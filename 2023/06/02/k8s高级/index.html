



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="运维" />


<link rel="canonical" href="http://example.com/2023/06/02/k8s%E9%AB%98%E7%BA%A7/">



  <title>
k8s高级 - 运维 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">k8s高级
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-06-02 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-06-02T13:38:45+08:00">2023-06-02</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/08e73cd8998a540ab698836447eeea91.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/1708e15cf2398f98ebe5f305d9d6074a.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/a8d0ac76b87f7593653e29559d61b32d.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c50475797549951523025a46bab169bb.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/226cdddcc87f721f3412378f31d5c9d1.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/dd21608b40c2387068c472909a82b3e0.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="In 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/02/k8s%E9%AB%98%E7%BA%A7/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="k8s高级"><a class="markdownIt-Anchor" href="#k8s高级">#</a> k8s 高级</h1>
<h2 id="环境配置"><a class="markdownIt-Anchor" href="#环境配置">#</a> 环境配置</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker load -i  .tar.gz</span><br><span class="line">ctr -n=k8s.io images import .tar.gz</span><br><span class="line">ctr -n=k8s.io images pull docker.io/library/centos:latest</span><br><span class="line">docker save -o .tar.gz</span><br><span class="line">ctr -n=k8s.io import .tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">修改ip</span><br><span class="line">配置主机名</span><br><span class="line">配置hosts文件</span><br><span class="line">配置免密登录</span><br><span class="line">关闭交换分区</span><br><span class="line">修改内核参数</span><br><span class="line">关闭firewalld防火墙</span><br><span class="line">关闭selinux</span><br><span class="line">配置阿里云的安装docker的repo源</span><br><span class="line">配置阿里云安装k8s的repo源</span><br><span class="line">配置时间同步</span><br><span class="line">开启ipvs</span><br><span class="line">安装基础软件包</span><br><span class="line">安装iptablese</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.13.180:6443 --token or2v2h.3vffzj49xx3yuvr6 \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:09c9428481b6f33c04537f0753472f38c16637b351123a1416e7771366ca837a</span><br><span class="line"></span><br><span class="line">1.安装bash-completion工具</span><br><span class="line">yum install bash-completion -y</span><br><span class="line"> 否则报错：</span><br><span class="line">-bash: _get_comp_words_by_ref: command not found</span><br><span class="line">2.执行bash_completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">3.加载kubectl completion</span><br><span class="line">source &lt;(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc # 在您的 bash shell 中永久的添加自动补全</span><br><span class="line">您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</span><br><span class="line">cat &gt;&gt;/root/.bashrc&lt;&lt;EOF</span><br><span class="line">alias k=kubectl</span><br><span class="line">complete -F __start_kubectl k</span><br><span class="line">EOF</span><br><span class="line">source /root/.bashrc</span><br></pre></td></tr></table></figure>
<h2 id="prometheus"><a class="markdownIt-Anchor" href="#prometheus">#</a> Prometheus</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Prometheus是一个开源的系统监控和报警系统，现在已经加入到CNCF基金会，成为继k8s之后第二个在CNCF托管的项目，在kubernetes容器管理系统中，通常会搭配prometheus进行监控，同时也支持多种exporter采集数据，还支持pushgateway进行数据上报，Prometheus性能足够支撑上万台规模的集群。</span><br><span class="line"></span><br><span class="line">zabbix,nagios,cattio</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.多维度数据模型</span><br><span class="line">每一个时间序列数据都由metric度量指标名称和它的标签labels键值对集合唯一确定：</span><br><span class="line">这个metric度量指标名称指定监控目标系统的测量特征（如：http_requests_total- 接收http请求的总计数）。labels开启了Prometheus的多维数据模型：对于相同的度量名称，通过不同标签列表的结合, 会形成特定的度量维度实例。(例如：所有包含度量名称为/api/tracks的http请求，打上method=POST的标签，则形成了具体的http请求)。这个查询语言在这些度量和标签列表的基础上进行过滤和聚合。改变任何度量上的任何标签值，则会形成新的时间序列图。</span><br><span class="line">2.灵活的查询语言（PromQL）</span><br><span class="line">可以对采集的metrics指标进行加法，乘法，连接等操作；</span><br><span class="line">3.可以直接在本地部署，不依赖其他分布式存储；</span><br><span class="line">4.通过基于HTTP的pull方式采集时序数据；</span><br><span class="line">5.可以通过中间网关pushgateway的方式把时间序列数据推送到prometheus server端；</span><br><span class="line">6.可通过服务发现或者静态配置来发现目标服务对象（targets）。</span><br><span class="line">7.有多种可视化图像界面，如Grafana等。</span><br><span class="line">8.高效的存储，每个采样数据占3.5 bytes左右，300万的时间序列，30s间隔，保留60天，消耗磁盘大概200G。</span><br><span class="line">9.做高可用，可以对数据做异地备份，联邦集群，部署多套prometheus，pushgateway上报数据</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">样本</span><br><span class="line">在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成：</span><br><span class="line">1、指标（metric）：指标名称和描述当前样本特征的 labelsets；</span><br><span class="line">2、时间戳（timestamp）：一个精确到毫秒的时间戳；</span><br><span class="line">3、样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。</span><br><span class="line"></span><br><span class="line">表示方式：</span><br><span class="line">通过如下表达方式表示指定指标名称和指定标签集合的时间序列：</span><br><span class="line">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</span><br><span class="line">例如，指标名称为 api_http_requests_total，标签为 method=&quot;POST&quot; 和 handler=&quot;/messages&quot; 的时间序列可以表示为：</span><br><span class="line">api_http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="组件介绍"><a class="markdownIt-Anchor" href="#组件介绍">#</a> 组件介绍</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.Prometheus Server: 用于收集和存储时间序列数据。</span><br><span class="line">2.Client Library: 客户端库，检测应用程序代码，当Prometheus抓取实例的HTTP端点时，客户端库会将所有跟踪的metrics指标的当前状态发送到prometheus server端。</span><br><span class="line">3.Exporters: prometheus支持多种exporter，通过exporter可以采集metrics数据，然后发送到prometheus server端，所有向promtheus server提供监控数据的程序都可以被称为exporter</span><br><span class="line">4.Alertmanager: 从 Prometheus server 端接收到 alerts 后，会进行去重，分组，并路由到相应的接收方，发出报警，常见的接收方式有：电子邮件，微信，钉钉, slack等。</span><br><span class="line">5.Grafana：监控仪表盘，可视化监控数据</span><br><span class="line">6.pushgateway: 各个目标主机可上报数据到pushgateway，然后prometheus server统一从pushgateway拉取数据。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143122137.png" alt="image-20230526143122137"></p>
<h3 id="工作流程"><a class="markdownIt-Anchor" href="#工作流程">#</a> 工作流程</h3>
<p>1.Prometheus server 可定期从活跃的（up）目标主机上（target）拉取监控指标数据，目标主机的监控数据可通过配置静态 job 或者服务发现的方式被 prometheus server 采集到，这种方式默认的 pull 方式拉取指标；也可通过 pushgateway 把采集的数据上报到 prometheus server 中；还可通过一些组件自带的 exporter 采集相应组件的数据；</p>
<p>2.Prometheus server 把采集到的监控指标数据保存到本地磁盘或者数据库；</p>
<p>3.Prometheus 采集的监控指标数据按时间序列存储，通过配置报警规则，把触发的报警发送到 alertmanager</p>
<p>4.Alertmanager 通过配置报警接收方，发送报警到邮件，微信或者钉钉等</p>
<p>5.Prometheus 自带的 web ui 界面提供 PromQL 查询语言，可查询监控数据</p>
<p>6.Grafana 可接入 prometheus 数据源，把监控数据以图形化形式展示出</p>
<h3 id="prometheus和zabbix对比"><a class="markdownIt-Anchor" href="#prometheus和zabbix对比">#</a> Prometheus 和 Zabbix 对比</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143352088.png" alt="image-20230526143352088"></p>
<h3 id="部署模式"><a class="markdownIt-Anchor" href="#部署模式">#</a> 部署模式</h3>
<p>基本 HA</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143444630.png" alt="image-20230526143444630"></p>
<p><strong>基本的 HA 模式只能确保 Promthues 服务的可用性问题，但是不解决 Prometheus Server 之间的数据一致性问题以及持久化问题 (数据丢失后无法恢复)，也无法进行动态的扩展。因此这种部署方式适合监控规模不大，Promthues Server 也不会频繁发生迁移的情况，并且只需要保存短周期监控数据的场景。</strong></p>
<p>基本 HA + 远程存储</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143538150.png" alt="image-20230526143538150"></p>
<p><strong>在解决了 Promthues 服务可用性的基础上，同时确保了数据的持久化，当 Promthues Server 发生宕机或者数据丢失的情况下，可以快速的恢复。 同时 Promthues Server 可能很好的进行迁移。因此，该方案适用于用户监控规模不大，但是希望能够将监控数据持久化，同时能够确保 Promthues Server 的可迁移性的场景。</strong></p>
<p>基本 HA + 远程存储 + 联邦集群</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143645241.png" alt="image-20230526143645241"></p>
<p><strong>Promthues 的性能瓶颈主要在于大量的采集任务，因此用户需要利用 Prometheus 联邦集群的特性，将不同类型的采集任务划分到不同的 Promthues 子服务中，从而实现功能分区。例如一个 Promthues Server 负责采集基础设施相关的监控指标，另外一个 Prometheus Server 负责采集应用监控指标。再有上层 Prometheus Server 实现对数据的汇聚。</strong></p>
<h3 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型">#</a> 数据类型</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Counter是计数器类型：</span><br><span class="line">1、Counter 用于累计值，例如记录请求次数、任务完成数、错误发生次数。</span><br><span class="line">2、一直增加，不会减少。</span><br><span class="line">3、重启进程后，会被重置。</span><br><span class="line">例如：http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  100</span><br><span class="line">      http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  160</span><br><span class="line">      </span><br><span class="line">Counter 类型数据可以让用户方便的了解事件产生的速率的变化，在PromQL内置的相关操作函数可以提供相应的分析，比如以HTTP应用请求量来进行说明：</span><br><span class="line">1、通过rate()函数获取HTTP请求量的增长率</span><br><span class="line">rate(http_requests_total[5m])</span><br><span class="line">2、查询当前系统中，访问量前10的HTTP地址</span><br><span class="line">topk(10, http_requests_total)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gauge是测量器类型：</span><br><span class="line">1、Gauge是常规数值，例如温度变化、内存使用变化。</span><br><span class="line">2、可变大，可变小。</span><br><span class="line">3、重启进程后，会被重置</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   100</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   30</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   50</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   80 </span><br><span class="line"></span><br><span class="line">对于 Gauge 类型的监控指标，通过 PromQL 内置函数 delta() 可以获取样本在一段时间内的变化情况，例如，计算 CPU 温度在两小时内的差异：</span><br><span class="line">dalta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h])</span><br><span class="line"></span><br><span class="line">你还可以通过PromQL 内置函数 predict_linear() 基于简单线性回归的方式，对样本数据的变化趋势做出预测。例如，基于 2 小时的样本数据，来预测主机可用磁盘空间在 4 个小时之后的剩余情况：</span><br><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">histogram是柱状图，在Prometheus系统的查询语言中，有三种作用：</span><br><span class="line">1、在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中. 后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。</span><br><span class="line">2、对每个采样点值累计和(sum)</span><br><span class="line">3、对采样点的次数累计和(count)</span><br><span class="line"></span><br><span class="line">度量指标名称: [basename]_上面三类的作用度量指标名称</span><br><span class="line">1、[basename]_bucket&#123;le=&quot;上边界&quot;&#125;, 这个值为小于等于上边界的所有采样点数量</span><br><span class="line">2、[basename]_sum</span><br><span class="line">3、[basename]_count</span><br><span class="line"></span><br><span class="line">在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统 API 调用的平均响应时间为例：如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</span><br><span class="line">为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在 0~10ms 之间的请求数有多少，而 10~20ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，我们可以快速了解监控样本的分布情况。</span><br><span class="line"></span><br><span class="line">Histogram 类型的样本会提供三种指标（假设指标名称为 &lt;basename&gt;）：</span><br><span class="line">样本的值分布在 bucket 中的数量，命名为 &lt;basename&gt;_bucket&#123;le=&quot;&lt;上边界&gt;&quot;&#125;。解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。</span><br><span class="line"></span><br><span class="line">1、http 请求响应时间 &lt;=0.005 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.005&quot;,&#125; 0.0</span><br><span class="line">2、http 请求响应时间 &lt;=0.01 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.01&quot;,&#125; 0.0</span><br><span class="line"> 3、http 请求响应时间 &lt;=0.025 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.025&quot;,&#125; 0.0</span><br><span class="line"></span><br><span class="line">所有样本值的大小总和，命名为 &lt;basename&gt;_sum。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">summary</span><br><span class="line">与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。它也有三种作用：</span><br><span class="line">1、对于每个采样点进行统计，并形成分位图。（如：正态分布一样，统计低于60分不及格的同学比例，统计低于80分的同学比例，统计低于95分的同学比例）</span><br><span class="line">2、统计班上所有同学的总成绩(sum)</span><br><span class="line">3、统计班上同学的考试总人数(count)</span><br><span class="line"></span><br><span class="line">样本值的分位数分布情况，命名为 &lt;basename&gt;&#123;quantile=&quot;&lt;φ&gt;&quot;&#125;。</span><br><span class="line">1、含义：http 请求中有 50% 的请求响应时间是 3.052404983s</span><br><span class="line">  io_namespace_http_requests_latency_seconds_summary&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,quantile=&quot;0.5&quot;,&#125; 3.052404983</span><br><span class="line">  </span><br><span class="line">  Histogram 需要通过 &lt;basename&gt;_bucket 来计算分位数，而 Summary 则直接存储了分位数的值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Prometheus对kubernetes的监控</span><br><span class="line">对于Kubernetes而言，我们可以把当中所有的资源分为几类：</span><br><span class="line">•基础设施层（Node）：集群节点，为整个集群和应用提供运行时资源</span><br><span class="line">•容器基础设施（Container）：为应用提供运行时环境</span><br><span class="line">•用户应用（Pod）：Pod中会包含一组容器，它们一起工作，并且对外提供一个（或者一组）功能</span><br><span class="line">•内部服务负载均衡（Service）：在集群内，通过Service在集群暴露应用功能，集群内应用和应用之间访问时提供内部的负载均衡</span><br><span class="line">•外部访问入口（Ingress）：通过Ingress提供集群外的访问入口，从而可以使外部客户端能够访问到部署在Kubernetes集群内的服务</span><br></pre></td></tr></table></figure>
<h3 id="node-exporter"><a class="markdownIt-Anchor" href="#node-exporter">#</a> node-exporter</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-exporter可以采集机器（物理机、虚拟机、云主机等）的监控指标数据，能够采集到的指标包括CPU, 内存，磁盘，网络，文件数等信息。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>  <span class="comment">#可以保证k8s集群的每个节点都运行完全一样的pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/node-exporter:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">0.15</span>  <span class="comment">#这个容器运行至少需要0.15核cpu</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span>  <span class="comment">#开启特权模式</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.procfs</span>  <span class="comment">#配置挂载宿主机（node节点）的路径</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/host/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.sysfs</span>  <span class="comment">#配置挂载宿主机（node节点）的路径</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/host/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span></span><br><span class="line"><span class="comment">#通过正则表达式忽略某些文件系统挂载点的信息收集</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/rootfs</span></span><br><span class="line"><span class="comment">#将主机/dev、/proc、/sys这些目录挂在到容器中，这是因为我们采集的很多节点数据都是通过这些文件来获取系统信息的。</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/1</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span><span class="string">:9100/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span><span class="string">:9100/metrics</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">node_cpu_seconds</span></span><br><span class="line">  <span class="string">%</span> <span class="string">Total</span>    <span class="string">%</span> <span class="string">Received</span> <span class="string">%</span> <span class="string">Xferd</span>  <span class="string">Average</span> <span class="string">Speed</span>   <span class="string">Time</span>    <span class="string">Time</span>     <span class="string">Time</span>  <span class="string">Current</span></span><br><span class="line">                                 <span class="string">Dload</span>  <span class="string">Upload</span>   <span class="string">Total</span>   <span class="string">Spent</span>    <span class="string">Left</span>  <span class="string">Speed</span></span><br><span class="line">  <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>      <span class="number">0</span>      <span class="number">0</span> <span class="string">--:--:--</span> <span class="string">--:--:--</span> <span class="string">--:--:--</span>     <span class="number">0</span></span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment"># TYPE node_cpu_seconds_total counter</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;idle&quot;&#125;</span> <span class="number">14492.66</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;iowait&quot;&#125;</span> <span class="number">19.3</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;irq&quot;&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;nice&quot;&#125;</span> <span class="number">0.48</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;softirq&quot;&#125;</span> <span class="number">28.25</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建sa账号，对sa做rbac授权</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">serviceaccount</span> <span class="string">monitor</span> <span class="string">-n</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">monitor-clusterrolebinding</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">--clusterrole=cluster-admin</span>  <span class="string">--serviceaccount=monitor-sa:monitor</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">monitor-clusterrolebinding-1</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">--clusterrole=cluster-admin</span> <span class="string">--user=system:serviceaccount:monitor:monitor-sa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建prometheus数据存储目录</span></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">~</span>]<span class="comment"># mkdir /data </span></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">~</span>]<span class="comment"># chmod 777 -R /data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建configmap</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      evaluation_interval: 1m</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role:  node</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __scheme__</span></span><br><span class="line"><span class="string">        regex: (https?)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_name </span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<h3 id="部署prothemeus"><a class="markdownIt-Anchor" href="#部署prothemeus">#</a> 部署 Prothemeus</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过deployment部署Prothemeus</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">    <span class="comment">#matchExpressions:</span></span><br><span class="line">    <span class="comment">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class="line">    <span class="comment">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">monitor</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus/prometheus.yml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--storage.tsdb.path=/prometheus</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--storage.tsdb.retention=720h</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--web.enable-lifecycle</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">prome</span>]<span class="comment"># kubectl exec -it -n monitor-sa prometheus-server-674dff4c46-l67r6 -- /bin/sh</span></span><br><span class="line"><span class="string">/prometheus</span> <span class="string">$</span> <span class="string">cd</span> <span class="string">/etc/prometheus/</span></span><br><span class="line"><span class="string">/etc/prometheus</span> <span class="string">$</span> <span class="string">ls</span></span><br><span class="line"><span class="string">prometheus.yml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控promethus-service</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="prothemeus热加载"><a class="markdownIt-Anchor" href="#prothemeus热加载">#</a> Prothemeus 热加载</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://pod-ip:9090/-/reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#热加载速度比较慢，可以暴力重启prometheus，如修改上面的prometheus-cfg.yaml文件之后，可执行如下强制删除：</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">然后再通过apply更新：</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">线上最好热加载，暴力删除可能造成监控数据的丢失</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527153500817.png" alt="image-20230527153500817"></p>
<h3 id="grafana"><a class="markdownIt-Anchor" href="#grafana">#</a> Grafana</h3>
<p><strong>Grafana 是一个跨平台的开源的度量分析和可视化工具，可以将采集的数据可视化的展示，并及时通知给告警接收方。它主要有以下六大特点：</strong></p>
<p><strong>1、展示方式：快速灵活的客户端图表，面板插件有许多不同方式的可视化指标和日志，官方库中具有丰富的仪表盘插件，比如热图、折线图、图表等多种展示方式；</strong></p>
<p><strong>2、数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch 和 KairosDB 等；</strong></p>
<p><strong>3、通知提醒：以可视方式定义最重要指标的警报规则，Grafana 将不断计算并发送通知，在数据达到阈值时通过 Slack、PagerDuty 等获得通知；</strong></p>
<p><strong>4、混合展示：在同一图表中混合使用不同的数据源，可以基于每个查询指定数据源，甚至自定义数据源；</strong></p>
<p><strong>5、注释：使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记</strong></p>
<h3 id="安装grafana"><a class="markdownIt-Anchor" href="#安装grafana">#</a> 安装 Grafana</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: &quot;3000&quot;</span><br><span class="line">          # The following env variables are required to make Grafana accessible via</span><br><span class="line">          # the kubernetes api-server proxy. On production clusters, we recommend</span><br><span class="line">          # removing these env variables, setup auth for grafana, and expose the grafana</span><br><span class="line">          # service using a LoadBalancer or a public IP.</span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          # If you&#x27;re only using the API Server proxy, set this value instead:</span><br><span class="line">          # value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: &#x27;true&#x27;</span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  # In a production setup, we recommend accessing Grafana through an external Loadbalancer</span><br><span class="line">  # or through a public IP.</span><br><span class="line">  # type: LoadBalancer</span><br><span class="line">  # You could also use NodePort to expose the service at a randomly-generated port</span><br><span class="line">  # type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160404888.png" alt="image-20230527160404888"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160957066.png" alt="image-20230527160957066"></p>
<p>将其中的 container_last_seen 放到 Prometheus 中 query，如果显示 nodata 说明没有这项监控</p>
<h3 id="kube-metric"><a class="markdownIt-Anchor" href="#kube-metric">#</a> kube-metric</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;nodes&quot;, &quot;pods&quot;, &quot;services&quot;, &quot;resourcequotas&quot;, &quot;replicationcontrollers&quot;, &quot;limitranges&quot;, &quot;persistentvolumeclaims&quot;, &quot;persistentvolumes&quot;, &quot;namespaces&quot;, &quot;endpoints&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;extensions&quot;]</span><br><span class="line">  resources: [&quot;daemonsets&quot;, &quot;deployments&quot;, &quot;replicasets&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;apps&quot;]</span><br><span class="line">  resources: [&quot;statefulsets&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;batch&quot;]</span><br><span class="line">  resources: [&quot;cronjobs&quot;, &quot;jobs&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;autoscaling&quot;]</span><br><span class="line">  resources: [&quot;horizontalpodautoscalers&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: quay.io/coreos/kube-state-metrics:v1.9.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: kube-state-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">    </span><br><span class="line">导入json</span><br><span class="line">https://grafana.com/grafana/dashboards/?search=kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="alert-manager"><a class="markdownIt-Anchor" href="#alert-manager">#</a> alert manager</h2>
<h3 id="报警到qq邮箱"><a class="markdownIt-Anchor" href="#报警到qq邮箱">#</a> 报警到 qq 邮箱</h3>
<p>WYCMUCTTXLOBSVYS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alertmanager.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      resolve_timeout: 1m</span></span><br><span class="line"><span class="string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class="line"><span class="string">      smtp_from: &#x27;kbshire@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_username: &#x27;kbshire@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_password: &#x27;WYCMUCTTXLOBSVYS&#x27;</span></span><br><span class="line"><span class="string">      smtp_require_tls: false</span></span><br><span class="line"><span class="string">    route:  #用于配置告警分发策略</span></span><br><span class="line"><span class="string">      group_by: [alertname] # 采用哪个标签来作为分组依据</span></span><br><span class="line"><span class="string">      group_wait: 10s       # 组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span></span><br><span class="line"><span class="string">      group_interval: 10s    # 上下两组发送告警的间隔时间</span></span><br><span class="line"><span class="string">      repeat_interval: 10m    # 重复发送告警的时间，减少相同邮件的发送频率，默认是1h</span></span><br><span class="line"><span class="string">      receiver: default-receiver  #定义谁来收告警</span></span><br><span class="line"><span class="string">    receivers:</span></span><br><span class="line"><span class="string">    - name: &#x27;default-receiver&#x27;</span></span><br><span class="line"><span class="string">      email_configs:</span></span><br><span class="line"><span class="string">      - to: &#x27;183108913@qq.com&#x27;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">报警处理流程如下：</span><br><span class="line">1. Prometheus Server监控目标主机上暴露的http接口（这里假设接口A），通过Promethes配置的&#x27;scrape_interval&#x27;定义的时间间隔，定期采集目标主机上监控数据。</span><br><span class="line">2. 当接口A不可用的时候，Server端会持续的尝试从接口中取数据，直到&quot;scrape_timeout&quot;时间后停止尝试。这时候把接口的状态变为“DOWN”。</span><br><span class="line">3. Prometheus同时根据配置的&quot;evaluation_interval&quot;的时间间隔，定期（默认1min）的对Alert Rule进行评估；当到达评估周期的时候，发现接口A为DOWN，即UP=0为真，激活Alert，进入“PENDING”状态，并记录当前active的时间；</span><br><span class="line">4. 当下一个alert rule的评估周期到来的时候，发现UP=0继续为真，然后判断警报Active的时间是否已经超出rule里的‘for’ 持续时间，如果未超出，则进入下一个评估周期；如果时间超出，则alert的状态变为“FIRING”；同时调用Alertmanager接口，发送相关报警数据。</span><br><span class="line">5. AlertManager收到报警数据后，会将警报信息进行分组，然后根据alertmanager配置的“group_wait”时间先进行等待。等wait时间过后再发送报警信息。</span><br><span class="line">6. 属于同一个Alert Group的警报，在等待的过程中可能进入新的alert，如果之前的报警已经成功发出，那么间隔“group_interval”的时间间隔后再重新发送报警信息。比如配置的是邮件报警，那么同属一个group的报警信息会汇总在一个邮件里进行发送。</span><br><span class="line">7. 如果Alert Group里的警报一直没发生变化并且已经成功发送，等待‘repeat_interval’时间间隔之后再重复发送相同的报警邮件；如果之前的警报没有成功发送，则相当于触发第6条条件，则需要等待group_interval时间间隔后重复发送。</span><br><span class="line"></span><br><span class="line">同时最后至于警报信息具体发给谁，满足什么样的条件下指定警报接收人，设置不同报警发送频率，这里有alertmanager的route路由规则进行配置。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">    - /etc/prometheus/rules.yml</span></span><br><span class="line"><span class="string">    alerting:</span></span><br><span class="line"><span class="string">      alertmanagers:</span></span><br><span class="line"><span class="string">      - static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;localhost:9093&quot;]</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      evaluation_interval: 1m</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role:  node</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __scheme__</span></span><br><span class="line"><span class="string">        regex: (https?)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_name </span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-pods&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_path</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __address__</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_port</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: kubernetes_pod_name</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-etcd&#x27;</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line"><span class="string">        cert_file: /etc/kubernetes/pki/etcd/server.crt</span></span><br><span class="line"><span class="string">        key_file: /etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line"><span class="string">      scrape_interval: 5s</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets: [&#x27;192.168.13.180:2379&#x27;]</span></span><br><span class="line"><span class="string"></span>  <span class="attr">rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - name: example</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: apiserver的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">      - alert:  apiserver的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">      - alert: etcd的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">      - alert:  etcd的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-state-metrics的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;80%&quot;      </span></span><br><span class="line"><span class="string">      - alert: kube-state-metrics的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;90%&quot;      </span></span><br><span class="line"><span class="string">      - alert: coredns的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;80%&quot;      </span></span><br><span class="line"><span class="string">      - alert: coredns的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;90%&quot;      </span></span><br><span class="line"><span class="string">      - alert: kube-proxy打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-proxy打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-schedule打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-schedule打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: coredns</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning </span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: coredns</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-proxy</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: scheduler</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-dns</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: HttpRequestsAvg</span></span><br><span class="line"><span class="string">        expr: sum(rate(rest_client_requests_total&#123;job=~&quot;kubernetes-kube-proxy|kubernetes-kubelet|kubernetes-schedule|kubernetes-control-manager|kubernetes-apiservers&quot;&#125;[1m]))  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): TPS超过1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1000&quot;   </span></span><br><span class="line"><span class="string">      - alert: Pod_restarts</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_restarts_total&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;在&#123;&#123;$labels.namespace&#125;&#125;名称空间下发现&#123;&#123;$labels.pod&#125;&#125;这个pod下的容器&#123;&#123;$labels.container&#125;&#125;被重启,这个监控指标是由&#123;&#123;$labels.instance&#125;&#125;采集的&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Pod_waiting</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_waiting_reason&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;启动异常等待中&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;   </span></span><br><span class="line"><span class="string">      - alert: Pod_terminated</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_terminated_reason&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;被删除&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_leader</span></span><br><span class="line"><span class="string">        expr: etcd_server_has_leader&#123;job=&quot;kubernetes-etcd&quot;&#125; == 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前没有leader&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_leader_changes</span></span><br><span class="line"><span class="string">        expr: rate(etcd_server_leader_changes_seen_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前leader已发生改变&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_failed</span></span><br><span class="line"><span class="string">        expr: rate(etcd_server_proposals_failed_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 服务失败&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_db_total_size</span></span><br><span class="line"><span class="string">        expr: etcd_debugging_mvcc_db_total_size_in_bytes&#123;job=&quot;kubernetes-etcd&quot;&#125; &gt; 10000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;)：db空间超过10G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;10G&quot;</span></span><br><span class="line"><span class="string">      - alert: Endpoint_ready</span></span><br><span class="line"><span class="string">        expr: kube_endpoint_address_not_ready&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.endpoint&#125;&#125;不可用&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;</span></span><br><span class="line"><span class="string">    - name: 物理节点状态-监控告警</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: 物理节点cpu使用率</span></span><br><span class="line"><span class="string">        expr: 100-avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by(instance)*100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: ccritical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;cpu使用率过高&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的cpu使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot; </span></span><br><span class="line"><span class="string">      - alert: 物理节点内存使用率</span></span><br><span class="line"><span class="string">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;内存使用率过高&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的内存使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot;</span></span><br><span class="line"><span class="string">      - alert: InstanceDown</span></span><br><span class="line"><span class="string">        expr: up == 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:   </span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器宕机&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器延时超过2分钟&quot;</span></span><br><span class="line"><span class="string">      - alert: 物理节点磁盘的IO性能</span></span><br><span class="line"><span class="string">        expr: 100-(avg(irate(node_disk_io_time_seconds_total[1m])) by(instance)* 100) &lt; 60</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入磁盘IO使用率过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 流入磁盘IO大于60%(目前使用:&#123;&#123;$value&#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: 入网流量带宽</span></span><br><span class="line"><span class="string">        expr: ((sum(rate (node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入网络带宽过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流入网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: 出网流量带宽</span></span><br><span class="line"><span class="string">        expr: ((sum(rate (node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流出网络带宽过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流出网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: TCP会话</span></span><br><span class="line"><span class="string">        expr: node_netstat_Tcp_CurrEstab &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; TCP_ESTABLISHED过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; TCP_ESTABLISHED大于1000%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">      - alert: 磁盘容量</span></span><br><span class="line"><span class="string">        expr: 100-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes &#123;fstype=~&quot;ext4|xfs&quot;&#125;*100) &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 磁盘分区使用率过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 磁盘分区使用大于80%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">create</span> <span class="string">secret</span> <span class="string">generic</span> <span class="string">etcd-certs</span> <span class="string">--from-file=/etc/kubernetes/pki/etcd/server.key</span>  <span class="string">--from-file=/etc/kubernetes/pki/etcd/server.crt</span> <span class="string">--from-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">    <span class="comment">#matchExpressions:</span></span><br><span class="line">    <span class="comment">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class="line">    <span class="comment">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#nodeName: xianchaonode1</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">monitor</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--web.enable-lifecycle&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/k8s-certs/etcd/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/alertmanager/alertmanager.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--log.level=debug&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">           <span class="attr">secretName:</span> <span class="string">etcd-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-storage</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data/alertmanager</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30066</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9093</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 微信</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">  <span class="attr">wechat_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">corp_id:</span> <span class="string">wwa82df90a693abb15</span></span><br><span class="line">    <span class="attr">to_user:</span> <span class="string">&#x27;@all&#x27;</span></span><br><span class="line">    <span class="attr">agent_id:</span> <span class="number">1000003</span></span><br><span class="line">    <span class="attr">api_secret:</span> <span class="string">Ov5SWq_JqrolsOj6dD4Jg9qaMu1TTaDzVTCrXHcjlFs</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 钉钉</span></span><br><span class="line">  <span class="attr">receivers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster1</span></span><br><span class="line">      <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://192.168.40.180:8060/dingtalk/cluster1/send&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="promql"><a class="markdownIt-Anchor" href="#promql">#</a> <strong>PromQL</strong></h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PromQL（Prometheus</span> <span class="string">Query</span> <span class="string">Language）是</span> <span class="string">Prometheus</span> <span class="string">自己开发的表达式语言，语言表现力很丰富，内置函数也很多。使用它可以对时序数据进行筛选和聚合。</span></span><br><span class="line"></span><br><span class="line"><span class="string">PromQL</span> <span class="string">表达式计算出来的值有以下几种类型：</span></span><br><span class="line"><span class="string">瞬时向量</span> <span class="string">(Instant</span> <span class="string">vector):</span> <span class="string">一组时序，每个时序只有一个采样值</span></span><br><span class="line"><span class="string">区间向量</span> <span class="string">(Range</span> <span class="string">vector):</span> <span class="string">一组时序，每个时序包含一段时间内的多个采样值</span></span><br><span class="line"><span class="string">标量数据</span> <span class="string">(Scalar):</span> <span class="string">一个浮点数</span></span><br><span class="line"><span class="string">字符串</span> <span class="string">(String):</span> <span class="string">一个字符串，暂时未用</span></span><br><span class="line"></span><br><span class="line"><span class="string">瞬时向量选择器用来选择一组时序在某个采样点的采样值。</span></span><br><span class="line"><span class="string">最简单的情况就是指定一个度量指标，选择出所有属于该度量指标的时序的当前采样值。</span></span><br><span class="line"><span class="string">可以通过在后面添加用大括号包围起来的一组标签键值对来对时序进行过滤。比如下面的表达式筛选出了</span> <span class="string">job</span> <span class="string">为</span> <span class="string">kubernetes-apiservers，并且</span> <span class="string">resource为</span> <span class="string">pod的时序：apiserver_request_total</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span></span><br><span class="line"><span class="string">匹配标签值时可以是等于，也可以使用正则表达式。总共有下面几种匹配操作符：</span></span><br><span class="line"><span class="string">=：完全相等</span></span><br><span class="line"><span class="type">!=</span><span class="string">：</span> <span class="string">不相等</span></span><br><span class="line"><span class="string">=~：</span> <span class="string">正则表达式匹配</span></span><br><span class="line"><span class="type">!~</span><span class="string">：</span> <span class="string">正则表达式不匹配</span></span><br><span class="line"><span class="string">下面的表达式筛选出了container是kube-scheduler或kube-proxy或kube-apiserver的时序数据</span></span><br><span class="line"><span class="string">container_processes&#123;container=~&quot;kube-scheduler|kube-proxy|kube-apiserver&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">区间向量选择器类似于瞬时向量选择器，不同的是它选择的是过去一段时间的采样值。可以通过在瞬时向量选择器后面添加包含在</span> [] <span class="string">里的时长来得到区间向量选择器。比如下面的表达式选出了所有度量指标为apiserver_request_total且resource是pod的时序在过去1</span> <span class="string">分钟的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;[1m]</span></span><br><span class="line"><span class="string">这个不支持Graph，需要选择Console，才会看到采集的数据</span></span><br><span class="line"><span class="string">说明：时长的单位可以是下面几种之一：</span></span><br><span class="line"><span class="string">s：seconds</span></span><br><span class="line"><span class="string">m：minutes</span></span><br><span class="line"><span class="string">h：hours</span></span><br><span class="line"><span class="string">d：days</span></span><br><span class="line"><span class="string">w：weeks</span></span><br><span class="line"><span class="string">y：years</span></span><br><span class="line"></span><br><span class="line"><span class="string">偏移向量选择器</span></span><br><span class="line"><span class="string">前面介绍的选择器默认都是以当前时间为基准时间，偏移修饰器用来调整基准时间，使其往前偏移一段时间。偏移修饰器紧跟在选择器后面，使用</span> <span class="string">offset</span> <span class="string">来指定要偏移的量。比如下面的表达式选择度量名称为apiserver_request_total的所有时序在</span> <span class="number">5</span> <span class="string">分钟前的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> <span class="string">offset</span> <span class="string">5m</span></span><br><span class="line"><span class="string">下面的表达式选择apiserver_request_total</span> <span class="string">度量指标在</span> <span class="number">1</span> <span class="string">周前的这个时间点过去</span> <span class="number">5</span> <span class="string">分钟的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> [<span class="string">5m</span>] <span class="string">offset</span> <span class="string">1w</span></span><br><span class="line"></span><br><span class="line"><span class="string">聚合操作符</span></span><br><span class="line"><span class="string">PromQL</span> <span class="string">的聚合操作符用来将向量里的元素聚合得更少。总共有下面这些聚合操作符：</span></span><br><span class="line"><span class="string">sum：求和</span></span><br><span class="line"><span class="string">min：最小值</span></span><br><span class="line"><span class="string">max：最大值</span></span><br><span class="line"><span class="string">avg：平均值</span></span><br><span class="line"><span class="string">stddev：标准差</span></span><br><span class="line"><span class="string">stdvar：方差</span></span><br><span class="line"><span class="string">count：元素个数</span></span><br><span class="line"><span class="string">count_values：等于某值的元素个数</span></span><br><span class="line"><span class="string">bottomk：最小的</span> <span class="string">k</span> <span class="string">个元素</span></span><br><span class="line"><span class="string">topk：最大的</span> <span class="string">k</span> <span class="string">个元素</span></span><br><span class="line"><span class="string">quantile：分位数</span></span><br><span class="line"><span class="string">计算haha节点所有容器总计内存</span></span><br><span class="line"><span class="string">sum(container_memory_usage_bytes&#123;instance=~&quot;haha&quot;&#125;)/1024/1024/1024</span></span><br><span class="line"><span class="string">计算haha节点最近1m所有容器cpu使用率</span></span><br><span class="line"><span class="string">sum</span> <span class="string">(rate</span> <span class="string">(container_cpu_usage_seconds_total&#123;instance=~&quot;haha&quot;&#125;[1m]))</span> <span class="string">/</span> <span class="string">sum</span> <span class="string">(machine_cpu_cores&#123;</span> <span class="string">instance</span> <span class="string">=~&quot;haha&quot;&#125;)</span> <span class="string">*</span> <span class="number">100</span></span><br><span class="line"><span class="string">计算最近1m所有容器cpu使用率</span></span><br><span class="line"><span class="string">sum</span> <span class="string">(rate</span> <span class="string">(container_cpu_usage_seconds_total&#123;id!=&quot;/&quot;&#125;[1m]))</span> <span class="string">by</span> <span class="string">(id)</span></span><br><span class="line"></span><br><span class="line"><span class="string">函数</span></span><br><span class="line"><span class="string">Prometheus</span> <span class="string">内置了一些函数来辅助计算，下面介绍一些典型的。</span></span><br><span class="line"><span class="string">abs()：绝对值</span></span><br><span class="line"><span class="string">sqrt()：平方根</span></span><br><span class="line"><span class="string">exp()：指数计算</span></span><br><span class="line"><span class="string">ln()：自然对数</span></span><br><span class="line"><span class="string">ceil()：向上取整</span></span><br><span class="line"><span class="string">floor()：向下取整</span></span><br><span class="line"><span class="string">round()：四舍五入取整</span></span><br><span class="line"><span class="string">delta()：计算区间向量里每一个时序第一个和最后一个的差值</span></span><br><span class="line"><span class="string">sort()：排序</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控tomcat"><a class="markdownIt-Anchor" href="#prometheus-监控tomcat">#</a> prometheus 监控 tomcat</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25saWdodGVuL3RvbWNhdF9leHBvcnRlcg==">nlighten/tomcat_exporter: A Prometheus exporter for Apache Tomcat (github.com)</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">下面在k8s-master节点操作</span><br><span class="line">（1）制作tomcat镜像，按如下步骤</span><br><span class="line">mkdir /root/tomcat_image</span><br><span class="line">把上面的war包和jar包传到这个目录下</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM tomcat:8.5-jdk8-corretto</span><br><span class="line">ADD metrics.war /usr/local/tomcat/webapps/</span><br><span class="line">ADD simpleclient-0.8.0.jar  /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_common-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_hotspot-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_servlet-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD tomcat_exporter_client-0.0.12.jar /usr/local/tomcat/lib/</span><br><span class="line"></span><br><span class="line">docker build -t=&#x27;/tomcat_prometheus:v1&#x27; .</span><br><span class="line">docker login</span><br><span class="line">  username：xianchao</span><br><span class="line">  password：1989317**</span><br><span class="line">docker push xianchao/tomcat_prometheus:v1 #上传镜像到hub仓库</span><br><span class="line">docker pull xianchao/tomcat_prometheus:v1  #在k8s的node节点拉取镜像拉取镜像</span><br><span class="line"></span><br><span class="line">（2）基于上面的镜像创建一个tomcat实例</span><br><span class="line">cat deploy.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    matchLabels: </span><br><span class="line">     app: tomcat</span><br><span class="line">  replicas: 2 # tells deployment to run 2 pods matching the template</span><br><span class="line">  template: # create pods using pod definition in this template</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: xianchao/tomcat_prometheus:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        securityContext: </span><br><span class="line">          privileged: true</span><br><span class="line"></span><br><span class="line">kubectl apply -f deploy.yaml</span><br><span class="line"></span><br><span class="line">创建一个service，可操作也可不操作</span><br><span class="line"> cat tomcat-service.yaml</span><br><span class="line">kind: Service  #service 类型</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">#  annotations:</span><br><span class="line">#    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">  name: tomcat-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 31360</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br><span class="line">kubectl apply -f tomcat-service.yaml </span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控-redis"><a class="markdownIt-Anchor" href="#prometheus-监控-redis">#</a> prometheus 监控 redis</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">redis.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:4</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">oliver006/redis_exporter:latest</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9121</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;9121&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prom</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9121</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9121</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span>  <span class="string">apply</span> <span class="string">-f</span> <span class="string">redis.yaml</span></span><br><span class="line"><span class="string">redis</span> <span class="string">这个</span> <span class="string">Pod</span> <span class="string">中包含了两个容器，一个就是</span> <span class="string">redis</span> <span class="string">本身的主应用，另外一个容器就是</span> <span class="string">redis_exporter</span></span><br><span class="line"></span><br><span class="line"><span class="string">由于Redis服务的metrics接口在redis-exporter</span> <span class="number">9121</span><span class="string">上，所以我们添加了prometheus.io/port=9121这样的annotation,在prometheus就会自动发现redis了</span></span><br><span class="line"></span><br><span class="line"><span class="string">接下来我们刷新一下Redis的Service配置</span></span><br><span class="line">[<span class="string">root@abcdocker</span> <span class="string">prometheus</span>]<span class="comment"># kubectl apply -f  redis.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控mysql"><a class="markdownIt-Anchor" href="#prometheus-监控mysql">#</a> prometheus 监控 mysql</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">mysql</span> <span class="string">-y</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">mariadb</span>  <span class="string">-y</span></span><br><span class="line"></span><br><span class="line"><span class="string">tar</span> <span class="string">-xvf</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class="line"><span class="string">cp</span> <span class="string">-ar</span> <span class="string">mysqld_exporter</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/mysqld_exporter</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.登陆mysql为mysql_exporter创建账号并授权</span></span><br><span class="line"><span class="comment"># 创建数据库用户。</span></span><br><span class="line"><span class="string">mysql&gt;</span> <span class="string">CREATE</span> <span class="string">USER</span> <span class="string">&#x27;mysql_exporter&#x27;</span><span class="string">@&#x27;localhost&#x27;</span> <span class="string">IDENTIFIED</span> <span class="string">BY</span> <span class="string">&#x27;Abcdef123!.&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对mysql_exporter用户授权</span></span><br><span class="line"><span class="string">mysql&gt;</span> <span class="string">GRANT</span> <span class="string">PROCESS,</span> <span class="string">REPLICATION</span> <span class="string">CLIENT,</span> <span class="string">SELECT</span> <span class="string">ON</span> <span class="string">*.*</span> <span class="string">TO</span> <span class="string">&#x27;mysql_exporter&#x27;</span><span class="string">@&#x27;localhost&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.创建mysql配置文件、运行时可免密码连接数据库：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class="line"><span class="string">cat</span> <span class="string">my.cnf</span></span><br><span class="line">[<span class="string">client</span>]</span><br><span class="line"><span class="string">user=mysql_exporter</span></span><br><span class="line"><span class="string">password=Abcdef123!.</span></span><br><span class="line"></span><br><span class="line"><span class="string">nohup</span> <span class="string">./mysqld_exporter</span> <span class="string">--config.my-cnf=./my.cnf</span> <span class="string">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span><span class="string">.修改prometheus-alertmanager-cfg.yaml文件，添加如下</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.40.180:9104&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-deploy.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-deploy.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prothemeus监控nginx"><a class="markdownIt-Anchor" href="#prothemeus监控nginx">#</a> Prothemeus 监控 nginx</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">unzip</span> <span class="string">nginx-module-vts-master.zip</span></span><br><span class="line"><span class="string">mv</span> <span class="string">nginx-module-vts-master</span> <span class="string">/usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="string">tar</span> <span class="string">zxvf</span> <span class="string">nginx-1.15.7.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">nginx-1.15.7</span></span><br><span class="line"><span class="string">./configure</span>  <span class="string">--prefix=/usr/local/nginx</span> <span class="string">--with-http_gzip_static_module</span> <span class="string">--with-http_stub_status_module</span> <span class="string">--with-http_ssl_module</span> <span class="string">--with-pcre</span> <span class="string">--with-file-aio</span> <span class="string">--with-http_realip_module</span> <span class="string">--add-module=/usr/local/nginx-module-vts-master</span></span><br><span class="line"></span><br><span class="line"><span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="string">修改nginx配置文件：</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="string">server下添加如下：</span></span><br><span class="line"><span class="string">location</span> <span class="string">/status</span> &#123;</span><br><span class="line">        <span class="string">vhost_traffic_status_display;</span></span><br><span class="line">        <span class="string">vhost_traffic_status_display_format</span> <span class="string">html;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="string">http中添加如下：</span></span><br><span class="line"><span class="string">vhost_traffic_status_zone;</span></span><br><span class="line"><span class="string">nginx</span> <span class="string">-s</span> <span class="string">reload</span></span><br><span class="line"><span class="string">访问192.168.124.16/status可以看到nginx监控数据</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.安装nginx-vts-exporter</span></span><br><span class="line"><span class="string">unzip</span>  <span class="string">nginx-vts-exporter-0.5.zip</span></span><br><span class="line"><span class="string">mv</span> <span class="string">nginx-vts-exporter-0.5</span>  <span class="string">/usr/local/</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/nginx-vts-exporter-0.5/bin/nginx-vts-exporter</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/nginx-vts-exporter-0.5/bin</span></span><br><span class="line"><span class="string">nohup</span> <span class="string">./nginx-vts-exporter</span>  <span class="string">-nginx.scrape_uri</span> <span class="string">http://192.168.124.16/status/format/json</span> <span class="string">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.修改prometheus-cfg.yaml文件</span></span><br><span class="line"><span class="string">添加如下job：</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;nginx&#x27;</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.124.16:9913&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控-mongodb"><a class="markdownIt-Anchor" href="#prometheus-监控-mongodb">#</a> prometheus 监控 mongodb</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1.下载mongodb和mongodb_exporter镜像</span><br><span class="line">docker pull mongo</span><br><span class="line">docker pull eses/mongodb_exporter</span><br><span class="line"></span><br><span class="line">2.启动mongodb</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/db</span><br><span class="line">docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db mongo</span><br><span class="line"><span class="comment">#创建mongo账号密码，给mongodb_exporter连接mongo用</span></span><br><span class="line">（1）登录到容器</span><br><span class="line">docker <span class="built_in">exec</span> -it 24f910190790ade396844cef61cc66412b7af2108494742922c6157c5b236aac mongo admin</span><br><span class="line">（2）设置密码</span><br><span class="line">use admin</span><br><span class="line">db.createUser(&#123; user: <span class="string">&#x27;admin&#x27;</span>, <span class="built_in">pwd</span>: <span class="string">&#x27;admin111111&#x27;</span>, roles: [ &#123; role: <span class="string">&quot;userAdminAnyDatabase&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ] &#125;)</span><br><span class="line"></span><br><span class="line">docker run -d --name mongodb_exporter -p 30056:9104  percona/mongodb_exporter:0.34.0   --mongodb.uri mongodb://admin:admin111111@192.168.124.16:27017</span><br><span class="line"></span><br><span class="line">注：admin:admin111111这个就是上面启动mongodb后设置的密码，@后面接mongodb的ip和端口</span><br><span class="line"></span><br><span class="line">4.修改prometheus-cfg.yaml文件</span><br><span class="line">添加一个job_name</span><br><span class="line">- job_name: <span class="string">&#x27;mongodb&#x27;</span></span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [<span class="string">&#x27;192.168.124.16:30056&#x27;</span>]</span><br><span class="line"></span><br><span class="line">kubectl apply -f prometheus-cfg.yaml</span><br><span class="line">kubectl delete -f prometheus-deploy.yaml</span><br><span class="line">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>
<h3 id="pushgateway"><a class="markdownIt-Anchor" href="#pushgateway">#</a> pushgateway</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Pushgateway是prometheus的一个组件，prometheus server默认是通过exporter主动获取数据（默认采取pull拉取数据），pushgateway则是通过被动方式推送数据到prometheus server，用户可以写一些自定义的监控脚本把需要监控的数据发送给pushgateway， 然后pushgateway再把数据发送给Prometheus server</span><br><span class="line"></span><br><span class="line">Pushgateway优点：</span><br><span class="line">Prometheus 默认采用定时pull 模式拉取targets数据，但是如果不在一个子网或者防火墙，prometheus就拉取不到targets数据，所以可以采用各个target往pushgateway上push数据，然后prometheus去pushgateway上定时pull数据</span><br><span class="line">在监控业务数据的时候，需要将不同数据汇总, 汇总之后的数据可以由pushgateway统一收集，然后由 Prometheus 统一拉取。</span><br><span class="line"></span><br><span class="line">pushgateway缺点：</span><br><span class="line">Prometheus拉取状态只针对 pushgateway, 不能对每个节点都有效；</span><br><span class="line">Pushgateway出现问题，整个采集到的数据都会出现问题</span><br><span class="line">监控下线，prometheus还会拉取到旧的监控数据，需要手动清理 pushgateway不要的数据。</span><br><span class="line"></span><br><span class="line">docker push prom/pushgateway</span><br><span class="line">docker run -d --name pushgateway -p 9091:9091 prom/pushgateway</span><br><span class="line"></span><br><span class="line">    - job_name: <span class="string">&#x27;pushgateway&#x27;</span></span><br><span class="line">      scrape_interval: 5s</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [<span class="string">&#x27;192.168.13.181:9091&#x27;</span>]</span><br><span class="line">      honor_labels: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f prometheus-cfg.yaml</span><br><span class="line">kubectl delete -f prometheus-deploy.yaml</span><br><span class="line">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230529153332021.png" alt="image-20230529153332021"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">推送指定的数据格式到pushgateway</span><br><span class="line"></span><br><span class="line">向 &#123;job=<span class="string">&quot;test_job&quot;</span>&#125; 添加单条数据：</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; metric 3.6&quot;</span> | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job</span><br><span class="line"></span><br><span class="line">添加复杂数据</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span></span><br><span class="line"><span class="string">node_memory_usage 36</span></span><br><span class="line"><span class="string">node_memory_total 36000</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">删除某个组下某个实例的所有数据</span><br><span class="line">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span><br><span class="line"></span><br><span class="line">删除某个组下的所有数据：</span><br><span class="line">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">把数据上报到pushgateway</span><br><span class="line">在被监控服务所在的机器配置数据上报,想要把192.168.13.181这个机器的内存数据上报到pushgateway，下面步骤需要在192.168.40.181操作</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> push.sh</span><br><span class="line"></span><br><span class="line">node_memory_usages=$(free -m | grep Mem | awk <span class="string">&#x27;&#123;print $3/$2*100&#125;&#x27;</span>)</span><br><span class="line">job_name=<span class="string">&quot;memory&quot;</span></span><br><span class="line">instance_name=<span class="string">&quot;192.168.13.181&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/$job_name/instance/$instance_name</span></span><br><span class="line"><span class="string">node_memory_usages $node_memory_usages</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh push.sh</span><br><span class="line"></span><br><span class="line">crontab -u root -e</span><br><span class="line">*/1 * * * * /root/push.sh</span><br><span class="line"></span><br><span class="line">注意：从上面配置可以看到，我们上传到pushgateway中的数据有job也有instance，而prometheus配置pushgateway这个job_name中也有job和instance，这个job和instance是指pushgateway实例本身，添加 honor_labels: <span class="literal">true</span> 参数， 可以避免promethues的targets列表中的job_name是pushgateway的 job 、instance 和上报到pushgateway数据的job和instance冲突。</span><br></pre></td></tr></table></figure>
<h2 id="elk"><a class="markdownIt-Anchor" href="#elk">#</a> ELK</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">日志打印的常见级别：</span><br><span class="line">日志打印通常有四种级别，从高到底分别是：ERROR、WARN、INFO、DEBUG。</span><br><span class="line"></span><br><span class="line">在你的系统中如果开启了某一级别的日志后，就不会打印比它级别低的日志。例如，程序如果开启了INFO级别日志，DEBUG日志就不会打印，通常在生产环境中开启INFO日志。</span><br><span class="line"></span><br><span class="line">1、DEBUG：</span><br><span class="line">DEBU可以打印出最详细的日志信息，主要用于开发过程中打印一些运行信息。</span><br><span class="line">2、INFO：</span><br><span class="line">INFO可以打印一些你感兴趣的或者重要的信息，这个可以用于生产环境中输出程序运行的一些重要信息，但是不能滥用，避免打印过多的日志。</span><br><span class="line">3、WARNING： </span><br><span class="line">WARNING 表明发生了一些暂时不影响运行的错误，会出现潜在错误的情形，有些信息不是错误信息，但是也要给程序员的一些提示 </span><br><span class="line">4、ERROR：</span><br><span class="line">ERROR 可以打印错误和异常信息，如果不想输出太多的日志，可以使用这个级别，这一级就是比较重要的错误了，软件的某些功能已经不能继续执行了。</span><br><span class="line"></span><br><span class="line">通过查看INFO日志发现是由于自己操作失误，造成了程序结果和预期不符合，这种情况不是程序出错，所以并不是bug，不需要开发人员到场。</span><br><span class="line">通过查看INFO日志发现自己的操作正确，根据INFO日志查看并不是操作失误造成，这个时候就需要开发人员到场确认。</span><br><span class="line"></span><br><span class="line">ERROR和WARN的级别都比INFO要高，所以在设定日志级别在INFO时，这两者的日志也会被打印。根据上面INFO和DEBUG级别的区别以及适用人员可以知道，ERROR和WARN是同时给测试和开发、运维观察的。WARN级别称之为“警告”，这个“警告”实际上就有点含糊了，它不算错，你可以选择忽视它，但也可以选择重视它。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">常见的日志收集方案</span><br><span class="line">EFK</span><br><span class="line">在Kubernetes集群上运行多个服务和应用程序时，日志收集系统可以帮助你快速分类和分析由Pod生成的大量日志数据。Kubernetes中比较流行的日志收集解决方案是Elasticsearch、Fluentd和Kibana（EFK）技术栈，也是官方推荐的一种方案。</span><br><span class="line"></span><br><span class="line">Elasticsearch是一个实时的，分布式的，可扩展的搜索引擎，它允许进行全文本和结构化搜索以及对日志进行分析。它通常用于索引和搜索大量日志数据，也可以用于搜索许多不同种类的文档。</span><br><span class="line"></span><br><span class="line">Elasticsearch通常与Kibana一起部署，kibana可以把Elasticsearch采集到的数据通过dashboard（仪表板）可视化展示出来。Kibana允许你通过Web界面浏览Elasticsearch日志数据，也可自定义查询条件快速检索出elasticccsearch中的日志数据。</span><br><span class="line"></span><br><span class="line">Fluentd是一个流行的开源数据收集器，我们在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</span><br><span class="line"></span><br><span class="line">ELK</span><br><span class="line">E - Elasticsearch（简称：ES）</span><br><span class="line">L - Logstash</span><br><span class="line">K - Kibana</span><br><span class="line">Elasticsearch：日志存储和搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</span><br><span class="line"></span><br><span class="line">Logstash：是一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作。）。</span><br><span class="line"></span><br><span class="line">Kibana 也是一个开源和免费的工具，Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ELK+filebeat</span><br><span class="line">Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line"></span><br><span class="line">2.4 其他方案</span><br><span class="line">ELK日志流程可以有多种方案（不同组件可自由组合，根据自身业务配置），常见有以下：</span><br><span class="line"></span><br><span class="line">    Logstash（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Logstash（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Filebeat（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">Filebeat（采集）—&gt; Kafka/Redis(消峰) —&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br></pre></td></tr></table></figure>
<h3 id="efk组件"><a class="markdownIt-Anchor" href="#efk组件">#</a> efk 组件</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch 是一个分布式的免费开源搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。</span><br><span class="line">Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。</span><br><span class="line">人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana），目前 Elastic Stack 包括一系列丰富的轻量型数据采集代理，这些代理统称为 Beats，可用来向 Elasticsearch 发送数据。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filebeat是Beats中的一员。</span><br><span class="line">　　Beats是一个轻量级日志采集器，Beats家族有6个成员，早期的ELK架构中使用Logstash收集、解析日志，但是Logstash对内存、cpu、io等资源消耗比较高。相比Logstash，Beats所占系统的CPU和内存几乎可以忽略不计。</span><br><span class="line"></span><br><span class="line">目前Beats包含六种工具：</span><br><span class="line">1、Packetbeat：网络数据（收集网络流量数据）</span><br><span class="line">2、Metricbeat：指标（收集系统、进程和文件系统级别的CPU和内存使用情况等数据）</span><br><span class="line">3、Filebeat：日志文件（收集文件数据）</span><br><span class="line">4、Winlogbeat：windows事件日志（收集Windows事件日志数据）</span><br><span class="line">5、Auditbeat：审计数据（收集审计日志）</span><br><span class="line">6、Heartbeat：运行时间监控（收集系统运行时的数据）</span><br><span class="line"></span><br><span class="line">Filebeat是用于转发和收集日志数据的轻量级传送工具。Filebeat监视你指定的日志文件或位置，收集日志事件，并将它们转发到Elasticsearch或 Logstash中。</span><br><span class="line">Filebeat的工作方式如下：启动Filebeat时，它将启动一个或多个输入，这些输入将在为日志数据指定的位置中查找。对于Filebeat所找到的每个日志，Filebeat都会启动收集器。每个收集器都读取单个日志以获取新内容，并将新日志数据发送到libbeat，libbeat将聚集事件，并将聚集的数据发送到为Filebeat配置的输出。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530142835668.png" alt="image-20230530142835668"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Filebeat 有两个主要组件：</span><br><span class="line">    harvester：一个harvester负责读取一个单个文件的内容。harvester逐行读取每个文件，并把这些内容发送到输出。每个文件启动一个harvester。</span><br><span class="line">    Input：一个input负责管理harvesters，并找到所有要读取的源。如果input类型是log，则input查找驱动器上与已定义的log日志路径匹配的所有文件，并为每个文件启动一个harvester。</span><br><span class="line">    </span><br><span class="line">Filebeat工作原理</span><br><span class="line">在任何环境下，应用程序都有停机的可能性。 Filebeat 读取并转发日志行，如果中断，则会记住所有事件恢复联机状态时所在位置。</span><br><span class="line">Filebeat带有内部模块（auditd，Apache，Nginx，System和MySQL），可通过一个指定命令来简化通用日志格式的收集，解析和可视化。</span><br><span class="line">FileBeat 不会让你的管道超负荷。FileBeat 如果是向 Logstash 传输数据，当 Logstash 忙于处理数据，会通知 FileBeat 放慢读取速度。一旦拥塞得到解决，FileBeat将恢复到原来的速度并继续传播。</span><br><span class="line">Filebeat保持每个文件的状态，并经常刷新注册表文件中的磁盘状态。状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。Filebeat将每个事件的传递状态存储在注册表文件中。所以它能保证事件至少传递一次到配置的输出，没有数据丢失。</span><br><span class="line"></span><br><span class="line">传输方案</span><br><span class="line">1、output.elasticsearch</span><br><span class="line">如果你希望使用 filebeat 直接向 elasticsearch 输出数据，需要配置 output.elasticsearch</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.40.180:9200&quot;]</span><br><span class="line">2、output.logstash</span><br><span class="line">如果使用filebeat向 logstash输出数据，然后由 logstash 再向elasticsearch 输出数据，需要配置 output.logstash。 logstash 和 filebeat 一起工作时，如果 logstash 忙于处理数据，会通知FileBeat放慢读取速度。一旦拥塞得到解决，FileBeat 将恢复到原来的速度并继续传播。这样，可以减少管道超负荷的情况。</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.40.180:5044&quot;]  </span><br><span class="line">  </span><br><span class="line">3、output.kafka</span><br><span class="line">如果使用filebeat向kafka输出数据，然后由 logstash 作为消费者拉取kafka中的日志，并再向elasticsearch 输出数据，需要配置 output.logstash</span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;192.168.40.180:9092&quot;]</span><br><span class="line">  topic: elfk8stest</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">logstash组件介绍</span><br><span class="line">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。Logstash 是一个应用程序日志、事件的传输、处理、管理和搜索的平台。你可以用它来统一对应用程序日志进行收集管理，提供 Web 接口用于查询和统计。</span><br><span class="line">输入：采集各种样式、大小和来源的数据</span><br><span class="line">数据往往以各种各样的形式，或分散或集中地存在于很多系统中。Logstash 支持各种输入选择 ，可以在同一时间从众多常用来源捕捉事件。能够以连续的流式传输方式，轻松地从你的日志、指标、Web 应用、数据存储以及各种 AWS 服务采集数据。</span><br><span class="line"></span><br><span class="line">过滤器：实时解析和转换数据</span><br><span class="line">数据从源传输到存储库的过程中，Logstash 过滤器能够解析各个事件，识别已命名的字段以构建结构，并将它们转换成通用格式，以便更轻松、更快速地分析和实现商业价值。</span><br><span class="line">Logstash 能够动态地转换和解析数据，不受格式或复杂度的影响：</span><br><span class="line">1、利用 Grok 从非结构化数据中派生出结构</span><br><span class="line">2、从 IP 地址破译出地理坐标</span><br><span class="line">3、将 PII 数据匿名化，完全排除敏感字段</span><br><span class="line">4、整体处理不受数据源、格式或架构的影响</span><br><span class="line"></span><br><span class="line">输出：选择你的存储，导出你的数据</span><br><span class="line">尽管 Elasticsearch 是我们的首选输出方向，能够为我们的搜索和分析带来无限可能，但它并非唯一选择。Logstash 提供众多输出选择，你可以将数据发送到你要指定的地方。 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530143914957.png" alt="image-20230530143914957"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Logstash 有两个必要元素：input 和 output ，一个可选元素：filter。 这三个元素，分别代表 Logstash 事件处理的三个阶段：输入 &gt; 过滤器 &gt; 输出</span><br><span class="line"></span><br><span class="line">Input负责从数据源采集数据。</span><br><span class="line">filter 将数据修改为你指定的格式或内容。</span><br><span class="line">output 将数据传输到目的地。</span><br><span class="line"></span><br><span class="line">在实际应用场景中，通常输入、输出、过滤器不止一个。Logstash 的这三个元素都使用插件式管理方式，可以根据应用需要，灵活的选用各阶段需要的插件，并组合使用。</span><br><span class="line"></span><br><span class="line">常用input模块</span><br><span class="line">    file：从文件系统上的文件读取</span><br><span class="line">    syslog：在众所周知的端口514上侦听系统日志消息，并根据RFC3164格式进行解析</span><br><span class="line">    redis：从redis服务器读取，使用redis通道和redis列表。 Redis经常用作集中式Logstash安装中的“代理”，它将接收来自远程Logstash“托运人”的Logstash事件排队。</span><br><span class="line">    beats：处理由Filebeat发送的事件。</span><br><span class="line"></span><br><span class="line">常用的filter模块</span><br><span class="line">    过滤器是Logstash管道中的中间处理设备。可以将条件过滤器组合在一起，对事件执行操作。</span><br><span class="line">    grok：解析和结构任意文本。 Grok目前是Logstash中将非结构化日志数据解析为结构化和可查询的最佳方法。</span><br><span class="line">    mutate：对事件字段执行一般转换。可以重命名，删除，替换和修改事件中的字段。</span><br><span class="line">    drop：完全放弃一个事件，例如调试事件。</span><br><span class="line">    clone：制作一个事件的副本，可能会添加或删除字段。</span><br><span class="line">    geoip：添加有关IP地址的地理位置的信息</span><br><span class="line"></span><br><span class="line">常用output</span><br><span class="line">    elasticsearch：将事件数据发送给 Elasticsearch（推荐模式）。</span><br><span class="line">    file：将事件数据写入文件或磁盘。</span><br><span class="line">    graphite：将事件数据发送给 graphite（一个流行的开源工具，存储和绘制指标， http://graphite.readthedocs.io/en/latest/）。</span><br><span class="line">    statsd：将事件数据发送到 statsd （这是一种侦听统计数据的服务，如计数器和定时器，通过UDP发送并将聚合发送到一个或多个可插入的后端服务）。</span><br><span class="line">    </span><br><span class="line">input &#123;</span><br><span class="line">      kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; &quot;192.168.40.180:9092&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        decorate_events =&gt; true</span><br><span class="line">        topics =&gt; [&quot;elktest&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">output &#123; </span><br><span class="line">    elasticsearch &#123; </span><br><span class="line">        hosts =&gt; [&quot;192.168.40.180:9200&quot;]</span><br><span class="line">        index =&gt; &quot;elkk8stest-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fluentd是一个针对日志的收集、处理、转发系统。通过丰富的插件系统，可以收集来自于各种系统或应用的日志，转化为用户指定的格式后，转发到用户所指定的日志存储系统之中。</span><br><span class="line">fluentd 常常被拿来和Logstash比较，我们常说ELK，L就是这个agent。fluentd 是随着Docker和es一起流行起来的agent。</span><br><span class="line">fluentd 比 logstash 更省资源；</span><br><span class="line">更轻量级的 fluent-bid 对应 filebeat，作为部署在结点上的日志收集器；</span><br><span class="line">fluentd 有更多强大、开放的插件数量和社区。插件多，也非常灵活，规则也不复杂。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">fluentd、filebeat、logstash对比分析</span><br><span class="line"></span><br><span class="line">Logstash</span><br><span class="line">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。</span><br><span class="line">优势</span><br><span class="line">Logstash 主要的优点就是它的灵活性，主要因为它有很多插件，详细的文档以及直白的配置格式让它可以在多种场景下应用。我们基本上可以在网上找到很多资源，几乎可以处理任何问题。</span><br><span class="line">劣势</span><br><span class="line">Logstash 致命的问题是它的性能以及资源消耗(默认的堆大小是 1GB)。尽管它的性能在近几年已经有很大提升，与它的替代者们相比还是要慢很多的。这里有 Logstash 与 rsyslog 性能对比以及Logstash 与 filebeat 的性能对比。它在大数据量的情况下会是个问题。</span><br><span class="line">另一个问题是它目前不支持缓存，目前的典型替代方案是将 Redis 或 Kafka 作为中心缓冲池：</span><br><span class="line">因为 Logstash 自身的灵活性以及网络上丰富的资料，Logstash 适用于原型验证阶段使用，或者解析非常的复杂的时候。在不考虑服务器资源的情况下，如果服务器的性能足够好，我们也可以为每台服务器安装 Logstash 。我们也不需要使用缓冲，因为文件自身就有缓冲的行为，而 Logstash 也会记住上次处理的位置。</span><br><span class="line">如果服务器性能较差，并不推荐为每个服务器安装 Logstash ，这样就需要一个轻量的日志传输工具，将数据从服务器端经由一个或多个 Logstash 中心服务器传输到 Elasticsearch：</span><br><span class="line"></span><br><span class="line">Filebeat</span><br><span class="line">作为 Beats 家族的一员，Filebeat 是一个轻量级的日志传输工具，它的存在正弥补了 Logstash 的缺点：Filebeat 作为一个轻量级的日志传输工具可以将日志推送到中心 Logstash。</span><br><span class="line">在版本 5.x 中，Elasticsearch 具有解析的能力(像 Logstash 过滤器)— Ingest。这也就意味着可以将数据直接用 Filebeat 推送到 Elasticsearch，并让 Elasticsearch 既做解析的事情，又做存储的事情。也不需要使用缓冲，因为 Filebeat 也会和 Logstash 一样记住上次读取的偏移，如果需要缓冲(例如，不希望将日志服务器的文件系统填满)，可以使用 Redis/Kafka，因为 Filebeat 可以与它们进行通信。</span><br><span class="line">优势</span><br><span class="line">Filebeat 只是一个二进制文件没有任何依赖。它占用资源极少，尽管它还十分年轻，正式因为它简单，所以几乎没有什么可以出错的地方，所以它的可靠性还是很高的。它也为我们提供了很多可以调节的点，例如：它以何种方式搜索新的文件，以及当文件有一段时间没有发生变化时，何时选择关闭文件句柄。</span><br><span class="line">劣势</span><br><span class="line">Filebeat 的应用范围十分有限，所以在某些场景下我们会碰到问题。例如，如果使用 Logstash 作为下游管道，我们同样会遇到性能问题。正因为如此，Filebeat 的范围在扩大。开始时，它只能将日志发送到 Logstash 和 Elasticsearch，而现在它可以将日志发送给 Kafka 和 Redis，在 5.x 版本中，它还具备过滤的能力。</span><br><span class="line"></span><br><span class="line">Fluentd</span><br><span class="line">Fluentd 创建的初衷主要是尽可能的使用 JSON 作为日志输出，所以传输工具及其下游的传输线不需要猜测子字符串里面各个字段的类型。这样，它为几乎所有的语言都提供库，这也意味着，我们可以将它插入到我们自定义的程序中。</span><br><span class="line">优势</span><br><span class="line">和多数 Logstash 插件一样，Fluentd 插件是用 Ruby 语言开发的非常易于编写维护。所以它数量很多，几乎所有的源和目标存储都有插件(各个插件的成熟度也不太一样)。这也意味这我们可以用 Fluentd 来串联所有的东西。</span><br><span class="line">劣势</span><br><span class="line">因为在多数应用场景下，我们会通过 Fluentd 得到结构化的数据，它的灵活性并不好。但是我们仍然可以通过正则表达式，来解析非结构化的数据。尽管，性能在大多数场景下都很好，但它并不是最好的，和 syslog-ng 一样，它的缓冲只存在与输出端，单线程核心以及 Ruby GIL 实现的插件意味着它大的节点下性能是受限的，不过，它的资源消耗在大多数场景下是可以接受的。对于小的或者嵌入式的设备，可能需要看看 Fluent Bit，它和 Fluentd 的关系与 Filebeat 和 Logstash 之间的关系类似。</span><br><span class="line"></span><br><span class="line">Logagent</span><br><span class="line">Logagent 是 Sematext 提供的传输工具，它用来将日志传输到 Logsene(一个基于 SaaS 平台的 Elasticsearch API)，因为 Logsene 会暴露 Elasticsearch API，所以 Logagent 可以很容易将数据推送到 Elasticsearch 。</span><br><span class="line">优势</span><br><span class="line">可以获取 /var/log 下的所有信息，解析各种格式(Elasticsearch，Solr，MongoDB，Apache HTTPD等等)，它可以掩盖敏感的数据信息，例如，个人验证信息(PII)，出生年月日，信用卡号码，等等。它还可以基于 IP 做 GeoIP 丰富地理位置信息(例如，access logs)。同样，它轻量又快速，可以将其置入任何日志块中。在新的 2.0 版本中，它以第三方 node.js 模块化方式增加了支持对输入输出的处理插件。重要的是 Logagent 有本地缓冲，所以不像 Logstash ，在数据传输目的地不可用时会丢失日志。</span><br><span class="line">劣势</span><br><span class="line">尽管 Logagent 有些比较有意思的功能(例如，接收 Heroku 或 CloudFoundry 日志)，但是它并没有 Logstash 灵活。</span><br><span class="line"></span><br><span class="line">logtail</span><br><span class="line">阿里云日志服务的生产者，目前在阿里集团内部机器上运行，经过3年多时间的考验，目前为阿里公有云用户提供日志收集服务。</span><br><span class="line">采用C++语言实现，对稳定性、资源控制、管理等下过很大的功夫，性能良好。相比于logstash、fluentd的社区支持，logtail功能较为单一，专注日志收集功能。</span><br><span class="line">优势</span><br><span class="line">logtail占用机器cpu、内存资源最少，结合阿里云日志服务的E2E体验良好。</span><br><span class="line">劣势</span><br><span class="line">logtail目前对特定日志类型解析的支持较弱，后续需要把这一块补起来。</span><br><span class="line"></span><br><span class="line">rsyslog</span><br><span class="line">绝大多数 Linux 发布版本默认的 syslog 守护进程，rsyslog 可以做的不仅仅是将日志从 syslog socket 读取并写入 /var/log/messages 。它可以提取文件、解析、缓冲(磁盘和内存)以及将它们传输到多个目的地，包括 Elasticsearch 。可以从此处找到如何处理 Apache 以及系统日志。</span><br><span class="line">优势</span><br><span class="line">rsyslog 是经测试过的最快的传输工具。如果只是将它作为一个简单的 router/shipper 使用，几乎所有的机器都会受带宽的限制，但是它非常擅长处理解析多个规则。它基于语法的模块(mmnormalize)无论规则数目如何增加，它的处理速度始终是线性增长的。这也就意味着，如果当规则在 20-30 条时，如解析 Cisco 日志时，它的性能可以大大超过基于正则式解析的 grok ，达到 100 倍(当然，这也取决于 grok 的实现以及 liblognorm 的版本)。</span><br><span class="line">它同时也是我们能找到的最轻的解析器，当然这也取决于我们配置的缓冲。</span><br><span class="line">劣势</span><br><span class="line">rsyslog 的配置工作需要更大的代价(这里有一些例子)，这让两件事情非常困难：</span><br><span class="line">文档难以搜索和阅读，特别是那些对术语比较陌生的开发者。</span><br><span class="line">5.x 以上的版本格式不太一样(它扩展了 syslogd 的配置格式，同时也仍然支持旧的格式)，尽管新的格式可以兼容旧格式，但是新的特性(例如，Elasticsearch 的输出)只在新的配置下才有效，然后旧的插件(例如，Postgres 输出)只在旧格式下支持。</span><br></pre></td></tr></table></figure>
<h3 id="安装elasticsearch"><a class="markdownIt-Anchor" href="#安装elasticsearch">#</a> 安装 elasticsearch</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">.创建一个kube-logging名称空间，将EFK组件安装到该名称空间中。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在这个名称空间下去安装日志收集组件efk，首先，我们需要部署一个有3个节点的Elasticsearch集群。我们使用3个Elasticsearch</span> <span class="string">Pods可以避免高可用中的多节点群集中发生的“裂脑”的问题。</span> <span class="string">Elasticsearch脑裂可参考如下：https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.创建一个headless</span> <span class="string">service的Kubernetes服务，服务名称是elasticsearch，这个服务将为3个Pod定义一个DNS域。headless</span> <span class="string">service不具备负载均衡也没有IP。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9300</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">inter-node</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="number">3</span><span class="string">.</span> <span class="string">创建Storageclass，实现存储类动态供给</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nfs</span> <span class="string">--now</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/data/v1</span> <span class="string">-p</span></span><br><span class="line"><span class="string">/data/v1</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nfs</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.创建nfs作为存储的供应商</span></span><br><span class="line"><span class="number">1</span><span class="string">、创建sa</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="number">2</span><span class="string">、对sa做rbac授权</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;use&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=RemoveSelfLink=false</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span> <span class="comment"># 可能导致6443暂时无法访问</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">kube-apiserver</span> <span class="comment"># 高可用时需要改一个文件删一个api-server</span></span><br><span class="line"></span><br><span class="line"><span class="string">工作节点：</span></span><br><span class="line"> <span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span> <span class="string">nfs-client-provisioner.tar.gz</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#通过deployment创建pod用来运行nfs-provisioner</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/xianchao/nfs-client-provisioner:v1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">example.com/nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/data/v1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/v1</span></span><br><span class="line"><span class="comment">#创建stoorageclass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">do-block-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 安装elasticsearch集群</span></span><br><span class="line"><span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span> <span class="string">elasticsearch_7_2_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.2.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9200</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9300</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">inter-node</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster.name</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">k8s-logs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node.name</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">discovery.seed_hosts</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;es-cluster-0.elasticsearch.kube-logging.svc.cluster.local,es-cluster-1.elasticsearch.kube-logging.svc.cluster.local,es-cluster-2.elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster.initial_master_nodes</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;es-cluster-0,es-cluster-1,es-cluster-2&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms512m -Xmx512m&quot;</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fix-permissions</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;chown -R 1000:1000 /usr/share/elasticsearch/data&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-vm-max-map</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sysctl&quot;</span>, <span class="string">&quot;-w&quot;</span>, <span class="string">&quot;vm.max_map_count=262144&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-fd-ulimit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ulimit -n 65536&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">do-block-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"></span><br><span class="line"><span class="string">pod部署完成之后，可以通过REST</span> <span class="string">API检查elasticsearch集群是否部署成功，使用下面的命令将本地端口9200转发到</span> <span class="string">Elasticsearch</span> <span class="string">节点（如es-cluster-0）对应的端口：</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">port-forward</span> <span class="string">es-cluster-0</span> <span class="number">9200</span><span class="string">:9200</span> <span class="string">--namespace=kube-logging</span></span><br><span class="line"><span class="string">curl</span> <span class="string">http://localhost:9200/_cat/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建kibaba</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: kube-logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5601</span><br><span class="line">  selector:</span><br><span class="line">    app: kibana</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: kube-logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: docker.elastic.co/kibana/kibana:7.2.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          - name: ELASTICSEARCH_URL</span><br><span class="line">            value: http://elasticsearch.kube-logging.svc.cluster.local:9200</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装fluentd组件</span></span><br><span class="line"><span class="string">我们使用daemonset控制器部署fluentd组件，这样可以保证集群中的每个节点都可以运行同样fluentd的pod副本，这样就可以收集k8s集群中每个节点的日志，在k8s集群中，容器应用程序的输入输出日志会重定向到node节点里的json文件中，fluentd可以tail和过滤以及把日志转换成指定的格式发送到elasticsearch集群中。除了容器日志，fluentd也可以采集kubelet、kube-proxy、docker的日志。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">fluentd</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">fluentd</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fluent/fluentd-kubernetes-daemonset:v1.4.2-debian-elasticsearch-1.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">FLUENT_ELASTICSEARCH_HOST</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">FLUENT_ELASTICSEARCH_PORT</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;9200&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENT_ELASTICSEARCH_SCHEME</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;http&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENTD_SYSTEMD_CONF</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">disable</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="测试pod"><a class="markdownIt-Anchor" href="#测试pod">#</a> 测试 pod</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">count</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>,<span class="string">&#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143741555.png" alt="image-20230531143741555"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143701392.png" alt="image-20230531143701392"></p>
<p>[Kibana Query Language | Kibana Guide <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9raWJhbmEvNy4yL2t1ZXJ5LXF1ZXJ5Lmh0bWw=">7.2] | Elastic</span></p>
<h2 id="ceph"><a class="markdownIt-Anchor" href="#ceph">#</a> ceph</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ceph是一种开源的分布式的存储系统</span><br><span class="line">包含以下几种存储类型：</span><br><span class="line">块存储（rbd），对象存储(RADOS Fateway)，文件系统（cephfs）</span><br><span class="line"></span><br><span class="line">1.块存储（rbd）：</span><br><span class="line">块是一个字节序列（例如，512字节的数据块）。 基于块的存储接口是使用旋转介质（如硬盘，CD，软盘甚至传统的9轨磁带）存储数据的最常用方法;Ceph块设备是精简配置，可调整大小并存储在Ceph集群中多个OSD条带化的数据。 Ceph块设备利用RADOS功能，如快照，复制和一致性。 Ceph的RADOS块设备（RBD）使用内核模块或librbd库与OSD进行交互;Ceph的块设备为内核模块或QVM等KVM以及依赖libvirt和QEMU与Ceph块设备集成的OpenStack和CloudStack等基于云的计算系统提供高性能和无限可扩展性。 可以使用同一个集群同时运行Ceph RADOS Gateway，CephFS文件系统和Ceph块设备。</span><br><span class="line">linux系统中，ls /dev/下有很多块设备文件，这些文件就是我们添加硬盘时识别出来的；</span><br><span class="line">rbd就是由Ceph集群提供出来的块设备。可以这样理解，sda是通过数据线连接到了真实的硬盘，而rbd是通过网络连接到了Ceph集群中的一块存储区域，往rbd设备文件写入数据，最终会被存储到Ceph集群的这块区域中；</span><br><span class="line">总结：块设备可理解成一块硬盘，用户可以直接使用不含文件系统的块设备，也可以将其格式化成特定的文件系统，由文件系统来组织管理存储空间，从而为用户提供丰富而友好的数据操作支持。</span><br><span class="line"></span><br><span class="line">2.文件系统cephfs</span><br><span class="line">Ceph文件系统（CephFS）是一个符合POSIX标准的文件系统，它使用Ceph存储集群来存储其数据。 Ceph文件系统使用与Ceph块设备相同的Ceph存储集群系统。</span><br><span class="line">用户可以在块设备上创建xfs文件系统，也可以创建ext4等其他文件系统，Ceph集群实现了自己的文件系统来组织管理集群的存储空间，用户可以直接将Ceph集群的文件系统挂载到用户机上使用，Ceph有了块设备接口，在块设备上完全可以构建一个文件系统，那么Ceph为什么还需要文件系统接口呢？</span><br><span class="line">主要是因为应用场景的不同，Ceph的块设备具有优异的读写性能，但不能多处挂载同时读写，目前主要用在OpenStack上作为虚拟磁盘，而Ceph的文件系统接口读写性能较块设备接口差，但具有优异的共享性。</span><br><span class="line"></span><br><span class="line">3.对象存储</span><br><span class="line">Ceph对象存储使用Ceph对象网关守护进程（radosgw），它是一个用于与Ceph存储集群交互的HTTP服务器。由于它提供与OpenStack Swift和Amazon S3兼容的接口，因此Ceph对象网关具有自己的用户管理。 Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的相同Ceph存储集群中</span><br><span class="line">使用方式就是通过http协议上传下载删除对象（文件即对象）。</span><br><span class="line">老问题来了，有了块设备接口存储和文件系统接口存储，为什么还整个对象存储呢?</span><br><span class="line">Ceph的块设备存储具有优异的存储性能但不具有共享性，而Ceph的文件系统具有共享性然而性能较块设备存储差，为什么不权衡一下存储性能和共享性，整个具有共享性而存储性能好于文件系统存储的存储呢，对象存储就这样出现了。</span><br><span class="line"></span><br><span class="line">分布式存储的优点：</span><br><span class="line">高可靠：既满足存储读取不丢失，还要保证数据长期存储。 在保证部分硬件损坏后依然可以保证数据安全</span><br><span class="line">高性能：读写速度快</span><br><span class="line">可扩展：分布式存储的优势就是“分布式”，所谓的“分布式”就是能够将多个物理节点整合在一起形成共享的存储池，节点可以线性扩充，这样可以源源不断的通过扩充节点提升性能和扩大容量，这是传统存储阵列无法做到的</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Ceph核心组件介绍</span><br><span class="line">在ceph集群中，不管你是想要提供对象存储，块设备存储，还是文件系统存储，所有Ceph存储集群部署都是从设置每个Ceph节点，网络和Ceph存储开始 的。 Ceph存储集群至少需要一个Ceph Monitor，Ceph Manager和Ceph OSD（对象存储守护进程）。 运行Ceph Filesystem客户端时也需要Ceph元数据服务器。</span><br><span class="line"></span><br><span class="line">Monitors：Ceph监视器（ceph-mon）维护集群状态的映射，包括监视器映射，管理器映射，OSD映射和CRUSH映射。这些映射是Ceph守护进程相互协调所需的关键集群状态。监视器还负责管理守护进程和客户端之间的身份验证。冗余和高可用性通常至少需要三个监视器。</span><br><span class="line"></span><br><span class="line">Managers：Ceph Manager守护程序（ceph-mgr）负责跟踪运行时指标和Ceph集群的当前状态，包括存储利用率，当前性能指标和系统负载。 Ceph Manager守护进程还托管基于python的模块来管理和公开Ceph集群信息，包括基于Web的Ceph Dashboard和REST API。高可用性通常至少需要两名Managers。</span><br><span class="line"></span><br><span class="line">Ceph OSD：Ceph OSD（对象存储守护进程，ceph-osd）存储数据，处理数据复制，恢复，重新平衡，并通过检查其他Ceph OSD守护进程来获取心跳，为Ceph监视器和管理器提供一些监视信息。冗余和高可用性通常至少需要3个Ceph OSD。</span><br><span class="line"></span><br><span class="line">MDS：Ceph元数据服务器（MDS，ceph-mds）代表Ceph文件系统存储元数据（即，Ceph块设备和Ceph对象存储不使用MDS）。 Ceph元数据服务器允许POSIX文件系统用户执行基本命令（如ls，find等），而不会给Ceph存储集群带来巨大负担。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ceph集群</span></span><br><span class="line"><span class="comment">#在master1-admin节点安装ceph-deploy</span></span><br><span class="line"> yum install python-setuptools  ceph-deploy -y</span><br><span class="line"><span class="comment">#在master1-admin、node1-monitor和node2-osd节点安装ceph</span></span><br><span class="line">yum install ceph ceph-radosgw  -y</span><br><span class="line"></span><br><span class="line">[root@master1-admin ~]<span class="comment"># ceph --version</span></span><br><span class="line">ceph version 10.2.11 (e4b061b47f07f583c92a050d9e84b1813a35671e)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个目录，用于保存 ceph-deploy 生成的配置文件信息的</span></span><br><span class="line">[root@master1-admin ceph ~]<span class="comment"># cd /etc/ceph</span></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ceph-deploy new master1-admin node1-monitor node2-osd</span></span><br><span class="line"><span class="comment"># 执行会生成如下文件</span></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ls </span></span><br><span class="line">ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring  rbdmap</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.<span class="comment"># 追加如下参数</span></span><br><span class="line">osd_pool_default_size = 2</span><br><span class="line">mon clock drift allowed = 0.500</span><br><span class="line">mon clock drift warn backoff = 10</span><br><span class="line"></span><br><span class="line">mon clock drift allowed <span class="comment">#监视器间允许的时钟漂移量默认值0.05</span></span><br><span class="line">mon clock drift warn backoff <span class="comment">#时钟偏移警告的退避指数。默认值5</span></span><br><span class="line">ceph对每个mon之间的时间同步延时默认要求在0.05s之间，这个时间有的时候太短了。所以如果ceph集群如果出现clock问题就检查ntp时间同步或者适当放宽这个误差时间。</span><br><span class="line">cephx是认证机制是整个 Ceph 系统的用户名/密码</span><br><span class="line"></span><br><span class="line">2、配置初始monitor、收集所有的密钥</span><br><span class="line">[root@master1-admin]<span class="comment"># cd /etc/ceph</span></span><br><span class="line">[root@master1-admin]<span class="comment"># ceph-deploy mon create-initial</span></span><br><span class="line">[root@master1-admin]<span class="comment"># ls *.keyring</span></span><br><span class="line">ceph.bootstrap-mds.keyring  ceph.bootstrap-mgr.keyring  ceph.bootstrap-osd.keyring  ceph.bootstrap-rgw.keyring  ceph.client.admin.keyring  ceph.mon.keyring</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备osd</span></span><br><span class="line"><span class="built_in">cd</span> /etc/ceph/</span><br><span class="line">ceph-deploy osd prepare master1-admin:/dev/sdb </span><br><span class="line">ceph-deploy osd prepare node1-monitor:/dev/sdb </span><br><span class="line">ceph-deploy osd prepare node2-osd:/dev/sdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#激活osd</span></span><br><span class="line">ceph-deploy osd activate master1-admin:/dev/sdb1</span><br><span class="line">ceph-deploy osd activate node1-monitor:/dev/sdb1</span><br><span class="line">ceph-deploy osd activate node2-osd:/dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">ceph-deploy osd list master1-admin node1-monitor node2-osd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ceph文件系统</span></span><br><span class="line">创建mds</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph-deploy mds create master1-admin node1-monitor node2-osd</span></span><br><span class="line"></span><br><span class="line">查看ceph当前文件系统</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs ls   	</span></span><br><span class="line"></span><br><span class="line">No filesystems enabled</span><br><span class="line"></span><br><span class="line">一个cephfs至少要求两个librados存储池，一个为data，一个为metadata。当配置这两个存储池时，注意：</span><br><span class="line">1. 为metadata pool设置较高级别的副本级别，因为metadata的损坏可能导致整个文件系统不用</span><br><span class="line">2. 建议，metadata pool使用低延时存储，比如SSD，因为metadata会直接影响客户端的响应速度。</span><br><span class="line"></span><br><span class="line">创建存储池</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph osd pool create cephfs_data 128</span></span><br><span class="line">pool <span class="string">&#x27;cephfs_data&#x27;</span> created</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph osd pool create cephfs_metadata 128</span></span><br><span class="line">pool <span class="string">&#x27;cephfs_metadata&#x27;</span> created</span><br><span class="line"></span><br><span class="line">关于创建存储池</span><br><span class="line">确定 pg_num 取值是强制性的，因为不能自动计算。下面是几个常用的值：</span><br><span class="line">*少于 5 个 OSD 时可把 pg_num 设置为 128</span><br><span class="line">*OSD 数量在 5 到 10 个时，可把 pg_num 设置为 512</span><br><span class="line">*OSD 数量在 10 到 50 个时，可把 pg_num 设置为 4096</span><br><span class="line">*OSD 数量大于 50 时，你得理解权衡方法、以及如何自己计算 pg_num 取值</span><br><span class="line">*自己计算 pg_num 取值时可借助 pgcalc 工具</span><br><span class="line">随着 OSD 数量的增加，正确的 pg_num 取值变得更加重要，因为它显著地影响着集群的行为、以及出错时的数据持久性（即灾难性事件导致数据丢失的概率）。</span><br><span class="line"></span><br><span class="line">创建文件系统</span><br><span class="line">创建好存储池后，你就可以用 fs new 命令创建文件系统了</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs new xianchao cephfs_metadata cephfs_data</span></span><br><span class="line">new fs with metadata pool 2 and data pool 1</span><br><span class="line">其中：new后的fsname  可自定义</span><br><span class="line"></span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs ls              #查看创建后的cephfs</span></span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph mds stat          #查看mds节点状态</span></span><br><span class="line"></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ceph -s </span></span><br><span class="line">    cluster 66e0ffc8-fb71-40ee-bcc0-a6e87713ddac</span><br><span class="line">     health HEALTH_WARN</span><br><span class="line">            clock skew detected on mon.node2-osd</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="k8s挂载ceph-rbd"><a class="markdownIt-Anchor" href="#k8s挂载ceph-rbd">#</a> k8s 挂载 ceph rbd</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes要想使用ceph，需要在k8s的每个node节点安装ceph-common，把ceph节点上的ceph.repo文件拷贝到k8s各个节点/etc/yum.repos.d/目录下，然后在k8s的各个节点yum install ceph-common -y</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># scp /etc/yum.repos.d/ceph.repo 192.168.40.180:/etc/yum.repos.d/</span></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># scp /etc/yum.repos.d/ceph.repo 192.168.40.181:/etc/yum.repos.d/</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@masterk8s</span> <span class="string">~</span>]<span class="comment"># yum install ceph-common -y</span></span><br><span class="line">[<span class="string">root@nodek8s</span> <span class="string">~</span>]<span class="comment"># yum install ceph-common -y</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># scp /etc/ceph/* 192.168.40.180:/etc/ceph/</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># scp /etc/ceph/* 192.168.40.181:/etc/ceph/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ceph rbd</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8srbd1 6</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd create rbda -s 1024 -p k8srbd1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd feature disable  k8srbd1/rbda object-map fast-diff deep-flatten</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line">      <span class="attr">rbd:</span></span><br><span class="line">        <span class="attr">monitors:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.202:6789&#x27;</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="string">k8srbd1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">rbda</span></span><br><span class="line">        <span class="attr">fsType:</span> <span class="string">xfs</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">keyring:</span> <span class="string">/etc/ceph/ceph.client.admin.keyring</span></span><br><span class="line"></span><br><span class="line"><span class="string">k8srbd1下的rbda被pod挂载了，那其他pod就不能占用这个k8srbd1下的rbda了</span></span><br><span class="line"></span><br><span class="line"><span class="string">创建deployment的时候也只有一个能running，因为只有一个pod能用这个块设备</span></span><br></pre></td></tr></table></figure>
<h3 id="ceph-rbd生成pv"><a class="markdownIt-Anchor" href="#ceph-rbd生成pv">#</a> ceph rbd 生成 pv</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、创建ceph-secret这个k8s</span> <span class="string">secret对象，这个secret对象用于k8s</span> <span class="string">volume插件访问ceph集群，获取client.admin的keyring值，并用base64编码，在master1-admin（ceph管理节点）操作</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph auth get-key client.admin | base64</span></span><br><span class="line"></span><br><span class="line"><span class="string">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFBWk0zeGdZdDlhQXhBQVZsS0poYzlQUlBianBGSWJVbDNBenc9PQ==</span></span><br><span class="line">  </span><br><span class="line"><span class="number">3</span><span class="string">.回到ceph</span> <span class="string">管理节点创建pool池</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8stest 6</span></span><br><span class="line"><span class="string">pool</span> <span class="string">&#x27;k8stest&#x27;</span> <span class="string">created</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd create rbda -s 1024 -p k8stest</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd feature disable  k8stest/rbda object-map fast-diff deep-flatten</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-pv</span> </span><br><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">   <span class="attr">capacity:</span>     </span><br><span class="line">     <span class="attr">storage:</span> <span class="string">1Gi</span>   </span><br><span class="line">   <span class="attr">accessModes:</span>     </span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>   </span><br><span class="line">   <span class="attr">rbd:</span>     </span><br><span class="line">         <span class="attr">monitors:</span>       </span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.202:6789&#x27;</span>    </span><br><span class="line">         <span class="attr">pool:</span> <span class="string">k8stest</span>     </span><br><span class="line">         <span class="attr">image:</span> <span class="string">rbda</span>     </span><br><span class="line">         <span class="attr">user:</span> <span class="string">admin</span>     </span><br><span class="line">         <span class="attr">secretRef:</span>       </span><br><span class="line">             <span class="attr">name:</span> <span class="string">ceph-secret</span>     </span><br><span class="line">         <span class="attr">fsType:</span> <span class="string">xfs</span>     </span><br><span class="line">         <span class="attr">readOnly:</span> <span class="literal">false</span>   </span><br><span class="line">   <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">metadata:</span>   </span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-pvc</span> </span><br><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">  <span class="attr">accessModes:</span>     </span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>   </span><br><span class="line">  <span class="attr">resources:</span>     </span><br><span class="line">   <span class="attr">requests:</span>       </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># tells deployment to run 2 pods matching the template</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># create pods using pod definition in this template</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/ceph-data&quot;</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">ceph-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">ceph-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过上面实验可以发现pod是可以以ReadWriteOnce共享挂载相同的pvc的</span></span><br><span class="line"></span><br><span class="line"><span class="string">注意：ceph</span> <span class="string">rbd块存储的特点</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储能在同一个node上跨pod以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储能在同一个node上同一个pod多个容器中以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储不能跨node以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">如果一个使用ceph</span> <span class="string">rdb的pod所在的node挂掉，这个pod虽然会被调度到其它node，但是由于rbd不能跨node多次挂载和挂掉的pod不能自动解绑pv的问题，这个新pod不会正常运行</span></span><br><span class="line"></span><br><span class="line"><span class="string">Deployment更新特性：</span></span><br><span class="line"><span class="string">deployment触发更新的时候，它确保至少所需</span> <span class="string">Pods</span> <span class="number">75</span><span class="string">%</span> <span class="string">处于运行状态（最大不可用比例为</span> <span class="number">25</span><span class="string">%）。故像一个pod的情况，肯定是新创建一个新的pod，新pod运行正常之后，再关闭老的pod。</span></span><br><span class="line"><span class="string">默认情况下，它可确保启动的</span> <span class="string">Pod</span> <span class="string">个数比期望个数最多多出</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line"></span><br><span class="line"><span class="string">问题：</span></span><br><span class="line"><span class="string">结合ceph</span> <span class="string">rbd共享挂载的特性和deployment更新的特性，我们发现原因如下：</span></span><br><span class="line"><span class="string">由于deployment触发更新，为了保证服务的可用性，deployment要先创建一个pod并运行正常之后，再去删除老pod。而如果新创建的pod和老pod不在一个node，就会导致此故障。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法：</span></span><br><span class="line"><span class="number">1</span><span class="string">，使用能支持跨node和pod之间挂载的共享存储，例如cephfs，GlusterFS等</span></span><br><span class="line"><span class="number">2</span><span class="string">，给node添加label，只允许deployment所管理的pod调度到一个固定的node上。（不建议，这个node挂掉的话，服务就故障了）</span></span><br></pre></td></tr></table></figure>
<h3 id="基于storage动态生成pv"><a class="markdownIt-Anchor" href="#基于storage动态生成pv">#</a> 基于 storage 动态生成 pv</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@\master~</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment">#mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master~</span>]<span class="comment">#mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">、创建rbd的供应商provisioner</span></span><br><span class="line"><span class="comment">#把rbd-provisioner.tar.gz上传到xianchaonode1上，手动解压</span></span><br><span class="line">[<span class="string">root@xianchaonode1</span> <span class="string">~</span>]<span class="comment"># docker load -i rbd-provisioner.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kube-dns&quot;</span>,<span class="string">&quot;coredns&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/xianchao/external_storage/rbd-provisioner:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">ceph.com/rbd</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">、创建ceph-secret</span></span><br><span class="line"><span class="comment">#创建pool池</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8stest1 6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-secret-1</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&quot;ceph.com/rbd&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-rbd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">ceph.com/rbd</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">monitors:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.201</span><span class="string">:6789,192.168.13.202:6789,192.168.13.200:6789</span></span><br><span class="line">  <span class="attr">adminId:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">adminSecretName:</span> <span class="string">ceph-secret-1</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">k8stest1</span></span><br><span class="line">  <span class="attr">userId:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">userSecretName:</span> <span class="string">ceph-secret-1</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">xfs</span></span><br><span class="line">  <span class="attr">imageFormat:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="attr">imageFeatures:</span> <span class="string">&quot;layering&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">k8s-rbd</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">rbd-pod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-rbd-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">rbd-pvc</span></span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<h3 id="k8s对接cephfs"><a class="markdownIt-Anchor" href="#k8s对接cephfs">#</a> k8s 对接 cephfs</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、创建ceph子目录</span></span><br><span class="line"></span><br><span class="line"><span class="string">为了别的地方能挂载cephfs，先创建一个secretfile</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># cat /etc/ceph/ceph.client.admin.keyring |grep key|awk -F&quot; &quot; &#x27;&#123;print $3&#125;&#x27; &gt; /etc/ceph/admin.secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">挂载cephfs的根目录到集群的mon节点下的一个目录，比如xianchao_data，因为挂载后，我们就可以直接在xianchao_data下面用Linux命令创建子目录了。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># mkdir xianchao_data</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># mount -t ceph 192.168.40.201:6789:/ /root/xianchao_data -o name=admin,secretfile=/etc/ceph/admin.secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">在cephfs的根目录里面创建了一个子目录lucky，k8s以后就可以挂载这个目录</span> </span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># cd /root/xianchao_data/</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># mkdir lucky</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># chmod 0777 lucky/</span></span><br><span class="line"></span><br><span class="line"><span class="string">创建k8s连接ceph使用的secret</span></span><br><span class="line">   <span class="string">将/etc/ceph/ceph.client.admin.keyring里面的key的值转换为base64，否则会有问题</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># echo &quot;AQBvBdZgsDSZKxAAan+5rnsjr2ziA/atqFnQOA==&quot; | base64</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFCdkJkWmdzRFNaS3hBQWFuKzVybnNqcjJ6aUEvYXRxRm5RT0E9PQo=</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">cephfs:</span></span><br><span class="line">    <span class="attr">monitors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.201</span><span class="string">:6789</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/lucky</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cephfs-secret</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">volumeName:</span> <span class="string">cephfs-pv</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pod-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-v1</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-v1</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">cephfs-pvc</span></span><br></pre></td></tr></table></figure>
<h2 id="devops"><a class="markdownIt-Anchor" href="#devops">#</a> devops</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">敏捷开发</span><br><span class="line">提高开发效率，及时跟进用户需求，缩短开发周期。</span><br><span class="line"></span><br><span class="line">敏捷开发包括编写代码和构建代码两个阶段，可以使用git或者svn来管理代码，用maven对代码进行构建 </span><br><span class="line"></span><br><span class="line">1.5.2 持续集成（CI）</span><br><span class="line">持续集成强调开发人员提交了新代码之后，立刻自动的进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。持续集成过程中很重视自动化测试验证结果，对可能出现的一些问题进行预警，以保障最终合并的代码没有问题。</span><br><span class="line">常见的持续集成工具：</span><br><span class="line">1. Jenkins</span><br><span class="line">Jenkins是用Java语言编写的，是目前使用最多和最受欢迎的持续集成工具，使用Jenkins，可以自动监测到git或者svn存储库代码的更新，基于最新的代码进行构建，把构建好的源码或者镜像发布到生产环境。Jenkins还有个非常好的功能：它可以在多台机器上进行分布式地构建和负载测试</span><br><span class="line">2. TeamCity</span><br><span class="line">3.  Travis CI</span><br><span class="line">4.   Go CD </span><br><span class="line">5.  Bamboo</span><br><span class="line">6.   GitLab CI</span><br><span class="line">7.  Codeship</span><br><span class="line"></span><br><span class="line">它的好处主要有以下几点：</span><br><span class="line">1）较早的发现错误：每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，哪个环节出现问题都可以较早的发现</span><br><span class="line">2）快速的发现错误：每完成一部分代码的更新，就会把代码集成到主干中，这样就可以快速的发现错误，比较容易的定位错误</span><br><span class="line">3）提升团队绩效：持续集成中代码更新速度快，能及时发现小问题并进行修改，使团队能创造出更好的产品</span><br><span class="line">4）防止分支过多的偏离主干：经常持续集成，会使分支代码经常向主干更新，当单元测试失败或者出现bug，如果开发者需要在没有调试的情况下恢复仓库的代码到没有bug的状态，只有很小部分的代码会丢失 </span><br><span class="line">持续集成的目的是提高代码质量，让产品快速的更新迭代。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。</span><br><span class="line">Martin Fowler说过，&quot;持续集成并不能消除Bug，而是让它们非常容易发现和改正。&quot;</span><br><span class="line"></span><br><span class="line">1.5.3 持续交付</span><br><span class="line">持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的「类生产环境」（production-like environments）中。交付给质量团队或者用户，以供评审。如果评审通过，代码就进入生产阶段。</span><br><span class="line">如果所有的代码完成之后一起交付，会导致很多问题爆发出来，解决起来很麻烦，所以持续集成，也就是没更新一次代码，都向下交付一次，这样可以及时发现问题，及时解决，防止问题大量堆积。</span><br><span class="line">1.5.4 持续部署</span><br><span class="line">持续部署是指当交付的代码通过评审之后，自动部署到生产环境中。持续部署是持续交付的最高阶段。</span><br><span class="line">Puppet，SaltStack和Ansible是这个阶段使用的流行工具。容器化工具在部署阶段也发挥着重要作用。 Docker和k8s是流行的工具，有助于在开发，测试和生产环境中实现一致性。 除此之外，k8s还可以实现自动扩容缩容等功能。 </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602135250221.png" alt="image-20230602135250221"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">K8S在DevOps中的核心作用</span><br><span class="line">Docker和K8S的出现使DevOps变得更加普及，更加容易实现。在传统运维中我们服务时需要针对不同的环境去安装不同的版本，部署方式也杂、多。那么有了docker之后，一次构建、到处运行，我们只需要要构建一次镜像，那么只要有docker的主机，就可以基于镜像把应用跑起来。</span><br><span class="line"></span><br><span class="line">在众多微服务中，我们每天可能需要去处理各种服务的崩溃，而服务间的依赖调用关系也及其复杂，这对我们解决问题带来了很大的复杂度。要很好的解决这个问题。我们就需要用到容器编排工具。</span><br><span class="line"></span><br><span class="line">Kubernetes 的出现主宰了容器编排的市场，也进化了过去的运维方式，将开发与运维联系的更加紧密。而且让 DevOps 这一角色变得更加清晰，它是目前可用的很流行的容器解决方案之一。</span><br><span class="line">3.1 自动化</span><br><span class="line">敏捷开发-&gt;持续集成-&gt;持续交付-&gt;持续部署</span><br><span class="line">3.2 多集群管理</span><br><span class="line">可以根据客户需求对开发，测试，生产环境部署多套kubernetes集群，每个环境使用独立的物理资源，相互之间避免影响</span><br><span class="line">3.3 多环境一致性</span><br><span class="line">Kubernetes是基于docker的容器编排工具，因为容器的镜像是不可变的，所以镜像把 OS、业务代码、运行环境、程序库、目录结构都包含在内，镜像保存在我们的私有仓库，只要用户从我们提供的私有仓库拉取镜像，就能保证环境的一致性。</span><br><span class="line">3.4 实时反馈和智能化报表</span><br><span class="line">每次集成或交付，都会第一时间将结果通过多途径的方式反馈给你，也可以定制适合企业专用的报表平台。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602143206987.png" alt="image-20230602143206987"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">.安装nfs</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">start</span> <span class="string">nfs</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nfs</span></span><br><span class="line"><span class="string">（2）在master1上创建一个nfs共享目录</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/data/v2</span>  <span class="string">-p</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="string">/data/v1</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/v2</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.安装Jenkins</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">namespace</span> <span class="string">jenkins-k8s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-k8s-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/v2</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-k8s-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  </span><br><span class="line"><span class="string">（4）创建一个sa账号</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">sa</span> <span class="string">jenkins-k8s-sa</span> <span class="string">-n</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="string">（5）把上面的sa账号做rbac授权</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">jenkins-k8s-sa-cluster</span> <span class="string">-n</span> <span class="string">jenkins-k8s</span>  <span class="string">--clusterrole=cluster-admin</span> <span class="string">--serviceaccount=jenkins-k8s:jenkins-k8s-sa</span></span><br><span class="line"></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">jenkins/jenkins</span></span><br><span class="line"><span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span>  <span class="string">jenkins-slave-latest.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="string">jenkins-slave-latest.tar.gz这个里面封装的镜像是jenkins-slave-latest:v1，这个jenkins-slave-latest:v1镜像制作方法如下：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/root/slave</span></span><br><span class="line"><span class="string">cat</span> <span class="string">dockerfile</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">jenkins/jnlp-slave:4.13.3-1-jdk11</span></span><br><span class="line"><span class="string">USER</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># 安装Docker</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">\</span></span><br><span class="line">    <span class="string">docker.io</span></span><br><span class="line"><span class="comment"># 将当前用户加入docker用户组</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">usermod</span> <span class="string">-aG</span> <span class="string">docker</span> <span class="string">jenkins</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">curl</span> <span class="string">-LO</span> <span class="string">https://dl.k8s.io/release/stable.txt</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">curl</span> <span class="string">-LO</span> <span class="string">https://dl.k8s.io/release/$(cat</span> <span class="string">stable.txt)/bin/linux/amd64/kubectl</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">kubectl</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">mv</span> <span class="string">kubectl</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">DOCKER_HOST</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line"></span><br><span class="line"><span class="string">docker</span> <span class="string">build</span> <span class="string">-t=jenkins-slave-latest:v1</span> <span class="string">.</span></span><br><span class="line"><span class="string">docker</span> <span class="string">save</span> <span class="string">-o</span> <span class="string">jenkins-slave-latest.tar.gz</span>  <span class="string">jenkins-slave-latest:v1</span></span><br><span class="line"></span><br><span class="line"><span class="string">chown</span> <span class="string">-R</span> <span class="number">1000.1000</span> <span class="string">/data/v2/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">jenkins-k8s-sa</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">image:</span>  <span class="string">jenkins/jenkins:2.401.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">50000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-volume</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">jenkins-home</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">jenkins-k8s-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30002</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">agent</span></span><br><span class="line">    </span><br><span class="line"><span class="string">http://192.168.13.180:30002</span></span><br><span class="line"></span><br><span class="line"><span class="string">查看初始密码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 测试通过Jenkins部署应用发布到k8s开发环境、测试环境、生产环境</span><br><span class="line"></span><br><span class="line">开发提交代码到代码仓库gitlab-jenkins检测到代码更新-调用k8s api在k8s中创建jenkins slave pod：</span><br><span class="line">Jenkins slave pod拉取代码---通过maven把拉取的代码进行构建成war包或者jar包---&gt;上传代码到Sonarqube，进行静态代码扫描- --&gt;基于war包构建docker image--&gt;把镜像上传到harbor镜像仓库--&gt;基于镜像部署应用到开发环境--&gt;部署应用到测试环境---&gt;部署应用到生产环境。</span><br><span class="line"></span><br><span class="line">kubectl create ns devlopment</span><br><span class="line">kubectl create ns production</span><br><span class="line">kubectl create ns qatest</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">api_token</span><br><span class="line"> 11e9faa9696f6e6b8ced2d7bcf7172a1a4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">    stage(<span class="string">&#x27;Clone&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1.Clone Stage&quot;</span></span><br><span class="line">        git url: <span class="string">&quot;https://github.com/luckylucky421/jenkins-sample.git&quot;</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;2.Test Stage&quot;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class="line">        sh <span class="string">&quot;docker build -t kbshire/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> .&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">&#x27;3774bc6b-f509-4c57-b913-c82d4f20aeb5&#x27;</span>, passwordVariable: <span class="string">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class="string">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker login -u <span class="variable">$&#123;dockerHubUser&#125;</span> -p <span class="variable">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class="line">            sh <span class="string">&quot;docker push kbshire/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Deploy to dev&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;5. Deploy DEV&quot;</span></span><br><span class="line">		sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class="line">        sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class="line">//        sh <span class="string">&quot;bash running-devlopment.sh&quot;</span></span><br><span class="line">        sh <span class="string">&quot;kubectl apply -f k8s-dev.yaml  --validate=false&quot;</span></span><br><span class="line">	&#125;	</span><br><span class="line">	stage(<span class="string">&#x27;Promote to qa&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line"></span><br><span class="line">            message: <span class="string">&#x27;Promote to qa?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-qa.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-qa.yaml --validate=false&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sleep 6&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl get pods -n qatest&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            //exit</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	stage(<span class="string">&#x27;Promote to pro&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line"></span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line">            message: <span class="string">&#x27;Promote to pro?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-production.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;cat k8s-prod.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-prod.yaml --record --validate=false&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果有403错误，修改/usr/local/bin/jenkins.sh ,主要修改地方在exec java这行，修改完之后重启docker 容器，docker restart docker_id </span></span><br><span class="line"><span class="comment">#! /bin/bash -e</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;JENKINS_WAR:=&quot;/usr/share/jenkins/jenkins.war&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;JENKINS_HOME:=&quot;/var/jenkins_home&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG:=&quot;<span class="variable">$&#123;JENKINS_HOME&#125;</span>/copy_reference_file.log&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;REF:=&quot;/usr/share/jenkins/ref&quot;&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">touch</span> <span class="string">&quot;<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Can not write to <span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>. Wrong volume permissions?&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Copying files at <span class="subst">$(date)</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$COPY_REFERENCE_FILE_LOG</span>&quot;</span></span><br><span class="line">find <span class="string">&quot;<span class="variable">$&#123;REF&#125;</span>&quot;</span> \( -<span class="built_in">type</span> f -o -<span class="built_in">type</span> l \) -<span class="built_in">exec</span> bash -c <span class="string">&#x27;. /usr/local/bin/jenkins-support; for arg; do copy_reference_file &quot;$arg&quot;; done&#x27;</span> _ &#123;&#125; +</span><br><span class="line"><span class="comment"># if `docker run` first argument start with `--` the user is passing jenkins launcher arguments</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> -lt 1 ]] || [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;--&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># shellcheck disable=SC2001</span></span><br><span class="line">  effective_java_opts=$(sed -e <span class="string">&#x27;s/^ $//&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$JAVA_OPTS</span> <span class="variable">$JENKINS_JAVA_OPTS</span>&quot;</span>)</span><br><span class="line">  <span class="comment"># read JAVA_OPTS and JENKINS_OPTS into arrays to avoid need for eval (and associated vulnerabilities)</span></span><br><span class="line">  java_opts_array=()</span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r -d <span class="string">&#x27;&#x27;</span> item; <span class="keyword">do</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;<span class="variable">$item</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">done</span> &lt; &lt;([[ <span class="variable">$effective_java_opts</span> ]] &amp;&amp; xargs <span class="built_in">printf</span> <span class="string">&#x27;%s\0&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$effective_java_opts</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">readonly</span> agent_port_property=<span class="string">&#x27;jenkins.model.Jenkins.slaveAgentPort&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT:-&#125;</span>&quot;</span> ] &amp;&amp; [[ <span class="string">&quot;<span class="variable">$&#123;effective_java_opts:-&#125;</span>&quot;</span> != *<span class="string">&quot;<span class="variable">$&#123;agent_port_property&#125;</span>&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;-D<span class="variable">$&#123;agent_port_property&#125;</span>=<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT&#125;</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">readonly</span> lifecycle_property=<span class="string">&#x27;hudson.lifecycle&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS:-&#125;</span>&quot;</span> != *<span class="string">&quot;<span class="variable">$&#123;lifecycle_property&#125;</span>&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;-D<span class="variable">$&#123;lifecycle_property&#125;</span>=hudson.lifecycle.ExitLifecycle&quot;</span> )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$DEBUG</span>&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( \</span><br><span class="line">      <span class="string">&#x27;-Xdebug&#x27;</span> \</span><br><span class="line">      <span class="string">&#x27;-Xrunjdwp:server=y,transport=dt_socket,address=*:5005,suspend=y&#x27;</span> \</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  jenkins_opts_array=( )</span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r -d <span class="string">&#x27;&#x27;</span> item; <span class="keyword">do</span></span><br><span class="line">    jenkins_opts_array+=( <span class="string">&quot;<span class="variable">$item</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">done</span> &lt; &lt;([[ <span class="variable">$JENKINS_OPTS</span> ]] &amp;&amp; xargs <span class="built_in">printf</span> <span class="string">&#x27;%s\0&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$JENKINS_OPTS</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">exec</span> java -Duser.home=<span class="string">&quot;<span class="variable">$JENKINS_HOME</span>&quot;</span> -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=<span class="literal">true</span> <span class="string">&quot;<span class="variable">$&#123;java_opts_array[@]&#125;</span>&quot;</span> -jar <span class="string">&quot;<span class="variable">$&#123;JENKINS_WAR&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;jenkins_opts_array[@]&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># As argument is not jenkins, assume user wants to run a different process, for example a `bash` shell to explore this image</span></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230603155028149.png" alt="image-20230603155028149"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回滚脚本</span></span><br><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">  stage(<span class="string">&#x27;git clone&#x27;</span>) &#123;</span><br><span class="line">    git url: <span class="string">&quot;https://github.com/kbshire/jenkins-rollout.git&quot;</span></span><br><span class="line">    sh <span class="string">&quot;ls -al&quot;</span></span><br><span class="line">    sh <span class="string">&quot;pwd&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;select env&#x27;</span>) &#123;</span><br><span class="line">    def envInput = input(</span><br><span class="line">      <span class="built_in">id</span>: <span class="string">&#x27;envInput&#x27;</span>,</span><br><span class="line">      message: <span class="string">&#x27;Choose a deploy environment&#x27;</span>,</span><br><span class="line">      parameters: [</span><br><span class="line">         [</span><br><span class="line">             <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">             choices: <span class="string">&quot;devlopment\nqatest\nproduction&quot;</span>,</span><br><span class="line">             name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">         ]</span><br><span class="line">     ]</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;envInput&#125;</span>&quot;</span></span><br><span class="line">sh <span class="string">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class="variable">$&#123;envInput&#125;</span>/&#x27; getVersion.sh&quot;</span></span><br><span class="line">sh <span class="string">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class="variable">$&#123;envInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class="line">sh <span class="string">&quot;bash getVersion.sh&quot;</span></span><br><span class="line">// env.WORKSPACE = <span class="built_in">pwd</span>()</span><br><span class="line">// def version = readFile <span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class="line">// println version</span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;select version&#x27;</span>) &#123;</span><br><span class="line">     env.WORKSPACE = <span class="built_in">pwd</span>()</span><br><span class="line">  def version = readFile <span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class="line">  println version</span><br><span class="line">      def userInput = input(<span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line">                                        message: <span class="string">&#x27;选择回滚版本&#x27;</span>,</span><br><span class="line">                                        parameters: [</span><br><span class="line">            [</span><br><span class="line">                 <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                 choices: <span class="string">&quot;<span class="variable">$version</span>\n&quot;</span>,</span><br><span class="line">                 name: <span class="string">&#x27;Version&#x27;</span></span><br><span class="line">       ]</span><br><span class="line">      ]</span><br><span class="line">)</span><br><span class="line">       sh <span class="string">&quot;sed -i &#x27;s/&lt;version&gt;/<span class="variable">$&#123;userInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;rollout deploy&#x27;</span>) &#123;</span><br><span class="line">      sh <span class="string">&quot;bash rollout.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Jenkins Pipeline介绍</span><br><span class="line">Jenkins pipeline （流水线）是一套运行于jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。它把持续提交流水线（Continuous Delivery Pipeline）的任务集成到Jenkins中。</span><br><span class="line">pipeline 是jenkins2.X 最核心的特性， 帮助jenkins 实现从CI到CD与DevOps的转变。</span><br><span class="line"></span><br><span class="line">持续提交流水线（Continuous Delivery Pipeline）会经历一个复杂的过程： 从版本控制、向用户和客户提交软件，软件的每次变更（提交代码到仓库）到软件发布（Release）。这个过程包括以一种可靠并可重复的方式构建软件，以及通过多个测试和部署阶段来开发构建好的软件（称为Build）。</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">1.Jenkins Pipeline是一组插件，让Jenkins可以实现持续交付管道的落地和实施。</span><br><span class="line">2.持续交付管道(CD Pipeline)是将软件从版本控制阶段到交付给用户或客户的完</span><br><span class="line">整过程的自动化表现。</span><br><span class="line">3.软件的每一次更改（提交到源代码管理系统）都要经过一个复杂的过程才能被发布。</span><br><span class="line"></span><br><span class="line">本质上，Jenkins 是一个自动化引擎，它支持许多自动模式。 Pipeline向Jenkins中添加了一组强大的工具, 支持简单的CI到全面的CD pipeline。通过对一系列的相关任务进行建模, 用户可以利用pipeline的很多特性:</span><br><span class="line">1、代码：Pipeline以代码的形式实现，使团队能够编辑，审查和迭代其CD流程。</span><br><span class="line">    2、可持续性：Jenkins重启或者中断后都不会影响Pipeline Job。</span><br><span class="line">    3、停顿：Pipeline可以选择停止并等待人工输入或批准，然后再继续Pipeline运行。</span><br><span class="line">    4、多功能：Pipeline支持现实复杂的CD要求，包括循环和并行执行工作的能力。</span><br><span class="line">    5、可扩展：Pipeline插件支持其DSL的自定义扩展以及与其他插件集成的多个选项。</span><br><span class="line"></span><br><span class="line">DSL 是什么？</span><br><span class="line">DSL 其实是 Domain Specific Language 的缩写，中文翻译为领域特定语言（下简称 DSL）；而与 DSL相对的就是GPL，这里的GPL并不是我们知道的开源许可证，而是 General Purpose Language的简称，即通用编程语言，也就是我们非常熟悉的 Objective-C、Java、Python 以及 C 语言等等。</span><br><span class="line"></span><br><span class="line">pipeline脚本是由groovy 语言实现的</span><br><span class="line">但无需专门学习 groovy</span><br><span class="line"></span><br><span class="line">pipeline支持两种语法：</span><br><span class="line">　-Declarative：声明式</span><br><span class="line">　-Scripted pipeline ：脚本式</span><br><span class="line"></span><br><span class="line">声明式pipeline语法：</span><br><span class="line">官网：</span><br><span class="line">https://www.jenkins.io/doc/book/pipeline/syntax/</span><br><span class="line"></span><br><span class="line">声明式语法包括以下核心流程：</span><br><span class="line">1.pipeline : 声明其内容为一个声明式的pipeline脚本</span><br><span class="line">2.agent:  执行节点（job运行的slave或者master节点）</span><br><span class="line">3.stages: 阶段集合，包裹所有的阶段（例如：打包，部署等各个阶段）</span><br><span class="line">4.stage:  阶段，被stages包裹，一个stages可以有多个stage</span><br><span class="line">5.steps:  步骤,为每个阶段的最小执行单元,被stage包裹</span><br><span class="line">6.post:   执行构建后的操作，根据构建结果来执行对应的操作</span><br><span class="line"></span><br><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&quot;This is first stage&quot;</span>)&#123;</span><br><span class="line">            steps(<span class="string">&quot;This is first step&quot;</span>)&#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post&#123;</span><br><span class="line">        always&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;The process is ending&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">environment</span><br><span class="line">environment指令指定一系列键值对，这些键值对将被定义为所有step或stage-specific step的环境变量，具体取决于environment指令在Pipeline中的位置。该指令支持一种特殊的方法credentials()，可以通过其在Jenkins环境中的标识符来访问预定义的凭据。对于类型为“Secret Text”的凭据，该 credentials()方法将确保指定的环境变量包含Secret Text内容；对于“标准用户名和密码”类型的凭证，指定的环境变量将被设置为username:password并且将自动定义两个附加的环境变量：MYVARNAME_USR和MYVARNAME_PSW。</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;  </span><br><span class="line">        CC = <span class="string">&#x27;clang&#x27;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;printenv&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">options</span><br><span class="line">options指令允许在Pipeline本身内配置Pipeline专用选项。Pipeline本身提供了许多选项，例如buildDiscarder，但它们也可能由插件提供，例如 timestamps。</span><br><span class="line"></span><br><span class="line">可用选项</span><br><span class="line">buildDiscarder：  pipeline保持构建的最大个数。用于保存Pipeline最近几次运行的数据，例如：options &#123; buildDiscarder(logRotator(numToKeepStr: <span class="string">&#x27;1&#x27;</span>)) &#125;</span><br><span class="line">　　disableConcurrentBuilds： 不允许并行执行Pipeline,可用于防止同时访问共享资源等。例如：options &#123; disableConcurrentBuilds() &#125;</span><br><span class="line">　　skipDefaultCheckout：跳过默认设置的代码check out。例如：options &#123; skipDefaultCheckout() &#125;</span><br><span class="line">　　skipStagesAfterUnstable： 一旦构建状态进入了“Unstable”状态，就跳过此stage。例如：options &#123; skipStagesAfterUnstable() &#125;</span><br><span class="line">　　<span class="built_in">timeout</span>： 设置Pipeline运行的超时时间，超过超时时间，job会自动被终止，例如：options &#123; <span class="built_in">timeout</span>(time: 1, unit: <span class="string">&#x27;HOURS&#x27;</span>) &#125;</span><br><span class="line">　　retry：  失败后，重试整个Pipeline的次数。例如：options &#123; retry(3) &#125;</span><br><span class="line">　　timestamps： 预定义由Pipeline生成的所有控制台输出时间。例如：options &#123; timestamps() &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    options &#123;</span><br><span class="line">        <span class="built_in">timeout</span>(time: 1, unit: <span class="string">&#x27;HOURS&#x27;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;　</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parameters</span><br><span class="line">parameters指令提供用户在触发Pipeline时的参数列表。这些参数值通过该params对象可用于Pipeline stage中，具体用法如下：</span><br><span class="line">作用域：被最外层pipeline所包裹，并且只能出现一次，参数可被全局使用 </span><br><span class="line">好处：使用parameters好处是能够使参数也变成code,达到pipeline as code，pipeline中设置的参数会自动在job构建的时候生成，形成参数化构建</span><br><span class="line"></span><br><span class="line">可用参数</span><br><span class="line">　　string</span><br><span class="line">　　　　A parameter of a string <span class="built_in">type</span>, <span class="keyword">for</span> example: parameters &#123; string(name: <span class="string">&#x27;DEPLOY_ENV&#x27;</span>, defaultValue: <span class="string">&#x27;staging&#x27;</span>, description: <span class="string">&#x27;&#x27;</span>) &#125;</span><br><span class="line">　　booleanParam</span><br><span class="line">　　　　A boolean parameter, <span class="keyword">for</span> example: parameters &#123; booleanParam(name: <span class="string">&#x27;DEBUG_BUILD&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;&#x27;</span>) &#125;</span><br><span class="line">　　目前只支持[booleanParam, choice, credentials, file, text, password, run, string]这几种参数类型，其他高级参数化类型还需等待社区支持。</span><br><span class="line"></span><br><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">        string(name: <span class="string">&#x27;haha&#x27;</span>, defaultValue: <span class="string">&#x27;sb&#x27;</span>, description: <span class="string">&#x27;haha&#x27;</span>)</span><br><span class="line">        booleanParam(name: <span class="string">&#x27;xixi&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;xixi&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&quot;stage1&quot;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$haha</span>&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$xixi</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">triggers</span><br><span class="line">triggers指令定义了Pipeline自动化触发的方式。目前有三个可用的触发器：cron和pollSCM和upstream。</span><br><span class="line">用域：被pipeline包裹，在符合条件下自动触发pipeline</span><br><span class="line"></span><br><span class="line">cron</span><br><span class="line">　　接受一个cron风格的字符串来定义Pipeline触发的时间间隔，例如： </span><br><span class="line">triggers &#123; cron(<span class="string">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class="line">pollSCM</span><br><span class="line">　　接受一个cron风格的字符串来定义Jenkins检查SCM源更改的常规间隔。如果存在新的更改，则Pipeline将被重新触发。例如：triggers &#123; pollSCM(<span class="string">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class="line">　　</span><br><span class="line">　　</span><br><span class="line">tools</span><br><span class="line"> 通过tools可自动安装工具，并放置环境变量到PATH。如果agent none，这将被忽略。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    tools &#123;</span><br><span class="line">       <span class="comment">#工具名称必须在Jenkins 管理Jenkins → 全局工具配置中预配置。</span></span><br><span class="line">        maven <span class="string">&#x27;apache-maven-3.0.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn --version&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">stage 的 input 指令允许你使用 input step提示输入。 在应用了 options 后，进入 stage 的 agent 或评估 when 条件前，stage 将暂停。 如果 input 被批准, stage 将会继续。 作为 input 提交的一部分的任何参数都将在环境中用于其他 stage</span><br><span class="line">配置项</span><br><span class="line">message</span><br><span class="line">必需的。 这将在用户提交 input 时呈现给用户。</span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">input 的可选标识符， 默认为 stage 名称。</span><br><span class="line">ok</span><br><span class="line">`input`表单上的<span class="string">&quot;ok&quot;</span> 按钮的可选文本。</span><br><span class="line">submitter</span><br><span class="line">可选的以逗号分隔的用户列表或允许提交 input 的外部组名。默认允许任何用户。</span><br><span class="line">submitterParameter</span><br><span class="line">环境变量的可选名称。如果存在，用 submitter 名称设置。</span><br><span class="line">parameters</span><br><span class="line">提示提交者提供的一个可选的参数列表。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            input &#123;</span><br><span class="line">                message <span class="string">&quot;Should we continue?&quot;</span></span><br><span class="line">                ok <span class="string">&quot;Yes, we should.&quot;</span></span><br><span class="line">                submitter <span class="string">&quot;222&quot;</span></span><br><span class="line">                parameters &#123;</span><br><span class="line">                    string(name: <span class="string">&#x27;PERSON&#x27;</span>, defaultValue: <span class="string">&#x27;111&#x27;</span>, description: <span class="string">&#x27;Who should I say hello to?&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Hello, <span class="variable">$&#123;PERSON&#125;</span>, nice to meet you.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">　when指令允许Pipeline根据给定的条件确定是否执行该阶段。该when指令必须至少包含一个条件。如果when指令包含多个条件，则所有子条件必须为stage执行返回<span class="literal">true</span>。这与子条件嵌套在一个allOf条件中相同（见下面的例子）。</span><br><span class="line">更复杂的条件结构可使用嵌套条件建：not，allOf或anyOf。嵌套条件可以嵌套到任意深度。</span><br><span class="line">内置条件</span><br><span class="line">branch</span><br><span class="line">　　　　当正在构建的分支与给出的分支模式匹配时执行，例如：when &#123; branch <span class="string">&#x27;master&#x27;</span> &#125;。请注意，这仅适用于多分支Pipeline。</span><br><span class="line">　　environment</span><br><span class="line">　　　　当指定的环境变量设置为给定值时执行，例如： when &#123; environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span> &#125;</span><br><span class="line">　　expression</span><br><span class="line">　　　　当指定的Groovy表达式求值为<span class="literal">true</span>时执行，例如： when &#123; expression &#123; <span class="built_in">return</span> params.DEBUG_BUILD &#125; &#125;</span><br><span class="line">　　not</span><br><span class="line">　　　　当嵌套条件为<span class="literal">false</span>时执行。必须包含一个条件。例如：when &#123; not &#123; branch <span class="string">&#x27;master&#x27;</span> &#125; &#125;</span><br><span class="line">　　allOf</span><br><span class="line">　　　　当所有嵌套条件都为真时执行。必须至少包含一个条件。例如：when &#123; allOf &#123; branch <span class="string">&#x27;master&#x27;</span>; environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span> &#125; &#125;</span><br><span class="line">　　anyOf</span><br><span class="line">　　　　当至少一个嵌套条件为真时执行。必须至少包含一个条件。例如：when &#123; anyOf &#123; branch <span class="string">&#x27;master&#x27;</span>; branch <span class="string">&#x27;staging&#x27;</span> &#125; &#125;</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Example Deploy&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                allOf &#123;</span><br><span class="line">                    branch <span class="string">&#x27;production&#x27;</span></span><br><span class="line">                    environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parallel</span><br><span class="line">Declarative Pipeline近期新增了对并行嵌套stage的支持，对耗时长，相互不存在依赖的stage可以使用此方式提升运行效率。除了parallel stage，单个parallel里的多个step也可以使用并行的方式运行。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Non-Parallel Stage&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;This stage will be executed first.&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Parallel Stage&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            parallel &#123;</span><br><span class="line">                stage(<span class="string">&#x27;Branch A&#x27;</span>) &#123;</span><br><span class="line">                    agent &#123;</span><br><span class="line">                        label <span class="string">&quot;for-branch-a&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;On Branch A&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">&#x27;Branch B&#x27;</span>) &#123;</span><br><span class="line">                    agent &#123;</span><br><span class="line">                        label <span class="string">&quot;for-branch-b&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;On Branch B&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Pipeline Scripted语法</span><br><span class="line">Groovy脚本不一定适合所有使用者，因此jenkins创建了Declarative pipeline，为编写Jenkins管道提供了一种更简单、更有主见的语法。但是由于脚本化的pipeline是基于groovy的一种DSL语言，所以与Declarative pipeline相比为jenkins用户提供了更巨大的灵活性和可扩展性。</span><br><span class="line">1.流程控制</span><br><span class="line">　pipeline脚本同其它脚本语言一样，从上至下顺序执行，它的流程控制取决于Groovy表达式，如<span class="keyword">if</span>/else条件语句，举例如下：</span><br><span class="line">node &#123;</span><br><span class="line">    stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (env.BRANCH_NAME == <span class="string">&#x27;master&#x27;</span>) &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&#x27;I only execute on the master branch&#x27;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&#x27;I execute elsewhere&#x27;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Declarative pipeline和Scripted pipeline的比较</span><br><span class="line">共同点：</span><br><span class="line">　　两者都是pipeline代码的持久实现，都能够使用pipeline内置的插件或者插件提供的stage，两者都可以利用共享库扩展。</span><br><span class="line">    区别：</span><br><span class="line">　　两者不同之处在于语法和灵活性。Declarative pipeline对用户来说，语法更严格，有固定的组织结构，更容易生成代码段，使其成为用户更理想的选择。但是Scripted pipeline更加灵活，因为Groovy本身只能对结构和语法进行限制，对于更复杂的pipeline来说，用户可以根据自己的业务进行灵活的实现和扩展。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">3774bc6b-f509-4c57-b913-c82d4f20aeb5	kbshire/****** (dockerhun)</span><br><span class="line">9511af49-48b7-4d13-90ad-0f6d8194b2d7	admin/****** (harbor)</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">    stage(<span class="string">&#x27;Clone&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1.Clone Stage&quot;</span></span><br><span class="line">        git url: <span class="string">&quot;https://github.com/kbshire/jenkins-sample.git&quot;</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;2.Test Stage&quot;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class="line">        sh <span class="string">&quot;docker build -t 192.168.13.14:85/jenkins-demo/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> .&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">&#x27;9511af49-48b7-4d13-90ad-0f6d8194b2d7&#x27;</span>, passwordVariable: <span class="string">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class="string">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker login 192.168.13.14:85 -u <span class="variable">$&#123;dockerHubUser&#125;</span> -p <span class="variable">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class="line">            sh <span class="string">&quot;docker push 192.168.13.14:85/jenkins-demo/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Deploy to dev&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;5. Deploy DEV&quot;</span></span><br><span class="line">		sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-dev-harbor.yaml&quot;</span></span><br><span class="line">        sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-dev-harbor.yaml&quot;</span></span><br><span class="line">//        sh <span class="string">&quot;bash running-devlopment.sh&quot;</span></span><br><span class="line">        sh <span class="string">&quot;kubectl apply -f k8s-dev-harbor.yaml  --validate=false&quot;</span></span><br><span class="line">	&#125;	</span><br><span class="line">	stage(<span class="string">&#x27;Promote to qa&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line"></span><br><span class="line">            message: <span class="string">&#x27;Promote to qa?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-qa-harbor.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-qa-harbor.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-qa.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-qa-harbor.yaml --validate=false&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sleep 6&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl get pods -n qatest&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            //exit</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	stage(<span class="string">&#x27;Promote to pro&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line"></span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line">            message: <span class="string">&#x27;Promote to pro?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-prod-harbor.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-prod-harbor.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-production.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;cat k8s-prod-harbor.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-prod-harbor.yaml --record --validate=false&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">安装nexus</span><br><span class="line">概念：</span><br><span class="line">Nexus服务器是一个代码包管理的服务器，可以理解 Nexus 服务器是一个巨大的 Library 仓库。Nexus 可以支持管理的工具包括 Maven ， npm 等，对于 JAVA 开发来说，只要用到 Maven 管理就可以了。</span><br><span class="line">Nexus服务器作用：因为传统的中央仓库在国外，其地理位置比较远，下载速度比较缓慢。因此，当公司开发人员数量越来越多时，如果不架设一台自己的Nexus服务器，会产生大量的流量阻塞带宽，并且在出现一些不可抗原因（光缆被挖断）导致无法连接到中央仓库时，开发就会因为无法下载相关依赖包而进度停滞。因此在本地环境部署一台私有的Nexus服务器来缓存所有依赖包，并且将公司内部开发的私有包也部署上去，方便其他开发人员下载，是非常有必要的。因为 Nexus 有权限控制，因此外部人员是无法得到公司内部开发的项目包的。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker run -d -p 8081:8081 -p 8082:8082 -p 8083:8083 -v /etc/localtime:/etc/localtime --name nexus3   sonatype/nexus3</span><br><span class="line"></span><br><span class="line">在日志中，会看到一条消息： Started Sonatype Nexus OSS 3.20.1-01 这意味着Nexus Repository Manager可以使用了。现在转到浏览器并打开</span><br><span class="line">http://your-ip-addr:8081</span><br><span class="line"></span><br><span class="line">第一步：</span><br><span class="line">1、在 pom.xml 文件中声明发布的宿主仓库和 release 版本发布的仓库。</span><br><span class="line">&lt;!-- 发布构件到Nexus --&gt;</span><br><span class="line">    &lt;distributionManagement&gt;</span><br><span class="line">        &lt;repository&gt;</span><br><span class="line">            &lt;<span class="built_in">id</span>&gt;releases&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;nexus-releases&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://192.168.40.133:8081/repository/maven-releases/&lt;/url&gt;</span><br><span class="line">        &lt;/repository&gt;</span><br><span class="line">        &lt;snapshotRepository&gt;</span><br><span class="line">            &lt;<span class="built_in">id</span>&gt;snapshots&lt;/id&gt;</span><br><span class="line">            &lt;name&gt;nexus-snapshots&lt;/name&gt;</span><br><span class="line">            &lt;url&gt;http://192.168.40.133:8081/repository/maven-snapshots/&lt;/url&gt;</span><br><span class="line">        &lt;/snapshotRepository&gt;</span><br><span class="line">    &lt;/distributionManagement&gt;</span><br><span class="line"></span><br><span class="line">第二步：在 settings.xml 文件中配置 </span><br><span class="line">由于用 Maven 分发构件到远程仓库需要认证，须要在~/.m2/settings.xml或者中加入验证信息：</span><br><span class="line">&lt;servers&gt;  </span><br><span class="line">   &lt;server&gt;  </span><br><span class="line">           &lt;<span class="built_in">id</span>&gt;public&lt;/id&gt;  </span><br><span class="line">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class="line">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class="line">       &lt;/server&gt;  </span><br><span class="line">   &lt;server&gt;  </span><br><span class="line">           &lt;<span class="built_in">id</span>&gt;releases&lt;/id&gt;  </span><br><span class="line">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class="line">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class="line">       &lt;/server&gt;  </span><br><span class="line">   &lt;server&gt;  </span><br><span class="line">           &lt;<span class="built_in">id</span>&gt;snapshots&lt;/id&gt;  </span><br><span class="line">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class="line">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class="line">       &lt;/server&gt;  </span><br><span class="line"> &lt;/servers&gt;  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">注意： settings.xml 中 server 元素下 <span class="built_in">id</span> 的值必须与 POM 中 repository 或 snapshotRepository 下 <span class="built_in">id</span> 的值完全一致 。　</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">安装gitlab</span><br><span class="line">在192.168.40.135上安装</span><br><span class="line"></span><br><span class="line">docker run -d  -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /home/gitlab/config:/etc/gitlab -v /home/gitlab/logs:/var/log/gitlab -v /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce  gitlab/gitlab-ce</span><br><span class="line"></span><br><span class="line">改配置：</span><br><span class="line"><span class="built_in">cat</span> /home/gitlab/config/gitlab.rb</span><br><span class="line">增加如下三行：</span><br><span class="line">external_url <span class="string">&#x27;http://192.168.40.135&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_ssh_host&#x27;</span>] = <span class="string">&#x27;192.168.40.135&#x27;</span></span><br><span class="line">gitlab_rails[<span class="string">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 222</span><br><span class="line"></span><br><span class="line">重启docker：</span><br><span class="line">docker restart gitlab</span><br><span class="line"></span><br><span class="line">登录192.168.40.135即可登录：</span><br><span class="line">第一次登录注册账号密码之后，报错如下：</span><br><span class="line">Your account is pending approval from your GitLab administrator and hence bl</span><br><span class="line"></span><br><span class="line">可通过如下方法实现：</span><br><span class="line">[root@xianchaomaster1 ~]<span class="comment"># docker exec -it gitlab sh</span></span><br><span class="line">irb(main):004:0&gt; u=User.<span class="built_in">where</span>(<span class="built_in">id</span>:1).first</span><br><span class="line">=&gt; <span class="comment">#&lt;User id:1 @root&gt;</span></span><br><span class="line">irb(main):005:0&gt; u.password=<span class="string">&#x27;12345678&#x27;</span></span><br><span class="line">=&gt; <span class="string">&quot;12345678&quot;</span></span><br><span class="line">irb(main):006:0&gt; u.password_confirmation=<span class="string">&#x27;12345678&#x27;</span> </span><br><span class="line">=&gt; <span class="string">&quot;12345678&quot;</span></span><br><span class="line">irb(main):007:0&gt; u.save!</span><br><span class="line">=&gt; <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">再次登录192.168.40.135</span><br><span class="line"></span><br><span class="line">用户名是root</span><br><span class="line">密码是12345678</span><br><span class="line"></span><br><span class="line"><span class="comment"># -d：后台运行</span></span><br><span class="line"><span class="comment"># -p：将容器内部端口向外映射</span></span><br><span class="line"><span class="comment"># --name：命名容器名称</span></span><br><span class="line"><span class="comment"># -v：将容器内数据文件夹或者日志、配置等文件夹挂载到宿主机指定目录</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在Jenkins安装git插件</span><br><span class="line">系统管理-插件管理-可选插件-搜索git安装即可</span><br><span class="line"></span><br><span class="line">在Jenkins上添加gitlab凭据</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">jenkins-jnlp-v2.tar.gz这个压缩包封装的镜像带有mvn命令</span><br><span class="line"></span><br><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">   stage(<span class="string">&#x27;Clone&#x27;</span>) &#123;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;1.Clone Stage&quot;</span></span><br><span class="line">      git credentialsId: <span class="string">&#x27;gitlab&#x27;</span>, url: <span class="string">&#x27;http://192.168.40.135/root/microservic-test.git &#x27;</span></span><br><span class="line">       script &#123;</span><br><span class="line">           build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">&#x27;git rev-parse --shortHEAD&#x27;</span>).trim()</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">     <span class="built_in">echo</span> <span class="string">&quot;2.Test Stage&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   stage(<span class="string">&#x27;mvn&#x27;</span>) &#123;</span><br><span class="line">     sh <span class="string">&quot;mvn clean package -D maven.test.skip=true&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class="line">       sh <span class="string">&quot;cd /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/portal-service&quot;</span></span><br><span class="line">       sh <span class="string">&quot;docker build --tag 192.168.40.132/microservice/jenkins-demo:v1 /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/portal-service/&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">   stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">       <span class="built_in">echo</span> <span class="string">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class="line">       withCredentials([usernamePassword(credentialsId: <span class="string">&#x27;dockerharbor&#x27;</span>,passwordVariable: <span class="string">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class="string">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class="line">           sh <span class="string">&quot;docker login 192.168.40.132 -u <span class="variable">$&#123;dockerHubUser&#125;</span> -p <span class="variable">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class="line">           sh <span class="string">&quot;docker push 192.168.40.132/microservice/jenkins-demo:v1&quot;</span></span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     stage(<span class="string">&#x27;Promoteto pro&#x27;</span>) &#123;    </span><br><span class="line">    sh <span class="string">&quot;kubectl apply -f /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/k8s/portal.yaml&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NXQU5TQU4vYXJ0aWNsZS9kZXRhaWxzLzEyNjI0NzM4Ng==">(88 条消息) Jenkins 持续集成结合 Docker Swarm 集群实现 Web 应用部署的发布_SWANSAN 的博客 - CSDN 博客</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9sZXkuYmVzdC9qZW5raW5zLXBpcGVsaW5lLWdpdC1kb2NrZXItc3dhcm0tYXV0by11cGRhdGUv">使用 jenkins pipeline 在代码合并后自动打包并部署到 docker swarm – MOCUISHLE (ley.best)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbm92d2luZC9wLzE0NTk0OTM1Lmh0bWw=">CI/CD 探索与实践 （二、Jenkins+Docker Swarm） - 夜色微光 - 博客园 (cnblogs.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE1ODU2MDkvYXJ0aWNsZS9kZXRhaWxzLzEwOTQ2MDg0Mz9zcG09MTAwMS4yMTAxLjMwMDEuNjY1MC4xJmFtcDt1dG1fbWVkaXVtPWRpc3RyaWJ1dGUucGNfcmVsZXZhbnQubm9uZS10YXNrLWJsb2ctMn5kZWZhdWx0fkNUUkxJU1R+UmF0ZS0xLTEwOTQ2MDg0My1ibG9nLTEyNDI2MjIzOC4yMzUlNUV2MzYlNUVwY19yZWxldmFudF9hbnRpX3ZpcF9iYXNlJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTA5NDYwODQzLWJsb2ctMTI0MjYyMjM4LjIzNSU1RXYzNiU1RXBjX3JlbGV2YW50X2FudGlfdmlwX2Jhc2UmYW1wO3V0bV9yZWxldmFudF9pbmRleD0y">(88 条消息) 最新最全最详细 jenkins pipeline+docker swarm+sonar+junit 实现 java maven 应用的 devops_淡远的博客 - CSDN 博客</span></p>
<h2 id="istio"><a class="markdownIt-Anchor" href="#istio">#</a> istio</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">官方文档：https://istio.io/docs/concepts/what-is-istio/</span><br><span class="line">中文官方文档：https://istio.io/zh/docs/concepts/what-is-istio/</span><br><span class="line">Github地址：https://github.com/istio/istio/releases</span><br><span class="line"></span><br><span class="line">1、连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和蓝绿部署等功能</span><br><span class="line">2、安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密。</span><br><span class="line">3、控制（Control）：应用用户定义的 policy，保证资源在消费者中公平分配。</span><br><span class="line">4、观察（Observe）：查看服务运行期间的各种数据，比如日志、监控和 tracing，了解服务的运行情况。</span><br><span class="line"></span><br><span class="line">Istio是ServiceMesh的产品化落地，可以通过在现有的服务器新增部署边车代理(sidecar proxy)，应用程序不用改代码，或者只需要改很少的代码，就能实现如下基础功能：</span><br><span class="line">1、帮助微服务之间建立连接，帮助研发团队更好的管理与监控微服务，并使得系统架构更加安全；</span><br><span class="line">2、帮助微服务分层解耦，解耦后的proxy层能够更加专注于提供基础架构能力，例如：</span><br><span class="line">（1）服务发现(discovery);</span><br><span class="line">（2）负载均衡(load balancing);</span><br><span class="line">（3）故障恢复(failure recovery);</span><br><span class="line">（4）服务度量(metrics);</span><br><span class="line">（5）服务监控(monitoring);</span><br><span class="line">（6）A/B测试(A/B testing);</span><br><span class="line">（7）灰度发布(canary rollouts);</span><br><span class="line">（8）限流限速(rate limiting);</span><br><span class="line">（9）访问控制(access control);</span><br><span class="line">（10）身份认证(end-to-end authentication)。</span><br><span class="line"></span><br><span class="line">RPC：RPC（Remote Procedure Call）远程过程调用，简单的理解是一个节点请求另一个节点提供的服务</span><br><span class="line"></span><br><span class="line">负载均衡</span><br><span class="line">把前端的请求分发到后台多个服务器</span><br><span class="line"></span><br><span class="line">故障恢复</span><br><span class="line">出现故障具备自恢复的能力</span><br><span class="line"></span><br><span class="line">服务度量</span><br><span class="line">对于 HTTP，HTTP/2 和 GRPC 流量，Istio 生成以下指标：</span><br><span class="line">1、请求计数（istio_requests_total）：这是一个用于累加每个由 Istio 代理所处理请求的 COUNTER 指标。</span><br><span class="line">2、请求持续时间（istio_request_duration_seconds）：这是一个用于测量请求的持续时间的 DISTRIBUTION 指标。</span><br><span class="line">3、请求大小（istio_request_bytes）：这是一个用于测量 HTTP 请求 body 大小的 DISTRIBUTION 指标。</span><br><span class="line">4、响应大小（istio_response_bytes）：这是一个用于测量 HTTP 响应 body 大小的 DISTRIBUTION 指标。</span><br><span class="line">对于 TCP 流量，Istio 生成以下指标：</span><br><span class="line">1、Tcp 发送字节数（istio_tcp_sent_bytes_total）：这是一个用于测量在 TCP 连接下响应期间发送的总字节数的 COUNTER 指标。</span><br><span class="line">2、Tcp 接收字节数（istio_tcp_received_bytes_total）：这是一个用于测量在 TCP 连接下请求期间接收的总字节数的COUNTER指标。</span><br><span class="line">3、Tcp 打开连接数（istio_tcp_connections_opened_total）：这是一个用于累加每个打开连接的 COUNTER 指标。</span><br><span class="line">4、Tcp 关闭连接数 (istio_tcp_connections_closed_total) : 这是一个用于累加每个关闭连接的 COUNTER 指标。</span><br><span class="line"></span><br><span class="line">灰度发布</span><br><span class="line">灰度发布也叫金丝雀发布，起源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高。</span><br><span class="line"></span><br><span class="line">Istio核心特性</span><br><span class="line">1、流控(traffic management)</span><br><span class="line">断路器(circuit breakers)、超时、重试、多路由规则、AB测试、灰度发布、按照百分比分配流量等。</span><br><span class="line"></span><br><span class="line">2、安全(security)</span><br><span class="line">加密、身份认证、服务到服务的权限控制、K8S里容器到容器的权限控制等。</span><br><span class="line"></span><br><span class="line">3、可观察(observability)</span><br><span class="line">追踪、监控、数据收集，通过控制后台全面了解上行下行流量，服务链路情况，服务运行情况，系统性能情况，国内微服务架构体系，这一块做得比较缺乏。</span><br><span class="line"></span><br><span class="line">4、平台无关系(platform support)</span><br><span class="line">K8s，物理机，自己的虚机都没问题。</span><br><span class="line"></span><br><span class="line">5、集成与定制(integration and customization)</span><br><span class="line">可定制化扩展功能。</span><br><span class="line">1.2.1 断路器</span><br><span class="line">当电路发生故障或异常时，伴随着电流不断升高，并且升高的电流有可能能损坏电路中的某些重要器件，也有可能烧毁电路甚至造成火灾。若电路中正确地安置了保险丝，那么保险丝就会在电流异常升高到一定的高度和热度的时候，自身熔断切断电流，从而起到保护电路安全运行的作用。</span><br><span class="line">断路器也称为服务熔断，在多个服务调用的时候，服务A依赖服务B，服务B依赖服务C，如果服务C响应时间过长或者不可用，则会让服务B占用太多系统资源，而服务A也依赖服B，同时也在占用大量的系统资源，造成系统雪崩的情况出现。 Istio 断路器通过网格中的边车对流量进行拦截判断处理，避免了在代码中侵入控制逻辑，非常方便的就实服务熔断的能力。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607165625825.png" alt="image-20230607165625825"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607170204018.png" alt="image-20230607170204018"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607171256521.png" alt="image-20230607171256521"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">在微服务架构中，在高并发情况下，如果请求数量达到一定极限（可以自己设置阈值），超出了设置的阈值，断路器会自动开启服务保护功能，然后通过服务降级的方式返回一个友好的提示给客户端。假设当10个请求中，有10%失败时，熔断器就会打开，此时再调用此服务，将会直接返回失败，不再调远程服务。直到10s钟之后，重新检测该触发条件，判断是否把熔断器关闭，或者继续打开。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">服务降级（提高用户体验效果）</span><br><span class="line">比如电商平台，在针对618、双11的时候会有一些秒杀场景，秒杀的时候请求量大，可能会返回报错标志“当前请求人数多，请稍后重试”等，如果使用服务降级，无法提供服务的时候，消费者会调用降级的操作，返回服务不可用等信息，或者返回提前准备好的静态页面写好的信息。</span><br><span class="line"></span><br><span class="line">超时</span><br><span class="line">在生产环境中经常会碰到由于调用方等待下游的响应过长，堆积大量的请求阻塞了自身服务，造成雪崩的情况，通过超时处理来避免由于无限期等待造成的故障，进而增强服务的可用性。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607172033300.png" alt="image-20230607172033300"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">重试</span><br><span class="line">istio 重试机制就是如果调用服务失败，Envoy 代理尝试连接服务的最大次数。而默认情况下，Envoy 代理在失败后并不会尝试重新连接服务。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607172139477.png" alt="image-20230607172139477"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">客户端调用 nginx，nginx 将请求转发给 tomcat。tomcat 通过故障注入而中止对外服务，nginx 设置如果访问 tomcat 失败则会重试 3 次。</span><br><span class="line"></span><br><span class="line">多路由规则</span><br><span class="line">1、HTTP重定向（HTTPRedirect）</span><br><span class="line">2、HTTP重写（HTTPRewrite）</span><br><span class="line">3、HTTP重试（HTTPRetry）</span><br><span class="line">4、HTTP故障注入（HTTPFaultInjection）</span><br><span class="line">5、HTTP跨域资源共享（CorsPolicy）</span><br></pre></td></tr></table></figure>
<h3 id="架构"><a class="markdownIt-Anchor" href="#架构">#</a> 架构</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607174630299.png" alt="image-20230607174630299"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、数据平面由一组以Sidecar方式部署的智能代理(Envoy+Polit-agent)组成。这些代理承载并控制微服务之间的所有网络通信，管理入口和出口流量，类似于一线员工。 Sidecar 一般和业务容器绑定在一起（在Kubernets中以自动注入的方式注入到到业务pod中），来劫持业务应用容器的流量，并接受控制面组件的控制，同 时会向控制面输出日志、跟踪及监控数据。</span><br><span class="line"></span><br><span class="line">Envoy 和 pilot-agent 打在同一个镜像中，即sidecar Proxy。</span><br><span class="line"></span><br><span class="line">2、控制平面负责管理和配置代理来路由流量。</span><br><span class="line">istio1.5+中使用了一个全新的部署模式，重建了控制平面，将原有的多个组件整合为一个单体结构istiod，这个组件是控制平面的核心，管理Istio的所有功能，主要包括Pilot、Mixer、Citadel等服务组件。</span><br><span class="line"></span><br><span class="line">istiod是新版本中最大的变化，以一个单体组件替代了原有的架构，降低了复杂度和维护难度，但原有的多组件并不是被完全移除，而是在重构后以模块的形式整合在一起组成了istiod。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607180054619.png" alt="image-20230607180054619"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1. 自动注入：在创建应用程序时自动注入 Sidecar代理Envoy程序。在 Kubernetes中创建 Pod时，Kube-apiserver调用控制面组件的 Sidecar-Injector服务，自动修改应用程序的描述信息并注入Sidecar。在真正创建Pod时，在创建业务容器的Pod中同时创建Sidecar容器。 </span><br><span class="line"></span><br><span class="line">2. 流量拦截：在Pod初始化时设置iptables 规则，基于配置的iptables规则拦截业务容器的Inbound流量和Outbound流量到Sidecar上。而应用程序感知不到Sidecar的存在，还以原本的方式 进行互相访问。上图中，流出frontend服务的流量会被 frontend服务侧的 Envoy拦截，而当流量到达forecast容器时，Inbound流量被forecast 服务侧的Envoy拦截。</span><br><span class="line"> </span><br><span class="line">3. 服务发现：服务发起方的 Envoy 调用控制面组件 Pilot 的服务发现接口获取目标服务的实例列表。上图中，frontend 服务侧的 Envoy 通过 Pilot 的服务发现接口得到forecast服务各个实例的地址。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">4. 负载均衡：服务发起方的Envoy根据配置的负载均衡策略选择服务实例，并连接对应的实例地址。上图中，数据面的各个Envoy从Pilot中获取forecast服务的负载均衡配置，并执行负载均衡动作。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">5. 流量治理：Envoy 从 Pilot 中获取配置的流量规则，在拦截到 Inbound 流量和Outbound 流量时执行治理逻辑。上图中， frontend 服务侧的 Envoy 从 Pilot 中获取流量治理规则，并根据该流量治理规则将不同特征的流量分发到forecast服务的v1或v2版本。 </span><br><span class="line"></span><br><span class="line">6. 访问安全：在服务间访问时通过双方的Envoy进行双向认证和通道加密，并基于服务的身份进行授权管理。上图中，Pilot下发安全相关配置，在frontend服务和forecast服务的Envoy上自动加载证书和密钥来实现双向认证，其中的证书和密钥由另一个管理面组件 Citadel维护。 </span><br><span class="line"></span><br><span class="line">7. 服务监测：在服务间通信时，通信双方的Envoy都会连接管理面组件Mixer上报访问数据，并通过Mixer将数据转发给对应的监控后端。上图中，frontend服务对forecast服务的访问监控指标、日志和调用链都可以通过这种方式收集到对应的监控后端。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">8. 策略执行：在进行服务访问时，通过Mixer连接后端服务来控制服务间的访问，判断对访问是放行还是拒绝。上图中，Mixer 后端可以对接一个限流服务对从frontend服务到forecast服务的访问进行速率控制等操作。 </span><br><span class="line"></span><br><span class="line">9. 外部访问：在网格的入口处有一个Envoy扮演入口网关的角 色。上图中，外部服务通过Gateway访问入口服务 frontend，对 frontend服务的负载均衡和一些流量治理策略都在这个Gateway上执行。 </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">istio组件详解</span><br><span class="line">Istio服务组件有很多，从上面的流程中基本能看出每个组件如何协作的，下面具体讲解每个组件的具体用途和功能。</span><br><span class="line">[root@xianchaomaster1 ~]# kubectl get svc -n istio-system |awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class="line">istio-egressgateway</span><br><span class="line">istio-ingressgateway</span><br><span class="line">istiod</span><br><span class="line"></span><br><span class="line">3.1 Pilot</span><br><span class="line">Pilot 是 Istio 的主要控制组件，下发指令控制客户端。在整个系统中，Pilot 完成以下任务：</span><br><span class="line">1、从 Kubernetes 或者其他平台的注册中心获取服务信息，完成服务发现过程。</span><br><span class="line">2、读取 Istio 的各项控制配置，在进行转换之后，将其发给数据面进行实施。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607180656237.png" alt="image-20230607180656237"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">Pilot 将配置内容下发给数据面的 Envoy，Envoy 根据 Pilot 指令，将路由、服务、监听、集群等定义信息转换为本地配置，完成控制行为的落地。</span><br><span class="line"></span><br><span class="line">1）Pilot为Envoy提供服务发现</span><br><span class="line">2）提供流量管理功能（例如，A/B 测试、金丝雀发布等）以及弹性功能（超时、重试、熔断器等）；</span><br><span class="line">3）生成envoy配置</span><br><span class="line">4）启动envoy</span><br><span class="line">5）监控并管理envoy的运行状况，比如envoy出错时pilot-agent负责重启envoy，或者envoy配置变更后reload envoy</span><br><span class="line"></span><br><span class="line">Envoy是用 C++ 开发的高性能代理，用于协调服务网格中所有服务的入站和出站流量。</span><br><span class="line">Envoy有许多强大的功能，例如:</span><br><span class="line">动态服务发现</span><br><span class="line">负载均衡</span><br><span class="line">TLS终端</span><br><span class="line">HTTP/2与gRPC代理</span><br><span class="line">断路器</span><br><span class="line">健康检查</span><br><span class="line">流量拆分</span><br><span class="line">灰度发布</span><br><span class="line">故障注入</span><br><span class="line"></span><br><span class="line">Citadel</span><br><span class="line">负责处理系统上不同服务之间的TLS通信。 Citadel充当证书颁发机构(CA)，并生成证书以允许在数据平面中进行安全的mTLS通信。</span><br><span class="line"></span><br><span class="line">Citadel是 Istio的核心安全组件，提供了自动生 成、分发、轮换与撤销密钥和证书功能。Citadel一直监听 Kube- apiserver，以 Secret的形式为每个服务都生成证书密钥，并在Pod创建时挂载到Pod上，代理容器使用这些文件来做服务身份认证，进而代 理两端服务实现双向TLS认证、通道加密、访问授权等安全功能。如图 所示，frontend 服 务对 forecast 服务的访问用到了HTTP方式，通过配置即可对服务增加认证功能，双方的Envoy会建立双向认证的TLS通道，从而在服务间启用双向认证的HTTPS。</span><br></pre></td></tr></table></figure>
<p>Istio 为微服务应用提供了一个完整的解决方案，可以以统一的方式去检测和管理微服务。同时，它还提供了管理流量、实施访问策略、收集数据等功能，而所有这些功能都对业务代码透明，即不需要修改业务代码就能实现。</p>
<p>有了 Istio，就几乎可以不需要其他的微服务框架，也不需要自己去实现服务治理等功能，只要把网络层委托给 Istio，它就能帮助完成这一系列的功能。简单来说，Istio 就是一个提供了服务治理能力的服务网格。</p>
<p>对服务网格来讲，业务代码无侵入和网络层的全权代理是其重要的优势。</p>
<p>Istio 的架构从逻辑上分成数据平面（Data Plane）和控制平面（Control Plane）。</p>
<ul>
<li>数据平面：由一组和业务服务成对出现的 Sidecar 代理（Envoy）构成，它的主要功能是接管服务的进出流量，传递并控制服务和 Mixer 组件的所有网络通信（Mixer 是一个策略和遥测数据的收集器，稍后会介绍）。</li>
<li>控制平面：主要包括了 Pilot、Mixer、Citadel 和 Galley 共 4 个组件，主要功能是通过配置和管理 Sidecar 代理来进行流量控制，并配置 Mixer 去执行策略和收集遥测数据（Telemetry）。</li>
</ul>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e26fa190dcf620ef885c7e8da25fedfd_720w.webp" alt="img"></p>
<h3 id="istio的核心控件"><a class="markdownIt-Anchor" href="#istio的核心控件">#</a> <strong>Istio 的核心控件</strong></h3>
<h3 id="k8s安装istio"><a class="markdownIt-Anchor" href="#k8s安装istio">#</a> k8s 安装 istio</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">https://github.com/istio/istio/</span><br><span class="line"></span><br><span class="line">1、把压缩包上传到k8s的控制节点。手动解压：</span><br><span class="line">[root@ ~]# tar zxvf istio-1.13.1.tar.gz </span><br><span class="line">2、切换到istio包所在目录下。tar zxvf istio-1.13.1.tar.gz解压的软件包包名是istio-1.13.1，则：</span><br><span class="line">cd istio-1.13.1</span><br><span class="line">安装目录包含如下内容：</span><br><span class="line">2）samples/目录下，有示例应用程序</span><br><span class="line">3）bin/目录下，包含istioctl的客户端文件。istioctl工具用于手动注入Envoy sidecar代理。</span><br><span class="line"></span><br><span class="line">3、将istioctl客户端路径增加到path环境变量中，macOS 或 Linux 系统的增加方式如下：</span><br><span class="line">export PATH=$PWD/bin:$PATH</span><br><span class="line">4、把istioctl这个可执行文件拷贝到/usr/bin/目录</span><br><span class="line">cd /root/istio-1.13.1/bin/</span><br><span class="line">cp -ar istioctl /usr/bin/</span><br><span class="line"></span><br><span class="line">4.2 安装istio</span><br><span class="line">1.下载镜像：</span><br><span class="line">安装istio需要的镜像默认从官网拉取，但是官网的镜像我们拉取会有问题，可以从课件下载镜像，然后上传到自己k8s集群的各个节点，通过docker load -i手动解压镜像：</span><br><span class="line"></span><br><span class="line">docker load -i  examples-bookinfo-details.tar.gz      </span><br><span class="line">docker load -i  examples-bookinfo-reviews-v1.tar.gz </span><br><span class="line">docker load -i  examples-bookinfo-productpage.tar.gz  </span><br><span class="line">docker load -i  examples-bookinfo-reviews-v2.tar.gz</span><br><span class="line">docker load -i  examples-bookinfo-ratings.tar.gz     </span><br><span class="line">docker load -i  examples-bookinfo-reviews-v3.tar.gz</span><br><span class="line">docker load -i  pilot.tar.gz</span><br><span class="line">docker load -i  proxyv2.tar.gz</span><br><span class="line">docker load -i  httpbin.tar.gz</span><br><span class="line"></span><br><span class="line">master:</span><br><span class="line">istioctl install --set profile=demo -y</span><br><span class="line"></span><br><span class="line">4.卸载istio集群，暂时不执行，记住这个命令即可</span><br><span class="line">istioctl manifest generate --set profile=demo | kubectl delete -f -</span><br></pre></td></tr></table></figure>
<h3 id="istio核心资源"><a class="markdownIt-Anchor" href="#istio核心资源">#</a> <strong>istio 核心资源</strong></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Gateway	</span><br><span class="line">在Kubernetes环境中，Ingress controller用于管理进入集群的流量。在Istio服务网格中 Istio Ingress Gateway承担相应的角色，它使用新的配置模型（Gateway 和 VirtualServices）完成流量管理的功能。通过下图做一个总的描述。</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDEyMzk5Ng==">K8s 为何需要 Istio？较为深入地讨论 Istio—— 其历史发展、设计理念、核心功能原理及运行流程 - 知乎 (zhihu.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81Mzg1ODUwMQ==">浅谈 Service Mesh: 其定义、起源、出现背景和设计理念及作用 - 知乎 (zhihu.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84MTU0NjU3Ng==">Istio 入门：什么是 Istio？Istio 的 4 个主要功能和实现原理 - 知乎 (zhihu.com)</span></p>
<h2 id="helm"><a class="markdownIt-Anchor" href="#helm">#</a> helm</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Helm是kubernetes的包管理工具，相当于linux环境下的yum/apg-get命令。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Helm中的一些概念：</span><br><span class="line">（1）helm：命令行客户端工具，主要用于Kubernetes应用中的chart的创建、打包、发布和管理。</span><br><span class="line">（2）Chart：helm程序包，一系列用于描述k8s资源相关文件的集合，比方说我们部署nginx，需要deployment的yaml，需要service的yaml，这两个清单文件就是一个helm程序包，在k8s中把这些yaml清单文件叫做chart图表。</span><br><span class="line">vlues.yaml文件为模板中的文件赋值，可以实现我们自定义安装</span><br><span class="line">如果是chart开发者需要自定义模板，如果是chart使用者只需要修改values.yaml即可</span><br><span class="line"></span><br><span class="line">repository：存放chart图表的仓库，提供部署k8s应用程序需要的那些yaml清单文件</span><br><span class="line"></span><br><span class="line">chart---&gt;通过values.yaml这个文件赋值--&gt;生成release实例</span><br><span class="line">helm也是go语言开发的</span><br><span class="line"></span><br><span class="line">（3）Release：基于Chart的部署实体，一个chart被Helm运行后将会生成对应的一个release；将在k8s中创建出真实运行的资源对象。</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">helm把kubernetes资源打包到一个chart中，制作并完成各个chart和chart本身依赖关系并利用chart仓库实现对外分发，而helm还可通过values.yaml文件完成可配置的发布，如果chart版本更新了，helm自动支持滚更更新机制，还可以一键回滚，但是不是适合在生产环境使用，除非具有定义自制chart的能力。</span><br><span class="line"></span><br><span class="line">https://github.com/helm/helm/releases</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609003730213.png" alt="image-20230609003730213"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">tar zxvf helm-v3.8.1-linux-amd64.tar.gz</span><br><span class="line"> mv linux-amd64/helm /usr/bin/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置国内存放chart仓库的地址</span><br><span class="line">阿里云仓库（https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts）</span><br><span class="line">官方仓库（https://hub.kubeapps.com/charts/incubator）官方chart仓库，国内可能无法访问。</span><br><span class="line">微软仓库（http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本上官网有的chart这里都有，国内可能无法访问。</span><br><span class="line"></span><br><span class="line">#添加阿里云的chart仓库</span><br><span class="line">[root@ ~]# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class="line"></span><br><span class="line">[root@prometheus-master ~]# helm repo list </span><br><span class="line">NAME   	URL                                                   </span><br><span class="line">aliyun 	https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class="line">bitnami	https://charts.bitnami.com/bitnami         </span><br><span class="line"></span><br><span class="line">helm repo update</span><br><span class="line"></span><br><span class="line">helm repo remove xxx</span><br><span class="line"></span><br><span class="line">#查看阿里云chart仓库中的memcached</span><br><span class="line">[root@ ~]# helm search repo aliyun |grep memcached</span><br><span class="line"></span><br><span class="line">#查看chart信息</span><br><span class="line">[root@ ~]# helm show chart  aliyun/memcached</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#下载chart包到本地</span><br><span class="line">[root@ ~]#  helm pull  aliyun/memcached</span><br><span class="line">[root@ ~]# tar zxvf memcached-2.0.1.tgz</span><br><span class="line">[root@ ~]# cd memcached</span><br><span class="line">[root@ memcached]# ls</span><br><span class="line">Chart.yaml  README.md  templates  values.yaml</span><br><span class="line"></span><br><span class="line">Chart.yaml: chart的基本信息，包括版本名字之类</span><br><span class="line">templates: 存放k8s的部署资源模板，通过渲染变量得到部署文件</span><br><span class="line">values.yaml：存放全局变量，templates下的文件可以调用</span><br><span class="line"></span><br><span class="line">[root@ memcached]# cd templates/</span><br><span class="line">[root@ templates]# ls</span><br><span class="line">_helpers.tpl  NOTES.txt  pdb.yaml  statefulset.yaml  svc.yaml</span><br><span class="line"></span><br><span class="line">_helpers.tpl      存放能够复用的模板</span><br><span class="line">NOTES.txt         为用户提供一个关于chart部署后使用说明的文件</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: StatefulSet</span><br><span class="line">metadata:</span><br><span class="line">  name: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class="line">  labels:</span><br><span class="line">    app: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class="line">    chart: &quot;&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class="line">    release: &quot;&#123;&#123; .Release.Name &#125;&#125;&quot;</span><br><span class="line">    heritage: &quot;&#123;&#123; .Release.Service &#125;&#125;&quot;</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class="line">      chart: &quot;&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class="line">      release: &quot;&#123;&#123; .Release.Name &#125;&#125;&quot;</span><br><span class="line">      heritage: &quot;&#123;&#123; .Release.Service &#125;&#125;&quot;</span><br><span class="line">  serviceName: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class="line">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class="line">  </span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class="line">    image: &#123;&#123; .Values.image &#125;&#125;</span><br><span class="line">    imagePullPolicy: &#123;&#123; default &quot;&quot; .Values.imagePullPolicy | quote &#125;&#125;</span><br><span class="line">    command:</span><br><span class="line">    - memcached</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">docker pull memcache:1.4.36-alpine</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm install memcache ./</span><br><span class="line"></span><br><span class="line">[root@prometheus-master memcached]# kubectl get pod </span><br><span class="line">NAME                               READY   STATUS    RESTARTS      AGE</span><br><span class="line">memcache-memcached-0               1/1     Running   0             2m13s</span><br><span class="line">memcache-memcached-1               1/1     Running   0             23s</span><br><span class="line">memcache-memcached-2               1/1     Running   0             13s</span><br><span class="line">[root@prometheus-master memcached]# kubectl get svc </span><br><span class="line">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE</span><br><span class="line">kubernetes           ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP     14d</span><br><span class="line">memcache-memcached   ClusterIP   None         &lt;none&gt;        11211/TCP   2m43s</span><br><span class="line">[root@prometheus-master memcached]# kubectl get sts</span><br><span class="line">NAME                 READY   AGE</span><br><span class="line">memcache-memcached   3/3     2m59s</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">测试：</span><br><span class="line">[root@prometheus-master memcached]# export POD_NAME=$(kubectl get pods --namespace default -l &quot;app=memcache-memcached&quot; -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;)</span><br><span class="line">[root@prometheus-master memcached]#   kubectl port-forward $POD_NAME 11211</span><br><span class="line">[root@prometheus-master ~]# echo -e &#x27;set mykey 0 60 5\r\nhello\r&#x27; | nc localhost 11211</span><br><span class="line">STORED</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">helm list</span><br><span class="line"></span><br><span class="line">helm delete memcache</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">当我们安装好helm之后我们可以开始自定义chart，那么我们需要先创建出一个模板如下：</span><br><span class="line">[root@ ~]<span class="comment"># helm create myapp</span></span><br><span class="line">[root@ ~]<span class="comment"># cd myapp/</span></span><br><span class="line">[root@ myapp]<span class="comment"># yum install tree -y</span></span><br><span class="line">[root@prometheus-master myapp]<span class="comment"># tree </span></span><br><span class="line">.</span><br><span class="line">├── charts</span><br><span class="line">├── Chart.yaml</span><br><span class="line">├── templates</span><br><span class="line">│   ├── deployment.yaml</span><br><span class="line">│   ├── _helpers.tpl</span><br><span class="line">│   ├── hpa.yaml</span><br><span class="line">│   ├── ingress.yaml</span><br><span class="line">│   ├── NOTES.txt</span><br><span class="line">│   ├── serviceaccount.yaml</span><br><span class="line">│   ├── service.yaml</span><br><span class="line">│   └── tests</span><br><span class="line">│       └── test-connection.yaml</span><br><span class="line">└── values.yaml</span><br><span class="line"></span><br><span class="line">部署release</span><br><span class="line">[root@ myapp]<span class="comment"># helm install  myapp .</span></span><br><span class="line"></span><br><span class="line">检查values语法格式</span><br><span class="line">[root@ myapp]<span class="comment"># helm lint /root/myapp/</span></span><br><span class="line"></span><br><span class="line">upgrade升级release</span><br><span class="line">[root@ myapp]<span class="comment"># helm upgrade --set service.type=&quot;NodePort&quot; myapp .</span></span><br><span class="line"></span><br><span class="line">回滚release</span><br><span class="line"><span class="comment">#查看历史版本</span></span><br><span class="line">[root@ myapp]<span class="comment"># helm history myapp</span></span><br><span class="line">helm rollback myapp 1</span><br><span class="line"></span><br><span class="line">打包Chart</span><br><span class="line">[root@  myapp]<span class="comment"># helm package /root/myapp/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">操作release命令</span><br><span class="line">升级release版本</span><br><span class="line">helm upgrade</span><br><span class="line"></span><br><span class="line">回滚release版本</span><br><span class="line">helm rollback</span><br><span class="line"></span><br><span class="line">创建一个release实例</span><br><span class="line">helm install</span><br><span class="line"></span><br><span class="line">卸载release</span><br><span class="line">helm uninstall</span><br><span class="line"></span><br><span class="line">查看历史版本</span><br><span class="line">helm history</span><br><span class="line"></span><br><span class="line">7.6 操作Chart命令</span><br><span class="line"></span><br><span class="line">#检查Chat的语法</span><br><span class="line">helm lint</span><br><span class="line"></span><br><span class="line">chart相关的</span><br><span class="line">查看chart的详细信息</span><br><span class="line">helm inspect </span><br><span class="line"></span><br><span class="line">把chart下载下来</span><br><span class="line">helm pull</span><br><span class="line"></span><br><span class="line">把chart打包</span><br><span class="line">helm package</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609152643159.png" alt="image-20230609152643159"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609152653698.png" alt="image-20230609152653698"></p>
<h2 id="rancher"><a class="markdownIt-Anchor" href="#rancher">#</a> Rancher</h2>
<p>Rancher 简介<br>
 Rancher 是一个开源的企业级多集群 Kubernetes 管理平台，实现了 Kubernetes 集群在混合云 + 本地数据中心的集中部署与管理，以确保集群的安全性，加速企业数字化转型。</p>
<p>Rancher 和 k8s 的区别<br>
 Rancher 和 k8s 都是用来作为容器的调度与编排系统。但是 rancher 不仅能够管理应用容器，更重要的一点是能够管理 k8s 集群。Rancher2.x 底层基于 k8s 调度引擎，通过 Rancher 的封装，用户可以在不熟悉 k8s 概念的情况下轻松的通过 Rancher 来部署容器到 k8s 集群当中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装rancher</span></span><br><span class="line"><span class="comment"># 修改内核参数</span></span><br><span class="line">modprobe br_netfilter</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;modprobe br_netfilter&quot;</span> &gt;&gt; /etc/profile</span><br><span class="line"><span class="built_in">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt;<span class="string">EOF</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class="line"><span class="string">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class="line"><span class="string">net.ipv4.ip_forward = 1</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class="line"></span><br><span class="line">在rancher上配置阿里云镜像源：</span><br><span class="line"><span class="built_in">mv</span> /etc/yum.repos.d/CentOS-Base.repo  /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="comment">#在rancher配置国内阿里云docker的repo源</span></span><br><span class="line">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class="line"> </span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate </span><br><span class="line"> </span><br><span class="line">在rancher上安装docker</span><br><span class="line">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class="line"></span><br><span class="line"><span class="built_in">tee</span> /etc/docker/daemon.json &lt;&lt; <span class="string">&#x27;EOF&#x27;</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">&quot;registry-mirrors&quot;</span>:[<span class="string">&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;</span>,<span class="string">&quot;https://registry.docker-cn.com&quot;</span>,<span class="string">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<span class="string">&quot;https://dockerhub.azk8s.cn&quot;</span>,<span class="string">&quot;http://hub-mirror.c.163.com&quot;</span>,<span class="string">&quot;http://qtid6917.mirror.aliyuncs.com&quot;</span>, <span class="string">&quot;https://rncxm540.mirror.aliyuncs.com&quot;</span>],</span><br><span class="line"><span class="string">&quot;exec-opts&quot;</span>: [<span class="string">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class="line">&#125; </span><br><span class="line">[root@rancher ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@rancher ~]<span class="comment"># systemctl restart docker</span></span><br><span class="line">[root@rancher ~]<span class="comment"># systemctl status docker</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在rancher上操作如下命令：</span><br><span class="line">[root@node1 ~]<span class="comment">#docker load -i rancher-agent_2.6.4.tar.gz</span></span><br><span class="line">[root@master1 ~]<span class="comment">#docker load -i rancher-agent_2.6.4.tar.gz</span></span><br><span class="line">[root@rancher ~]<span class="comment"># docker load -i rancher_2.6.4.tar.gz</span></span><br><span class="line">[root@rancher ~]<span class="comment"># docker run -d --restart=unless-stopped -p 80:80 -p 443:443 --privileged rancher/rancher:v2.6.4</span></span><br><span class="line"></span><br><span class="line">docker ps | grep rancher</span><br><span class="line"></span><br><span class="line">注：unless-stopped，在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器</span><br></pre></td></tr></table></figure>
<p>访问 rancher IP</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230610201304940.png" alt="image-20230610201304940"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">NAMESPACE             NAME                                        READY   STATUS              RESTARTS            AGE     IP               NODE                NOMINATED NODE   READINESS GATES</span><br><span class="line">cattle-fleet-system   fleet-agent-77c6d6f87-tw9q6                 0/1     ContainerCreating   0                   47s     &lt;none&gt;           prometheus-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cattle-system         cattle-cluster-agent-778b4cb5cf-fvcrh       1/1     Running             0                   78s     10.244.216.90    prometheus-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class="line">cattle-system         cattle-cluster-agent-778b4cb5cf-g69nt       1/1     Running             0                   66s     10.244.64.30     prometheus-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="管理已有集群"><a class="markdownIt-Anchor" href="#管理已有集群">#</a> 管理已有集群</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620145108499.png" alt="image-20230620145108499"></p>
<p>选择通用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620145117206.png" alt="image-20230620145117206"></p>
<p>接下来的创建资源的步骤和 kubernetes 自带的 dashboard 或者 kube-sphere 一样，都是图形化页面，不在赘述</p>
<h2 id="二进制安装k8s"><a class="markdownIt-Anchor" href="#二进制安装k8s">#</a> 二进制安装 k8s</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubeadm和二进制安装k8s适用场景分析</span><br><span class="line">kubeadm是官方提供的开源工具，是一个开源项目，用于快速搭建kubernetes集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm <span class="built_in">join</span> 这两个命令可以快速创建 kubernetes 集群。Kubeadm初始化k8s，所有的组件都是以pod形式运行的，具备故障自恢复能力。</span><br><span class="line">kubeadm是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对k8s架构组件理解不深的话，遇到问题比较难排查。</span><br><span class="line">kubeadm适合需要经常部署k8s，或者对自动化要求比较高的场景下使用。</span><br><span class="line">二进制：在官网下载相关组件的二进制包，如果手动安装，对kubernetes理解也会更全面。 </span><br><span class="line">Kubeadm和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。</span><br></pre></td></tr></table></figure>
<p>master1 192.168.13.200</p>
<p>master2 192.168.13.201</p>
<p>master3 192.168.13.202</p>
<p>work-node 192.168.13.203</p>
<p>virtual ip: 192.168.13.244</p>
<h3 id="初始化"><a class="markdownIt-Anchor" href="#初始化">#</a> 初始化</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">配置静态IP</span><br><span class="line">配置主机名</span><br><span class="line">配置/etc/hosts</span><br><span class="line">配置免密登录</span><br><span class="line">关闭firewalld</span><br><span class="line">关闭selinux</span><br><span class="line">关闭交换分区</span><br><span class="line">修改内核参数</span><br><span class="line">配置阿里云repo源</span><br><span class="line">配置时间同步</span><br><span class="line">安装并关闭iptables</span><br><span class="line">开启ipvs</span><br><span class="line">安装基础软件包</span><br><span class="line">安装docker-ce</span><br><span class="line">配置docker镜像加速</span><br></pre></td></tr></table></figure>
<h3 id="安装etcd集群"><a class="markdownIt-Anchor" href="#安装etcd集群">#</a> 安装 etcd 集群</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line">配置etcd工作目录</span><br><span class="line"><span class="comment">#创建配置文件和证书文件存放目录</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># mkdir -p /etc/etcd</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># mkdir -p /etc/etcd/ssl</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># mkdir -p /etc/etcd</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># mkdir -p /etc/etcd/ssl</span></span><br><span class="line">[root@ master3 ~]<span class="comment"># mkdir -p /etc/etcd</span></span><br><span class="line">[root@ master3 ~]<span class="comment"># mkdir -p /etc/etcd/ssl</span></span><br><span class="line"></span><br><span class="line">安装签发证书工具cfssl</span><br><span class="line">[root@ master1 ~]<span class="comment"># mkdir /data/work -p</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># cd /data/work/</span></span><br><span class="line"><span class="comment">#cfssl-certinfo_linux-amd64 、cfssljson_linux-amd64 、cfssl_linux-amd64上传到/data/work/目录下</span></span><br><span class="line">[root@ master1 work]<span class="comment"># ls</span></span><br><span class="line">cfssl-certinfo_linux-amd64  cfssljson_linux-amd64  cfssl_linux-amd64</span><br><span class="line"><span class="comment">#把文件变成可执行权限</span></span><br><span class="line">[root@ master1 work]<span class="comment"># chmod +x *</span></span><br><span class="line">[root@ master1 work]<span class="comment"># mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span><br><span class="line">[root@ master1 work]<span class="comment"># mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span><br><span class="line">[root@ master1 work]<span class="comment"># mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span></span><br><span class="line"></span><br><span class="line">配置ca证书</span><br><span class="line"><span class="comment">#生成ca证书请求文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim ca-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">  <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">      <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">      <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">      <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;ca&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -initca ca-csr.json  | cfssljson -bare ca</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#生成ca证书文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim ca-config.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;signing&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">      <span class="string">&quot;profiles&quot;</span>: &#123;</span><br><span class="line">          <span class="string">&quot;kubernetes&quot;</span>: &#123;</span><br><span class="line">              <span class="string">&quot;usages&quot;</span>: [</span><br><span class="line">                  <span class="string">&quot;signing&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;key encipherment&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;server auth&quot;</span>,</span><br><span class="line">                  <span class="string">&quot;client auth&quot;</span></span><br><span class="line">              ],</span><br><span class="line">              <span class="string">&quot;expiry&quot;</span>: <span class="string">&quot;87600h&quot;</span></span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">生成etcd证书</span><br><span class="line">    <span class="comment">#配置etcd证书请求，hosts的ip变成自己etcd所在节点的ip</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim etcd-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;etcd&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.200&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.201&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.202&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.244&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [&#123;</span><br><span class="line">    <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">    <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">    <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">    <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">    <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson  -bare etcd</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># ls etcd*.pem</span></span><br><span class="line">etcd-key.pem  etcd.pem</span><br><span class="line"></span><br><span class="line">部署etcd集群</span><br><span class="line">把etcd-v3.4.13-linux-amd64.tar.gz上传到/data/work目录下</span><br><span class="line">[root@ master1 work]<span class="comment"># pwd</span></span><br><span class="line">/data/work</span><br><span class="line">[root@ master1 work]<span class="comment"># tar -xf etcd-v3.4.13-linux-amd64.tar.gz</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp -p etcd-v3.4.13-linux-amd64/etcd* /usr/local/bin/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># scp -r  etcd-v3.4.13-linux-amd64/etcd*  master2:/usr/local/bin/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># scp -r  etcd-v3.4.13-linux-amd64/etcd*  master3:/usr/local/bin/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim etcd.conf </span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd1&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.13.200:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.13.200:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.13.200:2380&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.13.200:2379&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建启动服务文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim etcd.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Etcd Server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">WorkingDirectory=/var/lib/etcd/</span><br><span class="line">ExecStart=/usr/local/bin/etcd \</span><br><span class="line">  --cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \</span><br><span class="line">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \</span><br><span class="line">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \</span><br><span class="line">  --peer-client-cert-auth \</span><br><span class="line">  --client-cert-auth</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># cp ca*.pem /etc/etcd/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp etcd*.pem /etc/etcd/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp etcd.conf /etc/etcd/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp etcd.service /usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># for i in  master2  master3;do rsync -vaz etcd.conf $i:/etc/etcd/;done</span></span><br><span class="line">[root@ master1 work]<span class="comment"># for i in  master2  master3;do rsync -vaz etcd*.pem ca*.pem $i:/etc/etcd/ssl/;done</span></span><br><span class="line">[root@ master1 work]<span class="comment"># for i in  master2  master3;do rsync -vaz etcd.service $i:/usr/lib/systemd/system/;done</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动etcd集群</span></span><br><span class="line">[root@ master1 work]<span class="comment"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class="line">[root@ master2 work]<span class="comment"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class="line">[root@ master3 work]<span class="comment"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class="line"></span><br><span class="line">[root@ master2 ~]<span class="comment"># vim /etc/etcd/etcd.conf </span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd2&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.13.201:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.13.201:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.13.201:2380&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.13.201:2379&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line"></span><br><span class="line">[root@ master3 ~]<span class="comment"># vim /etc/etcd/etcd.conf </span></span><br><span class="line"><span class="comment">#[Member]</span></span><br><span class="line">ETCD_NAME=<span class="string">&quot;etcd3&quot;</span></span><br><span class="line">ETCD_DATA_DIR=<span class="string">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class="line">ETCD_LISTEN_PEER_URLS=<span class="string">&quot;https://192.168.13.202:2380&quot;</span></span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=<span class="string">&quot;https://192.168.13.202:2379,http://127.0.0.1:2379&quot;</span></span><br><span class="line"><span class="comment">#[Clustering]</span></span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class="string">&quot;https://192.168.13.202:2380&quot;</span></span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=<span class="string">&quot;https://192.168.13.202:2379&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER=<span class="string">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=<span class="string">&quot;etcd-cluster&quot;</span></span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=<span class="string">&quot;new&quot;</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl enable etcd.service</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl start etcd.service</span></span><br><span class="line"></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl enable etcd.service</span></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl start etcd.service</span></span><br><span class="line"></span><br><span class="line">启动etcd的时候，先启动 master1的etcd服务，会一直卡住在启动的状态，然后接着再启动 master2的etcd，这样 master1这个节点etcd才会正常起来</span><br><span class="line"></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl enable etcd.service</span></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl start etcd.service</span></span><br><span class="line"></span><br><span class="line">[root@ master1]<span class="comment"># systemctl status etcd</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl status etcd</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl status etcd</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看etcd集群</span></span><br><span class="line">[root@ master1 work]<span class="comment"># ETCDCTL_API=3</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># /usr/local/bin/etcdctl --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=https://192.168.13.200:2379,https://192.168.13.201:2379,https://192.168.13.202:2379  endpoint health</span></span><br><span class="line"></span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class="line">+----------------------------+--------+-------------+-------+</span><br><span class="line">| https://192.168.13.200:2379 |   <span class="literal">true</span> | 12.614205ms |       |</span><br><span class="line">| https://192.168.13.201:2379 |   <span class="literal">true</span> | 15.762435ms |       |</span><br><span class="line">| https://192.168.13.202:2379 |   <span class="literal">true</span> | 76.066459ms |       |</span><br><span class="line">+----------------------------+--------+-------------+-------+ |</span><br></pre></td></tr></table></figure>
<h3 id="安装kubernetes组件"><a class="markdownIt-Anchor" href="#安装kubernetes组件">#</a> 安装 kubernetes 组件</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">下载安装包</span><br><span class="line">二进制包所在的github地址如下：</span><br><span class="line">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</span><br><span class="line"></span><br><span class="line">#把kubernetes-server-linux-amd64.tar.gz上传到 master1上的/data/work目录下:</span><br><span class="line">[root@ master1 work]# tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@ master1 work]# cd kubernetes/server/bin/</span><br><span class="line">[root@ master1 bin]# cp kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/</span><br><span class="line">[root@ master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl  master2:/usr/local/bin/</span><br><span class="line">[root@ master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl  master3:/usr/local/bin/</span><br><span class="line"></span><br><span class="line">[root@ master1 bin]# scp kubelet kube-proxy  node1:/usr/local/bin/</span><br><span class="line">[root@ master1 bin]# cd /data/work/</span><br><span class="line">[root@ master1 work]# mkdir -p /etc/kubernetes/ </span><br><span class="line">[root@ master1 work]# mkdir -p /etc/kubernetes/ssl</span><br><span class="line">[root@ master1 work]# mkdir /var/log/kubernetes</span><br></pre></td></tr></table></figure>
<h4 id="部署apiserver组件"><a class="markdownIt-Anchor" href="#部署apiserver组件">#</a> 部署 apiserver 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line">部署apiserver组件</span><br><span class="line"><span class="comment">#启动TLS Bootstrapping 机制</span></span><br><span class="line"><span class="comment">#创建token.csv文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cat &gt; token.csv &lt;&lt; EOF</span></span><br><span class="line">$(<span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>),kubelet-bootstrap,10001,<span class="string">&quot;system:kubelet-bootstrap&quot;</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建csr请求文件，替换为自己机器的IP</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-apiserver-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.200&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.201&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.202&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.203&quot;</span>,</span><br><span class="line">    <span class="string">&quot;192.168.13.244&quot;</span>,</span><br><span class="line">    <span class="string">&quot;10.255.0.1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class="line">    <span class="string">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">      <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">      <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建api-server的配置文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-apiserver.conf </span></span><br><span class="line">KUBE_APISERVER_OPTS=<span class="string">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \</span></span><br><span class="line"><span class="string">  --anonymous-auth=false \</span></span><br><span class="line"><span class="string">  --bind-address=192.168.13.200 \</span></span><br><span class="line"><span class="string">  --secure-port=6443 \</span></span><br><span class="line"><span class="string">  --advertise-address=192.168.13.200 \</span></span><br><span class="line"><span class="string">  --insecure-port=0 \</span></span><br><span class="line"><span class="string">  --authorization-mode=Node,RBAC \</span></span><br><span class="line"><span class="string">  --runtime-config=api/all=true \</span></span><br><span class="line"><span class="string">  --enable-bootstrap-token-auth \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.255.0.0/16 \</span></span><br><span class="line"><span class="string">  --token-auth-file=/etc/kubernetes/token.csv \</span></span><br><span class="line"><span class="string">  --service-node-port-range=30000-50000 \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \</span></span><br><span class="line"><span class="string">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \</span></span><br><span class="line"><span class="string">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \</span></span><br><span class="line"><span class="string">  --etcd-cafile=/etc/etcd/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \</span></span><br><span class="line"><span class="string">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \</span></span><br><span class="line"><span class="string">  --etcd-servers=https://192.168.13.200:2379,https://192.168.13.201:2379,https://192.168.13.202:2379 \</span></span><br><span class="line"><span class="string">  --enable-swagger-ui=true \</span></span><br><span class="line"><span class="string">  --allow-privileged=true \</span></span><br><span class="line"><span class="string">  --apiserver-count=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxage=30 \</span></span><br><span class="line"><span class="string">  --audit-log-maxbackup=3 \</span></span><br><span class="line"><span class="string">  --audit-log-maxsize=100 \</span></span><br><span class="line"><span class="string">  --audit-log-path=/var/log/kube-apiserver-audit.log \</span></span><br><span class="line"><span class="string">  --event-ttl=1h \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=4&quot;</span></span><br><span class="line">  </span><br><span class="line"><span class="comment">#创建服务启动文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-apiserver.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=etcd.service</span><br><span class="line">Wants=etcd.service</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver <span class="variable">$KUBE_APISERVER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">Type=notify</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># cp ca*.pem /etc/kubernetes/ssl</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-apiserver*.pem /etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp token.csv /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-apiserver.conf /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-apiserver.service /usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz token.csv  master2:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz token.csv  master3:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz ca*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz ca*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver.conf  master2:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver.conf  master3:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver.service  master2:/usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-apiserver.service  master3:/usr/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#  master2和 master3配置文件kube-apiserver.conf的IP地址修改为实际的本机IP</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># cat /etc/kubernetes/kube-apiserver.conf </span></span><br><span class="line">[root@ master3 ~]<span class="comment"># cat /etc/kubernetes/kube-apiserver.conf </span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl enable kube-apiserver</span></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl enable kube-apiserver</span></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl enable kube-apiserver</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl start kube-apiserver</span></span><br><span class="line">[root@ master2 work]<span class="comment"># systemctl start kube-apiserver</span></span><br><span class="line">[root@ master3 work]<span class="comment"># systemctl start kube-apiserver</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment">#  systemctl status kube-apiserver</span></span><br><span class="line">[root@ master2 work]<span class="comment">#  systemctl status kube-apiserver</span></span><br><span class="line">[root@ master3 work]<span class="comment">#  systemctl status kube-apiserver</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment">#  curl --insecure https://192.168.40.180:6443/</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;Status&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;metadata&quot;</span>: &#123;</span><br><span class="line">    </span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;status&quot;</span>: <span class="string">&quot;Failure&quot;</span>,</span><br><span class="line">  <span class="string">&quot;message&quot;</span>: <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">  <span class="string">&quot;reason&quot;</span>: <span class="string">&quot;Unauthorized&quot;</span>,</span><br><span class="line">  <span class="string">&quot;code&quot;</span>: 401</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">上面看到401，这个是正常的的状态，还没认证</span><br></pre></td></tr></table></figure>
<h4 id="部署kubectl组件"><a class="markdownIt-Anchor" href="#部署kubectl组件">#</a> 部署 kubectl 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">可以设置一个环境变量KUBECONFIG</span><br><span class="line">[root@  master1 ~]<span class="comment"># export KUBECONFIG =/etc/kubernetes/admin.conf</span></span><br><span class="line">这样在操作kubectl，就会自动加载KUBECONFIG来操作要管理哪个集群的k8s资源了</span><br><span class="line"></span><br><span class="line">也可以按照下面方法</span><br><span class="line">[root@  master1 ~]<span class="comment"># cp /etc/kubernetes/admin.conf /root/.kube/config</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建csr请求文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim admin-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;admin&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hosts&quot;</span>: [],</span><br><span class="line">  <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">      <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">      <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:masters&quot;</span>,             </span><br><span class="line">      <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br><span class="line"></span><br><span class="line">配置安全上下文</span><br><span class="line"><span class="comment">#创建kubeconfig配置文件</span></span><br><span class="line">1.设置集群参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube.config</span></span><br><span class="line">2.设置客户端认证参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-credentials admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=kube.config</span></span><br><span class="line">3.设置上下文参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-context kubernetes --cluster=kubernetes --user=admin --kubeconfig=kube.config</span></span><br><span class="line">4.设置当前上下文</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config use-context kubernetes --kubeconfig=kube.config</span></span><br><span class="line">[root@ master1 work]<span class="comment"># mkdir ~/.kube -p</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube.config ~/.kube/config</span></span><br><span class="line">5.授权kubernetes证书访问kubelet api权限</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看集群组件状态</span></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl cluster-info</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl get all --all-namespaces</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#同步kubectl文件到其他节点</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># mkdir /root/.kube/</span></span><br><span class="line">[root@ master3 ~]<span class="comment">#  mkdir /root/.kube/</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz /root/.kube/config  master2:/root/.kube/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz /root/.kube/config  master3:/root/.kube/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置kubectl子命令补全</span></span><br><span class="line">[root@ master1 work]<span class="comment"># yum install -y bash-completion</span></span><br><span class="line">[root@ master1 work]<span class="comment"># source /usr/share/bash-completion/bash_completion</span></span><br><span class="line">[root@ master1 work]<span class="comment"># source &lt;(kubectl completion bash)</span></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl completion bash &gt; ~/.kube/completion.bash.inc</span></span><br><span class="line">[root@ master1 work]<span class="comment"># source &#x27;/root/.kube/completion.bash.inc&#x27;</span></span><br><span class="line">[root@ master1 work]<span class="comment"># source $HOME/.bash_profile</span></span><br></pre></td></tr></table></figure>
<h4 id="创建kube-controller-manager组件"><a class="markdownIt-Anchor" href="#创建kube-controller-manager组件">#</a> 创建 kube-controller-manager 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[root@ master1 work]<span class="comment"># vim kube-controller-manager-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.200&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.201&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.202&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.244&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">        <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建kube-controller-manager的kubeconfig</span></span><br><span class="line">1.设置集群参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line">2.设置客户端认证参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line">3.设置上下文参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line">4.设置当前上下文</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件kube-controller-manager.conf</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-controller-manager.conf </span></span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=<span class="string">&quot;--port=0 \</span></span><br><span class="line"><span class="string">  --secure-port=10252 \</span></span><br><span class="line"><span class="string">  --bind-address=127.0.0.1 \</span></span><br><span class="line"><span class="string">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \</span></span><br><span class="line"><span class="string">  --service-cluster-ip-range=10.255.0.0/16 \</span></span><br><span class="line"><span class="string">  --cluster-name=kubernetes \</span></span><br><span class="line"><span class="string">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --allocate-node-cidrs=true \</span></span><br><span class="line"><span class="string">  --cluster-cidr=10.0.0.0/16 \</span></span><br><span class="line"><span class="string">  --experimental-cluster-signing-duration=87600h \</span></span><br><span class="line"><span class="string">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \</span></span><br><span class="line"><span class="string">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \</span></span><br><span class="line"><span class="string">  --leader-elect=true \</span></span><br><span class="line"><span class="string">  --feature-gates=RotateKubeletServerCertificate=true \</span></span><br><span class="line"><span class="string">  --controllers=*,bootstrapsigner,tokencleaner \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-use-rest-clients=true \</span></span><br><span class="line"><span class="string">  --horizontal-pod-autoscaler-sync-period=10s \</span></span><br><span class="line"><span class="string">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \</span></span><br><span class="line"><span class="string">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \</span></span><br><span class="line"><span class="string">  --use-service-account-credentials=true \</span></span><br><span class="line"><span class="string">  --alsologtostderr=true \</span></span><br><span class="line"><span class="string">  --logtostderr=false \</span></span><br><span class="line"><span class="string">  --log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">  --v=2&quot;</span></span><br><span class="line"><span class="comment">#创建启动文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-controller-manager.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Controller Manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager <span class="variable">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-controller-manager*.pem /etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-controller-manager.conf /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-controller-manager.service /usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf  master2:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf  master3:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager.service  master2:/usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-controller-manager.service  master3:/usr/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl enable kube-controller-manager</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl start kube-controller-manager</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line">[root@ master2]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl enable kube-controller-manager</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl start kube-controller-manager</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl status kube-controller-manager</span></span><br><span class="line"></span><br><span class="line">[root@ master3]<span class="comment"># systemctl daemon-reload </span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl enable kube-controller-manager</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl start kube-controller-manager</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure>
<h4 id="创建kube-scheduler组件"><a class="markdownIt-Anchor" href="#创建kube-scheduler组件">#</a> 创建 kube-scheduler 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建csr请求</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-scheduler-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;system:kube-scheduler&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hosts&quot;</span>: [</span><br><span class="line">      <span class="string">&quot;127.0.0.1&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.200&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.201&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.202&quot;</span>,</span><br><span class="line">      <span class="string">&quot;192.168.13.244&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">        <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">        <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">        <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">        <span class="string">&quot;O&quot;</span>: <span class="string">&quot;system:kube-scheduler&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#生成证书</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建kube-scheduler的kubeconfig</span></span><br><span class="line">1.设置集群参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line">2.设置客户端认证参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line">3.设置上下文参数</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line">4.设置当前上下文</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件kube-scheduler.conf</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-scheduler.conf </span></span><br><span class="line">KUBE_SCHEDULER_OPTS=<span class="string">&quot;--address=127.0.0.1 \</span></span><br><span class="line"><span class="string">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \</span></span><br><span class="line"><span class="string">--leader-elect=true \</span></span><br><span class="line"><span class="string">--alsologtostderr=true \</span></span><br><span class="line"><span class="string">--logtostderr=false \</span></span><br><span class="line"><span class="string">--log-dir=/var/log/kubernetes \</span></span><br><span class="line"><span class="string">--v=2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建服务启动文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-scheduler.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler <span class="variable">$KUBE_SCHEDULER_OPTS</span></span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-scheduler*.pem /etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-scheduler.conf /etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># cp kube-scheduler.service /usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf  master2:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf  master3:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler.service  master2:/usr/lib/systemd/system/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># rsync -vaz kube-scheduler.service  master3:/usr/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl enable kube-scheduler</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl start kube-scheduler</span></span><br><span class="line">[root@ master1 work]<span class="comment"># systemctl status kube-scheduler</span></span><br><span class="line"></span><br><span class="line">[root@ master2]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl enable kube-scheduler</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl start kube-scheduler</span></span><br><span class="line">[root@ master2]<span class="comment"># systemctl status kube-scheduler</span></span><br><span class="line"></span><br><span class="line">[root@ master3]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl enable kube-scheduler</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl start kube-scheduler</span></span><br><span class="line">[root@ master3]<span class="comment"># systemctl status kube-scheduler</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#把pause-cordns.tar.gz上传到 node1节点，手动解压</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># docker load -i pause-cordns.tar.gz</span></span><br></pre></td></tr></table></figure>
<h4 id="部署kubelet组件"><a class="markdownIt-Anchor" href="#部署kubelet组件">#</a> 部署 kubelet 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">创建kubelet-bootstrap.kubeconfig</span><br><span class="line">[root@ master1 work]<span class="comment"># cd /data/work/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># BOOTSTRAP_TOKEN=$(awk -F &quot;,&quot; &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv)</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># rm -r kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment">#  kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-credentials kubelet-bootstrap --token=$&#123;BOOTSTRAP_TOKEN&#125; --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建配置文件kubelet.json</span></span><br><span class="line"><span class="string">&quot;cgroupDriver&quot;</span>: <span class="string">&quot;systemd&quot;</span>要和docker的驱动一致。</span><br><span class="line">address替换为自己 node1的IP地址。</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kubelet.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;kind&quot;</span>: <span class="string">&quot;KubeletConfiguration&quot;</span>,</span><br><span class="line">  <span class="string">&quot;apiVersion&quot;</span>: <span class="string">&quot;kubelet.config.k8s.io/v1beta1&quot;</span>,</span><br><span class="line">  <span class="string">&quot;authentication&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;x509&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;clientCAFile&quot;</span>: <span class="string">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;webhook&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;enabled&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">      <span class="string">&quot;cacheTTL&quot;</span>: <span class="string">&quot;2m0s&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;anonymous&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;enabled&quot;</span>: <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;authorization&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;mode&quot;</span>: <span class="string">&quot;Webhook&quot;</span>,</span><br><span class="line">    <span class="string">&quot;webhook&quot;</span>: &#123;</span><br><span class="line">      <span class="string">&quot;cacheAuthorizedTTL&quot;</span>: <span class="string">&quot;5m0s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;cacheUnauthorizedTTL&quot;</span>: <span class="string">&quot;30s&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;address&quot;</span>: <span class="string">&quot;192.168.13.203&quot;</span>,</span><br><span class="line">  <span class="string">&quot;port&quot;</span>: 10250,</span><br><span class="line">  <span class="string">&quot;readOnlyPort&quot;</span>: 10255,</span><br><span class="line">  <span class="string">&quot;cgroupDriver&quot;</span>: <span class="string">&quot;systemd&quot;</span>,</span><br><span class="line">  <span class="string">&quot;hairpinMode&quot;</span>: <span class="string">&quot;promiscuous-bridge&quot;</span>,</span><br><span class="line">  <span class="string">&quot;serializeImagePulls&quot;</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="string">&quot;featureGates&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;RotateKubeletClientCertificate&quot;</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="string">&quot;RotateKubeletServerCertificate&quot;</span>: <span class="literal">true</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;clusterDomain&quot;</span>: <span class="string">&quot;cluster.local.&quot;</span>,</span><br><span class="line">  <span class="string">&quot;clusterDNS&quot;</span>: [<span class="string">&quot;10.255.0.2&quot;</span>]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kubelet.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kubelet</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=docker.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kubelet</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \</span><br><span class="line">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \</span><br><span class="line">  --cert-dir=/etc/kubernetes/ssl \</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \</span><br><span class="line">  --config=/etc/kubernetes/kubelet.json \</span><br><span class="line">  --network-plugin=cni \</span><br><span class="line">  --pod-infra-container-image=k8s.gcr.io/pause:3.2 \</span><br><span class="line">  --alsologtostderr=<span class="literal">true</span> \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># mkdir /etc/kubernetes/ssl -p</span></span><br><span class="line">[root@ master1 work]<span class="comment"># scp kubelet-bootstrap.kubeconfig kubelet.json  node1:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># scp  ca.pem  node1:/etc/kubernetes/ssl/</span></span><br><span class="line">[root@ master1 work]<span class="comment"># scp  kubelet.service  node1:/usr/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动kubelet服务</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># mkdir /var/lib/kubelet</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># mkdir /var/log/kubernetes</span></span><br><span class="line">[root@ node1 ~]<span class="comment">#  systemctl daemon-reload</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl enable kubelet</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl start kubelet</span></span><br><span class="line">[root@ node1 ~]<span class="comment">#  systemctl status kubelet</span></span><br><span class="line"></span><br><span class="line">执行如下命令可以看到一个worker节点发送了一个 CSR 请求：</span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc   87s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl certificate approve node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc</span></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl get csr</span></span><br><span class="line">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc   2m25s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME    STATUS     ROLES    AGE   VERSION</span><br><span class="line"> node1   NotReady   &lt;none&gt;   30s   v1.20.7</span><br></pre></td></tr></table></figure>
<h4 id="部署kube-proxy组件"><a class="markdownIt-Anchor" href="#部署kube-proxy组件">#</a> 部署 kube-proxy 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建csr请求</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-proxy-csr.json </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;CN&quot;</span>: <span class="string">&quot;system:kube-proxy&quot;</span>,</span><br><span class="line">  <span class="string">&quot;key&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;algo&quot;</span>: <span class="string">&quot;rsa&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span>: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;names&quot;</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="string">&quot;C&quot;</span>: <span class="string">&quot;CN&quot;</span>,</span><br><span class="line">      <span class="string">&quot;ST&quot;</span>: <span class="string">&quot;Hubei&quot;</span>,</span><br><span class="line">      <span class="string">&quot;L&quot;</span>: <span class="string">&quot;Wuhan&quot;</span>,</span><br><span class="line">      <span class="string">&quot;O&quot;</span>: <span class="string">&quot;k8s&quot;</span>,</span><br><span class="line">      <span class="string">&quot;OU&quot;</span>: <span class="string">&quot;system&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">生成证书</span><br><span class="line">[root@ master1 work]<span class="comment"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建kubeconfig文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建kube-proxy配置文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-proxy.yaml </span></span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">bindAddress: 192.168.13.203</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">clusterCIDR: 192.168.13.0/24</span><br><span class="line">healthzBindAddress: 192.168.13.203:10256</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">metricsBindAddress: 192.168.13.203:10249</span><br><span class="line">mode: <span class="string">&quot;ipvs&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建服务启动文件</span></span><br><span class="line">[root@ master1 work]<span class="comment"># vim kube-proxy.service </span></span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Kube-Proxy Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target</span><br><span class="line"> </span><br><span class="line">[Service]</span><br><span class="line">WorkingDirectory=/var/lib/kube-proxy</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \</span><br><span class="line">  --config=/etc/kubernetes/kube-proxy.yaml \</span><br><span class="line">  --alsologtostderr=<span class="literal">true</span> \</span><br><span class="line">  --logtostderr=<span class="literal">false</span> \</span><br><span class="line">  --log-dir=/var/log/kubernetes \</span><br><span class="line">  --v=2</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line"> </span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@ master1 work]<span class="comment"># scp  kube-proxy.kubeconfig kube-proxy.yaml  node1:/etc/kubernetes/</span></span><br><span class="line">[root@ master1 work]<span class="comment">#scp  kube-proxy.service  node1:/usr/lib/systemd/system/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#启动服务</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># mkdir -p /var/lib/kube-proxy</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl enable kube-proxy</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl  start kube-proxy</span></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure>
<h4 id="部署calico组件"><a class="markdownIt-Anchor" href="#部署calico组件">#</a> 部署 calico 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@ node1 ~]<span class="comment"># docker load -i calico.tar.gz</span></span><br><span class="line"><span class="comment">#把calico.yaml文件上传到 master1上的的/data/work目录</span></span><br><span class="line">[root@ master1 work]<span class="comment"># kubectl apply -f calico.yaml</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line"></span><br><span class="line">[root@ master1 ~]<span class="comment"># kubectl get nodes</span></span><br><span class="line">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class="line">node1   Ready    &lt;none&gt;   73m   v1.20.7</span><br></pre></td></tr></table></figure>
<h4 id="部署coredns组件"><a class="markdownIt-Anchor" href="#部署coredns组件">#</a> 部署 coredns 组件</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@ master1 ~]<span class="comment"># kubectl apply -f coredns.yaml</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># kubectl get pods -n kube-system</span></span><br><span class="line">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class="line">calico-kube-controllers-6949477b58-qvn5b   1/1     Running   0          2m17s</span><br><span class="line">calico-node-lv6w4                            1/1     Running   0          2m18s</span><br><span class="line">coredns-7bf4bd64bd-dt8dq   1/1     Running   0          51s</span><br><span class="line">[root@ master1 ~]<span class="comment"># kubectl get svc -n kube-system</span></span><br><span class="line">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class="line">kube-dns   ClusterIP   10.255.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br></pre></td></tr></table></figure>
<h3 id="查看集群状态"><a class="markdownIt-Anchor" href="#查看集群状态">#</a> 查看集群状态</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@</span> <span class="string">master1</span> <span class="string">~</span>]<span class="comment"># kubectl get nodes</span></span><br><span class="line"><span class="string">NAME</span>    <span class="string">STATUS</span>   <span class="string">ROLES</span>    <span class="string">AGE</span>   <span class="string">VERSION</span></span><br><span class="line"><span class="string">node1</span>   <span class="string">Ready</span>    <span class="string">&lt;none&gt;</span>   <span class="string">38m</span>   <span class="string">v1.20.7</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 测试</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">node1</span> <span class="string">~</span>]<span class="comment"># docker load -i tomcat.tar.gz</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f tomcat.yaml</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f tomcat-service.yaml</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">master1</span> <span class="string">~</span>]<span class="comment"># kubectl get svc</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@</span> <span class="string">master1</span> <span class="string">~</span>]<span class="comment"># kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># ping www.baidu.com</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># nslookup kubernetes.default.svc.cluster.local</span></span><br><span class="line"><span class="string">/</span> <span class="comment"># nslookup tomcat.default.svc.cluster.local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="keepalivednginx实现高可用"><a class="markdownIt-Anchor" href="#keepalivednginx实现高可用">#</a> keepalived+nginx 实现高可用</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line">把epel.repo传到 master2、 master3、 node1上</span><br><span class="line">[root@ master1 ~]<span class="comment"># scp /etc/yum.repos.d/epel.repo  master2:/etc/yum.repos.d/</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># scp /etc/yum.repos.d/epel.repo  master3:/etc/yum.repos.d/</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># scp /etc/yum.repos.d/epel.repo  node1:/etc/yum.repos.d/</span></span><br><span class="line"></span><br><span class="line">1、安装nginx主备：</span><br><span class="line">在 master1和 master2上做nginx主备安装</span><br><span class="line">[root@ master1 ~]<span class="comment">#  yum install nginx keepalived -y</span></span><br><span class="line">[root@ master2 ~]<span class="comment">#  yum install nginx keepalived -y</span></span><br><span class="line">2、修改nginx配置文件。主备一样</span><br><span class="line">[root@ master1 ~]<span class="comment"># cat /etc/nginx/nginx.conf</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># cat /etc/nginx/nginx.conf</span></span><br><span class="line"></span><br><span class="line">两个master上nginx配置文件一样</span><br><span class="line">user nginx;</span><br><span class="line">worker_processes auto;</span><br><span class="line">error_log /var/log/nginx/error.log;</span><br><span class="line">pid /run/nginx.pid;</span><br><span class="line"></span><br><span class="line">include /usr/share/nginx/modules/*.conf;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections 1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class="line">stream &#123;</span><br><span class="line"></span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class="line"></span><br><span class="line">    upstream k8s-apiserver &#123;</span><br><span class="line">       server 192.168.13.200:6443;   <span class="comment">#  master1 APISERVER IP:PORT</span></span><br><span class="line">       server 192.168.13.201:6443;   <span class="comment">#  master2 APISERVER IP:PORT</span></span><br><span class="line">       server 192.168.13.202:6443;   <span class="comment">#  master3 APISERVER IP:PORT</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    server &#123;</span><br><span class="line">       listen 16443; <span class="comment"># 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突</span></span><br><span class="line">       proxy_pass k8s-apiserver;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    log_format  main  <span class="string">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class="line">                      <span class="string">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    access_log  /var/log/nginx/access.log  main;</span><br><span class="line"></span><br><span class="line">    sendfile            on;</span><br><span class="line">    tcp_nopush          on;</span><br><span class="line">    tcp_nodelay         on;</span><br><span class="line">    keepalive_timeout   65;</span><br><span class="line">    types_hash_max_size 2048;</span><br><span class="line"></span><br><span class="line">    include             /etc/nginx/mime.types;</span><br><span class="line">    default_type        application/octet-stream;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># keepalive配置</span></span><br><span class="line">主keepalived</span><br><span class="line">[root@ master1 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf </span></span><br><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_MASTER</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state MASTER </span><br><span class="line">    interface ens33  <span class="comment"># 修改为实际网卡名</span></span><br><span class="line">    virtual_router_id 51 <span class="comment"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line">    priority 100    <span class="comment"># 优先级，备服务器设置 90 </span></span><br><span class="line">    advert_int 1    <span class="comment"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    <span class="comment"># 虚拟IP</span></span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.13.244/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ master1 ~]<span class="comment"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$count</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl stop keepalived</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">[root@ master1 ~]<span class="comment"># chmod +x  /etc/keepalived/check_nginx.sh</span></span><br><span class="line"></span><br><span class="line">[root@ master2 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf </span></span><br><span class="line">global_defs &#123; </span><br><span class="line">   notification_email &#123; </span><br><span class="line">     acassen@firewall.loc </span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc </span><br><span class="line">   &#125; </span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class="line">   smtp_server 127.0.0.1 </span><br><span class="line">   smtp_connect_timeout 30 </span><br><span class="line">   router_id NGINX_BACKUP</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">    script <span class="string">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123; </span><br><span class="line">    state BACKUP </span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51 <span class="comment"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123; </span><br><span class="line">        auth_type PASS      </span><br><span class="line">        auth_pass 1111 </span><br><span class="line">    &#125;  </span><br><span class="line">    virtual_ipaddress &#123; </span><br><span class="line">        192.168.13.244/24</span><br><span class="line">    &#125; </span><br><span class="line">    track_script &#123;</span><br><span class="line">        check_nginx</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@ master2 ~]<span class="comment"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class="line"><span class="comment">#!/bin/bash</span></span><br><span class="line">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class="string">&quot;grep|$$&quot;</span>)</span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$count</span>&quot;</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">    systemctl stop keepalived</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># chmod +x /etc/keepalived/check_nginx.sh</span></span><br><span class="line"></span><br><span class="line">[root@ master1 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># yum install nginx-mod-stream -y</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># systemctl start nginx</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">[root@ master1 ~]<span class="comment"># systemctl enable nginx keepalived</span></span><br><span class="line"></span><br><span class="line">[root@ master2 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># yum install nginx-mod-stream -y</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># systemctl start nginx</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">[root@ master2 ~]<span class="comment"># systemctl enable nginx keepalived</span></span><br><span class="line"></span><br><span class="line">改所有Worker Node（kubectl get node命令查看到的节点）组件配置文件，由原来192.168.13.200修改为192.168.13.244（VIP）。</span><br><span class="line">在所有Worker Node执行：</span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet-bootstrap.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet.json</span></span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kube-proxy.yaml</span></span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kube-proxy.kubeconfig</span></span><br><span class="line"></span><br><span class="line">[root@ node1 ~]<span class="comment"># systemctl restart kubelet kube-proxy</span></span><br></pre></td></tr></table></figure>
<h2 id="ackcce"><a class="markdownIt-Anchor" href="#ackcce">#</a> ACK&amp;&amp;CCE</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">阿里云容器服务Kubernetes版（Alibaba Cloud Container Service for Kubernetes，简称容器服务ACK）是全球首批通过Kubernetes一致性认证的服务平台，提供高性能的容器应用管理服务，支持企业级Kubernetes容器化应用的生命周期管理，让您轻松高效地在云端运行Kubernetes容器化应用。</span><br><span class="line"></span><br><span class="line">ACK包含了专有版Kubernetes（Dedicated Kubernetes）、托管版Kubernetes（Managed Kubernetes）、Serverless Kubernetes三种形态，方便按需选择。</span><br><span class="line"></span><br><span class="line">https://www.aliyun.com/product/kubernetes</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">云容器引擎（Cloud Container Engine）提供高可靠高性能的企业级容器应用管理服务，支持Kubernetes社区原生应用和工具，简化云上自动化容器运行环境搭建，面向云原生2.0打造CCE Turbo容器集群，计算、网络、调度全面加速，全面加速企业应用创新。</span><br><span class="line"></span><br><span class="line">https://www.huaweicloud.com/product/cce.html</span><br></pre></td></tr></table></figure>
<p>使用 kubernetes 集群</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">只要有kubectl的机器即可，完成购买后他们会提供config</span><br><span class="line">替换/root/.kube/config </span><br><span class="line">即可访问集群，记得需要通过公网ip</span><br><span class="line">kubectl config view 查看是否替换为公网IP</span><br></pre></td></tr></table></figure>
<h2 id="基于hpa和vpa实现pod自动扩缩容"><a class="markdownIt-Anchor" href="#基于hpa和vpa实现pod自动扩缩容">#</a> 基于 HPA 和 VPA 实现 Pod 自动扩缩容</h2>
<p>弹性伸缩是根据用户的业务需求和策略，自动 “调整” 其 “弹性资源” 的管理服务。通过弹性伸缩功能，用户可设置定时、周期或监控策略，恰到好处地增加或减少 “弹性资源”，并完成实例配置，保证业务平稳健康运行</p>
<p>在实际工作中，我们常常需要做一些扩容缩容操作，如：电商平台在 618 和双十一搞秒杀活动；由于资源紧张、工作负载降低等都需要对服务实例数进行扩缩容操作。</p>
<p>在 k8s 中扩缩容分为两种：</p>
<p>1、Node 层面：<br>
对 K8s 物理节点扩容和缩容，根据业务规模实现物理节点自动扩缩容</p>
<p>2、Pod 层面：<br>
我们一般会使用 Deployment 中的 replicas 参数，设置多个副本集来保证服务的高可用，但是这是一个固定的值，比如我们设置 10 个副本，就会启 10 个 pod 同时 running 来提供服务。如果这个服务平时流量很少的时候，也是 10 个 pod 同时在 running，而流量突然暴增时，又可能出现 10 个 pod 不够用的情况。针对这种情况怎么办？就需要扩容和缩容</p>
<h3 id="k8s中自动伸缩的方案"><a class="markdownIt-Anchor" href="#k8s中自动伸缩的方案">#</a> k8s 中自动伸缩的方案</h3>
<h4 id="hpa"><a class="markdownIt-Anchor" href="#hpa">#</a> HPA</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># HPA</span><br><span class="line">Kubernetes HPA（Horizontal Pod Autoscaling）：Pod水平自动伸缩</span><br><span class="line"></span><br><span class="line">通过此功能，只需简单的配置，便可以利用监控指标（cpu使用率、磁盘、自定义的等）自动的扩容或缩容服务中Pod数量，当业务需求增加时，系统将无缝地自动增加适量pod容器，提高系统稳定性。</span><br><span class="line"></span><br><span class="line">HPA v1版本可以根据CPU使用率来进行自动扩缩容：</span><br><span class="line">但是并非所有的系统都可以仅依靠CPU或者Memory指标来扩容，对于大多数 Web 应用的后端来说，基于每秒的请求数量进行弹性伸缩来处理突发流量会更加的靠谱，所以对于一个自动扩缩容系统来说，我们不能局限于CPU、Memory基础监控数据，每秒请求数RPS等自定义指标也是十分重要。</span><br><span class="line"></span><br><span class="line">HPA v2版本可以根据自定义的指标进行自动扩缩容</span><br><span class="line"></span><br><span class="line">hpa v1只能基于cpu做扩容所用</span><br><span class="line">hpa v2可以基于内存和自定义的指标做扩容和缩容</span><br><span class="line"></span><br><span class="line">如果我们的系统默认依赖Prometheus，自定义的Metrics指标则可以从各种数据源或者exporter中获取，基于拉模型的Prometheus会定期从数据源中拉取数据。 也可以基于metrics-server自动获取节点和pod的资源指标</span><br><span class="line"></span><br><span class="line">K8s的HPA controller已经实现了一套简单的自动扩缩容逻辑，默认情况下，每30s检测一次指标，只要检测到了配置HPA的目标值，则会计算出预期的工作负载的副本数，再进行扩缩容操作。同时，为了避免过于频繁的扩缩容，默认在5min内没有重新扩缩容的情况下，才会触发扩缩容。 HPA本身的算法相对比较保守，可能并不适用于很多场景。例如，一个快速的流量突发场景，如果正处在5min内的HPA稳定期，这个时候根据HPA的策略，会导致无法扩容。</span><br></pre></td></tr></table></figure>
<h4 id="kpa"><a class="markdownIt-Anchor" href="#kpa">#</a> KPA</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kpa</span></span><br><span class="line">KPA（Knative Pod Autoscaler）：基于请求数对Pod自动扩缩容，KPA 的主要限制在于它不支持基于 CPU 的自动扩缩容。</span><br><span class="line"></span><br><span class="line">1、根据并发请求数实现自动扩缩容</span><br><span class="line">2、设置扩缩容边界实现自动扩缩容</span><br><span class="line"></span><br><span class="line">扩缩容边界指应用程序提供服务的最小和最大Pod数量。通过设置应用程序提供服务的最小和最大Pod数量实现自动扩缩容。</span><br><span class="line">相比HPA，KPA会考虑更多的场景，其中一个比较重要的是流量突发的时候</span><br></pre></td></tr></table></figure>
<h4 id="vpa"><a class="markdownIt-Anchor" href="#vpa">#</a> VPA</h4>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">kubernetes VPA（Vertical Pod Autoscaler），垂直 Pod 自动扩缩容，VPA会基于Pod的资源使用情况自动为集群设置资源占用的限制，从而让集群将Pod调度到有足够资源的最佳节点上。VPA也会保持最初容器定义中资源request和<span class="built_in">limit</span>的占比。</span><br><span class="line">它会根据容器资源使用率自动设置pod的CPU和内存的requests，从而允许在节点上进行适当的调度，以便为每个 Pod 提供适当的可用的节点。它既可以缩小过度请求资源的容器，也可以根据其使用情况随时提升资源不足的容量。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">HPA全称是Horizontal Pod Autoscaler，翻译成中文是POD水平自动伸缩， HPA可以基于CPU利用率对deployment中的pod数量进行自动扩缩容（除了CPU也可以基于自定义的指标进行自动扩缩容）。pod自动缩放不适用于无法缩放的对象，比如DaemonSets。</span><br><span class="line">HPA由Kubernetes API资源和控制器实现。控制器会周期性的获取平均CPU利用率，并与目标值相比较后调整deployment中的副本数量。</span><br><span class="line"></span><br><span class="line">HPA是根据指标来进行自动伸缩的，目前HPA有两个版本–v1和v2beta</span><br><span class="line"></span><br><span class="line">HPA的API有三个版本，通过kubectl api-versions | grep autoscal可看到</span><br><span class="line">autoscaling/v1</span><br><span class="line">autoscaling/v2beta1</span><br><span class="line">autoscaling/v2beta2</span><br><span class="line"></span><br><span class="line">autoscaling/v1只支持基于CPU指标的缩放；</span><br><span class="line">autoscaling/v2beta1支持Resource Metrics（资源指标，如pod内存）和Custom Metrics（自定义指标）的缩放；</span><br><span class="line">autoscaling/v2beta2支持Resource Metrics（资源指标，如pod的内存）和Custom Metrics（自定义指标）和ExternalMetrics（额外指标）的缩放，但是目前也仅仅是处于beta阶段</span><br><span class="line"></span><br><span class="line">K8S从1.8版本开始，CPU、内存等资源的metrics信息可以通过 Metrics API来获取，用户可以直接获取这些metrics信息（例如通过执行kubect top命令），HPA使用这些metics信息来实现动态伸缩。</span><br><span class="line"></span><br><span class="line">Metrics server：</span><br><span class="line">1、Metrics server是K8S集群资源使用情况的聚合器</span><br><span class="line">2、从1.8版本开始，Metrics server可以通过yaml文件的方式进行部署</span><br><span class="line">3、Metrics server收集所有node节点的metrics信息</span><br><span class="line"></span><br><span class="line">HPA的实现是一个控制循环，由controller manager的--horizontal-pod-autoscaler-sync-period参数指定周期（默认值为15秒）。每个周期内，controller manager根据每个HorizontalPodAutoscaler定义中指定的指标查询资源利用率。controller manager可以从resource metrics API（pod 资源指标）和custom metrics API（自定义指标）获取指标。</span><br><span class="line"></span><br><span class="line">然后，通过现有pods的CPU使用率的平均值（计算方式是最近的pod使用量（最近一分钟的平均值，从metrics-server中获得）除以设定的每个Pod的CPU使用率限额）跟目标使用率进行比较，并且在扩容时，还要遵循预先设定的副本数限制：MinReplicas &lt;= Replicas &lt;= MaxReplicas。</span><br><span class="line"></span><br><span class="line">计算扩容后Pod的个数：<span class="built_in">sum</span>(最近一分钟内某个Pod的CPU使用率的平均值)/CPU使用上限的整数+1</span><br><span class="line"></span><br><span class="line">流程：</span><br><span class="line">1、创建HPA资源，设定目标CPU使用率限额，以及最大、最小实例数</span><br><span class="line">2、收集一组中（PodSelector）每个Pod最近一分钟内的CPU使用率，并计算平均值</span><br><span class="line">3、读取HPA中设定的CPU使用限额</span><br><span class="line">4、计算：平均值之和/限额，求出目标调整的实例个数</span><br><span class="line">5、目标调整的实例数不能超过1中设定的最大、最小实例数，如果没有超过，则扩容；超过，则扩容至最大的实例个数</span><br><span class="line">6、回到2，不断循环</span><br></pre></td></tr></table></figure>
<h3 id="metrics-server"><a class="markdownIt-Anchor" href="#metrics-server">#</a> metrics-server</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">metrics-server是一个集群范围内的资源数据集和工具，同样的，metrics-server也只是显示数据，并不提供数据存储服务，主要关注的是资源度量API的实现，比如CPU、文件描述符、内存、请求延时等指标，metric-server收集数据给k8s集群内使用，如kubectl,hpa,scheduler等。</span><br><span class="line"></span><br><span class="line">https://github.com/kubernetes-sigs/metrics-server/</span><br><span class="line"></span><br><span class="line">docker load -i metrics-server-0.6.1.tar.gz</span><br><span class="line"></span><br><span class="line">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class="line">    - --enable-aggregator-routing=true</span><br><span class="line"></span><br><span class="line"># 所有节点重启kubelet</span><br><span class="line">systemctl restart kubelet</span><br><span class="line"></span><br><span class="line">在components.yaml中增加如下字段：</span><br><span class="line">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620162201037.png" alt="image-20230620162201037"></p>
<h3 id="php-apache-利用hpa扩缩容"><a class="markdownIt-Anchor" href="#php-apache-利用hpa扩缩容">#</a> php-apache 利用 hpa 扩缩容</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">php-apache服务正在运行，使用kubectl</span> <span class="string">autoscale创建自动缩放器，实现对php-apache这个deployment创建的pod自动扩缩容，下面的命令将会创建一个HPA，HPA将会根据CPU，内存等资源指标增加或减少副本数，创建一个可以实现如下目的的hpa：</span></span><br><span class="line"><span class="number">1</span><span class="string">）让副本数维持在1-10个之间（这里副本数指的是通过deployment部署的pod的副本数）</span></span><br><span class="line"><span class="number">2</span><span class="string">）将所有Pod的平均CPU使用率维持在50％（通过kubectl</span> <span class="string">run运行的每个pod如果是200毫核，这意味着平均CPU利用率为100毫核）</span></span><br><span class="line"><span class="comment">#给上面php-apache这个deployment创建HPA,基于cpu动态扩缩容</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">~</span>]<span class="comment"># kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">~</span>]<span class="comment"># kubectl get hpa </span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"># 创建一个hpa，基于内存动态扩缩容</span><br><span class="line">[root@ ~]# cat hpa-v1.yaml </span><br><span class="line">apiVersion: autoscaling/v2</span><br><span class="line">kind: HorizontalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-hpa</span><br><span class="line">spec:</span><br><span class="line">    maxReplicas: 10</span><br><span class="line">    minReplicas: 1</span><br><span class="line">    scaleTargetRef:</span><br><span class="line">      apiVersion: apps/v1</span><br><span class="line">      kind: Deployment</span><br><span class="line">      name: nginx-hpa</span><br><span class="line">    metrics:</span><br><span class="line">    - type: Resource</span><br><span class="line">      resource:</span><br><span class="line">        name: memory</span><br><span class="line">        target:</span><br><span class="line">         averageUtilization: 60</span><br><span class="line">         type: Utilization</span><br><span class="line">         </span><br><span class="line">kubectl get hpa</span><br><span class="line">扩展：查看v2版本的hpa如何定义？</span><br><span class="line">[root@ ~]# kubectl get hpa.v2beta2.autoscaling -o yaml &gt; 1.yaml</span><br></pre></td></tr></table></figure>
<h3 id="vpa-2"><a class="markdownIt-Anchor" href="#vpa-2">#</a> VPA</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">使用updateMode: &quot;Off&quot;模式，这种模式仅获取资源推荐值，但是不更新Pod</span><br><span class="line"></span><br><span class="line">apiVersion: autoscaling.k8s.io/v1beta2</span><br><span class="line">kind: VerticalPodAutoscaler</span><br><span class="line">metadata:</span><br><span class="line">  name: nginx-vpa</span><br><span class="line">  namespace: vpa</span><br><span class="line">spec:</span><br><span class="line">  targetRef:</span><br><span class="line">    apiVersion: &quot;apps/v1&quot;</span><br><span class="line">    kind: Deployment</span><br><span class="line">    name: nginx</span><br><span class="line">  updatePolicy:</span><br><span class="line">    updateMode: &quot;Off&quot;</span><br><span class="line">  resourcePolicy:</span><br><span class="line">    containerPolicies:</span><br><span class="line">    - containerName: &quot;nginx&quot;</span><br><span class="line">      minAllowed:</span><br><span class="line">        cpu: &quot;500m&quot;</span><br><span class="line">        memory: &quot;100Mi&quot;</span><br><span class="line">      maxAllowed:</span><br><span class="line">        cpu: &quot;2000m&quot;</span><br><span class="line">        memory: &quot;2600Mi&quot;</span><br><span class="line">        </span><br><span class="line">kubectl get vpa -n vpa</span><br><span class="line"> </span><br><span class="line">Lower Bound:           下限值</span><br><span class="line">Target:                推荐值</span><br><span class="line">Upper Bound:           上限值</span><br><span class="line">Uncapped Target:       如果没有为VPA提供最小或最大边界，则表示目标利用率</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">updateMode: &quot;Auto&quot;</span><br><span class="line"></span><br><span class="line">从输出信息可以看到，vpa执行了EvictedByVPA，自动停掉了nginx，然后使用 VPA推荐的资源启动了新的nginx</span><br><span class="line">，我们查看下nginx的pod可以得到确认</span><br><span class="line"></span><br><span class="line">随着服务的负载的变化，VPA的推荐值也会不断变化。当目前运行的pod的资源达不到VPA的推荐值，就会执行pod驱逐，重新部署新的足够资源的服务。</span><br><span class="line"></span><br><span class="line">VPA使用限制：</span><br><span class="line">不能与HPA（Horizontal Pod Autoscaler ）一起使用</span><br><span class="line">Pod比如使用副本控制器，例如属于Deployment或者StatefulSet</span><br><span class="line"></span><br><span class="line">VPA好处：</span><br><span class="line">Pod 资源用其所需，所以集群节点使用效率高。</span><br><span class="line">Pod 会被安排到具有适当可用资源的节点上。</span><br><span class="line">不必运行基准测试任务来确定 CPU 和内存请求的合适值。</span><br><span class="line">VPA 可以随时调整 CPU 和内存请求，无需人为操作，因此可以减少维护时间。</span><br></pre></td></tr></table></figure>
<h3 id="kubernetes-cluster-autoscaler"><a class="markdownIt-Anchor" href="#kubernetes-cluster-autoscaler">#</a> kubernetes cluster-autoscaler</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">Cluster Autoscaler (CA)是一个独立程序，是用来弹性伸缩kubernetes集群的。它可以自动根据部署应用所请求的资源量来动态的伸缩集群。当集群容量不足时，它会自动去 Cloud Provider （支持 GCE、GKE 和 AWS）创建新的 Node，而在 Node 长时间资源利用率很低时自动将其删除以节省开支。</span><br><span class="line"></span><br><span class="line">在以下情况下，集群自动扩容或者缩放：</span><br><span class="line">扩容：由于资源不足，某些Pod无法在任何当前节点上进行调度</span><br><span class="line"></span><br><span class="line">缩容: Node节点资源利用率较低时，且此node节点上存在的pod都能被重新调度到其他node节点上运行</span><br><span class="line"></span><br><span class="line">什么时候集群节点不会被 CA 删除?</span><br><span class="line">1）节点上有pod被 PodDisruptionBudget 控制器限制。</span><br><span class="line">2）节点上有命名空间是 kube-system 的pods。</span><br><span class="line">3）节点上的pod不是被控制器创建，例如不是被deployment, replica set, job, stateful set创建。</span><br><span class="line">4）节点上有pod使用了本地存储</span><br><span class="line">5）节点上pod驱逐后无处可去，即没有其他node能调度这个pod</span><br><span class="line">6）节点有注解：&quot;cluster-autoscaler.kubernetes.io/scale-down-disabled&quot;: &quot;true&quot;(在CA 1.0.3或更高版本中受支持)</span><br><span class="line"></span><br><span class="line">通过PodDisruptionBudget控制器可以设置应用POD集群处于运行状态最低个数，也可以设置应用POD集群处于运行状态的最低百分比，这样可以保证在主动销毁应用POD的时候，不会一次性销毁太多的应用POD，从而保证业务不中断</span><br><span class="line"></span><br><span class="line">Horizontal Pod Autoscaler 会根据当前CPU负载更改部署或副本集的副本数。如果负载增加，则HPA将创建新的副本，集群中可能有足够的空间，也可能没有足够的空间。如果没有足够的资源，CA将尝试启动一些节点，以便HPA创建的Pod可以运行。如果负载减少，则HPA将停止某些副本。结果，某些节点可能变得利用率过低或完全为空，然后CA将终止这些不需要的节点。</span><br><span class="line"></span><br><span class="line">如何防止节点被CA删除?</span><br><span class="line">节点可以打上以下标签：</span><br><span class="line">&quot;cluster-autoscaler.kubernetes.io/scale-down-disabled&quot;: &quot;true&quot;</span><br><span class="line"></span><br><span class="line">可以使用 kubectl 将其添加到节点(或从节点删除)：</span><br><span class="line">$ kubectl annotate node &lt;nodename&gt;  cluster-autoscaler.kubernetes.io/scale-down-disabled=true</span><br></pre></td></tr></table></figure>
<h2 id="python-调用k8s-api"><a class="markdownIt-Anchor" href="#python-调用k8s-api">#</a> python 调用 k8s api</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">python操作kubernetes api需要如下两个条件：</span><br><span class="line">1.前提是需要有个k8s集群环境</span><br><span class="line">2.需要在windows上安装kubernetes模块</span><br><span class="line"></span><br><span class="line">在windows下安装kubernetes</span><br><span class="line">pip install --ignore-installed kubernetes</span><br><span class="line"></span><br><span class="line">认证：把k8s集群的控制节点上的/root/.kube/config传到自己的电脑指定路径下，我传到了C盘，注意：每个人config文件不一样，大家需要用自己k8s集群控制节点的config文件</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client,config</span><br><span class="line">config.kube_config.load_kube_config(config_file=<span class="string">&#x27;C:\config&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#获取CoreV1API版本对象</span></span><br><span class="line">v1 = client.CoreV1Api()</span><br><span class="line"></span><br><span class="line"><span class="comment">#列出来k8s中的所有名称空间</span></span><br><span class="line"><span class="keyword">for</span> namespace <span class="keyword">in</span> v1.list_namespace().items:</span><br><span class="line">    <span class="built_in">print</span>(namespace.metadata.name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> node <span class="keyword">in</span> v1.list_node().items:</span><br><span class="line">    <span class="built_in">print</span>(node.metadata.name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#列举所有名称空间下的所有service</span></span><br><span class="line">services=v1.list_service_for_all_namespaces()</span><br><span class="line"><span class="keyword">for</span> svc <span class="keyword">in</span> services.items:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;%s \t%s \t%s \t%s \n&#x27;</span> %(svc.metadata.namespace,svc.metadata.name,svc.spec.cluster_ip,svc.spec.ports))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#列举所有名称空间下的pod资源</span></span><br><span class="line">pods=v1.list_pod_for_all_namespaces()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> pods.items:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s\t%s\t%s&quot;</span> %(i.status.pod_ip,i.metadata.namespace,i.metadata.name))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#client.AppsV1Api对象可以操作跟k8s中控制器相关资源对象，下面演示的是列举所有名称空间的deployment</span></span><br><span class="line">v1_deploy=client.AppsV1Api()</span><br><span class="line">deploys=v1_deploy.list_deployment_for_all_namespaces()</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> deploys.items:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;%s\t%s\t%s&quot;</span>%(i.metadata.name,i.metadata.namespace,i.spec.replicas))</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client,config</span><br><span class="line"><span class="comment">#引入我们要用的包</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    config.load_kube_config(config_file=<span class="string">&#x27;C:\config&#x27;</span>)</span><br><span class="line"><span class="comment">#读入集群相关信息，就是要操作哪个集群</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(path.join(path.dirname(__file__),<span class="string">&quot;nginx-deploy.yaml&quot;</span>)) <span class="keyword">as</span> f:</span><br><span class="line">        dep=yaml.safe_load(f)</span><br><span class="line">        k8s_apps_v1=client.AppsV1Api()</span><br><span class="line">        resp = k8s_apps_v1.create_namespaced_deployment(body=dep,namespace=<span class="string">&#x27;default&#x27;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&#x27;deployment created,name=%s&#x27;</span>%(resp.metadata.name))</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">      main()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client,config</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    config.load_kube_config(config_file=<span class="string">&#x27;C:\config&#x27;</span>)</span><br><span class="line">    k8s_core_v1=client.CoreV1Api()</span><br><span class="line">    resp=k8s_core_v1.delete_namespaced_pod(namespace=<span class="string">&#x27;default&#x27;</span>,name=<span class="string">&#x27;busybox-test&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;delete pod&#x27;</span>)</span><br><span class="line">main()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">上面是删除自己linux机器上的k8s集群的默认名称空间下的busybox-test这个pod</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client,config</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    config.load_kube_config(config_file=<span class="string">&#x27;C:\config&#x27;</span>)</span><br><span class="line">    k8s_core_v1=client.CoreV1Api()</span><br><span class="line">    old_resp=k8s_core_v1.read_namespaced_pod(namespace=<span class="string">&#x27;default&#x27;</span>,name=<span class="string">&#x27;busybox-test&#x27;</span>)</span><br><span class="line">    old_resp.spec.containers[<span class="number">0</span>].image=<span class="string">&#x27;nginx&#x27;</span></span><br><span class="line">    <span class="comment">#修改镜像</span></span><br><span class="line">    new_resp=k8s_core_v1.patch_namespaced_pod(namespace=<span class="string">&#x27;default&#x27;</span>,name=<span class="string">&#x27;busybox-test&#x27;</span>,body=old_resp)</span><br><span class="line">    <span class="built_in">print</span>(new_resp.spec.containers[<span class="number">0</span>].image)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> os <span class="keyword">import</span> path</span><br><span class="line"><span class="keyword">import</span> yaml</span><br><span class="line"><span class="keyword">from</span> kubernetes <span class="keyword">import</span> client,config</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>():</span><br><span class="line">    config.load_kube_config(config_file=<span class="string">&#x27;C:\config&#x27;</span>)</span><br><span class="line">    k8s_core_v1=client.CoreV1Api()</span><br><span class="line">    resp=k8s_core_v1.read_namespaced_pod(namespace=<span class="string">&#x27;default&#x27;</span>,name=<span class="string">&#x27;busybox-test&#x27;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;read pod&#x27;</span>)</span><br><span class="line"><span class="comment">#    print(resp)</span></span><br><span class="line">    <span class="comment">#读取指定的信息</span></span><br><span class="line">    <span class="built_in">print</span>(resp.spec.containers[<span class="number">0</span>])</span><br><span class="line">    <span class="built_in">print</span>(resp.spec.containers[<span class="number">0</span>].image)</span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    main()</span><br></pre></td></tr></table></figure>
<h2 id="ephemeral"><a class="markdownIt-Anchor" href="#ephemeral">#</a> ephemeral</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">临时容器与其他容器的不同之处在于，它们缺少对资源或执行的保证，并且永远不会自动重启，因此不适用于构建应用程序。临时容器使用与常规容器相同的 Container.Spec字段进行描述，但许多字段是不允许使用的。</span><br><span class="line">临时容器没有端口配置，因此像 ports，livenessProbe，readinessProbe 这样的字段是不允许的。</span><br><span class="line">Pod 资源分配是不可变的，因此 resources 配置是不允许的。</span><br><span class="line">临时容器是使用 API 中的一种特殊的 ephemeralcontainers 处理器进行创建的， 而不是直接添加到 pod.spec 段，因此无法使用 kubectl edit 来添加一个临时容器。</span><br><span class="line"></span><br><span class="line">与常规容器一样，将临时容器添加到 Pod 后，将不能更改或删除临时容器</span><br><span class="line"></span><br><span class="line">当由于容器崩溃或容器镜像不包含调试实用程序而导致 kubectl exec 无用时，临时容器对于交互式故障排查很有用。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">需要开启支持临时容器的特性：</span></span><br><span class="line"><span class="string">修改kube-apiserver.yaml、kube-scheduler.yaml、kubelet配置。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@</span>]<span class="comment"># cat /etc/kubernetes/manifests/kube-apiserver.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.180</span><span class="string">:6443</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-apiserver</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-apiserver</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--advertise-address=192.168.40.180</span></span><br><span class="line">    <span class="string">………</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=RemoveSelfLink=false</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=EphemeralContainers=true</span></span><br><span class="line"><span class="string">………</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新增加--feature-gates=EphemeralContainers=true字段</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">root@</span>]<span class="comment"># cat /etc/kubernetes/manifests/kube-scheduler.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">creationTimestamp:</span> <span class="literal">null</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="attr">tier:</span> <span class="string">control-plane</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">kube-scheduler</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">command:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">kube-scheduler</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--bind-address=192.168.40.180</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--leader-elect=true</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=EphemeralContainers=true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#新增加--feature-gates=EphemeralContainers=true字段</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master</span>]<span class="comment"># cat /etc/sysconfig/kubelet </span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--feature-gates=EphemeralContainers=true&quot;</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@node~</span>]<span class="comment"># cat /etc/sysconfig/kubelet </span></span><br><span class="line"><span class="string">KUBELET_EXTRA_ARGS=&quot;--feature-gates=EphemeralContainers=true&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#修改之后重启k8s控制节点和工作节点的kubelet</span></span><br><span class="line">[<span class="string">root@</span>]<span class="comment"># systemctl restart kubelet</span></span><br><span class="line">[<span class="string">root@</span> <span class="string">~</span>]<span class="comment"># systemctl restart kubelet</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看kube-system名称空间pod，都是running说明修改正常</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: v1</span><br><span class="line">kind: Pod</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-test</span><br><span class="line">  namespace: default</span><br><span class="line">  labels:</span><br><span class="line">    app:  tomcat</span><br><span class="line">spec:</span><br><span class="line">  containers:</span><br><span class="line">  - name:  tomcat-java</span><br><span class="line">    ports:</span><br><span class="line">    - containerPort: 8080</span><br><span class="line">    image: tomcat-8.5-jre8</span><br><span class="line">    imagePullPolicy: IfNotPresent</span><br><span class="line">    </span><br><span class="line">#创建临时容器</span><br><span class="line">[root@xianchaomaster1]# kubectl debug -it tomcat-test --image=busybox:1.28 --target=tomcat-java</span><br><span class="line"></span><br><span class="line">[root@prometheus-master ~]# kubectl describe pod tomcat-test </span><br><span class="line">Containers:</span><br><span class="line">  tomcat-java:</span><br><span class="line">    Container ID:   docker://b15184eb42acf60957e2d245a3e784ec20528f057adc55fdb944aee4ffcd968d</span><br><span class="line">    Image:          tomcat-8.5-jre8</span><br><span class="line">    Image ID:       docker://sha256:4ac473a3dd922eecfc8e0dabd9f6c410871dfd913fea49bfed3fb99924839131</span><br><span class="line">    Port:           8080/TCP</span><br><span class="line">    Host Port:      0/TCP</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Sun, 11 Jun 2023 02:10:21 +0800</span><br><span class="line">    Ready:          True</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:</span><br><span class="line">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-mhn6h (ro)</span><br><span class="line">Ephemeral Containers:</span><br><span class="line">  debugger-tnspk:</span><br><span class="line">    Container ID:   docker://0d8d52ce48509f796aa591d7175242f34b00d0235e9d58710f0109dbce30683c</span><br><span class="line">    Image:          busybox:1.28</span><br><span class="line">    Image ID:       docker://sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a</span><br><span class="line">    Port:           &lt;none&gt;</span><br><span class="line">    Host Port:      &lt;none&gt;</span><br><span class="line">    State:          Running</span><br><span class="line">      Started:      Sun, 11 Jun 2023 02:12:52 +0800</span><br><span class="line">    Ready:          False</span><br><span class="line">    Restart Count:  0</span><br><span class="line">    Environment:    &lt;none&gt;</span><br><span class="line">    Mounts:         &lt;none&gt;</span><br><span class="line">    </span><br><span class="line">kubectl debug 每次都会创建一个新的临时容器，以前的临时容器不会删除，但也无法登录</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">raw更新临时容器</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">applf</span> <span class="string">-f</span> <span class="string">tomcat.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">a.json</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;:</span> <span class="string">&quot;v1&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;kind&quot;:</span> <span class="string">&quot;EphemeralContainers&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;metadata&quot;:</span> &#123;</span><br><span class="line">            <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;tomcat-test&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;ephemeralContainers&quot;:</span> [&#123;</span><br><span class="line">        <span class="attr">&quot;command&quot;:</span> [</span><br><span class="line">            <span class="string">&quot;sh&quot;</span></span><br><span class="line">        ],</span><br><span class="line">        <span class="attr">&quot;image&quot;:</span> <span class="string">&quot;busybox&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;imagePullPolicy&quot;:</span> <span class="string">&quot;IfNotPresent&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;name&quot;:</span> <span class="string">&quot;debugger&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;stdin&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;tty&quot;:</span> <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">&quot;targetContainerName&quot;:</span> <span class="string">&quot;tomcat-java&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;terminationMessagePolicy&quot;:</span> <span class="string">&quot;File&quot;</span></span><br><span class="line">    &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">replace</span> <span class="string">--raw</span> <span class="string">/api/v1/namespaces/default/pods/tomcat-test/ephemeralcontainers</span> <span class="string">-f</span> <span class="string">a.json</span> </span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">attach</span> <span class="string">-it</span> <span class="string">-c</span> <span class="string">debugger</span> <span class="string">tomcat-test</span></span><br><span class="line"></span><br><span class="line"><span class="string">附加退出后不能在进入临时容器</span></span><br><span class="line"></span><br><span class="line"><span class="string">临时容器特别适合包含主容器剥离出来的一些调试工具，在需要的时候临时注入到目标pod中</span></span><br><span class="line"><span class="string">在pod中添加临时容器之后，目前还无法删除，同时如果这时候临时容器已经退出，会导致无法再次attach，也不会被拉起（临时容器不支持probe），相关的issue：</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">如果attach了临时容器，然后退出了容器主进程（和前面示例中展示的那样），会导致这个容器无法再attach，也无法重新启动。此时，如果要重复上述步骤再次进行调试，需要新创建一个临时容器，同时还需要保留老的配置，否则k8s会拒绝新的配置：</span><br><span class="line"></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;apiVersion&quot;</span><span class="punctuation">:</span> <span class="string">&quot;v1&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;kind&quot;</span><span class="punctuation">:</span> <span class="string">&quot;EphemeralContainers&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;metadata&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tomcat-test&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;ephemeralContainers&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">   <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;sh&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;imagePullPolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IfNotPresent&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debugger&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;targetContainerName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tomcat-java&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;terminationMessagePolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;File&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="punctuation">&#123;</span><span class="attr">&quot;command&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">            <span class="string">&quot;sh&quot;</span></span><br><span class="line">        <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;image&quot;</span><span class="punctuation">:</span> <span class="string">&quot;busybox&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;imagePullPolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;IfNotPresent&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;debugger1&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;stdin&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;tty&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;targetContainerName&quot;</span><span class="punctuation">:</span> <span class="string">&quot;tomcat-java&quot;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="attr">&quot;terminationMessagePolicy&quot;</span><span class="punctuation">:</span> <span class="string">&quot;File&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line">配置文件需要做这样的修改，再新增一个临时容器。重新修改后pod的状态（describe结果）：</span><br><span class="line"></span><br><span class="line"><span class="punctuation">[</span>root@<span class="punctuation">]</span># kubectl replace --raw /api/v1/namespaces/default/pods/tomcat-test/ephemeralcontainers -f a.json</span><br><span class="line"> </span><br><span class="line">kubectl attach -it tomcat-test -c debugger1</span><br></pre></td></tr></table></figure>
<h2 id="k3s"><a class="markdownIt-Anchor" href="#k3s">#</a> k3s</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">k3s是经过CNCF认证的由Rancher公司开发维护的一个轻量级的</span> <span class="string">Kubernetes</span> <span class="string">发行版，内核机制还是和</span> <span class="string">k8s</span> <span class="string">一样，但是剔除了很多外部依赖以及</span> <span class="string">K8s</span> <span class="string">的</span> <span class="string">alpha、beta</span> <span class="string">特性，同时改变了部署方式和运行方式，目的是轻量化</span> <span class="string">K8s，简单来说，K3s</span> <span class="string">就是阉割版</span> <span class="string">K8s，消耗资源极少。它主要用于边缘计算、物联网等场景。K3s</span> <span class="string">具有以下特点：</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">、安装简单，占用资源少，只需要512M内存就可以运行起来；</span></span><br><span class="line"><span class="number">2</span><span class="string">、apiserver</span> <span class="string">、schedule</span> <span class="string">等组件全部简化，并以进程的形式运行在节点上，把程序都打包为单个二进制文件，每个程序只需要占用100M内存；</span></span><br><span class="line"><span class="number">3</span><span class="string">、使用基于sqlite3的轻量级存储后端作为默认存储机制。同时支持使用etcd3、MySQL</span> <span class="string">和PostgreSQL作为存储机制；</span></span><br><span class="line"><span class="number">4</span><span class="string">、默认使用</span> <span class="string">local-path-provisioner</span> <span class="string">提供本地存储卷；</span></span><br><span class="line"><span class="number">5</span><span class="string">、默认安装了Helm</span> <span class="string">controller</span> <span class="string">和</span> <span class="string">Traefik</span> <span class="string">Ingress</span> <span class="string">controller；</span></span><br><span class="line"><span class="number">6</span><span class="string">、所有</span> <span class="string">Kubernetes</span> <span class="string">control-plane</span> <span class="string">组件的操作都封装在单个二进制文件和进程中，使</span> <span class="string">K3s</span> <span class="string">具有自动化和管理包括证书分发在内的复杂集群操作的能力。</span></span><br><span class="line"><span class="number">7</span><span class="string">、减少外部依赖，操作系统只需要安装较新的内核（centos7.6就可以，不需要升级内核）以及支持cgroup即可，k3s安装包已经包含了containerd、Flannel、CoreDNS，非常方便地一键式安装，不需要额外安装Docker、Flannel等组件。</span></span><br><span class="line"></span><br><span class="line"><span class="string">K3s</span> <span class="string">适用于以下场景：</span></span><br><span class="line"><span class="number">1</span><span class="string">、边缘计算-Edge</span></span><br><span class="line"><span class="number">2</span><span class="string">、物联网-IoT</span></span><br><span class="line"><span class="number">3</span><span class="string">、CI：持续集成</span></span><br><span class="line"><span class="number">4</span><span class="string">、Development：开发</span></span><br><span class="line"><span class="number">5</span><span class="string">、ARM</span></span><br><span class="line"><span class="number">6</span><span class="string">、嵌入</span> <span class="string">K8s</span></span><br><span class="line"></span><br><span class="line"><span class="string">由于运行</span> <span class="string">K3s</span> <span class="string">所需的资源相对较少，所以</span> <span class="string">K3s</span> <span class="string">也适用于开发和测试场景。在这些场景中，如果开发或测试人员需要对某些功能进行验证，或对某些问题进行重现，那么使用</span> <span class="string">K3s</span> <span class="string">不仅能够缩短启动集群的时间，还能够减少集群需要消耗的资源。与此同时，Rancher</span> <span class="string">中国团队推出了一款针对</span> <span class="string">K3s</span> <span class="string">的效率提升工具：AutoK3s。只需要输入一行命令，即可快速创建</span> <span class="string">K3s</span> <span class="string">集群并添加指定数量的</span> <span class="string">master</span> <span class="string">节点和</span> <span class="string">worker</span> <span class="string">节点。</span></span><br></pre></td></tr></table></figure>
<h3 id="k3s架构"><a class="markdownIt-Anchor" href="#k3s架构">#</a> k3s 架构</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230623175001742.png" alt="image-20230623175001742"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">k3s server节点是运行k3s server命令的机器（裸机或者虚拟机），而k3s Agent 节点是运行k3s agent命令的机器。</span><br><span class="line"></span><br><span class="line">单点架构只有一个控制节点（在 K3s 里叫做server node，相当于 K8s 的 master node），而且K3s的数据存储使用 sqlite 并内置在了控制节点上</span><br><span class="line"></span><br><span class="line">在这种配置中，每个 agent 节点都注册到同一个 server 节点。K3s 用户可以通过调用server节点上的K3s API来操作Kubernetes资源。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230623175156884.png" alt="image-20230623175156884"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">虽然单节点 k3s 集群可以满足各种用例，但对于 Kubernetes control-plane 的正常运行至关重要的环境，可以在高可用配置中运行 K3s。一个高可用 K3s 集群由以下几个部分组成：</span><br><span class="line"></span><br><span class="line">1、K3s Server 节点：两个或者更多的server节点将为 Kubernetes API 提供服务并运行其他 control-plane 服务</span><br><span class="line">2、外部数据库：外部数据存储（与单节点 k3s 设置中使用的嵌入式 SQLite 数据存储相反）</span><br><span class="line"></span><br><span class="line">k3s和k8s如何选择</span><br><span class="line">K8s和k3s各有优劣。若是你要进行大型的集群部署，建议你选择使用K8s；若是你处于边缘计算等小型部署的场景或仅仅须要部署一些非核心集群进行开发/测试，那么选择k3s则是性价比更高的选择。</span><br><span class="line"></span><br><span class="line">云计算场景用k8s</span><br><span class="line">边缘计算场景用k3s</span><br></pre></td></tr></table></figure>
<h3 id="安装k3s"><a class="markdownIt-Anchor" href="#安装k3s">#</a> 安装 k3s</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLmszcy5pby96aC9xdWljay1zdGFydA==">快速入门指南 | K3s</span></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">在192.168.40.180和192.168.40.181新机器初始化操作你们自己去做：</span></span><br><span class="line"><span class="string">参考安装k8s时候的初始化去做就可以了</span></span><br><span class="line"><span class="string">配置yum源</span></span><br><span class="line"><span class="string">关掉防火墙</span></span><br><span class="line"><span class="string">关掉selinux</span></span><br><span class="line"><span class="string">修改内核参数</span></span><br><span class="line"><span class="string">关掉swap交换分区</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">在192.168.40.180和192.168.40.181上安装containerd</span></span><br><span class="line"> [<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># yum install containerd -y</span></span><br><span class="line"><span class="string">启动containerd</span></span><br><span class="line">[<span class="string">root@localhost</span> <span class="string">~</span>]<span class="comment"># systemctl start containerd</span></span><br><span class="line"></span><br><span class="line"><span class="string">国内用户可以用如下方法：安装速度会更快</span></span><br><span class="line"><span class="string">在192.168.40.180上操作：</span></span><br><span class="line"><span class="comment">#执行如下命令安装：</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="string">-sfL</span> <span class="string">https://rancher-mirror.rancher.cn/k3s/k3s-install.sh</span> <span class="string">|</span> <span class="string">INSTALL_K3S_MIRROR=cn</span> <span class="string">sh</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="string">提取join</span> <span class="string">token</span></span><br><span class="line"><span class="string">我们想要添加一对worker节点。在这些节点上安装K3s，我们需要一个join</span> <span class="string">token。Join</span> <span class="string">token存在于master节点的文件系统上。让我们复制并将它保存在某个地方，稍后我们可以获取它：</span></span><br><span class="line"><span class="string">cat</span> <span class="string">/var/lib/rancher/k3s/server/node-token</span></span><br><span class="line"></span><br><span class="line"><span class="string">获取到一串token：</span></span><br><span class="line"><span class="string">K1048a0844cf602b7c96a4ea98a0a3531298e78262ba19875bd31a92ffc56686f63::server:698e6bc453d5871cbb1a4741387824b0</span></span><br><span class="line"></span><br><span class="line"><span class="string">在192.168.40.181上执行如下，把work节点加入k3s:</span></span><br><span class="line"><span class="string">curl</span> <span class="string">-sfL</span> <span class="string">http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span> <span class="string">|</span> <span class="string">INSTALL_K3S_MIRROR=cn</span> <span class="string">K3S_URL=https://192.168.40.186:6443</span> <span class="string">K3S_TOKEN=K105914c0b8bc0c8056a958ae90d0c2e5bf755d470cda85626aef879c8956ba95e4::server:bcdeca25ed8372d9f1bc983f0efb119e</span> <span class="string">sh</span> <span class="bullet">-</span></span><br><span class="line"></span><br><span class="line"><span class="string">验证work节点是否加入集群：</span></span><br><span class="line"><span class="string">在192.168.40.180操作：</span></span><br><span class="line"><span class="string">k3s</span> <span class="string">kubectl</span> <span class="string">get</span> <span class="string">nodes</span></span><br></pre></td></tr></table></figure>
<h2 id="openshift"><a class="markdownIt-Anchor" href="#openshift">#</a> openshift</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">OpenShift 是红帽 Red Hat 公司开源的平台，是平台即服务（PaaS），是一种容器应用平台。允许开发人员构建、测试和部署应用。在 OpenShift 上可以进行开发、测试、部署、运维全流程，实现高度的自动化，满足企业中的应用持续集成和交付及部署的需求，同时也满足企业对于容器管理（Docker）、容器编排（K8S）的需求。</span><br><span class="line">Openshift 是首个支持企业级 Java 的 PaaS 平台，支持 JEE6 与 JBoss 和其 Eclipse 集成开发环境以及 Maven 和 Jenkins 自动化。</span><br><span class="line">OpenShift通常被称为容器应用平台，因为它是一个用于开发和部署容器的平台。OpenShift底层以Docker作为容器引擎驱动，以K8s作为容器编排引擎组件，并提供了开发语言，中间件，DevOps自动化流程工具和web console用户界面等元素，提供了一套完整的基于容器的应用云平台。</span><br><span class="line"></span><br><span class="line">OpenShift功能</span><br><span class="line">容器引擎：docker；</span><br><span class="line">容器编排：kubernetes；</span><br><span class="line">应用开发框架及中间件：Java、Python、Tomcat、MySQL、PHP、Ruby、MongoDB和JBoss等中间件；</span><br><span class="line">应用及服务目录：用户可一键部署各类应用及服务；</span><br><span class="line">自动化流程及工具：内置自动化流程工具S2I（Source to Image），用户可完成代码编译、构建和镜像发布；</span><br><span class="line">软件定义网络：提供 OpenVSwitch，实现跨主机共享网络及多租户隔离网络模式；</span><br><span class="line">性能监控及日志管理：内置 Prometheus 监控功能，用户可以通过 Grafana 仪表板上实时显示应用；</span><br><span class="line">多用户接口：提供友好的 UI、命令行工具（oc，类似于 K8S 的 kubectl 以及 RESTful API，基本与 K8S 兼容）；</span><br><span class="line">自动化集群部署及管理：通过 Ansible 实现集群的自动化部署，为集群的自动化扩容提供接口。</span><br><span class="line"></span><br><span class="line">OpenShift 与 K8S的区别</span><br><span class="line">概念：OpenShift 是 PaaS（平台即服务），K8S 是 CaaS（容器即服务），OpenShift 内置了Kubernetes。OpenShift 底层以 Docker 作为容器引擎驱动，以 Kubernetes 作为容器编排引擎组件。</span><br><span class="line">部署：OpenShift 可以安装在 RHEL（Red Hat Enterprise Linux）和 RHELAH（Red Hat Eneterprise Linux Atomic Host）、CentOS 和 Fedora上；K8S 最好在 Unbuntu、Fedora、centos 和 Debian上运行，可部署在任何主要的 IaaS 上，如 IBM、AWS、Azure、GCP 和阿里云等云平台上。</span><br><span class="line">网络：OpenShift 提供了开箱即用的本机网络解决方案，即 OpenvSwitch，它提供三种不同的插件；K8S 没有本机网络解决方案，但提供可供第三方网络插件使用的接口。</span><br><span class="line"></span><br><span class="line">OpenShift 与 K8S相同点</span><br><span class="line">OpenShift 集成了原生的 K8S 作为容器编排组件，提供容器集群的管理，为业务应用可以提供：</span><br><span class="line">容器调度：根据业务的要求，快速部署容器到达指定的目标状态；</span><br><span class="line">弹性伸缩：应用可以快速的扩缩容pod的实例数量；</span><br><span class="line">异常修复：在容器实例发生异常时，集群可以自动发现问题、处理并恢复应用服务的状态；</span><br><span class="line">持久化卷：为集群中的不同机器上的容器提供持久化卷的对接功能；</span><br><span class="line">服务发现：可以提供负载均衡及服务发现功能；</span><br><span class="line">配置管理：为业务应用提供灵活的配置管理和分发规则。</span><br><span class="line"></span><br><span class="line">Openshift基础组件</span><br><span class="line">在OpenShift中，Kubernetes管理容器化应用程序，并为部署、维护和应用程序扩展提供机制。Kubernetes集群由一个或多个Master节点和一组Node节点组成。</span><br><span class="line">Master节点</span><br><span class="line">主控节点。包括API Server、Controller Manager Server和Etcd。主控节点管理其Kubernetes集群中的Node节点，并安排pod在这些节点上运行。</span><br><span class="line">Node节点</span><br><span class="line">Node节点为容器提供运行时环境。Kubernetes集群中的每个Node节点都有需要由Master节点管理的服务。该节点还具有运行pods所需的服务，包括容器运行时、kubelet和服务代理。</span><br><span class="line"></span><br><span class="line">openshift基本概念</span><br><span class="line">以下将提供有关使用OpenShift时将遇到的核心概念和对象的高级体系结构信息。其中许多对象来自Kubernetes, OpenShift对Kubernetes进行了扩展，以提供功能更丰富的开发生命周期平台。</span><br><span class="line">Project</span><br><span class="line">Project是一个带有附加注释的Kubernetes名称空间，是管理普通用户访问资源的中心媒介。用户必须由管理员提供相关的权限，或者如果允许创建项目，则自动访问自己的项目。</span><br><span class="line">Namespaces</span><br><span class="line">Kubernetes命名空间提供了一种用于划分集群中资源的机制。在OpenShift中，Project是带有附加注释的Kubernetes命名空间。</span><br><span class="line">Users</span><br><span class="line">与OpenShift交互的用户。OpenShift用户对象表示一个参与者，可以通过向其添加角色或向其组添加角色来授予该参与者在系统中的权限。</span><br><span class="line">Pod</span><br><span class="line">运行于Node节点上，若干相关容器的组合。Pod内包含的容器运行在同一宿主机上，使用相同的网络命名空间、IP地址和端口，能够通过localhost进行通信。Pod是Kurbernetes进行创建、调度和管理的最小单位，它提供了比容器更高层次的抽象，使得部署和管理更加灵活。一个Pod可以包含一个容器或者多个相关容器。</span><br><span class="line">Service</span><br><span class="line">Service定义了Pod的逻辑集合和访问该集合的策略，是真实服务的抽象。Service提供了一个统一的服务访问入口以及服务代理和发现机制，关联多个相同Label的Pod，用户不需要了解后台Pod是如何运行。</span><br><span class="line">Router</span><br><span class="line">Service提供了一个通往后端Pod集群的稳定入口，但是Service的IP地址只是集群内部的节点和容器可见。外部需通过Router（路由器）来转发。Router组件是Openshift集群中一个重要的组件，它是外界访问集群内容器应用的入口。用户可以创建Route（路由规则）对象，一个Route会与一个Service关联，并绑定一个域名。</span><br><span class="line">Persistent Storage</span><br><span class="line">容器默认是非持久化的，所有的修改在容器销毁时都会丢失。Docker提供了持久化卷挂载的能力，Openshift除了提供持久化卷挂载的能力，还提供了一种持久化供给模型即PV（Persistent Volume）和PVC（Persistent Volume Claim）。用户在部署应用时显示的声明对持久化的需求，创建PVC，在PVC中定义所需要的存储大小，访问方式。OpenShift集群会自动寻找符合要求的PV与PVC自动对接。</span><br><span class="line">Registry</span><br><span class="line">Openshift内部的镜像仓库，主要用于存放内置的S2I构建流程所产生的镜像。</span><br><span class="line">S2I</span><br><span class="line">Source to Image，负责将应用源码构建成镜像。</span><br></pre></td></tr></table></figure>
<h3 id="安装openshiftansible"><a class="markdownIt-Anchor" href="#安装openshiftansible">#</a> 安装 openshift&amp;ansible</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br></pre></td><td class="code"><pre><span class="line">安装ansible</span><br><span class="line">初始化</span><br><span class="line">1.1.12 修改网卡配置文件</span><br><span class="line">[root@master ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">最后追加如下内容：</span><br><span class="line">NM_CONTROLLED=yes</span><br><span class="line">修改好之后重启网络</span><br><span class="line">service network restart</span><br><span class="line"></span><br><span class="line">[root@node1~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">最后追加如下内容：</span><br><span class="line">NM_CONTROLLED=yes</span><br><span class="line">修改好之后重启网络</span><br><span class="line">service network restart</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class="line">最后追加如下内容：</span><br><span class="line">NM_CONTROLLED=yes</span><br><span class="line">修改好之后重启网络</span><br><span class="line">service network restart</span><br><span class="line"></span><br><span class="line">1.1.13 停掉NetworkManager</span><br><span class="line">[root@master ~]# systemctl stop NetworkManager</span><br><span class="line">[root@master ~]# systemctl disable NetworkManager</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# systemctl stop NetworkManager</span><br><span class="line">[root@node1 ~]# systemctl disable NetworkManager</span><br><span class="line"></span><br><span class="line">[root@node2 ~]# systemctl stop NetworkManager</span><br><span class="line">[root@node2 ~]# systemctl disable NetworkManager</span><br><span class="line"></span><br><span class="line">1.1.14 安装ansible</span><br><span class="line">把ansible-2.6.5-1.el7.ans.noarch.rpm上传到master、node1、node2上</span><br><span class="line">[root@master ~]#yum install ansible-2.6.5-1.el7.ans.noarch.rpm -y</span><br><span class="line">[root@node1~]#yum install ansible-2.6.5-1.el7.ans.noarch.rpm -y</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">把openshift-ansible-release-3.10.zip上传到master节点，手动解压：</span><br><span class="line">[root@master ~]#unzip openshift-ansible-release-3.10.zip</span><br><span class="line"></span><br><span class="line">1.2.2 安装和配置docker</span><br><span class="line">[root@master ~]#yum install -y docker-1.13.1</span><br><span class="line">[root@node1~]#yum install -y docker-1.13.1</span><br><span class="line"></span><br><span class="line">1）修改docker配置文件</span><br><span class="line">[root@master ~]# vim /etc/sysconfig/docker</span><br><span class="line">把之前的OPTIONS注释掉 </span><br><span class="line">#OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false&#x27;</span><br><span class="line">新增如下内容：</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled  --signature-verification=False&#x27;</span><br><span class="line"></span><br><span class="line">[root@node1~]# vim /etc/sysconfig/docker</span><br><span class="line">把之前的OPTIONS注释掉 </span><br><span class="line">#OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false&#x27;</span><br><span class="line">新增如下内容：</span><br><span class="line">OPTIONS=&#x27;--selinux-enabled  --signature-verification=False&#x27;</span><br><span class="line"></span><br><span class="line">2）配置docker镜像加速器</span><br><span class="line">[root@node1 ~]# systemctl start docker</span><br><span class="line">[root@node2 ~]# systemctl start docker</span><br><span class="line"></span><br><span class="line">[root@master ~]# cat /etc/docker/daemon.json </span><br><span class="line">&#123;&quot;registry-mirrors&quot;: [&quot;http://6e9e5b27.m.daocloud.io&quot;,&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">&quot;insecure-registries&quot;:[&quot;192.168.40.180:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node1 ~]# cat /etc/docker/daemon.json </span><br><span class="line">&#123;&quot;registry-mirrors&quot;: [&quot;http://6e9e5b27.m.daocloud.io&quot;,&quot;https://registry.docker-cn.com&quot;],</span><br><span class="line">&quot;insecure-registries&quot;:[&quot;192.168.40.180:5000&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">3）重启docker</span><br><span class="line">[root@master ~]# systemctl restart docker</span><br><span class="line">[root@node1~]# systemctl restart docker</span><br><span class="line"></span><br><span class="line">4）配置私有镜像仓库</span><br><span class="line">[root@master ~]# docker load -i registry.tar.gz</span><br><span class="line">[root@master ~]# yum install httpd -y</span><br><span class="line">[root@master ~]# systemctl start httpd</span><br><span class="line">[root@master ~]# systemctl enable httpd</span><br><span class="line">[root@master ~]# mkdir -p /opt/registry-var/auth/</span><br><span class="line">[root@master ~]#  docker run --entrypoint htpasswd registry:2.5 -Bbn xianchao xianchao  &gt;&gt; /opt/registry-var/auth/htpasswd</span><br><span class="line"></span><br><span class="line">设置配置文件</span><br><span class="line">[root@master ~]# mkdir -p /opt/registry-var/config</span><br><span class="line">[root@master ~]# vim /opt/registry-var/config/config.yml</span><br><span class="line">version: &quot;0.1&quot;</span><br><span class="line">log:</span><br><span class="line">  fields:</span><br><span class="line">    service: registry</span><br><span class="line">storage:</span><br><span class="line">  delete:</span><br><span class="line">    enabled: true</span><br><span class="line">  cache:</span><br><span class="line">    blobdescriptor: inmemory</span><br><span class="line">  filesystem:</span><br><span class="line">    rootdirectory: /var/lib/registry</span><br><span class="line">http:</span><br><span class="line">  addr: :5000</span><br><span class="line">  headers:</span><br><span class="line">    X-Content-Type-Options: [nosniff]</span><br><span class="line">health:</span><br><span class="line">  storagedriver:</span><br><span class="line">    enabled: true</span><br><span class="line">    interval: 10s</span><br><span class="line">threshold: 3</span><br><span class="line"></span><br><span class="line">启动服务</span><br><span class="line">docker run -d -p 5000:5000 --restart=always  --name=registry -v /opt/registry-var/config/:/etc/docker/registry/ -v /opt/registry-var/auth/:/auth/ -e &quot;REGISTRY_AUTH=htpasswd&quot;  -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd -v /opt/registry-var/:/var/lib/registry/ registry:2.5</span><br><span class="line"></span><br><span class="line">1.2.3 登录镜像仓库</span><br><span class="line">[root@master ~]#docker login 192.168.40.180:5000</span><br><span class="line">用户名：</span><br><span class="line">密码：  </span><br><span class="line"></span><br><span class="line">[root@node1~]#docker login 192.168.40.180:5000</span><br><span class="line">用户名：</span><br><span class="line">密码：  </span><br><span class="line"></span><br><span class="line">1.2.4 修改docker存储</span><br><span class="line">1）设置docker开机自启动</span><br><span class="line">systemctl enable docker</span><br><span class="line">systemctl is-active docker</span><br><span class="line">2）所有节点更改/etc/sysconfig/docker-storage-setup如下：</span><br><span class="line">DEVS=/dev/sdb </span><br><span class="line">VG=docker-vg</span><br><span class="line">3）所有Node节点执行docker-storage-setup</span><br><span class="line">docker-storage-setup </span><br><span class="line"></span><br><span class="line">1.2.5 解压镜像</span><br><span class="line">[root@node1 ~]# docker load -i openshift_slave_3_10.tar.gz</span><br><span class="line">[root@node2 ~]# docker load -i openshift_slave_3_10.tar.gz</span><br><span class="line"></span><br><span class="line">1.3、安装并访问openshift </span><br><span class="line"></span><br><span class="line">1.3.1 配置ansible的hosts文件</span><br><span class="line">[root@master ~]# cat /etc/ansible/hosts </span><br><span class="line">[OSEv3:children]</span><br><span class="line">masters</span><br><span class="line">nodes</span><br><span class="line">etcd</span><br><span class="line">[OSEv3:vars]</span><br><span class="line">openshift_deployment_type=origin</span><br><span class="line">ansible_ssh_user=root</span><br><span class="line">ansible_become=yes</span><br><span class="line">openshift_repos_enable_testing=true</span><br><span class="line">openshift_enable_service_catalog=false</span><br><span class="line">template_service_broker_install=false</span><br><span class="line">debug_level=4</span><br><span class="line">openshift_clock_enabled=true</span><br><span class="line">openshift_version=3.10.0 </span><br><span class="line">openshift_image_tag=v3.10</span><br><span class="line">openshift_disable_check=disk_availability,docker_storage,memory_availability,docker_image_availability,os_sdn_network_plugin_name=redhat/openshift-ovs-multitenant i</span><br><span class="line">openshift_master_identity_providers=[&#123;&#x27;name&#x27;: &#x27;htpasswd_auth&#x27;,&#x27;login&#x27;: &#x27;true&#x27;, &#x27;challenge&#x27;: &#x27;true&#x27;,&#x27;kind&#x27;: &#x27;HTPasswdPasswordIdentityProvider&#x27;&#125;]</span><br><span class="line">[masters]</span><br><span class="line">master</span><br><span class="line">[nodes]</span><br><span class="line">master openshift_node_group_name=&#x27;node-config-master&#x27;</span><br><span class="line">node1 openshift_node_group_name=&#x27;node-config-master&#x27; </span><br><span class="line">node2 openshift_node_group_name=&#x27;node-config-master&#x27;</span><br><span class="line">[etcd]</span><br><span class="line">master</span><br><span class="line">1.3.2 安装openshift</span><br><span class="line">1）安装前预配置检查</span><br><span class="line">[root@master ~]#ansible-playbook -i /etc/ansible/hosts openshift-ansible-release-3.10/playbooks/prerequisites.yml</span><br><span class="line"></span><br><span class="line">3）安装</span><br><span class="line">执行deploy时主机dns导致连外网失败（在执行上面deploy时，需要在每个节点ping www.baidu.com，如果ping不通，解决方案如下）</span><br><span class="line">临时解决方案更改/etc/resolv.conf</span><br><span class="line">当部署的时候看到retry，就需要在master和node节点执行下面命令，这样就可以继续ping通外网</span><br><span class="line">[root@master ~]#echo nameserver 8.8.8.8 &gt;&gt;/etc/resolv.conf</span><br><span class="line">可以写个计划任务：</span><br><span class="line">crontab -e</span><br><span class="line">* */1 * * * /usr/sbin/ntpdate   cn.pool.ntp.org</span><br><span class="line">* * * * * /usr/bin/echo  nameserver 8.8.8.8  &gt;&gt;/etc/resolv.conf</span><br><span class="line"></span><br><span class="line">[root@master ~]# ansible-playbook -i /etc/ansible/hosts openshift-ansible-release-3.10/playbooks/deploy_cluster.yml</span><br><span class="line"></span><br><span class="line">需要给节点打标签</span><br><span class="line">TASK [openshift_manage_node : Set node schedulability] 到这个task之后执行下面部分</span><br><span class="line">[root@master ~]#oc label node node1 node-role.kubernetes.io/infra=true</span><br></pre></td></tr></table></figure>
<h3 id="登录openshift"><a class="markdownIt-Anchor" href="#登录openshift">#</a> 登录 openshift</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">1.3.3 登录openshift</span><br><span class="line"></span><br><span class="line">首次新建用户密码</span><br><span class="line">htpasswd -cb /etc/origin/master/htpasswd admin admin</span><br><span class="line">添加用户密码</span><br><span class="line">htpasswd -b /etc/origin/master/htpasswd dev dev</span><br><span class="line">以集群管理员登录</span><br><span class="line">oc login -u system:admin</span><br><span class="line">给用户分配一个集群管理员角色</span><br><span class="line">oc adm policy add-cluster-role-to-user cluster-admin admin</span><br><span class="line">浏览器登录openshift，配置自己电脑hosts文件</span><br><span class="line"></span><br><span class="line">https://master:8443/console/catalog</span><br><span class="line"></span><br><span class="line">1.3.4 openshift内部私有仓库使用</span><br><span class="line">Master上执行如下，获取admin密码</span><br><span class="line">oc login -n openshift</span><br><span class="line">admin/admin</span><br><span class="line">oc whoami -t</span><br><span class="line">eYtOZNGab9w4IO_LX2sHEHyoAZHOy1oxJ9gEsuJVMpI</span><br><span class="line">每个节点执行如下登陆openshift私有镜像仓库    </span><br><span class="line">docker login docker-registry.default.svc:5000</span><br><span class="line">用户：admin</span><br><span class="line">密码：eYtOZNGab9w4IO_LX2sHEHyoAZHOy1oxJ9gEsuJVMpI</span><br></pre></td></tr></table></figure>
<h3 id="openshift-部署应用程序"><a class="markdownIt-Anchor" href="#openshift-部署应用程序">#</a> <strong>openshift</strong> <strong>部署应用程序</strong></h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">使用OpenShift时，可以通过多种方式添加应用程序。 主要方法是：</span><br><span class="line">1.通过已经存在的docker镜像部署应用程序</span><br><span class="line">2.使用Source-to-Image的方式部署应用程序（Source-to-Image简称S2I:从代码仓库拉取代码，构建成镜像，基于此镜像部署应用程序）</span><br><span class="line">3.在dockerfile中通过指定git仓库地址构建程序</span><br></pre></td></tr></table></figure>
<h3 id="openshift-cicd"><a class="markdownIt-Anchor" href="#openshift-cicd">#</a> openshift CICD</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">一、CI/CD工具链涉及到的组件介绍</span><br><span class="line">1、gogs：</span><br><span class="line">Gogs 是一款极易搭建的自助 Git 服务，类似于github这种代码托管系统；以最简便的方式搭建简单、稳定和可扩展的自助 Git 服务。使用 Go 语言开发使得 Gogs 能够通过独立的二进制分发，并且支持 Go 语言支持的 所有平台，包括 Linux、macOS、Windows 以及 ARM 平台。</span><br><span class="line">功能特性</span><br><span class="line"></span><br><span class="line">官方文档</span><br><span class="line">https://gogs.io/docs/intro</span><br><span class="line"></span><br><span class="line">github上的中文站点：</span><br><span class="line">https://github.com/gogs/gogs/blob/master/README_ZH.md</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2、nexus是一个私服</span><br><span class="line">为什么搭建nexus？</span><br><span class="line">为什么要搭建nexus私服，原因很简单，有些公司都不提供外网给项目组人员，因此就不能访问maven中央仓库，或者公司内部的jar包在外网无法找到，所以很有必要在局域网里使用一台有外网权限的机器，搭建nexus私服，然后开发人员连到这台私服上，这样的话就可以通过这台搭建了nexus私服的电脑访问maven的远程仓库，或者从上面下载内部jar包，使得开发人员可以下载仓库中的内容，而且对于下载过的文件，局域网内下载会更加快速。还有一点优势在于，我们需要的jar包可能在中央仓库中没有，需要去其他地方下载，有了中央仓库，只需要一人找到jar包其他人就不用再去上网搜索jar包，十分方便。</span><br><span class="line"></span><br><span class="line">3、sonarqube：</span><br><span class="line">代码扫描工具</span><br><span class="line"></span><br><span class="line">4、jenkins</span><br><span class="line"></span><br><span class="line">二、创建CI/CD流</span><br><span class="line"></span><br><span class="line">OpenShift DevOps/CICD工作流</span><br><span class="line"></span><br><span class="line">1.从gogs或者gitlab克隆代码</span><br><span class="line">2.通过maven构建war包</span><br><span class="line">3.单元测试</span><br><span class="line">4.Sonarqube静态代码扫描</span><br><span class="line">5.war包归档到Nexus</span><br><span class="line">6.构建docker image</span><br><span class="line">7.把镜像上传到harbor镜像仓库</span><br><span class="line">8.部署到dev（开发）环境</span><br><span class="line">9.部署到测试环境-集成测试</span><br><span class="line">10.管理员promote（同意） or abort（不同意）</span><br><span class="line">11.部署到stage（生产）环境</span><br><span class="line"></span><br><span class="line">官网地址：</span><br><span class="line">https://github.com/siamaksade/openshift-cd-demo/tree/origin-1.3</span><br></pre></td></tr></table></figure>
<h2 id="排错"><a class="markdownIt-Anchor" href="#排错">#</a> 排错</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、两台机器部署Keepalive出现双vip，如何排查？</span></span><br><span class="line"></span><br><span class="line"><span class="string">添加如下参数</span></span><br><span class="line"></span><br><span class="line"><span class="string">unicast_src_ip</span> <span class="number">192.168</span><span class="number">.0</span><span class="number">.29</span>         <span class="comment">##source ip</span></span><br><span class="line">    <span class="string">unicast_peer</span> &#123;</span><br><span class="line">          <span class="number">192.168</span><span class="number">.0</span><span class="number">.186</span>               <span class="comment">##dest ip</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628160651535.png" alt="image-20230628160651535"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">2.</span><span class="string">jenkins</span> <span class="string">一定要最新的</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">、kubeadm初始化k8s集群报错failed</span> <span class="string">to</span> <span class="string">parse</span> <span class="string">kernel</span> <span class="string">config：unable</span> <span class="string">to</span> <span class="string">load</span> <span class="string">kernel</span> <span class="string">module：”configs</span></span><br><span class="line"><span class="string">答：</span></span><br><span class="line"><span class="string">Kubeadm初始化k8s,会检测configs模块，configs模块现在centos操作系统不在维护了，可以忽略这个检查，那么kubeadm</span> <span class="string">初始化只需要加上参数--ignore-preflight-errors=SystemVerification即可</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.浏览器显示非私密连接</span></span><br><span class="line"><span class="string">在google浏览器中，在上图出现的页面任意位置，直接键盘敲入这11个字符：thisisunsafe，可以直接跳过安全报错进入页面</span></span><br><span class="line"></span><br><span class="line"><span class="number">5.</span><span class="string">centos8的yum源无法使用(dockerfile基于centos构建镜像报错Failed</span> <span class="string">to</span> <span class="string">download</span> <span class="string">metadata</span> <span class="string">for</span> <span class="string">repo</span> <span class="string">‘appstream’:</span> <span class="attr">Cannot prepare internal mirrorlist:</span> <span class="literal">No</span> <span class="string">URLs</span> <span class="string">in</span> <span class="string">mirrorlist)</span></span><br><span class="line"><span class="string">vim</span> <span class="string">Centos-vault-8.5.2111.repo</span></span><br><span class="line">[<span class="string">base</span>]</span><br><span class="line"><span class="string">name=CentOS-8.5.2111</span> <span class="bullet">-</span> <span class="string">Base</span> <span class="bullet">-</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#additional packages that may be useful</span></span><br><span class="line">[<span class="string">extras</span>]</span><br><span class="line"><span class="string">name=CentOS-8.5.2111</span> <span class="bullet">-</span> <span class="string">Extras</span> <span class="bullet">-</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#additional packages that extend functionality of existing packages</span></span><br><span class="line">[<span class="string">centosplus</span>]</span><br><span class="line"><span class="string">name=CentOS-8.5.2111</span> <span class="bullet">-</span> <span class="string">Plus</span> <span class="bullet">-</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class="line"> </span><br><span class="line">[<span class="string">PowerTools</span>]</span><br><span class="line"><span class="string">name=CentOS-8.5.2111</span> <span class="bullet">-</span> <span class="string">PowerTools</span> <span class="bullet">-</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">enabled=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[<span class="string">AppStream</span>]</span><br><span class="line"><span class="string">name=CentOS-8.5.2111</span> <span class="bullet">-</span> <span class="string">AppStream</span> <span class="bullet">-</span> <span class="string">mirrors.aliyun.com</span></span><br><span class="line"><span class="string">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class="line">        <span class="string">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class="line"><span class="string">gpgcheck=0</span></span><br><span class="line"><span class="string">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class="line"></span><br><span class="line"><span class="number">6</span><span class="string">.云主机安全组放行端口</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628161250017.png" alt="image-20230628161250017"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">删除kubeadm安装的k8s集群，重新搭建</span></span><br><span class="line"></span><br><span class="line"><span class="string">在k8s集群的每个节点执行kubeadm</span> <span class="string">reset即可，这个命令是重置k8s集群，会清空k8s所有组件和资源。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">7.</span><span class="string">yum</span> <span class="string">install</span> <span class="string">报错</span></span><br><span class="line"><span class="string">yum</span> <span class="string">clean</span> <span class="string">all</span></span><br><span class="line"><span class="string">yum</span> <span class="string">makecache</span> <span class="string">-y</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">epel-release</span> <span class="string">-y</span></span><br><span class="line"><span class="string">yum</span> <span class="string">update</span> <span class="string">-y</span></span><br><span class="line"></span><br><span class="line"><span class="number">8</span><span class="string">.删除k8s名称空间一直报错Terminating</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">namespace</span> <span class="string">app-team1</span> <span class="string">-o</span> <span class="string">json</span> <span class="string">&gt;</span> <span class="string">temp.json</span></span><br><span class="line"><span class="string">修改temp.json文件</span></span><br><span class="line"><span class="string">删除框住的部分</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628161656494.png" alt="image-20230628161656494"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">再开启一个新的终端执行如下：</span><br><span class="line">root@master1:~# kubectl proxy</span><br><span class="line"></span><br><span class="line">另一个终端执行如下：</span><br><span class="line">root@master1:~# curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @temp.json http://127.0.0.1:8001/api/v1/namespaces/app-team1/finalize</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">11、基于kubectl run busybox2 --image busybox:1.28 --restart=Never --rm -it busybox – sh 创建的pod，无法ping www.baidu.com</span><br><span class="line">首先把安装k8s的所有机器重启，然后重新创建pod，如果重启之后还是ping不通www.baidu.com，可以按照如下方法解决：</span><br><span class="line">进入pod</span><br><span class="line">打开/etc/resolv.conf，最后添加nameserver 8.8.8.8</span><br><span class="line">在search这增加域名www.baidu.com即可</span><br><span class="line"></span><br><span class="line">12.containerd如果作为容器运行时，用ctr拉取镜像，需要写镜像完成的路径才可以</span><br><span class="line">ctr images pull docker.io/library/busybox:1.28</span><br></pre></td></tr></table></figure>
<h3 id="pod"><a class="markdownIt-Anchor" href="#pod">#</a> pod</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">部分工作节点上的pod一直处于ContainerCreating的状态</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span>  <span class="string">-o</span> <span class="string">wide</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">tomcat</span> </span><br><span class="line"></span><br><span class="line"><span class="string">NAME</span>         <span class="string">READY</span>     <span class="string">STATUS</span>               <span class="string">RESTARTS</span>    <span class="string">AGE</span>     <span class="string">IP</span>             <span class="string">NODE</span></span><br><span class="line"><span class="string">tomcat-pod</span>     <span class="number">0</span><span class="string">/1</span>       <span class="string">ContainerCreating</span>     <span class="number">0</span>         <span class="string">106s</span>    <span class="number">10.244</span><span class="number">.1</span><span class="number">.4</span>     <span class="string">k8s-node1</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">pods</span> <span class="string">tomcat-pod</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">一、pending状态</span></span><br><span class="line"><span class="string">Pending是挂起状态：表示创建的Pod找不到可以运行它的物理节点，不能调度到相应的节点上运行，那么这种情况如何去排查呢？我门可以从两个层面分析问题：</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.物理节点层面分析：</span></span><br><span class="line"><span class="number">1</span><span class="string">）查看节点资源使用情况：如free</span> <span class="string">-m查看内存、top查看CPU使用率、df</span> <span class="string">–h查看磁盘使用情况，这样就可以快速定位节点资源情况，判断是不是节点有问题</span></span><br><span class="line"><span class="number">2</span><span class="string">）查看节点污点：kubectl</span> <span class="string">describe</span> <span class="string">nodes</span>  <span class="string">master1（控制节点名字），如果节点定义了污点，那么Pod不能容忍污点，就会导致调度失败，如下：</span></span><br><span class="line"><span class="attr">Taints:</span>    <span class="string">node-role.kubernetes.io/master:NoSchedule</span></span><br><span class="line"><span class="string">这个看到的是控制节点的污点，表示不允许Pod调度（如果Pod定义容忍度，则可以实现调度）</span></span><br><span class="line"></span><br><span class="line"><span class="number">2.</span><span class="string">Pod本身分析</span></span><br><span class="line"><span class="number">1</span><span class="string">）在定义pod时，如果指定了nodeName是不存在的，那也会调度失败</span></span><br><span class="line"><span class="number">2</span><span class="string">）在定义Pod时，如果定义的资源请求比较大，导致物理节点资源不够</span></span><br><span class="line"><span class="string">如何排查，可按如下分析：</span></span><br><span class="line"><span class="number">3</span><span class="string">）在定于pod时，如果制定了node节点应亲和性或者nodeselector，那么没有满足的条件，也会pending状态</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">二、ImagePullBackOff状态</span></span><br><span class="line"><span class="string">问题分析：</span></span><br><span class="line"><span class="string">拉取镜像时间长导致超时：</span></span><br><span class="line"><span class="string">配置的镜像有错误：如镜像名字不存在等</span></span><br><span class="line"><span class="string">配置的镜像无法访问：如网络限制无法访问hub上的镜像</span></span><br><span class="line"><span class="string">配置的私有镜像仓库参数错误：如imagePullSecret没有配置或者配置错误</span></span><br><span class="line"><span class="string">dockerfile打包的镜像不可用</span></span><br><span class="line"><span class="string">排查思路：</span></span><br><span class="line"><span class="comment">#查看Pod</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pods</span> <span class="string">-o</span> <span class="string">wide</span></span><br><span class="line"><span class="string">显示如下：</span></span><br><span class="line"><span class="string">tomcat-pod</span>     <span class="number">0</span><span class="string">/1</span>     <span class="string">ImagePullBackOff</span>   <span class="number">0</span>          <span class="string">105s</span></span><br><span class="line"><span class="string">通过上面可以看到镜像拉取有问题，那可以进一步再排查错误</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">describe</span> <span class="string">pods</span> <span class="string">tomcat-pod</span></span><br><span class="line"><span class="string">显示如下：</span></span><br><span class="line"><span class="string">Normal</span>   <span class="string">BackOff</span>    <span class="string">96s</span> <span class="string">(x7</span> <span class="string">over</span> <span class="string">6m15s)</span>    <span class="string">kubelet</span>            <span class="string">Back-off</span> <span class="string">pulling</span> <span class="string">image</span> <span class="string">&quot;atomcat:8.5-jre8-alpine&quot;</span></span><br><span class="line"><span class="string">可以在宿主机通过docker</span> <span class="string">pull手动验证是否可以正常拉取镜像</span></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">atomcat:8.5-jre8-alpine</span></span><br><span class="line"><span class="string">报错：</span></span><br><span class="line"><span class="attr">Error response from daemon:</span> <span class="string">pull</span> <span class="string">access</span> <span class="string">denied</span> <span class="string">for</span> <span class="string">atomcat,</span> <span class="string">repository</span> <span class="string">does</span> <span class="string">not</span> <span class="string">exist</span> <span class="string">or</span> <span class="string">may</span> <span class="string">require</span> <span class="attr">&#x27;docker login&#x27;:</span> <span class="attr">denied:</span> <span class="string">requested</span> <span class="string">access</span> <span class="string">to</span> <span class="string">the</span> <span class="string">resource</span> <span class="string">is</span> <span class="string">denied</span></span><br><span class="line"><span class="string">那就说明我们使用的镜像有问题，需要重新更改镜像地址</span></span><br><span class="line"></span><br><span class="line"><span class="string">三、CrashLoopBackOff状态</span></span><br><span class="line"><span class="string">K8s中的pod正常运行，但是里面的容器可能退出或者多次重启或者准备删除，导致出现这个状态，这个状态具有偶发性，可能上一秒还是running状态，但是突然就变成CrashLoopBackOff状态了。</span></span><br><span class="line"><span class="number">1</span><span class="string">）kubectl</span> <span class="string">logs</span> <span class="string">查看日志，出现如下：</span></span><br><span class="line"><span class="attr">standard_init_linux.go:216:</span> <span class="string">exec</span> <span class="string">user</span> <span class="string">process</span> <span class="string">caused</span> <span class="string">&quot;exec format error“</span></span><br><span class="line"><span class="string">解决方案：</span></span><br><span class="line"><span class="string">查看构建镜像用的代码是否有问题，如果代码没问题，再看环境变量是否有问题，可能权限问题：假如pod挂载了数据目录，这个数据目录，我们需要修改属主和属组，否则pod往这个目录写数据，可能没权限</span></span><br><span class="line"><span class="string">2）kubectl describe pods 查看详细信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">四、Evicted状态</span></span><br><span class="line"><span class="string">这个Evicted表示pod所在节点的资源不够了，pod被驱逐走了</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">五、Complete状态</span></span><br><span class="line"><span class="string">这个状态表示pod里面的任务完成了，job或者cronjob创建pod的时候，如果pod任务完成了，会出现这个complete状态</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">六、error状态</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">15、pod健康探测</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">pod定义的存活性探测如下：</span></span><br><span class="line"><span class="string">livenessProbe:</span></span><br><span class="line"><span class="string">       httpGet:</span></span><br><span class="line"><span class="string">         path: /</span></span><br><span class="line"><span class="string">         port: 8080</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">常见错误：</span></span><br><span class="line"><span class="string">Killing container with id docker://:Container failed probe.. Container will be killed and recreated. Liveness</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">如果在pod启动时遇到这种情况，一般是没有设置 initialDelaySeconds导致的</span></span><br><span class="line"><span class="string"># 设置初始化延迟initialDelaySeconds。</span></span><br><span class="line"><span class="string">livenessProbe:</span></span><br><span class="line"><span class="string">       httpGet:</span></span><br><span class="line"><span class="string">         path: /</span></span><br><span class="line"><span class="string">         port: 8080</span></span><br><span class="line"><span class="string">       initialDelaySeconds: 15 # pod启动过15s开始探测</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">15、pod服务超时</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">K8S中Pod服务连接超时主要分以下几种情况：</span></span><br><span class="line"><span class="string">1.Pod和Pod连接超时</span></span><br><span class="line"><span class="string">2.Pod和虚拟主机上的服务连接超时</span></span><br><span class="line"><span class="string">3.Pod和云主机连接超时</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">针对上面几种问题，排查思路可按下面方法：</span></span><br><span class="line"><span class="string">网络插件层面：</span></span><br><span class="line"><span class="string">查看calico或者flannel是否是running状态，查看日志提取重要信息</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Pod层面：</span></span><br><span class="line"><span class="string">检查Pod网络，测试Pod是否可以ping通同网段其他pod ip</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">物理机层面：</span></span><br><span class="line"><span class="string">检查物理机网络，测试ping www.baidu.com，ping其他的pod ip</span></span><br><span class="line"><span class="string">可以抓包测试有无异常</span></span><br><span class="line"><span class="string">通过抓包修改内核参数</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">16、service代理pod出现问题</span></span><br><span class="line"><span class="string">直接访问pod可以请求到，但是访问pod前端service，通过请求pod有问题，请求不到。</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">iptables： 重启iptables，重启iptables不可以，重启下机器</span></span><br><span class="line"><span class="string">ipvs：重启机器</span></span><br></pre></td></tr></table></figure>
<h2 id="tekton"><a class="markdownIt-Anchor" href="#tekton">#</a> Tekton</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">Tekton</span> <span class="string">是一个功能强大且灵活的</span> <span class="string">Kubernetes</span> <span class="string">原生开源框架，是谷歌开源的，功能强大且灵活，开源社区也正在快速的迭代和发展壮大，主要用于创建持续集成和交付（CI/CD）系统。通过抽象底层实现细节，用户可以跨多云平台和本地系统进行构建、测试和部署。另外，基于kubernetes</span> <span class="string">CRD定义的pipeline流水线也是Tekton最重要的特征。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">CRD全称是CustomResourceDefinition：</span></span><br><span class="line"><span class="string">在</span> <span class="string">Kubernetes</span> <span class="string">中一切都可视为资源，Kubernetes</span> <span class="number">1.7</span> <span class="string">之后增加了对</span> <span class="string">CRD</span> <span class="string">自定义资源二次开发能力来扩展</span> <span class="string">Kubernetes</span> <span class="string">API，通过</span> <span class="string">CRD</span> <span class="string">我们可以向</span> <span class="string">Kubernetes</span> <span class="string">API</span> <span class="string">中增加新资源类型，而不需要修改</span> <span class="string">Kubernetes</span> <span class="string">源码来创建自定义的</span> <span class="string">API</span> <span class="string">server，该功能大大提高了</span> <span class="string">Kubernetes</span> <span class="string">的扩展能力。当你创建一个新的CustomResourceDefinition</span> <span class="string">(CRD)时，Kubernetes</span> <span class="string">API服务器将为你指定的每个版本创建一个新的RESTful资源路径，我们可以根据该api路径来创建一些我们自己定义的类型资源。CRD可以是命名空间的，也可以是集群范围的，由CRD的作用域(scpoe)字段中所指定的，与现有的内置对象一样，删除名称空间将删除该名称空间中的所有自定义对象。customresourcedefinition本身没有名称空间，所有名称空间都可以使用。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">持续集成是云原生应用的支柱技术之一，因此在交付基于云原生的一些支撑产品的时候，CICD</span> <span class="string">是非常好的方案。为了满足这种需要，自然而然会想到对Jenkins(X)或者</span> <span class="string">Gitlab</span> <span class="string">进行集成，也有创业公司出来的一些小工具比如</span> <span class="string">Argo</span> <span class="string">Rollout。Tekton</span> <span class="string">是一款</span> <span class="string">k8s</span> <span class="string">原生的应用发布框架，主要用来构建</span> <span class="string">CI/CD</span> <span class="string">系统。它原本是</span> <span class="string">knative</span> <span class="string">项目里面一个叫做</span> <span class="string">build-pipeline</span> <span class="string">的子项目，用来作为</span> <span class="string">knative-build</span> <span class="string">的下一代引擎。然而，随着</span> <span class="string">k8s</span> <span class="string">社区里各种各样的需求涌入，这个子项目慢慢成长为一个通用的框架，能够提供灵活强大的能力去做基于</span> <span class="string">k8s</span> <span class="string">的构建发布。Tekton</span> <span class="string">其实只提供</span> <span class="string">Pipeline</span> <span class="string">这个一个功能，Pipeline</span> <span class="string">会被直接映射成</span> <span class="string">K8s</span> <span class="string">Pod</span> <span class="string">等</span> <span class="string">API</span> <span class="string">资源。而比如应用发布过程的控制，灰度和上线策略，都是我们自己编写</span> <span class="string">K8s</span> <span class="string">Controller来实现的，也就意味着</span> <span class="string">Tekton</span> <span class="string">不会在K8s</span> <span class="string">上盖一个”大帽子“，比如我们想看发布状态、日志等是直接通过</span> <span class="string">K8s</span> <span class="string">查看这个</span> <span class="string">Pipeline</span> <span class="string">对应的</span> <span class="string">Pod</span> <span class="string">的状态和日志，不需要再面对另外一个</span> <span class="string">API。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">Tekton功能：</span></span><br><span class="line"><span class="number">1.</span><span class="string">Kubernetes原生的Tekton的所有配置都是使用CRD方式进行编写存储的，非常易于检索和使用。</span></span><br><span class="line"><span class="number">2</span><span class="string">.配置和流程分离：</span> <span class="string">Tekton的Pipeline和配置可以分开编写，使用名称进行引用。</span></span><br><span class="line"><span class="number">3</span><span class="string">.轻量级核心的Pipeline</span> <span class="string">非常轻便：适合作为组件进行集成，另外也有周边的</span> <span class="string">Dashboard、Trigger、CLI等工具，能够进一步挖掘其潜力。</span></span><br><span class="line"><span class="number">4</span><span class="string">.可复用、组合的</span> <span class="string">Pipeline</span> <span class="string">构建方式：非常适合在集成过程中对Pipeline进行定制。</span></span><br><span class="line"></span><br><span class="line"><span class="string">这里的流程大致是：</span></span><br><span class="line"><span class="number">1</span><span class="string">、用户把需要部署的应用先按照一套标准的应用定义写成</span> <span class="string">YAML</span> <span class="string">文件（类似</span> <span class="string">Helm</span> <span class="string">Chart）；</span></span><br><span class="line"><span class="number">2</span><span class="string">、用户把应用定义</span> <span class="string">YAML</span> <span class="string">推送到</span> <span class="string">Git</span> <span class="string">仓库里；</span></span><br><span class="line"><span class="number">3</span><span class="string">、Tekton</span> <span class="string">CD</span> <span class="string">(一个</span> <span class="string">K8s</span> <span class="string">Operator)</span> <span class="string">会监听到相应的改动，根据不同条件生成不同的</span> <span class="string">Tekton</span> <span class="string">Pipelines；</span></span><br><span class="line"><span class="string">Tekton</span> <span class="string">CD</span> <span class="string">的操作具体分为以下几种情况：</span></span><br><span class="line"><span class="number">1</span><span class="string">、如果</span> <span class="string">Git</span> <span class="string">改动里有一个应用</span> <span class="string">YAML</span> <span class="string">且该应用不存在，那么将渲染和生成</span> <span class="string">Tekton</span> <span class="string">Pipelines</span> <span class="string">用来创建应用。</span></span><br><span class="line"><span class="number">2</span><span class="string">、如果</span> <span class="string">Git</span> <span class="string">改动里有一个应用</span> <span class="string">YAML</span> <span class="string">且该应用存在，那么将渲染和生成</span> <span class="string">Tekton</span> <span class="string">Pipelines</span> <span class="string">用来升级应用。这里我们会根据应用定义</span> <span class="string">YAML</span> <span class="string">里的策略来做升级，比如做金丝雀发布、灰度升级。</span></span><br><span class="line"><span class="number">3</span><span class="string">、如果</span> <span class="string">Git</span> <span class="string">改动里有一个应用</span> <span class="string">YAML</span> <span class="string">且该应用存在且标记了“被删除”，那么将渲染和生成</span> <span class="string">Tekton</span> <span class="string">Pipelines</span> <span class="string">用来删除应用。确认应用被删除后，我们才从</span> <span class="string">Git</span> <span class="string">里删除这个应用的</span> <span class="string">YAML。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">安装Tekton</span></span><br><span class="line"><span class="comment">#把tekton-0-12-0.tar.gz和busybox-v-1-0.tar.gz上传到node1机器上，手动解压：</span></span><br><span class="line">[<span class="string">root@node1</span>]<span class="comment"># docker load -i tekton-0-12-0.tar.gz</span></span><br><span class="line">[<span class="string">root@node1</span>]<span class="comment"># docker load -i busybox-v-1-0.tar.gz</span></span><br><span class="line">[<span class="string">root@node2</span>]<span class="comment"># docker load -i tekton-0-12-0.tar.gz</span></span><br><span class="line">[<span class="string">root@node2</span>]<span class="comment"># docker load -i busybox-v-1-0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#编写安装tekton资源清单文件</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f release.yaml</span></span><br><span class="line"><span class="comment">#验证pod是否创建成功</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -n tekton-pipelines</span></span><br><span class="line"><span class="string">NAME</span>                                          <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">tekton-pipelines-controller-d64889fb9-9b68f</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>              <span class="string">52s</span></span><br><span class="line"><span class="string">tekton-pipelines-webhook-7c8664944c-ctsgf</span>     <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>            <span class="string">52s</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get crd</span></span><br><span class="line"><span class="string">找到下面这些东西，说明创建crd成功了：</span></span><br><span class="line"><span class="string">pipelineresources.tekton.dev</span>                          <span class="number">2021-08-21T13:52:16Z</span></span><br><span class="line"><span class="string">pipelineruns.tekton.dev</span>                               <span class="number">2021-08-21T13:52:16Z</span></span><br><span class="line"><span class="string">pipelines.tekton.dev</span>                                  <span class="number">2021-08-21T13:52:16Z</span></span><br><span class="line"><span class="string">taskruns.tekton.dev</span>                                   <span class="number">2021-08-21T13:52:16Z</span></span><br><span class="line"><span class="string">tasks.tekton.dev</span>                                      <span class="number">2021-08-21T13:52:16Z</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl api-versions</span></span><br><span class="line"><span class="string">看到下面说明apiversion创建成功了</span></span><br><span class="line"><span class="string">tekton.dev/v1alpha1</span></span><br><span class="line"><span class="string">tekton.dev/v1beta1</span></span><br><span class="line"></span><br><span class="line"><span class="string">Tekton概念</span></span><br><span class="line"><span class="string">Tekton</span> <span class="string">为Kubernetes</span> <span class="string">提供了多种</span> <span class="string">CRD</span> <span class="string">资源对象，可用于定义我们的流水线，主要有以下几个CRD资源对象：</span></span><br><span class="line"><span class="number">1</span><span class="string">）Task：表示执行命令的一系列步骤，task</span> <span class="string">里可以定义一系列的</span> <span class="string">steps，例如编译代码、构建镜像、推送镜像等，每个</span> <span class="string">step</span> <span class="string">实际由一个</span> <span class="string">Pod</span> <span class="string">里的容器执行。</span></span><br><span class="line"><span class="number">2</span><span class="string">）TaskRun：task只是定义了一个模版，taskRun</span> <span class="string">才真正代表了一次实际的运行，当然你也可以自己手动创建一个taskRun，taskRun创建出来之后，就会自动触发task描述的构建任务。</span></span><br><span class="line"><span class="number">3</span><span class="string">）Pipeline：一组任务，表示一个或多个task、PipelineResource</span> <span class="string">以及各种定义参数的集合。</span></span><br><span class="line"><span class="number">4</span><span class="string">）PipelineRun：类似task和taskRun的关系，pipelineRun也表示某一次实际运行的</span> <span class="string">pipeline，下发一个</span> <span class="string">pipelineRun</span> <span class="string">CRD</span> <span class="string">实例到</span> <span class="string">Kubernetes后，同样也会触发一次</span> <span class="string">pipeline</span> <span class="string">的构建。</span></span><br><span class="line"><span class="number">5</span><span class="string">）PipelineResource：表示pipeline输入资源，比如github上的源码，或者pipeline</span> <span class="string">输出资源，例如一个容器镜像或者构建生成的jar包等。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">我们测试一个简单的golang程序。应用程序代码，测试及dockerfile文件可在如下地址获取：https://github.com/luckylucky421/tekton-demo</span></span><br><span class="line"></span><br><span class="line"><span class="number">3.8</span><span class="number">.1</span>  <span class="string">clone应用程序代码进行测试，创建一个task任务</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat task-test.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Task</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">steps:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">run-test</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">golang:1.14-alpine</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">workingDir:</span> <span class="string">/workspace/repo</span></span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;go&quot;</span>]</span><br><span class="line">    <span class="attr">args:</span> [<span class="string">&quot;test&quot;</span>]</span><br><span class="line"><span class="comment">#更新资源清单文件</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f task-test.yaml </span></span><br><span class="line"><span class="string">task.tekton.dev/test</span> <span class="string">created</span></span><br><span class="line"><span class="comment">#查看Task资源</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get Task</span></span><br><span class="line"><span class="string">NAME</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">test</span>   <span class="string">23s</span></span><br><span class="line"></span><br><span class="line"><span class="string">resources定义了我们的任务中定义的步骤中需要输入的内容，这里我们的步骤需要</span> <span class="string">Clone</span> <span class="string">一个</span> <span class="string">Git</span> <span class="string">仓库作为</span> <span class="string">go</span> <span class="string">test</span> <span class="string">命令的输入。Tekton</span> <span class="string">内置了一种</span> <span class="string">git</span> <span class="string">资源类型，它会自动将代码仓库</span> <span class="string">Clone</span> <span class="string">到</span> <span class="string">/workspace/$input_name</span> <span class="string">目录中，由于我们这里输入被命名成</span> <span class="string">repo，所以代码会被</span> <span class="string">Clone</span> <span class="string">到</span> <span class="string">/workspace/repo</span> <span class="string">目录下面。然后下面的</span> <span class="string">steps</span> <span class="string">就是来定义执行运行测试命令的步骤，这里我们直接在代码的根目录中运行</span> <span class="string">go</span> <span class="string">test</span> <span class="string">命令即可，需要注意的是命令和参数需要分别定义。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">创建pipelineresource资源对象</span></span><br><span class="line"><span class="string">通过上面步骤我们定义了一个</span> <span class="string">Task</span> <span class="string">任务，但是该任务并不会立即执行，我们必须创建一个</span> <span class="string">TaskRun</span> <span class="string">引用它并提供所有必需输入的数据才行。这里我们就需要将</span> <span class="string">git</span> <span class="string">代码库作为输入，我们必须先创建一个</span> <span class="string">PipelineResource</span> <span class="string">对象来定义输入信息，创建一个名为</span> <span class="string">pipelineresource.yaml</span> <span class="string">的资源清单文件，内容如下所示：</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat pipelineresource.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1alpha1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PipelineResource</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">-tekton-example</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">git</span></span><br><span class="line">  <span class="attr">params:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">url</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">https://github.com/luckylucky421/tekton-demo</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">revision</span></span><br><span class="line">      <span class="attr">value:</span> <span class="string">master</span></span><br><span class="line"><span class="comment">#更新资源清单文件</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f pipelineresource.yaml </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="string">创建taskrun任务</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat taskrun.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">tekton.dev/v1beta1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">TaskRun</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testrun</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">taskRef:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">test</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">inputs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">repo</span></span><br><span class="line">      <span class="attr">resourceRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">-tekton-example</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#更新资源清单文件</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f taskrun.yaml </span></span><br><span class="line"><span class="comment">#上面资源清单文件解释说明</span></span><br><span class="line"><span class="string">这里通过taskRef引用上面定义的Task和git仓库作为输入，resourceRef也是引用上面定义的PipelineResource资源对象。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建后，我们可以通过查看TaskRun资源对象的状态来查看构建状态</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get taskrun</span></span><br><span class="line"><span class="string">NAME</span>      <span class="string">SUCCEEDED</span>   <span class="string">REASON</span>    <span class="string">STARTTIME</span></span><br><span class="line"><span class="string">testrun</span>      <span class="string">Unknown</span>     <span class="string">Running</span>    <span class="string">6s</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">testrun-pod-x9rkn</span>   <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">9s</span></span><br><span class="line"><span class="string">当任务执行完成后，</span> <span class="string">Pod</span> <span class="string">就会变成</span> <span class="string">Completed</span> <span class="string">状态了：</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl get pods</span></span><br><span class="line"><span class="string">NAME</span>                <span class="string">READY</span>   <span class="string">STATUS</span>      <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">testrun-pod-x9rkn</span>   <span class="number">0</span><span class="string">/2</span>     <span class="string">Completed</span>       <span class="number">0</span>          <span class="string">72s</span></span><br></pre></td></tr></table></figure>
<h2 id="创建自定义资源"><a class="markdownIt-Anchor" href="#创建自定义资源">#</a> 创建自定义资源</h2>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apiextensions.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CustomResourceDefinition</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">crontabs.stable.example.com</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">group:</span> <span class="string">stable.example.com</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">schema:</span></span><br><span class="line">        <span class="attr">openAPIV3Schema:</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">          <span class="attr">properties:</span></span><br><span class="line">            <span class="attr">spec:</span></span><br><span class="line">              <span class="attr">type:</span> <span class="string">object</span></span><br><span class="line">              <span class="attr">properties:</span></span><br><span class="line">                <span class="attr">cronSpec:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">image:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">string</span></span><br><span class="line">                <span class="attr">replicas:</span></span><br><span class="line">                  <span class="attr">type:</span> <span class="string">integer</span></span><br><span class="line">  <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line">  <span class="attr">names:</span></span><br><span class="line">    <span class="attr">plural:</span> <span class="string">crontabs</span></span><br><span class="line">    <span class="attr">singular:</span> <span class="string">crontab</span></span><br><span class="line">    <span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ct</span></span><br><span class="line">    </span><br><span class="line"><span class="string">Yaml文件注解：</span></span><br><span class="line"><span class="string">metadata.name</span> <span class="string">是用户自定义资源中自己自定义的一个名字。一般我们建议使用“顶级域名.xxx.APIGroup”这样的格式，名称必须与下面的spec.Group字段匹配，格式为:</span> <span class="string">&lt;plural&gt;.&lt;group&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="string">spec</span> <span class="string">用于指定该</span> <span class="string">CRD</span> <span class="string">的</span> <span class="string">group、version。比如在创建</span> <span class="string">Pod</span> <span class="string">或者</span> <span class="string">Deployment</span> <span class="string">时，它的</span> <span class="string">group</span> <span class="string">可能为</span> <span class="string">apps/v1</span> <span class="string">或者</span> <span class="string">apps/v1beta1</span> <span class="string">之类，这里我们也同样需要去定义</span> <span class="string">CRD</span> <span class="string">的</span> <span class="string">group。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">group:</span> <span class="string">stable.example.com</span> <span class="comment">#组名称</span></span><br><span class="line">  <span class="attr">versions:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">v1</span></span><br><span class="line">      <span class="comment">#指定组下的版本</span></span><br><span class="line"></span><br><span class="line"><span class="attr">served:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#每个版本都可以通过服务标志启用/禁用</span></span><br><span class="line"><span class="attr">storage:</span> <span class="literal">true</span></span><br><span class="line"><span class="comment">#必须将一个且只有一个版本标记为存储版本。</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">scope:</span> <span class="string">Namespaced</span></span><br><span class="line"><span class="comment">#指定crd资源作用范围在命名空间或集群</span></span><br><span class="line"></span><br><span class="line"><span class="string">names</span> <span class="string">指的是它的</span> <span class="string">kind</span> <span class="string">是什么，比如</span> <span class="string">Deployment</span> <span class="string">的</span> <span class="string">kind</span> <span class="string">就是</span> <span class="string">Deployment，Pod</span> <span class="string">的</span> <span class="string">kind</span> <span class="string">就是</span> <span class="string">Pod，这里的</span> <span class="string">kind</span> <span class="string">被定义为了CronTab</span></span><br><span class="line"></span><br><span class="line"><span class="string">plural</span> <span class="string">字段就是一个昵称，比如当一些字段或者一些资源的名字比较长时，可以用该字段自定义一些昵称来简化它的长度；</span></span><br><span class="line"></span><br><span class="line"> <span class="attr">singular:</span> <span class="string">crontab</span></span><br><span class="line"><span class="comment"># 在CLI(shell界面输入的参数)上用作别名并用于显示的单数名称</span></span><br><span class="line"></span><br><span class="line">    <span class="attr">shortNames:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ct</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 短名称允许短字符串匹配CLI上的资源，就是能通过kubectl 在查看资源的时候使用该资源的简名称来获取。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 创建资源</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">&quot;stable.example.com/v1&quot;</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">CronTab</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">my-new-cron-object</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">cronSpec:</span> <span class="string">&quot;* * * * * *&quot;</span></span><br><span class="line">  <span class="attr">image:</span> <span class="string">busybox</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、项目地址</span></span><br><span class="line"><span class="string">https://github.com/mongodb/mongodb-kubernetes-operator.git</span></span><br><span class="line"></span><br><span class="line"><span class="string">把课件里的压缩包传到k8s控制节点上来，手动解压</span></span><br><span class="line"><span class="string">unzip</span> <span class="string">mongodb-kubernetes-operator-0.5.0.zip</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">、创建名称空间mongodb，并进入到mongodb-kubernetes-operator目录应用crd资源，创建自定义资源类型</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>] <span class="string">kubectl</span> <span class="string">create</span> <span class="string">ns</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cd mongodb-kubernetes-operator-0.5.0</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># kubectl apply -f deploy/crds/mongodb.com_mongodbcommunity_crd.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看mongodb是否创建成功</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">crd/mongodbcommunity.mongodb.com</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">、安装operator</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># kubectl apply -f deploy/operator/ -n mongodb</span></span><br><span class="line"></span><br><span class="line"><span class="string">提示：mongodb-kubernetes-operator这个项目是将自定义控制器和自定义资源类型分开实现的；其operator只负责创建和监听对应资源类型的变化，在资源有变化时，实例化为对应资源对象，并保持对应资源对象状态吻合用户期望状态；上述四个清单中主要是创建了一个sa账户，并对对应的sa用户授权；</span></span><br><span class="line"></span><br><span class="line"><span class="string">验证：查看operator是否正常运行</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># kubectl get pods -n mongodb</span></span><br><span class="line"><span class="string">NAME</span>                                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">mongodb-kubernetes-operator-7f8c55db45-tmpk5</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">44s</span></span><br><span class="line"></span><br><span class="line"><span class="string">验证：使用自定义资源类型创建一个mongodb</span> <span class="string">副本集集群</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># cat deploy/crds/mongodb.com_v1_mongodbcommunity_cr.yaml</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># kubectl apply -f deploy/crds/mongodb.com_v1_mongodbcommunity_cr.yaml -n mongodb</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">mongodb-kubernetes-operator-0.5.0</span>]<span class="comment"># kubectl get pods -n mongodb</span></span><br><span class="line"><span class="string">NAME</span>                                           <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">example-mongodb-0</span>                              <span class="number">0</span><span class="string">/2</span>     <span class="string">Pending</span>   <span class="number">0</span>          <span class="string">66s</span></span><br><span class="line"></span><br><span class="line"><span class="string">提示：这里可以看到对应pod处于pending状态；</span></span><br><span class="line">　　<span class="string">查看pod详细信息</span></span><br><span class="line">　　</span><br><span class="line">　<span class="string">提示：这里提示没有可以用的pvc；</span></span><br><span class="line">　　<span class="string">删除mongodb名称空间下pvc</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">get</span> <span class="string">pvc</span> <span class="string">-n</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pvc</span> <span class="string">--all</span> <span class="string">-n</span> <span class="string">mongodb</span></span><br><span class="line"></span><br><span class="line">　<span class="string">创建pv和pvc</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat pv-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-v1</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-mongodb-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadOnlyMany&quot;</span>]</span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/p1</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-v2</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-mongodb-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadOnlyMany&quot;</span>]</span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/p2</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.180</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="meta"> </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-pv-v3</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">example-mongodb-svc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">accessModes:</span> [<span class="string">&quot;ReadWriteOnce&quot;</span>,<span class="string">&quot;ReadWriteMany&quot;</span>,<span class="string">&quot;ReadOnlyMany&quot;</span>]</span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Retain</span></span><br><span class="line">  <span class="attr">mountOptions:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">hard</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">nfsvers=4.1</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/p3</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.180</span></span><br><span class="line">    </span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># mkdir /data/p1</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># mkdir /data/p2</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># mkdir /data/p3</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat /etc/exports</span></span><br><span class="line"><span class="string">/data/v1</span>  <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/p1</span>  <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/p2</span>  <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/p3</span>  <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># exportfs -arv</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f pv-demo.yaml</span></span><br><span class="line"></span><br><span class="line"><span class="string">创建pvc资源</span></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># cat pvc-demo.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">data-volume-example-mongodb-0</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">data-volume-example-mongodb-1</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500Mi</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">data-volume-example-mongodb-2</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">mongodb</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">500M</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1</span> <span class="string">~</span>]<span class="comment"># kubectl apply -f pvc-demo.yaml</span></span><br><span class="line">[<span class="string">root@master01</span> <span class="string">~</span>]<span class="comment"># kubectl get pods -n mongodb </span></span><br><span class="line"><span class="string">NAME</span>                                                 <span class="string">READY</span>   <span class="string">STATUS</span>    <span class="string">RESTARTS</span>   <span class="string">AGE</span></span><br><span class="line"><span class="string">example-mongodb-0</span>                              <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">8m</span></span><br><span class="line"><span class="string">example-mongodb-1</span>                              <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">111s</span></span><br><span class="line"><span class="string">example-mongodb-2</span>                              <span class="number">2</span><span class="string">/2</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">48s</span></span><br><span class="line"><span class="string">mongodb-kubernetes-operator-7d557bcc95-th8js</span>   <span class="number">1</span><span class="string">/1</span>     <span class="string">Running</span>   <span class="number">0</span>          <span class="string">9m19s</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"><i class="ic i-tag"></i> 运维</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-01-02 22:55:50" itemprop="dateModified" datetime="2024-01-02T22:55:50+08:00">2024-01-02</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" title="k8s高级">http://example.com/2023/06/02/k8s高级/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/05/30/jenkins/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;46d0371c19c0586fb0629e97bac23133.jpg" title="Jenkins">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>Jenkins</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/07/15/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;0a30d7eca259366c104d2fbfe515dc0e.jpg" title="中间件漏洞">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>中间件漏洞</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E9%AB%98%E7%BA%A7"><span class="toc-number">1.</span> <span class="toc-text"> k8s 高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> 环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prometheus"><span class="toc-number">1.2.</span> <span class="toc-text"> Prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 组件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus%E5%92%8Czabbix%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.3.</span> <span class="toc-text"> Prometheus 和 Zabbix 对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 部署模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-exporter"><span class="toc-number">1.2.6.</span> <span class="toc-text"> node-exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2prothemeus"><span class="toc-number">1.2.7.</span> <span class="toc-text"> 部署 Prothemeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prothemeus%E7%83%AD%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.2.8.</span> <span class="toc-text"> Prothemeus 热加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grafana"><span class="toc-number">1.2.9.</span> <span class="toc-text"> Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85grafana"><span class="toc-number">1.2.10.</span> <span class="toc-text"> 安装 Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-metric"><span class="toc-number">1.2.11.</span> <span class="toc-text"> kube-metric</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alert-manager"><span class="toc-number">1.3.</span> <span class="toc-text"> alert manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E5%88%B0qq%E9%82%AE%E7%AE%B1"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 报警到 qq 邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promql"><span class="toc-number">1.3.2.</span> <span class="toc-text"> PromQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7tomcat"><span class="toc-number">1.3.3.</span> <span class="toc-text"> prometheus 监控 tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7-redis"><span class="toc-number">1.3.4.</span> <span class="toc-text"> prometheus 监控 redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7mysql"><span class="toc-number">1.3.5.</span> <span class="toc-text"> prometheus 监控 mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prothemeus%E7%9B%91%E6%8E%A7nginx"><span class="toc-number">1.3.6.</span> <span class="toc-text"> Prothemeus 监控 nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7-mongodb"><span class="toc-number">1.3.7.</span> <span class="toc-text"> prometheus 监控 mongodb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pushgateway"><span class="toc-number">1.3.8.</span> <span class="toc-text"> pushgateway</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elk"><span class="toc-number">1.4.</span> <span class="toc-text"> ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#efk%E7%BB%84%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text"> efk 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85elasticsearch"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 安装 elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95pod"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 测试 pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ceph"><span class="toc-number">1.5.</span> <span class="toc-text"> ceph</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E6%8C%82%E8%BD%BDceph-rbd"><span class="toc-number">1.5.1.</span> <span class="toc-text"> k8s 挂载 ceph rbd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ceph-rbd%E7%94%9F%E6%88%90pv"><span class="toc-number">1.5.2.</span> <span class="toc-text"> ceph rbd 生成 pv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Estorage%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90pv"><span class="toc-number">1.5.3.</span> <span class="toc-text"> 基于 storage 动态生成 pv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E5%AF%B9%E6%8E%A5cephfs"><span class="toc-number">1.5.4.</span> <span class="toc-text"> k8s 对接 cephfs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#devops"><span class="toc-number">1.6.</span> <span class="toc-text"> devops</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#istio"><span class="toc-number">1.7.</span> <span class="toc-text"> istio</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%B6%E6%9E%84"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#istio%E7%9A%84%E6%A0%B8%E5%BF%83%E6%8E%A7%E4%BB%B6"><span class="toc-number">1.7.2.</span> <span class="toc-text"> Istio 的核心控件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E5%AE%89%E8%A3%85istio"><span class="toc-number">1.7.3.</span> <span class="toc-text"> k8s 安装 istio</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#istio%E6%A0%B8%E5%BF%83%E8%B5%84%E6%BA%90"><span class="toc-number">1.7.4.</span> <span class="toc-text"> istio 核心资源</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#helm"><span class="toc-number">1.8.</span> <span class="toc-text"> helm</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rancher"><span class="toc-number">1.9.</span> <span class="toc-text"> Rancher</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%A1%E7%90%86%E5%B7%B2%E6%9C%89%E9%9B%86%E7%BE%A4"><span class="toc-number">1.9.1.</span> <span class="toc-text"> 管理已有集群</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%85k8s"><span class="toc-number">1.10.</span> <span class="toc-text"> 二进制安装 k8s</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="toc-number">1.10.1.</span> <span class="toc-text"> 初始化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85etcd%E9%9B%86%E7%BE%A4"><span class="toc-number">1.10.2.</span> <span class="toc-text"> 安装 etcd 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kubernetes%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.</span> <span class="toc-text"> 安装 kubernetes 组件</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2apiserver%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.1.</span> <span class="toc-text"> 部署 apiserver 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubectl%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.2.</span> <span class="toc-text"> 部署 kubectl 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAkube-controller-manager%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.3.</span> <span class="toc-text"> 创建 kube-controller-manager 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%9B%E5%BB%BAkube-scheduler%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.4.</span> <span class="toc-text"> 创建 kube-scheduler 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kubelet%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.5.</span> <span class="toc-text"> 部署 kubelet 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kube-proxy%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.6.</span> <span class="toc-text"> 部署 kube-proxy 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2calico%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.7.</span> <span class="toc-text"> 部署 calico 组件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2coredns%E7%BB%84%E4%BB%B6"><span class="toc-number">1.10.3.8.</span> <span class="toc-text"> 部署 coredns 组件</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E9%9B%86%E7%BE%A4%E7%8A%B6%E6%80%81"><span class="toc-number">1.10.4.</span> <span class="toc-text"> 查看集群状态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#keepalivednginx%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8"><span class="toc-number">1.10.5.</span> <span class="toc-text"> keepalived+nginx 实现高可用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ackcce"><span class="toc-number">1.11.</span> <span class="toc-text"> ACK&amp;&amp;CCE</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Ehpa%E5%92%8Cvpa%E5%AE%9E%E7%8E%B0pod%E8%87%AA%E5%8A%A8%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="toc-number">1.12.</span> <span class="toc-text"> 基于 HPA 和 VPA 实现 Pod 自动扩缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E4%B8%AD%E8%87%AA%E5%8A%A8%E4%BC%B8%E7%BC%A9%E7%9A%84%E6%96%B9%E6%A1%88"><span class="toc-number">1.12.1.</span> <span class="toc-text"> k8s 中自动伸缩的方案</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hpa"><span class="toc-number">1.12.1.1.</span> <span class="toc-text"> HPA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#kpa"><span class="toc-number">1.12.1.2.</span> <span class="toc-text"> KPA</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#vpa"><span class="toc-number">1.12.1.3.</span> <span class="toc-text"> VPA</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metrics-server"><span class="toc-number">1.12.2.</span> <span class="toc-text"> metrics-server</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-apache-%E5%88%A9%E7%94%A8hpa%E6%89%A9%E7%BC%A9%E5%AE%B9"><span class="toc-number">1.12.3.</span> <span class="toc-text"> php-apache 利用 hpa 扩缩容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vpa-2"><span class="toc-number">1.12.4.</span> <span class="toc-text"> VPA</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kubernetes-cluster-autoscaler"><span class="toc-number">1.12.5.</span> <span class="toc-text"> kubernetes cluster-autoscaler</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#python-%E8%B0%83%E7%94%A8k8s-api"><span class="toc-number">1.13.</span> <span class="toc-text"> python 调用 k8s api</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ephemeral"><span class="toc-number">1.14.</span> <span class="toc-text"> ephemeral</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#k3s"><span class="toc-number">1.15.</span> <span class="toc-text"> k3s</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#k3s%E6%9E%B6%E6%9E%84"><span class="toc-number">1.15.1.</span> <span class="toc-text"> k3s 架构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85k3s"><span class="toc-number">1.15.2.</span> <span class="toc-text"> 安装 k3s</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#openshift"><span class="toc-number">1.16.</span> <span class="toc-text"> openshift</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85openshiftansible"><span class="toc-number">1.16.1.</span> <span class="toc-text"> 安装 openshift&amp;ansible</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%99%BB%E5%BD%95openshift"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 登录 openshift</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openshift-%E9%83%A8%E7%BD%B2%E5%BA%94%E7%94%A8%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.16.3.</span> <span class="toc-text"> openshift 部署应用程序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#openshift-cicd"><span class="toc-number">1.16.4.</span> <span class="toc-text"> openshift CICD</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%8E%92%E9%94%99"><span class="toc-number">1.17.</span> <span class="toc-text"> 排错</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pod"><span class="toc-number">1.17.1.</span> <span class="toc-text"> pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tekton"><span class="toc-number">1.18.</span> <span class="toc-text"> Tekton</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%9B%E5%BB%BA%E8%87%AA%E5%AE%9A%E4%B9%89%E8%B5%84%E6%BA%90"><span class="toc-number">1.19.</span> <span class="toc-text"> 创建自定义资源</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2023/04/03/iptables2/" rel="bookmark" title="iptables">iptables</a></li><li><a href="/2023/04/05/Docker/" rel="bookmark" title="docker">docker</a></li><li><a href="/2023/04/15/Nginx_new/" rel="bookmark" title="Nginx">Nginx</a></li><li><a href="/2023/05/20/Kubernetes/" rel="bookmark" title="Kubernetes">Kubernetes</a></li><li><a href="/2023/05/30/jenkins/" rel="bookmark" title="Jenkins">Jenkins</a></li><li class="active"><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" rel="bookmark" title="k8s高级">k8s高级</a></li><li><a href="/2024/01/01/istio/" rel="bookmark" title="istio">istio</a></li><li><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="bookmark" title="集群与存储">集群与存储</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">42</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/05/30/jenkins/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/07/15/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/02/28/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/09/15/%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93/" title="缓存污染&#x2F;请求走私">缓存污染/请求走私</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" title="k8s高级">k8s高级</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" title="集群与存储">集群与存储</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="秋招总结">秋招总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2022/11/27/CDN/" title="CDN&amp;DNS">CDN&DNS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/07/15/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" title="中间件漏洞">中间件漏洞</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/05/Docker/" title="docker">docker</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/03/hg%20ker/" title="hg内核">hg内核</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/06/02/k8s高级/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
