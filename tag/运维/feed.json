{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"运维\" tag",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2024/01/01/istio/",
            "url": "http://example.com/2024/01/01/istio/",
            "title": "istio",
            "date_published": "2024-01-01T05:38:45.000Z",
            "content_html": "<p><strong>更新中</strong></p>\n<h1 id=\"istio\"><a class=\"markdownIt-Anchor\" href=\"#istio\">#</a> istio</h1>\n<h2 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 安装istio命令行工具</span><br><span class=\"line\">curl -L https://istio.io/downloadIstio | sh -</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">PATH=$PATH:/root/istio/bin</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# cp tools/istioctl.bash ~/.istioctl.bash </span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# source ~/.istioctl.bash </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# ls </span><br><span class=\"line\">bin  LICENSE  manifests  manifest.yaml  README.md  samples  tools</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# istioctl version </span><br><span class=\"line\">client version: 1.20.1</span><br><span class=\"line\">control plane version: 1.20.1</span><br><span class=\"line\">data plane version: 1.20.1 (8 proxies)</span><br><span class=\"line\"></span><br><span class=\"line\">// 安装istio</span><br><span class=\"line\">istioctl manifest apply --set profile=demo</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# istioctl profile list </span><br><span class=\"line\">Istio configuration profiles:</span><br><span class=\"line\">    ambient</span><br><span class=\"line\">    default</span><br><span class=\"line\">    demo</span><br><span class=\"line\">    empty</span><br><span class=\"line\">    external</span><br><span class=\"line\">    minimal</span><br><span class=\"line\">    openshift</span><br><span class=\"line\">    preview</span><br><span class=\"line\">    remote</span><br><span class=\"line\">    </span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# kubectl get all -n istio-system </span><br><span class=\"line\">NAME                                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod/grafana-8cb9f8f79-9fr74                1/1     Running   0          28h</span><br><span class=\"line\">pod/istio-egressgateway-8649fd8848-9hvp4   1/1     Running   0          2d6h</span><br><span class=\"line\">pod/istio-ingressgateway-9b58f8c86-hk4fx   1/1     Running   0          2d6h</span><br><span class=\"line\">pod/istiod-755784476f-lxnw2                1/1     Running   0          2d6h</span><br><span class=\"line\">pod/jaeger-7cc9dd4499-hwsd9                1/1     Running   0          28h</span><br><span class=\"line\">pod/kiali-6d5f569c67-s222f                 1/1     Running   0          28h</span><br><span class=\"line\">pod/prometheus-85674d4cb8-rqnlc            2/2     Running   0          28h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                           TYPE           CLUSTER-IP        EXTERNAL-IP      PORT(S)                           AGE</span><br><span class=\"line\">service/grafana                ClusterIP      192.168.57.247    &lt;none&gt;           3000/TCP                                                 </span><br><span class=\"line\">service/istio-egressgateway    ClusterIP      192.168.74.170    &lt;none&gt;           80/TCP,443/TCP                                           </span><br><span class=\"line\">service/istio-ingressgateway   LoadBalancer   192.168.126.220   101.132.74.102   15021:30190/TCP,80:30304/TCP,443:31928/TCP,31400:31218/TCP,15443:30438/TCP   2d6h</span><br><span class=\"line\">service/istiod                 ClusterIP      192.168.72.13     &lt;none&gt;           15010/TCP,15012/TCP,443/TCP,15014/TCP                   </span><br><span class=\"line\">service/jaeger-collector       ClusterIP      192.168.94.27     &lt;none&gt;           14268/TCP,14250/TCP,9411/TCP,4317/TCP,4318/TCP           </span><br><span class=\"line\">service/kiali                  ClusterIP      192.168.80.120    &lt;none&gt;           20001/TCP,9090/TCP                                       </span><br><span class=\"line\">service/loki-headless          ClusterIP      None              &lt;none&gt;           3100/TCP                                                 </span><br><span class=\"line\">service/prometheus             ClusterIP      192.168.226.115   &lt;none&gt;           9090/TCP                                                 </span><br><span class=\"line\">service/tracing                ClusterIP      192.168.218.160   &lt;none&gt;           80/TCP,16685/TCP                                         </span><br><span class=\"line\">service/zipkin                 ClusterIP      192.168.16.18     &lt;none&gt;           9411/TCP                                                 </span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                   READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">deployment.apps/grafana                1/1     1            1           28h</span><br><span class=\"line\">deployment.apps/istio-egressgateway    1/1     1            1           2d6h</span><br><span class=\"line\">deployment.apps/istio-ingressgateway   1/1     1            1           2d6h</span><br><span class=\"line\">deployment.apps/istiod                 1/1     1            1           2d6h</span><br><span class=\"line\">deployment.apps/jaeger                 1/1     1            1           28h</span><br><span class=\"line\">deployment.apps/kiali                  1/1     1            1           28h</span><br><span class=\"line\">deployment.apps/prometheus             1/1     1            1           28h</span><br><span class=\"line\"></span><br><span class=\"line\">NAME                                             DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">replicaset.apps/grafana-8cb9f8f79                1         1         1       28h</span><br><span class=\"line\">replicaset.apps/istio-egressgateway-8649fd8848   1         1         1       2d6h</span><br><span class=\"line\">replicaset.apps/istio-ingressgateway-9b58f8c86   1         1         1       2d6h</span><br><span class=\"line\">replicaset.apps/istiod-755784476f                1         1         1       2d6h</span><br><span class=\"line\">replicaset.apps/jaeger-7cc9dd4499                1         1         1       28h</span><br><span class=\"line\">replicaset.apps/kiali-6d5f569c67                 1         1         1       28h</span><br><span class=\"line\">replicaset.apps/prometheus-85674d4cb8            1         1         1       28h</span><br><span class=\"line\"></span><br><span class=\"line\">// 卸载demo</span><br><span class=\"line\">istioctl manifest generate --set profile=demo | kubectl delete -f -</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# istioctl version </span><br><span class=\"line\">client version: 1.20.1</span><br><span class=\"line\">control plane version: 1.20.1</span><br><span class=\"line\">data plane version: 1.20.1 (8 proxies)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z istio-1.20.1]# istioctl analyze -n default </span><br><span class=\"line\">✔ No validation issues found when analyzing namespace: default.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 操作profile</span><br><span class=\"line\">istioctl profile list</span><br><span class=\"line\">istioctl profile dump demo &gt; 1.yaml </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231227225342706.png\" alt=\"image-20231227225342706\"></p>\n<p>kiali</p>\n<p>在部署 demo 这个 profile 之后，默认就会有这个 pod 和 svc，把 svc 改成 nodeport，访问 http://ip:Port</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231227224013433.png\" alt=\"image-20231227224013433\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231227230645389.png\" alt=\"image-20231227230645389\"></p>\n<h2 id=\"inject\"><a class=\"markdownIt-Anchor\" href=\"#inject\">#</a> inject</h2>\n<p>istio 注入</p>\n<p>注入后在 pod 内生成 Net 和 Window</p>\n<p>service，secret，configmap 被注入后不会多出容器</p>\n<p>注入时新生成一个被注入的资源，在杀掉原来的资源</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// 部署一个deployment，创建nginx</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-deployment</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 3</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: nginx</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: nginx</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: nginx</span><br><span class=\"line\">        image: nginx:latest</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 80</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231228170839584.png\" alt=\"image-20231228170839584\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">istioctl kube-inject -f 111.yaml | kubectl apply -f - </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231228170907079.png\" alt=\"image-20231228170907079\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231228171034981.png\" alt=\"image-20231228171034981\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@iZuf60im9c63xjnpkubjq7Z</span> <span class=\"string\">inject</span>]<span class=\"comment\"># istioctl kube-inject -f inject.yaml  &gt; nginx.yaml </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-deployment</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span> &#123;&#125;</span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">annotations:</span></span><br><span class=\"line\">        <span class=\"attr\">istio.io/rev:</span> <span class=\"string\">default</span></span><br><span class=\"line\">        <span class=\"attr\">kubectl.kubernetes.io/default-container:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">kubectl.kubernetes.io/default-logs-container:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">prometheus.io/path:</span> <span class=\"string\">/stats/prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">prometheus.io/port:</span> <span class=\"string\">&quot;15020&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">prometheus.io/scrape:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">sidecar.istio.io/status:</span> <span class=\"string\">&#x27;&#123;&quot;initContainers&quot;:[&quot;istio-init&quot;],&quot;containers&quot;:[&quot;istio-proxy&quot;],&quot;volumes&quot;:[&quot;workload-socket&quot;,&quot;credential-socket&quot;,&quot;workload-certs&quot;,&quot;istio-envoy&quot;,&quot;istio-data&quot;,&quot;istio-podinfo&quot;,&quot;istio-token&quot;,&quot;istiod-ca-cert&quot;],&quot;imagePullSecrets&quot;:null,&quot;revision&quot;:&quot;default&quot;&#125;&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">security.istio.io/tlsMode:</span> <span class=\"string\">istio</span></span><br><span class=\"line\">        <span class=\"attr\">service.istio.io/canonical-name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">service.istio.io/canonical-revision:</span> <span class=\"string\">latest</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx:latest</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span> &#123;&#125;</span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">proxy</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">sidecar</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--domain</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">$(POD_NAMESPACE).svc.cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--proxyLogLevel=warning</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--proxyComponentLogLevel=misc:error</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--log_output_level=default:info</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">JWT_POLICY</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">third-party-jwt</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PILOT_CERT_PROVIDER</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">istiod</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">CA_ADDR</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">istiod.istio-system.svc:15012</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">INSTANCE_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.podIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">SERVICE_ACCOUNT</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">spec.serviceAccountName</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">HOST_IP</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">status.hostIP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_CPU_LIMIT</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">resourceFieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">divisor:</span> <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">              <span class=\"attr\">resource:</span> <span class=\"string\">limits.cpu</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROXY_CONFIG</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">            &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\"></span>        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_POD_PORTS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">|-</span></span><br><span class=\"line\"><span class=\"string\">            [</span></span><br><span class=\"line\"><span class=\"string\">                &#123;&quot;containerPort&quot;:80&#125;</span></span><br><span class=\"line\"><span class=\"string\">            ]</span></span><br><span class=\"line\"><span class=\"string\"></span>        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_APP_CONTAINERS</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">GOMEMLIMIT</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">resourceFieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">divisor:</span> <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">              <span class=\"attr\">resource:</span> <span class=\"string\">limits.memory</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">GOMAXPROCS</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">resourceFieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">divisor:</span> <span class=\"string\">&quot;0&quot;</span></span><br><span class=\"line\">              <span class=\"attr\">resource:</span> <span class=\"string\">limits.cpu</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_CLUSTER_ID</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">Kubernetes</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_NODE_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">            <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">spec.nodeName</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_INTERCEPTION_MODE</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">REDIRECT</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ISTIO_META_MESH_ID</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">cluster.local</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">TRUST_DOMAIN</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">cluster.local</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker.io/istio/proxyv2:1.20.1</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istio-proxy</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">15090</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">http-envoy-prom</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">4</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/healthz/ready</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">15021</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">10m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">40Mi</span></span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">allowPrivilegeEscalation:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">            <span class=\"attr\">drop:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">ALL</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">readOnlyRootFilesystem:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">runAsGroup:</span> <span class=\"number\">1337</span></span><br><span class=\"line\">          <span class=\"attr\">runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">runAsUser:</span> <span class=\"number\">1337</span></span><br><span class=\"line\">        <span class=\"attr\">startupProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">600</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/healthz/ready</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">15021</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">3</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/workload-spiffe-uds</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">workload-socket</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/credential-uds</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">credential-socket</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/workload-spiffe-credentials</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">workload-certs</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/istio</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istiod-ca-cert</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/istio/data</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istio-data</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/istio/proxy</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istio-envoy</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/tokens</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istio-token</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/istio/pod</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istio-podinfo</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">istio-iptables</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-p</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;15001&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-z</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;15006&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-u</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;1337&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-m</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">REDIRECT</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-i</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;*&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-x</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-b</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;*&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">-d</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"number\">15090</span><span class=\"string\">,15021,15020</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--log_output_level=default:info</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker.io/istio/proxyv2:1.20.1</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istio-init</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">10m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">40Mi</span></span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">allowPrivilegeEscalation:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">            <span class=\"attr\">add:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">NET_ADMIN</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">NET_RAW</span></span><br><span class=\"line\">            <span class=\"attr\">drop:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">ALL</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">readOnlyRootFilesystem:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">runAsGroup:</span> <span class=\"number\">0</span></span><br><span class=\"line\">          <span class=\"attr\">runAsNonRoot:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">          <span class=\"attr\">runAsUser:</span> <span class=\"number\">0</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">workload-socket</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">credential-socket</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">workload-certs</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">emptyDir:</span></span><br><span class=\"line\">          <span class=\"attr\">medium:</span> <span class=\"string\">Memory</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istio-envoy</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istio-data</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">downwardAPI:</span></span><br><span class=\"line\">          <span class=\"attr\">items:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.labels</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">labels</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.annotations</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">annotations</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istio-podinfo</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">istio-token</span></span><br><span class=\"line\">        <span class=\"attr\">projected:</span></span><br><span class=\"line\">          <span class=\"attr\">sources:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">serviceAccountToken:</span></span><br><span class=\"line\">              <span class=\"attr\">audience:</span> <span class=\"string\">istio-ca</span></span><br><span class=\"line\">              <span class=\"attr\">expirationSeconds:</span> <span class=\"number\">43200</span></span><br><span class=\"line\">              <span class=\"attr\">path:</span> <span class=\"string\">istio-token</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">istio-ca-root-cert</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">istiod-ca-cert</span></span><br><span class=\"line\"><span class=\"attr\">status:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231228171604818.png\" alt=\"image-20231228171604818\"></p>\n<p>istio-init 初始化网络命名空间</p>\n<p>注入后所有的容器都在同一个 ns 中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z inject]# kubectl exec -it nginx-deployment-846d79d-77zhs -c nginx -- bash </span><br><span class=\"line\">root@nginx-deployment-846d79d-77zhs:/# hostname  -i </span><br><span class=\"line\">2408:4002:1038:9800:dea9:b421:34bb:25a0 10.0.0.240</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z inject]# kubectl exec -it nginx-deployment-846d79d-77zhs -c istio-proxy -- bash </span><br><span class=\"line\">istio-proxy@nginx-deployment-846d79d-77zhs:/$ hostname -i </span><br><span class=\"line\">2408:4002:1038:9800:dea9:b421:34bb:25a0 10.0.0.240</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z inject]# kubectl exec -it nginx-deployment-846d79d-77zhs -c istio-proxy -- bash  </span><br><span class=\"line\">istio-proxy@nginx-deployment-846d79d-77zhs:/$ netstat -lntup </span><br><span class=\"line\">Active Internet connections (only servers)</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15021           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15021           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 127.0.0.1:15000         0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15001           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15001           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 127.0.0.1:15004         0.0.0.0:*               LISTEN      1/pilot-agent       </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15006           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15006           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp6       0      0 :::15020                :::*                    LISTEN      1/pilot-agent       </span><br><span class=\"line\">tcp6       0      0 :::80                   :::*                    LISTEN      -      </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf60im9c63xjnpkubjq7Z inject]# kubectl logs -f nginx-deployment-846d79d-77zhs -c istio-init </span><br><span class=\"line\">2023-12-28T09:08:49.813711Z     info    Istio iptables environment:</span><br><span class=\"line\">ENVOY_PORT=</span><br><span class=\"line\">INBOUND_CAPTURE_PORT=</span><br><span class=\"line\">ISTIO_INBOUND_INTERCEPTION_MODE=</span><br><span class=\"line\">ISTIO_INBOUND_TPROXY_ROUTE_TABLE=</span><br><span class=\"line\">ISTIO_INBOUND_PORTS=</span><br><span class=\"line\">ISTIO_OUTBOUND_PORTS=</span><br><span class=\"line\">ISTIO_LOCAL_EXCLUDE_PORTS=</span><br><span class=\"line\">ISTIO_EXCLUDE_INTERFACES=</span><br><span class=\"line\">ISTIO_SERVICE_CIDR=</span><br><span class=\"line\">ISTIO_SERVICE_EXCLUDE_CIDR=</span><br><span class=\"line\">ISTIO_META_DNS_CAPTURE=</span><br><span class=\"line\">INVALID_DROP=</span><br><span class=\"line\"></span><br><span class=\"line\">2023-12-28T09:08:49.813747Z     info    Istio iptables variables:</span><br><span class=\"line\">IPTABLES_VERSION=</span><br><span class=\"line\">PROXY_PORT=15001</span><br><span class=\"line\">PROXY_INBOUND_CAPTURE_PORT=15006</span><br><span class=\"line\">PROXY_TUNNEL_PORT=15008</span><br><span class=\"line\">PROXY_UID=1337</span><br><span class=\"line\">PROXY_GID=1337</span><br><span class=\"line\">INBOUND_INTERCEPTION_MODE=REDIRECT</span><br><span class=\"line\">INBOUND_TPROXY_MARK=1337</span><br><span class=\"line\">INBOUND_TPROXY_ROUTE_TABLE=133</span><br><span class=\"line\">INBOUND_PORTS_INCLUDE=*</span><br><span class=\"line\">INBOUND_PORTS_EXCLUDE=15090,15021,15020</span><br><span class=\"line\">OUTBOUND_OWNER_GROUPS_INCLUDE=*</span><br><span class=\"line\">OUTBOUND_OWNER_GROUPS_EXCLUDE=</span><br><span class=\"line\">OUTBOUND_IP_RANGES_INCLUDE=*</span><br><span class=\"line\">OUTBOUND_IP_RANGES_EXCLUDE=</span><br><span class=\"line\">OUTBOUND_PORTS_INCLUDE=</span><br><span class=\"line\">OUTBOUND_PORTS_EXCLUDE=</span><br><span class=\"line\">KUBE_VIRT_INTERFACES=</span><br><span class=\"line\">ENABLE_INBOUND_IPV6=false</span><br><span class=\"line\">DUAL_STACK=false</span><br><span class=\"line\">DNS_CAPTURE=false</span><br><span class=\"line\">DROP_INVALID=false</span><br><span class=\"line\">CAPTURE_ALL_DNS=false</span><br><span class=\"line\">DNS_SERVERS=[],[]</span><br><span class=\"line\">NETWORK_NAMESPACE=</span><br><span class=\"line\">CNI_MODE=false</span><br><span class=\"line\">EXCLUDE_INTERFACES=</span><br><span class=\"line\"></span><br><span class=\"line\">2023-12-28T09:08:49.813791Z     info    Running iptables-restore with the following input:</span><br><span class=\"line\">* nat</span><br><span class=\"line\">-N ISTIO_INBOUND\t\t\t\t// iptables增加链</span><br><span class=\"line\">-N ISTIO_REDIRECT</span><br><span class=\"line\">-N ISTIO_IN_REDIRECT</span><br><span class=\"line\">-N ISTIO_OUTPUT</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp --dport 15008 -j RETURN</span><br><span class=\"line\">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class=\"line\">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class=\"line\">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp --dport 15090 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp --dport 15021 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp --dport 15020 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo -s 127.0.0.6/32 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -p tcp ! --dport 15008 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo ! -d 127.0.0.1/32 -p tcp ! --dport 15008 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\">2023-12-28T09:08:49.813839Z     info    Running command (with wait lock): iptables-restore --noflush --wait=30</span><br><span class=\"line\">2023-12-28T09:08:49.815293Z     info    Running ip6tables-restore with the following input:</span><br><span class=\"line\"></span><br><span class=\"line\">2023-12-28T09:08:49.815329Z     info    Running command (with wait lock): ip6tables-restore --noflush --wait=30</span><br><span class=\"line\">2023-12-28T09:08:49.816025Z     info    Running command (without lock): iptables-save </span><br><span class=\"line\">2023-12-28T09:08:49.817187Z     info    Command output: </span><br><span class=\"line\"># Generated by iptables-save v1.8.7 on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\">*raw</span><br><span class=\"line\">:PREROUTING ACCEPT [0:0]</span><br><span class=\"line\">:OUTPUT ACCEPT [0:0]</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\"># Completed on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\"># Generated by iptables-save v1.8.7 on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\">*mangle</span><br><span class=\"line\">:PREROUTING ACCEPT [0:0]</span><br><span class=\"line\">:INPUT ACCEPT [0:0]</span><br><span class=\"line\">:FORWARD ACCEPT [0:0]</span><br><span class=\"line\">:OUTPUT ACCEPT [0:0]</span><br><span class=\"line\">:POSTROUTING ACCEPT [0:0]</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\"># Completed on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\"># Generated by iptables-save v1.8.7 on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\">*filter</span><br><span class=\"line\">:INPUT ACCEPT [0:0]</span><br><span class=\"line\">:FORWARD ACCEPT [0:0]</span><br><span class=\"line\">:OUTPUT ACCEPT [0:0]</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\"># Completed on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\"># Generated by iptables-save v1.8.7 on Thu Dec 28 09:08:49 2023</span><br><span class=\"line\">*nat</span><br><span class=\"line\">:PREROUTING ACCEPT [0:0]</span><br><span class=\"line\">:INPUT ACCEPT [0:0]</span><br><span class=\"line\">:OUTPUT ACCEPT [0:0]</span><br><span class=\"line\">:POSTROUTING ACCEPT [0:0]</span><br><span class=\"line\">:ISTIO_INBOUND - [0:0]</span><br><span class=\"line\">:ISTIO_IN_REDIRECT - [0:0]</span><br><span class=\"line\">:ISTIO_OUTPUT - [0:0]</span><br><span class=\"line\">:ISTIO_REDIRECT - [0:0]</span><br><span class=\"line\">-A PREROUTING -p tcp -j ISTIO_INBOUND</span><br><span class=\"line\">-A OUTPUT -p tcp -j ISTIO_OUTPUT</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -m tcp --dport 15008 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -m tcp --dport 15090 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -m tcp --dport 15021 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -m tcp --dport 15020 -j RETURN</span><br><span class=\"line\">-A ISTIO_INBOUND -p tcp -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A ISTIO_IN_REDIRECT -p tcp -j REDIRECT --to-ports 15006</span><br><span class=\"line\">-A ISTIO_OUTPUT -s 127.0.0.6/32 -o lo -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --uid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo -m owner ! --uid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -m owner --uid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT ! -d 127.0.0.1/32 -o lo -p tcp -m tcp ! --dport 15008 -m owner --gid-owner 1337 -j ISTIO_IN_REDIRECT</span><br><span class=\"line\">-A ISTIO_OUTPUT -o lo -m owner ! --gid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -m owner --gid-owner 1337 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -d 127.0.0.1/32 -j RETURN</span><br><span class=\"line\">-A ISTIO_OUTPUT -j ISTIO_REDIRECT</span><br><span class=\"line\">-A ISTIO_REDIRECT -p tcp -j REDIRECT --to-ports 15001</span><br><span class=\"line\">COMMIT</span><br><span class=\"line\"># Completed on Thu Dec 28 09:08:49 2023</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">被注入后，会有istio-proxy中会有两个进程</span><br><span class=\"line\"></span><br><span class=\"line\">istio-proxy@nginx-deployment-846d79d-77zhs:/$ ps -ef </span><br><span class=\"line\">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class=\"line\">istio-p+       1       0  0 Dec28 ?        00:00:35 /usr/local/bin/pilot-agent proxy sidecar --domain default.svc.cluster.local --proxyLogLevel=warning --proxyComponentLogLevel=misc:error --log_output_level=default:info</span><br><span class=\"line\">istio-p+      14       1  0 Dec28 ?        00:02:19 /usr/local/bin/envoy -c etc/istio/proxy/envoy-rev.json --drain-time-s 45 --drain-strategy immediate --local-address-ip-version v4 --file-flush-interval-msec 1000 --disable-hot-restart --allow-unknown-static-fields --log-</span><br><span class=\"line\">istio-p+      58       0  0 05:45 pts/0    00:00:00 bash</span><br><span class=\"line\">istio-p+      67      58  0 05:45 pts/0    00:00:00 ps -ef</span><br><span class=\"line\"></span><br><span class=\"line\">pilot-agent动作：</span><br><span class=\"line\">1生成envoy,启动配置</span><br><span class=\"line\">2启动envoy</span><br><span class=\"line\">3监控并管理envoy 的运行情况，比如envoy出错时负责重启，envoy 配置变更后重新加载</span><br><span class=\"line\"></span><br><span class=\"line\">可以把envoy理解成一个轻量的ngx</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231230135040352.png\" alt=\"image-20231230135040352\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">istio-proxy@istiod-755784476f-lxnw2:/$ ps -ef </span><br><span class=\"line\">UID          PID    PPID  C STIME TTY          TIME CMD</span><br><span class=\"line\">istio-p+       1       0  0 Dec25 ?        00:10:28 /usr/local/bin/pilot-discovery discovery --monitoringAddr=:15014 --log_output_level=default:info --domain cluster.local --keepaliveMaxServerConnectionAge 30m</span><br><span class=\"line\">istio-p+      20       0  0 11:30 pts/0    00:00:00 bash</span><br><span class=\"line\">istio-p+      28      20  0 11:30 pts/0    00:00:00 ps -ef</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">istio-proxy@nginx-deployment-846d79d-77zhs:/$ netstat -lntup </span><br><span class=\"line\">Active Internet connections (only servers)</span><br><span class=\"line\">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name    </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15021           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15021           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      -                   </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15090           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 127.0.0.1:15000         0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15001           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15001           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 127.0.0.1:15004         0.0.0.0:*               LISTEN      1/pilot-agent       </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15006           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp        0      0 0.0.0.0:15006           0.0.0.0:*               LISTEN      14/envoy            </span><br><span class=\"line\">tcp6       0      0 :::15020                :::*                    LISTEN      1/pilot-agent       </span><br><span class=\"line\">tcp6       0      0 :::80                   :::*                    LISTEN      -      </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231230142501664.png\" alt=\"image-20231230142501664\"></p>\n<p>15000 只能本 network ns 才能访问，不允许外部流量访问</p>\n<p>同样的镜像 proxyv2 产生了不同的行为</p>\n<p>当用户同时在 kubernetes 中的 yaml 文件中写了 command 和 args 的时候自然是可以覆盖 DockerFile 中 ENTRYPOINT 的命令行和参数，完整的情况分类如下:<br>\n 如果 command 和 args 均没有写，那么用 Docker 默认的配置。<br>\n如果 command 写了，但 args 没有写，那么 Docker 默认的配置会被忽略而且仅仅执行.yam 文件的 command (不带任何参数的)。<br>\n如果 command 没写，但 args 写了，那么 Docker 默认配置的 ENTRYPOINT 的命令行会被执行，但是调用的参数是.vaml 中的 args。<br>\n如果如果 command 和 args 都写了，那么 Docker 默认的配置被忽略，使用.vaml 的配置</p>\n<p>自动注入</p>\n<p>本质是给 ns 打标签</p>\n<p>kubectl label ns istio-injection=enabled</p>\n<h2 id=\"upgrade\"><a class=\"markdownIt-Anchor\" href=\"#upgrade\">#</a> upgrade</h2>\n<p>1. 升级被注入的资源</p>\n<p>2. 升级 istio</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.download istio </span><br><span class=\"line\"></span><br><span class=\"line\">2.tar xzvf istio.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">3.source istio.bash </span><br><span class=\"line\"></span><br><span class=\"line\">4.保证升级前后profile相同</span><br><span class=\"line\">istioctl profile dump demo &gt; 1.demo</span><br><span class=\"line\"></span><br><span class=\"line\">4.1修改jwt策略</span><br><span class=\"line\"></span><br><span class=\"line\">5.upgrade</span><br><span class=\"line\">istioctl upgrade -f 1.demo</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9pc3Rpby5pby9sYXRlc3QvemgvZG9jcy9zZXR1cC91cGdyYWRlL2luLXBsYWNlLw==\">https://istio.io/latest/zh/docs/setup/upgrade/in-place/</span></p>\n<h2 id=\"virtual-service\"><a class=\"markdownIt-Anchor\" href=\"#virtual-service\">#</a> virtual service</h2>\n<p>一种实现流量管理的方式</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/arch.svg\" alt=\"The overall architecture of an Istio-based application.\" style=\"zoom: 50%;\" /> \n<p>service 可以简单理解为一个微服务</p>\n<p>注入后的微服务，就会形成一个网格</p>\n<p>网格之间的通信要通过网格的 proxy</p>\n<p>ingress -&gt; envoy -&gt; service -&gt; envoy -&gt;envoyB -&gt; serviceB -&gt; envoyB -&gt; engress</p>\n<p>Istio 架构由数据面 (data plane) 和控制面 (control plane) 构成，因此 lstio 流量也可以分为数据面流量和控制面流量。数据面流量是指微服务之间业务调用的流量，控制面流量是指 Istio 各组件之间配置和控制网格行为的流量。</p>\n<p>traffic management 指的是数据平面的流量</p>\n<p>lstio traffic management model 依赖于随服务一起部署的 Envoy 代理，网格发送和接收的所有流量 (数据平面流量) 都通过 Envoy 进行代理。基于此模型可以轻松引导和控制网格周围的流量，而无需对服务进行任何更改</p>\n<p>traffic management 实现方式</p>\n<p>Virtual services</p>\n<p>Destination rules</p>\n<p>Gateways</p>\n<p>Service entries</p>\n<p>Sidecars</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231231182246917.png\" alt=\"image-20231231182246917\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231231185940467.png\" alt=\"image-20231231185940467\"></p>\n<p>client 也需要被 istio 注入才能实现上述功能，他们必须在一个 istio 网络内</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.istio.io/</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">VirtualService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">web-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">hosts:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">web-svc.default.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"attr\">http:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">route:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">destination:</span></span><br><span class=\"line\">        <span class=\"attr\">host:</span> <span class=\"string\">tomcat-svc.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"attr\">weight:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">destination:</span></span><br><span class=\"line\">        <span class=\"attr\">host:</span> <span class=\"string\">httpd-svc.default.svc.cluster.local</span></span><br><span class=\"line\">      <span class=\"attr\">weight:</span> <span class=\"number\">20</span></span><br></pre></td></tr></table></figure>\n<p>istio 规则只在集群内生效，从外部访问无效</p>\n<p>kubectl get <span class=\"exturl\" data-url=\"aHR0cDovL3ZpcnR1YWxzZXJ2aWNlcy5uZXR3b3JraW5nLmlzdGlvLmlv\">virtualservices.networking.istio.io</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101201220715.png\" alt=\"image-20240101201220715\" style=\"zoom:50%;\" /> \n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101201229872.png\" alt=\"image-20240101201229872\" style=\"zoom:50%;\" /> \n<p>envoy 是个反代服务器</p>\n<p>virtualservice 指向一个 host，host 可以在 k8s 内寻址，host 路由规则依据 routing rules</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101202339223.png\" alt=\"image-20240101202339223\" style=\"zoom:50%;\" /> \n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101202531446.png\" alt=\"image-20240101202531446\" style=\"zoom:50%;\" /> \n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101202550632.png\" alt=\"image-20240101202550632\" style=\"zoom:50%;\" /> \n<p>hosts field</p>\n<p>1 short name service(web-svc</p>\n<p>2 full qualified domain name service(web-svc.default.svc.clusterlocal</p>\n<p>3 gateway name( <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy53ZWItc3ZjLmNvbQ==\">www.web-svc.com</span>)</p>\n<p>4 *</p>\n<p>rules</p>\n<p>1.match condition</p>\n<p>2.destination</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101203438577.png\" alt=\"image-20240101203438577\" style=\"zoom:50%;\" /> \n<p>路由优先级：在 yaml 中越往上优先级越高</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101204406434.png\" alt=\"image-20240101204406434\" style=\"zoom:50%;\" /> \n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240101205143775.png\" alt=\"image-20240101205143775\"></p>\n<p>wget -q -O - <span class=\"exturl\" data-url=\"aHR0cDovL3dldi1zdmMtdnM6ODA4MA==\">http://wev-svc-vs:8080</span> --header ‘end-user: jiuxi’</p>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/06/02/k8s%E9%AB%98%E7%BA%A7/",
            "url": "http://example.com/2023/06/02/k8s%E9%AB%98%E7%BA%A7/",
            "title": "k8s高级",
            "date_published": "2023-06-02T05:38:45.000Z",
            "content_html": "<h1 id=\"k8s高级\"><a class=\"markdownIt-Anchor\" href=\"#k8s高级\">#</a> k8s 高级</h1>\n<h2 id=\"环境配置\"><a class=\"markdownIt-Anchor\" href=\"#环境配置\">#</a> 环境配置</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker load -i  .tar.gz</span><br><span class=\"line\">ctr -n=k8s.io images import .tar.gz</span><br><span class=\"line\">ctr -n=k8s.io images pull docker.io/library/centos:latest</span><br><span class=\"line\">docker save -o .tar.gz</span><br><span class=\"line\">ctr -n=k8s.io import .tar.gz</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改ip</span><br><span class=\"line\">配置主机名</span><br><span class=\"line\">配置hosts文件</span><br><span class=\"line\">配置免密登录</span><br><span class=\"line\">关闭交换分区</span><br><span class=\"line\">修改内核参数</span><br><span class=\"line\">关闭firewalld防火墙</span><br><span class=\"line\">关闭selinux</span><br><span class=\"line\">配置阿里云的安装docker的repo源</span><br><span class=\"line\">配置阿里云安装k8s的repo源</span><br><span class=\"line\">配置时间同步</span><br><span class=\"line\">开启ipvs</span><br><span class=\"line\">安装基础软件包</span><br><span class=\"line\">安装iptablese</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm join 192.168.13.180:6443 --token or2v2h.3vffzj49xx3yuvr6 \\</span><br><span class=\"line\">\t--discovery-token-ca-cert-hash sha256:09c9428481b6f33c04537f0753472f38c16637b351123a1416e7771366ca837a</span><br><span class=\"line\"></span><br><span class=\"line\">1.安装bash-completion工具</span><br><span class=\"line\">yum install bash-completion -y</span><br><span class=\"line\"> 否则报错：</span><br><span class=\"line\">-bash: _get_comp_words_by_ref: command not found</span><br><span class=\"line\">2.执行bash_completion</span><br><span class=\"line\">source /usr/share/bash-completion/bash_completion</span><br><span class=\"line\">3.加载kubectl completion</span><br><span class=\"line\">source &lt;(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span><br><span class=\"line\">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc # 在您的 bash shell 中永久的添加自动补全</span><br><span class=\"line\">您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</span><br><span class=\"line\">cat &gt;&gt;/root/.bashrc&lt;&lt;EOF</span><br><span class=\"line\">alias k=kubectl</span><br><span class=\"line\">complete -F __start_kubectl k</span><br><span class=\"line\">EOF</span><br><span class=\"line\">source /root/.bashrc</span><br></pre></td></tr></table></figure>\n<h2 id=\"prometheus\"><a class=\"markdownIt-Anchor\" href=\"#prometheus\">#</a> Prometheus</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Prometheus是一个开源的系统监控和报警系统，现在已经加入到CNCF基金会，成为继k8s之后第二个在CNCF托管的项目，在kubernetes容器管理系统中，通常会搭配prometheus进行监控，同时也支持多种exporter采集数据，还支持pushgateway进行数据上报，Prometheus性能足够支撑上万台规模的集群。</span><br><span class=\"line\"></span><br><span class=\"line\">zabbix,nagios,cattio</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.多维度数据模型</span><br><span class=\"line\">每一个时间序列数据都由metric度量指标名称和它的标签labels键值对集合唯一确定：</span><br><span class=\"line\">这个metric度量指标名称指定监控目标系统的测量特征（如：http_requests_total- 接收http请求的总计数）。labels开启了Prometheus的多维数据模型：对于相同的度量名称，通过不同标签列表的结合, 会形成特定的度量维度实例。(例如：所有包含度量名称为/api/tracks的http请求，打上method=POST的标签，则形成了具体的http请求)。这个查询语言在这些度量和标签列表的基础上进行过滤和聚合。改变任何度量上的任何标签值，则会形成新的时间序列图。</span><br><span class=\"line\">2.灵活的查询语言（PromQL）</span><br><span class=\"line\">可以对采集的metrics指标进行加法，乘法，连接等操作；</span><br><span class=\"line\">3.可以直接在本地部署，不依赖其他分布式存储；</span><br><span class=\"line\">4.通过基于HTTP的pull方式采集时序数据；</span><br><span class=\"line\">5.可以通过中间网关pushgateway的方式把时间序列数据推送到prometheus server端；</span><br><span class=\"line\">6.可通过服务发现或者静态配置来发现目标服务对象（targets）。</span><br><span class=\"line\">7.有多种可视化图像界面，如Grafana等。</span><br><span class=\"line\">8.高效的存储，每个采样数据占3.5 bytes左右，300万的时间序列，30s间隔，保留60天，消耗磁盘大概200G。</span><br><span class=\"line\">9.做高可用，可以对数据做异地备份，联邦集群，部署多套prometheus，pushgateway上报数据</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">样本</span><br><span class=\"line\">在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成：</span><br><span class=\"line\">1、指标（metric）：指标名称和描述当前样本特征的 labelsets；</span><br><span class=\"line\">2、时间戳（timestamp）：一个精确到毫秒的时间戳；</span><br><span class=\"line\">3、样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。</span><br><span class=\"line\"></span><br><span class=\"line\">表示方式：</span><br><span class=\"line\">通过如下表达方式表示指定指标名称和指定标签集合的时间序列：</span><br><span class=\"line\">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</span><br><span class=\"line\">例如，指标名称为 api_http_requests_total，标签为 method=&quot;POST&quot; 和 handler=&quot;/messages&quot; 的时间序列可以表示为：</span><br><span class=\"line\">api_http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"组件介绍\"><a class=\"markdownIt-Anchor\" href=\"#组件介绍\">#</a> 组件介绍</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.Prometheus Server: 用于收集和存储时间序列数据。</span><br><span class=\"line\">2.Client Library: 客户端库，检测应用程序代码，当Prometheus抓取实例的HTTP端点时，客户端库会将所有跟踪的metrics指标的当前状态发送到prometheus server端。</span><br><span class=\"line\">3.Exporters: prometheus支持多种exporter，通过exporter可以采集metrics数据，然后发送到prometheus server端，所有向promtheus server提供监控数据的程序都可以被称为exporter</span><br><span class=\"line\">4.Alertmanager: 从 Prometheus server 端接收到 alerts 后，会进行去重，分组，并路由到相应的接收方，发出报警，常见的接收方式有：电子邮件，微信，钉钉, slack等。</span><br><span class=\"line\">5.Grafana：监控仪表盘，可视化监控数据</span><br><span class=\"line\">6.pushgateway: 各个目标主机可上报数据到pushgateway，然后prometheus server统一从pushgateway拉取数据。</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143122137.png\" alt=\"image-20230526143122137\"></p>\n<h3 id=\"工作流程\"><a class=\"markdownIt-Anchor\" href=\"#工作流程\">#</a> 工作流程</h3>\n<p>1.Prometheus server 可定期从活跃的（up）目标主机上（target）拉取监控指标数据，目标主机的监控数据可通过配置静态 job 或者服务发现的方式被 prometheus server 采集到，这种方式默认的 pull 方式拉取指标；也可通过 pushgateway 把采集的数据上报到 prometheus server 中；还可通过一些组件自带的 exporter 采集相应组件的数据；</p>\n<p>2.Prometheus server 把采集到的监控指标数据保存到本地磁盘或者数据库；</p>\n<p>3.Prometheus 采集的监控指标数据按时间序列存储，通过配置报警规则，把触发的报警发送到 alertmanager</p>\n<p>4.Alertmanager 通过配置报警接收方，发送报警到邮件，微信或者钉钉等</p>\n<p>5.Prometheus 自带的 web ui 界面提供 PromQL 查询语言，可查询监控数据</p>\n<p>6.Grafana 可接入 prometheus 数据源，把监控数据以图形化形式展示出</p>\n<h3 id=\"prometheus和zabbix对比\"><a class=\"markdownIt-Anchor\" href=\"#prometheus和zabbix对比\">#</a> Prometheus 和 Zabbix 对比</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143352088.png\" alt=\"image-20230526143352088\"></p>\n<h3 id=\"部署模式\"><a class=\"markdownIt-Anchor\" href=\"#部署模式\">#</a> 部署模式</h3>\n<p>基本 HA</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143444630.png\" alt=\"image-20230526143444630\"></p>\n<p><strong>基本的 HA 模式只能确保 Promthues 服务的可用性问题，但是不解决 Prometheus Server 之间的数据一致性问题以及持久化问题 (数据丢失后无法恢复)，也无法进行动态的扩展。因此这种部署方式适合监控规模不大，Promthues Server 也不会频繁发生迁移的情况，并且只需要保存短周期监控数据的场景。</strong></p>\n<p>基本 HA + 远程存储</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143538150.png\" alt=\"image-20230526143538150\"></p>\n<p><strong>在解决了 Promthues 服务可用性的基础上，同时确保了数据的持久化，当 Promthues Server 发生宕机或者数据丢失的情况下，可以快速的恢复。 同时 Promthues Server 可能很好的进行迁移。因此，该方案适用于用户监控规模不大，但是希望能够将监控数据持久化，同时能够确保 Promthues Server 的可迁移性的场景。</strong></p>\n<p>基本 HA + 远程存储 + 联邦集群</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143645241.png\" alt=\"image-20230526143645241\"></p>\n<p><strong>Promthues 的性能瓶颈主要在于大量的采集任务，因此用户需要利用 Prometheus 联邦集群的特性，将不同类型的采集任务划分到不同的 Promthues 子服务中，从而实现功能分区。例如一个 Promthues Server 负责采集基础设施相关的监控指标，另外一个 Prometheus Server 负责采集应用监控指标。再有上层 Prometheus Server 实现对数据的汇聚。</strong></p>\n<h3 id=\"数据类型\"><a class=\"markdownIt-Anchor\" href=\"#数据类型\">#</a> 数据类型</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Counter是计数器类型：</span><br><span class=\"line\">1、Counter 用于累计值，例如记录请求次数、任务完成数、错误发生次数。</span><br><span class=\"line\">2、一直增加，不会减少。</span><br><span class=\"line\">3、重启进程后，会被重置。</span><br><span class=\"line\">例如：http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  100</span><br><span class=\"line\">      http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  160</span><br><span class=\"line\">      </span><br><span class=\"line\">Counter 类型数据可以让用户方便的了解事件产生的速率的变化，在PromQL内置的相关操作函数可以提供相应的分析，比如以HTTP应用请求量来进行说明：</span><br><span class=\"line\">1、通过rate()函数获取HTTP请求量的增长率</span><br><span class=\"line\">rate(http_requests_total[5m])</span><br><span class=\"line\">2、查询当前系统中，访问量前10的HTTP地址</span><br><span class=\"line\">topk(10, http_requests_total)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Gauge是测量器类型：</span><br><span class=\"line\">1、Gauge是常规数值，例如温度变化、内存使用变化。</span><br><span class=\"line\">2、可变大，可变小。</span><br><span class=\"line\">3、重启进程后，会被重置</span><br><span class=\"line\"></span><br><span class=\"line\">例如：</span><br><span class=\"line\">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   100</span><br><span class=\"line\">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   30</span><br><span class=\"line\">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   50</span><br><span class=\"line\">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   80 </span><br><span class=\"line\"></span><br><span class=\"line\">对于 Gauge 类型的监控指标，通过 PromQL 内置函数 delta() 可以获取样本在一段时间内的变化情况，例如，计算 CPU 温度在两小时内的差异：</span><br><span class=\"line\">dalta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h])</span><br><span class=\"line\"></span><br><span class=\"line\">你还可以通过PromQL 内置函数 predict_linear() 基于简单线性回归的方式，对样本数据的变化趋势做出预测。例如，基于 2 小时的样本数据，来预测主机可用磁盘空间在 4 个小时之后的剩余情况：</span><br><span class=\"line\">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">histogram是柱状图，在Prometheus系统的查询语言中，有三种作用：</span><br><span class=\"line\">1、在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中. 后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。</span><br><span class=\"line\">2、对每个采样点值累计和(sum)</span><br><span class=\"line\">3、对采样点的次数累计和(count)</span><br><span class=\"line\"></span><br><span class=\"line\">度量指标名称: [basename]_上面三类的作用度量指标名称</span><br><span class=\"line\">1、[basename]_bucket&#123;le=&quot;上边界&quot;&#125;, 这个值为小于等于上边界的所有采样点数量</span><br><span class=\"line\">2、[basename]_sum</span><br><span class=\"line\">3、[basename]_count</span><br><span class=\"line\"></span><br><span class=\"line\">在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统 API 调用的平均响应时间为例：如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</span><br><span class=\"line\">为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在 0~10ms 之间的请求数有多少，而 10~20ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，我们可以快速了解监控样本的分布情况。</span><br><span class=\"line\"></span><br><span class=\"line\">Histogram 类型的样本会提供三种指标（假设指标名称为 &lt;basename&gt;）：</span><br><span class=\"line\">样本的值分布在 bucket 中的数量，命名为 &lt;basename&gt;_bucket&#123;le=&quot;&lt;上边界&gt;&quot;&#125;。解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。</span><br><span class=\"line\"></span><br><span class=\"line\">1、http 请求响应时间 &lt;=0.005 秒 的请求次数为0</span><br><span class=\"line\">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.005&quot;,&#125; 0.0</span><br><span class=\"line\">2、http 请求响应时间 &lt;=0.01 秒 的请求次数为0</span><br><span class=\"line\">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.01&quot;,&#125; 0.0</span><br><span class=\"line\"> 3、http 请求响应时间 &lt;=0.025 秒 的请求次数为0</span><br><span class=\"line\">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.025&quot;,&#125; 0.0</span><br><span class=\"line\"></span><br><span class=\"line\">所有样本值的大小总和，命名为 &lt;basename&gt;_sum。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">summary</span><br><span class=\"line\">与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。它也有三种作用：</span><br><span class=\"line\">1、对于每个采样点进行统计，并形成分位图。（如：正态分布一样，统计低于60分不及格的同学比例，统计低于80分的同学比例，统计低于95分的同学比例）</span><br><span class=\"line\">2、统计班上所有同学的总成绩(sum)</span><br><span class=\"line\">3、统计班上同学的考试总人数(count)</span><br><span class=\"line\"></span><br><span class=\"line\">样本值的分位数分布情况，命名为 &lt;basename&gt;&#123;quantile=&quot;&lt;φ&gt;&quot;&#125;。</span><br><span class=\"line\">1、含义：http 请求中有 50% 的请求响应时间是 3.052404983s</span><br><span class=\"line\">  io_namespace_http_requests_latency_seconds_summary&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,quantile=&quot;0.5&quot;,&#125; 3.052404983</span><br><span class=\"line\">  </span><br><span class=\"line\">  Histogram 需要通过 &lt;basename&gt;_bucket 来计算分位数，而 Summary 则直接存储了分位数的值。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Prometheus对kubernetes的监控</span><br><span class=\"line\">对于Kubernetes而言，我们可以把当中所有的资源分为几类：</span><br><span class=\"line\">•基础设施层（Node）：集群节点，为整个集群和应用提供运行时资源</span><br><span class=\"line\">•容器基础设施（Container）：为应用提供运行时环境</span><br><span class=\"line\">•用户应用（Pod）：Pod中会包含一组容器，它们一起工作，并且对外提供一个（或者一组）功能</span><br><span class=\"line\">•内部服务负载均衡（Service）：在集群内，通过Service在集群暴露应用功能，集群内应用和应用之间访问时提供内部的负载均衡</span><br><span class=\"line\">•外部访问入口（Ingress）：通过Ingress提供集群外的访问入口，从而可以使外部客户端能够访问到部署在Kubernetes集群内的服务</span><br></pre></td></tr></table></figure>\n<h3 id=\"node-exporter\"><a class=\"markdownIt-Anchor\" href=\"#node-exporter\">#</a> node-exporter</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node-exporter可以采集机器（物理机、虚拟机、云主机等）的监控指标数据，能够采集到的指标包括CPU, 内存，磁盘，网络，文件数等信息。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span>  <span class=\"comment\">#可以保证k8s集群的每个节点都运行完全一样的pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">     <span class=\"attr\">name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">hostPID:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">hostIPC:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">hostNetwork:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">node-exporter</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">prom/node-exporter:latest</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9100</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"number\">0.15</span>  <span class=\"comment\">#这个容器运行至少需要0.15核cpu</span></span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span>  <span class=\"comment\">#开启特权模式</span></span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--path.procfs</span>  <span class=\"comment\">#配置挂载宿主机（node节点）的路径</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">/host/proc</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--path.sysfs</span>  <span class=\"comment\">#配置挂载宿主机（node节点）的路径</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">/host/sys</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--collector.filesystem.ignored-mount-points</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#通过正则表达式忽略某些文件系统挂载点的信息收集</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dev</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/host/dev</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">proc</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/host/proc</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">sys</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/host/sys</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rootfs</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/rootfs</span></span><br><span class=\"line\"><span class=\"comment\">#将主机/dev、/proc、/sys这些目录挂在到容器中，这是因为我们采集的很多节点数据都是通过这些文件来获取系统信息的。</span></span><br><span class=\"line\">      <span class=\"attr\">tolerations:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">operator:</span> <span class=\"string\">&quot;Exists&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">effect:</span> <span class=\"string\">&quot;NoSchedule&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">proc</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/proc</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dev</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/dev</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">sys</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/sys</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rootfs</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span><span class=\"string\">:9100/metrics</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span><span class=\"string\">:9100/metrics</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">node_cpu_seconds</span></span><br><span class=\"line\">  <span class=\"string\">%</span> <span class=\"string\">Total</span>    <span class=\"string\">%</span> <span class=\"string\">Received</span> <span class=\"string\">%</span> <span class=\"string\">Xferd</span>  <span class=\"string\">Average</span> <span class=\"string\">Speed</span>   <span class=\"string\">Time</span>    <span class=\"string\">Time</span>     <span class=\"string\">Time</span>  <span class=\"string\">Current</span></span><br><span class=\"line\">                                 <span class=\"string\">Dload</span>  <span class=\"string\">Upload</span>   <span class=\"string\">Total</span>   <span class=\"string\">Spent</span>    <span class=\"string\">Left</span>  <span class=\"string\">Speed</span></span><br><span class=\"line\">  <span class=\"number\">0</span>     <span class=\"number\">0</span>    <span class=\"number\">0</span>     <span class=\"number\">0</span>    <span class=\"number\">0</span>     <span class=\"number\">0</span>      <span class=\"number\">0</span>      <span class=\"number\">0</span> <span class=\"string\">--:--:--</span> <span class=\"string\">--:--:--</span> <span class=\"string\">--:--:--</span>     <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"comment\"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class=\"line\"><span class=\"comment\"># TYPE node_cpu_seconds_total counter</span></span><br><span class=\"line\"><span class=\"string\">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;idle&quot;&#125;</span> <span class=\"number\">14492.66</span></span><br><span class=\"line\"><span class=\"string\">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;iowait&quot;&#125;</span> <span class=\"number\">19.3</span></span><br><span class=\"line\"><span class=\"string\">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;irq&quot;&#125;</span> <span class=\"number\">0</span></span><br><span class=\"line\"><span class=\"string\">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;nice&quot;&#125;</span> <span class=\"number\">0.48</span></span><br><span class=\"line\"><span class=\"string\">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;softirq&quot;&#125;</span> <span class=\"number\">28.25</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建sa账号，对sa做rbac授权</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">serviceaccount</span> <span class=\"string\">monitor</span> <span class=\"string\">-n</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">monitor-clusterrolebinding</span> <span class=\"string\">-n</span> <span class=\"string\">monitor-sa</span> <span class=\"string\">--clusterrole=cluster-admin</span>  <span class=\"string\">--serviceaccount=monitor-sa:monitor</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">monitor-clusterrolebinding-1</span> <span class=\"string\">-n</span> <span class=\"string\">monitor-sa</span> <span class=\"string\">--clusterrole=cluster-admin</span> <span class=\"string\">--user=system:serviceaccount:monitor:monitor-sa</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建prometheus数据存储目录</span></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data </span></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">~</span>]<span class=\"comment\"># chmod 777 -R /data/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建configmap</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    global:</span></span><br><span class=\"line\"><span class=\"string\">      scrape_interval: 15s</span></span><br><span class=\"line\"><span class=\"string\">      scrape_timeout: 10s</span></span><br><span class=\"line\"><span class=\"string\">      evaluation_interval: 1m</span></span><br><span class=\"line\"><span class=\"string\">    scrape_configs:</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: node</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__address__]</span></span><br><span class=\"line\"><span class=\"string\">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role:  node</span></span><br><span class=\"line\"><span class=\"string\">      scheme: https</span></span><br><span class=\"line\"><span class=\"string\">      tls_config:</span></span><br><span class=\"line\"><span class=\"string\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">      - target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        replacement: kubernetes.default.svc:443</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class=\"line\"><span class=\"string\">        regex: (.+)</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __metrics_path__</span></span><br><span class=\"line\"><span class=\"string\">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: endpoints</span></span><br><span class=\"line\"><span class=\"string\">      scheme: https</span></span><br><span class=\"line\"><span class=\"string\">      tls_config:</span></span><br><span class=\"line\"><span class=\"string\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class=\"line\"><span class=\"string\">        action: keep</span></span><br><span class=\"line\"><span class=\"string\">        regex: default;kubernetes;https</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: endpoints</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class=\"line\"><span class=\"string\">        action: keep</span></span><br><span class=\"line\"><span class=\"string\">        regex: true</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __scheme__</span></span><br><span class=\"line\"><span class=\"string\">        regex: (https?)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __metrics_path__</span></span><br><span class=\"line\"><span class=\"string\">        regex: (.+)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        regex: ([^:]+)(?::\\d+)?;(\\d+)</span></span><br><span class=\"line\"><span class=\"string\">        replacement: $1:$2</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_name </span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<h3 id=\"部署prothemeus\"><a class=\"markdownIt-Anchor\" href=\"#部署prothemeus\">#</a> 部署 Prothemeus</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过deployment部署Prothemeus</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">      <span class=\"attr\">component:</span> <span class=\"string\">server</span></span><br><span class=\"line\">    <span class=\"comment\">#matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class=\"line\">    <span class=\"comment\">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">component:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">annotations:</span></span><br><span class=\"line\">        <span class=\"attr\">prometheus.io/scrape:</span> <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">monitor</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">--config.file=/etc/prometheus/prometheus.yml</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">--storage.tsdb.path=/prometheus</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">--storage.tsdb.retention=720h</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">--web.enable-lifecycle</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/prometheus</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/prometheus/</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">prometheus-storage-volume</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">          <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus-storage-volume</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">           <span class=\"attr\">path:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">           <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">prome</span>]<span class=\"comment\"># kubectl exec -it -n monitor-sa prometheus-server-674dff4c46-l67r6 -- /bin/sh</span></span><br><span class=\"line\"><span class=\"string\">/prometheus</span> <span class=\"string\">$</span> <span class=\"string\">cd</span> <span class=\"string\">/etc/prometheus/</span></span><br><span class=\"line\"><span class=\"string\">/etc/prometheus</span> <span class=\"string\">$</span> <span class=\"string\">ls</span></span><br><span class=\"line\"><span class=\"string\">prometheus.yml</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">9090</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">component:</span> <span class=\"string\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 监控promethus-service</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">prometheus.io/scrape:</span> <span class=\"string\">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prothemeus热加载\"><a class=\"markdownIt-Anchor\" href=\"#prothemeus热加载\">#</a> Prothemeus 热加载</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-X</span> <span class=\"string\">POST</span> <span class=\"string\">http://pod-ip:9090/-/reload</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#热加载速度比较慢，可以暴力重启prometheus，如修改上面的prometheus-cfg.yaml文件之后，可执行如下强制删除：</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-cfg.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-deploy.yaml</span></span><br><span class=\"line\"><span class=\"string\">然后再通过apply更新：</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-cfg.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-deploy.yaml</span></span><br><span class=\"line\"><span class=\"string\">注意：</span></span><br><span class=\"line\"><span class=\"string\">线上最好热加载，暴力删除可能造成监控数据的丢失</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527153500817.png\" alt=\"image-20230527153500817\"></p>\n<h3 id=\"grafana\"><a class=\"markdownIt-Anchor\" href=\"#grafana\">#</a> Grafana</h3>\n<p><strong>Grafana 是一个跨平台的开源的度量分析和可视化工具，可以将采集的数据可视化的展示，并及时通知给告警接收方。它主要有以下六大特点：</strong></p>\n<p><strong>1、展示方式：快速灵活的客户端图表，面板插件有许多不同方式的可视化指标和日志，官方库中具有丰富的仪表盘插件，比如热图、折线图、图表等多种展示方式；</strong></p>\n<p><strong>2、数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch 和 KairosDB 等；</strong></p>\n<p><strong>3、通知提醒：以可视方式定义最重要指标的警报规则，Grafana 将不断计算并发送通知，在数据达到阈值时通过 Slack、PagerDuty 等获得通知；</strong></p>\n<p><strong>4、混合展示：在同一图表中混合使用不同的数据源，可以基于每个查询指定数据源，甚至自定义数据源；</strong></p>\n<p><strong>5、注释：使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记</strong></p>\n<h3 id=\"安装grafana\"><a class=\"markdownIt-Anchor\" href=\"#安装grafana\">#</a> 安装 Grafana</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      task: monitoring</span><br><span class=\"line\">      k8s-app: grafana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        task: monitoring</span><br><span class=\"line\">        k8s-app: grafana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: grafana</span><br><span class=\"line\">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 3000</span><br><span class=\"line\">          protocol: TCP</span><br><span class=\"line\">        volumeMounts:</span><br><span class=\"line\">        - mountPath: /etc/ssl/certs</span><br><span class=\"line\">          name: ca-certificates</span><br><span class=\"line\">          readOnly: true</span><br><span class=\"line\">        - mountPath: /var</span><br><span class=\"line\">          name: grafana-storage</span><br><span class=\"line\">        env:</span><br><span class=\"line\">        - name: INFLUXDB_HOST</span><br><span class=\"line\">          value: monitoring-influxdb</span><br><span class=\"line\">        - name: GF_SERVER_HTTP_PORT</span><br><span class=\"line\">          value: &quot;3000&quot;</span><br><span class=\"line\">          # The following env variables are required to make Grafana accessible via</span><br><span class=\"line\">          # the kubernetes api-server proxy. On production clusters, we recommend</span><br><span class=\"line\">          # removing these env variables, setup auth for grafana, and expose the grafana</span><br><span class=\"line\">          # service using a LoadBalancer or a public IP.</span><br><span class=\"line\">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class=\"line\">          value: &quot;false&quot;</span><br><span class=\"line\">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class=\"line\">          value: &quot;true&quot;</span><br><span class=\"line\">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class=\"line\">          value: Admin</span><br><span class=\"line\">        - name: GF_SERVER_ROOT_URL</span><br><span class=\"line\">          # If you&#x27;re only using the API Server proxy, set this value instead:</span><br><span class=\"line\">          # value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span><br><span class=\"line\">          value: /</span><br><span class=\"line\">      volumes:</span><br><span class=\"line\">      - name: ca-certificates</span><br><span class=\"line\">        hostPath:</span><br><span class=\"line\">          path: /etc/ssl/certs</span><br><span class=\"line\">      - name: grafana-storage</span><br><span class=\"line\">        emptyDir: &#123;&#125;</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class=\"line\">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class=\"line\">    kubernetes.io/cluster-service: &#x27;true&#x27;</span><br><span class=\"line\">    kubernetes.io/name: monitoring-grafana</span><br><span class=\"line\">  name: monitoring-grafana</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  # In a production setup, we recommend accessing Grafana through an external Loadbalancer</span><br><span class=\"line\">  # or through a public IP.</span><br><span class=\"line\">  # type: LoadBalancer</span><br><span class=\"line\">  # You could also use NodePort to expose the service at a randomly-generated port</span><br><span class=\"line\">  # type: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 80</span><br><span class=\"line\">    targetPort: 3000</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    k8s-app: grafana</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160404888.png\" alt=\"image-20230527160404888\"></p>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160957066.png\" alt=\"image-20230527160957066\"></p>\n<p>将其中的 container_last_seen 放到 Prometheus 中 query，如果显示 nodata 说明没有这项监控</p>\n<h3 id=\"kube-metric\"><a class=\"markdownIt-Anchor\" href=\"#kube-metric\">#</a> kube-metric</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRole</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">rules:</span><br><span class=\"line\">- apiGroups: [&quot;&quot;]</span><br><span class=\"line\">  resources: [&quot;nodes&quot;, &quot;pods&quot;, &quot;services&quot;, &quot;resourcequotas&quot;, &quot;replicationcontrollers&quot;, &quot;limitranges&quot;, &quot;persistentvolumeclaims&quot;, &quot;persistentvolumes&quot;, &quot;namespaces&quot;, &quot;endpoints&quot;]</span><br><span class=\"line\">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;extensions&quot;]</span><br><span class=\"line\">  resources: [&quot;daemonsets&quot;, &quot;deployments&quot;, &quot;replicasets&quot;]</span><br><span class=\"line\">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;apps&quot;]</span><br><span class=\"line\">  resources: [&quot;statefulsets&quot;]</span><br><span class=\"line\">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;batch&quot;]</span><br><span class=\"line\">  resources: [&quot;cronjobs&quot;, &quot;jobs&quot;]</span><br><span class=\"line\">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">- apiGroups: [&quot;autoscaling&quot;]</span><br><span class=\"line\">  resources: [&quot;horizontalpodautoscalers&quot;]</span><br><span class=\"line\">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  </span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kube-state-metrics</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kube-state-metrics</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      serviceAccountName: kube-state-metrics</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: kube-state-metrics</span><br><span class=\"line\">        image: quay.io/coreos/kube-state-metrics:v1.9.0</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 8080</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class=\"line\">  name: kube-state-metrics</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: kube-state-metrics</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kube-state-metrics</span><br><span class=\"line\">    </span><br><span class=\"line\">导入json</span><br><span class=\"line\">https://grafana.com/grafana/dashboards/?search=kubernetes</span><br></pre></td></tr></table></figure>\n<h2 id=\"alert-manager\"><a class=\"markdownIt-Anchor\" href=\"#alert-manager\">#</a> alert manager</h2>\n<h3 id=\"报警到qq邮箱\"><a class=\"markdownIt-Anchor\" href=\"#报警到qq邮箱\">#</a> 报警到 qq 邮箱</h3>\n<p>WYCMUCTTXLOBSVYS</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">alertmanager.yml:</span> <span class=\"string\">|-</span></span><br><span class=\"line\"><span class=\"string\">    global:</span></span><br><span class=\"line\"><span class=\"string\">      resolve_timeout: 1m</span></span><br><span class=\"line\"><span class=\"string\">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      smtp_from: &#x27;kbshire@163.com&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      smtp_auth_username: &#x27;kbshire@163.com&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      smtp_auth_password: &#x27;WYCMUCTTXLOBSVYS&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      smtp_require_tls: false</span></span><br><span class=\"line\"><span class=\"string\">    route:  #用于配置告警分发策略</span></span><br><span class=\"line\"><span class=\"string\">      group_by: [alertname] # 采用哪个标签来作为分组依据</span></span><br><span class=\"line\"><span class=\"string\">      group_wait: 10s       # 组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span></span><br><span class=\"line\"><span class=\"string\">      group_interval: 10s    # 上下两组发送告警的间隔时间</span></span><br><span class=\"line\"><span class=\"string\">      repeat_interval: 10m    # 重复发送告警的时间，减少相同邮件的发送频率，默认是1h</span></span><br><span class=\"line\"><span class=\"string\">      receiver: default-receiver  #定义谁来收告警</span></span><br><span class=\"line\"><span class=\"string\">    receivers:</span></span><br><span class=\"line\"><span class=\"string\">    - name: &#x27;default-receiver&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      email_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - to: &#x27;183108913@qq.com&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">报警处理流程如下：</span><br><span class=\"line\">1. Prometheus Server监控目标主机上暴露的http接口（这里假设接口A），通过Promethes配置的&#x27;scrape_interval&#x27;定义的时间间隔，定期采集目标主机上监控数据。</span><br><span class=\"line\">2. 当接口A不可用的时候，Server端会持续的尝试从接口中取数据，直到&quot;scrape_timeout&quot;时间后停止尝试。这时候把接口的状态变为“DOWN”。</span><br><span class=\"line\">3. Prometheus同时根据配置的&quot;evaluation_interval&quot;的时间间隔，定期（默认1min）的对Alert Rule进行评估；当到达评估周期的时候，发现接口A为DOWN，即UP=0为真，激活Alert，进入“PENDING”状态，并记录当前active的时间；</span><br><span class=\"line\">4. 当下一个alert rule的评估周期到来的时候，发现UP=0继续为真，然后判断警报Active的时间是否已经超出rule里的‘for’ 持续时间，如果未超出，则进入下一个评估周期；如果时间超出，则alert的状态变为“FIRING”；同时调用Alertmanager接口，发送相关报警数据。</span><br><span class=\"line\">5. AlertManager收到报警数据后，会将警报信息进行分组，然后根据alertmanager配置的“group_wait”时间先进行等待。等wait时间过后再发送报警信息。</span><br><span class=\"line\">6. 属于同一个Alert Group的警报，在等待的过程中可能进入新的alert，如果之前的报警已经成功发出，那么间隔“group_interval”的时间间隔后再重新发送报警信息。比如配置的是邮件报警，那么同属一个group的报警信息会汇总在一个邮件里进行发送。</span><br><span class=\"line\">7. 如果Alert Group里的警报一直没发生变化并且已经成功发送，等待‘repeat_interval’时间间隔之后再重复发送相同的报警邮件；如果之前的警报没有成功发送，则相当于触发第6条条件，则需要等待group_interval时间间隔后重复发送。</span><br><span class=\"line\"></span><br><span class=\"line\">同时最后至于警报信息具体发给谁，满足什么样的条件下指定警报接收人，设置不同报警发送频率，这里有alertmanager的route路由规则进行配置。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">prometheus.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    rule_files:</span></span><br><span class=\"line\"><span class=\"string\">    - /etc/prometheus/rules.yml</span></span><br><span class=\"line\"><span class=\"string\">    alerting:</span></span><br><span class=\"line\"><span class=\"string\">      alertmanagers:</span></span><br><span class=\"line\"><span class=\"string\">      - static_configs:</span></span><br><span class=\"line\"><span class=\"string\">        - targets: [&quot;localhost:9093&quot;]</span></span><br><span class=\"line\"><span class=\"string\">    global:</span></span><br><span class=\"line\"><span class=\"string\">      scrape_interval: 15s</span></span><br><span class=\"line\"><span class=\"string\">      scrape_timeout: 10s</span></span><br><span class=\"line\"><span class=\"string\">      evaluation_interval: 1m</span></span><br><span class=\"line\"><span class=\"string\">    scrape_configs:</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: node</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__address__]</span></span><br><span class=\"line\"><span class=\"string\">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role:  node</span></span><br><span class=\"line\"><span class=\"string\">      scheme: https</span></span><br><span class=\"line\"><span class=\"string\">      tls_config:</span></span><br><span class=\"line\"><span class=\"string\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">      - target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        replacement: kubernetes.default.svc:443</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class=\"line\"><span class=\"string\">        regex: (.+)</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __metrics_path__</span></span><br><span class=\"line\"><span class=\"string\">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: endpoints</span></span><br><span class=\"line\"><span class=\"string\">      scheme: https</span></span><br><span class=\"line\"><span class=\"string\">      tls_config:</span></span><br><span class=\"line\"><span class=\"string\">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class=\"line\"><span class=\"string\">        action: keep</span></span><br><span class=\"line\"><span class=\"string\">        regex: default;kubernetes;https</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: endpoints</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class=\"line\"><span class=\"string\">        action: keep</span></span><br><span class=\"line\"><span class=\"string\">        regex: true</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __scheme__</span></span><br><span class=\"line\"><span class=\"string\">        regex: (https?)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __metrics_path__</span></span><br><span class=\"line\"><span class=\"string\">        regex: (.+)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">        regex: ([^:]+)(?::\\d+)?;(\\d+)</span></span><br><span class=\"line\"><span class=\"string\">        replacement: $1:$2</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"string\">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class=\"line\"><span class=\"string\">        action: replace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_name </span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-pods&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      kubernetes_sd_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - role: pod</span></span><br><span class=\"line\"><span class=\"string\">      relabel_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - action: keep</span></span><br><span class=\"line\"><span class=\"string\">        regex: true</span></span><br><span class=\"line\"><span class=\"string\">        source_labels:</span></span><br><span class=\"line\"><span class=\"string\">        - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span><br><span class=\"line\"><span class=\"string\">      - action: replace</span></span><br><span class=\"line\"><span class=\"string\">        regex: (.+)</span></span><br><span class=\"line\"><span class=\"string\">        source_labels:</span></span><br><span class=\"line\"><span class=\"string\">        - __meta_kubernetes_pod_annotation_prometheus_io_path</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __metrics_path__</span></span><br><span class=\"line\"><span class=\"string\">      - action: replace</span></span><br><span class=\"line\"><span class=\"string\">        regex: ([^:]+)(?::\\d+)?;(\\d+)</span></span><br><span class=\"line\"><span class=\"string\">        replacement: $1:$2</span></span><br><span class=\"line\"><span class=\"string\">        source_labels:</span></span><br><span class=\"line\"><span class=\"string\">        - __address__</span></span><br><span class=\"line\"><span class=\"string\">        - __meta_kubernetes_pod_annotation_prometheus_io_port</span></span><br><span class=\"line\"><span class=\"string\">        target_label: __address__</span></span><br><span class=\"line\"><span class=\"string\">      - action: labelmap</span></span><br><span class=\"line\"><span class=\"string\">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class=\"line\"><span class=\"string\">      - action: replace</span></span><br><span class=\"line\"><span class=\"string\">        source_labels:</span></span><br><span class=\"line\"><span class=\"string\">        - __meta_kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_namespace</span></span><br><span class=\"line\"><span class=\"string\">      - action: replace</span></span><br><span class=\"line\"><span class=\"string\">        source_labels:</span></span><br><span class=\"line\"><span class=\"string\">        - __meta_kubernetes_pod_name</span></span><br><span class=\"line\"><span class=\"string\">        target_label: kubernetes_pod_name</span></span><br><span class=\"line\"><span class=\"string\">    - job_name: &#x27;kubernetes-etcd&#x27;</span></span><br><span class=\"line\"><span class=\"string\">      scheme: https</span></span><br><span class=\"line\"><span class=\"string\">      tls_config:</span></span><br><span class=\"line\"><span class=\"string\">        ca_file: /etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class=\"line\"><span class=\"string\">        cert_file: /etc/kubernetes/pki/etcd/server.crt</span></span><br><span class=\"line\"><span class=\"string\">        key_file: /etc/kubernetes/pki/etcd/server.key</span></span><br><span class=\"line\"><span class=\"string\">      scrape_interval: 5s</span></span><br><span class=\"line\"><span class=\"string\">      static_configs:</span></span><br><span class=\"line\"><span class=\"string\">      - targets: [&#x27;192.168.13.180:2379&#x27;]</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">rules.yml:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    groups:</span></span><br><span class=\"line\"><span class=\"string\">    - name: example</span></span><br><span class=\"line\"><span class=\"string\">      rules:</span></span><br><span class=\"line\"><span class=\"string\">      - alert: apiserver的cpu使用率大于80%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert:  apiserver的cpu使用率大于90%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: etcd的cpu使用率大于80%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert:  etcd的cpu使用率大于90%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-state-metrics的cpu使用率大于80%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;80%&quot;      </span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-state-metrics的cpu使用率大于90%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;90%&quot;      </span></span><br><span class=\"line\"><span class=\"string\">      - alert: coredns的cpu使用率大于80%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;80%&quot;      </span></span><br><span class=\"line\"><span class=\"string\">      - alert: coredns的cpu使用率大于90%</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;90%&quot;      </span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-proxy打开句柄数&gt;600</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-proxy打开句柄数&gt;1000</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-schedule打开句柄数&gt;600</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-schedule打开句柄数&gt;1000</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-controller-manager打开句柄数&gt;600</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-controller-manager打开句柄数&gt;1000</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-apiserver打开句柄数&gt;600</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-apiserver打开句柄数&gt;1000</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-etcd打开句柄数&gt;600</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-etcd打开句柄数&gt;1000</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: coredns</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 600</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning </span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过600&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: coredns</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-proxy</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: scheduler</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-controller-manager</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-apiserver</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kubernetes-etcd</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: kube-dns</span></span><br><span class=\"line\"><span class=\"string\">        expr: process_virtual_memory_bytes&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 2000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: HttpRequestsAvg</span></span><br><span class=\"line\"><span class=\"string\">        expr: sum(rate(rest_client_requests_total&#123;job=~&quot;kubernetes-kube-proxy|kubernetes-kubelet|kubernetes-schedule|kubernetes-control-manager|kubernetes-apiservers&quot;&#125;[1m]))  &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): TPS超过1000&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;1000&quot;   </span></span><br><span class=\"line\"><span class=\"string\">      - alert: Pod_restarts</span></span><br><span class=\"line\"><span class=\"string\">        expr: kube_pod_container_status_restarts_total&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; &gt; 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: warnning</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;在&#123;&#123;$labels.namespace&#125;&#125;名称空间下发现&#123;&#123;$labels.pod&#125;&#125;这个pod下的容器&#123;&#123;$labels.container&#125;&#125;被重启,这个监控指标是由&#123;&#123;$labels.instance&#125;&#125;采集的&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Pod_waiting</span></span><br><span class=\"line\"><span class=\"string\">        expr: kube_pod_container_status_waiting_reason&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;启动异常等待中&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;1&quot;   </span></span><br><span class=\"line\"><span class=\"string\">      - alert: Pod_terminated</span></span><br><span class=\"line\"><span class=\"string\">        expr: kube_pod_container_status_terminated_reason&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; == 1</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;被删除&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;1&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Etcd_leader</span></span><br><span class=\"line\"><span class=\"string\">        expr: etcd_server_has_leader&#123;job=&quot;kubernetes-etcd&quot;&#125; == 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前没有leader&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Etcd_leader_changes</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(etcd_server_leader_changes_seen_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前leader已发生改变&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Etcd_failed</span></span><br><span class=\"line\"><span class=\"string\">        expr: rate(etcd_server_proposals_failed_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 服务失败&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;0&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Etcd_db_total_size</span></span><br><span class=\"line\"><span class=\"string\">        expr: etcd_debugging_mvcc_db_total_size_in_bytes&#123;job=&quot;kubernetes-etcd&quot;&#125; &gt; 10000000000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;)：db空间超过10G&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;10G&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: Endpoint_ready</span></span><br><span class=\"line\"><span class=\"string\">        expr: kube_endpoint_address_not_ready&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          team: admin</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.endpoint&#125;&#125;不可用&quot;</span></span><br><span class=\"line\"><span class=\"string\">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">          threshold: &quot;1&quot;</span></span><br><span class=\"line\"><span class=\"string\">    - name: 物理节点状态-监控告警</span></span><br><span class=\"line\"><span class=\"string\">      rules:</span></span><br><span class=\"line\"><span class=\"string\">      - alert: 物理节点cpu使用率</span></span><br><span class=\"line\"><span class=\"string\">        expr: 100-avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by(instance)*100 &gt; 90</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: ccritical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;cpu使用率过高&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的cpu使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot; </span></span><br><span class=\"line\"><span class=\"string\">      - alert: 物理节点内存使用率</span></span><br><span class=\"line\"><span class=\"string\">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 90</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;内存使用率过高&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的内存使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: InstanceDown</span></span><br><span class=\"line\"><span class=\"string\">        expr: up == 0</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:   </span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器宕机&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器延时超过2分钟&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: 物理节点磁盘的IO性能</span></span><br><span class=\"line\"><span class=\"string\">        expr: 100-(avg(irate(node_disk_io_time_seconds_total[1m])) by(instance)* 100) &lt; 60</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入磁盘IO使用率过高！&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 流入磁盘IO大于60%(目前使用:&#123;&#123;$value&#125;&#125;)&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: 入网流量带宽</span></span><br><span class=\"line\"><span class=\"string\">        expr: ((sum(rate (node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入网络带宽过高！&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流入网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: 出网流量带宽</span></span><br><span class=\"line\"><span class=\"string\">        expr: ((sum(rate (node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流出网络带宽过高！&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流出网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: TCP会话</span></span><br><span class=\"line\"><span class=\"string\">        expr: node_netstat_Tcp_CurrEstab &gt; 1000</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; TCP_ESTABLISHED过高！&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; TCP_ESTABLISHED大于1000%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class=\"line\"><span class=\"string\">      - alert: 磁盘容量</span></span><br><span class=\"line\"><span class=\"string\">        expr: 100-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes &#123;fstype=~&quot;ext4|xfs&quot;&#125;*100) &gt; 80</span></span><br><span class=\"line\"><span class=\"string\">        for: 2s</span></span><br><span class=\"line\"><span class=\"string\">        labels:</span></span><br><span class=\"line\"><span class=\"string\">          severity: critical</span></span><br><span class=\"line\"><span class=\"string\">        annotations:</span></span><br><span class=\"line\"><span class=\"string\">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 磁盘分区使用率过高！&quot;</span></span><br><span class=\"line\"><span class=\"string\">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 磁盘分区使用大于80%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">-n</span> <span class=\"string\">monitor-sa</span> <span class=\"string\">create</span> <span class=\"string\">secret</span> <span class=\"string\">generic</span> <span class=\"string\">etcd-certs</span> <span class=\"string\">--from-file=/etc/kubernetes/pki/etcd/server.key</span>  <span class=\"string\">--from-file=/etc/kubernetes/pki/etcd/server.crt</span> <span class=\"string\">--from-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">prometheus-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">      <span class=\"attr\">component:</span> <span class=\"string\">server</span></span><br><span class=\"line\">    <span class=\"comment\">#matchExpressions:</span></span><br><span class=\"line\">    <span class=\"comment\">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class=\"line\">    <span class=\"comment\">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">component:</span> <span class=\"string\">server</span></span><br><span class=\"line\">      <span class=\"attr\">annotations:</span></span><br><span class=\"line\">        <span class=\"attr\">prometheus.io/scrape:</span> <span class=\"string\">&#x27;false&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"comment\">#nodeName: xianchaonode1</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">monitor</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">prom/prometheus</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;/bin/prometheus&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--web.enable-lifecycle&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9090</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/prometheus</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/prometheus/</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">prometheus-storage-volume</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">k8s-certs</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/run/secrets/kubernetes.io/k8s-certs/etcd/</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">prom/alertmanager</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--config.file=/etc/alertmanager/alertmanager.yml&quot;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&quot;--log.level=debug&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9093</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager-config</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/alertmanager</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager-storage</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/alertmanager</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">localtime</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/etc/localtime</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">          <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">prometheus-config</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prometheus-storage-volume</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">           <span class=\"attr\">path:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">           <span class=\"attr\">type:</span> <span class=\"string\">Directory</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">k8s-certs</span></span><br><span class=\"line\">          <span class=\"attr\">secret:</span></span><br><span class=\"line\">           <span class=\"attr\">secretName:</span> <span class=\"string\">etcd-certs</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager-config</span></span><br><span class=\"line\">          <span class=\"attr\">configMap:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager-storage</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">           <span class=\"attr\">path:</span> <span class=\"string\">/data/alertmanager</span></span><br><span class=\"line\">           <span class=\"attr\">type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">localtime</span></span><br><span class=\"line\">          <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">           <span class=\"attr\">path:</span> <span class=\"string\">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/cluster-service:</span> <span class=\"string\">&#x27;true&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">monitor-sa</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">alertmanager</span></span><br><span class=\"line\">    <span class=\"attr\">nodePort:</span> <span class=\"number\">30066</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">9093</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">9093</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">prometheus</span></span><br><span class=\"line\">  <span class=\"attr\">sessionAffinity:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 微信</span></span><br><span class=\"line\"><span class=\"attr\">receivers:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">&#x27;prometheus&#x27;</span></span><br><span class=\"line\">  <span class=\"attr\">wechat_configs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">corp_id:</span> <span class=\"string\">wwa82df90a693abb15</span></span><br><span class=\"line\">    <span class=\"attr\">to_user:</span> <span class=\"string\">&#x27;@all&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">agent_id:</span> <span class=\"number\">1000003</span></span><br><span class=\"line\">    <span class=\"attr\">api_secret:</span> <span class=\"string\">Ov5SWq_JqrolsOj6dD4Jg9qaMu1TTaDzVTCrXHcjlFs</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># 钉钉</span></span><br><span class=\"line\">  <span class=\"attr\">receivers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cluster1</span></span><br><span class=\"line\">      <span class=\"attr\">webhook_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">url:</span> <span class=\"string\">&#x27;http://192.168.40.180:8060/dingtalk/cluster1/send&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">send_resolved:</span> <span class=\"literal\">true</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"promql\"><a class=\"markdownIt-Anchor\" href=\"#promql\">#</a> <strong>PromQL</strong></h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">PromQL（Prometheus</span> <span class=\"string\">Query</span> <span class=\"string\">Language）是</span> <span class=\"string\">Prometheus</span> <span class=\"string\">自己开发的表达式语言，语言表现力很丰富，内置函数也很多。使用它可以对时序数据进行筛选和聚合。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">PromQL</span> <span class=\"string\">表达式计算出来的值有以下几种类型：</span></span><br><span class=\"line\"><span class=\"string\">瞬时向量</span> <span class=\"string\">(Instant</span> <span class=\"string\">vector):</span> <span class=\"string\">一组时序，每个时序只有一个采样值</span></span><br><span class=\"line\"><span class=\"string\">区间向量</span> <span class=\"string\">(Range</span> <span class=\"string\">vector):</span> <span class=\"string\">一组时序，每个时序包含一段时间内的多个采样值</span></span><br><span class=\"line\"><span class=\"string\">标量数据</span> <span class=\"string\">(Scalar):</span> <span class=\"string\">一个浮点数</span></span><br><span class=\"line\"><span class=\"string\">字符串</span> <span class=\"string\">(String):</span> <span class=\"string\">一个字符串，暂时未用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">瞬时向量选择器用来选择一组时序在某个采样点的采样值。</span></span><br><span class=\"line\"><span class=\"string\">最简单的情况就是指定一个度量指标，选择出所有属于该度量指标的时序的当前采样值。</span></span><br><span class=\"line\"><span class=\"string\">可以通过在后面添加用大括号包围起来的一组标签键值对来对时序进行过滤。比如下面的表达式筛选出了</span> <span class=\"string\">job</span> <span class=\"string\">为</span> <span class=\"string\">kubernetes-apiservers，并且</span> <span class=\"string\">resource为</span> <span class=\"string\">pod的时序：apiserver_request_total</span></span><br><span class=\"line\"><span class=\"string\">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span></span><br><span class=\"line\"><span class=\"string\">匹配标签值时可以是等于，也可以使用正则表达式。总共有下面几种匹配操作符：</span></span><br><span class=\"line\"><span class=\"string\">=：完全相等</span></span><br><span class=\"line\"><span class=\"type\">!=</span><span class=\"string\">：</span> <span class=\"string\">不相等</span></span><br><span class=\"line\"><span class=\"string\">=~：</span> <span class=\"string\">正则表达式匹配</span></span><br><span class=\"line\"><span class=\"type\">!~</span><span class=\"string\">：</span> <span class=\"string\">正则表达式不匹配</span></span><br><span class=\"line\"><span class=\"string\">下面的表达式筛选出了container是kube-scheduler或kube-proxy或kube-apiserver的时序数据</span></span><br><span class=\"line\"><span class=\"string\">container_processes&#123;container=~&quot;kube-scheduler|kube-proxy|kube-apiserver&quot;&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">区间向量选择器类似于瞬时向量选择器，不同的是它选择的是过去一段时间的采样值。可以通过在瞬时向量选择器后面添加包含在</span> [] <span class=\"string\">里的时长来得到区间向量选择器。比如下面的表达式选出了所有度量指标为apiserver_request_total且resource是pod的时序在过去1</span> <span class=\"string\">分钟的采样值。</span></span><br><span class=\"line\"><span class=\"string\">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;[1m]</span></span><br><span class=\"line\"><span class=\"string\">这个不支持Graph，需要选择Console，才会看到采集的数据</span></span><br><span class=\"line\"><span class=\"string\">说明：时长的单位可以是下面几种之一：</span></span><br><span class=\"line\"><span class=\"string\">s：seconds</span></span><br><span class=\"line\"><span class=\"string\">m：minutes</span></span><br><span class=\"line\"><span class=\"string\">h：hours</span></span><br><span class=\"line\"><span class=\"string\">d：days</span></span><br><span class=\"line\"><span class=\"string\">w：weeks</span></span><br><span class=\"line\"><span class=\"string\">y：years</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">偏移向量选择器</span></span><br><span class=\"line\"><span class=\"string\">前面介绍的选择器默认都是以当前时间为基准时间，偏移修饰器用来调整基准时间，使其往前偏移一段时间。偏移修饰器紧跟在选择器后面，使用</span> <span class=\"string\">offset</span> <span class=\"string\">来指定要偏移的量。比如下面的表达式选择度量名称为apiserver_request_total的所有时序在</span> <span class=\"number\">5</span> <span class=\"string\">分钟前的采样值。</span></span><br><span class=\"line\"><span class=\"string\">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> <span class=\"string\">offset</span> <span class=\"string\">5m</span></span><br><span class=\"line\"><span class=\"string\">下面的表达式选择apiserver_request_total</span> <span class=\"string\">度量指标在</span> <span class=\"number\">1</span> <span class=\"string\">周前的这个时间点过去</span> <span class=\"number\">5</span> <span class=\"string\">分钟的采样值。</span></span><br><span class=\"line\"><span class=\"string\">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> [<span class=\"string\">5m</span>] <span class=\"string\">offset</span> <span class=\"string\">1w</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">聚合操作符</span></span><br><span class=\"line\"><span class=\"string\">PromQL</span> <span class=\"string\">的聚合操作符用来将向量里的元素聚合得更少。总共有下面这些聚合操作符：</span></span><br><span class=\"line\"><span class=\"string\">sum：求和</span></span><br><span class=\"line\"><span class=\"string\">min：最小值</span></span><br><span class=\"line\"><span class=\"string\">max：最大值</span></span><br><span class=\"line\"><span class=\"string\">avg：平均值</span></span><br><span class=\"line\"><span class=\"string\">stddev：标准差</span></span><br><span class=\"line\"><span class=\"string\">stdvar：方差</span></span><br><span class=\"line\"><span class=\"string\">count：元素个数</span></span><br><span class=\"line\"><span class=\"string\">count_values：等于某值的元素个数</span></span><br><span class=\"line\"><span class=\"string\">bottomk：最小的</span> <span class=\"string\">k</span> <span class=\"string\">个元素</span></span><br><span class=\"line\"><span class=\"string\">topk：最大的</span> <span class=\"string\">k</span> <span class=\"string\">个元素</span></span><br><span class=\"line\"><span class=\"string\">quantile：分位数</span></span><br><span class=\"line\"><span class=\"string\">计算haha节点所有容器总计内存</span></span><br><span class=\"line\"><span class=\"string\">sum(container_memory_usage_bytes&#123;instance=~&quot;haha&quot;&#125;)/1024/1024/1024</span></span><br><span class=\"line\"><span class=\"string\">计算haha节点最近1m所有容器cpu使用率</span></span><br><span class=\"line\"><span class=\"string\">sum</span> <span class=\"string\">(rate</span> <span class=\"string\">(container_cpu_usage_seconds_total&#123;instance=~&quot;haha&quot;&#125;[1m]))</span> <span class=\"string\">/</span> <span class=\"string\">sum</span> <span class=\"string\">(machine_cpu_cores&#123;</span> <span class=\"string\">instance</span> <span class=\"string\">=~&quot;haha&quot;&#125;)</span> <span class=\"string\">*</span> <span class=\"number\">100</span></span><br><span class=\"line\"><span class=\"string\">计算最近1m所有容器cpu使用率</span></span><br><span class=\"line\"><span class=\"string\">sum</span> <span class=\"string\">(rate</span> <span class=\"string\">(container_cpu_usage_seconds_total&#123;id!=&quot;/&quot;&#125;[1m]))</span> <span class=\"string\">by</span> <span class=\"string\">(id)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">函数</span></span><br><span class=\"line\"><span class=\"string\">Prometheus</span> <span class=\"string\">内置了一些函数来辅助计算，下面介绍一些典型的。</span></span><br><span class=\"line\"><span class=\"string\">abs()：绝对值</span></span><br><span class=\"line\"><span class=\"string\">sqrt()：平方根</span></span><br><span class=\"line\"><span class=\"string\">exp()：指数计算</span></span><br><span class=\"line\"><span class=\"string\">ln()：自然对数</span></span><br><span class=\"line\"><span class=\"string\">ceil()：向上取整</span></span><br><span class=\"line\"><span class=\"string\">floor()：向下取整</span></span><br><span class=\"line\"><span class=\"string\">round()：四舍五入取整</span></span><br><span class=\"line\"><span class=\"string\">delta()：计算区间向量里每一个时序第一个和最后一个的差值</span></span><br><span class=\"line\"><span class=\"string\">sort()：排序</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus-监控tomcat\"><a class=\"markdownIt-Anchor\" href=\"#prometheus-监控tomcat\">#</a> prometheus 监控 tomcat</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL25saWdodGVuL3RvbWNhdF9leHBvcnRlcg==\">nlighten/tomcat_exporter: A Prometheus exporter for Apache Tomcat (github.com)</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">下面在k8s-master节点操作</span><br><span class=\"line\">（1）制作tomcat镜像，按如下步骤</span><br><span class=\"line\">mkdir /root/tomcat_image</span><br><span class=\"line\">把上面的war包和jar包传到这个目录下</span><br><span class=\"line\">cat Dockerfile</span><br><span class=\"line\">FROM tomcat:8.5-jdk8-corretto</span><br><span class=\"line\">ADD metrics.war /usr/local/tomcat/webapps/</span><br><span class=\"line\">ADD simpleclient-0.8.0.jar  /usr/local/tomcat/lib/</span><br><span class=\"line\">ADD simpleclient_common-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class=\"line\">ADD simpleclient_hotspot-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class=\"line\">ADD simpleclient_servlet-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class=\"line\">ADD tomcat_exporter_client-0.0.12.jar /usr/local/tomcat/lib/</span><br><span class=\"line\"></span><br><span class=\"line\">docker build -t=&#x27;/tomcat_prometheus:v1&#x27; .</span><br><span class=\"line\">docker login</span><br><span class=\"line\">  username：xianchao</span><br><span class=\"line\">  password：1989317**</span><br><span class=\"line\">docker push xianchao/tomcat_prometheus:v1 #上传镜像到hub仓库</span><br><span class=\"line\">docker pull xianchao/tomcat_prometheus:v1  #在k8s的node节点拉取镜像拉取镜像</span><br><span class=\"line\"></span><br><span class=\"line\">（2）基于上面的镜像创建一个tomcat实例</span><br><span class=\"line\">cat deploy.yaml</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tomcat-deployment</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector: </span><br><span class=\"line\">    matchLabels: </span><br><span class=\"line\">     app: tomcat</span><br><span class=\"line\">  replicas: 2 # tells deployment to run 2 pods matching the template</span><br><span class=\"line\">  template: # create pods using pod definition in this template</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: tomcat</span><br><span class=\"line\">      annotations:</span><br><span class=\"line\">        prometheus.io/scrape: &#x27;true&#x27;</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: tomcat</span><br><span class=\"line\">        image: xianchao/tomcat_prometheus:v1</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 8080</span><br><span class=\"line\">        securityContext: </span><br><span class=\"line\">          privileged: true</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f deploy.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">创建一个service，可操作也可不操作</span><br><span class=\"line\"> cat tomcat-service.yaml</span><br><span class=\"line\">kind: Service  #service 类型</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">#  annotations:</span><br><span class=\"line\">#    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class=\"line\">  name: tomcat-service</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: tomcat</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - nodePort: 31360</span><br><span class=\"line\">    port: 80</span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 8080</span><br><span class=\"line\">  type: NodePort</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f tomcat-service.yaml </span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus-监控-redis\"><a class=\"markdownIt-Anchor\" href=\"#prometheus-监控-redis\">#</a> prometheus 监控 redis</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">redis.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">redis:4</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">100Mi</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis-exporter</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">oliver006/redis_exporter:latest</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">100Mi</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9121</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">prometheus.io/scrape:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">prometheus.io/port:</span> <span class=\"string\">&quot;9121&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">prom</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">9121</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">9121</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span>  <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">redis.yaml</span></span><br><span class=\"line\"><span class=\"string\">redis</span> <span class=\"string\">这个</span> <span class=\"string\">Pod</span> <span class=\"string\">中包含了两个容器，一个就是</span> <span class=\"string\">redis</span> <span class=\"string\">本身的主应用，另外一个容器就是</span> <span class=\"string\">redis_exporter</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">由于Redis服务的metrics接口在redis-exporter</span> <span class=\"number\">9121</span><span class=\"string\">上，所以我们添加了prometheus.io/port=9121这样的annotation,在prometheus就会自动发现redis了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">接下来我们刷新一下Redis的Service配置</span></span><br><span class=\"line\">[<span class=\"string\">root@abcdocker</span> <span class=\"string\">prometheus</span>]<span class=\"comment\"># kubectl apply -f  redis.yaml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus-监控mysql\"><a class=\"markdownIt-Anchor\" href=\"#prometheus-监控mysql\">#</a> prometheus 监控 mysql</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">mysql</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">mariadb</span>  <span class=\"string\">-y</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tar</span> <span class=\"string\">-xvf</span> <span class=\"string\">mysqld_exporter-0.10.0.linux-amd64.tar.gz</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class=\"line\"><span class=\"string\">cp</span> <span class=\"string\">-ar</span> <span class=\"string\">mysqld_exporter</span> <span class=\"string\">/usr/local/bin/</span></span><br><span class=\"line\"><span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/usr/local/bin/mysqld_exporter</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">.登陆mysql为mysql_exporter创建账号并授权</span></span><br><span class=\"line\"><span class=\"comment\"># 创建数据库用户。</span></span><br><span class=\"line\"><span class=\"string\">mysql&gt;</span> <span class=\"string\">CREATE</span> <span class=\"string\">USER</span> <span class=\"string\">&#x27;mysql_exporter&#x27;</span><span class=\"string\">@&#x27;localhost&#x27;</span> <span class=\"string\">IDENTIFIED</span> <span class=\"string\">BY</span> <span class=\"string\">&#x27;Abcdef123!.&#x27;</span><span class=\"string\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对mysql_exporter用户授权</span></span><br><span class=\"line\"><span class=\"string\">mysql&gt;</span> <span class=\"string\">GRANT</span> <span class=\"string\">PROCESS,</span> <span class=\"string\">REPLICATION</span> <span class=\"string\">CLIENT,</span> <span class=\"string\">SELECT</span> <span class=\"string\">ON</span> <span class=\"string\">*.*</span> <span class=\"string\">TO</span> <span class=\"string\">&#x27;mysql_exporter&#x27;</span><span class=\"string\">@&#x27;localhost&#x27;;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">.创建mysql配置文件、运行时可免密码连接数据库：</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">my.cnf</span></span><br><span class=\"line\">[<span class=\"string\">client</span>]</span><br><span class=\"line\"><span class=\"string\">user=mysql_exporter</span></span><br><span class=\"line\"><span class=\"string\">password=Abcdef123!.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">nohup</span> <span class=\"string\">./mysqld_exporter</span> <span class=\"string\">--config.my-cnf=./my.cnf</span> <span class=\"string\">&amp;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5</span><span class=\"string\">.修改prometheus-alertmanager-cfg.yaml文件，添加如下</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;mysql&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;192.168.40.180:9104&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-alertmanager-cfg.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-alertmanager-deploy.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-alertmanager-deploy.yaml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prothemeus监控nginx\"><a class=\"markdownIt-Anchor\" href=\"#prothemeus监控nginx\">#</a> Prothemeus 监控 nginx</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">unzip</span> <span class=\"string\">nginx-module-vts-master.zip</span></span><br><span class=\"line\"><span class=\"string\">mv</span> <span class=\"string\">nginx-module-vts-master</span> <span class=\"string\">/usr/local/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">tar</span> <span class=\"string\">zxvf</span> <span class=\"string\">nginx-1.15.7.tar.gz</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">nginx-1.15.7</span></span><br><span class=\"line\"><span class=\"string\">./configure</span>  <span class=\"string\">--prefix=/usr/local/nginx</span> <span class=\"string\">--with-http_gzip_static_module</span> <span class=\"string\">--with-http_stub_status_module</span> <span class=\"string\">--with-http_ssl_module</span> <span class=\"string\">--with-pcre</span> <span class=\"string\">--with-file-aio</span> <span class=\"string\">--with-http_realip_module</span> <span class=\"string\">--add-module=/usr/local/nginx-module-vts-master</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">make</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">make</span> <span class=\"string\">install</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">修改nginx配置文件：</span></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">/usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"string\">server下添加如下：</span></span><br><span class=\"line\"><span class=\"string\">location</span> <span class=\"string\">/status</span> &#123;</span><br><span class=\"line\">        <span class=\"string\">vhost_traffic_status_display;</span></span><br><span class=\"line\">        <span class=\"string\">vhost_traffic_status_display_format</span> <span class=\"string\">html;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"><span class=\"string\">http中添加如下：</span></span><br><span class=\"line\"><span class=\"string\">vhost_traffic_status_zone;</span></span><br><span class=\"line\"><span class=\"string\">nginx</span> <span class=\"string\">-s</span> <span class=\"string\">reload</span></span><br><span class=\"line\"><span class=\"string\">访问192.168.124.16/status可以看到nginx监控数据</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">.安装nginx-vts-exporter</span></span><br><span class=\"line\"><span class=\"string\">unzip</span>  <span class=\"string\">nginx-vts-exporter-0.5.zip</span></span><br><span class=\"line\"><span class=\"string\">mv</span> <span class=\"string\">nginx-vts-exporter-0.5</span>  <span class=\"string\">/usr/local/</span></span><br><span class=\"line\"><span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">/usr/local/nginx-vts-exporter-0.5/bin/nginx-vts-exporter</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/usr/local/nginx-vts-exporter-0.5/bin</span></span><br><span class=\"line\"><span class=\"string\">nohup</span> <span class=\"string\">./nginx-vts-exporter</span>  <span class=\"string\">-nginx.scrape_uri</span> <span class=\"string\">http://192.168.124.16/status/format/json</span> <span class=\"string\">&amp;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">.修改prometheus-cfg.yaml文件</span></span><br><span class=\"line\"><span class=\"string\">添加如下job：</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">job_name:</span> <span class=\"string\">&#x27;nginx&#x27;</span></span><br><span class=\"line\">      <span class=\"attr\">scrape_interval:</span> <span class=\"string\">5s</span></span><br><span class=\"line\">      <span class=\"attr\">static_configs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">targets:</span> [<span class=\"string\">&#x27;192.168.124.16:9913&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-cfg.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-deploy.yaml</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"prometheus-监控-mongodb\"><a class=\"markdownIt-Anchor\" href=\"#prometheus-监控-mongodb\">#</a> prometheus 监控 mongodb</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.下载mongodb和mongodb_exporter镜像</span><br><span class=\"line\">docker pull mongo</span><br><span class=\"line\">docker pull eses/mongodb_exporter</span><br><span class=\"line\"></span><br><span class=\"line\">2.启动mongodb</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /data/db</span><br><span class=\"line\">docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db mongo</span><br><span class=\"line\"><span class=\"comment\">#创建mongo账号密码，给mongodb_exporter连接mongo用</span></span><br><span class=\"line\">（1）登录到容器</span><br><span class=\"line\">docker <span class=\"built_in\">exec</span> -it 24f910190790ade396844cef61cc66412b7af2108494742922c6157c5b236aac mongo admin</span><br><span class=\"line\">（2）设置密码</span><br><span class=\"line\">use admin</span><br><span class=\"line\">db.createUser(&#123; user: <span class=\"string\">&#x27;admin&#x27;</span>, <span class=\"built_in\">pwd</span>: <span class=\"string\">&#x27;admin111111&#x27;</span>, roles: [ &#123; role: <span class=\"string\">&quot;userAdminAnyDatabase&quot;</span>, db: <span class=\"string\">&quot;admin&quot;</span> &#125; ] &#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d --name mongodb_exporter -p 30056:9104  percona/mongodb_exporter:0.34.0   --mongodb.uri mongodb://admin:admin111111@192.168.124.16:27017</span><br><span class=\"line\"></span><br><span class=\"line\">注：admin:admin111111这个就是上面启动mongodb后设置的密码，@后面接mongodb的ip和端口</span><br><span class=\"line\"></span><br><span class=\"line\">4.修改prometheus-cfg.yaml文件</span><br><span class=\"line\">添加一个job_name</span><br><span class=\"line\">- job_name: <span class=\"string\">&#x27;mongodb&#x27;</span></span><br><span class=\"line\">  scrape_interval: 5s</span><br><span class=\"line\">  static_configs:</span><br><span class=\"line\">  - targets: [<span class=\"string\">&#x27;192.168.124.16:30056&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f prometheus-cfg.yaml</span><br><span class=\"line\">kubectl delete -f prometheus-deploy.yaml</span><br><span class=\"line\">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"pushgateway\"><a class=\"markdownIt-Anchor\" href=\"#pushgateway\">#</a> pushgateway</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Pushgateway是prometheus的一个组件，prometheus server默认是通过exporter主动获取数据（默认采取pull拉取数据），pushgateway则是通过被动方式推送数据到prometheus server，用户可以写一些自定义的监控脚本把需要监控的数据发送给pushgateway， 然后pushgateway再把数据发送给Prometheus server</span><br><span class=\"line\"></span><br><span class=\"line\">Pushgateway优点：</span><br><span class=\"line\">Prometheus 默认采用定时pull 模式拉取targets数据，但是如果不在一个子网或者防火墙，prometheus就拉取不到targets数据，所以可以采用各个target往pushgateway上push数据，然后prometheus去pushgateway上定时pull数据</span><br><span class=\"line\">在监控业务数据的时候，需要将不同数据汇总, 汇总之后的数据可以由pushgateway统一收集，然后由 Prometheus 统一拉取。</span><br><span class=\"line\"></span><br><span class=\"line\">pushgateway缺点：</span><br><span class=\"line\">Prometheus拉取状态只针对 pushgateway, 不能对每个节点都有效；</span><br><span class=\"line\">Pushgateway出现问题，整个采集到的数据都会出现问题</span><br><span class=\"line\">监控下线，prometheus还会拉取到旧的监控数据，需要手动清理 pushgateway不要的数据。</span><br><span class=\"line\"></span><br><span class=\"line\">docker push prom/pushgateway</span><br><span class=\"line\">docker run -d --name pushgateway -p 9091:9091 prom/pushgateway</span><br><span class=\"line\"></span><br><span class=\"line\">    - job_name: <span class=\"string\">&#x27;pushgateway&#x27;</span></span><br><span class=\"line\">      scrape_interval: 5s</span><br><span class=\"line\">      static_configs:</span><br><span class=\"line\">      - targets: [<span class=\"string\">&#x27;192.168.13.181:9091&#x27;</span>]</span><br><span class=\"line\">      honor_labels: <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl apply -f prometheus-cfg.yaml</span><br><span class=\"line\">kubectl delete -f prometheus-deploy.yaml</span><br><span class=\"line\">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230529153332021.png\" alt=\"image-20230529153332021\"></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">推送指定的数据格式到pushgateway</span><br><span class=\"line\"></span><br><span class=\"line\">向 &#123;job=<span class=\"string\">&quot;test_job&quot;</span>&#125; 添加单条数据：</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot; metric 3.6&quot;</span> | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job</span><br><span class=\"line\"></span><br><span class=\"line\">添加复杂数据</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span></span><br><span class=\"line\"><span class=\"string\">node_memory_usage 36</span></span><br><span class=\"line\"><span class=\"string\">node_memory_total 36000</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\">删除某个组下某个实例的所有数据</span><br><span class=\"line\">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span><br><span class=\"line\"></span><br><span class=\"line\">删除某个组下的所有数据：</span><br><span class=\"line\">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">把数据上报到pushgateway</span><br><span class=\"line\">在被监控服务所在的机器配置数据上报,想要把192.168.13.181这个机器的内存数据上报到pushgateway，下面步骤需要在192.168.40.181操作</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> push.sh</span><br><span class=\"line\"></span><br><span class=\"line\">node_memory_usages=$(free -m | grep Mem | awk <span class=\"string\">&#x27;&#123;print $3/$2*100&#125;&#x27;</span>)</span><br><span class=\"line\">job_name=<span class=\"string\">&quot;memory&quot;</span></span><br><span class=\"line\">instance_name=<span class=\"string\">&quot;192.168.13.181&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/$job_name/instance/$instance_name</span></span><br><span class=\"line\"><span class=\"string\">node_memory_usages $node_memory_usages</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sh push.sh</span><br><span class=\"line\"></span><br><span class=\"line\">crontab -u root -e</span><br><span class=\"line\">*/1 * * * * /root/push.sh</span><br><span class=\"line\"></span><br><span class=\"line\">注意：从上面配置可以看到，我们上传到pushgateway中的数据有job也有instance，而prometheus配置pushgateway这个job_name中也有job和instance，这个job和instance是指pushgateway实例本身，添加 honor_labels: <span class=\"literal\">true</span> 参数， 可以避免promethues的targets列表中的job_name是pushgateway的 job 、instance 和上报到pushgateway数据的job和instance冲突。</span><br></pre></td></tr></table></figure>\n<h2 id=\"elk\"><a class=\"markdownIt-Anchor\" href=\"#elk\">#</a> ELK</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">日志打印的常见级别：</span><br><span class=\"line\">日志打印通常有四种级别，从高到底分别是：ERROR、WARN、INFO、DEBUG。</span><br><span class=\"line\"></span><br><span class=\"line\">在你的系统中如果开启了某一级别的日志后，就不会打印比它级别低的日志。例如，程序如果开启了INFO级别日志，DEBUG日志就不会打印，通常在生产环境中开启INFO日志。</span><br><span class=\"line\"></span><br><span class=\"line\">1、DEBUG：</span><br><span class=\"line\">DEBU可以打印出最详细的日志信息，主要用于开发过程中打印一些运行信息。</span><br><span class=\"line\">2、INFO：</span><br><span class=\"line\">INFO可以打印一些你感兴趣的或者重要的信息，这个可以用于生产环境中输出程序运行的一些重要信息，但是不能滥用，避免打印过多的日志。</span><br><span class=\"line\">3、WARNING： </span><br><span class=\"line\">WARNING 表明发生了一些暂时不影响运行的错误，会出现潜在错误的情形，有些信息不是错误信息，但是也要给程序员的一些提示 </span><br><span class=\"line\">4、ERROR：</span><br><span class=\"line\">ERROR 可以打印错误和异常信息，如果不想输出太多的日志，可以使用这个级别，这一级就是比较重要的错误了，软件的某些功能已经不能继续执行了。</span><br><span class=\"line\"></span><br><span class=\"line\">通过查看INFO日志发现是由于自己操作失误，造成了程序结果和预期不符合，这种情况不是程序出错，所以并不是bug，不需要开发人员到场。</span><br><span class=\"line\">通过查看INFO日志发现自己的操作正确，根据INFO日志查看并不是操作失误造成，这个时候就需要开发人员到场确认。</span><br><span class=\"line\"></span><br><span class=\"line\">ERROR和WARN的级别都比INFO要高，所以在设定日志级别在INFO时，这两者的日志也会被打印。根据上面INFO和DEBUG级别的区别以及适用人员可以知道，ERROR和WARN是同时给测试和开发、运维观察的。WARN级别称之为“警告”，这个“警告”实际上就有点含糊了，它不算错，你可以选择忽视它，但也可以选择重视它。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">常见的日志收集方案</span><br><span class=\"line\">EFK</span><br><span class=\"line\">在Kubernetes集群上运行多个服务和应用程序时，日志收集系统可以帮助你快速分类和分析由Pod生成的大量日志数据。Kubernetes中比较流行的日志收集解决方案是Elasticsearch、Fluentd和Kibana（EFK）技术栈，也是官方推荐的一种方案。</span><br><span class=\"line\"></span><br><span class=\"line\">Elasticsearch是一个实时的，分布式的，可扩展的搜索引擎，它允许进行全文本和结构化搜索以及对日志进行分析。它通常用于索引和搜索大量日志数据，也可以用于搜索许多不同种类的文档。</span><br><span class=\"line\"></span><br><span class=\"line\">Elasticsearch通常与Kibana一起部署，kibana可以把Elasticsearch采集到的数据通过dashboard（仪表板）可视化展示出来。Kibana允许你通过Web界面浏览Elasticsearch日志数据，也可自定义查询条件快速检索出elasticccsearch中的日志数据。</span><br><span class=\"line\"></span><br><span class=\"line\">Fluentd是一个流行的开源数据收集器，我们在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</span><br><span class=\"line\"></span><br><span class=\"line\">ELK</span><br><span class=\"line\">E - Elasticsearch（简称：ES）</span><br><span class=\"line\">L - Logstash</span><br><span class=\"line\">K - Kibana</span><br><span class=\"line\">Elasticsearch：日志存储和搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</span><br><span class=\"line\"></span><br><span class=\"line\">Logstash：是一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作。）。</span><br><span class=\"line\"></span><br><span class=\"line\">Kibana 也是一个开源和免费的工具，Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ELK+filebeat</span><br><span class=\"line\">Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class=\"line\"></span><br><span class=\"line\">2.4 其他方案</span><br><span class=\"line\">ELK日志流程可以有多种方案（不同组件可自由组合，根据自身业务配置），常见有以下：</span><br><span class=\"line\"></span><br><span class=\"line\">    Logstash（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class=\"line\">    Logstash（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class=\"line\">    Filebeat（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class=\"line\">    Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class=\"line\">Filebeat（采集）—&gt; Kafka/Redis(消峰) —&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br></pre></td></tr></table></figure>\n<h3 id=\"efk组件\"><a class=\"markdownIt-Anchor\" href=\"#efk组件\">#</a> efk 组件</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Elasticsearch 是一个分布式的免费开源搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。</span><br><span class=\"line\">Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。</span><br><span class=\"line\">人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana），目前 Elastic Stack 包括一系列丰富的轻量型数据采集代理，这些代理统称为 Beats，可用来向 Elasticsearch 发送数据。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">filebeat是Beats中的一员。</span><br><span class=\"line\">　　Beats是一个轻量级日志采集器，Beats家族有6个成员，早期的ELK架构中使用Logstash收集、解析日志，但是Logstash对内存、cpu、io等资源消耗比较高。相比Logstash，Beats所占系统的CPU和内存几乎可以忽略不计。</span><br><span class=\"line\"></span><br><span class=\"line\">目前Beats包含六种工具：</span><br><span class=\"line\">1、Packetbeat：网络数据（收集网络流量数据）</span><br><span class=\"line\">2、Metricbeat：指标（收集系统、进程和文件系统级别的CPU和内存使用情况等数据）</span><br><span class=\"line\">3、Filebeat：日志文件（收集文件数据）</span><br><span class=\"line\">4、Winlogbeat：windows事件日志（收集Windows事件日志数据）</span><br><span class=\"line\">5、Auditbeat：审计数据（收集审计日志）</span><br><span class=\"line\">6、Heartbeat：运行时间监控（收集系统运行时的数据）</span><br><span class=\"line\"></span><br><span class=\"line\">Filebeat是用于转发和收集日志数据的轻量级传送工具。Filebeat监视你指定的日志文件或位置，收集日志事件，并将它们转发到Elasticsearch或 Logstash中。</span><br><span class=\"line\">Filebeat的工作方式如下：启动Filebeat时，它将启动一个或多个输入，这些输入将在为日志数据指定的位置中查找。对于Filebeat所找到的每个日志，Filebeat都会启动收集器。每个收集器都读取单个日志以获取新内容，并将新日志数据发送到libbeat，libbeat将聚集事件，并将聚集的数据发送到为Filebeat配置的输出。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530142835668.png\" alt=\"image-20230530142835668\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Filebeat 有两个主要组件：</span><br><span class=\"line\">    harvester：一个harvester负责读取一个单个文件的内容。harvester逐行读取每个文件，并把这些内容发送到输出。每个文件启动一个harvester。</span><br><span class=\"line\">    Input：一个input负责管理harvesters，并找到所有要读取的源。如果input类型是log，则input查找驱动器上与已定义的log日志路径匹配的所有文件，并为每个文件启动一个harvester。</span><br><span class=\"line\">    </span><br><span class=\"line\">Filebeat工作原理</span><br><span class=\"line\">在任何环境下，应用程序都有停机的可能性。 Filebeat 读取并转发日志行，如果中断，则会记住所有事件恢复联机状态时所在位置。</span><br><span class=\"line\">Filebeat带有内部模块（auditd，Apache，Nginx，System和MySQL），可通过一个指定命令来简化通用日志格式的收集，解析和可视化。</span><br><span class=\"line\">FileBeat 不会让你的管道超负荷。FileBeat 如果是向 Logstash 传输数据，当 Logstash 忙于处理数据，会通知 FileBeat 放慢读取速度。一旦拥塞得到解决，FileBeat将恢复到原来的速度并继续传播。</span><br><span class=\"line\">Filebeat保持每个文件的状态，并经常刷新注册表文件中的磁盘状态。状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。Filebeat将每个事件的传递状态存储在注册表文件中。所以它能保证事件至少传递一次到配置的输出，没有数据丢失。</span><br><span class=\"line\"></span><br><span class=\"line\">传输方案</span><br><span class=\"line\">1、output.elasticsearch</span><br><span class=\"line\">如果你希望使用 filebeat 直接向 elasticsearch 输出数据，需要配置 output.elasticsearch</span><br><span class=\"line\">output.elasticsearch:</span><br><span class=\"line\">  hosts: [&quot;192.168.40.180:9200&quot;]</span><br><span class=\"line\">2、output.logstash</span><br><span class=\"line\">如果使用filebeat向 logstash输出数据，然后由 logstash 再向elasticsearch 输出数据，需要配置 output.logstash。 logstash 和 filebeat 一起工作时，如果 logstash 忙于处理数据，会通知FileBeat放慢读取速度。一旦拥塞得到解决，FileBeat 将恢复到原来的速度并继续传播。这样，可以减少管道超负荷的情况。</span><br><span class=\"line\">output.logstash:</span><br><span class=\"line\">  hosts: [&quot;192.168.40.180:5044&quot;]  </span><br><span class=\"line\">  </span><br><span class=\"line\">3、output.kafka</span><br><span class=\"line\">如果使用filebeat向kafka输出数据，然后由 logstash 作为消费者拉取kafka中的日志，并再向elasticsearch 输出数据，需要配置 output.logstash</span><br><span class=\"line\">output.kafka:</span><br><span class=\"line\">  enabled: true</span><br><span class=\"line\">  hosts: [&quot;192.168.40.180:9092&quot;]</span><br><span class=\"line\">  topic: elfk8stest</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">logstash组件介绍</span><br><span class=\"line\">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。Logstash 是一个应用程序日志、事件的传输、处理、管理和搜索的平台。你可以用它来统一对应用程序日志进行收集管理，提供 Web 接口用于查询和统计。</span><br><span class=\"line\">输入：采集各种样式、大小和来源的数据</span><br><span class=\"line\">数据往往以各种各样的形式，或分散或集中地存在于很多系统中。Logstash 支持各种输入选择 ，可以在同一时间从众多常用来源捕捉事件。能够以连续的流式传输方式，轻松地从你的日志、指标、Web 应用、数据存储以及各种 AWS 服务采集数据。</span><br><span class=\"line\"></span><br><span class=\"line\">过滤器：实时解析和转换数据</span><br><span class=\"line\">数据从源传输到存储库的过程中，Logstash 过滤器能够解析各个事件，识别已命名的字段以构建结构，并将它们转换成通用格式，以便更轻松、更快速地分析和实现商业价值。</span><br><span class=\"line\">Logstash 能够动态地转换和解析数据，不受格式或复杂度的影响：</span><br><span class=\"line\">1、利用 Grok 从非结构化数据中派生出结构</span><br><span class=\"line\">2、从 IP 地址破译出地理坐标</span><br><span class=\"line\">3、将 PII 数据匿名化，完全排除敏感字段</span><br><span class=\"line\">4、整体处理不受数据源、格式或架构的影响</span><br><span class=\"line\"></span><br><span class=\"line\">输出：选择你的存储，导出你的数据</span><br><span class=\"line\">尽管 Elasticsearch 是我们的首选输出方向，能够为我们的搜索和分析带来无限可能，但它并非唯一选择。Logstash 提供众多输出选择，你可以将数据发送到你要指定的地方。 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530143914957.png\" alt=\"image-20230530143914957\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Logstash 有两个必要元素：input 和 output ，一个可选元素：filter。 这三个元素，分别代表 Logstash 事件处理的三个阶段：输入 &gt; 过滤器 &gt; 输出</span><br><span class=\"line\"></span><br><span class=\"line\">Input负责从数据源采集数据。</span><br><span class=\"line\">filter 将数据修改为你指定的格式或内容。</span><br><span class=\"line\">output 将数据传输到目的地。</span><br><span class=\"line\"></span><br><span class=\"line\">在实际应用场景中，通常输入、输出、过滤器不止一个。Logstash 的这三个元素都使用插件式管理方式，可以根据应用需要，灵活的选用各阶段需要的插件，并组合使用。</span><br><span class=\"line\"></span><br><span class=\"line\">常用input模块</span><br><span class=\"line\">    file：从文件系统上的文件读取</span><br><span class=\"line\">    syslog：在众所周知的端口514上侦听系统日志消息，并根据RFC3164格式进行解析</span><br><span class=\"line\">    redis：从redis服务器读取，使用redis通道和redis列表。 Redis经常用作集中式Logstash安装中的“代理”，它将接收来自远程Logstash“托运人”的Logstash事件排队。</span><br><span class=\"line\">    beats：处理由Filebeat发送的事件。</span><br><span class=\"line\"></span><br><span class=\"line\">常用的filter模块</span><br><span class=\"line\">    过滤器是Logstash管道中的中间处理设备。可以将条件过滤器组合在一起，对事件执行操作。</span><br><span class=\"line\">    grok：解析和结构任意文本。 Grok目前是Logstash中将非结构化日志数据解析为结构化和可查询的最佳方法。</span><br><span class=\"line\">    mutate：对事件字段执行一般转换。可以重命名，删除，替换和修改事件中的字段。</span><br><span class=\"line\">    drop：完全放弃一个事件，例如调试事件。</span><br><span class=\"line\">    clone：制作一个事件的副本，可能会添加或删除字段。</span><br><span class=\"line\">    geoip：添加有关IP地址的地理位置的信息</span><br><span class=\"line\"></span><br><span class=\"line\">常用output</span><br><span class=\"line\">    elasticsearch：将事件数据发送给 Elasticsearch（推荐模式）。</span><br><span class=\"line\">    file：将事件数据写入文件或磁盘。</span><br><span class=\"line\">    graphite：将事件数据发送给 graphite（一个流行的开源工具，存储和绘制指标， http://graphite.readthedocs.io/en/latest/）。</span><br><span class=\"line\">    statsd：将事件数据发送到 statsd （这是一种侦听统计数据的服务，如计数器和定时器，通过UDP发送并将聚合发送到一个或多个可插入的后端服务）。</span><br><span class=\"line\">    </span><br><span class=\"line\">input &#123;</span><br><span class=\"line\">      kafka &#123;</span><br><span class=\"line\">        bootstrap_servers =&gt; &quot;192.168.40.180:9092&quot;</span><br><span class=\"line\">        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class=\"line\">        consumer_threads =&gt; 5</span><br><span class=\"line\">        decorate_events =&gt; true</span><br><span class=\"line\">        topics =&gt; [&quot;elktest&quot;]</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">          </span><br><span class=\"line\">output &#123; </span><br><span class=\"line\">    elasticsearch &#123; </span><br><span class=\"line\">        hosts =&gt; [&quot;192.168.40.180:9200&quot;]</span><br><span class=\"line\">        index =&gt; &quot;elkk8stest-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;        </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fluentd是一个针对日志的收集、处理、转发系统。通过丰富的插件系统，可以收集来自于各种系统或应用的日志，转化为用户指定的格式后，转发到用户所指定的日志存储系统之中。</span><br><span class=\"line\">fluentd 常常被拿来和Logstash比较，我们常说ELK，L就是这个agent。fluentd 是随着Docker和es一起流行起来的agent。</span><br><span class=\"line\">fluentd 比 logstash 更省资源；</span><br><span class=\"line\">更轻量级的 fluent-bid 对应 filebeat，作为部署在结点上的日志收集器；</span><br><span class=\"line\">fluentd 有更多强大、开放的插件数量和社区。插件多，也非常灵活，规则也不复杂。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">fluentd、filebeat、logstash对比分析</span><br><span class=\"line\"></span><br><span class=\"line\">Logstash</span><br><span class=\"line\">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。</span><br><span class=\"line\">优势</span><br><span class=\"line\">Logstash 主要的优点就是它的灵活性，主要因为它有很多插件，详细的文档以及直白的配置格式让它可以在多种场景下应用。我们基本上可以在网上找到很多资源，几乎可以处理任何问题。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">Logstash 致命的问题是它的性能以及资源消耗(默认的堆大小是 1GB)。尽管它的性能在近几年已经有很大提升，与它的替代者们相比还是要慢很多的。这里有 Logstash 与 rsyslog 性能对比以及Logstash 与 filebeat 的性能对比。它在大数据量的情况下会是个问题。</span><br><span class=\"line\">另一个问题是它目前不支持缓存，目前的典型替代方案是将 Redis 或 Kafka 作为中心缓冲池：</span><br><span class=\"line\">因为 Logstash 自身的灵活性以及网络上丰富的资料，Logstash 适用于原型验证阶段使用，或者解析非常的复杂的时候。在不考虑服务器资源的情况下，如果服务器的性能足够好，我们也可以为每台服务器安装 Logstash 。我们也不需要使用缓冲，因为文件自身就有缓冲的行为，而 Logstash 也会记住上次处理的位置。</span><br><span class=\"line\">如果服务器性能较差，并不推荐为每个服务器安装 Logstash ，这样就需要一个轻量的日志传输工具，将数据从服务器端经由一个或多个 Logstash 中心服务器传输到 Elasticsearch：</span><br><span class=\"line\"></span><br><span class=\"line\">Filebeat</span><br><span class=\"line\">作为 Beats 家族的一员，Filebeat 是一个轻量级的日志传输工具，它的存在正弥补了 Logstash 的缺点：Filebeat 作为一个轻量级的日志传输工具可以将日志推送到中心 Logstash。</span><br><span class=\"line\">在版本 5.x 中，Elasticsearch 具有解析的能力(像 Logstash 过滤器)— Ingest。这也就意味着可以将数据直接用 Filebeat 推送到 Elasticsearch，并让 Elasticsearch 既做解析的事情，又做存储的事情。也不需要使用缓冲，因为 Filebeat 也会和 Logstash 一样记住上次读取的偏移，如果需要缓冲(例如，不希望将日志服务器的文件系统填满)，可以使用 Redis/Kafka，因为 Filebeat 可以与它们进行通信。</span><br><span class=\"line\">优势</span><br><span class=\"line\">Filebeat 只是一个二进制文件没有任何依赖。它占用资源极少，尽管它还十分年轻，正式因为它简单，所以几乎没有什么可以出错的地方，所以它的可靠性还是很高的。它也为我们提供了很多可以调节的点，例如：它以何种方式搜索新的文件，以及当文件有一段时间没有发生变化时，何时选择关闭文件句柄。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">Filebeat 的应用范围十分有限，所以在某些场景下我们会碰到问题。例如，如果使用 Logstash 作为下游管道，我们同样会遇到性能问题。正因为如此，Filebeat 的范围在扩大。开始时，它只能将日志发送到 Logstash 和 Elasticsearch，而现在它可以将日志发送给 Kafka 和 Redis，在 5.x 版本中，它还具备过滤的能力。</span><br><span class=\"line\"></span><br><span class=\"line\">Fluentd</span><br><span class=\"line\">Fluentd 创建的初衷主要是尽可能的使用 JSON 作为日志输出，所以传输工具及其下游的传输线不需要猜测子字符串里面各个字段的类型。这样，它为几乎所有的语言都提供库，这也意味着，我们可以将它插入到我们自定义的程序中。</span><br><span class=\"line\">优势</span><br><span class=\"line\">和多数 Logstash 插件一样，Fluentd 插件是用 Ruby 语言开发的非常易于编写维护。所以它数量很多，几乎所有的源和目标存储都有插件(各个插件的成熟度也不太一样)。这也意味这我们可以用 Fluentd 来串联所有的东西。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">因为在多数应用场景下，我们会通过 Fluentd 得到结构化的数据，它的灵活性并不好。但是我们仍然可以通过正则表达式，来解析非结构化的数据。尽管，性能在大多数场景下都很好，但它并不是最好的，和 syslog-ng 一样，它的缓冲只存在与输出端，单线程核心以及 Ruby GIL 实现的插件意味着它大的节点下性能是受限的，不过，它的资源消耗在大多数场景下是可以接受的。对于小的或者嵌入式的设备，可能需要看看 Fluent Bit，它和 Fluentd 的关系与 Filebeat 和 Logstash 之间的关系类似。</span><br><span class=\"line\"></span><br><span class=\"line\">Logagent</span><br><span class=\"line\">Logagent 是 Sematext 提供的传输工具，它用来将日志传输到 Logsene(一个基于 SaaS 平台的 Elasticsearch API)，因为 Logsene 会暴露 Elasticsearch API，所以 Logagent 可以很容易将数据推送到 Elasticsearch 。</span><br><span class=\"line\">优势</span><br><span class=\"line\">可以获取 /var/log 下的所有信息，解析各种格式(Elasticsearch，Solr，MongoDB，Apache HTTPD等等)，它可以掩盖敏感的数据信息，例如，个人验证信息(PII)，出生年月日，信用卡号码，等等。它还可以基于 IP 做 GeoIP 丰富地理位置信息(例如，access logs)。同样，它轻量又快速，可以将其置入任何日志块中。在新的 2.0 版本中，它以第三方 node.js 模块化方式增加了支持对输入输出的处理插件。重要的是 Logagent 有本地缓冲，所以不像 Logstash ，在数据传输目的地不可用时会丢失日志。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">尽管 Logagent 有些比较有意思的功能(例如，接收 Heroku 或 CloudFoundry 日志)，但是它并没有 Logstash 灵活。</span><br><span class=\"line\"></span><br><span class=\"line\">logtail</span><br><span class=\"line\">阿里云日志服务的生产者，目前在阿里集团内部机器上运行，经过3年多时间的考验，目前为阿里公有云用户提供日志收集服务。</span><br><span class=\"line\">采用C++语言实现，对稳定性、资源控制、管理等下过很大的功夫，性能良好。相比于logstash、fluentd的社区支持，logtail功能较为单一，专注日志收集功能。</span><br><span class=\"line\">优势</span><br><span class=\"line\">logtail占用机器cpu、内存资源最少，结合阿里云日志服务的E2E体验良好。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">logtail目前对特定日志类型解析的支持较弱，后续需要把这一块补起来。</span><br><span class=\"line\"></span><br><span class=\"line\">rsyslog</span><br><span class=\"line\">绝大多数 Linux 发布版本默认的 syslog 守护进程，rsyslog 可以做的不仅仅是将日志从 syslog socket 读取并写入 /var/log/messages 。它可以提取文件、解析、缓冲(磁盘和内存)以及将它们传输到多个目的地，包括 Elasticsearch 。可以从此处找到如何处理 Apache 以及系统日志。</span><br><span class=\"line\">优势</span><br><span class=\"line\">rsyslog 是经测试过的最快的传输工具。如果只是将它作为一个简单的 router/shipper 使用，几乎所有的机器都会受带宽的限制，但是它非常擅长处理解析多个规则。它基于语法的模块(mmnormalize)无论规则数目如何增加，它的处理速度始终是线性增长的。这也就意味着，如果当规则在 20-30 条时，如解析 Cisco 日志时，它的性能可以大大超过基于正则式解析的 grok ，达到 100 倍(当然，这也取决于 grok 的实现以及 liblognorm 的版本)。</span><br><span class=\"line\">它同时也是我们能找到的最轻的解析器，当然这也取决于我们配置的缓冲。</span><br><span class=\"line\">劣势</span><br><span class=\"line\">rsyslog 的配置工作需要更大的代价(这里有一些例子)，这让两件事情非常困难：</span><br><span class=\"line\">文档难以搜索和阅读，特别是那些对术语比较陌生的开发者。</span><br><span class=\"line\">5.x 以上的版本格式不太一样(它扩展了 syslogd 的配置格式，同时也仍然支持旧的格式)，尽管新的格式可以兼容旧格式，但是新的特性(例如，Elasticsearch 的输出)只在新的配置下才有效，然后旧的插件(例如，Postgres 输出)只在旧格式下支持。</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装elasticsearch\"><a class=\"markdownIt-Anchor\" href=\"#安装elasticsearch\">#</a> 安装 elasticsearch</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">.创建一个kube-logging名称空间，将EFK组件安装到该名称空间中。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在这个名称空间下去安装日志收集组件efk，首先，我们需要部署一个有3个节点的Elasticsearch集群。我们使用3个Elasticsearch</span> <span class=\"string\">Pods可以避免高可用中的多节点群集中发生的“裂脑”的问题。</span> <span class=\"string\">Elasticsearch脑裂可参考如下：https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">.创建一个headless</span> <span class=\"string\">service的Kubernetes服务，服务名称是elasticsearch，这个服务将为3个Pod定义一个DNS域。headless</span> <span class=\"string\">service不具备负载均衡也没有IP。</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-logging</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">rest</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">inter-node</span></span><br><span class=\"line\"></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">.</span> <span class=\"string\">创建Storageclass，实现存储类动态供给</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">nfs-utils</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">nfs</span> <span class=\"string\">--now</span></span><br><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">/data/v1</span> <span class=\"string\">-p</span></span><br><span class=\"line\"><span class=\"string\">/data/v1</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">exportfs</span> <span class=\"string\">-arv</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">restart</span> <span class=\"string\">nfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">.创建nfs作为存储的供应商</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、创建sa</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、对sa做rbac授权</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;services&quot;</span>, <span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;extensions&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;podsecuritypolicies&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;nfs-provisioner&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;use&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">run-nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner-runner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">/etc/kubernetes/manifests/kube-apiserver.yaml</span> </span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--feature-gates=RemoveSelfLink=false</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">apply</span> <span class=\"string\">-f</span> <span class=\"string\">/etc/kubernetes/manifests/kube-apiserver.yaml</span> <span class=\"comment\"># 可能导致6443暂时无法访问</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">pod</span> <span class=\"string\">-n</span> <span class=\"string\">kube-system</span> <span class=\"string\">kube-apiserver</span> <span class=\"comment\"># 高可用时需要改一个文件删一个api-server</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">工作节点：</span></span><br><span class=\"line\"> <span class=\"string\">docker</span> <span class=\"string\">load</span> <span class=\"string\">-i</span> <span class=\"string\">nfs-client-provisioner.tar.gz</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#通过deployment创建pod用来运行nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/open-ali/xianchao/nfs-client-provisioner:v1</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">example.com/nfs</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_PATH</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/data/v1</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/data/v1</span></span><br><span class=\"line\"><span class=\"comment\">#创建stoorageclass</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">do-block-storage</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">example.com/nfs</span></span><br><span class=\"line\">      </span><br><span class=\"line\"><span class=\"comment\"># 安装elasticsearch集群</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">load</span> <span class=\"string\">-i</span> <span class=\"string\">elasticsearch_7_2_0.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-cluster</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">docker.elastic.co/elasticsearch/elasticsearch:7.2.0</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">1000m</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9200</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">rest</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9300</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">inter-node</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cluster.name</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">k8s-logs</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">node.name</span></span><br><span class=\"line\">            <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">              <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">discovery.seed_hosts</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;es-cluster-0.elasticsearch.kube-logging.svc.cluster.local,es-cluster-1.elasticsearch.kube-logging.svc.cluster.local,es-cluster-2.elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cluster.initial_master_nodes</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;es-cluster-0,es-cluster-1,es-cluster-2&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ES_JAVA_OPTS</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;-Xms512m -Xmx512m&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">initContainers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">fix-permissions</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;chown -R 1000:1000 /usr/share/elasticsearch/data&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/elasticsearch/data</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">increase-vm-max-map</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sysctl&quot;</span>, <span class=\"string\">&quot;-w&quot;</span>, <span class=\"string\">&quot;vm.max_map_count=262144&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">increase-fd-ulimit</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;ulimit -n 65536&quot;</span>]</span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">privileged:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">elasticsearch</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span> [ <span class=\"string\">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">do-block-storage</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">10Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">pod部署完成之后，可以通过REST</span> <span class=\"string\">API检查elasticsearch集群是否部署成功，使用下面的命令将本地端口9200转发到</span> <span class=\"string\">Elasticsearch</span> <span class=\"string\">节点（如es-cluster-0）对应的端口：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">port-forward</span> <span class=\"string\">es-cluster-0</span> <span class=\"number\">9200</span><span class=\"string\">:9200</span> <span class=\"string\">--namespace=kube-logging</span></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">http://localhost:9200/_cat/</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建kibaba</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: kube-logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 5601</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: kibana</span><br><span class=\"line\">  namespace: kube-logging</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: kibana</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 1</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: kibana</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        app: kibana</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: kibana</span><br><span class=\"line\">        image: docker.elastic.co/kibana/kibana:7.2.0</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        resources:</span><br><span class=\"line\">          limits:</span><br><span class=\"line\">            cpu: 1000m</span><br><span class=\"line\">          requests:</span><br><span class=\"line\">            cpu: 100m</span><br><span class=\"line\">        <span class=\"built_in\">env</span>:</span><br><span class=\"line\">          - name: ELASTICSEARCH_URL</span><br><span class=\"line\">            value: http://elasticsearch.kube-logging.svc.cluster.local:9200</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 5601</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装fluentd组件</span></span><br><span class=\"line\"><span class=\"string\">我们使用daemonset控制器部署fluentd组件，这样可以保证集群中的每个节点都可以运行同样fluentd的pod副本，这样就可以收集k8s集群中每个节点的日志，在k8s集群中，容器应用程序的输入输出日志会重定向到node节点里的json文件中，fluentd可以tail和过滤以及把日志转换成指定的格式发送到elasticsearch集群中。除了容器日志，fluentd也可以采集kubelet、kube-proxy、docker的日志。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-logging</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">namespaces</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-logging</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-logging</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">      <span class=\"attr\">tolerations:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\">        <span class=\"attr\">effect:</span> <span class=\"string\">NoSchedule</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">fluent/fluentd-kubernetes-daemonset:v1.4.2-debian-elasticsearch-1.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">FLUENT_ELASTICSEARCH_HOST</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">FLUENT_ELASTICSEARCH_PORT</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;9200&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">FLUENT_ELASTICSEARCH_SCHEME</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">&quot;http&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">FLUENTD_SYSTEMD_CONF</span></span><br><span class=\"line\">            <span class=\"attr\">value:</span> <span class=\"string\">disable</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">512Mi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlog</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">          <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">30</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlog</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlibdockercontainers</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"测试pod\"><a class=\"markdownIt-Anchor\" href=\"#测试pod\">#</a> 测试 pod</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">counter</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">count</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">args:</span> [<span class=\"string\">/bin/sh</span>, <span class=\"string\">-c</span>,<span class=\"string\">&#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done&#x27;</span>]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143741555.png\" alt=\"image-20230531143741555\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143701392.png\" alt=\"image-20230531143701392\"></p>\n<p>[Kibana Query Language | Kibana Guide <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9raWJhbmEvNy4yL2t1ZXJ5LXF1ZXJ5Lmh0bWw=\">7.2] | Elastic</span></p>\n<h2 id=\"ceph\"><a class=\"markdownIt-Anchor\" href=\"#ceph\">#</a> ceph</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ceph是一种开源的分布式的存储系统</span><br><span class=\"line\">包含以下几种存储类型：</span><br><span class=\"line\">块存储（rbd），对象存储(RADOS Fateway)，文件系统（cephfs）</span><br><span class=\"line\"></span><br><span class=\"line\">1.块存储（rbd）：</span><br><span class=\"line\">块是一个字节序列（例如，512字节的数据块）。 基于块的存储接口是使用旋转介质（如硬盘，CD，软盘甚至传统的9轨磁带）存储数据的最常用方法;Ceph块设备是精简配置，可调整大小并存储在Ceph集群中多个OSD条带化的数据。 Ceph块设备利用RADOS功能，如快照，复制和一致性。 Ceph的RADOS块设备（RBD）使用内核模块或librbd库与OSD进行交互;Ceph的块设备为内核模块或QVM等KVM以及依赖libvirt和QEMU与Ceph块设备集成的OpenStack和CloudStack等基于云的计算系统提供高性能和无限可扩展性。 可以使用同一个集群同时运行Ceph RADOS Gateway，CephFS文件系统和Ceph块设备。</span><br><span class=\"line\">linux系统中，ls /dev/下有很多块设备文件，这些文件就是我们添加硬盘时识别出来的；</span><br><span class=\"line\">rbd就是由Ceph集群提供出来的块设备。可以这样理解，sda是通过数据线连接到了真实的硬盘，而rbd是通过网络连接到了Ceph集群中的一块存储区域，往rbd设备文件写入数据，最终会被存储到Ceph集群的这块区域中；</span><br><span class=\"line\">总结：块设备可理解成一块硬盘，用户可以直接使用不含文件系统的块设备，也可以将其格式化成特定的文件系统，由文件系统来组织管理存储空间，从而为用户提供丰富而友好的数据操作支持。</span><br><span class=\"line\"></span><br><span class=\"line\">2.文件系统cephfs</span><br><span class=\"line\">Ceph文件系统（CephFS）是一个符合POSIX标准的文件系统，它使用Ceph存储集群来存储其数据。 Ceph文件系统使用与Ceph块设备相同的Ceph存储集群系统。</span><br><span class=\"line\">用户可以在块设备上创建xfs文件系统，也可以创建ext4等其他文件系统，Ceph集群实现了自己的文件系统来组织管理集群的存储空间，用户可以直接将Ceph集群的文件系统挂载到用户机上使用，Ceph有了块设备接口，在块设备上完全可以构建一个文件系统，那么Ceph为什么还需要文件系统接口呢？</span><br><span class=\"line\">主要是因为应用场景的不同，Ceph的块设备具有优异的读写性能，但不能多处挂载同时读写，目前主要用在OpenStack上作为虚拟磁盘，而Ceph的文件系统接口读写性能较块设备接口差，但具有优异的共享性。</span><br><span class=\"line\"></span><br><span class=\"line\">3.对象存储</span><br><span class=\"line\">Ceph对象存储使用Ceph对象网关守护进程（radosgw），它是一个用于与Ceph存储集群交互的HTTP服务器。由于它提供与OpenStack Swift和Amazon S3兼容的接口，因此Ceph对象网关具有自己的用户管理。 Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的相同Ceph存储集群中</span><br><span class=\"line\">使用方式就是通过http协议上传下载删除对象（文件即对象）。</span><br><span class=\"line\">老问题来了，有了块设备接口存储和文件系统接口存储，为什么还整个对象存储呢?</span><br><span class=\"line\">Ceph的块设备存储具有优异的存储性能但不具有共享性，而Ceph的文件系统具有共享性然而性能较块设备存储差，为什么不权衡一下存储性能和共享性，整个具有共享性而存储性能好于文件系统存储的存储呢，对象存储就这样出现了。</span><br><span class=\"line\"></span><br><span class=\"line\">分布式存储的优点：</span><br><span class=\"line\">高可靠：既满足存储读取不丢失，还要保证数据长期存储。 在保证部分硬件损坏后依然可以保证数据安全</span><br><span class=\"line\">高性能：读写速度快</span><br><span class=\"line\">可扩展：分布式存储的优势就是“分布式”，所谓的“分布式”就是能够将多个物理节点整合在一起形成共享的存储池，节点可以线性扩充，这样可以源源不断的通过扩充节点提升性能和扩大容量，这是传统存储阵列无法做到的</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Ceph核心组件介绍</span><br><span class=\"line\">在ceph集群中，不管你是想要提供对象存储，块设备存储，还是文件系统存储，所有Ceph存储集群部署都是从设置每个Ceph节点，网络和Ceph存储开始 的。 Ceph存储集群至少需要一个Ceph Monitor，Ceph Manager和Ceph OSD（对象存储守护进程）。 运行Ceph Filesystem客户端时也需要Ceph元数据服务器。</span><br><span class=\"line\"></span><br><span class=\"line\">Monitors：Ceph监视器（ceph-mon）维护集群状态的映射，包括监视器映射，管理器映射，OSD映射和CRUSH映射。这些映射是Ceph守护进程相互协调所需的关键集群状态。监视器还负责管理守护进程和客户端之间的身份验证。冗余和高可用性通常至少需要三个监视器。</span><br><span class=\"line\"></span><br><span class=\"line\">Managers：Ceph Manager守护程序（ceph-mgr）负责跟踪运行时指标和Ceph集群的当前状态，包括存储利用率，当前性能指标和系统负载。 Ceph Manager守护进程还托管基于python的模块来管理和公开Ceph集群信息，包括基于Web的Ceph Dashboard和REST API。高可用性通常至少需要两名Managers。</span><br><span class=\"line\"></span><br><span class=\"line\">Ceph OSD：Ceph OSD（对象存储守护进程，ceph-osd）存储数据，处理数据复制，恢复，重新平衡，并通过检查其他Ceph OSD守护进程来获取心跳，为Ceph监视器和管理器提供一些监视信息。冗余和高可用性通常至少需要3个Ceph OSD。</span><br><span class=\"line\"></span><br><span class=\"line\">MDS：Ceph元数据服务器（MDS，ceph-mds）代表Ceph文件系统存储元数据（即，Ceph块设备和Ceph对象存储不使用MDS）。 Ceph元数据服务器允许POSIX文件系统用户执行基本命令（如ls，find等），而不会给Ceph存储集群带来巨大负担。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装ceph集群</span></span><br><span class=\"line\"><span class=\"comment\">#在master1-admin节点安装ceph-deploy</span></span><br><span class=\"line\"> yum install python-setuptools  ceph-deploy -y</span><br><span class=\"line\"><span class=\"comment\">#在master1-admin、node1-monitor和node2-osd节点安装ceph</span></span><br><span class=\"line\">yum install ceph ceph-radosgw  -y</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1-admin ~]<span class=\"comment\"># ceph --version</span></span><br><span class=\"line\">ceph version 10.2.11 (e4b061b47f07f583c92a050d9e84b1813a35671e)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建一个目录，用于保存 ceph-deploy 生成的配置文件信息的</span></span><br><span class=\"line\">[root@master1-admin ceph ~]<span class=\"comment\"># cd /etc/ceph</span></span><br><span class=\"line\">[root@master1-admin ceph]<span class=\"comment\"># ceph-deploy new master1-admin node1-monitor node2-osd</span></span><br><span class=\"line\"><span class=\"comment\"># 执行会生成如下文件</span></span><br><span class=\"line\">[root@master1-admin ceph]<span class=\"comment\"># ls </span></span><br><span class=\"line\">ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring  rbdmap</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.<span class=\"comment\"># 追加如下参数</span></span><br><span class=\"line\">osd_pool_default_size = 2</span><br><span class=\"line\">mon clock drift allowed = 0.500</span><br><span class=\"line\">mon clock drift warn backoff = 10</span><br><span class=\"line\"></span><br><span class=\"line\">mon clock drift allowed <span class=\"comment\">#监视器间允许的时钟漂移量默认值0.05</span></span><br><span class=\"line\">mon clock drift warn backoff <span class=\"comment\">#时钟偏移警告的退避指数。默认值5</span></span><br><span class=\"line\">ceph对每个mon之间的时间同步延时默认要求在0.05s之间，这个时间有的时候太短了。所以如果ceph集群如果出现clock问题就检查ntp时间同步或者适当放宽这个误差时间。</span><br><span class=\"line\">cephx是认证机制是整个 Ceph 系统的用户名/密码</span><br><span class=\"line\"></span><br><span class=\"line\">2、配置初始monitor、收集所有的密钥</span><br><span class=\"line\">[root@master1-admin]<span class=\"comment\"># cd /etc/ceph</span></span><br><span class=\"line\">[root@master1-admin]<span class=\"comment\"># ceph-deploy mon create-initial</span></span><br><span class=\"line\">[root@master1-admin]<span class=\"comment\"># ls *.keyring</span></span><br><span class=\"line\">ceph.bootstrap-mds.keyring  ceph.bootstrap-mgr.keyring  ceph.bootstrap-osd.keyring  ceph.bootstrap-rgw.keyring  ceph.client.admin.keyring  ceph.mon.keyring</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 准备osd</span></span><br><span class=\"line\"><span class=\"built_in\">cd</span> /etc/ceph/</span><br><span class=\"line\">ceph-deploy osd prepare master1-admin:/dev/sdb </span><br><span class=\"line\">ceph-deploy osd prepare node1-monitor:/dev/sdb </span><br><span class=\"line\">ceph-deploy osd prepare node2-osd:/dev/sdb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#激活osd</span></span><br><span class=\"line\">ceph-deploy osd activate master1-admin:/dev/sdb1</span><br><span class=\"line\">ceph-deploy osd activate node1-monitor:/dev/sdb1</span><br><span class=\"line\">ceph-deploy osd activate node2-osd:/dev/sdb1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看状态</span></span><br><span class=\"line\">ceph-deploy osd list master1-admin node1-monitor node2-osd</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建ceph文件系统</span></span><br><span class=\"line\">创建mds</span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph-deploy mds create master1-admin node1-monitor node2-osd</span></span><br><span class=\"line\"></span><br><span class=\"line\">查看ceph当前文件系统</span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph fs ls   \t</span></span><br><span class=\"line\"></span><br><span class=\"line\">No filesystems enabled</span><br><span class=\"line\"></span><br><span class=\"line\">一个cephfs至少要求两个librados存储池，一个为data，一个为metadata。当配置这两个存储池时，注意：</span><br><span class=\"line\">1. 为metadata pool设置较高级别的副本级别，因为metadata的损坏可能导致整个文件系统不用</span><br><span class=\"line\">2. 建议，metadata pool使用低延时存储，比如SSD，因为metadata会直接影响客户端的响应速度。</span><br><span class=\"line\"></span><br><span class=\"line\">创建存储池</span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph osd pool create cephfs_data 128</span></span><br><span class=\"line\">pool <span class=\"string\">&#x27;cephfs_data&#x27;</span> created</span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph osd pool create cephfs_metadata 128</span></span><br><span class=\"line\">pool <span class=\"string\">&#x27;cephfs_metadata&#x27;</span> created</span><br><span class=\"line\"></span><br><span class=\"line\">关于创建存储池</span><br><span class=\"line\">确定 pg_num 取值是强制性的，因为不能自动计算。下面是几个常用的值：</span><br><span class=\"line\">*少于 5 个 OSD 时可把 pg_num 设置为 128</span><br><span class=\"line\">*OSD 数量在 5 到 10 个时，可把 pg_num 设置为 512</span><br><span class=\"line\">*OSD 数量在 10 到 50 个时，可把 pg_num 设置为 4096</span><br><span class=\"line\">*OSD 数量大于 50 时，你得理解权衡方法、以及如何自己计算 pg_num 取值</span><br><span class=\"line\">*自己计算 pg_num 取值时可借助 pgcalc 工具</span><br><span class=\"line\">随着 OSD 数量的增加，正确的 pg_num 取值变得更加重要，因为它显著地影响着集群的行为、以及出错时的数据持久性（即灾难性事件导致数据丢失的概率）。</span><br><span class=\"line\"></span><br><span class=\"line\">创建文件系统</span><br><span class=\"line\">创建好存储池后，你就可以用 fs new 命令创建文件系统了</span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph fs new xianchao cephfs_metadata cephfs_data</span></span><br><span class=\"line\">new fs with metadata pool 2 and data pool 1</span><br><span class=\"line\">其中：new后的fsname  可自定义</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph fs ls              #查看创建后的cephfs</span></span><br><span class=\"line\">[root@ master1-admin ceph]<span class=\"comment\"># ceph mds stat          #查看mds节点状态</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1-admin ceph]<span class=\"comment\"># ceph -s </span></span><br><span class=\"line\">    cluster 66e0ffc8-fb71-40ee-bcc0-a6e87713ddac</span><br><span class=\"line\">     health HEALTH_WARN</span><br><span class=\"line\">            clock skew detected on mon.node2-osd</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"k8s挂载ceph-rbd\"><a class=\"markdownIt-Anchor\" href=\"#k8s挂载ceph-rbd\">#</a> k8s 挂载 ceph rbd</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubernetes要想使用ceph，需要在k8s的每个node节点安装ceph-common，把ceph节点上的ceph.repo文件拷贝到k8s各个节点/etc/yum.repos.d/目录下，然后在k8s的各个节点yum install ceph-common -y</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span>]<span class=\"comment\"># scp /etc/yum.repos.d/ceph.repo 192.168.40.180:/etc/yum.repos.d/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span>]<span class=\"comment\"># scp /etc/yum.repos.d/ceph.repo 192.168.40.181:/etc/yum.repos.d/</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@masterk8s</span> <span class=\"string\">~</span>]<span class=\"comment\"># yum install ceph-common -y</span></span><br><span class=\"line\">[<span class=\"string\">root@nodek8s</span> <span class=\"string\">~</span>]<span class=\"comment\"># yum install ceph-common -y</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># scp /etc/ceph/* 192.168.40.180:/etc/ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># scp /etc/ceph/* 192.168.40.181:/etc/ceph/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建ceph rbd</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># ceph osd pool create k8srbd1 6</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># rbd create rbda -s 1024 -p k8srbd1</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># rbd feature disable  k8srbd1/rbda object-map fast-diff deep-flatten</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">testrbd</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">testrbd</span></span><br><span class=\"line\">        <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">testrbd</span></span><br><span class=\"line\">      <span class=\"attr\">rbd:</span></span><br><span class=\"line\">        <span class=\"attr\">monitors:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.202:6789&#x27;</span></span><br><span class=\"line\">        <span class=\"attr\">pool:</span> <span class=\"string\">k8srbd1</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">rbda</span></span><br><span class=\"line\">        <span class=\"attr\">fsType:</span> <span class=\"string\">xfs</span></span><br><span class=\"line\">        <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">        <span class=\"attr\">user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\">        <span class=\"attr\">keyring:</span> <span class=\"string\">/etc/ceph/ceph.client.admin.keyring</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">k8srbd1下的rbda被pod挂载了，那其他pod就不能占用这个k8srbd1下的rbda了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">创建deployment的时候也只有一个能running，因为只有一个pod能用这个块设备</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"ceph-rbd生成pv\"><a class=\"markdownIt-Anchor\" href=\"#ceph-rbd生成pv\">#</a> ceph rbd 生成 pv</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、创建ceph-secret这个k8s</span> <span class=\"string\">secret对象，这个secret对象用于k8s</span> <span class=\"string\">volume插件访问ceph集群，获取client.admin的keyring值，并用base64编码，在master1-admin（ceph管理节点）操作</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># ceph auth get-key client.admin | base64</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ceph-secret</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">key:</span> <span class=\"string\">QVFBWk0zeGdZdDlhQXhBQVZsS0poYzlQUlBianBGSWJVbDNBenc9PQ==</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">.回到ceph</span> <span class=\"string\">管理节点创建pool池</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># ceph osd pool create k8stest 6</span></span><br><span class=\"line\"><span class=\"string\">pool</span> <span class=\"string\">&#x27;k8stest&#x27;</span> <span class=\"string\">created</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># rbd create rbda -s 1024 -p k8stest</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># rbd feature disable  k8stest/rbda object-map fast-diff deep-flatten</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span> </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ceph-pv</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span>   </span><br><span class=\"line\">   <span class=\"attr\">capacity:</span>     </span><br><span class=\"line\">     <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span>   </span><br><span class=\"line\">   <span class=\"attr\">accessModes:</span>     </span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span>   </span><br><span class=\"line\">   <span class=\"attr\">rbd:</span>     </span><br><span class=\"line\">         <span class=\"attr\">monitors:</span>       </span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"string\">&#x27;192.168.13.202:6789&#x27;</span>    </span><br><span class=\"line\">         <span class=\"attr\">pool:</span> <span class=\"string\">k8stest</span>     </span><br><span class=\"line\">         <span class=\"attr\">image:</span> <span class=\"string\">rbda</span>     </span><br><span class=\"line\">         <span class=\"attr\">user:</span> <span class=\"string\">admin</span>     </span><br><span class=\"line\">         <span class=\"attr\">secretRef:</span>       </span><br><span class=\"line\">             <span class=\"attr\">name:</span> <span class=\"string\">ceph-secret</span>     </span><br><span class=\"line\">         <span class=\"attr\">fsType:</span> <span class=\"string\">xfs</span>     </span><br><span class=\"line\">         <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span>   </span><br><span class=\"line\">   <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Recycle</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span> </span><br><span class=\"line\"><span class=\"attr\">metadata:</span>   </span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ceph-pvc</span> </span><br><span class=\"line\"><span class=\"attr\">spec:</span>   </span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span>     </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span>   </span><br><span class=\"line\">  <span class=\"attr\">resources:</span>     </span><br><span class=\"line\">   <span class=\"attr\">requests:</span>       </span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-deployment</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">     <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span> <span class=\"comment\"># tells deployment to run 2 pods matching the template</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span> <span class=\"comment\"># create pods using pod definition in this template</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">&quot;/ceph-data&quot;</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">ceph-data</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ceph-data</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">            <span class=\"attr\">claimName:</span> <span class=\"string\">ceph-pvc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">通过上面实验可以发现pod是可以以ReadWriteOnce共享挂载相同的pvc的</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">注意：ceph</span> <span class=\"string\">rbd块存储的特点</span></span><br><span class=\"line\"><span class=\"string\">ceph</span> <span class=\"string\">rbd块存储能在同一个node上跨pod以ReadWriteOnce共享挂载</span></span><br><span class=\"line\"><span class=\"string\">ceph</span> <span class=\"string\">rbd块存储能在同一个node上同一个pod多个容器中以ReadWriteOnce共享挂载</span></span><br><span class=\"line\"><span class=\"string\">ceph</span> <span class=\"string\">rbd块存储不能跨node以ReadWriteOnce共享挂载</span></span><br><span class=\"line\"><span class=\"string\">如果一个使用ceph</span> <span class=\"string\">rdb的pod所在的node挂掉，这个pod虽然会被调度到其它node，但是由于rbd不能跨node多次挂载和挂掉的pod不能自动解绑pv的问题，这个新pod不会正常运行</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Deployment更新特性：</span></span><br><span class=\"line\"><span class=\"string\">deployment触发更新的时候，它确保至少所需</span> <span class=\"string\">Pods</span> <span class=\"number\">75</span><span class=\"string\">%</span> <span class=\"string\">处于运行状态（最大不可用比例为</span> <span class=\"number\">25</span><span class=\"string\">%）。故像一个pod的情况，肯定是新创建一个新的pod，新pod运行正常之后，再关闭老的pod。</span></span><br><span class=\"line\"><span class=\"string\">默认情况下，它可确保启动的</span> <span class=\"string\">Pod</span> <span class=\"string\">个数比期望个数最多多出</span> <span class=\"number\">25</span><span class=\"string\">%</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">问题：</span></span><br><span class=\"line\"><span class=\"string\">结合ceph</span> <span class=\"string\">rbd共享挂载的特性和deployment更新的特性，我们发现原因如下：</span></span><br><span class=\"line\"><span class=\"string\">由于deployment触发更新，为了保证服务的可用性，deployment要先创建一个pod并运行正常之后，再去删除老pod。而如果新创建的pod和老pod不在一个node，就会导致此故障。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">解决办法：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">，使用能支持跨node和pod之间挂载的共享存储，例如cephfs，GlusterFS等</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">，给node添加label，只允许deployment所管理的pod调度到一个固定的node上。（不建议，这个node挂掉的话，服务就故障了）</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"基于storage动态生成pv\"><a class=\"markdownIt-Anchor\" href=\"#基于storage动态生成pv\">#</a> 基于 storage 动态生成 pv</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1-admin</span>]<span class=\"comment\"># chmod 777  -R  /etc/ceph/*</span></span><br><span class=\"line\">[<span class=\"string\">root@node1-monitor</span> <span class=\"string\">~</span>]<span class=\"comment\"># chmod 777  -R  /etc/ceph/*</span></span><br><span class=\"line\">[<span class=\"string\">root@node2-osd</span>]<span class=\"comment\"># chmod 777  -R  /etc/ceph/*</span></span><br><span class=\"line\">[<span class=\"string\">root@\\master~</span>]<span class=\"comment\"># chmod 777  -R  /etc/ceph/*</span></span><br><span class=\"line\">[<span class=\"string\">root@node</span>]<span class=\"comment\"># chmod 777  -R  /etc/ceph/*</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span>]<span class=\"comment\"># mkdir /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span>]<span class=\"comment\"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node1-monitor</span> <span class=\"string\">~</span>]<span class=\"comment\">#mkdir /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node1-monitor</span> <span class=\"string\">~</span>]<span class=\"comment\">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node2-osd</span>]<span class=\"comment\"># mkdir /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node2-osd</span>]<span class=\"comment\"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@master~</span>]<span class=\"comment\">#mkdir /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@master</span> <span class=\"string\">~</span>]<span class=\"comment\">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span>]<span class=\"comment\"># mkdir /root/.ceph/</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、创建rbd的供应商provisioner</span></span><br><span class=\"line\"><span class=\"comment\">#把rbd-provisioner.tar.gz上传到xianchaonode1上，手动解压</span></span><br><span class=\"line\">[<span class=\"string\">root@xianchaonode1</span> <span class=\"string\">~</span>]<span class=\"comment\"># docker load -i rbd-provisioner.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;services&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;kube-dns&quot;</span>,<span class=\"string\">&quot;coredns&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;secrets&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">quay.io/xianchao/external_storage/rbd-provisioner:v1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">env:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">          <span class=\"attr\">value:</span> <span class=\"string\">ceph.com/rbd</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-provisioner</span></span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、创建ceph-secret</span></span><br><span class=\"line\"><span class=\"comment\">#创建pool池</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># ceph osd pool create k8stest1 6</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ceph-secret-1</span></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">&quot;ceph.com/rbd&quot;</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">key:</span> <span class=\"string\">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">k8s-rbd</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">ceph.com/rbd</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\">  <span class=\"attr\">monitors:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.201</span><span class=\"string\">:6789,192.168.13.202:6789,192.168.13.200:6789</span></span><br><span class=\"line\">  <span class=\"attr\">adminId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\">  <span class=\"attr\">adminSecretName:</span> <span class=\"string\">ceph-secret-1</span></span><br><span class=\"line\">  <span class=\"attr\">pool:</span> <span class=\"string\">k8stest1</span></span><br><span class=\"line\">  <span class=\"attr\">userId:</span> <span class=\"string\">admin</span></span><br><span class=\"line\">  <span class=\"attr\">userSecretName:</span> <span class=\"string\">ceph-secret-1</span></span><br><span class=\"line\">  <span class=\"attr\">fsType:</span> <span class=\"string\">xfs</span></span><br><span class=\"line\">  <span class=\"attr\">imageFormat:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">imageFeatures:</span> <span class=\"string\">&quot;layering&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">rbd-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteOnce</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">k8s-rbd</span></span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">test:</span> <span class=\"string\">rbd-pod</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ceph-rbd-pod</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ceph-rbd-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ceph-rbd</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt</span></span><br><span class=\"line\">      <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ceph-rbd</span></span><br><span class=\"line\">    <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">      <span class=\"attr\">claimName:</span> <span class=\"string\">rbd-pvc</span></span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n<h3 id=\"k8s对接cephfs\"><a class=\"markdownIt-Anchor\" href=\"#k8s对接cephfs\">#</a> k8s 对接 cephfs</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、创建ceph子目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">为了别的地方能挂载cephfs，先创建一个secretfile</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/ceph/ceph.client.admin.keyring |grep key|awk -F&quot; &quot; &#x27;&#123;print $3&#125;&#x27; &gt; /etc/ceph/admin.secret</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">挂载cephfs的根目录到集群的mon节点下的一个目录，比如xianchao_data，因为挂载后，我们就可以直接在xianchao_data下面用Linux命令创建子目录了。</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir xianchao_data</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># mount -t ceph 192.168.40.201:6789:/ /root/xianchao_data -o name=admin,secretfile=/etc/ceph/admin.secret</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在cephfs的根目录里面创建了一个子目录lucky，k8s以后就可以挂载这个目录</span> </span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">~</span>]<span class=\"comment\"># cd /root/xianchao_data/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">xianchao_data</span>]<span class=\"comment\"># mkdir lucky</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">xianchao_data</span>]<span class=\"comment\"># chmod 0777 lucky/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">创建k8s连接ceph使用的secret</span></span><br><span class=\"line\">   <span class=\"string\">将/etc/ceph/ceph.client.admin.keyring里面的key的值转换为base64，否则会有问题</span></span><br><span class=\"line\">[<span class=\"string\">root@master1-admin</span> <span class=\"string\">xianchao_data</span>]<span class=\"comment\"># echo &quot;AQBvBdZgsDSZKxAAan+5rnsjr2ziA/atqFnQOA==&quot; | base64</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Secret</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cephfs-secret</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">key:</span> <span class=\"string\">QVFCdkJkWmdzRFNaS3hBQWFuKzVybnNqcjJ6aUEvYXRxRm5RT0E9PQo=</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cephfs-pv</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">cephfs:</span></span><br><span class=\"line\">    <span class=\"attr\">monitors:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.201</span><span class=\"string\">:6789</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/lucky</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">admin</span></span><br><span class=\"line\">    <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">    <span class=\"attr\">secretRef:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">cephfs-secret</span></span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Recycle</span>  </span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cephfs-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">volumeName:</span> <span class=\"string\">cephfs-pv</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cephfs-pod-1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-v1</span></span><br><span class=\"line\">        <span class=\"attr\">mountPath:</span> <span class=\"string\">/mnt</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-v1</span></span><br><span class=\"line\">    <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">      <span class=\"attr\">claimName:</span> <span class=\"string\">cephfs-pvc</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"devops\"><a class=\"markdownIt-Anchor\" href=\"#devops\">#</a> devops</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">敏捷开发</span><br><span class=\"line\">提高开发效率，及时跟进用户需求，缩短开发周期。</span><br><span class=\"line\"></span><br><span class=\"line\">敏捷开发包括编写代码和构建代码两个阶段，可以使用git或者svn来管理代码，用maven对代码进行构建 </span><br><span class=\"line\"></span><br><span class=\"line\">1.5.2 持续集成（CI）</span><br><span class=\"line\">持续集成强调开发人员提交了新代码之后，立刻自动的进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。持续集成过程中很重视自动化测试验证结果，对可能出现的一些问题进行预警，以保障最终合并的代码没有问题。</span><br><span class=\"line\">常见的持续集成工具：</span><br><span class=\"line\">1. Jenkins</span><br><span class=\"line\">Jenkins是用Java语言编写的，是目前使用最多和最受欢迎的持续集成工具，使用Jenkins，可以自动监测到git或者svn存储库代码的更新，基于最新的代码进行构建，把构建好的源码或者镜像发布到生产环境。Jenkins还有个非常好的功能：它可以在多台机器上进行分布式地构建和负载测试</span><br><span class=\"line\">2. TeamCity</span><br><span class=\"line\">3.  Travis CI</span><br><span class=\"line\">4.   Go CD </span><br><span class=\"line\">5.  Bamboo</span><br><span class=\"line\">6.   GitLab CI</span><br><span class=\"line\">7.  Codeship</span><br><span class=\"line\"></span><br><span class=\"line\">它的好处主要有以下几点：</span><br><span class=\"line\">1）较早的发现错误：每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，哪个环节出现问题都可以较早的发现</span><br><span class=\"line\">2）快速的发现错误：每完成一部分代码的更新，就会把代码集成到主干中，这样就可以快速的发现错误，比较容易的定位错误</span><br><span class=\"line\">3）提升团队绩效：持续集成中代码更新速度快，能及时发现小问题并进行修改，使团队能创造出更好的产品</span><br><span class=\"line\">4）防止分支过多的偏离主干：经常持续集成，会使分支代码经常向主干更新，当单元测试失败或者出现bug，如果开发者需要在没有调试的情况下恢复仓库的代码到没有bug的状态，只有很小部分的代码会丢失 </span><br><span class=\"line\">持续集成的目的是提高代码质量，让产品快速的更新迭代。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。</span><br><span class=\"line\">Martin Fowler说过，&quot;持续集成并不能消除Bug，而是让它们非常容易发现和改正。&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">1.5.3 持续交付</span><br><span class=\"line\">持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的「类生产环境」（production-like environments）中。交付给质量团队或者用户，以供评审。如果评审通过，代码就进入生产阶段。</span><br><span class=\"line\">如果所有的代码完成之后一起交付，会导致很多问题爆发出来，解决起来很麻烦，所以持续集成，也就是没更新一次代码，都向下交付一次，这样可以及时发现问题，及时解决，防止问题大量堆积。</span><br><span class=\"line\">1.5.4 持续部署</span><br><span class=\"line\">持续部署是指当交付的代码通过评审之后，自动部署到生产环境中。持续部署是持续交付的最高阶段。</span><br><span class=\"line\">Puppet，SaltStack和Ansible是这个阶段使用的流行工具。容器化工具在部署阶段也发挥着重要作用。 Docker和k8s是流行的工具，有助于在开发，测试和生产环境中实现一致性。 除此之外，k8s还可以实现自动扩容缩容等功能。 </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602135250221.png\" alt=\"image-20230602135250221\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">K8S在DevOps中的核心作用</span><br><span class=\"line\">Docker和K8S的出现使DevOps变得更加普及，更加容易实现。在传统运维中我们服务时需要针对不同的环境去安装不同的版本，部署方式也杂、多。那么有了docker之后，一次构建、到处运行，我们只需要要构建一次镜像，那么只要有docker的主机，就可以基于镜像把应用跑起来。</span><br><span class=\"line\"></span><br><span class=\"line\">在众多微服务中，我们每天可能需要去处理各种服务的崩溃，而服务间的依赖调用关系也及其复杂，这对我们解决问题带来了很大的复杂度。要很好的解决这个问题。我们就需要用到容器编排工具。</span><br><span class=\"line\"></span><br><span class=\"line\">Kubernetes 的出现主宰了容器编排的市场，也进化了过去的运维方式，将开发与运维联系的更加紧密。而且让 DevOps 这一角色变得更加清晰，它是目前可用的很流行的容器解决方案之一。</span><br><span class=\"line\">3.1 自动化</span><br><span class=\"line\">敏捷开发-&gt;持续集成-&gt;持续交付-&gt;持续部署</span><br><span class=\"line\">3.2 多集群管理</span><br><span class=\"line\">可以根据客户需求对开发，测试，生产环境部署多套kubernetes集群，每个环境使用独立的物理资源，相互之间避免影响</span><br><span class=\"line\">3.3 多环境一致性</span><br><span class=\"line\">Kubernetes是基于docker的容器编排工具，因为容器的镜像是不可变的，所以镜像把 OS、业务代码、运行环境、程序库、目录结构都包含在内，镜像保存在我们的私有仓库，只要用户从我们提供的私有仓库拉取镜像，就能保证环境的一致性。</span><br><span class=\"line\">3.4 实时反馈和智能化报表</span><br><span class=\"line\">每次集成或交付，都会第一时间将结果通过多途径的方式反馈给你，也可以定制适合企业专用的报表平台。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602143206987.png\" alt=\"image-20230602143206987\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">.安装nfs</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">nfs-utils</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">start</span> <span class=\"string\">nfs</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">nfs</span></span><br><span class=\"line\"><span class=\"string\">（2）在master1上创建一个nfs共享目录</span></span><br><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">/data/v2</span>  <span class=\"string\">-p</span></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">/etc/exports</span></span><br><span class=\"line\"><span class=\"string\">/data/v1</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/v2</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">exportfs</span> <span class=\"string\">-arv</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">.安装Jenkins</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">namespace</span> <span class=\"string\">jenkins-k8s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">jenkins-k8s-pv</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">10Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/v2</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">jenkins-k8s-pvc</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">jenkins-k8s</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">10Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"string\">（4）创建一个sa账号</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">sa</span> <span class=\"string\">jenkins-k8s-sa</span> <span class=\"string\">-n</span> <span class=\"string\">jenkins-k8s</span></span><br><span class=\"line\"><span class=\"string\">（5）把上面的sa账号做rbac授权</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">jenkins-k8s-sa-cluster</span> <span class=\"string\">-n</span> <span class=\"string\">jenkins-k8s</span>  <span class=\"string\">--clusterrole=cluster-admin</span> <span class=\"string\">--serviceaccount=jenkins-k8s:jenkins-k8s-sa</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">pull</span> <span class=\"string\">jenkins/jenkins</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">load</span> <span class=\"string\">-i</span>  <span class=\"string\">jenkins-slave-latest.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">jenkins-slave-latest.tar.gz这个里面封装的镜像是jenkins-slave-latest:v1，这个jenkins-slave-latest:v1镜像制作方法如下：</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/root/slave</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">dockerfile</span></span><br><span class=\"line\"><span class=\"string\">FROM</span> <span class=\"string\">jenkins/jnlp-slave:4.13.3-1-jdk11</span></span><br><span class=\"line\"><span class=\"string\">USER</span> <span class=\"string\">root</span></span><br><span class=\"line\"><span class=\"comment\"># 安装Docker</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">apt-get</span> <span class=\"string\">update</span> <span class=\"string\">&amp;&amp;</span> <span class=\"string\">apt-get</span> <span class=\"string\">install</span> <span class=\"string\">-y</span> <span class=\"string\">\\</span></span><br><span class=\"line\">    <span class=\"string\">docker.io</span></span><br><span class=\"line\"><span class=\"comment\"># 将当前用户加入docker用户组</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">usermod</span> <span class=\"string\">-aG</span> <span class=\"string\">docker</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">curl</span> <span class=\"string\">-LO</span> <span class=\"string\">https://dl.k8s.io/release/stable.txt</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">curl</span> <span class=\"string\">-LO</span> <span class=\"string\">https://dl.k8s.io/release/$(cat</span> <span class=\"string\">stable.txt)/bin/linux/amd64/kubectl</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">chmod</span> <span class=\"string\">+x</span> <span class=\"string\">kubectl</span></span><br><span class=\"line\"><span class=\"string\">RUN</span> <span class=\"string\">mv</span> <span class=\"string\">kubectl</span> <span class=\"string\">/usr/local/bin/</span></span><br><span class=\"line\"><span class=\"string\">ENV</span> <span class=\"string\">DOCKER_HOST</span> <span class=\"string\">unix:///var/run/docker.sock</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">build</span> <span class=\"string\">-t=jenkins-slave-latest:v1</span> <span class=\"string\">.</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">save</span> <span class=\"string\">-o</span> <span class=\"string\">jenkins-slave-latest.tar.gz</span>  <span class=\"string\">jenkins-slave-latest:v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">chown</span> <span class=\"string\">-R</span> <span class=\"number\">1000.1000</span> <span class=\"string\">/data/v2/</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">jenkins-k8s</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">jenkins-k8s-sa</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span>  <span class=\"string\">jenkins/jenkins:2.401.1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">50000</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">agent</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">1000m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">512Mi</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/login</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">12</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/login</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">60</span></span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">12</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">jenkins-volume</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">jenkins-home</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/jenkins_home</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">jenkins-volume</span></span><br><span class=\"line\">        <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">jenkins-k8s-pvc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">jenkins-service</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">jenkins-k8s</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">jenkins</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"string\">web</span></span><br><span class=\"line\">    <span class=\"attr\">nodePort:</span> <span class=\"number\">30002</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">agent</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">50000</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"string\">agent</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"string\">http://192.168.13.180:30002</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">查看初始密码</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 测试通过Jenkins部署应用发布到k8s开发环境、测试环境、生产环境</span><br><span class=\"line\"></span><br><span class=\"line\">开发提交代码到代码仓库gitlab-jenkins检测到代码更新-调用k8s api在k8s中创建jenkins slave pod：</span><br><span class=\"line\">Jenkins slave pod拉取代码---通过maven把拉取的代码进行构建成war包或者jar包---&gt;上传代码到Sonarqube，进行静态代码扫描- --&gt;基于war包构建docker image--&gt;把镜像上传到harbor镜像仓库--&gt;基于镜像部署应用到开发环境--&gt;部署应用到测试环境---&gt;部署应用到生产环境。</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create ns devlopment</span><br><span class=\"line\">kubectl create ns production</span><br><span class=\"line\">kubectl create ns qatest</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">api_token</span><br><span class=\"line\"> 11e9faa9696f6e6b8ced2d7bcf7172a1a4</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">node(<span class=\"string\">&#x27;testing&#x27;</span>) &#123;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Clone&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1.Clone Stage&quot;</span></span><br><span class=\"line\">        git url: <span class=\"string\">&quot;https://github.com/luckylucky421/jenkins-sample.git&quot;</span></span><br><span class=\"line\">        script &#123;</span><br><span class=\"line\">            build_tag = sh(returnStdout: <span class=\"literal\">true</span>, script: <span class=\"string\">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Test&#x27;</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">&quot;2.Test Stage&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Build&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;docker build -t kbshire/jenkins-demo:<span class=\"variable\">$&#123;build_tag&#125;</span> .&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Push&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class=\"line\">        withCredentials([usernamePassword(credentialsId: <span class=\"string\">&#x27;3774bc6b-f509-4c57-b913-c82d4f20aeb5&#x27;</span>, passwordVariable: <span class=\"string\">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class=\"string\">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;docker login -u <span class=\"variable\">$&#123;dockerHubUser&#125;</span> -p <span class=\"variable\">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;docker push kbshire/jenkins-demo:<span class=\"variable\">$&#123;build_tag&#125;</span>&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Deploy to dev&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;5. Deploy DEV&quot;</span></span><br><span class=\"line\">\t\tsh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class=\"line\">//        sh <span class=\"string\">&quot;bash running-devlopment.sh&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;kubectl apply -f k8s-dev.yaml  --validate=false&quot;</span></span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\tstage(<span class=\"string\">&#x27;Promote to qa&#x27;</span>) &#123;\t</span><br><span class=\"line\">\t\tdef userInput = input(</span><br><span class=\"line\">            <span class=\"built_in\">id</span>: <span class=\"string\">&#x27;userInput&#x27;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            message: <span class=\"string\">&#x27;Promote to qa?&#x27;</span>,</span><br><span class=\"line\">            parameters: [</span><br><span class=\"line\">                [</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">                    choices: <span class=\"string\">&quot;YES\\nNO&quot;</span>,</span><br><span class=\"line\">                    name: <span class=\"string\">&#x27;Env&#x27;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;This is a deploy step to <span class=\"variable\">$&#123;userInput&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (userInput == <span class=\"string\">&quot;YES&quot;</span>) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class=\"line\">//            sh <span class=\"string\">&quot;bash running-qa.sh&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl apply -f k8s-qa.yaml --validate=false&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sleep 6&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl get pods -n qatest&quot;</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            //exit</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\tstage(<span class=\"string\">&#x27;Promote to pro&#x27;</span>) &#123;\t</span><br><span class=\"line\">\t\tdef userInput = input(</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"built_in\">id</span>: <span class=\"string\">&#x27;userInput&#x27;</span>,</span><br><span class=\"line\">            message: <span class=\"string\">&#x27;Promote to pro?&#x27;</span>,</span><br><span class=\"line\">            parameters: [</span><br><span class=\"line\">                [</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">                    choices: <span class=\"string\">&quot;YES\\nNO&quot;</span>,</span><br><span class=\"line\">                    name: <span class=\"string\">&#x27;Env&#x27;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;This is a deploy step to <span class=\"variable\">$&#123;userInput&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (userInput == <span class=\"string\">&quot;YES&quot;</span>) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class=\"line\">//            sh <span class=\"string\">&quot;bash running-production.sh&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;cat k8s-prod.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl apply -f k8s-prod.yaml --record --validate=false&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果有403错误，修改/usr/local/bin/jenkins.sh ,主要修改地方在exec java这行，修改完之后重启docker 容器，docker restart docker_id </span></span><br><span class=\"line\"><span class=\"comment\">#! /bin/bash -e</span></span><br><span class=\"line\">: <span class=\"string\">&quot;<span class=\"variable\">$&#123;JENKINS_WAR:=&quot;/usr/share/jenkins/jenkins.war&quot;&#125;</span>&quot;</span></span><br><span class=\"line\">: <span class=\"string\">&quot;<span class=\"variable\">$&#123;JENKINS_HOME:=&quot;/var/jenkins_home&quot;&#125;</span>&quot;</span></span><br><span class=\"line\">: <span class=\"string\">&quot;<span class=\"variable\">$&#123;COPY_REFERENCE_FILE_LOG:=&quot;<span class=\"variable\">$&#123;JENKINS_HOME&#125;</span>/copy_reference_file.log&quot;&#125;</span>&quot;</span></span><br><span class=\"line\">: <span class=\"string\">&quot;<span class=\"variable\">$&#123;REF:=&quot;/usr/share/jenkins/ref&quot;&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">touch</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>&quot;</span> || &#123; <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Can not write to <span class=\"variable\">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>. Wrong volume permissions?&quot;</span>; <span class=\"built_in\">exit</span> 1; &#125;</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;--- Copying files at <span class=\"subst\">$(date)</span>&quot;</span> &gt;&gt; <span class=\"string\">&quot;<span class=\"variable\">$COPY_REFERENCE_FILE_LOG</span>&quot;</span></span><br><span class=\"line\">find <span class=\"string\">&quot;<span class=\"variable\">$&#123;REF&#125;</span>&quot;</span> \\( -<span class=\"built_in\">type</span> f -o -<span class=\"built_in\">type</span> l \\) -<span class=\"built_in\">exec</span> bash -c <span class=\"string\">&#x27;. /usr/local/bin/jenkins-support; for arg; do copy_reference_file &quot;$arg&quot;; done&#x27;</span> _ &#123;&#125; +</span><br><span class=\"line\"><span class=\"comment\"># if `docker run` first argument start with `--` the user is passing jenkins launcher arguments</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ <span class=\"variable\">$#</span> -lt 1 ]] || [[ <span class=\"string\">&quot;<span class=\"variable\">$1</span>&quot;</span> == <span class=\"string\">&quot;--&quot;</span>* ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">  <span class=\"comment\"># shellcheck disable=SC2001</span></span><br><span class=\"line\">  effective_java_opts=$(sed -e <span class=\"string\">&#x27;s/^ $//&#x27;</span> &lt;&lt;&lt;<span class=\"string\">&quot;<span class=\"variable\">$JAVA_OPTS</span> <span class=\"variable\">$JENKINS_JAVA_OPTS</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"comment\"># read JAVA_OPTS and JENKINS_OPTS into arrays to avoid need for eval (and associated vulnerabilities)</span></span><br><span class=\"line\">  java_opts_array=()</span><br><span class=\"line\">  <span class=\"keyword\">while</span> IFS= <span class=\"built_in\">read</span> -r -d <span class=\"string\">&#x27;&#x27;</span> item; <span class=\"keyword\">do</span></span><br><span class=\"line\">    java_opts_array+=( <span class=\"string\">&quot;<span class=\"variable\">$item</span>&quot;</span> )</span><br><span class=\"line\">  <span class=\"keyword\">done</span> &lt; &lt;([[ <span class=\"variable\">$effective_java_opts</span> ]] &amp;&amp; xargs <span class=\"built_in\">printf</span> <span class=\"string\">&#x27;%s\\0&#x27;</span> &lt;&lt;&lt;<span class=\"string\">&quot;<span class=\"variable\">$effective_java_opts</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">readonly</span> agent_port_property=<span class=\"string\">&#x27;jenkins.model.Jenkins.slaveAgentPort&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [ -n <span class=\"string\">&quot;<span class=\"variable\">$&#123;JENKINS_SLAVE_AGENT_PORT:-&#125;</span>&quot;</span> ] &amp;&amp; [[ <span class=\"string\">&quot;<span class=\"variable\">$&#123;effective_java_opts:-&#125;</span>&quot;</span> != *<span class=\"string\">&quot;<span class=\"variable\">$&#123;agent_port_property&#125;</span>&quot;</span>* ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    java_opts_array+=( <span class=\"string\">&quot;-D<span class=\"variable\">$&#123;agent_port_property&#125;</span>=<span class=\"variable\">$&#123;JENKINS_SLAVE_AGENT_PORT&#125;</span>&quot;</span> )</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"built_in\">readonly</span> lifecycle_property=<span class=\"string\">&#x27;hudson.lifecycle&#x27;</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$&#123;JAVA_OPTS:-&#125;</span>&quot;</span> != *<span class=\"string\">&quot;<span class=\"variable\">$&#123;lifecycle_property&#125;</span>&quot;</span>* ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    java_opts_array+=( <span class=\"string\">&quot;-D<span class=\"variable\">$&#123;lifecycle_property&#125;</span>=hudson.lifecycle.ExitLifecycle&quot;</span> )</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> [[ <span class=\"string\">&quot;<span class=\"variable\">$DEBUG</span>&quot;</span> ]] ; <span class=\"keyword\">then</span></span><br><span class=\"line\">    java_opts_array+=( \\</span><br><span class=\"line\">      <span class=\"string\">&#x27;-Xdebug&#x27;</span> \\</span><br><span class=\"line\">      <span class=\"string\">&#x27;-Xrunjdwp:server=y,transport=dt_socket,address=*:5005,suspend=y&#x27;</span> \\</span><br><span class=\"line\">    )</span><br><span class=\"line\">  <span class=\"keyword\">fi</span></span><br><span class=\"line\">  jenkins_opts_array=( )</span><br><span class=\"line\">  <span class=\"keyword\">while</span> IFS= <span class=\"built_in\">read</span> -r -d <span class=\"string\">&#x27;&#x27;</span> item; <span class=\"keyword\">do</span></span><br><span class=\"line\">    jenkins_opts_array+=( <span class=\"string\">&quot;<span class=\"variable\">$item</span>&quot;</span> )</span><br><span class=\"line\">  <span class=\"keyword\">done</span> &lt; &lt;([[ <span class=\"variable\">$JENKINS_OPTS</span> ]] &amp;&amp; xargs <span class=\"built_in\">printf</span> <span class=\"string\">&#x27;%s\\0&#x27;</span> &lt;&lt;&lt;<span class=\"string\">&quot;<span class=\"variable\">$JENKINS_OPTS</span>&quot;</span>)</span><br><span class=\"line\">  <span class=\"built_in\">exec</span> java -Duser.home=<span class=\"string\">&quot;<span class=\"variable\">$JENKINS_HOME</span>&quot;</span> -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=<span class=\"literal\">true</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;java_opts_array[@]&#125;</span>&quot;</span> -jar <span class=\"string\">&quot;<span class=\"variable\">$&#123;JENKINS_WAR&#125;</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;jenkins_opts_array[@]&#125;</span>&quot;</span> <span class=\"string\">&quot;<span class=\"variable\">$@</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"comment\"># As argument is not jenkins, assume user wants to run a different process, for example a `bash` shell to explore this image</span></span><br><span class=\"line\"><span class=\"built_in\">exec</span> <span class=\"string\">&quot;<span class=\"variable\">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230603155028149.png\" alt=\"image-20230603155028149\"></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 回滚脚本</span></span><br><span class=\"line\">node(<span class=\"string\">&#x27;testing&#x27;</span>) &#123;</span><br><span class=\"line\">  stage(<span class=\"string\">&#x27;git clone&#x27;</span>) &#123;</span><br><span class=\"line\">    git url: <span class=\"string\">&quot;https://github.com/kbshire/jenkins-rollout.git&quot;</span></span><br><span class=\"line\">    sh <span class=\"string\">&quot;ls -al&quot;</span></span><br><span class=\"line\">    sh <span class=\"string\">&quot;pwd&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  stage(<span class=\"string\">&#x27;select env&#x27;</span>) &#123;</span><br><span class=\"line\">    def envInput = input(</span><br><span class=\"line\">      <span class=\"built_in\">id</span>: <span class=\"string\">&#x27;envInput&#x27;</span>,</span><br><span class=\"line\">      message: <span class=\"string\">&#x27;Choose a deploy environment&#x27;</span>,</span><br><span class=\"line\">      parameters: [</span><br><span class=\"line\">         [</span><br><span class=\"line\">             <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">             choices: <span class=\"string\">&quot;devlopment\\nqatest\\nproduction&quot;</span>,</span><br><span class=\"line\">             name: <span class=\"string\">&#x27;Env&#x27;</span></span><br><span class=\"line\">         ]</span><br><span class=\"line\">     ]</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;This is a deploy step to <span class=\"variable\">$&#123;envInput&#125;</span>&quot;</span></span><br><span class=\"line\">sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class=\"variable\">$&#123;envInput&#125;</span>/&#x27; getVersion.sh&quot;</span></span><br><span class=\"line\">sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class=\"variable\">$&#123;envInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class=\"line\">sh <span class=\"string\">&quot;bash getVersion.sh&quot;</span></span><br><span class=\"line\">// env.WORKSPACE = <span class=\"built_in\">pwd</span>()</span><br><span class=\"line\">// def version = readFile <span class=\"string\">&quot;<span class=\"variable\">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class=\"line\">// println version</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  stage(<span class=\"string\">&#x27;select version&#x27;</span>) &#123;</span><br><span class=\"line\">     env.WORKSPACE = <span class=\"built_in\">pwd</span>()</span><br><span class=\"line\">  def version = readFile <span class=\"string\">&quot;<span class=\"variable\">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class=\"line\">  println version</span><br><span class=\"line\">      def userInput = input(<span class=\"built_in\">id</span>: <span class=\"string\">&#x27;userInput&#x27;</span>,</span><br><span class=\"line\">                                        message: <span class=\"string\">&#x27;选择回滚版本&#x27;</span>,</span><br><span class=\"line\">                                        parameters: [</span><br><span class=\"line\">            [</span><br><span class=\"line\">                 <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">                 choices: <span class=\"string\">&quot;<span class=\"variable\">$version</span>\\n&quot;</span>,</span><br><span class=\"line\">                 name: <span class=\"string\">&#x27;Version&#x27;</span></span><br><span class=\"line\">       ]</span><br><span class=\"line\">      ]</span><br><span class=\"line\">)</span><br><span class=\"line\">       sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;version&gt;/<span class=\"variable\">$&#123;userInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">  stage(<span class=\"string\">&#x27;rollout deploy&#x27;</span>) &#123;</span><br><span class=\"line\">      sh <span class=\"string\">&quot;bash rollout.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Jenkins Pipeline介绍</span><br><span class=\"line\">Jenkins pipeline （流水线）是一套运行于jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。它把持续提交流水线（Continuous Delivery Pipeline）的任务集成到Jenkins中。</span><br><span class=\"line\">pipeline 是jenkins2.X 最核心的特性， 帮助jenkins 实现从CI到CD与DevOps的转变。</span><br><span class=\"line\"></span><br><span class=\"line\">持续提交流水线（Continuous Delivery Pipeline）会经历一个复杂的过程： 从版本控制、向用户和客户提交软件，软件的每次变更（提交代码到仓库）到软件发布（Release）。这个过程包括以一种可靠并可重复的方式构建软件，以及通过多个测试和部署阶段来开发构建好的软件（称为Build）。</span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">1.Jenkins Pipeline是一组插件，让Jenkins可以实现持续交付管道的落地和实施。</span><br><span class=\"line\">2.持续交付管道(CD Pipeline)是将软件从版本控制阶段到交付给用户或客户的完</span><br><span class=\"line\">整过程的自动化表现。</span><br><span class=\"line\">3.软件的每一次更改（提交到源代码管理系统）都要经过一个复杂的过程才能被发布。</span><br><span class=\"line\"></span><br><span class=\"line\">本质上，Jenkins 是一个自动化引擎，它支持许多自动模式。 Pipeline向Jenkins中添加了一组强大的工具, 支持简单的CI到全面的CD pipeline。通过对一系列的相关任务进行建模, 用户可以利用pipeline的很多特性:</span><br><span class=\"line\">1、代码：Pipeline以代码的形式实现，使团队能够编辑，审查和迭代其CD流程。</span><br><span class=\"line\">    2、可持续性：Jenkins重启或者中断后都不会影响Pipeline Job。</span><br><span class=\"line\">    3、停顿：Pipeline可以选择停止并等待人工输入或批准，然后再继续Pipeline运行。</span><br><span class=\"line\">    4、多功能：Pipeline支持现实复杂的CD要求，包括循环和并行执行工作的能力。</span><br><span class=\"line\">    5、可扩展：Pipeline插件支持其DSL的自定义扩展以及与其他插件集成的多个选项。</span><br><span class=\"line\"></span><br><span class=\"line\">DSL 是什么？</span><br><span class=\"line\">DSL 其实是 Domain Specific Language 的缩写，中文翻译为领域特定语言（下简称 DSL）；而与 DSL相对的就是GPL，这里的GPL并不是我们知道的开源许可证，而是 General Purpose Language的简称，即通用编程语言，也就是我们非常熟悉的 Objective-C、Java、Python 以及 C 语言等等。</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline脚本是由groovy 语言实现的</span><br><span class=\"line\">但无需专门学习 groovy</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline支持两种语法：</span><br><span class=\"line\">　-Declarative：声明式</span><br><span class=\"line\">　-Scripted pipeline ：脚本式</span><br><span class=\"line\"></span><br><span class=\"line\">声明式pipeline语法：</span><br><span class=\"line\">官网：</span><br><span class=\"line\">https://www.jenkins.io/doc/book/pipeline/syntax/</span><br><span class=\"line\"></span><br><span class=\"line\">声明式语法包括以下核心流程：</span><br><span class=\"line\">1.pipeline : 声明其内容为一个声明式的pipeline脚本</span><br><span class=\"line\">2.agent:  执行节点（job运行的slave或者master节点）</span><br><span class=\"line\">3.stages: 阶段集合，包裹所有的阶段（例如：打包，部署等各个阶段）</span><br><span class=\"line\">4.stage:  阶段，被stages包裹，一个stages可以有多个stage</span><br><span class=\"line\">5.steps:  步骤,为每个阶段的最小执行单元,被stage包裹</span><br><span class=\"line\">6.post:   执行构建后的操作，根据构建结果来执行对应的操作</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    stages&#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&quot;This is first stage&quot;</span>)&#123;</span><br><span class=\"line\">            steps(<span class=\"string\">&quot;This is first step&quot;</span>)&#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    post&#123;</span><br><span class=\"line\">        always&#123;</span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&quot;The process is ending&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">environment</span><br><span class=\"line\">environment指令指定一系列键值对，这些键值对将被定义为所有step或stage-specific step的环境变量，具体取决于environment指令在Pipeline中的位置。该指令支持一种特殊的方法credentials()，可以通过其在Jenkins环境中的标识符来访问预定义的凭据。对于类型为“Secret Text”的凭据，该 credentials()方法将确保指定的环境变量包含Secret Text内容；对于“标准用户名和密码”类型的凭证，指定的环境变量将被设置为username:password并且将自动定义两个附加的环境变量：MYVARNAME_USR和MYVARNAME_PSW。</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    environment &#123;  </span><br><span class=\"line\">        CC = <span class=\"string\">&#x27;clang&#x27;</span> </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">&#x27;printenv&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">options</span><br><span class=\"line\">options指令允许在Pipeline本身内配置Pipeline专用选项。Pipeline本身提供了许多选项，例如buildDiscarder，但它们也可能由插件提供，例如 timestamps。</span><br><span class=\"line\"></span><br><span class=\"line\">可用选项</span><br><span class=\"line\">buildDiscarder：  pipeline保持构建的最大个数。用于保存Pipeline最近几次运行的数据，例如：options &#123; buildDiscarder(logRotator(numToKeepStr: <span class=\"string\">&#x27;1&#x27;</span>)) &#125;</span><br><span class=\"line\">　　disableConcurrentBuilds： 不允许并行执行Pipeline,可用于防止同时访问共享资源等。例如：options &#123; disableConcurrentBuilds() &#125;</span><br><span class=\"line\">　　skipDefaultCheckout：跳过默认设置的代码check out。例如：options &#123; skipDefaultCheckout() &#125;</span><br><span class=\"line\">　　skipStagesAfterUnstable： 一旦构建状态进入了“Unstable”状态，就跳过此stage。例如：options &#123; skipStagesAfterUnstable() &#125;</span><br><span class=\"line\">　　<span class=\"built_in\">timeout</span>： 设置Pipeline运行的超时时间，超过超时时间，job会自动被终止，例如：options &#123; <span class=\"built_in\">timeout</span>(time: 1, unit: <span class=\"string\">&#x27;HOURS&#x27;</span>) &#125;</span><br><span class=\"line\">　　retry：  失败后，重试整个Pipeline的次数。例如：options &#123; retry(3) &#125;</span><br><span class=\"line\">　　timestamps： 预定义由Pipeline生成的所有控制台输出时间。例如：options &#123; timestamps() &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    options &#123;</span><br><span class=\"line\">        <span class=\"built_in\">timeout</span>(time: 1, unit: <span class=\"string\">&#x27;HOURS&#x27;</span>) </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;Hello World&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;　</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">parameters</span><br><span class=\"line\">parameters指令提供用户在触发Pipeline时的参数列表。这些参数值通过该params对象可用于Pipeline stage中，具体用法如下：</span><br><span class=\"line\">作用域：被最外层pipeline所包裹，并且只能出现一次，参数可被全局使用 </span><br><span class=\"line\">好处：使用parameters好处是能够使参数也变成code,达到pipeline as code，pipeline中设置的参数会自动在job构建的时候生成，形成参数化构建</span><br><span class=\"line\"></span><br><span class=\"line\">可用参数</span><br><span class=\"line\">　　string</span><br><span class=\"line\">　　　　A parameter of a string <span class=\"built_in\">type</span>, <span class=\"keyword\">for</span> example: parameters &#123; string(name: <span class=\"string\">&#x27;DEPLOY_ENV&#x27;</span>, defaultValue: <span class=\"string\">&#x27;staging&#x27;</span>, description: <span class=\"string\">&#x27;&#x27;</span>) &#125;</span><br><span class=\"line\">　　booleanParam</span><br><span class=\"line\">　　　　A boolean parameter, <span class=\"keyword\">for</span> example: parameters &#123; booleanParam(name: <span class=\"string\">&#x27;DEBUG_BUILD&#x27;</span>, defaultValue: <span class=\"literal\">true</span>, description: <span class=\"string\">&#x27;&#x27;</span>) &#125;</span><br><span class=\"line\">　　目前只支持[booleanParam, choice, credentials, file, text, password, run, string]这几种参数类型，其他高级参数化类型还需等待社区支持。</span><br><span class=\"line\"></span><br><span class=\"line\">pipeline&#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    parameters &#123;</span><br><span class=\"line\">        string(name: <span class=\"string\">&#x27;haha&#x27;</span>, defaultValue: <span class=\"string\">&#x27;sb&#x27;</span>, description: <span class=\"string\">&#x27;haha&#x27;</span>)</span><br><span class=\"line\">        booleanParam(name: <span class=\"string\">&#x27;xixi&#x27;</span>, defaultValue: <span class=\"literal\">true</span>, description: <span class=\"string\">&#x27;xixi&#x27;</span>)</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages&#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&quot;stage1&quot;</span>)&#123;</span><br><span class=\"line\">            steps&#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$haha</span>&quot;</span></span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$xixi</span>&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">triggers</span><br><span class=\"line\">triggers指令定义了Pipeline自动化触发的方式。目前有三个可用的触发器：cron和pollSCM和upstream。</span><br><span class=\"line\">用域：被pipeline包裹，在符合条件下自动触发pipeline</span><br><span class=\"line\"></span><br><span class=\"line\">cron</span><br><span class=\"line\">　　接受一个cron风格的字符串来定义Pipeline触发的时间间隔，例如： </span><br><span class=\"line\">triggers &#123; cron(<span class=\"string\">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class=\"line\">pollSCM</span><br><span class=\"line\">　　接受一个cron风格的字符串来定义Jenkins检查SCM源更改的常规间隔。如果存在新的更改，则Pipeline将被重新触发。例如：triggers &#123; pollSCM(<span class=\"string\">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class=\"line\">　　</span><br><span class=\"line\">　　</span><br><span class=\"line\">tools</span><br><span class=\"line\"> 通过tools可自动安装工具，并放置环境变量到PATH。如果agent none，这将被忽略。</span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    tools &#123;</span><br><span class=\"line\">       <span class=\"comment\">#工具名称必须在Jenkins 管理Jenkins → 全局工具配置中预配置。</span></span><br><span class=\"line\">        maven <span class=\"string\">&#x27;apache-maven-3.0.1&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh <span class=\"string\">&#x27;mvn --version&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">input</span><br><span class=\"line\">stage 的 input 指令允许你使用 input step提示输入。 在应用了 options 后，进入 stage 的 agent 或评估 when 条件前，stage 将暂停。 如果 input 被批准, stage 将会继续。 作为 input 提交的一部分的任何参数都将在环境中用于其他 stage</span><br><span class=\"line\">配置项</span><br><span class=\"line\">message</span><br><span class=\"line\">必需的。 这将在用户提交 input 时呈现给用户。</span><br><span class=\"line\"><span class=\"built_in\">id</span></span><br><span class=\"line\">input 的可选标识符， 默认为 stage 名称。</span><br><span class=\"line\">ok</span><br><span class=\"line\">`input`表单上的<span class=\"string\">&quot;ok&quot;</span> 按钮的可选文本。</span><br><span class=\"line\">submitter</span><br><span class=\"line\">可选的以逗号分隔的用户列表或允许提交 input 的外部组名。默认允许任何用户。</span><br><span class=\"line\">submitterParameter</span><br><span class=\"line\">环境变量的可选名称。如果存在，用 submitter 名称设置。</span><br><span class=\"line\">parameters</span><br><span class=\"line\">提示提交者提供的一个可选的参数列表。</span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example&#x27;</span>) &#123;</span><br><span class=\"line\">            input &#123;</span><br><span class=\"line\">                message <span class=\"string\">&quot;Should we continue?&quot;</span></span><br><span class=\"line\">                ok <span class=\"string\">&quot;Yes, we should.&quot;</span></span><br><span class=\"line\">                submitter <span class=\"string\">&quot;222&quot;</span></span><br><span class=\"line\">                parameters &#123;</span><br><span class=\"line\">                    string(name: <span class=\"string\">&#x27;PERSON&#x27;</span>, defaultValue: <span class=\"string\">&#x27;111&#x27;</span>, description: <span class=\"string\">&#x27;Who should I say hello to?&#x27;</span>)</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&quot;Hello, <span class=\"variable\">$&#123;PERSON&#125;</span>, nice to meet you.&quot;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">when</span><br><span class=\"line\">　when指令允许Pipeline根据给定的条件确定是否执行该阶段。该when指令必须至少包含一个条件。如果when指令包含多个条件，则所有子条件必须为stage执行返回<span class=\"literal\">true</span>。这与子条件嵌套在一个allOf条件中相同（见下面的例子）。</span><br><span class=\"line\">更复杂的条件结构可使用嵌套条件建：not，allOf或anyOf。嵌套条件可以嵌套到任意深度。</span><br><span class=\"line\">内置条件</span><br><span class=\"line\">branch</span><br><span class=\"line\">　　　　当正在构建的分支与给出的分支模式匹配时执行，例如：when &#123; branch <span class=\"string\">&#x27;master&#x27;</span> &#125;。请注意，这仅适用于多分支Pipeline。</span><br><span class=\"line\">　　environment</span><br><span class=\"line\">　　　　当指定的环境变量设置为给定值时执行，例如： when &#123; environment name: <span class=\"string\">&#x27;DEPLOY_TO&#x27;</span>, value: <span class=\"string\">&#x27;production&#x27;</span> &#125;</span><br><span class=\"line\">　　expression</span><br><span class=\"line\">　　　　当指定的Groovy表达式求值为<span class=\"literal\">true</span>时执行，例如： when &#123; expression &#123; <span class=\"built_in\">return</span> params.DEBUG_BUILD &#125; &#125;</span><br><span class=\"line\">　　not</span><br><span class=\"line\">　　　　当嵌套条件为<span class=\"literal\">false</span>时执行。必须包含一个条件。例如：when &#123; not &#123; branch <span class=\"string\">&#x27;master&#x27;</span> &#125; &#125;</span><br><span class=\"line\">　　allOf</span><br><span class=\"line\">　　　　当所有嵌套条件都为真时执行。必须至少包含一个条件。例如：when &#123; allOf &#123; branch <span class=\"string\">&#x27;master&#x27;</span>; environment name: <span class=\"string\">&#x27;DEPLOY_TO&#x27;</span>, value: <span class=\"string\">&#x27;production&#x27;</span> &#125; &#125;</span><br><span class=\"line\">　　anyOf</span><br><span class=\"line\">　　　　当至少一个嵌套条件为真时执行。必须至少包含一个条件。例如：when &#123; anyOf &#123; branch <span class=\"string\">&#x27;master&#x27;</span>; branch <span class=\"string\">&#x27;staging&#x27;</span> &#125; &#125;</span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example Build&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;Hello World&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Example Deploy&#x27;</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                allOf &#123;</span><br><span class=\"line\">                    branch <span class=\"string\">&#x27;production&#x27;</span></span><br><span class=\"line\">                    environment name: <span class=\"string\">&#x27;DEPLOY_TO&#x27;</span>, value: <span class=\"string\">&#x27;production&#x27;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;Deploying&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Parallel</span><br><span class=\"line\">Declarative Pipeline近期新增了对并行嵌套stage的支持，对耗时长，相互不存在依赖的stage可以使用此方式提升运行效率。除了parallel stage，单个parallel里的多个step也可以使用并行的方式运行。</span><br><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Non-Parallel Stage&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;This stage will be executed first.&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Parallel Stage&#x27;</span>) &#123;</span><br><span class=\"line\">            when &#123;</span><br><span class=\"line\">                branch <span class=\"string\">&#x27;master&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            parallel &#123;</span><br><span class=\"line\">                stage(<span class=\"string\">&#x27;Branch A&#x27;</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        label <span class=\"string\">&quot;for-branch-a&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    steps &#123;</span><br><span class=\"line\">                        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;On Branch A&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                stage(<span class=\"string\">&#x27;Branch B&#x27;</span>) &#123;</span><br><span class=\"line\">                    agent &#123;</span><br><span class=\"line\">                        label <span class=\"string\">&quot;for-branch-b&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    steps &#123;</span><br><span class=\"line\">                        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;On Branch B&quot;</span></span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Pipeline Scripted语法</span><br><span class=\"line\">Groovy脚本不一定适合所有使用者，因此jenkins创建了Declarative pipeline，为编写Jenkins管道提供了一种更简单、更有主见的语法。但是由于脚本化的pipeline是基于groovy的一种DSL语言，所以与Declarative pipeline相比为jenkins用户提供了更巨大的灵活性和可扩展性。</span><br><span class=\"line\">1.流程控制</span><br><span class=\"line\">　pipeline脚本同其它脚本语言一样，从上至下顺序执行，它的流程控制取决于Groovy表达式，如<span class=\"keyword\">if</span>/else条件语句，举例如下：</span><br><span class=\"line\">node &#123;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Example&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (env.BRANCH_NAME == <span class=\"string\">&#x27;master&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;I only execute on the master branch&#x27;</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;I execute elsewhere&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">Declarative pipeline和Scripted pipeline的比较</span><br><span class=\"line\">共同点：</span><br><span class=\"line\">　　两者都是pipeline代码的持久实现，都能够使用pipeline内置的插件或者插件提供的stage，两者都可以利用共享库扩展。</span><br><span class=\"line\">    区别：</span><br><span class=\"line\">　　两者不同之处在于语法和灵活性。Declarative pipeline对用户来说，语法更严格，有固定的组织结构，更容易生成代码段，使其成为用户更理想的选择。但是Scripted pipeline更加灵活，因为Groovy本身只能对结构和语法进行限制，对于更复杂的pipeline来说，用户可以根据自己的业务进行灵活的实现和扩展。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">3774bc6b-f509-4c57-b913-c82d4f20aeb5\tkbshire/****** (dockerhun)</span><br><span class=\"line\">9511af49-48b7-4d13-90ad-0f6d8194b2d7\tadmin/****** (harbor)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node(<span class=\"string\">&#x27;testing&#x27;</span>) &#123;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Clone&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1.Clone Stage&quot;</span></span><br><span class=\"line\">        git url: <span class=\"string\">&quot;https://github.com/kbshire/jenkins-sample.git&quot;</span></span><br><span class=\"line\">        script &#123;</span><br><span class=\"line\">            build_tag = sh(returnStdout: <span class=\"literal\">true</span>, script: <span class=\"string\">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Test&#x27;</span>) &#123;</span><br><span class=\"line\">      <span class=\"built_in\">echo</span> <span class=\"string\">&quot;2.Test Stage&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Build&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;docker build -t 192.168.13.14:85/jenkins-demo/jenkins-demo:<span class=\"variable\">$&#123;build_tag&#125;</span> .&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Push&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class=\"line\">        withCredentials([usernamePassword(credentialsId: <span class=\"string\">&#x27;9511af49-48b7-4d13-90ad-0f6d8194b2d7&#x27;</span>, passwordVariable: <span class=\"string\">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class=\"string\">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;docker login 192.168.13.14:85 -u <span class=\"variable\">$&#123;dockerHubUser&#125;</span> -p <span class=\"variable\">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;docker push 192.168.13.14:85/jenkins-demo/jenkins-demo:<span class=\"variable\">$&#123;build_tag&#125;</span>&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Deploy to dev&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;5. Deploy DEV&quot;</span></span><br><span class=\"line\">\t\tsh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-dev-harbor.yaml&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-dev-harbor.yaml&quot;</span></span><br><span class=\"line\">//        sh <span class=\"string\">&quot;bash running-devlopment.sh&quot;</span></span><br><span class=\"line\">        sh <span class=\"string\">&quot;kubectl apply -f k8s-dev-harbor.yaml  --validate=false&quot;</span></span><br><span class=\"line\">\t&#125;\t</span><br><span class=\"line\">\tstage(<span class=\"string\">&#x27;Promote to qa&#x27;</span>) &#123;\t</span><br><span class=\"line\">\t\tdef userInput = input(</span><br><span class=\"line\">            <span class=\"built_in\">id</span>: <span class=\"string\">&#x27;userInput&#x27;</span>,</span><br><span class=\"line\"></span><br><span class=\"line\">            message: <span class=\"string\">&#x27;Promote to qa?&#x27;</span>,</span><br><span class=\"line\">            parameters: [</span><br><span class=\"line\">                [</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">                    choices: <span class=\"string\">&quot;YES\\nNO&quot;</span>,</span><br><span class=\"line\">                    name: <span class=\"string\">&#x27;Env&#x27;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;This is a deploy step to <span class=\"variable\">$&#123;userInput&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (userInput == <span class=\"string\">&quot;YES&quot;</span>) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-qa-harbor.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-qa-harbor.yaml&quot;</span></span><br><span class=\"line\">//            sh <span class=\"string\">&quot;bash running-qa.sh&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl apply -f k8s-qa-harbor.yaml --validate=false&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sleep 6&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl get pods -n qatest&quot;</span></span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            //exit</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">\tstage(<span class=\"string\">&#x27;Promote to pro&#x27;</span>) &#123;\t</span><br><span class=\"line\">\t\tdef userInput = input(</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"built_in\">id</span>: <span class=\"string\">&#x27;userInput&#x27;</span>,</span><br><span class=\"line\">            message: <span class=\"string\">&#x27;Promote to pro?&#x27;</span>,</span><br><span class=\"line\">            parameters: [</span><br><span class=\"line\">                [</span><br><span class=\"line\">                    <span class=\"variable\">$class</span>: <span class=\"string\">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class=\"line\">                    choices: <span class=\"string\">&quot;YES\\nNO&quot;</span>,</span><br><span class=\"line\">                    name: <span class=\"string\">&#x27;Env&#x27;</span></span><br><span class=\"line\">                ]</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        )</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;This is a deploy step to <span class=\"variable\">$&#123;userInput&#125;</span>&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (userInput == <span class=\"string\">&quot;YES&quot;</span>) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class=\"variable\">$&#123;build_tag&#125;</span>/&#x27; k8s-prod-harbor.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class=\"variable\">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-prod-harbor.yaml&quot;</span></span><br><span class=\"line\">//            sh <span class=\"string\">&quot;bash running-production.sh&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;cat k8s-prod-harbor.yaml&quot;</span></span><br><span class=\"line\">            sh <span class=\"string\">&quot;kubectl apply -f k8s-prod-harbor.yaml --record --validate=false&quot;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装nexus</span><br><span class=\"line\">概念：</span><br><span class=\"line\">Nexus服务器是一个代码包管理的服务器，可以理解 Nexus 服务器是一个巨大的 Library 仓库。Nexus 可以支持管理的工具包括 Maven ， npm 等，对于 JAVA 开发来说，只要用到 Maven 管理就可以了。</span><br><span class=\"line\">Nexus服务器作用：因为传统的中央仓库在国外，其地理位置比较远，下载速度比较缓慢。因此，当公司开发人员数量越来越多时，如果不架设一台自己的Nexus服务器，会产生大量的流量阻塞带宽，并且在出现一些不可抗原因（光缆被挖断）导致无法连接到中央仓库时，开发就会因为无法下载相关依赖包而进度停滞。因此在本地环境部署一台私有的Nexus服务器来缓存所有依赖包，并且将公司内部开发的私有包也部署上去，方便其他开发人员下载，是非常有必要的。因为 Nexus 有权限控制，因此外部人员是无法得到公司内部开发的项目包的。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d -p 8081:8081 -p 8082:8082 -p 8083:8083 -v /etc/localtime:/etc/localtime --name nexus3   sonatype/nexus3</span><br><span class=\"line\"></span><br><span class=\"line\">在日志中，会看到一条消息： Started Sonatype Nexus OSS 3.20.1-01 这意味着Nexus Repository Manager可以使用了。现在转到浏览器并打开</span><br><span class=\"line\">http://your-ip-addr:8081</span><br><span class=\"line\"></span><br><span class=\"line\">第一步：</span><br><span class=\"line\">1、在 pom.xml 文件中声明发布的宿主仓库和 release 版本发布的仓库。</span><br><span class=\"line\">&lt;!-- 发布构件到Nexus --&gt;</span><br><span class=\"line\">    &lt;distributionManagement&gt;</span><br><span class=\"line\">        &lt;repository&gt;</span><br><span class=\"line\">            &lt;<span class=\"built_in\">id</span>&gt;releases&lt;/id&gt;</span><br><span class=\"line\">            &lt;name&gt;nexus-releases&lt;/name&gt;</span><br><span class=\"line\">            &lt;url&gt;http://192.168.40.133:8081/repository/maven-releases/&lt;/url&gt;</span><br><span class=\"line\">        &lt;/repository&gt;</span><br><span class=\"line\">        &lt;snapshotRepository&gt;</span><br><span class=\"line\">            &lt;<span class=\"built_in\">id</span>&gt;snapshots&lt;/id&gt;</span><br><span class=\"line\">            &lt;name&gt;nexus-snapshots&lt;/name&gt;</span><br><span class=\"line\">            &lt;url&gt;http://192.168.40.133:8081/repository/maven-snapshots/&lt;/url&gt;</span><br><span class=\"line\">        &lt;/snapshotRepository&gt;</span><br><span class=\"line\">    &lt;/distributionManagement&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">第二步：在 settings.xml 文件中配置 </span><br><span class=\"line\">由于用 Maven 分发构件到远程仓库需要认证，须要在~/.m2/settings.xml或者中加入验证信息：</span><br><span class=\"line\">&lt;servers&gt;  </span><br><span class=\"line\">   &lt;server&gt;  </span><br><span class=\"line\">           &lt;<span class=\"built_in\">id</span>&gt;public&lt;/id&gt;  </span><br><span class=\"line\">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class=\"line\">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class=\"line\">       &lt;/server&gt;  </span><br><span class=\"line\">   &lt;server&gt;  </span><br><span class=\"line\">           &lt;<span class=\"built_in\">id</span>&gt;releases&lt;/id&gt;  </span><br><span class=\"line\">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class=\"line\">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class=\"line\">       &lt;/server&gt;  </span><br><span class=\"line\">   &lt;server&gt;  </span><br><span class=\"line\">           &lt;<span class=\"built_in\">id</span>&gt;snapshots&lt;/id&gt;  </span><br><span class=\"line\">           &lt;username&gt;admin&lt;/username&gt;  </span><br><span class=\"line\">           &lt;password&gt;123456&lt;/password&gt;  </span><br><span class=\"line\">       &lt;/server&gt;  </span><br><span class=\"line\"> &lt;/servers&gt;  </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">注意： settings.xml 中 server 元素下 <span class=\"built_in\">id</span> 的值必须与 POM 中 repository 或 snapshotRepository 下 <span class=\"built_in\">id</span> 的值完全一致 。　</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装gitlab</span><br><span class=\"line\">在192.168.40.135上安装</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d  -p 443:443 -p 80:80 -p 222:22 --name gitlab --restart always -v /home/gitlab/config:/etc/gitlab -v /home/gitlab/logs:/var/log/gitlab -v /home/gitlab/data:/var/opt/gitlab gitlab/gitlab-ce  gitlab/gitlab-ce</span><br><span class=\"line\"></span><br><span class=\"line\">改配置：</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /home/gitlab/config/gitlab.rb</span><br><span class=\"line\">增加如下三行：</span><br><span class=\"line\">external_url <span class=\"string\">&#x27;http://192.168.40.135&#x27;</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">&#x27;gitlab_ssh_host&#x27;</span>] = <span class=\"string\">&#x27;192.168.40.135&#x27;</span></span><br><span class=\"line\">gitlab_rails[<span class=\"string\">&#x27;gitlab_shell_ssh_port&#x27;</span>] = 222</span><br><span class=\"line\"></span><br><span class=\"line\">重启docker：</span><br><span class=\"line\">docker restart gitlab</span><br><span class=\"line\"></span><br><span class=\"line\">登录192.168.40.135即可登录：</span><br><span class=\"line\">第一次登录注册账号密码之后，报错如下：</span><br><span class=\"line\">Your account is pending approval from your GitLab administrator and hence bl</span><br><span class=\"line\"></span><br><span class=\"line\">可通过如下方法实现：</span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># docker exec -it gitlab sh</span></span><br><span class=\"line\">irb(main):004:0&gt; u=User.<span class=\"built_in\">where</span>(<span class=\"built_in\">id</span>:1).first</span><br><span class=\"line\">=&gt; <span class=\"comment\">#&lt;User id:1 @root&gt;</span></span><br><span class=\"line\">irb(main):005:0&gt; u.password=<span class=\"string\">&#x27;12345678&#x27;</span></span><br><span class=\"line\">=&gt; <span class=\"string\">&quot;12345678&quot;</span></span><br><span class=\"line\">irb(main):006:0&gt; u.password_confirmation=<span class=\"string\">&#x27;12345678&#x27;</span> </span><br><span class=\"line\">=&gt; <span class=\"string\">&quot;12345678&quot;</span></span><br><span class=\"line\">irb(main):007:0&gt; u.save!</span><br><span class=\"line\">=&gt; <span class=\"literal\">true</span></span><br><span class=\"line\"></span><br><span class=\"line\">再次登录192.168.40.135</span><br><span class=\"line\"></span><br><span class=\"line\">用户名是root</span><br><span class=\"line\">密码是12345678</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># -d：后台运行</span></span><br><span class=\"line\"><span class=\"comment\"># -p：将容器内部端口向外映射</span></span><br><span class=\"line\"><span class=\"comment\"># --name：命名容器名称</span></span><br><span class=\"line\"><span class=\"comment\"># -v：将容器内数据文件夹或者日志、配置等文件夹挂载到宿主机指定目录</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">在Jenkins安装git插件</span><br><span class=\"line\">系统管理-插件管理-可选插件-搜索git安装即可</span><br><span class=\"line\"></span><br><span class=\"line\">在Jenkins上添加gitlab凭据</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jenkins-jnlp-v2.tar.gz这个压缩包封装的镜像带有mvn命令</span><br><span class=\"line\"></span><br><span class=\"line\">node(<span class=\"string\">&#x27;testing&#x27;</span>) &#123;</span><br><span class=\"line\">   stage(<span class=\"string\">&#x27;Clone&#x27;</span>) &#123;</span><br><span class=\"line\">       <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1.Clone Stage&quot;</span></span><br><span class=\"line\">      git credentialsId: <span class=\"string\">&#x27;gitlab&#x27;</span>, url: <span class=\"string\">&#x27;http://192.168.40.135/root/microservic-test.git &#x27;</span></span><br><span class=\"line\">       script &#123;</span><br><span class=\"line\">           build_tag = sh(returnStdout: <span class=\"literal\">true</span>, script: <span class=\"string\">&#x27;git rev-parse --shortHEAD&#x27;</span>).trim()</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   stage(<span class=\"string\">&#x27;Test&#x27;</span>) &#123;</span><br><span class=\"line\">     <span class=\"built_in\">echo</span> <span class=\"string\">&quot;2.Test Stage&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   stage(<span class=\"string\">&#x27;mvn&#x27;</span>) &#123;</span><br><span class=\"line\">     sh <span class=\"string\">&quot;mvn clean package -D maven.test.skip=true&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   stage(<span class=\"string\">&#x27;Build&#x27;</span>) &#123;</span><br><span class=\"line\">       <span class=\"built_in\">echo</span> <span class=\"string\">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class=\"line\">       sh <span class=\"string\">&quot;cd /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/portal-service&quot;</span></span><br><span class=\"line\">       sh <span class=\"string\">&quot;docker build --tag 192.168.40.132/microservice/jenkins-demo:v1 /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/portal-service/&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">   stage(<span class=\"string\">&#x27;Push&#x27;</span>) &#123;</span><br><span class=\"line\">       <span class=\"built_in\">echo</span> <span class=\"string\">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class=\"line\">       withCredentials([usernamePassword(credentialsId: <span class=\"string\">&#x27;dockerharbor&#x27;</span>,passwordVariable: <span class=\"string\">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class=\"string\">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class=\"line\">           sh <span class=\"string\">&quot;docker login 192.168.40.132 -u <span class=\"variable\">$&#123;dockerHubUser&#125;</span> -p <span class=\"variable\">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class=\"line\">           sh <span class=\"string\">&quot;docker push 192.168.40.132/microservice/jenkins-demo:v1&quot;</span></span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     stage(<span class=\"string\">&#x27;Promoteto pro&#x27;</span>) &#123;    </span><br><span class=\"line\">    sh <span class=\"string\">&quot;kubectl apply -f /home/jenkins/agent/workspace/mvn-gitlab-harbor-springcloud/k8s/portal.yaml&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NXQU5TQU4vYXJ0aWNsZS9kZXRhaWxzLzEyNjI0NzM4Ng==\">(88 条消息) Jenkins 持续集成结合 Docker Swarm 集群实现 Web 应用部署的发布_SWANSAN 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9sZXkuYmVzdC9qZW5raW5zLXBpcGVsaW5lLWdpdC1kb2NrZXItc3dhcm0tYXV0by11cGRhdGUv\">使用 jenkins pipeline 在代码合并后自动打包并部署到 docker swarm – MOCUISHLE (ley.best)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbm92d2luZC9wLzE0NTk0OTM1Lmh0bWw=\">CI/CD 探索与实践 （二、Jenkins+Docker Swarm） - 夜色微光 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTE1ODU2MDkvYXJ0aWNsZS9kZXRhaWxzLzEwOTQ2MDg0Mz9zcG09MTAwMS4yMTAxLjMwMDEuNjY1MC4xJmFtcDt1dG1fbWVkaXVtPWRpc3RyaWJ1dGUucGNfcmVsZXZhbnQubm9uZS10YXNrLWJsb2ctMn5kZWZhdWx0fkNUUkxJU1R+UmF0ZS0xLTEwOTQ2MDg0My1ibG9nLTEyNDI2MjIzOC4yMzUlNUV2MzYlNUVwY19yZWxldmFudF9hbnRpX3ZpcF9iYXNlJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTA5NDYwODQzLWJsb2ctMTI0MjYyMjM4LjIzNSU1RXYzNiU1RXBjX3JlbGV2YW50X2FudGlfdmlwX2Jhc2UmYW1wO3V0bV9yZWxldmFudF9pbmRleD0y\">(88 条消息) 最新最全最详细 jenkins pipeline+docker swarm+sonar+junit 实现 java maven 应用的 devops_淡远的博客 - CSDN 博客</span></p>\n<h2 id=\"istio\"><a class=\"markdownIt-Anchor\" href=\"#istio\">#</a> istio</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">官方文档：https://istio.io/docs/concepts/what-is-istio/</span><br><span class=\"line\">中文官方文档：https://istio.io/zh/docs/concepts/what-is-istio/</span><br><span class=\"line\">Github地址：https://github.com/istio/istio/releases</span><br><span class=\"line\"></span><br><span class=\"line\">1、连接（Connect）：智能控制服务之间的调用流量，能够实现灰度升级、AB 测试和蓝绿部署等功能</span><br><span class=\"line\">2、安全加固（Secure）：自动为服务之间的调用提供认证、授权和加密。</span><br><span class=\"line\">3、控制（Control）：应用用户定义的 policy，保证资源在消费者中公平分配。</span><br><span class=\"line\">4、观察（Observe）：查看服务运行期间的各种数据，比如日志、监控和 tracing，了解服务的运行情况。</span><br><span class=\"line\"></span><br><span class=\"line\">Istio是ServiceMesh的产品化落地，可以通过在现有的服务器新增部署边车代理(sidecar proxy)，应用程序不用改代码，或者只需要改很少的代码，就能实现如下基础功能：</span><br><span class=\"line\">1、帮助微服务之间建立连接，帮助研发团队更好的管理与监控微服务，并使得系统架构更加安全；</span><br><span class=\"line\">2、帮助微服务分层解耦，解耦后的proxy层能够更加专注于提供基础架构能力，例如：</span><br><span class=\"line\">（1）服务发现(discovery);</span><br><span class=\"line\">（2）负载均衡(load balancing);</span><br><span class=\"line\">（3）故障恢复(failure recovery);</span><br><span class=\"line\">（4）服务度量(metrics);</span><br><span class=\"line\">（5）服务监控(monitoring);</span><br><span class=\"line\">（6）A/B测试(A/B testing);</span><br><span class=\"line\">（7）灰度发布(canary rollouts);</span><br><span class=\"line\">（8）限流限速(rate limiting);</span><br><span class=\"line\">（9）访问控制(access control);</span><br><span class=\"line\">（10）身份认证(end-to-end authentication)。</span><br><span class=\"line\"></span><br><span class=\"line\">RPC：RPC（Remote Procedure Call）远程过程调用，简单的理解是一个节点请求另一个节点提供的服务</span><br><span class=\"line\"></span><br><span class=\"line\">负载均衡</span><br><span class=\"line\">把前端的请求分发到后台多个服务器</span><br><span class=\"line\"></span><br><span class=\"line\">故障恢复</span><br><span class=\"line\">出现故障具备自恢复的能力</span><br><span class=\"line\"></span><br><span class=\"line\">服务度量</span><br><span class=\"line\">对于 HTTP，HTTP/2 和 GRPC 流量，Istio 生成以下指标：</span><br><span class=\"line\">1、请求计数（istio_requests_total）：这是一个用于累加每个由 Istio 代理所处理请求的 COUNTER 指标。</span><br><span class=\"line\">2、请求持续时间（istio_request_duration_seconds）：这是一个用于测量请求的持续时间的 DISTRIBUTION 指标。</span><br><span class=\"line\">3、请求大小（istio_request_bytes）：这是一个用于测量 HTTP 请求 body 大小的 DISTRIBUTION 指标。</span><br><span class=\"line\">4、响应大小（istio_response_bytes）：这是一个用于测量 HTTP 响应 body 大小的 DISTRIBUTION 指标。</span><br><span class=\"line\">对于 TCP 流量，Istio 生成以下指标：</span><br><span class=\"line\">1、Tcp 发送字节数（istio_tcp_sent_bytes_total）：这是一个用于测量在 TCP 连接下响应期间发送的总字节数的 COUNTER 指标。</span><br><span class=\"line\">2、Tcp 接收字节数（istio_tcp_received_bytes_total）：这是一个用于测量在 TCP 连接下请求期间接收的总字节数的COUNTER指标。</span><br><span class=\"line\">3、Tcp 打开连接数（istio_tcp_connections_opened_total）：这是一个用于累加每个打开连接的 COUNTER 指标。</span><br><span class=\"line\">4、Tcp 关闭连接数 (istio_tcp_connections_closed_total) : 这是一个用于累加每个关闭连接的 COUNTER 指标。</span><br><span class=\"line\"></span><br><span class=\"line\">灰度发布</span><br><span class=\"line\">灰度发布也叫金丝雀发布，起源是，矿井工人发现，金丝雀对瓦斯气体很敏感，矿工会在下井之前，先放一只金丝雀到井中，如果金丝雀不叫了，就代表瓦斯浓度高。</span><br><span class=\"line\"></span><br><span class=\"line\">Istio核心特性</span><br><span class=\"line\">1、流控(traffic management)</span><br><span class=\"line\">断路器(circuit breakers)、超时、重试、多路由规则、AB测试、灰度发布、按照百分比分配流量等。</span><br><span class=\"line\"></span><br><span class=\"line\">2、安全(security)</span><br><span class=\"line\">加密、身份认证、服务到服务的权限控制、K8S里容器到容器的权限控制等。</span><br><span class=\"line\"></span><br><span class=\"line\">3、可观察(observability)</span><br><span class=\"line\">追踪、监控、数据收集，通过控制后台全面了解上行下行流量，服务链路情况，服务运行情况，系统性能情况，国内微服务架构体系，这一块做得比较缺乏。</span><br><span class=\"line\"></span><br><span class=\"line\">4、平台无关系(platform support)</span><br><span class=\"line\">K8s，物理机，自己的虚机都没问题。</span><br><span class=\"line\"></span><br><span class=\"line\">5、集成与定制(integration and customization)</span><br><span class=\"line\">可定制化扩展功能。</span><br><span class=\"line\">1.2.1 断路器</span><br><span class=\"line\">当电路发生故障或异常时，伴随着电流不断升高，并且升高的电流有可能能损坏电路中的某些重要器件，也有可能烧毁电路甚至造成火灾。若电路中正确地安置了保险丝，那么保险丝就会在电流异常升高到一定的高度和热度的时候，自身熔断切断电流，从而起到保护电路安全运行的作用。</span><br><span class=\"line\">断路器也称为服务熔断，在多个服务调用的时候，服务A依赖服务B，服务B依赖服务C，如果服务C响应时间过长或者不可用，则会让服务B占用太多系统资源，而服务A也依赖服B，同时也在占用大量的系统资源，造成系统雪崩的情况出现。 Istio 断路器通过网格中的边车对流量进行拦截判断处理，避免了在代码中侵入控制逻辑，非常方便的就实服务熔断的能力。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607165625825.png\" alt=\"image-20230607165625825\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607170204018.png\" alt=\"image-20230607170204018\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607171256521.png\" alt=\"image-20230607171256521\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在微服务架构中，在高并发情况下，如果请求数量达到一定极限（可以自己设置阈值），超出了设置的阈值，断路器会自动开启服务保护功能，然后通过服务降级的方式返回一个友好的提示给客户端。假设当10个请求中，有10%失败时，熔断器就会打开，此时再调用此服务，将会直接返回失败，不再调远程服务。直到10s钟之后，重新检测该触发条件，判断是否把熔断器关闭，或者继续打开。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">服务降级（提高用户体验效果）</span><br><span class=\"line\">比如电商平台，在针对618、双11的时候会有一些秒杀场景，秒杀的时候请求量大，可能会返回报错标志“当前请求人数多，请稍后重试”等，如果使用服务降级，无法提供服务的时候，消费者会调用降级的操作，返回服务不可用等信息，或者返回提前准备好的静态页面写好的信息。</span><br><span class=\"line\"></span><br><span class=\"line\">超时</span><br><span class=\"line\">在生产环境中经常会碰到由于调用方等待下游的响应过长，堆积大量的请求阻塞了自身服务，造成雪崩的情况，通过超时处理来避免由于无限期等待造成的故障，进而增强服务的可用性。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607172033300.png\" alt=\"image-20230607172033300\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">重试</span><br><span class=\"line\">istio 重试机制就是如果调用服务失败，Envoy 代理尝试连接服务的最大次数。而默认情况下，Envoy 代理在失败后并不会尝试重新连接服务。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607172139477.png\" alt=\"image-20230607172139477\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">客户端调用 nginx，nginx 将请求转发给 tomcat。tomcat 通过故障注入而中止对外服务，nginx 设置如果访问 tomcat 失败则会重试 3 次。</span><br><span class=\"line\"></span><br><span class=\"line\">多路由规则</span><br><span class=\"line\">1、HTTP重定向（HTTPRedirect）</span><br><span class=\"line\">2、HTTP重写（HTTPRewrite）</span><br><span class=\"line\">3、HTTP重试（HTTPRetry）</span><br><span class=\"line\">4、HTTP故障注入（HTTPFaultInjection）</span><br><span class=\"line\">5、HTTP跨域资源共享（CorsPolicy）</span><br></pre></td></tr></table></figure>\n<h3 id=\"架构\"><a class=\"markdownIt-Anchor\" href=\"#架构\">#</a> 架构</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607174630299.png\" alt=\"image-20230607174630299\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、数据平面由一组以Sidecar方式部署的智能代理(Envoy+Polit-agent)组成。这些代理承载并控制微服务之间的所有网络通信，管理入口和出口流量，类似于一线员工。 Sidecar 一般和业务容器绑定在一起（在Kubernets中以自动注入的方式注入到到业务pod中），来劫持业务应用容器的流量，并接受控制面组件的控制，同 时会向控制面输出日志、跟踪及监控数据。</span><br><span class=\"line\"></span><br><span class=\"line\">Envoy 和 pilot-agent 打在同一个镜像中，即sidecar Proxy。</span><br><span class=\"line\"></span><br><span class=\"line\">2、控制平面负责管理和配置代理来路由流量。</span><br><span class=\"line\">istio1.5+中使用了一个全新的部署模式，重建了控制平面，将原有的多个组件整合为一个单体结构istiod，这个组件是控制平面的核心，管理Istio的所有功能，主要包括Pilot、Mixer、Citadel等服务组件。</span><br><span class=\"line\"></span><br><span class=\"line\">istiod是新版本中最大的变化，以一个单体组件替代了原有的架构，降低了复杂度和维护难度，但原有的多组件并不是被完全移除，而是在重构后以模块的形式整合在一起组成了istiod。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607180054619.png\" alt=\"image-20230607180054619\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 自动注入：在创建应用程序时自动注入 Sidecar代理Envoy程序。在 Kubernetes中创建 Pod时，Kube-apiserver调用控制面组件的 Sidecar-Injector服务，自动修改应用程序的描述信息并注入Sidecar。在真正创建Pod时，在创建业务容器的Pod中同时创建Sidecar容器。 </span><br><span class=\"line\"></span><br><span class=\"line\">2. 流量拦截：在Pod初始化时设置iptables 规则，基于配置的iptables规则拦截业务容器的Inbound流量和Outbound流量到Sidecar上。而应用程序感知不到Sidecar的存在，还以原本的方式 进行互相访问。上图中，流出frontend服务的流量会被 frontend服务侧的 Envoy拦截，而当流量到达forecast容器时，Inbound流量被forecast 服务侧的Envoy拦截。</span><br><span class=\"line\"> </span><br><span class=\"line\">3. 服务发现：服务发起方的 Envoy 调用控制面组件 Pilot 的服务发现接口获取目标服务的实例列表。上图中，frontend 服务侧的 Envoy 通过 Pilot 的服务发现接口得到forecast服务各个实例的地址。 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">4. 负载均衡：服务发起方的Envoy根据配置的负载均衡策略选择服务实例，并连接对应的实例地址。上图中，数据面的各个Envoy从Pilot中获取forecast服务的负载均衡配置，并执行负载均衡动作。 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">5. 流量治理：Envoy 从 Pilot 中获取配置的流量规则，在拦截到 Inbound 流量和Outbound 流量时执行治理逻辑。上图中， frontend 服务侧的 Envoy 从 Pilot 中获取流量治理规则，并根据该流量治理规则将不同特征的流量分发到forecast服务的v1或v2版本。 </span><br><span class=\"line\"></span><br><span class=\"line\">6. 访问安全：在服务间访问时通过双方的Envoy进行双向认证和通道加密，并基于服务的身份进行授权管理。上图中，Pilot下发安全相关配置，在frontend服务和forecast服务的Envoy上自动加载证书和密钥来实现双向认证，其中的证书和密钥由另一个管理面组件 Citadel维护。 </span><br><span class=\"line\"></span><br><span class=\"line\">7. 服务监测：在服务间通信时，通信双方的Envoy都会连接管理面组件Mixer上报访问数据，并通过Mixer将数据转发给对应的监控后端。上图中，frontend服务对forecast服务的访问监控指标、日志和调用链都可以通过这种方式收集到对应的监控后端。 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">8. 策略执行：在进行服务访问时，通过Mixer连接后端服务来控制服务间的访问，判断对访问是放行还是拒绝。上图中，Mixer 后端可以对接一个限流服务对从frontend服务到forecast服务的访问进行速率控制等操作。 </span><br><span class=\"line\"></span><br><span class=\"line\">9. 外部访问：在网格的入口处有一个Envoy扮演入口网关的角 色。上图中，外部服务通过Gateway访问入口服务 frontend，对 frontend服务的负载均衡和一些流量治理策略都在这个Gateway上执行。 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">istio组件详解</span><br><span class=\"line\">Istio服务组件有很多，从上面的流程中基本能看出每个组件如何协作的，下面具体讲解每个组件的具体用途和功能。</span><br><span class=\"line\">[root@xianchaomaster1 ~]# kubectl get svc -n istio-system |awk &#x27;&#123;print $1&#125;&#x27;</span><br><span class=\"line\">istio-egressgateway</span><br><span class=\"line\">istio-ingressgateway</span><br><span class=\"line\">istiod</span><br><span class=\"line\"></span><br><span class=\"line\">3.1 Pilot</span><br><span class=\"line\">Pilot 是 Istio 的主要控制组件，下发指令控制客户端。在整个系统中，Pilot 完成以下任务：</span><br><span class=\"line\">1、从 Kubernetes 或者其他平台的注册中心获取服务信息，完成服务发现过程。</span><br><span class=\"line\">2、读取 Istio 的各项控制配置，在进行转换之后，将其发给数据面进行实施。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230607180656237.png\" alt=\"image-20230607180656237\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Pilot 将配置内容下发给数据面的 Envoy，Envoy 根据 Pilot 指令，将路由、服务、监听、集群等定义信息转换为本地配置，完成控制行为的落地。</span><br><span class=\"line\"></span><br><span class=\"line\">1）Pilot为Envoy提供服务发现</span><br><span class=\"line\">2）提供流量管理功能（例如，A/B 测试、金丝雀发布等）以及弹性功能（超时、重试、熔断器等）；</span><br><span class=\"line\">3）生成envoy配置</span><br><span class=\"line\">4）启动envoy</span><br><span class=\"line\">5）监控并管理envoy的运行状况，比如envoy出错时pilot-agent负责重启envoy，或者envoy配置变更后reload envoy</span><br><span class=\"line\"></span><br><span class=\"line\">Envoy是用 C++ 开发的高性能代理，用于协调服务网格中所有服务的入站和出站流量。</span><br><span class=\"line\">Envoy有许多强大的功能，例如:</span><br><span class=\"line\">动态服务发现</span><br><span class=\"line\">负载均衡</span><br><span class=\"line\">TLS终端</span><br><span class=\"line\">HTTP/2与gRPC代理</span><br><span class=\"line\">断路器</span><br><span class=\"line\">健康检查</span><br><span class=\"line\">流量拆分</span><br><span class=\"line\">灰度发布</span><br><span class=\"line\">故障注入</span><br><span class=\"line\"></span><br><span class=\"line\">Citadel</span><br><span class=\"line\">负责处理系统上不同服务之间的TLS通信。 Citadel充当证书颁发机构(CA)，并生成证书以允许在数据平面中进行安全的mTLS通信。</span><br><span class=\"line\"></span><br><span class=\"line\">Citadel是 Istio的核心安全组件，提供了自动生 成、分发、轮换与撤销密钥和证书功能。Citadel一直监听 Kube- apiserver，以 Secret的形式为每个服务都生成证书密钥，并在Pod创建时挂载到Pod上，代理容器使用这些文件来做服务身份认证，进而代 理两端服务实现双向TLS认证、通道加密、访问授权等安全功能。如图 所示，frontend 服 务对 forecast 服务的访问用到了HTTP方式，通过配置即可对服务增加认证功能，双方的Envoy会建立双向认证的TLS通道，从而在服务间启用双向认证的HTTPS。</span><br></pre></td></tr></table></figure>\n<p>Istio 为微服务应用提供了一个完整的解决方案，可以以统一的方式去检测和管理微服务。同时，它还提供了管理流量、实施访问策略、收集数据等功能，而所有这些功能都对业务代码透明，即不需要修改业务代码就能实现。</p>\n<p>有了 Istio，就几乎可以不需要其他的微服务框架，也不需要自己去实现服务治理等功能，只要把网络层委托给 Istio，它就能帮助完成这一系列的功能。简单来说，Istio 就是一个提供了服务治理能力的服务网格。</p>\n<p>对服务网格来讲，业务代码无侵入和网络层的全权代理是其重要的优势。</p>\n<p>Istio 的架构从逻辑上分成数据平面（Data Plane）和控制平面（Control Plane）。</p>\n<ul>\n<li>数据平面：由一组和业务服务成对出现的 Sidecar 代理（Envoy）构成，它的主要功能是接管服务的进出流量，传递并控制服务和 Mixer 组件的所有网络通信（Mixer 是一个策略和遥测数据的收集器，稍后会介绍）。</li>\n<li>控制平面：主要包括了 Pilot、Mixer、Citadel 和 Galley 共 4 个组件，主要功能是通过配置和管理 Sidecar 代理来进行流量控制，并配置 Mixer 去执行策略和收集遥测数据（Telemetry）。</li>\n</ul>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e26fa190dcf620ef885c7e8da25fedfd_720w.webp\" alt=\"img\"></p>\n<h3 id=\"istio的核心控件\"><a class=\"markdownIt-Anchor\" href=\"#istio的核心控件\">#</a> <strong>Istio 的核心控件</strong></h3>\n<h3 id=\"k8s安装istio\"><a class=\"markdownIt-Anchor\" href=\"#k8s安装istio\">#</a> k8s 安装 istio</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://github.com/istio/istio/</span><br><span class=\"line\"></span><br><span class=\"line\">1、把压缩包上传到k8s的控制节点。手动解压：</span><br><span class=\"line\">[root@ ~]# tar zxvf istio-1.13.1.tar.gz </span><br><span class=\"line\">2、切换到istio包所在目录下。tar zxvf istio-1.13.1.tar.gz解压的软件包包名是istio-1.13.1，则：</span><br><span class=\"line\">cd istio-1.13.1</span><br><span class=\"line\">安装目录包含如下内容：</span><br><span class=\"line\">2）samples/目录下，有示例应用程序</span><br><span class=\"line\">3）bin/目录下，包含istioctl的客户端文件。istioctl工具用于手动注入Envoy sidecar代理。</span><br><span class=\"line\"></span><br><span class=\"line\">3、将istioctl客户端路径增加到path环境变量中，macOS 或 Linux 系统的增加方式如下：</span><br><span class=\"line\">export PATH=$PWD/bin:$PATH</span><br><span class=\"line\">4、把istioctl这个可执行文件拷贝到/usr/bin/目录</span><br><span class=\"line\">cd /root/istio-1.13.1/bin/</span><br><span class=\"line\">cp -ar istioctl /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\">4.2 安装istio</span><br><span class=\"line\">1.下载镜像：</span><br><span class=\"line\">安装istio需要的镜像默认从官网拉取，但是官网的镜像我们拉取会有问题，可以从课件下载镜像，然后上传到自己k8s集群的各个节点，通过docker load -i手动解压镜像：</span><br><span class=\"line\"></span><br><span class=\"line\">docker load -i  examples-bookinfo-details.tar.gz      </span><br><span class=\"line\">docker load -i  examples-bookinfo-reviews-v1.tar.gz </span><br><span class=\"line\">docker load -i  examples-bookinfo-productpage.tar.gz  </span><br><span class=\"line\">docker load -i  examples-bookinfo-reviews-v2.tar.gz</span><br><span class=\"line\">docker load -i  examples-bookinfo-ratings.tar.gz     </span><br><span class=\"line\">docker load -i  examples-bookinfo-reviews-v3.tar.gz</span><br><span class=\"line\">docker load -i  pilot.tar.gz</span><br><span class=\"line\">docker load -i  proxyv2.tar.gz</span><br><span class=\"line\">docker load -i  httpbin.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">master:</span><br><span class=\"line\">istioctl install --set profile=demo -y</span><br><span class=\"line\"></span><br><span class=\"line\">4.卸载istio集群，暂时不执行，记住这个命令即可</span><br><span class=\"line\">istioctl manifest generate --set profile=demo | kubectl delete -f -</span><br></pre></td></tr></table></figure>\n<h3 id=\"istio核心资源\"><a class=\"markdownIt-Anchor\" href=\"#istio核心资源\">#</a> <strong>istio 核心资源</strong></h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Gateway\t</span><br><span class=\"line\">在Kubernetes环境中，Ingress controller用于管理进入集群的流量。在Istio服务网格中 Istio Ingress Gateway承担相应的角色，它使用新的配置模型（Gateway 和 VirtualServices）完成流量管理的功能。通过下图做一个总的描述。</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81NDEyMzk5Ng==\">K8s 为何需要 Istio？较为深入地讨论 Istio—— 其历史发展、设计理念、核心功能原理及运行流程 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81Mzg1ODUwMQ==\">浅谈 Service Mesh: 其定义、起源、出现背景和设计理念及作用 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84MTU0NjU3Ng==\">Istio 入门：什么是 Istio？Istio 的 4 个主要功能和实现原理 - 知乎 (zhihu.com)</span></p>\n<h2 id=\"helm\"><a class=\"markdownIt-Anchor\" href=\"#helm\">#</a> helm</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Helm是kubernetes的包管理工具，相当于linux环境下的yum/apg-get命令。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Helm中的一些概念：</span><br><span class=\"line\">（1）helm：命令行客户端工具，主要用于Kubernetes应用中的chart的创建、打包、发布和管理。</span><br><span class=\"line\">（2）Chart：helm程序包，一系列用于描述k8s资源相关文件的集合，比方说我们部署nginx，需要deployment的yaml，需要service的yaml，这两个清单文件就是一个helm程序包，在k8s中把这些yaml清单文件叫做chart图表。</span><br><span class=\"line\">vlues.yaml文件为模板中的文件赋值，可以实现我们自定义安装</span><br><span class=\"line\">如果是chart开发者需要自定义模板，如果是chart使用者只需要修改values.yaml即可</span><br><span class=\"line\"></span><br><span class=\"line\">repository：存放chart图表的仓库，提供部署k8s应用程序需要的那些yaml清单文件</span><br><span class=\"line\"></span><br><span class=\"line\">chart---&gt;通过values.yaml这个文件赋值--&gt;生成release实例</span><br><span class=\"line\">helm也是go语言开发的</span><br><span class=\"line\"></span><br><span class=\"line\">（3）Release：基于Chart的部署实体，一个chart被Helm运行后将会生成对应的一个release；将在k8s中创建出真实运行的资源对象。</span><br><span class=\"line\"></span><br><span class=\"line\">总结：</span><br><span class=\"line\">helm把kubernetes资源打包到一个chart中，制作并完成各个chart和chart本身依赖关系并利用chart仓库实现对外分发，而helm还可通过values.yaml文件完成可配置的发布，如果chart版本更新了，helm自动支持滚更更新机制，还可以一键回滚，但是不是适合在生产环境使用，除非具有定义自制chart的能力。</span><br><span class=\"line\"></span><br><span class=\"line\">https://github.com/helm/helm/releases</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609003730213.png\" alt=\"image-20230609003730213\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf helm-v3.8.1-linux-amd64.tar.gz</span><br><span class=\"line\"> mv linux-amd64/helm /usr/bin/</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">配置国内存放chart仓库的地址</span><br><span class=\"line\">阿里云仓库（https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts）</span><br><span class=\"line\">官方仓库（https://hub.kubeapps.com/charts/incubator）官方chart仓库，国内可能无法访问。</span><br><span class=\"line\">微软仓库（http://mirror.azure.cn/kubernetes/charts/）这个仓库推荐，基本上官网有的chart这里都有，国内可能无法访问。</span><br><span class=\"line\"></span><br><span class=\"line\">#添加阿里云的chart仓库</span><br><span class=\"line\">[root@ ~]# helm repo add aliyun https://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class=\"line\">helm repo add bitnami https://charts.bitnami.com/bitnami</span><br><span class=\"line\"></span><br><span class=\"line\">[root@prometheus-master ~]# helm repo list </span><br><span class=\"line\">NAME   \tURL                                                   </span><br><span class=\"line\">aliyun \thttps://kubernetes.oss-cn-hangzhou.aliyuncs.com/charts</span><br><span class=\"line\">bitnami\thttps://charts.bitnami.com/bitnami         </span><br><span class=\"line\"></span><br><span class=\"line\">helm repo update</span><br><span class=\"line\"></span><br><span class=\"line\">helm repo remove xxx</span><br><span class=\"line\"></span><br><span class=\"line\">#查看阿里云chart仓库中的memcached</span><br><span class=\"line\">[root@ ~]# helm search repo aliyun |grep memcached</span><br><span class=\"line\"></span><br><span class=\"line\">#查看chart信息</span><br><span class=\"line\">[root@ ~]# helm show chart  aliyun/memcached</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#下载chart包到本地</span><br><span class=\"line\">[root@ ~]#  helm pull  aliyun/memcached</span><br><span class=\"line\">[root@ ~]# tar zxvf memcached-2.0.1.tgz</span><br><span class=\"line\">[root@ ~]# cd memcached</span><br><span class=\"line\">[root@ memcached]# ls</span><br><span class=\"line\">Chart.yaml  README.md  templates  values.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">Chart.yaml: chart的基本信息，包括版本名字之类</span><br><span class=\"line\">templates: 存放k8s的部署资源模板，通过渲染变量得到部署文件</span><br><span class=\"line\">values.yaml：存放全局变量，templates下的文件可以调用</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ memcached]# cd templates/</span><br><span class=\"line\">[root@ templates]# ls</span><br><span class=\"line\">_helpers.tpl  NOTES.txt  pdb.yaml  statefulset.yaml  svc.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">_helpers.tpl      存放能够复用的模板</span><br><span class=\"line\">NOTES.txt         为用户提供一个关于chart部署后使用说明的文件</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: StatefulSet</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class=\"line\">    chart: &quot;&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class=\"line\">    release: &quot;&#123;&#123; .Release.Name &#125;&#125;&quot;</span><br><span class=\"line\">    heritage: &quot;&#123;&#123; .Release.Service &#125;&#125;&quot;</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      app: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class=\"line\">      chart: &quot;&#123;&#123; .Chart.Name &#125;&#125;-&#123;&#123; .Chart.Version &#125;&#125;&quot;</span><br><span class=\"line\">      release: &quot;&#123;&#123; .Release.Name &#125;&#125;&quot;</span><br><span class=\"line\">      heritage: &quot;&#123;&#123; .Release.Service &#125;&#125;&quot;</span><br><span class=\"line\">  serviceName: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class=\"line\">  replicas: &#123;&#123; .Values.replicaCount &#125;&#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: &#123;&#123; template &quot;memcached.fullname&quot; . &#125;&#125;</span><br><span class=\"line\">    image: &#123;&#123; .Values.image &#125;&#125;</span><br><span class=\"line\">    imagePullPolicy: &#123;&#123; default &quot;&quot; .Values.imagePullPolicy | quote &#125;&#125;</span><br><span class=\"line\">    command:</span><br><span class=\"line\">    - memcached</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">docker pull memcache:1.4.36-alpine</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">helm install memcache ./</span><br><span class=\"line\"></span><br><span class=\"line\">[root@prometheus-master memcached]# kubectl get pod </span><br><span class=\"line\">NAME                               READY   STATUS    RESTARTS      AGE</span><br><span class=\"line\">memcache-memcached-0               1/1     Running   0             2m13s</span><br><span class=\"line\">memcache-memcached-1               1/1     Running   0             23s</span><br><span class=\"line\">memcache-memcached-2               1/1     Running   0             13s</span><br><span class=\"line\">[root@prometheus-master memcached]# kubectl get svc </span><br><span class=\"line\">NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)     AGE</span><br><span class=\"line\">kubernetes           ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP     14d</span><br><span class=\"line\">memcache-memcached   ClusterIP   None         &lt;none&gt;        11211/TCP   2m43s</span><br><span class=\"line\">[root@prometheus-master memcached]# kubectl get sts</span><br><span class=\"line\">NAME                 READY   AGE</span><br><span class=\"line\">memcache-memcached   3/3     2m59s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">测试：</span><br><span class=\"line\">[root@prometheus-master memcached]# export POD_NAME=$(kubectl get pods --namespace default -l &quot;app=memcache-memcached&quot; -o jsonpath=&quot;&#123;.items[0].metadata.name&#125;&quot;)</span><br><span class=\"line\">[root@prometheus-master memcached]#   kubectl port-forward $POD_NAME 11211</span><br><span class=\"line\">[root@prometheus-master ~]# echo -e &#x27;set mykey 0 60 5\\r\\nhello\\r&#x27; | nc localhost 11211</span><br><span class=\"line\">STORED</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">helm list</span><br><span class=\"line\"></span><br><span class=\"line\">helm delete memcache</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">当我们安装好helm之后我们可以开始自定义chart，那么我们需要先创建出一个模板如下：</span><br><span class=\"line\">[root@ ~]<span class=\"comment\"># helm create myapp</span></span><br><span class=\"line\">[root@ ~]<span class=\"comment\"># cd myapp/</span></span><br><span class=\"line\">[root@ myapp]<span class=\"comment\"># yum install tree -y</span></span><br><span class=\"line\">[root@prometheus-master myapp]<span class=\"comment\"># tree </span></span><br><span class=\"line\">.</span><br><span class=\"line\">├── charts</span><br><span class=\"line\">├── Chart.yaml</span><br><span class=\"line\">├── templates</span><br><span class=\"line\">│   ├── deployment.yaml</span><br><span class=\"line\">│   ├── _helpers.tpl</span><br><span class=\"line\">│   ├── hpa.yaml</span><br><span class=\"line\">│   ├── ingress.yaml</span><br><span class=\"line\">│   ├── NOTES.txt</span><br><span class=\"line\">│   ├── serviceaccount.yaml</span><br><span class=\"line\">│   ├── service.yaml</span><br><span class=\"line\">│   └── tests</span><br><span class=\"line\">│       └── test-connection.yaml</span><br><span class=\"line\">└── values.yaml</span><br><span class=\"line\"></span><br><span class=\"line\">部署release</span><br><span class=\"line\">[root@ myapp]<span class=\"comment\"># helm install  myapp .</span></span><br><span class=\"line\"></span><br><span class=\"line\">检查values语法格式</span><br><span class=\"line\">[root@ myapp]<span class=\"comment\"># helm lint /root/myapp/</span></span><br><span class=\"line\"></span><br><span class=\"line\">upgrade升级release</span><br><span class=\"line\">[root@ myapp]<span class=\"comment\"># helm upgrade --set service.type=&quot;NodePort&quot; myapp .</span></span><br><span class=\"line\"></span><br><span class=\"line\">回滚release</span><br><span class=\"line\"><span class=\"comment\">#查看历史版本</span></span><br><span class=\"line\">[root@ myapp]<span class=\"comment\"># helm history myapp</span></span><br><span class=\"line\">helm rollback myapp 1</span><br><span class=\"line\"></span><br><span class=\"line\">打包Chart</span><br><span class=\"line\">[root@  myapp]<span class=\"comment\"># helm package /root/myapp/</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">操作release命令</span><br><span class=\"line\">升级release版本</span><br><span class=\"line\">helm upgrade</span><br><span class=\"line\"></span><br><span class=\"line\">回滚release版本</span><br><span class=\"line\">helm rollback</span><br><span class=\"line\"></span><br><span class=\"line\">创建一个release实例</span><br><span class=\"line\">helm install</span><br><span class=\"line\"></span><br><span class=\"line\">卸载release</span><br><span class=\"line\">helm uninstall</span><br><span class=\"line\"></span><br><span class=\"line\">查看历史版本</span><br><span class=\"line\">helm history</span><br><span class=\"line\"></span><br><span class=\"line\">7.6 操作Chart命令</span><br><span class=\"line\"></span><br><span class=\"line\">#检查Chat的语法</span><br><span class=\"line\">helm lint</span><br><span class=\"line\"></span><br><span class=\"line\">chart相关的</span><br><span class=\"line\">查看chart的详细信息</span><br><span class=\"line\">helm inspect </span><br><span class=\"line\"></span><br><span class=\"line\">把chart下载下来</span><br><span class=\"line\">helm pull</span><br><span class=\"line\"></span><br><span class=\"line\">把chart打包</span><br><span class=\"line\">helm package</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609152643159.png\" alt=\"image-20230609152643159\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230609152653698.png\" alt=\"image-20230609152653698\"></p>\n<h2 id=\"rancher\"><a class=\"markdownIt-Anchor\" href=\"#rancher\">#</a> Rancher</h2>\n<p>Rancher 简介<br>\n Rancher 是一个开源的企业级多集群 Kubernetes 管理平台，实现了 Kubernetes 集群在混合云 + 本地数据中心的集中部署与管理，以确保集群的安全性，加速企业数字化转型。</p>\n<p>Rancher 和 k8s 的区别<br>\n Rancher 和 k8s 都是用来作为容器的调度与编排系统。但是 rancher 不仅能够管理应用容器，更重要的一点是能够管理 k8s 集群。Rancher2.x 底层基于 k8s 调度引擎，通过 Rancher 的封装，用户可以在不熟悉 k8s 概念的情况下轻松的通过 Rancher 来部署容器到 k8s 集群当中。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装rancher</span></span><br><span class=\"line\"><span class=\"comment\"># 修改内核参数</span></span><br><span class=\"line\">modprobe br_netfilter</span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;modprobe br_netfilter&quot;</span> &gt;&gt; /etc/profile</span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/sysctl.d/k8s.conf &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-ip6tables = 1</span></span><br><span class=\"line\"><span class=\"string\">net.bridge.bridge-nf-call-iptables = 1</span></span><br><span class=\"line\"><span class=\"string\">net.ipv4.ip_forward = 1</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">sysctl -p /etc/sysctl.d/k8s.conf</span><br><span class=\"line\"></span><br><span class=\"line\">在rancher上配置阿里云镜像源：</span><br><span class=\"line\"><span class=\"built_in\">mv</span> /etc/yum.repos.d/CentOS-Base.repo  /etc/yum.repos.d/CentOS-Base.repo.backup</span><br><span class=\"line\">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#在rancher配置国内阿里云docker的repo源</span></span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class=\"line\"> </span><br><span class=\"line\">yum install -y yum-utils device-mapper-persistent-data lvm2 wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack ntpdate </span><br><span class=\"line\"> </span><br><span class=\"line\">在rancher上安装docker</span><br><span class=\"line\">yum install docker-ce docker-ce-cli containerd.io -y</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">tee</span> /etc/docker/daemon.json &lt;&lt; <span class=\"string\">&#x27;EOF&#x27;</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"string\">&quot;registry-mirrors&quot;</span>:[<span class=\"string\">&quot;https://rsbud4vc.mirror.aliyuncs.com&quot;</span>,<span class=\"string\">&quot;https://registry.docker-cn.com&quot;</span>,<span class=\"string\">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<span class=\"string\">&quot;https://dockerhub.azk8s.cn&quot;</span>,<span class=\"string\">&quot;http://hub-mirror.c.163.com&quot;</span>,<span class=\"string\">&quot;http://qtid6917.mirror.aliyuncs.com&quot;</span>, <span class=\"string\">&quot;https://rncxm540.mirror.aliyuncs.com&quot;</span>],</span><br><span class=\"line\"><span class=\"string\">&quot;exec-opts&quot;</span>: [<span class=\"string\">&quot;native.cgroupdriver=systemd&quot;</span>]</span><br><span class=\"line\">&#125; </span><br><span class=\"line\">[root@rancher ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@rancher ~]<span class=\"comment\"># systemctl restart docker</span></span><br><span class=\"line\">[root@rancher ~]<span class=\"comment\"># systemctl status docker</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">在rancher上操作如下命令：</span><br><span class=\"line\">[root@node1 ~]<span class=\"comment\">#docker load -i rancher-agent_2.6.4.tar.gz</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\">#docker load -i rancher-agent_2.6.4.tar.gz</span></span><br><span class=\"line\">[root@rancher ~]<span class=\"comment\"># docker load -i rancher_2.6.4.tar.gz</span></span><br><span class=\"line\">[root@rancher ~]<span class=\"comment\"># docker run -d --restart=unless-stopped -p 80:80 -p 443:443 --privileged rancher/rancher:v2.6.4</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker ps | grep rancher</span><br><span class=\"line\"></span><br><span class=\"line\">注：unless-stopped，在容器退出时总是重启容器，但是不考虑在Docker守护进程启动时就已经停止了的容器</span><br></pre></td></tr></table></figure>\n<p>访问 rancher IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230610201304940.png\" alt=\"image-20230610201304940\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">NAMESPACE             NAME                                        READY   STATUS              RESTARTS            AGE     IP               NODE                NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">cattle-fleet-system   fleet-agent-77c6d6f87-tw9q6                 0/1     ContainerCreating   0                   47s     &lt;none&gt;           prometheus-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cattle-system         cattle-cluster-agent-778b4cb5cf-fvcrh       1/1     Running             0                   78s     10.244.216.90    prometheus-node1    &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">cattle-system         cattle-cluster-agent-778b4cb5cf-g69nt       1/1     Running             0                   66s     10.244.64.30     prometheus-node2    &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"管理已有集群\"><a class=\"markdownIt-Anchor\" href=\"#管理已有集群\">#</a> 管理已有集群</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620145108499.png\" alt=\"image-20230620145108499\"></p>\n<p>选择通用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620145117206.png\" alt=\"image-20230620145117206\"></p>\n<p>接下来的创建资源的步骤和 kubernetes 自带的 dashboard 或者 kube-sphere 一样，都是图形化页面，不在赘述</p>\n<h2 id=\"二进制安装k8s\"><a class=\"markdownIt-Anchor\" href=\"#二进制安装k8s\">#</a> 二进制安装 k8s</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubeadm和二进制安装k8s适用场景分析</span><br><span class=\"line\">kubeadm是官方提供的开源工具，是一个开源项目，用于快速搭建kubernetes集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm <span class=\"built_in\">join</span> 这两个命令可以快速创建 kubernetes 集群。Kubeadm初始化k8s，所有的组件都是以pod形式运行的，具备故障自恢复能力。</span><br><span class=\"line\">kubeadm是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对k8s架构组件理解不深的话，遇到问题比较难排查。</span><br><span class=\"line\">kubeadm适合需要经常部署k8s，或者对自动化要求比较高的场景下使用。</span><br><span class=\"line\">二进制：在官网下载相关组件的二进制包，如果手动安装，对kubernetes理解也会更全面。 </span><br><span class=\"line\">Kubeadm和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。</span><br></pre></td></tr></table></figure>\n<p>master1 192.168.13.200</p>\n<p>master2 192.168.13.201</p>\n<p>master3 192.168.13.202</p>\n<p>work-node 192.168.13.203</p>\n<p>virtual ip: 192.168.13.244</p>\n<h3 id=\"初始化\"><a class=\"markdownIt-Anchor\" href=\"#初始化\">#</a> 初始化</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置静态IP</span><br><span class=\"line\">配置主机名</span><br><span class=\"line\">配置/etc/hosts</span><br><span class=\"line\">配置免密登录</span><br><span class=\"line\">关闭firewalld</span><br><span class=\"line\">关闭selinux</span><br><span class=\"line\">关闭交换分区</span><br><span class=\"line\">修改内核参数</span><br><span class=\"line\">配置阿里云repo源</span><br><span class=\"line\">配置时间同步</span><br><span class=\"line\">安装并关闭iptables</span><br><span class=\"line\">开启ipvs</span><br><span class=\"line\">安装基础软件包</span><br><span class=\"line\">安装docker-ce</span><br><span class=\"line\">配置docker镜像加速</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装etcd集群\"><a class=\"markdownIt-Anchor\" href=\"#安装etcd集群\">#</a> 安装 etcd 集群</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置etcd工作目录</span><br><span class=\"line\"><span class=\"comment\">#创建配置文件和证书文件存放目录</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># mkdir -p /etc/etcd</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># mkdir -p /etc/etcd/ssl</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># mkdir -p /etc/etcd</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># mkdir -p /etc/etcd/ssl</span></span><br><span class=\"line\">[root@ master3 ~]<span class=\"comment\"># mkdir -p /etc/etcd</span></span><br><span class=\"line\">[root@ master3 ~]<span class=\"comment\"># mkdir -p /etc/etcd/ssl</span></span><br><span class=\"line\"></span><br><span class=\"line\">安装签发证书工具cfssl</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># mkdir /data/work -p</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># cd /data/work/</span></span><br><span class=\"line\"><span class=\"comment\">#cfssl-certinfo_linux-amd64 、cfssljson_linux-amd64 、cfssl_linux-amd64上传到/data/work/目录下</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># ls</span></span><br><span class=\"line\">cfssl-certinfo_linux-amd64  cfssljson_linux-amd64  cfssl_linux-amd64</span><br><span class=\"line\"><span class=\"comment\">#把文件变成可执行权限</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># chmod +x *</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># mv cfssl_linux-amd64 /usr/local/bin/cfssl</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># mv cfssljson_linux-amd64 /usr/local/bin/cfssljson</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># mv cfssl-certinfo_linux-amd64 /usr/local/bin/cfssl-certinfo</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置ca证书</span><br><span class=\"line\"><span class=\"comment\">#生成ca证书请求文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim ca-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;ca&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -initca ca-csr.json  | cfssljson -bare ca</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成ca证书文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim ca-config.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;signing&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;default&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">      <span class=\"string\">&quot;profiles&quot;</span>: &#123;</span><br><span class=\"line\">          <span class=\"string\">&quot;kubernetes&quot;</span>: &#123;</span><br><span class=\"line\">              <span class=\"string\">&quot;usages&quot;</span>: [</span><br><span class=\"line\">                  <span class=\"string\">&quot;signing&quot;</span>,</span><br><span class=\"line\">                  <span class=\"string\">&quot;key encipherment&quot;</span>,</span><br><span class=\"line\">                  <span class=\"string\">&quot;server auth&quot;</span>,</span><br><span class=\"line\">                  <span class=\"string\">&quot;client auth&quot;</span></span><br><span class=\"line\">              ],</span><br><span class=\"line\">              <span class=\"string\">&quot;expiry&quot;</span>: <span class=\"string\">&quot;87600h&quot;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">生成etcd证书</span><br><span class=\"line\">    <span class=\"comment\">#配置etcd证书请求，hosts的ip变成自己etcd所在节点的ip</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim etcd-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;etcd&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.200&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.201&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.202&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.244&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">  &#125;]</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson  -bare etcd</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># ls etcd*.pem</span></span><br><span class=\"line\">etcd-key.pem  etcd.pem</span><br><span class=\"line\"></span><br><span class=\"line\">部署etcd集群</span><br><span class=\"line\">把etcd-v3.4.13-linux-amd64.tar.gz上传到/data/work目录下</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># pwd</span></span><br><span class=\"line\">/data/work</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># tar -xf etcd-v3.4.13-linux-amd64.tar.gz</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp -p etcd-v3.4.13-linux-amd64/etcd* /usr/local/bin/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp -r  etcd-v3.4.13-linux-amd64/etcd*  master2:/usr/local/bin/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp -r  etcd-v3.4.13-linux-amd64/etcd*  master3:/usr/local/bin/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建配置文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim etcd.conf </span></span><br><span class=\"line\"><span class=\"comment\">#[Member]</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&quot;etcd1&quot;</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.200:2380&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.200:2379,http://127.0.0.1:2379&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#[Clustering]</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.200:2380&quot;</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.200:2379&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建启动服务文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim etcd.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Etcd Server</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\">After=network-online.target</span><br><span class=\"line\">Wants=network-online.target</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class=\"line\">WorkingDirectory=/var/lib/etcd/</span><br><span class=\"line\">ExecStart=/usr/local/bin/etcd \\</span><br><span class=\"line\">  --cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\">  --key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\">  --trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\">  --peer-cert-file=/etc/etcd/ssl/etcd.pem \\</span><br><span class=\"line\">  --peer-key-file=/etc/etcd/ssl/etcd-key.pem \\</span><br><span class=\"line\">  --peer-trusted-ca-file=/etc/etcd/ssl/ca.pem \\</span><br><span class=\"line\">  --peer-client-cert-auth \\</span><br><span class=\"line\">  --client-cert-auth</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp ca*.pem /etc/etcd/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp etcd*.pem /etc/etcd/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp etcd.conf /etc/etcd/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp etcd.service /usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># for i in  master2  master3;do rsync -vaz etcd.conf $i:/etc/etcd/;done</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># for i in  master2  master3;do rsync -vaz etcd*.pem ca*.pem $i:/etc/etcd/ssl/;done</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># for i in  master2  master3;do rsync -vaz etcd.service $i:/usr/lib/systemd/system/;done</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动etcd集群</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># mkdir -p /var/lib/etcd/default.etcd</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># vim /etc/etcd/etcd.conf </span></span><br><span class=\"line\"><span class=\"comment\">#[Member]</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&quot;etcd2&quot;</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.201:2380&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.201:2379,http://127.0.0.1:2379&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#[Clustering]</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.201:2380&quot;</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.201:2379&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master3 ~]<span class=\"comment\"># vim /etc/etcd/etcd.conf </span></span><br><span class=\"line\"><span class=\"comment\">#[Member]</span></span><br><span class=\"line\">ETCD_NAME=<span class=\"string\">&quot;etcd3&quot;</span></span><br><span class=\"line\">ETCD_DATA_DIR=<span class=\"string\">&quot;/var/lib/etcd/default.etcd&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.202:2380&quot;</span></span><br><span class=\"line\">ETCD_LISTEN_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.202:2379,http://127.0.0.1:2379&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#[Clustering]</span></span><br><span class=\"line\">ETCD_INITIAL_ADVERTISE_PEER_URLS=<span class=\"string\">&quot;https://192.168.13.202:2380&quot;</span></span><br><span class=\"line\">ETCD_ADVERTISE_CLIENT_URLS=<span class=\"string\">&quot;https://192.168.13.202:2379&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER=<span class=\"string\">&quot;etcd1=https://192.168.13.200:2380,etcd2=https://192.168.13.201:2380,etcd3=https://192.168.13.202:2380&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_TOKEN=<span class=\"string\">&quot;etcd-cluster&quot;</span></span><br><span class=\"line\">ETCD_INITIAL_CLUSTER_STATE=<span class=\"string\">&quot;new&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl enable etcd.service</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl start etcd.service</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl enable etcd.service</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl start etcd.service</span></span><br><span class=\"line\"></span><br><span class=\"line\">启动etcd的时候，先启动 master1的etcd服务，会一直卡住在启动的状态，然后接着再启动 master2的etcd，这样 master1这个节点etcd才会正常起来</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl enable etcd.service</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl start etcd.service</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1]<span class=\"comment\"># systemctl status etcd</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl status etcd</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl status etcd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看etcd集群</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># ETCDCTL_API=3</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># /usr/local/bin/etcdctl --write-out=table --cacert=/etc/etcd/ssl/ca.pem --cert=/etc/etcd/ssl/etcd.pem --key=/etc/etcd/ssl/etcd-key.pem --endpoints=https://192.168.13.200:2379,https://192.168.13.201:2379,https://192.168.13.202:2379  endpoint health</span></span><br><span class=\"line\"></span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">|          ENDPOINT          | HEALTH |    TOOK     | ERROR |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+</span><br><span class=\"line\">| https://192.168.13.200:2379 |   <span class=\"literal\">true</span> | 12.614205ms |       |</span><br><span class=\"line\">| https://192.168.13.201:2379 |   <span class=\"literal\">true</span> | 15.762435ms |       |</span><br><span class=\"line\">| https://192.168.13.202:2379 |   <span class=\"literal\">true</span> | 76.066459ms |       |</span><br><span class=\"line\">+----------------------------+--------+-------------+-------+ |</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装kubernetes组件\"><a class=\"markdownIt-Anchor\" href=\"#安装kubernetes组件\">#</a> 安装 kubernetes 组件</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">下载安装包</span><br><span class=\"line\">二进制包所在的github地址如下：</span><br><span class=\"line\">https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/</span><br><span class=\"line\"></span><br><span class=\"line\">#把kubernetes-server-linux-amd64.tar.gz上传到 master1上的/data/work目录下:</span><br><span class=\"line\">[root@ master1 work]# tar zxvf kubernetes-server-linux-amd64.tar.gz</span><br><span class=\"line\">[root@ master1 work]# cd kubernetes/server/bin/</span><br><span class=\"line\">[root@ master1 bin]# cp kube-apiserver kube-controller-manager kube-scheduler kubectl /usr/local/bin/</span><br><span class=\"line\">[root@ master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl  master2:/usr/local/bin/</span><br><span class=\"line\">[root@ master1 bin]# rsync -vaz kube-apiserver kube-controller-manager kube-scheduler kubectl  master3:/usr/local/bin/</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 bin]# scp kubelet kube-proxy  node1:/usr/local/bin/</span><br><span class=\"line\">[root@ master1 bin]# cd /data/work/</span><br><span class=\"line\">[root@ master1 work]# mkdir -p /etc/kubernetes/ </span><br><span class=\"line\">[root@ master1 work]# mkdir -p /etc/kubernetes/ssl</span><br><span class=\"line\">[root@ master1 work]# mkdir /var/log/kubernetes</span><br></pre></td></tr></table></figure>\n<h4 id=\"部署apiserver组件\"><a class=\"markdownIt-Anchor\" href=\"#部署apiserver组件\">#</a> 部署 apiserver 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">部署apiserver组件</span><br><span class=\"line\"><span class=\"comment\">#启动TLS Bootstrapping 机制</span></span><br><span class=\"line\"><span class=\"comment\">#创建token.csv文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cat &gt; token.csv &lt;&lt; EOF</span></span><br><span class=\"line\">$(<span class=\"built_in\">head</span> -c 16 /dev/urandom | <span class=\"built_in\">od</span> -An -t x | <span class=\"built_in\">tr</span> -d <span class=\"string\">&#x27; &#x27;</span>),kubelet-bootstrap,10001,<span class=\"string\">&quot;system:kubelet-bootstrap&quot;</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建csr请求文件，替换为自己机器的IP</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-apiserver-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">    <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.200&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.201&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.202&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.203&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;192.168.13.244&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;10.255.0.1&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;kubernetes.default.svc.cluster.local&quot;</span></span><br><span class=\"line\">  ],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成证书</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建api-server的配置文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-apiserver.conf </span></span><br><span class=\"line\">KUBE_APISERVER_OPTS=<span class=\"string\">&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span></span><br><span class=\"line\"><span class=\"string\">  --anonymous-auth=false \\</span></span><br><span class=\"line\"><span class=\"string\">  --bind-address=192.168.13.200 \\</span></span><br><span class=\"line\"><span class=\"string\">  --secure-port=6443 \\</span></span><br><span class=\"line\"><span class=\"string\">  --advertise-address=192.168.13.200 \\</span></span><br><span class=\"line\"><span class=\"string\">  --insecure-port=0 \\</span></span><br><span class=\"line\"><span class=\"string\">  --authorization-mode=Node,RBAC \\</span></span><br><span class=\"line\"><span class=\"string\">  --runtime-config=api/all=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --enable-bootstrap-token-auth \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-cluster-ip-range=10.255.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --token-auth-file=/etc/kubernetes/token.csv \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-node-port-range=30000-50000 \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-cert-file=/etc/kubernetes/ssl/kube-apiserver.pem  \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-private-key-file=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --client-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubelet-client-certificate=/etc/kubernetes/ssl/kube-apiserver.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubelet-client-key=/etc/kubernetes/ssl/kube-apiserver-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-signing-key-file=/etc/kubernetes/ssl/ca-key.pem  \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span></span><br><span class=\"line\"><span class=\"string\">  --etcd-cafile=/etc/etcd/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --etcd-certfile=/etc/etcd/ssl/etcd.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --etcd-keyfile=/etc/etcd/ssl/etcd-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --etcd-servers=https://192.168.13.200:2379,https://192.168.13.201:2379,https://192.168.13.202:2379 \\</span></span><br><span class=\"line\"><span class=\"string\">  --enable-swagger-ui=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --allow-privileged=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --apiserver-count=3 \\</span></span><br><span class=\"line\"><span class=\"string\">  --audit-log-maxage=30 \\</span></span><br><span class=\"line\"><span class=\"string\">  --audit-log-maxbackup=3 \\</span></span><br><span class=\"line\"><span class=\"string\">  --audit-log-maxsize=100 \\</span></span><br><span class=\"line\"><span class=\"string\">  --audit-log-path=/var/log/kube-apiserver-audit.log \\</span></span><br><span class=\"line\"><span class=\"string\">  --event-ttl=1h \\</span></span><br><span class=\"line\"><span class=\"string\">  --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\">  --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --v=4&quot;</span></span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\">#创建服务启动文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-apiserver.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes API Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=etcd.service</span><br><span class=\"line\">Wants=etcd.service</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-apiserver <span class=\"variable\">$KUBE_APISERVER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">Type=notify</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp ca*.pem /etc/kubernetes/ssl</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-apiserver*.pem /etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp token.csv /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-apiserver.conf /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-apiserver.service /usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz token.csv  master2:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz token.csv  master3:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz ca*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz ca*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver.conf  master2:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver.conf  master3:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver.service  master2:/usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-apiserver.service  master3:/usr/lib/systemd/system/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#  master2和 master3配置文件kube-apiserver.conf的IP地址修改为实际的本机IP</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># cat /etc/kubernetes/kube-apiserver.conf </span></span><br><span class=\"line\">[root@ master3 ~]<span class=\"comment\"># cat /etc/kubernetes/kube-apiserver.conf </span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl enable kube-apiserver</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl enable kube-apiserver</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl enable kube-apiserver</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl start kube-apiserver</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\"># systemctl start kube-apiserver</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\"># systemctl start kube-apiserver</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\">#  systemctl status kube-apiserver</span></span><br><span class=\"line\">[root@ master2 work]<span class=\"comment\">#  systemctl status kube-apiserver</span></span><br><span class=\"line\">[root@ master3 work]<span class=\"comment\">#  systemctl status kube-apiserver</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\">#  curl --insecure https://192.168.40.180:6443/</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;Status&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;metadata&quot;</span>: &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;status&quot;</span>: <span class=\"string\">&quot;Failure&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;message&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;reason&quot;</span>: <span class=\"string\">&quot;Unauthorized&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;code&quot;</span>: 401</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">上面看到401，这个是正常的的状态，还没认证</span><br></pre></td></tr></table></figure>\n<h4 id=\"部署kubectl组件\"><a class=\"markdownIt-Anchor\" href=\"#部署kubectl组件\">#</a> 部署 kubectl 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可以设置一个环境变量KUBECONFIG</span><br><span class=\"line\">[root@  master1 ~]<span class=\"comment\"># export KUBECONFIG =/etc/kubernetes/admin.conf</span></span><br><span class=\"line\">这样在操作kubectl，就会自动加载KUBECONFIG来操作要管理哪个集群的k8s资源了</span><br><span class=\"line\"></span><br><span class=\"line\">也可以按照下面方法</span><br><span class=\"line\">[root@  master1 ~]<span class=\"comment\"># cp /etc/kubernetes/admin.conf /root/.kube/config</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建csr请求文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim admin-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;admin&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hosts&quot;</span>: [],</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:masters&quot;</span>,             </span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成证书</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes admin-csr.json | cfssljson -bare admin</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp admin*.pem /etc/kubernetes/ssl/</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置安全上下文</span><br><span class=\"line\"><span class=\"comment\">#创建kubeconfig配置文件</span></span><br><span class=\"line\">1.设置集群参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube.config</span></span><br><span class=\"line\">2.设置客户端认证参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-credentials admin --client-certificate=admin.pem --client-key=admin-key.pem --embed-certs=true --kubeconfig=kube.config</span></span><br><span class=\"line\">3.设置上下文参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-context kubernetes --cluster=kubernetes --user=admin --kubeconfig=kube.config</span></span><br><span class=\"line\">4.设置当前上下文</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config use-context kubernetes --kubeconfig=kube.config</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># mkdir ~/.kube -p</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube.config ~/.kube/config</span></span><br><span class=\"line\">5.授权kubernetes证书访问kubelet api权限</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl create clusterrolebinding kube-apiserver:kubelet-apis --clusterrole=system:kubelet-api-admin --user kubernetes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看集群组件状态</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl cluster-info</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl get all --all-namespaces</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#同步kubectl文件到其他节点</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># mkdir /root/.kube/</span></span><br><span class=\"line\">[root@ master3 ~]<span class=\"comment\">#  mkdir /root/.kube/</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz /root/.kube/config  master2:/root/.kube/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz /root/.kube/config  master3:/root/.kube/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#配置kubectl子命令补全</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># yum install -y bash-completion</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># source /usr/share/bash-completion/bash_completion</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># source &lt;(kubectl completion bash)</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl completion bash &gt; ~/.kube/completion.bash.inc</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># source &#x27;/root/.kube/completion.bash.inc&#x27;</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># source $HOME/.bash_profile</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"创建kube-controller-manager组件\"><a class=\"markdownIt-Anchor\" href=\"#创建kube-controller-manager组件\">#</a> 创建 kube-controller-manager 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-controller-manager-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.200&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.201&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.202&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.244&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-controller-manager&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成证书</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建kube-controller-manager的kubeconfig</span></span><br><span class=\"line\">1.设置集群参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class=\"line\">2.设置客户端认证参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-credentials system:kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class=\"line\">3.设置上下文参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-context system:kube-controller-manager --cluster=kubernetes --user=system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class=\"line\">4.设置当前上下文</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config use-context system:kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建配置文件kube-controller-manager.conf</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-controller-manager.conf </span></span><br><span class=\"line\">KUBE_CONTROLLER_MANAGER_OPTS=<span class=\"string\">&quot;--port=0 \\</span></span><br><span class=\"line\"><span class=\"string\">  --secure-port=10252 \\</span></span><br><span class=\"line\"><span class=\"string\">  --bind-address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-cluster-ip-range=10.255.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-name=kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-cert-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-signing-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --allocate-node-cidrs=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --cluster-cidr=10.0.0.0/16 \\</span></span><br><span class=\"line\"><span class=\"string\">  --experimental-cluster-signing-duration=87600h \\</span></span><br><span class=\"line\"><span class=\"string\">  --root-ca-file=/etc/kubernetes/ssl/ca.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --service-account-private-key-file=/etc/kubernetes/ssl/ca-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --feature-gates=RotateKubeletServerCertificate=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --controllers=*,bootstrapsigner,tokencleaner \\</span></span><br><span class=\"line\"><span class=\"string\">  --horizontal-pod-autoscaler-use-rest-clients=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --horizontal-pod-autoscaler-sync-period=10s \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-cert-file=/etc/kubernetes/ssl/kube-controller-manager.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --tls-private-key-file=/etc/kubernetes/ssl/kube-controller-manager-key.pem \\</span></span><br><span class=\"line\"><span class=\"string\">  --use-service-account-credentials=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\">  --logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\">  --log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">  --v=2&quot;</span></span><br><span class=\"line\"><span class=\"comment\">#创建启动文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-controller-manager.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Controller Manager</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-controller-manager <span class=\"variable\">$KUBE_CONTROLLER_MANAGER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-controller-manager*.pem /etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-controller-manager.kubeconfig /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-controller-manager.conf /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-controller-manager.service /usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf  master2:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager.kubeconfig kube-controller-manager.conf  master3:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager.service  master2:/usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-controller-manager.service  master3:/usr/lib/systemd/system/</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl daemon-reload </span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl enable kube-controller-manager</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl start kube-controller-manager</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl status kube-controller-manager</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl daemon-reload </span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl enable kube-controller-manager</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl start kube-controller-manager</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl status kube-controller-manager</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl daemon-reload </span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl enable kube-controller-manager</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl start kube-controller-manager</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl status kube-controller-manager</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"创建kube-scheduler组件\"><a class=\"markdownIt-Anchor\" href=\"#创建kube-scheduler组件\">#</a> 创建 kube-scheduler 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建csr请求</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-scheduler-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;hosts&quot;</span>: [</span><br><span class=\"line\">      <span class=\"string\">&quot;127.0.0.1&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.200&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.201&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.202&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;192.168.13.244&quot;</span></span><br><span class=\"line\">    ],</span><br><span class=\"line\">    <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;system:kube-scheduler&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成证书</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建kube-scheduler的kubeconfig</span></span><br><span class=\"line\">1.设置集群参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">2.设置客户端认证参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-credentials system:kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">3.设置上下文参数</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-context system:kube-scheduler --cluster=kubernetes --user=system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">4.设置当前上下文</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config use-context system:kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建配置文件kube-scheduler.conf</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-scheduler.conf </span></span><br><span class=\"line\">KUBE_SCHEDULER_OPTS=<span class=\"string\">&quot;--address=127.0.0.1 \\</span></span><br><span class=\"line\"><span class=\"string\">--kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span></span><br><span class=\"line\"><span class=\"string\">--leader-elect=true \\</span></span><br><span class=\"line\"><span class=\"string\">--alsologtostderr=true \\</span></span><br><span class=\"line\"><span class=\"string\">--logtostderr=false \\</span></span><br><span class=\"line\"><span class=\"string\">--log-dir=/var/log/kubernetes \\</span></span><br><span class=\"line\"><span class=\"string\">--v=2&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建服务启动文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-scheduler.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Scheduler</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-scheduler <span class=\"variable\">$KUBE_SCHEDULER_OPTS</span></span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-scheduler*.pem /etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-scheduler.kubeconfig /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-scheduler.conf /etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cp kube-scheduler.service /usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler*.pem  master2:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler*.pem  master3:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf  master2:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler.kubeconfig kube-scheduler.conf  master3:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler.service  master2:/usr/lib/systemd/system/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rsync -vaz kube-scheduler.service  master3:/usr/lib/systemd/system/</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl enable kube-scheduler</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl start kube-scheduler</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># systemctl status kube-scheduler</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl enable kube-scheduler</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl start kube-scheduler</span></span><br><span class=\"line\">[root@ master2]<span class=\"comment\"># systemctl status kube-scheduler</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl enable kube-scheduler</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl start kube-scheduler</span></span><br><span class=\"line\">[root@ master3]<span class=\"comment\"># systemctl status kube-scheduler</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#把pause-cordns.tar.gz上传到 node1节点，手动解压</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># docker load -i pause-cordns.tar.gz</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"部署kubelet组件\"><a class=\"markdownIt-Anchor\" href=\"#部署kubelet组件\">#</a> 部署 kubelet 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建kubelet-bootstrap.kubeconfig</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cd /data/work/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># BOOTSTRAP_TOKEN=$(awk -F &quot;,&quot; &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv)</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># rm -r kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\">#  kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-credentials kubelet-bootstrap --token=$&#123;BOOTSTRAP_TOKEN&#125; --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建配置文件kubelet.json</span></span><br><span class=\"line\"><span class=\"string\">&quot;cgroupDriver&quot;</span>: <span class=\"string\">&quot;systemd&quot;</span>要和docker的驱动一致。</span><br><span class=\"line\">address替换为自己 node1的IP地址。</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kubelet.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;kind&quot;</span>: <span class=\"string\">&quot;KubeletConfiguration&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;apiVersion&quot;</span>: <span class=\"string\">&quot;kubelet.config.k8s.io/v1beta1&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;authentication&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;x509&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;clientCAFile&quot;</span>: <span class=\"string\">&quot;/etc/kubernetes/ssl/ca.pem&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;cacheTTL&quot;</span>: <span class=\"string\">&quot;2m0s&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"string\">&quot;anonymous&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;enabled&quot;</span>: <span class=\"literal\">false</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;authorization&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;mode&quot;</span>: <span class=\"string\">&quot;Webhook&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;webhook&quot;</span>: &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;cacheAuthorizedTTL&quot;</span>: <span class=\"string\">&quot;5m0s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;cacheUnauthorizedTTL&quot;</span>: <span class=\"string\">&quot;30s&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;address&quot;</span>: <span class=\"string\">&quot;192.168.13.203&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;port&quot;</span>: 10250,</span><br><span class=\"line\">  <span class=\"string\">&quot;readOnlyPort&quot;</span>: 10255,</span><br><span class=\"line\">  <span class=\"string\">&quot;cgroupDriver&quot;</span>: <span class=\"string\">&quot;systemd&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;hairpinMode&quot;</span>: <span class=\"string\">&quot;promiscuous-bridge&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;serializeImagePulls&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;featureGates&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;RotateKubeletClientCertificate&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;RotateKubeletServerCertificate&quot;</span>: <span class=\"literal\">true</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;clusterDomain&quot;</span>: <span class=\"string\">&quot;cluster.local.&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;clusterDNS&quot;</span>: [<span class=\"string\">&quot;10.255.0.2&quot;</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kubelet.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kubelet</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=docker.service</span><br><span class=\"line\">Requires=docker.service</span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kubelet</span><br><span class=\"line\">ExecStart=/usr/local/bin/kubelet \\</span><br><span class=\"line\">  --bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class=\"line\">  --cert-dir=/etc/kubernetes/ssl \\</span><br><span class=\"line\">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class=\"line\">  --config=/etc/kubernetes/kubelet.json \\</span><br><span class=\"line\">  --network-plugin=cni \\</span><br><span class=\"line\">  --pod-infra-container-image=k8s.gcr.io/pause:3.2 \\</span><br><span class=\"line\">  --alsologtostderr=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --logtostderr=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --log-dir=/var/log/kubernetes \\</span><br><span class=\"line\">  --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># mkdir /etc/kubernetes/ssl -p</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp kubelet-bootstrap.kubeconfig kubelet.json  node1:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp  ca.pem  node1:/etc/kubernetes/ssl/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp  kubelet.service  node1:/usr/lib/systemd/system/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动kubelet服务</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># mkdir /var/lib/kubelet</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># mkdir /var/log/kubernetes</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\">#  systemctl daemon-reload</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl enable kubelet</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl start kubelet</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\">#  systemctl status kubelet</span></span><br><span class=\"line\"></span><br><span class=\"line\">执行如下命令可以看到一个worker节点发送了一个 CSR 请求：</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl get csr</span></span><br><span class=\"line\">NAME                                                   AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc   87s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl certificate approve node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl get csr</span></span><br><span class=\"line\">NAME                                                   AGE     SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class=\"line\">node-csr-SY6gROGEmH0qVZhMVhJKKWN3UaWkKKQzV8dopoIO9Uc   2m25s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl get nodes</span></span><br><span class=\"line\">NAME    STATUS     ROLES    AGE   VERSION</span><br><span class=\"line\"> node1   NotReady   &lt;none&gt;   30s   v1.20.7</span><br></pre></td></tr></table></figure>\n<h4 id=\"部署kube-proxy组件\"><a class=\"markdownIt-Anchor\" href=\"#部署kube-proxy组件\">#</a> 部署 kube-proxy 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#创建csr请求</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-proxy-csr.json </span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;CN&quot;</span>: <span class=\"string\">&quot;system:kube-proxy&quot;</span>,</span><br><span class=\"line\">  <span class=\"string\">&quot;key&quot;</span>: &#123;</span><br><span class=\"line\">    <span class=\"string\">&quot;algo&quot;</span>: <span class=\"string\">&quot;rsa&quot;</span>,</span><br><span class=\"line\">    <span class=\"string\">&quot;size&quot;</span>: 2048</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"string\">&quot;names&quot;</span>: [</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">      <span class=\"string\">&quot;C&quot;</span>: <span class=\"string\">&quot;CN&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;ST&quot;</span>: <span class=\"string\">&quot;Hubei&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;L&quot;</span>: <span class=\"string\">&quot;Wuhan&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;O&quot;</span>: <span class=\"string\">&quot;k8s&quot;</span>,</span><br><span class=\"line\">      <span class=\"string\">&quot;OU&quot;</span>: <span class=\"string\">&quot;system&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  ]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">生成证书</span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建kubeconfig文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.13.200:6443 --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建kube-proxy配置文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-proxy.yaml </span></span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">bindAddress: 192.168.13.203</span><br><span class=\"line\">clientConnection:</span><br><span class=\"line\">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class=\"line\">clusterCIDR: 192.168.13.0/24</span><br><span class=\"line\">healthzBindAddress: 192.168.13.203:10256</span><br><span class=\"line\">kind: KubeProxyConfiguration</span><br><span class=\"line\">metricsBindAddress: 192.168.13.203:10249</span><br><span class=\"line\">mode: <span class=\"string\">&quot;ipvs&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建服务启动文件</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># vim kube-proxy.service </span></span><br><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=Kubernetes Kube-Proxy Server</span><br><span class=\"line\">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"> </span><br><span class=\"line\">[Service]</span><br><span class=\"line\">WorkingDirectory=/var/lib/kube-proxy</span><br><span class=\"line\">ExecStart=/usr/local/bin/kube-proxy \\</span><br><span class=\"line\">  --config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class=\"line\">  --alsologtostderr=<span class=\"literal\">true</span> \\</span><br><span class=\"line\">  --logtostderr=<span class=\"literal\">false</span> \\</span><br><span class=\"line\">  --log-dir=/var/log/kubernetes \\</span><br><span class=\"line\">  --v=2</span><br><span class=\"line\">Restart=on-failure</span><br><span class=\"line\">RestartSec=5</span><br><span class=\"line\">LimitNOFILE=65536</span><br><span class=\"line\"> </span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=multi-user.target</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># scp  kube-proxy.kubeconfig kube-proxy.yaml  node1:/etc/kubernetes/</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\">#scp  kube-proxy.service  node1:/usr/lib/systemd/system/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#启动服务</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># mkdir -p /var/lib/kube-proxy</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl enable kube-proxy</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl  start kube-proxy</span></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl status kube-proxy</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"部署calico组件\"><a class=\"markdownIt-Anchor\" href=\"#部署calico组件\">#</a> 部署 calico 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># docker load -i calico.tar.gz</span></span><br><span class=\"line\"><span class=\"comment\">#把calico.yaml文件上传到 master1上的的/data/work目录</span></span><br><span class=\"line\">[root@ master1 work]<span class=\"comment\"># kubectl apply -f calico.yaml</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># kubectl get pods -n kube-system</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># kubectl get nodes</span></span><br><span class=\"line\">NAME            STATUS   ROLES    AGE   VERSION</span><br><span class=\"line\">node1   Ready    &lt;none&gt;   73m   v1.20.7</span><br></pre></td></tr></table></figure>\n<h4 id=\"部署coredns组件\"><a class=\"markdownIt-Anchor\" href=\"#部署coredns组件\">#</a> 部署 coredns 组件</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># kubectl apply -f coredns.yaml</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># kubectl get pods -n kube-system</span></span><br><span class=\"line\">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">calico-kube-controllers-6949477b58-qvn5b   1/1     Running   0          2m17s</span><br><span class=\"line\">calico-node-lv6w4                            1/1     Running   0          2m18s</span><br><span class=\"line\">coredns-7bf4bd64bd-dt8dq   1/1     Running   0          51s</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># kubectl get svc -n kube-system</span></span><br><span class=\"line\">NAME       TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)                  AGE</span><br><span class=\"line\">kube-dns   ClusterIP   10.255.0.2   &lt;none&gt;        53/UDP,53/TCP,9153/TCP   12m</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看集群状态\"><a class=\"markdownIt-Anchor\" href=\"#查看集群状态\">#</a> 查看集群状态</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get nodes</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>    <span class=\"string\">STATUS</span>   <span class=\"string\">ROLES</span>    <span class=\"string\">AGE</span>   <span class=\"string\">VERSION</span></span><br><span class=\"line\"><span class=\"string\">node1</span>   <span class=\"string\">Ready</span>    <span class=\"string\">&lt;none&gt;</span>   <span class=\"string\">38m</span>   <span class=\"string\">v1.20.7</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 测试</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># docker load -i tomcat.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f tomcat.yaml</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f tomcat-service.yaml</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get svc</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl run busybox --image busybox:1.28 --restart=Never --rm -it busybox -- sh</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># ping www.baidu.com</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># nslookup kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># nslookup tomcat.default.svc.cluster.local</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"keepalivednginx实现高可用\"><a class=\"markdownIt-Anchor\" href=\"#keepalivednginx实现高可用\">#</a> keepalived+nginx 实现高可用</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">把epel.repo传到 master2、 master3、 node1上</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># scp /etc/yum.repos.d/epel.repo  master2:/etc/yum.repos.d/</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># scp /etc/yum.repos.d/epel.repo  master3:/etc/yum.repos.d/</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># scp /etc/yum.repos.d/epel.repo  node1:/etc/yum.repos.d/</span></span><br><span class=\"line\"></span><br><span class=\"line\">1、安装nginx主备：</span><br><span class=\"line\">在 master1和 master2上做nginx主备安装</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\">#  yum install nginx keepalived -y</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\">#  yum install nginx keepalived -y</span></span><br><span class=\"line\">2、修改nginx配置文件。主备一样</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># cat /etc/nginx/nginx.conf</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># cat /etc/nginx/nginx.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\">两个master上nginx配置文件一样</span><br><span class=\"line\">user nginx;</span><br><span class=\"line\">worker_processes auto;</span><br><span class=\"line\">error_log /var/log/nginx/error.log;</span><br><span class=\"line\">pid /run/nginx.pid;</span><br><span class=\"line\"></span><br><span class=\"line\">include /usr/share/nginx/modules/*.conf;</span><br><span class=\"line\"></span><br><span class=\"line\">events &#123;</span><br><span class=\"line\">    worker_connections 1024;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class=\"line\">stream &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    log_format  main  <span class=\"string\">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/k8s-access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    upstream k8s-apiserver &#123;</span><br><span class=\"line\">       server 192.168.13.200:6443;   <span class=\"comment\">#  master1 APISERVER IP:PORT</span></span><br><span class=\"line\">       server 192.168.13.201:6443;   <span class=\"comment\">#  master2 APISERVER IP:PORT</span></span><br><span class=\"line\">       server 192.168.13.202:6443;   <span class=\"comment\">#  master3 APISERVER IP:PORT</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">       listen 16443; <span class=\"comment\"># 由于nginx与master节点复用，这个监听端口不能是6443，否则会冲突</span></span><br><span class=\"line\">       proxy_pass k8s-apiserver;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">http &#123;</span><br><span class=\"line\">    log_format  main  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    access_log  /var/log/nginx/access.log  main;</span><br><span class=\"line\"></span><br><span class=\"line\">    sendfile            on;</span><br><span class=\"line\">    tcp_nopush          on;</span><br><span class=\"line\">    tcp_nodelay         on;</span><br><span class=\"line\">    keepalive_timeout   65;</span><br><span class=\"line\">    types_hash_max_size 2048;</span><br><span class=\"line\"></span><br><span class=\"line\">    include             /etc/nginx/mime.types;</span><br><span class=\"line\">    default_type        application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    server &#123;</span><br><span class=\"line\">        listen       80 default_server;</span><br><span class=\"line\">        server_name  _;</span><br><span class=\"line\"></span><br><span class=\"line\">        location / &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># keepalive配置</span></span><br><span class=\"line\">主keepalived</span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># cat /etc/keepalived/keepalived.conf </span></span><br><span class=\"line\">global_defs &#123; </span><br><span class=\"line\">   notification_email &#123; </span><br><span class=\"line\">     acassen@firewall.loc </span><br><span class=\"line\">     failover@firewall.loc </span><br><span class=\"line\">     sysadmin@firewall.loc </span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class=\"line\">   smtp_server 127.0.0.1 </span><br><span class=\"line\">   smtp_connect_timeout 30 </span><br><span class=\"line\">   router_id NGINX_MASTER</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_nginx &#123;</span><br><span class=\"line\">    script <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123; </span><br><span class=\"line\">    state MASTER </span><br><span class=\"line\">    interface ens33  <span class=\"comment\"># 修改为实际网卡名</span></span><br><span class=\"line\">    virtual_router_id 51 <span class=\"comment\"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class=\"line\">    priority 100    <span class=\"comment\"># 优先级，备服务器设置 90 </span></span><br><span class=\"line\">    advert_int 1    <span class=\"comment\"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class=\"line\">    authentication &#123; </span><br><span class=\"line\">        auth_type PASS      </span><br><span class=\"line\">        auth_pass 1111 </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"comment\"># 虚拟IP</span></span><br><span class=\"line\">    virtual_ipaddress &#123; </span><br><span class=\"line\">        192.168.13.244/24</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_nginx</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class=\"string\">&quot;grep|$$&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$count</span>&quot;</span> -eq 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    systemctl stop keepalived</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># chmod +x  /etc/keepalived/check_nginx.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># cat /etc/keepalived/keepalived.conf </span></span><br><span class=\"line\">global_defs &#123; </span><br><span class=\"line\">   notification_email &#123; </span><br><span class=\"line\">     acassen@firewall.loc </span><br><span class=\"line\">     failover@firewall.loc </span><br><span class=\"line\">     sysadmin@firewall.loc </span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   notification_email_from Alexandre.Cassen@firewall.loc  </span><br><span class=\"line\">   smtp_server 127.0.0.1 </span><br><span class=\"line\">   smtp_connect_timeout 30 </span><br><span class=\"line\">   router_id NGINX_BACKUP</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_script check_nginx &#123;</span><br><span class=\"line\">    script <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">vrrp_instance VI_1 &#123; </span><br><span class=\"line\">    state BACKUP </span><br><span class=\"line\">    interface ens33</span><br><span class=\"line\">    virtual_router_id 51 <span class=\"comment\"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class=\"line\">    priority 90</span><br><span class=\"line\">    advert_int 1</span><br><span class=\"line\">    authentication &#123; </span><br><span class=\"line\">        auth_type PASS      </span><br><span class=\"line\">        auth_pass 1111 </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    virtual_ipaddress &#123; </span><br><span class=\"line\">        192.168.13.244/24</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">        check_nginx</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">count=$(ps -ef |grep nginx | grep sbin | egrep -cv <span class=\"string\">&quot;grep|$$&quot;</span>)</span><br><span class=\"line\"><span class=\"keyword\">if</span> [ <span class=\"string\">&quot;<span class=\"variable\">$count</span>&quot;</span> -eq 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">    systemctl stop keepalived</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># chmod +x /etc/keepalived/check_nginx.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># yum install nginx-mod-stream -y</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># systemctl start nginx</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># systemctl start keepalived</span></span><br><span class=\"line\">[root@ master1 ~]<span class=\"comment\"># systemctl enable nginx keepalived</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># yum install nginx-mod-stream -y</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># systemctl start nginx</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># systemctl start keepalived</span></span><br><span class=\"line\">[root@ master2 ~]<span class=\"comment\"># systemctl enable nginx keepalived</span></span><br><span class=\"line\"></span><br><span class=\"line\">改所有Worker Node（kubectl get node命令查看到的节点）组件配置文件，由原来192.168.13.200修改为192.168.13.244（VIP）。</span><br><span class=\"line\">在所有Worker Node执行：</span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet-bootstrap.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet.json</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kubelet.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kube-proxy.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># sed -i &#x27;s#192.168.13.200:6443#192.168.13.244:16443#&#x27; /etc/kubernetes/kube-proxy.kubeconfig</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@ node1 ~]<span class=\"comment\"># systemctl restart kubelet kube-proxy</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"ackcce\"><a class=\"markdownIt-Anchor\" href=\"#ackcce\">#</a> ACK&amp;&amp;CCE</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">阿里云容器服务Kubernetes版（Alibaba Cloud Container Service for Kubernetes，简称容器服务ACK）是全球首批通过Kubernetes一致性认证的服务平台，提供高性能的容器应用管理服务，支持企业级Kubernetes容器化应用的生命周期管理，让您轻松高效地在云端运行Kubernetes容器化应用。</span><br><span class=\"line\"></span><br><span class=\"line\">ACK包含了专有版Kubernetes（Dedicated Kubernetes）、托管版Kubernetes（Managed Kubernetes）、Serverless Kubernetes三种形态，方便按需选择。</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.aliyun.com/product/kubernetes</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">云容器引擎（Cloud Container Engine）提供高可靠高性能的企业级容器应用管理服务，支持Kubernetes社区原生应用和工具，简化云上自动化容器运行环境搭建，面向云原生2.0打造CCE Turbo容器集群，计算、网络、调度全面加速，全面加速企业应用创新。</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.huaweicloud.com/product/cce.html</span><br></pre></td></tr></table></figure>\n<p>使用 kubernetes 集群</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">只要有kubectl的机器即可，完成购买后他们会提供config</span><br><span class=\"line\">替换/root/.kube/config </span><br><span class=\"line\">即可访问集群，记得需要通过公网ip</span><br><span class=\"line\">kubectl config view 查看是否替换为公网IP</span><br></pre></td></tr></table></figure>\n<h2 id=\"基于hpa和vpa实现pod自动扩缩容\"><a class=\"markdownIt-Anchor\" href=\"#基于hpa和vpa实现pod自动扩缩容\">#</a> 基于 HPA 和 VPA 实现 Pod 自动扩缩容</h2>\n<p>弹性伸缩是根据用户的业务需求和策略，自动 “调整” 其 “弹性资源” 的管理服务。通过弹性伸缩功能，用户可设置定时、周期或监控策略，恰到好处地增加或减少 “弹性资源”，并完成实例配置，保证业务平稳健康运行</p>\n<p>在实际工作中，我们常常需要做一些扩容缩容操作，如：电商平台在 618 和双十一搞秒杀活动；由于资源紧张、工作负载降低等都需要对服务实例数进行扩缩容操作。</p>\n<p>在 k8s 中扩缩容分为两种：</p>\n<p>1、Node 层面：<br>\n对 K8s 物理节点扩容和缩容，根据业务规模实现物理节点自动扩缩容</p>\n<p>2、Pod 层面：<br>\n我们一般会使用 Deployment 中的 replicas 参数，设置多个副本集来保证服务的高可用，但是这是一个固定的值，比如我们设置 10 个副本，就会启 10 个 pod 同时 running 来提供服务。如果这个服务平时流量很少的时候，也是 10 个 pod 同时在 running，而流量突然暴增时，又可能出现 10 个 pod 不够用的情况。针对这种情况怎么办？就需要扩容和缩容</p>\n<h3 id=\"k8s中自动伸缩的方案\"><a class=\"markdownIt-Anchor\" href=\"#k8s中自动伸缩的方案\">#</a> k8s 中自动伸缩的方案</h3>\n<h4 id=\"hpa\"><a class=\"markdownIt-Anchor\" href=\"#hpa\">#</a> HPA</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># HPA</span><br><span class=\"line\">Kubernetes HPA（Horizontal Pod Autoscaling）：Pod水平自动伸缩</span><br><span class=\"line\"></span><br><span class=\"line\">通过此功能，只需简单的配置，便可以利用监控指标（cpu使用率、磁盘、自定义的等）自动的扩容或缩容服务中Pod数量，当业务需求增加时，系统将无缝地自动增加适量pod容器，提高系统稳定性。</span><br><span class=\"line\"></span><br><span class=\"line\">HPA v1版本可以根据CPU使用率来进行自动扩缩容：</span><br><span class=\"line\">但是并非所有的系统都可以仅依靠CPU或者Memory指标来扩容，对于大多数 Web 应用的后端来说，基于每秒的请求数量进行弹性伸缩来处理突发流量会更加的靠谱，所以对于一个自动扩缩容系统来说，我们不能局限于CPU、Memory基础监控数据，每秒请求数RPS等自定义指标也是十分重要。</span><br><span class=\"line\"></span><br><span class=\"line\">HPA v2版本可以根据自定义的指标进行自动扩缩容</span><br><span class=\"line\"></span><br><span class=\"line\">hpa v1只能基于cpu做扩容所用</span><br><span class=\"line\">hpa v2可以基于内存和自定义的指标做扩容和缩容</span><br><span class=\"line\"></span><br><span class=\"line\">如果我们的系统默认依赖Prometheus，自定义的Metrics指标则可以从各种数据源或者exporter中获取，基于拉模型的Prometheus会定期从数据源中拉取数据。 也可以基于metrics-server自动获取节点和pod的资源指标</span><br><span class=\"line\"></span><br><span class=\"line\">K8s的HPA controller已经实现了一套简单的自动扩缩容逻辑，默认情况下，每30s检测一次指标，只要检测到了配置HPA的目标值，则会计算出预期的工作负载的副本数，再进行扩缩容操作。同时，为了避免过于频繁的扩缩容，默认在5min内没有重新扩缩容的情况下，才会触发扩缩容。 HPA本身的算法相对比较保守，可能并不适用于很多场景。例如，一个快速的流量突发场景，如果正处在5min内的HPA稳定期，这个时候根据HPA的策略，会导致无法扩容。</span><br></pre></td></tr></table></figure>\n<h4 id=\"kpa\"><a class=\"markdownIt-Anchor\" href=\"#kpa\">#</a> KPA</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kpa</span></span><br><span class=\"line\">KPA（Knative Pod Autoscaler）：基于请求数对Pod自动扩缩容，KPA 的主要限制在于它不支持基于 CPU 的自动扩缩容。</span><br><span class=\"line\"></span><br><span class=\"line\">1、根据并发请求数实现自动扩缩容</span><br><span class=\"line\">2、设置扩缩容边界实现自动扩缩容</span><br><span class=\"line\"></span><br><span class=\"line\">扩缩容边界指应用程序提供服务的最小和最大Pod数量。通过设置应用程序提供服务的最小和最大Pod数量实现自动扩缩容。</span><br><span class=\"line\">相比HPA，KPA会考虑更多的场景，其中一个比较重要的是流量突发的时候</span><br></pre></td></tr></table></figure>\n<h4 id=\"vpa\"><a class=\"markdownIt-Anchor\" href=\"#vpa\">#</a> VPA</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubernetes VPA（Vertical Pod Autoscaler），垂直 Pod 自动扩缩容，VPA会基于Pod的资源使用情况自动为集群设置资源占用的限制，从而让集群将Pod调度到有足够资源的最佳节点上。VPA也会保持最初容器定义中资源request和<span class=\"built_in\">limit</span>的占比。</span><br><span class=\"line\">它会根据容器资源使用率自动设置pod的CPU和内存的requests，从而允许在节点上进行适当的调度，以便为每个 Pod 提供适当的可用的节点。它既可以缩小过度请求资源的容器，也可以根据其使用情况随时提升资源不足的容量。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HPA全称是Horizontal Pod Autoscaler，翻译成中文是POD水平自动伸缩， HPA可以基于CPU利用率对deployment中的pod数量进行自动扩缩容（除了CPU也可以基于自定义的指标进行自动扩缩容）。pod自动缩放不适用于无法缩放的对象，比如DaemonSets。</span><br><span class=\"line\">HPA由Kubernetes API资源和控制器实现。控制器会周期性的获取平均CPU利用率，并与目标值相比较后调整deployment中的副本数量。</span><br><span class=\"line\"></span><br><span class=\"line\">HPA是根据指标来进行自动伸缩的，目前HPA有两个版本–v1和v2beta</span><br><span class=\"line\"></span><br><span class=\"line\">HPA的API有三个版本，通过kubectl api-versions | grep autoscal可看到</span><br><span class=\"line\">autoscaling/v1</span><br><span class=\"line\">autoscaling/v2beta1</span><br><span class=\"line\">autoscaling/v2beta2</span><br><span class=\"line\"></span><br><span class=\"line\">autoscaling/v1只支持基于CPU指标的缩放；</span><br><span class=\"line\">autoscaling/v2beta1支持Resource Metrics（资源指标，如pod内存）和Custom Metrics（自定义指标）的缩放；</span><br><span class=\"line\">autoscaling/v2beta2支持Resource Metrics（资源指标，如pod的内存）和Custom Metrics（自定义指标）和ExternalMetrics（额外指标）的缩放，但是目前也仅仅是处于beta阶段</span><br><span class=\"line\"></span><br><span class=\"line\">K8S从1.8版本开始，CPU、内存等资源的metrics信息可以通过 Metrics API来获取，用户可以直接获取这些metrics信息（例如通过执行kubect top命令），HPA使用这些metics信息来实现动态伸缩。</span><br><span class=\"line\"></span><br><span class=\"line\">Metrics server：</span><br><span class=\"line\">1、Metrics server是K8S集群资源使用情况的聚合器</span><br><span class=\"line\">2、从1.8版本开始，Metrics server可以通过yaml文件的方式进行部署</span><br><span class=\"line\">3、Metrics server收集所有node节点的metrics信息</span><br><span class=\"line\"></span><br><span class=\"line\">HPA的实现是一个控制循环，由controller manager的--horizontal-pod-autoscaler-sync-period参数指定周期（默认值为15秒）。每个周期内，controller manager根据每个HorizontalPodAutoscaler定义中指定的指标查询资源利用率。controller manager可以从resource metrics API（pod 资源指标）和custom metrics API（自定义指标）获取指标。</span><br><span class=\"line\"></span><br><span class=\"line\">然后，通过现有pods的CPU使用率的平均值（计算方式是最近的pod使用量（最近一分钟的平均值，从metrics-server中获得）除以设定的每个Pod的CPU使用率限额）跟目标使用率进行比较，并且在扩容时，还要遵循预先设定的副本数限制：MinReplicas &lt;= Replicas &lt;= MaxReplicas。</span><br><span class=\"line\"></span><br><span class=\"line\">计算扩容后Pod的个数：<span class=\"built_in\">sum</span>(最近一分钟内某个Pod的CPU使用率的平均值)/CPU使用上限的整数+1</span><br><span class=\"line\"></span><br><span class=\"line\">流程：</span><br><span class=\"line\">1、创建HPA资源，设定目标CPU使用率限额，以及最大、最小实例数</span><br><span class=\"line\">2、收集一组中（PodSelector）每个Pod最近一分钟内的CPU使用率，并计算平均值</span><br><span class=\"line\">3、读取HPA中设定的CPU使用限额</span><br><span class=\"line\">4、计算：平均值之和/限额，求出目标调整的实例个数</span><br><span class=\"line\">5、目标调整的实例数不能超过1中设定的最大、最小实例数，如果没有超过，则扩容；超过，则扩容至最大的实例个数</span><br><span class=\"line\">6、回到2，不断循环</span><br></pre></td></tr></table></figure>\n<h3 id=\"metrics-server\"><a class=\"markdownIt-Anchor\" href=\"#metrics-server\">#</a> metrics-server</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">metrics-server是一个集群范围内的资源数据集和工具，同样的，metrics-server也只是显示数据，并不提供数据存储服务，主要关注的是资源度量API的实现，比如CPU、文件描述符、内存、请求延时等指标，metric-server收集数据给k8s集群内使用，如kubectl,hpa,scheduler等。</span><br><span class=\"line\"></span><br><span class=\"line\">https://github.com/kubernetes-sigs/metrics-server/</span><br><span class=\"line\"></span><br><span class=\"line\">docker load -i metrics-server-0.6.1.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/kubernetes/manifests/kube-apiserver.yaml</span><br><span class=\"line\">    - --enable-aggregator-routing=true</span><br><span class=\"line\"></span><br><span class=\"line\"># 所有节点重启kubelet</span><br><span class=\"line\">systemctl restart kubelet</span><br><span class=\"line\"></span><br><span class=\"line\">在components.yaml中增加如下字段：</span><br><span class=\"line\">kubectl apply -f components.yaml</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230620162201037.png\" alt=\"image-20230620162201037\"></p>\n<h3 id=\"php-apache-利用hpa扩缩容\"><a class=\"markdownIt-Anchor\" href=\"#php-apache-利用hpa扩缩容\">#</a> php-apache 利用 hpa 扩缩容</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">php-apache服务正在运行，使用kubectl</span> <span class=\"string\">autoscale创建自动缩放器，实现对php-apache这个deployment创建的pod自动扩缩容，下面的命令将会创建一个HPA，HPA将会根据CPU，内存等资源指标增加或减少副本数，创建一个可以实现如下目的的hpa：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">）让副本数维持在1-10个之间（这里副本数指的是通过deployment部署的pod的副本数）</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">）将所有Pod的平均CPU使用率维持在50％（通过kubectl</span> <span class=\"string\">run运行的每个pod如果是200毫核，这意味着平均CPU利用率为100毫核）</span></span><br><span class=\"line\"><span class=\"comment\">#给上面php-apache这个deployment创建HPA,基于cpu动态扩缩容</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl autoscale deployment php-apache --cpu-percent=50 --min=1 --max=10</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get hpa </span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建一个hpa，基于内存动态扩缩容</span><br><span class=\"line\">[root@ ~]# cat hpa-v1.yaml </span><br><span class=\"line\">apiVersion: autoscaling/v2</span><br><span class=\"line\">kind: HorizontalPodAutoscaler</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-hpa</span><br><span class=\"line\">spec:</span><br><span class=\"line\">    maxReplicas: 10</span><br><span class=\"line\">    minReplicas: 1</span><br><span class=\"line\">    scaleTargetRef:</span><br><span class=\"line\">      apiVersion: apps/v1</span><br><span class=\"line\">      kind: Deployment</span><br><span class=\"line\">      name: nginx-hpa</span><br><span class=\"line\">    metrics:</span><br><span class=\"line\">    - type: Resource</span><br><span class=\"line\">      resource:</span><br><span class=\"line\">        name: memory</span><br><span class=\"line\">        target:</span><br><span class=\"line\">         averageUtilization: 60</span><br><span class=\"line\">         type: Utilization</span><br><span class=\"line\">         </span><br><span class=\"line\">kubectl get hpa</span><br><span class=\"line\">扩展：查看v2版本的hpa如何定义？</span><br><span class=\"line\">[root@ ~]# kubectl get hpa.v2beta2.autoscaling -o yaml &gt; 1.yaml</span><br></pre></td></tr></table></figure>\n<h3 id=\"vpa-2\"><a class=\"markdownIt-Anchor\" href=\"#vpa-2\">#</a> VPA</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用updateMode: &quot;Off&quot;模式，这种模式仅获取资源推荐值，但是不更新Pod</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: autoscaling.k8s.io/v1beta2</span><br><span class=\"line\">kind: VerticalPodAutoscaler</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-vpa</span><br><span class=\"line\">  namespace: vpa</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  targetRef:</span><br><span class=\"line\">    apiVersion: &quot;apps/v1&quot;</span><br><span class=\"line\">    kind: Deployment</span><br><span class=\"line\">    name: nginx</span><br><span class=\"line\">  updatePolicy:</span><br><span class=\"line\">    updateMode: &quot;Off&quot;</span><br><span class=\"line\">  resourcePolicy:</span><br><span class=\"line\">    containerPolicies:</span><br><span class=\"line\">    - containerName: &quot;nginx&quot;</span><br><span class=\"line\">      minAllowed:</span><br><span class=\"line\">        cpu: &quot;500m&quot;</span><br><span class=\"line\">        memory: &quot;100Mi&quot;</span><br><span class=\"line\">      maxAllowed:</span><br><span class=\"line\">        cpu: &quot;2000m&quot;</span><br><span class=\"line\">        memory: &quot;2600Mi&quot;</span><br><span class=\"line\">        </span><br><span class=\"line\">kubectl get vpa -n vpa</span><br><span class=\"line\"> </span><br><span class=\"line\">Lower Bound:           下限值</span><br><span class=\"line\">Target:                推荐值</span><br><span class=\"line\">Upper Bound:           上限值</span><br><span class=\"line\">Uncapped Target:       如果没有为VPA提供最小或最大边界，则表示目标利用率</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">updateMode: &quot;Auto&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">从输出信息可以看到，vpa执行了EvictedByVPA，自动停掉了nginx，然后使用 VPA推荐的资源启动了新的nginx</span><br><span class=\"line\">，我们查看下nginx的pod可以得到确认</span><br><span class=\"line\"></span><br><span class=\"line\">随着服务的负载的变化，VPA的推荐值也会不断变化。当目前运行的pod的资源达不到VPA的推荐值，就会执行pod驱逐，重新部署新的足够资源的服务。</span><br><span class=\"line\"></span><br><span class=\"line\">VPA使用限制：</span><br><span class=\"line\">不能与HPA（Horizontal Pod Autoscaler ）一起使用</span><br><span class=\"line\">Pod比如使用副本控制器，例如属于Deployment或者StatefulSet</span><br><span class=\"line\"></span><br><span class=\"line\">VPA好处：</span><br><span class=\"line\">Pod 资源用其所需，所以集群节点使用效率高。</span><br><span class=\"line\">Pod 会被安排到具有适当可用资源的节点上。</span><br><span class=\"line\">不必运行基准测试任务来确定 CPU 和内存请求的合适值。</span><br><span class=\"line\">VPA 可以随时调整 CPU 和内存请求，无需人为操作，因此可以减少维护时间。</span><br></pre></td></tr></table></figure>\n<h3 id=\"kubernetes-cluster-autoscaler\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes-cluster-autoscaler\">#</a> kubernetes cluster-autoscaler</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cluster Autoscaler (CA)是一个独立程序，是用来弹性伸缩kubernetes集群的。它可以自动根据部署应用所请求的资源量来动态的伸缩集群。当集群容量不足时，它会自动去 Cloud Provider （支持 GCE、GKE 和 AWS）创建新的 Node，而在 Node 长时间资源利用率很低时自动将其删除以节省开支。</span><br><span class=\"line\"></span><br><span class=\"line\">在以下情况下，集群自动扩容或者缩放：</span><br><span class=\"line\">扩容：由于资源不足，某些Pod无法在任何当前节点上进行调度</span><br><span class=\"line\"></span><br><span class=\"line\">缩容: Node节点资源利用率较低时，且此node节点上存在的pod都能被重新调度到其他node节点上运行</span><br><span class=\"line\"></span><br><span class=\"line\">什么时候集群节点不会被 CA 删除?</span><br><span class=\"line\">1）节点上有pod被 PodDisruptionBudget 控制器限制。</span><br><span class=\"line\">2）节点上有命名空间是 kube-system 的pods。</span><br><span class=\"line\">3）节点上的pod不是被控制器创建，例如不是被deployment, replica set, job, stateful set创建。</span><br><span class=\"line\">4）节点上有pod使用了本地存储</span><br><span class=\"line\">5）节点上pod驱逐后无处可去，即没有其他node能调度这个pod</span><br><span class=\"line\">6）节点有注解：&quot;cluster-autoscaler.kubernetes.io/scale-down-disabled&quot;: &quot;true&quot;(在CA 1.0.3或更高版本中受支持)</span><br><span class=\"line\"></span><br><span class=\"line\">通过PodDisruptionBudget控制器可以设置应用POD集群处于运行状态最低个数，也可以设置应用POD集群处于运行状态的最低百分比，这样可以保证在主动销毁应用POD的时候，不会一次性销毁太多的应用POD，从而保证业务不中断</span><br><span class=\"line\"></span><br><span class=\"line\">Horizontal Pod Autoscaler 会根据当前CPU负载更改部署或副本集的副本数。如果负载增加，则HPA将创建新的副本，集群中可能有足够的空间，也可能没有足够的空间。如果没有足够的资源，CA将尝试启动一些节点，以便HPA创建的Pod可以运行。如果负载减少，则HPA将停止某些副本。结果，某些节点可能变得利用率过低或完全为空，然后CA将终止这些不需要的节点。</span><br><span class=\"line\"></span><br><span class=\"line\">如何防止节点被CA删除?</span><br><span class=\"line\">节点可以打上以下标签：</span><br><span class=\"line\">&quot;cluster-autoscaler.kubernetes.io/scale-down-disabled&quot;: &quot;true&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">可以使用 kubectl 将其添加到节点(或从节点删除)：</span><br><span class=\"line\">$ kubectl annotate node &lt;nodename&gt;  cluster-autoscaler.kubernetes.io/scale-down-disabled=true</span><br></pre></td></tr></table></figure>\n<h2 id=\"python-调用k8s-api\"><a class=\"markdownIt-Anchor\" href=\"#python-调用k8s-api\">#</a> python 调用 k8s api</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python操作kubernetes api需要如下两个条件：</span><br><span class=\"line\">1.前提是需要有个k8s集群环境</span><br><span class=\"line\">2.需要在windows上安装kubernetes模块</span><br><span class=\"line\"></span><br><span class=\"line\">在windows下安装kubernetes</span><br><span class=\"line\">pip install --ignore-installed kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">认证：把k8s集群的控制节点上的/root/.kube/config传到自己的电脑指定路径下，我传到了C盘，注意：每个人config文件不一样，大家需要用自己k8s集群控制节点的config文件</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> kubernetes <span class=\"keyword\">import</span> client,config</span><br><span class=\"line\">config.kube_config.load_kube_config(config_file=<span class=\"string\">&#x27;C:\\config&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#获取CoreV1API版本对象</span></span><br><span class=\"line\">v1 = client.CoreV1Api()</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#列出来k8s中的所有名称空间</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> namespace <span class=\"keyword\">in</span> v1.list_namespace().items:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(namespace.metadata.name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> node <span class=\"keyword\">in</span> v1.list_node().items:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(node.metadata.name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#列举所有名称空间下的所有service</span></span><br><span class=\"line\">services=v1.list_service_for_all_namespaces()</span><br><span class=\"line\"><span class=\"keyword\">for</span> svc <span class=\"keyword\">in</span> services.items:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;%s \\t%s \\t%s \\t%s \\n&#x27;</span> %(svc.metadata.namespace,svc.metadata.name,svc.spec.cluster_ip,svc.spec.ports))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#列举所有名称空间下的pod资源</span></span><br><span class=\"line\">pods=v1.list_pod_for_all_namespaces()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> pods.items:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;%s\\t%s\\t%s&quot;</span> %(i.status.pod_ip,i.metadata.namespace,i.metadata.name))</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#client.AppsV1Api对象可以操作跟k8s中控制器相关资源对象，下面演示的是列举所有名称空间的deployment</span></span><br><span class=\"line\">v1_deploy=client.AppsV1Api()</span><br><span class=\"line\">deploys=v1_deploy.list_deployment_for_all_namespaces()</span><br><span class=\"line\"><span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> deploys.items:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&quot;%s\\t%s\\t%s&quot;</span>%(i.metadata.name,i.metadata.namespace,i.spec.replicas))</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> os <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">import</span> yaml</span><br><span class=\"line\"><span class=\"keyword\">from</span> kubernetes <span class=\"keyword\">import</span> client,config</span><br><span class=\"line\"><span class=\"comment\">#引入我们要用的包</span></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    config.load_kube_config(config_file=<span class=\"string\">&#x27;C:\\config&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#读入集群相关信息，就是要操作哪个集群</span></span><br><span class=\"line\">    <span class=\"keyword\">with</span> <span class=\"built_in\">open</span>(path.join(path.dirname(__file__),<span class=\"string\">&quot;nginx-deploy.yaml&quot;</span>)) <span class=\"keyword\">as</span> f:</span><br><span class=\"line\">        dep=yaml.safe_load(f)</span><br><span class=\"line\">        k8s_apps_v1=client.AppsV1Api()</span><br><span class=\"line\">        resp = k8s_apps_v1.create_namespaced_deployment(body=dep,namespace=<span class=\"string\">&#x27;default&#x27;</span>)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;deployment created,name=%s&#x27;</span>%(resp.metadata.name))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">      main()</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> os <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">import</span> yaml</span><br><span class=\"line\"><span class=\"keyword\">from</span> kubernetes <span class=\"keyword\">import</span> client,config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    config.load_kube_config(config_file=<span class=\"string\">&#x27;C:\\config&#x27;</span>)</span><br><span class=\"line\">    k8s_core_v1=client.CoreV1Api()</span><br><span class=\"line\">    resp=k8s_core_v1.delete_namespaced_pod(namespace=<span class=\"string\">&#x27;default&#x27;</span>,name=<span class=\"string\">&#x27;busybox-test&#x27;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;delete pod&#x27;</span>)</span><br><span class=\"line\">main()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">上面是删除自己linux机器上的k8s集群的默认名称空间下的busybox-test这个pod</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> os <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">import</span> yaml</span><br><span class=\"line\"><span class=\"keyword\">from</span> kubernetes <span class=\"keyword\">import</span> client,config</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    config.load_kube_config(config_file=<span class=\"string\">&#x27;C:\\config&#x27;</span>)</span><br><span class=\"line\">    k8s_core_v1=client.CoreV1Api()</span><br><span class=\"line\">    old_resp=k8s_core_v1.read_namespaced_pod(namespace=<span class=\"string\">&#x27;default&#x27;</span>,name=<span class=\"string\">&#x27;busybox-test&#x27;</span>)</span><br><span class=\"line\">    old_resp.spec.containers[<span class=\"number\">0</span>].image=<span class=\"string\">&#x27;nginx&#x27;</span></span><br><span class=\"line\">    <span class=\"comment\">#修改镜像</span></span><br><span class=\"line\">    new_resp=k8s_core_v1.patch_namespaced_pod(namespace=<span class=\"string\">&#x27;default&#x27;</span>,name=<span class=\"string\">&#x27;busybox-test&#x27;</span>,body=old_resp)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(new_resp.spec.containers[<span class=\"number\">0</span>].image)</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__==<span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">from</span> os <span class=\"keyword\">import</span> path</span><br><span class=\"line\"><span class=\"keyword\">import</span> yaml</span><br><span class=\"line\"><span class=\"keyword\">from</span> kubernetes <span class=\"keyword\">import</span> client,config</span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    config.load_kube_config(config_file=<span class=\"string\">&#x27;C:\\config&#x27;</span>)</span><br><span class=\"line\">    k8s_core_v1=client.CoreV1Api()</span><br><span class=\"line\">    resp=k8s_core_v1.read_namespaced_pod(namespace=<span class=\"string\">&#x27;default&#x27;</span>,name=<span class=\"string\">&#x27;busybox-test&#x27;</span>)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;read pod&#x27;</span>)</span><br><span class=\"line\"><span class=\"comment\">#    print(resp)</span></span><br><span class=\"line\">    <span class=\"comment\">#读取指定的信息</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span>(resp.spec.containers[<span class=\"number\">0</span>])</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(resp.spec.containers[<span class=\"number\">0</span>].image)</span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__==<span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    main()</span><br></pre></td></tr></table></figure>\n<h2 id=\"ephemeral\"><a class=\"markdownIt-Anchor\" href=\"#ephemeral\">#</a> ephemeral</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">临时容器与其他容器的不同之处在于，它们缺少对资源或执行的保证，并且永远不会自动重启，因此不适用于构建应用程序。临时容器使用与常规容器相同的 Container.Spec字段进行描述，但许多字段是不允许使用的。</span><br><span class=\"line\">临时容器没有端口配置，因此像 ports，livenessProbe，readinessProbe 这样的字段是不允许的。</span><br><span class=\"line\">Pod 资源分配是不可变的，因此 resources 配置是不允许的。</span><br><span class=\"line\">临时容器是使用 API 中的一种特殊的 ephemeralcontainers 处理器进行创建的， 而不是直接添加到 pod.spec 段，因此无法使用 kubectl edit 来添加一个临时容器。</span><br><span class=\"line\"></span><br><span class=\"line\">与常规容器一样，将临时容器添加到 Pod 后，将不能更改或删除临时容器</span><br><span class=\"line\"></span><br><span class=\"line\">当由于容器崩溃或容器镜像不包含调试实用程序而导致 kubectl exec 无用时，临时容器对于交互式故障排查很有用。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">需要开启支持临时容器的特性：</span></span><br><span class=\"line\"><span class=\"string\">修改kube-apiserver.yaml、kube-scheduler.yaml、kubelet配置。</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\"># cat /etc/kubernetes/manifests/kube-apiserver.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint:</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.180</span><span class=\"string\">:6443</span></span><br><span class=\"line\">  <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">component:</span> <span class=\"string\">kube-apiserver</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">control-plane</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kube-apiserver</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">kube-apiserver</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--advertise-address=192.168.40.180</span></span><br><span class=\"line\">    <span class=\"string\">………</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--feature-gates=RemoveSelfLink=false</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--feature-gates=EphemeralContainers=true</span></span><br><span class=\"line\"><span class=\"string\">………</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#新增加--feature-gates=EphemeralContainers=true字段</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\"># cat /etc/kubernetes/manifests/kube-scheduler.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">creationTimestamp:</span> <span class=\"literal\">null</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">component:</span> <span class=\"string\">kube-scheduler</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">control-plane</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kube-scheduler</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">command:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">kube-scheduler</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--authentication-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--authorization-kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--bind-address=192.168.40.180</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--kubeconfig=/etc/kubernetes/scheduler.conf</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--leader-elect=true</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">--feature-gates=EphemeralContainers=true</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#新增加--feature-gates=EphemeralContainers=true字段</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master</span>]<span class=\"comment\"># cat /etc/sysconfig/kubelet </span></span><br><span class=\"line\"><span class=\"string\">KUBELET_EXTRA_ARGS=&quot;--feature-gates=EphemeralContainers=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node~</span>]<span class=\"comment\"># cat /etc/sysconfig/kubelet </span></span><br><span class=\"line\"><span class=\"string\">KUBELET_EXTRA_ARGS=&quot;--feature-gates=EphemeralContainers=true&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#修改之后重启k8s控制节点和工作节点的kubelet</span></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\"># systemctl restart kubelet</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl restart kubelet</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看kube-system名称空间pod，都是running说明修改正常</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: tomcat-test</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app:  tomcat</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name:  tomcat-java</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat-8.5-jre8</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    </span><br><span class=\"line\">#创建临时容器</span><br><span class=\"line\">[root@xianchaomaster1]# kubectl debug -it tomcat-test --image=busybox:1.28 --target=tomcat-java</span><br><span class=\"line\"></span><br><span class=\"line\">[root@prometheus-master ~]# kubectl describe pod tomcat-test </span><br><span class=\"line\">Containers:</span><br><span class=\"line\">  tomcat-java:</span><br><span class=\"line\">    Container ID:   docker://b15184eb42acf60957e2d245a3e784ec20528f057adc55fdb944aee4ffcd968d</span><br><span class=\"line\">    Image:          tomcat-8.5-jre8</span><br><span class=\"line\">    Image ID:       docker://sha256:4ac473a3dd922eecfc8e0dabd9f6c410871dfd913fea49bfed3fb99924839131</span><br><span class=\"line\">    Port:           8080/TCP</span><br><span class=\"line\">    Host Port:      0/TCP</span><br><span class=\"line\">    State:          Running</span><br><span class=\"line\">      Started:      Sun, 11 Jun 2023 02:10:21 +0800</span><br><span class=\"line\">    Ready:          True</span><br><span class=\"line\">    Restart Count:  0</span><br><span class=\"line\">    Environment:    &lt;none&gt;</span><br><span class=\"line\">    Mounts:</span><br><span class=\"line\">      /var/run/secrets/kubernetes.io/serviceaccount from kube-api-access-mhn6h (ro)</span><br><span class=\"line\">Ephemeral Containers:</span><br><span class=\"line\">  debugger-tnspk:</span><br><span class=\"line\">    Container ID:   docker://0d8d52ce48509f796aa591d7175242f34b00d0235e9d58710f0109dbce30683c</span><br><span class=\"line\">    Image:          busybox:1.28</span><br><span class=\"line\">    Image ID:       docker://sha256:8c811b4aec35f259572d0f79207bc0678df4c736eeec50bc9fec37ed936a472a</span><br><span class=\"line\">    Port:           &lt;none&gt;</span><br><span class=\"line\">    Host Port:      &lt;none&gt;</span><br><span class=\"line\">    State:          Running</span><br><span class=\"line\">      Started:      Sun, 11 Jun 2023 02:12:52 +0800</span><br><span class=\"line\">    Ready:          False</span><br><span class=\"line\">    Restart Count:  0</span><br><span class=\"line\">    Environment:    &lt;none&gt;</span><br><span class=\"line\">    Mounts:         &lt;none&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">kubectl debug 每次都会创建一个新的临时容器，以前的临时容器不会删除，但也无法登录</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">raw更新临时容器</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">applf</span> <span class=\"string\">-f</span> <span class=\"string\">tomcat.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">a.json</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;EphemeralContainers&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">            <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;tomcat-test&quot;</span></span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    <span class=\"attr\">&quot;ephemeralContainers&quot;:</span> [&#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;command&quot;:</span> [</span><br><span class=\"line\">            <span class=\"string\">&quot;sh&quot;</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"attr\">&quot;image&quot;:</span> <span class=\"string\">&quot;busybox&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;imagePullPolicy&quot;:</span> <span class=\"string\">&quot;IfNotPresent&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;debugger&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;stdin&quot;:</span> <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;tty&quot;:</span> <span class=\"literal\">true</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;targetContainerName&quot;:</span> <span class=\"string\">&quot;tomcat-java&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;terminationMessagePolicy&quot;:</span> <span class=\"string\">&quot;File&quot;</span></span><br><span class=\"line\">    &#125;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">replace</span> <span class=\"string\">--raw</span> <span class=\"string\">/api/v1/namespaces/default/pods/tomcat-test/ephemeralcontainers</span> <span class=\"string\">-f</span> <span class=\"string\">a.json</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">attach</span> <span class=\"string\">-it</span> <span class=\"string\">-c</span> <span class=\"string\">debugger</span> <span class=\"string\">tomcat-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">附加退出后不能在进入临时容器</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">临时容器特别适合包含主容器剥离出来的一些调试工具，在需要的时候临时注入到目标pod中</span></span><br><span class=\"line\"><span class=\"string\">在pod中添加临时容器之后，目前还无法删除，同时如果这时候临时容器已经退出，会导致无法再次attach，也不会被拉起（临时容器不支持probe），相关的issue：</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight json\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果attach了临时容器，然后退出了容器主进程（和前面示例中展示的那样），会导致这个容器无法再attach，也无法重新启动。此时，如果要重复上述步骤再次进行调试，需要新创建一个临时容器，同时还需要保留老的配置，否则k8s会拒绝新的配置：</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;apiVersion&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;v1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;kind&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;EphemeralContainers&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;metadata&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">            <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;tomcat-test&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">    <span class=\"attr\">&quot;ephemeralContainers&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">   <span class=\"punctuation\">&#123;</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;command&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">            <span class=\"string\">&quot;sh&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;image&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;busybox&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;imagePullPolicy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;IfNotPresent&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;debugger&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;stdin&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;tty&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;targetContainerName&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;tomcat-java&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;terminationMessagePolicy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;File&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">      <span class=\"punctuation\">&#123;</span><span class=\"attr\">&quot;command&quot;</span><span class=\"punctuation\">:</span> <span class=\"punctuation\">[</span></span><br><span class=\"line\">            <span class=\"string\">&quot;sh&quot;</span></span><br><span class=\"line\">        <span class=\"punctuation\">]</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;image&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;busybox&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;imagePullPolicy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;IfNotPresent&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;name&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;debugger1&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;stdin&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;tty&quot;</span><span class=\"punctuation\">:</span> <span class=\"literal\"><span class=\"keyword\">true</span></span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;targetContainerName&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;tomcat-java&quot;</span><span class=\"punctuation\">,</span></span><br><span class=\"line\">        <span class=\"attr\">&quot;terminationMessagePolicy&quot;</span><span class=\"punctuation\">:</span> <span class=\"string\">&quot;File&quot;</span></span><br><span class=\"line\">    <span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"><span class=\"punctuation\">]</span></span><br><span class=\"line\"><span class=\"punctuation\">&#125;</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置文件需要做这样的修改，再新增一个临时容器。重新修改后pod的状态（describe结果）：</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"punctuation\">[</span>root@<span class=\"punctuation\">]</span># kubectl replace --raw /api/v1/namespaces/default/pods/tomcat-test/ephemeralcontainers -f a.json</span><br><span class=\"line\"> </span><br><span class=\"line\">kubectl attach -it tomcat-test -c debugger1</span><br></pre></td></tr></table></figure>\n<h2 id=\"k3s\"><a class=\"markdownIt-Anchor\" href=\"#k3s\">#</a> k3s</h2>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">k3s是经过CNCF认证的由Rancher公司开发维护的一个轻量级的</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">发行版，内核机制还是和</span> <span class=\"string\">k8s</span> <span class=\"string\">一样，但是剔除了很多外部依赖以及</span> <span class=\"string\">K8s</span> <span class=\"string\">的</span> <span class=\"string\">alpha、beta</span> <span class=\"string\">特性，同时改变了部署方式和运行方式，目的是轻量化</span> <span class=\"string\">K8s，简单来说，K3s</span> <span class=\"string\">就是阉割版</span> <span class=\"string\">K8s，消耗资源极少。它主要用于边缘计算、物联网等场景。K3s</span> <span class=\"string\">具有以下特点：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、安装简单，占用资源少，只需要512M内存就可以运行起来；</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、apiserver</span> <span class=\"string\">、schedule</span> <span class=\"string\">等组件全部简化，并以进程的形式运行在节点上，把程序都打包为单个二进制文件，每个程序只需要占用100M内存；</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、使用基于sqlite3的轻量级存储后端作为默认存储机制。同时支持使用etcd3、MySQL</span> <span class=\"string\">和PostgreSQL作为存储机制；</span></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">、默认使用</span> <span class=\"string\">local-path-provisioner</span> <span class=\"string\">提供本地存储卷；</span></span><br><span class=\"line\"><span class=\"number\">5</span><span class=\"string\">、默认安装了Helm</span> <span class=\"string\">controller</span> <span class=\"string\">和</span> <span class=\"string\">Traefik</span> <span class=\"string\">Ingress</span> <span class=\"string\">controller；</span></span><br><span class=\"line\"><span class=\"number\">6</span><span class=\"string\">、所有</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">control-plane</span> <span class=\"string\">组件的操作都封装在单个二进制文件和进程中，使</span> <span class=\"string\">K3s</span> <span class=\"string\">具有自动化和管理包括证书分发在内的复杂集群操作的能力。</span></span><br><span class=\"line\"><span class=\"number\">7</span><span class=\"string\">、减少外部依赖，操作系统只需要安装较新的内核（centos7.6就可以，不需要升级内核）以及支持cgroup即可，k3s安装包已经包含了containerd、Flannel、CoreDNS，非常方便地一键式安装，不需要额外安装Docker、Flannel等组件。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">K3s</span> <span class=\"string\">适用于以下场景：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、边缘计算-Edge</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、物联网-IoT</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、CI：持续集成</span></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">、Development：开发</span></span><br><span class=\"line\"><span class=\"number\">5</span><span class=\"string\">、ARM</span></span><br><span class=\"line\"><span class=\"number\">6</span><span class=\"string\">、嵌入</span> <span class=\"string\">K8s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">由于运行</span> <span class=\"string\">K3s</span> <span class=\"string\">所需的资源相对较少，所以</span> <span class=\"string\">K3s</span> <span class=\"string\">也适用于开发和测试场景。在这些场景中，如果开发或测试人员需要对某些功能进行验证，或对某些问题进行重现，那么使用</span> <span class=\"string\">K3s</span> <span class=\"string\">不仅能够缩短启动集群的时间，还能够减少集群需要消耗的资源。与此同时，Rancher</span> <span class=\"string\">中国团队推出了一款针对</span> <span class=\"string\">K3s</span> <span class=\"string\">的效率提升工具：AutoK3s。只需要输入一行命令，即可快速创建</span> <span class=\"string\">K3s</span> <span class=\"string\">集群并添加指定数量的</span> <span class=\"string\">master</span> <span class=\"string\">节点和</span> <span class=\"string\">worker</span> <span class=\"string\">节点。</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"k3s架构\"><a class=\"markdownIt-Anchor\" href=\"#k3s架构\">#</a> k3s 架构</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230623175001742.png\" alt=\"image-20230623175001742\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">k3s server节点是运行k3s server命令的机器（裸机或者虚拟机），而k3s Agent 节点是运行k3s agent命令的机器。</span><br><span class=\"line\"></span><br><span class=\"line\">单点架构只有一个控制节点（在 K3s 里叫做server node，相当于 K8s 的 master node），而且K3s的数据存储使用 sqlite 并内置在了控制节点上</span><br><span class=\"line\"></span><br><span class=\"line\">在这种配置中，每个 agent 节点都注册到同一个 server 节点。K3s 用户可以通过调用server节点上的K3s API来操作Kubernetes资源。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230623175156884.png\" alt=\"image-20230623175156884\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">虽然单节点 k3s 集群可以满足各种用例，但对于 Kubernetes control-plane 的正常运行至关重要的环境，可以在高可用配置中运行 K3s。一个高可用 K3s 集群由以下几个部分组成：</span><br><span class=\"line\"></span><br><span class=\"line\">1、K3s Server 节点：两个或者更多的server节点将为 Kubernetes API 提供服务并运行其他 control-plane 服务</span><br><span class=\"line\">2、外部数据库：外部数据存储（与单节点 k3s 设置中使用的嵌入式 SQLite 数据存储相反）</span><br><span class=\"line\"></span><br><span class=\"line\">k3s和k8s如何选择</span><br><span class=\"line\">K8s和k3s各有优劣。若是你要进行大型的集群部署，建议你选择使用K8s；若是你处于边缘计算等小型部署的场景或仅仅须要部署一些非核心集群进行开发/测试，那么选择k3s则是性价比更高的选择。</span><br><span class=\"line\"></span><br><span class=\"line\">云计算场景用k8s</span><br><span class=\"line\">边缘计算场景用k3s</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装k3s\"><a class=\"markdownIt-Anchor\" href=\"#安装k3s\">#</a> 安装 k3s</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmszcy5pby96aC9xdWljay1zdGFydA==\">快速入门指南 | K3s</span></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">在192.168.40.180和192.168.40.181新机器初始化操作你们自己去做：</span></span><br><span class=\"line\"><span class=\"string\">参考安装k8s时候的初始化去做就可以了</span></span><br><span class=\"line\"><span class=\"string\">配置yum源</span></span><br><span class=\"line\"><span class=\"string\">关掉防火墙</span></span><br><span class=\"line\"><span class=\"string\">关掉selinux</span></span><br><span class=\"line\"><span class=\"string\">修改内核参数</span></span><br><span class=\"line\"><span class=\"string\">关掉swap交换分区</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在192.168.40.180和192.168.40.181上安装containerd</span></span><br><span class=\"line\"> [<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># yum install containerd -y</span></span><br><span class=\"line\"><span class=\"string\">启动containerd</span></span><br><span class=\"line\">[<span class=\"string\">root@localhost</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start containerd</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">国内用户可以用如下方法：安装速度会更快</span></span><br><span class=\"line\"><span class=\"string\">在192.168.40.180上操作：</span></span><br><span class=\"line\"><span class=\"comment\">#执行如下命令安装：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-sfL</span> <span class=\"string\">https://rancher-mirror.rancher.cn/k3s/k3s-install.sh</span> <span class=\"string\">|</span> <span class=\"string\">INSTALL_K3S_MIRROR=cn</span> <span class=\"string\">sh</span> <span class=\"bullet\">-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">提取join</span> <span class=\"string\">token</span></span><br><span class=\"line\"><span class=\"string\">我们想要添加一对worker节点。在这些节点上安装K3s，我们需要一个join</span> <span class=\"string\">token。Join</span> <span class=\"string\">token存在于master节点的文件系统上。让我们复制并将它保存在某个地方，稍后我们可以获取它：</span></span><br><span class=\"line\"><span class=\"string\">cat</span> <span class=\"string\">/var/lib/rancher/k3s/server/node-token</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">获取到一串token：</span></span><br><span class=\"line\"><span class=\"string\">K1048a0844cf602b7c96a4ea98a0a3531298e78262ba19875bd31a92ffc56686f63::server:698e6bc453d5871cbb1a4741387824b0</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在192.168.40.181上执行如下，把work节点加入k3s:</span></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-sfL</span> <span class=\"string\">http://rancher-mirror.cnrancher.com/k3s/k3s-install.sh</span> <span class=\"string\">|</span> <span class=\"string\">INSTALL_K3S_MIRROR=cn</span> <span class=\"string\">K3S_URL=https://192.168.40.186:6443</span> <span class=\"string\">K3S_TOKEN=K105914c0b8bc0c8056a958ae90d0c2e5bf755d470cda85626aef879c8956ba95e4::server:bcdeca25ed8372d9f1bc983f0efb119e</span> <span class=\"string\">sh</span> <span class=\"bullet\">-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">验证work节点是否加入集群：</span></span><br><span class=\"line\"><span class=\"string\">在192.168.40.180操作：</span></span><br><span class=\"line\"><span class=\"string\">k3s</span> <span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">nodes</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"openshift\"><a class=\"markdownIt-Anchor\" href=\"#openshift\">#</a> openshift</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">OpenShift 是红帽 Red Hat 公司开源的平台，是平台即服务（PaaS），是一种容器应用平台。允许开发人员构建、测试和部署应用。在 OpenShift 上可以进行开发、测试、部署、运维全流程，实现高度的自动化，满足企业中的应用持续集成和交付及部署的需求，同时也满足企业对于容器管理（Docker）、容器编排（K8S）的需求。</span><br><span class=\"line\">Openshift 是首个支持企业级 Java 的 PaaS 平台，支持 JEE6 与 JBoss 和其 Eclipse 集成开发环境以及 Maven 和 Jenkins 自动化。</span><br><span class=\"line\">OpenShift通常被称为容器应用平台，因为它是一个用于开发和部署容器的平台。OpenShift底层以Docker作为容器引擎驱动，以K8s作为容器编排引擎组件，并提供了开发语言，中间件，DevOps自动化流程工具和web console用户界面等元素，提供了一套完整的基于容器的应用云平台。</span><br><span class=\"line\"></span><br><span class=\"line\">OpenShift功能</span><br><span class=\"line\">容器引擎：docker；</span><br><span class=\"line\">容器编排：kubernetes；</span><br><span class=\"line\">应用开发框架及中间件：Java、Python、Tomcat、MySQL、PHP、Ruby、MongoDB和JBoss等中间件；</span><br><span class=\"line\">应用及服务目录：用户可一键部署各类应用及服务；</span><br><span class=\"line\">自动化流程及工具：内置自动化流程工具S2I（Source to Image），用户可完成代码编译、构建和镜像发布；</span><br><span class=\"line\">软件定义网络：提供 OpenVSwitch，实现跨主机共享网络及多租户隔离网络模式；</span><br><span class=\"line\">性能监控及日志管理：内置 Prometheus 监控功能，用户可以通过 Grafana 仪表板上实时显示应用；</span><br><span class=\"line\">多用户接口：提供友好的 UI、命令行工具（oc，类似于 K8S 的 kubectl 以及 RESTful API，基本与 K8S 兼容）；</span><br><span class=\"line\">自动化集群部署及管理：通过 Ansible 实现集群的自动化部署，为集群的自动化扩容提供接口。</span><br><span class=\"line\"></span><br><span class=\"line\">OpenShift 与 K8S的区别</span><br><span class=\"line\">概念：OpenShift 是 PaaS（平台即服务），K8S 是 CaaS（容器即服务），OpenShift 内置了Kubernetes。OpenShift 底层以 Docker 作为容器引擎驱动，以 Kubernetes 作为容器编排引擎组件。</span><br><span class=\"line\">部署：OpenShift 可以安装在 RHEL（Red Hat Enterprise Linux）和 RHELAH（Red Hat Eneterprise Linux Atomic Host）、CentOS 和 Fedora上；K8S 最好在 Unbuntu、Fedora、centos 和 Debian上运行，可部署在任何主要的 IaaS 上，如 IBM、AWS、Azure、GCP 和阿里云等云平台上。</span><br><span class=\"line\">网络：OpenShift 提供了开箱即用的本机网络解决方案，即 OpenvSwitch，它提供三种不同的插件；K8S 没有本机网络解决方案，但提供可供第三方网络插件使用的接口。</span><br><span class=\"line\"></span><br><span class=\"line\">OpenShift 与 K8S相同点</span><br><span class=\"line\">OpenShift 集成了原生的 K8S 作为容器编排组件，提供容器集群的管理，为业务应用可以提供：</span><br><span class=\"line\">容器调度：根据业务的要求，快速部署容器到达指定的目标状态；</span><br><span class=\"line\">弹性伸缩：应用可以快速的扩缩容pod的实例数量；</span><br><span class=\"line\">异常修复：在容器实例发生异常时，集群可以自动发现问题、处理并恢复应用服务的状态；</span><br><span class=\"line\">持久化卷：为集群中的不同机器上的容器提供持久化卷的对接功能；</span><br><span class=\"line\">服务发现：可以提供负载均衡及服务发现功能；</span><br><span class=\"line\">配置管理：为业务应用提供灵活的配置管理和分发规则。</span><br><span class=\"line\"></span><br><span class=\"line\">Openshift基础组件</span><br><span class=\"line\">在OpenShift中，Kubernetes管理容器化应用程序，并为部署、维护和应用程序扩展提供机制。Kubernetes集群由一个或多个Master节点和一组Node节点组成。</span><br><span class=\"line\">Master节点</span><br><span class=\"line\">主控节点。包括API Server、Controller Manager Server和Etcd。主控节点管理其Kubernetes集群中的Node节点，并安排pod在这些节点上运行。</span><br><span class=\"line\">Node节点</span><br><span class=\"line\">Node节点为容器提供运行时环境。Kubernetes集群中的每个Node节点都有需要由Master节点管理的服务。该节点还具有运行pods所需的服务，包括容器运行时、kubelet和服务代理。</span><br><span class=\"line\"></span><br><span class=\"line\">openshift基本概念</span><br><span class=\"line\">以下将提供有关使用OpenShift时将遇到的核心概念和对象的高级体系结构信息。其中许多对象来自Kubernetes, OpenShift对Kubernetes进行了扩展，以提供功能更丰富的开发生命周期平台。</span><br><span class=\"line\">Project</span><br><span class=\"line\">Project是一个带有附加注释的Kubernetes名称空间，是管理普通用户访问资源的中心媒介。用户必须由管理员提供相关的权限，或者如果允许创建项目，则自动访问自己的项目。</span><br><span class=\"line\">Namespaces</span><br><span class=\"line\">Kubernetes命名空间提供了一种用于划分集群中资源的机制。在OpenShift中，Project是带有附加注释的Kubernetes命名空间。</span><br><span class=\"line\">Users</span><br><span class=\"line\">与OpenShift交互的用户。OpenShift用户对象表示一个参与者，可以通过向其添加角色或向其组添加角色来授予该参与者在系统中的权限。</span><br><span class=\"line\">Pod</span><br><span class=\"line\">运行于Node节点上，若干相关容器的组合。Pod内包含的容器运行在同一宿主机上，使用相同的网络命名空间、IP地址和端口，能够通过localhost进行通信。Pod是Kurbernetes进行创建、调度和管理的最小单位，它提供了比容器更高层次的抽象，使得部署和管理更加灵活。一个Pod可以包含一个容器或者多个相关容器。</span><br><span class=\"line\">Service</span><br><span class=\"line\">Service定义了Pod的逻辑集合和访问该集合的策略，是真实服务的抽象。Service提供了一个统一的服务访问入口以及服务代理和发现机制，关联多个相同Label的Pod，用户不需要了解后台Pod是如何运行。</span><br><span class=\"line\">Router</span><br><span class=\"line\">Service提供了一个通往后端Pod集群的稳定入口，但是Service的IP地址只是集群内部的节点和容器可见。外部需通过Router（路由器）来转发。Router组件是Openshift集群中一个重要的组件，它是外界访问集群内容器应用的入口。用户可以创建Route（路由规则）对象，一个Route会与一个Service关联，并绑定一个域名。</span><br><span class=\"line\">Persistent Storage</span><br><span class=\"line\">容器默认是非持久化的，所有的修改在容器销毁时都会丢失。Docker提供了持久化卷挂载的能力，Openshift除了提供持久化卷挂载的能力，还提供了一种持久化供给模型即PV（Persistent Volume）和PVC（Persistent Volume Claim）。用户在部署应用时显示的声明对持久化的需求，创建PVC，在PVC中定义所需要的存储大小，访问方式。OpenShift集群会自动寻找符合要求的PV与PVC自动对接。</span><br><span class=\"line\">Registry</span><br><span class=\"line\">Openshift内部的镜像仓库，主要用于存放内置的S2I构建流程所产生的镜像。</span><br><span class=\"line\">S2I</span><br><span class=\"line\">Source to Image，负责将应用源码构建成镜像。</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装openshiftansible\"><a class=\"markdownIt-Anchor\" href=\"#安装openshiftansible\">#</a> 安装 openshift&amp;ansible</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">安装ansible</span><br><span class=\"line\">初始化</span><br><span class=\"line\">1.1.12 修改网卡配置文件</span><br><span class=\"line\">[root@master ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">最后追加如下内容：</span><br><span class=\"line\">NM_CONTROLLED=yes</span><br><span class=\"line\">修改好之后重启网络</span><br><span class=\"line\">service network restart</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">最后追加如下内容：</span><br><span class=\"line\">NM_CONTROLLED=yes</span><br><span class=\"line\">修改好之后重启网络</span><br><span class=\"line\">service network restart</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node2 ~]# vim /etc/sysconfig/network-scripts/ifcfg-ens33</span><br><span class=\"line\">最后追加如下内容：</span><br><span class=\"line\">NM_CONTROLLED=yes</span><br><span class=\"line\">修改好之后重启网络</span><br><span class=\"line\">service network restart</span><br><span class=\"line\"></span><br><span class=\"line\">1.1.13 停掉NetworkManager</span><br><span class=\"line\">[root@master ~]# systemctl stop NetworkManager</span><br><span class=\"line\">[root@master ~]# systemctl disable NetworkManager</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1 ~]# systemctl stop NetworkManager</span><br><span class=\"line\">[root@node1 ~]# systemctl disable NetworkManager</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node2 ~]# systemctl stop NetworkManager</span><br><span class=\"line\">[root@node2 ~]# systemctl disable NetworkManager</span><br><span class=\"line\"></span><br><span class=\"line\">1.1.14 安装ansible</span><br><span class=\"line\">把ansible-2.6.5-1.el7.ans.noarch.rpm上传到master、node1、node2上</span><br><span class=\"line\">[root@master ~]#yum install ansible-2.6.5-1.el7.ans.noarch.rpm -y</span><br><span class=\"line\">[root@node1~]#yum install ansible-2.6.5-1.el7.ans.noarch.rpm -y</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">把openshift-ansible-release-3.10.zip上传到master节点，手动解压：</span><br><span class=\"line\">[root@master ~]#unzip openshift-ansible-release-3.10.zip</span><br><span class=\"line\"></span><br><span class=\"line\">1.2.2 安装和配置docker</span><br><span class=\"line\">[root@master ~]#yum install -y docker-1.13.1</span><br><span class=\"line\">[root@node1~]#yum install -y docker-1.13.1</span><br><span class=\"line\"></span><br><span class=\"line\">1）修改docker配置文件</span><br><span class=\"line\">[root@master ~]# vim /etc/sysconfig/docker</span><br><span class=\"line\">把之前的OPTIONS注释掉 </span><br><span class=\"line\">#OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false&#x27;</span><br><span class=\"line\">新增如下内容：</span><br><span class=\"line\">OPTIONS=&#x27;--selinux-enabled  --signature-verification=False&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1~]# vim /etc/sysconfig/docker</span><br><span class=\"line\">把之前的OPTIONS注释掉 </span><br><span class=\"line\">#OPTIONS=&#x27;--selinux-enabled --log-driver=journald --signature-verification=false&#x27;</span><br><span class=\"line\">新增如下内容：</span><br><span class=\"line\">OPTIONS=&#x27;--selinux-enabled  --signature-verification=False&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">2）配置docker镜像加速器</span><br><span class=\"line\">[root@node1 ~]# systemctl start docker</span><br><span class=\"line\">[root@node2 ~]# systemctl start docker</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]# cat /etc/docker/daemon.json </span><br><span class=\"line\">&#123;&quot;registry-mirrors&quot;: [&quot;http://6e9e5b27.m.daocloud.io&quot;,&quot;https://registry.docker-cn.com&quot;],</span><br><span class=\"line\">&quot;insecure-registries&quot;:[&quot;192.168.40.180:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1 ~]# cat /etc/docker/daemon.json </span><br><span class=\"line\">&#123;&quot;registry-mirrors&quot;: [&quot;http://6e9e5b27.m.daocloud.io&quot;,&quot;https://registry.docker-cn.com&quot;],</span><br><span class=\"line\">&quot;insecure-registries&quot;:[&quot;192.168.40.180:5000&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">3）重启docker</span><br><span class=\"line\">[root@master ~]# systemctl restart docker</span><br><span class=\"line\">[root@node1~]# systemctl restart docker</span><br><span class=\"line\"></span><br><span class=\"line\">4）配置私有镜像仓库</span><br><span class=\"line\">[root@master ~]# docker load -i registry.tar.gz</span><br><span class=\"line\">[root@master ~]# yum install httpd -y</span><br><span class=\"line\">[root@master ~]# systemctl start httpd</span><br><span class=\"line\">[root@master ~]# systemctl enable httpd</span><br><span class=\"line\">[root@master ~]# mkdir -p /opt/registry-var/auth/</span><br><span class=\"line\">[root@master ~]#  docker run --entrypoint htpasswd registry:2.5 -Bbn xianchao xianchao  &gt;&gt; /opt/registry-var/auth/htpasswd</span><br><span class=\"line\"></span><br><span class=\"line\">设置配置文件</span><br><span class=\"line\">[root@master ~]# mkdir -p /opt/registry-var/config</span><br><span class=\"line\">[root@master ~]# vim /opt/registry-var/config/config.yml</span><br><span class=\"line\">version: &quot;0.1&quot;</span><br><span class=\"line\">log:</span><br><span class=\"line\">  fields:</span><br><span class=\"line\">    service: registry</span><br><span class=\"line\">storage:</span><br><span class=\"line\">  delete:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">  cache:</span><br><span class=\"line\">    blobdescriptor: inmemory</span><br><span class=\"line\">  filesystem:</span><br><span class=\"line\">    rootdirectory: /var/lib/registry</span><br><span class=\"line\">http:</span><br><span class=\"line\">  addr: :5000</span><br><span class=\"line\">  headers:</span><br><span class=\"line\">    X-Content-Type-Options: [nosniff]</span><br><span class=\"line\">health:</span><br><span class=\"line\">  storagedriver:</span><br><span class=\"line\">    enabled: true</span><br><span class=\"line\">    interval: 10s</span><br><span class=\"line\">threshold: 3</span><br><span class=\"line\"></span><br><span class=\"line\">启动服务</span><br><span class=\"line\">docker run -d -p 5000:5000 --restart=always  --name=registry -v /opt/registry-var/config/:/etc/docker/registry/ -v /opt/registry-var/auth/:/auth/ -e &quot;REGISTRY_AUTH=htpasswd&quot;  -e &quot;REGISTRY_AUTH_HTPASSWD_REALM=Registry Realm&quot; -e REGISTRY_AUTH_HTPASSWD_PATH=/auth/htpasswd -v /opt/registry-var/:/var/lib/registry/ registry:2.5</span><br><span class=\"line\"></span><br><span class=\"line\">1.2.3 登录镜像仓库</span><br><span class=\"line\">[root@master ~]#docker login 192.168.40.180:5000</span><br><span class=\"line\">用户名：</span><br><span class=\"line\">密码：  </span><br><span class=\"line\"></span><br><span class=\"line\">[root@node1~]#docker login 192.168.40.180:5000</span><br><span class=\"line\">用户名：</span><br><span class=\"line\">密码：  </span><br><span class=\"line\"></span><br><span class=\"line\">1.2.4 修改docker存储</span><br><span class=\"line\">1）设置docker开机自启动</span><br><span class=\"line\">systemctl enable docker</span><br><span class=\"line\">systemctl is-active docker</span><br><span class=\"line\">2）所有节点更改/etc/sysconfig/docker-storage-setup如下：</span><br><span class=\"line\">DEVS=/dev/sdb </span><br><span class=\"line\">VG=docker-vg</span><br><span class=\"line\">3）所有Node节点执行docker-storage-setup</span><br><span class=\"line\">docker-storage-setup </span><br><span class=\"line\"></span><br><span class=\"line\">1.2.5 解压镜像</span><br><span class=\"line\">[root@node1 ~]# docker load -i openshift_slave_3_10.tar.gz</span><br><span class=\"line\">[root@node2 ~]# docker load -i openshift_slave_3_10.tar.gz</span><br><span class=\"line\"></span><br><span class=\"line\">1.3、安装并访问openshift </span><br><span class=\"line\"></span><br><span class=\"line\">1.3.1 配置ansible的hosts文件</span><br><span class=\"line\">[root@master ~]# cat /etc/ansible/hosts </span><br><span class=\"line\">[OSEv3:children]</span><br><span class=\"line\">masters</span><br><span class=\"line\">nodes</span><br><span class=\"line\">etcd</span><br><span class=\"line\">[OSEv3:vars]</span><br><span class=\"line\">openshift_deployment_type=origin</span><br><span class=\"line\">ansible_ssh_user=root</span><br><span class=\"line\">ansible_become=yes</span><br><span class=\"line\">openshift_repos_enable_testing=true</span><br><span class=\"line\">openshift_enable_service_catalog=false</span><br><span class=\"line\">template_service_broker_install=false</span><br><span class=\"line\">debug_level=4</span><br><span class=\"line\">openshift_clock_enabled=true</span><br><span class=\"line\">openshift_version=3.10.0 </span><br><span class=\"line\">openshift_image_tag=v3.10</span><br><span class=\"line\">openshift_disable_check=disk_availability,docker_storage,memory_availability,docker_image_availability,os_sdn_network_plugin_name=redhat/openshift-ovs-multitenant i</span><br><span class=\"line\">openshift_master_identity_providers=[&#123;&#x27;name&#x27;: &#x27;htpasswd_auth&#x27;,&#x27;login&#x27;: &#x27;true&#x27;, &#x27;challenge&#x27;: &#x27;true&#x27;,&#x27;kind&#x27;: &#x27;HTPasswdPasswordIdentityProvider&#x27;&#125;]</span><br><span class=\"line\">[masters]</span><br><span class=\"line\">master</span><br><span class=\"line\">[nodes]</span><br><span class=\"line\">master openshift_node_group_name=&#x27;node-config-master&#x27;</span><br><span class=\"line\">node1 openshift_node_group_name=&#x27;node-config-master&#x27; </span><br><span class=\"line\">node2 openshift_node_group_name=&#x27;node-config-master&#x27;</span><br><span class=\"line\">[etcd]</span><br><span class=\"line\">master</span><br><span class=\"line\">1.3.2 安装openshift</span><br><span class=\"line\">1）安装前预配置检查</span><br><span class=\"line\">[root@master ~]#ansible-playbook -i /etc/ansible/hosts openshift-ansible-release-3.10/playbooks/prerequisites.yml</span><br><span class=\"line\"></span><br><span class=\"line\">3）安装</span><br><span class=\"line\">执行deploy时主机dns导致连外网失败（在执行上面deploy时，需要在每个节点ping www.baidu.com，如果ping不通，解决方案如下）</span><br><span class=\"line\">临时解决方案更改/etc/resolv.conf</span><br><span class=\"line\">当部署的时候看到retry，就需要在master和node节点执行下面命令，这样就可以继续ping通外网</span><br><span class=\"line\">[root@master ~]#echo nameserver 8.8.8.8 &gt;&gt;/etc/resolv.conf</span><br><span class=\"line\">可以写个计划任务：</span><br><span class=\"line\">crontab -e</span><br><span class=\"line\">* */1 * * * /usr/sbin/ntpdate   cn.pool.ntp.org</span><br><span class=\"line\">* * * * * /usr/bin/echo  nameserver 8.8.8.8  &gt;&gt;/etc/resolv.conf</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]# ansible-playbook -i /etc/ansible/hosts openshift-ansible-release-3.10/playbooks/deploy_cluster.yml</span><br><span class=\"line\"></span><br><span class=\"line\">需要给节点打标签</span><br><span class=\"line\">TASK [openshift_manage_node : Set node schedulability] 到这个task之后执行下面部分</span><br><span class=\"line\">[root@master ~]#oc label node node1 node-role.kubernetes.io/infra=true</span><br></pre></td></tr></table></figure>\n<h3 id=\"登录openshift\"><a class=\"markdownIt-Anchor\" href=\"#登录openshift\">#</a> 登录 openshift</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.3.3 登录openshift</span><br><span class=\"line\"></span><br><span class=\"line\">首次新建用户密码</span><br><span class=\"line\">htpasswd -cb /etc/origin/master/htpasswd admin admin</span><br><span class=\"line\">添加用户密码</span><br><span class=\"line\">htpasswd -b /etc/origin/master/htpasswd dev dev</span><br><span class=\"line\">以集群管理员登录</span><br><span class=\"line\">oc login -u system:admin</span><br><span class=\"line\">给用户分配一个集群管理员角色</span><br><span class=\"line\">oc adm policy add-cluster-role-to-user cluster-admin admin</span><br><span class=\"line\">浏览器登录openshift，配置自己电脑hosts文件</span><br><span class=\"line\"></span><br><span class=\"line\">https://master:8443/console/catalog</span><br><span class=\"line\"></span><br><span class=\"line\">1.3.4 openshift内部私有仓库使用</span><br><span class=\"line\">Master上执行如下，获取admin密码</span><br><span class=\"line\">oc login -n openshift</span><br><span class=\"line\">admin/admin</span><br><span class=\"line\">oc whoami -t</span><br><span class=\"line\">eYtOZNGab9w4IO_LX2sHEHyoAZHOy1oxJ9gEsuJVMpI</span><br><span class=\"line\">每个节点执行如下登陆openshift私有镜像仓库    </span><br><span class=\"line\">docker login docker-registry.default.svc:5000</span><br><span class=\"line\">用户：admin</span><br><span class=\"line\">密码：eYtOZNGab9w4IO_LX2sHEHyoAZHOy1oxJ9gEsuJVMpI</span><br></pre></td></tr></table></figure>\n<h3 id=\"openshift-部署应用程序\"><a class=\"markdownIt-Anchor\" href=\"#openshift-部署应用程序\">#</a> <strong>openshift</strong> <strong>部署应用程序</strong></h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">使用OpenShift时，可以通过多种方式添加应用程序。 主要方法是：</span><br><span class=\"line\">1.通过已经存在的docker镜像部署应用程序</span><br><span class=\"line\">2.使用Source-to-Image的方式部署应用程序（Source-to-Image简称S2I:从代码仓库拉取代码，构建成镜像，基于此镜像部署应用程序）</span><br><span class=\"line\">3.在dockerfile中通过指定git仓库地址构建程序</span><br></pre></td></tr></table></figure>\n<h3 id=\"openshift-cicd\"><a class=\"markdownIt-Anchor\" href=\"#openshift-cicd\">#</a> openshift CICD</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">一、CI/CD工具链涉及到的组件介绍</span><br><span class=\"line\">1、gogs：</span><br><span class=\"line\">Gogs 是一款极易搭建的自助 Git 服务，类似于github这种代码托管系统；以最简便的方式搭建简单、稳定和可扩展的自助 Git 服务。使用 Go 语言开发使得 Gogs 能够通过独立的二进制分发，并且支持 Go 语言支持的 所有平台，包括 Linux、macOS、Windows 以及 ARM 平台。</span><br><span class=\"line\">功能特性</span><br><span class=\"line\"></span><br><span class=\"line\">官方文档</span><br><span class=\"line\">https://gogs.io/docs/intro</span><br><span class=\"line\"></span><br><span class=\"line\">github上的中文站点：</span><br><span class=\"line\">https://github.com/gogs/gogs/blob/master/README_ZH.md</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2、nexus是一个私服</span><br><span class=\"line\">为什么搭建nexus？</span><br><span class=\"line\">为什么要搭建nexus私服，原因很简单，有些公司都不提供外网给项目组人员，因此就不能访问maven中央仓库，或者公司内部的jar包在外网无法找到，所以很有必要在局域网里使用一台有外网权限的机器，搭建nexus私服，然后开发人员连到这台私服上，这样的话就可以通过这台搭建了nexus私服的电脑访问maven的远程仓库，或者从上面下载内部jar包，使得开发人员可以下载仓库中的内容，而且对于下载过的文件，局域网内下载会更加快速。还有一点优势在于，我们需要的jar包可能在中央仓库中没有，需要去其他地方下载，有了中央仓库，只需要一人找到jar包其他人就不用再去上网搜索jar包，十分方便。</span><br><span class=\"line\"></span><br><span class=\"line\">3、sonarqube：</span><br><span class=\"line\">代码扫描工具</span><br><span class=\"line\"></span><br><span class=\"line\">4、jenkins</span><br><span class=\"line\"></span><br><span class=\"line\">二、创建CI/CD流</span><br><span class=\"line\"></span><br><span class=\"line\">OpenShift DevOps/CICD工作流</span><br><span class=\"line\"></span><br><span class=\"line\">1.从gogs或者gitlab克隆代码</span><br><span class=\"line\">2.通过maven构建war包</span><br><span class=\"line\">3.单元测试</span><br><span class=\"line\">4.Sonarqube静态代码扫描</span><br><span class=\"line\">5.war包归档到Nexus</span><br><span class=\"line\">6.构建docker image</span><br><span class=\"line\">7.把镜像上传到harbor镜像仓库</span><br><span class=\"line\">8.部署到dev（开发）环境</span><br><span class=\"line\">9.部署到测试环境-集成测试</span><br><span class=\"line\">10.管理员promote（同意） or abort（不同意）</span><br><span class=\"line\">11.部署到stage（生产）环境</span><br><span class=\"line\"></span><br><span class=\"line\">官网地址：</span><br><span class=\"line\">https://github.com/siamaksade/openshift-cd-demo/tree/origin-1.3</span><br></pre></td></tr></table></figure>\n<h2 id=\"排错\"><a class=\"markdownIt-Anchor\" href=\"#排错\">#</a> 排错</h2>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、两台机器部署Keepalive出现双vip，如何排查？</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">添加如下参数</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">unicast_src_ip</span> <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.29</span>         <span class=\"comment\">##source ip</span></span><br><span class=\"line\">    <span class=\"string\">unicast_peer</span> &#123;</span><br><span class=\"line\">          <span class=\"number\">192.168</span><span class=\"number\">.0</span><span class=\"number\">.186</span>               <span class=\"comment\">##dest ip</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628160651535.png\" alt=\"image-20230628160651535\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2.</span><span class=\"string\">jenkins</span> <span class=\"string\">一定要最新的</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、kubeadm初始化k8s集群报错failed</span> <span class=\"string\">to</span> <span class=\"string\">parse</span> <span class=\"string\">kernel</span> <span class=\"string\">config：unable</span> <span class=\"string\">to</span> <span class=\"string\">load</span> <span class=\"string\">kernel</span> <span class=\"string\">module：”configs</span></span><br><span class=\"line\"><span class=\"string\">答：</span></span><br><span class=\"line\"><span class=\"string\">Kubeadm初始化k8s,会检测configs模块，configs模块现在centos操作系统不在维护了，可以忽略这个检查，那么kubeadm</span> <span class=\"string\">初始化只需要加上参数--ignore-preflight-errors=SystemVerification即可</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">.浏览器显示非私密连接</span></span><br><span class=\"line\"><span class=\"string\">在google浏览器中，在上图出现的页面任意位置，直接键盘敲入这11个字符：thisisunsafe，可以直接跳过安全报错进入页面</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5.</span><span class=\"string\">centos8的yum源无法使用(dockerfile基于centos构建镜像报错Failed</span> <span class=\"string\">to</span> <span class=\"string\">download</span> <span class=\"string\">metadata</span> <span class=\"string\">for</span> <span class=\"string\">repo</span> <span class=\"string\">‘appstream’:</span> <span class=\"attr\">Cannot prepare internal mirrorlist:</span> <span class=\"literal\">No</span> <span class=\"string\">URLs</span> <span class=\"string\">in</span> <span class=\"string\">mirrorlist)</span></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">Centos-vault-8.5.2111.repo</span></span><br><span class=\"line\">[<span class=\"string\">base</span>]</span><br><span class=\"line\"><span class=\"string\">name=CentOS-8.5.2111</span> <span class=\"bullet\">-</span> <span class=\"string\">Base</span> <span class=\"bullet\">-</span> <span class=\"string\">mirrors.aliyun.com</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/BaseOS/$basearch/os/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#additional packages that may be useful</span></span><br><span class=\"line\">[<span class=\"string\">extras</span>]</span><br><span class=\"line\"><span class=\"string\">name=CentOS-8.5.2111</span> <span class=\"bullet\">-</span> <span class=\"string\">Extras</span> <span class=\"bullet\">-</span> <span class=\"string\">mirrors.aliyun.com</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/extras/$basearch/os/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\">#additional packages that extend functionality of existing packages</span></span><br><span class=\"line\">[<span class=\"string\">centosplus</span>]</span><br><span class=\"line\"><span class=\"string\">name=CentOS-8.5.2111</span> <span class=\"bullet\">-</span> <span class=\"string\">Plus</span> <span class=\"bullet\">-</span> <span class=\"string\">mirrors.aliyun.com</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/centosplus/$basearch/os/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class=\"line\"> </span><br><span class=\"line\">[<span class=\"string\">PowerTools</span>]</span><br><span class=\"line\"><span class=\"string\">name=CentOS-8.5.2111</span> <span class=\"bullet\">-</span> <span class=\"string\">PowerTools</span> <span class=\"bullet\">-</span> <span class=\"string\">mirrors.aliyun.com</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/PowerTools/$basearch/os/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">enabled=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">AppStream</span>]</span><br><span class=\"line\"><span class=\"string\">name=CentOS-8.5.2111</span> <span class=\"bullet\">-</span> <span class=\"string\">AppStream</span> <span class=\"bullet\">-</span> <span class=\"string\">mirrors.aliyun.com</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.aliyuncs.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class=\"line\">        <span class=\"string\">http://mirrors.cloud.aliyuncs.com/centos-vault/8.5.2111/AppStream/$basearch/os/</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/centos/RPM-GPG-KEY-CentOS-Official</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">6</span><span class=\"string\">.云主机安全组放行端口</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628161250017.png\" alt=\"image-20230628161250017\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">删除kubeadm安装的k8s集群，重新搭建</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在k8s集群的每个节点执行kubeadm</span> <span class=\"string\">reset即可，这个命令是重置k8s集群，会清空k8s所有组件和资源。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">7.</span><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">报错</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">clean</span> <span class=\"string\">all</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">makecache</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">epel-release</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">update</span> <span class=\"string\">-y</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">8</span><span class=\"string\">.删除k8s名称空间一直报错Terminating</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">namespace</span> <span class=\"string\">app-team1</span> <span class=\"string\">-o</span> <span class=\"string\">json</span> <span class=\"string\">&gt;</span> <span class=\"string\">temp.json</span></span><br><span class=\"line\"><span class=\"string\">修改temp.json文件</span></span><br><span class=\"line\"><span class=\"string\">删除框住的部分</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230628161656494.png\" alt=\"image-20230628161656494\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">再开启一个新的终端执行如下：</span><br><span class=\"line\">root@master1:~# kubectl proxy</span><br><span class=\"line\"></span><br><span class=\"line\">另一个终端执行如下：</span><br><span class=\"line\">root@master1:~# curl -k -H &quot;Content-Type: application/json&quot; -X PUT --data-binary @temp.json http://127.0.0.1:8001/api/v1/namespaces/app-team1/finalize</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">11、基于kubectl run busybox2 --image busybox:1.28 --restart=Never --rm -it busybox – sh 创建的pod，无法ping www.baidu.com</span><br><span class=\"line\">首先把安装k8s的所有机器重启，然后重新创建pod，如果重启之后还是ping不通www.baidu.com，可以按照如下方法解决：</span><br><span class=\"line\">进入pod</span><br><span class=\"line\">打开/etc/resolv.conf，最后添加nameserver 8.8.8.8</span><br><span class=\"line\">在search这增加域名www.baidu.com即可</span><br><span class=\"line\"></span><br><span class=\"line\">12.containerd如果作为容器运行时，用ctr拉取镜像，需要写镜像完成的路径才可以</span><br><span class=\"line\">ctr images pull docker.io/library/busybox:1.28</span><br></pre></td></tr></table></figure>\n<h3 id=\"pod\"><a class=\"markdownIt-Anchor\" href=\"#pod\">#</a> pod</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">部分工作节点上的pod一直处于ContainerCreating的状态</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span>  <span class=\"string\">-o</span> <span class=\"string\">wide</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">tomcat</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">NAME</span>         <span class=\"string\">READY</span>     <span class=\"string\">STATUS</span>               <span class=\"string\">RESTARTS</span>    <span class=\"string\">AGE</span>     <span class=\"string\">IP</span>             <span class=\"string\">NODE</span></span><br><span class=\"line\"><span class=\"string\">tomcat-pod</span>     <span class=\"number\">0</span><span class=\"string\">/1</span>       <span class=\"string\">ContainerCreating</span>     <span class=\"number\">0</span>         <span class=\"string\">106s</span>    <span class=\"number\">10.244</span><span class=\"number\">.1</span><span class=\"number\">.4</span>     <span class=\"string\">k8s-node1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">describe</span> <span class=\"string\">pods</span> <span class=\"string\">tomcat-pod</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">一、pending状态</span></span><br><span class=\"line\"><span class=\"string\">Pending是挂起状态：表示创建的Pod找不到可以运行它的物理节点，不能调度到相应的节点上运行，那么这种情况如何去排查呢？我门可以从两个层面分析问题：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">.物理节点层面分析：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">）查看节点资源使用情况：如free</span> <span class=\"string\">-m查看内存、top查看CPU使用率、df</span> <span class=\"string\">–h查看磁盘使用情况，这样就可以快速定位节点资源情况，判断是不是节点有问题</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">）查看节点污点：kubectl</span> <span class=\"string\">describe</span> <span class=\"string\">nodes</span>  <span class=\"string\">master1（控制节点名字），如果节点定义了污点，那么Pod不能容忍污点，就会导致调度失败，如下：</span></span><br><span class=\"line\"><span class=\"attr\">Taints:</span>    <span class=\"string\">node-role.kubernetes.io/master:NoSchedule</span></span><br><span class=\"line\"><span class=\"string\">这个看到的是控制节点的污点，表示不允许Pod调度（如果Pod定义容忍度，则可以实现调度）</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2.</span><span class=\"string\">Pod本身分析</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">）在定义pod时，如果指定了nodeName是不存在的，那也会调度失败</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">）在定义Pod时，如果定义的资源请求比较大，导致物理节点资源不够</span></span><br><span class=\"line\"><span class=\"string\">如何排查，可按如下分析：</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">）在定于pod时，如果制定了node节点应亲和性或者nodeselector，那么没有满足的条件，也会pending状态</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">二、ImagePullBackOff状态</span></span><br><span class=\"line\"><span class=\"string\">问题分析：</span></span><br><span class=\"line\"><span class=\"string\">拉取镜像时间长导致超时：</span></span><br><span class=\"line\"><span class=\"string\">配置的镜像有错误：如镜像名字不存在等</span></span><br><span class=\"line\"><span class=\"string\">配置的镜像无法访问：如网络限制无法访问hub上的镜像</span></span><br><span class=\"line\"><span class=\"string\">配置的私有镜像仓库参数错误：如imagePullSecret没有配置或者配置错误</span></span><br><span class=\"line\"><span class=\"string\">dockerfile打包的镜像不可用</span></span><br><span class=\"line\"><span class=\"string\">排查思路：</span></span><br><span class=\"line\"><span class=\"comment\">#查看Pod</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span> <span class=\"string\">-o</span> <span class=\"string\">wide</span></span><br><span class=\"line\"><span class=\"string\">显示如下：</span></span><br><span class=\"line\"><span class=\"string\">tomcat-pod</span>     <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ImagePullBackOff</span>   <span class=\"number\">0</span>          <span class=\"string\">105s</span></span><br><span class=\"line\"><span class=\"string\">通过上面可以看到镜像拉取有问题，那可以进一步再排查错误</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">describe</span> <span class=\"string\">pods</span> <span class=\"string\">tomcat-pod</span></span><br><span class=\"line\"><span class=\"string\">显示如下：</span></span><br><span class=\"line\"><span class=\"string\">Normal</span>   <span class=\"string\">BackOff</span>    <span class=\"string\">96s</span> <span class=\"string\">(x7</span> <span class=\"string\">over</span> <span class=\"string\">6m15s)</span>    <span class=\"string\">kubelet</span>            <span class=\"string\">Back-off</span> <span class=\"string\">pulling</span> <span class=\"string\">image</span> <span class=\"string\">&quot;atomcat:8.5-jre8-alpine&quot;</span></span><br><span class=\"line\"><span class=\"string\">可以在宿主机通过docker</span> <span class=\"string\">pull手动验证是否可以正常拉取镜像</span></span><br><span class=\"line\"><span class=\"string\">docker</span> <span class=\"string\">pull</span> <span class=\"string\">atomcat:8.5-jre8-alpine</span></span><br><span class=\"line\"><span class=\"string\">报错：</span></span><br><span class=\"line\"><span class=\"attr\">Error response from daemon:</span> <span class=\"string\">pull</span> <span class=\"string\">access</span> <span class=\"string\">denied</span> <span class=\"string\">for</span> <span class=\"string\">atomcat,</span> <span class=\"string\">repository</span> <span class=\"string\">does</span> <span class=\"string\">not</span> <span class=\"string\">exist</span> <span class=\"string\">or</span> <span class=\"string\">may</span> <span class=\"string\">require</span> <span class=\"attr\">&#x27;docker login&#x27;:</span> <span class=\"attr\">denied:</span> <span class=\"string\">requested</span> <span class=\"string\">access</span> <span class=\"string\">to</span> <span class=\"string\">the</span> <span class=\"string\">resource</span> <span class=\"string\">is</span> <span class=\"string\">denied</span></span><br><span class=\"line\"><span class=\"string\">那就说明我们使用的镜像有问题，需要重新更改镜像地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">三、CrashLoopBackOff状态</span></span><br><span class=\"line\"><span class=\"string\">K8s中的pod正常运行，但是里面的容器可能退出或者多次重启或者准备删除，导致出现这个状态，这个状态具有偶发性，可能上一秒还是running状态，但是突然就变成CrashLoopBackOff状态了。</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">）kubectl</span> <span class=\"string\">logs</span> <span class=\"string\">查看日志，出现如下：</span></span><br><span class=\"line\"><span class=\"attr\">standard_init_linux.go:216:</span> <span class=\"string\">exec</span> <span class=\"string\">user</span> <span class=\"string\">process</span> <span class=\"string\">caused</span> <span class=\"string\">&quot;exec format error“</span></span><br><span class=\"line\"><span class=\"string\">解决方案：</span></span><br><span class=\"line\"><span class=\"string\">查看构建镜像用的代码是否有问题，如果代码没问题，再看环境变量是否有问题，可能权限问题：假如pod挂载了数据目录，这个数据目录，我们需要修改属主和属组，否则pod往这个目录写数据，可能没权限</span></span><br><span class=\"line\"><span class=\"string\">2）kubectl describe pods 查看详细信息</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">四、Evicted状态</span></span><br><span class=\"line\"><span class=\"string\">这个Evicted表示pod所在节点的资源不够了，pod被驱逐走了</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">五、Complete状态</span></span><br><span class=\"line\"><span class=\"string\">这个状态表示pod里面的任务完成了，job或者cronjob创建pod的时候，如果pod任务完成了，会出现这个complete状态</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">六、error状态</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">15、pod健康探测</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">pod定义的存活性探测如下：</span></span><br><span class=\"line\"><span class=\"string\">livenessProbe:</span></span><br><span class=\"line\"><span class=\"string\">       httpGet:</span></span><br><span class=\"line\"><span class=\"string\">         path: /</span></span><br><span class=\"line\"><span class=\"string\">         port: 8080</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">常见错误：</span></span><br><span class=\"line\"><span class=\"string\">Killing container with id docker://:Container failed probe.. Container will be killed and recreated. Liveness</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">如果在pod启动时遇到这种情况，一般是没有设置 initialDelaySeconds导致的</span></span><br><span class=\"line\"><span class=\"string\"># 设置初始化延迟initialDelaySeconds。</span></span><br><span class=\"line\"><span class=\"string\">livenessProbe:</span></span><br><span class=\"line\"><span class=\"string\">       httpGet:</span></span><br><span class=\"line\"><span class=\"string\">         path: /</span></span><br><span class=\"line\"><span class=\"string\">         port: 8080</span></span><br><span class=\"line\"><span class=\"string\">       initialDelaySeconds: 15 # pod启动过15s开始探测</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">15、pod服务超时</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">K8S中Pod服务连接超时主要分以下几种情况：</span></span><br><span class=\"line\"><span class=\"string\">1.Pod和Pod连接超时</span></span><br><span class=\"line\"><span class=\"string\">2.Pod和虚拟主机上的服务连接超时</span></span><br><span class=\"line\"><span class=\"string\">3.Pod和云主机连接超时</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">针对上面几种问题，排查思路可按下面方法：</span></span><br><span class=\"line\"><span class=\"string\">网络插件层面：</span></span><br><span class=\"line\"><span class=\"string\">查看calico或者flannel是否是running状态，查看日志提取重要信息</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">Pod层面：</span></span><br><span class=\"line\"><span class=\"string\">检查Pod网络，测试Pod是否可以ping通同网段其他pod ip</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">物理机层面：</span></span><br><span class=\"line\"><span class=\"string\">检查物理机网络，测试ping www.baidu.com，ping其他的pod ip</span></span><br><span class=\"line\"><span class=\"string\">可以抓包测试有无异常</span></span><br><span class=\"line\"><span class=\"string\">通过抓包修改内核参数</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">16、service代理pod出现问题</span></span><br><span class=\"line\"><span class=\"string\">直接访问pod可以请求到，但是访问pod前端service，通过请求pod有问题，请求不到。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">iptables： 重启iptables，重启iptables不可以，重启下机器</span></span><br><span class=\"line\"><span class=\"string\">ipvs：重启机器</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"tekton\"><a class=\"markdownIt-Anchor\" href=\"#tekton\">#</a> Tekton</h2>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Tekton</span> <span class=\"string\">是一个功能强大且灵活的</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">原生开源框架，是谷歌开源的，功能强大且灵活，开源社区也正在快速的迭代和发展壮大，主要用于创建持续集成和交付（CI/CD）系统。通过抽象底层实现细节，用户可以跨多云平台和本地系统进行构建、测试和部署。另外，基于kubernetes</span> <span class=\"string\">CRD定义的pipeline流水线也是Tekton最重要的特征。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">CRD全称是CustomResourceDefinition：</span></span><br><span class=\"line\"><span class=\"string\">在</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">中一切都可视为资源，Kubernetes</span> <span class=\"number\">1.7</span> <span class=\"string\">之后增加了对</span> <span class=\"string\">CRD</span> <span class=\"string\">自定义资源二次开发能力来扩展</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">API，通过</span> <span class=\"string\">CRD</span> <span class=\"string\">我们可以向</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">API</span> <span class=\"string\">中增加新资源类型，而不需要修改</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">源码来创建自定义的</span> <span class=\"string\">API</span> <span class=\"string\">server，该功能大大提高了</span> <span class=\"string\">Kubernetes</span> <span class=\"string\">的扩展能力。当你创建一个新的CustomResourceDefinition</span> <span class=\"string\">(CRD)时，Kubernetes</span> <span class=\"string\">API服务器将为你指定的每个版本创建一个新的RESTful资源路径，我们可以根据该api路径来创建一些我们自己定义的类型资源。CRD可以是命名空间的，也可以是集群范围的，由CRD的作用域(scpoe)字段中所指定的，与现有的内置对象一样，删除名称空间将删除该名称空间中的所有自定义对象。customresourcedefinition本身没有名称空间，所有名称空间都可以使用。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">持续集成是云原生应用的支柱技术之一，因此在交付基于云原生的一些支撑产品的时候，CICD</span> <span class=\"string\">是非常好的方案。为了满足这种需要，自然而然会想到对Jenkins(X)或者</span> <span class=\"string\">Gitlab</span> <span class=\"string\">进行集成，也有创业公司出来的一些小工具比如</span> <span class=\"string\">Argo</span> <span class=\"string\">Rollout。Tekton</span> <span class=\"string\">是一款</span> <span class=\"string\">k8s</span> <span class=\"string\">原生的应用发布框架，主要用来构建</span> <span class=\"string\">CI/CD</span> <span class=\"string\">系统。它原本是</span> <span class=\"string\">knative</span> <span class=\"string\">项目里面一个叫做</span> <span class=\"string\">build-pipeline</span> <span class=\"string\">的子项目，用来作为</span> <span class=\"string\">knative-build</span> <span class=\"string\">的下一代引擎。然而，随着</span> <span class=\"string\">k8s</span> <span class=\"string\">社区里各种各样的需求涌入，这个子项目慢慢成长为一个通用的框架，能够提供灵活强大的能力去做基于</span> <span class=\"string\">k8s</span> <span class=\"string\">的构建发布。Tekton</span> <span class=\"string\">其实只提供</span> <span class=\"string\">Pipeline</span> <span class=\"string\">这个一个功能，Pipeline</span> <span class=\"string\">会被直接映射成</span> <span class=\"string\">K8s</span> <span class=\"string\">Pod</span> <span class=\"string\">等</span> <span class=\"string\">API</span> <span class=\"string\">资源。而比如应用发布过程的控制，灰度和上线策略，都是我们自己编写</span> <span class=\"string\">K8s</span> <span class=\"string\">Controller来实现的，也就意味着</span> <span class=\"string\">Tekton</span> <span class=\"string\">不会在K8s</span> <span class=\"string\">上盖一个”大帽子“，比如我们想看发布状态、日志等是直接通过</span> <span class=\"string\">K8s</span> <span class=\"string\">查看这个</span> <span class=\"string\">Pipeline</span> <span class=\"string\">对应的</span> <span class=\"string\">Pod</span> <span class=\"string\">的状态和日志，不需要再面对另外一个</span> <span class=\"string\">API。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Tekton功能：</span></span><br><span class=\"line\"><span class=\"number\">1.</span><span class=\"string\">Kubernetes原生的Tekton的所有配置都是使用CRD方式进行编写存储的，非常易于检索和使用。</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">.配置和流程分离：</span> <span class=\"string\">Tekton的Pipeline和配置可以分开编写，使用名称进行引用。</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">.轻量级核心的Pipeline</span> <span class=\"string\">非常轻便：适合作为组件进行集成，另外也有周边的</span> <span class=\"string\">Dashboard、Trigger、CLI等工具，能够进一步挖掘其潜力。</span></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">.可复用、组合的</span> <span class=\"string\">Pipeline</span> <span class=\"string\">构建方式：非常适合在集成过程中对Pipeline进行定制。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">这里的流程大致是：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、用户把需要部署的应用先按照一套标准的应用定义写成</span> <span class=\"string\">YAML</span> <span class=\"string\">文件（类似</span> <span class=\"string\">Helm</span> <span class=\"string\">Chart）；</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、用户把应用定义</span> <span class=\"string\">YAML</span> <span class=\"string\">推送到</span> <span class=\"string\">Git</span> <span class=\"string\">仓库里；</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、Tekton</span> <span class=\"string\">CD</span> <span class=\"string\">(一个</span> <span class=\"string\">K8s</span> <span class=\"string\">Operator)</span> <span class=\"string\">会监听到相应的改动，根据不同条件生成不同的</span> <span class=\"string\">Tekton</span> <span class=\"string\">Pipelines；</span></span><br><span class=\"line\"><span class=\"string\">Tekton</span> <span class=\"string\">CD</span> <span class=\"string\">的操作具体分为以下几种情况：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、如果</span> <span class=\"string\">Git</span> <span class=\"string\">改动里有一个应用</span> <span class=\"string\">YAML</span> <span class=\"string\">且该应用不存在，那么将渲染和生成</span> <span class=\"string\">Tekton</span> <span class=\"string\">Pipelines</span> <span class=\"string\">用来创建应用。</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、如果</span> <span class=\"string\">Git</span> <span class=\"string\">改动里有一个应用</span> <span class=\"string\">YAML</span> <span class=\"string\">且该应用存在，那么将渲染和生成</span> <span class=\"string\">Tekton</span> <span class=\"string\">Pipelines</span> <span class=\"string\">用来升级应用。这里我们会根据应用定义</span> <span class=\"string\">YAML</span> <span class=\"string\">里的策略来做升级，比如做金丝雀发布、灰度升级。</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、如果</span> <span class=\"string\">Git</span> <span class=\"string\">改动里有一个应用</span> <span class=\"string\">YAML</span> <span class=\"string\">且该应用存在且标记了“被删除”，那么将渲染和生成</span> <span class=\"string\">Tekton</span> <span class=\"string\">Pipelines</span> <span class=\"string\">用来删除应用。确认应用被删除后，我们才从</span> <span class=\"string\">Git</span> <span class=\"string\">里删除这个应用的</span> <span class=\"string\">YAML。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">安装Tekton</span></span><br><span class=\"line\"><span class=\"comment\">#把tekton-0-12-0.tar.gz和busybox-v-1-0.tar.gz上传到node1机器上，手动解压：</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span>]<span class=\"comment\"># docker load -i tekton-0-12-0.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span>]<span class=\"comment\"># docker load -i busybox-v-1-0.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span>]<span class=\"comment\"># docker load -i tekton-0-12-0.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span>]<span class=\"comment\"># docker load -i busybox-v-1-0.tar.gz</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#编写安装tekton资源清单文件</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f release.yaml</span></span><br><span class=\"line\"><span class=\"comment\">#验证pod是否创建成功</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pods -n tekton-pipelines</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                          <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">tekton-pipelines-controller-d64889fb9-9b68f</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>              <span class=\"string\">52s</span></span><br><span class=\"line\"><span class=\"string\">tekton-pipelines-webhook-7c8664944c-ctsgf</span>     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>            <span class=\"string\">52s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get crd</span></span><br><span class=\"line\"><span class=\"string\">找到下面这些东西，说明创建crd成功了：</span></span><br><span class=\"line\"><span class=\"string\">pipelineresources.tekton.dev</span>                          <span class=\"number\">2021-08-21T13:52:16Z</span></span><br><span class=\"line\"><span class=\"string\">pipelineruns.tekton.dev</span>                               <span class=\"number\">2021-08-21T13:52:16Z</span></span><br><span class=\"line\"><span class=\"string\">pipelines.tekton.dev</span>                                  <span class=\"number\">2021-08-21T13:52:16Z</span></span><br><span class=\"line\"><span class=\"string\">taskruns.tekton.dev</span>                                   <span class=\"number\">2021-08-21T13:52:16Z</span></span><br><span class=\"line\"><span class=\"string\">tasks.tekton.dev</span>                                      <span class=\"number\">2021-08-21T13:52:16Z</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl api-versions</span></span><br><span class=\"line\"><span class=\"string\">看到下面说明apiversion创建成功了</span></span><br><span class=\"line\"><span class=\"string\">tekton.dev/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">tekton.dev/v1beta1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Tekton概念</span></span><br><span class=\"line\"><span class=\"string\">Tekton</span> <span class=\"string\">为Kubernetes</span> <span class=\"string\">提供了多种</span> <span class=\"string\">CRD</span> <span class=\"string\">资源对象，可用于定义我们的流水线，主要有以下几个CRD资源对象：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">）Task：表示执行命令的一系列步骤，task</span> <span class=\"string\">里可以定义一系列的</span> <span class=\"string\">steps，例如编译代码、构建镜像、推送镜像等，每个</span> <span class=\"string\">step</span> <span class=\"string\">实际由一个</span> <span class=\"string\">Pod</span> <span class=\"string\">里的容器执行。</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">）TaskRun：task只是定义了一个模版，taskRun</span> <span class=\"string\">才真正代表了一次实际的运行，当然你也可以自己手动创建一个taskRun，taskRun创建出来之后，就会自动触发task描述的构建任务。</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">）Pipeline：一组任务，表示一个或多个task、PipelineResource</span> <span class=\"string\">以及各种定义参数的集合。</span></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">）PipelineRun：类似task和taskRun的关系，pipelineRun也表示某一次实际运行的</span> <span class=\"string\">pipeline，下发一个</span> <span class=\"string\">pipelineRun</span> <span class=\"string\">CRD</span> <span class=\"string\">实例到</span> <span class=\"string\">Kubernetes后，同样也会触发一次</span> <span class=\"string\">pipeline</span> <span class=\"string\">的构建。</span></span><br><span class=\"line\"><span class=\"number\">5</span><span class=\"string\">）PipelineResource：表示pipeline输入资源，比如github上的源码，或者pipeline</span> <span class=\"string\">输出资源，例如一个容器镜像或者构建生成的jar包等。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">我们测试一个简单的golang程序。应用程序代码，测试及dockerfile文件可在如下地址获取：https://github.com/luckylucky421/tekton-demo</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3.8</span><span class=\"number\">.1</span>  <span class=\"string\">clone应用程序代码进行测试，创建一个task任务</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat task-test.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">tekton.dev/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Task</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">repo</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">  <span class=\"attr\">steps:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">run-test</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">golang:1.14-alpine</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">workingDir:</span> <span class=\"string\">/workspace/repo</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [<span class=\"string\">&quot;go&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">args:</span> [<span class=\"string\">&quot;test&quot;</span>]</span><br><span class=\"line\"><span class=\"comment\">#更新资源清单文件</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f task-test.yaml </span></span><br><span class=\"line\"><span class=\"string\">task.tekton.dev/test</span> <span class=\"string\">created</span></span><br><span class=\"line\"><span class=\"comment\">#查看Task资源</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get Task</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">test</span>   <span class=\"string\">23s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">resources定义了我们的任务中定义的步骤中需要输入的内容，这里我们的步骤需要</span> <span class=\"string\">Clone</span> <span class=\"string\">一个</span> <span class=\"string\">Git</span> <span class=\"string\">仓库作为</span> <span class=\"string\">go</span> <span class=\"string\">test</span> <span class=\"string\">命令的输入。Tekton</span> <span class=\"string\">内置了一种</span> <span class=\"string\">git</span> <span class=\"string\">资源类型，它会自动将代码仓库</span> <span class=\"string\">Clone</span> <span class=\"string\">到</span> <span class=\"string\">/workspace/$input_name</span> <span class=\"string\">目录中，由于我们这里输入被命名成</span> <span class=\"string\">repo，所以代码会被</span> <span class=\"string\">Clone</span> <span class=\"string\">到</span> <span class=\"string\">/workspace/repo</span> <span class=\"string\">目录下面。然后下面的</span> <span class=\"string\">steps</span> <span class=\"string\">就是来定义执行运行测试命令的步骤，这里我们直接在代码的根目录中运行</span> <span class=\"string\">go</span> <span class=\"string\">test</span> <span class=\"string\">命令即可，需要注意的是命令和参数需要分别定义。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">创建pipelineresource资源对象</span></span><br><span class=\"line\"><span class=\"string\">通过上面步骤我们定义了一个</span> <span class=\"string\">Task</span> <span class=\"string\">任务，但是该任务并不会立即执行，我们必须创建一个</span> <span class=\"string\">TaskRun</span> <span class=\"string\">引用它并提供所有必需输入的数据才行。这里我们就需要将</span> <span class=\"string\">git</span> <span class=\"string\">代码库作为输入，我们必须先创建一个</span> <span class=\"string\">PipelineResource</span> <span class=\"string\">对象来定义输入信息，创建一个名为</span> <span class=\"string\">pipelineresource.yaml</span> <span class=\"string\">的资源清单文件，内容如下所示：</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat pipelineresource.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">tekton.dev/v1alpha1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PipelineResource</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">-tekton-example</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">git</span></span><br><span class=\"line\">  <span class=\"attr\">params:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">url</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">https://github.com/luckylucky421/tekton-demo</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">revision</span></span><br><span class=\"line\">      <span class=\"attr\">value:</span> <span class=\"string\">master</span></span><br><span class=\"line\"><span class=\"comment\">#更新资源清单文件</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f pipelineresource.yaml </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">创建taskrun任务</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat taskrun.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">tekton.dev/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">TaskRun</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">testrun</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">taskRef:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">test</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">inputs:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">repo</span></span><br><span class=\"line\">      <span class=\"attr\">resourceRef:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">-tekton-example</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#更新资源清单文件</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f taskrun.yaml </span></span><br><span class=\"line\"><span class=\"comment\">#上面资源清单文件解释说明</span></span><br><span class=\"line\"><span class=\"string\">这里通过taskRef引用上面定义的Task和git仓库作为输入，resourceRef也是引用上面定义的PipelineResource资源对象。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#创建后，我们可以通过查看TaskRun资源对象的状态来查看构建状态</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get taskrun</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>      <span class=\"string\">SUCCEEDED</span>   <span class=\"string\">REASON</span>    <span class=\"string\">STARTTIME</span></span><br><span class=\"line\"><span class=\"string\">testrun</span>      <span class=\"string\">Unknown</span>     <span class=\"string\">Running</span>    <span class=\"string\">6s</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pods</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">testrun-pod-x9rkn</span>   <span class=\"number\">2</span><span class=\"string\">/2</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">9s</span></span><br><span class=\"line\"><span class=\"string\">当任务执行完成后，</span> <span class=\"string\">Pod</span> <span class=\"string\">就会变成</span> <span class=\"string\">Completed</span> <span class=\"string\">状态了：</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pods</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>      <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">testrun-pod-x9rkn</span>   <span class=\"number\">0</span><span class=\"string\">/2</span>     <span class=\"string\">Completed</span>       <span class=\"number\">0</span>          <span class=\"string\">72s</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"创建自定义资源\"><a class=\"markdownIt-Anchor\" href=\"#创建自定义资源\">#</a> 创建自定义资源</h2>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apiextensions.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">CustomResourceDefinition</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">crontabs.stable.example.com</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">group:</span> <span class=\"string\">stable.example.com</span></span><br><span class=\"line\">  <span class=\"attr\">versions:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">      <span class=\"attr\">served:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">      <span class=\"attr\">schema:</span></span><br><span class=\"line\">        <span class=\"attr\">openAPIV3Schema:</span></span><br><span class=\"line\">          <span class=\"attr\">type:</span> <span class=\"string\">object</span></span><br><span class=\"line\">          <span class=\"attr\">properties:</span></span><br><span class=\"line\">            <span class=\"attr\">spec:</span></span><br><span class=\"line\">              <span class=\"attr\">type:</span> <span class=\"string\">object</span></span><br><span class=\"line\">              <span class=\"attr\">properties:</span></span><br><span class=\"line\">                <span class=\"attr\">cronSpec:</span></span><br><span class=\"line\">                  <span class=\"attr\">type:</span> <span class=\"string\">string</span></span><br><span class=\"line\">                <span class=\"attr\">image:</span></span><br><span class=\"line\">                  <span class=\"attr\">type:</span> <span class=\"string\">string</span></span><br><span class=\"line\">                <span class=\"attr\">replicas:</span></span><br><span class=\"line\">                  <span class=\"attr\">type:</span> <span class=\"string\">integer</span></span><br><span class=\"line\">  <span class=\"attr\">scope:</span> <span class=\"string\">Namespaced</span></span><br><span class=\"line\">  <span class=\"attr\">names:</span></span><br><span class=\"line\">    <span class=\"attr\">plural:</span> <span class=\"string\">crontabs</span></span><br><span class=\"line\">    <span class=\"attr\">singular:</span> <span class=\"string\">crontab</span></span><br><span class=\"line\">    <span class=\"attr\">kind:</span> <span class=\"string\">CronTab</span></span><br><span class=\"line\">    <span class=\"attr\">shortNames:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ct</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"string\">Yaml文件注解：</span></span><br><span class=\"line\"><span class=\"string\">metadata.name</span> <span class=\"string\">是用户自定义资源中自己自定义的一个名字。一般我们建议使用“顶级域名.xxx.APIGroup”这样的格式，名称必须与下面的spec.Group字段匹配，格式为:</span> <span class=\"string\">&lt;plural&gt;.&lt;group&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">spec</span> <span class=\"string\">用于指定该</span> <span class=\"string\">CRD</span> <span class=\"string\">的</span> <span class=\"string\">group、version。比如在创建</span> <span class=\"string\">Pod</span> <span class=\"string\">或者</span> <span class=\"string\">Deployment</span> <span class=\"string\">时，它的</span> <span class=\"string\">group</span> <span class=\"string\">可能为</span> <span class=\"string\">apps/v1</span> <span class=\"string\">或者</span> <span class=\"string\">apps/v1beta1</span> <span class=\"string\">之类，这里我们也同样需要去定义</span> <span class=\"string\">CRD</span> <span class=\"string\">的</span> <span class=\"string\">group。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">group:</span> <span class=\"string\">stable.example.com</span> <span class=\"comment\">#组名称</span></span><br><span class=\"line\">  <span class=\"attr\">versions:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">      <span class=\"comment\">#指定组下的版本</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">served:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#每个版本都可以通过服务标志启用/禁用</span></span><br><span class=\"line\"><span class=\"attr\">storage:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"comment\">#必须将一个且只有一个版本标记为存储版本。</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"attr\">scope:</span> <span class=\"string\">Namespaced</span></span><br><span class=\"line\"><span class=\"comment\">#指定crd资源作用范围在命名空间或集群</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">names</span> <span class=\"string\">指的是它的</span> <span class=\"string\">kind</span> <span class=\"string\">是什么，比如</span> <span class=\"string\">Deployment</span> <span class=\"string\">的</span> <span class=\"string\">kind</span> <span class=\"string\">就是</span> <span class=\"string\">Deployment，Pod</span> <span class=\"string\">的</span> <span class=\"string\">kind</span> <span class=\"string\">就是</span> <span class=\"string\">Pod，这里的</span> <span class=\"string\">kind</span> <span class=\"string\">被定义为了CronTab</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">plural</span> <span class=\"string\">字段就是一个昵称，比如当一些字段或者一些资源的名字比较长时，可以用该字段自定义一些昵称来简化它的长度；</span></span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"attr\">singular:</span> <span class=\"string\">crontab</span></span><br><span class=\"line\"><span class=\"comment\"># 在CLI(shell界面输入的参数)上用作别名并用于显示的单数名称</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attr\">shortNames:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ct</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 短名称允许短字符串匹配CLI上的资源，就是能通过kubectl 在查看资源的时候使用该资源的简名称来获取。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">## 创建资源</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">&quot;stable.example.com/v1&quot;</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">CronTab</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-new-cron-object</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">cronSpec:</span> <span class=\"string\">&quot;* * * * * *&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、项目地址</span></span><br><span class=\"line\"><span class=\"string\">https://github.com/mongodb/mongodb-kubernetes-operator.git</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">把课件里的压缩包传到k8s控制节点上来，手动解压</span></span><br><span class=\"line\"><span class=\"string\">unzip</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0.zip</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、创建名称空间mongodb，并进入到mongodb-kubernetes-operator目录应用crd资源，创建自定义资源类型</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>] <span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">ns</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cd mongodb-kubernetes-operator-0.5.0</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># kubectl apply -f deploy/crds/mongodb.com_mongodbcommunity_crd.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看mongodb是否创建成功</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">crd/mongodbcommunity.mongodb.com</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、安装operator</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># kubectl apply -f deploy/operator/ -n mongodb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">提示：mongodb-kubernetes-operator这个项目是将自定义控制器和自定义资源类型分开实现的；其operator只负责创建和监听对应资源类型的变化，在资源有变化时，实例化为对应资源对象，并保持对应资源对象状态吻合用户期望状态；上述四个清单中主要是创建了一个sa账户，并对对应的sa用户授权；</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">验证：查看operator是否正常运行</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># kubectl get pods -n mongodb</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                           <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">mongodb-kubernetes-operator-7f8c55db45-tmpk5</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">44s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">验证：使用自定义资源类型创建一个mongodb</span> <span class=\"string\">副本集集群</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># cat deploy/crds/mongodb.com_v1_mongodbcommunity_cr.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># kubectl apply -f deploy/crds/mongodb.com_v1_mongodbcommunity_cr.yaml -n mongodb</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">mongodb-kubernetes-operator-0.5.0</span>]<span class=\"comment\"># kubectl get pods -n mongodb</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                           <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">example-mongodb-0</span>                              <span class=\"number\">0</span><span class=\"string\">/2</span>     <span class=\"string\">Pending</span>   <span class=\"number\">0</span>          <span class=\"string\">66s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">提示：这里可以看到对应pod处于pending状态；</span></span><br><span class=\"line\">　　<span class=\"string\">查看pod详细信息</span></span><br><span class=\"line\">　　</span><br><span class=\"line\">　<span class=\"string\">提示：这里提示没有可以用的pvc；</span></span><br><span class=\"line\">　　<span class=\"string\">删除mongodb名称空间下pvc</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pvc</span> <span class=\"string\">-n</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">pvc</span> <span class=\"string\">--all</span> <span class=\"string\">-n</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"></span><br><span class=\"line\">　<span class=\"string\">创建pv和pvc</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat pv-demo.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-pv-v1</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">example-mongodb-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteOnce&quot;</span>,<span class=\"string\">&quot;ReadWriteMany&quot;</span>,<span class=\"string\">&quot;ReadOnlyMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\">  <span class=\"attr\">mountOptions:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">hard</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nfsvers=4.1</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/p1</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.180</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-pv-v2</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">example-mongodb-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteOnce&quot;</span>,<span class=\"string\">&quot;ReadWriteMany&quot;</span>,<span class=\"string\">&quot;ReadOnlyMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\">  <span class=\"attr\">mountOptions:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">hard</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nfsvers=4.1</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/p2</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.180</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"meta\"> </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-pv-v3</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">example-mongodb-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteOnce&quot;</span>,<span class=\"string\">&quot;ReadWriteMany&quot;</span>,<span class=\"string\">&quot;ReadOnlyMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">persistentVolumeReclaimPolicy:</span> <span class=\"string\">Retain</span></span><br><span class=\"line\">  <span class=\"attr\">mountOptions:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">hard</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nfsvers=4.1</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/p3</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.180</span></span><br><span class=\"line\">    </span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data/p1</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data/p2</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data/p3</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/exports</span></span><br><span class=\"line\"><span class=\"string\">/data/v1</span>  <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/p1</span>  <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/p2</span>  <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/p3</span>  <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># exportfs -arv</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f pv-demo.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">创建pvc资源</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat pvc-demo.yaml </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">data-volume-example-mongodb-0</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">data-volume-example-mongodb-1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">data-volume-example-mongodb-2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">mongodb</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">volumeMode:</span> <span class=\"string\">Filesystem</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">500M</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f pvc-demo.yaml</span></span><br><span class=\"line\">[<span class=\"string\">root@master01</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pods -n mongodb </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                                 <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">example-mongodb-0</span>                              <span class=\"number\">2</span><span class=\"string\">/2</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">8m</span></span><br><span class=\"line\"><span class=\"string\">example-mongodb-1</span>                              <span class=\"number\">2</span><span class=\"string\">/2</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">111s</span></span><br><span class=\"line\"><span class=\"string\">example-mongodb-2</span>                              <span class=\"number\">2</span><span class=\"string\">/2</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">48s</span></span><br><span class=\"line\"><span class=\"string\">mongodb-kubernetes-operator-7d557bcc95-th8js</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">9m19s</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/05/30/jenkins/",
            "url": "http://example.com/2023/05/30/jenkins/",
            "title": "Jenkins",
            "date_published": "2023-05-30T05:38:45.000Z",
            "content_html": "<h1 id=\"jenkins\"><a class=\"markdownIt-Anchor\" href=\"#jenkins\">#</a> jenkins</h1>\n<p><strong>注意，这篇需要结合 kubernetes 和一些其他的运维相关知识，不适合单独使用，仅作为 backup</strong></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMXlIZDVmc0tRSVFxSXFYMEUxaTB5Nnc/cHdkPTE5MDMjbGlzdC9wYXRoPSUyRnNoYXJlbGluazMyMzI1MDk1MDAtNjEzNTM3ODY5NzE5MTQ4JTJGSmVua2lucyVFNiU5NSU5OSVFNyVBOCU4QiZhbXA7cGFyZW50UGF0aD0lMkZzaGFyZWxpbmszMjMyNTA5NTAwLTYxMzUzNzg2OTcxOTE0OA==\">Jenkins 教程_免费高速下载 | 百度网盘 - 分享无限制 (baidu.com)</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">gitlab</span><br><span class=\"line\">http://192.168.13.11/</span><br><span class=\"line\">root kbshire1</span><br><span class=\"line\"></span><br><span class=\"line\">jenkins </span><br><span class=\"line\">http://192.168.13.12:8080/</span><br><span class=\"line\">admin kbshire1</span><br><span class=\"line\"></span><br><span class=\"line\">tomcat </span><br><span class=\"line\">http://192.168.13.13:8080/</span><br><span class=\"line\"></span><br><span class=\"line\">harbor</span><br><span class=\"line\">https://192.168.13.14/</span><br><span class=\"line\">admin Harbor12345</span><br><span class=\"line\">Eric123456</span><br><span class=\"line\"></span><br><span class=\"line\">maven </span><br><span class=\"line\">192.168.13.12</span><br><span class=\"line\"></span><br><span class=\"line\">sonarqube</span><br><span class=\"line\">192.168.13.12:9000</span><br><span class=\"line\">admin</span><br><span class=\"line\">admin</span><br><span class=\"line\">token: 8bf0de8a91bef59c1afd4c942935f8fbc1f9db1f</span><br><span class=\"line\"></span><br><span class=\"line\">mysql</span><br><span class=\"line\">192.168.13.12:3306</span><br><span class=\"line\">root</span><br><span class=\"line\">123456</span><br><span class=\"line\"></span><br><span class=\"line\">k8s-jenkins</span><br><span class=\"line\">http://192.168.13.15:32688/</span><br><span class=\"line\">kbshire1</span><br><span class=\"line\"></span><br><span class=\"line\">(*)</span><br><span class=\"line\">http://47.100.66.171:30889/asynchPeople/</span><br><span class=\"line\">http://106.14.71.168:30888/admin/users/</span><br><span class=\"line\">http://192.168.13.132:8080/job/</span><br></pre></td></tr></table></figure>\n<h2 id=\"前置概念\"><a class=\"markdownIt-Anchor\" href=\"#前置概念\">#</a> 前置概念</h2>\n<h3 id=\"软件开发声明周期\"><a class=\"markdownIt-Anchor\" href=\"#软件开发声明周期\">#</a> 软件开发声明周期</h3>\n<p>软件开发生命周期又叫做<strong> SDLC</strong>（Software Development Life Cycle），它是集合了计划、开发、测试和部署过程的集合。</p>\n<p>需求分析</p>\n<p>这是生命周期的第一阶段，根据项目需求，团队执行一个可行性计划的分析。项目需求可能是公司内部或者客户提出的。这阶段主要是对信息的收集，也有可能是对现有项目的改善和重新做一个新的项目。还要分析项目的预算多长，可以从哪方面受益及布局，这也是项目创建的目标。</p>\n<p>设计</p>\n<p>第二阶段就是设计阶段，系统架构和满意状态（就是要做成什么样子，有什么功能），和创建一个项目计划。计划可以使用图表，布局设计或者文者的方式呈现。</p>\n<p>实现</p>\n<p>第三阶段就是实现阶段，项目经理创建和分配工作给开者，开发者根据任务和在设计阶段定义的目标进行开发代码。依据项目的大小和复杂程度，可以需要数月或更长时间才能完成。</p>\n<p>测试</p>\n<p>测试人员进行代码测试 ，包括功能测试、代码测试、压力测试等。</p>\n<p>进化</p>\n<p>最后进阶段就是对产品不断的进化改进和维护阶段，根据用户的使用情况，可能需要对某功能进行修改，bug 修复，功能增加等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417181513388.png\" alt=\"image-20230417181513388\"></p>\n<h3 id=\"瀑布模型\"><a class=\"markdownIt-Anchor\" href=\"#瀑布模型\">#</a> 瀑布模型</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417181556355.png\" alt=\"image-20230417181556355\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417181855245.png\" alt=\"image-20230417181855245\" style=\"zoom: 67%;\" /> \n<h3 id=\"敏捷开发\"><a class=\"markdownIt-Anchor\" href=\"#敏捷开发\">#</a> 敏捷开发</h3>\n<p>敏捷开发 (Agile Development) 的核心是迭代开发 (lterative Development) 与增量开发 (IncrementalDevelopment)。</p>\n<p>虽然敏捷开发将软件开发分成多个迭代，但是也要求，每次迭代都是一个完整的软件开发周期，必须按照软件工程的方法论，进行正规的流程管理。</p>\n<p>早期交付</p>\n<p>降低风险</p>\n<h3 id=\"持续继承\"><a class=\"markdownIt-Anchor\" href=\"#持续继承\">#</a> 持续继承</h3>\n<p>持续集成（ Continuous integration ， 简称 CI ）指的是，频繁地（一天多次）将代码集成到主干。</p>\n<p>提交</p>\n<p>流程的第一步，是开发者向代码仓库提交代码。所有后面的步骤都始于本地代码的一次提交（commit）</p>\n<p>测试（第一轮）</p>\n<p>代码仓库对 commit 操作配置了钩子（hook），只要提交代码或者合并进主干，就会跑自动化测试。</p>\n<p>构建</p>\n<p>通过第一轮测试，代码就可以合并进主干，就算可以交付了。交付后，就先进行构建（build），再进入第二轮测试。所谓构建，指的是将源码转换为可以运行的实际代码，比如安装依赖，配置各种资源（样式表、JS 脚本、图片）等等。</p>\n<p>测试（第二轮）</p>\n<p>构建完成，就要进行第二轮测试。如果第一轮已经涵盖了所有测试内容，第二轮可以省略，当然，这时构建步骤也要移到第一轮测试前面。</p>\n<p>部署</p>\n<p>过了第二轮测试，当前代码就是一个可以直接部署的版本（artifact）。将这个版本的所有文件打包（tar fifilename.tar * ）存档，发到生产服务器。</p>\n<p>回滚</p>\n<p>一旦当前版本发生问题，就要回滚到上一个版本的构建结果。最简单的做法就是修改一下符号链接，指向上一个版本的目录。</p>\n<h3 id=\"jenkins-2\"><a class=\"markdownIt-Anchor\" href=\"#jenkins-2\">#</a> Jenkins</h3>\n<p>Jenkins 是一款流行的开源持续集成（Continuous Integration）工具，广泛用于项目开发，具有自动化构建、测试和部署等功能。官网： <span class=\"exturl\" data-url=\"aHR0cDovL2plbmtpbnMtY2kub3JnLyVFMyU4MCU4Mg==\">http://jenkins-ci.org/。</span></p>\n<p>Jenkins 的特征：</p>\n<p>开源的 Java 语言开发持续集成工具，支持持续集成，持续部署。易于安装部署配置：</p>\n<p>可通过 yum 安装，或下载 war 包以及通过 docker 容器等快速实现安装部署，可方便 web 界面配置管理。</p>\n<p>消息通知及测试报告：集成 RSS/E-mail 通过 RSS 发布构建结果或当构建完成时通过 e-mail 通知，生成 JUnit/TestNG 测试报告。</p>\n<p>分布式构建：支持 Jenkins 能够让多台计算机一起构建 / 测试。</p>\n<p>文件识别：Jenkins 能够跟踪哪次构建生成哪些 jar，哪次构建使用哪个版本的 jar 等。</p>\n<p>丰富的插件支持：支持扩展插件，你可以开发适合自己团队使用的工具，如 git，svn，maven，docker 等。</p>\n<h2 id=\"持续集成流程环境搭建\"><a class=\"markdownIt-Anchor\" href=\"#持续集成流程环境搭建\">#</a> 持续集成流程 &amp; 环境搭建</h2>\n<p>1）首先，开发人员每天进行代码提交，提交到 Git 仓库</p>\n<p>2）然后，Jenkins 作为持续集成工具，使用 Git 工具到 Git 仓库拉取代码到集成服务器，再配合 JDK，Maven 等软件完成代码编译，代码测试与审查，测试，打包等工作，在这个过程中每一步出错，都重新再执行一次整个流程。</p>\n<p>3）最后，Jenkins 把生成的 jar 或 war 包分发到测试服务器或者生产服务器，测试人员或用户就可以访问应用。</p>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>IP</th>\n<th>安装的软件</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>代码托管服务器</td>\n<td>192.168.13.132</td>\n<td>Gitlab</td>\n</tr>\n<tr>\n<td>持续集成服务器</td>\n<td>192.168.13.155</td>\n<td>Jenkins，JDK，Maven，Git，SonarQube</td>\n</tr>\n<tr>\n<td>应用测试服务器</td>\n<td>192.168.13.166</td>\n<td>JDK，tomcat</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"gitlab\"><a class=\"markdownIt-Anchor\" href=\"#gitlab\">#</a> gitlab</h3>\n<p>GitLab 是一个用于仓库管理系统的开源项目，使用 Git 作为代码管理工具，并在此基础上搭建起来的 web 服务。</p>\n<ol>\n<li>安装相关依赖</li>\n</ol>\n<p>yum -y install policycoreutils openssh-server openssh-clients postfifix</p>\n<ol start=\"2\">\n<li>启动 ssh 服务 &amp; 设置为开机启动</li>\n</ol>\n<p>systemctl enable sshd &amp;&amp; sudo systemctl start sshd</p>\n<ol start=\"3\">\n<li>设置 postfifix 开机自启，并启动，postfifix 支持 gitlab 发信功能</li>\n</ol>\n<p>systemctl enable postfix &amp;&amp; systemctl start postfix</p>\n<ol start=\"4\">\n<li>开放 ssh 以及 http 服务，然后重新加载防火墙列表</li>\n</ol>\n<p>fifirewall-cmd --add-service=ssh --permanent</p>\n<p>fifirewall-cmd --add-service=http --permanent</p>\n<p>fifirewall-cmd --reload</p>\n<ol start=\"5\">\n<li>下载 gitlab 包，并且安装</li>\n</ol>\n<p>在线下载安装包：</p>\n<p>wget <span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL2dpdGxhYi1jZS95dW0vZWw2L2dpdGxhYi1jZS0xMi40LjItY2UuMC5lbDYueDg2XzY0LnJwbQ==\">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/el6/gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</span></p>\n<p>安装：</p>\n<p>rpm -i gitlab-ce-12.4.2-ce.0.el6.x86_64.rpm</p>\n<p>centos8 ： <span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYWNrYWdlcy5naXRsYWIuY29tL2dpdGxhYi9naXRsYWItY2UvcGFja2FnZXMvZWwvOC9naXRsYWItY2UtMTUuMTAuMy1jZS4wLmVsOC54ODZfNjQucnBt\">el/8/gitlab-ce-15.10.3-ce.0.el8.x86_64.rpm - gitlab/gitlab-ce · packages.gitlab.com</span></p>\n<ol start=\"6\">\n<li>修改 gitlab 配置</li>\n</ol>\n<p>vi /etc/gitlab/gitlab.rb</p>\n<p>修改 gitlab 访问地址和端口，默认为 80，我们改为 82</p>\n<p>external_url ‘<span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguNjYuMTAwOjgy\">http://192.168.66.100:82</span>’</p>\n<p>nginx[‘listen_port’] = 82</p>\n<ol start=\"7\">\n<li>重载配置及启动 gitlab</li>\n</ol>\n<p>gitlab-ctl reconfigure</p>\n<p>gitlab-ctl restart</p>\n<ol start=\"8\">\n<li>把端口添加到防火墙</li>\n</ol>\n<p>fifirewall-cmd --zone=public --add-port=82/tcp --permanent</p>\n<p>fifirewall-cmd --reload</p>\n<h3 id=\"jenkins-3\"><a class=\"markdownIt-Anchor\" href=\"#jenkins-3\">#</a> jenkins</h3>\n<p>1）安装 JDK</p>\n<p>Jenkins 需要依赖 JDK，所以先安装 JDK1.8</p>\n<p><code>yum install java-1.8.0-openjdk* -y</code></p>\n<p><strong>新版 Jenkins 要求必须 java 为 11 或 17，使用 1.8 会导致 Jenkins 无法启动</strong></p>\n<p><em><em>yum intall java-11</em> - y</em>*</p>\n<p>安装目录为：/usr/lib/jvm</p>\n<p>2）获取 jenkins 安装包</p>\n<p>下载页面：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9qZW5raW5zLmlvL3poL2Rvd25sb2FkLw==\">https://jenkins.io/zh/download/</span></p>\n<p>安装文件：jenkins-2.190.3-1.1.noarch.rpm</p>\n<p>3）把安装包上传到 192.168.66.101 服务器，进行安装</p>\n<p>rpm -ivh jenkins-2.190.3-1.1.noarch.rpm</p>\n<p>4）修改 Jenkins 配置</p>\n<p>vi /etc/syscofifig/jenkins</p>\n<p>修改内容如下：</p>\n<p>JENKINS_USER=“root”</p>\n<p>JENKINS_PORT=“8888”</p>\n<p>5）启动 Jenkins</p>\n<p>systemctl start jenkins</p>\n<p>6）打开浏览器访问</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguNjYuMTAxOjg4ODg=\">http://192.168.66.101:8888</span></p>\n<p>先跳过插件，之后换源之后再自行安装</p>\n<p>安装插件前先替换源</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sed -i &#x27;s/http:\\/\\/updates.jenkins-ci.org\\/download/https:\\/\\/mirrors.tuna.tsinghua.edu.cn\\/jenkins/g&#x27; default.json &amp;&amp; sed -i &#x27;s/http:\\/\\/www.google.com/https:\\/\\/www.baidu.com/g&#x27; default.json</span><br></pre></td></tr></table></figure>\n<p>再选择 advanced，改成如下网址</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXJyb3JzLnR1bmEudHNpbmdodWEuZWR1LmNuL2plbmtpbnMvdXBkYXRlcy91cGRhdGUtY2VudGVyLmpzb24=\">https://mirrors.tuna.tsinghua.edu.cn/jenkins/updates/update-center.json</span></p>\n<p>重启</p>\n<p>[Restart Jenkins <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTMuMTMyOjgwODAvcmVzdGFydA==\">Jenkins]</span></p>\n<p>如果 Jenkins 启动失败：</p>\n<p>[(68 条消息) <span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3p3anpvbmUvYXJ0aWNsZS9kZXRhaWxzLzEyNTE3MDgyMA==\">Jenkins] Failed to start Jenkins Continuous Integration Server_码里法的博客 - CSDN 博客</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd /etc/init.d</span><br><span class=\"line\"></span><br><span class=\"line\"># 启动</span><br><span class=\"line\">./jenkins start</span><br><span class=\"line\"># 停止</span><br><span class=\"line\">./jenkins stop</span><br><span class=\"line\"># 状态</span><br><span class=\"line\">./jenkins status</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">openssl req -sha512 -new -subj &quot;/C=CN/ST=JS/L=WX/O=zwx/OU=jhmy/CN=192.168.13.14&quot; -key harbor.key -out harbor.csr</span><br></pre></td></tr></table></figure>\n<h3 id=\"用户权限管理\"><a class=\"markdownIt-Anchor\" href=\"#用户权限管理\">#</a> 用户权限管理：</h3>\n<p>安装插件 Role-base auth straegy</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421185352254.png\" alt=\"image-20230421185352254\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421185421344.png\" alt=\"image-20230421185421344\"></p>\n<p>进入 Mange roles，根据需求创建 roles，分配给角色</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421185512385.png\" alt=\"image-20230421185512385\"></p>\n<p>baseRole：该角色为全局角色。这个角色需要绑定 Overall 下面的 Read 权限，是为了给所有用户绑定最基本的 Jenkins 访问权限。注意：如果不给后续用户绑定这个角色，会报错误：用户名 is missing the Overall/Read permission</p>\n<p>role1：该角色为项目角色。使用正则表达式绑定 &quot;itcast.*&quot;，意思是只能操作 itcast 开头的项目。</p>\n<p>role2：该角色也为项目角色。绑定 &quot;itheima.*&quot;，意思是只能操作 itheima 开头的项目。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jenkins</span><br><span class=\"line\">用户名 - kbshire </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"凭证管理\"><a class=\"markdownIt-Anchor\" href=\"#凭证管理\">#</a> 凭证管理</h3>\n<p>凭据可以用来存储需要密文保护的数据库密码、Gitlab 密码信息、Docker 私有仓库密码等，以便 Jenkins 可以和这些第三方的应用进行交互。</p>\n<p>安装插件 Credentials Binding</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421185601535.png\" alt=\"image-20230421185601535\"></p>\n<p>一共有五种凭证</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421185750965.png\" alt=\"image-20230421185750965\"></p>\n<p>Username with password：用户名和密码</p>\n<p>SSH Username with private key： 使用 SSH 用户和密钥</p>\n<p>Secret fifile：需要保密的文本文件，使用时 Jenkins 会将文件复制到一个临时目录中，再将文件路径设置到一个变量中，等构建结束后，所复制的 Secret fifile 就会被删除。</p>\n<p>Secret text：需要保存的一个加密的文本串，如钉钉机器人或 Github 的 api token</p>\n<p>Certifificate：通过上传证书文件的方式</p>\n<p>添加凭证</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230421194819714.png\" alt=\"image-20230421194819714\"></p>\n<p>在 project 选择 git，选择凭证拉取</p>\n<h3 id=\"安装maven\"><a class=\"markdownIt-Anchor\" href=\"#安装maven\">#</a> 安装 maven</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar -xzf apache-maven-3.6.2-bin.tar.gz 解压</span><br><span class=\"line\">mkdir -p /opt/maven 创建目录</span><br><span class=\"line\">mv apache-maven-3.6.2/* /opt/maven 移动文件</span><br><span class=\"line\"></span><br><span class=\"line\">或者yum install maven</span><br><span class=\"line\"></span><br><span class=\"line\">export JAVA_HOME=/usr/lib/jvm/java-11-openjdk/</span><br><span class=\"line\">export MAVEN_HOME=/usr/share/maven</span><br><span class=\"line\">export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Global Tool Confifiguration</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423193611132.png\" alt=\"image-20230423193611132\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423193631789.png\" alt=\"image-20230423193631789\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423193939924.png\" alt=\"image-20230423193939924\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mkdir /root/repo 创建本地仓库目录</span><br><span class=\"line\">vi /opt/maven/conf/settings.xml</span><br><span class=\"line\"></span><br><span class=\"line\">本地仓库改为：/root/repo/</span><br><span class=\"line\">添加阿里云私服地址：</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;mirror&gt;</span><br><span class=\"line\">    &lt;id&gt;aliyunmaven&lt;/id&gt;</span><br><span class=\"line\">    &lt;mirrorOf&gt;*&lt;/mirrorOf&gt;</span><br><span class=\"line\">    &lt;name&gt;阿里云公共仓库&lt;/name&gt;</span><br><span class=\"line\">    &lt;url&gt;https://maven.aliyun.com/repository/public&lt;/url&gt;</span><br><span class=\"line\">&lt;/mirror&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"部署tomcat\"><a class=\"markdownIt-Anchor\" href=\"#部署tomcat\">#</a> 部署 tomcat</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vi /opt/tomcat/conf/tomcat-users.xml</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;tomcat&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;role1&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;manager-script&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;manager-gui&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;manager-status&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;admin-gui&quot;</span>/&gt;</span><br><span class=\"line\">&lt;role rolename=<span class=\"string\">&quot;admin-script&quot;</span>/&gt;</span><br><span class=\"line\">&lt;user username=<span class=\"string\">&quot;tomcat&quot;</span> password=<span class=\"string\">&quot;tomcat&quot;</span> roles=<span class=\"string\">&quot;manager-gui,manager\u0002script,tomcat,admin-gui,admin-script&quot;</span>/&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@tomcat apache-tomcat-10.1.7]<span class=\"comment\"># cd webapps/manager/META-INF/</span></span><br><span class=\"line\">[root@tomcat META-INF]<span class=\"comment\"># vim context.xml </span></span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;!--</span><br><span class=\"line\">  &lt;Valve className=<span class=\"string\">&quot;org.apache.catalina.valves.RemoteAddrValve&quot;</span></span><br><span class=\"line\">         allow=<span class=\"string\">&quot;127\\.\\d+\\.\\d+\\.\\d+|::1|0:0:0:0:0:0:0:1&quot;</span> /&gt;</span><br><span class=\"line\">  --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">登录：</span><br><span class=\"line\">http://192.168.13.13:8080/manager/html</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427195133505.png\" alt=\"image-20230427195133505\"></p>\n<h2 id=\"jenkins构建maven项目\"><a class=\"markdownIt-Anchor\" href=\"#jenkins构建maven项目\">#</a> Jenkins 构建 maven 项目</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Jenkins中自动构建项目的类型有很多，常用的有以下三种：</span><br><span class=\"line\">自由风格软件项目（FreeStyle Project）</span><br><span class=\"line\">Maven项目（Maven Project）</span><br><span class=\"line\">流水线项目（Pipeline Project）</span><br><span class=\"line\">每种类型的构建其实都可以完成一样的构建过程与结果，只是在操作方式、灵活度等方面有所区别，在</span><br><span class=\"line\">实际开发中可以根据自己的需求和习惯来选择。（个人推荐使用流水线类型，因为灵活度非常高）</span><br></pre></td></tr></table></figure>\n<h3 id=\"free_style\"><a class=\"markdownIt-Anchor\" href=\"#free_style\">#</a> free_style</h3>\n<p>[root@jenkins repo]# cd /var/lib/jenkins/workspace/</p>\n<p>Jenkins 默认只有 free_style 的项目</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427201046503.png\" alt=\"image-20230427201046503\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427201111874.png\" alt=\"image-20230427201111874\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427201101832.png\" alt=\"image-20230427201101832\"></p>\n<h3 id=\"maven项目\"><a class=\"markdownIt-Anchor\" href=\"#maven项目\">#</a> maven 项目</h3>\n<p>安装 Deploy to container 插件</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427203149978.png\" alt=\"image-20230427203149978\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427203158112.png\" alt=\"image-20230427203158112\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427203216179.png\" alt=\"image-20230427203216179\"></p>\n<h3 id=\"流水线\"><a class=\"markdownIt-Anchor\" href=\"#流水线\">#</a> 流水线</h3>\n<p>1）概念</p>\n<p>Pipeline，简单来说，就是一套运行在 Jenkins 上的工作流框架，将原来独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排和可视化的工作。</p>\n<p>2）使用 Pipeline 有以下好处（来自翻译自官方文档）：代码：Pipeline 以代码的形式实现，通常被检入源代码控制，使团队能够编辑，审查和迭代其传送流程。 持久：无论是计划内的还是计划外的服务器重启，Pipeline 都是可恢复的。 可停止：Pipeline 可接收交互式输入，以确定是否继续执行 Pipeline。 多功能：Pipeline 支持现实世界中复杂的持续交付要求。它支持 fork/join、循环执行，并行执行任务的功能。 可扩展：Pipeline 插件支持其 DSL 的自定义扩展 ，以及与其他插件集成的多个选项。</p>\n<p>3）如何创建 Jenkins Pipeline 呢？</p>\n<p>Pipeline 脚本是由 <strong>Groovy</strong> 语言实现的，但是我们没必要单独去学习 GroovyPipeline 支持两种语法：<strong>Declarative</strong> (声明式) 和 <strong>Scripted Pipeline</strong> (脚本式) 语法</p>\n<p>Pipeline 也有两种创建方法：可以直接在 Jenkins 的 Web UI 界面中输入脚本；也可以通过创建一个 Jenkinsfifile 脚本文件放入项目源码库中（一般我们都推荐在 Jenkins 中直接从源代码控制 (SCM) 中直接载入 Jenkinsfifile Pipeline 这种方法）。</p>\n<h3 id=\"流水线-2\"><a class=\"markdownIt-Anchor\" href=\"#流水线-2\">#</a> 流水线</h3>\n<h4 id=\"声明式\"><a class=\"markdownIt-Anchor\" href=\"#声明式\">#</a> 声明式</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;Hello&#x27;</span>) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;Hello World&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"脚本式\"><a class=\"markdownIt-Anchor\" href=\"#脚本式\">#</a> 脚本式</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">node &#123;</span><br><span class=\"line\">    def mvnHome</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;pull code&#x27;</span>) &#123; // <span class=\"keyword\">for</span> display purposes</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;Build project&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;publish &#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">echo</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"构建触发器\"><a class=\"markdownIt-Anchor\" href=\"#构建触发器\">#</a> 构建触发器</h3>\n<p>Jenkins 内置 4 种构建触发器：</p>\n<p>触发远程构建</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230428194514430.png\" alt=\"image-20230428194514430\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTMuMTI6ODA4MC9qb2IvcGlwNDQvYnVpbGQ/dG9rZW49OTk5OQ==\">192.168.13.12:8080/job/pip44/build?token=9999</span></p>\n<p>其他工程构建后触发（Build after other projects are build）</p>\n<p>定时构建（Build periodically）</p>\n<p>定时字符串从左往右分别为：</p>\n<p>分 时 日 月 周一些定时表达式的例子：</p>\n<p>每 30 分钟构建一次：H 代表形参 H/30 * * * * 10:02 10:32</p>\n<p>每 2 个小时构建一次: H H/2 * * *</p>\n<p>每天的 8 点，12 点，22 点，一天构建 3 次： (多个时间点中间用逗号隔开) 0 8,12,22 * * *</p>\n<p>每天中午 12 点定时构建一次 H 12 * * *</p>\n<p>每天下午 18 点定时构建一次 H 18 * * *</p>\n<p>在每个小时的前半个小时内的每 10 分钟 H (0-29)/10 * * * *</p>\n<p>每两小时一次，每个工作日上午 9 点到下午 5 点 (也许是上午 10:38，下午 12:38，下午 2:38，下午</p>\n<p>4:38) H H(9-16)/2 * * 1-5</p>\n<p>轮询 SCM（Poll SCM）</p>\n<p>轮询 SCM，是指定时扫描本地代码仓库的代码是否有变更，如果代码有变更就触发项目构建。</p>\n<p>注意：这次构建触发器，Jenkins 会定时扫描本地整个项目的代码，增大系统的开销，不建议使用。</p>\n<h3 id=\"webhook\"><a class=\"markdownIt-Anchor\" href=\"#webhook\">#</a> webhook</h3>\n<p>就是利用 Gitlab 的 webhook 实现代码 push 到仓库，立即触发项目自动构建。</p>\n<p>需要安装两个插件：</p>\n<p>Gitlab Hook 和 GitLab</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230428200812134.png\" alt=\"image-20230428200812134\"></p>\n<h3 id=\"参数化构建\"><a class=\"markdownIt-Anchor\" href=\"#参数化构建\">#</a> 参数化构建</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230428202004524.png\" alt=\"image-20230428202004524\"></p>\n<h3 id=\"sonarqube\"><a class=\"markdownIt-Anchor\" href=\"#sonarqube\">#</a> sonarqube</h3>\n<p>systemctl set-environment MYSQLD_OPTS=&quot;–skip-grant-tables&quot;   慎用</p>\n<p>解压 sonar，并设置权限</p>\n<p>yum install unzip</p>\n<p>unzip sonarqube-6.7.4.zip 解压</p>\n<p>mkdir /opt/sonar 创建目录</p>\n<p>mv sonarqube-6.7.4/* /opt/sonar 移动文件</p>\n<p>useradd sonar 创建 sonar 用户，必须 sonar 用于启动，否则报错</p>\n<p>chown -R sonar. /opt/sonar 更改 sonar 目录及文件权限</p>\n<p>修改 sonar 配置文件</p>\n<p>vi /opt/sonarqube-6.7.4/conf/sonar.properties</p>\n<p>内容如下：</p>\n<p>sonar.jdbc.username=root sonar.jdbc.password=Root@123</p>\n<p>sonar.jdbc.url=jdbc:mysql://localhost:3306/sonar?</p>\n<p>useUnicode=true&amp;characterEncoding=utf8&amp;rewriteBatchedStatements=true&amp;useConfifigs=</p>\n<p>maxPerformance&amp;useSSL=false</p>\n<p>注意：sonar 默认监听 9000 端口，如果 9000 端口被占用，需要更改。</p>\n<p>启动 sonar</p>\n<p>cd /opt/sonarqube-6.7.4</p>\n<p>su sonar ./bin/linux-x86-64/sonar.sh start 启动</p>\n<p>su sonar ./bin/linux-x86-64/sonar.sh status 查看状态</p>\n<p>su sonar ./bin/linux-x86-64/sonar.sh stop 停止</p>\n<p>tail -f logs/sonar.logs 查看日志</p>\n<p>访问 sonar</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguNjYuMTAxOjkwMDA=\">http://192.168.66.101:9000</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430160853684.png\" alt=\"image-20230430160853684\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># must be unique in a given SonarQube instance</span><br><span class=\"line\">sonar.projectKey=free_style</span><br><span class=\"line\"># this is the name and version displayed in the SonarQube UI. Was mandatory prior to SonarQube 6.1.</span><br><span class=\"line\">sonar.projectName=free_style</span><br><span class=\"line\">sonar.projectVersion=1.0</span><br><span class=\"line\"># Path is relative to the sonar-project.properties file. Replace &quot;\\&quot; by &quot;/&quot; on Windows.</span><br><span class=\"line\"># This property is optional if sonar.modules is set.</span><br><span class=\"line\">sonar.sources=.</span><br><span class=\"line\">sonar.exclusions=**/test/**,**/target/**</span><br><span class=\"line\"></span><br><span class=\"line\">sonar.java.source=11</span><br><span class=\"line\">sonar.java.target=11</span><br><span class=\"line\"># Encoding of the source code. Default is default system encoding</span><br><span class=\"line\">sonar.sourceEncoding=UTF-8</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">    agent any</span><br><span class=\"line\"></span><br><span class=\"line\">    stages &#123;</span><br><span class=\"line\">        stage(&#x27;pull images&#x27;) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                checkout scmGit(branches: [[name: &#x27;*/master&#x27;]], extensions: [], userRemoteConfigs: [[credentialsId: &#x27;5e7e7a6e-744e-498b-8790-924dfd4e42a8&#x27;, url: &#x27;http://192.168.13.11/root/test04.git&#x27;]])</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(&#x27;pull images&#x27;) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                script &#123;</span><br><span class=\"line\">                    scannerHome = tool &#x27;sonarqube-scanner&#x27;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                withSonarQubeEnv(&#x27;sonarqube6.7.4&#x27;) &#123;</span><br><span class=\"line\">                sh &quot;$&#123;scannerHome&#125;/bin/sonar-scanner&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(&#x27;build project&#x27;) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                sh &#x27;mvn clean package&#x27;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(&#x27;deploy project&#x27;) &#123;</span><br><span class=\"line\">            steps &#123;</span><br><span class=\"line\">                deploy adapters: [tomcat9(credentialsId: &#x27;b3de0bd0-bcbe-4680-8b56-7e748ef40984&#x27;, path: &#x27;&#x27;, url: &#x27;http://192.168.13.13:8080/&#x27;)], contextPath: null, war: &#x27;target/untitled4_war exploded.war&#x27;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"jenkins微服务持续继承\"><a class=\"markdownIt-Anchor\" href=\"#jenkins微服务持续继承\">#</a> Jenkins 微服务持续继承</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230429204123621.png\" alt=\"image-20230429204123621\"></p>\n<h2 id=\"harbro\"><a class=\"markdownIt-Anchor\" href=\"#harbro\">#</a> harbro</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Harbor需要安装在192.168.66.102上面</span><br><span class=\"line\">1）先安装Docker并启动Docker（已完成）</span><br><span class=\"line\">参考之前的安装过程</span><br><span class=\"line\">2）先安装docker-compose</span><br><span class=\"line\">3）给docker-compose添加执行权限</span><br><span class=\"line\">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class=\"line\">4）查看docker-compose是否安装成功</span><br><span class=\"line\">docker-compose -version</span><br><span class=\"line\">5）下载Harbor的压缩包（本课程版本为：v1.9.2）</span><br><span class=\"line\">https://github.com/goharbor/harbor/releases</span><br><span class=\"line\">6）上传压缩包到linux，并解压</span><br><span class=\"line\">tar -xzf harbor-offline-installer-v1.9.2.tgz</span><br><span class=\"line\">mkdir /opt/harbor</span><br><span class=\"line\">mv harbor/* /opt/harbor</span><br><span class=\"line\">cd /opt/harbor</span><br><span class=\"line\">7）修改Harbor的配置</span><br><span class=\"line\">sudo curl -L https://github.com/docker/compose/releases/download/1.21.2/docker￾compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose</span><br><span class=\"line\">sudo chmod +x /usr/local/bin/docker-compose</span><br><span class=\"line\">vi harbor.yml</span><br><span class=\"line\">修改hostname和port</span><br><span class=\"line\">hostname: 192.168.66.102</span><br><span class=\"line\">port: 85</span><br><span class=\"line\">8）安装Harbor</span><br><span class=\"line\">./prepare</span><br><span class=\"line\">./install.sh</span><br><span class=\"line\">9）启动Harbor</span><br><span class=\"line\">docker-compose up -d 启动</span><br><span class=\"line\">docker-compose stop 停止</span><br><span class=\"line\">docker-compose restart 重新启动</span><br><span class=\"line\"></span><br><span class=\"line\">openssl req -x509 -new -nodes -sha512 -days 3650 \\</span><br><span class=\"line\"> -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.13.14&quot; \\</span><br><span class=\"line\"> -key ca.key \\</span><br><span class=\"line\"> -out ca.crt</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\"> openssl req -sha512 -new \\</span><br><span class=\"line\">    -subj &quot;/C=CN/ST=Beijing/L=Beijing/O=example/OU=Personal/CN=192.168.13.14&quot; \\</span><br><span class=\"line\">    -key 192.168.13.14.key \\</span><br><span class=\"line\">    -out 192.168.13.14.csr</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">cat &gt; v3.ext &lt;&lt;-EOF</span><br><span class=\"line\">authorityKeyIdentifier=keyid,issuer</span><br><span class=\"line\">basicConstraints=CA:FALSE</span><br><span class=\"line\">keyUsage = digitalSignature, nonRepudiation, keyEncipherment, dataEncipherment</span><br><span class=\"line\">extendedKeyUsage = serverAuth</span><br><span class=\"line\">subjectAltName = @alt_names</span><br><span class=\"line\"></span><br><span class=\"line\">[alt_names]</span><br><span class=\"line\">DNS.1=192.168.13.14</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">openssl x509 -req -sha512 -days 3650 \\</span><br><span class=\"line\">    -extfile v3.ext \\</span><br><span class=\"line\">    -CA ca.crt -CAkey ca.key -CAcreateserial \\</span><br><span class=\"line\">    -in 192.168.13.14.csr \\</span><br><span class=\"line\">    -out 192.168.13.14.crt</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//git凭证ID</span><br><span class=\"line\">def git_auth = &quot;b632ed00-fc81-43c8-a746-5aa0673b2658&quot;</span><br><span class=\"line\">//git的url地址</span><br><span class=\"line\">def git_url = &quot;git@192.168.66.100:itheima_group/tensquare_back.git&quot;</span><br><span class=\"line\">//镜像的版本号</span><br><span class=\"line\">def tag = &quot;latest&quot;</span><br><span class=\"line\">//Harbor的url地址</span><br><span class=\"line\">def harbor_url = &quot;192.168.66.102:85&quot;</span><br><span class=\"line\">//镜像库项目名称</span><br><span class=\"line\">def harbor_project = &quot;tensquare&quot;</span><br><span class=\"line\">//Harbor的登录凭证ID</span><br><span class=\"line\">def harbor_auth = &quot;833d1a75-f3db-4aec-9cc4-75a77e423163&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">node &#123;</span><br><span class=\"line\">   //获取当前选择的项目名称</span><br><span class=\"line\">   def selectedProjectNames = &quot;$&#123;project_name&#125;&quot;.split(&quot;,&quot;)</span><br><span class=\"line\">   //获取当前选择的服务器名称</span><br><span class=\"line\">   def selectedServers = &quot;$&#123;publish_server&#125;&quot;.split(&quot;,&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">   stage(&#x27;拉取代码&#x27;) &#123;</span><br><span class=\"line\">      checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &quot;*/$&#123;branch&#125;&quot;]], doGenerateSubmoduleConfigurations: false, extensions: [], submoduleCfg: [], userRemoteConfigs: [[credentialsId: &quot;$&#123;git_auth&#125;&quot;, url: &quot;$&#123;git_url&#125;&quot;]]])</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   stage(&#x27;代码审查&#x27;) &#123;</span><br><span class=\"line\">        for(int i=0;i&lt;selectedProjectNames.length;i++)&#123;</span><br><span class=\"line\">            //tensquare_eureka_server@10086</span><br><span class=\"line\">            def projectInfo = selectedProjectNames[i];</span><br><span class=\"line\">            //当前遍历的项目名称</span><br><span class=\"line\">            def currentProjectName = &quot;$&#123;projectInfo&#125;&quot;.split(&quot;@&quot;)[0]</span><br><span class=\"line\">            //当前遍历的项目端口</span><br><span class=\"line\">            def currentProjectPort = &quot;$&#123;projectInfo&#125;&quot;.split(&quot;@&quot;)[1]</span><br><span class=\"line\"></span><br><span class=\"line\">            //定义当前Jenkins的SonarQubeScanner工具</span><br><span class=\"line\">            def scannerHome = tool &#x27;sonar-scanner&#x27;</span><br><span class=\"line\">            //引用当前JenkinsSonarQube环境</span><br><span class=\"line\">            withSonarQubeEnv(&#x27;sonarqube&#x27;) &#123;</span><br><span class=\"line\">                 sh &quot;&quot;&quot;</span><br><span class=\"line\">                         cd $&#123;currentProjectName&#125;</span><br><span class=\"line\">                         $&#123;scannerHome&#125;/bin/sonar-scanner</span><br><span class=\"line\">                 &quot;&quot;&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   stage(&#x27;编译，安装公共子工程&#x27;) &#123;</span><br><span class=\"line\">      sh &quot;mvn -f tensquare_common clean install&quot;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   stage(&#x27;编译，打包微服务工程，上传镜像&#x27;) &#123;</span><br><span class=\"line\">       for(int i=0;i&lt;selectedProjectNames.length;i++)&#123;</span><br><span class=\"line\">                 //tensquare_eureka_server@10086</span><br><span class=\"line\">                 def projectInfo = selectedProjectNames[i];</span><br><span class=\"line\">                 //当前遍历的项目名称</span><br><span class=\"line\">                 def currentProjectName = &quot;$&#123;projectInfo&#125;&quot;.split(&quot;@&quot;)[0]</span><br><span class=\"line\">                 //当前遍历的项目端口</span><br><span class=\"line\">                 def currentProjectPort = &quot;$&#123;projectInfo&#125;&quot;.split(&quot;@&quot;)[1]</span><br><span class=\"line\"></span><br><span class=\"line\">                 sh &quot;mvn -f $&#123;currentProjectName&#125; clean package dockerfile:build&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                 //定义镜像名称</span><br><span class=\"line\">                 def imageName = &quot;$&#123;currentProjectName&#125;:$&#123;tag&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                 //对镜像打上标签</span><br><span class=\"line\">                 sh &quot;docker tag $&#123;imageName&#125; $&#123;harbor_url&#125;/$&#123;harbor_project&#125;/$&#123;imageName&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                //把镜像推送到Harbor</span><br><span class=\"line\">                withCredentials([usernamePassword(credentialsId: &quot;$&#123;harbor_auth&#125;&quot;, passwordVariable: &#x27;password&#x27;, usernameVariable: &#x27;username&#x27;)]) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">                    //登录到Harbor</span><br><span class=\"line\">                    sh &quot;docker login -u $&#123;username&#125; -p $&#123;password&#125; $&#123;harbor_url&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                    //镜像上传</span><br><span class=\"line\">                    sh &quot;docker push $&#123;harbor_url&#125;/$&#123;harbor_project&#125;/$&#123;imageName&#125;&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                    sh &quot;echo 镜像上传成功&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                //遍历所有服务器，分别部署</span><br><span class=\"line\">                for(int j=0;j&lt;selectedServers.length;j++)&#123;</span><br><span class=\"line\">                       //获取当前遍历的服务器名称</span><br><span class=\"line\">                       def currentServerName = selectedServers[j]</span><br><span class=\"line\"></span><br><span class=\"line\">                       //加上的参数格式：--spring.profiles.active=eureka-server1/eureka-server2</span><br><span class=\"line\">                       def activeProfile = &quot;--spring.profiles.active=&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">                       //根据不同的服务名称来读取不同的Eureka配置信息</span><br><span class=\"line\">                       if(currentServerName==&quot;master_server&quot;)&#123;</span><br><span class=\"line\">                          activeProfile = activeProfile+&quot;eureka-server1&quot;</span><br><span class=\"line\">                       &#125;else if(currentServerName==&quot;slave_server&quot;)&#123;</span><br><span class=\"line\">                          activeProfile = activeProfile+&quot;eureka-server2&quot;</span><br><span class=\"line\">                       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">                       //部署应用</span><br><span class=\"line\">                       sshPublisher(publishers: [sshPublisherDesc(configName: &quot;$&#123;currentServerName&#125;&quot;, transfers: [sshTransfer(cleanRemote: false, excludes: &#x27;&#x27;, execCommand: &quot;/opt/jenkins_shell/deployCluster.sh $harbor_url $harbor_project $currentProjectName $tag $currentProjectPort $activeProfile&quot;, execTimeout: 120000, flatten: false, makeEmptyDirs: false, noDefaultExcludes: false, patternSeparator: &#x27;[, ]+&#x27;, remoteDirectory: &#x27;&#x27;, remoteDirectorySDF: false, removePrefix: &#x27;&#x27;, sourceFiles: &#x27;&#x27;)], usePromotionTimestamp: false, useWorkspaceInPromotion: false, verbose: false)])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vSmFja3BvdEhhbi9wLzEwNzc0MTkxLmh0bWw=\">Spring Cloud 项目 MVN 编译 – Non-resolvable import POM - JackpotHan - 博客园 (cnblogs.com)</span></p>\n<p>[(74 条消息) Non-resolvable import POM: Failure to find org.springframework.cloud:spring-cloud-dependencies_Code 神之手的博客 - CSDN 博客](<span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L1NldmVuNzExMTEvYXJ0aWNsZS9kZXRhaWxzLzEwMzAwMDE1MSM6fjp0ZXh0PQ==\">https://blog.csdn.net/Seven71111/article/details/103000151#:~:text=</span>[ ERROR] Non-resolvable import POM%3A Failure to find,of alimaven has elapsed or updates are forced)</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzMjIwOTQ5L2FydGljbGUvZGV0YWlscy8xMTI3MTc0ODc=\">(74 条消息) 不能解决 org.springframework.cloud:spring-cloud-starter-netflix-turbine:unknown 不能解决 org.springframework._或许没看到的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaHVqaW56aG9uZy9wLzE0NTcxMDQxLmh0bWw=\">Jenkins+Docker+SpringCloud 微服务持续集成 (单机版) - 运维人在路上 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vdGlhbmNpeGlvbmcvdGVuc3F1YXJl\">tensquare: 黑马十次方微服务项目 (gitee.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90d2l0dGVyLmNvbS9Bc3Rvbk1hcnRpbkYxL3N0YXR1cy8xNjUzMDI5MDAxNDYyNTM0MTQ1P3Q9Q0ZwNVBlWF91WVlSdlV0a0lYejlhQSZhbXA7cz0wNQ==\">https://twitter.com/AstonMartinF1/status/1653029001462534145?t=CFp5PeX_uYYRvUtkIXz9aA&amp;s=05</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"># 单机版</span><br><span class=\"line\">#server:</span><br><span class=\"line\">#  port: 10086</span><br><span class=\"line\">#spring:</span><br><span class=\"line\">#  application:</span><br><span class=\"line\">#    admin:</span><br><span class=\"line\">#      jmx-name: eureka-server</span><br><span class=\"line\">#eureka:</span><br><span class=\"line\">#  client:</span><br><span class=\"line\">#    fetch-registry: false</span><br><span class=\"line\">#    register-with-eureka: false</span><br><span class=\"line\">#    service-url:</span><br><span class=\"line\">#      defaultZone: http://192.168.13.13:$&#123;server.port&#125;/eureka</span><br><span class=\"line\">#  server:</span><br><span class=\"line\">#    enable-self-preservation: false</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">spring:</span><br><span class=\"line\">  application:</span><br><span class=\"line\">    name: EUREKA-HA</span><br><span class=\"line\">---</span><br><span class=\"line\">server:</span><br><span class=\"line\">  port: 10086</span><br><span class=\"line\">spring:</span><br><span class=\"line\">  profiles: eureka-server1</span><br><span class=\"line\">eureka:</span><br><span class=\"line\">  instance:</span><br><span class=\"line\">    hostname: 192.168.13.13</span><br><span class=\"line\">  client:</span><br><span class=\"line\">    service-url:</span><br><span class=\"line\">      defaultZone: http://192.168.13.13:10086/eureka/,http://192.168.13.15:10086/eureka/</span><br><span class=\"line\">    register-with-eureka: false</span><br><span class=\"line\">    fetch-registry: false</span><br><span class=\"line\">---</span><br><span class=\"line\">server:</span><br><span class=\"line\">  port: 10086</span><br><span class=\"line\">spring:</span><br><span class=\"line\">  profiles: eureka-server2</span><br><span class=\"line\">eureka:</span><br><span class=\"line\">  instance:</span><br><span class=\"line\">    hostname: 192.168.13.15</span><br><span class=\"line\">  client:</span><br><span class=\"line\">    service-url:</span><br><span class=\"line\">      defaultZone: http://192.168.13.13:10086/eureka/,http://192.168.13.15:10086/eureka/</span><br><span class=\"line\">    register-with-eureka: false</span><br><span class=\"line\">    fetch-registry: false</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">server:</span><br><span class=\"line\">  port: 10086</span><br><span class=\"line\">spring:</span><br><span class=\"line\">  application:</span><br><span class=\"line\">    admin:</span><br><span class=\"line\">      jmx-name: eureka-server</span><br><span class=\"line\">eureka:</span><br><span class=\"line\">  client:</span><br><span class=\"line\">    fetch-registry: false</span><br><span class=\"line\">    register-with-eureka: false</span><br><span class=\"line\">    service-url:</span><br><span class=\"line\">      defaultZone: http://192.168.13.13:$&#123;server.port&#125;/eureka</span><br><span class=\"line\">  server:</span><br><span class=\"line\">    enable-self-preservation: false</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230502212659240.png\" alt=\"image-20230502212659240\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat &gt;&gt;/etc/hosts&lt;&lt;EOF </span><br><span class=\"line\">192.168.13.12 k8s-master </span><br><span class=\"line\">192.168.13.13 k8s-node1</span><br><span class=\"line\">192.168.13.15 k8s-node2 </span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</span><br><span class=\"line\">[kubernetes]</span><br><span class=\"line\">name=Kubernetes</span><br><span class=\"line\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span><br><span class=\"line\">enabled=1</span><br><span class=\"line\">gpgcheck=0</span><br><span class=\"line\">repo_gpgcheck=0</span><br><span class=\"line\">gpgkey=https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span><br><span class=\"line\">https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm init --kubernetes-version=1.21.2 \\</span><br><span class=\"line\">--apiserver-advertise-address=192.168.13.12  \\</span><br><span class=\"line\">--image-repository registry.aliyuncs.com/google_containers \\</span><br><span class=\"line\">--service-cidr=10.1.0.0/16 \\</span><br><span class=\"line\">--pod-network-cidr=10.244.0.0/16</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm join 192.168.13.12:6443 --token l1x1ji.yonc002xc0vhf9vv \\</span><br><span class=\"line\">\t--discovery-token-ca-cert-hash sha256:75a8c65d8521a2f275fae4e4c6ff40fbe2c518d54ed6348a408d20b8443d0eb2 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def git_address = &quot;http://192.168.13.11/root/tensquare_back.git&quot;</span><br><span class=\"line\">def git_auth = &quot;322ed148-5eda-40c0-9c47-eb89edf08c69&quot;</span><br><span class=\"line\">//创建一个Pod的模板，label为jenkins-slave</span><br><span class=\"line\">podTemplate(label: &#x27;jenkins-slave&#x27;, cloud: &#x27;kubernetes&#x27;, containers: [</span><br><span class=\"line\">    containerTemplate(</span><br><span class=\"line\">        name: &#x27;jnlp&#x27;,</span><br><span class=\"line\">        image: &quot;192.168.13.14:85/library/jenkins-slave-maven:latest&quot;</span><br><span class=\"line\">    )</span><br><span class=\"line\">]</span><br><span class=\"line\">)</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">//引用jenkins-slave的pod模块来构建Jenkins-Slave的pod</span><br><span class=\"line\">    node(&quot;jenkins-slave&quot;)&#123;</span><br><span class=\"line\">    // 第一步</span><br><span class=\"line\">        stage(&#x27;拉取代码&#x27;)&#123;</span><br><span class=\"line\">            checkout([$class: &#x27;GitSCM&#x27;, branches: [[name: &#x27;*/master&#x27;]], extensions: [], userRemoteConfigs: [[credentialsId: &quot;$&#123;git_auth&#125;&quot;, url: &quot;$&#123;git_address&#125;&quot;]]])</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vemhpaml5aXl1L3AvMTU5OTQ0NDQuaHRtbA==\">基于 Kubernetes 平台微服务的部署 - 知己一语 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIuYWxpeXVuLmNvbS9hcnRpY2xlLzkwMDQwNA==\">基于 kubernetes 平台微服务的部署 - 阿里云开发者社区 (aliyun.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzMzI5NzUvYXJ0aWNsZS9kZXRhaWxzLzEyMDU0MjEzMA==\">(82 条消息) 基于 k8s 平台 jenkins 部署及动态 slave 节点制作和配置_jenkins 部署动态 salve 安装 nerdctl_— 逆渡默行 — 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3Byb2dyYW1lcl9iZWkvYXJ0aWNsZS9kZXRhaWxzLzEwMTI4OTgzNQ==\">(82 条消息) Jenkins 集成 k8s 运行 Jenkins slave（Jenkins 弹性 slave）_jenkins podretention_programer_bei 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGlnYW5nMDM1Ny9wLzEzNzI1ODYyLmh0bWw=\">k8s 集群中部署 jenkins master slave - 李刚 - 天道酬勤 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wbHVnaW5zLmplbmtpbnMuaW8va3ViZXJuZXRlcy8=\">Kubernetes | Jenkins plugin</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vc2NhankvcC8xNjI5MjE4MC5odG1s\">k8s-jenkins 在 kubernetes 中持续部署 - 七月流星雨 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/05/20/Kubernetes/",
            "url": "http://example.com/2023/05/20/Kubernetes/",
            "title": "Kubernetes",
            "date_published": "2023-05-20T05:38:45.000Z",
            "content_html": "<h1 id=\"kubernetes\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes\">#</a> Kubernetes</h1>\n<p>[TOC]</p>\n<p>VPC 私有网络，不同 VPC 之间相互隔离</p>\n<p>k8s 大规模容器编排系统</p>\n<p>master/node 模式</p>\n<h2 id=\"k8s特性\"><a class=\"markdownIt-Anchor\" href=\"#k8s特性\">#</a> k8s 特性</h2>\n<blockquote>\n<ul>\n<li><strong>服务发现和负载均衡</strong><br>\n Kubernetes 可以使用 DNS 名称或自己的 IP 地址公开容器，如果进入容器的流量很大， Kubernetes 可以负载均衡并分配网络流量，从而使部署稳定。</li>\n<li><strong>存储编排</strong><br>\n Kubernetes 允许你自动挂载你选择的存储系统，例如本地存储、公共云提供商等。</li>\n<li><strong>自动部署和回滚</strong><br>\n你可以使用 Kubernetes 描述已部署容器的所需状态，它可以以受控的速率将实际状态 更改为期望状态。例如，你可以自动化 Kubernetes 来为你的部署创建新容器， 删除现有容器并将它们的所有资源用于新容器。</li>\n<li><strong>自动完成装箱计算</strong><br>\n Kubernetes 允许你指定每个容器所需 CPU 和内存（RAM）。 当容器指定了资源请求时，Kubernetes 可以做出更好的决策来管理容器的资源。</li>\n<li><strong>自我修复</strong><br>\n Kubernetes 重新启动失败的容器、替换容器、杀死不响应用户定义的 运行状况检查的容器，并且在准备好服务之前不将其通告给客户端。</li>\n<li><strong>密钥与配置管理</strong><br>\n Kubernetes 允许你存储和管理敏感信息，例如密码、OAuth 令牌和 ssh 密钥。 你可以在不重建容器镜像的情况下部署和更新密钥和应用程序配置，也无需在堆栈配置中暴露密钥。</li>\n</ul>\n</blockquote>\n<h2 id=\"架构\"><a class=\"markdownIt-Anchor\" href=\"#架构\">#</a> 架构</h2>\n<p>主节点 (master) + 工作节点 (worker)</p>\n<p>K8s 集群至少需要一个主节点 (Master) 和多个工作节点 (Worker)，Master 节点是集群的控制节点，负责整个集群的管理和控制，主节点主要用于暴露 API，调度部署和节点的管理。工作节点主要是运行容器的。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/components-of-kubernetes.svg\" alt=\"Kubernetes 组件\"></p>\n<p>多 master 节点高可用架构</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423162509705.png\" alt=\"image-20230423162509705\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl：管理K8s的命令行工具，可以操作K8s中的资源对象。</span><br><span class=\"line\"></span><br><span class=\"line\">etcd： 是一个高可用的键值数据库，存储K8s的资源状态信息和网络信息的，etcd中的数据变更是通过api server进行的。</span><br><span class=\"line\"></span><br><span class=\"line\">apiserver:  提供K8s api，是整个系统的对外接口，提供资源操作的唯一入口，供客户端和其它组件调用，提供了K8s各类资源对象（pod,deployment,Service等）的增删改查，是整个系统的数据总线和数据中心，并提供认证、授权、访问控制、API注册和发现等机制，并将操作对象持久化到etcd中。相当于“营业厅”。</span><br><span class=\"line\"></span><br><span class=\"line\">scheduler：负责K8s集群中pod的调度的 ， scheduler通过与apiserver交互监听到创建Pod副本的信息后，它会检索所有符合该Pod要求的工作节点列表，开始执行Pod调度逻辑。调度成功后将Pod绑定到目标节点上，相当于“调度室”。</span><br><span class=\"line\"></span><br><span class=\"line\">controller-manager：与apiserver交互，实时监控和维护K8s集群的控制器的健康情况，对有故障的进行处理和恢复，相当于“大总管”。</span><br><span class=\"line\"></span><br><span class=\"line\">kubelet： 每个Node节点上的kubelet定期就会调用API Server的REST接口报告自身状态，API Server接收这些信息后，将节点状态信息更新到etcd中。kubelet也通过API Server监听Pod信息，从而对Node机器上的POD进行管理，如创建、删除、更新Pod</span><br><span class=\"line\"></span><br><span class=\"line\">kube-proxy：提供网络代理和负载均衡，是实现service的通信与负载均衡机制的重要组件，kube-proxy负责为Pod创建代理服务，从apiserver获取所有service信息，并根据service信息创建代理服务，实现service到Pod的请求路由和转发，从而实现K8s层级的虚拟转发网络，将到service的请求转发到后端的pod上。 </span><br><span class=\"line\"></span><br><span class=\"line\">calico:网络插件，提供IP，策略隔离</span><br><span class=\"line\"></span><br><span class=\"line\">coredns:域名解析</span><br></pre></td></tr></table></figure>\n<h3 id=\"资源对象\"><a class=\"markdownIt-Anchor\" href=\"#资源对象\">#</a> 资源对象</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Pod是Kubernetes中的最小调度单元，当指派容器时，容器实际上并不会指派到物理硬件上，容器会被分配到一个Pod里。Pod代表集群上正在运行的一个进程，一个Pod封装一个容器（也可以封装多个容器），Pod里的容器共享存储、网络等。也就是说，应该把整个pod看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</span><br><span class=\"line\"></span><br><span class=\"line\">Replicaset</span><br><span class=\"line\">Kubernetes中的副本控制器，管理Pod，使pod副本的数量始终维持在预设的个数。</span><br><span class=\"line\"></span><br><span class=\"line\">Deployment管理Replicaset和Pod的副本控制器，Deployment可以管理多个Replicaset，是比Replicaset更高级的控制器，也即是说在创建Deployment的时候，会自动创建Replicaset，由Replicaset再创建Pod，Deployment能对Pod扩容、缩容、滚动更新和回滚、维持Pod数量。</span><br><span class=\"line\"></span><br><span class=\"line\">Service</span><br><span class=\"line\">在kubernetes中，Pod是有生命周期的，如果Pod重启IP很有可能会发生变化。如果我们的服务都是将Pod的IP地址写死，Pod的挂掉或者重启，和刚才重启的pod相关联的其他服务将会找不到它所关联的Pod，为了解决这个问题，在kubernetes中定义了service资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service是一组Pod的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector实现的。</span><br><span class=\"line\"></span><br><span class=\"line\">Statefulset</span><br><span class=\"line\"></span><br><span class=\"line\">Job &amp; CronJob</span><br><span class=\"line\"></span><br><span class=\"line\">Ingress </span><br><span class=\"line\"></span><br><span class=\"line\">Configmap和Secret</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>开发代码 -&gt; 提交代码到代码仓库 -&gt;Jenkins 调 K8s API-&gt; 动态生成 Jenkins Slave Pod-&gt;Slave Pod 拉取 git 上的代码 -&gt; 编译代码 -&gt; 打包镜像 -&gt; 推送镜像到镜像仓库 harbor 或者 docker hub-&gt; 通过 K8s 编排服务发布到测试、生产平台 -&gt; Slave Pod 工作完成之后自动删除 &gt; 通过 Ingress 发布服务。</p>\n<h3 id=\"kubeadm安装k8s多master高可用集群\"><a class=\"markdownIt-Anchor\" href=\"#kubeadm安装k8s多master高可用集群\">#</a> kubeadm 安装 k8s 多 master 高可用集群</h3>\n<blockquote>\n<p>kubeadm 是官方提供的开源工具，是一个开源项目，用于快速搭建 kubernetes 集群，目前是比较方便和推荐使用的。kubeadm init 以及 kubeadm join 这两个命令可以快速创建 kubernetes 集群。Kubeadm 初始化 k8s，所有的组件都是以 pod 形式运行的，具备故障自恢复能力。</p>\n<p>kubeadm 是工具，可以快速搭建集群，也就是相当于用程序脚本帮我们装好了集群，属于自动部署，简化部署操作，自动部署屏蔽了很多细节，使得对各个模块感知很少，如果对 k8s 架构组件理解不深的话，遇到问题比较难排查。</p>\n<p>kubeadm 适合需要经常部署 k8s，或者对自动化要求比较高的场景下使用。</p>\n<p>二进制：在官网下载相关组件的二进制包，如果手动安装，对 kubernetes 理解也会更全面。</p>\n<p>Kubeadm 和二进制都适合生产环境，在生产环境运行都很稳定，具体如何选择，可以根据实际项目进行评估。</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/share/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib64/nginx/modules --conf-path=/etc/nginx/nginx.conf --error-log-path=/var/log/nginx/error.log --http-log-path=/var/log/nginx/access.log --http-client-body-temp-path=/var/lib/nginx/tmp/client_body --http-proxy-temp-path=/var/lib/nginx/tmp/proxy --http-fastcgi-temp-path=/var/lib/nginx/tmp/fastcgi --http-uwsgi-temp-path=/var/lib/nginx/tmp/uwsgi --http-scgi-temp-path=/var/lib/nginx/tmp/scgi --pid-path=/run/nginx.pid --lock-path=/run/lock/subsys/nginx --user=nginx --group=nginx --with-compat --with-debug --with-file-aio --with-google_perftools_module --prefix= --with-http_addition_module --with-http_auth_request_module --with-http_dav_module --with-http_degradation_module --with-http_flv_module --with-http_gunzip_module --with-http_gzip_static_module --with-http_image_filter_module=dynamic --with-http_mp4_module --with-http_perl_module=dynamic --with-http_random_index_module --with-http_realip_module --with-http_secure_link_module --with-http_slice_module --with-http_ssl_module --with-http_stub_status_module --with-http_sub_module --with-http_v2_module --with-http_xslt_module=dynamic --with-mail=dynamic --with-mail_ssl_module --with-pcre --with-pcre-jit --with-stream=dynamic --with-stream_ssl_module --with-stream_ssl_preread_module --with-threads --with-cc-opt=<span class=\"string\">&#x27;-O2 -g -pipe -Wall -Wp,-D_FORTIFY_SOURCE=2 -fexceptions -fstack-protector-strong --param=ssp-buffer-size=4 -grecord-gcc-switches -specs=/usr/lib/rpm/redhat/redhat-hardened-cc1 -m64 -mtune=generic&#x27;</span> --with-ld-opt=<span class=\"string\">&#x27;-Wl,-z,relro -specs=/usr/lib/rpm/redhat/redhat-hardened-ld -Wl,-E&#x27;</span> --with-stream </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auto eth0</span><br><span class=\"line\">iface eth0 inet static</span><br><span class=\"line\">address 192.168.13.198</span><br><span class=\"line\">gateway 192.168.13.2</span><br><span class=\"line\">netmask 255.255.255.0</span><br></pre></td></tr></table></figure>\n<h2 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h2>\n<p>1. 安装 docker</p>\n<p>2. 安装 kubelet</p>\n<p>3. 安装 kubectl</p>\n<p>4. 安装 kubeadm</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">预配环境：</span><br><span class=\"line\">#各个机器设置自己的域名</span><br><span class=\"line\">hostnamectl set-hostname xxxx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"># 将 SELinux 设置为 permissive 模式（相当于将其禁用）</span><br><span class=\"line\">sudo setenforce 0</span><br><span class=\"line\">sudo sed -i &#x27;s/^SELINUX=enforcing$/SELINUX=permissive/&#x27; /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\">#关闭swap</span><br><span class=\"line\">swapoff -a  </span><br><span class=\"line\">sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\">#允许 iptables 检查桥接流量</span><br><span class=\"line\">cat &lt;&lt;EOF | sudo tee /etc/modules-load.d/k8s.conf</span><br><span class=\"line\">br_netfilter</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">cat &lt;&lt;EOF | sudo tee /etc/sysctl.d/k8s.conf</span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo sysctl --system</span><br></pre></td></tr></table></figure>\n<p>安装 kubelet、kubeadm、kubectl</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF | sudo tee /etc/yum.repos.d/kubernetes.repo</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=http://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">repo_gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">gpgkey=http://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">   http://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg</span></span><br><span class=\"line\"><span class=\"string\">exclude=kubelet kubeadm kubectl</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">sudo yum install -y kubelet-1.20.9 kubeadm-1.20.9 kubectl-1.20.9 --disableexcludes=kubernetes</span><br><span class=\"line\"></span><br><span class=\"line\">sudo systemctl <span class=\"built_in\">enable</span> --now kubelet</span><br></pre></td></tr></table></figure>\n<p>安装 kubelet、kubeadm、kubectl</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo <span class=\"built_in\">tee</span> ./images.sh &lt;&lt;-<span class=\"string\">&#x27;EOF&#x27;</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">images=(</span><br><span class=\"line\">kube-apiserver:v1.20.9</span><br><span class=\"line\">kube-proxy:v1.20.9</span><br><span class=\"line\">kube-controller-manager:v1.20.9</span><br><span class=\"line\">kube-scheduler:v1.20.9</span><br><span class=\"line\">coredns:1.7.0</span><br><span class=\"line\">etcd:3.4.13-0</span><br><span class=\"line\">pause:3.2</span><br><span class=\"line\">)</span><br><span class=\"line\"><span class=\"keyword\">for</span> imageName <span class=\"keyword\">in</span> <span class=\"variable\">$&#123;images[@]&#125;</span> ; <span class=\"keyword\">do</span></span><br><span class=\"line\">docker pull registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/<span class=\"variable\">$imageName</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x ./images.sh &amp;&amp; ./images.sh</span><br></pre></td></tr></table></figure>\n<p>初始化主节点</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#所有机器添加master域名映射，以下需要修改为自己的</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;172.23.142.216  k8s-master&quot;</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#主节点初始化</span></span><br><span class=\"line\">kubeadm init \\</span><br><span class=\"line\">--apiserver-advertise-address=172.23.142.216 \\</span><br><span class=\"line\">--control-plane-endpoint=k8s-master \\</span><br><span class=\"line\">--image-repository registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images \\</span><br><span class=\"line\">--kubernetes-version v1.20.9 \\</span><br><span class=\"line\">--service-cidr=10.96.0.0/16 \\</span><br><span class=\"line\">--pod-network-cidr=192.168.0.0/16</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#所有网络范围不重叠</span></span><br><span class=\"line\"></span><br><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  sudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  sudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 \\</span><br><span class=\"line\">    --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">主节点</span><br><span class=\"line\"> <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\"> sudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"> sudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  </span><br><span class=\"line\"> 主节点</span><br><span class=\"line\"> 下载calico</span><br><span class=\"line\">https://docs.tigera.io/archive/v3.22/getting-started/kubernetes/self-managed-onprem/onpremises</span><br><span class=\"line\">curl https://projectcalico.docs.tigera.io/archive/v3.22/manifests/calico.yaml -O</span><br><span class=\"line\"></span><br><span class=\"line\"> kubectl apply -f calico.yaml</span><br><span class=\"line\"> </span><br><span class=\"line\"> [root@i-taf5qf6u ~]<span class=\"comment\"># kubectl get pod -A</span></span><br><span class=\"line\">NAMESPACE         NAME                                       READY   STATUS              RESTARTS   AGE</span><br><span class=\"line\">kube-system       calico-kube-controllers-57c7b58f66-jq7lm   0/1     ContainerCreating   0          22m</span><br><span class=\"line\">kube-system       calico-node-4bttn                          1/1     Running             0          22m</span><br><span class=\"line\">kube-system       coredns-5897cd56c4-2fhkm                   1/1     Running             0          55m</span><br><span class=\"line\">kube-system       coredns-5897cd56c4-2l59f                   1/1     Running             0          55m</span><br><span class=\"line\">kube-system       etcd-master                                1/1     Running             0          55m</span><br><span class=\"line\">kube-system       kube-apiserver-master                      1/1     Running             0          55m</span><br><span class=\"line\">kube-system       kube-controller-manager-master             1/1     Running             0          55m</span><br><span class=\"line\">kube-system       kube-proxy-d4sgz                           1/1     Running             0          55m</span><br><span class=\"line\">kube-system       kube-scheduler-master                      1/1     Running             0          55m</span><br><span class=\"line\">tigera-operator   tigera-operator-57cb64cf85-kqsvh           1/1     Running             0          37m</span><br><span class=\"line\">[root@i-taf5qf6u ~]<span class=\"comment\"># kubectl get node</span></span><br><span class=\"line\">NAME     STATUS   ROLES                  AGE   VERSION</span><br><span class=\"line\">master   Ready    control-plane,master   56m   v1.20.9</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看集群所有节点</span></span><br><span class=\"line\">kubectl get nodes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 很久配置文件，给集群创建资源</span></span><br><span class=\"line\">kubectl appy -f xxx.yml</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看集群部署了那些命令</span></span><br><span class=\"line\">kubectl get pods -A</span><br><span class=\"line\"><span class=\"comment\"># 类似于docker ps -a</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># worker 加入master</span></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> cluster-endpoint:6443 --token 902kx7.ic9ncjvtuksmf2rw \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:753403dbd24f4cef391a276ad67e8c9c8d91cec64467998426e3021123381b36 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 重新创建新的令牌</span></span><br><span class=\"line\">kubeadm token create --print-join-command</span><br></pre></td></tr></table></figure>\n<p>==== new =====</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 重置kubeadm</span></span><br><span class=\"line\">kubeadm reset</span><br><span class=\"line\"><span class=\"comment\"># 相当于卸载k8s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 根据机器上安装了哪些组件区分</span></span><br><span class=\"line\"><span class=\"comment\"># master</span></span><br><span class=\"line\">apiserver controller-manager scheduler etcd kube-proxy  docker calico</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># node </span></span><br><span class=\"line\">coredns</span><br><span class=\"line\">calico</span><br><span class=\"line\">kubelet</span><br><span class=\"line\">kube-proxy</span><br><span class=\"line\">docker</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">Swap是交换分区，如果机器内存不够，会使用swap分区，但是swap分区的性能较低，k8s设计的时候为了能提升性能，默认是不允许使用交换分区的。Kubeadm初始化的时候会检测swap是否关闭，如果没关闭，那就初始化失败。如果不想要关闭交换分区，安装k8s的时候可以指定--ignore-preflight-errors=Swap来解决。</span><br><span class=\"line\">free -m</span><br><span class=\"line\"></span><br><span class=\"line\">1.24之后使用contained </span><br><span class=\"line\"></span><br><span class=\"line\">Kubeadm:  kubeadm是一个工具，用来初始化k8s集群的</span><br><span class=\"line\">kubelet:   安装在集群所有节点上，用于启动Pod的</span><br><span class=\"line\">kubectl:   通过kubectl可以部署和管理应用，查看各种资源，创建、删除和更新各种组件</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl config view </span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">clusters:</span><br><span class=\"line\">- cluster:</span><br><span class=\"line\">    certificate-authority-data: DATA+OMITTED</span><br><span class=\"line\">    server: https://192.168.13.249:16443</span><br><span class=\"line\">  name: kubernetes</span><br><span class=\"line\">contexts:</span><br><span class=\"line\">- context:</span><br><span class=\"line\">    cluster: kubernetes</span><br><span class=\"line\">    user: kubernetes-admin</span><br><span class=\"line\">  name: kubernetes-admin@kubernetes</span><br><span class=\"line\">current-context: kubernetes-admin@kubernetes</span><br><span class=\"line\">kind: Config</span><br><span class=\"line\">preferences: &#123;&#125;</span><br><span class=\"line\"><span class=\"built_in\">users</span>:</span><br><span class=\"line\">- name: kubernetes-admin</span><br><span class=\"line\">  user:</span><br><span class=\"line\">    client-certificate-data: REDACTED</span><br><span class=\"line\">    client-key-data: REDACTED</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 想在其他机器上执行kubevtl需要有/root/.kube/config </span></span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm 在执行安装之前进行了相当细致的环境检测</span><br><span class=\"line\"></span><br><span class=\"line\">   1) 检查执行 init 命令的用户是否为 root，如果不是 root，直接快速失败（fail fast）；</span><br><span class=\"line\">   2) 检查待安装的 k8s 版本是否被当前版本的 kubeadm 支持（kubeadm 版本 &gt;= 待安装 k8s 版本）；</span><br><span class=\"line\">   3) 检查防火墙，如果防火墙未关闭，提示开放端口 10250；</span><br><span class=\"line\">   4) 检查端口是否已被占用，6443（或你指定的监听端口）、10257、10259；</span><br><span class=\"line\">   5) 检查文件是否已经存在，/etc/kubernetes/manifests/*.yaml；</span><br><span class=\"line\">   6) 检查是否存在代理，连接本机网络、服务网络、Pod网络，都会检查，目前不允许代理；</span><br><span class=\"line\">   7) 检查容器运行时，使用 CRI 还是 Docker，如果是 Docker，进一步检查 Docker 服务是否已启动，是否设置了开机自启动；</span><br><span class=\"line\">   8) 对于 Linux 系统，会额外检查以下内容：</span><br><span class=\"line\">       8.1) 检查以下命令是否存在：crictl、ip、iptables、mount、nsenter、ebtables、ethtool、socat、tc、<span class=\"built_in\">touch</span>；</span><br><span class=\"line\">       8.2) 检查 /proc/sys/net/bridge/bridge-nf-call-iptables、/proc/sys/net/ipv4/ip-forward 内容是否为 1；</span><br><span class=\"line\">       8.3) 检查 swap 是否是关闭状态；</span><br><span class=\"line\">    9) 检查内核是否被支持，Docker 版本及后端存储 GraphDriver 是否被支持；</span><br><span class=\"line\">         对于 Linux 系统，还需检查 OS 版本和 cgroup 支持程度（支持哪些资源的隔离）；</span><br><span class=\"line\">    10) 检查主机名访问可达性；</span><br><span class=\"line\">    11) 检查 kubelet 版本，要高于 kubeadm 需要的最低版本，同时不高于待安装的 k8s 版本；</span><br><span class=\"line\">    12) 检查 kubelet 服务是否开机自启动；</span><br><span class=\"line\">    13) 检查 10250 端口是否被占用；</span><br><span class=\"line\">    14) 如果开启 IPVS 功能，检查系统内核是否加载了 ipvs 模块；</span><br><span class=\"line\">    15) 对于 etcd，如果使用 Local etcd，则检查 2379 端口是否被占用， /var/lib/etcd/ 是否为空目录；</span><br><span class=\"line\">          如果使用 External etcd，则检查证书文件是否存在（CA、key、cert），验证 etcd 服务版本是否符合要求；</span><br><span class=\"line\">    16) 如果使用 IPv6，</span><br><span class=\"line\">           检查 /proc/sys/net/bridge/bridge-nf-call-iptables、/proc/sys/net/ipv6/conf/default/forwarding 内容是否为 1；</span><br><span class=\"line\"></span><br><span class=\"line\">完成安装前的配置</span><br><span class=\"line\">       1) 在 kube-system 命名空间创建 ConfigMap kubeadm-config，同时对其配置 RBAC 权限；</span><br><span class=\"line\">       2) 在 kube-system 命名空间创建 ConfigMap kubelet-config-&lt;version&gt;，同时对其配置 RBAC 权限；</span><br><span class=\"line\">       3) 为当前节点（Master）打标记：node-role.kubernetes.io/master=；</span><br><span class=\"line\">       4) 为当前节点（Master）补充 Annotation；</span><br><span class=\"line\">       5) 如果启用了 DynamicKubeletConfig 特性，设置本节点 kubelet 的配置数据源为 ConfigMap 形式；</span><br><span class=\"line\">       6) 创建 BootStrap token Secret，并对其配置 RBAC 权限；</span><br><span class=\"line\">       7) 在 kube-public 命名空间创建 ConfigMap cluster-info，同时对其配置 RBAC 权限；</span><br><span class=\"line\">       8) 与 apiserver 通信，部署 DNS 服务；</span><br><span class=\"line\">       9) 与 apiserver 通信，部署 kube-proxy 服务；</span><br><span class=\"line\">       10) 如果启用了 self-hosted 特性，将 Control Plane 转为 DaemonSet 形式运行；</span><br><span class=\"line\">       11) 打印 <span class=\"built_in\">join</span> 语句；</span><br><span class=\"line\">       </span><br><span class=\"line\">Kubeadm生成的k8s证书内容说明：</span><br><span class=\"line\">一、证书分组</span><br><span class=\"line\">Kubernetes把证书放在了两个文件夹中</span><br><span class=\"line\">/etc/kubernetes/pki</span><br><span class=\"line\">/etc/kubernetes/pki/etcd</span><br><span class=\"line\"></span><br><span class=\"line\">二、Kubernetes 集群根证书</span><br><span class=\"line\">Kubernetes 集群根证书CA(Kubernetes集群组件的证书签发机构)</span><br><span class=\"line\">/etc/kubernetes/pki/ca.crt</span><br><span class=\"line\">/etc/kubernetes/pki/ca.key</span><br><span class=\"line\"></span><br><span class=\"line\">以上这组证书为签发其他Kubernetes组件证书使用的根证书, 可以认为是Kubernetes集群中证书签发机构之一</span><br><span class=\"line\"></span><br><span class=\"line\">由此根证书签发的证书有:</span><br><span class=\"line\">1、kube-apiserver apiserver证书</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver.crt</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver.key</span><br><span class=\"line\">2、kubelet客户端证书, 用作 kube-apiserver 主动向 kubelet 发起请求时的客户端认证</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver-kubelet-client.crt</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver-kubelet-client.key</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">三、kube-apiserver 代理根证书(客户端证书)</span><br><span class=\"line\">用在requestheader-client-ca-file配置选项中, kube-apiserver 使用该证书来验证客户端证书是否为自己所签发</span><br><span class=\"line\">/etc/kubernetes/pki/front-proxy-ca.crt</span><br><span class=\"line\">/etc/kubernetes/pki/front-proxy-ca.key</span><br><span class=\"line\"></span><br><span class=\"line\">由此根证书签发的证书只有一组:</span><br><span class=\"line\">代理层(如汇聚层aggregator)使用此套代理证书来向 kube-apiserver 请求认证</span><br><span class=\"line\">代理端使用的客户端证书, 用作代用户与 kube-apiserver 认证</span><br><span class=\"line\">/etc/kubernetes/pki/front-proxy-client.crt</span><br><span class=\"line\">/etc/kubernetes/pki/front-proxy-client.key</span><br><span class=\"line\"></span><br><span class=\"line\">三、etcd 集群根证书</span><br><span class=\"line\">etcd集群所用到的证书都保存在/etc/kubernetes/pki/etcd这路径下, 很明显, 这一套证书是用来专门给etcd集群服务使用的, 设计以下证书文件</span><br><span class=\"line\">etcd 集群根证书CA(etcd 所用到的所有证书的签发机构)</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/ca.crt</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/ca.key</span><br><span class=\"line\"></span><br><span class=\"line\">由此根证书签发机构签发的证书有:</span><br><span class=\"line\">1、etcd server 持有的服务端证书</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/server.crt</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/server.key</span><br><span class=\"line\"></span><br><span class=\"line\">2、peer 集群中节点互相通信使用的客户端证书</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/peer.crt</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/peer.key</span><br><span class=\"line\">注: Peer：对同一个etcd集群中另外一个Member的称呼</span><br><span class=\"line\">3、pod 中定义 Liveness 探针使用的客户端证书</span><br><span class=\"line\">kubeadm 部署的 Kubernetes 集群是以 pod 的方式运行 etcd 服务的, 在该 pod 的定义中, 配置了 Liveness 探活探针</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/healthcheck-client.crt</span><br><span class=\"line\">/etc/kubernetes/pki/etcd/healthcheck-client.key</span><br><span class=\"line\"></span><br><span class=\"line\">当你 describe etcd 的 pod 时, 会看到如下一行配置:</span><br><span class=\"line\">Liveness: <span class=\"built_in\">exec</span> [/bin/sh -ec ETCDCTL_API=3 etcdctl --endpoints=https://[127.0.0.1]:2379 --cacert=/etc/kubernetes/pki/etcd/ca.crt --cert=/etc/kubernetes/pki/etcd/healthcheck-client.crt --key=/etc/kubernetes/pki/etcd/healthcheck-client.key get foo] delay=15s <span class=\"built_in\">timeout</span>=15s period=10s <span class=\"comment\">#success=1 #failure=8</span></span><br><span class=\"line\"></span><br><span class=\"line\">4、配置在 kube-apiserver 中用来与 etcd server 做双向认证的客户端证书</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver-etcd-client.crt</span><br><span class=\"line\">/etc/kubernetes/pki/apiserver-etcd-client.key</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230425155408675.png\" alt=\"image-20230425155408675\"></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Calico网络模型主要工作组件：</span><br><span class=\"line\">1.Felix：运行在每一台 Host 的 agent 进程，主要负责网络接口管理和监听、路由、ARP 管理、ACL 管理和同步、状态上报等。保证跨主机容器网络互通。</span><br><span class=\"line\">2.etcd：分布式键值存储，相当于k8s集群中的数据库，存储着Calico网络模型中IP地址等相关信息。主要负责网络元数据一致性，确保 Calico 网络状态的准确性；</span><br><span class=\"line\">3.BGP Client（BIRD）：Calico 为每一台 Host 部署一个 BGP Client，即每台host上部署一个BIRD。 主要负责把 Felix 写入 Kernel 的路由信息分发到当前 Calico 网络，确保 Workload 间的通信的有效性；</span><br><span class=\"line\">4.BGP Route Reflector：在大型网络规模中，如果仅仅使用 BGP client 形成 mesh 全网互联的方案就会导致规模限制，因为所有节点之间俩俩互联，需要 N^2 个连接，为了解决这个规模问题，可以采用 BGP 的 Router Reflector 的方法，通过一个或者多个 BGP Route Reflector 来完成集中式的路由分发。 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">扩展：calico的IPIP模式和BGP模式对比分析</span><br><span class=\"line\">1）IPIP</span><br><span class=\"line\">把一个IP数据包又套在一个IP包里，即把IP层封装到IP层的一个 tunnel，它的作用其实基本上就相当于一个基于IP层的网桥，一般来说，普通的网桥是基于mac层的，根本不需要IP，而这个ipip则是通过两端的路由做一个tunnel，把两个本来不通的网络通过点对点连接起来；</span><br><span class=\"line\"></span><br><span class=\"line\">calico以ipip模式部署完毕后，node上会有一个tunl0的网卡设备，这是ipip做隧道封装用的,也是一种overlay模式的网络。当我们把节点下线，calico容器都停止后，这个设备依然还在，执行 rmmodipip命令可以将它删除。</span><br><span class=\"line\"></span><br><span class=\"line\">2）BGP</span><br><span class=\"line\">BGP模式直接使用物理机作为虚拟路由路（vRouter），不再创建额外的tunnel</span><br><span class=\"line\"></span><br><span class=\"line\">边界网关协议（BorderGateway Protocol, BGP）是互联网上一个核心的去中心化的自治路由协议。它通过维护IP路由表或‘前缀’表来实现自治系统（AS）之间的可达性，属于矢量路由协议。BGP不使用传统的内部网关协议（IGP）的指标，而是基于路径、网络策略或规则集来决定路由。因此，它更适合被称为矢量性协议，而不是路由协议，通俗的说就是将接入到机房的多条线路（如电信、联通、移动等）融合为一体，实现多线单IP；</span><br><span class=\"line\"></span><br><span class=\"line\">BGP 机房的优点：服务器只需要设置一个IP地址，最佳访问路由是由网络上的骨干路由器根据路由跳数与其它技术指标来确定的，不会占用服务器的任何系统；</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">常见网络插件</span><br><span class=\"line\">Flannel</span><br><span class=\"line\">Calico</span><br><span class=\"line\">Weave</span><br><span class=\"line\">canal</span><br><span class=\"line\">kubeadm init --config kubeadm.yaml --ignore-preflight-errors=SystemVerification</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: kubeadm.k8s.io/v1beta2</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">kubernetesVersion: v1.20.6</span><br><span class=\"line\">controlPlaneEndpoint: 192.168.13.249:16443</span><br><span class=\"line\">imageRepository: registry.aliyuncs.com/google_containers</span><br><span class=\"line\">apiServer:</span><br><span class=\"line\"> certSANs:</span><br><span class=\"line\"> - 192.168.13.211</span><br><span class=\"line\"> - 192.168.13.177</span><br><span class=\"line\"> - 192.168.13.188</span><br><span class=\"line\"> - 192.168.13.249</span><br><span class=\"line\">networking:</span><br><span class=\"line\">  podSubnet: 10.244.0.0/16</span><br><span class=\"line\">  serviceSubnet: 10.96.0.0/16</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class=\"line\">kind:  KubeProxyConfiguration</span><br><span class=\"line\">mode: ipvs</span><br><span class=\"line\">kubectl label node xianchaonode1 node-role.kubernetes.io/worker=worker</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 脚本一键安装</span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\">. /etc/init.d/functions</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># IP地址,默认为本机第一块网卡IP地址(不包含lo网卡)</span></span><br><span class=\"line\">ip=</span><br><span class=\"line\"><span class=\"comment\"># 主机名称,默认为当前主机名称</span></span><br><span class=\"line\">hostName=master</span><br><span class=\"line\"><span class=\"comment\"># Docker版本</span></span><br><span class=\"line\">dockerVersion=20.10.6</span><br><span class=\"line\"><span class=\"comment\"># Kubernetes版本</span></span><br><span class=\"line\">k8sVersion=1.23.0</span><br><span class=\"line\"><span class=\"comment\"># Pod网段</span></span><br><span class=\"line\">podSubnet=<span class=\"string\">&quot;10.244.0.0/16&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># Service网段</span></span><br><span class=\"line\">serviceSubnet=<span class=\"string\">&quot;10.10.0.0/16&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">openNetwork</span></span>()&#123;</span><br><span class=\"line\">ping -c 1 www.baidu.com &gt; /dev/null 2&gt;&amp;1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [ $? -eq 0 ];<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;外网权限:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;外网权限:&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;此脚本需要访问外网权限才可成功执行,退出脚本&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">exit</span> 5</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">stopFirewall</span></span>()&#123;</span><br><span class=\"line\">systemctl <span class=\"built_in\">disable</span> firewalld --now &amp;&gt;/dev/null</span><br><span class=\"line\">setenforce 0 &amp;&gt;/dev/null</span><br><span class=\"line\">sed  -i.$(<span class=\"built_in\">date</span> +%F) -r <span class=\"string\">&#x27;s/SELINUX=[ep].*/SELINUX=disabled/g&#x27;</span> /etc/selinux/config</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (grep SELINUX=disabled /etc/selinux/config) &amp;&gt;/dev/null;<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;关闭防火墙:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;关闭防火墙:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">hostName</span></span>()&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -z <span class=\"variable\">$&#123;ip&#125;</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\tip=$(ip addr | grep -oP <span class=\"string\">&#x27;(?&lt;=inet\\s)\\d+\\.\\d+\\.\\d+\\.\\d+&#x27;</span>|egrep -v <span class=\"string\">&quot;127.0.0.1|172.17.0.1&quot;</span>|awk NR==1)</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -z <span class=\"variable\">$&#123;hostName&#125;</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\thostName=<span class=\"string\">&quot;<span class=\"variable\">$&#123;HOSTNAME&#125;</span>&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> ! (egrep -w <span class=\"string\">&quot;<span class=\"variable\">$&#123;ip&#125;</span> +<span class=\"variable\">$&#123;hostName&#125;</span>&quot;</span> /etc/hosts) &amp;&gt;/dev/null;<span class=\"keyword\">then</span></span><br><span class=\"line\">\thostnamectl set-hostname <span class=\"variable\">$&#123;hostName&#125;</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;ip&#125;</span> <span class=\"variable\">$&#123;hostName&#125;</span>&quot;</span> &gt;&gt; /etc/hosts</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (egrep -w <span class=\"string\">&quot;<span class=\"variable\">$&#123;ip&#125;</span> +<span class=\"variable\">$&#123;hostName&#125;</span>&quot;</span> /etc/hosts) &amp;&gt;/dev/null;<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;添加本地域名解析:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">        action <span class=\"string\">&quot;添加本地域名解析:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">timeSync</span></span>()&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ! (<span class=\"built_in\">which</span> ntpdate &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# ntpdate未安装,开始进行安装....\\033[0m&quot;</span></span><br><span class=\"line\">\t(yum -y install ntpdate) &amp;&gt;/dev/null;<span class=\"built_in\">sleep</span> 0.3</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">which</span> ntpdate &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;ntpdate安装成功:&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (ntpdate ntp1.aliyun.com &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> ! (egrep <span class=\"string\">&quot;ntpdate +ntp1.aliyun.com&quot;</span> /var/spool/cron/root &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;0 1 * * * ntpdate ntp1.aliyun.com&quot;</span> &gt;&gt; /var/spool/cron/root</span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;时间同步:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;时间同步:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">swapOff</span></span>()&#123;</span><br><span class=\"line\">swapoff --all</span><br><span class=\"line\">sed -i -r <span class=\"string\">&#x27;/swap/ s/^/#/&#x27;</span> /etc/fstab</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ $(free | grep -i swap | awk <span class=\"string\">&#x27;&#123;print $2&#125;&#x27;</span>) -eq 0 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">    action <span class=\"string\">&quot;关闭交换分区:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">    action <span class=\"string\">&quot;关闭交换分区:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">addKernelArg</span></span>()&#123;</span><br><span class=\"line\">KernelArg=(<span class=\"string\">&quot;net.bridge.bridge-nf-call-ip6tables&quot;</span> <span class=\"string\">&quot;net.bridge.bridge-nf-call-iptables&quot;</span> <span class=\"string\">&quot;net.ipv4.ip_forward&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 判断内核参数是否存在,如果不存在则添加</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> ((i=0;i&lt;<span class=\"variable\">$&#123;#KernelArg[@]&#125;</span>;i++))<span class=\"keyword\">do</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> [[ $(sysctl -n <span class=\"variable\">$&#123;KernelArg[i]&#125;</span>) -ne 1 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\t<span class=\"built_in\">echo</span> <span class=\"string\">&quot;<span class=\"variable\">$&#123;KernelArg[i]&#125;</span> = 1&quot;</span> &gt;&gt; /etc/sysctl.d/kubernetes.conf</span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">modprobe br_netfilter &amp;&gt;/dev/null</span><br><span class=\"line\">sysctl -p /etc/sysctl.d/kubernetes.conf &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ $(sysctl -n <span class=\"variable\">$&#123;KernelArg[0]&#125;</span>) -eq 1 &amp;&amp; $(sysctl -n <span class=\"variable\">$&#123;KernelArg[1]&#125;</span>) -eq 1 &amp;&amp; $(sysctl -n <span class=\"variable\">$&#123;KernelArg[2]&#125;</span>) -eq 1 ]]; <span class=\"keyword\">then</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;添加内核参数&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;添加内核参数&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">ipvs</span></span>()&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"built_in\">command</span> -v ipset &amp;&gt;/dev/null &amp;&amp; <span class=\"built_in\">command</span> -v ipvsadm &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_rr</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_wrr</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_sh</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- nf_conntrack_ipv4  </span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">\t<span class=\"built_in\">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class=\"line\">\t/etc/sysconfig/modules/ipvs.modules</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# ipvs未安装,开始进行安装....\\033[0m&quot;</span></span><br><span class=\"line\">\tyum -y install ipset ipvsadm &amp;&gt;/dev/null</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">command</span> -v ipset &amp;&gt;/dev/null &amp;&amp; <span class=\"built_in\">command</span> -v ipvsadm &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;ipvs安装成功:&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt; /etc/sysconfig/modules/ipvs.modules &lt;&lt;<span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_rr</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_wrr</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- ip_vs_sh</span></span><br><span class=\"line\"><span class=\"string\">modprobe -- nf_conntrack_ipv4  </span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">\t        <span class=\"built_in\">chmod</span> +x /etc/sysconfig/modules/ipvs.modules</span><br><span class=\"line\">        \t/etc/sysconfig/modules/ipvs.modules</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">modprobe br_netfilter &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (lsmod | grep -q -e ip_vs -e nf_conntrack_ipv4)&amp;&gt;/dev/null; <span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;启用ipvs模块:&quot;</span> </span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;启用ipvs模块:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">dockerInstall</span></span>()&#123;</span><br><span class=\"line\"><span class=\"keyword\">if</span> ! (<span class=\"built_in\">command</span> -v docker &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# Docker未安装,开始进行安装....\\033[0m&quot;</span></span><br><span class=\"line\">\t(curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-7.repo) &amp;&gt;/dev/null</span><br><span class=\"line\">\t(wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo) &amp;&gt;/dev/null</span><br><span class=\"line\">\t(yum install -y yum-utils) &amp;&gt;/dev/null</span><br><span class=\"line\">\t(yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo) &amp;&gt;/dev/null</span><br><span class=\"line\">\t(yum install docker-ce-<span class=\"variable\">$&#123;dockerVersion&#125;</span> docker-ce-cli-<span class=\"variable\">$&#123;dockerVersion&#125;</span> -y) &amp;&gt;/dev/null</span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">command</span> -v docker &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;Docker安装成功:&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;Docker安装成功:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /etc/docker &amp;&gt;/dev/null</span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -f /etc/docker/daemon.json ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"built_in\">mv</span> /etc/docker/daemon.json&#123;,.$(<span class=\"built_in\">date</span> +%F)&#125;</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; /etc/docker/daemon.json</span></span><br><span class=\"line\"><span class=\"string\">&#123;</span></span><br><span class=\"line\"><span class=\"string\">  &quot;registry-mirrors&quot;: [&quot;https://aoewjvel.mirror.aliyuncs.com&quot;],</span></span><br><span class=\"line\"><span class=\"string\">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;]</span></span><br><span class=\"line\"><span class=\"string\">&#125;</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\">(systemctl <span class=\"built_in\">enable</span> docker --now) &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -f /etc/docker/daemon.json ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;Docker镜像加速源:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;Docker镜像加速源:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">k8sInstall</span></span>()&#123;</span><br><span class=\"line\">k8scommand=(<span class=\"string\">&quot;kubeadm&quot;</span> <span class=\"string\">&quot;kubelet&quot;</span> <span class=\"string\">&quot;kubectl&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -f /etc/yum.repos.d/kubernetes.repo ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"built_in\">mv</span> /etc/yum.repos.d/kubernetes.repo&#123;,.$(<span class=\"built_in\">date</span> +%F)&#125;</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &lt;&lt;<span class=\"string\">EOF &gt; /etc/yum.repos.d/kubernetes.repo</span></span><br><span class=\"line\"><span class=\"string\">[kubernetes]</span></span><br><span class=\"line\"><span class=\"string\">name=Kubernetes</span></span><br><span class=\"line\"><span class=\"string\">baseurl=https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/</span></span><br><span class=\"line\"><span class=\"string\">enabled=1</span></span><br><span class=\"line\"><span class=\"string\">gpgcheck=0</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# 正在安装K8S,请耐心等待......\\033[0m&quot;</span></span><br><span class=\"line\">(yum -y install --<span class=\"built_in\">setopt</span>=obsoletes=0 kubeadm-<span class=\"variable\">$&#123;k8sVersion&#125;</span> kubelet-<span class=\"variable\">$&#123;k8sVersion&#125;</span> kubectl-<span class=\"variable\">$&#123;k8sVersion&#125;</span>) &amp;&gt;/dev/null</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> kubelet.service --now  &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">for</span> ((i=0;i&lt;<span class=\"variable\">$&#123;#k8scommand[@]&#125;</span>;i++))<span class=\"keyword\">do</span></span><br><span class=\"line\">\t<span class=\"keyword\">if</span> (<span class=\"built_in\">command</span> -v <span class=\"variable\">$&#123;k8scommand[i]&#125;</span> &amp;&gt;/dev/null);<span class=\"keyword\">then</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;安装<span class=\"variable\">$&#123;k8scommand[i]&#125;</span>组件:&quot;</span></span><br><span class=\"line\">\t<span class=\"keyword\">else</span></span><br><span class=\"line\">\t\taction <span class=\"string\">&quot;安装<span class=\"variable\">$&#123;k8scommand[i]&#125;</span>组件:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t<span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">k8sInit</span></span>()&#123;</span><br><span class=\"line\"><span class=\"comment\"># 通过hosts文件获取IP地址</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -z <span class=\"variable\">$&#123;ip&#125;</span> ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\tip=$(grep <span class=\"variable\">$&#123;HOSTNAME&#125;</span> /etc/hosts|awk <span class=\"string\">&#x27;&#123;print $1&#125;&#x27;</span>| awk NR==1)</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -f /root/kubeadm-config.yaml ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\t<span class=\"built_in\">mv</span> /root/kubeadm-config.yaml&#123;,.$(<span class=\"built_in\">date</span> +%F)&#125;</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">cat</span> &gt;&gt; /root/kubeadm-config.yaml &lt;&lt; <span class=\"string\">EOF</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class=\"line\"><span class=\"string\">bootstrapTokens:</span></span><br><span class=\"line\"><span class=\"string\">- groups:</span></span><br><span class=\"line\"><span class=\"string\">  - system:bootstrappers:kubeadm:default-node-token</span></span><br><span class=\"line\"><span class=\"string\">  token: abcdef.0123456789abcdef</span></span><br><span class=\"line\"><span class=\"string\">  ttl: 24h0m0s</span></span><br><span class=\"line\"><span class=\"string\">  usages:</span></span><br><span class=\"line\"><span class=\"string\">  - signing</span></span><br><span class=\"line\"><span class=\"string\">  - authentication</span></span><br><span class=\"line\"><span class=\"string\">kind: InitConfiguration</span></span><br><span class=\"line\"><span class=\"string\">localAPIEndpoint:</span></span><br><span class=\"line\"><span class=\"string\">  advertiseAddress: $&#123;ip&#125;</span></span><br><span class=\"line\"><span class=\"string\">  bindPort: 6443</span></span><br><span class=\"line\"><span class=\"string\">nodeRegistration:</span></span><br><span class=\"line\"><span class=\"string\">  imagePullPolicy: IfNotPresent</span></span><br><span class=\"line\"><span class=\"string\">  name: node</span></span><br><span class=\"line\"><span class=\"string\">  taints: null</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiServer:</span></span><br><span class=\"line\"><span class=\"string\">  timeoutForControlPlane: 4m0s</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeadm.k8s.io/v1beta3</span></span><br><span class=\"line\"><span class=\"string\">certificatesDir: /etc/kubernetes/pki</span></span><br><span class=\"line\"><span class=\"string\">clusterName: kubernetes</span></span><br><span class=\"line\"><span class=\"string\">controllerManager: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">dns: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">etcd:</span></span><br><span class=\"line\"><span class=\"string\">  local:</span></span><br><span class=\"line\"><span class=\"string\">    dataDir: /var/lib/etcd</span></span><br><span class=\"line\"><span class=\"string\">imageRepository: registry.aliyuncs.com/google_containers</span></span><br><span class=\"line\"><span class=\"string\">kind: ClusterConfiguration</span></span><br><span class=\"line\"><span class=\"string\">kubernetesVersion: $&#123;k8sVersion&#125;</span></span><br><span class=\"line\"><span class=\"string\">networking:</span></span><br><span class=\"line\"><span class=\"string\">  dnsDomain: cluster.local</span></span><br><span class=\"line\"><span class=\"string\">  serviceSubnet: $&#123;serviceSubnet&#125;</span></span><br><span class=\"line\"><span class=\"string\">  podSubnet: $&#123;podSubnet&#125;</span></span><br><span class=\"line\"><span class=\"string\">scheduler: &#123;&#125;</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeProxyConfiguration</span></span><br><span class=\"line\"><span class=\"string\">mode: ipvs</span></span><br><span class=\"line\"><span class=\"string\">---</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: kubelet.config.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"string\">kind: KubeletConfiguration</span></span><br><span class=\"line\"><span class=\"string\">cgroupDriver: systemd</span></span><br><span class=\"line\"><span class=\"string\">EOF</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ -f /root/kubeadm-config.yaml ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">        action <span class=\"string\">&quot;生成K8s初始化文件:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">        action <span class=\"string\">&quot;生成K8s初始化文件:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# K8s初始化中,时间可能较长,可以使用 tailf k8s_init.log 可追踪整个过程....\\033[0m&quot;</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> </span><br><span class=\"line\">kubeadm init --config /root/kubeadm-config.yaml --ignore-preflight-errors=SystemVerification &amp;&gt;k8s_init.log</span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ $? -eq 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;K8s初始化:&quot;</span></span><br><span class=\"line\">\t<span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">\tsudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">\tsudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;K8s初始化:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\">\t<span class=\"built_in\">exit</span> 5</span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">k8sNetwork</span></span>()&#123;</span><br><span class=\"line\">(wget -O /root/calico.yaml  http://120.48.34.146/calico.yaml) &amp;&gt;/dev/null</span><br><span class=\"line\">(kubectl apply -f  /root/calico.yaml) &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ $? -eq 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;K8s网络插件:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">\taction <span class=\"string\">&quot;K8s网络插件:&quot;</span>  <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">k8sTaint</span></span>()&#123;</span><br><span class=\"line\">(kubectl taint nodes --all node-role.kubernetes.io/master-) &amp;&gt;/dev/null</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> [[ $? -eq 0 ]];<span class=\"keyword\">then</span></span><br><span class=\"line\">        action <span class=\"string\">&quot;设置Master节点可调度:&quot;</span></span><br><span class=\"line\"><span class=\"keyword\">else</span></span><br><span class=\"line\">        action <span class=\"string\">&quot;设置Master节点可调度:&quot;</span> <span class=\"literal\">false</span></span><br><span class=\"line\"><span class=\"keyword\">fi</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">initEnv</span></span>()&#123;</span><br><span class=\"line\">clear;<span class=\"built_in\">echo</span> <span class=\"string\">&quot;一键部署单机版K8S脚本&quot;</span></span><br><span class=\"line\">openNetwork</span><br><span class=\"line\">hostName</span><br><span class=\"line\">stopFirewall</span><br><span class=\"line\">swapOff</span><br><span class=\"line\">timeSync</span><br><span class=\"line\">ipvs</span><br><span class=\"line\">addKernelArg</span><br><span class=\"line\">dockerInstall</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">k8s</span></span>()&#123;</span><br><span class=\"line\">clear;k8sInstall</span><br><span class=\"line\">k8sInit</span><br><span class=\"line\">k8sNetwork</span><br><span class=\"line\">k8sTaint</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">echo</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> -e <span class=\"string\">&quot;\\033[32m# K8s单机版部署完成,等待Pod全部运行成功即可使用 使用 kubectl get pods -n kube-system 关注Pod状态...\\033[0m&quot;</span></span><br><span class=\"line\">bash</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">initEnv</span><br><span class=\"line\">k8s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"部署dashboard\"><a class=\"markdownIt-Anchor\" href=\"#部署dashboard\">#</a> 部署 dashboard</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f https://raw.githubusercontent.com/kubernetes/dashboard/v2.3.1/aio/deploy/recommended.yaml</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubernetes-dashboard   dashboard-metrics-scraper-79c5968bdc-24bws   1/1     Running   0          2m5s</span><br><span class=\"line\">kubernetes-dashboard   kubernetes-dashboard-658485d5c7-9hpsc        1/1     Running   0          2m5s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">设置访问端口</span><br><span class=\"line\">kubectl edit svc kubernetes-dashboard -n kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">:/type</span><br><span class=\"line\">改为 NodePort</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl get svc -A |grep kubernetes-dashboard</span><br><span class=\"line\"><span class=\"comment\">## 找到端口，在安全组放行</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get svc -A |grep kubernetes-dashboard</span></span><br><span class=\"line\">kubernetes-dashboard   dashboard-metrics-scraper   ClusterIP   10.96.232.147   &lt;none&gt;        8000/TCP                 6m7s</span><br><span class=\"line\">kubernetes-dashboard   kubernetes-dashboard        NodePort    10.96.28.103    &lt;none&gt;        443:31882/TCP            6m7s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过token访问</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># vi dash-user.yml</span></span><br><span class=\"line\"><span class=\"comment\">#创建访问账号，准备一个yaml文件； vi dash.yaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ServiceAccount</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: admin-user</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class=\"line\">kind: ClusterRoleBinding</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: admin-user</span><br><span class=\"line\">roleRef:</span><br><span class=\"line\">  apiGroup: rbac.authorization.k8s.io</span><br><span class=\"line\">  kind: ClusterRole</span><br><span class=\"line\">  name: cluster-admin</span><br><span class=\"line\">subjects:</span><br><span class=\"line\">- kind: ServiceAccount</span><br><span class=\"line\">  name: admin-user</span><br><span class=\"line\">  namespace: kubernetes-dashboard</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f dash-user.yml </span></span><br><span class=\"line\">serviceaccount/admin-user created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/admin-user created</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#获取访问令牌</span></span><br><span class=\"line\">kubectl -n kubernetes-dashboard get secret $(kubectl -n kubernetes-dashboard get sa/admin-user -o jsonpath=<span class=\"string\">&quot;&#123;.secrets[0].name&#125;&quot;</span>) -o go-template=<span class=\"string\">&quot;&#123;&#123;.data.token | base64decode&#125;&#125;&quot;</span></span><br><span class=\"line\">eyJhbGciOiJSUzI1NiIsImtpZCI6IkY5LU9Jc0pnblNNOVJhM1dlWVl6c09DTjNnbFNQa1hzcWhOSThHVENEdlUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXp3NmRzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkOTRmMDZlNi1kNTkxLTRmMzktODMxNC0zNzI2MDVhM2RkN2MiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.TMTc8QDTIo3qhsGTYD05c8txOyq2op7xW9ZQB5ICVw5x4fg-L0iUnn1jGyo4REP6ci63zBR-xmirqHy1eQ5GgT1nwGZnv4oKqNElm8-wkAit5rEgVN7ATo5GN3VrRQgNyBsHwqFhe1SsrK47flCZcmBvWbgmU4ugFfrNZ8xHkSURKrLAPUPjsYUC6ugyrEMqfwhcxzMiZcSKxG20jjLgVK7Pd_T01NAObUb_lCjq7mrEV0KdHcYTtSYwVwV88mTu5vwb39k-10V0s6HOqiDx87lp7fPtctrcR3mRiT1PkEvsyhCb8qAuFDPuaJZtESFu2dCXP_fVmv5g7AhSO_qUHg</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410143529721.png\" alt=\"image-20230410143529721\"></p>\n<p>如果页面没有接受风险，换浏览器或者空白输入 thisisunsafe</p>\n<p><strong>通过 token 访问 dashboard</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 查看token </span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:kubernetes-dashboard</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get secrets -n kubernetes-dashboard </span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl describe secrets kubernetes-dashboard-token-dmv8x -n kubernetes-dashboard </span></span><br></pre></td></tr></table></figure>\n<p><strong>通过 kubeconfig 访问 dashborad</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">cd</span> /etc/kubernetes/pki/</span><br><span class=\"line\">kubectl config set-cluster kubernetes --certificate-authority=./ca.crt --server=<span class=\"string\">&quot;https://192.168.40.249:6443&quot;</span> --embed-certs=<span class=\"literal\">true</span> --kueconfig=/root/dashboard-admin.conf</span><br><span class=\"line\">DEF_NS_ADMIN_TOKEN=$(kubectl get secret kubernetes-dashboard-token-dmv8x -n kubernetes-dashboard  -o jsonpath=&#123;.data.token&#125;|<span class=\"built_in\">base64</span> -d</span><br><span class=\"line\">kubectl config set-credentials dashboard-admin --token=<span class=\"variable\">$DEF_NS_ADMIN_TOKEN</span> --kubeconfig=/root/dashboard-admin.conf</span><br><span class=\"line\">kubectl config set-context dashboard-admin@kubernetes --cluster=kubernetes --user=dashboard-admin --kubeconfig=/root/dashboard-admin.onf</span><br><span class=\"line\">kubectl config use-context dashboard-admin@kubernetes --kubeconfig=/root/dashboard-admin.conf</span><br><span class=\"line\">vim /root/dashboard-admin.conf </span><br></pre></td></tr></table></figure>\n<h3 id=\"安装containerd\"><a class=\"markdownIt-Anchor\" href=\"#安装containerd\">#</a> 安装 containerd</h3>\n<p>对于 1.24 以上的版本，使用 containerd 管理和运行容器，在此版本之前使用的是 docker</p>\n<p><strong>Kubernetes 中的容器运行时就像一个保姆一样，它负责管理容器的生命周期和资源隔离，确保容器能够在节点上稳定地运行。其中，containerd 就是一个常用的容器运行时，它实现了 Kubernetes 规定的 CRI 接口，因此可以被 Kubernetes 作为容器运行时来使用。简单来说，就是 Kubernetes 需要容器运行时来管理和运行容器，而 containerd 就是 Kubernetes 中常用的一种容器运行时，能够让 Kubernetes 更加高效、稳定地运行容器化应用。</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install  containerd.io-1.6.6 -y</span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /etc/containerd</span><br><span class=\"line\">containerd config default &gt; /etc/containerd/config.toml</span><br><span class=\"line\">vim /etc/containerd/config.toml  <span class=\"comment\"># 修改</span></span><br><span class=\"line\">SystemdCgroup = <span class=\"literal\">true</span></span><br><span class=\"line\">sandbox_image=<span class=\"string\">&quot;registry.aliyuncs.com/google_containers/pause:3.7&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">相比 cgroupfs，systemd-cgroup 在资源隔离方面提供了更好的性能和更多的特性。例如，systemd-cgroup 可以使用更多的内存压缩算法，以便更有效地使用内存。此外，systemd-cgroup 还提供了更好的 cgroup 监控和控制机制，可以更精确地调整容器的资源使用量。</span><br><span class=\"line\">总之，使用 systemd-cgroup 作为容器运行时的 cgroup 驱动程序，可以提高 Kubernetes 集群中容器的资源管理效率，从而提升整个集群的性能。</span><br><span class=\"line\"></span><br><span class=\"line\">在 Kubernetes 中，每个 Pod 中都有一个 pause 容器，这个容器不会运行任何应用，只是简单地 <span class=\"built_in\">sleep</span>。它的作用是为了保证 Pod 中所有的容器共享同一个网络命名空间和 IPC 命名空间。pause 容器会在 Pod 的初始化过程中首先启动，然后为 Pod 中的其他容器创建对应的网络和 IPC 命名空间，并且在其他容器启动之前保持运行状态，以保证其他容器可以加入到共享的命名空间中。</span><br><span class=\"line\">简单来说，pause 容器就是一个占位符，它为 Pod 中的其他容器提供了一个共享的环境，使它们可以共享同一个网络和 IPC 命名空间。这也是 Kubernetes 实现容器间通信和网络隔离的重要机制之一。</span><br><span class=\"line\"> </span><br><span class=\"line\">创建/etc/crictl.yaml文件</span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\">#cat &gt; /etc/crictl.yaml &lt;&lt;EOF</span></span><br><span class=\"line\">runtime-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\">image-endpoint: unix:///run/containerd/containerd.sock</span><br><span class=\"line\"><span class=\"built_in\">timeout</span>: 10</span><br><span class=\"line\">debug: <span class=\"literal\">false</span></span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">这个文件是 crictl 工具的配置文件，用于指定与 containerd 交互的相关设置：</span><br><span class=\"line\"></span><br><span class=\"line\">指定unix:///run/containerd/containerd.sock 是为了告诉 crictl 使用 Unix 域套接字的方式来连接 containerd 的 API。containerd 提供了一个 socket 文件 /run/containerd/containerd.sock，crictl 通过连接该 socket 文件，可以与 containerd 进行通信，管理容器和镜像等操作。</span><br><span class=\"line\"></span><br><span class=\"line\">1）runtime-endpoint：指定 containerd 的运行时接口地址，以便 crictl 可以与 containerd 通信来管理容器生命周期和资源隔离。</span><br><span class=\"line\">2）image-endpoint：指定 containerd 的镜像接口地址，以便 crictl 可以与 containerd 通信来管理镜像的拉取和推送。</span><br><span class=\"line\">3）<span class=\"built_in\">timeout</span>：指定 crictl 等待 containerd 响应的最大时间，避免出现无响应的情况。</span><br><span class=\"line\">4）debug：开启或关闭 crictl 的调试模式，方便排查问题。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#systemctl enable containerd  --now</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置containerd镜像加速器，k8s所有节点均按照以下配置：</span><br><span class=\"line\">编辑vim /etc/containerd/config.toml文件</span><br><span class=\"line\">找到config_path = <span class=\"string\">&quot;&quot;</span>，修改成如下目录：</span><br><span class=\"line\">config_path = <span class=\"string\">&quot;/etc/containerd/certs.d&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#保存退出</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> /etc/containerd/certs.d/docker.io/ -p</span><br><span class=\"line\">vim /etc/containerd/certs.d/docker.io/hosts.toml</span><br><span class=\"line\"><span class=\"comment\">#写入如下内容：</span></span><br><span class=\"line\">[host.<span class=\"string\">&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;</span>,host.<span class=\"string\">&quot;https://registry.docker-cn.com&quot;</span>]</span><br><span class=\"line\">  capabilities = [<span class=\"string\">&quot;pull&quot;</span>,<span class=\"string\">&quot;push&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">重启containerd：</span><br><span class=\"line\">systemctl restart containerd</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">yum install  docker-ce  -y</span><br><span class=\"line\"><span class=\"comment\"># 为了使用dockerfile所以还要装docker</span></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">写入如下内容：</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"> <span class=\"string\">&quot;registry-mirrors&quot;</span>:[<span class=\"string\">&quot;https://vh3bm52y.mirror.aliyuncs.com&quot;</span>,<span class=\"string\">&quot;https://registry.docker-cn.com&quot;</span>,<span class=\"string\">&quot;https://docker.mirrors.ustc.edu.cn&quot;</span>,<span class=\"string\">&quot;https://dockerhub.azk8s.cn&quot;</span>,<span class=\"string\">&quot;http://hub-mirror.c.163.com&quot;</span>]</span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\">重启docker：</span><br><span class=\"line\">systemctl restart docker</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.ctr是containerd自带的CLI命令行工具，crictl是k8s中CRI（容器运行时接口）的客户端，k8s使用该客户端和containerd进行交互；</span><br><span class=\"line\"></span><br><span class=\"line\">2.ctr和crictl命令具体区别如下，也可以--help查看。crictl缺少对具体镜像的管理能力，可能是k8s层面镜像管理可以由用户自行控制，能配置pod里面容器的统一镜像仓库，镜像的管理可以有habor</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426170330957.png\" alt=\"image-20230426170330957\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">K8s官方文档：https://kubernetes.io/</span><br><span class=\"line\">K8s中文官方文档： https://kubernetes.io/zh/</span><br><span class=\"line\">K8s Github地址：https://github.com/kubernetes/kubernetes</span><br></pre></td></tr></table></figure>\n<h2 id=\"namespace\"><a class=\"markdownIt-Anchor\" href=\"#namespace\">#</a> Namespace</h2>\n<p>Kubernetes 支持多个虚拟集群，它们底层依赖于同一个物理集群。 这些虚拟集群被称为命名空间。</p>\n<p>命名空间 namespace 是 k8s 集群级别的资源，可以给不同的用户、租户、环境或项目创建对应的命名空间</p>\n<p>命名空间适用于存在很多跨多个团队或项目的用户的场景。默认存放在 default 空间下</p>\n<p>隔离资源，不隔离网络</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get ns </span></span><br><span class=\"line\">NAME                   STATUS   AGE</span><br><span class=\"line\">calico-system          Active   41h</span><br><span class=\"line\">default                Active   41h</span><br><span class=\"line\">kube-node-lease        Active   41h</span><br><span class=\"line\">kube-public            Active   41h</span><br><span class=\"line\">kube-system            Active   41h</span><br><span class=\"line\">kubernetes-dashboard   Active   27m</span><br><span class=\"line\">tigera-operator        Active   41h</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看所有命名空间下</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pods -A </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 默认命名空间</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pods</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看指定名称空间</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pods -n kube-system</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除名称空间</span></span><br><span class=\"line\">kubectl delete ns 111</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建名称空间</span></span><br><span class=\"line\">kubectl create ns 111</span><br><span class=\"line\">kubectl get ns</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过yaml创建名称空间</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Namespace</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: hello</span><br><span class=\"line\"></span><br><span class=\"line\">kubectl explain ResourceQuota</span><br><span class=\"line\"><span class=\"comment\"># 创建资源限额的namespace</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ResourceQuota</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mem-cpu-quota</span><br><span class=\"line\">  namespace: testing</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hard:</span><br><span class=\"line\">    requests.cpu: <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    requests.memory: 2Gi</span><br><span class=\"line\">    limits.cpu: <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\">    limits.memory: 4Gi</span><br><span class=\"line\">    </span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get resourcequotas -n testing </span></span><br><span class=\"line\">NAME            AGE   REQUEST                                     LIMIT</span><br><span class=\"line\">mem-cpu-quota   18s   requests.cpu: 0/2, requests.memory: 0/1Gi   limits.cpu: 0/4, limits.memory: 0/2Gi</span><br><span class=\"line\"></span><br><span class=\"line\">request node必须有空闲的request指定的内存才会调度pod到该node上</span><br><span class=\"line\"><span class=\"built_in\">limit</span>是限制不能超过指定的内存和CPU</span><br><span class=\"line\"><span class=\"comment\"># 在namespace下面定义的pod加起来必须满足request和limit</span></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: pod-test</span><br><span class=\"line\">  namespace: <span class=\"built_in\">test</span></span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: tomcat-pod-test</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name:  tomcat-test</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat-8.5-jre8</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    resources:</span><br><span class=\"line\">      requests:</span><br><span class=\"line\">        memory: <span class=\"string\">&quot;100Mi&quot;</span></span><br><span class=\"line\">        cpu: <span class=\"string\">&quot;500m&quot;</span></span><br><span class=\"line\">      limits:</span><br><span class=\"line\">        memory: <span class=\"string\">&quot;2Gi&quot;</span></span><br><span class=\"line\">        cpu: <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">   </span><br><span class=\"line\"><span class=\"comment\"># 即pod request和limit不能超过namespace的request和limit，否则不能创建</span></span><br><span class=\"line\"><span class=\"comment\"># namespace指定request和limit，pod也必须指定</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pod超过了ns的限制会无法创建</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"pod\"><a class=\"markdownIt-Anchor\" href=\"#pod\">#</a> pod</h2>\n<p>运行中的一组容器，Pod 是 kubernetes 中应用的最小调度单元 k8s 是通过定义一个 Pod 的资源，然后在 Pod 里面运行容器，容器需要指定一个镜像，这样就可以用来运行具体的服务。</p>\n<p>一个 Pod 封装一个容器（也可以封装多个容器），<strong>Pod 里的容器共享存储、网络等</strong>。也就是说，应该把整个 pod 看作虚拟机，然后每个容器相当于运行在虚拟机的进程。</p>\n<p>Pod 是需要调度到 k8s 集群的工作节点来运行的，具体调度到哪个节点，是<strong>根据 scheduler 调度器实现的。</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410144807975.png\" alt=\"image-20230410144807975\" style=\"zoom:67%;\" /> <img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410144917082.png\" alt=\"image-20230410144917082\" style=\"zoom:67%;\" /></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526165706388.png\" alt=\"image-20230526165706388\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526170239453.png\" alt=\"image-20230526170239453\"></p>\n<h3 id=\"pod管理多个容器\"><a class=\"markdownIt-Anchor\" href=\"#pod管理多个容器\">#</a> pod 管理多个容器</h3>\n<p>pod 之间隔离，pod 中可以运行多个容器，pod 中共享资源</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410145136606.png\" alt=\"image-20230410145136606\"></p>\n<p>Pod 中可以同时运行多个容器。同一个 Pod 中的容器会自动的分配到同一个 node 上。同一个 Pod 中的容器共享资源、网络环境，它们总是被同时调度，在一个 Pod 中同时运行多个容器是一种比较高级的用法，只有当你的容器需要紧密配合协作的时候才考虑用这种模式。</p>\n<p>例如，你有一个容器作为 web 服务器运行，需要用到共享的 volume，有另一个 “sidecar” 容器来从远端获取资源更新这些文件。</p>\n<p>一些 Pod 有 init 容器和应用容器。 在应用程序容器启动之前，运行初始化容器。比如 es 就需要有 init 容器修改 es 内核参数</p>\n<h3 id=\"pod网络\"><a class=\"markdownIt-Anchor\" href=\"#pod网络\">#</a> Pod 网络</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 pki]<span class=\"comment\"># kubectl get pod -A -owide</span></span><br><span class=\"line\">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE   IP               NODE      </span><br><span class=\"line\">default                nginx-7f466444dc-jbhpm                       1/1     Running   0          77m   10.244.166.134   node1     &lt;none&gt;  </span><br><span class=\"line\">kube-system            calico-kube-controllers-57c7b58f66-b7pw7     1/1     Running   0          24h   10.244.166.132   node1     &lt;none&gt;   </span><br><span class=\"line\">kube-system            calico-node-fdzw9                            1/1     Running   1          24h   192.168.13.188   master2   &lt;none&gt;   </span><br><span class=\"line\">kube-system            calico-node-hz96l                            1/1     Running   1          24h   192.168.13.199   node1     &lt;none&gt;   </span><br><span class=\"line\"></span><br><span class=\"line\">Pod是有IP地址的，假如pod不是共享物理机ip，由网络插件（calico、flannel、weave）划分的ip，每个pod都被分配唯一的IP地址</span><br><span class=\"line\"></span><br><span class=\"line\">控制节点组件 pod ip和物理机ip一样</span><br><span class=\"line\">如果pod由calico分配，且不共享物理机IP，那么IP唯一,ip地址段在配置时指定</span><br><span class=\"line\"></span><br><span class=\"line\">docker 容器间通信，通过--net container参数，指定其和已经存在的某个容器共享一个 Network Namespace。</span><br><span class=\"line\">docker run --name container2 --net=container:none  -it --privileged=<span class=\"literal\">true</span> centos</span><br><span class=\"line\"></span><br><span class=\"line\">Kubernetes中容器共享的方式</span><br><span class=\"line\">在k8s中，启动Pod时，会先启动⼀个pause 的容器，然后将后续的所有容器都 <span class=\"built_in\">link</span> 到这个pause 的容器，以实现⽹络共享</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526171816395.png\" alt=\"image-20230526171816395\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427134601678.png\" alt=\"image-20230427134601678\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426173422564.png\" alt=\"image-20230426173422564\"></p>\n<h3 id=\"pod-存储\"><a class=\"markdownIt-Anchor\" href=\"#pod-存储\">#</a> pod 存储</h3>\n<p>创建 Pod 的时候可以指定挂载的存储卷。 POD 中的所有容器都可以访问共享卷，允许这些容器共享数据。 Pod 只要挂载持久化数据卷，Pod 重启之后数据还是会存在的</p>\n<p>volume 可以是 nfs，cefs，或者云存储</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426173643049.png\" alt=\"image-20230426173643049\"></p>\n<p>Pod 中的所用容器会被一致调度、同节点部署，并且在一个 “共享环境” 中运行。</p>\n<p>1）所有容器共享一个 IP 地址和端口空间，意味着容器之间可以通过 localhost 高效访问，不能有端口冲突</p>\n<p>2）允许容器之间共享存储卷，通过文件系统交互信息</p>\n<p>些容器需要紧密联系，需要一起工作。Pod 提供了比容器更高层次的抽象， Pod 中的所有容器使用同一个网络的 namespace，即相同的 IP 地址和 Port 空间。它们可以直接用 localhost 通信。同样的，这些容器可以共享存储，当 K8s 挂载 Volume 到 Pod 上，本质上是将 volume 挂载到 Pod 中的每一个容器里。</p>\n<p>通过 pod 可以实现代码自动更新和日志收集</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426175239516.png\" alt=\"image-20230426175239516\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">生产环境部署了一个go的应用，而且部署了几百个节点，希望这个应用可以定时的同步最新的代码，以便自动升级线上环境。这时，我们不希望改动原来的go应用，可以开发一个Git代码仓库的自动同步服务，然后通过Pod的方式进行编排，并共享代码目录，就可以达到更新java应用代码的效果。</span><br></pre></td></tr></table></figure>\n<p>pod 实现日志收集并 aggregate</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230426175303038.png\" alt=\"image-20230426175303038\"></p>\n<p>使用 Pod 的方式，通过简单的编排，既可以保持原有服务逻辑、部署方式不变，又可以增加新的日志收集服务。<br>\n而且如果我们对所有服务的日志生成有一个统一的标准，或者仅对日志收集服务稍加修改，就可以将日志收集服务和其他服务进行 Pod 编排，提供统一、标准的日志收集方式。<br>\n这里的 “核心业务服务”、“日志收集服务” 分别是一个镜像，运行在隔离的容器环境中。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建方式</span></span><br><span class=\"line\"><span class=\"number\">1.</span><span class=\"string\">kubectl</span> <span class=\"string\">run</span> <span class=\"string\">命令行创建</span>  <span class=\"string\">(不常用)</span></span><br><span class=\"line\"><span class=\"number\">2.</span><span class=\"string\">yaml文件创建</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># pod工作方式</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">.自主式pod：直接定义一个pod资源</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tomcat-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span>  <span class=\"string\">tomcat</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">tomcat-java</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat:latest</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pod -A -owide -l app=tomcat</span></span><br><span class=\"line\"><span class=\"string\">NAMESPACE</span>   <span class=\"string\">NAME</span>          <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>              <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span>   <span class=\"string\">IP</span>       <span class=\"string\">NODE</span>    <span class=\"string\">NOMINATED</span> <span class=\"string\">NODE</span>   <span class=\"string\">READINESS</span> <span class=\"string\">GATES</span></span><br><span class=\"line\"><span class=\"string\">default</span>     <span class=\"string\">tomcat-test</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">66s</span>   <span class=\"string\">&lt;none&gt;</span>   <span class=\"string\">node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod被删之后不会在重启</span> <span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">pod</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">.控制器管理pod</span></span><br><span class=\"line\"><span class=\"string\">常见的管理Pod的控制器：Replicaset、Deployment、Job、CronJob、Daemonset、Statefulset。</span></span><br><span class=\"line\"><span class=\"string\">控制器管理的Pod可以确保Pod始终维持在指定的副本数运行。</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment、Job...</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-test</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">xianchao/nginx:v1</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"pod-创建机制\"><a class=\"markdownIt-Anchor\" href=\"#pod-创建机制\">#</a> pod 创建机制</h3>\n<p>kubectl 执行的时候先找 kubeconfig 的环境变量，如果没有就找～/.kube/config</p>\n<p><code>kubectl config view</code>  查看不带 key 的 config</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl config view </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">clusters:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">cluster:</span></span><br><span class=\"line\">    <span class=\"attr\">certificate-authority-data:</span> <span class=\"string\">DATA+OMITTED</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://192.168.13.249:16443</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">contexts:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">context:</span></span><br><span class=\"line\">    <span class=\"attr\">cluster:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">current-context:</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">preferences:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">users:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">user:</span></span><br><span class=\"line\">    <span class=\"attr\">client-certificate-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\">    <span class=\"attr\">client-key-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用kubernetes-admin访问192.168.13.249:16443，找到apiserver</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230427135535238.png\" alt=\"image-20230427135535238\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl apply -f nginx-deploy.yaml-&gt;找到config文件，基于config文件指定的用户访问指定的集群，这样就找到了apiserver</span><br><span class=\"line\"></span><br><span class=\"line\">第一步：</span><br><span class=\"line\">通过 kubectl 命令向 apiserver 提交创建pod的请求，apiserver接收到pod创建请求后，会将pod的属性信息(metadata)写入etcd。</span><br><span class=\"line\"></span><br><span class=\"line\">第二步：</span><br><span class=\"line\">apiserver触发watch机制准备创建pod，信息转发给调度器scheduler，调度器使用调度算法选择node，调度器将node信息给apiserver，apiserver将绑定的node信息写入etcd</span><br><span class=\"line\"></span><br><span class=\"line\">第三步：</span><br><span class=\"line\">apiserver又通过watch机制，调用kubelet，指定pod信息，调用容器运行时创建并启动pod内的容器。</span><br><span class=\"line\"></span><br><span class=\"line\">第四步：</span><br><span class=\"line\">创建完成之后反馈给kubelet, kubelet又将pod的状态信息给apiserver,</span><br><span class=\"line\">apiserver又将pod的状态信息写入etcd。</span><br></pre></td></tr></table></figure>\n<h3 id=\"yaml创建pod\"><a class=\"markdownIt-Anchor\" href=\"#yaml创建pod\">#</a> yaml 创建 pod</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master2</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain pod </span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">Pod</span> <span class=\"string\">is</span> <span class=\"string\">a</span> <span class=\"string\">collection</span> <span class=\"string\">of</span> <span class=\"string\">containers</span> <span class=\"string\">that</span> <span class=\"string\">can</span> <span class=\"string\">run</span> <span class=\"string\">on</span> <span class=\"string\">a</span> <span class=\"string\">host.</span> <span class=\"string\">This</span> <span class=\"string\">resource</span> <span class=\"string\">is</span></span><br><span class=\"line\">     <span class=\"string\">created</span> <span class=\"string\">by</span> <span class=\"string\">clients</span> <span class=\"string\">and</span> <span class=\"string\">scheduled</span> <span class=\"string\">onto</span> <span class=\"string\">hosts.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">apiVersion</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">APIVersion</span> <span class=\"string\">defines</span> <span class=\"string\">the</span> <span class=\"string\">versioned</span> <span class=\"string\">schema</span> <span class=\"string\">of</span> <span class=\"string\">this</span> <span class=\"string\">representation</span> <span class=\"string\">of</span> <span class=\"string\">an</span></span><br><span class=\"line\">     <span class=\"string\">object.</span> <span class=\"string\">Servers</span> <span class=\"string\">should</span> <span class=\"string\">convert</span> <span class=\"string\">recognized</span> <span class=\"string\">schemas</span> <span class=\"string\">to</span> <span class=\"string\">the</span> <span class=\"string\">latest</span> <span class=\"string\">internal</span></span><br><span class=\"line\">     <span class=\"string\">value,</span> <span class=\"attr\">and may reject unrecognized values. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#resources</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">kind</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Kind</span> <span class=\"string\">is</span> <span class=\"string\">a</span> <span class=\"string\">string</span> <span class=\"string\">value</span> <span class=\"string\">representing</span> <span class=\"string\">the</span> <span class=\"string\">REST</span> <span class=\"string\">resource</span> <span class=\"string\">this</span> <span class=\"string\">object</span></span><br><span class=\"line\">     <span class=\"string\">represents.</span> <span class=\"string\">Servers</span> <span class=\"string\">may</span> <span class=\"string\">infer</span> <span class=\"string\">this</span> <span class=\"string\">from</span> <span class=\"string\">the</span> <span class=\"string\">endpoint</span> <span class=\"string\">the</span> <span class=\"string\">client</span> <span class=\"string\">submits</span></span><br><span class=\"line\">     <span class=\"attr\">requests to. Cannot be updated. In CamelCase. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#types-kinds</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">metadata</span>\t<span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Standard</span> <span class=\"string\">object&#x27;s</span> <span class=\"attr\">metadata. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">spec</span>\t<span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\">     <span class=\"attr\">Specification of the desired behavior of the pod. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">status</span>\t<span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Most</span> <span class=\"string\">recently</span> <span class=\"string\">observed</span> <span class=\"string\">status</span> <span class=\"string\">of</span> <span class=\"string\">the</span> <span class=\"string\">pod.</span> <span class=\"string\">This</span> <span class=\"string\">data</span> <span class=\"string\">may</span> <span class=\"string\">not</span> <span class=\"string\">be</span> <span class=\"string\">up</span> <span class=\"string\">to</span> <span class=\"string\">date.</span></span><br><span class=\"line\">     <span class=\"attr\">Populated by the system. Read-only. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master2</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain pod.metadata</span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">metadata</span> <span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">Standard</span> <span class=\"string\">object&#x27;s</span> <span class=\"attr\">metadata. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"string\">ObjectMeta</span> <span class=\"string\">is</span> <span class=\"string\">metadata</span> <span class=\"string\">that</span> <span class=\"string\">all</span> <span class=\"string\">persisted</span> <span class=\"string\">resources</span> <span class=\"string\">must</span> <span class=\"string\">have,</span> <span class=\"string\">which</span></span><br><span class=\"line\">     <span class=\"string\">includes</span> <span class=\"string\">all</span> <span class=\"string\">objects</span> <span class=\"string\">users</span> <span class=\"string\">must</span> <span class=\"string\">create.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">annotations</span>\t<span class=\"string\">&lt;map[string]string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Annotations</span> <span class=\"string\">is</span> <span class=\"string\">an</span> <span class=\"string\">unstructured</span> <span class=\"string\">key</span> <span class=\"string\">value</span> <span class=\"string\">map</span> <span class=\"string\">stored</span> <span class=\"string\">with</span> <span class=\"string\">a</span> <span class=\"string\">resource</span> <span class=\"string\">that</span></span><br><span class=\"line\">     <span class=\"string\">may</span> <span class=\"string\">be</span> <span class=\"string\">set</span> <span class=\"string\">by</span> <span class=\"string\">external</span> <span class=\"string\">tools</span> <span class=\"string\">to</span> <span class=\"string\">store</span> <span class=\"string\">and</span> <span class=\"string\">retrieve</span> <span class=\"string\">arbitrary</span> <span class=\"string\">metadata.</span> <span class=\"string\">They</span></span><br><span class=\"line\">     <span class=\"string\">are</span> <span class=\"string\">not</span> <span class=\"string\">queryable</span> <span class=\"string\">and</span> <span class=\"string\">should</span> <span class=\"string\">be</span> <span class=\"string\">preserved</span> <span class=\"string\">when</span> <span class=\"string\">modifying</span> <span class=\"string\">objects.</span> <span class=\"string\">More</span></span><br><span class=\"line\">     <span class=\"attr\">info:</span> <span class=\"string\">http://kubernetes.io/docs/user-guide/annotations</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master2</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain pod.spec</span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">spec</span> <span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"attr\">Specification of the desired behavior of the pod. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#spec-and-status</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"string\">PodSpec</span> <span class=\"string\">is</span> <span class=\"string\">a</span> <span class=\"string\">description</span> <span class=\"string\">of</span> <span class=\"string\">a</span> <span class=\"string\">pod.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">activeDeadlineSeconds</span>\t<span class=\"string\">&lt;integer&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Optional</span> <span class=\"string\">duration</span> <span class=\"string\">in</span> <span class=\"string\">seconds</span> <span class=\"string\">the</span> <span class=\"string\">pod</span> <span class=\"string\">may</span> <span class=\"string\">be</span> <span class=\"string\">active</span> <span class=\"string\">on</span> <span class=\"string\">the</span> <span class=\"string\">node</span> <span class=\"string\">relative</span> <span class=\"string\">to</span></span><br><span class=\"line\">     <span class=\"string\">StartTime</span> <span class=\"string\">before</span> <span class=\"string\">the</span> <span class=\"string\">system</span> <span class=\"string\">will</span> <span class=\"string\">actively</span> <span class=\"string\">try</span> <span class=\"string\">to</span> <span class=\"string\">mark</span> <span class=\"string\">it</span> <span class=\"string\">failed</span> <span class=\"string\">and</span> <span class=\"string\">kill</span></span><br><span class=\"line\">     <span class=\"string\">associated</span> <span class=\"string\">containers.</span> <span class=\"string\">Value</span> <span class=\"string\">must</span> <span class=\"string\">be</span> <span class=\"string\">a</span> <span class=\"string\">positive</span> <span class=\"string\">integer.</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">affinity</span>\t<span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\">     <span class=\"string\">If</span> <span class=\"string\">specified,</span> <span class=\"string\">the</span> <span class=\"string\">pod&#x27;s</span> <span class=\"string\">scheduling</span> <span class=\"string\">constraints</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master2</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain pod.spec.containers </span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">containers</span> <span class=\"string\">&lt;[]Object&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">List</span> <span class=\"string\">of</span> <span class=\"string\">containers</span> <span class=\"string\">belonging</span> <span class=\"string\">to</span> <span class=\"string\">the</span> <span class=\"string\">pod.</span> <span class=\"string\">Containers</span> <span class=\"string\">cannot</span> <span class=\"string\">currently</span> <span class=\"string\">be</span></span><br><span class=\"line\">     <span class=\"string\">added</span> <span class=\"string\">or</span> <span class=\"string\">removed.</span> <span class=\"string\">There</span> <span class=\"string\">must</span> <span class=\"string\">be</span> <span class=\"string\">at</span> <span class=\"string\">least</span> <span class=\"string\">one</span> <span class=\"string\">container</span> <span class=\"string\">in</span> <span class=\"string\">a</span> <span class=\"string\">Pod.</span> <span class=\"string\">Cannot</span> <span class=\"string\">be</span></span><br><span class=\"line\">     <span class=\"string\">updated.</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"string\">A</span> <span class=\"string\">single</span> <span class=\"string\">application</span> <span class=\"string\">container</span> <span class=\"string\">that</span> <span class=\"string\">you</span> <span class=\"string\">want</span> <span class=\"string\">to</span> <span class=\"string\">run</span> <span class=\"string\">within</span> <span class=\"string\">a</span> <span class=\"string\">pod.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">args</span>\t<span class=\"string\">&lt;[]string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Arguments</span> <span class=\"string\">to</span> <span class=\"string\">the</span> <span class=\"string\">entrypoint.</span> <span class=\"string\">The</span> <span class=\"string\">docker</span> <span class=\"string\">image&#x27;s</span> <span class=\"string\">CMD</span> <span class=\"string\">is</span> <span class=\"string\">used</span> <span class=\"string\">if</span> <span class=\"string\">this</span> <span class=\"string\">is</span> <span class=\"string\">not</span></span><br><span class=\"line\">     <span class=\"string\">provided.</span> <span class=\"string\">Variable</span> <span class=\"string\">references</span> <span class=\"string\">$(VAR_NAME)</span> <span class=\"string\">are</span> <span class=\"string\">expanded</span> <span class=\"string\">using</span> <span class=\"string\">the</span></span><br><span class=\"line\">     <span class=\"string\">container&#x27;s</span> <span class=\"string\">environment.</span> <span class=\"string\">If</span> <span class=\"string\">a</span> <span class=\"string\">variable</span> <span class=\"string\">cannot</span> <span class=\"string\">be</span> <span class=\"string\">resolved,</span> <span class=\"string\">the</span> <span class=\"string\">reference</span> <span class=\"string\">in</span></span><br><span class=\"line\">     <span class=\"string\">the</span> <span class=\"string\">input</span> <span class=\"string\">string</span> <span class=\"string\">will</span> <span class=\"string\">be</span> <span class=\"string\">unchanged.</span> <span class=\"string\">The</span> <span class=\"string\">$(VAR_NAME)</span> <span class=\"string\">syntax</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">escaped</span></span><br><span class=\"line\">     <span class=\"string\">with</span> <span class=\"string\">a</span> <span class=\"string\">double</span> <span class=\"string\">$$,</span> <span class=\"attr\">ie:</span> <span class=\"string\">$$(VAR_NAME).</span> <span class=\"string\">Escaped</span> <span class=\"string\">references</span> <span class=\"string\">will</span> <span class=\"string\">never</span> <span class=\"string\">be</span></span><br><span class=\"line\">     <span class=\"string\">expanded,</span> <span class=\"string\">regardless</span> <span class=\"string\">of</span> <span class=\"string\">whether</span> <span class=\"string\">the</span> <span class=\"string\">variable</span> <span class=\"string\">exists</span> <span class=\"string\">or</span> <span class=\"string\">not.</span> <span class=\"string\">Cannot</span> <span class=\"string\">be</span></span><br><span class=\"line\">     <span class=\"attr\">updated. More info:</span></span><br><span class=\"line\">     <span class=\"string\">https://kubernetes.io/docs/tasks/inject-data-application/define-command-argument-container/#running-a-command-in-a-shell</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master2</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain pod.spec.containers.ports</span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">ports</span> <span class=\"string\">&lt;[]Object&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">List</span> <span class=\"string\">of</span> <span class=\"string\">ports</span> <span class=\"string\">to</span> <span class=\"string\">expose</span> <span class=\"string\">from</span> <span class=\"string\">the</span> <span class=\"string\">container.</span> <span class=\"string\">Exposing</span> <span class=\"string\">a</span> <span class=\"string\">port</span> <span class=\"string\">here</span> <span class=\"string\">gives</span> <span class=\"string\">the</span></span><br><span class=\"line\">     <span class=\"string\">system</span> <span class=\"string\">additional</span> <span class=\"string\">information</span> <span class=\"string\">about</span> <span class=\"string\">the</span> <span class=\"string\">network</span> <span class=\"string\">connections</span> <span class=\"string\">a</span> <span class=\"string\">container</span></span><br><span class=\"line\">     <span class=\"string\">uses,</span> <span class=\"string\">but</span> <span class=\"string\">is</span> <span class=\"string\">primarily</span> <span class=\"string\">informational.</span> <span class=\"string\">Not</span> <span class=\"string\">specifying</span> <span class=\"string\">a</span> <span class=\"string\">port</span> <span class=\"string\">here</span> <span class=\"string\">DOES</span> <span class=\"string\">NOT</span></span><br><span class=\"line\">     <span class=\"string\">prevent</span> <span class=\"string\">that</span> <span class=\"string\">port</span> <span class=\"string\">from</span> <span class=\"string\">being</span> <span class=\"string\">exposed.</span> <span class=\"string\">Any</span> <span class=\"string\">port</span> <span class=\"string\">which</span> <span class=\"string\">is</span> <span class=\"string\">listening</span> <span class=\"string\">on</span> <span class=\"string\">the</span></span><br><span class=\"line\">     <span class=\"string\">default</span> <span class=\"string\">&quot;0.0.0.0&quot;</span> <span class=\"string\">address</span> <span class=\"string\">inside</span> <span class=\"string\">a</span> <span class=\"string\">container</span> <span class=\"string\">will</span> <span class=\"string\">be</span> <span class=\"string\">accessible</span> <span class=\"string\">from</span> <span class=\"string\">the</span></span><br><span class=\"line\">     <span class=\"string\">network.</span> <span class=\"string\">Cannot</span> <span class=\"string\">be</span> <span class=\"string\">updated.</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"string\">ContainerPort</span> <span class=\"string\">represents</span> <span class=\"string\">a</span> <span class=\"string\">network</span> <span class=\"string\">port</span> <span class=\"string\">in</span> <span class=\"string\">a</span> <span class=\"string\">single</span> <span class=\"string\">container.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">containerPort</span>\t<span class=\"string\">&lt;integer&gt;</span> <span class=\"string\">-required-</span></span><br><span class=\"line\">     <span class=\"string\">Number</span> <span class=\"string\">of</span> <span class=\"string\">port</span> <span class=\"string\">to</span> <span class=\"string\">expose</span> <span class=\"string\">on</span> <span class=\"string\">the</span> <span class=\"string\">pod&#x27;s</span> <span class=\"string\">IP</span> <span class=\"string\">address.</span> <span class=\"string\">This</span> <span class=\"string\">must</span> <span class=\"string\">be</span> <span class=\"string\">a</span> <span class=\"string\">valid</span> <span class=\"string\">port</span></span><br><span class=\"line\">     <span class=\"string\">number,</span> <span class=\"number\">0</span> <span class=\"string\">&lt;</span> <span class=\"string\">x</span> <span class=\"string\">&lt;</span> <span class=\"number\">65536</span><span class=\"string\">.</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># vim pod2.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tomcat-cattt</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">activeDeadlineSeconds:</span> <span class=\"number\">10000</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span> <span class=\"comment\"># 对象列表下面字段需要有 -  </span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tomcat-doggg</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat:9.0</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span>  <span class=\"comment\"># always 总是从镜像仓库拉取镜像   ifnot 有就用，没有就拉</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"><span class=\"comment\"># metadat下面对齐需要一样，spec下面的对齐需要一样，但是metadata和spec下面的字段对齐不需要一样</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl apply -f pod2.yaml </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pod 常用命令</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl run mynginx --image=nginx --image-pull-policy=&#x27;IfNotPresent&#x27; --port=8080</span></span><br><span class=\"line\"></span><br><span class=\"line\">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">default                mynginx                                      1/1     Running   0          84s</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\">#kubectl describe pod</span></span><br><span class=\"line\">Events:</span><br><span class=\"line\">  Type    Reason     Age    From               Message</span><br><span class=\"line\">  ----    ------     ----   ----               -------</span><br><span class=\"line\">  Normal  Scheduled  2m17s  default-scheduler  Successfully assigned default/mynginx to node2</span><br><span class=\"line\">  Normal  Pulling    2m16s  kubelet            Pulling image <span class=\"string\">&quot;nginx&quot;</span></span><br><span class=\"line\">  Normal  Pulled     71s    kubelet            Successfully pulled image <span class=\"string\">&quot;nginx&quot;</span> <span class=\"keyword\">in</span> 1m5.193735599s</span><br><span class=\"line\">  Normal  Created    67s    kubelet            Created container mynginx</span><br><span class=\"line\">  Normal  Started    67s    kubelet            Started container mynginx</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># docker ps | grep mynginx </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pods -A</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -l app=tomcat</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod --show-labels</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除pod</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl delete pod mynginx -n default</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># yaml创建pod</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    run: mynginx</span><br><span class=\"line\">  name: mynginx</span><br><span class=\"line\"><span class=\"comment\">#  namespace: default</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - image: nginx</span><br><span class=\"line\">    name: mynginx</span><br><span class=\"line\">    </span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f pod.yml </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl delete -f pod.yml </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl logs -f mynginx </span></span><br><span class=\"line\">/docker-entrypoint.sh: /docker-entrypoint.d/ is not empty, will attempt to perform configuration</span><br><span class=\"line\">/docker-entrypoint.sh: Looking <span class=\"keyword\">for</span> shell scripts <span class=\"keyword\">in</span> /docker-entrypoint.d/</span><br><span class=\"line\">/docker-entrypoint.sh: Launching /docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span><br><span class=\"line\">10-listen-on-ipv6-by-default.sh: info: Getting the checksum of /etc/nginx/conf.d/default.conf</span><br><span class=\"line\">10-listen-on-ipv6-by-default.sh: info: Enabled listen on IPv6 <span class=\"keyword\">in</span> /etc/nginx/conf.d/default.conf</span><br><span class=\"line\">/docker-entrypoint.sh: Launching /docker-entrypoint.d/20-envsubst-on-templates.sh</span><br><span class=\"line\">/docker-entrypoint.sh: Launching /docker-entrypoint.d/30-tune-worker-processes.sh</span><br><span class=\"line\">/docker-entrypoint.sh: Configuration complete; ready <span class=\"keyword\">for</span> start up</span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: using the &quot;epoll&quot; event method</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: nginx/1.21.5</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) </span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: OS: Linux 3.10.0-1160.el7.x86_64</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: start worker processes</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: start worker process 31</span></span><br><span class=\"line\">2023/04/10 07:09:42 [notice] 1<span class=\"comment\">#1: start worker process 32</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 每个podk8s都会分配ip，保证k8s中所有应用都能访问到</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pod -owide </span></span><br><span class=\"line\">NAME      READY   STATUS    RESTARTS   AGE     IP              NODE    NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">mynginx   1/1     Running   0          3m55s   192.168.104.4   node2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"><span class=\"comment\"># 使用IP + Port访问</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># curl 192.168.104.4 </span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 进入pod</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl exec -it mynginx -- /bin/bash</span></span><br><span class=\"line\"><span class=\"comment\"># 进入pod指定的容器 -c</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl exec -it tomcat-cattt -c tomcat-doggg  -- /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">集群中的任意一个机器，任意一个应用都能通过pod分配的ip访问pod</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubectl get pods -l app=tomcat</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定位pod错误，查看describe和logs</span></span><br><span class=\"line\"></span><br><span class=\"line\">NAME      READY   STATUS        RESTARTS   AGE    IP               NODE    NOMINATED NODE   READINESS GATES</span><br><span class=\"line\">busybox   1/1     Terminating   0          127m   10.244.166.130   node1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">10.244网段只能在集群内访问</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># pod内部署多容器</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    run: myapp</span><br><span class=\"line\">  name: myapp</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - image: nginx</span><br><span class=\"line\">    name: nginx</span><br><span class=\"line\">  - image: tomcat:8.5.68</span><br><span class=\"line\">    name: tomcat</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># 同一pod内共享网络空间和存储</span></span><br><span class=\"line\">pod内只需要通过127.0.0.1即可访问</span><br><span class=\"line\"></span><br><span class=\"line\">pod内两个容器占用同一个端口会导致error</span><br></pre></td></tr></table></figure>\n<h2 id=\"labels\"><a class=\"markdownIt-Anchor\" href=\"#labels\">#</a> labels</h2>\n<p>标签其实就一对 key/value ，被关联到对象上，比如 Pod, 标签的使用我们倾向于能够表示对象的特殊特点，就是一眼就看出了这个 Pod 是干什么的，标签可以用来划分特定的对象（比如版本，服务类型等），标签可以在创建一个对象的时候直接定义，也可以在后期随时修改，每一个对象可以拥有多个标签，但是，key 值必须是唯一的。创建标签之后也可以方便我们对资源进行分组管理。如果对 pod 打标签，之后就可以使用标签来查看、删除指定的 pod。<br>\n在 k8s 中，大部分资源都可以打标签。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label pods tomcat release=v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod --show-labels </span></span><br><span class=\"line\">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">tomcat-cattt             1/1     Running   0          69m   app=tomcat</span><br><span class=\"line\">   </span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label pods tomcat-cattt hahaha=shabi</span></span><br><span class=\"line\">pod/tomcat-cattt labeled</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod --show-labels -n default</span></span><br><span class=\"line\">NAME                     READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">tomcat-cattt             1/1     Running   0          70m   app=tomcat,hahaha=shabi</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod tomcat-cattt  --show-labels -n default </span></span><br><span class=\"line\">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">tomcat-cattt   1/1     Running   0          72m   app=tomcat,hahaha=shabi</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -l hahaha   #-l指定标签的key</span></span><br><span class=\"line\">NAME           READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">tomcat-cattt   1/1     Running   0          72m</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -l hahaha --show-labels </span></span><br><span class=\"line\">NAME           READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">tomcat-cattt   1/1     Running   0          73m   app=tomcat,hahaha=shabi</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -L hahaha  # -L显示标签的key-value</span></span><br><span class=\"line\">NAME                     READY   STATUS    RESTARTS   AGE   HAHAHA</span><br><span class=\"line\">tomcat-cattt             1/1     Running   0          73m   shabi</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -L hahaha,app</span></span><br><span class=\"line\">NAME                     READY   STATUS    RESTARTS   AGE   HAHAHA   APP</span><br><span class=\"line\">tomcat-cattt             1/1     Running   0          74m   shabi    tomcat</span><br><span class=\"line\">tomcat-test              1/1     Running   0          21h            tomcat</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pods --all-namespaces --show-labels </span></span><br><span class=\"line\">NAMESPACE              NAME                                         READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">default                busybox                                      1/1     Running   0          46h   run=busybox</span><br><span class=\"line\">default                nginx-7f466444dc-8pbkp                       1/1     Running   0          23h   k8s-app=nginx,pod-template-hash=7f466444dc</span><br><span class=\"line\">default                nginx-7f466444dc-jbhpm                       1/1     Running   0          23h   k8s-app=nginx,pod-template-hash=7f466444dc</span><br><span class=\"line\">default                tomcat-cattt                                 1/1     Running   0          75m   app=tomcat,hahaha=shabi</span><br><span class=\"line\">default                tomcat-test                                  1/1     Running   0          21h   app=tomcat</span><br><span class=\"line\">kube-system            calico-kube-controllers-57c7b58f66-b7pw7     1/1     Running   0          46h   k8s-app=calico-kube</span><br></pre></td></tr></table></figure>\n<h2 id=\"node节点选择器\"><a class=\"markdownIt-Anchor\" href=\"#node节点选择器\">#</a> node 节点选择器</h2>\n<p>我们在创建 pod 资源的时候，pod 会根据 schduler 进行调度，那么默认会调度到随机的一个工作节点，如果我们想要 pod 调度到指定节点或者调度到一些具有相同特点的 node 节点，<br>\n可以使用 pod 中的 nodeName 或者 nodeSelector 字段指定要调度到的 node 节点</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用nodename调度pod</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: demo-pod</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">    <span class=\"built_in\">env</span>: dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  nodeName: master3   <span class=\"comment\"># 指定运行pod的node</span></span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name:  tomcat-pod-java</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat:9.0</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">  - name: busybox</span><br><span class=\"line\">    image: busybox:latest</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    <span class=\"built_in\">command</span>:    <span class=\"comment\"># 容器中必须有前台进程才不会启动后立即退出</span></span><br><span class=\"line\">    - <span class=\"string\">&quot;/bin/sh&quot;</span></span><br><span class=\"line\">    - <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">    - <span class=\"string\">&quot;sleep 3600&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># kubectl get pod -owide </span></span><br><span class=\"line\">default                demo-pod        2/2     Running   0          2m20s   10.244.136.2     master3   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 使用nodeselector调度pod</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: demo-pod-1</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">    <span class=\"built_in\">env</span>: dev</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  nodeSelector:</span><br><span class=\"line\">    disk: ceph</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name:  tomcat-pod-java</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat:9.0</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># kubectl get pod -owide</span></span><br><span class=\"line\">demo-pod-1                         0/1     Pending   0          17s     &lt;none&gt;          &lt;none&gt;              &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get nodes --show-labels </span></span><br><span class=\"line\">NAME      STATUS   ROLES                  AGE   VERSION   LABELS</span><br><span class=\"line\">master1   Ready    control-plane,master   47h   v1.20.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master1,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</span><br><span class=\"line\">master2   Ready    control-plane,master   47h   v1.20.6   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master2,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># apply -f 不能正常调度，因为所有的node都没有ceph的标签，pod状态为pending</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label nodes master1 disk=ceph</span></span><br><span class=\"line\">apply -f</span><br><span class=\"line\">0/4 nodes are available: 1 node(s) didn<span class=\"string\">&#x27;t match Pod&#x27;</span>s node affinity, 3 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn<span class=\"string\">&#x27;t tolerate.</span></span><br><span class=\"line\"><span class=\"string\">[root@master1 ~]# kubectl label nodes node1 disk=ceph</span></span><br><span class=\"line\"><span class=\"string\">[root@master1 ~]# kubectl apply -f </span></span><br><span class=\"line\"><span class=\"string\">demo-pod-1               1/1     Running   0       95s    10.244.166.139   node1     &lt;none&gt;           &lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 删除节点标签</span></span><br><span class=\"line\"><span class=\"string\">[root@master1 ~]# kubectl label nodes master1 disk-</span></span><br><span class=\"line\"><span class=\"string\">node/master1 labeled</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 只有nodename可以强行调度到master，nodeselector不能强行调度到master即使label匹配</span></span><br><span class=\"line\"><span class=\"string\"># kubectl delete -f x.yaml --force --grace-period=0  强行删除pod</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 同时使用nodename 和 nodeselector调度pod</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  nodeName: node2</span><br><span class=\"line\">  nodeSelector:</span><br><span class=\"line\">    disk: ceph</span><br><span class=\"line\"><span class=\"comment\"># nodename 和 nodeselector都存在的时候</span></span><br><span class=\"line\"><span class=\"comment\"># 如果其中有一个不匹配</span></span><br><span class=\"line\"><span class=\"comment\"># 会Predicate NodeAffinity failed 亲和性调度失败，因为两个标签不完全匹配</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 但是两个都是匹配时可以正常运行，比如node2中有disk:ceph的标签</span></span><br><span class=\"line\"><span class=\"comment\"># 并且由于nodeName优先级更高，如果master节点同时满足，也能调度到master节点(kubectl  v1.23.1)</span></span><br><span class=\"line\"></span><br><span class=\"line\">总结:同一个yaml文件里定义pod资源，如果同时定义了nodeName和NodeSelector，那么条件必须都满足才可以，有一个不满足都会调度失败</span><br></pre></td></tr></table></figure>\n<h2 id=\"节点亲和性-反亲和性\"><a class=\"markdownIt-Anchor\" href=\"#节点亲和性-反亲和性\">#</a> 节点亲和性、反亲和性</h2>\n<p><strong>node 节点亲和性调度：nodeAffinity</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl explain pods.spec.affinity</span></span><br><span class=\"line\">KIND:     Pod</span><br><span class=\"line\">VERSION:  v1</span><br><span class=\"line\"></span><br><span class=\"line\">RESOURCE: affinity &lt;Object&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">DESCRIPTION:</span><br><span class=\"line\">     If specified, the pod<span class=\"string\">&#x27;s scheduling constraints</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">     Affinity is a group of affinity scheduling rules.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">FIELDS:</span></span><br><span class=\"line\"><span class=\"string\">   nodeAffinity\t&lt;Object&gt;</span></span><br><span class=\"line\"><span class=\"string\">     Describes node affinity scheduling rules for the pod.</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   podAffinity\t&lt;Object&gt;</span></span><br><span class=\"line\"><span class=\"string\">     Describes pod affinity scheduling rules (e.g. co-locate this pod in the</span></span><br><span class=\"line\"><span class=\"string\">     same node, zone, etc. as some other pod(s)).</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   podAntiAffinity\t&lt;Object&gt;</span></span><br><span class=\"line\"><span class=\"string\">     Describes pod anti-affinity scheduling rules (e.g. avoid putting this pod</span></span><br><span class=\"line\"><span class=\"string\">     in the same node, zone, etc. as some other pod(s)).</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># node亲和性</span></span><br><span class=\"line\"><span class=\"string\">[root@prometheus-master ~]# kubectl explain pods.spec.affinity.nodeAffinity</span></span><br><span class=\"line\"><span class=\"string\">KIND:     Pod</span></span><br><span class=\"line\"><span class=\"string\">VERSION:  v1</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">FIELDS:</span></span><br><span class=\"line\"><span class=\"string\">   preferredDuringSchedulingIgnoredDuringExecution\t&lt;[]Object&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">   requiredDuringSchedulingIgnoredDuringExecution\t&lt;Object&gt;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">prefered表示有节点尽量满足这个位置定义的亲和性，这不是一个必须的条件，软亲和性</span></span><br><span class=\"line\"><span class=\"string\">require表示必须有节点满足这个位置定义的亲和性，这是个硬性条件，硬亲和性</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">可以使用operator字段来为Kubernetes设置在解释规则时要使用的逻辑操作符。你可以使用In、NotIn, Exists , DoesNotExist,Gt和Lt之一作为操作符。</span></span><br><span class=\"line\"><span class=\"string\">NotIn和 DoesNotExist可用来实现节点反亲和性行为。你也可以使用节点污点将Pod从特定节点上驱逐。</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"># 硬亲和性</span></span><br><span class=\"line\"><span class=\"string\">vim pod6.yaml</span></span><br><span class=\"line\"><span class=\"string\">apiVersion: v1</span></span><br><span class=\"line\"><span class=\"string\">kind: Pod</span></span><br><span class=\"line\"><span class=\"string\">metadata:</span></span><br><span class=\"line\"><span class=\"string\">  name: pod-affinity</span></span><br><span class=\"line\"><span class=\"string\">  namespace: default</span></span><br><span class=\"line\"><span class=\"string\">  labels:</span></span><br><span class=\"line\"><span class=\"string\">    app: myapp</span></span><br><span class=\"line\"><span class=\"string\">spec:</span></span><br><span class=\"line\"><span class=\"string\">  containers:</span></span><br><span class=\"line\"><span class=\"string\">  - name: pod-affinity</span></span><br><span class=\"line\"><span class=\"string\">    image: tomcat-8.5-jre8</span></span><br><span class=\"line\"><span class=\"string\">    imagePullPolicy: IfNotPresent</span></span><br><span class=\"line\"><span class=\"string\">  affinity:</span></span><br><span class=\"line\"><span class=\"string\">    nodeAffinity:</span></span><br><span class=\"line\"><span class=\"string\">      requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\"><span class=\"string\">        nodeSelectorTerms:</span></span><br><span class=\"line\"><span class=\"string\">        - matchExpressions:</span></span><br><span class=\"line\"><span class=\"string\">          - key: zone    # label key</span></span><br><span class=\"line\"><span class=\"string\">            operator: In   # condition</span></span><br><span class=\"line\"><span class=\"string\">            values:   # label value</span></span><br><span class=\"line\"><span class=\"string\">            - foo</span></span><br><span class=\"line\"><span class=\"string\">            - bar</span></span><br><span class=\"line\"><span class=\"string\">     </span></span><br><span class=\"line\"><span class=\"string\">由于初始没有node有zone这个label，所以会pending，一定有某个node被label对应的标签，pod会被立刻创建</span></span><br><span class=\"line\"><span class=\"string\">pod-affinity                       0/1     Pending   0             78s     &lt;none&gt;          prometheus-node2   </span></span><br><span class=\"line\"><span class=\"string\">pod-affinity                       0/1     ContainerCreating   0             78s     &lt;none&gt;          prometheus-node2   </span></span><br><span class=\"line\"><span class=\"string\">pod-affinity                       0/1     ContainerCreating   0             79s     &lt;none&gt;          prometheus-node2   </span></span><br><span class=\"line\"><span class=\"string\">pod-affinity                       1/1     Running             0             80s     10.244.64.44    prometheus-node2    </span></span><br><span class=\"line\"><span class=\"string\">由于是硬亲和性，因此如果没有node有对应的label就不调度</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">[root@master1 ~]# kubectl apply -f pod6.yaml </span></span><br><span class=\"line\"><span class=\"string\">0/4 nodes are available: 1 node(s) didn&#x27;</span>t match Pod<span class=\"string\">&#x27;s node affinity, 3 node(s) had taint &#123;node-role.kubernetes.io/master: &#125;, that the pod didn&#x27;</span>t tolerate.</span><br><span class=\"line\"><span class=\"comment\"># 必须在工作node上调度，他无法容忍master的污点。因此即使master有对应的label，pod也不会被调度</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 软亲和性</span></span><br><span class=\"line\">vim pod7.yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: pod-node-affinity-demo-2</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">    tier: frontend</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: myapp</span><br><span class=\"line\">    image: tomcat-8.5-jre8 </span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">  affinity:</span><br><span class=\"line\">    nodeAffinity:</span><br><span class=\"line\">      preferredDuringSchedulingIgnoredDuringExecution:</span><br><span class=\"line\">      - preference:</span><br><span class=\"line\">          matchExpressions: </span><br><span class=\"line\">          - key: zone1</span><br><span class=\"line\">            operator: In</span><br><span class=\"line\">            values:</span><br><span class=\"line\">            - foo1</span><br><span class=\"line\">            - bar1</span><br><span class=\"line\">        weight: 10</span><br><span class=\"line\">      - preference:</span><br><span class=\"line\">          matchExpressions:</span><br><span class=\"line\">          - key: zone2</span><br><span class=\"line\">            operator: In</span><br><span class=\"line\">            values:</span><br><span class=\"line\">            - foo2</span><br><span class=\"line\">            - bar2</span><br><span class=\"line\">        weight: 20</span><br><span class=\"line\"> <span class=\"comment\"># 软亲和性，如果没有node匹配label也会调度</span></span><br><span class=\"line\"> <span class=\"comment\"># prefer是软亲和性，可以设置weight，由多个preference时，会往weight高的node调度</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod </span></span><br><span class=\"line\">NAME                       READY   STATUS    RESTARTS   AGE</span><br><span class=\"line\">pod-node-affinity-demo-2   1/1     Running   0          5s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label nodes master1 zone1=foo1</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label nodes master2 zone2=foo2</span></span><br><span class=\"line\"><span class=\"comment\"># 这里prefer也无法忍受master的污点，所以即使有标签的weight他也不会往master上调度，但是如果多个node都有label，他会往weight高的label调度</span></span><br><span class=\"line\"> </span><br><span class=\"line\"><span class=\"comment\"># 去除标签</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl label nodes master2 zone2-</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 删除pod</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl delete -f pod7.yaml --force --grace-period=0</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl delete pods pod-affinity --force --grace-period=0</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>pod 节点亲和性</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">pod自身的亲和性调度有两种表示形式：</span></span><br><span class=\"line\"><span class=\"string\">podaffinity：pod和pod更倾向在一起，把相近的pod结合到相近的位置，如同一区域，同一机架，这样的话pod和pod之间更好通信，比方说有两个机房，这两个机房部署的集群有1000台主机，那么我们希望把nginx和tomcat都部署同一个地方的node节点上，可以提高通信效率；</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">podunaffinity：pod和pod更倾向不j在一起，如果部署两套程序，那么这两套程序更倾向于反亲和性，这样相互之间不会有影响。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">prefer：软亲和性</span></span><br><span class=\"line\"><span class=\"string\">required：硬亲和性</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">topologyKey：判断pod是否在同一位置</span></span><br><span class=\"line\"><span class=\"string\">位置拓扑的键，这个是必须字段</span></span><br><span class=\"line\"><span class=\"string\">怎么判断是不是同一个位置：</span></span><br><span class=\"line\"><span class=\"string\">rack=rack1</span></span><br><span class=\"line\"><span class=\"string\">row=row1</span></span><br><span class=\"line\"><span class=\"string\">使用rack的键是同一个位置</span></span><br><span class=\"line\"><span class=\"string\">使用row的键是同一个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">labelSelector：</span></span><br><span class=\"line\"><span class=\"string\">我们要判断pod跟别的pod亲和，跟哪个pod亲和，需要靠labelSelector，通过labelSelector选则一组能作为亲和对象的pod资源</span></span><br><span class=\"line\"><span class=\"string\">namespace：</span></span><br><span class=\"line\"><span class=\"string\">labelSelector需要选则一组资源，那么这组资源是在哪个名称空间中呢，通过namespace指定，如果不指定namespaces，那么就是当前创建pod的名称空间</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">pod8.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-first</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app2:</span> <span class=\"string\">myapp2</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span>  <span class=\"string\">tomcat-8.5-jre8</span> </span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">pod9.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-second</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">backend</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox:latest</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">affinity:</span></span><br><span class=\"line\">      <span class=\"attr\">podAffinity:</span></span><br><span class=\"line\">         <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"attr\">labelSelector:</span>   <span class=\"comment\"># 根具有那个标签的pod调度</span></span><br><span class=\"line\">              <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> &#123;<span class=\"attr\">key:</span> <span class=\"string\">app2</span>, <span class=\"attr\">operator:</span> <span class=\"string\">In</span>, <span class=\"attr\">values:</span> [<span class=\"string\">&quot;myapp2&quot;</span>]&#125;</span><br><span class=\"line\">           <span class=\"attr\">topologyKey:</span> <span class=\"string\">kubernetes.io/hostname</span>     <span class=\"comment\"># kubernetes.io/hostname相同的pod是一个位置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">pod-first</span>                <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">19m</span>    <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.145</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod-second</span>               <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">101s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.146</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">先判断标签是否一样，来决定pod是否调度到一起，在根据topologyKey决定调度到那个node</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果硬亲和label不满足，会pending状态</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-second</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">backend</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox:latest</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">affinity:</span></span><br><span class=\"line\">      <span class=\"attr\">podAffinity:</span></span><br><span class=\"line\">        <span class=\"attr\">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">weight:</span> <span class=\"number\">10</span></span><br><span class=\"line\">          <span class=\"attr\">podAffinityTerm:</span></span><br><span class=\"line\">            <span class=\"attr\">topologyKey:</span> <span class=\"string\">kubernetes.io/hostname</span></span><br><span class=\"line\">            <span class=\"attr\">labelSelector:</span></span><br><span class=\"line\">              <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> &#123;<span class=\"attr\">key:</span> <span class=\"string\">app1</span>, <span class=\"attr\">operator:</span> <span class=\"string\">In</span>, <span class=\"attr\">values:</span> [<span class=\"string\">&quot;myapp1&quot;</span>]&#125;</span><br><span class=\"line\"><span class=\"comment\"># 此时pod-second不满足软亲和性，依然可以调度，但是不会和pod-first调度到一起</span></span><br></pre></td></tr></table></figure>\n<p><strong>pod 反亲和性</strong></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">pod10.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-first</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app1:</span> <span class=\"string\">myapp1</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">tomcat-8.5-jre8</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      </span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pod -owide  -l app1=myapp1</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>        <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span>   <span class=\"string\">IP</span>               <span class=\"string\">NODE</span>    <span class=\"string\">NOMINATED</span> <span class=\"string\">NODE</span>   <span class=\"string\">READINESS</span> <span class=\"string\">GATES</span></span><br><span class=\"line\"><span class=\"string\">pod-first</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">28s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.147</span>   <span class=\"string\">node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">pod11.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-second</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">backend</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox:latest</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">affinity:</span></span><br><span class=\"line\">      <span class=\"attr\">podAntiAffinity:</span></span><br><span class=\"line\">         <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"attr\">labelSelector:</span></span><br><span class=\"line\">              <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> &#123;<span class=\"attr\">key:</span> <span class=\"string\">app1</span>, <span class=\"attr\">operator:</span> <span class=\"string\">In</span>, <span class=\"attr\">values:</span> [<span class=\"string\">&quot;myapp1&quot;</span>]&#125;</span><br><span class=\"line\">           <span class=\"attr\">topologyKey:</span> <span class=\"string\">kubernetes.io/hostname</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 只有一个work node的情况下：</span></span><br><span class=\"line\"><span class=\"string\">pod-first</span>                <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">4m26s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.147</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod-second</span>               <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>   <span class=\"number\">0</span>          <span class=\"string\">25s</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span>    <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"comment\"># 说明pod反亲和性也不能容忍master的污点，因为此时只有一个node，于是他pending了</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 如果存在多个工作节点，second会去找topologyKey的value值不同的节点</span></span><br><span class=\"line\"><span class=\"string\">pod-first</span>                          <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>             <span class=\"string\">52s</span>     <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.124</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod-second</span>                         <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>             <span class=\"string\">10s</span>     <span class=\"number\">10.244</span><span class=\"number\">.64</span><span class=\"number\">.48</span>     <span class=\"string\">prometheus-node2</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更换topologyKey</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">label</span> <span class=\"string\">node</span> <span class=\"string\">node1</span> <span class=\"string\">zone=foo</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">label</span> <span class=\"string\">node</span> <span class=\"string\">node2</span> <span class=\"string\">zone=foo</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">po12.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-first</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app3:</span> <span class=\"string\">myapp3</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">tomcat-8.5-jre8</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">pod13.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-second</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">backend</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox:latest</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">affinity:</span></span><br><span class=\"line\">      <span class=\"attr\">podAntiAffinity:</span></span><br><span class=\"line\">         <span class=\"attr\">requiredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">         <span class=\"bullet\">-</span> <span class=\"attr\">labelSelector:</span></span><br><span class=\"line\">              <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> &#123;<span class=\"attr\">key:</span> <span class=\"string\">app3</span> ,<span class=\"attr\">operator:</span> <span class=\"string\">In</span>, <span class=\"attr\">values:</span> [<span class=\"string\">&quot;myapp3&quot;</span>]&#125;</span><br><span class=\"line\">           <span class=\"attr\">topologyKey:</span>  <span class=\"string\">zone</span></span><br><span class=\"line\">           </span><br><span class=\"line\"><span class=\"string\">pod-first</span>                          <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>             <span class=\"string\">62s</span>     <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.125</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod-second</span>                         <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>   <span class=\"number\">0</span>             <span class=\"string\">5s</span>      <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span>             <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\">           </span><br><span class=\"line\"><span class=\"comment\"># topologyKey 相同时pod会认为这是同一个位置。因此pod-first在node1或node2上时，pod-second不会再这两个节点调度，他又无法忍受master污点，所以他pending了</span></span><br><span class=\"line\"><span class=\"comment\"># 如果在反亲和性这个位置把required改成preferred，那么也会运行。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-second</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">backend</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">db</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">busybox:latest</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">command:</span> [<span class=\"string\">&quot;sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">affinity:</span></span><br><span class=\"line\">      <span class=\"attr\">podAntiAffinity:</span></span><br><span class=\"line\">        <span class=\"attr\">preferredDuringSchedulingIgnoredDuringExecution:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">weight:</span> <span class=\"number\">10</span></span><br><span class=\"line\">          <span class=\"attr\">podAffinityTerm:</span></span><br><span class=\"line\">            <span class=\"attr\">topologyKey:</span> <span class=\"string\">zone</span></span><br><span class=\"line\">            <span class=\"attr\">labelSelector:</span></span><br><span class=\"line\">              <span class=\"attr\">matchExpressions:</span></span><br><span class=\"line\">              <span class=\"bullet\">-</span> &#123;<span class=\"attr\">key:</span> <span class=\"string\">app3</span>, <span class=\"attr\">operator:</span> <span class=\"string\">In</span>, <span class=\"attr\">values:</span> [<span class=\"string\">&quot;myapp3&quot;</span>]&#125;</span><br><span class=\"line\"><span class=\"string\">pod-first</span>                          <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>             <span class=\"string\">6m43s</span>   <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.125</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">pod-second</span>                         <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>             <span class=\"string\">21s</span>     <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.126</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>podaffinity：pod 节点亲和性，pod 倾向于哪个 pod</strong><br>\n<strong>podantiaffinity:pod 反亲和性</strong><br>\n<strong> nodeaffinity：node 节点亲和性，pod 倾向于哪个 node</strong></p>\n<h2 id=\"污点容忍度\"><a class=\"markdownIt-Anchor\" href=\"#污点容忍度\">#</a> 污点，容忍度</h2>\n<p>给了节点选则的主动权，我们给节点打一个污点，不容忍的 pod 就运行不上来，污点就是定义在节点上的键值属性数据，可以定决定拒绝那些 pod；<br>\ntaints 是键值数据，用在节点上，定义污点；</p>\n<p>tolerations 是键值数据，用在 pod 上，定义容忍度，能容忍哪些污点</p>\n<p>pod 亲和性是 pod 属性；但是污点是 node 的属性，污点定义在 k8s 集群的节点上的一个字段</p>\n<p>master 上会有污点<br>\n <code>Taints:             node-role.kubernetes.io/master:NoSchedule</code></p>\n<p>taints 的 effect 用来定义对 pod 对象的排斥等级（效果）：</p>\n<blockquote>\n<p><code>NoSchedule：</code> <br>\n仅影响 pod 调度过程，当 pod 能容忍这个节点污点，就可以调度到当前节点，后来这个节点的污点改了，加了一个新的污点，使得之前调度的 pod 不能容忍了，那这个 pod 会怎么处理，对现存的 pod 对象不产生影响</p>\n<p><code>NoExecute：</code> <br>\n既影响调度过程，又影响现存的 pod 对象，如果现存的 pod 不能容忍节点后来加的污点，这个 pod 就会被驱逐</p>\n<p><code>PreferNoSchedule：</code> <br>\n最好不，也可以，是 NoSchedule 的柔性版本</p>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pod -n kube-system -owide | grep master1</span></span><br><span class=\"line\">calico-node-mptp2                          1/1     Running   1          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-7f89b7bc75-gtmmh                   1/1     Running   1          5d4h   10.244.137.67    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">coredns-7f89b7bc75-hc7ns                   1/1     Running   1          5d4h   10.244.137.68    master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">etcd-master1                               1/1     Running   3          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-apiserver-master1                     1/1     Running   5          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-controller-manager-master1            1/1     Running   2          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-proxy-t9td4                           1/1     Running   1          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">kube-scheduler-master1                     1/1     Running   2          5d4h   192.168.13.177   master1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 由于定义了Tolerations，上面这些pod能容忍master的污点</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl describe pods -n kube-system kube-apiserver-master1 </span></span><br><span class=\"line\">Tolerations:       :NoExecute op=Exists</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># exist NoExecute的trait等级要比NoSchedule高，能容忍NoExecute一定能容忍NoSchedule和PreferNoSchedule</span></span><br><span class=\"line\"><span class=\"comment\"># op=exist 情况下 排斥等级可以理解为 NoExecute &gt; NoSchedule &gt; PreferNoSchedule</span></span><br><span class=\"line\"><span class=\"comment\"># equal是严格比配，不能有exist跨级匹配</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl taint node node1 node-type=prod:NoSchedule</span></span><br><span class=\"line\">node/node1 tainted</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">vim pod14.yaml</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: taint-pod</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    tomcat:  tomcat-pod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name:  taint-pod</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat-8.5-jre8</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    </span><br><span class=\"line\">taint-pod                          1/1     Running   0             3s      10.244.216.127   prometheus-node1   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">重新创建pod，pod无法忍受node1的污点</span><br><span class=\"line\">taint-pod                          1/1     Running   0             4s      10.244.64.49   prometheus-node2   &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># NoExecute污点，没有定义容忍度的pod会被驱逐</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl taint node node1 node-type=dev:NoExecute</span></span><br><span class=\"line\">default                nginx-7f466444dc-klcl9                       1/1     Terminating   0          4m32s   10.244.166.152   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">vim pod15.yaml</span><br><span class=\"line\"><span class=\"comment\"># 定义容忍度为NoExecute</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: myapp-deploy</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">    release: canary</span><br><span class=\"line\">spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: myapp</span><br><span class=\"line\">        image: tomcat-8.5-jre8</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - name: http</span><br><span class=\"line\">          containerPort: 8080</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: <span class=\"string\">&quot;node-type&quot;</span></span><br><span class=\"line\">        operator: <span class=\"string\">&quot;Equal&quot;</span></span><br><span class=\"line\">        value: <span class=\"string\">&quot;dev&quot;</span></span><br><span class=\"line\">        effect: <span class=\"string\">&quot;NoExecute&quot;</span></span><br><span class=\"line\">        tolerationSeconds: 3600</span><br><span class=\"line\"><span class=\"comment\"># 此时等值匹配情况下，只有能忍受node-type=dev:NoExecute 的node可以被调度</span></span><br><span class=\"line\">myapp-deploy             1/1     Running   0          2m27s   10.244.166.154   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对于equals等值匹配，能容忍noexecute也不能容忍noschedule，因为是严格等值匹配</span></span><br><span class=\"line\"><span class=\"comment\"># 保持pod容忍不变，改变node污点为noschedule</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl taint node node1 node-type=dev:NoSchedule</span></span><br><span class=\"line\">myapp-deploy             0/1     Pending   0          3s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 定义容忍度为NoSchedule</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: myapp-deploy</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">    release: canary</span><br><span class=\"line\">spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: myapp</span><br><span class=\"line\">        image: tomcat-8.5-jre8</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - name: http</span><br><span class=\"line\">          containerPort: 8080</span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: <span class=\"string\">&quot;node-type&quot;</span></span><br><span class=\"line\">        operator: <span class=\"string\">&quot;Equal&quot;</span></span><br><span class=\"line\">        value: <span class=\"string\">&quot;dev&quot;</span></span><br><span class=\"line\">        effect: <span class=\"string\">&quot;NoSchedule&quot;</span></span><br><span class=\"line\">myapp-deploy             1/1     Running   0          28s    10.244.166.157   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对于noschedule，不需要定义容忍时间(tolerationSeconds)，因为不会驱逐原有pod</span></span><br><span class=\"line\"><span class=\"comment\"># noexecute如果有新的污点pod不能忍受，经过tolerationSeconds  pod会被驱逐</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 以下为exists特性：</span></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: <span class=\"string\">&quot;node-type&quot;</span></span><br><span class=\"line\">        operator: <span class=\"string\">&quot;Exists&quot;</span></span><br><span class=\"line\">        value: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        effect: <span class=\"string\">&quot;NoSchedule&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 可以不写value，只要key和effect匹配就行</span></span><br><span class=\"line\"></span><br><span class=\"line\">      tolerations:</span><br><span class=\"line\">      - key: <span class=\"string\">&quot;node-type&quot;</span></span><br><span class=\"line\">        operator: <span class=\"string\">&quot;Exists&quot;</span></span><br><span class=\"line\">        value: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        effect: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\"><span class=\"comment\"># 可以容忍key匹配的一切污点</span></span><br><span class=\"line\">myapp-deploy             1/1     Running   0          6s     10.244.166.158   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">当某种条件为真时，节点控制器会自动给节点添加一个污点。当前内置的污点包括：</span><br><span class=\"line\"></span><br><span class=\"line\">node.kubernetes.io/not-ready：节点未准备好。这相当于节点状况 Ready 的值为 &quot;False&quot;。</span><br><span class=\"line\">node.kubernetes.io/unreachable：节点控制器访问不到节点. 这相当于节点状况 Ready 的值为 &quot;Unknown&quot;。</span><br><span class=\"line\">node.kubernetes.io/memory-pressure：节点存在内存压力。</span><br><span class=\"line\">node.kubernetes.io/disk-pressure：节点存在磁盘压力。</span><br><span class=\"line\">node.kubernetes.io/pid-pressure: 节点的 PID 压力。</span><br><span class=\"line\">node.kubernetes.io/network-unavailable：节点网络不可用。</span><br><span class=\"line\">node.kubernetes.io/unschedulable: 节点不可调度。</span><br><span class=\"line\">node.cloudprovider.kubernetes.io/uninitialized：如果 kubelet 启动时指定了一个“外部”云平台驱动， 它将给当前节点添加一个污点将其标志为不可用。在 cloud-controller-manager 的一个控制器初始化这个节点后，kubelet 将删除这个污点。</span><br><span class=\"line\">在节点被驱逐时，节点控制器或者 kubelet 会添加带有 NoExecute 效果的相关污点。 如果异常状态恢复正常，kubelet 或节点控制器能够移除相关的污点。</span><br><span class=\"line\"></span><br><span class=\"line\">在某些情况下，当节点不可达时，API 服务器无法与节点上的 kubelet 进行通信。 在与 API 服务器的通信被重新建立之前，删除 Pod 的决定无法传递到 kubelet。 同时，被调度进行删除的那些 Pod 可能会继续运行在分区后的节点上。</span><br><span class=\"line\"></span><br><span class=\"line\">这些值都可以修改，比如在内存剩余不足指定数量后会自动打上node.kubernetes.io/disk-pressure的污点，且不能手工删除，除非空出指定大小的内存之后</span><br></pre></td></tr></table></figure>\n<h2 id=\"pod常见状态和重启策略\"><a class=\"markdownIt-Anchor\" href=\"#pod常见状态和重启策略\">#</a> pod 常见状态和重启策略</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430215552262.png\" alt=\"image-20230430215552262\"></p>\n<blockquote>\n<p>第一阶段：<br>\n挂起（ <code>Pending</code> ）：<br>\n1、正在创建 Pod 但是 Pod 中的容器还没有全部被创建完成，处于此状态的 Pod 应该检查 Pod 依赖的存储是否有权限挂载、镜像是否可以下载、调度是否正常等</p>\n<p>2、我们在请求创建 pod 时，条件不满足，调度没有完成，没有任何一个节点能满足调度条件，已经创建了 pod 但是没有适合它运行的节点叫做挂起，调度没有完成。</p>\n<p>失败（ <code>Failed</code> ）：Pod 中的所有容器都已终止了，并且至少有一个容器是因为失败终止。也就是说，容器以非 0 状态退出或者被系统终止。</p>\n<p>未知（ <code>Unknown</code> ）：未知状态，所谓 pod 是什么状态是 apiserver 和运行在 pod 节点的 kubelet 进行通信获取状态信息的，如果节点之上的 kubelet 本身出故障，那么 apiserver 就连不上 kubelet，得不到信息了，就会看 Unknown，通常是由于与 pod 所在的 node 节点通信错误。</p>\n<p><code>Error</code>  状态：Pod 启动过程中发生了错误</p>\n<p>成功（ <code>Succeeded</code> ）：Pod 中的所有容器都被成功终止，即 pod 里所有的 containers 均已 terminated。</p>\n<p>第二阶段：<br>\n <code>Unschedulable</code> ：Pod 不能被调度， scheduler 没有匹配到合适的 node 节点</p>\n<p><code>PodScheduled</code> ：pod 正处于调度中，在 scheduler 刚开始调度的时候，还没有将 pod 分配到指定的 node，在筛选出合适的节点后就会更新 etcd 数据，将 pod 分配到指定的 node</p>\n<p><code>Initialized</code> ：所有 pod 中的初始化容器已经完成了</p>\n<p><code>ImagePullBackOff</code> ：Pod 所在的 node 节点下载镜像失败</p>\n<p><code>Running</code> ：Pod 内部的容器已经被创建并且启动。</p>\n<p><code>Ready</code></p>\n<p>扩展：还有其他状态，如下：</p>\n<p><code>Evicted</code>  状态：出现这种情况，多见于系统内存或硬盘资源不足，可 df-h 查看 docker 存储所在目录的资源使用情况，如果百分比大于 85%，就要及时清理下资源，尤其是一些大文件、docker 镜像。</p>\n<p>CrashLoopBackOff：容器曾经启动了，但可能又异常退出了</p>\n<p>查看内存，CPU，磁盘：</p>\n<p>free -mh</p>\n<p>top</p>\n<p>df -hl</p>\n<p>kubectl describe pod_name</p>\n<p>kubectl logs pod_name</p>\n</blockquote>\n<p><strong>Pod 重启策略</strong></p>\n<blockquote>\n<p>Pod 的重启策略（RestartPolicy）应用于 Pod 内的所有容器，当某个容器异常退出或者健康检查失败时，kubelet 将根据 重启策略来进行相应的操作。</p>\n<p>Pod 的 spec 中包含一个 restartPolicy 字段，其可能取值包括 Always、OnFailure 和 Never。默认值是 Always。</p>\n<p>Always：只要容器异常退出，kubelet 就会自动重启该容器。（这个是默认的重启策略）</p>\n<p>OnFailure：当容器终止运行且退出码不为 0 时，由 kubelet 自动重启该容器。</p>\n<p>Never：不论容器运行状态如何，kubelet 都不会重启该容器。</p>\n<p>(重启的不是 pod，是 pod 中的容器)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">name: demo-pod</span><br><span class=\"line\">namespace: default</span><br><span class=\"line\">labels:</span><br><span class=\"line\"> app: myapp</span><br><span class=\"line\">spec:</span><br><span class=\"line\">restartPolicy: Always</span><br><span class=\"line\">containers:</span><br><span class=\"line\">  - name:  tomcat-pod-java</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 8080</span><br><span class=\"line\">    image: tomcat-8.5-jre8</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl exec -it demo-pod -- /bin/bash</span><br><span class=\"line\">/usr/local/tomcat/bin/shutdown.sh</span><br><span class=\"line\"># always - complete - 重启</span><br><span class=\"line\"># onFailure - complete - 不会重启</span><br><span class=\"line\"># never - complete状态，不会重启</span><br><span class=\"line\"></span><br><span class=\"line\">kill 1</span><br><span class=\"line\"># always error - 立刻重启</span><br><span class=\"line\"># onFailure - error - 重启</span><br><span class=\"line\"># never - error - 不重启</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"pod生命周期\"><a class=\"markdownIt-Anchor\" href=\"#pod生命周期\">#</a> pod 生命周期</h2>\n<p>pod 从开始创建到终止退出的时间范围称为 Pod 生命周期</p>\n<p>生命周期包含以下几个重要流程：<br>\n创建主容器（containers）是必须的操作，初始化容器（initContainers），容器启动后钩子，启动探测、存活性探测，就绪性探测，容器停止前钩子。</p>\n<p>其中 initcontainers、容器启动后钩子、探测、容器终止前钩子这些是可选项 -</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430224431424.png\" alt=\"image-20230430224431424\"></p>\n<p><strong>pod 在整个生命周期的过程中总会处于以下几个状态：</strong></p>\n<blockquote>\n<p>Pending：创建了 pod 资源并存入 etcd 中，但尚未完成调度。</p>\n<p>ContainerCreating：Pod 的调度完成，被分配到指定 Node 上。处于容器创建的过程中。通常是在拉取镜像的过程中。</p>\n<p>Running：Pod 包含的所有容器都已经成功创建，并且成功运行起来。</p>\n<p>Succeeded：Pod 中的所有容器都已经成功终止并且不会被重启（重启策略是 never）</p>\n<p>Failed：所有容器都已经终止，但至少有一个容器终止失败，也就是说容器返回了非 0 值的退出状态或已经被系统终止。</p>\n<p>Unknown：因为某些原因无法取得 Pod 的状态。这种情况通常是因为与 Pod 所在主机通信失败。</p>\n</blockquote>\n<p><strong>pod 生命周期的重要行为：</strong></p>\n<blockquote>\n<p>1、在启动任何容器之前，先创建 pause 基础容器，它初始化 Pod 的环境并为后续加⼊的容器提供共享的名称空间。</p>\n<p>2. 初始化容器（initcontainer）：</p>\n<p>一个 pod 可以拥有任意数量的 init 容器。init 容器是按照顺序以此执行的，并且仅当最后一个 init 容器执行完毕才会去启动主容器。</p>\n<p>3. 生命周期钩子：</p>\n<p>pod 允许定义两种类型的生命周期钩子，启动后 (post-start) 钩子和停止前 (pre-stop) 钩子</p>\n<p>这些生命周期钩子是基于每个容器来指定的，和 init 容器不同的是，init 容器是应用到整个 pod。而这些钩子是针对容器的，是在容器启动后和停止前执行的。比如启动时复制文件到容器中，结束后发送信息到监控</p>\n<p>4. 容器探测：</p>\n<p>对 Pod 健康状态诊断。分为三种： Startupprobe、Livenessprobe (存活性探测)， Readinessprobe (就绪性检测)</p>\n<p>Startup（启动探测）: 探测容器是否正常运行</p>\n<p>Liveness (存活性探测)：判断容器是否处于 runnning 状态，根据重启策略决定是否重启容器</p>\n<p>Readiness (就绪性检测)：判断容器是否准备就绪并对外提供服务，将容器设置为不可用，不接受 service 转发的请求</p>\n</blockquote>\n<p><strong>三种探针用于 Pod 检测：</strong></p>\n<blockquote>\n<p>ExecAction：在容器中执行一个命令，并根据返回的状态码进行诊断，只有返回 0 为成功</p>\n<p>TCPSocketAction：通过与容器的某 TCP 端口尝试建立连接</p>\n<p>HTTPGetAction：通过向容器 IP 地址的某指定端口的 path 发起 HTTP GET 请求。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230430230843299.png\" alt=\"image-20230430230843299\"></p>\n<p>6.pod 的终止过程</p>\n<blockquote>\n<p>终止过程主要分为如下几个步骤：</p>\n<p>(1) 用户发出删除 pod 命令：kubectl delete pods ，kubectl delete -f yaml</p>\n<p>(2) Pod 对象随着时间的推移更新，在宽限期（默认情况下 30 秒），pod 被视为 “dead” 状态</p>\n<p>(3) 将 pod 标记为 “Terminating” 状态</p>\n<p>(4) 第三步同时运行，监控到 pod 对象为 “Terminating” 状态的同时启动 pod 关闭过程</p>\n<p>(5) 第三步同时进行，endpoints 控制器监控到 pod 对象关闭，将 pod 与 service 匹配的 endpoints 列表中删除</p>\n<p>(6) 如果 pod 中定义了 preStop 钩子处理程序，则 pod 被标记为 “Terminating” 状态时以同步的方式启动执行；若宽限期结束后，preStop 仍未执行结束，第二步会重新执行并额外获得一个 2 秒的小宽限期</p>\n<p>(7) Pod 内对象的容器收到 TERM 信号</p>\n<p>(8) 宽限期结束之后，若存在任何一个运行的进程，pod 会收到 SIGKILL 信号</p>\n<p>(9) Kubelet 请求 API Server 将此 Pod 资源宽限期设置为 0 从而完成删除操作</p>\n</blockquote>\n<h3 id=\"initcontainer\"><a class=\"markdownIt-Anchor\" href=\"#initcontainer\">#</a> initcontainer</h3>\n<p>spec 字段下有个 initContainers 字段 (初始化容器)，Init 容器就是做初始化工作的容器。可以有一个或多个，如果多个按照定义的顺序依次执行，先执行初始化容器 1，再执行初始化容器 2 等，等初始化容器执行完具体操作之后初始化容器就退出了，只有所有的初始化容器执行完后，主容器才启动。</p>\n<p>由于一个 Pod 里容器存储卷是共享的，所以 Init Container 里产生的数据可以被主容器使用到，Init Container 可以在多种 K8S 资源里被使用到，如 Deployment、DaemonSet, StatefulSet、Job 等，但都是在 Pod 启动时，在主容器启动前执行，做初始化工作。</p>\n<p>初始化容器与主容器区别是:<br>\n1、初始化容器不支持 Readinessprobe, 因为它们必须在 Pod 就绪之前运行完成<br>\n 2、每个 Init 容器必须运行成功，下一个才能够运行</p>\n<p>初始化容器的官方地址：<br>\n<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMvaW5pdC1jb250YWluZXJzLyNpbml0LWNvbnRhaW5lcnMtaW4tdXNl\">https://kubernetes.io/docs/concepts/workloads/pods/init-containers/#init-containers-in-use</span></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: myapp-pod</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: myapp</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  initContainers:</span><br><span class=\"line\">  - name: init-myservice</span><br><span class=\"line\">    image: busybox:1.28</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&#x27;sh&#x27;</span>, <span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&quot;until nslookup myservice.<span class=\"subst\">$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>.svc.cluster.local; do echo waiting for myservice; sleep 2; done&quot;</span>]</span><br><span class=\"line\">  - name: init-mydb</span><br><span class=\"line\">    image: busybox:1.28</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&#x27;sh&#x27;</span>, <span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&quot;until nslookup mydb.<span class=\"subst\">$(cat /var/run/secrets/kubernetes.io/serviceaccount/namespace)</span>.svc.cluster.local; do echo waiting for mydb; sleep 2; done&quot;</span>]</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: myapp-container</span><br><span class=\"line\">    image: busybox:1.28</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [<span class=\"string\">&#x27;sh&#x27;</span>, <span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&#x27;echo The app is running! &amp;&amp; sleep 3600&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">myapp-pod                0/1     Init:0/2   0          4s</span><br><span class=\"line\">由于两个初始化容器一直无法解析nslookup的域名，导致主容器一致不会创建</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 初始化容器拉取百度页面，主容器使用</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: initnginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  initContainers:</span><br><span class=\"line\">  - name: install</span><br><span class=\"line\">    image: docker.io/library/busybox:1.28</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    <span class=\"built_in\">command</span>:</span><br><span class=\"line\">    - wget</span><br><span class=\"line\">    - <span class=\"string\">&quot;-O&quot;</span></span><br><span class=\"line\">    - <span class=\"string\">&quot;/work-dir/index.html&quot;</span></span><br><span class=\"line\">    - <span class=\"string\">&quot;https://www.baidu.com&quot;</span></span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: workdir</span><br><span class=\"line\">      mountPath: /work-dir</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: nginx</span><br><span class=\"line\">    image: nginx</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - containerPort: 80</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: workdir</span><br><span class=\"line\">      mountPath: /usr/share/nginx/html</span><br><span class=\"line\">  dnsPolicy: Default</span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: workdir</span><br><span class=\"line\">    emptyDir: &#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># curl 10.244.166.161</span></span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;!--STATUS OK--&gt;&lt;html&gt; &lt;<span class=\"built_in\">head</span>&gt;&lt;meta http-equiv=content-type content=text/html;charset=utf-8&gt;&lt;meta http-equiv=X-UA-Compatible content=IE=Edge&gt;&lt;meta content=always name=referrer&gt;&lt;<span class=\"built_in\">link</span> rel=stylesheet <span class=\"built_in\">type</span>=text/css href=https://ss1.bdstatic.com/5eN1bjq8AAUYm2zgoY3K/r/www/cache/bdorz/baidu.min.css&gt;&lt;title&gt;百度一下，你就知道&lt;/title&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"主容器\"><a class=\"markdownIt-Anchor\" href=\"#主容器\">#</a> 主容器</h3>\n<p>1、容器钩子</p>\n<p>初始化容器启动之后，开始启动主容器，在主容器启动之后有一个 post start hook（容器启动后钩子）和 pre stop hook（容器结束前钩子），无论启动后还是结束前所做的事我们可以把它放两个钩子，这个钩子就表示用户可以用它来钩住一些命令，非必须选项</p>\n<p>postStart：该钩子在容器被创建后立刻执行，如果该钩子对应的探测执行失败，则该容器会被杀死，并根据该容器的重启策略决定是否要重启该容器，这个钩子不需要传递任何参数。</p>\n<p>preStop：该钩子在容器被删除前执行，主要用于释放资源和优雅关闭程序</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">containers:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">sample:v2</span>  </span><br><span class=\"line\">     <span class=\"attr\">name:</span> <span class=\"string\">war</span></span><br><span class=\"line\">     <span class=\"string\">lifecycle：</span></span><br><span class=\"line\">      <span class=\"attr\">postStart:</span></span><br><span class=\"line\">       <span class=\"attr\">exec:</span></span><br><span class=\"line\">         <span class=\"attr\">command:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">&quot;cp&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">&quot;/sample.war&quot;</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">&quot;/app&quot;</span></span><br><span class=\"line\">      <span class=\"attr\">prestop:</span></span><br><span class=\"line\">       <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">        <span class=\"attr\">host:</span> <span class=\"string\">monitor.com</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/waring</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br></pre></td></tr></table></figure>\n<p>以上示例中，定义了一个 Pod，包含一个 JAVA 的 web 应用容器，其中设置了 PostStart 和 PreStop 回调函数。即在容器创建成功后，复制 /sample.war 到 /app 文件夹中。而在容器终止之前，发送 HTTP 请求到 http://monitor.com:8080/waring，即向监控系统发送警告。</p>\n<p>优雅的删除资源对象</p>\n<p>当用户请求删除含有 pod 的资源对象时（如 RC、deployment 等），K8S 为了让应用程序优雅关闭（即让应用程序完成正在处理的请求后，再关闭软件），K8S 提供两种信息通知：</p>\n<p>1）、默认：K8S 通知 node 执行 docker stop 命令，docker 会先向容器中 PID 为 1 的进程发送系统信号 SIGTERM，然后等待容器中的应用程序终止执行，如果等待时间达到设定的超时时间，或者默认超时时间（30s），会继续发送 SIGKILL 的系统信号强行 kill 掉进程。</p>\n<p>2）、使用 pod 生命周期（利用 PreStop 回调函数），它执行在发送终止信号之前。<br>\n默认情况下，所有的删除操作的优雅退出时间都在 30 秒以内。kubectl delete 命令支持–grace-period = 的选项，以运行用户来修改默认值。0 表示删除立即执行，并且立即从 API 中删除 pod。在节点上，被设置了立即结束的的 pod，仍然会给一个很短的优雅退出时间段，才会开始被强制杀死。如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">centos:nginx</span></span><br><span class=\"line\">    <span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">      <span class=\"attr\">preStop:</span></span><br><span class=\"line\">        <span class=\"attr\">exec:</span></span><br><span class=\"line\">          <span class=\"comment\"># nginx -s quit gracefully terminate while SIGTERM triggers a quick exit</span></span><br><span class=\"line\">          <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/usr/local/nginx/sbin/nginx&quot;</span>,<span class=\"string\">&quot;-s&quot;</span>,<span class=\"string\">&quot;quit&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">        <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">life-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">lifecycle-demo-container</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">      <span class=\"attr\">postStart:</span></span><br><span class=\"line\">         <span class=\"attr\">exec:</span></span><br><span class=\"line\">           <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;echo &#x27;lifecycle hookshandler&#x27; &gt; /usr/share/nginx/html/test.html&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">preStop:</span></span><br><span class=\"line\">         <span class=\"attr\">exec:</span></span><br><span class=\"line\">           <span class=\"attr\">command:</span></span><br><span class=\"line\">           <span class=\"bullet\">-</span> <span class=\"string\">&quot;/bin/sh&quot;</span></span><br><span class=\"line\">           <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">           <span class=\"bullet\">-</span> <span class=\"string\">&quot;nginx -s stop&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">pod</span>]<span class=\"comment\"># kubectl exec -it life-demo -- /bin/bash </span></span><br><span class=\"line\"><span class=\"string\">root@life-demo:/#</span> <span class=\"string\">ls</span> <span class=\"string\">/usr/share/nginx/html/</span></span><br><span class=\"line\"><span class=\"string\">50x.html</span>  <span class=\"string\">index.html</span>  <span class=\"string\">test.html</span></span><br><span class=\"line\"><span class=\"string\">root@life-demo:/#</span> <span class=\"string\">cat</span> <span class=\"string\">/usr/share/nginx/html/test.html</span> </span><br><span class=\"line\"><span class=\"string\">lifecycle</span> <span class=\"string\">hookshandler</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">event</span></span><br><span class=\"line\"><span class=\"string\">0s</span>          <span class=\"string\">Normal</span>    <span class=\"string\">Killing</span>          <span class=\"string\">pod/life-demo</span>                          <span class=\"string\">Stopping</span> <span class=\"string\">container</span> <span class=\"string\">lifecycle-demo-container</span></span><br><span class=\"line\"><span class=\"string\">0s</span>          <span class=\"string\">Normal</span>    <span class=\"string\">Killing</span>          <span class=\"string\">pod/life-demo</span>                          <span class=\"string\">Stopping</span> <span class=\"string\">container</span> <span class=\"string\">lifecycle-demo-container</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>pod 在整个生命周期中有非常多的用户行为：</p>\n<p>1、初始化容器完成初始化</p>\n<p>2、主容器启动后可以做启动后钩子</p>\n<p>3、主容器结束前可以做结束前钩子</p>\n<p>4、在主容器运行中可以做一些健康检测，如 startupprobe、livenessprobe，readnessprobe</p>\n<h2 id=\"容器探测\"><a class=\"markdownIt-Anchor\" href=\"#容器探测\">#</a> 容器探测</h2>\n<p>在 Kubernetes 中 Pod 是最小的计算单元，而一个 Pod 又由多个容器组成，相当于每个容器就是一个应用，应用在运行期间，可能因为某些意外情况致使程序挂掉。那么如何监控这些容器状态稳定性，保证服务在运行期间不会发生问题，发生问题后进行重启等机制，就成为了重中之重的事情，考虑到这点 kubernetes 推出了活性探针机制。有了存活性探针能保证程序在运行中如果挂掉能够自动重启，但是还有个经常遇到的问题，比如说，在 Kubernetes 中启动 Pod，显示明明 Pod 已经启动成功，且能访问里面的端口，但是却返回错误信息。还有就是在执行滚动更新时候，总会出现一段时间，Pod 对外提供网络访问，但是访问却发生 404，这两个原因，都是因为 Pod 已经成功启动，但是 Pod 的的容器中应用程序还在启动中导致，考虑到这点 Kubernetes 推出了就绪性探针机制。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">check</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">check</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">check</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">busybox:1.28</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">-c</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">sleep</span> <span class=\"number\">10</span><span class=\"string\">;exit</span></span><br></pre></td></tr></table></figure>\n<p>k8s 提供了三种来实现容器探测的方法，分别是：</p>\n<blockquote>\n<p>1、startupProbe：探测容器中的应用是否已经启动。如果提供了启动探测 (startup probe)，则暂时禁用所有其他探测，直到它成功为止。如果启动探测失败，kubelet 将杀死容器，容器服从其重启策略进行重启。如果容器没有提供启动探测，则默认状态为成功 Success。</p>\n<p>2、livenessprobe：用指定的方式（exec、tcp、http）<strong>检测 pod 中的容器是否正常运行</strong>，如果检测失败，则认为容器不健康，那么 Kubelet 将根据 Pod 中设置的 restartPolicy 策略来判断 Pod 是否要进行重启操作，如果容器配置中没有配置 livenessProbe，Kubelet 将认为存活探针探测一直为 success（成功）状态。</p>\n<p>3、readnessprobe：就绪性探针，<strong>用于检测容器中的应用是否可以接受请求</strong>，当探测成功后才使 Pod 对外提供网络访问，将容器标记为就绪状态，可以加到 pod 前端负载，如果探测失败，则将容器标记为未就绪状态，会把 pod 从前端负载移除。</p>\n</blockquote>\n<p>可以自定义在 pod 启动时是否执行这些检测，如果不设置，则检测结果均默认为通过，如果设置，则顺序为 startupProbe&gt;readinessProbe 和 livenessProbe，readinessProbe 和 livenessProbe 是并发关系</p>\n<p>目前 LivenessProbe 和 ReadinessProbe、startupprobe 探测都支持下面三种探针：</p>\n<blockquote>\n<p>1、exec：在容器中执行指定的命令，如果执行成功，退出码为 0 则探测成功。</p>\n<p>2、TCPSocket：通过容器的 IP 地址和端口号执行 TCP 检 查，如果能够建立 TCP 连接，则表明容器健康。</p>\n<p>3、HTTPGet：通过容器的 IP 地址、端口号及路径调用 HTTP Get 方法，如果响应的状态码大于等于 200 且小于 400，则认为容器健康</p>\n</blockquote>\n<p>探针探测结果有以下值：</p>\n<blockquote>\n<p>1、Success：表示通过检测。</p>\n<p>2、Failure：表示未通过检测。</p>\n<p>3、Unknown：表示检测没有正常进行。</p>\n</blockquote>\n<p>Pod 探针相关的属性：</p>\n<p>探针 (Probe) 有许多可选字段，可以用来更加精确的控制 Liveness 和 Readiness 两种探针的行为</p>\n<blockquote>\n<p>initialDelaySeconds：容器启动后要等待多少秒后探针开始工作，单位 “秒”，默认是 0 秒，最小值是 0</p>\n<p>periodSeconds： 执行探测的时间间隔（单位是秒），默认为 10s，单位 “秒”，最小值是 1</p>\n<p>timeoutSeconds： 探针执行检测请求后，等待响应的超时时间，默认为 1，单位 “秒”。</p>\n<p>successThreshold：连续探测几次成功，才认为探测成功，默认为 1，在 Liveness 探针中必须为 1，最小值为 1。</p>\n<p>failureThreshold： 探测失败的重试次数，重试一定次数后将认为失败，在 readiness 探针中，Pod 会被标记为未就绪，默认为 3，最小值为 1</p>\n</blockquote>\n<p>两种探针区别：</p>\n<p>ReadinessProbe 和 livenessProbe 可以使用相同探测方式，只是对 Pod 的处置方式不同：</p>\n<blockquote>\n<p>readinessProbe 当检测失败后，<strong>将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。</strong></p>\n<p>livenessProbe 当检测失败后，<strong>将杀死容器并根据 Pod 的重启策略来决定作出对应的措施。</strong></p>\n</blockquote>\n<h3 id=\"启动探测\"><a class=\"markdownIt-Anchor\" href=\"#启动探测\">#</a> 启动探测</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1、exec模式</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl explain pod.spec.containers.startupProbe</span></span><br><span class=\"line\"><span class=\"comment\"># startupProbe</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">startupprobe</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">startup</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat-8.5-jre8</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">startupProbe:</span></span><br><span class=\"line\">     <span class=\"attr\">exec:</span></span><br><span class=\"line\">       <span class=\"attr\">command:</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"string\">&quot;/bin/sh&quot;</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"string\">&quot;-c&quot;</span></span><br><span class=\"line\">       <span class=\"bullet\">-</span> <span class=\"string\">&quot;ps aux | grep tomcat&quot;</span></span><br><span class=\"line\">     <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#容器启动后多久开始探测</span></span><br><span class=\"line\">     <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#执行探测的时间间隔</span></span><br><span class=\"line\">     <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span> <span class=\"comment\">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class=\"line\">     <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span> <span class=\"comment\">#成功多少次才算成功</span></span><br><span class=\"line\">     <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span> <span class=\"comment\">#失败多少次才算失败</span></span><br><span class=\"line\"><span class=\"comment\"># 第一次探测失败多久会重启</span></span><br><span class=\"line\"><span class=\"string\">initialDelaySeconds</span> <span class=\"string\">+</span> <span class=\"string\">(periodSeconds</span> <span class=\"string\">+</span> <span class=\"string\">timeoutSeconds)</span> <span class=\"string\">*</span> <span class=\"string\">failureThreshold</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># tcpsocket模式</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">startupprobe</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">startup</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat:9.0</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">startupProbe:</span></span><br><span class=\"line\">     <span class=\"attr\">tcpSocket:</span></span><br><span class=\"line\">       <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">     <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#容器启动后多久开始探测</span></span><br><span class=\"line\">     <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#执行探测的时间间隔</span></span><br><span class=\"line\">     <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span> <span class=\"comment\">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class=\"line\">     <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span> <span class=\"comment\">#成功多少次才算成功</span></span><br><span class=\"line\">     <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span> <span class=\"comment\">#失败多少次才算失败</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">startupprobe</span>             <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">0s</span>      <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">startupprobe</span>             <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">1s</span>      <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">startupprobe</span>             <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>             <span class=\"number\">0</span>          <span class=\"string\">2s</span>      <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.168</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">startupprobe</span>             <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>             <span class=\"number\">0</span>          <span class=\"string\">36s</span>     <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.168</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">startupprobe</span>             <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>             <span class=\"number\">0</span>          <span class=\"string\">78s</span>     <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.168</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># httpget模式</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">startupprobe</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">startup</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat:9.0</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">startupProbe:</span></span><br><span class=\"line\">      <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">     <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#容器启动后多久开始探测</span></span><br><span class=\"line\">     <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span> <span class=\"comment\">#执行探测的时间间隔</span></span><br><span class=\"line\">     <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span> <span class=\"comment\">#探针执行检测请求后，等待响应的超时时间</span></span><br><span class=\"line\">     <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span> <span class=\"comment\">#成功多少次才算成功</span></span><br><span class=\"line\">     <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span> <span class=\"comment\">#失败多少次才算失败</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"存活探测\"><a class=\"markdownIt-Anchor\" href=\"#存活探测\">#</a> 存活探测</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># livenessProbe</span></span><br><span class=\"line\"><span class=\"comment\"># exec</span></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: liveness-exec</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: liveness</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: liveness</span><br><span class=\"line\">    image: busybox:1.28</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    args:                       <span class=\"comment\">#创建测试探针探测的文件</span></span><br><span class=\"line\">    - /bin/sh</span><br><span class=\"line\">    - -c</span><br><span class=\"line\">    - <span class=\"built_in\">touch</span> /tmp/healthy; <span class=\"built_in\">sleep</span> 30; <span class=\"built_in\">rm</span> -rf /tmp/healthy; <span class=\"built_in\">sleep</span> 600</span><br><span class=\"line\">    livenessProbe:</span><br><span class=\"line\">      initialDelaySeconds: 10   <span class=\"comment\">#延迟检测时间</span></span><br><span class=\"line\">      periodSeconds: 5          <span class=\"comment\">#检测时间间隔</span></span><br><span class=\"line\">      <span class=\"built_in\">exec</span>:</span><br><span class=\"line\">        <span class=\"built_in\">command</span>:</span><br><span class=\"line\">        - <span class=\"built_in\">cat</span></span><br><span class=\"line\">        - /tmp/healthy</span><br><span class=\"line\"></span><br><span class=\"line\">liveness-exec            1/1     Running             0          2s      10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">liveness-exec            1/1     Running             1          76s     10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">liveness-exec            1/1     Running             2          2m30s   10.244.166.171   node1     &lt;none&gt;           &lt;none&gt;</span><br><span class=\"line\">10 + 20 * 3</span><br></pre></td></tr></table></figure>\n<p>容器启动设置执行的命令：</p>\n<p>/bin/sh -c “touch /tmp/healthy; sleep 30; rm -rf /tmp/healthy; sleep 600”</p>\n<p>容器在初始化后，首先创建一个 /tmp/healthy 文件，然后执行睡眠命令，睡眠 30 秒，到时间后执行删除 /tmp/healthy 文件命令。而设置的存活探针检检测方式为执行 shell 命令，用 cat 命令输出 healthy 文件的内容，如果能成功执行这条命令，存活探针就认为探测成功，否则探测失败。在前 30 秒内，由于文件存在，所以存活探针探测时执行 cat /tmp/healthy 命令成功执行。30 秒后 healthy 文件被删除，所以执行命令失败，Kubernetes 会根据 Pod 设置的重启策略来判断，是否重启 Pod。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># http</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">liveness-http</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">test:</span> <span class=\"string\">liveness</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">liveness</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mydlqclub/springboot-helloworld:0.0.1</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">      <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span>   <span class=\"comment\">#延迟加载时间</span></span><br><span class=\"line\">      <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span>          <span class=\"comment\">#重试时间间隔</span></span><br><span class=\"line\">      <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span>        <span class=\"comment\">#超时时间设置</span></span><br><span class=\"line\">      <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">        <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">8081</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/actuator/health</span></span><br><span class=\"line\"><span class=\"comment\"># localhost:8081/actuator/health</span></span><br></pre></td></tr></table></figure>\n<p>上面 Pod 中启动的容器是一个 SpringBoot 应用，其中引用了 Actuator 组件，提供了 /actuator/health 健康检查地址，存活探针可以使用 HTTPGet 方式向服务发起请求，请求 8081 端口的 /actuator/health 路径来进行存活判断：</p>\n<p>任何大于或等于 200 且小于 400 的代码表示探测成功。</p>\n<p>任何其他代码表示失败。</p>\n<p>如果探测失败，则会杀死 Pod 进行重启操作。</p>\n<p>httpGet 探测方式有如下可选的控制字段:</p>\n<blockquote>\n<p>scheme: 用于连接 host 的协议，默认为 HTTP。</p>\n<p>host：要连接的主机名，默认为 Pod IP，可以在 http request head 中设置 host 头部。</p>\n<p>port：容器上要访问端口号或名称。</p>\n<p>path：http 服务器上的访问 URI。</p>\n<p>httpHeaders：自定义 HTTP 请求 headers，HTTP 允许重复 headers。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># tcp</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">liveness-tcp</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">liveness</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">liveness</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">      <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">15</span></span><br><span class=\"line\">      <span class=\"attr\">periodSeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">      <span class=\"attr\">tcpSocket:</span></span><br><span class=\"line\">        <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"就绪探测\"><a class=\"markdownIt-Anchor\" href=\"#就绪探测\">#</a> 就绪探测</h3>\n<p>Pod 的 ReadinessProbe 探针使用方式和 LivenessProbe 探针探测方法一样，也是支持三种，只是一个是用于探测应用的存活，一个是判断是否对外提供流量的条件。这里用一个 Springboot 项目，设置 ReadinessProbe 探测 SpringBoot 项目的 8081 端口下的 /actuator/health 接口，如果探测成功则代表内部程序以及启动，就开放对外提供接口访问，否则内部应用没有成功启动，暂不对外提供访问，直到就绪探针探测成功。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># readiness </span></span><br><span class=\"line\"><span class=\"comment\"># exec</span></span><br><span class=\"line\"><span class=\"comment\"># http</span></span><br><span class=\"line\"><span class=\"comment\"># exec</span></span><br><span class=\"line\">当检测失败后，将 Pod 的 IP:Port 从对应的 EndPoint 列表中删除。</span><br><span class=\"line\">检测成功后才会加到service的endpoint中</span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: springboot</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: server</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">    targetPort: 8080</span><br><span class=\"line\">    nodePort: 31180</span><br><span class=\"line\">  - name: management</span><br><span class=\"line\">    port: 8081</span><br><span class=\"line\">    targetPort: 8081</span><br><span class=\"line\">    nodePort: 31181</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: springboot</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: springboot</span><br><span class=\"line\">    image: mydlqclub/springboot-helloworld:0.0.1</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - name: server</span><br><span class=\"line\">      containerPort: 8080</span><br><span class=\"line\">    - name: management</span><br><span class=\"line\">      containerPort: 8081</span><br><span class=\"line\">    readinessProbe:</span><br><span class=\"line\">      initialDelaySeconds: 20   </span><br><span class=\"line\">      periodSeconds: 5          </span><br><span class=\"line\">      timeoutSeconds: 10   </span><br><span class=\"line\">      httpGet:</span><br><span class=\"line\">        scheme: HTTP</span><br><span class=\"line\">        port: 8081</span><br><span class=\"line\">        path: /actuator/health</span><br></pre></td></tr></table></figure>\n<h3 id=\"混合使用三种探测\"><a class=\"markdownIt-Anchor\" href=\"#混合使用三种探测\">#</a> 混合使用三种探测</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 混合使用三种探测</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: springboot-live</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: NodePort</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - name: server</span><br><span class=\"line\">    port: 8080</span><br><span class=\"line\">    targetPort: 8080</span><br><span class=\"line\">    nodePort: 31180</span><br><span class=\"line\">  - name: management</span><br><span class=\"line\">    port: 8081</span><br><span class=\"line\">    targetPort: 8081</span><br><span class=\"line\">    nodePort: 31181</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: springboot-live</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: springboot</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: springboot</span><br><span class=\"line\">    image: mydlqclub/springboot-helloworld:0.0.1</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - name: server</span><br><span class=\"line\">      containerPort: 8080</span><br><span class=\"line\">    - name: management</span><br><span class=\"line\">      containerPort: 8081</span><br><span class=\"line\">    readinessProbe:</span><br><span class=\"line\">      initialDelaySeconds: 20   </span><br><span class=\"line\">      periodSeconds: 5          </span><br><span class=\"line\">      timeoutSeconds: 10   </span><br><span class=\"line\">      httpGet:</span><br><span class=\"line\">        scheme: HTTP</span><br><span class=\"line\">        port: 8081</span><br><span class=\"line\">        path: /actuator/health</span><br><span class=\"line\">    livenessProbe:</span><br><span class=\"line\">      initialDelaySeconds: 20</span><br><span class=\"line\">      periodSeconds: 5</span><br><span class=\"line\">      timeoutSeconds: 10</span><br><span class=\"line\">      httpGet:</span><br><span class=\"line\">        scheme: HTTP</span><br><span class=\"line\">        port: 8081</span><br><span class=\"line\">        path: /actuator/health</span><br><span class=\"line\">    startupProbe:</span><br><span class=\"line\">      initialDelaySeconds: 20</span><br><span class=\"line\">      periodSeconds: 5</span><br><span class=\"line\">      timeoutSeconds: 10</span><br><span class=\"line\">      httpGet:</span><br><span class=\"line\">        scheme: HTTP</span><br><span class=\"line\">        port: 8081</span><br><span class=\"line\">        path: /actuator/health</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 先启动探测，成功之后执行就绪和存活，后两个并行执行</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"replicaset\"><a class=\"markdownIt-Anchor\" href=\"#replicaset\">#</a> Replicaset</h2>\n<p>Pod 类型的自主式 pod，但是这存在一个问题，假如 pod 被删除了，那这个 pod 就不能自我恢复，就会彻底被删除，线上这种情况非常危险，pod 的控制器，所谓控制器就是能够管理 pod，监测 pod 运行状况，当 pod 发生故障，可以自动恢复 pod。也就是说能够代我们去管理 pod 中间层，并帮助我们确保每一个 pod 资源始终处于我们所定义或者我们所期望的目标状态，一旦 pod 资源出现故障，那么控制器会尝试重启 pod 或者里面的容器，如果一直重启有问题的话那么它可能会基于某种策略来进行重新布派或者重新编排；如果 pod 副本数量低于用户所定义的目标数量，它也会自动补全；如果多余，也会自动终止 pod 资源。</p>\n<p>kubectl explain rs</p>\n<p>ReplicaSet 是 kubernetes 中的一种副本控制器，简称 rs，主要作用是控制由其管理的 pod，使 pod 副本的数量始终维持在预设的个数。它的主要作用就是保证一定数量的 Pod 能够在集群中正常运行，它会持续监听这些 Pod 的运行状态，在 Pod 发生故障时重启 pod，pod 数量减少时重新运行新的 Pod 副本。官方推荐不要直接使用 ReplicaSet，用 Deployments 取而代之，Deployments 是比 ReplicaSet 更高级的概念，它会管理 ReplicaSet 并提供很多其它有用的特性，最重要的是 Deployments 支持声明式更新，声明式更新的好处是不会丢失历史变更。所以 Deployment 控制器不直接管理 Pod 对象，而是由 Deployment 管理 ReplicaSet，再由 ReplicaSet 负责管理 Pod 对象。</p>\n<p>Replicaset 控制器主要由三个部分组成：</p>\n<blockquote>\n<p>1、用户期望的 pod 副本数：用来定义由这个控制器管控的 pod 副本有几个</p>\n<p>2、标签选择器：选定哪些 pod 是自己管理的，如果通过标签选择器选到的 pod 副本数量少于我们指定的数量，需要用到下面的组件</p>\n<p>3、pod 资源模板：如果集群中现存的 pod 数量不够我们定义的副本中期望的数量怎么办，需要新建 pod，这就需要 pod 模板，新建的 pod 是基于模板来创建的。</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ReplicaSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">frontend</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">shabi</span></span><br><span class=\"line\">    <span class=\"attr\">tier:</span> <span class=\"string\">zhizhang</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span> </span><br><span class=\"line\">      <span class=\"attr\">tier1:</span> <span class=\"string\">frontend1</span></span><br><span class=\"line\">  <span class=\"comment\"># pod 模板</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">tier1:</span> <span class=\"string\">frontend1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span> </span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span>   </span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span>          </span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span>   </span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">startupProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span>   </span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span>          </span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span>   </span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span>   </span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span>          </span><br><span class=\"line\">          <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span>   </span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">  </span><br><span class=\"line\">\t\t</span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">replicaset</span>]<span class=\"comment\"># kubectl get rs</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                         <span class=\"string\">DESIRED</span>   <span class=\"string\">CURRENT</span>   <span class=\"string\">READY</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">frontend</span>                     <span class=\"number\">3</span>         <span class=\"number\">3</span>         <span class=\"number\">3</span>       <span class=\"string\">8s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">pod名字</span> <span class=\"string\">=</span> <span class=\"string\">repset名字</span> <span class=\"bullet\">-</span> <span class=\"string\">随机数,所以在template中只需要定义标签，不需要名字</span></span><br><span class=\"line\"><span class=\"string\">删除pod之后，pod</span> <span class=\"string\">ip会变，会产生一个IP不同的新的pod</span></span><br><span class=\"line\"><span class=\"string\">repset永远让pod数量维持</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">replicaset</span>]<span class=\"comment\"># kubectl get pod -owide </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                               <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>       <span class=\"string\">AGE</span>     <span class=\"string\">IP</span>               <span class=\"string\">NODE</span>               <span class=\"string\">NOMINATED</span> <span class=\"string\">NODE</span>   <span class=\"string\">READINESS</span> <span class=\"string\">GATES</span></span><br><span class=\"line\"><span class=\"string\">frontend-8t7jx</span>                     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>              <span class=\"string\">56s</span>     <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.104</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">frontend-qx7dx</span>                     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>              <span class=\"string\">56s</span>     <span class=\"number\">10.244</span><span class=\"number\">.64</span><span class=\"number\">.21</span>     <span class=\"string\">prometheus-node2</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">frontend-s8jgx</span>                     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>              <span class=\"string\">56s</span>     <span class=\"number\">10.244</span><span class=\"number\">.216</span><span class=\"number\">.103</span>   <span class=\"string\">prometheus-node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"pod动态扩缩容\"><a class=\"markdownIt-Anchor\" href=\"#pod动态扩缩容\">#</a> pod 动态扩缩容</h3>\n<p>replicaset 可以实现动态变更副本数和镜像</p>\n<p>变更镜像的时候需要手动删除原来的 pod (delete pods) 不会滚动更新，如果增加副本数只需要在原有基础上增加 pod 即可，删除副本是随机删除 pod</p>\n<p>ReplicaSet 最核心的功能是可以动态扩容和回缩，如果我们觉得两个副本太少了，想要增加，只需要修改配置文件 replicaset.yaml 里的 replicas 的值即可，原来 replicas: 3，现在变成 replicaset: 4，修改之后，执行如下命令更新：<br>\nkubectl apply -f replicaset.yaml</p>\n<p>生产环境如果升级，可以删除一个 pod，观察一段时间之后没问题再删除另一个 pod，但是这样需要人工干预多次；实际生产环境一般采用蓝绿发布，原来有一个 rs1，再创建一个 rs2（控制器），通过修改 service 标签，修改 service 可以匹配到 rs2 的控制器，这样才是蓝绿发布，这个也需要我们精心的部署规划，我们有一个控制器就是建立在 rs 之上完成的，叫做 Deployment</p>\n<h2 id=\"deployment\"><a class=\"markdownIt-Anchor\" href=\"#deployment\">#</a> deployment</h2>\n<p>Deployment 是 kubernetes 中最常用的资源对象，为 ReplicaSet 和 Pod 的创建提供了一种声明式的定义方法，在 Deployment 对象中描述一个期望的状态，Deployment 控制器就会按照一定的控制速率把实际状态改成期望状态，通过定义一个 Deployment 控制器会创建一个新的 ReplicaSet 控制器，通过 ReplicaSet 创建 pod，删除 Deployment 控制器，也会删除 Deployment 控制器下对应的 ReplicaSet 控制器和 pod 资源.</p>\n<p>使用 Deployment 而不直接创建 ReplicaSet 是因为 Deployment 对象拥有许多 ReplicaSet 没有的特性，例如滚动升级、金丝雀发布、蓝绿部署和回滚。</p>\n<p>声明式定义是指直接修改资源清单 yaml 文件，然后通过 kubectl apply -f 资源清单 yaml 文件，就可以更改资源</p>\n<p>Deployment 控制器是建立在 rs 之上的一个控制器，可以管理多个 rs，每次更新镜像版本，都会生成一个新的 rs，把旧的 rs 替换掉，多个 rs 同时存在，但是只有一个 rs 运行。</p>\n<p>Deployment 可以使用声明式定义，直接在命令行通过纯命令的方式完成对应资源版本的内容的修改，也就是通过打补丁的方式进行修改；Deployment 能提供滚动式自定义自控制的更新；对 Deployment 来讲，我们在实现更新时还可以实现控制更新节奏和更新逻辑。（先创建还是先删除）</p>\n<p>通过 Deployment 对象，你可以做到以下事情：</p>\n<blockquote>\n<p>1、创建 ReplicaSet 和 Pod</p>\n<p>2、滚动升级（不停止旧服务的状态下升级）和回滚应用（将应用回滚到之前的版本）</p>\n<p>3、平滑地扩容和缩容</p>\n<p>4、暂停和继续 Deployment</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain deploy.spec.strategy.rollingUpdate</span></span><br><span class=\"line\"><span class=\"string\">maxSurge</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\"><span class=\"comment\">#我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span></span><br><span class=\"line\"><span class=\"string\">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span></span><br><span class=\"line\"><span class=\"string\">maxUnavailable</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\"><span class=\"comment\">#最多允许几个不可用</span></span><br><span class=\"line\"><span class=\"string\">假设有5个副本，最多一个不可用，就表示最少有4个可用</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">假如pod数为5，surge和maxun都是2</span></span><br><span class=\"line\"><span class=\"string\">那么最大超出的副本数是5+2</span></span><br><span class=\"line\"><span class=\"string\">最少副本数为5-2</span></span><br><span class=\"line\"><span class=\"string\">maxsurge</span> <span class=\"string\">出现小数向上取整</span></span><br><span class=\"line\"><span class=\"string\">maxunavailable</span> <span class=\"string\">出现小数向下取整</span> </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">ctr</span> <span class=\"string\">-n=k8s.io</span> <span class=\"string\">images</span> <span class=\"string\">import</span> <span class=\"string\">x.tar.gz</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span> </span><br><span class=\"line\">           <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">           <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">           <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">             <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">             <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">             <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">           <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">           <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">           <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">           <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">             <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">             <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">             <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">           <span class=\"attr\">periodSeconds:</span> <span class=\"number\">5</span></span><br><span class=\"line\">           <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">20</span></span><br><span class=\"line\">           <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">           <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">             <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">             <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">             <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> [root@master1 ~]<span class=\"comment\"># kubectl get deployment</span></span><br><span class=\"line\">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">myapp-v1   2/2     2            2           57s</span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get replicaset </span></span><br><span class=\"line\">NAME                 DESIRED   CURRENT   READY   AGE</span><br><span class=\"line\">myapp-v1-b5d4c8b9d   2         2         2       72s</span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl get pods </span></span><br><span class=\"line\">myapp-v1-b5d4c8b9d-cxcvr   1/1     Running   0          108s</span><br><span class=\"line\">myapp-v1-b5d4c8b9d-ptsv4   1/1     Running   0          108s</span><br><span class=\"line\"></span><br><span class=\"line\">1.NAME ：列出名称空间中deployment的名称。</span><br><span class=\"line\">2.READY：显示deployment有多少副本数。它遵循ready/desired的模式。</span><br><span class=\"line\">3.UP-TO-DATE： 显示已更新到所需状态的副本数。</span><br><span class=\"line\">4.AVAILABLE： 显示你的可以使用多少个应用程序副本。</span><br><span class=\"line\">5.AGE ：显示应用程序已运行的时间。</span><br><span class=\"line\"></span><br><span class=\"line\">1.NAME： 列出名称空间中ReplicaSet资源</span><br><span class=\"line\">2.DESIRED：显示应用程序的所需副本数，这些副本数是在创建时定义的。这是所需的状态。</span><br><span class=\"line\">3.CURRENT： 显示当前正在运行多少个副本。</span><br><span class=\"line\">4.READY： 显示你的用户可以使用多少个应用程序副本。</span><br><span class=\"line\">5.AGE ：显示应用程序已运行的时间。 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 扩容缩容</span></span><br><span class=\"line\">spec:</span><br><span class=\"line\">  replicas: 3</span><br><span class=\"line\">声明式更新 - apply -f</span><br></pre></td></tr></table></figure>\n<h3 id=\"滚动更新\"><a class=\"markdownIt-Anchor\" href=\"#滚动更新\">#</a> 滚动更新</h3>\n<p>滚动更新是一种自动化程度较高的发布方式，用户体验比较平滑，是目前成熟型技术组织所采用的主流发布方式，一次滚动发布一般由若干个发布批次组成，每批的数量一般是可以配置的（可以通过发布模板定义），例如第一批 1 台，第二批 10%，第三批 50%，第四批 100%。每个批次之间留观察间隔，通过手工验证或监控反馈确保没有问题再发下一批次，所以总体上滚动式发布过程是比较缓慢的</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># rollingupdate</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">explain</span> <span class=\"string\">deploy.spec.strategy.rollingUpdate</span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">rollingUpdate</span> <span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">Rolling</span> <span class=\"string\">update</span> <span class=\"string\">config</span> <span class=\"string\">params.</span> <span class=\"string\">Present</span> <span class=\"string\">only</span> <span class=\"string\">if</span> <span class=\"string\">DeploymentStrategyType</span> <span class=\"string\">=</span></span><br><span class=\"line\">     <span class=\"string\">RollingUpdate.</span></span><br><span class=\"line\">     <span class=\"string\">Spec</span> <span class=\"string\">to</span> <span class=\"string\">control</span> <span class=\"string\">the</span> <span class=\"string\">desired</span> <span class=\"string\">behavior</span> <span class=\"string\">of</span> <span class=\"string\">rolling</span> <span class=\"string\">update.</span></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">maxSurge</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">The</span> <span class=\"string\">maximum</span> <span class=\"string\">number</span> <span class=\"string\">of</span> <span class=\"string\">pods</span> <span class=\"string\">that</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">scheduled</span> <span class=\"string\">above</span> <span class=\"string\">the</span> <span class=\"string\">desired</span> <span class=\"string\">number</span></span><br><span class=\"line\">     <span class=\"string\">of</span> <span class=\"string\">pods.</span> <span class=\"string\">Value</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">an</span> <span class=\"string\">absolute</span> <span class=\"string\">number</span> <span class=\"string\">(ex:</span> <span class=\"number\">5</span><span class=\"string\">)</span> <span class=\"string\">or</span> <span class=\"string\">a</span> <span class=\"string\">percentage</span> <span class=\"string\">of</span> <span class=\"string\">desired</span></span><br><span class=\"line\">     <span class=\"string\">pods</span> <span class=\"string\">(ex:</span> <span class=\"number\">10</span><span class=\"string\">%).</span> <span class=\"string\">This</span> <span class=\"string\">can</span> <span class=\"string\">not</span> <span class=\"string\">be</span> <span class=\"number\">0</span> <span class=\"string\">if</span> <span class=\"string\">MaxUnavailable</span> <span class=\"string\">is</span> <span class=\"number\">0</span><span class=\"string\">.</span> <span class=\"string\">Absolute</span> <span class=\"string\">number</span></span><br><span class=\"line\">     <span class=\"string\">is</span> <span class=\"string\">calculated</span> <span class=\"string\">from</span> <span class=\"string\">percentage</span> <span class=\"string\">by</span> <span class=\"string\">rounding</span> <span class=\"string\">up.</span> <span class=\"string\">Defaults</span> <span class=\"string\">to</span> <span class=\"number\">25</span><span class=\"string\">%.</span> <span class=\"attr\">Example:</span></span><br><span class=\"line\">     <span class=\"string\">when</span> <span class=\"string\">this</span> <span class=\"string\">is</span> <span class=\"string\">set</span> <span class=\"string\">to</span> <span class=\"number\">30</span><span class=\"string\">%,</span> <span class=\"string\">the</span> <span class=\"string\">new</span> <span class=\"string\">ReplicaSet</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">scaled</span> <span class=\"string\">up</span> <span class=\"string\">immediately</span></span><br><span class=\"line\">     <span class=\"string\">when</span> <span class=\"string\">the</span> <span class=\"string\">rolling</span> <span class=\"string\">update</span> <span class=\"string\">starts,</span> <span class=\"string\">such</span> <span class=\"string\">that</span> <span class=\"string\">the</span> <span class=\"string\">total</span> <span class=\"string\">number</span> <span class=\"string\">of</span> <span class=\"string\">old</span> <span class=\"string\">and</span> <span class=\"string\">new</span></span><br><span class=\"line\">     <span class=\"string\">pods</span> <span class=\"string\">do</span> <span class=\"string\">not</span> <span class=\"string\">exceed</span> <span class=\"number\">130</span><span class=\"string\">%</span> <span class=\"string\">of</span> <span class=\"string\">desired</span> <span class=\"string\">pods.</span> <span class=\"string\">Once</span> <span class=\"string\">old</span> <span class=\"string\">pods</span> <span class=\"string\">have</span> <span class=\"string\">been</span> <span class=\"string\">killed,</span></span><br><span class=\"line\">     <span class=\"string\">new</span> <span class=\"string\">ReplicaSet</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">scaled</span> <span class=\"string\">up</span> <span class=\"string\">further,</span> <span class=\"string\">ensuring</span> <span class=\"string\">that</span> <span class=\"string\">total</span> <span class=\"string\">number</span> <span class=\"string\">of</span> <span class=\"string\">pods</span></span><br><span class=\"line\">     <span class=\"string\">running</span> <span class=\"string\">at</span> <span class=\"string\">any</span> <span class=\"string\">time</span> <span class=\"string\">during</span> <span class=\"string\">the</span> <span class=\"string\">update</span> <span class=\"string\">is</span> <span class=\"string\">at</span> <span class=\"string\">most</span> <span class=\"number\">130</span><span class=\"string\">%</span> <span class=\"string\">of</span> <span class=\"string\">desired</span> <span class=\"string\">pods.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#我们更新的过程当中最多允许超出的指定的目标副本数有几个； </span></span><br><span class=\"line\"><span class=\"string\">它有两种取值方式，第一种直接给定数量，第二种根据百分比，百分比表示原本是5个，最多可以超出20%，那就允许多一个，最多可以超过40%，那就允许多两个</span></span><br><span class=\"line\">   <span class=\"string\">maxUnavailable</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">The</span> <span class=\"string\">maximum</span> <span class=\"string\">number</span> <span class=\"string\">of</span> <span class=\"string\">pods</span> <span class=\"string\">that</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">unavailable</span> <span class=\"string\">during</span> <span class=\"string\">the</span> <span class=\"string\">update.</span> <span class=\"string\">Value</span></span><br><span class=\"line\">     <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">an</span> <span class=\"string\">absolute</span> <span class=\"string\">number</span> <span class=\"string\">(ex:</span> <span class=\"number\">5</span><span class=\"string\">)</span> <span class=\"string\">or</span> <span class=\"string\">a</span> <span class=\"string\">percentage</span> <span class=\"string\">of</span> <span class=\"string\">desired</span> <span class=\"string\">pods</span> <span class=\"string\">(ex:</span></span><br><span class=\"line\">     <span class=\"number\">10</span><span class=\"string\">%).</span> <span class=\"string\">Absolute</span> <span class=\"string\">number</span> <span class=\"string\">is</span> <span class=\"string\">calculated</span> <span class=\"string\">from</span> <span class=\"string\">percentage</span> <span class=\"string\">by</span> <span class=\"string\">rounding</span> <span class=\"string\">down.</span> <span class=\"string\">This</span></span><br><span class=\"line\">     <span class=\"string\">can</span> <span class=\"string\">not</span> <span class=\"string\">be</span> <span class=\"number\">0</span> <span class=\"string\">if</span> <span class=\"string\">MaxSurge</span> <span class=\"string\">is</span> <span class=\"number\">0</span><span class=\"string\">.</span> <span class=\"string\">Defaults</span> <span class=\"string\">to</span> <span class=\"number\">25</span><span class=\"string\">%.</span> <span class=\"attr\">Example:</span> <span class=\"string\">when</span> <span class=\"string\">this</span> <span class=\"string\">is</span> <span class=\"string\">set</span></span><br><span class=\"line\">     <span class=\"string\">to</span> <span class=\"number\">30</span><span class=\"string\">%,</span> <span class=\"string\">the</span> <span class=\"string\">old</span> <span class=\"string\">ReplicaSet</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">scaled</span> <span class=\"string\">down</span> <span class=\"string\">to</span> <span class=\"number\">70</span><span class=\"string\">%</span> <span class=\"string\">of</span> <span class=\"string\">desired</span> <span class=\"string\">pods</span></span><br><span class=\"line\">     <span class=\"string\">immediately</span> <span class=\"string\">when</span> <span class=\"string\">the</span> <span class=\"string\">rolling</span> <span class=\"string\">update</span> <span class=\"string\">starts.</span> <span class=\"string\">Once</span> <span class=\"string\">new</span> <span class=\"string\">pods</span> <span class=\"string\">are</span> <span class=\"string\">ready,</span> <span class=\"string\">old</span></span><br><span class=\"line\">     <span class=\"string\">ReplicaSet</span> <span class=\"string\">can</span> <span class=\"string\">be</span> <span class=\"string\">scaled</span> <span class=\"string\">down</span> <span class=\"string\">further,</span> <span class=\"string\">followed</span> <span class=\"string\">by</span> <span class=\"string\">scaling</span> <span class=\"string\">up</span> <span class=\"string\">the</span> <span class=\"string\">new</span></span><br><span class=\"line\">     <span class=\"string\">ReplicaSet,</span> <span class=\"string\">ensuring</span> <span class=\"string\">that</span> <span class=\"string\">the</span> <span class=\"string\">total</span> <span class=\"string\">number</span> <span class=\"string\">of</span> <span class=\"string\">pods</span> <span class=\"string\">available</span> <span class=\"string\">at</span> <span class=\"string\">all</span> <span class=\"string\">times</span></span><br><span class=\"line\">     <span class=\"string\">during</span> <span class=\"string\">the</span> <span class=\"string\">update</span> <span class=\"string\">is</span> <span class=\"string\">at</span> <span class=\"string\">least</span> <span class=\"number\">70</span><span class=\"string\">%</span> <span class=\"string\">of</span> <span class=\"string\">desired</span> <span class=\"string\">pods.</span></span><br><span class=\"line\"><span class=\"comment\">#最多允许几个不可用</span></span><br><span class=\"line\"><span class=\"string\">假设有5个副本，最多一个不可用，就表示最少有4个可用</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看历史版本</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl rollout history deployment myapp-v1 </span></span><br><span class=\"line\"><span class=\"string\">deployment.apps/myapp-v1</span> </span><br><span class=\"line\"><span class=\"string\">REVISION</span>  <span class=\"string\">CHANGE-CAUSE</span></span><br><span class=\"line\"><span class=\"number\">1</span>         <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"number\">2</span>         <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">滚动更新后会创建一个新的replicaset</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">rs</span> </span><br><span class=\"line\"><span class=\"string\">NAME</span>                  <span class=\"string\">DESIRED</span>   <span class=\"string\">CURRENT</span>   <span class=\"string\">READY</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-75fb478d6c</span>   <span class=\"number\">3</span>         <span class=\"number\">3</span>         <span class=\"number\">3</span>       <span class=\"string\">2m7s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-67fd9fc9c8</span>   <span class=\"number\">0</span>         <span class=\"number\">0</span>         <span class=\"number\">0</span>       <span class=\"string\">25m</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 回滚</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">rollout</span> <span class=\"string\">undo</span> <span class=\"string\">deployment/myapp-v1</span> <span class=\"string\">--to-revision=1</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"自动滚动更新策略\"><a class=\"markdownIt-Anchor\" href=\"#自动滚动更新策略\">#</a> 自动滚动更新策略</h3>\n<p>maxUnavailable: [0%, 100%] 向下取整，比如 10 个副本，5% 的话<mark> 0.5 个，但计算按照 0 个；<br>\nmaxSurge: [0%, 100%] 向上取整，比如 10 个副本，5% 的话</mark> 0.5 个，但计算按照 1 个；</p>\n<p>建议配置，不少于目标副本数，但是 maxsurge 变大可以实现更快的更新</p>\n<ol>\n<li>maxUnavailable == 0</li>\n<li>maxSurge == 1</li>\n</ol>\n<p>即 “一上一下，先上后下” 最平滑原则：</p>\n<p>maxUnavailable：和期望的副本数比，不可用副本数最大比例（或最大值），这个值越小，越能保证服务稳定，更新越平滑；<br>\nmaxSurge：和期望的副本数比，超过期望副本数最大比例（或最大值），这个值调的越大，副本更新速度越快。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">deploy.spec.strategy.type</span></span><br><span class=\"line\"><span class=\"string\">==</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\"><span class=\"string\">==</span> <span class=\"string\">RollingUpdate(default)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自定义策略 通过命令</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">patch</span> <span class=\"string\">deployment</span> <span class=\"string\">myapp-v1</span> <span class=\"string\">-p</span> <span class=\"string\">&#x27;&#123;&quot;spec&quot;:&#123;&quot;strategy&quot;:&#123;&quot;rollingUpdate&quot;: &#123;&quot;maxSurge&quot;:1,&quot;maxUnavailable&quot;:1&#125;&#125;&#125;&#125;&#x27;</span> </span><br><span class=\"line\"><span class=\"comment\"># 自定义策略 通过yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxSurge:</span> <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"comment\"># 删除一个pod再新建一个pod</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重建式方式</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"comment\"># 先把所有pod干掉在新建</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-zslxg</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m3s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-nvjhq</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m24s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-gglnb</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m24s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-gglnb</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m24s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-nvjhq</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m24s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-zslxg</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m3s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-gglnb</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-gglnb</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-gglnb</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-zslxg</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m4s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-zslxg</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m4s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-zslxg</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m4s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-nvjhq</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-nvjhq</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"string\">myapp-v1-59c458cb84-nvjhq</span>   <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">5m25s</span></span><br><span class=\"line\"><span class=\"comment\"># 最好别用reCreate</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"蓝绿部署\"><a class=\"markdownIt-Anchor\" href=\"#蓝绿部署\">#</a> 蓝绿部署</h3>\n<p>蓝绿部署中，一共有两套系统：一套是正在提供服务系统，标记为 “绿色”；另一套是准备发布的系统，标记为 “蓝色”。两套系统都是功能完善的、正在运行的系统，只是系统版本和对外服务情况不同。</p>\n<p>开发新版本，要用新版本替换线上的旧版本，在线上的系统之外，搭建了一个使用新版本代码的全新系统。 这时候，一共有两套系统在运行，正在对外提供服务的老系统是绿色系统，新部署的系统是蓝色系统。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619175716206.png\" alt=\"image-20230619175716206\"></p>\n<p>用来做发布前测试，测试过程中发现任何问题，可以直接在蓝色系统上修改，不干扰用户正在使用的系统。（注意，两套系统没有耦合的时候才能百分百保证不干扰）<br>\n蓝色系统经过反复的测试、修改、验证，确定达到上线标准之后，直接将用户切换到蓝色系统：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619180146410.png\" alt=\"image-20230619180146410\"></p>\n<p>切换后的一段时间内，依旧是蓝绿两套系统并存，但是用户访问的已经是蓝色系统。这段时间内观察蓝色系统（新系统）工作状态，如果出现问题，直接切换回绿色系统。</p>\n<p>当确信对外提供服务的蓝色系统工作正常，不对外提供服务的绿色系统已经不再需要的时候，蓝色系统正式成为对外提供服务系统，成为新的绿色系统。 原先的绿色系统可以销毁，将资源释放出来，用于部署下一个蓝色系统。</p>\n<p>优点：</p>\n<blockquote>\n<p>1、更新过程无需停机，风险较少</p>\n<p>2、回滚方便，只需要更改路由或者切换 DNS 服务器，效率较高</p>\n</blockquote>\n<p>缺点：</p>\n<blockquote>\n<p>1、成本较高，需要部署两套环境。如果新版本中基础服务出现问题，会瞬间影响全网用户；如果新版本有问题也会影响全网用户。</p>\n<p>2、需要部署两套机器，费用开销大</p>\n<p>3、在非隔离的机器（Docker、VM）上操作时，可能会导致蓝绿环境被摧毁风险</p>\n<p>4、负载均衡器 / 反向代理 / 路由 / DNS 处理不当，将导致流量没有切换过来情况出现</p>\n</blockquote>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># deployment实现蓝绿部署</span></span><br><span class=\"line\"><span class=\"comment\"># 创建绿色系统</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-v2</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">blue-green</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">   <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">   <span class=\"attr\">metadata:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">     <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">     <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">   <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">janakiramm/myapp:v1</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建蓝色系统</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-v1</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">blue-green</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">   <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">   <span class=\"attr\">metadata:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">     <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">     <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">   <span class=\"attr\">spec:</span></span><br><span class=\"line\">    <span class=\"attr\">containers:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">      <span class=\"attr\">image:</span> <span class=\"string\">janakiramm/myapp:v2</span></span><br><span class=\"line\">      <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">      <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"comment\"># 此时同时有两组pod存在</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建四层代理</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">myapp-lan-lv</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">blue-green</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">nodePort:</span> <span class=\"number\">30062</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"comment\"># 蓝绿部署需要service 通过service中selector选择不同label选择不同pod实现service代理到不同deploy，实现动态流量切换</span></span><br><span class=\"line\"><span class=\"comment\"># 切换到蓝色</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"comment\"># 切换到绿色</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"金丝雀发布\"><a class=\"markdownIt-Anchor\" href=\"#金丝雀发布\">#</a> 金丝雀发布</h3>\n<p>金丝雀发布（又称灰度发布、灰度更新）：金丝雀发布一般先发 1 台，或者一个小比例，例如 2% 的服务器，主要做流量验证用，也称为金丝雀 (Canary) 测试 （国内常称灰度测试）。</p>\n<p>简单的金丝雀测试一般通过手工测试验证，复杂的金丝雀测试需要比较完善的监控基础设施配合，通过监控指标反馈，观察金丝雀的健康状况，作为后续发布或回退的依据。 如果金丝测试通过，则把剩余的 V1 版本全部升级为 V2 版本。如果金丝雀测试失败，则直接回退金丝雀，发布失败。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230619182743417.png\" alt=\"image-20230619182743417\"></p>\n<p>优点：灵活，策略自定义，可以按照流量或具体的内容进行灰度 (比如不同账号，不同参数)，出现问题不会影响全网用户</p>\n<p>缺点：没有覆盖到所有的用户导致出现问题不好排查</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 先创建一个deployment</span></span><br><span class=\"line\">kubectl apply -f .yaml</span><br><span class=\"line\"><span class=\"comment\"># 只更新一个pod，此时有n+1个pod,立刻暂停更新，新的pod称为金丝雀</span></span><br><span class=\"line\">kubectl <span class=\"built_in\">set</span> image deployment myapp-v1 myapp=nginx  -n blue-green &amp;&amp; kubectl rollout pause deployment myapp-v1 -n blue-green</span><br><span class=\"line\"></span><br><span class=\"line\">上面的解释说明把myapp这个容器的镜像更新到nginx版本 更新镜像之后，创建一个新的pod就立即暂停，这就是我们说的金丝雀发布；如果暂停几个小时之后没有问题，那么取消暂停，就会依次执行后面步骤，把所有pod都升级。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全部pod更新，解除暂停</span></span><br><span class=\"line\">kubectl rollout resume deployment myapp-v1 -n blue-green</span><br></pre></td></tr></table></figure>\n<hr>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl run mynginx --image=nginx</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 通过命令行创建deployment</span></span><br><span class=\"line\"></span><br><span class=\"line\">kubectl create deployment mytomcat --image=tomcat:8.5.68</span><br><span class=\"line\"><span class=\"comment\"># delete 之后会立刻重新起一个新的pod，称为自愈能力</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get deploy</span></span><br><span class=\"line\">NAME       READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class=\"line\">mytomcat   1/1     1            1           4m6s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl delete  deploy mytomcat</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 多副本</span></span><br><span class=\"line\">kubectl create deployment my-dep --image=nginx --replicas=3</span><br></pre></td></tr></table></figure>\n<p>使用 web 页面</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410160308833.png\" alt=\"image-20230410160308833\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">3</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 扩缩容</span></span><br><span class=\"line\">kubectl scale --replicas=5 deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编辑配置文件实现扩缩容</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl edit deploy my-dep</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自愈 - 故障转移</span></span><br><span class=\"line\">自愈： 尝试重启pod</span><br><span class=\"line\">故障转移： 将pod从故障的机器转移到好的机器</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 滚动更新</span></span><br><span class=\"line\"><span class=\"comment\"># 实现不停机更新</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl set image deployment/my-dep nginx=nginx:1.16.1 --record</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl rollout status deployment/my-dep</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 查看deploy信息</span></span><br><span class=\"line\">kubectl get deploy my-dep -oyaml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 版本回退</span></span><br><span class=\"line\"><span class=\"comment\">#历史记录</span></span><br><span class=\"line\">kubectl rollout <span class=\"built_in\">history</span> deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#查看某个历史详情</span></span><br><span class=\"line\">kubectl rollout <span class=\"built_in\">history</span> deployment/my-dep --revision=2</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#回滚(回到上次)</span></span><br><span class=\"line\">kubectl rollout undo deployment/my-dep</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#回滚(回到指定版本)</span></span><br><span class=\"line\">kubectl rollout undo deployment/my-dep --to-revision=2</span><br></pre></td></tr></table></figure>\n<p>除了 Deployment，k8s 还有  <code>StatefulSet</code>  、 <code>DaemonSet</code>  、 <code>Job</code>   等 类型资源。我们都称为  <code>工作负载</code> 。</p>\n<p>有状态应用使用   <code>StatefulSet</code>   部署，无状态应用使用  <code>Deployment</code>  部署</p>\n<p>其他工作负载</p>\n<p>Deployment: 无状态应用部署，比如微服务，提供多副本等功能</p>\n<p>StatefulSet: 有状态应用部署，比如 redis，提供稳定的存储、网络等功能</p>\n<p>DaemonSet: 守护型应用部署，比如日志收集组件，在每个机器都运行一份</p>\n<p>Job/CronJob: 定时任务部署，比如垃圾清理组件，可以在指定时间运行</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410164854497.png\" alt=\"image-20230410164854497\"></p>\n<h2 id=\"service\"><a class=\"markdownIt-Anchor\" href=\"#service\">#</a> service</h2>\n<p>在 kubernetes 中，Pod 是有生命周期的，如果 Pod 重启它的 IP 很有可能会发生变化。如果我们的服务都是将 Pod 的 IP 地址写死，Pod 挂掉或者重启，和刚才重启的 pod 相关联的其他服务将会找不到它所关联的 Pod，为了解决这个问题，在 kubernetes 中定义了 service 资源对象，Service 定义了一个服务访问的入口，客户端通过这个入口即可访问服务背后的应用集群实例，service 是一组 Pod 的逻辑集合，这一组 Pod 能够被 Service 访问到，通常是通过 Label Selector 实现的。</p>\n<p>创建 service 的时候会创建同名的 endpoint，会把 pod 的 ip 和端口加入到 endpoint 中</p>\n<p>service 创建的时候有 service 的 ip，关联到 pod 的 ip 和端口，都保存在防火墙规则中：iptables 或者 ipvs</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># ipvsadm -Ln</span></span><br><span class=\"line\">IP Virtual Server version 1.2.1 (size=4096)</span><br><span class=\"line\">Prot LocalAddress:Port Scheduler Flags</span><br><span class=\"line\">  -&gt; RemoteAddress:Port           Forward Weight ActiveConn InActConn</span><br><span class=\"line\">TCP  127.0.0.1:30821 rr</span><br><span class=\"line\">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class=\"line\">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class=\"line\">TCP  127.0.0.1:31180 rr</span><br><span class=\"line\">  -&gt; 10.244.166.172:8080          Masq    1      0          0         </span><br><span class=\"line\">TCP  127.0.0.1:31181 rr</span><br><span class=\"line\">  -&gt; 10.244.166.172:8081          Masq    1      0          0         </span><br><span class=\"line\">TCP  127.0.0.1:31441 rr</span><br><span class=\"line\">  -&gt; 10.244.180.1:8443            Masq    1      0          0         </span><br><span class=\"line\">TCP  172.17.0.1:30821 rr</span><br><span class=\"line\">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class=\"line\">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class=\"line\">TCP  172.17.0.1:31180 rr</span><br><span class=\"line\">  -&gt; 10.244.166.172:8080          Masq    1      0          0         </span><br><span class=\"line\">TCP  172.17.0.1:31181 rr</span><br><span class=\"line\">  -&gt; 10.244.166.172:8081          Masq    1      0          0         </span><br><span class=\"line\">TCP  172.17.0.1:31441 rr</span><br><span class=\"line\">  -&gt; 10.244.180.1:8443            Masq    1      0          0         </span><br><span class=\"line\">TCP  192.168.13.177:30821 rr</span><br><span class=\"line\">  -&gt; 10.244.166.155:80            Masq    1      0          0         </span><br><span class=\"line\">  -&gt; 10.244.166.156:80            Masq    1      0          0         </span><br><span class=\"line\">  </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>kube-proxy 这个组件将始终监视着 apiserver 中有关 service 资源的变动信息，需要跟 master 之上的 apiserver 交互，随时连接到 apiserver 上获取任何一个与 service 资源相关的资源变动状态，这种是通过 kubernetes 中固有的一种请求方法 watch（监视）来实现的，一旦有 service 资源的内容发生变动（如创建，删除），kube-proxy 都会将它转化成当前节点之上的能够实现 service 资源调度，把我们请求调度到后端特定的 pod 资源之上的规则，这个规则可能是 iptables，也可能是 ipvs，取决于 service 的实现方式。</p>\n<p>k8s 在创建 Service 时，会根据标签选择器 selector (lable selector) 来查找 Pod，据此创建与 Service 同名的 endpoint 对象，当 Pod 地址发生变化时，endpoint 也会随之发生变化，service 接收前端 client 请求的时候，就会通过 endpoint，找到转发到哪个 Pod 进行访问的地址。(至于转发到哪个节点的 Pod，由负载均衡 kube-proxy 决定)</p>\n<p><strong>kubernetes 集群中有三类 IP 地址</strong></p>\n<p>1、Node Network（节点网络）：物理节点或者虚拟节点的网络，如 ens33 接口上的网路地址</p>\n<p>2、Pod network（pod 网络），创建的 Pod 具有的 IP 地址<br>\n Node Network 和 Pod network 这两种网络地址是我们实实在在配置的，其中节点网络地址是配置在节点接口之上，而 pod 网络地址是配置在 pod 资源之上的，因此这些地址都是配置在某些设备之上的，这些设备可能是硬件，也可能是软件模拟的</p>\n<p>3、Cluster Network（集群地址，也称为 service network），这个地址是虚拟的地址（virtual ip），没有配置在某个接口上，只是出现在 service 的规则当中。</p>\n<p>三个网段不能冲突</p>\n<p>–type=ClusterIP 集群内部访问</p>\n<p>–type=NodePort  集群外也能访问</p>\n<p>–type=ExternalName</p>\n<p>–type=LoadBalancer</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@ ~]# kubectl explain service.spec.ports</span><br><span class=\"line\">KIND:     Service</span><br><span class=\"line\">VERSION:  v1</span><br><span class=\"line\">RESOURCE: ports &lt;[]Object&gt;</span><br><span class=\"line\">DESCRIPTION:</span><br><span class=\"line\">     The list of ports that are exposed by this service. More info:</span><br><span class=\"line\">     https://kubernetes.io/docs/concepts/services-networking/service/#virtual-ips-and-service-proxies</span><br><span class=\"line\">     ServicePort contains information on service&#x27;s port.</span><br><span class=\"line\">FIELDS:</span><br><span class=\"line\">   appProtocol\t&lt;string&gt;</span><br><span class=\"line\">   name\t&lt;string&gt;  #定义端口的名字</span><br><span class=\"line\">   nodePort\t&lt;integer&gt;   #service在物理机映射的端口，默认在 30000-32767 之间</span><br><span class=\"line\">   port\t&lt;integer&gt; -required-  #service的端口，这个是k8s集群内部服务可访问的端口</span><br><span class=\"line\">   protocol\t&lt;string&gt;</span><br><span class=\"line\">   targetPort\t&lt;string&gt;</span><br><span class=\"line\"># targetPort是pod上的端口，从port和nodePort上来的流量，经过kube-proxy流入到后端pod的targetPort上，最后进入容器。 </span><br></pre></td></tr></table></figure>\n<h3 id=\"cluster-ip\"><a class=\"markdownIt-Anchor\" href=\"#cluster-ip\">#</a> cluster-ip</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 默认的type类型</span></span><br><span class=\"line\"><span class=\"comment\"># 创建nginx的deployment</span></span><br><span class=\"line\">apiVersion: apps/v1</span><br><span class=\"line\">kind: Deployment</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: my-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    matchLabels:</span><br><span class=\"line\">      run: my-nginx</span><br><span class=\"line\">  replicas: 2</span><br><span class=\"line\">  template:</span><br><span class=\"line\">    metadata:</span><br><span class=\"line\">      labels:</span><br><span class=\"line\">        run: my-nginx</span><br><span class=\"line\">    spec:</span><br><span class=\"line\">      containers:</span><br><span class=\"line\">      - name: my-nginx</span><br><span class=\"line\">        image: nginx</span><br><span class=\"line\">        imagePullPolicy: IfNotPresent</span><br><span class=\"line\">        ports:</span><br><span class=\"line\">        - containerPort: 80  <span class=\"comment\">#pod中的容器需要暴露的端口</span></span><br><span class=\"line\">        startupProbe:</span><br><span class=\"line\">           periodSeconds: 5</span><br><span class=\"line\">           initialDelaySeconds: 60</span><br><span class=\"line\">           timeoutSeconds: 10</span><br><span class=\"line\">           httpGet:</span><br><span class=\"line\">             scheme: HTTP</span><br><span class=\"line\">             port: 80</span><br><span class=\"line\">             path: /</span><br><span class=\"line\">        livenessProbe:</span><br><span class=\"line\">           periodSeconds: 5</span><br><span class=\"line\">           initialDelaySeconds: 60</span><br><span class=\"line\">           timeoutSeconds: 10</span><br><span class=\"line\">           httpGet:</span><br><span class=\"line\">             scheme: HTTP</span><br><span class=\"line\">             port: 80</span><br><span class=\"line\">             path: /</span><br><span class=\"line\">        readinessProbe:</span><br><span class=\"line\">           periodSeconds: 5</span><br><span class=\"line\">           initialDelaySeconds: 60</span><br><span class=\"line\">           timeoutSeconds: 10</span><br><span class=\"line\">           httpGet:</span><br><span class=\"line\">             scheme: HTTP</span><br><span class=\"line\">             port: 80</span><br><span class=\"line\">             path: /</span><br><span class=\"line\">---           </span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: my-nginx</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    run: my-nginx</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 80   <span class=\"comment\">#service的端口，暴露给k8s集群内部服务访问</span></span><br><span class=\"line\">    protocol: TCP</span><br><span class=\"line\">    targetPort: 80    <span class=\"comment\">#pod容器中定义的端口</span></span><br><span class=\"line\">  selector:</span><br><span class=\"line\">    run: my-nginx  <span class=\"comment\">#选择拥有run=my-nginx标签的pod</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl describe svc my-nginx </span></span><br><span class=\"line\">Name:              my-nginx</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            run=my-nginx</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          run=my-nginx</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Families:       &lt;none&gt;</span><br><span class=\"line\">IP:                10.96.60.147</span><br><span class=\"line\">IPs:               10.96.60.147</span><br><span class=\"line\">Port:              &lt;<span class=\"built_in\">unset</span>&gt;  30080/TCP</span><br><span class=\"line\">TargetPort:        80/TCP</span><br><span class=\"line\">Endpoints:         10.244.166.180:80,10.244.166.181:80</span><br><span class=\"line\">Session Affinity:  None</span><br><span class=\"line\">Events:            &lt;none&gt;</span><br><span class=\"line\">You have new mail <span class=\"keyword\">in</span> /var/spool/mail/root</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl describe ep my-nginx </span></span><br><span class=\"line\">Name:         my-nginx</span><br><span class=\"line\">Namespace:    default</span><br><span class=\"line\">Labels:       run=my-nginx</span><br><span class=\"line\">Annotations:  endpoints.kubernetes.io/last-change-trigger-time: 2023-05-10T12:28:47Z</span><br><span class=\"line\">Subsets:</span><br><span class=\"line\">  Addresses:          10.244.166.180,10.244.166.181</span><br><span class=\"line\">  NotReadyAddresses:  &lt;none&gt;</span><br><span class=\"line\">  Ports:</span><br><span class=\"line\">    Name     Port  Protocol</span><br><span class=\"line\">    ----     ----  --------</span><br><span class=\"line\">    &lt;<span class=\"built_in\">unset</span>&gt;  80    TCP</span><br><span class=\"line\"></span><br><span class=\"line\">Events:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># ipvsadm -Ln</span></span><br><span class=\"line\"><span class=\"comment\"># 只能在集群内访问</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>service 只要创建完成，我们就可以直接解析它的服务名，每一个服务创建完成后都会在集群 dns 中动态添加一个资源记录，添加完成后我们就可以解析了，资源记录格式是：</p>\n<p>SVC_NAME.NS_NAME.DOMAIN.LTD.<br>\n 服务名。命名空间。域名后缀<br>\n集群默认的域名后缀是 svc.cluster.local.</p>\n<p>就像我们上面创建的 my-nginx 这个服务，它的完整名称解析就是<br>\n my-nginx.default.svc.cluster.local</p>\n<p>这个域名只能 service 关联的 pod 内访问</p>\n<p>使用就绪探测防止容器还没能提供服务就加入 endpoint 中，不能通过 service 访问</p>\n<hr>\n<p>pod 的发现与负载均衡</p>\n<p>将一组 Pods 公开为网络服务的抽象方法。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl expose deploy my-dep --port=8000 --target-port=80  --type=ClusterIP</span></span><br><span class=\"line\">service/my-dep exposed</span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl delete service my-dep</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get service </span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pod --show-labels </span></span><br><span class=\"line\">NAME                      READY   STATUS    RESTARTS   AGE   LABELS</span><br><span class=\"line\">my-dep-5b7868d854-29j5l   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class=\"line\">my-dep-5b7868d854-67vg6   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class=\"line\">my-dep-5b7868d854-9x4j8   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class=\"line\">my-dep-5b7868d854-jtpbw   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class=\"line\">my-dep-5b7868d854-nb4kn   1/1     Running   0          21h   app=my-dep,pod-template-hash=5b7868d854</span><br><span class=\"line\"></span><br><span class=\"line\">在集群内使用IP:port 可以实现负载均衡访问</span><br><span class=\"line\"></span><br><span class=\"line\">也可以使用svc域名直接访问，域名规则： 服务名.所在namespace.svc     只能在pod内使用域名访问</span><br><span class=\"line\"></span><br><span class=\"line\">curl my-dep.default.svc:8000</span><br><span class=\"line\"></span><br><span class=\"line\">root@my-dep-5b7868d854-nb4kn:/<span class=\"comment\"># cat /etc/hosts </span></span><br><span class=\"line\"><span class=\"comment\"># Kubernetes-managed hosts file.</span></span><br><span class=\"line\">127.0.0.1       localhost</span><br><span class=\"line\">::1     localhost ip6-localhost ip6-loopback</span><br><span class=\"line\">fe00::0 ip6-localnet</span><br><span class=\"line\">fe00::0 ip6-mcastprefix</span><br><span class=\"line\">fe00::1 ip6-allnodes</span><br><span class=\"line\">fe00::2 ip6-allrouters</span><br><span class=\"line\">192.168.166.142 my-dep-5b7868d854-nb4kn</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-dep</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">my-dep</span>      <span class=\"comment\"># 选择标签</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411140954966.png\" alt=\"image-20230411140954966\"></p>\n<h3 id=\"nodeport\"><a class=\"markdownIt-Anchor\" href=\"#nodeport\">#</a> NodePort</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-nginx-nodeport</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">run:</span> <span class=\"string\">my-nginx-nodeport</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">run:</span> <span class=\"string\">my-nginx-nodeport</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">my-nginx-nodeport-container</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">my-nginx-nodeport</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">run:</span> <span class=\"string\">my-nginx-nodeport</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">nodePort:</span> <span class=\"number\">30380</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">run:</span> <span class=\"string\">my-nginx-nodeport</span> </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get svc </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                <span class=\"string\">TYPE</span>           <span class=\"string\">CLUSTER-IP</span>      <span class=\"string\">EXTERNAL-IP</span>   <span class=\"string\">PORT(S)</span>                         <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">my-nginx-nodeport</span>   <span class=\"string\">NodePort</span>       <span class=\"number\">10.96</span><span class=\"number\">.152</span><span class=\"number\">.128</span>   <span class=\"string\">&lt;none&gt;</span>        <span class=\"number\">80</span><span class=\"string\">:30380/TCP</span>                    <span class=\"string\">4s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># ss -lntup | grep 30380</span></span><br><span class=\"line\"><span class=\"string\">tcp</span>    <span class=\"string\">LISTEN</span>     <span class=\"number\">0</span>      <span class=\"number\">128</span>       <span class=\"string\">*:30380</span>                 <span class=\"string\">*:*</span>                   <span class=\"string\">users:((&quot;kube-proxy&quot;,pid=14706,fd=10))</span></span><br><span class=\"line\"><span class=\"string\">会在每一个节点上监听这个端口</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get  ep </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                <span class=\"string\">ENDPOINTS</span>                                                     <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">my-nginx-nodeport</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.184</span><span class=\"string\">:80,10.244.166.185:80</span>                           <span class=\"string\">5m2s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">curl节点中任何一个节点都能请求到</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">客户端请求http://192.168.13.177:30380-&gt;docker0虚拟网卡:172.17.0.1:30380-&gt;</span> <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.184</span><span class=\"string\">:80,10.244.166.185:80</span>         </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411141906087.png\" alt=\"image-20230411141906087\"></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl expose deploy my-dep --port=8000 --target-port=80 --type=NodePort</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get service </span></span><br><span class=\"line\">NAME         TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE</span><br><span class=\"line\">kubernetes   ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP          2d17h</span><br><span class=\"line\">my-dep       NodePort    10.96.206.111   &lt;none&gt;        8000:32666/TCP   6m59s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用masterip或nodeip + 端口都可以访问</span></span><br><span class=\"line\"><span class=\"comment\"># 容器内部仍可以通过域名访问，主语端口还是原来的8000</span></span><br><span class=\"line\"></span><br><span class=\"line\">32666只是用于外部访问的端口，实现公网访问</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"externalname\"><a class=\"markdownIt-Anchor\" href=\"#externalname\">#</a> externalName</h3>\n<p>跨名称空间访问</p>\n<p>需求：default 名称空间下的 client 服务想要访问 nginx-ns 名称空间下的 nginx-svc 服务</p>\n<p>service 正常情况只能代理自己 ns 下面的 pod</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">nginx-ns</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> </span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">   <span class=\"attr\">metadata:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">   <span class=\"attr\">spec:</span></span><br><span class=\"line\">     <span class=\"attr\">containers:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">       <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">       <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-svc</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">nginx-ns</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">   <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">     <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">     <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">     <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">client</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span> </span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">   <span class=\"attr\">metadata:</span></span><br><span class=\"line\">    <span class=\"attr\">labels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">   <span class=\"attr\">spec:</span></span><br><span class=\"line\">     <span class=\"attr\">containers:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">       <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">       <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">       <span class=\"attr\">command:</span> [<span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 36000&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---    </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">client-svc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ExternalName</span></span><br><span class=\"line\">  <span class=\"attr\">externalName:</span> <span class=\"string\">nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">wget</span> <span class=\"string\">-q</span> <span class=\"string\">-O</span> <span class=\"string\">client-svc</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get svc </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>              <span class=\"string\">TYPE</span>           <span class=\"string\">CLUSTER-IP</span>     <span class=\"string\">EXTERNAL-IP</span>                            <span class=\"string\">PORT(S)</span>                         <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">client-svc</span>        <span class=\"string\">ExternalName</span>   <span class=\"string\">&lt;none&gt;</span>         <span class=\"string\">nginx-svc.nginx-ns.svc.cluster.local</span>   <span class=\"number\">80</span><span class=\"string\">/TCP</span>                          <span class=\"string\">15s</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">exec</span> <span class=\"string\">-it</span>  <span class=\"string\">client-76b6556d97-xk7mg</span> <span class=\"string\">--</span> <span class=\"string\">/bin/sh</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># wget -q -O - client-svc</span></span><br><span class=\"line\">    <span class=\"string\">wget</span> <span class=\"string\">-q</span> <span class=\"string\">-O</span> <span class=\"bullet\">-</span> <span class=\"string\">nginx-svc.nginx-ns.svc.cluster.local</span></span><br><span class=\"line\"><span class=\"string\">上面两个请求的结果一样</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">此时client-svc相当于</span> <span class=\"string\">nginx-svc.nginx-ns.svc.cluster.local的软链，可以不使用名称空间直接访问软链的资源</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 映射外部服务</span></span><br><span class=\"line\"><span class=\"comment\"># k8s引用集群外的mysql</span></span><br><span class=\"line\"><span class=\"comment\"># 工作节点安装mysql</span></span><br><span class=\"line\">https://zhuanlan.zhihu.com/p/623778183</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Service</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysql</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  <span class=\"built_in\">type</span>: ClusterIP</span><br><span class=\"line\">  ports:</span><br><span class=\"line\">  - port: 3306</span><br><span class=\"line\">  </span><br><span class=\"line\"><span class=\"comment\"># 没有selector找不到endpoint</span></span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl describe svc mysql </span></span><br><span class=\"line\">Name:              mysql</span><br><span class=\"line\">Namespace:         default</span><br><span class=\"line\">Labels:            &lt;none&gt;</span><br><span class=\"line\">Annotations:       &lt;none&gt;</span><br><span class=\"line\">Selector:          &lt;none&gt;</span><br><span class=\"line\">Type:              ClusterIP</span><br><span class=\"line\">IP Families:       &lt;none&gt;</span><br><span class=\"line\">IP:                10.96.96.21</span><br><span class=\"line\">IPs:               10.96.96.21</span><br><span class=\"line\">Port:              &lt;<span class=\"built_in\">unset</span>&gt;  3306/TCP</span><br><span class=\"line\">TargetPort:        3306/TCP</span><br><span class=\"line\">Endpoints:         &lt;none&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 手动创建EP</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Endpoints</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span> <span class=\"comment\"># 和service name一致</span></span><br><span class=\"line\"><span class=\"attr\">subsets:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">addresses:</span> </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">ip:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.199</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">3306</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl describe svc mysql</span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>              <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>         <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Labels:</span>            <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Annotations:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Selector:</span>          <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Type:</span>              <span class=\"string\">ClusterIP</span></span><br><span class=\"line\"><span class=\"attr\">IP Families:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">IP:</span>                <span class=\"number\">10.96</span><span class=\"number\">.159</span><span class=\"number\">.210</span></span><br><span class=\"line\"><span class=\"attr\">IPs:</span>               <span class=\"number\">10.96</span><span class=\"number\">.159</span><span class=\"number\">.210</span></span><br><span class=\"line\"><span class=\"attr\">Port:</span>              <span class=\"string\">&lt;unset&gt;</span>  <span class=\"number\">3306</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">TargetPort:</span>        <span class=\"number\">3306</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">Endpoints:</span>         <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.199</span><span class=\"string\">:3306</span></span><br><span class=\"line\"><span class=\"attr\">Session Affinity:</span>  <span class=\"string\">None</span></span><br><span class=\"line\"><span class=\"attr\">Events:</span>            <span class=\"string\">&lt;none&gt;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"coredns\"><a class=\"markdownIt-Anchor\" href=\"#coredns\">#</a> coredns</h3>\n<p>CoreDNS 其实就是一个 DNS 服务，而 DNS 作为一种常见的服务发现手段，所以很多开源项目以及工程师都会使用 CoreDNS 为集群提供服务发现的功能，Kubernetes 就在集群中使用 CoreDNS 解决服务发现的问题。</p>\n<p>service fqdn == service_name.namespace.svc.cluster.local</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">dig</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">dig</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">dig</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">sleep</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;3600&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Always</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@</span>] <span class=\"string\">~]#</span> <span class=\"string\">kubectl</span> <span class=\"string\">exec</span> <span class=\"string\">-it</span> <span class=\"string\">dig</span> <span class=\"string\">--</span> <span class=\"string\">nslookup</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">Server:</span>\t\t<span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.10</span></span><br><span class=\"line\"><span class=\"attr\">Address:</span>\t<span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.10</span><span class=\"comment\">#53</span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>\t<span class=\"string\">kubernetes.default.svc.cluster.local</span></span><br><span class=\"line\"><span class=\"attr\">Address:</span> <span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">在k8s中创建service之后，service默认的FQDN是&lt;servicename&gt;.&lt;namespace&gt;.svc.cluster.local，那么k8s集群内部的服务就可以通过FQDN访问</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">service</span>]<span class=\"comment\"># kubectl get svc -n kube-system </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                 <span class=\"string\">TYPE</span>        <span class=\"string\">CLUSTER-IP</span>       <span class=\"string\">EXTERNAL-IP</span>   <span class=\"string\">PORT(S)</span>                  <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">kube-dns</span>             <span class=\"string\">ClusterIP</span>   <span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.10</span>       <span class=\"string\">&lt;none&gt;</span>        <span class=\"number\">53</span><span class=\"string\">/UDP,53/TCP,9153/TCP</span>   <span class=\"string\">16d</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">service</span>]<span class=\"comment\"># kubectl describe svc -n kube-system kube-dns </span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>              <span class=\"string\">kube-dns</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>         <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">IP Families:</span>       <span class=\"string\">IPv4</span></span><br><span class=\"line\"><span class=\"attr\">IP:</span>                <span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.10</span></span><br><span class=\"line\"><span class=\"attr\">IPs:</span>               <span class=\"number\">10.96</span><span class=\"number\">.0</span><span class=\"number\">.10</span></span><br><span class=\"line\"><span class=\"attr\">Port:</span>              <span class=\"string\">dns</span>  <span class=\"number\">53</span><span class=\"string\">/UDP</span></span><br><span class=\"line\"><span class=\"attr\">TargetPort:</span>        <span class=\"number\">53</span><span class=\"string\">/UDP</span></span><br><span class=\"line\"><span class=\"attr\">Endpoints:</span>         <span class=\"number\">10.244</span><span class=\"number\">.229</span><span class=\"number\">.92</span><span class=\"string\">:53,10.244.229.93:53</span></span><br><span class=\"line\"><span class=\"attr\">Port:</span>              <span class=\"string\">dns-tcp</span>  <span class=\"number\">53</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">TargetPort:</span>        <span class=\"number\">53</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">Endpoints:</span>         <span class=\"number\">10.244</span><span class=\"number\">.229</span><span class=\"number\">.92</span><span class=\"string\">:53,10.244.229.93:53</span></span><br><span class=\"line\"><span class=\"attr\">Port:</span>              <span class=\"string\">metrics</span>  <span class=\"number\">9153</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">TargetPort:</span>        <span class=\"number\">9153</span><span class=\"string\">/TCP</span></span><br><span class=\"line\"><span class=\"attr\">Endpoints:</span>         <span class=\"number\">10.244</span><span class=\"number\">.229</span><span class=\"number\">.92</span><span class=\"string\">:9153,10.244.229.93:9153</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># coredns 实现service域名解析</span></span><br><span class=\"line\"><span class=\"string\">coredns-6d8c4cb4d-jmstd</span>                     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">5</span> <span class=\"string\">(30h</span> <span class=\"string\">ago)</span>     <span class=\"string\">16d</span>     <span class=\"number\">10.244</span><span class=\"number\">.229</span><span class=\"number\">.93</span>    <span class=\"string\">prometheus-master</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">coredns-6d8c4cb4d-pg4sb</span>                     <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">5</span> <span class=\"string\">(30h</span> <span class=\"string\">ago)</span>     <span class=\"string\">16d</span>     <span class=\"number\">10.244</span><span class=\"number\">.229</span><span class=\"number\">.92</span>    <span class=\"string\">prometheus-master</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">coredns</span> <span class=\"string\">也可以解析外部域名</span></span><br><span class=\"line\">[<span class=\"string\">root@xianchaomaster1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl exec -it dig -- nslookup www.baidu.com</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"ingress\"><a class=\"markdownIt-Anchor\" href=\"#ingress\">#</a> ingress</h2>\n<p>Service 可以通过标签选择器找到它所关联的 Pod。但是属于四层代理，只能基于 IP 和端口代理。</p>\n<p>Service 的 type 类型有很多，如 NodePort、clusterIp、loadbalancer、externalname，如果 Service 想要被 k8s 集群外部访问，需要用 NodePort 类型，但是 NodePort 类型的 svc 有如下几个问题：<br>\nnodeport 会在物理机映射一个端口，绑定到物理机上，这样就导致，每个服务都要映射一个端口，端口过多，维护困难，还有就是 Service 底层使用的是 iptables 或者 ipvs，仅支持四层代理，无法基于 https 协议做代理</p>\n<p>四层负载和七层负载的区别：<br>\n区别：<br>\n1）四层负载：四层的负载均衡就是基于 IP + 端口的负载均衡：在三层负载均衡的基础上，通过发布三层的 IP 地址（VIP），然后加四层的端口号，来决定哪些流量需要做负载均衡，对需要处理的流量进行 NAT 处理，转发至后台服务器，并记录下这个 TCP 或者 UDP 的流量是由哪台服务器处理的，后续这个连接的所有流量都同样转发到同一台服务器处理。</p>\n<p>2）七层的负载均衡就是基于虚拟的 URL 或主机 IP 的负载均衡：在四层负载均衡的基础上（没有四层是绝对不可能有七层的），再考虑应用层的特征，比如同一个 Web 服务器的负载均衡，除了根据 VIP 加 80 端口辨别是否需要处理的流量，还可根据七层的 URL、浏览器类别、语言来决定是否要进行负载均衡。举个例子，如果你的 Web 服务器分成两组，一组是中文语言的，一组是英文语言的，那么七层负载均衡就可以当用户来访问你的域名时，自动辨别用户语言，然后选择对应的语言服务器组进行负载均衡处理。</p>\n<p>3）四层负载均衡工作在传输层，七层负载均衡工作在应用层</p>\n<p>ingress 是 k8s 中的资源，主要是管理 ingress-controller 这个代理的配置文件</p>\n<p>Ingress Controller 是一个七层负载均衡调度器，客户端的请求先到达这个七层负载均衡调度器，由七层负载均衡器在反向代理到后端 pod，常见的七层负载均衡器有 nginx、traefik，以我们熟悉的 nginx 为例，假如请求到达 nginx，会通过 upstream 反向代理到后端 pod 应用，但是后端 pod 的 ip 地址是一直在变化的，因此在后端 pod 前需要加一个 service，这个 service 只是起到分组的作用，那么我们 upstream 只需要填写 service 地址即可。</p>\n<p>ingress-controller 封装的 nginx，ingress 维护配置，ingress 创建好之后，会自动的把配置文件传到 ingress-controller 这个 pod 里，会自动进行 reload，然后配置就生效了。</p>\n<p>Ingress Controller<br>\nIngress Controller 结合 Ingress 定义的规则生成配置，然后动态更新 ingress-controller 里的 Nginx 或者 trafik 负载均衡器，并刷新使配置生效，来达到服务自动发现的作用。<br>\nIngress 则是定义规则，通过它定义某个域名的请求过来之后转发到集群中指定的 Service。它可以通过 Yaml 文件定义，可以给一个或多个 Service 定义一个或多个 Ingress 规则。</p>\n<p>使用 Ingress Controller 代理 k8s 内部 pod 的流程</p>\n<p>（1）部署 Ingress controller，我们 ingress controller 使用的是 nginx<br>\n（2）创建 Pod 应用，可以通过控制器创建 pod<br>\n（3）创建 Service，用来分组 pod<br>\n（4）创建 Ingress http，测试通过 http 访问应用<br>\n（5）创建 Ingress https，测试通过 https 访问应用<br>\n客户端通过七层调度器访问后端 pod 的方式</p>\n<h3 id=\"ingress-高可用\"><a class=\"markdownIt-Anchor\" href=\"#ingress-高可用\">#</a> ingress 高可用</h3>\n<p>Ingress Controller 是集群流量的接入层，对它做高可用非常重要，可以基于 keepalive 实现 nginx-ingress-controller 高可用，具体实现如下：<br>\nIngress-controller 根据 Deployment+ nodeSeletor+pod 反亲和性方式部署在 k8s 指定的两个 work 节点，nginx-ingress-controller 这个 pod 共享宿主机 ip，然后通过 keepalive+nginx 实现 nginx-ingress-controller 高可用</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># ctr -n=k8s.io images import ingress-nginx-controllerv1.1.0.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># ctr -n=k8s.io images import kube-webhook-certgen-v1.1.0.tar.gz</span></span><br><span class=\"line\"><span class=\"comment\"># kubectl apply -f ingress-deploy.yaml</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">ingress</span>]<span class=\"comment\"># kubectl get pod -n ingress-nginx -owide </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                        <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>      <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span>    <span class=\"string\">IP</span>               <span class=\"string\">NODE</span>    <span class=\"string\">NOMINATED</span> <span class=\"string\">NODE</span>   <span class=\"string\">READINESS</span> <span class=\"string\">GATES</span></span><br><span class=\"line\"><span class=\"string\">ingress-nginx-admission-create-g4qzz</span>        <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Completed</span>   <span class=\"number\">0</span>          <span class=\"string\">8m2s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.180</span>   <span class=\"string\">node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">ingress-nginx-admission-patch-r62tp</span>         <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Completed</span>   <span class=\"number\">1</span>          <span class=\"string\">8m2s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.181</span>   <span class=\"string\">node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">ingress-nginx-controller-6c8ffbbfcf-28tmg</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>     <span class=\"number\">0</span>          <span class=\"string\">82s</span>    <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.199</span>   <span class=\"string\">node1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># webhook报错，k8s版本 &gt; 1.25 报错</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">-A</span> <span class=\"string\">ValidatingWebhookConfiguration</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装nginx，keepalived，并修改配置，上传check_nginx.sh</span></span><br><span class=\"line\"><span class=\"string\">user</span> <span class=\"string\">nginx;</span></span><br><span class=\"line\"><span class=\"string\">worker_processes</span> <span class=\"string\">auto;</span></span><br><span class=\"line\"><span class=\"string\">error_log</span> <span class=\"string\">/var/log/nginx/error.log;</span></span><br><span class=\"line\"><span class=\"string\">pid</span> <span class=\"string\">/run/nginx.pid;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#include /usr/share/nginx/modules/*.conf;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">worker_connections</span> <span class=\"number\">1024</span><span class=\"string\">;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 四层负载均衡，为两台Master apiserver组件提供负载均衡</span></span><br><span class=\"line\"><span class=\"string\">stream</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">log_format</span>  <span class=\"string\">main</span>  <span class=\"string\">&#x27;$remote_addr $upstream_addr - [$time_local] $status $upstream_bytes_sent&#x27;</span><span class=\"string\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">access_log</span>  <span class=\"string\">/var/log/nginx/k8s-access.log</span>  <span class=\"string\">main;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">upstream</span> <span class=\"string\">k8s-ingress-controller</span>&#123;</span><br><span class=\"line\">       <span class=\"string\">server</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.181</span><span class=\"string\">:80</span> <span class=\"string\">weight=5</span> <span class=\"string\">max_fails=3</span> <span class=\"string\">fail_timeout=30s;</span>   </span><br><span class=\"line\">       <span class=\"string\">server</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.182</span><span class=\"string\">:80</span> <span class=\"string\">weight=5</span> <span class=\"string\">max_fails=3</span> <span class=\"string\">fail_timeout=30s;</span>  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"string\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"string\">listen</span> <span class=\"number\">30080</span><span class=\"string\">;</span> </span><br><span class=\"line\">       <span class=\"string\">proxy_pass</span> <span class=\"string\">k8s-ingress-controller;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">log_format</span>  <span class=\"string\">main</span>  <span class=\"string\">&#x27;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;$status $body_bytes_sent &quot;$http_referer&quot; &#x27;</span></span><br><span class=\"line\">                      <span class=\"string\">&#x27;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&#x27;</span><span class=\"string\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">access_log</span>  <span class=\"string\">/var/log/nginx/access.log</span>  <span class=\"string\">main;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">sendfile</span>            <span class=\"string\">on;</span></span><br><span class=\"line\">    <span class=\"string\">tcp_nopush</span>          <span class=\"string\">on;</span></span><br><span class=\"line\">    <span class=\"string\">tcp_nodelay</span>         <span class=\"string\">on;</span></span><br><span class=\"line\">    <span class=\"string\">keepalive_timeout</span>   <span class=\"number\">65</span><span class=\"string\">;</span></span><br><span class=\"line\">    <span class=\"string\">types_hash_max_size</span> <span class=\"number\">2048</span><span class=\"string\">;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"string\">include</span>             <span class=\"string\">/etc/nginx/mime.types;</span></span><br><span class=\"line\">    <span class=\"string\">default_type</span>        <span class=\"string\">application/octet-stream;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、keepalive配置</span></span><br><span class=\"line\"><span class=\"string\">主keepalived</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/keepalived/keepalived.conf </span></span><br><span class=\"line\"><span class=\"string\">global_defs</span> &#123; </span><br><span class=\"line\">   <span class=\"string\">notification_email</span> &#123; </span><br><span class=\"line\">     <span class=\"string\">acassen@firewall.loc</span> </span><br><span class=\"line\">     <span class=\"string\">failover@firewall.loc</span> </span><br><span class=\"line\">     <span class=\"string\">sysadmin@firewall.loc</span> </span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   <span class=\"string\">notification_email_from</span> <span class=\"string\">Alexandre.Cassen@firewall.loc</span>  </span><br><span class=\"line\">   <span class=\"string\">smtp_server</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> </span><br><span class=\"line\">   <span class=\"string\">smtp_connect_timeout</span> <span class=\"number\">30</span> </span><br><span class=\"line\">   <span class=\"string\">router_id</span> <span class=\"string\">NGINX_MASTER</span></span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vrrp_script</span> <span class=\"string\">check_nginx</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">script</span> <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vrrp_instance</span> <span class=\"string\">VI_1</span> &#123; </span><br><span class=\"line\">    <span class=\"string\">state</span> <span class=\"string\">MASTER</span> </span><br><span class=\"line\">    <span class=\"string\">interface</span> <span class=\"string\">ens33</span>  <span class=\"comment\"># 修改为实际网卡名</span></span><br><span class=\"line\">    <span class=\"string\">virtual_router_id</span> <span class=\"number\">51</span> <span class=\"comment\"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class=\"line\">    <span class=\"string\">priority</span> <span class=\"number\">100</span>    <span class=\"comment\"># 优先级，备服务器设置 90 </span></span><br><span class=\"line\">    <span class=\"string\">advert_int</span> <span class=\"number\">1</span>    <span class=\"comment\"># 指定VRRP 心跳包通告间隔时间，默认1秒 </span></span><br><span class=\"line\">    <span class=\"string\">authentication</span> &#123; </span><br><span class=\"line\">        <span class=\"string\">auth_type</span> <span class=\"string\">PASS</span>      </span><br><span class=\"line\">        <span class=\"string\">auth_pass</span> <span class=\"number\">1111</span> </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"comment\"># 虚拟IP</span></span><br><span class=\"line\">    <span class=\"string\">virtual_ipaddress</span> &#123; </span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.199</span><span class=\"string\">/24</span></span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"string\">track_script</span> &#123;</span><br><span class=\"line\">        <span class=\"string\">check_nginx</span></span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#vrrp_script：指定检查nginx工作状态脚本（根据nginx状态判断是否故障转移）</span></span><br><span class=\"line\"><span class=\"comment\">#virtual_ipaddress：虚拟IP（VIP）</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#1、判断Nginx是否存活</span></span><br><span class=\"line\"><span class=\"string\">counter=$(ps</span> <span class=\"string\">-ef</span> <span class=\"string\">|grep</span> <span class=\"string\">nginx</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">sbin</span> <span class=\"string\">|</span> <span class=\"string\">egrep</span> <span class=\"string\">-cv</span> <span class=\"string\">&quot;grep|$$&quot;</span> <span class=\"string\">)</span></span><br><span class=\"line\"><span class=\"string\">if</span> [ <span class=\"string\">$counter</span> <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">    <span class=\"comment\">#2、如果不存活则尝试启动Nginx</span></span><br><span class=\"line\">    <span class=\"string\">service</span> <span class=\"string\">nginx</span> <span class=\"string\">start</span></span><br><span class=\"line\">    <span class=\"string\">sleep</span> <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"comment\">#3、等待2秒后再次获取一次Nginx状态</span></span><br><span class=\"line\">    <span class=\"string\">counter=$(ps</span> <span class=\"string\">-ef</span> <span class=\"string\">|grep</span> <span class=\"string\">nginx</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">sbin</span> <span class=\"string\">|</span> <span class=\"string\">egrep</span> <span class=\"string\">-cv</span> <span class=\"string\">&quot;grep|$$&quot;</span> <span class=\"string\">)</span></span><br><span class=\"line\">    <span class=\"comment\">#4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移</span></span><br><span class=\"line\">    <span class=\"string\">if</span> [ <span class=\"string\">$counter</span> <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">service</span>  <span class=\"string\">keepalived</span> <span class=\"string\">stop</span></span><br><span class=\"line\">    <span class=\"string\">fi</span></span><br><span class=\"line\"><span class=\"string\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># chmod +x  /etc/keepalived/check_nginx.sh</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">备keepalive</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/keepalived/keepalived.conf </span></span><br><span class=\"line\"><span class=\"string\">global_defs</span> &#123; </span><br><span class=\"line\">   <span class=\"string\">notification_email</span> &#123; </span><br><span class=\"line\">     <span class=\"string\">acassen@firewall.loc</span> </span><br><span class=\"line\">     <span class=\"string\">failover@firewall.loc</span> </span><br><span class=\"line\">     <span class=\"string\">sysadmin@firewall.loc</span> </span><br><span class=\"line\">   &#125; </span><br><span class=\"line\">   <span class=\"string\">notification_email_from</span> <span class=\"string\">Alexandre.Cassen@firewall.loc</span>  </span><br><span class=\"line\">   <span class=\"string\">smtp_server</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span> </span><br><span class=\"line\">   <span class=\"string\">smtp_connect_timeout</span> <span class=\"number\">30</span> </span><br><span class=\"line\">   <span class=\"string\">router_id</span> <span class=\"string\">NGINX_BACKUP</span></span><br><span class=\"line\">&#125; </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vrrp_script</span> <span class=\"string\">check_nginx</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">script</span> <span class=\"string\">&quot;/etc/keepalived/check_nginx.sh&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vrrp_instance</span> <span class=\"string\">VI_1</span> &#123; </span><br><span class=\"line\">    <span class=\"string\">state</span> <span class=\"string\">BACKUP</span> </span><br><span class=\"line\">    <span class=\"string\">interface</span> <span class=\"string\">ens33</span></span><br><span class=\"line\">    <span class=\"string\">virtual_router_id</span> <span class=\"number\">51</span> <span class=\"comment\"># VRRP 路由 ID实例，每个实例是唯一的 </span></span><br><span class=\"line\">    <span class=\"string\">priority</span> <span class=\"number\">90</span></span><br><span class=\"line\">    <span class=\"string\">advert_int</span> <span class=\"number\">1</span></span><br><span class=\"line\">    <span class=\"string\">authentication</span> &#123; </span><br><span class=\"line\">        <span class=\"string\">auth_type</span> <span class=\"string\">PASS</span>      </span><br><span class=\"line\">        <span class=\"string\">auth_pass</span> <span class=\"number\">1111</span> </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">    <span class=\"string\">virtual_ipaddress</span> &#123; </span><br><span class=\"line\">        <span class=\"number\">192.168</span><span class=\"number\">.1</span><span class=\"number\">.199</span><span class=\"string\">/24</span></span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">    <span class=\"string\">track_script</span> &#123;</span><br><span class=\"line\">        <span class=\"string\">check_nginx</span></span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/keepalived/check_nginx.sh </span></span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"comment\">#1、判断Nginx是否存活</span></span><br><span class=\"line\"><span class=\"string\">counter=$(ps</span> <span class=\"string\">-ef</span> <span class=\"string\">|grep</span> <span class=\"string\">nginx</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">sbin</span> <span class=\"string\">|</span> <span class=\"string\">egrep</span> <span class=\"string\">-cv</span> <span class=\"string\">&quot;grep|$$&quot;</span> <span class=\"string\">)</span></span><br><span class=\"line\"><span class=\"string\">if</span> [ <span class=\"string\">$counter</span> <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">    <span class=\"comment\">#2、如果不存活则尝试启动Nginx</span></span><br><span class=\"line\">    <span class=\"string\">service</span> <span class=\"string\">nginx</span> <span class=\"string\">start</span></span><br><span class=\"line\">    <span class=\"string\">sleep</span> <span class=\"number\">2</span></span><br><span class=\"line\">    <span class=\"comment\">#3、等待2秒后再次获取一次Nginx状态</span></span><br><span class=\"line\">    <span class=\"string\">counter=$(ps</span> <span class=\"string\">-ef</span> <span class=\"string\">|grep</span> <span class=\"string\">nginx</span> <span class=\"string\">|</span> <span class=\"string\">grep</span> <span class=\"string\">sbin</span> <span class=\"string\">|</span> <span class=\"string\">egrep</span> <span class=\"string\">-cv</span> <span class=\"string\">&quot;grep|$$&quot;</span> <span class=\"string\">)</span></span><br><span class=\"line\">    <span class=\"comment\">#4、再次进行判断，如Nginx还不存活则停止Keepalived，让地址进行漂移</span></span><br><span class=\"line\">    <span class=\"string\">if</span> [ <span class=\"string\">$counter</span> <span class=\"string\">-eq</span> <span class=\"number\">0</span> ]<span class=\"string\">;</span> <span class=\"string\">then</span></span><br><span class=\"line\">        <span class=\"string\">service</span>  <span class=\"string\">keepalived</span> <span class=\"string\">stop</span></span><br><span class=\"line\">    <span class=\"string\">fi</span></span><br><span class=\"line\"><span class=\"string\">fi</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># chmod +x /etc/keepalived/check_nginx.sh</span></span><br><span class=\"line\"><span class=\"comment\">#注：keepalived根据脚本返回状态码（0为工作正常，非0不正常）判断是否故障转移。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">、启动服务：</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl enable nginx keepalived</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start nginx</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start keepalived</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">、启动服务：</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl daemon-reload</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl enable nginx keepalived</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start nginx</span></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start keepalived</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">5</span><span class=\"string\">、测试vip是否绑定成功</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># ip addr</span></span><br><span class=\"line\"><span class=\"attr\">1: lo:</span> <span class=\"string\">&lt;LOOPBACK,UP,LOWER_UP&gt;</span> <span class=\"string\">mtu</span> <span class=\"number\">65536</span> <span class=\"string\">qdisc</span> <span class=\"string\">noqueue</span> <span class=\"string\">state</span> <span class=\"string\">UNKNOWN</span> <span class=\"string\">group</span> <span class=\"string\">default</span> <span class=\"string\">qlen</span> <span class=\"number\">1000</span></span><br><span class=\"line\">    <span class=\"string\">link/loopback</span> <span class=\"number\">00</span><span class=\"string\">:00:00:00:00:00</span> <span class=\"string\">brd</span> <span class=\"number\">00</span><span class=\"string\">:00:00:00:00:00</span></span><br><span class=\"line\">    <span class=\"string\">inet</span> <span class=\"number\">127.0</span><span class=\"number\">.0</span><span class=\"number\">.1</span><span class=\"string\">/8</span> <span class=\"string\">scope</span> <span class=\"string\">host</span> <span class=\"string\">lo</span></span><br><span class=\"line\">       <span class=\"string\">valid_lft</span> <span class=\"string\">forever</span> <span class=\"string\">preferred_lft</span> <span class=\"string\">forever</span></span><br><span class=\"line\">    <span class=\"string\">inet6</span> <span class=\"string\">::1/128</span> <span class=\"string\">scope</span> <span class=\"string\">host</span> </span><br><span class=\"line\">       <span class=\"string\">valid_lft</span> <span class=\"string\">forever</span> <span class=\"string\">preferred_lft</span> <span class=\"string\">forever</span></span><br><span class=\"line\"><span class=\"attr\">2: ens33:</span> <span class=\"string\">&lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt;</span> <span class=\"string\">mtu</span> <span class=\"number\">1500 </span><span class=\"string\">qdisc</span> <span class=\"string\">pfifo_fast</span> <span class=\"string\">state</span> <span class=\"string\">UP</span> <span class=\"string\">group</span> <span class=\"string\">default</span> <span class=\"string\">qlen</span> <span class=\"number\">1000</span></span><br><span class=\"line\">    <span class=\"string\">link/ether</span> <span class=\"number\">00</span><span class=\"string\">:0c:29:79:9e:36</span> <span class=\"string\">brd</span> <span class=\"string\">ff:ff:ff:ff:ff:ff</span></span><br><span class=\"line\">    <span class=\"string\">inet</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.182</span><span class=\"string\">/24</span> <span class=\"string\">brd</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.255</span> <span class=\"string\">scope</span> <span class=\"string\">global</span> <span class=\"string\">noprefixroute</span> <span class=\"string\">ens33</span></span><br><span class=\"line\">       <span class=\"string\">valid_lft</span> <span class=\"string\">forever</span> <span class=\"string\">preferred_lft</span> <span class=\"string\">forever</span></span><br><span class=\"line\">    <span class=\"string\">inet</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.199</span><span class=\"string\">/24</span> <span class=\"string\">scope</span> <span class=\"string\">global</span> <span class=\"string\">secondary</span> <span class=\"string\">ens33</span></span><br><span class=\"line\">       <span class=\"string\">valid_lft</span> <span class=\"string\">forever</span> <span class=\"string\">preferred_lft</span> <span class=\"string\">forever</span></span><br><span class=\"line\">    <span class=\"string\">inet6</span> <span class=\"string\">fe80::b6ef:8646:1cfc:3e0c/64</span> <span class=\"string\">scope</span> <span class=\"string\">link</span> <span class=\"string\">noprefixroute</span> </span><br><span class=\"line\">       <span class=\"string\">valid_lft</span> <span class=\"string\">forever</span> <span class=\"string\">preferred_lft</span> <span class=\"string\">forever</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">daemon-reload</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">enable</span> <span class=\"string\">nginx</span> <span class=\"string\">keepalived</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">start</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">start</span> <span class=\"string\">keepalived</span></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDU5MzI3NS9hcnRpY2xlL2RldGFpbHMvMTI2MzIyMDk5P3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjcmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+QmxvZ0NvbW1lbmRGcm9tQmFpZHV+UmF0ZS03LTEyNjMyMjA5OS1ibG9nLTEwOTgxODIyMS5wY19yZWxldmFudF8zbW90aG5fc3RyYXRlZ3lfYW5kX2RhdGFfcmVjb3ZlcnkmYW1wO2RlcHRoXzEtdXRtX3NvdXJjZT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTJ+ZGVmYXVsdH5CbG9nQ29tbWVuZEZyb21CYWlkdX5SYXRlLTctMTI2MzIyMDk5LWJsb2ctMTA5ODE4MjIxLnBjX3JlbGV2YW50XzNtb3Robl9zdHJhdGVneV9hbmRfZGF0YV9yZWNvdmVyeSZhbXA7dXRtX3JlbGV2YW50X2luZGV4PTg=\">(85 条消息) REK 安装 K8S 后，Ingress-nginx 一直状态为 ContainerCreating_ingress-nginx-controller 一直是 containercreating_Steady Ben 的博客 - CSDN 博客</span></p>\n<h3 id=\"http代理pod\"><a class=\"markdownIt-Anchor\" href=\"#http代理pod\">#</a> http 代理 pod</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># http</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">    <span class=\"attr\">release:</span> <span class=\"string\">canary</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span> </span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">ajp</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">8009</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">8009</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">tomcat-deploy</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">      <span class=\"attr\">release:</span> <span class=\"string\">canary</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">        <span class=\"attr\">release:</span> <span class=\"string\">canary</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">tomcat:9.0</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span>  </span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">ajp</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">8009</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-myapp</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"comment\">#kubernetes.io/ingress.class: &quot;nginx&quot;    # 标识ingress-controller 只能在1.23以下使用，1.25需要使用IngressClassName </span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">tomcat.shabi.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> </span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8080</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">ingress</span>]<span class=\"comment\"># kubectl get ingress</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>            <span class=\"string\">CLASS</span>   <span class=\"string\">HOSTS</span>              <span class=\"string\">ADDRESS</span>          <span class=\"string\">PORTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">ingress-myapp</span>   <span class=\"string\">nginx</span>   <span class=\"string\">tomcat.shabi.com</span>   <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.199</span>   <span class=\"number\">80</span>      <span class=\"string\">3m29s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># https</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">genrsa</span> <span class=\"string\">-out</span> <span class=\"string\">tls.key</span> <span class=\"number\">2048</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">req</span> <span class=\"string\">-new</span> <span class=\"string\">-x509</span> <span class=\"string\">-key</span> <span class=\"string\">tls.key</span> <span class=\"string\">-out</span> <span class=\"string\">tls.crt</span> <span class=\"string\">-subj</span> <span class=\"string\">/C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=hhh.com</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">secret</span> <span class=\"string\">tls</span> <span class=\"string\">tomcat-ingress-secret</span> <span class=\"string\">--cert=tls.crt</span> <span class=\"string\">--key=tls.key</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span>]<span class=\"comment\"># cd /root/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># openssl genrsa -out tls.key 2048</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># openssl req -new -x509 -key tls.key -out tls.crt -subj /C=CN/ST=Beijing/L=Beijing/O=DevOps/CN=han.lucky.com</span></span><br><span class=\"line\"><span class=\"string\">（2）生成secret，在master1节点操作</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl create secret tls tomcat-ingress-secret --cert=tls.crt --key=tls.key</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-tomcat-tls</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">tls:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hosts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span>  <span class=\"string\">tomcat.shabi.com</span></span><br><span class=\"line\">    <span class=\"attr\">secretName:</span> <span class=\"string\">tomcat-ingress-secret</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">tomcat.shabi.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span>  <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">         <span class=\"attr\">service:</span></span><br><span class=\"line\">           <span class=\"attr\">name:</span> <span class=\"string\">tomcat</span></span><br><span class=\"line\">           <span class=\"attr\">port:</span></span><br><span class=\"line\">            <span class=\"attr\">number:</span> <span class=\"number\">8080</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"ingress-实现业务灰度发布\"><a class=\"markdownIt-Anchor\" href=\"#ingress-实现业务灰度发布\">#</a> ingress 实现业务灰度发布</h3>\n<p>假设线上运行了一套对外提供 7 层服务的 Service A 服务，后来开发了个新版本 Service A’ 想要上线，但又不想直接替换掉原来的 Service A，希望先灰度一小部分用户，等运行一段时间足够稳定了再逐渐全量上线新版本，最后平滑下线旧版本。这个时候就可以利用 Nginx Ingress 基于 Header 或 Cookie 进行流量切分的策略来发布，业务使用 Header 或 Cookie 来标识不同类型的用户，我们通过配置 Ingress 来实现让带有指定 Header 或 Cookie 的请求被转发到新版本，其它的仍然转发到旧版本，从而实现将新版本灰度给部分用户:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230627193032931.png\" alt=\"image-20230627193032931\"></p>\n<p>假设线上运行了一套对外提供 7 层服务的 Service B 服务，后来修复了一些问题，需要灰度上线一个新版本 Service B’，但又不想直接替换掉原来的 Service B，而是让先切 10% 的流量到新版本，等观察一段时间稳定后再逐渐加大新版本的流量比例直至完全替换旧版本，最后再滑下线旧版本，从而实现切一定比例的流量给新版本:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230627193056866.png\" alt=\"image-20230627193056866\"></p>\n<p>Ingress-Nginx 是一个 K8S ingress ingress-Nginx 是一个 K8S ingress 工具，支持配置 Ingress Annotations 来实现不同场景下的灰度发布和测试。 Nginx Annotations 支持以下几种 Canary 规则：</p>\n<p>假设我们现在部署了两个版本的服务，老版本和 canary 版本工具，支持配置 Ingress Annotations 来实现不同场景下的灰度发布和测试。 Nginx Annotations 支持以下几种 Canary 规则：</p>\n<p>假设我们现在部署了两个版本的服务，老版本和 canary 版本</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54LmluZ3Jlc3Mua3ViZXJuZXRlcy5pby9jYW5hcnktYnktaGVhZGVyJUVGJUJDJTlBJUU1JTlGJUJBJUU0JUJBJThFUmVxdWVzdA==\">nginx.ingress.kubernetes.io/canary-by-header：基于 Request</span> Header 的流量切分，适用于灰度发布以及 A/B 测试。当 Request Header 设置为 always 时，请求将会被一直发送到 Canary 版本；当 Request Header 设置为 never 时，请求不会被发送到 Canary 入口。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54LmluZ3Jlc3Mua3ViZXJuZXRlcy5pby9jYW5hcnktYnktaGVhZGVyLXZhbHVlJUVGJUJDJTlBJUU4JUE2JTgxJUU1JThDJUI5JUU5JTg1JThEJUU3JTlBJTg0\">nginx.ingress.kubernetes.io/canary-by-header-value：要匹配的</span> Request Header 的值，用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务。当 Request Header 设置为此值时，它将被路由到 Canary 入口。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54LmluZ3Jlc3Mua3ViZXJuZXRlcy5pby9jYW5hcnktd2VpZ2h0JUVGJUJDJTlBJUU1JTlGJUJBJUU0JUJBJThFJUU2JTlDJThEJUU1JThBJUExJUU2JTlEJTgzJUU5JTg3JThEJUU3JTlBJTg0JUU2JUI1JTgxJUU5JTg3JThGJUU1JTg4JTg3JUU1JTg4JTg2JUVGJUJDJThDJUU5JTgwJTgyJUU3JTk0JUE4JUU0JUJBJThFJUU4JTkzJTlEJUU3JUJCJUJGJUU5JTgzJUE4JUU3JUJEJUIyJUVGJUJDJThDJUU2JTlEJTgzJUU5JTg3JThEJUU4JThDJTgzJUU1JTlCJUI0\">nginx.ingress.kubernetes.io/canary-weight：基于服务权重的流量切分，适用于蓝绿部署，权重范围</span> 0 - 100 按百分比将请求路由到 Canary Ingress 中指定的服务。权重为 0 意味着该金丝雀规则不会向 Canary 入口的服务发送任何请求。权重为 60 意味着 60% 流量转到 canary。权重为 100 意味着所有请求都将被发送到 Canary 入口。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54LmluZ3Jlc3Mua3ViZXJuZXRlcy5pby9jYW5hcnktYnktY29va2llJUVGJUJDJTlBJUU1JTlGJUJBJUU0JUJBJThF\">nginx.ingress.kubernetes.io/canary-by-cookie：基于</span> Cookie 的流量切分，适用于灰度发布与 A/B 测试。用于通知 Ingress 将请求路由到 Canary Ingress 中指定的服务的 cookie。当 cookie 值设置为 always 时，它将被路由到 Canary 入口；当 cookie 值设置为 never 时，请求不会被发送到 Canary 入口。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># v1</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">&quot;openresty/openresty:centos&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/local/openresty/nginx/conf/nginx.conf</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">nginx.conf</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx.conf:</span> <span class=\"string\">|-</span></span><br><span class=\"line\"><span class=\"string\">    worker_processes  1;</span></span><br><span class=\"line\"><span class=\"string\">    events &#123;</span></span><br><span class=\"line\"><span class=\"string\">        accept_mutex on;</span></span><br><span class=\"line\"><span class=\"string\">        multi_accept on;</span></span><br><span class=\"line\"><span class=\"string\">        use epoll;</span></span><br><span class=\"line\"><span class=\"string\">        worker_connections  1024;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    http &#123;</span></span><br><span class=\"line\"><span class=\"string\">        ignore_invalid_headers off;</span></span><br><span class=\"line\"><span class=\"string\">        server &#123;</span></span><br><span class=\"line\"><span class=\"string\">            listen 80;</span></span><br><span class=\"line\"><span class=\"string\">            location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                access_by_lua &#x27;</span></span><br><span class=\"line\"><span class=\"string\">                    local header_str = ngx.say(&quot;nginx-v1&quot;)</span></span><br><span class=\"line\"><span class=\"string\">                &#x27;;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># v2</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">&quot;openresty/openresty:centos&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/local/openresty/nginx/conf/nginx.conf</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">          <span class=\"attr\">subPath:</span> <span class=\"string\">nginx.conf</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">        <span class=\"attr\">configMap:</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">nginx.conf:</span> <span class=\"string\">|-</span></span><br><span class=\"line\"><span class=\"string\">    worker_processes  1;</span></span><br><span class=\"line\"><span class=\"string\">    events &#123;</span></span><br><span class=\"line\"><span class=\"string\">        accept_mutex on;</span></span><br><span class=\"line\"><span class=\"string\">        multi_accept on;</span></span><br><span class=\"line\"><span class=\"string\">        use epoll;</span></span><br><span class=\"line\"><span class=\"string\">        worker_connections  1024;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\">    http &#123;</span></span><br><span class=\"line\"><span class=\"string\">        ignore_invalid_headers off;</span></span><br><span class=\"line\"><span class=\"string\">        server &#123;</span></span><br><span class=\"line\"><span class=\"string\">            listen 80;</span></span><br><span class=\"line\"><span class=\"string\">            location / &#123;</span></span><br><span class=\"line\"><span class=\"string\">                access_by_lua &#x27;</span></span><br><span class=\"line\"><span class=\"string\">                    local header_str = ngx.say(&quot;nginx-v2&quot;)</span></span><br><span class=\"line\"><span class=\"string\">                &#x27;;</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">        &#125;</span></span><br><span class=\"line\"><span class=\"string\">    &#125;</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">version:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ingress</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">canary.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span>  <span class=\"comment\">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span>  <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span>  <span class=\"comment\">#配置后端服务</span></span><br><span class=\"line\">         <span class=\"attr\">service:</span></span><br><span class=\"line\">           <span class=\"attr\">name:</span> <span class=\"string\">nginx-v1</span></span><br><span class=\"line\">           <span class=\"attr\">port:</span></span><br><span class=\"line\">            <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            </span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">http://192.168.13.199</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于 Header 的流量切分：</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header:</span> <span class=\"string\">&quot;Region&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-header-pattern:</span> <span class=\"string\">&quot;cd|sz&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-canary</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">canary.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span>  <span class=\"comment\">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span>  <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span>  <span class=\"comment\">#配置后端服务</span></span><br><span class=\"line\">         <span class=\"attr\">service:</span></span><br><span class=\"line\">           <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\">           <span class=\"attr\">port:</span></span><br><span class=\"line\">            <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            </span><br><span class=\"line\">            </span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Region: cd&quot;</span> <span class=\"string\">http://192.168.13.199</span>   <span class=\"string\">//v2</span></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Region: sz&quot;</span> <span class=\"string\">http://192.168.13.199</span>   <span class=\"string\">//v2</span></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Region: cc&quot;</span> <span class=\"string\">http://192.168.13.199</span>   <span class=\"string\">//v1</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于 Cookie 的流量切分：</span></span><br><span class=\"line\"><span class=\"string\">与前面</span> <span class=\"string\">Header</span> <span class=\"string\">类似，不过使用</span> <span class=\"string\">Cookie</span> <span class=\"string\">就无法自定义</span> <span class=\"string\">value</span> <span class=\"string\">了，这里以模拟灰度成都地域用户为例，仅将带有名为</span> <span class=\"string\">user_from_cd</span> <span class=\"string\">的</span> <span class=\"string\">cookie</span> <span class=\"string\">的请求转发给当前</span> <span class=\"string\">Canary</span> <span class=\"string\">Ingress</span> <span class=\"string\">。先删除前面基于</span> <span class=\"string\">Header</span> <span class=\"string\">的流量切分的</span> <span class=\"string\">Canary</span> <span class=\"string\">Ingress，然后创建下面新的</span> <span class=\"attr\">Canary Ingress:</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-by-cookie:</span> <span class=\"string\">&quot;user_from_cd&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-canary</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">canary.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span>  <span class=\"comment\">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span>  <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span>  <span class=\"comment\">#配置后端服务</span></span><br><span class=\"line\">         <span class=\"attr\">service:</span></span><br><span class=\"line\">           <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\">           <span class=\"attr\">port:</span></span><br><span class=\"line\">            <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"string\">curl</span> <span class=\"string\">-s</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">--cookie</span> <span class=\"string\">&quot;user_from_cd=always&quot;</span> <span class=\"string\">http://192.168.13.199</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 基于服务权重的流量切分</span></span><br><span class=\"line\"><span class=\"string\">基于服务权重的</span> <span class=\"string\">Canary</span> <span class=\"string\">Ingress</span> <span class=\"string\">直接定义需要导入的流量比例，这里以导入</span> <span class=\"number\">10</span><span class=\"string\">%</span> <span class=\"string\">流量到</span> <span class=\"string\">v2</span> <span class=\"string\">版本为例</span> <span class=\"string\">(如果有，先删除之前的</span> <span class=\"string\">Canary</span> <span class=\"string\">Ingress):</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">kubernetes.io/ingress.class:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/canary-weight:</span> <span class=\"string\">&quot;10&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-canary</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">canary.example.com</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">path:</span> <span class=\"string\">/</span>  <span class=\"comment\">#配置访问路径，如果通过url进行转发，需要修改；空默认为访问的路径为&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">pathType:</span>  <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span>  <span class=\"comment\">#配置后端服务</span></span><br><span class=\"line\">         <span class=\"attr\">service:</span></span><br><span class=\"line\">           <span class=\"attr\">name:</span> <span class=\"string\">nginx-v2</span></span><br><span class=\"line\">           <span class=\"attr\">port:</span></span><br><span class=\"line\">            <span class=\"attr\">number:</span> <span class=\"number\">80</span></span><br><span class=\"line\">            </span><br><span class=\"line\"><span class=\"string\">for</span> <span class=\"string\">i</span> <span class=\"string\">in</span> &#123;<span class=\"number\">1</span><span class=\"string\">..10</span>&#125;<span class=\"string\">;</span> <span class=\"string\">do</span> <span class=\"string\">curl</span> <span class=\"string\">-H</span> <span class=\"string\">&quot;Host: canary.example.com&quot;</span> <span class=\"string\">http://192.168.13.199;</span> <span class=\"string\">done;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ingress service 的统一网关入口</span></span><br><span class=\"line\"><span class=\"comment\"># service pod的统一入口</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411143640824.png\" alt=\"image-20230411143640824\"></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br><span class=\"line\">256</span><br><span class=\"line\">257</span><br><span class=\"line\">258</span><br><span class=\"line\">259</span><br><span class=\"line\">260</span><br><span class=\"line\">261</span><br><span class=\"line\">262</span><br><span class=\"line\">263</span><br><span class=\"line\">264</span><br><span class=\"line\">265</span><br><span class=\"line\">266</span><br><span class=\"line\">267</span><br><span class=\"line\">268</span><br><span class=\"line\">269</span><br><span class=\"line\">270</span><br><span class=\"line\">271</span><br><span class=\"line\">272</span><br><span class=\"line\">273</span><br><span class=\"line\">274</span><br><span class=\"line\">275</span><br><span class=\"line\">276</span><br><span class=\"line\">277</span><br><span class=\"line\">278</span><br><span class=\"line\">279</span><br><span class=\"line\">280</span><br><span class=\"line\">281</span><br><span class=\"line\">282</span><br><span class=\"line\">283</span><br><span class=\"line\">284</span><br><span class=\"line\">285</span><br><span class=\"line\">286</span><br><span class=\"line\">287</span><br><span class=\"line\">288</span><br><span class=\"line\">289</span><br><span class=\"line\">290</span><br><span class=\"line\">291</span><br><span class=\"line\">292</span><br><span class=\"line\">293</span><br><span class=\"line\">294</span><br><span class=\"line\">295</span><br><span class=\"line\">296</span><br><span class=\"line\">297</span><br><span class=\"line\">298</span><br><span class=\"line\">299</span><br><span class=\"line\">300</span><br><span class=\"line\">301</span><br><span class=\"line\">302</span><br><span class=\"line\">303</span><br><span class=\"line\">304</span><br><span class=\"line\">305</span><br><span class=\"line\">306</span><br><span class=\"line\">307</span><br><span class=\"line\">308</span><br><span class=\"line\">309</span><br><span class=\"line\">310</span><br><span class=\"line\">311</span><br><span class=\"line\">312</span><br><span class=\"line\">313</span><br><span class=\"line\">314</span><br><span class=\"line\">315</span><br><span class=\"line\">316</span><br><span class=\"line\">317</span><br><span class=\"line\">318</span><br><span class=\"line\">319</span><br><span class=\"line\">320</span><br><span class=\"line\">321</span><br><span class=\"line\">322</span><br><span class=\"line\">323</span><br><span class=\"line\">324</span><br><span class=\"line\">325</span><br><span class=\"line\">326</span><br><span class=\"line\">327</span><br><span class=\"line\">328</span><br><span class=\"line\">329</span><br><span class=\"line\">330</span><br><span class=\"line\">331</span><br><span class=\"line\">332</span><br><span class=\"line\">333</span><br><span class=\"line\">334</span><br><span class=\"line\">335</span><br><span class=\"line\">336</span><br><span class=\"line\">337</span><br><span class=\"line\">338</span><br><span class=\"line\">339</span><br><span class=\"line\">340</span><br><span class=\"line\">341</span><br><span class=\"line\">342</span><br><span class=\"line\">343</span><br><span class=\"line\">344</span><br><span class=\"line\">345</span><br><span class=\"line\">346</span><br><span class=\"line\">347</span><br><span class=\"line\">348</span><br><span class=\"line\">349</span><br><span class=\"line\">350</span><br><span class=\"line\">351</span><br><span class=\"line\">352</span><br><span class=\"line\">353</span><br><span class=\"line\">354</span><br><span class=\"line\">355</span><br><span class=\"line\">356</span><br><span class=\"line\">357</span><br><span class=\"line\">358</span><br><span class=\"line\">359</span><br><span class=\"line\">360</span><br><span class=\"line\">361</span><br><span class=\"line\">362</span><br><span class=\"line\">363</span><br><span class=\"line\">364</span><br><span class=\"line\">365</span><br><span class=\"line\">366</span><br><span class=\"line\">367</span><br><span class=\"line\">368</span><br><span class=\"line\">369</span><br><span class=\"line\">370</span><br><span class=\"line\">371</span><br><span class=\"line\">372</span><br><span class=\"line\">373</span><br><span class=\"line\">374</span><br><span class=\"line\">375</span><br><span class=\"line\">376</span><br><span class=\"line\">377</span><br><span class=\"line\">378</span><br><span class=\"line\">379</span><br><span class=\"line\">380</span><br><span class=\"line\">381</span><br><span class=\"line\">382</span><br><span class=\"line\">383</span><br><span class=\"line\">384</span><br><span class=\"line\">385</span><br><span class=\"line\">386</span><br><span class=\"line\">387</span><br><span class=\"line\">388</span><br><span class=\"line\">389</span><br><span class=\"line\">390</span><br><span class=\"line\">391</span><br><span class=\"line\">392</span><br><span class=\"line\">393</span><br><span class=\"line\">394</span><br><span class=\"line\">395</span><br><span class=\"line\">396</span><br><span class=\"line\">397</span><br><span class=\"line\">398</span><br><span class=\"line\">399</span><br><span class=\"line\">400</span><br><span class=\"line\">401</span><br><span class=\"line\">402</span><br><span class=\"line\">403</span><br><span class=\"line\">404</span><br><span class=\"line\">405</span><br><span class=\"line\">406</span><br><span class=\"line\">407</span><br><span class=\"line\">408</span><br><span class=\"line\">409</span><br><span class=\"line\">410</span><br><span class=\"line\">411</span><br><span class=\"line\">412</span><br><span class=\"line\">413</span><br><span class=\"line\">414</span><br><span class=\"line\">415</span><br><span class=\"line\">416</span><br><span class=\"line\">417</span><br><span class=\"line\">418</span><br><span class=\"line\">419</span><br><span class=\"line\">420</span><br><span class=\"line\">421</span><br><span class=\"line\">422</span><br><span class=\"line\">423</span><br><span class=\"line\">424</span><br><span class=\"line\">425</span><br><span class=\"line\">426</span><br><span class=\"line\">427</span><br><span class=\"line\">428</span><br><span class=\"line\">429</span><br><span class=\"line\">430</span><br><span class=\"line\">431</span><br><span class=\"line\">432</span><br><span class=\"line\">433</span><br><span class=\"line\">434</span><br><span class=\"line\">435</span><br><span class=\"line\">436</span><br><span class=\"line\">437</span><br><span class=\"line\">438</span><br><span class=\"line\">439</span><br><span class=\"line\">440</span><br><span class=\"line\">441</span><br><span class=\"line\">442</span><br><span class=\"line\">443</span><br><span class=\"line\">444</span><br><span class=\"line\">445</span><br><span class=\"line\">446</span><br><span class=\"line\">447</span><br><span class=\"line\">448</span><br><span class=\"line\">449</span><br><span class=\"line\">450</span><br><span class=\"line\">451</span><br><span class=\"line\">452</span><br><span class=\"line\">453</span><br><span class=\"line\">454</span><br><span class=\"line\">455</span><br><span class=\"line\">456</span><br><span class=\"line\">457</span><br><span class=\"line\">458</span><br><span class=\"line\">459</span><br><span class=\"line\">460</span><br><span class=\"line\">461</span><br><span class=\"line\">462</span><br><span class=\"line\">463</span><br><span class=\"line\">464</span><br><span class=\"line\">465</span><br><span class=\"line\">466</span><br><span class=\"line\">467</span><br><span class=\"line\">468</span><br><span class=\"line\">469</span><br><span class=\"line\">470</span><br><span class=\"line\">471</span><br><span class=\"line\">472</span><br><span class=\"line\">473</span><br><span class=\"line\">474</span><br><span class=\"line\">475</span><br><span class=\"line\">476</span><br><span class=\"line\">477</span><br><span class=\"line\">478</span><br><span class=\"line\">479</span><br><span class=\"line\">480</span><br><span class=\"line\">481</span><br><span class=\"line\">482</span><br><span class=\"line\">483</span><br><span class=\"line\">484</span><br><span class=\"line\">485</span><br><span class=\"line\">486</span><br><span class=\"line\">487</span><br><span class=\"line\">488</span><br><span class=\"line\">489</span><br><span class=\"line\">490</span><br><span class=\"line\">491</span><br><span class=\"line\">492</span><br><span class=\"line\">493</span><br><span class=\"line\">494</span><br><span class=\"line\">495</span><br><span class=\"line\">496</span><br><span class=\"line\">497</span><br><span class=\"line\">498</span><br><span class=\"line\">499</span><br><span class=\"line\">500</span><br><span class=\"line\">501</span><br><span class=\"line\">502</span><br><span class=\"line\">503</span><br><span class=\"line\">504</span><br><span class=\"line\">505</span><br><span class=\"line\">506</span><br><span class=\"line\">507</span><br><span class=\"line\">508</span><br><span class=\"line\">509</span><br><span class=\"line\">510</span><br><span class=\"line\">511</span><br><span class=\"line\">512</span><br><span class=\"line\">513</span><br><span class=\"line\">514</span><br><span class=\"line\">515</span><br><span class=\"line\">516</span><br><span class=\"line\">517</span><br><span class=\"line\">518</span><br><span class=\"line\">519</span><br><span class=\"line\">520</span><br><span class=\"line\">521</span><br><span class=\"line\">522</span><br><span class=\"line\">523</span><br><span class=\"line\">524</span><br><span class=\"line\">525</span><br><span class=\"line\">526</span><br><span class=\"line\">527</span><br><span class=\"line\">528</span><br><span class=\"line\">529</span><br><span class=\"line\">530</span><br><span class=\"line\">531</span><br><span class=\"line\">532</span><br><span class=\"line\">533</span><br><span class=\"line\">534</span><br><span class=\"line\">535</span><br><span class=\"line\">536</span><br><span class=\"line\">537</span><br><span class=\"line\">538</span><br><span class=\"line\">539</span><br><span class=\"line\">540</span><br><span class=\"line\">541</span><br><span class=\"line\">542</span><br><span class=\"line\">543</span><br><span class=\"line\">544</span><br><span class=\"line\">545</span><br><span class=\"line\">546</span><br><span class=\"line\">547</span><br><span class=\"line\">548</span><br><span class=\"line\">549</span><br><span class=\"line\">550</span><br><span class=\"line\">551</span><br><span class=\"line\">552</span><br><span class=\"line\">553</span><br><span class=\"line\">554</span><br><span class=\"line\">555</span><br><span class=\"line\">556</span><br><span class=\"line\">557</span><br><span class=\"line\">558</span><br><span class=\"line\">559</span><br><span class=\"line\">560</span><br><span class=\"line\">561</span><br><span class=\"line\">562</span><br><span class=\"line\">563</span><br><span class=\"line\">564</span><br><span class=\"line\">565</span><br><span class=\"line\">566</span><br><span class=\"line\">567</span><br><span class=\"line\">568</span><br><span class=\"line\">569</span><br><span class=\"line\">570</span><br><span class=\"line\">571</span><br><span class=\"line\">572</span><br><span class=\"line\">573</span><br><span class=\"line\">574</span><br><span class=\"line\">575</span><br><span class=\"line\">576</span><br><span class=\"line\">577</span><br><span class=\"line\">578</span><br><span class=\"line\">579</span><br><span class=\"line\">580</span><br><span class=\"line\">581</span><br><span class=\"line\">582</span><br><span class=\"line\">583</span><br><span class=\"line\">584</span><br><span class=\"line\">585</span><br><span class=\"line\">586</span><br><span class=\"line\">587</span><br><span class=\"line\">588</span><br><span class=\"line\">589</span><br><span class=\"line\">590</span><br><span class=\"line\">591</span><br><span class=\"line\">592</span><br><span class=\"line\">593</span><br><span class=\"line\">594</span><br><span class=\"line\">595</span><br><span class=\"line\">596</span><br><span class=\"line\">597</span><br><span class=\"line\">598</span><br><span class=\"line\">599</span><br><span class=\"line\">600</span><br><span class=\"line\">601</span><br><span class=\"line\">602</span><br><span class=\"line\">603</span><br><span class=\"line\">604</span><br><span class=\"line\">605</span><br><span class=\"line\">606</span><br><span class=\"line\">607</span><br><span class=\"line\">608</span><br><span class=\"line\">609</span><br><span class=\"line\">610</span><br><span class=\"line\">611</span><br><span class=\"line\">612</span><br><span class=\"line\">613</span><br><span class=\"line\">614</span><br><span class=\"line\">615</span><br><span class=\"line\">616</span><br><span class=\"line\">617</span><br><span class=\"line\">618</span><br><span class=\"line\">619</span><br><span class=\"line\">620</span><br><span class=\"line\">621</span><br><span class=\"line\">622</span><br><span class=\"line\">623</span><br><span class=\"line\">624</span><br><span class=\"line\">625</span><br><span class=\"line\">626</span><br><span class=\"line\">627</span><br><span class=\"line\">628</span><br><span class=\"line\">629</span><br><span class=\"line\">630</span><br><span class=\"line\">631</span><br><span class=\"line\">632</span><br><span class=\"line\">633</span><br><span class=\"line\">634</span><br><span class=\"line\">635</span><br><span class=\"line\">636</span><br><span class=\"line\">637</span><br><span class=\"line\">638</span><br><span class=\"line\">639</span><br><span class=\"line\">640</span><br><span class=\"line\">641</span><br><span class=\"line\">642</span><br><span class=\"line\">643</span><br><span class=\"line\">644</span><br><span class=\"line\">645</span><br><span class=\"line\">646</span><br><span class=\"line\">647</span><br><span class=\"line\">648</span><br><span class=\"line\">649</span><br><span class=\"line\">650</span><br><span class=\"line\">651</span><br><span class=\"line\">652</span><br><span class=\"line\">653</span><br><span class=\"line\">654</span><br><span class=\"line\">655</span><br><span class=\"line\">656</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装ingress</span></span><br><span class=\"line\"><span class=\"comment\"># 使用如下yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-serviceaccount.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">automountServiceAccountToken:</span> <span class=\"literal\">true</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-configmap.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-controller</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/clusterrole.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">nodes</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">secrets</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">nodes</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">services</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">extensions</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingresses</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">events</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">create</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">patch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">extensions</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingresses/status</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">update</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingressclasses</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/clusterrolebinding.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-role.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">namespaces</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">secrets</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">endpoints</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">services</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">extensions</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingresses</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">extensions</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingresses/status</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">update</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span>   <span class=\"comment\"># k8s 1.14+</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingressclasses</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\">    <span class=\"attr\">resourceNames:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">ingress-controller-leader-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">update</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">create</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">events</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">create</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">patch</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-rolebinding.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-service-webhook.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-controller-admission</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">ClusterIP</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">https-webhook</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">443</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"string\">webhook</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-service.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-controller</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">type:</span> <span class=\"string\">NodePort</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"string\">http</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">https</span></span><br><span class=\"line\">      <span class=\"attr\">port:</span> <span class=\"number\">443</span></span><br><span class=\"line\">      <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">      <span class=\"attr\">targetPort:</span> <span class=\"string\">https</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/controller-deployment.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-controller</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">      <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">  <span class=\"attr\">revisionHistoryLimit:</span> <span class=\"number\">10</span></span><br><span class=\"line\">  <span class=\"attr\">minReadySeconds:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">dnsPolicy:</span> <span class=\"string\">ClusterFirst</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">controller</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/ingress-nginx-controller:v0.46.0</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">lifecycle:</span></span><br><span class=\"line\">            <span class=\"attr\">preStop:</span></span><br><span class=\"line\">              <span class=\"attr\">exec:</span></span><br><span class=\"line\">                <span class=\"attr\">command:</span></span><br><span class=\"line\">                  <span class=\"bullet\">-</span> <span class=\"string\">/wait-shutdown</span></span><br><span class=\"line\">          <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">/nginx-ingress-controller</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--election-id=ingress-controller-leader</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--ingress-class=nginx</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--configmap=$(POD_NAMESPACE)/ingress-nginx-controller</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--validating-webhook=:8443</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--validating-webhook-certificate=/usr/local/certificates/cert</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--validating-webhook-key=/usr/local/certificates/key</span></span><br><span class=\"line\">          <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">            <span class=\"attr\">capabilities:</span></span><br><span class=\"line\">              <span class=\"attr\">drop:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">ALL</span></span><br><span class=\"line\">              <span class=\"attr\">add:</span></span><br><span class=\"line\">                <span class=\"bullet\">-</span> <span class=\"string\">NET_BIND_SERVICE</span></span><br><span class=\"line\">            <span class=\"attr\">runAsUser:</span> <span class=\"number\">101</span></span><br><span class=\"line\">            <span class=\"attr\">allowPrivilegeEscalation:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.name</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">LD_PRELOAD</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/usr/local/lib/libmimalloc.so</span></span><br><span class=\"line\">          <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">5</span></span><br><span class=\"line\">            <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">              <span class=\"attr\">path:</span> <span class=\"string\">/healthz</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span> <span class=\"number\">10254</span></span><br><span class=\"line\">              <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">            <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">            <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">              <span class=\"attr\">path:</span> <span class=\"string\">/healthz</span></span><br><span class=\"line\">              <span class=\"attr\">port:</span> <span class=\"number\">10254</span></span><br><span class=\"line\">              <span class=\"attr\">scheme:</span> <span class=\"string\">HTTP</span></span><br><span class=\"line\">            <span class=\"attr\">initialDelaySeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">            <span class=\"attr\">successThreshold:</span> <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"attr\">timeoutSeconds:</span> <span class=\"number\">1</span></span><br><span class=\"line\">          <span class=\"attr\">ports:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">http</span></span><br><span class=\"line\">              <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">https</span></span><br><span class=\"line\">              <span class=\"attr\">containerPort:</span> <span class=\"number\">443</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">webhook</span></span><br><span class=\"line\">              <span class=\"attr\">containerPort:</span> <span class=\"number\">8443</span></span><br><span class=\"line\">              <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">webhook-cert</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/local/certificates/</span></span><br><span class=\"line\">              <span class=\"attr\">readOnly:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">resources:</span></span><br><span class=\"line\">            <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">90Mi</span></span><br><span class=\"line\">      <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">kubernetes.io/os:</span> <span class=\"string\">linux</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">      <span class=\"attr\">terminationGracePeriodSeconds:</span> <span class=\"number\">300</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">webhook-cert</span></span><br><span class=\"line\">          <span class=\"attr\">secret:</span></span><br><span class=\"line\">            <span class=\"attr\">secretName:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/validating-webhook.yaml</span></span><br><span class=\"line\"><span class=\"comment\"># before changing this value, check the required kubernetes version</span></span><br><span class=\"line\"><span class=\"comment\"># https://kubernetes.io/docs/reference/access-authn-authz/extensible-admission-controllers/#prerequisites</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">admissionregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ValidatingWebhookConfiguration</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\"><span class=\"attr\">webhooks:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">validate.nginx.ingress.kubernetes.io</span></span><br><span class=\"line\">    <span class=\"attr\">matchPolicy:</span> <span class=\"string\">Equivalent</span></span><br><span class=\"line\">    <span class=\"attr\">rules:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">networking.k8s.io</span></span><br><span class=\"line\">        <span class=\"attr\">apiVersions:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">v1beta1</span></span><br><span class=\"line\">        <span class=\"attr\">operations:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">CREATE</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">UPDATE</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"bullet\">-</span> <span class=\"string\">ingresses</span></span><br><span class=\"line\">    <span class=\"attr\">failurePolicy:</span> <span class=\"string\">Fail</span></span><br><span class=\"line\">    <span class=\"attr\">sideEffects:</span> <span class=\"string\">None</span></span><br><span class=\"line\">    <span class=\"attr\">admissionReviewVersions:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">v1</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">v1beta1</span></span><br><span class=\"line\">    <span class=\"attr\">clientConfig:</span></span><br><span class=\"line\">      <span class=\"attr\">service:</span></span><br><span class=\"line\">        <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-controller-admission</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">/networking/v1beta1/ingresses</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/serviceaccount.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrole.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">admissionregistration.k8s.io</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">validatingwebhookconfigurations</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">update</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/clusterrolebinding.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/role.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">secrets</span></span><br><span class=\"line\">    <span class=\"attr\">verbs:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">create</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/rolebinding.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade,post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-createSecret.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">batch/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Job</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission-create</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">pre-install,pre-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission-create</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">create</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">docker.io/jettech/kube-webhook-certgen:v1.5.1</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">create</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--host=ingress-nginx-controller-admission,ingress-nginx-controller-admission.$(POD_NAMESPACE).svc</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--namespace=$(POD_NAMESPACE)</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--secret-name=ingress-nginx-admission</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">OnFailure</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">2000</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"comment\"># Source: ingress-nginx/templates/admission-webhooks/job-patch/job-patchWebhook.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">batch/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Job</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission-patch</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook:</span> <span class=\"string\">post-install,post-upgrade</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/hook-delete-policy:</span> <span class=\"string\">before-hook-creation,hook-succeeded</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">    <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">ingress-nginx-admission-patch</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">helm.sh/chart:</span> <span class=\"string\">ingress-nginx-3.33.0</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/name:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/instance:</span> <span class=\"string\">ingress-nginx</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/version:</span> <span class=\"number\">0.47</span><span class=\"number\">.0</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/managed-by:</span> <span class=\"string\">Helm</span></span><br><span class=\"line\">        <span class=\"attr\">app.kubernetes.io/component:</span> <span class=\"string\">admission-webhook</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">patch</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">docker.io/jettech/kube-webhook-certgen:v1.5.1</span></span><br><span class=\"line\">          <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">args:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">patch</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--webhook-name=ingress-nginx-admission</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--namespace=$(POD_NAMESPACE)</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--patch-mutating=false</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--secret-name=ingress-nginx-admission</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"string\">--patch-failure-policy=Fail</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">POD_NAMESPACE</span></span><br><span class=\"line\">              <span class=\"attr\">valueFrom:</span></span><br><span class=\"line\">                <span class=\"attr\">fieldRef:</span></span><br><span class=\"line\">                  <span class=\"attr\">fieldPath:</span> <span class=\"string\">metadata.namespace</span></span><br><span class=\"line\">      <span class=\"attr\">restartPolicy:</span> <span class=\"string\">OnFailure</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">ingress-nginx-admission</span></span><br><span class=\"line\">      <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">        <span class=\"attr\">runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">        <span class=\"attr\">runAsUser:</span> <span class=\"number\">2000</span></span><br><span class=\"line\">        </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"创建ingress\"><a class=\"markdownIt-Anchor\" href=\"#创建ingress\">#</a> 创建 ingress</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f ingress.yml</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get service -A </span></span><br><span class=\"line\">NAMESPACE              NAME                                 TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)                      AGE</span><br><span class=\"line\">calico-system          calico-typha                         ClusterIP   10.96.222.97    &lt;none&gt;        5473/TCP                     2d17h</span><br><span class=\"line\">default                kubernetes                           ClusterIP   10.96.0.1       &lt;none&gt;        443/TCP                      2d17h</span><br><span class=\"line\">default                my-dep                               NodePort    10.96.206.111   &lt;none&gt;        8000:32666/TCP               22m</span><br><span class=\"line\">ingress-nginx          ingress-nginx-controller             NodePort    10.96.18.49     &lt;none&gt;        80:31625/TCP,443:31507/TCP   112s</span><br><span class=\"line\">ingress-nginx          ingress-nginx-controller-admission   ClusterIP   10.96.19.25     &lt;none&gt;        443/TCP                      112s</span><br><span class=\"line\"></span><br><span class=\"line\">ingress 就是一个nginx</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">https://139.198.179.44:31507/</span><br><span class=\"line\">http://139.198.179.44:31625</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># ingress.yml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/hello-server</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">9000</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"number\">9000</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eyJhbGciOiJSUzI1NiIsImtpZCI6IkY5LU9Jc0pnblNNOVJhM1dlWVl6c09DTjNnbFNQa1hzcWhOSThHVENEdlUifQ.eyJpc3MiOiJrdWJlcm5ldGVzL3NlcnZpY2VhY2NvdW50Iiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9uYW1lc3BhY2UiOiJrdWJlcm5ldGVzLWRhc2hib2FyZCIsImt1YmVybmV0ZXMuaW8vc2VydmljZWFjY291bnQvc2VjcmV0Lm5hbWUiOiJhZG1pbi11c2VyLXRva2VuLXp3NmRzIiwia3ViZXJuZXRlcy5pby9zZXJ2aWNlYWNjb3VudC9zZXJ2aWNlLWFjY291bnQubmFtZSI6ImFkbWluLXVzZXIiLCJrdWJlcm5ldGVzLmlvL3NlcnZpY2VhY2NvdW50L3NlcnZpY2UtYWNjb3VudC51aWQiOiJkOTRmMDZlNi1kNTkxLTRmMzktODMxNC0zNzI2MDVhM2RkN2MiLCJzdWIiOiJzeXN0ZW06c2VydmljZWFjY291bnQ6a3ViZXJuZXRlcy1kYXNoYm9hcmQ6YWRtaW4tdXNlciJ9.TMTc8QDTIo3qhsGTYD05c8txOyq2op7xW9ZQB5ICVw5x4fg-L0iUnn1jGyo4REP6ci63zBR-xmirqHy1eQ5GgT1nwGZnv4oKqNElm8-wkAit5rEgVN7ATo5GN3VrRQgNyBsHwqFhe1SsrK47flCZcmBvWbgmU4ugFfrNZ8xHkSURKrLAPUPjsYUC6ugyrEMqfwhcxzMiZcSKxG20jjLgVK7Pd_T01NAObUb_lCjq7mrEV0KdHcYTtSYwVwV88mTu5vwb39k-10V0s6HOqiDx87lp7fPtctrcR3mRiT1PkEvsyhCb8qAuFDPuaJZtESFu2dCXP_fVmv5g7AhSO_qUHg</span><br></pre></td></tr></table></figure>\n<h3 id=\"域名访问\"><a class=\"markdownIt-Anchor\" href=\"#域名访问\">#</a> 域名访问</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span>  </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-host-bar</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">&quot;hello.atguigu.com&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span></span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">&quot;demo.atguigu.com&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">&quot;/nginx&quot;</span>  <span class=\"comment\"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span>  <span class=\"comment\">## java，比如使用路径重写，去掉前缀nginx</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span></span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8000</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"路径重写\"><a class=\"markdownIt-Anchor\" href=\"#路径重写\">#</a> 路径重写</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span>  </span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class=\"string\">/$2</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-host-bar</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">&quot;hello.atguigu.com&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">hello-server</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span></span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8000</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">&quot;demo.atguigu.com&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">pathType:</span> <span class=\"string\">Prefix</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">&quot;/nginx(/|$)(.*)&quot;</span>  <span class=\"comment\"># 把请求会转给下面的服务，下面的服务一定要能处理这个路径，不能处理就是404</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span>  <span class=\"comment\">## java，比如使用路径重写，去掉前缀nginx</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span></span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8000</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"流量限制\"><a class=\"markdownIt-Anchor\" href=\"#流量限制\">#</a> 流量限制</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">networking.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Ingress</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">ingress-limit-rate</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">nginx.ingress.kubernetes.io/limit-rps:</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ingressClassName:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">host:</span> <span class=\"string\">&quot;haha.atguigu.com&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">http:</span></span><br><span class=\"line\">      <span class=\"attr\">paths:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">pathType:</span> <span class=\"string\">Exact</span></span><br><span class=\"line\">        <span class=\"attr\">path:</span> <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">        <span class=\"attr\">backend:</span></span><br><span class=\"line\">          <span class=\"attr\">service:</span></span><br><span class=\"line\">            <span class=\"attr\">name:</span> <span class=\"string\">nginx-demo</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span></span><br><span class=\"line\">              <span class=\"attr\">number:</span> <span class=\"number\">8000</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230411153649369.png\" alt=\"image-20230411153649369\"></p>\n<h2 id=\"存储抽象\"><a class=\"markdownIt-Anchor\" href=\"#存储抽象\">#</a> 存储抽象</h2>\n<p>在 k8s 中部署的应用都是以 pod 容器的形式运行的，假如我们部署 MySQL、Redis 等数据库，需要对这些数据库产生的数据做备份。因为 Pod 是有生命周期的，如果 pod 不挂载数据卷，那 pod 被删除或重启后这些数据会随之消失，如果想要长久的保留这些数据就要用到 pod 数据持久化存储。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl explain pod.spec.volumes</span></span><br><span class=\"line\">   awsElasticBlockStore\t&lt;Object&gt;</span><br><span class=\"line\">   azureDisk\t&lt;Object&gt;</span><br><span class=\"line\">   azureFile\t&lt;Object&gt;</span><br><span class=\"line\">   cephfs\t&lt;Object&gt;</span><br><span class=\"line\">   cinder\t&lt;Object&gt;</span><br><span class=\"line\">   configMap\t&lt;Object&gt;</span><br><span class=\"line\">   csi\t&lt;Object&gt;</span><br><span class=\"line\">   downwardAPI\t&lt;Object&gt;</span><br><span class=\"line\">   emptyDir\t&lt;Object&gt;</span><br><span class=\"line\">   ephemeral\t&lt;Object&gt;</span><br><span class=\"line\">   <span class=\"built_in\">fc</span>\t&lt;Object&gt;</span><br><span class=\"line\">   flexVolume\t&lt;Object&gt;</span><br><span class=\"line\">   flocker\t&lt;Object&gt;</span><br><span class=\"line\">   gcePersistentDisk\t&lt;Object&gt;</span><br><span class=\"line\">   gitRepo\t&lt;Object&gt;</span><br><span class=\"line\">   glusterfs\t&lt;Object&gt;</span><br><span class=\"line\">   hostPath\t&lt;Object&gt;</span><br><span class=\"line\">   iscsi\t&lt;Object&gt;</span><br><span class=\"line\">   name\t&lt;string&gt; -required-</span><br><span class=\"line\">   nfs\t&lt;Object&gt;</span><br><span class=\"line\">   persistentVolumeClaim\t&lt;Object&gt;</span><br><span class=\"line\">   photonPersistentDisk\t&lt;Object&gt;</span><br><span class=\"line\">   portworxVolume\t&lt;Object&gt;</span><br><span class=\"line\">   projected\t&lt;Object&gt;</span><br><span class=\"line\">   quobyte\t&lt;Object&gt;</span><br><span class=\"line\">   rbd\t&lt;Object&gt;</span><br><span class=\"line\">   scaleIO\t&lt;Object&gt;</span><br><span class=\"line\">   secret\t&lt;Object&gt;</span><br><span class=\"line\">   storageos\t&lt;Object&gt;</span><br><span class=\"line\">   vsphereVolume\t&lt;Object&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>常用的如下：<br>\nemptyDir 临时目录<br>\n hostPath<br>\nnfs<br>\npersistentVolumeClaim<br>\nglusterfs<br>\ncephfs<br>\nconfigMap<br>\nsecret</p>\n<p>我们想要使用存储卷，需要经历如下步骤</p>\n<p>1、定义 pod 的 volume，这个 volume 指明它要关联到哪个存储上的</p>\n<p>2、在容器中要使用 volumemounts 挂载对应的存储</p>\n<h3 id=\"emptydir\"><a class=\"markdownIt-Anchor\" href=\"#emptydir\">#</a> emptydir</h3>\n<p>emptyDir 类型的 Volume 是在 Pod 分配到 Node 上时被创建，Kubernetes 会在 Node 上自动分配一个目录，因此无需指定宿主机 Node 上对应的目录文件。 这个目录的初始内容为空，当 Pod 从 Node 上移除时，emptyDir 中的数据会被永久删除。emptyDir Volume 主要用于某些应用程序无需永久保存的临时目录，多个容器的共享目录等。</p>\n<p>emptyDir 的一些用途:</p>\n<p>缓存空间，例如基于磁盘的归并排序。</p>\n<p>为耗时较长的计算任务提供检查点，以便任务能方便地从崩溃前状态恢复执行。</p>\n<p>在 Web 服务器容器服务数据时，保存内容管理器容器获取的文件。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-emptydir</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">container-emptydir</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">cache-volume</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/cache</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">cache-volume</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># [root@master1 ~]# kubectl describe pod pod-emptydir </span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>         <span class=\"string\">pod-emptydir</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>    <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Node:</span>         <span class=\"string\">node1/192.168.13.199</span></span><br><span class=\"line\"><span class=\"attr\">Start Time:</span>   <span class=\"string\">Thu,</span> <span class=\"number\">18</span> <span class=\"string\">May</span> <span class=\"number\">2023 14:15:22</span> <span class=\"string\">+0800</span></span><br><span class=\"line\"><span class=\"attr\">Labels:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Status:</span>       <span class=\"string\">Running</span></span><br><span class=\"line\"><span class=\"attr\">IP:</span>           <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.189</span></span><br><span class=\"line\"><span class=\"attr\">IPs:</span></span><br><span class=\"line\">  <span class=\"attr\">IP:</span>  <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.189</span></span><br><span class=\"line\"><span class=\"attr\">Containers:</span></span><br><span class=\"line\">  <span class=\"attr\">container-emptydir:</span></span><br><span class=\"line\">    <span class=\"attr\">Container ID:</span>   <span class=\"string\">docker://4496b67a7a687a878e8f644d2064e45e6a1356cb7fc84b98093d6d37bb281a2a</span></span><br><span class=\"line\">    <span class=\"attr\">Image:</span>          <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">Image ID:</span>       <span class=\"string\">docker-pullable://nginx@sha256:0d17b565c37bcbd895e9d92315a05c1c3c9a29f762b011a10c54a66cd53c9b31</span></span><br><span class=\"line\">    <span class=\"attr\">Port:</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\">    <span class=\"attr\">Host Port:</span>      <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\">    <span class=\"attr\">State:</span>          <span class=\"string\">Running</span></span><br><span class=\"line\">      <span class=\"attr\">Started:</span>      <span class=\"string\">Thu,</span> <span class=\"number\">18</span> <span class=\"string\">May</span> <span class=\"number\">2023 14:15:24</span> <span class=\"string\">+0800</span></span><br><span class=\"line\">    <span class=\"attr\">Ready:</span>          <span class=\"literal\">True</span></span><br><span class=\"line\">    <span class=\"attr\">Restart Count:</span>  <span class=\"number\">0</span></span><br><span class=\"line\">    <span class=\"attr\">Environment:</span>    <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\">    <span class=\"attr\">Mounts:</span></span><br><span class=\"line\">      <span class=\"string\">/cache</span> <span class=\"string\">from</span> <span class=\"string\">cache-volume</span> <span class=\"string\">(rw)</span></span><br><span class=\"line\">      <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount</span> <span class=\"string\">from</span> <span class=\"string\">default-token-sc5zb</span> <span class=\"string\">(ro)</span></span><br><span class=\"line\"><span class=\"attr\">Volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">cache-volume:</span></span><br><span class=\"line\">    <span class=\"attr\">Type:</span>       <span class=\"string\">EmptyDir</span> <span class=\"string\">(a</span> <span class=\"string\">temporary</span> <span class=\"string\">directory</span> <span class=\"string\">that</span> <span class=\"string\">shares</span> <span class=\"string\">a</span> <span class=\"string\">pod&#x27;s</span> <span class=\"string\">lifetime)</span></span><br><span class=\"line\">    <span class=\"attr\">Medium:</span>     </span><br><span class=\"line\">    <span class=\"attr\">SizeLimit:</span>  <span class=\"string\">&lt;unset&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># emptydir 会在宿主机上创建一个名字为pod uid的临时目录，pod被调度到的节点都会创建这个目录</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pod pod-emptydir -oyaml | grep uid</span></span><br><span class=\"line\">  <span class=\"attr\">uid:</span> <span class=\"string\">d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># tree /var/lib/kubelet/pods/d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class=\"line\"><span class=\"string\">/var/lib/kubelet/pods/d952eb75-575e-4bf3-b08f-c7faed4f4bbd</span></span><br><span class=\"line\"><span class=\"string\">├──</span> <span class=\"string\">containers</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">container-emptydir</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">└──</span> <span class=\"number\">21760842</span></span><br><span class=\"line\"><span class=\"string\">├──</span> <span class=\"string\">etc-hosts</span></span><br><span class=\"line\"><span class=\"string\">├──</span> <span class=\"string\">plugins</span></span><br><span class=\"line\"><span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">kubernetes.io~empty-dir</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">├──</span> <span class=\"string\">cache-volume</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">ready</span></span><br><span class=\"line\"><span class=\"string\">│</span>       <span class=\"string\">└──</span> <span class=\"string\">wrapped_default-token-sc5zb</span></span><br><span class=\"line\"><span class=\"string\">│</span>           <span class=\"string\">└──</span> <span class=\"string\">ready</span></span><br><span class=\"line\"><span class=\"string\">└──</span> <span class=\"string\">volumes</span></span><br><span class=\"line\">    <span class=\"string\">├──</span> <span class=\"string\">kubernetes.io~empty-dir</span></span><br><span class=\"line\">    <span class=\"string\">│</span>   <span class=\"string\">└──</span> <span class=\"string\">cache-volume</span>   <span class=\"comment\"># pod内部文件存储路径  </span></span><br><span class=\"line\">    <span class=\"string\">└──</span> <span class=\"string\">kubernetes.io~secret</span></span><br><span class=\"line\">        <span class=\"string\">└──</span> <span class=\"string\">default-token-sc5zb</span></span><br><span class=\"line\">            <span class=\"string\">├──</span> <span class=\"string\">ca.crt</span> <span class=\"string\">-&gt;</span> <span class=\"string\">..data/ca.crt</span></span><br><span class=\"line\">            <span class=\"string\">├──</span> <span class=\"string\">namespace</span> <span class=\"string\">-&gt;</span> <span class=\"string\">..data/namespace</span></span><br><span class=\"line\">            <span class=\"string\">└──</span> <span class=\"string\">token</span> <span class=\"string\">-&gt;</span> <span class=\"string\">..data/token</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">11</span> <span class=\"string\">directories,</span> <span class=\"number\">7</span> <span class=\"string\">files</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"hostpath\"><a class=\"markdownIt-Anchor\" href=\"#hostpath\">#</a> hostpath</h3>\n<p>hostPath Volume 是指 Pod 挂载宿主机上的目录或文件。 hostPath Volume 使得容器可以使用宿主机的文件系统进行存储，hostpath（宿主机路径）：节点级别的存储卷，在 pod 被删除，这个存储卷还是存在的，不会被删除，所以只要同一个 pod 被调度到同一个节点上来，在 pod 被删除重新被调度到这个节点之后，对应的数据依然是存在的。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test-hostpath</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-volume</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/test-nginx</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-tomcat</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">tomcat:9.0</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">test-volume</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/test-tomcat</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">      <span class=\"attr\">type:</span> <span class=\"string\">DirectoryOrCreate</span></span><br><span class=\"line\">      <span class=\"attr\">path:</span> <span class=\"string\">/data1</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">test-volume</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl exec -it test-hostpath -c test-nginx -- /bin/bash </span></span><br><span class=\"line\"><span class=\"string\">root@test-hostpath:/#</span> <span class=\"string\">cd</span> <span class=\"string\">/test-nginx/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">https://kubernetes.io/zh-cn/docs/concepts/storage/volumes/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">不会删除宿主机目录，但是如果调度到不同node还是会丢失数据</span> <span class=\"attr\">nodeName:</span> <span class=\"string\">node2</span></span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230518151050405.png\" alt=\"image-20230518151050405\" style=\"zoom:150%;\" /> \n<p>可以用分布式存储：</p>\n<p>nfs，cephfs，glusterfs</p>\n<h3 id=\"nfs\"><a class=\"markdownIt-Anchor\" href=\"#nfs\">#</a> nfs</h3>\n<p>NFS：网络文件系统，英文 Network File System (NFS)，是由 SUN 公司研制的 UNIX 表示层协议 (presentation layer protocol)，能使使用者访问网络上别处的文件就像在使用自己的计算机一样。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># yum install nfs-utils -y</span></span><br><span class=\"line\"><span class=\"comment\">#在宿主机创建NFS需要的共享目录</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data/volumes -pv </span></span><br><span class=\"line\"><span class=\"attr\">mkdir:</span> <span class=\"string\">created</span> <span class=\"string\">directory</span> <span class=\"string\">‘/data’</span></span><br><span class=\"line\"><span class=\"attr\">mkdir:</span> <span class=\"string\">created</span> <span class=\"string\">directory</span> <span class=\"string\">‘/data/volumes’</span></span><br><span class=\"line\"><span class=\"comment\">#配置nfs共享服务器上的/data/volumes目录</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl start nfs</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># vim /etc/exports</span></span><br><span class=\"line\"><span class=\"string\">/data/volumes</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"comment\">#rw 该主机对该共享目录有读写权限</span></span><br><span class=\"line\"><span class=\"comment\"># no_root_squash 登入 NFS 主机使用分享目录的使用者，如果是 root 的话，那么对于这个分享的目录来说，他就具有 root 的权限</span></span><br><span class=\"line\"><span class=\"string\">exportfs</span> <span class=\"string\">-avr</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># service nfs restart</span></span><br><span class=\"line\"><span class=\"comment\">#设置成开机自启动</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl enable nfs</span></span><br><span class=\"line\"><span class=\"comment\">#查看nfs是否启动成功</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># systemctl status nfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#node2和node1上也安装nfs驱动</span></span><br><span class=\"line\"><span class=\"string\">yum</span> <span class=\"string\">install</span> <span class=\"string\">nfs-utils</span> <span class=\"string\">-y</span></span><br><span class=\"line\"><span class=\"string\">systemctl</span> <span class=\"string\">enable</span>  <span class=\"string\">nfs</span> <span class=\"string\">–now</span></span><br><span class=\"line\"><span class=\"comment\"># node节点测试</span></span><br><span class=\"line\"><span class=\"string\">showmount</span> <span class=\"string\">-e</span> </span><br><span class=\"line\"><span class=\"string\">mount</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.177</span><span class=\"string\">:/data/volumes</span> <span class=\"string\">/test/</span></span><br><span class=\"line\"><span class=\"string\">df</span> <span class=\"string\">-h</span></span><br><span class=\"line\"><span class=\"string\">umount</span> <span class=\"string\">/test</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-test</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">cunchu:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">cunchu:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">test-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-volumes</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-volumes</span></span><br><span class=\"line\">        <span class=\"attr\">nfs:</span></span><br><span class=\"line\">          <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.177</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/data/volumes</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cd /data/volumes/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">volumes</span>]<span class=\"comment\"># vim index.html</span></span><br><span class=\"line\"><span class=\"string\">&lt;h1&gt;woshishabi&lt;h1&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">volumes</span>]<span class=\"comment\"># curl 10.244.166.191</span></span><br><span class=\"line\"><span class=\"string\">&lt;h1&gt;woshishabi&lt;/h1&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">删除pod，pod重新创建后仍然存在挂载目录中的内容</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#上面说明挂载nfs存储卷成功了，nfs支持多个客户端挂载，可以创建多个pod，挂载同一个nfs服务器共享出来的目录；但是nfs如果宕机了，数据也就丢失了，所以需要使用分布式存储，常见的分布式存储有glusterfs和cephfs</span></span><br></pre></td></tr></table></figure>\n<p>假设我们使用 nfs 作为存储层</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装nfs</span></span><br><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 主节点</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind --now</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs-server --now</span><br><span class=\"line\"><span class=\"comment\">#配置生效</span></span><br><span class=\"line\">exportfs -r</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 从节点</span></span><br><span class=\"line\">showmount -e 172.31.0.4</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#执行以下命令挂载 nfs 服务器上的共享目录到本机路径 /root/nfsmount</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data</span><br><span class=\"line\"></span><br><span class=\"line\">mount -t nfs 172.31.0.4:/nfs/data /nfs/data</span><br><span class=\"line\"><span class=\"comment\"># 写入一个测试文件</span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;hello nfs server&quot;</span> &gt; /nfs/data/test.txt</span><br></pre></td></tr></table></figure>\n<h3 id=\"原生方式挂载\"><a class=\"markdownIt-Anchor\" href=\"#原生方式挂载\">#</a> 原生方式挂载</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-pv-demo</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/nginx-pv</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"持久卷\"><a class=\"markdownIt-Anchor\" href=\"#持久卷\">#</a> 持久卷</h3>\n<p>PV：持久卷（Persistent Volume），将应用需要持久化的数据保存到指定位置</p>\n<p>PVC：持久卷申明（<strong>Persistent Volume Claim</strong>），申明需要使用的持久卷规格</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PersistentVolume（PV）是群集中的一块存储，由管理员配置或使用存储类动态配置。 它是集群中的资源，就像pod是k8s集群资源一样。 PV是容量插件，如Volumes，其生命周期独立于使用PV的任何单个pod。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">PersistentVolumeClaim（PVC）是一个持久化存储卷，我们在创建pod时可以定义这个类型的存储卷。 它类似于一个pod。 Pod消耗节点资源，PVC消耗PV资源。 Pod可以请求特定级别的资源（CPU和内存）。 pvc在申请pv的时候也可以请求特定的大小和访问模式（例如，可以一次读写或多次只读）。</span><br><span class=\"line\"></span><br><span class=\"line\">PV是群集中的资源。 PVC是对这些资源的请求。 </span><br><span class=\"line\">PV和PVC之间的相互作用遵循以下生命周期：</span><br><span class=\"line\"></span><br><span class=\"line\">（1）pv的供应方式</span><br><span class=\"line\">可以通过两种方式配置PV：静态或动态。</span><br><span class=\"line\"></span><br><span class=\"line\">静态的：</span><br><span class=\"line\">集群管理员创建了许多PV。它们包含可供群集用户使用的实际存储的详细信息。它们存在于Kubernetes API中，可供使用。</span><br><span class=\"line\"></span><br><span class=\"line\">动态的：</span><br><span class=\"line\">当管理员创建的静态PV都不匹配用户的PersistentVolumeClaim时，群集可能会尝试为PVC专门动态配置卷。此配置基于StorageClasses，PVC必须请求存储类，管理员必须创建并配置该类，以便进行动态配置。</span><br><span class=\"line\"></span><br><span class=\"line\">（2）绑定</span><br><span class=\"line\">用户创建pvc并指定需要的资源和访问模式。在找到可用pv之前，pvc会保持未绑定状态</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">（3）使用</span><br><span class=\"line\">a）需要找一个存储服务器，把它划分成多个存储空间；</span><br><span class=\"line\">b）k8s管理员可以把这些存储空间定义成多个pv；</span><br><span class=\"line\">c）在pod中使用pvc类型的存储卷之前需要先创建pvc，通过定义需要使用的pv的大小和对应的访问模式，找到合适的pv；</span><br><span class=\"line\">d）pvc被创建之后，就可以当成存储卷来使用了，我们在定义pod时就可以使用这个pvc的存储卷</span><br><span class=\"line\">e）pvc和pv它们是一一对应的关系，pv如果被pvc绑定了，就不能被其他pvc使用了；</span><br><span class=\"line\">f）我们在创建pvc的时候，应该确保和底下的pv能绑定，如果没有合适的pv，那么pvc就会处于pending状态。</span><br><span class=\"line\"></span><br><span class=\"line\">（4）回收策略</span><br><span class=\"line\">当我们创建pod时如果使用pvc做为存储卷，那么它会和pv绑定，当删除pod，pvc和pv绑定就会解除，解除之后和pvc绑定的pv卷里的数据需要怎么处理，目前，卷可以保留，回收或删除：</span><br><span class=\"line\">Retain</span><br><span class=\"line\">Recycle （不推荐使用，1.15可能被废弃了）</span><br><span class=\"line\">Delete</span><br><span class=\"line\">1、Retain</span><br><span class=\"line\">当删除pvc的时候，pv仍然存在，处于released状态，但是它不能被其他pvc绑定使用，里面的数据还是存在的，当我们下次再使用的时候，数据还是存在的，这个是默认的回收策略</span><br><span class=\"line\"> </span><br><span class=\"line\">Delete</span><br><span class=\"line\">删除pvc时即会从Kubernetes中移除PV，也会从相关的外部设施中删除存储资产</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">mkdir</span> <span class=\"string\">/data/volume_test/v&#123;1,2,3,4,5,6,7,8,9,10&#125;</span> <span class=\"string\">-p</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">vim</span> <span class=\"string\">/etc/exports</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v1</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v2</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v3</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v4</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v5</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v6</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v7</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v8</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v9</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"><span class=\"string\">/data/volume_test/v10</span> <span class=\"string\">*(rw,no_root_squash)</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">exportfs</span> <span class=\"string\">-arv</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/volume_test/v1</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.177</span></span><br><span class=\"line\">    <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteOnce&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">capacity:</span> </span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">v2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/volume_test/v2</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.177</span></span><br><span class=\"line\">    <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadOnlyMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">capacity:</span> </span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">v3</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">v3</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/data/volume_test/v3</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.177</span></span><br><span class=\"line\">    <span class=\"attr\">readOnly:</span> <span class=\"literal\">false</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">capacity:</span> </span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span>  </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">RWO：readwariteonce:</span>  <span class=\"string\">单路读写，允许同一个node节点上的pod访问</span></span><br><span class=\"line\"><span class=\"string\">ROX：</span> <span class=\"attr\">readonlymany:</span>    <span class=\"string\">多路只读，允许不同node节点的pod以只读方式访问</span></span><br><span class=\"line\"><span class=\"string\">RWX：</span> <span class=\"attr\">readwritemany:</span>  <span class=\"string\">多路读写，允许不同的node节点的pod以读写方式访问</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pv</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>   <span class=\"string\">CAPACITY</span>   <span class=\"string\">ACCESS</span> <span class=\"string\">MODES</span>   <span class=\"string\">RECLAIM</span> <span class=\"string\">POLICY</span>   <span class=\"string\">STATUS</span>      <span class=\"string\">CLAIM</span>   <span class=\"string\">STORAGECLASS</span>   <span class=\"string\">REASON</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">v1</span>     <span class=\"string\">1Gi</span>        <span class=\"string\">RWO</span>            <span class=\"string\">Retain</span>           <span class=\"string\">Available</span>                                   <span class=\"string\">9m1s</span></span><br><span class=\"line\"><span class=\"string\">v2</span>     <span class=\"string\">2Gi</span>        <span class=\"string\">ROX</span>            <span class=\"string\">Retain</span>           <span class=\"string\">Available</span>                                   <span class=\"string\">9m1s</span></span><br><span class=\"line\"><span class=\"string\">v3</span>     <span class=\"string\">3Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">Retain</span>           <span class=\"string\">Available</span>                                   <span class=\"string\">9m1s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc-v1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteOnce&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span> </span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc-v2</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadOnlyMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">v2</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span> </span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc-v3</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">v3</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span> </span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pvc </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>     <span class=\"string\">STATUS</span>   <span class=\"string\">VOLUME</span>   <span class=\"string\">CAPACITY</span>   <span class=\"string\">ACCESS</span> <span class=\"string\">MODES</span>   <span class=\"string\">STORAGECLASS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">pvc-v1</span>   <span class=\"string\">Bound</span>    <span class=\"string\">v1</span>       <span class=\"string\">1Gi</span>        <span class=\"string\">RWO</span>                           <span class=\"string\">3m13s</span></span><br><span class=\"line\"><span class=\"string\">pvc-v2</span>   <span class=\"string\">Bound</span>    <span class=\"string\">v2</span>       <span class=\"string\">2Gi</span>        <span class=\"string\">ROX</span>                           <span class=\"string\">43s</span></span><br><span class=\"line\"><span class=\"string\">pvc-v3</span>   <span class=\"string\">Bound</span>    <span class=\"string\">v3</span>       <span class=\"string\">3Gi</span>        <span class=\"string\">RWX</span>                           <span class=\"string\">43s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pvc-test</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">cunchu:</span> <span class=\"string\">pvc</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">cunchu:</span> <span class=\"string\">pvc</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">test-nfs</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx-html</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">          <span class=\"attr\">claimName:</span> <span class=\"string\">pvc-v1</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx-html</span></span><br><span class=\"line\">        </span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、我们每次创建pvc的时候，需要事先有划分好的pv，这样可能不方便，那么可以在创建pvc的时候直接动态创建一个pv这个存储类，pv事先是不存在的</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、pvc和pv绑定，如果使用默认的回收策略retain，那么删除pvc之后，pv会处于released状态，我们想要继续使用这个pv，需要手动删除pv，kubectl</span> <span class=\"string\">delete</span> <span class=\"string\">pv</span> <span class=\"string\">pv_name，删除pv，不会删除pv里的数据，当我们重新创建pvc时还会和这个最匹配的pv绑定，数据还是原来数据，不会丢失。</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">删除pvc的步骤：</span></span><br><span class=\"line\"><span class=\"string\">需要先删除使用pvc的pod</span></span><br><span class=\"line\"><span class=\"string\">再删除pvc</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">回收策略为retain，删除pvc，pv状态release，需要删除pv重新创建才能为bound状态</span></span><br><span class=\"line\"><span class=\"string\">Delete策略，删除pvc，pv状态Failed</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Delete策略，删除pv后端存储所用的数据目录不会被删除，与回收策略无关</span></span><br></pre></td></tr></table></figure>\n<p>创建 pv</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv01-10m</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">10M</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/01</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv02-1gi</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/02</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolume</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pv03-3gi</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">capacity:</span></span><br><span class=\"line\">    <span class=\"attr\">storage:</span> <span class=\"string\">3Gi</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">  <span class=\"attr\">nfs:</span></span><br><span class=\"line\">    <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data/03</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"number\">172.31</span><span class=\"number\">.0</span><span class=\"number\">.2</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get persistentvolume</span></span><br><span class=\"line\">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM   STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pv01-10m   10M        RWX            Retain           Available           nfs                     59s</span><br><span class=\"line\">pv02-1gi   1Gi        RWX            Retain           Available           nfs                     59s</span><br><span class=\"line\">pv03-3gi   3Gi        RWX            Retain           Available           nfs                     59s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>创建 pvc</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"string\">ReadWriteMany</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pv </span></span><br><span class=\"line\">NAME       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pv01-10m   10M        RWX            Retain           Available                       nfs                     3m48s</span><br><span class=\"line\">pv02-1gi   1Gi        RWX            Retain           Bound       default/nginx-pvc   nfs                     3m48s</span><br><span class=\"line\">pv03-3gi   3Gi        RWX            Retain           Available                       nfs                     3m48s</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pvc</span></span><br><span class=\"line\">NAME        STATUS   VOLUME     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">nginx-pvc   Bound    pv02-1gi   1Gi        RWX            nfs            107s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建dep时挂载</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx-deploy-pvc</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">html</span></span><br><span class=\"line\">          <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">            <span class=\"attr\">claimName:</span> <span class=\"string\">nginx-pvc</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"storageclass\"><a class=\"markdownIt-Anchor\" href=\"#storageclass\">#</a> storageclass</h3>\n<p>上面介绍的 PV 和 PVC 模式都是需要先创建好 PV，然后定义好 PVC 和 pv 进行一对一的 Bond，但是如果 PVC 请求成千上万，那么就需要创建成千上万的 PV，对于运维人员来说维护成本很高，Kubernetes 提供一种自动创建 PV 的机制，叫 StorageClass，它的作用就是创建 PV 的模板。k8s 集群管理员通过创建 storageclass 可以动态生成一个存储卷 pv 供 k8s pvc 使用。</p>\n<p>每个 StorageClass 都包含字段 provisioner，parameters 和 reclaimPolicy。</p>\n<p>具体来说，StorageClass 会定义以下两部分：<br>\n1、PV 的属性 ，比如存储的大小、类型等；<br>\n2、创建这种 PV 需要使用到的存储插件，比如 Ceph、NFS 等</p>\n<p>有了这两部分信息，Kubernetes 就能够根据用户提交的 PVC，找到对应的 StorageClass，然后 Kubernetes 就会调用 StorageClass 声明的存储插件，创建出需要的 PV。</p>\n<p>provisioner：供应商，storageclass 需要有一个供应者，用来确定我们使用什么样的存储来创建 pv，常见的 provisioner 如下</p>\n<p>（<span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvY29uY2VwdHMvc3RvcmFnZS9zdG9yYWdlLWNsYXNzZXMvJUVGJUJDJTg5JUVGJUJDJTlB\">https://kubernetes.io/zh/docs/concepts/storage/storage-classes/）：</span></p>\n<p>provisioner 既可以由内部供应商提供，也可以由外部供应商提供，如果是外部供应商可以参考 https://github.com/kubernetes-incubator/external-storage/ 下提供的方法创建。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2t1YmVybmV0ZXMtc2lncy9zaWctc3RvcmFnZS1saWItZXh0ZXJuYWwtcHJvdmlzaW9uZXI=\">https://github.com/kubernetes-sigs/sig-storage-lib-external-provisioner</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230519162407835.png\" alt=\"image-20230519162407835\" style=\"zoom:150%;\" /> \n<p>以 NFS 为例，要想使用 NFS，我们需要一个 nfs-client 的自动装载程序，称之为 provisioner，这个程序会使用我们已经配置好的 NFS 服务器自动创建持久卷，也就是自动帮我们创建 PV。</p>\n<p>reclaimPolicy：回收策略</p>\n<p>allowVolumeExpansion：允许卷扩展，PersistentVolume 可以配置成可扩展。将此功能设置为 true 时，允许用户通过编辑相应的 PVC 对象来调整卷大小。当基础存储类的 allowVolumeExpansion 字段设置为 true 时，以下类型的卷支持卷扩展。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230519162535255.png\" alt=\"image-20230519162535255\" style=\"zoom:150%;\" /> \n<p>注意：此功能仅用于扩容卷，不能用于缩小卷。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">安装nfs</span> <span class=\"string\">provisioner，用于配合存储类动态生成pv</span></span><br><span class=\"line\"><span class=\"comment\">#把nfs-subdir-external-provisioner.tar.gz上传到node2和node1上，手动解压。</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@node2</span> <span class=\"string\">~</span>]<span class=\"comment\"># ctr -n=k8s.io images import  nfs-subdir-external-provisioner.tar.gz</span></span><br><span class=\"line\">[<span class=\"string\">root@node1</span> <span class=\"string\">~</span>]<span class=\"comment\"># ctr -n=k8s.io images import  nfs-subdir-external-provisioner.tar.gz</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">对sa授权</span> </span><br><span class=\"line\">[<span class=\"string\">root@master1</span>]<span class=\"comment\"># kubectl create clusterrolebinding nfs-provisioner-clusterrolebinding --clusterrole=cluster-admin --serviceaccount=default:nfs-provisioner</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">安装nfs-provisioner程序</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># mkdir /data/nfs_pro -p</span></span><br><span class=\"line\"><span class=\"comment\">#把/data/nfs_pro变成nfs共享的目录</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># cat /etc/exports</span></span><br><span class=\"line\"><span class=\"string\">/data/nfs_pro</span> <span class=\"number\">192.168</span><span class=\"number\">.40</span><span class=\"number\">.0</span><span class=\"string\">/24(rw,no_root_squash)</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># exportfs -arv</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">       <span class=\"attr\">app:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccount:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-provisioner</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-beijing.aliyuncs.com/mydlq/nfs-subdir-external-provisioner:v4.0.0</span></span><br><span class=\"line\"><span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">example.com/nfs</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_PATH</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/data/nfs_pro</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">192.168</span><span class=\"number\">.13</span><span class=\"number\">.180</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/data/nfs_pro</span></span><br><span class=\"line\">            </span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">example.com/nfs</span>        </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">PersistentVolumeClaim</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">test-claim1</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">accessModes:</span>  [<span class=\"string\">&quot;ReadWriteMany&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">    <span class=\"attr\">requests:</span></span><br><span class=\"line\">      <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">storageClassName:</span>  <span class=\"string\">nfs</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">storage-class</span>]<span class=\"comment\"># cd /data/nfs_pro/</span></span><br><span class=\"line\">[<span class=\"string\">root@prometheus-master</span> <span class=\"string\">nfs_pro</span>]<span class=\"comment\"># ls </span></span><br><span class=\"line\"><span class=\"string\">default-test-claim1-pvc-85419aac-02d0-4790-a2ed-3eed433841b5</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">步骤总结：</span><br><span class=\"line\">1、供应商：创建一个nfs provisioner</span><br><span class=\"line\">2、创建storageclass，storageclass指定刚才创建的供应商</span><br><span class=\"line\">3、创建pvc，这个pvc指定storageclass</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建pod挂载</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">read-pod</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">read-pod</span></span><br><span class=\"line\"><span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-pvc</span></span><br><span class=\"line\">        <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">&quot;Never&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-pvc</span></span><br><span class=\"line\">      <span class=\"attr\">persistentVolumeClaim:</span></span><br><span class=\"line\">        <span class=\"attr\">claimName:</span> <span class=\"string\">test-claim1</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建pvc时不需要先创建pv，只需要先创建sc，sc动态生成pv，pvc自动和pv绑定</span><br></pre></td></tr></table></figure>\n<h2 id=\"statefulset\"><a class=\"markdownIt-Anchor\" href=\"#statefulset\">#</a> statefulset</h2>\n<p>StatefulSet 是为了管理有状态服务的问题而设计的</p>\n<p>有状态服务<br>\n StatefulSet 是有状态的集合，管理有状态的服务，它所管理的 Pod 的名称不能随意变化。数据持久化的目录也是不一样，每一个 Pod 都有自己独有的数据持久化存储目录。比如 MySQL 主从、redis 集群等。<br>\npod 删除后名字不变</p>\n<p>无状态服务<br>\n RC、Deployment、DaemonSet 都是管理无状态的服务，它们所管理的 Pod 的 IP、名字，启停顺序等都是随机的。个体对整体无影响，所有 pod 都是共用一个数据卷的，部署的 tomcat 就是无状态的服务，tomcat 被删除，在启动一个新的 tomcat，加入到集群即可，跟 tomcat 的名字无关。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">&quot;nginx&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span> </span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">www</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">www</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteMany&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 创建sts必须创建一个没有ip的service</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get sts</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>   <span class=\"string\">READY</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">web</span>    <span class=\"number\">2</span><span class=\"string\">/2</span>     <span class=\"string\">66s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pod </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                               <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">nfs-provisioner-68878cc575-zckvq</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"number\">18</span></span><br><span class=\"line\"><span class=\"string\">web-0</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">68s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">64s</span></span><br><span class=\"line\"><span class=\"comment\"># sts创建的每个pod都是独享数据目录</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pvc </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>          <span class=\"string\">STATUS</span>   <span class=\"string\">VOLUME</span>                                     <span class=\"string\">CAPACITY</span>   <span class=\"string\">ACCESS</span> <span class=\"string\">MODES</span>   <span class=\"string\">STORAGECLASS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">test-claim1</span>   <span class=\"string\">Bound</span>    <span class=\"string\">pvc-c23b6e3e-6e95-47b7-9fba-98e97101a541</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">nfs</span>            <span class=\"string\">16m</span></span><br><span class=\"line\"><span class=\"string\">www-web-0</span>     <span class=\"string\">Bound</span>    <span class=\"string\">pvc-6b0fb835-f835-49cd-b6b8-8805d52af664</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">nfs</span>            <span class=\"string\">73s</span></span><br><span class=\"line\"><span class=\"string\">www-web-1</span>     <span class=\"string\">Bound</span>    <span class=\"string\">pvc-e4001db8-3ffe-4274-86db-2386933b3b1c</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">nfs</span>            <span class=\"string\">69s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pv</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                                       <span class=\"string\">CAPACITY</span>   <span class=\"string\">ACCESS</span> <span class=\"string\">MODES</span>   <span class=\"string\">RECLAIM</span> <span class=\"string\">POLICY</span>   <span class=\"string\">STATUS</span>   <span class=\"string\">CLAIM</span>                 <span class=\"string\">STORAGECLASS</span>   <span class=\"string\">REASON</span> </span><br><span class=\"line\"><span class=\"string\">pvc-6b0fb835-f835-49cd-b6b8-8805d52af664</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">Delete</span>           <span class=\"string\">Bound</span>    <span class=\"string\">default/www-web-0</span>     <span class=\"string\">nfs</span>                   </span><br><span class=\"line\"><span class=\"string\">pvc-c23b6e3e-6e95-47b7-9fba-98e97101a541</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">Delete</span>           <span class=\"string\">Bound</span>    <span class=\"string\">default/test-claim1</span>   <span class=\"string\">nfs</span>                   </span><br><span class=\"line\"><span class=\"string\">pvc-e4001db8-3ffe-4274-86db-2386933b3b1c</span>   <span class=\"string\">1Gi</span>        <span class=\"string\">RWX</span>            <span class=\"string\">Delete</span>           <span class=\"string\">Bound</span>    <span class=\"string\">default/www-web-1</span>     <span class=\"string\">nfs</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">使用busybox解析svc</span></span><br><span class=\"line\"><span class=\"string\">nslookup</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Statefulset 总结：</p>\n<blockquote>\n<p>1、Statefulset 管理的 pod，pod 名字是有序的，由 statefulset 的名字 - 0、1、2 这种格式组成</p>\n<p>2、创建 statefulset 资源的时候，必须事先创建好一个 service, 如果创建的 service 没有 ip，那对这个 service 做 dns 解析，会找到它所关联的 pod ip，如果创建的 service 有 ip，那对这个 service 做 dns 解析，会解析到 service 本身 ip。</p>\n<p>3、statefulset 管理的 pod，删除 pod，新创建的 pod 名字跟删除的 pod 名字是一样的</p>\n<p>4、statefulset 具有 volumeclaimtemplate 这个字段，这个是卷申请模板，会自动创建 pv，pvc 也会自动生成，跟 pv 进行绑定，那如果创建的 statefulset 使用了 volumeclaimtemplate 这个字段，那创建 pod，数据目录是独享的</p>\n<p>5、ststefulset 创建的 pod，是有域名的（域名组成：pod-name.svc-name.svc-namespace.svc.cluster.local）</p>\n</blockquote>\n<h3 id=\"statefulset-扩缩容\"><a class=\"markdownIt-Anchor\" href=\"#statefulset-扩缩容\">#</a> statefulset 扩缩容</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">replicas:</span> <span class=\"string\">+</span> <span class=\"bullet\">-</span></span><br><span class=\"line\"><span class=\"string\">缩容删除pod顺序是由大到小，即每次删除序号最大的那个</span></span><br><span class=\"line\"><span class=\"string\">扩容是从小到大</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 滚动更新</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl explain sts.spec.updateStrategy</span></span><br><span class=\"line\"><span class=\"attr\">KIND:</span>     <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">VERSION:</span>  <span class=\"string\">apps/v1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">RESOURCE:</span> <span class=\"string\">updateStrategy</span> <span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">DESCRIPTION:</span></span><br><span class=\"line\">     <span class=\"string\">updateStrategy</span> <span class=\"string\">indicates</span> <span class=\"string\">the</span> <span class=\"string\">StatefulSetUpdateStrategy</span> <span class=\"string\">that</span> <span class=\"string\">will</span> <span class=\"string\">be</span></span><br><span class=\"line\">     <span class=\"string\">employed</span> <span class=\"string\">to</span> <span class=\"string\">update</span> <span class=\"string\">Pods</span> <span class=\"string\">in</span> <span class=\"string\">the</span> <span class=\"string\">StatefulSet</span> <span class=\"string\">when</span> <span class=\"string\">a</span> <span class=\"string\">revision</span> <span class=\"string\">is</span> <span class=\"string\">made</span> <span class=\"string\">to</span></span><br><span class=\"line\">     <span class=\"string\">Template.</span></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"string\">StatefulSetUpdateStrategy</span> <span class=\"string\">indicates</span> <span class=\"string\">the</span> <span class=\"string\">strategy</span> <span class=\"string\">that</span> <span class=\"string\">the</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\">     <span class=\"string\">controller</span> <span class=\"string\">will</span> <span class=\"string\">use</span> <span class=\"string\">to</span> <span class=\"string\">perform</span> <span class=\"string\">updates.</span> <span class=\"string\">It</span> <span class=\"string\">includes</span> <span class=\"string\">any</span> <span class=\"string\">additional</span></span><br><span class=\"line\">     <span class=\"string\">parameters</span> <span class=\"string\">necessary</span> <span class=\"string\">to</span> <span class=\"string\">perform</span> <span class=\"string\">the</span> <span class=\"string\">update</span> <span class=\"string\">for</span> <span class=\"string\">the</span> <span class=\"string\">indicated</span> <span class=\"string\">strategy.</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">FIELDS:</span></span><br><span class=\"line\">   <span class=\"string\">rollingUpdate</span>\t<span class=\"string\">&lt;Object&gt;</span></span><br><span class=\"line\">     <span class=\"string\">RollingUpdate</span> <span class=\"string\">is</span> <span class=\"string\">used</span> <span class=\"string\">to</span> <span class=\"string\">communicate</span> <span class=\"string\">parameters</span> <span class=\"string\">when</span> <span class=\"string\">Type</span> <span class=\"string\">is</span></span><br><span class=\"line\">     <span class=\"string\">RollingUpdateStatefulSetStrategyType.</span></span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"string\">type</span>\t<span class=\"string\">&lt;string&gt;</span></span><br><span class=\"line\">     <span class=\"string\">Type</span> <span class=\"string\">indicates</span> <span class=\"string\">the</span> <span class=\"string\">type</span> <span class=\"string\">of</span> <span class=\"string\">the</span> <span class=\"string\">StatefulSetUpdateStrategy.</span> <span class=\"string\">Default</span> <span class=\"string\">is</span></span><br><span class=\"line\">     <span class=\"string\">RollingUpdate.</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">port:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">  <span class=\"attr\">clusterIP:</span> <span class=\"string\">None</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StatefulSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">partition:</span> <span class=\"number\">1</span>  <span class=\"comment\"># 先更新序号&gt;=1的pod</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">serviceName:</span> <span class=\"string\">&quot;nginx&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nginx</span> </span><br><span class=\"line\">    <span class=\"attr\">spec:</span>  </span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">web</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">www</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/usr/share/nginx/html</span></span><br><span class=\"line\">  <span class=\"attr\">volumeClaimTemplates:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">www</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">accessModes:</span> [<span class=\"string\">&quot;ReadWriteMany&quot;</span>]</span><br><span class=\"line\">      <span class=\"attr\">storageClassName:</span> <span class=\"string\">nfs</span></span><br><span class=\"line\">      <span class=\"attr\">resources:</span></span><br><span class=\"line\">        <span class=\"attr\">requests:</span></span><br><span class=\"line\">          <span class=\"attr\">storage:</span> <span class=\"string\">1Gi</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">web-0</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">57s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">55s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">71s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">71s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">72s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">73s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>   <span class=\"number\">0</span>          <span class=\"string\">73s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>       <span class=\"number\">0</span>          <span class=\"string\">0s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>       <span class=\"number\">0</span>          <span class=\"string\">0s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">1s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">2s</span></span><br><span class=\"line\"><span class=\"string\">web-1</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>             <span class=\"number\">0</span>          <span class=\"string\">3s</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">partition：1</span> <span class=\"string\">更新的时候会把pod序号&gt;=1的进行更新</span></span><br><span class=\"line\"><span class=\"string\">partition：0</span> <span class=\"string\">所有和yaml不符的pod都会更新</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">type:</span> <span class=\"string\">OnDelte</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">OnDelete</span></span><br><span class=\"line\"><span class=\"string\">pod不会自动更新，需要手动删除pod，statefulset会在自动用新的yaml创建新的pod</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"daemonset\"><a class=\"markdownIt-Anchor\" href=\"#daemonset\">#</a> DaemonSet</h2>\n<p>DaemonSet 控制器能够确保 k8s 集群所有的节点都运行一个相同的 pod 副本，当向 k8s 集群中增加 node 节点时，这个 node 节点也会自动创建一个 pod 副本，当 node 节点从集群移除，这些 pod 也会自动删除；删除 Daemonset 也会删除它们创建的 pod</p>\n<p>daemonset 的控制器会监听 kuberntes 的 daemonset 对象、pod 对象、node 对象，这些被监听的对象之变动，就会触发 syncLoop 循环让 kubernetes 集群朝着 daemonset 对象描述的状态进行演进。</p>\n<p>在集群的每个节点上运行存储，比如：glusterd 或 ceph。<br>\n在每个节点上运行日志收集组件，比如：flunentd 、 logstash、filebeat 等。<br>\n在每个节点上运行监控组件，比如：Prometheus、 Node Exporter 、collectd 等。</p>\n<p>Deployment 部署的副本 Pod 会分布在各个 Node 上，每个 Node 都可能运行好几个副本。<br>\nDaemonSet 的不同之处在于：每个 Node 上最多只能运行一个副本。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">DaemonSet</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">fluentd-logging</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span> </span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlog</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varcontainers</span></span><br><span class=\"line\">        <span class=\"attr\">hostPath:</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\">      <span class=\"attr\">tolerations:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">node-role.kubernetes.io/master</span></span><br><span class=\"line\">        <span class=\"attr\">effect:</span> <span class=\"string\">NoSchedule</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">fluentd</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">            <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">            <span class=\"attr\">memory:</span> <span class=\"string\">200Mi</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varlog</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/log</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">varcontainers</span></span><br><span class=\"line\">          <span class=\"attr\">mountPath:</span> <span class=\"string\">/var/lib/docker/containers</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get pod -n kube-system -l name=fluentd -owide </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>            <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span>   <span class=\"string\">IP</span>               <span class=\"string\">NODE</span>      <span class=\"string\">NOMINATED</span> <span class=\"string\">NODE</span>   <span class=\"string\">READINESS</span> <span class=\"string\">GATES</span></span><br><span class=\"line\"><span class=\"string\">fluentd-gv4jk</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">87s</span>   <span class=\"number\">10.244</span><span class=\"number\">.136</span><span class=\"number\">.3</span>     <span class=\"string\">master3</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">fluentd-ttcgl</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">87s</span>   <span class=\"number\">10.244</span><span class=\"number\">.180</span><span class=\"number\">.2</span>     <span class=\"string\">master2</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">fluentd-w5vxw</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">87s</span>   <span class=\"number\">10.244</span><span class=\"number\">.166</span><span class=\"number\">.146</span>   <span class=\"string\">node1</span>     <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">fluentd-w9m2w</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">87s</span>   <span class=\"number\">10.244</span><span class=\"number\">.137</span><span class=\"number\">.70</span>    <span class=\"string\">master1</span>   <span class=\"string\">&lt;none&gt;</span>           <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">四个pod因为集群是三主一从，且定义了容忍度容忍matser污点</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get ds -n kube-system </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>          <span class=\"string\">DESIRED</span>   <span class=\"string\">CURRENT</span>   <span class=\"string\">READY</span>   <span class=\"string\">UP-TO-DATE</span>   <span class=\"string\">AVAILABLE</span>   <span class=\"string\">NODE</span> <span class=\"string\">SELECTOR</span>            <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">fluentd</span>       <span class=\"number\">4</span>         <span class=\"number\">4</span>         <span class=\"number\">4</span>       <span class=\"number\">4</span>            <span class=\"number\">4</span>           <span class=\"string\">&lt;none&gt;</span>                   <span class=\"string\">106s</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"滚动更新-2\"><a class=\"markdownIt-Anchor\" href=\"#滚动更新-2\">#</a> 滚动更新</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">updateStrategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">1</span>  <span class=\"comment\"># 更新期间最大只能有一个不可用，即一个一个更新</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 更新镜像 控制器名字 pod名字 镜像名字</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">set</span> <span class=\"string\">image</span> <span class=\"string\">daemonset</span> <span class=\"string\">fluentd</span> <span class=\"string\">fluentd=nginx</span> <span class=\"string\">-n</span> <span class=\"string\">kube-system</span>     </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">fluentd-55p5p</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>         <span class=\"number\">0</span>          <span class=\"string\">14s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-55p5p</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>         <span class=\"number\">0</span>          <span class=\"string\">14s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-55p5p</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>         <span class=\"number\">0</span>          <span class=\"string\">14s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-55p5p</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Terminating</span>         <span class=\"number\">0</span>          <span class=\"string\">14s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-qk56k</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>             <span class=\"number\">0</span>          <span class=\"string\">0s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-qk56k</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">Pending</span>             <span class=\"number\">0</span>          <span class=\"string\">0s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-qk56k</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">1s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-qk56k</span>                              <span class=\"number\">0</span><span class=\"string\">/1</span>     <span class=\"string\">ContainerCreating</span>   <span class=\"number\">0</span>          <span class=\"string\">3s</span></span><br><span class=\"line\"><span class=\"string\">fluentd-qk56k</span>                              <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>             <span class=\"number\">0</span>          <span class=\"string\">3s</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"configmap\"><a class=\"markdownIt-Anchor\" href=\"#configmap\">#</a> ConfigMap</h2>\n<p>Configmap 是 k8s 中的资源对象，用于保存非机密性的配置的，数据可以用 key/value 键值对的形式保存，也可通过文件的形式保存。</p>\n<p>我们在部署服务的时候，每个服务都有自己的配置文件，如果一台服务器上部署多个服务：nginx、tomcat、apache 等，那么这些配置都存在这个节点上，假如一台服务器不能满足线上高并发的要求，需要对服务器扩容，扩容之后的服务器还是需要部署多个服务：nginx、tomcat、apache，新增加的服务器上还是要管理这些服务的配置，如果有一个服务出现问题，需要修改配置文件，每台物理节点上的配置都需要修改，这种方式肯定满足不了线上大批量的配置变更要求。 所以，k8s 中引入了 Configmap 资源对象，可以当成 volume 挂载到 pod 中，实现统一的配置管理。</p>\n<blockquote>\n<p>1、Configmap 是 k8s 中的资源， 相当于配置文件，可以有一个或者多个 Configmap；</p>\n<p>2、Configmap 可以做成 Volume，k8s pod 启动之后，通过 volume 形式映射到容器内部指定目录上；</p>\n<p>3、容器中应用程序按照原有方式读取容器特定目录上的配置文件。</p>\n<p>4、在容器看来，配置文件就像是打包在容器内部特定目录，整个过程对应用没有任何。</p>\n</blockquote>\n<p>应用场景：</p>\n<blockquote>\n<p>1、使用 k8s 部署应用，当你将应用配置写进代码中，更新配置时也需要打包镜像，configmap 可以将配置信息和 docker 镜像解耦，以便实现镜像的可移植性和可复用性，因为一个 configMap 其实就是一系列配置信息的集合，可直接注入到 Pod 中给容器使用。configmap 注入方式有两种，一种将 configMap 做为存储卷，一种是将 configMap 通过 env 中 configMapKeyRef 注入到容器中。</p>\n<p>2、使用微服务架构的话，存在多个服务共用配置的情况，如果每个服务中单独一份配置的话，那么更新配置就很麻烦，使用 configmap 可以友好的进行配置共享。</p>\n</blockquote>\n<p>configmap 局限性：</p>\n<blockquote>\n<p>ConfigMap 在设计上不是用来保存大量数据的。在 ConfigMap 中保存的数据不可超过 1 MiB。如果你需要保存超出此尺寸限制的数据，可以考虑挂载存储卷或者使用独立的数据库或者文件服务。</p>\n</blockquote>\n<h3 id=\"创建configmap\"><a class=\"markdownIt-Anchor\" href=\"#创建configmap\">#</a> 创建 configMap</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.命令行创建</span></span><br><span class=\"line\"><span class=\"comment\"># 直接在命令行中指定configmap参数创建，通过--from-literal指定参数</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">configmap</span> <span class=\"string\">tomcat-config</span> <span class=\"string\">--from-literal=tomcat_port=8080</span> <span class=\"string\">--from-literal=server_name=myapp.tomcat.com</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl get cm</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>               <span class=\"string\">DATA</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">tomcat-config</span>      <span class=\"number\">2</span>      <span class=\"string\">6s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl describe configmap tomcat-config</span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>         <span class=\"string\">tomcat-config</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>    <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Labels:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Annotations:</span>  <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"string\">Data</span></span><br><span class=\"line\"><span class=\"string\">====</span></span><br><span class=\"line\"><span class=\"attr\">server_name:</span></span><br><span class=\"line\"><span class=\"string\">----</span></span><br><span class=\"line\"><span class=\"string\">myapp.tomcat.com</span></span><br><span class=\"line\"><span class=\"attr\">tomcat_port:</span></span><br><span class=\"line\"><span class=\"string\">----</span></span><br><span class=\"line\"><span class=\"number\">8080</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 2.文件创建</span></span><br><span class=\"line\"><span class=\"string\">创建nginx.conf：</span></span><br><span class=\"line\"><span class=\"string\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">listen</span> <span class=\"number\">80</span><span class=\"string\">;</span></span><br><span class=\"line\">    <span class=\"string\">root</span> <span class=\"string\">html;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl create cm www-nginx --from-file=www=./nginx.conf </span></span><br><span class=\"line\"><span class=\"string\">configmap/www-nginx</span> <span class=\"string\">created</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl describe cm www</span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>         <span class=\"string\">www-nginx</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>    <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Labels:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Annotations:</span>  <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Data</span></span><br><span class=\"line\"><span class=\"string\">====</span></span><br><span class=\"line\"><span class=\"attr\">www:</span></span><br><span class=\"line\"><span class=\"string\">----</span></span><br><span class=\"line\"><span class=\"string\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"string\">listen</span> <span class=\"number\">80</span><span class=\"string\">;</span> </span><br><span class=\"line\">    <span class=\"string\">root</span> <span class=\"string\">html;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 不指定cm名称就是文件名称</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 目录创建</span></span><br><span class=\"line\"><span class=\"comment\"># 整个目录里面的内容都会变成配置文件</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl create cm mysql-config --from-file=./test/</span></span><br><span class=\"line\"><span class=\"string\">configmap/mysql-config</span> <span class=\"string\">created</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl describe cm mysql-config </span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>         <span class=\"string\">mysql-config</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>    <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Labels:</span>       <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"><span class=\"attr\">Annotations:</span>  <span class=\"string\">&lt;none&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Data</span></span><br><span class=\"line\"><span class=\"string\">====</span></span><br><span class=\"line\"><span class=\"attr\">my-cnf:</span></span><br><span class=\"line\"><span class=\"string\">----</span></span><br><span class=\"line\"><span class=\"string\">server-id=1</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">my-slave-cnf:</span></span><br><span class=\"line\"><span class=\"string\">----</span></span><br><span class=\"line\"><span class=\"string\">server-id=2</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># yaml文件创建</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">  <span class=\"attr\">master.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    [mysqld]</span></span><br><span class=\"line\"><span class=\"string\">    log-bin</span></span><br><span class=\"line\"><span class=\"string\">    log_bin_trust_function_creators=1</span></span><br><span class=\"line\"><span class=\"string\">    lower_case_table_names=1</span></span><br><span class=\"line\"><span class=\"string\"></span>  <span class=\"attr\">slave.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">    [mysqld]</span></span><br><span class=\"line\"><span class=\"string\">    super-read-only</span></span><br><span class=\"line\"><span class=\"string\">    log_bin_trust_function_creators=1</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"comment\"># | 代表配置文件有多行</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"yaml文件创建pod中使用\"><a class=\"markdownIt-Anchor\" href=\"#yaml文件创建pod中使用\">#</a> yaml 文件创建 pod 中使用</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># yaml文件创建pod中使用</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysql</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    app: mysql</span><br><span class=\"line\">data:</span><br><span class=\"line\">    <span class=\"built_in\">log</span>: <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    lower: <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\"># 1.通过环境变量引入：使用configMapKeyRef </span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysql-pod</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: mysql</span><br><span class=\"line\">    image: busybox</span><br><span class=\"line\">    <span class=\"built_in\">command</span>: [ <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;sleep 3600&quot;</span> ]</span><br><span class=\"line\">    <span class=\"built_in\">env</span>:</span><br><span class=\"line\">    - name: log_bin   <span class=\"comment\">#定义环境变量log_bin</span></span><br><span class=\"line\">      valueFrom: </span><br><span class=\"line\">        configMapKeyRef:</span><br><span class=\"line\">          name: mysql     <span class=\"comment\">#指定configmap的名字</span></span><br><span class=\"line\">          key: <span class=\"built_in\">log</span> <span class=\"comment\">#指定configmap中的key</span></span><br><span class=\"line\">    - name: lower   <span class=\"comment\">#定义环境变量lower</span></span><br><span class=\"line\">      valueFrom:</span><br><span class=\"line\">        configMapKeyRef:</span><br><span class=\"line\">          name: mysql</span><br><span class=\"line\">          key: lower</span><br><span class=\"line\">  restartPolicy: Never</span><br><span class=\"line\">  </span><br><span class=\"line\">[root@master1 ~]<span class=\"comment\"># kubectl exec -it mysql-pod -- /bin/sh</span></span><br><span class=\"line\">/ <span class=\"comment\"># printenv </span></span><br><span class=\"line\">log_bin=1</span><br><span class=\"line\">lower=2</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 2.使用envfrom</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pod-envfrom</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [ <span class=\"string\">&quot;/bin/sh&quot;</span>, <span class=\"string\">&quot;-c&quot;</span>, <span class=\"string\">&quot;sleep 3600&quot;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">envFrom:</span> </span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">configMapRef:</span></span><br><span class=\"line\">       <span class=\"attr\">name:</span> <span class=\"string\">mysql</span>     <span class=\"comment\">#指定configmap的名字</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\">  </span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl exec -it mysql-pod-envfrom -c mysql -- /bin/sh</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># printenv </span></span><br><span class=\"line\"><span class=\"string\">lower=2</span></span><br><span class=\"line\"><span class=\"string\">log=1</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 3.以存储卷方式挂载</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ConfigMap</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\"><span class=\"attr\">data:</span></span><br><span class=\"line\">    <span class=\"attr\">log:</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">lower:</span> <span class=\"string\">&quot;1&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">my.cnf:</span> <span class=\"string\">|</span></span><br><span class=\"line\"><span class=\"string\">      [mysqld]</span></span><br><span class=\"line\"><span class=\"string\">      haha=shabi</span></span><br><span class=\"line\"><span class=\"string\"></span><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">mysql-pod-volume</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">busybox</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> [ <span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;sleep 3600&quot;</span> ]</span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-config</span></span><br><span class=\"line\">      <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp/config</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">mysql-config</span></span><br><span class=\"line\">    <span class=\"attr\">configMap:</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">mysql</span></span><br><span class=\"line\">  <span class=\"attr\">restartPolicy:</span> <span class=\"string\">Never</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl exec -it mysql-pod-volume -c mysql -- /bin/sh</span></span><br><span class=\"line\"><span class=\"string\">/</span> <span class=\"comment\"># cd /tmp/config/</span></span><br><span class=\"line\"><span class=\"string\">/tmp/config</span> <span class=\"comment\"># ls </span></span><br><span class=\"line\"><span class=\"string\">log</span>     <span class=\"string\">lower</span>   <span class=\"string\">my.cnf</span></span><br><span class=\"line\"><span class=\"string\">/tmp/config</span> <span class=\"comment\"># cat my.cnf </span></span><br><span class=\"line\">[<span class=\"string\">mysqld</span>]</span><br><span class=\"line\"><span class=\"string\">haha=shabi</span></span><br><span class=\"line\"><span class=\"comment\"># 以存储卷挂载不会在环境变量中创建key和value</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">configmap在以volume启动时可以热加载，cm修改，pod内配置也会自动更新，但需要一定时间</span><br><span class=\"line\">环境变量注入不会自动更新cm，即不能热加载</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl create cm redis-conf --from-file=redis.conf </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get cm</span></span><br><span class=\"line\">NAME               DATA   AGE</span><br><span class=\"line\">kube-root-ca.crt   1      3d16h</span><br><span class=\"line\">redis-conf         1      6s</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># configmap 会保存在 etcd中</span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># rm -rf redis.conf </span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get cm redis-conf -oyaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  redis.conf: |</span><br><span class=\"line\">    appendonly <span class=\"built_in\">yes</span></span><br><span class=\"line\">kind: ConfigMap</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: redis-conf</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\"><span class=\"comment\"># data是所有真正的数据</span></span><br><span class=\"line\"><span class=\"comment\"># key默认是文件名 value是配置文件内容 </span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis-server</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;/redis-master/redis.conf&quot;</span>  <span class=\"comment\">#指的是redis容器内部的位置</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">6379</span></span><br><span class=\"line\">    <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/data</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/redis-master</span></span><br><span class=\"line\">      <span class=\"attr\">name:</span> <span class=\"string\">config</span>    <span class=\"comment\"># config 是下面configmap的名字</span></span><br><span class=\"line\">  <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">data</span></span><br><span class=\"line\">      <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">config</span></span><br><span class=\"line\">      <span class=\"attr\">configMap:</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">redis-conf</span>   <span class=\"comment\"># redis-conf的configmap在上面已经创建过</span></span><br><span class=\"line\">        <span class=\"attr\">items:</span>\t\t\t<span class=\"comment\"># items获取data中的内容</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">key:</span> <span class=\"string\">redis.conf</span>   <span class=\"comment\"># 取出redis-conf对应的value</span></span><br><span class=\"line\">          <span class=\"attr\">path:</span> <span class=\"string\">redis.conf</span>  <span class=\"comment\"># /redis-master/redis.conf </span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl edit cm redis-conf </span></span><br><span class=\"line\"><span class=\"string\">configmap/redis-conf</span> <span class=\"string\">edited</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 外部修改配置文件，内部自动同步</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">redis-cli</span></span><br><span class=\"line\"><span class=\"string\">config</span> <span class=\"string\">get</span> <span class=\"string\">appendonly</span></span><br><span class=\"line\"><span class=\"comment\"># 需要重新启动pod，因为pod的中间件没有热更新能力</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"secret\"><a class=\"markdownIt-Anchor\" href=\"#secret\">#</a> secret</h2>\n<p>Secret 对象类型用来保存敏感信息，例如密码、OAuth 令牌和 SSH 密钥。 将这些信息放在 secret 中比放在 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL2RvY3MvY29uY2VwdHMvd29ya2xvYWRzL3BvZHMvcG9kLW92ZXJ2aWV3Lw==\">Pod</span> 的定义或者 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poL2RvY3MvcmVmZXJlbmNlL2dsb3NzYXJ5Lz9hbGw9dHJ1ZSN0ZXJtLWltYWdl\">容器镜像</span> 中来说更加安全和灵活。</p>\n<p>Configmap 一般是用来存放明文数据的，如配置文件，对于一些敏感数据，如密码、私钥等数据时，要用 secret 类型。</p>\n<p>Secret 解决了密码、token、秘钥等敏感数据的配置问题，而不需要把这些敏感数据暴露到镜像或者 Pod Spec 中。Secret 可以以 Volume 或者环境变量的方式使用。</p>\n<p>要使用 secret，pod 需要引用 secret。Pod 可以用两种方式使用 secret：作为 volume 中的文件被挂载到 pod 中的一个或者多个容器里，或者当 kubelet 为 pod 拉取镜像时使用。</p>\n<p>secret 可选参数有三种:</p>\n<blockquote>\n<p>generic: 通用类型，通常用于存储密码数据。</p>\n<p>tls：此类型仅用于存储私钥和证书。</p>\n<p>docker-registry: 若要保存 docker 仓库的认证信息的话，就必须使用此种类型来创建。</p>\n</blockquote>\n<p>Secret 类型：</p>\n<blockquote>\n<p>Service Account：用于被 serviceaccount 引用。serviceaccout 创建时 Kubernetes 会默认创建对应的 secret。Pod 如果使用了 serviceaccount，对应的 secret 会自动挂载到 Pod 的 /run/secrets/kubernetes.io/serviceaccount 目录中。</p>\n<p>Opaque：base64 编码格式的 Secret，用来存储密码、秘钥等。可以通过 base64 --decode 解码获得原始数据，因此安全性弱</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2t1YmVybmV0ZXMuaW8vZG9ja2VyY29uZmlnanNvbiVFRiVCQyU5QSVFNyU5NCVBOCVFNiU5RCVBNSVFNSVBRCU5OCVFNSU4MiVBOCVFNyVBNyU4MSVFNiU5QyU4OWRvY2tlcg==\">kubernetes.io/dockerconfigjson：用来存储私有 docker</span> registry 的认证信息。</p>\n</blockquote>\n<h3 id=\"创建secret\"><a class=\"markdownIt-Anchor\" href=\"#创建secret\">#</a> 创建 secret</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">secret</span>]<span class=\"comment\"># kubectl create secret generic mysql-password --from-literal=password=123456</span></span><br><span class=\"line\"><span class=\"string\">secret/mysql-password</span> <span class=\"string\">created</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">secret</span>]<span class=\"comment\"># kubectl get secrets </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                          <span class=\"string\">TYPE</span>                                  <span class=\"string\">DATA</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">mysql-password</span>                <span class=\"string\">Opaque</span>                                <span class=\"number\">1</span>      <span class=\"string\">11s</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">secret</span>]<span class=\"comment\"># kubectl describe secrets mysql-password </span></span><br><span class=\"line\"><span class=\"attr\">Name:</span>         <span class=\"string\">mysql-password</span></span><br><span class=\"line\"><span class=\"attr\">Namespace:</span>    <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">Type:</span>  <span class=\"string\">Opaque</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">Data</span></span><br><span class=\"line\"><span class=\"string\">====</span></span><br><span class=\"line\"><span class=\"attr\">password:</span>  <span class=\"number\">6</span> <span class=\"string\">bytes</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"使用secret\"><a class=\"markdownIt-Anchor\" href=\"#使用secret\">#</a> 使用 secret</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 环境变量挂载secret</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: pod-secret</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">     app: myapp</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: myapp</span><br><span class=\"line\">    image: nginx</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    ports:</span><br><span class=\"line\">    - name: http</span><br><span class=\"line\">      containerPort: 80</span><br><span class=\"line\">    <span class=\"built_in\">env</span>:</span><br><span class=\"line\">     - name: MYSQL_ROOT_PASSWORD   <span class=\"comment\">#它是Pod启动成功后,Pod中容器的环境变量名.</span></span><br><span class=\"line\">       valueFrom:</span><br><span class=\"line\">          secretKeyRef:</span><br><span class=\"line\">            name: mysql-password  <span class=\"comment\">#这是secret的对象名</span></span><br><span class=\"line\">            key: password      <span class=\"comment\">#它是secret中的key名</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 secret]<span class=\"comment\"># kubectl exec -it pod-secret -- /bin/sh</span></span><br><span class=\"line\"><span class=\"comment\"># printenv</span></span><br><span class=\"line\">MYSQL_ROOT_PASSWORD=123456</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 手动加密</span></span><br><span class=\"line\">[root@master1 secret]<span class=\"comment\"># echo -n &quot;admin&quot; | base64</span></span><br><span class=\"line\">YWRtaW4=</span><br><span class=\"line\">[root@master1 secret]<span class=\"comment\"># echo -n &quot;YWRtaW4=&quot; | base64 -d </span></span><br><span class=\"line\">admin</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: mysecret</span><br><span class=\"line\"><span class=\"built_in\">type</span>: Opaque</span><br><span class=\"line\">data:</span><br><span class=\"line\">  username: YWRtaW4=</span><br><span class=\"line\">  password: MTIzNDU2  <span class=\"comment\"># 用户名和密码都是base64加密</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 secret]<span class=\"comment\"># kubectl describe secrets mysecret </span></span><br><span class=\"line\">Name:         mysecret</span><br><span class=\"line\">Namespace:    default</span><br><span class=\"line\">Labels:       &lt;none&gt;</span><br><span class=\"line\">Annotations:  &lt;none&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">Type:  Opaque</span><br><span class=\"line\"></span><br><span class=\"line\">Data</span><br><span class=\"line\">====</span><br><span class=\"line\">password:  6 bytes</span><br><span class=\"line\">username:  5 bytes</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># volume挂载secret</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: pod-secret-volume</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - name: myapp</span><br><span class=\"line\">    image: nginx</span><br><span class=\"line\">    imagePullPolicy: IfNotPresent</span><br><span class=\"line\">    volumeMounts:</span><br><span class=\"line\">    - name: secret-volume</span><br><span class=\"line\">      mountPath: /etc/secret</span><br><span class=\"line\">      readOnly: <span class=\"literal\">true</span></span><br><span class=\"line\">  volumes:</span><br><span class=\"line\">  - name: secret-volume</span><br><span class=\"line\">    secret:</span><br><span class=\"line\">      secretName: mysecret</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master1 secret]<span class=\"comment\"># kubectl exec -it pod-secret-volume -c myapp -- /bin/bash</span></span><br><span class=\"line\">root@pod-secret-volume:/<span class=\"comment\"># cd /etc/secret</span></span><br><span class=\"line\">root@pod-secret-volume:/etc/secret<span class=\"comment\"># ls </span></span><br><span class=\"line\">password  username</span><br><span class=\"line\">root@pod-secret-volume:/etc/secret<span class=\"comment\"># cat password </span></span><br><span class=\"line\">123456</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl create secret docker-registry kbshire-docker --docker-username=kbshire --docker-password=shabi --docker-email=kbshire@163.com</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get secret </span></span><br><span class=\"line\">NAME                  TYPE                                  DATA   AGE</span><br><span class=\"line\">default-token-mlttj   kubernetes.io/service-account-token   3      3d17h</span><br><span class=\"line\">kbshire-docker        kubernetes.io/dockerconfigjson        1      43s</span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get secret kbshire-docker -oyaml</span></span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">data:</span><br><span class=\"line\">  .dockerconfigjson: eyJhdXRocyI6eyJodHRwczovL2luZGV4LmRvY2tlci5pby92MS8iOnsidXNlcm5hbWUiOiJrYnNoaXJlIiwicGFzc3dvcmQiOiIxODMxMDg5MTNhYkMiLCJlbWFpbCI6Imtic2hpcmVAMTYzLmNvbSIsImF1dGgiOiJhMkp6YUdseVpUb3hPRE14TURnNU1UTmhZa009In19fQ==</span><br><span class=\"line\">kind: Secret</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  creationTimestamp: <span class=\"string\">&quot;2023-04-12T05:50:16Z&quot;</span></span><br><span class=\"line\">  managedFields:</span><br><span class=\"line\">  - apiVersion: v1</span><br><span class=\"line\">    fieldsType: FieldsV1</span><br><span class=\"line\">    fieldsV1:</span><br><span class=\"line\">      f:data:</span><br><span class=\"line\">        .: &#123;&#125;</span><br><span class=\"line\">        f:.dockerconfigjson: &#123;&#125;</span><br><span class=\"line\">      f:<span class=\"built_in\">type</span>: &#123;&#125;</span><br><span class=\"line\">    manager: kubectl-create</span><br><span class=\"line\">    operation: Update</span><br><span class=\"line\">    time: <span class=\"string\">&quot;2023-04-12T05:50:16Z&quot;</span></span><br><span class=\"line\">  name: kbshire-docker</span><br><span class=\"line\">  namespace: default</span><br><span class=\"line\">  resourceVersion: <span class=\"string\">&quot;621248&quot;</span></span><br><span class=\"line\">  uid: 84367164-813e-4f1d-8641-da19acd151b7</span><br><span class=\"line\"><span class=\"built_in\">type</span>: kubernetes.io/dockerconfigjson</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">private-nginx</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">private-nginx</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">leifengyang/guignginx:v1.0</span></span><br><span class=\"line\">  <span class=\"attr\">imagePullSecrets:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kbshire-docker</span>    <span class=\"comment\"># 创建过的secret名称</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"rbac\"><a class=\"markdownIt-Anchor\" href=\"#rbac\">#</a> RBAC</h2>\n<p>认证</p>\n<p>kubernetes 主要通过 APIserver 对外提供服务，那么就需要对访问 apiserver 的用户做认证，如果任何人都能访问 apiserver，那么就可以随意在 k8s 集群部署资源，这是非常危险的，也容易被黑客攻击渗透，所以需要我们对访问 k8s 系统的 apiserver 的用户进行认证，确保是合法的符合要求的用户。</p>\n<p>授权</p>\n<p>认证通过后仅代表它是一个被 apiserver 信任的用户，能访问 apiserver，但是用户是否拥有删除资源的权限， 需要进行授权操作，常见的授权方式有 rbac 授权。</p>\n<p>准入控制</p>\n<p>当用户经过认证和授权之后，最后一步就是准入控制了，k8s 提供了多种准入控制机制，它有点类似 &quot;插件&quot;，为 apiserver 提供了很好的 &quot;可扩展性&quot;。请求 apiserver 时，通过认证、鉴权后、持久化 (“api 对象 &quot;保存到 etcd) 前，会经过&quot; 准入控制器”，让它可以做 &quot;变更和验证&quot;。<br>\n如果我们创建 pod 时定义了资源上下限，但不满足 LimitRange 规则中定义的资源上下限，此时 LimitRanger 就会拒绝我们创建此 pod</p>\n<p>为什么需要准入控制器呢？<br>\n如果我们创建 pod 时定义了资源上下限，但不满足 LimitRange 规则中定义的资源上下限，此时 LimitRanger 就会拒绝我们创建此 pod</p>\n<p>假如我们定义了一个名称空间叫做 test-aa，这个名称空间做下资源限制：限制最多可以使用 10vCPU、10Gi 内存，在这个名称空间 test-aa 下创建的所有 pod，定义 limit 的时候，所有 pod 的 limit 值不能超过 test-aa 这个名称空间设置的 limit 上线。</p>\n<p>k8s 客户端访问 apiserver 的几种认证方式</p>\n<blockquote>\n<p>1）客户端认证：<br>\n客户端认证也称为双向 TLS 认证， kubectl 在访问 apiserver 的时候，apiserver 也要认证 kubectl 是否是合法的，他们都会通过 ca 根证书来进行验证，如下图：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230625160345722.png\" alt=\"image-20230625160345722\"></p>\n<p>2）Bearertoken<br>\nBearertoken 的方式，可以理解为 apiserver 将一个密码通过了非对称加密的方式告诉了 kubectl，然后通过该密码进行相互访问，如下图：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230625160451787.png\" alt=\"image-20230625160451787\"></p>\n<p>Kubectl 访问 k8s 集群，要找一个 kubeconfig 文件，基于 kubeconfig 文件里的用户访问 apiserver</p>\n<ol start=\"3\">\n<li>ServiceAccount</li>\n</ol>\n<p>上面客户端证书认证和 Bearertoken 的两种认证方式，都是外部访问 apiserver 的时候使用的方式，那么我们这次说的 Serviceaccount 是内部访问 pod 和 apiserver 交互时候采用的一种方式。</p>\n<p>Serviceaccount 包括了，namespace、token、ca，且通过目录挂载的方式给予 pod，当 pod 运行起来的时候，就会读取到这些信息，从而使用该方式和 apiserver 进行通信。</p>\n</blockquote>\n<p>在 K8S 集群当中，当我们使用 kubectl 操作 k8s 资源时候，需要确定我们用哪个用户访问哪个 k8s 集群，kubectl 操作 k8s 集群资源会去 /root/.kube 目录下找 config 文件，可以通过 kubectl config 查看 config 文件配置，如下：</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl config view </span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">clusters:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">cluster:</span></span><br><span class=\"line\">    <span class=\"attr\">certificate-authority-data:</span> <span class=\"string\">DATA+OMITTED</span></span><br><span class=\"line\">    <span class=\"attr\">server:</span> <span class=\"string\">https://192.168.13.249:16443</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">contexts:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">context:</span></span><br><span class=\"line\">    <span class=\"attr\">cluster:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">current-context:</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">preferences:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">users:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">user:</span></span><br><span class=\"line\">    <span class=\"attr\">client-certificate-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\">    <span class=\"attr\">client-key-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 指定使用用户访问集群</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span> <span class=\"string\">--kubeconfig=/root/.kube/config</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"授权\"><a class=\"markdownIt-Anchor\" href=\"#授权\">#</a> 授权</h3>\n<p>用户通过认证之后，什么权限都没有，需要一些后续的授权操作，如对资源的增删该查等，kubernetes1.6 之后开始有 RBAC（基于角色的访问控制机制）授权检查机制。</p>\n<p>Kubernetes 的授权是基于插件形成的，其常用的授权插件有以下几种：</p>\n<blockquote>\n<p>1）Node（节点认证）</p>\n<p>2）ABAC (基于属性的访问控制)</p>\n<p>3）RBAC（基于角色的访问控制）</p>\n<p>4）Webhook（基于 http 回调机制的访问控制）</p>\n</blockquote>\n<p>什么是 RBAC（基于角色的授权）</p>\n<p>让一个用户（Users）扮演一个角色（Role），角色拥有权限，从而让用户拥有这样的权限，随后在授权机制当中，只需要将权限授予某个角色，此时用户将获取对应角色的权限，从而实现角色的访问控制。</p>\n<p>另外，k8s 为此还有一种集群级别的授权机制，就是定义一个集群角色（ClusterRole），对集群内的所有资源都有可操作的权限，从而将 User2 通过 ClusterRoleBinding 到 ClusterRole，从而使 User2 拥有集群的操作权限。</p>\n<p>Role、RoleBinding、ClusterRole 和 ClusterRoleBinding 的关系如下：</p>\n<p>1. 用户基于 rolebinding 绑定到 role<br>\n 限定在 rolebinding 所在的名称空间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522152729791.png\" alt=\"image-20230522152729791\"></p>\n<p>2. 用户基于 rolebinding 绑定到 clusterrole<br>\nRoleBinding 仅仅对当前名称空间有对应的权限</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522153654517.png\" alt=\"image-20230522153654517\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）用户通过rolebinding绑定role</span><br><span class=\"line\">（2）用户通过rolebinding绑定clusterrole</span><br><span class=\"line\"></span><br><span class=\"line\">rolebinding绑定clusterrole的好处：</span><br><span class=\"line\">假如有6个名称空间，每个名称空间的用户都需要对自己的名称空间有管理员权限，那么需要定义6个role和rolebinding，然后依次绑定，如果名称空间更多，我们需要定义更多的role，这个是很麻烦的，所以我们引入clusterrole，定义一个clusterrole，对clusterrole授予所有权限，然后用户通过rolebinding绑定到clusterrole，就会拥有自己名称空间的管理员权限了</span><br></pre></td></tr></table></figure>\n<p>3、用户基于 clusterrolebinding 绑定到 clusterrole<br>\n 不限定名称空间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230522154527804.png\" alt=\"image-20230522154527804\"></p>\n<blockquote>\n<p>用户基于 rbac 授权有几种方案：</p>\n<p>基于 rolebinding 绑定到 role 上</p>\n<p>基于 rolebinding 绑定到 clusterrole 上</p>\n<p>基于 clusterrolebinding 绑定到 clusterrole 上</p>\n</blockquote>\n<h3 id=\"准入控制\"><a class=\"markdownIt-Anchor\" href=\"#准入控制\">#</a> 准入控制</h3>\n<p>在 k8s 上准入控制器的模块有很多，其中比较常用的有 LimitRanger、ResourceQuota、ServiceAccount、PodSecurityPolicy (k8s1.25 废弃了) 等等，对于前面三种准入控制器系统默认是启用的，我们只需要定义对应的规则即可；对于 PodSecurityPolicy (k8s1.25 废弃了) 这种准入控制器，系统默认没有启用，如果我们要使用，就必需启用以后，对应规则才会正常生效；这里需要注意一点，对应 psp 准入控制器，一定要先写好对应的规则，把规则和权限绑定好以后，在启用对应的准入控制器，否则先启用准入控制器，没有对应的规则，默认情况它是拒绝操作，这可能导致现有的 k8s 系统跑的系统级 pod 无法正常工作；所以对于 psp 准入控制器要慎用，如果规则和权限做的足够精细，它会给我们的 k8s 系统安全带来大幅度的提升，反之，可能导致整个 k8s 系统不可用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cat /etc/kubernetes/manifests/kube-apiserver.yaml </span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">kind: Pod</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  annotations:</span><br><span class=\"line\">    kubeadm.kubernetes.io/kube-apiserver.advertise-address.endpoint: 192.168.40.63:6443</span><br><span class=\"line\">  creationTimestamp: null</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    component: kube-apiserver</span><br><span class=\"line\">    tier: control-plane</span><br><span class=\"line\">  name: kube-apiserver</span><br><span class=\"line\">  namespace: kube-system</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  containers:</span><br><span class=\"line\">  - command:</span><br><span class=\"line\">    - kube-apiserver</span><br><span class=\"line\">    - --advertise-address=192.168.40.180</span><br><span class=\"line\">    …</span><br><span class=\"line\">    - --enable-admission-plugins=NodeRestriction   # 开启准入插件，逗号分隔</span><br><span class=\"line\"></span><br><span class=\"line\">LimitRanger、ResourceQuota、ServiceAccount 是自动开启的</span><br></pre></td></tr></table></figure>\n<p>apiserver 启用准入控制插件需要使用–enable-admission-plugins 选项来指定，该选项可以使用多个值，用逗号隔开表示启用指定的准入控制插件；这里配置文件中显式启用了 NodeRestrication 这个插件；默认没有写在这上面的内置准入控制器，它也是启用了的，比如 LimitRanger、ResourceQuota、ServiceAccount 等等；对于不同的 k8s 版本，内置的准入控制器和启用与否请查看相关版本的官方文档；对于那些没有启动的准入控制器，我们可以在上面选项中直接启用，分别用逗号隔开即可。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlcm5ldGVzLmlvL3poLWNuL2RvY3MvcmVmZXJlbmNlL2FjY2Vzcy1hdXRobi1hdXRoei9hZG1pc3Npb24tY29udHJvbGxlcnMv\">https://kubernetes.io/zh-cn/docs/reference/access-authn-authz/admission-controllers/</span></p>\n<h3 id=\"useraccount-serviceaccount\"><a class=\"markdownIt-Anchor\" href=\"#useraccount-serviceaccount\">#</a> useraccount 、serviceaccount</h3>\n<p>kubernetes 中账户分为：UserAccounts（用户账户） 和 ServiceAccounts（服务账户） 两种：<br>\nUserAccount 是给 kubernetes 集群外部用户使用的，如 kubectl 访问 k8s 集群要用 useraccount 用户， kubeadm 安装的 k8s，默认的 useraccount 用户是 kubernetes-admin；</p>\n<p>ServiceAccount 是 Pod 使用的账号，Pod 容器的进程需要访问 API Server 时用的就是 ServiceAccount 账户；ServiceAccount 仅局限它所在的 namespace，每个 namespace 创建时都会自动创建一个 default service account；创建 Pod 时，如果没有指定 Service Account，Pod 则会使用 default Service Account。</p>\n<p>ua 是 kubectl 访问集群的<br>\n sa 是 pod 访问 api-server</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl create sa sa-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">sa-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">sa</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">sa-test</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">sa-tomcat</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl exec -it sa-test -- /bin/bash </span></span><br><span class=\"line\"><span class=\"string\">root@sa-test:/#</span> <span class=\"string\">cd</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/</span></span><br><span class=\"line\"><span class=\"string\">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">ls</span> </span><br><span class=\"line\"><span class=\"string\">ca.crt</span>\t<span class=\"string\">namespace</span>  <span class=\"string\">token</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">curl</span> <span class=\"string\">--cacert</span> <span class=\"string\">./ca.crt</span>  <span class=\"string\">-H</span> <span class=\"string\">&quot;Authorization: Bearer $(cat ./token)&quot;</span>   <span class=\"string\">https://kubernetes/api/v1/namespaces/kube-system</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;Status&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;status&quot;:</span> <span class=\"string\">&quot;Failure&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;message&quot;:</span> <span class=\"string\">&quot;namespaces \\&quot;kube-system\\&quot; is forbidden: User \\&quot;system:serviceaccount:default:sa-test\\&quot; cannot get resource \\&quot;namespaces\\&quot; in API group \\&quot;\\&quot; in the namespace \\&quot;kube-system\\&quot;&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;reason&quot;:</span> <span class=\"string\">&quot;Forbidden&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;details&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;kube-system&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;namespaces&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;code&quot;:</span> <span class=\"number\">403</span>   <span class=\"comment\"># 因为SA没有被授权</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 对sa授权</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">sa-test-admin</span> <span class=\"string\">--clusterrole=cluster-admin</span>  <span class=\"string\">--serviceaccount=default:sa-test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">root@sa-test:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">curl</span> <span class=\"string\">--cacert</span> <span class=\"string\">./ca.crt</span>  <span class=\"string\">-H</span> <span class=\"string\">&quot;Authorization: Bearer $(cat ./token)&quot;</span>   <span class=\"string\">https://kubernetes/api/v1/namespaces/kube-system</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;Namespace&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;kube-system&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;uid&quot;:</span> <span class=\"string\">&quot;b25c9a07-c34a-4ce7-8afe-a7b3b1fa6895&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;resourceVersion&quot;:</span> <span class=\"string\">&quot;4&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;creationTimestamp&quot;:</span> <span class=\"string\">&quot;2023-04-25T08:50:07Z&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;managedFields&quot;:</span> [</span><br><span class=\"line\">      &#123;</span><br><span class=\"line\">        <span class=\"attr\">&quot;manager&quot;:</span> <span class=\"string\">&quot;kube-apiserver&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;operation&quot;:</span> <span class=\"string\">&quot;Update&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;time&quot;:</span> <span class=\"string\">&quot;2023-04-25T08:50:07Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;fieldsType&quot;:</span> <span class=\"string\">&quot;FieldsV1&quot;</span>,</span><br><span class=\"line\">        <span class=\"attr\">&quot;fieldsV1&quot;:</span> &#123;<span class=\"string\">&quot;f:status&quot;</span><span class=\"string\">:</span>&#123;<span class=\"string\">&quot;f:phase&quot;</span><span class=\"string\">:</span>&#123;&#125;&#125;&#125;</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;spec&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;finalizers&quot;:</span> [</span><br><span class=\"line\">      <span class=\"string\">&quot;kubernetes&quot;</span></span><br><span class=\"line\">    ]</span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;status&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;phase&quot;:</span> <span class=\"string\">&quot;Active&quot;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"string\">/api/v1/pods</span>  <span class=\"comment\"># 操作pod</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"rbac-2\"><a class=\"markdownIt-Anchor\" href=\"#rbac-2\">#</a> rbac</h3>\n<p>在 Kubernetes 中，所有资源对象都是通过 API 进行操作，他们保存在 etcd 里。而对 etcd 的操作我们需要通过访问 kube-apiserver 来实现，上面的 Service Account 其实就是 APIServer 的认证过程，而授权的机制是通过 RBAC：基于角色的访问控制实现。</p>\n<p>RBAC 有四个资源对象，分别是 Role、ClusterRole、RoleBinding、ClusterRoleBinding</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">role:</span></span><br><span class=\"line\"><span class=\"string\">一组权限的集合，在一个命名空间中，可以用其来定义一个角色，只能对命名空间内的资源进行授权。如果是集群级别的资源，则需要使用ClusterRole。</span></span><br><span class=\"line\"><span class=\"string\">例如：定义一个角色用来读取Pod的权限</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">rbac</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-read</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resourceNames:</span> []</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;list&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">rules中的参数说明：</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、apiGroups：支持的API组列表，例如：&quot;apiVersion:</span> <span class=\"string\">apps/v1&quot;等</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、resources：支持的资源对象列表，例如pods、deployments、jobs等</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、resourceNames:</span> <span class=\"string\">指定resource的名称</span></span><br><span class=\"line\"><span class=\"number\">4</span><span class=\"string\">、verbs：对资源对象的操作方法列表。</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">ClusterRole：集群角色</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">具有和角色一致的命名空间资源的管理能力，还可用于以下特殊元素的授权</span></span><br><span class=\"line\"><span class=\"number\">1</span><span class=\"string\">、集群范围的资源，例如Node</span></span><br><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、非资源型的路径，例如：/healthz</span></span><br><span class=\"line\"><span class=\"number\">3</span><span class=\"string\">、包含全部命名空间的资源，例如Pods</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">例如：定义一个集群角色可让用户访问任意secrets</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">secrets-clusterrole</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;secrets&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resourceNames:</span> []       <span class=\"comment\"># 可以指定对哪个secret做授权，不写对所有做授权</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;list&quot;</span>]</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">RoleBinding：角色绑定、ClusterRolebinding：集群角色绑定</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">角色绑定和集群角色绑定用于把一个角色绑定在一个目标上，可以是User，Group，Service</span> <span class=\"string\">Account，使用RoleBinding为某个命名空间授权，使用ClusterRoleBinding为集群范围内授权。</span></span><br><span class=\"line\"><span class=\"string\">例如：将在rbac命名空间中把pod-read角色授予用户es</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-read-bind</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">rbac</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">User</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-read</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorizatioin.k8s.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">RoleBinding也可以引用ClusterRole，对属于同一命名空间内的ClusterRole定义的资源主体进行授权，</span> <span class=\"string\">例如：es能获取到集群中所有的资源信息</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es-allresource</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">rbac</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">User</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">es</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-admin</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"资源引用方式\"><a class=\"markdownIt-Anchor\" href=\"#资源引用方式\">#</a> 资源引用方式</h3>\n<p>多数资源可以用其名称的字符串表示，也就是 Endpoint 中的 URL 相对路径，例如 pod 中的日志是 GET /api/v1/namaspaces/{namespace}/pods/{podname}/log</p>\n<p>如果需要在一个 RBAC 对象中体现上下级资源，就需要使用 “/” 分割资源和下级资源。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">例如：若想授权让某个主体同时能够读取Pod和Pod</span> <span class=\"string\">log，则可以配置</span> <span class=\"string\">resources为一个数组</span></span><br><span class=\"line\">[<span class=\"string\">root@</span> <span class=\"string\">~</span>]<span class=\"comment\"># kubectl create  ns test</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">logs-reader</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>,<span class=\"string\">&quot;pods/log&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  </span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl get role -n test </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>          <span class=\"string\">CREATED</span> <span class=\"string\">AT</span></span><br><span class=\"line\"><span class=\"string\">logs-reader</span>   <span class=\"number\">2023-05-23T06:33:45Z</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl create sa sa-test -n test </span></span><br><span class=\"line\"><span class=\"string\">serviceaccount/sa-test</span> <span class=\"string\">created</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl create rolebinding sa-test-1 -n test  --role=logs-reader --serviceaccount=test:sa-test</span></span><br><span class=\"line\"><span class=\"string\">rolebinding.rbac.authorization.k8s.io/sa-test-1</span> <span class=\"string\">created</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">sa-test-pod</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">test</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">sa</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">sa-test</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span>  <span class=\"string\">sa-tomcat</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl exec -it -n test sa-test-pod -- /bin/bash </span></span><br><span class=\"line\"><span class=\"string\">root@sa-test-pod:/#</span> <span class=\"string\">cd</span> <span class=\"string\">/var/run/secrets/kubernetes.io/serviceaccount/</span></span><br><span class=\"line\"><span class=\"string\">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">ls</span> </span><br><span class=\"line\"><span class=\"string\">ca.crt</span>\t<span class=\"string\">namespace</span>  <span class=\"string\">token</span></span><br><span class=\"line\"><span class=\"string\">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">curl</span> <span class=\"string\">--cacert</span> <span class=\"string\">./ca.crt</span>  <span class=\"string\">-H</span> <span class=\"string\">&quot;Authorization: Bearer $(cat ./token)&quot;</span>  <span class=\"string\">https://kubernetes.default/api/v1/namespaces/test/pods/sa-test-pod/logs</span></span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;Status&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;apiVersion&quot;:</span> <span class=\"string\">&quot;v1&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;metadata&quot;:</span> &#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;status&quot;:</span> <span class=\"string\">&quot;Failure&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;message&quot;:</span> <span class=\"string\">&quot;pods \\&quot;sa-test-pod\\&quot; is forbidden: User \\&quot;system:serviceaccount:test:sa-test\\&quot; cannot get resource \\&quot;pods/logs\\&quot; in API group \\&quot;\\&quot; in the namespace \\&quot;test\\&quot;&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;reason&quot;:</span> <span class=\"string\">&quot;Forbidden&quot;</span>,</span><br><span class=\"line\">  <span class=\"attr\">&quot;details&quot;:</span> &#123;</span><br><span class=\"line\">    <span class=\"attr\">&quot;name&quot;:</span> <span class=\"string\">&quot;sa-test-pod&quot;</span>,</span><br><span class=\"line\">    <span class=\"attr\">&quot;kind&quot;:</span> <span class=\"string\">&quot;pods&quot;</span></span><br><span class=\"line\">  &#125;,</span><br><span class=\"line\">  <span class=\"attr\">&quot;code&quot;:</span> <span class=\"number\">403</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">root@sa-test-pod:/var/run/secrets/kubernetes.io/serviceaccount#</span> <span class=\"string\">curl</span> <span class=\"string\">--cacert</span> <span class=\"string\">./ca.crt</span>  <span class=\"string\">-H</span> <span class=\"string\">&quot;Authorization: Bearer $(cat ./token)&quot;</span>  <span class=\"string\">https://kuberntes.default/api/v1/namespaces/test/pods/sa-test-pod/log</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">/docker-entrypoint.d/</span> <span class=\"string\">is</span> <span class=\"string\">not</span> <span class=\"string\">empty,</span> <span class=\"string\">will</span> <span class=\"string\">attempt</span> <span class=\"string\">to</span> <span class=\"string\">perform</span> <span class=\"string\">configuration</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">Looking</span> <span class=\"string\">for</span> <span class=\"string\">shell</span> <span class=\"string\">scripts</span> <span class=\"string\">in</span> <span class=\"string\">/docker-entrypoint.d/</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">Launching</span> <span class=\"string\">/docker-entrypoint.d/10-listen-on-ipv6-by-default.sh</span></span><br><span class=\"line\"><span class=\"attr\">10-listen-on-ipv6-by-default.sh: info:</span> <span class=\"string\">Getting</span> <span class=\"string\">the</span> <span class=\"string\">checksum</span> <span class=\"string\">of</span> <span class=\"string\">/etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\"><span class=\"attr\">10-listen-on-ipv6-by-default.sh: info:</span> <span class=\"string\">Enabled</span> <span class=\"string\">listen</span> <span class=\"string\">on</span> <span class=\"string\">IPv6</span> <span class=\"string\">in</span> <span class=\"string\">/etc/nginx/conf.d/default.conf</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">Launching</span> <span class=\"string\">/docker-entrypoint.d/20-envsubst-on-templates.sh</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">Launching</span> <span class=\"string\">/docker-entrypoint.d/30-tune-worker-processes.sh</span></span><br><span class=\"line\"><span class=\"string\">/docker-entrypoint.sh:</span> <span class=\"string\">Configuration</span> <span class=\"string\">complete;</span> <span class=\"string\">ready</span> <span class=\"string\">for</span> <span class=\"string\">start</span> <span class=\"string\">up</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: using the &quot;epoll&quot; event method</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: nginx/1.21.5</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: built by gcc 10.2.1 20210110 (Debian 10.2.1-6) </span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: OS: Linux 3.10.0-1160.el7.x86_64</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: getrlimit(RLIMIT_NOFILE): 1048576:1048576</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: start worker processes</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: start worker process 32</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: start worker process 33</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: start worker process 34</span></span><br><span class=\"line\"><span class=\"number\">2023</span><span class=\"string\">/05/23</span> <span class=\"number\">06</span><span class=\"string\">:37:45</span> [<span class=\"string\">notice</span>] <span class=\"number\">1</span><span class=\"comment\">#1: start worker process 35</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">资源还可以通过名称（ResourceName）进行引用，在指定ResourceName后，使用get、delete、update、patch请求，就会被限制在这个资源实例范围内</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">例如，下面的声明让一个主体只能对名为my-configmap的Configmap进行get和update操作：</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rabc.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">namaspace:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">configmap-update</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;configmaps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;my-configmap&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;update&quot;</span>]</span><br></pre></td></tr></table></figure>\n<h3 id=\"常见角色实例\"><a class=\"markdownIt-Anchor\" href=\"#常见角色实例\">#</a> 常见角色实例</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">（1）允许读取核心API组的Pod资源</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\"><span class=\"string\">（2）允许读写apps</span> <span class=\"string\">API组中的deployment资源</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;apps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;deployments&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;update&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\"><span class=\"string\">（3）允许读取Pod以及读写job信息</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;jobs&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>,<span class=\"string\">&quot;create&quot;</span>,<span class=\"string\">&quot;update&quot;</span>,<span class=\"string\">&quot;patch&quot;</span>,<span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\"><span class=\"string\">（4）允许读取一个名为my-config的ConfigMap（必须绑定到一个RoleBinding来限制到一个Namespace下的ConfigMap）：</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;configmaps&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resourceNames:</span> [<span class=\"string\">&quot;my-configmap&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>]</span><br><span class=\"line\"><span class=\"string\">（5）读取核心组的Node资源（Node属于集群级的资源，所以必须存在于ClusterRole中，并使用ClusterRoleBinding进行绑定）：</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;nodes&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;list&quot;</span>,<span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\"><span class=\"string\">（6）允许对非资源端点“/healthz”及其所有子路径进行GET和POST操作（必须使用ClusterRole和ClusterRoleBinding）：</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">nonResourceURLs:</span> [<span class=\"string\">&quot;/healthz&quot;</span>,<span class=\"string\">&quot;/healthz/*&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>,<span class=\"string\">&quot;post&quot;</span>]</span><br></pre></td></tr></table></figure>\n<h3 id=\"常见的角色绑定示例\"><a class=\"markdownIt-Anchor\" href=\"#常见的角色绑定示例\">#</a> 常见的角色绑定示例</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">（1）用户名alice</span>\t</span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">User</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">alice</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">　　</span><br><span class=\"line\"><span class=\"string\">（2）组名alice</span>\t</span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">Group</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">alice</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">（3）kube-system命名空间中默认Service</span> <span class=\"string\">Account</span>\t</span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">default</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"sa授权\"><a class=\"markdownIt-Anchor\" href=\"#sa授权\">#</a> SA 授权</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">Service</span> <span class=\"string\">Account也是一种账号，是给运行在Pod里的进程提供了必要的身份证明。需要在Pod定义中指明引用的Service</span> <span class=\"string\">Account，这样就可以对Pod的进行赋权操作。</span></span><br><span class=\"line\"><span class=\"string\">例如：pod内可获取rbac命名空间的所有Pod资源，pod-reader-sc的Service</span> <span class=\"string\">Account是绑定了名为pod-read的Role</span>\t</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\"># kubectl create ns rbac</span></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\"># kubectl create sa pod-reader-sc -n rbac</span></span><br><span class=\"line\">[<span class=\"string\">root@</span>]<span class=\"comment\">#cat pod-rbac.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">rbac</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">pod-reader-sc</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">（1）my-namespace中的my-sa</span> <span class=\"string\">Service</span> <span class=\"string\">Account授予只读权限</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">rolebinding</span> <span class=\"string\">my-sa-view</span> <span class=\"string\">--clusterrole=view</span> <span class=\"string\">--serviceaccount=my-namespace:my-sa</span> <span class=\"string\">--namespace=my-namespace</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">（2）为一个命名空间中名为default的Service</span> <span class=\"string\">Account授权</span></span><br><span class=\"line\"><span class=\"string\">如果一个应用没有指定</span> <span class=\"string\">serviceAccountName，则会使用名为default的Service</span> <span class=\"string\">Account。注意，赋予Service</span> <span class=\"string\">Account</span> <span class=\"string\">“default”的权限会让所有没有指定serviceAccountName的Pod都具有这些权限</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">（3）为命名空间中所有Service</span> <span class=\"string\">Account都授予一个角色</span></span><br><span class=\"line\"><span class=\"string\">如果希望在一个命名空间中，任何Service</span> <span class=\"string\">Account应用都具有一个角色，则可以为这一命名空间的Service</span> <span class=\"string\">Account群组进行授权</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">rolebinding</span> <span class=\"string\">serviceaccounts-view</span> <span class=\"string\">--clusterrole=view</span> <span class=\"string\">--group=system:serviceaccounts:my-namespace</span> <span class=\"string\">--namespace=my-namespace</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">（4）为集群范围内所有Service</span> <span class=\"string\">Account都授予一个低权限角色</span></span><br><span class=\"line\"><span class=\"string\">如果不想为每个命名空间管理授权，则可以把一个集群级别的角色赋给所有Service</span> <span class=\"string\">Account。</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">serviceaccounts-view</span> <span class=\"string\">--clusterrole=view</span> <span class=\"string\">--group=system:serviceaccounts</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">（5）为所有Service</span> <span class=\"string\">Account授予超级用户权限</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">serviceaccounts-view</span> <span class=\"string\">--clusterrole=cluster-admin</span> <span class=\"string\">--group=system:serviceaccounts</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># kubectl创建资源对象</span></span><br><span class=\"line\"><span class=\"string\">（1）在命名空间rbac中为用户es授权admin</span> <span class=\"string\">ClusterRole：</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">rolebinding</span> <span class=\"string\">bob-admin-binding</span> <span class=\"string\">--clusterrole=admin</span> <span class=\"string\">--user=es</span> <span class=\"string\">--namespace=rbac</span></span><br><span class=\"line\"></span><br><span class=\"line\">　　</span><br><span class=\"line\"><span class=\"string\">（2）在命名空间rbac中为名为myapp的Service</span> <span class=\"string\">Account授予view</span> <span class=\"string\">ClusterRole：</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"string\">kubctl</span> <span class=\"string\">create</span> <span class=\"string\">rolebinding</span> <span class=\"string\">myapp-role-binding</span> <span class=\"string\">--clusterrole=view</span> <span class=\"string\">--serviceaccount=rbac:myapp</span> <span class=\"string\">--namespace=rbac</span></span><br><span class=\"line\"></span><br><span class=\"line\">　　</span><br><span class=\"line\"><span class=\"string\">（3）在全集群范围内为用户root授予cluster-admin</span> <span class=\"string\">ClusterRole：</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">cluster-binding</span> <span class=\"string\">--clusterrole=cluster-admin</span> <span class=\"string\">--user=root</span></span><br><span class=\"line\"></span><br><span class=\"line\">　　</span><br><span class=\"line\"><span class=\"string\">（4）在全集群范围内为名为myapp的Service</span> <span class=\"string\">Account授予view</span> <span class=\"string\">ClusterRole：</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">create</span> <span class=\"string\">clusterrolebinding</span> <span class=\"string\">service-account-binding</span> <span class=\"string\">--clusterrole=view</span> <span class=\"string\">--serviceaccount=myapp</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"限制不同用户访问k8s\"><a class=\"markdownIt-Anchor\" href=\"#限制不同用户访问k8s\">#</a> 限制不同用户访问 k8s</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">（1）生成一个私钥</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/etc/kubernetes/pki/</span></span><br><span class=\"line\"><span class=\"string\">(umask</span> <span class=\"number\">077</span><span class=\"string\">;</span> <span class=\"string\">openssl</span> <span class=\"string\">genrsa</span> <span class=\"string\">-out</span> <span class=\"string\">lucky.key</span> <span class=\"number\">2048</span><span class=\"string\">)</span> </span><br><span class=\"line\"><span class=\"string\">（2）生成一个证书请求</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">req</span> <span class=\"string\">-new</span> <span class=\"string\">-key</span> <span class=\"string\">lucky.key</span> <span class=\"string\">-out</span> <span class=\"string\">lucky.csr</span> <span class=\"string\">-subj</span> <span class=\"string\">&quot;/CN=lucky&quot;</span></span><br><span class=\"line\"><span class=\"string\">（3）生成一个证书</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">x509</span> <span class=\"string\">-req</span> <span class=\"string\">-in</span> <span class=\"string\">lucky.csr</span> <span class=\"string\">-CA</span> <span class=\"string\">ca.crt</span> <span class=\"string\">-CAkey</span> <span class=\"string\">ca.key</span> <span class=\"string\">-CAcreateserial</span> <span class=\"string\">-out</span> <span class=\"string\">lucky.crt</span> <span class=\"string\">-days</span> <span class=\"number\">3650</span></span><br><span class=\"line\"><span class=\"string\">在kubeconfig下新增加一个lucky这个用户</span></span><br><span class=\"line\"><span class=\"string\">（1）把lucky这个用户添加到kubernetes集群中，可以用来认证apiserver的连接</span></span><br><span class=\"line\">[<span class=\"string\">root@xianchaomaster1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl config set-credentials lucky --client-certificate=./lucky.crt --client-key=./lucky.key --embed-certs=true  </span></span><br><span class=\"line\"><span class=\"string\">（2）在kubeconfig下新增加一个lucky这个账号</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">config</span> <span class=\"string\">set-context</span> <span class=\"string\">lucky@kubernetes</span> <span class=\"string\">--cluster=kubernetes</span> <span class=\"string\">--user=lucky</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">config</span> <span class=\"string\">view</span> </span><br><span class=\"line\"><span class=\"attr\">contexts:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">context:</span></span><br><span class=\"line\">    <span class=\"attr\">cluster:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">context:</span></span><br><span class=\"line\">    <span class=\"attr\">cluster:</span> <span class=\"string\">kubernetes</span></span><br><span class=\"line\">    <span class=\"attr\">user:</span> <span class=\"string\">lucky</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">lucky@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">current-context:</span> <span class=\"string\">lucky@kubernetes</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Config</span></span><br><span class=\"line\"><span class=\"attr\">preferences:</span> &#123;&#125;</span><br><span class=\"line\"><span class=\"attr\">users:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">kubernetes-admin</span></span><br><span class=\"line\">  <span class=\"attr\">user:</span></span><br><span class=\"line\">    <span class=\"attr\">client-certificate-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\">    <span class=\"attr\">client-key-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">lucky</span></span><br><span class=\"line\">  <span class=\"attr\">user:</span></span><br><span class=\"line\">    <span class=\"attr\">client-certificate-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\">    <span class=\"attr\">client-key-data:</span> <span class=\"string\">REDACTED</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl create ns lucky-ns</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl create rolebinding lucky -n lucky-test --clusterrole=cluster-admin --user=lucky</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl get pod -n lucky-test </span></span><br><span class=\"line\"><span class=\"literal\">No</span> <span class=\"string\">resources</span> <span class=\"string\">found</span> <span class=\"string\">in</span> <span class=\"string\">lucky-test</span> <span class=\"string\">namespace.</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl get pod -n default </span></span><br><span class=\"line\"><span class=\"string\">Error</span> <span class=\"string\">from</span> <span class=\"string\">server</span> <span class=\"string\">(Forbidden):</span> <span class=\"attr\">pods is forbidden:</span> <span class=\"string\">User</span> <span class=\"string\">&quot;lucky&quot;</span> <span class=\"string\">cannot</span> <span class=\"string\">list</span> <span class=\"string\">resource</span> <span class=\"string\">&quot;pods&quot;</span> <span class=\"string\">in</span> <span class=\"string\">API</span> <span class=\"string\">group</span> <span class=\"string\">&quot;&quot;</span> <span class=\"string\">in</span> <span class=\"string\">the</span> <span class=\"string\">namespace</span> <span class=\"string\">&quot;default&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">添加一个test的普通用户</span></span><br><span class=\"line\"><span class=\"string\">useradd</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"string\">cp</span> <span class=\"string\">-ar</span> <span class=\"string\">/root/.kube</span> <span class=\"string\">/tmp/</span></span><br><span class=\"line\"><span class=\"string\">修改/tmp/.kube/config文件，把kubernetes-admin相关的删除，只留lucky用户</span></span><br><span class=\"line\"><span class=\"string\">cp</span> <span class=\"string\">-ar</span> <span class=\"string\">/tmp/.kube/</span> <span class=\"string\">/home/test/</span></span><br><span class=\"line\"><span class=\"string\">chown</span> <span class=\"string\">-R</span> <span class=\"string\">test.test</span> <span class=\"string\">/home/test/</span></span><br><span class=\"line\"><span class=\"string\">su</span> <span class=\"bullet\">-</span> <span class=\"string\">test</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span> <span class=\"string\">-n</span> <span class=\"string\">lucky</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">test只能使用lucky的权限访问kubernetes</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">退出test用户，需要在把集群环境切换成管理员权限</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">config</span> <span class=\"string\">use-context</span> <span class=\"string\">kubernetes-admin@kubernetes</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"授权用户能查看所有名称空间pod权限\"><a class=\"markdownIt-Anchor\" href=\"#授权用户能查看所有名称空间pod权限\">#</a> 授权用户能查看所有名称空间 pod 权限</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"string\">ssl认证</span></span><br><span class=\"line\"><span class=\"string\">生成一个证书</span></span><br><span class=\"line\"><span class=\"string\">（1）生成一个私钥</span></span><br><span class=\"line\"><span class=\"string\">cd</span> <span class=\"string\">/etc/kubernetes/pki/</span></span><br><span class=\"line\"><span class=\"string\">(umask</span> <span class=\"number\">077</span><span class=\"string\">;</span> <span class=\"string\">openssl</span> <span class=\"string\">genrsa</span> <span class=\"string\">-out</span> <span class=\"string\">lucky1.key</span> <span class=\"number\">2048</span><span class=\"string\">)</span> </span><br><span class=\"line\"><span class=\"string\">（2）生成一个证书请求</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">req</span> <span class=\"string\">-new</span> <span class=\"string\">-key</span> <span class=\"string\">lucky1.key</span> <span class=\"string\">-out</span> <span class=\"string\">lucky1.csr</span> <span class=\"string\">-subj</span> <span class=\"string\">&quot;/CN=lucky66&quot;</span></span><br><span class=\"line\"><span class=\"string\">（3）生成一个证书</span></span><br><span class=\"line\"><span class=\"string\">openssl</span> <span class=\"string\">x509</span> <span class=\"string\">-req</span> <span class=\"string\">-in</span> <span class=\"string\">lucky1.csr</span> <span class=\"string\">-CA</span> <span class=\"string\">ca.crt</span> <span class=\"string\">-CAkey</span> <span class=\"string\">ca.key</span> <span class=\"string\">-CAcreateserial</span> <span class=\"string\">-out</span> <span class=\"string\">lucky1.crt</span> <span class=\"string\">-days</span> <span class=\"number\">3650</span></span><br><span class=\"line\"><span class=\"string\">在kubeconfig下新增加一个lucky这个用户</span></span><br><span class=\"line\"><span class=\"string\">（1）把lucky这个用户添加到kubernetes集群中，可以用来认证apiserver的连接</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">pki</span>]<span class=\"comment\"># kubectl config set-credentials lucky66 --client-certificate=./lucky1.crt --client-key=./lucky1.key --embed-certs=true  </span></span><br><span class=\"line\"><span class=\"string\">（2）在kubeconfig下新增加一个lucky这个账号</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">config</span> <span class=\"string\">set-context</span> <span class=\"string\">lucky66@kubernetes</span> <span class=\"string\">--cluster=kubernetes</span> <span class=\"string\">--user=lucky66</span></span><br><span class=\"line\"><span class=\"string\">(3)创建一个clusterrole</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">sa</span>]<span class=\"comment\"># vim lucky66-clusterrole.yaml</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">lucky66-get-pod</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;pods&quot;</span>]</span><br><span class=\"line\">  <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span>]<span class=\"comment\"># kubectl apply -f lucky66-clusterrole.yaml</span></span><br><span class=\"line\"><span class=\"string\">（4）创建一个clusterrolebinding</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span>]<span class=\"comment\"># kubectl create clusterrolebinding lucky66-get-pods --clusterrole=lucky66-get-pod  --user=lucky66</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">添加一个test66的普通用户</span></span><br><span class=\"line\"><span class=\"string\">useradd</span> <span class=\"string\">test66</span></span><br><span class=\"line\"><span class=\"string\">rm</span> <span class=\"string\">-rf</span> <span class=\"string\">/tmp/.kube</span></span><br><span class=\"line\"><span class=\"string\">cp</span> <span class=\"string\">-ar</span> <span class=\"string\">/root/.kube</span> <span class=\"string\">/tmp/</span></span><br><span class=\"line\"><span class=\"string\">修改/tmp/.kube/config文件，把kubernetes-admin和lucky相关的删除，只留lucky66用户</span></span><br><span class=\"line\"><span class=\"string\">cp</span> <span class=\"string\">-ar</span> <span class=\"string\">/tmp/.kube/</span> <span class=\"string\">/home/test66/</span></span><br><span class=\"line\"><span class=\"string\">chown</span> <span class=\"string\">-R</span> <span class=\"string\">test66.test66</span> <span class=\"string\">/home/test66/</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span>]<span class=\"comment\"># vim /home/test66/.kube/config</span></span><br><span class=\"line\"><span class=\"string\">把current-context变成如下：</span></span><br><span class=\"line\"><span class=\"attr\">current-context:</span> <span class=\"string\">lucky66@kubernetes</span></span><br><span class=\"line\"><span class=\"string\">su</span>  <span class=\"bullet\">-</span> <span class=\"string\">test66</span></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span> </span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">pods</span>  <span class=\"string\">-n</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">get</span> <span class=\"string\">ns</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"resourcequota准入控制器\"><a class=\"markdownIt-Anchor\" href=\"#resourcequota准入控制器\">#</a> <strong>ResourceQuota 准入控制器</strong></h3>\n<p>ResourceQuota 准入控制器是 k8s 上内置的准入控制器，默认该控制器是启用的状态，它主要作用是用来限制一个名称空间下的资源的使用，它能防止在一个名称空间下的 pod 被过多创建时，导致过多占用 k8s 资源，简单讲它是用来在名称空间级别限制用户的资源使用。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ResourceQuota</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">quota-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">quota</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">hard:</span></span><br><span class=\"line\">    <span class=\"attr\">pods:</span> <span class=\"string\">&quot;6&quot;</span>   <span class=\"comment\"># 数量不能超过6个</span></span><br><span class=\"line\">    <span class=\"attr\">requests.cpu:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">requests.memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">    <span class=\"attr\">limits.cpu:</span> <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">limits.memory:</span> <span class=\"string\">10Gi</span></span><br><span class=\"line\">    <span class=\"attr\">count/deployments.apps:</span> <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">persistentvolumeclaims:</span> <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">quota</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">2</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"number\">1</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"number\">2</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl get pod -n quota   # 注意限制pod数量的不只有pod数量，还有cpu和memory大小，只要有一个不满足要去就不会创建</span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                    <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">quota-8b9bc78cd-d2jcc</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">16s</span></span><br><span class=\"line\"><span class=\"string\">quota-8b9bc78cd-dzxp8</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">16s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ResourceQuota</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">quota-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">quota</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">hard:</span></span><br><span class=\"line\">    <span class=\"attr\">pods:</span> <span class=\"string\">&quot;6&quot;</span>   <span class=\"comment\"># 数量不能超过6个</span></span><br><span class=\"line\">    <span class=\"attr\">requests.cpu:</span> <span class=\"string\">&quot;2&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">requests.memory:</span> <span class=\"string\">2Gi</span></span><br><span class=\"line\">    <span class=\"attr\">limits.cpu:</span> <span class=\"string\">&quot;4&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">limits.memory:</span> <span class=\"string\">10Gi</span></span><br><span class=\"line\">    <span class=\"attr\">count/deployments.apps:</span> <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">persistentvolumeclaims:</span> <span class=\"string\">&quot;6&quot;</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">quota</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">7</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">        <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">myapp</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">80</span></span><br><span class=\"line\">        <span class=\"attr\">resources:</span></span><br><span class=\"line\">          <span class=\"attr\">requests:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"string\">10m</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">100Mi</span></span><br><span class=\"line\">          <span class=\"attr\">limits:</span></span><br><span class=\"line\">              <span class=\"attr\">cpu:</span> <span class=\"number\">1</span></span><br><span class=\"line\">              <span class=\"attr\">memory:</span> <span class=\"string\">1Gi</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">quota</span></span><br><span class=\"line\">      <span class=\"attr\">version:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl get pod -n quota </span></span><br><span class=\"line\"><span class=\"string\">NAME</span>                     <span class=\"string\">READY</span>   <span class=\"string\">STATUS</span>    <span class=\"string\">RESTARTS</span>   <span class=\"string\">AGE</span></span><br><span class=\"line\"><span class=\"string\">quota-646fb6b848-c2h8z</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">24s</span></span><br><span class=\"line\"><span class=\"string\">quota-646fb6b848-v5pmr</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">24s</span></span><br><span class=\"line\"><span class=\"string\">quota-646fb6b848-z2p5k</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">24s</span></span><br><span class=\"line\"><span class=\"string\">quota-646fb6b848-zwwd7</span>   <span class=\"number\">1</span><span class=\"string\">/1</span>     <span class=\"string\">Running</span>   <span class=\"number\">0</span>          <span class=\"string\">24s</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">2</span><span class=\"string\">、限制存储空间大小</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ResourceQuota</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">quota-storage-test</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">quota</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">hard:</span></span><br><span class=\"line\">    <span class=\"attr\">requests.storage:</span> <span class=\"string\">&quot;5Gi&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">persistentvolumeclaims:</span> <span class=\"string\">&quot;5&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">requests.ephemeral-storage:</span> <span class=\"string\">&quot;1Gi&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">limits.ephemeral-storage:</span> <span class=\"string\">&quot;2Gi&quot;</span></span><br></pre></td></tr></table></figure>\n<p>requests.storage 用来限制对应名称空间下的存储下限总和，persistenvolumeclaims 用来限制 pvc 总数量，requests.ephemeral-storage 用来现在使用本地临时存储的下限总容量；limits.ephemeral-storage 用来限制使用本地临时存储上限总容量；以上配置表示在 default 名称空间下非停止状态的容器存储下限总容量不能超过 5G，pvc 的数量不能超过 5 个，本地临时存储下限容量不能超过 1G，上限不能超过 2G。</p>\n<h3 id=\"limitranger准入控制器\"><a class=\"markdownIt-Anchor\" href=\"#limitranger准入控制器\">#</a> LimitRanger 准入控制器</h3>\n<p>LimitRanger 准入控制器是 k8s 上一个内置的准入控制器，LimitRange 是 k8s 上的一个标准资源，它主要用来定义在某个名称空间下限制 pod 或 pod 里的容器对 k8s 上的 cpu 和内存资源使用；它能够定义我们在某个名称空间下创建 pod 时使用的 cpu 和内存的上限和下限以及默认 cpu、内存的上下限。<br>\n如果我们创建 pod 时定义了资源上下限，但不满足 LimitRange 规则中定义的资源上下限，此时 LimitRanger 就会拒绝我们创建此 pod；如果我们在 LimitRange 规则中定义了默认的资源上下限制，我们创建资源没有指定其资源限制，它默认会使用 LimitRange 规则中的默认资源限制；同样的逻辑 LimitRanger 可以限制一个 pod 使用资源的上下限，它还可以限制 pod 中的容器的资源上下限，比限制 pod 更加精准；不管是针对 pod 还是 pod 里的容器，它始终只是限制单个 pod 资源使用。</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Namespace</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">limit</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">LimitRange</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cpu-memory</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">limit</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">limits:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">default:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">1000m</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">1000Mi</span></span><br><span class=\"line\">    <span class=\"attr\">defaultRequest:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">    <span class=\"attr\">min:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">500m</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">500Mi</span></span><br><span class=\"line\">    <span class=\"attr\">max:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"string\">2000m</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"string\">2000Mi</span></span><br><span class=\"line\">    <span class=\"attr\">maxLimitRequestRatio:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span> <span class=\"number\">4</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span> <span class=\"number\">4</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Container</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1beta1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">limit</span> <span class=\"comment\">#ClusterRoleBinding的名字</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">default</span>  <span class=\"comment\">#serviceaccount资源对象的name</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">limit</span> <span class=\"comment\">#serviceaccount的namespace</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">cluster-admin</span> <span class=\"comment\">#k8s集群中最高权限的角色</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">default</span> <span class=\"comment\"># ServiceAccount的名字</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">limit</span> <span class=\"comment\"># serviceaccount的namespace</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">default</span> <span class=\"comment\">#ServiceAccount的标签</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nginx-pod-demo</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">limit</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"string\">kubectl</span> <span class=\"string\">describe</span> <span class=\"string\">pod</span></span><br><span class=\"line\">    <span class=\"attr\">Limits:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span>     <span class=\"number\">1</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span>  <span class=\"string\">1000Mi</span></span><br><span class=\"line\">    <span class=\"attr\">Requests:</span></span><br><span class=\"line\">      <span class=\"attr\">cpu:</span>        <span class=\"string\">500m</span></span><br><span class=\"line\">      <span class=\"attr\">memory:</span>     <span class=\"string\">500Mi</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Pod</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">pod-request</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">limit</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">containers:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">resources:</span></span><br><span class=\"line\">      <span class=\"attr\">requests:</span></span><br><span class=\"line\">        <span class=\"attr\">cpu:</span> <span class=\"string\">100m</span></span><br><span class=\"line\">[<span class=\"string\">root@master1</span> <span class=\"string\">rbac</span>]<span class=\"comment\"># kubectl apply -f haha.yaml </span></span><br><span class=\"line\"><span class=\"string\">Error</span> <span class=\"string\">from</span> <span class=\"string\">server</span> <span class=\"string\">(Forbidden):</span> <span class=\"string\">error</span> <span class=\"string\">when</span> <span class=\"string\">creating</span> <span class=\"attr\">&quot;haha.yaml&quot;:</span> <span class=\"string\">pods</span> <span class=\"string\">&quot;pod-request&quot;</span> <span class=\"attr\">is forbidden:</span> [<span class=\"string\">minimum</span> <span class=\"string\">cpu</span> <span class=\"string\">usage</span> <span class=\"string\">per</span> <span class=\"string\">Container</span> <span class=\"string\">is</span> <span class=\"string\">500m</span>, <span class=\"string\">but</span> <span class=\"string\">request</span> <span class=\"string\">is</span> <span class=\"string\">100m</span>, <span class=\"string\">cpu</span> <span class=\"string\">max</span> <span class=\"string\">limit</span> <span class=\"string\">to</span> <span class=\"string\">request</span> <span class=\"string\">ratio</span> <span class=\"string\">per</span> <span class=\"string\">Container</span> <span class=\"string\">is</span> <span class=\"number\">4</span>, <span class=\"string\">but</span> <span class=\"string\">provided</span> <span class=\"string\">ratio</span> <span class=\"string\">is</span> <span class=\"number\">10.000000</span>]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h1 id=\"kubesphere\"><a class=\"markdownIt-Anchor\" href=\"#kubesphere\">#</a> kubesphere</h1>\n<p>建议配置： master：4c8g  node：4c16g</p>\n<h2 id=\"平台安装\"><a class=\"markdownIt-Anchor\" href=\"#平台安装\">#</a> 平台安装</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Your Kubernetes control-plane has initialized successfully!</span><br><span class=\"line\"></span><br><span class=\"line\">To start using your cluster, you need to run the following as a regular user:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">mkdir</span> -p <span class=\"variable\">$HOME</span>/.kube</span><br><span class=\"line\">  sudo <span class=\"built_in\">cp</span> -i /etc/kubernetes/admin.conf <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\">  sudo <span class=\"built_in\">chown</span> $(<span class=\"built_in\">id</span> -u):$(<span class=\"built_in\">id</span> -g) <span class=\"variable\">$HOME</span>/.kube/config</span><br><span class=\"line\"></span><br><span class=\"line\">Alternatively, <span class=\"keyword\">if</span> you are the root user, you can run:</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"built_in\">export</span> KUBECONFIG=/etc/kubernetes/admin.conf</span><br><span class=\"line\"></span><br><span class=\"line\">You should now deploy a pod network to the cluster.</span><br><span class=\"line\">Run <span class=\"string\">&quot;kubectl apply -f [podnetwork].yaml&quot;</span> with one of the options listed at:</span><br><span class=\"line\">  https://kubernetes.io/docs/concepts/cluster-administration/addons/</span><br><span class=\"line\"></span><br><span class=\"line\">You can now <span class=\"built_in\">join</span> any number of control-plane nodes by copying certificate authorities</span><br><span class=\"line\">and service account keys on each node and <span class=\"keyword\">then</span> running the following as root:</span><br><span class=\"line\"></span><br><span class=\"line\">  kubeadm <span class=\"built_in\">join</span> k8s-master:6443 --token butsu9.lcap4rmxigogjm3g \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:96ec447684310e31f9890dab205123d2081c5e1acbf025e88c727a1951fe0f54 \\</span><br><span class=\"line\">    --control-plane </span><br><span class=\"line\"></span><br><span class=\"line\">Then you can <span class=\"built_in\">join</span> any number of worker nodes by running the following on each as root:</span><br><span class=\"line\"></span><br><span class=\"line\">kubeadm <span class=\"built_in\">join</span> k8s-master:6443 --token butsu9.lcap4rmxigogjm3g \\</span><br><span class=\"line\">    --discovery-token-ca-cert-hash sha256:96ec447684310e31f9890dab205123d2081c5e1acbf025e88c727a1951fe0f54 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"配置前置存储类\"><a class=\"markdownIt-Anchor\" href=\"#配置前置存储类\">#</a> 配置前置存储类</h3>\n<p>安装 nfs-server</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在每个机器。</span></span><br><span class=\"line\">yum install -y nfs-utils</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在master 执行以下命令 </span></span><br><span class=\"line\"><span class=\"built_in\">echo</span> <span class=\"string\">&quot;/nfs/data/ *(insecure,rw,sync,no_root_squash)&quot;</span> &gt; /etc/exports</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 执行以下命令，启动 nfs 服务;创建共享目录</span></span><br><span class=\"line\"><span class=\"built_in\">mkdir</span> -p /nfs/data</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在master执行</span></span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> rpcbind</span><br><span class=\"line\">systemctl <span class=\"built_in\">enable</span> nfs-server</span><br><span class=\"line\">systemctl start rpcbind</span><br><span class=\"line\">systemctl start nfs-server</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使配置生效</span></span><br><span class=\"line\">exportfs -r</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#检查配置是否生效</span></span><br><span class=\"line\">exportfs</span><br></pre></td></tr></table></figure>\n<p>配置 nfs-client</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">showmount -e 172.23.142.216</span><br><span class=\"line\"></span><br><span class=\"line\">mkdir -p /nfs/data</span><br><span class=\"line\"></span><br><span class=\"line\">mount -t nfs 172.23.142.216:/nfs/data /nfs/data</span><br></pre></td></tr></table></figure>\n<p>配置默认存储</p>\n<p>配置动态供应的默认存储类</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">## 创建了一个存储类</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">storage.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">StorageClass</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-storage</span></span><br><span class=\"line\">  <span class=\"attr\">annotations:</span></span><br><span class=\"line\">    <span class=\"attr\">storageclass.kubernetes.io/is-default-class:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\"><span class=\"attr\">provisioner:</span> <span class=\"string\">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">parameters:</span></span><br><span class=\"line\">  <span class=\"attr\">archiveOnDelete:</span> <span class=\"string\">&quot;true&quot;</span>  <span class=\"comment\">## 删除pv的时候，pv的内容是否要备份</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">replicas:</span> <span class=\"number\">1</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">type:</span> <span class=\"string\">Recreate</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">app:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">          <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/nfs-subdir-external-provisioner:v4.0.2</span></span><br><span class=\"line\">          <span class=\"comment\"># resources:</span></span><br><span class=\"line\">          <span class=\"comment\">#    limits:</span></span><br><span class=\"line\">          <span class=\"comment\">#      cpu: 10m</span></span><br><span class=\"line\">          <span class=\"comment\">#    requests:</span></span><br><span class=\"line\">          <span class=\"comment\">#      cpu: 10m</span></span><br><span class=\"line\">          <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">              <span class=\"attr\">mountPath:</span> <span class=\"string\">/persistentvolumes</span></span><br><span class=\"line\">          <span class=\"attr\">env:</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">PROVISIONER_NAME</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">k8s-sigs.io/nfs-subdir-external-provisioner</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_SERVER</span></span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"number\">172.23</span><span class=\"number\">.142</span><span class=\"number\">.216</span> <span class=\"comment\">## 指定自己nfs服务器地址</span></span><br><span class=\"line\">            <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">NFS_PATH</span>  </span><br><span class=\"line\">              <span class=\"attr\">value:</span> <span class=\"string\">/nfs/data</span>  <span class=\"comment\">## nfs服务器共享的目录</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-root</span></span><br><span class=\"line\">          <span class=\"attr\">nfs:</span></span><br><span class=\"line\">            <span class=\"attr\">server:</span> <span class=\"number\">172.23</span><span class=\"number\">.142</span><span class=\"number\">.216</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/nfs/data</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;nodes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumes&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;delete&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;update&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;storage.k8s.io&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;storageclasses&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>]</span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;events&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">run-nfs-client-provisioner</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner-runner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span> [<span class=\"string\">&quot;&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">resources:</span> [<span class=\"string\">&quot;endpoints&quot;</span>]</span><br><span class=\"line\">    <span class=\"attr\">verbs:</span> [<span class=\"string\">&quot;get&quot;</span>, <span class=\"string\">&quot;list&quot;</span>, <span class=\"string\">&quot;watch&quot;</span>, <span class=\"string\">&quot;create&quot;</span>, <span class=\"string\">&quot;update&quot;</span>, <span class=\"string\">&quot;patch&quot;</span>]</span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">nfs-client-provisioner</span></span><br><span class=\"line\">    <span class=\"comment\"># replace with namespace where provisioner is deployed</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">default</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">leader-locking-nfs-client-provisioner</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f sc.yml </span></span><br><span class=\"line\">storageclass.storage.k8s.io/nfs-storage created</span><br><span class=\"line\">deployment.apps/nfs-client-provisioner created</span><br><span class=\"line\">serviceaccount/nfs-client-provisioner created</span><br><span class=\"line\">clusterrole.rbac.authorization.k8s.io/nfs-client-provisioner-runner created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/run-nfs-client-provisioner created</span><br><span class=\"line\">role.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class=\"line\">rolebinding.rbac.authorization.k8s.io/leader-locking-nfs-client-provisioner created</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get sc    # storageclass</span></span><br><span class=\"line\">NAME                    PROVISIONER                                   RECLAIMPOLICY   VOLUMEBINDINGMODE   ALLOWVOLUMEEXPANSION   AGE</span><br><span class=\"line\">nfs-storage (default)   k8s-sigs.io/nfs-subdir-external-provisioner   Delete          Immediate           <span class=\"literal\">false</span>                  18s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kind: PersistentVolumeClaim</span><br><span class=\"line\">apiVersion: v1</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: nginx-pvc</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  accessModes:</span><br><span class=\"line\">    - ReadWriteMany</span><br><span class=\"line\">  resources:</span><br><span class=\"line\">    requests:</span><br><span class=\"line\">      storage: 200Mi</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f pvc.yml </span></span><br><span class=\"line\">persistentvolumeclaim/nginx-pvc created</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pvc</span></span><br><span class=\"line\">NAME        STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE</span><br><span class=\"line\">nginx-pvc   Bound    pvc-2f0e7123-3311-4045-bba9-acdcbad0a572   200Mi      RWX            nfs-storage    10s</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl get pv</span></span><br><span class=\"line\">NAME                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS      CLAIM               STORAGECLASS   REASON   AGE</span><br><span class=\"line\">pv01-10m                                   10M        RWX            Retain           Available                       nfs                     22h</span><br><span class=\"line\">pv02-1gi                                   1Gi        RWX            Retain           Released    default/nginx-pvc   nfs                     22h</span><br><span class=\"line\">pv03-3gi                                   3Gi        RWX            Retain           Available                       nfs                     22h</span><br><span class=\"line\">pvc-2f0e7123-3311-4045-bba9-acdcbad0a572   200Mi      RWX            Delete           Bound       default/nginx-pvc   nfs-storage             24s</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"安装metrics-server\"><a class=\"markdownIt-Anchor\" href=\"#安装metrics-server\">#</a> 安装 metrics-server</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">    <span class=\"attr\">rbac.authorization.k8s.io/aggregate-to-admin:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">rbac.authorization.k8s.io/aggregate-to-edit:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">rbac.authorization.k8s.io/aggregate-to-view:</span> <span class=\"string\">&quot;true&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">system:aggregated-metrics-reader</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">metrics.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nodes</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">system:metrics-server</span></span><br><span class=\"line\"><span class=\"attr\">rules:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">apiGroups:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">resources:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">pods</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nodes</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">nodes/stats</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">namespaces</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">configmaps</span></span><br><span class=\"line\">  <span class=\"attr\">verbs:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">get</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">list</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"string\">watch</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">RoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server-auth-reader</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">Role</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">extension-apiserver-authentication-reader</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server:system:auth-delegator</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">system:auth-delegator</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">rbac.authorization.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">ClusterRoleBinding</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">system:metrics-server</span></span><br><span class=\"line\"><span class=\"attr\">roleRef:</span></span><br><span class=\"line\">  <span class=\"attr\">apiGroup:</span> <span class=\"string\">rbac.authorization.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">kind:</span> <span class=\"string\">ClusterRole</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">system:metrics-server</span></span><br><span class=\"line\"><span class=\"attr\">subjects:</span></span><br><span class=\"line\"><span class=\"bullet\">-</span> <span class=\"attr\">kind:</span> <span class=\"string\">ServiceAccount</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Service</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">ports:</span></span><br><span class=\"line\">  <span class=\"bullet\">-</span> <span class=\"attr\">name:</span> <span class=\"string\">https</span></span><br><span class=\"line\">    <span class=\"attr\">port:</span> <span class=\"number\">443</span></span><br><span class=\"line\">    <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">    <span class=\"attr\">targetPort:</span> <span class=\"string\">https</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apps/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">Deployment</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">selector:</span></span><br><span class=\"line\">    <span class=\"attr\">matchLabels:</span></span><br><span class=\"line\">      <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">strategy:</span></span><br><span class=\"line\">    <span class=\"attr\">rollingUpdate:</span></span><br><span class=\"line\">      <span class=\"attr\">maxUnavailable:</span> <span class=\"number\">0</span></span><br><span class=\"line\">  <span class=\"attr\">template:</span></span><br><span class=\"line\">    <span class=\"attr\">metadata:</span></span><br><span class=\"line\">      <span class=\"attr\">labels:</span></span><br><span class=\"line\">        <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">    <span class=\"attr\">spec:</span></span><br><span class=\"line\">      <span class=\"attr\">containers:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">args:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--cert-dir=/tmp</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--kubelet-insecure-tls</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--secure-port=4443</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--kubelet-preferred-address-types=InternalIP,ExternalIP,Hostname</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"string\">--kubelet-use-node-status-port</span></span><br><span class=\"line\">        <span class=\"attr\">image:</span> <span class=\"string\">registry.cn-hangzhou.aliyuncs.com/lfy_k8s_images/metrics-server:v0.4.3</span></span><br><span class=\"line\">        <span class=\"attr\">imagePullPolicy:</span> <span class=\"string\">IfNotPresent</span></span><br><span class=\"line\">        <span class=\"attr\">livenessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/livez</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"string\">https</span></span><br><span class=\"line\">            <span class=\"attr\">scheme:</span> <span class=\"string\">HTTPS</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">        <span class=\"attr\">ports:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">containerPort:</span> <span class=\"number\">4443</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">https</span></span><br><span class=\"line\">          <span class=\"attr\">protocol:</span> <span class=\"string\">TCP</span></span><br><span class=\"line\">        <span class=\"attr\">readinessProbe:</span></span><br><span class=\"line\">          <span class=\"attr\">failureThreshold:</span> <span class=\"number\">3</span></span><br><span class=\"line\">          <span class=\"attr\">httpGet:</span></span><br><span class=\"line\">            <span class=\"attr\">path:</span> <span class=\"string\">/readyz</span></span><br><span class=\"line\">            <span class=\"attr\">port:</span> <span class=\"string\">https</span></span><br><span class=\"line\">            <span class=\"attr\">scheme:</span> <span class=\"string\">HTTPS</span></span><br><span class=\"line\">          <span class=\"attr\">periodSeconds:</span> <span class=\"number\">10</span></span><br><span class=\"line\">        <span class=\"attr\">securityContext:</span></span><br><span class=\"line\">          <span class=\"attr\">readOnlyRootFilesystem:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">runAsNonRoot:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">          <span class=\"attr\">runAsUser:</span> <span class=\"number\">1000</span></span><br><span class=\"line\">        <span class=\"attr\">volumeMounts:</span></span><br><span class=\"line\">        <span class=\"bullet\">-</span> <span class=\"attr\">mountPath:</span> <span class=\"string\">/tmp</span></span><br><span class=\"line\">          <span class=\"attr\">name:</span> <span class=\"string\">tmp-dir</span></span><br><span class=\"line\">      <span class=\"attr\">nodeSelector:</span></span><br><span class=\"line\">        <span class=\"attr\">kubernetes.io/os:</span> <span class=\"string\">linux</span></span><br><span class=\"line\">      <span class=\"attr\">priorityClassName:</span> <span class=\"string\">system-cluster-critical</span></span><br><span class=\"line\">      <span class=\"attr\">serviceAccountName:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">      <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"attr\">emptyDir:</span> &#123;&#125;</span><br><span class=\"line\">        <span class=\"attr\">name:</span> <span class=\"string\">tmp-dir</span></span><br><span class=\"line\"><span class=\"meta\">---</span></span><br><span class=\"line\"><span class=\"attr\">apiVersion:</span> <span class=\"string\">apiregistration.k8s.io/v1</span></span><br><span class=\"line\"><span class=\"attr\">kind:</span> <span class=\"string\">APIService</span></span><br><span class=\"line\"><span class=\"attr\">metadata:</span></span><br><span class=\"line\">  <span class=\"attr\">labels:</span></span><br><span class=\"line\">    <span class=\"attr\">k8s-app:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">  <span class=\"attr\">name:</span> <span class=\"string\">v1beta1.metrics.k8s.io</span></span><br><span class=\"line\"><span class=\"attr\">spec:</span></span><br><span class=\"line\">  <span class=\"attr\">group:</span> <span class=\"string\">metrics.k8s.io</span></span><br><span class=\"line\">  <span class=\"attr\">groupPriorityMinimum:</span> <span class=\"number\">100</span></span><br><span class=\"line\">  <span class=\"attr\">insecureSkipTLSVerify:</span> <span class=\"literal\">true</span></span><br><span class=\"line\">  <span class=\"attr\">service:</span></span><br><span class=\"line\">    <span class=\"attr\">name:</span> <span class=\"string\">metrics-server</span></span><br><span class=\"line\">    <span class=\"attr\">namespace:</span> <span class=\"string\">kube-system</span></span><br><span class=\"line\">  <span class=\"attr\">version:</span> <span class=\"string\">v1beta1</span></span><br><span class=\"line\">  <span class=\"attr\">versionPriority:</span> <span class=\"number\">100</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f metrics </span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl top nodes </span></span><br><span class=\"line\">NAME     CPU(cores)   CPU%   MEMORY(bytes)   MEMORY%     </span><br><span class=\"line\">master   258m         12%    1889Mi          49%         </span><br><span class=\"line\">node1    &lt;unknown&gt;                           &lt;unknown&gt;               &lt;unknown&gt;               &lt;unknown&gt;               </span><br><span class=\"line\">node2    &lt;unknown&gt;                           &lt;unknown&gt;               &lt;unknown&gt;               &lt;unknown&gt;               </span><br><span class=\"line\">        </span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl top pods  -A </span></span><br><span class=\"line\">NAMESPACE         NAME                                       CPU(cores)   MEMORY(bytes)   </span><br><span class=\"line\">default           nfs-client-provisioner-786945db78-788mx    1m           11Mi            </span><br><span class=\"line\">kube-system       calico-kube-controllers-57c7b58f66-jq7lm   3m           23Mi            </span><br><span class=\"line\">kube-system       calico-node-4bttn                          38m          150Mi           </span><br><span class=\"line\">kube-system       coredns-5897cd56c4-2fhkm                   2m           14Mi            </span><br><span class=\"line\">kube-system       coredns-5897cd56c4-2l59f                   3m           10Mi            </span><br><span class=\"line\">kube-system       etcd-master                                13m          49Mi            </span><br><span class=\"line\">kube-system       kube-apiserver-master                      54m          467Mi           </span><br><span class=\"line\">kube-system       kube-controller-manager-master             22m          58Mi            </span><br><span class=\"line\">kube-system       kube-proxy-d4sgz                           1m           14Mi            </span><br><span class=\"line\">kube-system       kube-scheduler-master                      3m           23Mi            </span><br><span class=\"line\">kube-system       metrics-server-6497cc6c5f-n4l62            3m           13Mi            </span><br><span class=\"line\">tigera-operator   tigera-operator-57cb64cf85-kqsvh           3m           27Mi          </span><br></pre></td></tr></table></figure>\n<h3 id=\"全功能安装\"><a class=\"markdownIt-Anchor\" href=\"#全功能安装\">#</a> 全功能安装</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.2/kubesphere-installer.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">wget https://github.com/kubesphere/ks-installer/releases/download/v3.3.2/cluster-configuration.yaml</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># vi cluster-configuration.yaml </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># vim cluster-configuration.yaml </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f kubesphere-installer.yaml </span></span><br><span class=\"line\">customresourcedefinition.apiextensions.k8s.io/clusterconfigurations.installer.kubesphere.io created</span><br><span class=\"line\">namespace/kubesphere-system created</span><br><span class=\"line\">serviceaccount/ks-installer created</span><br><span class=\"line\">clusterrole.rbac.authorization.k8s.io/ks-installer created</span><br><span class=\"line\">clusterrolebinding.rbac.authorization.k8s.io/ks-installer created</span><br><span class=\"line\">deployment.apps/ks-installer created</span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># kubectl apply -f cluster-configuration.yaml </span></span><br><span class=\"line\">clusterconfiguration.installer.kubesphere.io/ks-installer created</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 修改clust.yml</span></span><br><span class=\"line\">---</span><br><span class=\"line\">apiVersion: installer.kubesphere.io/v1alpha1</span><br><span class=\"line\">kind: ClusterConfiguration</span><br><span class=\"line\">metadata:</span><br><span class=\"line\">  name: ks-installer</span><br><span class=\"line\">  namespace: kubesphere-system</span><br><span class=\"line\">  labels:</span><br><span class=\"line\">    version: v3.1.1</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  persistence:</span><br><span class=\"line\">    storageClass: <span class=\"string\">&quot;&quot;</span>        <span class=\"comment\"># If there is no default StorageClass in your cluster, you need to specify an existing StorageClass here.</span></span><br><span class=\"line\">  authentication:</span><br><span class=\"line\">    jwtSecret: <span class=\"string\">&quot;&quot;</span>           <span class=\"comment\"># Keep the jwtSecret consistent with the Host Cluster. Retrieve the jwtSecret by executing &quot;kubectl -n kubesphere-system get cm kubesphere-config -o yaml | grep -v &quot;apiVersion&quot; | grep jwtSecret&quot; on the Host Cluster.</span></span><br><span class=\"line\">  local_registry: <span class=\"string\">&quot;&quot;</span>        <span class=\"comment\"># Add your private registry address if it is needed.</span></span><br><span class=\"line\">  etcd:</span><br><span class=\"line\">    monitoring: <span class=\"literal\">true</span>       <span class=\"comment\"># Enable or disable etcd monitoring dashboard installation. You have to create a Secret for etcd before you enable it.</span></span><br><span class=\"line\">    endpointIps: 172.31.0.4  <span class=\"comment\"># etcd cluster EndpointIps. It can be a bunch of IPs here.</span></span><br><span class=\"line\">    port: 2379              <span class=\"comment\"># etcd port.</span></span><br><span class=\"line\">    tlsEnable: <span class=\"literal\">true</span></span><br><span class=\"line\">  common:</span><br><span class=\"line\">    redis:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    openldap:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">    minioVolumeSize: 20Gi <span class=\"comment\"># Minio PVC size.</span></span><br><span class=\"line\">    openldapVolumeSize: 2Gi   <span class=\"comment\"># openldap PVC size.</span></span><br><span class=\"line\">    redisVolumSize: 2Gi <span class=\"comment\"># Redis PVC size.</span></span><br><span class=\"line\">    monitoring:</span><br><span class=\"line\">      <span class=\"comment\"># type: external   # Whether to specify the external prometheus stack, and need to modify the endpoint at the next line.</span></span><br><span class=\"line\">      endpoint: http://prometheus-operated.kubesphere-monitoring-system.svc:9090 <span class=\"comment\"># Prometheus endpoint to get metrics data.</span></span><br><span class=\"line\">    es:   <span class=\"comment\"># Storage backend for logging, events and auditing.</span></span><br><span class=\"line\">      <span class=\"comment\"># elasticsearchMasterReplicas: 1   # The total number of master nodes. Even numbers are not allowed.</span></span><br><span class=\"line\">      <span class=\"comment\"># elasticsearchDataReplicas: 1     # The total number of data nodes.</span></span><br><span class=\"line\">      elasticsearchMasterVolumeSize: 4Gi   <span class=\"comment\"># The volume size of Elasticsearch master nodes.</span></span><br><span class=\"line\">      elasticsearchDataVolumeSize: 20Gi    <span class=\"comment\"># The volume size of Elasticsearch data nodes.</span></span><br><span class=\"line\">      logMaxAge: 7                     <span class=\"comment\"># Log retention time in built-in Elasticsearch. It is 7 days by default.</span></span><br><span class=\"line\">      elkPrefix: logstash              <span class=\"comment\"># The string making up index names. The index name will be formatted as ks-&lt;elk_prefix&gt;-log.</span></span><br><span class=\"line\">      basicAuth:</span><br><span class=\"line\">        enabled: <span class=\"literal\">false</span></span><br><span class=\"line\">        username: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        password: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">      externalElasticsearchUrl: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">      externalElasticsearchPort: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">  console:</span><br><span class=\"line\">    enableMultiLogin: <span class=\"literal\">true</span>  <span class=\"comment\"># Enable or disable simultaneous logins. It allows different users to log in with the same account at the same time.</span></span><br><span class=\"line\">    port: 30880</span><br><span class=\"line\">  alerting:                <span class=\"comment\"># (CPU: 0.1 Core, Memory: 100 MiB) It enables users to customize alerting policies to send messages to receivers in time with different time intervals and alerting levels to choose from.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>         <span class=\"comment\"># Enable or disable the KubeSphere Alerting System.</span></span><br><span class=\"line\">    <span class=\"comment\"># thanosruler:</span></span><br><span class=\"line\">    <span class=\"comment\">#   replicas: 1</span></span><br><span class=\"line\">    <span class=\"comment\">#   resources: &#123;&#125;</span></span><br><span class=\"line\">  auditing:                <span class=\"comment\"># Provide a security-relevant chronological set of records，recording the sequence of activities happening on the platform, initiated by different tenants.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>         <span class=\"comment\"># Enable or disable the KubeSphere Auditing Log System. </span></span><br><span class=\"line\">  devops:                  <span class=\"comment\"># (CPU: 0.47 Core, Memory: 8.6 G) Provide an out-of-the-box CI/CD system based on Jenkins, and automated workflow tools including Source-to-Image &amp; Binary-to-Image.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>             <span class=\"comment\"># Enable or disable the KubeSphere DevOps System.</span></span><br><span class=\"line\">    jenkinsMemoryLim: 2Gi      <span class=\"comment\"># Jenkins memory limit.</span></span><br><span class=\"line\">    jenkinsMemoryReq: 1500Mi   <span class=\"comment\"># Jenkins memory request.</span></span><br><span class=\"line\">    jenkinsVolumeSize: 8Gi     <span class=\"comment\"># Jenkins volume size.</span></span><br><span class=\"line\">    jenkinsJavaOpts_Xms: 512m  <span class=\"comment\"># The following three fields are JVM parameters.</span></span><br><span class=\"line\">    jenkinsJavaOpts_Xmx: 512m</span><br><span class=\"line\">    jenkinsJavaOpts_MaxRAM: 2g</span><br><span class=\"line\">  events:                  <span class=\"comment\"># Provide a graphical web console for Kubernetes Events exporting, filtering and alerting in multi-tenant Kubernetes clusters.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>         <span class=\"comment\"># Enable or disable the KubeSphere Events System.</span></span><br><span class=\"line\">    ruler:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">      replicas: 2</span><br><span class=\"line\">  logging:                 <span class=\"comment\"># (CPU: 57 m, Memory: 2.76 G) Flexible logging functions are provided for log query, collection and management in a unified console. Additional log collectors can be added, such as Elasticsearch, Kafka and Fluentd.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>         <span class=\"comment\"># Enable or disable the KubeSphere Logging System.</span></span><br><span class=\"line\">    logsidecar:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span></span><br><span class=\"line\">      replicas: 2</span><br><span class=\"line\">  metrics_server:                    <span class=\"comment\"># (CPU: 56 m, Memory: 44.35 MiB) It enables HPA (Horizontal Pod Autoscaler).</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">false</span>                   <span class=\"comment\"># Enable or disable metrics-server.</span></span><br><span class=\"line\">  monitoring:</span><br><span class=\"line\">    storageClass: <span class=\"string\">&quot;&quot;</span>                 <span class=\"comment\"># If there is an independent StorageClass you need for Prometheus, you can specify it here. The default StorageClass is used by default.</span></span><br><span class=\"line\">    <span class=\"comment\"># prometheusReplicas: 1          # Prometheus replicas are responsible for monitoring different segments of data source and providing high availability.</span></span><br><span class=\"line\">    prometheusMemoryRequest: 400Mi   <span class=\"comment\"># Prometheus request memory.</span></span><br><span class=\"line\">    prometheusVolumeSize: 20Gi       <span class=\"comment\"># Prometheus PVC size.</span></span><br><span class=\"line\">    <span class=\"comment\"># alertmanagerReplicas: 1          # AlertManager Replicas.</span></span><br><span class=\"line\">  multicluster:</span><br><span class=\"line\">    clusterRole: none  <span class=\"comment\"># host | member | none  # You can install a solo cluster, or specify it as the Host or Member Cluster.</span></span><br><span class=\"line\">  network:</span><br><span class=\"line\">    networkpolicy: <span class=\"comment\"># Network policies allow network isolation within the same cluster, which means firewalls can be set up between certain instances (Pods).</span></span><br><span class=\"line\">      <span class=\"comment\"># Make sure that the CNI network plugin used by the cluster supports NetworkPolicy. There are a number of CNI network plugins that support NetworkPolicy, including Calico, Cilium, Kube-router, Romana and Weave Net.</span></span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span> <span class=\"comment\"># Enable or disable network policies.</span></span><br><span class=\"line\">    ippool: <span class=\"comment\"># Use Pod IP Pools to manage the Pod network address space. Pods to be created can be assigned IP addresses from a Pod IP Pool.</span></span><br><span class=\"line\">      <span class=\"built_in\">type</span>: calico <span class=\"comment\"># Specify &quot;calico&quot; for this field if Calico is used as your CNI plugin. &quot;none&quot; means that Pod IP Pools are disabled.</span></span><br><span class=\"line\">    topology: <span class=\"comment\"># Use Service Topology to view Service-to-Service communication based on Weave Scope.</span></span><br><span class=\"line\">      <span class=\"built_in\">type</span>: none <span class=\"comment\"># Specify &quot;weave-scope&quot; for this field to enable Service Topology. &quot;none&quot; means that Service Topology is disabled.</span></span><br><span class=\"line\">  openpitrix: <span class=\"comment\"># An App Store that is accessible to all platform tenants. You can use it to manage apps across their entire lifecycle.</span></span><br><span class=\"line\">    store:</span><br><span class=\"line\">      enabled: <span class=\"literal\">true</span> <span class=\"comment\"># Enable or disable the KubeSphere App Store.</span></span><br><span class=\"line\">  servicemesh:         <span class=\"comment\"># (0.3 Core, 300 MiB) Provide fine-grained traffic management, observability and tracing, and visualized traffic topology.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>     <span class=\"comment\"># Base component (pilot). Enable or disable KubeSphere Service Mesh (Istio-based).</span></span><br><span class=\"line\">  kubeedge:          <span class=\"comment\"># Add edge nodes to your cluster and deploy workloads on edge nodes.</span></span><br><span class=\"line\">    enabled: <span class=\"literal\">true</span>   <span class=\"comment\"># Enable or disable KubeEdge.</span></span><br><span class=\"line\">    cloudCore:</span><br><span class=\"line\">      nodeSelector: &#123;<span class=\"string\">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">      tolerations: []</span><br><span class=\"line\">      cloudhubPort: <span class=\"string\">&quot;10000&quot;</span></span><br><span class=\"line\">      cloudhubQuicPort: <span class=\"string\">&quot;10001&quot;</span></span><br><span class=\"line\">      cloudhubHttpsPort: <span class=\"string\">&quot;10002&quot;</span></span><br><span class=\"line\">      cloudstreamPort: <span class=\"string\">&quot;10003&quot;</span></span><br><span class=\"line\">      tunnelPort: <span class=\"string\">&quot;10004&quot;</span></span><br><span class=\"line\">      cloudHub:</span><br><span class=\"line\">        advertiseAddress: <span class=\"comment\"># At least a public IP address or an IP address which can be accessed by edge nodes must be provided.</span></span><br><span class=\"line\">          - <span class=\"string\">&quot;&quot;</span>            <span class=\"comment\"># Note that once KubeEdge is enabled, CloudCore will malfunction if the address is not provided.</span></span><br><span class=\"line\">        nodeLimit: <span class=\"string\">&quot;100&quot;</span></span><br><span class=\"line\">      service:</span><br><span class=\"line\">        cloudhubNodePort: <span class=\"string\">&quot;30000&quot;</span></span><br><span class=\"line\">        cloudhubQuicNodePort: <span class=\"string\">&quot;30001&quot;</span></span><br><span class=\"line\">        cloudhubHttpsNodePort: <span class=\"string\">&quot;30002&quot;</span></span><br><span class=\"line\">        cloudstreamNodePort: <span class=\"string\">&quot;30003&quot;</span></span><br><span class=\"line\">        tunnelNodePort: <span class=\"string\">&quot;30004&quot;</span></span><br><span class=\"line\">    edgeWatcher:</span><br><span class=\"line\">      nodeSelector: &#123;<span class=\"string\">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">      tolerations: []</span><br><span class=\"line\">      edgeWatcherAgent:</span><br><span class=\"line\">        nodeSelector: &#123;<span class=\"string\">&quot;node-role.kubernetes.io/worker&quot;</span>: <span class=\"string\">&quot;&quot;</span>&#125;</span><br><span class=\"line\">        tolerations: []</span><br></pre></td></tr></table></figure>\n<p>检查日志</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l <span class=\"string\">&#x27;app in (ks-install, ks-installer)&#x27;</span> -o jsonpath=<span class=\"string\">&#x27;&#123;.items[0].metadata.name&#125;&#x27;</span>) -f</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 排查</span></span><br><span class=\"line\">kubectl describe pod -n namespace name</span><br></pre></td></tr></table></figure>\n<p>etcd 监控证书</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl -n kubesphere-monitoring-system create secret generic kube-etcd-client-certs  --from-file=etcd-client-ca.crt=/etc/kubernetes/pki/etcd/ca.crt  --from-file=etcd-client.crt=/etc/kubernetes/pki/apiserver-etcd-client.crt  --from-file=etcd-client.key=/etc/kubernetes/pki/apiserver-etcd-client.key</span><br></pre></td></tr></table></figure>\n<h2 id=\"linxu-安装-单节点\"><a class=\"markdownIt-Anchor\" href=\"#linxu-安装-单节点\">#</a> linxu 安装 单节点</h2>\n<p>1. 准备 kubekey</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export KKZONE=cn</span><br><span class=\"line\">curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -</span><br><span class=\"line\">chmod +x kk</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>2. 使用 kubekey 引导安装集群</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./kk create cluster [--with-kubernetes version] [--with-kubesphere version]</span><br><span class=\"line\">./kk create cluster --with-kubernetes v1.22.12 --with-kubesphere v3.3.2</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>这样不是全功能平台</p>\n<p>安装后开启功能</p>\n<blockquote>\n<ol>\n<li></li>\n<li>\n<p>以  <code>admin</code>  用户登录控制台，点击左上角的<strong>平台管理</strong>，选择<strong>集群管理</strong>。</p>\n</li>\n<li>\n<p>点击<strong>定制资源定义</strong>，在搜索栏中输入  <code>clusterconfiguration</code> ，点击搜索结果查看其详细页面。</p>\n<p>信息</p>\n<p>定制资源定义（CRD）允许用户在不新增 API 服务器的情况下创建一种新的资源类型，用户可以像使用其他 Kubernetes 原生对象一样使用这些定制资源。</p>\n</li>\n<li>\n<p>在<strong>自定义资源</strong>中，点击  <code>ks-installer</code>  右侧的 <img data-src=\"https://kubesphere.io/images/docs/v3.3/zh-cn/enable-pluggable-components/kubesphere-devops-system/three-dots.png\" alt=\"img\">，选择<strong>编辑 YAML</strong>。</p>\n</li>\n<li>\n<p>在该 YAML 文件中，搜索  <code>devops</code> ，将  <code>enabled</code>  的  <code>false</code>  改为  <code>true</code> 。完成后，点击右下角的<strong>确定</strong>，保存配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">devops:</span><br><span class=\"line\">  enabled: true # 将“false”更改为“true”。</span><br></pre></td></tr></table></figure>\n</li>\n<li>\n<p>在 kubectl 中执行以下命令检查安装过程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">kubectl logs -n kubesphere-system $(kubectl get pod -n kubesphere-system -l &#x27;app in (ks-install, ks-installer)&#x27; -o jsonpath=&#x27;&#123;.items[0].metadata.name&#125;&#x27;) -f</span><br></pre></td></tr></table></figure>\n</li>\n</ol>\n</blockquote>\n<h2 id=\"linux多节点安装\"><a class=\"markdownIt-Anchor\" href=\"#linux多节点安装\">#</a> linux 多节点安装</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># master节点</span></span><br><span class=\"line\"><span class=\"built_in\">export</span> KKZONE=cn</span><br><span class=\"line\">curl -sfL https://get-kk.kubesphere.io | VERSION=v3.0.7 sh -</span><br><span class=\"line\"><span class=\"built_in\">chmod</span> +x kk</span><br><span class=\"line\"></span><br><span class=\"line\"> ./kk create config --with-kubernetes v1.22.12 --with-kubesphere v3.3.2</span><br><span class=\"line\"></span><br><span class=\"line\">vim config.sample</span><br><span class=\"line\">spec:</span><br><span class=\"line\">  hosts:</span><br><span class=\"line\">  - &#123;name: master, address: 192.168.0.2, internalAddress: 192.168.0.2, user: ubuntu, password: Testing123&#125;</span><br><span class=\"line\">  - &#123;name: node1, address: 192.168.0.3, internalAddress: 192.168.0.3, user: ubuntu, password: Testing123&#125;</span><br><span class=\"line\">  - &#123;name: node2, address: 192.168.0.4, internalAddress: 192.168.0.4, user: ubuntu, password: Testing123&#125;</span><br><span class=\"line\">  roleGroups:</span><br><span class=\"line\">    etcd:</span><br><span class=\"line\">    - master</span><br><span class=\"line\">    control-plane:</span><br><span class=\"line\">    - master</span><br><span class=\"line\">    worker:</span><br><span class=\"line\">    - node1</span><br><span class=\"line\">    - node2</span><br><span class=\"line\">  controlPlaneEndpoint:</span><br><span class=\"line\">    domain: lb.kubesphere.local</span><br><span class=\"line\">    address: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    port: 6443</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">./kk create cluster -f config-sample.yaml</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9rdWJlc3BoZXJlLmlvL3poL2RvY3MvdjMuMy9pbnN0YWxsaW5nLW9uLWxpbnV4L2ludHJvZHVjdGlvbi9tdWx0aW92ZXJ2aWV3LyMlRTYlQUQlQTUlRTklQUElQTQtMyVFNSU4OCU5QiVFNSVCQiVCQSVFOSU5QiU4NiVFNyVCRSVBNA==\">多节点安装 (kubesphere.io)</span></p>\n<h2 id=\"部署应用\"><a class=\"markdownIt-Anchor\" href=\"#部署应用\">#</a> 部署应用</h2>\n<h3 id=\"使用镜像部署\"><a class=\"markdownIt-Anchor\" href=\"#使用镜像部署\">#</a> 使用镜像部署</h3>\n<p>deploy：部署无状态应用</p>\n<p>stateful：部署有状态应用，中间件</p>\n<p>daemon：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230413152836946.png\" alt=\"image-20230413152836946\"></p>\n<p>工作负载 -&gt; PVC -&gt; configmap -&gt; service -&gt; ingress</p>\n<p>pvc 建议现用现创</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 建议部署流程</span></span><br><span class=\"line\">1.定义配置字典</span><br><span class=\"line\">2.应用负载-创建工作负载</span><br><span class=\"line\">3.创建工作负载时创建持久卷</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用应用市场部署\"><a class=\"markdownIt-Anchor\" href=\"#使用应用市场部署\">#</a> 使用应用市场部署</h3>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155446759.png\" alt=\"image-20230414155446759\"></p>\n<h3 id=\"使用应用模板部署\"><a class=\"markdownIt-Anchor\" href=\"#使用应用模板部署\">#</a> 使用应用模板部署</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZWxtLnNoLw==\">Helm</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcnRpZmFjdGh1Yi5pby8=\">Artifact Hub</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.找到仓库地址</span><br><span class=\"line\">https://charts.bitnami.com/bitnami</span><br><span class=\"line\">2.找到对应的工作空间</span><br><span class=\"line\">添加应用仓库</span><br><span class=\"line\">创建应用时从应用模板创建</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155403399.png\" alt=\"image-20230414155403399\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414155326651.png\" alt=\"image-20230414155326651\"></p>\n<h2 id=\"部署ruoyi-cloud\"><a class=\"markdownIt-Anchor\" href=\"#部署ruoyi-cloud\">#</a> 部署 ruoyi cloud</h2>\n<h3 id=\"本地部署\"><a class=\"markdownIt-Anchor\" href=\"#本地部署\">#</a> 本地部署</h3>\n<p>1. 下载 ruoyi cloud 源码</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20veV9wcm9qZWN0L1J1b1lpLUNsb3Vk\">RuoYi-Cloud: 🎉 基于 Spring Boot、Spring Cloud &amp; Alibaba 的分布式微服务架构权限管理系统，同时提供了 Vue3 的版本 (gitee.com)</span></p>\n<p>2. 下载 nacos</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uYWNvcy5pby96aC1jbi9kb2NzL3F1aWNrLXN0YXJ0Lmh0bWw=\">Nacos 快速开始</span></p>\n<p>3. 修改配置文件</p>\n<p><code>application.properties</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">spring.datasource.platform=mysql</span><br><span class=\"line\"><span class=\"comment\"># spring.sql.init.platform=mysql</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### Count of DB:</span></span><br><span class=\"line\">db.num=1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">### Connect URL of DB:</span></span><br><span class=\"line\">db.url.0=jdbc:mysql://127.0.0.1:3306/nacos?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=<span class=\"literal\">true</span>&amp;useUnicode=<span class=\"literal\">true</span>&amp;useSSL=<span class=\"literal\">false</span>&amp;serverTimezone=UTC</span><br><span class=\"line\">db.user.0=root</span><br><span class=\"line\">db.password.0=root123</span><br></pre></td></tr></table></figure>\n<p>创建数据库 nacos</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230414161432325.png\" alt=\"image-20230414161432325\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/*</span><br><span class=\"line\"> * Copyright 1999-2018 Alibaba Group Holding Ltd.</span><br><span class=\"line\"> *</span><br><span class=\"line\"> * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span><br><span class=\"line\"> * you may not use this file except in compliance with the License.</span><br><span class=\"line\"> * You may obtain a copy of the License at</span><br><span class=\"line\"> *</span><br><span class=\"line\"> *      http://www.apache.org/licenses/LICENSE-2.0</span><br><span class=\"line\"> *</span><br><span class=\"line\"> * Unless required by applicable law or agreed to in writing, software</span><br><span class=\"line\"> * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span><br><span class=\"line\"> * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span><br><span class=\"line\"> * See the License for the specific language governing permissions and</span><br><span class=\"line\"> * limitations under the License.</span><br><span class=\"line\"> */</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = config_info   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `config_info` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) DEFAULT NULL,</span><br><span class=\"line\">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class=\"line\">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class=\"line\">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class=\"line\">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class=\"line\">  `c_desc` varchar(256) DEFAULT NULL,</span><br><span class=\"line\">  `c_use` varchar(64) DEFAULT NULL,</span><br><span class=\"line\">  `effect` varchar(64) DEFAULT NULL,</span><br><span class=\"line\">  `type` varchar(64) DEFAULT NULL,</span><br><span class=\"line\">  `c_schema` text,</span><br><span class=\"line\">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_configinfo_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = config_info_aggr   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `config_info_aggr` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class=\"line\">  `datum_id` varchar(255) NOT NULL COMMENT &#x27;datum_id&#x27;,</span><br><span class=\"line\">  `content` longtext NOT NULL COMMENT &#x27;内容&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  `app_name` varchar(128) DEFAULT NULL,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_configinfoaggr_datagrouptenantdatum` (`data_id`,`group_id`,`tenant_id`,`datum_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;增加租户字段&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = config_info_beta   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `config_info_beta` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class=\"line\">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class=\"line\">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class=\"line\">  `beta_ips` varchar(1024) DEFAULT NULL COMMENT &#x27;betaIps&#x27;,</span><br><span class=\"line\">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class=\"line\">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class=\"line\">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_configinfobeta_datagrouptenant` (`data_id`,`group_id`,`tenant_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_beta&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = config_info_tag   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `config_info_tag` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class=\"line\">  `tag_id` varchar(128) NOT NULL COMMENT &#x27;tag_id&#x27;,</span><br><span class=\"line\">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class=\"line\">  `content` longtext NOT NULL COMMENT &#x27;content&#x27;,</span><br><span class=\"line\">  `md5` varchar(32) DEFAULT NULL COMMENT &#x27;md5&#x27;,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  `src_user` text COMMENT &#x27;source user&#x27;,</span><br><span class=\"line\">  `src_ip` varchar(50) DEFAULT NULL COMMENT &#x27;source ip&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_configinfotag_datagrouptenanttag` (`data_id`,`group_id`,`tenant_id`,`tag_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_info_tag&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = config_tags_relation   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `config_tags_relation` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `tag_name` varchar(128) NOT NULL COMMENT &#x27;tag_name&#x27;,</span><br><span class=\"line\">  `tag_type` varchar(64) DEFAULT NULL COMMENT &#x27;tag_type&#x27;,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL COMMENT &#x27;data_id&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL COMMENT &#x27;group_id&#x27;,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class=\"line\">  `nid` bigint(20) NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  PRIMARY KEY (`nid`),</span><br><span class=\"line\">  UNIQUE KEY `uk_configtagrelation_configidtag` (`id`,`tag_name`,`tag_type`),</span><br><span class=\"line\">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;config_tag_relation&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = group_capacity   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `group_capacity` (</span><br><span class=\"line\">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Group ID，空字符表示整个集群&#x27;,</span><br><span class=\"line\">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class=\"line\">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数，，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_group_id` (`group_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;集群、各Group容量信息表&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = his_config_info   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `his_config_info` (</span><br><span class=\"line\">  `id` bigint(20) unsigned NOT NULL,</span><br><span class=\"line\">  `nid` bigint(20) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class=\"line\">  `data_id` varchar(255) NOT NULL,</span><br><span class=\"line\">  `group_id` varchar(128) NOT NULL,</span><br><span class=\"line\">  `app_name` varchar(128) DEFAULT NULL COMMENT &#x27;app_name&#x27;,</span><br><span class=\"line\">  `content` longtext NOT NULL,</span><br><span class=\"line\">  `md5` varchar(32) DEFAULT NULL,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class=\"line\">  `src_user` text,</span><br><span class=\"line\">  `src_ip` varchar(50) DEFAULT NULL,</span><br><span class=\"line\">  `op_type` char(10) DEFAULT NULL,</span><br><span class=\"line\">  `tenant_id` varchar(128) DEFAULT &#x27;&#x27; COMMENT &#x27;租户字段&#x27;,</span><br><span class=\"line\">  `encrypted_data_key` text NOT NULL COMMENT &#x27;秘钥&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`nid`),</span><br><span class=\"line\">  KEY `idx_gmt_create` (`gmt_create`),</span><br><span class=\"line\">  KEY `idx_gmt_modified` (`gmt_modified`),</span><br><span class=\"line\">  KEY `idx_did` (`data_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;多租户改造&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">/*   数据库全名 = nacos_config   */</span><br><span class=\"line\">/*   表名称 = tenant_capacity   */</span><br><span class=\"line\">/******************************************/</span><br><span class=\"line\">CREATE TABLE `tenant_capacity` (</span><br><span class=\"line\">  `id` bigint(20) unsigned NOT NULL AUTO_INCREMENT COMMENT &#x27;主键ID&#x27;,</span><br><span class=\"line\">  `tenant_id` varchar(128) NOT NULL DEFAULT &#x27;&#x27; COMMENT &#x27;Tenant ID&#x27;,</span><br><span class=\"line\">  `quota` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;配额，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `usage` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;使用量&#x27;,</span><br><span class=\"line\">  `max_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `max_aggr_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;聚合子配置最大个数&#x27;,</span><br><span class=\"line\">  `max_aggr_size` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;单个聚合数据的子配置大小上限，单位为字节，0表示使用默认值&#x27;,</span><br><span class=\"line\">  `max_history_count` int(10) unsigned NOT NULL DEFAULT &#x27;0&#x27; COMMENT &#x27;最大变更历史数量&#x27;,</span><br><span class=\"line\">  `gmt_create` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_tenant_id` (`tenant_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;租户容量信息表&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `tenant_info` (</span><br><span class=\"line\">  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT &#x27;id&#x27;,</span><br><span class=\"line\">  `kp` varchar(128) NOT NULL COMMENT &#x27;kp&#x27;,</span><br><span class=\"line\">  `tenant_id` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_id&#x27;,</span><br><span class=\"line\">  `tenant_name` varchar(128) default &#x27;&#x27; COMMENT &#x27;tenant_name&#x27;,</span><br><span class=\"line\">  `tenant_desc` varchar(256) DEFAULT NULL COMMENT &#x27;tenant_desc&#x27;,</span><br><span class=\"line\">  `create_source` varchar(32) DEFAULT NULL COMMENT &#x27;create_source&#x27;,</span><br><span class=\"line\">  `gmt_create` bigint(20) NOT NULL COMMENT &#x27;创建时间&#x27;,</span><br><span class=\"line\">  `gmt_modified` bigint(20) NOT NULL COMMENT &#x27;修改时间&#x27;,</span><br><span class=\"line\">  PRIMARY KEY (`id`),</span><br><span class=\"line\">  UNIQUE KEY `uk_tenant_info_kptenantid` (`kp`,`tenant_id`),</span><br><span class=\"line\">  KEY `idx_tenant_id` (`tenant_id`)</span><br><span class=\"line\">) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_bin COMMENT=&#x27;tenant_info&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `users` (</span><br><span class=\"line\">\t`username` varchar(50) NOT NULL PRIMARY KEY,</span><br><span class=\"line\">\t`password` varchar(500) NOT NULL,</span><br><span class=\"line\">\t`enabled` boolean NOT NULL</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `roles` (</span><br><span class=\"line\">\t`username` varchar(50) NOT NULL,</span><br><span class=\"line\">\t`role` varchar(50) NOT NULL,</span><br><span class=\"line\">\tUNIQUE INDEX `idx_user_role` (`username` ASC, `role` ASC) USING BTREE</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">CREATE TABLE `permissions` (</span><br><span class=\"line\">    `role` varchar(50) NOT NULL,</span><br><span class=\"line\">    `resource` varchar(255) NOT NULL,</span><br><span class=\"line\">    `action` varchar(8) NOT NULL,</span><br><span class=\"line\">    UNIQUE INDEX `uk_role_permission` (`role`,`resource`,`action`) USING BTREE</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO users (username, password, enabled) VALUES (&#x27;nacos&#x27;, &#x27;$2a$10$EuWPZHzz32dJN7jexM34MOeYirDdFAZm2kuWj7VEOJhhZkDrxfvUu&#x27;, TRUE);</span><br><span class=\"line\"></span><br><span class=\"line\">INSERT INTO roles (username, role) VALUES (&#x27;nacos&#x27;, &#x27;ROLE_ADMIN&#x27;);</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">startup.cmd -m standalone</span><br><span class=\"line\">http://localhost:8848/nacos/#/configurationManagement?dataId=&amp;group=&amp;appName=&amp;namespace=&amp;pageSize=&amp;pageNo=</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">导入</span><br><span class=\"line\">ry_config_20220929.sql</span><br><span class=\"line\"></span><br><span class=\"line\">#  修改配置文件</span><br><span class=\"line\"></span><br><span class=\"line\">db.url.0=jdbc:mysql://127.0.0.1:3306/ry-config?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true&amp;useUnicode=true&amp;useSSL=false&amp;serverTimezone=UTC</span><br><span class=\"line\">db.user.0=root</span><br><span class=\"line\">db.password.0=root123</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 创建</span><br><span class=\"line\">ry_20230223.sql</span><br></pre></td></tr></table></figure>\n<p>启动 service</p>\n<h3 id=\"上云部署\"><a class=\"markdownIt-Anchor\" href=\"#上云部署\">#</a> 上云部署</h3>\n<h4 id=\"1移至mysql\"><a class=\"markdownIt-Anchor\" href=\"#1移至mysql\">#</a> 1. 移至 mysql</h4>\n<p>将本地 mysql 使用 mysql workbench migrate 到云上</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415151254966.png\" alt=\"image-20230415151254966\"></p>\n<p>移植成功</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415151322174.png\" alt=\"image-20230415151322174\"></p>\n<h4 id=\"2部署中间件-nacos\"><a class=\"markdownIt-Anchor\" href=\"#2部署中间件-nacos\">#</a> 2. 部署中间件 nacos</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230415152614222.png\" alt=\"image-20230415152614222\"></p>\n<p>kubesphere 中创建 nacos service</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nacos-v1-0.nacos.hos.svc.cluster.local:8848</span><br><span class=\"line\">nacos-v1-1.nacos.hos.svc.cluster.local:8848</span><br></pre></td></tr></table></figure>\n<h4 id=\"部署微服务\"><a class=\"markdownIt-Anchor\" href=\"#部署微服务\">#</a> 部署微服务</h4>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM openjdk:8-jdk</span><br><span class=\"line\">LABEL maintainer=leifengyang</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#docker run -e PARAMS=&quot;--server.port 9090&quot;</span></span><br><span class=\"line\">ENV PARAMS=<span class=\"string\">&quot;--server.port=8080 --spring.profiles.active=prod --spring.cloud.nacos.discovery.server-addr=his-nacos.his:8848 --spring.cloud.nacos.config.server-addr=nacos.hos:8848 --spring.cloud.nacos.config.namespace=prod --spring.cloud.nacos.config.file-extension=yml&quot;</span></span><br><span class=\"line\">RUN /bin/cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime &amp;&amp; <span class=\"built_in\">echo</span> <span class=\"string\">&#x27;Asia/Shanghai&#x27;</span> &gt;/etc/timezone</span><br><span class=\"line\"></span><br><span class=\"line\">COPY target/*.jar /app.jar</span><br><span class=\"line\">EXPOSE 8080</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#</span></span><br><span class=\"line\">ENTRYPOINT [<span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;java -Dfile.encoding=utf8 -Djava.security.egd=file:/dev/./urandom -jar app.jar <span class=\"variable\">$&#123;PARAMS&#125;</span>&quot;</span>] </span><br></pre></td></tr></table></figure>\n<p>打包:<br>\nmaveh 打成可执行 jar, 上传给服务器 (master)</p>\n<p>制作镜像:docker 根据 Dockerfile 把包打成指定的镜像</p>\n<p>推送镜像：将镜像推送给 docker hub（阿里云镜像仓库)</p>\n<p>应用部署：给 k8s 部署应用，node1 节点部署应用</p>\n<p>docker tag [ImageId] <span class=\"exturl\" data-url=\"aHR0cDovL3JlZ2lzdHJ5LmNuLWhhbmd6aG91LmFsaXl1bmNzLmNvbS9zaGlueWEvJUU5JTk1JTlDJUU1JTgzJThGJUU1JTkwJThEOnYx\">registry.cn-hangzhou.aliyuncs.com/shinya/ 镜像名:v1</span></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230416213506519.png\" alt=\"image-20230416213506519\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEwNi4xNC4yMi4xMjg6MzAxNTYvbG9naW4/cmVkaXJlY3Q9JTJGc3lzdGVtJTJGdXNlcg==\">若依管理系统</span></p>\n<h1 id=\"devops\"><a class=\"markdownIt-Anchor\" href=\"#devops\">#</a> DevOps</h1>\n<p>DevOps <strong>是一系列做法和工具</strong>，可以使 IT 和软件开发团队之间的<strong>流程实现自动化</strong>。其中，随着敏捷软件开发日趋流行，<strong>持续集成 (CI)</strong> 和<strong>持续交付 (CD)</strong> 已经成为该领域一个理想的解决方案。在 CI/CD 工作流中，每次集成都通过自动化构建来验证，包括编码、发布和测试，从而帮助开发者提前发现集成错误，团队也可以快速、安全、可靠地将内部软件交付到生产环境。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1wYXJlbnQ=\">https://gitee.com/leifengyang/yygh-parent</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1hZG1pbg==\">https://gitee.com/leifengyang/yygh-admin</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRlZS5jb20vbGVpZmVuZ3lhbmcveXlnaC1zaXRl\">https://gitee.com/leifengyang/yygh-site</span></p>\n<p>中间件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sentinel.hos:8080</span><br><span class=\"line\">http://106.14.22.128:30395/#/login</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mongodb.hos:27017</span><br><span class=\"line\">http://106.14.22.128:30417</span><br><span class=\"line\"></span><br><span class=\"line\">redis.hos</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">mysql.hos</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">rabbitm-j17f1z-rabbitmq.hos</span><br></pre></td></tr></table></figure>\n<p>mvn clean package -Dmaven.test.skip=true</p>\n<ul>\n<li>\n<p>使用 admin 登陆 ks</p>\n</li>\n<li>\n<p>进入集群管理</p>\n</li>\n<li>\n<p>进入配置中心</p>\n</li>\n<li>\n<p>找到配置</p>\n</li>\n<li>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovLzEzOS4xOTguMTY1LjIzODozMDg4MC9jbHVzdGVycy9kZWZhdWx0L3Byb2plY3RzL2t1YmVzcGhlcmUtZGV2b3BzLXN5c3RlbS9jb25maWdtYXBzL2tzLWRldm9wcy1hZ2VudA==\">ks-devops-agent</span></li>\n<li>修改这个配置。加入 maven 阿里云镜像加速地址</li>\n<li>使用 admin 登陆 ks</li>\n<li>进入集群管理</li>\n<li>进入配置中心</li>\n<li>找到配置</li>\n</ul>\n</li>\n<li>\n<ul>\n<li>\n<ul>\n<li><span class=\"exturl\" data-url=\"aHR0cDovLzEzOS4xOTguMTY1LjIzODozMDg4MC9jbHVzdGVycy9kZWZhdWx0L3Byb2plY3RzL2t1YmVzcGhlcmUtZGV2b3BzLXN5c3RlbS9jb25maWdtYXBzL2tzLWRldm9wcy1hZ2VudA==\">ks-devops-agent</span></li>\n<li>修改这个配置。加入 maven 阿里云镜像加速地址</li>\n</ul>\n</li>\n</ul>\n</li>\n</ul>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">pipeline &#123;</span><br><span class=\"line\">  agent &#123;</span><br><span class=\"line\">    node &#123;</span><br><span class=\"line\">      label <span class=\"string\">&#x27;maven&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  stages &#123;</span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;拉取代码&#x27;</span>) &#123;</span><br><span class=\"line\">      agent none</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">          git(url: <span class=\"string\">&#x27;https://gitee.com/kbshire/yygh-parent&#x27;</span>, credentialsId: <span class=\"string\">&#x27;giteeid&#x27;</span>, branch: <span class=\"string\">&#x27;master&#x27;</span>, changelog: <span class=\"literal\">true</span>, poll: <span class=\"literal\">false</span>)</span><br><span class=\"line\">          sh <span class=\"string\">&#x27;ls -al&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;项目编译&#x27;</span>) &#123;</span><br><span class=\"line\">      agent none</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">          sh <span class=\"string\">&#x27;ls -al&#x27;</span></span><br><span class=\"line\">          sh <span class=\"string\">&#x27;mvn clean package -Dmaven.test.skip=true&#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;default-2&#x27;</span>) &#123;</span><br><span class=\"line\">      parallel &#123;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建hospital镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t hospital-manage:latest -f hospital-manage/Dockerfile hospital-manage/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al hospital-manage/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建server-gateway&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al server-gateway/target&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t server-gateway:latest -f server-gateway/Dockerfile server-gateway/&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-cmn镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-cmn:latest -f service/service-cmn/Dockerfile ./service/service-cmn/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-cmn/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-hosp镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-hosp:latest -f service/service-hosp/Dockerfile ./service/service-hosp/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-hosp/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-order镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-order:latest -f service/service-order/Dockerfile ./service/service-order/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-order/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-oss镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-oss:latest -f service/service-oss/Dockerfile ./service/service-oss/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-oss/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-sms镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-sms:latest -f service/service-sms/Dockerfile ./service/service-sms/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-sms/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-statistics镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-statistics:latest -f service/service-statistics/Dockerfile ./service/service-statistics/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-statistics/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-task镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-task:latest -f service/service-task/Dockerfile ./service/service-task/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-task/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        stage(<span class=\"string\">&#x27;构建service-user镜像&#x27;</span>) &#123;</span><br><span class=\"line\">          agent none</span><br><span class=\"line\">          steps &#123;</span><br><span class=\"line\">            container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">              sh <span class=\"string\">&#x27;docker build -t service-user:latest -f service/service-user/Dockerfile ./service/service-user/&#x27;</span></span><br><span class=\"line\">              sh <span class=\"string\">&#x27;ls -al service/service-user/target&#x27;</span></span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;push latest&#x27;</span>) &#123;</span><br><span class=\"line\">      when &#123;</span><br><span class=\"line\">        branch <span class=\"string\">&#x27;master&#x27;</span></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">          sh <span class=\"string\">&#x27;docker tag  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:SNAPSHOT-$BRANCH_NAME-$BUILD_NUMBER $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span></span><br><span class=\"line\">          sh <span class=\"string\">&#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/$APP_NAME:latest &#x27;</span></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;deploy to dev&#x27;</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">          input(<span class=\"built_in\">id</span>: <span class=\"string\">&#x27;deploy-to-dev&#x27;</span>, message: <span class=\"string\">&#x27;deploy to dev?&#x27;</span>)</span><br><span class=\"line\">          withCredentials([kubeconfigContent(credentialsId : <span class=\"string\">&#x27;KUBECONFIG_CREDENTIAL_ID&#x27;</span> ,variable : <span class=\"string\">&#x27;KUBECONFIG_CONFIG&#x27;</span> ,)]) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&#x27;mkdir -p ~/.kube/&#x27;</span></span><br><span class=\"line\">            sh <span class=\"string\">&#x27;echo &quot;$KUBECONFIG_CONFIG&quot; &gt; ~/.kube/config&#x27;</span></span><br><span class=\"line\">            sh <span class=\"string\">&#x27;envsubst &lt; deploy/dev-ol/deploy.yaml | kubectl apply -f -&#x27;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    stage(<span class=\"string\">&#x27;deploy to production&#x27;</span>) &#123;</span><br><span class=\"line\">      steps &#123;</span><br><span class=\"line\">        container(<span class=\"string\">&#x27;maven&#x27;</span>) &#123;</span><br><span class=\"line\">          input(<span class=\"built_in\">id</span>: <span class=\"string\">&#x27;deploy-to-production&#x27;</span>, message: <span class=\"string\">&#x27;deploy to production?&#x27;</span>)</span><br><span class=\"line\">          withCredentials([kubeconfigContent(credentialsId : <span class=\"string\">&#x27;KUBECONFIG_CREDENTIAL_ID&#x27;</span> ,variable : <span class=\"string\">&#x27;KUBECONFIG_CONFIG&#x27;</span> ,)]) &#123;</span><br><span class=\"line\">            sh <span class=\"string\">&#x27;mkdir -p ~/.kube/&#x27;</span></span><br><span class=\"line\">            sh <span class=\"string\">&#x27;echo &quot;$KUBECONFIG_CONFIG&quot; &gt; ~/.kube/config&#x27;</span></span><br><span class=\"line\">            sh <span class=\"string\">&#x27;envsubst &lt; deploy/prod-ol/deploy.yaml | kubectl apply -f -&#x27;</span></span><br><span class=\"line\">          &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  environment &#123;</span><br><span class=\"line\">  //定义的所有变量可以在任意位置使用</span><br><span class=\"line\">    DOCKER_CREDENTIAL_ID = <span class=\"string\">&#x27;dockerhub-id&#x27;</span></span><br><span class=\"line\">    GITHUB_CREDENTIAL_ID = <span class=\"string\">&#x27;github-id&#x27;</span></span><br><span class=\"line\">    KUBECONFIG_CREDENTIAL_ID = <span class=\"string\">&#x27;demo-kubeconfig&#x27;</span></span><br><span class=\"line\">    REGISTRY = <span class=\"string\">&#x27;docker.io&#x27;</span></span><br><span class=\"line\">    DOCKERHUB_NAMESPACE = <span class=\"string\">&#x27;docker_username&#x27;</span></span><br><span class=\"line\">    GITHUB_ACCOUNT = <span class=\"string\">&#x27;kubesphere&#x27;</span></span><br><span class=\"line\">    APP_NAME = <span class=\"string\">&#x27;devops-java-sample&#x27;</span></span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">  parameters &#123;</span><br><span class=\"line\">    string(name: <span class=\"string\">&#x27;TAG_NAME&#x27;</span>, defaultValue: <span class=\"string\">&#x27;&#x27;</span>, description: <span class=\"string\">&#x27;&#x27;</span>)</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">registry.cn-hangzhou.aliyuncs.com/shinya_hello/ruoyi-visual-monitor:</span><br><span class=\"line\"></span><br><span class=\"line\">sh &#x27;docker tag hospital-manage:latest $registry/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br><span class=\"line\">sh &#x27;docker push  $REGISTRY/$DOCKERHUB_NAMESPACE/hospital-manage:SNAPSHOT-$BUILD_NUMBER&#x27;</span><br></pre></td></tr></table></figure>\n<p>加载阿里云镜像密钥</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418174358540.png\" alt=\"image-20230418174358540\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEwNi4xNC4yMi4xMjg6MzA4ODAvZGV2b3BzX3dlYmhvb2svZ2l0Lz91cmw9aHR0cHM6Ly9naXRlZS5jb20va2JzaGlyZS95eWdoLXNpdGU=\">http://106.14.22.128:30880/devops_webhook/git/?url=https://gitee.com/kbshire/yygh-site</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEwNi4xNC4yMi4xMjg6MzA4ODAvZGV2b3BzX3dlYmhvb2svZ2l0Lz91cmw9aHR0cHM6Ly9naXRlZS5jb20va2JzaGlyZS95eWdoLWFkbWlu\">http://106.14.22.128:30880/devops_webhook/git/?url=https://gitee.com/kbshire/yygh-admin</span></p>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/04/15/Nginx_new/",
            "url": "http://example.com/2023/04/15/Nginx_new/",
            "title": "Nginx",
            "date_published": "2023-04-15T05:38:45.000Z",
            "content_html": "<h1 id=\"nginx\"><a class=\"markdownIt-Anchor\" href=\"#nginx\">#</a> Nginx</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMWJaV1dvSm90cDFfZ2gzNkZtSjhINkE/X2F0Xz0xNjgxMzg1MTc2MTU1I2xpc3QvcGF0aD0lMkYmYW1wO3BhcmVudFBhdGg9JTJG\">Java-nginx 分布式框架_免费高速下载 | 百度网盘 - 分享无限制 (baidu.com)</span></p>\n<h2 id=\"nginx目录结构\"><a class=\"markdownIt-Anchor\" href=\"#nginx目录结构\">#</a> nginx 目录结构</h2>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/local/nginx/</span><br><span class=\"line\">├── <span class=\"attribute\">client_body_temp</span></span><br><span class=\"line\">├── conf \t\t\t\t\t<span class=\"comment\"># 配置文件目录</span></span><br><span class=\"line\">│   ├── fastcgi.conf\t\t<span class=\"comment\"># fastcgi 配置文件</span></span><br><span class=\"line\">│   ├── fastcgi.conf.default</span><br><span class=\"line\">│   ├── fastcgi_params</span><br><span class=\"line\">│   ├── fastcgi_params.default</span><br><span class=\"line\">│   ├── koi-utf</span><br><span class=\"line\">│   ├── koi-win</span><br><span class=\"line\">│   ├── mime.types</span><br><span class=\"line\">│   ├── mime.types.default</span><br><span class=\"line\">│   ├── nginx.conf</span><br><span class=\"line\">│   ├── nginx.conf.default</span><br><span class=\"line\">│   ├── scgi_params</span><br><span class=\"line\">│   ├── scgi_params.default</span><br><span class=\"line\">│   ├── uwsgi_params</span><br><span class=\"line\">│   ├── uwsgi_params.default</span><br><span class=\"line\">│   └── win-utf</span><br><span class=\"line\">├── fastcgi_temp</span><br><span class=\"line\">├── html</span><br><span class=\"line\">│   ├── 50x.html</span><br><span class=\"line\">│   └── index.html</span><br><span class=\"line\">├── logs</span><br><span class=\"line\">│   ├── access.log</span><br><span class=\"line\">│   ├── <span class=\"literal\">error</span>.log</span><br><span class=\"line\">│   └── nginx.pid\t<span class=\"comment\"># nginx的process id</span></span><br><span class=\"line\">├── proxy_temp</span><br><span class=\"line\">│   ├── <span class=\"number\">1</span></span><br><span class=\"line\">│   │   └── <span class=\"number\">00</span></span><br><span class=\"line\">│   ├── <span class=\"number\">2</span></span><br><span class=\"line\">│   │   └── <span class=\"number\">00</span></span><br><span class=\"line\">│   ├── <span class=\"number\">3</span></span><br><span class=\"line\">│   │   └── <span class=\"number\">00</span></span><br><span class=\"line\">│   ├── <span class=\"number\">4</span></span><br><span class=\"line\">│   │   └── <span class=\"number\">00</span></span><br><span class=\"line\">│   ├── <span class=\"number\">5</span></span><br><span class=\"line\">│   │   └── <span class=\"number\">00</span></span><br><span class=\"line\">│   └── <span class=\"number\">6</span></span><br><span class=\"line\">│       └── <span class=\"number\">00</span></span><br><span class=\"line\">├── sbin</span><br><span class=\"line\">│   └── nginx</span><br><span class=\"line\">├── scgi_temp</span><br><span class=\"line\">├── ssl</span><br><span class=\"line\">│   ├── 9584217_www.radsm.co.key</span><br><span class=\"line\">│   ├── 9584217_www.radsm.co_nginx.zip</span><br><span class=\"line\">│   ├── 9584217_www.radsm.co.pem</span><br><span class=\"line\">│   ├── nginx.crt</span><br><span class=\"line\">│   └── nginx.key</span><br><span class=\"line\">└── uwsgi_temp</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>CGl (Common Gateway Interface) 通用网关【接口】，主要解决的问题是从客户端发送一个请求和数据，服务端获取到请求和数据后可以调用调用 CGI【程序】处理及相应结果给客户端的一种标准规范。</p>\n<p>fastcgi，scgi，uwsgi 是 cgi 的升级版</p>\n<p>koi-utf、koi-win、win-utf 这三个文件都是与编码转换映射相关的配置文件，用来将一种编码转换成另一种编码</p>\n<p><strong>mime.types: 记录的是 HTTP 协议中的 Content-Type 的值和文件后缀名的对应关系</strong></p>\n<p>mime.types.default:mime.types 的备份文件</p>\n<p><strong>nginx.conf: 这个是 Nginx 的核心配置文件，这个文件非常重要，也是我们即将要学习的重点</strong></p>\n<p>nginx.conf.default:nginx.conf 的备份文件</p>\n<p><strong>logs: 记录入门的文件，当 nginx 服务器启动后，这里面会有 access.log error.log 和 nginx.pid 三个文件出现。</strong></p>\n<p><strong>sbin: 是存放执行程序文件 nginx</strong></p>\n<p><strong>nginx 是用来控制 Nginx 的启动和停止等相关的命令。</strong></p>\n</blockquote>\n<h2 id=\"nginx启停\"><a class=\"markdownIt-Anchor\" href=\"#nginx启停\">#</a> nginx 启停</h2>\n<p><code>ps -ef | grep nginx</code>  查看 nginx 的 master 和 work process】</p>\n<p>Nginx 后台进程中包含一个 master 进程和多个 worker 进程，master 进程主要用来管理 worker 进程，包含接收外界的信息，并将接收到的信号发送给各个 worker 进程，监控 worker 进程的状态，当 worker 进程出现异常退出后，会自动重新启动新的 worker 进程。而 worker 进程则是专门用来处理用户请求的，各个 worker 进程之间是平等的并且相互独立，处理请求的机会也是一样的。nginx 的进程模型，我们可以通过下图来说明下：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># ps -ef | grep nginx </span></span><br><span class=\"line\">root     19255 19235  0 10:01 pts/0    00:00:00 grep --color=auto nginx</span><br><span class=\"line\">root     32091     1  0 Apr14 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class=\"line\">nobody   32092 32091  0 Apr14 ?        00:00:00 nginx: worker process</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># cat /usr/local/nginx/logs/nginx.pid </span></span><br><span class=\"line\">32091</span><br></pre></td></tr></table></figure>\n<p>nginx 是多进程工作模式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405205817349.png\" alt=\"image-20230405205817349\"></p>\n<table>\n<thead>\n<tr>\n<th>信号</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>TERM/INT</td>\n<td>立即关闭整个服务</td>\n</tr>\n<tr>\n<td>QUIT</td>\n<td>&quot;优雅&quot; 地关闭整个服务</td>\n</tr>\n<tr>\n<td>HUP</td>\n<td>重读配置文件并使用服务对新配置项生效</td>\n</tr>\n<tr>\n<td>USR1</td>\n<td>重新打开日志文件，可以用来进行日志切割</td>\n</tr>\n<tr>\n<td>USR2</td>\n<td>平滑升级到最新版的 nginx 会使用</td>\n</tr>\n<tr>\n<td>WINCH</td>\n<td>所有子进程不在接收处理新连接，相当于给 work 进程发送 QUIT 指令</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">kill</span> -TERM PID</span><br><span class=\"line\"><span class=\"built_in\">kill</span> -QUIT PID</span><br><span class=\"line\"><span class=\"built_in\">kill</span> -HUP PID    <span class=\"comment\"># master pid不会变，会重启worker，pid也会改变</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -WINCH PID  <span class=\"comment\"># 会关闭worker，不关闭master</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -USR1 PID   <span class=\"comment\"># 重新生成并打开日志</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -USR2 PID   <span class=\"comment\"># 生成新的master和worker，原来的pid文件变为nginx.pid.oldbin ，在QUIT关闭旧PID</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 sbin]# ./nginx -?</span><br><span class=\"line\">nginx version: nginx/1.23.4</span><br><span class=\"line\">Usage: nginx [-?hvVtTq] [-s signal] [-p prefix]</span><br><span class=\"line\">             [-e filename] [-c filename] [-g directives]</span><br><span class=\"line\"></span><br><span class=\"line\">Options:</span><br><span class=\"line\">  -?,-h         : this help</span><br><span class=\"line\">  -v            : show version and exit</span><br><span class=\"line\">  -V            : show version and configure options then exit</span><br><span class=\"line\">  -t            : test configuration and exit</span><br><span class=\"line\">  -T            : test configuration, dump it and exit,会输出nginxconf, mime 等其他信息</span><br><span class=\"line\">  -q            : suppress non-error messages during configuration testing    -tq只输出错误信息</span><br><span class=\"line\">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class=\"line\">  -p prefix     : set prefix path (default: /usr/local/nginx/)</span><br><span class=\"line\">  -e filename   : set error log file (default: logs/error.log)</span><br><span class=\"line\">  -c filename   : set configuration file (default: conf/nginx.conf)</span><br><span class=\"line\">  -g directives : set global directives out of configuration file</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-s singal </span><br><span class=\"line\">stop[快速关闭，类似于TERM/INT信号的作用]</span><br><span class=\"line\">quit[优雅的关闭，类似于QUIT信号的作用] </span><br><span class=\"line\">reopen[重新打开日志文件类似于USR1信号的作用] </span><br><span class=\"line\">reload[类似于HUP信号的作用]</span><br><span class=\"line\"></span><br><span class=\"line\">./nginx -g &quot;pid logs/abc.pid&quot;  # 指定启动时的全局变量</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx平滑升级\"><a class=\"markdownIt-Anchor\" href=\"#nginx平滑升级\">#</a> nginx 平滑升级</h2>\n<p>升级 1：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 安装新版本</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx</span><br><span class=\"line\">make</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 备份旧的nginx</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class=\"line\"><span class=\"comment\"># 复制新的nginx</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> objs/nginx /usr/local/nginx/sbin/</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 发送信号</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -USR2 `<span class=\"built_in\">cat</span> /usr/local/nginx/logs/nginx.pid`</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 关闭旧的进程</span></span><br><span class=\"line\"><span class=\"built_in\">kill</span> -QUIT `<span class=\"built_in\">cat</span> /usr/local/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>\n<p>升级 2：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 备份旧的nginx</span></span><br><span class=\"line\"><span class=\"built_in\">cp</span> /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装新版本</span></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx</span><br><span class=\"line\"><span class=\"built_in\">cp</span> objs/nginx /usr/local/nginx/sbin/</span><br><span class=\"line\">make upgrade</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">加减模块可升级基本一样，只是不发送最后的信号</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginxconf\"><a class=\"markdownIt-Anchor\" href=\"#nginxconf\">#</a> nginx.conf</h2>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># vim /usr/local/nginx/conf/nginx.conf</span></span><br><span class=\"line\"><span class=\"attribute\">worker_processes</span>  <span class=\"number\">1</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全局块</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># events块 配置网络连接相关内容</span></span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span>  <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 全局块</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># http块</span></span><br><span class=\"line\">    <span class=\"attribute\">include</span>       mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span>        <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\"># server块，配置虚拟主机等功能，一个http可以由多个server块</span></span><br><span class=\"line\">        <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">        <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">            <span class=\"comment\"># location块，匹配到路径，取出资源，展示给用户</span></span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">            <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">        <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>nginx.conf 配置文件中默认有三大块：全局块、events 块、http 块</p>\n<p>http 块中可以配置多个 server 块，每个 server 块又可以配置多个 location 块。</p>\n<h3 id=\"全局块\"><a class=\"markdownIt-Anchor\" href=\"#全局块\">#</a> 全局块</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">| 语法   | <span class=\"attribute\">user</span> user [group] |</span><br><span class=\"line\">| ------ | ----------------- |</span><br><span class=\"line\">| 默认值 | nobody            |</span><br><span class=\"line\">| 位置   | 全局块            |</span><br><span class=\"line\"></span><br><span class=\"line\">user www;</span><br><span class=\"line\"><span class=\"comment\"># 默认为nobody</span></span><br><span class=\"line\"><span class=\"comment\"># 如果user 的值是普通用户，那么root /root/html 会产生403的错误</span></span><br></pre></td></tr></table></figure>\n<p>综上所述，使用 user 指令可以指定启动运行工作进程的用户及用户组，这样对于系统的权限访问控制的更加精细，也更加安全。</p>\n<p>master_process: 用来指定是否开启工作进程。</p>\n<table>\n<thead>\n<tr>\n<th>语法</th>\n<th>master_process on|off;</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认值</td>\n<td>master_process on;</td>\n</tr>\n<tr>\n<td>位置</td>\n<td>全局块</td>\n</tr>\n</tbody>\n</table>\n<p>用于配置 Nginx 生成工作进程的数量，这个是 Nginx 服务器实现并发处理服务的关键所在。理论上来说 workder process 的值越大，可以支持的并发处理量也越多，但事实上这个值的设定是需要受到来自服务器自身的限制，建议将该值和服务器 CPU 的内核数保存一致。</p>\n<table>\n<thead>\n<tr>\n<th>语法</th>\n<th style=\"text-align:left\">worker_processes     num/auto;</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认值</td>\n<td style=\"text-align:left\">1</td>\n</tr>\n<tr>\n<td>位置</td>\n<td style=\"text-align:left\">全局块</td>\n</tr>\n</tbody>\n</table>\n<p>设定 Nginx 是否以守护进程的方式启动。</p>\n<table>\n<thead>\n<tr>\n<th>语法</th>\n<th>daemon on|off;</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认值</td>\n<td>daemon on;</td>\n</tr>\n<tr>\n<td>位置</td>\n<td>全局块</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">master_process</span> <span class=\"literal\">on</span>|<span class=\"literal\">off</span>; <span class=\"comment\"># 是否开启工作进程，default on</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">worker_process</span> num|auto; <span class=\"comment\"># 建议设置的和服务器cpu内核个数保持一致，生成工作进程的数量</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">daemon</span> <span class=\"literal\">on</span>|<span class=\"literal\">off</span>  <span class=\"comment\"># 是否以守护进程启动，default on</span></span><br><span class=\"line\"></span><br><span class=\"line\">pid /usr/local/nginx/logs <span class=\"comment\"># nginx.pid位置</span></span><br><span class=\"line\"></span><br><span class=\"line\">error_log /usr/local/nginx/logs/ <span class=\"literal\">error</span> <span class=\"comment\"># error_logs  可以配置在全局，http，server，location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 其中日志级别的值有：debug|info|notice|warn|error|crit|alert|emerg，这块建议大家设置的时候不要设置成info以下的等级，因为会带来大量的磁盘I/O消耗，影响Nginx的性能。</span></span><br><span class=\"line\"></span><br><span class=\"line\">include /usr/local/nginx/conf/aaa.conf  <span class=\"comment\"># 引入其他配置，可以在任何位置配置</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"events块\"><a class=\"markdownIt-Anchor\" href=\"#events块\">#</a> events 块</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">默认值<span class=\"attribute\">accept_mutex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">accept_mutex</span> <span class=\"literal\">on</span>;   <span class=\"comment\"># 解决惊群，用来设置nginx网络链接序列化，一个个唤醒worker  将会对多个Nginx进程接收连接进行序列号，一个个来唤醒接收，就防止了多个进程对连接的争抢。</span></span><br><span class=\"line\"></span><br><span class=\"line\">默认值<span class=\"attribute\">multi_accept</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\"><span class=\"attribute\">multi_accept</span> <span class=\"literal\">on</span>;  <span class=\"comment\"># 是否允许同时接受多个网络链接</span></span><br><span class=\"line\">如果multi_accept被禁止了，nginx一个工作进程只能同时接受一个新的连接。否则，一个工作进程可以同时接受所有的新连接</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">worker_connections</span> <span class=\"number\">512</span>;  <span class=\"comment\"># 单个worker进程最大连接数，number值不能大于操作系统支持打开的最大文件句柄数量。</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">use</span> <span class=\"literal\">epoll</span>|<span class=\"literal\">select</span>|<span class=\"literal\">poll</span>|<span class=\"literal\">kqueue</span>; \t\t<span class=\"comment\"># 来设置Nginx服务器选择哪种事件驱动来处理网络消息。建议epoll</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">accept_mutex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">multi_accept</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">use</span> <span class=\"literal\">epoll</span>;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span> <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"http-块\"><a class=\"markdownIt-Anchor\" href=\"#http-块\">#</a> http 块</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># mime-type Nginx作为web服务器，也需要能够识别前端请求的资源类型。</span></span><br><span class=\"line\">Nginx的配置文件中，默认有两行配置</span><br><span class=\"line\"><span class=\"attribute\">include</span> mime.types;</span><br><span class=\"line\"><span class=\"attribute\">default_type</span> application/octet-stream;   <span class=\"comment\"># http,server,location 可以配置，默认二进制流，浏览器会下载文件</span></span><br><span class=\"line\"></span><br><span class=\"line\">| 语法   | <span class=\"attribute\">default_type</span> mime-type;   |</span><br><span class=\"line\">| ------ | ------------------------- |</span><br><span class=\"line\">| 默认值 | <span class=\"attribute\">default_type</span> text/plain； |</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">location /get_text &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/html;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&quot;&lt;h1&gt;shabi&lt;/h1&gt;&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">sendfile</span> <span class=\"literal\">on</span>;  <span class=\"comment\"># 配置位置 http,server,location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">75</span>  <span class=\"comment\"># 长连接超时协议</span></span><br><span class=\"line\"></span><br><span class=\"line\">keepalive_requests <span class=\"number\">100</span> <span class=\"comment\"># 长连接处理请求个数</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"定义日志\"><a class=\"markdownIt-Anchor\" href=\"#定义日志\">#</a> 定义日志</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Nginx中日志的类型分access.log、error.log</span><br><span class=\"line\"></span><br><span class=\"line\">access.log:用来记录用户所有的访问请求。</span><br><span class=\"line\"></span><br><span class=\"line\">error.log:记录nginx本身运行时的错误信息，不会记录用户的访问请求。</span><br><span class=\"line\"></span><br><span class=\"line\">Nginx服务器支持对服务日志的格式、大小、输出等进行设置，需要使用到两个指令，分别是access_log和log_format指令。</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>语法</th>\n<th>access_log path[format[buffer=size]]</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认值</td>\n<td>access_log logs/access.log combined;</td>\n</tr>\n<tr>\n<td>位置</td>\n<td><code>http</code> ,  <code>server</code> ,  <code>location</code></td>\n</tr>\n</tbody>\n<tbody>\n<tr>\n<td>语法</td>\n<td>log_format name [escape=default|json|none] string…;</td>\n</tr>\n<tr>\n<td>------</td>\n<td>--------------------------------------------------------</td>\n</tr>\n<tr>\n<td>默认值</td>\n<td>log_format combined “…”;</td>\n</tr>\n<tr>\n<td>位置</td>\n<td>http</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">access_log</span> /usr/local/nginx/logs hahaha;   <span class=\"comment\"># http，server，location块配置</span></span><br><span class=\"line\"><span class=\"attribute\">log_format</span> hahaha <span class=\"string\">&#x27;fomat: <span class=\"variable\">$http_user_agent</span>&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sendfile:用来设置Nginx服务器是否使用sendfile()传输文件，该属性可以大大提高Nginx处理静态资源的性能</span><br><span class=\"line\">默认值<span class=\"attribute\">sendfile</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">位置http、server、<span class=\"section\">location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用keepalive模式，可以告诉服务器端在处理完一个请求后保持这个TCP连接的打开状态，若接收到来自这个客户端的其他请求，服务端就会利用这个未被关闭的连接，而不需要重新创建一个新连接，提升效率，但是这个连接也不能一直保持，这样的话，连接如果过多，也会是服务端的性能下降，这个时候就需要我们进行设置其的超时时间。</span></span><br><span class=\"line\">keepalive_timeout:用来设置长连接的超时时间。</span><br><span class=\"line\">默认值keepalive_timeout <span class=\"number\">75s</span>;</span><br><span class=\"line\">位置http、server、<span class=\"section\">location</span></span><br><span class=\"line\"></span><br><span class=\"line\">keepalive_requests:用来设置一个keep-alive连接使用的次数。</span><br><span class=\"line\">默认值keepalive_requests <span class=\"number\">100</span>;</span><br><span class=\"line\">位置http、server、<span class=\"section\">location</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"server-location\"><a class=\"markdownIt-Anchor\" href=\"#server-location\">#</a> server、location</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">      </span><br><span class=\"line\">       <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span> <span class=\"number\">404</span>  /50x.html;</span><br><span class=\"line\">       <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>http.server,location 中都有的，location 优先生效</p>\n<h3 id=\"exercise\"><a class=\"markdownIt-Anchor\" href=\"#exercise\">#</a> exercise</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）有如下访问：</span><br><span class=\"line\">\thttp://192.168.200.133:8081/server1/location1</span><br><span class=\"line\">\t\t访问的是：index_sr1_location1.html</span><br><span class=\"line\">\thttp://192.168.200.133:8081/server1/location2</span><br><span class=\"line\">\t\t访问的是：index_sr1_location2.html</span><br><span class=\"line\">\thttp://192.168.200.133:8082/server2/location1</span><br><span class=\"line\">\t\t访问的是：index_sr2_location1.html</span><br><span class=\"line\">\thttp://192.168.200.133:8082/server2/location2</span><br><span class=\"line\">\t\t访问的是：index_sr2_location2.html</span><br><span class=\"line\">（2）如果访问的资源不存在，</span><br><span class=\"line\">\t返回自定义的404页面</span><br><span class=\"line\">（3）将/server1和/server2的配置使用不同的配置文件分割</span><br><span class=\"line\">\t将文件放到/home/www/conf.d目录下，然后使用include进行合并</span><br><span class=\"line\">（4）为/server1和/server2各自创建一个访问日志文件</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># /home/www/conf.d/haha1.conf</span></span><br><span class=\"line\">\t<span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span>       <span class=\"number\">8081</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">\t    <span class=\"attribute\">access_log</span> /usr/local/nginx/logs main1;</span><br><span class=\"line\">        <span class=\"section\">location</span> server1/location1 &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   /home/www/myweb;</span><br><span class=\"line\">            <span class=\"attribute\">index</span>  index_sr1_location1.html index_sr1_location1.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"section\">location</span> server1/location2 &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   /home/www/myweb;</span><br><span class=\"line\">            <span class=\"attribute\">index</span>  index_sr1_location2.html index_sr1_location2.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">       </span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span> <span class=\"number\">404</span>  /50x.html;</span><br><span class=\"line\">        <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   /home/www/myweb;</span><br><span class=\"line\">        \t<span class=\"attribute\">index</span> <span class=\"number\">404</span>.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># /home/www/conf.d/haha2.conf    </span></span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span>       <span class=\"number\">8082</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">        <span class=\"attribute\">access_log</span> /usr/local/nginx/logs main2;</span><br><span class=\"line\">        <span class=\"section\">location</span> server2/location2 &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">            <span class=\"attribute\">index</span>  index_sr2_location2.html index_sr2_location2.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span> <span class=\"number\">404</span>  /50x.html;</span><br><span class=\"line\">        <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   /home/www/myweb;</span><br><span class=\"line\">        \t<span class=\"attribute\">index</span> <span class=\"number\">404</span>.html;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">worker_processes</span>  <span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"attribute\">user</span> www;</span><br><span class=\"line\"><span class=\"attribute\">error_log</span> logs/<span class=\"literal\">error</span>.log;</span><br><span class=\"line\"><span class=\"attribute\">pid</span> logs/nginx.pid;</span><br><span class=\"line\"><span class=\"attribute\">daemon</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">events</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">accept_mutex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">multi_accept</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">use</span> <span class=\"literal\">epoll</span>;</span><br><span class=\"line\">    <span class=\"attribute\">worker_connections</span> <span class=\"number\">1024</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">include</span>       mime.types;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span>  application/octet-stream;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">sendfile</span>        <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\">    <span class=\"attribute\">keepalive_requests</span> <span class=\"number\">100</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">\t<span class=\"attribute\">log_format</span>  main1  \t<span class=\"string\">&#x27;<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] &quot;<span class=\"variable\">$request</span>&quot; &#x27;</span></span><br><span class=\"line\">                       \t<span class=\"string\">&#x27;<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> &quot;<span class=\"variable\">$http_referer</span>&quot; &#x27;</span></span><br><span class=\"line\">                       \t<span class=\"string\">&#x27;&quot;<span class=\"variable\">$http_user_agent</span>&quot; &quot;<span class=\"variable\">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"attribute\">log_format</span>  main2  \t<span class=\"string\">&#x27;<span class=\"variable\">$remote_addr</span> - <span class=\"variable\">$remote_user</span> [<span class=\"variable\">$time_local</span>] &quot;<span class=\"variable\">$request</span>&quot; &#x27;</span></span><br><span class=\"line\">                   \t\t<span class=\"string\">&#x27;<span class=\"variable\">$status</span> <span class=\"variable\">$body_bytes_sent</span> &quot;<span class=\"variable\">$http_referer</span>&quot; &#x27;</span></span><br><span class=\"line\">                   \t\t<span class=\"string\">&#x27;&quot;<span class=\"variable\">$http_user_agent</span>&quot; &quot;<span class=\"variable\">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">resolver</span> <span class=\"number\">8.8.8.8</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"attribute\">include</span> /home/www/conf.d/<span class=\"regexp\">*.conf</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"配置nginx为系统服务\"><a class=\"markdownIt-Anchor\" href=\"#配置nginx为系统服务\">#</a> 配置 nginx 为系统服务</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[Unit]</span><br><span class=\"line\">Description=nginx web service</span><br><span class=\"line\">Documentation=http://nginx.org/en/docs/</span><br><span class=\"line\">After=network.target</span><br><span class=\"line\"></span><br><span class=\"line\">[Service]</span><br><span class=\"line\">Type=forking</span><br><span class=\"line\">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class=\"line\">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class=\"line\">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class=\"line\">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class=\"line\">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class=\"line\">PrivateTmp=true</span><br><span class=\"line\"></span><br><span class=\"line\">[Install]</span><br><span class=\"line\">WantedBy=default.target</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 755 /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">启动: systemctl start nginx</span><br><span class=\"line\">停止: systemctl stop nginx</span><br><span class=\"line\">重启: systemctl restart nginx</span><br><span class=\"line\">重新加载配置文件: systemctl reload nginx   # 不改变master pid，重启worker</span><br><span class=\"line\">查看nginx状态: systemctl status nginx</span><br><span class=\"line\">开机启动: systemctl enable nginx</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx配置环境变量\"><a class=\"markdownIt-Anchor\" href=\"#nginx配置环境变量\">#</a> nginx 配置环境变量</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">在最后一行添加</span><br><span class=\"line\">export PATH=$PATH:/usr/local/nginx/sbin</span><br><span class=\"line\"></span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx虚拟主机\"><a class=\"markdownIt-Anchor\" href=\"#nginx虚拟主机\">#</a> nginx 虚拟主机</h2>\n<ul>\n<li>虚拟 Web 主机指的是在同一台物理服务器中发布多个 Web 站点或应用</li>\n<li>独立的网站，独立的项目甚至独立的功能模块都可以使用虚拟主机进行发布</li>\n<li>Nginx 可以基于不同的 IP、不同的端口以及不同的域名实现不同的虚拟主机</li>\n<li>虚拟主机内的资源收到虚拟主机配置文件内容约束，与其他虚拟主机相对独立</li>\n</ul>\n<p>配置虚拟主机可以基于端口号也可以基于子域名</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;  <span class=\"comment\"># 域名或主机名</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#error_page  404              /404.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">       <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">88</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  a.com;  <span class=\"comment\"># 域名或主机名</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   /www/wwwroot;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#error_page  404              /404.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">       <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-静态资源部署\"><a class=\"markdownIt-Anchor\" href=\"#nginx-静态资源部署\">#</a> nginx 静态资源部署</h2>\n<p>我们所请 求的内容就分为两种类型，一类是静态资源、一类是动态资源。</p>\n<p>静态资源即指在服务器端真实存在并且能直接拿来展示的一些文件，比如常见的 html 页面、css 文件、js 文件、图 片、视频等资源；</p>\n<p>动态资源即指在服务器端真实存在但是要想获取需要经过一定的业务逻辑处理，根据不同的条件展示在页面不同这 一部分内容，比如说报表数据展示、根据当前登录用户展示相关具体数据等资源；</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）静态资源的配置指令</span><br><span class=\"line\">（2）静态资源的配置优化</span><br><span class=\"line\">（3）静态资源的压缩配置指令</span><br><span class=\"line\">（4）静态资源的缓存处理</span><br><span class=\"line\">（5）静态资源的访问控制，包括跨域问题和防盗链问题</span><br></pre></td></tr></table></figure>\n<h3 id=\"1静态资源的配置指令\"><a class=\"markdownIt-Anchor\" href=\"#1静态资源的配置指令\">#</a> （1）静态资源的配置指令</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">默认值<span class=\"attribute\">listen</span> *:<span class=\"number\">80</span> | *:<span class=\"number\">8000</span></span><br><span class=\"line\">位置server</span><br><span class=\"line\">listen *:<span class=\"number\">80</span>;</span><br><span class=\"line\"><span class=\"attribute\">listen</span> <span class=\"number\">8080</span>;    <span class=\"comment\"># server 下配置  监听指定端口上的连接</span></span><br><span class=\"line\"><span class=\"attribute\">listen</span> <span class=\"number\">127.0.0.1:8000</span>;</span><br><span class=\"line\"><span class=\"attribute\">listen</span> <span class=\"number\">127.0.0.1</span>; <span class=\"comment\"># 监听指定IP的所有端口</span></span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># default_server属性是标识符，用来将此虚拟主机设置成默认主机。所谓的默认主机指的是如果没有匹配到对应的address:port，则会默认执行的。如果不指定默认使用的是第一个server。</span></span><br><span class=\"line\">如果没有匹配成功，使用第一个server响应请求</span><br><span class=\"line\">比如<span class=\"attribute\">server_name</span> 写的<span class=\"number\">127.0.0.1</span>，但是访问<span class=\"number\">192.168.1.12</span>，会匹配第一个server</span><br><span class=\"line\"></span><br><span class=\"line\">如果配置了default_server ,会使用default_server 所在的server响应</span><br><span class=\"line\">listen <span class=\"number\">8080</span> default_server;</span><br><span class=\"line\"></span><br><span class=\"line\">-------------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">server_name</span> </span><br><span class=\"line\">默认值server_name  <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">位置<span class=\"attribute\">server</span></span><br><span class=\"line\"></span><br><span class=\"line\">配置方式<span class=\"number\">1</span>:精确配置</span><br><span class=\"line\">server_name www.baidu.com baidu.com;</span><br><span class=\"line\">如果你没有域名，你就要改hosts啦</span><br><span class=\"line\">匹配方式2:通配符匹配</span><br><span class=\"line\"><span class=\"attribute\">server_name</span> <span class=\"regexp\">*.baidu.com</span>;</span><br><span class=\"line\">*不能放在域名中间 ，比如 <span class=\"attribute\">server_name</span> <span class=\"regexp\">www.*</span>.com;</span><br><span class=\"line\">*不能在最后，比如 www.baidu.c*</span><br><span class=\"line\">匹配方式三：正则匹配</span><br><span class=\"line\"><span class=\"attribute\">server_name</span> ~^www\\.(\\w+)\\.com$;</span><br><span class=\"line\"><span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;====<span class=\"variable\">$1</span>&#x27;</span>;</span><br><span class=\"line\">    <span class=\"comment\"># ~后不能有空格</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 三种匹配方式都存在，且都能匹配，那么精确匹配 &gt; 前置通配符 &gt; 后置通配符 &gt; 正则匹配 &gt; default_server </span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># location 用来设置请求的URI</span></span><br><span class=\"line\">位置server,<span class=\"section\">location</span></span><br><span class=\"line\"><span class=\"number\">1</span>.不带任何符号</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"section\">location</span> /abc &#123;</span><br><span class=\"line\">        <span class=\"comment\"># /abc /abcdef /abc/ /abc?tom=1  都可以被匹配到</span></span><br><span class=\"line\">        <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;success&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> = /abc &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 精确匹配 /abc /abc?tom=1 </span></span><br><span class=\"line\">        <span class=\"comment\"># 不能匹配 /abc/ /abcde</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> ~^/abc\\w$ &#123;</span><br><span class=\"line\">        <span class=\"comment\"># abc_ 区分大小写</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># ~ ： 用于表示当前uri中包含了正则表达式，并且区分大小写</span></span><br><span class=\"line\">\t<span class=\"comment\"># ~*:  用于表示当前uri中包含了正则表达式，并且不区分大小写</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"section\">location</span> ~*^/abc\\w$ &#123;</span><br><span class=\"line\">        <span class=\"comment\"># abc_ 不区分大小写 </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># ^~: 用于不包含正则表达式的uri前，功能和不加符号的一致，唯一不同的是，如果模式匹配，那么就停止搜索其他模式了。</span></span><br><span class=\"line\">    <span class=\"section\">location</span><span class=\"regexp\"> ^~/abcd</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 非贪婪</span></span><br><span class=\"line\">        <span class=\"comment\"># 不加^ 贪婪匹配</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># root  path为Nginx服务器接收到请求以后查找资源的根目录路径。</span></span><br><span class=\"line\">默认值<span class=\"attribute\">root</span> html;</span><br><span class=\"line\">位置http、server、<span class=\"section\">location</span></span><br><span class=\"line\"><span class=\"comment\"># alias：用来更改location的URI</span></span><br><span class=\"line\">位置<span class=\"section\">location</span></span><br><span class=\"line\"></span><br><span class=\"line\">/usr/local/nginx/html/images/<span class=\"number\">1</span>.jpg</span><br><span class=\"line\"><span class=\"section\">location</span> /images &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html; <span class=\"comment\"># root处理结果 root路径+location</span></span><br><span class=\"line\">    <span class=\"attribute\">alias</span> html/images; <span class=\"comment\">#alias处理结果 直接使用Alisa路径替换location路径，如果location以/结尾,那么alias也要以/结尾</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 在`/usr/local/nginx/html`目录下创建一个 images目录,并在目录下放入一张图片mv.png图片</span></span><br><span class=\"line\"><span class=\"section\">location</span> /images &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">root</span> /usr/local/nginx/html;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">location</span> /images &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">alias</span> /usr/local/nginx/html/images/;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 访问 http://192.168.200.133/images/mv.png 时，上述效果相同</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># index</span></span><br><span class=\"line\">网站的默认页</span><br><span class=\"line\">默认值<span class=\"attribute\">index</span> index.html;位置http、server、<span class=\"section\">location</span></span><br><span class=\"line\">index index.html index.htm;  从左往右匹配，一经匹配，立即执行</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># error_page error_page:设置网站的错误页面</span></span><br><span class=\"line\"><span class=\"comment\"># 1.</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">error_page</span> <span class=\"number\">404</span> www.baidu.com;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.</span></span><br><span class=\"line\"><span class=\"attribute\">error_page</span> <span class=\"number\">500</span> <span class=\"number\">404</span> /50x.html;</span><br><span class=\"line\"><span class=\"section\">location</span> /50x.html &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.不能直接访问的location</span></span><br><span class=\"line\"><span class=\"attribute\">error_page</span> <span class=\"number\">404</span> <span class=\"variable\">@hahaha</span>;</span><br><span class=\"line\"><span class=\"section\">location</span> <span class=\"variable\">@hahaha</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">456</span> <span class=\"string\">&#x27;shabi&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.将相应代码更改为另外一个</span></span><br><span class=\"line\"><span class=\"attribute\">error_page</span> <span class=\"number\">404</span> =<span class=\"number\">200</span> /50x.html;</span><br><span class=\"line\"><span class=\"section\">location</span> /50x.html &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">root</span> html;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"静态资源优化\"><a class=\"markdownIt-Anchor\" href=\"#静态资源优化\">#</a> 静态资源优化</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">sendfile</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">tcp_nopush</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">tcp_nodelay</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">sendfile</span> 高效的文件传输，http，server，location</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407163654759.png\" alt=\"image-20230407163654759\"  />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407163846712.png\" alt=\"image-20230407163846712\"  />\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">tcp_nopush</span>   <span class=\"comment\"># sendfile 打开才生效 位置http,server,location  提升传输效率，即存满缓冲区再发，不要立即push</span></span><br><span class=\"line\">tcp_nodelay  <span class=\"comment\"># keep-alive连接开启才生效 提高网络包传输实时性，即有数据不等缓冲区满立即发 不要延迟</span></span><br></pre></td></tr></table></figure>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407164306027.png\" alt=\"image-20230407164306027\" style=\"zoom:67%;\" /> \n<p>在 linux2.5.9 以后的版本中两者是可以兼容的，三个指令都开启的好处是，sendfile 可以开启高效的文件传输模式，tcp_nopush 开启可以确保在发送到客户端之前数据包已经充分 “填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有 “填满” 而暂停的数据包时，Nginx 会忽略 tcp_nopush 参数， 然后，tcp_nodelay 强制套接字发送数据。由此可知，TCP_NOPUSH 可以与 TCP_NODELAY 一起设置，它比单独配置 TCP_NODELAY 具有更强的性能。所以我们可以使用如下配置来优化 Nginx 静态资源的处理</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sendfile on;</span><br><span class=\"line\">tcp_nopush on;</span><br><span class=\"line\">tcp_nodelay on;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx静态资源压缩\"><a class=\"markdownIt-Anchor\" href=\"#nginx静态资源压缩\">#</a> nginx 静态资源压缩</h2>\n<p>在 Nginx 的配置文件中可以通过配置 gzip 来对静态资源进行压缩，相关的指令可以配置在 http 块、server 块和 location 块中，Nginx 可以通过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ngx_http_gzip_module模块</span><br><span class=\"line\">ngx_http_gzip_static_module模块</span><br><span class=\"line\">ngx_http_gunzip_module模块</span><br></pre></td></tr></table></figure>\n<p>对这些指令进行解析和处理</p>\n<p>以下指令都可以在 http，server，location 中配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>   <span class=\"comment\"># 用于开启或者关闭gzip功能 http,server,location</span></span><br><span class=\"line\">gzip_types mine-type  <span class=\"comment\"># 默认text/html,对mime类型的资源做压缩，多个值空格分隔，使用*压缩所有，http，server，location.不建议压缩图片视频等资源</span></span><br><span class=\"line\">gzip_comp_level <span class=\"number\">1</span>    <span class=\"comment\"># 默认1，取值1-9，值越大，压缩等级最高。设置越高，浪费cpu资源越大。建议6</span></span><br><span class=\"line\">gzip_vary <span class=\"literal\">off</span>  <span class=\"comment\"># 默认off，是否携带“Vary:Accept-Encoding”头域的响应头部。主要是告诉接收方，所发送的数据经过了Gzip压缩处理</span></span><br><span class=\"line\">gzip_buffers <span class=\"number\">32</span> <span class=\"number\">4k</span>    <span class=\"comment\"># 主要实现的是申请number个每个大小为size的缓冲区空间。</span></span><br><span class=\"line\">gzip_disable <span class=\"string\">&quot;MSIE [1-6]\\.&quot;</span>;   <span class=\"comment\"># 针对不同客户端选择是否启用压缩</span></span><br><span class=\"line\"><span class=\"attribute\">gzip_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>    <span class=\"comment\"># 该指令是指定使用Gzip的HTTP最低版本，该指令一般采用默认值即可。</span></span><br><span class=\"line\">gzip_min_length <span class=\"number\">20</span>  <span class=\"comment\"># 小于20字节不在压缩，可以加单位。但是使用了Chunk编码动态压缩，该指令将被忽略。建议设置为1K或以上</span></span><br><span class=\"line\">gzip_proxied <span class=\"literal\">off</span>;  <span class=\"comment\"># 该指令设置是否对服务端返回的结果进行Gzip压缩。</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gzip_proxied</span> 取值</span><br><span class=\"line\"><span class=\"literal\">off</span> - 关闭Nginx服务器对后台服务器返回结果的Gzip压缩</span><br><span class=\"line\">expired - 启用压缩，如果header头中包含 <span class=\"string\">&quot;Expires&quot;</span> 头信息</span><br><span class=\"line\"><span class=\"literal\">no</span>-cache - 启用压缩，如果header头中包含 <span class=\"string\">&quot;Cache-Control:no-cache&quot;</span> 头信息</span><br><span class=\"line\"><span class=\"literal\">no</span>-store - 启用压缩，如果header头中包含 <span class=\"string\">&quot;Cache-Control:no-store&quot;</span> 头信息</span><br><span class=\"line\">private - 启用压缩，如果header头中包含 <span class=\"string\">&quot;Cache-Control:private&quot;</span> 头信息</span><br><span class=\"line\">no_last_modified - 启用压缩,如果header头中不包含 <span class=\"string\">&quot;Last-Modified&quot;</span> 头信息</span><br><span class=\"line\">no_etag - 启用压缩 ,如果header头中不包含 <span class=\"string\">&quot;ETag&quot;</span> 头信息</span><br><span class=\"line\">auth - 启用压缩 , 如果header头中包含 <span class=\"string\">&quot;Authorization&quot;</span> 头信息</span><br><span class=\"line\">any - 无条件启用压缩</span><br></pre></td></tr></table></figure>\n<p>新建 nginx_gzip.conf</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_types</span> *;</span><br><span class=\"line\"><span class=\"attribute\">gzip_comp_level</span> <span class=\"number\">6</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_min_length</span> <span class=\"number\">1024</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_buffers</span> <span class=\"number\">4</span> <span class=\"number\">16K</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_vary</span>  <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_disable</span> <span class=\"string\">&quot;MSIE [1-6]\\.&quot;</span>;</span><br><span class=\"line\"><span class=\"attribute\">gzip_proxied</span>  <span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">在nginx.<span class=\"attribute\">conf</span> </span><br><span class=\"line\">include nginx_gzip.conf</span><br></pre></td></tr></table></figure>\n<p>gzip 和 sendfile 冲突</p>\n<p>gzip 压缩是在用户态完成的，使用 sendfile 之后就不在从内核态到用户态，因此无法同时使用</p>\n<p>可以在存储压缩过的文件，直接发送压缩过的文件，客户端解压</p>\n<p><strong>可以使用 ngx_http_gzip_static_module 模块的 gzip_static 指令来解决。</strong></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">gzip_static</span> <span class=\"literal\">off</span>;  <span class=\"comment\"># 检查与访问资源同名的.gz文件时，response中以gzip相关的header返回.gz文件的内容。</span></span><br><span class=\"line\">取值 <span class=\"attribute\">on</span> <span class=\"literal\">off</span> always</span><br><span class=\"line\">always 浏览器不支持压缩都会发送，<span class=\"literal\">on</span>会先判断</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">nginx</span> 编译时默认没有该模块</span><br><span class=\"line\">./confighure --with-http_gzip_static_module </span><br></pre></td></tr></table></figure>\n<p>使用该模块后会在 header 中加入 <code>content-Encoding: gzip</code>   <code>Vary: Accept-Encoding</code></p>\n<h3 id=\"brotil\"><a class=\"markdownIt-Anchor\" href=\"#brotil\">#</a> brotil</h3>\n<p>需要 https 支持</p>\n<p>br 和 gzip 可以共存，br 优先级更高</p>\n<h4 id=\"安装\"><a class=\"markdownIt-Anchor\" href=\"#安装\">#</a> 安装</h4>\n<ul>\n<li>官网\n<ul>\n<li><code>https://github.com/google/ngx_brotli</code></li>\n<li><code>https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9</code></li>\n</ul>\n</li>\n<li>下载 两个项目</li>\n<li>解压缩</li>\n</ul>\n<p>把 brotli-1.0.9 下所有文件移走</p>\n<p><code>mv ./* ../ngx_brotli-1.0.0rc/deps/brotli/</code></p>\n<p>编译</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc --prefix=/usr/local/nginx/</span><br></pre></td></tr></table></figure>\n<ul>\n<li>make</li>\n<li>将 <code>ngx_http_brotli_filter_module.so</code>   <code>ngx_http_brotli_static_module.so</code>  拷贝到 <code>/usr/local/nginx/modules/</code></li>\n<li>复制 nginx 主程序</li>\n<li>配置文件中添加</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;;</span><br><span class=\"line\">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brotli on;</span><br><span class=\"line\">    brotli_static on;</span><br><span class=\"line\">\tbrotli_comp_level 6;</span><br><span class=\"line\">\tbrotli_buffers 16 8k;</span><br><span class=\"line\">\tbrotli_min_length 20;</span><br><span class=\"line\">\tbrotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">            #gunzip on;</span><br><span class=\"line\">            #gzip_static always;</span><br><span class=\"line\">            gzip on;  #默认关闭</span><br><span class=\"line\">            gzip_buffers 16 8k; #内存缓冲16个8k的块缓冲  32 4k 32位  16 8k 64位</span><br><span class=\"line\">            gzip_comp_level 6; #压缩等级</span><br><span class=\"line\">            gzip_http_version 1.1;  #http版本号</span><br><span class=\"line\">            gzip_min_length 256; #最小返回数据文件，&gt;这个值才压缩</span><br><span class=\"line\">            gzip_proxied any; #只针对反向代理生效，针对上游服务器返回header做条件压缩</span><br><span class=\"line\">            gzip_vary on;</span><br><span class=\"line\">            gzip_types text/xml text/css text/javascript;   #针对那些mine文件压缩</span><br><span class=\"line\">            gzip_disable MSIE6   # 针对那些浏览器关闭压缩，最好别搞正则， 对性能消耗太大</span><br><span class=\"line\">            proxy_http_version 1.1;</span><br><span class=\"line\">            proxy_set_header Connection &quot;&quot;;</span><br><span class=\"line\">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class=\"line\">            proxy_pass http://httpds;</span><br><span class=\"line\">            brotli on;</span><br><span class=\"line\">            brotli_static on;</span><br><span class=\"line\">            brotli_comp_level 6;</span><br><span class=\"line\">            brotli_buffers 16 8k;</span><br><span class=\"line\">            brotli_min_length 20;</span><br><span class=\"line\">            brotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        </span><br><span class=\"line\">#测试：</span><br><span class=\"line\">curl -H &#x27;accept-encoding:br&#x27; -I http://192.168.13.132</span><br></pre></td></tr></table></figure>\n<h2 id=\"静态资源缓存处理\"><a class=\"markdownIt-Anchor\" href=\"#静态资源缓存处理\">#</a> 静态资源缓存处理</h2>\n<p>缓存种类</p>\n<blockquote>\n<p>客户端缓存</p>\n<p>​\t浏览器缓存</p>\n<p>服务端缓存</p>\n<p>​\tNginx / Redis / Memcached 等</p>\n</blockquote>\n<p>浏览器缓存</p>\n<p>是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览.</p>\n<blockquote>\n<p>成本最低的一种缓存实现</p>\n<p>减少网络带宽消耗</p>\n<p>降低服务器压力</p>\n<p>减少网络延迟，加快页面打开速度</p>\n</blockquote>\n<p>header 和缓存相关字段</p>\n<table>\n<thead>\n<tr>\n<th>header</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Expires</td>\n<td>缓存过期的日期和时间</td>\n</tr>\n<tr>\n<td>Cache-Control</td>\n<td>设置和缓存相关的配置信息</td>\n</tr>\n<tr>\n<td>Last-Modified</td>\n<td>请求资源最后修改时间</td>\n</tr>\n<tr>\n<td>ETag</td>\n<td>请求变量的实体标签的当前值，比如文件的 MD5 值</td>\n</tr>\n</tbody>\n</table>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417111638213.png\" alt=\"image-20230417111638213\"></p>\n<blockquote>\n<p>（1）用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送 request 请求来获取数据；</p>\n<p>（2）服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回 200 的成功状态码并且在响应头上附上对应资源以及缓存信息；</p>\n<p>（3）当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件</p>\n<p>（4）如果没有找到对应的缓存文件，则走 (2) 步</p>\n<p>（5）如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是 (Expires),</p>\n<p>（6）如果没有过期，则直接从本地缓存中返回数据进行展示</p>\n<p>（7）如果 Expires 过期，接下来需要判断缓存文件是否发生过变化</p>\n<p>（8）判断的标准有两个，一个是 ETag (Entity Tag), 一个是 Last-Modified</p>\n<p>（9）判断结果是未发生变化，则服务端返回 304，直接从缓存文件中获取数据</p>\n<p>（10）如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商 (服务端所设置的是否需要进行缓存数据的设置) 来进行数据缓存。</p>\n</blockquote>\n<p>强缓存和弱缓存的区别在于是否还要向服务端请求</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">expires</span> <span class=\"literal\">off</span>;  <span class=\"comment\"># expires:该指令用来控制页面缓存的作用。可以通过该指令控制HTTP应答中的“Expires&quot;和”Cache-Control&quot;</span></span><br><span class=\"line\"><span class=\"attribute\">expires</span>   [modified] time</span><br><span class=\"line\">expires epoch|max|<span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">time:可以整数也可以是负数，指定过期时间，如果是负数，Cache-Control则为no-cache,如果为整数或0，则Cache-Control的值为max-age=time;</span><br><span class=\"line\">epoch: 指定Expires的值为&#x27;1 January,1970,00:00:01 GMT&#x27;(1970-01-01 00:00:00)，Cache-Control的值no-<span class=\"attribute\">cache</span></span><br><span class=\"line\">max:指定Expires的值为<span class=\"string\">&#x27;31 December2037 23:59:59GMT&#x27;</span> (<span class=\"number\">2037</span>-<span class=\"number\">12</span>-<span class=\"number\">31</span> <span class=\"number\">23</span>:<span class=\"number\">59</span>:<span class=\"number\">59</span>) ，Cache-Control的值为<span class=\"number\">10</span>年</span><br><span class=\"line\"><span class=\"literal\">off</span>:默认不缓存。</span><br><span class=\"line\"></span><br><span class=\"line\">location <span class=\"regexp\">~ .*\\.(html|js|css|png)$</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">expires</span> <span class=\"number\">1000</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"attribute\">off</span>\t\t\t\t\t\t\t\t\t\t\t\t整数\t\t\t\t\t\t\t\t\t\t\t负数</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410170254546.png\" alt=\"image-20230410170254546\"></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># add_header指令是用来添加指定的响应头和响应值。</span></span><br><span class=\"line\"><span class=\"attribute\">add_header</span> Cache-control <span class=\"literal\">no</span>-store</span><br><span class=\"line\"><span class=\"comment\"># 也能实现不缓存</span></span><br></pre></td></tr></table></figure>\n<p>缓存响应指令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cache-control: must-revalidate</span><br><span class=\"line\">Cache-control: no-cache</span><br><span class=\"line\">Cache-control: no-store</span><br><span class=\"line\">Cache-control: no-transform</span><br><span class=\"line\">Cache-control: public</span><br><span class=\"line\">Cache-control: private</span><br><span class=\"line\">Cache-control: proxy-revalidate</span><br><span class=\"line\">Cache-Control: max-age=&lt;seconds&gt;</span><br><span class=\"line\">Cache-control: s-maxage=&lt;seconds&gt;</span><br></pre></td></tr></table></figure>\n<table>\n<thead>\n<tr>\n<th>指令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>must-revalidate</td>\n<td>可缓存但必须再向源服务器进行确认</td>\n</tr>\n<tr>\n<td>no-cache</td>\n<td>缓存前必须确认其有效性</td>\n</tr>\n<tr>\n<td>no-store</td>\n<td>不缓存请求或响应的任何内容</td>\n</tr>\n<tr>\n<td>no-transform</td>\n<td>代理不可更改媒体类型</td>\n</tr>\n<tr>\n<td>public</td>\n<td>可向任意方提供响应的缓存</td>\n</tr>\n<tr>\n<td>private</td>\n<td>仅向特定用户返回响应</td>\n</tr>\n<tr>\n<td>proxy-revalidate</td>\n<td>要求中间缓存服务器对缓存的响应有效性再进行确认</td>\n</tr>\n<tr>\n<td>max-age=&lt;秒&gt;</td>\n<td>响应最大 Age 值</td>\n</tr>\n<tr>\n<td>s-maxage=&lt;秒&gt;</td>\n<td>公共缓存服务器响应的最大 Age 值</td>\n</tr>\n</tbody>\n</table>\n<p>max-age=[秒]：</p>\n<h2 id=\"nginx解决跨域问题\"><a class=\"markdownIt-Anchor\" href=\"#nginx解决跨域问题\">#</a> nginx 解决跨域问题</h2>\n<p>同源：协议、域名 (IP)、端口相同即为同源</p>\n<p>有两台服务器分别为 A,B, 如果从服务器 A 的页面发送异步请求到服务器 B 获取数据，如果服务器 A 和服务器 B 不满足同源策略，则就会出现跨域问题。</p>\n<p>Access-Control-Allow-Origin: 直译过来是允许跨域访问的源地址信息，可以配置多个 (多个用逗号分隔)，也可以使用 <code>*</code>  代表所有源</p>\n<p>Access-Control-Allow-Methods: 直译过来是允许跨域访问的请求方式，值可以为 GET POST PUT DELETE…, 可以全部设置，也可以根据需要设置，多个用逗号分隔</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 解决跨域问题</span></span><br><span class=\"line\"><span class=\"section\">location</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Access-Control-Allow-Origin http://192.168.13.132:80;   <span class=\"comment\"># * 匹配所有</span></span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">location</span> /getUser&#123;</span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Access-Control-Allow-Origin *;</span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> application/json;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"防盗链\"><a class=\"markdownIt-Anchor\" href=\"#防盗链\">#</a> 防盗链</h2>\n<p>资源盗链指的是此内容不在自己服务器上，而是通过技术手段，绕过别人的限制将别人的内容放到自己页面上最终展示给用户。以此来盗取大网站的空间和流量。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417112346770.png\" alt=\"image-20230417112346770\"></p>\n<p>Referer, 当浏览器向 web 服务器发送请求的时候，一般都会带上 Referer, 来告诉浏览器该网页是从哪个页面链接过来的。</p>\n<p>在二次请求时会在请求头中加入 referer，第一次访问时是没有的</p>\n<p>后台服务器可以根据获取到的这个 Referer 信息来判断是否为自己信任的网站地址，如果是则放行继续访问，如果不是则可以返回 403 (服务端拒绝访问) 的状态信息。</p>\n<p>valid_referers:nginx 会通就过查看 referer 自动和 valid_referers 后面的内容进行匹配，如果匹配到了就将 $invalid_referer 变量置 0，如果没有匹配到，则将 $invalid_referer 变量置为 1，匹配的过程中不区分大小写。</p>\n<table>\n<thead>\n<tr>\n<th>语法</th>\n<th>valid_referers none|blocked|server_names|string…</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>默认值</td>\n<td>—</td>\n</tr>\n<tr>\n<td>位置</td>\n<td>server、location</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 防盗链测试</span></span><br><span class=\"line\"><span class=\"attribute\">curl</span> 测试防盗链</span><br><span class=\"line\">curl -I 只返回响应头信息</span><br><span class=\"line\">curl -e <span class=\"string\">&quot;referer&quot;</span> -I <span class=\"string\">&quot;URL&quot;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">none: 如果Header中的Referer为空，允许访问</span><br><span class=\"line\">blocked:在Header中的Referer不为空，但是该值被防火墙或代理进行伪装过，如不带&quot;http://&quot; 、&quot;https://&quot;等协议头的资源允许访问。就是允许“http://”或&quot;https//&quot;以外的请求。</span><br><span class=\"line\">server_names:指定具体的域名或者<span class=\"attribute\">IP</span></span><br><span class=\"line\">string: 可以支持正则表达式和*的字符串。如果是正则表达式，需要以`~`开头表示，例如</span><br><span class=\"line\"></span><br><span class=\"line\">location <span class=\"regexp\">~ .*\\.(png|jpg|gif)$</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">vaild_referers</span> <span class=\"literal\">none</span> <span class=\"literal\">blocked</span> www.g.com;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">return</span> <span class=\"number\">403</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html/images;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 针对目录进行防盗链</span></span><br><span class=\"line\"><span class=\"section\">location</span> /static &#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">    <span class=\"attribute\">vaild_referers</span> <span class=\"literal\">none</span> <span class=\"literal\">blocked</span> www.g.com;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">return</span> <span class=\"number\">403</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检测到盗链时返回403错误码</span></span><br><span class=\"line\"><span class=\"section\">location</span> ~*/(js|img|css) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">valid_referers</span> <span class=\"literal\">none</span> <span class=\"number\">192.168.13.132</span>;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">403</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">    <span class=\"attribute\">index</span>  index.html index.htm; </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检测到盗链时返回指定页面</span></span><br><span class=\"line\"><span class=\"section\">location</span> ~*/(js|img|css) &#123;</span><br><span class=\"line\">    <span class=\"attribute\">valid_referers</span> <span class=\"literal\">none</span> <span class=\"number\">192.168.13.132</span>;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">401</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">    <span class=\"attribute\">index</span>  index.html index.htm; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">error_page</span>  <span class=\"number\">401</span>  /<span class=\"number\">401</span>.html;</span><br><span class=\"line\">    <span class=\"section\">location</span> = /<span class=\"number\">401</span>.html &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\"># 注意，只有打开图片链接才能看到指定页面</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检测到盗链时返回指定图片</span></span><br><span class=\"line\"><span class=\"section\">location</span> <span class=\"regexp\">~ .*\\.(png|jpg|gif)$</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">vaild_referers</span> <span class=\"literal\">none</span> <span class=\"literal\">blocked</span> www.g.com;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\"># return 403;</span></span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/</span> /imgaes/a.png <span class=\"literal\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html/images;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Referer 的限制比较粗，比如随意加一个 Referer，上面的方式是无法进行限制的</p>\n<p>此处我们需要用到 Nginx 的第三方模块 <code>ngx_http_accesskey_module</code> ，第三方模块如何实现盗链</p>\n<h2 id=\"rewrite\"><a class=\"markdownIt-Anchor\" href=\"#rewrite\">#</a> rewrite</h2>\n<p>主要的作用是用来实现 URL 的重写。</p>\n<p>Nginx 服务器的 Rewrite 功能的实现依赖于 PCRE 的支持，因此在编译安装 Nginx 服务器之前，需要安装 PCRE 库。Nginx 使用的是 ngx_http_rewrite_module 模块来解析和处理 Rewrite 功能的相关配置。</p>\n<p>重写和转发的区别:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">地址重写浏览器地址会发生变化而地址转发则不变</span><br><span class=\"line\">一次地址重写会产生两次请求而一次地址转发只会产生一次请求</span><br><span class=\"line\">地址重写到的页面必须是一个完整的路径而地址转发则不需要</span><br><span class=\"line\">地址重写因为是两次请求所以request范围内属性不能传递给新页面而地址转发因为是一次请求所以可以传递值</span><br><span class=\"line\">地址转发速度快于地址重写</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWw=\">Module ngx_http_rewrite_module (nginx.org)</span></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># set  该指令用来设置一个新的变量。</span></span><br><span class=\"line\"><span class=\"comment\"># server、location、if</span></span><br><span class=\"line\"><span class=\"attribute\">set</span> <span class=\"variable\">$variable</span> value;</span><br><span class=\"line\">variable:变量的名称，该变量名称要用&quot;$&quot;作为变量的第一个字符，且不能与Nginx服务器预设的全局变量同名。</span><br><span class=\"line\">value:变量的值，可以是字符串、其他变量或者变量的组合等。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8890</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server &#123;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$name</span> shabi;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$age</span> <span class=\"number\">18</span>;</span><br><span class=\"line\">        <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"variable\">$name</span>=<span class=\"variable\">$age</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>rewrite 常用全局变量</p>\n<table>\n<thead>\n<tr>\n<th>变量</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>$args</td>\n<td>变量中存放了请求 URL 中的请求指令。比如 http://192.168.200.133:8080?arg1=value1&amp;args2=value2 中的 &quot;arg1=value1&amp;arg2=value2&quot;，功能和 $query_string 一样</td>\n</tr>\n<tr>\n<td>$http_user_agent</td>\n<td>变量存储的是用户访问服务的代理信息 (如果通过浏览器访问，记录的是浏览器的相关版本信息)</td>\n</tr>\n<tr>\n<td>$host</td>\n<td>变量存储的是访问服务器的 server_name 值</td>\n</tr>\n<tr>\n<td>$document_uri</td>\n<td>变量存储的是当前访问地址的 URI。比如 http://192.168.200.133/server?id=10&amp;name=zhangsan 中的 &quot;/server&quot;，功能和 $uri 一样</td>\n</tr>\n<tr>\n<td>$document_root</td>\n<td>变量存储的是当前请求对应 location 的 root 值，如果未设置，默认指向 Nginx 自带 html 目录所在位置</td>\n</tr>\n<tr>\n<td>$content_length</td>\n<td>变量存储的是请求头中的 Content-Length 的值</td>\n</tr>\n<tr>\n<td>$content_type</td>\n<td>变量存储的是请求头中的 Content-Type 的值</td>\n</tr>\n<tr>\n<td>$http_cookie</td>\n<td>变量存储的是客户端的 cookie 信息，可以通过 add_header Set-Cookie 'cookieName=cookieValue’来添加 cookie 数据</td>\n</tr>\n<tr>\n<td>$limit_rate</td>\n<td>变量中存储的是 Nginx 服务器对网络连接速率的限制，也就是 Nginx 配置中对 limit_rate 指令设置的值，默认是 0，不限制。</td>\n</tr>\n<tr>\n<td>$remote_addr</td>\n<td>变量中存储的是客户端的 IP 地址</td>\n</tr>\n<tr>\n<td>$remote_port</td>\n<td>变量中存储了客户端与服务端建立连接的端口号</td>\n</tr>\n<tr>\n<td>$remote_user</td>\n<td>变量中存储了客户端的用户名，需要有认证模块才能获取</td>\n</tr>\n<tr>\n<td>$scheme</td>\n<td>变量中存储了访问协议</td>\n</tr>\n<tr>\n<td>$server_addr</td>\n<td>变量中存储了服务端的地址</td>\n</tr>\n<tr>\n<td>$server_name</td>\n<td>变量中存储了客户端请求到达的服务器的名称</td>\n</tr>\n<tr>\n<td>$server_port</td>\n<td>变量中存储了客户端请求到达服务器的端口号</td>\n</tr>\n<tr>\n<td>$server_protocol</td>\n<td>变量中存储了客户端请求协议的版本，比如 &quot;HTTP/1.1&quot;</td>\n</tr>\n<tr>\n<td>$request_body_file</td>\n<td>变量中存储了发给后端服务器的本地文件资源的名称</td>\n</tr>\n<tr>\n<td>$request_method</td>\n<td>变量中存储了客户端的请求方式，比如 &quot;GET&quot;,&quot;POST&quot; 等</td>\n</tr>\n<tr>\n<td>$request_filename</td>\n<td>变量中存储了当前请求的资源文件的路径名</td>\n</tr>\n<tr>\n<td>$request_uri</td>\n<td>变量中存储了当前请求的 URI，并且携带请求参数，比如 http://192.168.200.133/server?id=10&amp;name=zhangsan 中的 &quot;/server?id=10&amp;name=zhangsan&quot;</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"if\"><a class=\"markdownIt-Anchor\" href=\"#if\">#</a> if</h3>\n<p>使用正则表达式对变量进行匹配，匹配成功返回 true，否则返回 false。变量与正则表达式之间使用 &quot;<sub>&quot;,&quot;</sub>*&quot;,&quot;!<sub>&quot;,&quot;!</sub>*&quot; 来连接。</p>\n<p>&quot;~&quot; 代表匹配正则表达式过程中区分大小写，</p>\n<p>&quot;~*&quot; 代表匹配正则表达式过程中不区分大小写</p>\n<p>&quot;!<sub>“和”!</sub>*&quot; 刚好和上面取相反值，如果匹配上返回 false, 匹配不上返回 true</p>\n<p>判断请求的文件是否存在使用 &quot;-f&quot; 和 &quot;!-f&quot;,</p>\n<p>当使用 &quot;-f&quot; 时，如果请求的文件存在返回 true，不存在返回 false。</p>\n<p>当使用 &quot;!f&quot; 时，如果请求文件不存在，但该文件所在目录存在返回 true, 文件和目录都不存在返回 false, 如果文件存在返回 false</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># if  (condition)&#123;...&#125;</span></span><br><span class=\"line\"><span class=\"comment\"># server、location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /if &#123;</span><br><span class=\"line\">    <span class=\"attribute\">set</span> <span class=\"variable\">$param</span> <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$param</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"variable\">$param</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$request_method</span> = POST) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">405</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$http_user_agent</span> <span class=\"regexp\">~ Safari)</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (!-f <span class=\"variable\">$request_filename</span>) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"variable\">$request_filename</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;empty&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<ol start=\"5\">\n<li>\n<p>判断请求的目录是否存在使用 &quot;-d&quot; 和 &quot;!-d&quot;,</p>\n<p>当使用 &quot;-d&quot; 时，如果请求的目录存在，if 返回 true，如果目录不存在则返回 false</p>\n<p>当使用 &quot;!-d&quot; 时，如果请求的目录不存在但该目录的上级目录存在则返回 true，该目录和它上级目录都不存在则返回 false, 如果请求目录存在也返回 false.</p>\n</li>\n<li>\n<p>判断请求的目录或者文件是否存在使用 &quot;-e&quot; 和 &quot;!-e&quot;</p>\n<p>当使用 &quot;-e&quot;, 如果请求的目录或者文件存在时，if 返回 true, 否则返回 false.</p>\n<p>当使用 &quot;!-e&quot;, 如果请求的文件和文件所在路径上的目录都不存在返回 true, 否则返回 false</p>\n</li>\n<li>\n<p>判断请求的文件是否可执行使用 &quot;-x&quot; 和 &quot;!-x&quot;</p>\n<p>当使用 &quot;-x&quot;, 如果请求的文件可执行，if 返回 true, 否则返回 false</p>\n<p>当使用 &quot;!-x&quot;, 如果请求文件不可执行，返回 true, 否则返回 false</p>\n</li>\n</ol>\n<h3 id=\"break\"><a class=\"markdownIt-Anchor\" href=\"#break\">#</a> break</h3>\n<p>该指令用于中断当前相同作用域中的其他 Nginx 配置。与该指令处于同一作用域的 Nginx 配置中，位于它前面的指令配置生效，位于后面的指令配置无效。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /testbreak &#123;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$args</span>) &#123;</span><br><span class=\"line\">        <span class=\"attribute\">set</span> <span class=\"variable\">$username</span> haha;</span><br><span class=\"line\">        break;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"attribute\">add_header</span> <span class=\"variable\">$username</span> <span class=\"number\">222</span>;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"return\"><a class=\"markdownIt-Anchor\" href=\"#return\">#</a> return</h3>\n<p>该指令用于完成对请求的处理，直接向客户端返回响应状态代码。在 return 后的所有 Nginx 配置都是无效的。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">return</span> code [text];</span><br><span class=\"line\"><span class=\"attribute\">return</span> code URL;</span><br><span class=\"line\"><span class=\"attribute\">return</span> URL;</span><br></pre></td></tr></table></figure>\n<p>code: 为返回给客户端的 HTTP 状态代理。可以返回的状态代码为 0~999 的任意 HTTP 状态代理</p>\n<p>text: 为返回给客户端的响应体内容，支持变量的使用</p>\n<p>URL: 为返回给客户端的 URL 地址</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">server</span> /ret &#123;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> application/json;</span><br><span class=\"line\">    <span class=\"attribute\">return</span> <span class=\"number\">200</span> success;</span><br><span class=\"line\">    <span class=\"comment\"># return 302 http://www.baidu.com;</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"rewrite-2\"><a class=\"markdownIt-Anchor\" href=\"#rewrite-2\">#</a> rewrite</h3>\n<p>该指令通过正则表达式的使用来改变 URI。可以同时存在一个或者多个指令，按照顺序依次对 URL 进行匹配和处理。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># rewrite regex replacement [flag];</span></span><br><span class=\"line\"><span class=\"comment\"># server、location、if</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> /rewrite &#123;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/rewrite/url\\w*$</span> https://www.baidu.com;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/rewrite/(test)\\w*$</span>; /$1;</span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/rewrite/(demo)\\w*$</span>  /<span class=\"variable\">$1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>regex: 用来匹配 URI 的正则表达式</p>\n<p>replacement: 匹配成功后，用于替换 URI 中被截取内容的字符串。如果该字符串是以 &quot;http://&quot; 或者 &quot;https://&quot; 开头的，则不会继续向下对 URI 进行其他处理，而是直接返回重写后的 URI 给客户端。</p>\n<p>flag: 用来设置 rewrite 对 URI 的处理行为，可选值有如下：</p>\n<p>​\tlast: 终止继续在本 location 块中处理接收到的 URI，并将此处重写的 URI 作为一个新的 URI，使用各 location 块进行处理。该标志将重写后的 URI 重写在 server 块中执行，为重写后的 URI 提供了转入到其他 location 块的机会。即本条规则匹配完成后，继续向下匹配新的 1ocation URI 规则</p>\n<p>​\tbreak: 将此处重写的 URI 作为一个新的 URI, 在本块中继续进行处理。该标志将重写后的地址在当前的 location 块中执行，不会将新的 URI 转向其他的 location 块。</p>\n<p>​\tredirect: 将重写后的 URl 返回给客户端，状态码为 302，指明是临时重定向 URl, 主要用在 replacement 变量不是以 &quot;http:/“或者&quot;https:/”&quot; 开头的情况。浏览器地址会显示跳转后的 URL 地址</p>\n<p>​\tpermanent: 将重写后的 URI 返回给客户端，状态码为 301，指明是重定向 URl, 主要用在 replacement 变量不是以 &quot;http://“或者&quot;https://”&quot; 开头的情况。浏览器地址栏会显示跳转后的 URL 地址</p>\n<h3 id=\"rewrite_log\"><a class=\"markdownIt-Anchor\" href=\"#rewrite_log\">#</a> rewrite_log</h3>\n<p>该指令配置是否开启 URL 重写日志的输出功能。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rewrite_log off;</span><br><span class=\"line\">开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</span><br><span class=\"line\">error_log notice;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"rewrite实现伪静态\"><a class=\"markdownIt-Anchor\" href=\"#rewrite实现伪静态\">#</a> rewrite 实现伪静态</h3>\n<figure class=\"highlight jsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 假设pageNum为前端接收数据，后端根据对应的pageNum展示对应的页面</span><br><span class=\"line\">&lt;%</span><br><span class=\"line\">    <span class=\"type\">String</span> <span class=\"variable\">pageNum</span> <span class=\"operator\">=</span> request.getParameter(<span class=\"string\">&quot;pageNum&quot;</span>);</span><br><span class=\"line\">    out.println(<span class=\"string\">&quot;this is&quot;</span> + pageNum);</span><br><span class=\"line\">%&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;  <span class=\"comment\"># 域名或主机名</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">       \t<span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/([0-9]+).html$</span> /index.jsp?pageNum=<span class=\"variable\">$1</span> <span class=\"literal\">break</span>;</span><br><span class=\"line\">\t\t<span class=\"attribute\">proxy_pass</span> http://192.168.13.155:8080;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#error_page  404              /404.html;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">error_page</span>   <span class=\"number\">500</span> <span class=\"number\">502</span> <span class=\"number\">503</span> <span class=\"number\">504</span>  /50x.html;</span><br><span class=\"line\">       <span class=\"section\">location</span> = /50x.html &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">   &#125;</span><br></pre></td></tr></table></figure>\n<p>可以实现访问 http://www.a.com/haha?pageNum=13 时客户端显示 <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5hLmNvbS8xMy5odG1s\">http://www.a.com/13.html</span></p>\n<h3 id=\"域名跳转\"><a class=\"markdownIt-Anchor\" href=\"#域名跳转\">#</a> 域名跳转</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 1.修改hosts</span></span><br><span class=\"line\">127.0.0.1       www.shinya.<span class=\"attribute\">com</span></span><br><span class=\"line\"><span class=\"number\">127.0.0.1</span>       www.kbshire.com</span><br><span class=\"line\"><span class=\"number\">127.0.0.1</span>       www.shabi.com</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.修改conf</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> www.shinya.com;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">default_type</span> text/html;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;&lt;h1&gt;shinya&lt;/h1&gt;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> www.kbshire.com www.shinya.com;</span><br><span class=\"line\">    <span class=\"comment\"># rewrite ^/ http://www.shinya.com/;</span></span><br><span class=\"line\">    <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> http://www.shinya.com<span class=\"variable\">$1</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"域名镜像\"><a class=\"markdownIt-Anchor\" href=\"#域名镜像\">#</a> 域名镜像</h3>\n<p>镜像网站指定是将一个完全相同的网站分别放置到几台服务器上，并分别使用独立的 URL 进行访问。其中一台服务器上的网站叫主站，其他的为镜像网站。镜像网站和主站没有太大的区别，可以把镜像网站理解为主站的一个备份节点。</p>\n<p>然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在 location 块中配置 rewrite 功能，比如:</p>\n<p>提高可用性</p>\n<p>加快响应速度</p>\n<p>流量负载</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 只对user子目录做镜像</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> www.shinya.com www.kbshire.com;</span><br><span class=\"line\">    <span class=\"section\">location</span> /user &#123;</span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/user(.*)$</span> http://www.shabi.com<span class=\"variable\">$1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> /emp &#123;</span><br><span class=\"line\">        <span class=\"attribute\">default_type</span> text/html;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"独立域名\"><a class=\"markdownIt-Anchor\" href=\"#独立域名\">#</a> 独立域名</h3>\n<p>为每个模块设置独立域名</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://search.hm.<span class=\"attribute\">com</span>  访问商品搜索模块</span><br><span class=\"line\">http://item.hm.com\t  访问商品详情模块</span><br><span class=\"line\">http://cart.hm.com\t  访问商品购物车模块</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> search.hm.com;</span><br><span class=\"line\">\t<span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> http://www.hm.com/bbs<span class=\"variable\">$1</span> <span class=\"literal\">last</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">81</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> item.hm.com;</span><br><span class=\"line\">\t<span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> http://www.hm.com/item<span class=\"variable\">$1</span> <span class=\"literal\">last</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">82</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> cart.hm.com;</span><br><span class=\"line\">\t<span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> http://www.hm.com/cart<span class=\"variable\">$1</span> <span class=\"literal\">last</span>;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"自动加\"><a class=\"markdownIt-Anchor\" href=\"#自动加\">#</a> 自动加 /</h3>\n<p>重定向的地址会有一个指令叫 server_name_in_redirect on|off; 来决定重定向的地址：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果该指令为on</span><br><span class=\"line\">\t重定向的地址为:  http://server_name/目录名/;</span><br><span class=\"line\">如果该指令为off</span><br><span class=\"line\">\t重定向的地址为:  http://原URL中的域名/目录名/;</span><br></pre></td></tr></table></figure>\n<p>server_name_in_redirect on 时，如果访问 192.168.13.155/shabi 会跳转到 localhost/shabi/ 导致无法访问</p>\n<p>自动加 / 可以避免自动跳转</p>\n<p>注意 server_name_in_redirect 指令在 Nginx 的 0.8.48 版本之前默认都是 on，之后改成了 off, 所以现在我们这个版本不需要考虑这个问题</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8082</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"attribute\">server_name_in_redirect</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"section\">location</span> /shabi &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">        <span class=\"attribute\">index</span> index.html;</span><br><span class=\"line\">        <span class=\"attribute\">if</span> (-d <span class=\"variable\">$request_filename</span>) &#123;</span><br><span class=\"line\">            <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)([^/])$</span> http://<span class=\"variable\">$host</span>:<span class=\"variable\">$server_port</span><span class=\"variable\">$1</span><span class=\"variable\">$2</span>/ <span class=\"literal\">permanent</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>127.0.0.1/shbi 与 127.0.0.1/shabi/ 的区别</p>\n<p>127.0.0.1/shabi    不加 / 会 301 重定向到 /shabi/</p>\n<p>127.0.0.1/shabi/   不做重定向</p>\n<h3 id=\"目录合并\"><a class=\"markdownIt-Anchor\" href=\"#目录合并\">#</a> 目录合并</h3>\n<p>URL 的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">        <span class=\"attribute\">index</span> index.html;</span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)\\.html$</span> /server/<span class=\"variable\">$1</span>/<span class=\"variable\">$2</span>/<span class=\"variable\">$3</span>/<span class=\"variable\">$4</span>/<span class=\"variable\">$5</span>.html <span class=\"literal\">last</span>;</span><br><span class=\"line\">        <span class=\"comment\"># /server/11/22/33/44/20.html</span></span><br><span class=\"line\">        <span class=\"comment\"># /server/11-22-33-44-20.html</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"防盗链-2\"><a class=\"markdownIt-Anchor\" href=\"#防盗链-2\">#</a> 防盗链</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 检测到盗链时返回指定图片</span></span><br><span class=\"line\"><span class=\"section\">location</span> <span class=\"regexp\">~ .*\\.(png|jpg|gif)$</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">vaild_referers</span> <span class=\"literal\">none</span> <span class=\"literal\">blocked</span> www.g.com;</span><br><span class=\"line\">    <span class=\"attribute\">if</span> (<span class=\"variable\">$invalid_referer</span>) &#123;</span><br><span class=\"line\">\t\t<span class=\"comment\"># return 403;</span></span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^/</span> /imgaes/a.png <span class=\"literal\">break</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> html/images;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx代理\"><a class=\"markdownIt-Anchor\" href=\"#nginx代理\">#</a> Nginx 代理</h2>\n<p>正向代理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417115758644.png\" alt=\"image-20230417115758644\"></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 访问192.168.13.155 82 代理到服务器，服务器认为是155访问的</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">82</span>;</span><br><span class=\"line\">    <span class=\"attribute\">resolver</span> <span class=\"number\">8.8.8.8</span>;   <span class=\"comment\"># 设置DNSIP，用来继续proxy_pass中域名</span></span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://<span class=\"variable\">$host</span><span class=\"variable\">$request_uri</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修稿客户端的代理</p>\n<h3 id=\"反向代理\"><a class=\"markdownIt-Anchor\" href=\"#反向代理\">#</a> 反向代理</h3>\n<p>Nginx 反向代理模块的指令是由 <code>ngx_http_proxy_module</code>  模块进行解析，该模块在安装 Nginx 的时候已经自己加装到 Nginx 中了</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">proxy_pass</span> <span class=\"comment\"># 设置被代理服务器的地址</span></span><br><span class=\"line\">位置location</span><br><span class=\"line\"></span><br><span class=\"line\">server  &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8080</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 此时访问的是/server/index.html</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 此时访问的是/index.html</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\"># 注意location /  proxy_pass 后面会帮你加上 / </span></span><br><span class=\"line\">    <span class=\"comment\"># loction /xxx  后面不加 / 会出现上面的问题</span></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">proxy_set_header</span> </span><br><span class=\"line\"><span class=\"comment\"># 该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器</span></span><br><span class=\"line\">proxy_set_header Host <span class=\"variable\">$proxy_host</span>;</span><br><span class=\"line\"><span class=\"attribute\">proxy_set_header</span> Connection close;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 被带服务器</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8080</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">default_type</span> text/html;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"variable\">$http_username</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 代理服务器</span></span><br><span class=\"line\"><span class=\"section\">server</span>  &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8080</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155:8080;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_set_header</span> username HAHA;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 实现功能 访问代理服务器的:8080/server 添加username header，在被代服务器回显给客户端</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># proxy_redirect</span></span><br><span class=\"line\">该指令是用来重置头信息中的&quot;Location&quot;和&quot;Refresh&quot;的值。</span><br><span class=\"line\"><span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">redirect</span> replacement;</span><br><span class=\"line\"><span class=\"attribute\">proxy_redirect</span> default;</span><br><span class=\"line\"><span class=\"attribute\">proxy_redirect</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">位置http、server、<span class=\"section\">location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 服务端</span></span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8082</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">root</span> html;</span><br><span class=\"line\">        <span class=\"attribute\">index</span> index.html;</span><br><span class=\"line\">        <span class=\"comment\"># 这样会暴露服务端真实ip</span></span><br><span class=\"line\">        <span class=\"comment\">#if (!-f $request_filename) &#123;</span></span><br><span class=\"line\">        <span class=\"comment\">#    return 302 http://192.168.13.155/;</span></span><br><span class=\"line\">        <span class=\"comment\">#&#125;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 代理服务器</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8082</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155:8082;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_redirect</span> http://192.168.13.155 http://192.168.13.132;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_redirect redirect replacement;</span></span><br><span class=\"line\">redirect:目标,Location的值</span><br><span class=\"line\">replacement:要替换的值</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_redirect default;</span></span><br><span class=\"line\">将<span class=\"section\">location</span>块的uri变量作为replacement,</span><br><span class=\"line\">将proxy_pass变量作为redirect进行替换</span><br></pre></td></tr></table></figure>\n<p>当后端三台服务器上内容不一样时的案例：</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 如果后端服务器每台上内容不一样</span></span><br><span class=\"line\"><span class=\"comment\"># 服务器1</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> <span class=\"number\">192.168.13.155</span>;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;155&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"comment\"># 服务器2</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> <span class=\"number\">192.168.13.166</span>;</span><br><span class=\"line\">    <span class=\"attribute\">default_type</span> text/plain;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">return</span> <span class=\"number\">200</span> <span class=\"string\">&#x27;166&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 代理服务器</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155:8083/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8084</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.166:8083/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 代理服务器 - 或者</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server1 &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.155:8083/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">location</span> /server2 &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> http://192.168.13.166:8083/;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"nginx安全控制\"><a class=\"markdownIt-Anchor\" href=\"#nginx安全控制\">#</a> nginx 安全控制</h3>\n<p>http 请求转变成 https 请求</p>\n<p>nginx 添加 ssl 支持</p>\n<p>–with-http_ssl_module</p>\n<p>ssl 模块下所有的配置都可以在 http，server 块中配置，下面就省略配置位置了</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">ssl</span> <span class=\"literal\">on</span>;   <span class=\"comment\"># 开启ssl支持</span></span><br><span class=\"line\">位置http、<span class=\"attribute\">server</span></span><br><span class=\"line\">或者</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">效果一样~</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">ssl_certificate</span> ;   <span class=\"comment\"># 指定pem证书</span></span><br><span class=\"line\"><span class=\"attribute\">ssl_certificate_key</span> <span class=\"comment\"># 指定pem secret 文件</span></span><br><span class=\"line\">ssl_session_cache <span class=\"literal\">off</span>;  <span class=\"comment\"># 设置ssl会话缓存</span></span><br><span class=\"line\"></span><br><span class=\"line\">/*</span><br><span class=\"line\"><span class=\"attribute\">ssl_session_cache</span> 可选项如下</span><br><span class=\"line\"><span class=\"literal\">off</span>:禁用会话缓存，客户端不得重复使用会话</span><br><span class=\"line\"><span class=\"literal\">none</span>:禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数</span><br><span class=\"line\">builtin:内置OpenSSL缓存，仅在一个工作进程中使用。</span><br><span class=\"line\">shared:所有工作进程之间共享缓存，缓存的相关信息用name和size来指定</span><br><span class=\"line\">*/</span><br><span class=\"line\"></span><br><span class=\"line\">ssl_session_timeout <span class=\"comment\"># 设置客户端能够反复使用储存在缓存中的会话参数时间</span></span><br><span class=\"line\">ssl_ciphers <span class=\"comment\"># 允许的密码，必须为openssl支持的格式，可以使用`openssl ciphers`查看openssl支持的格式。</span></span><br><span class=\"line\">ssl_prefer_server_ciphers <span class=\"literal\">on</span>;  <span class=\"comment\">#该指令指定是否服务器密码优先客户端密码</span></span><br></pre></td></tr></table></figure>\n<p>生成证书</p>\n<blockquote>\n<p>阿里云生成</p>\n<p>openssl</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">mkdir</span> /root/cert</span><br><span class=\"line\"><span class=\"built_in\">cd</span> /root/cert</span><br><span class=\"line\">openssl genrsa -des3 -out server.key 2048</span><br><span class=\"line\">openssl req -new -key server.key -out server.csr</span><br><span class=\"line\"><span class=\"built_in\">cp</span> server.key server.key.org</span><br><span class=\"line\">openssl rsa -<span class=\"keyword\">in</span> server.key.org -out server.key</span><br><span class=\"line\">openssl x509 -req -days 365 -<span class=\"keyword\">in</span> server.csr -signkey server.key -out server.crt</span><br><span class=\"line\"></span><br><span class=\"line\">[root@localhost cert]<span class=\"comment\"># ls -al </span></span><br><span class=\"line\">total 20</span><br><span class=\"line\">drwxr-xr-x   2 root root   82 Apr 12 19:48 .</span><br><span class=\"line\">dr-xr-x---. 20 root root 4096 Apr 12 19:42 ..</span><br><span class=\"line\">-rw-r--r--   1 root root  867 Apr 12 19:48 server.crt</span><br><span class=\"line\">-rw-r--r--   1 root root  708 Apr 12 19:46 server.csr</span><br><span class=\"line\">-rw-------   1 root root  916 Apr 12 19:47 server.key</span><br><span class=\"line\">-rw-------   1 root root 1062 Apr 12 19:47 server.key.org</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">443</span> ssl;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate</span>      /root/cert/server.crt;</span><br><span class=\"line\">       <span class=\"attribute\">ssl_certificate_key</span>  /root/cert/server.key</span><br><span class=\"line\"></span><br><span class=\"line\">       ssl_session_cache    shared:SSL:<span class=\"number\">1m</span>;   <span class=\"comment\"># 工作进程共享缓存   名称   大小</span></span><br><span class=\"line\">       <span class=\"attribute\">ssl_session_timeout</span>  <span class=\"number\">5m</span>;              <span class=\"comment\"># 超时时间</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"attribute\">ssl_ciphers</span>  HIGH:!aNULL:!MD5;        <span class=\"comment\"># 密码格式</span></span><br><span class=\"line\">       <span class=\"attribute\">ssl_prefer_server_ciphers</span>  <span class=\"literal\">on</span>;        <span class=\"comment\"># 是否服务端密码优先于客户端密码</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">           <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">           <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># httprewrite到https，因为浏览器www.baidu.com 默认是http</span></span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span> <span class=\"number\">80</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span> www,baidu.com;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(.*)</span> https://baidu.com<span class=\"variable\">$1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h3 id=\"反向代理系统优化\"><a class=\"markdownIt-Anchor\" href=\"#反向代理系统优化\">#</a> 反向代理系统优化</h3>\n<p>Buffer 和 cache</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">相同点:</span><br><span class=\"line\">两种方式都是用来提供IO吞吐效率，都是用来提升Nginx代理的性能。</span><br><span class=\"line\">不同点:</span><br><span class=\"line\">缓冲主要用来解决不同设备之间数据传递速度不一致导致的性能低的问题，缓冲中的数据一旦此次操作完成后，就可以删除。</span><br><span class=\"line\">缓存主要是备份，将被代理服务器的数据缓存一份到代理服务器，这样的话，客户端再次获取相同数据的时候，就只需要从代理服务器上获取，效率较高，缓存中的数据可以重复使用，只有满足特定条件才会删除.</span><br></pre></td></tr></table></figure>\n<p>下面所有的参数都可以在 http，server，location 中配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">proxy_buffering</span> <span class=\"literal\">on</span>  :该指令用来开启或者关闭代理服务器的缓冲区；</span><br><span class=\"line\">proxy_buffers <span class=\"number\">8</span> <span class=\"number\">4k</span>   :该指令用来指定单个连接从代理服务器读取响应的缓存区的个数和大小。</span><br><span class=\"line\">proxy_buffer_size <span class=\"number\">4k</span> :该指令用来设置从被代理服务器获取的第一部分响应数据的大小。保持与proxy_buffers中的size一致即可，当然也可以更小。</span><br><span class=\"line\">proxy_busy_buffers_size <span class=\"number\">8k</span>  ：该指令用来限制同时处于BUSY状态的缓冲总大小</span><br><span class=\"line\">proxy_temp_path path  :当缓冲区存满后，仍未被Nginx服务器完全接受，响应数据就会被临时存放在磁盘文件上，该指令设置文件路径,最多只能三层目录</span><br><span class=\"line\">proxy_temp_file_write_size <span class=\"number\">8k</span> ：该指令用来设置磁盘上缓冲文件的大小。</span><br></pre></td></tr></table></figure>\n<p>通用配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">proxy_buffering</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"><span class=\"attribute\">proxy_buffer_size</span> <span class=\"number\">4</span> <span class=\"number\">32k</span>;</span><br><span class=\"line\"><span class=\"attribute\">proxy_busy_buffers_size</span> <span class=\"number\">64k</span>;</span><br><span class=\"line\"><span class=\"attribute\">proxy_temp_file_write_size</span> <span class=\"number\">64k</span>;</span><br></pre></td></tr></table></figure>\n<h4 id=\"代理https请求\"><a class=\"markdownIt-Anchor\" href=\"#代理https请求\">#</a> 代理 https 请求</h4>\n<p>需要第三方模块</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2Nob2JpdHMvbmd4X2h0dHBfcHJveHlfY29ubmVjdF9tb2R1bGU=\">https://github.com/chobits/ngx_http_proxy_connect_module</span></p>\n<p>配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server &#123;</span><br><span class=\"line\">    listen                         3128;</span><br><span class=\"line\"></span><br><span class=\"line\">    # dns resolver used by forward proxying</span><br><span class=\"line\">    resolver                       8.8.8.8;</span><br><span class=\"line\"></span><br><span class=\"line\">    # forward proxy for CONNECT request</span><br><span class=\"line\">    proxy_connect;</span><br><span class=\"line\">    proxy_connect_allow            443 563;</span><br><span class=\"line\">    proxy_connect_connect_timeout  10s;</span><br><span class=\"line\">    proxy_connect_read_timeout     10s;</span><br><span class=\"line\">    proxy_connect_send_timeout     10s;</span><br><span class=\"line\"></span><br><span class=\"line\">    # forward proxy for non-CONNECT request</span><br><span class=\"line\">    location / &#123;</span><br><span class=\"line\">        proxy_pass http://$host;</span><br><span class=\"line\">        proxy_set_header Host $host;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"负载均衡\"><a class=\"markdownIt-Anchor\" href=\"#负载均衡\">#</a> 负载均衡</h2>\n<p>系统的扩展分为纵向扩展和横向扩展</p>\n<p>纵向扩展是从单机的角度出发，通过增加系统的硬件处理能力来提升服务器的处理能力</p>\n<blockquote>\n<blockquote>\n<p>云服务资源增加</p>\n<p>・整机：IBM、浪潮、DELL、HP 等</p>\n<p>・CPU / 主板：更新到主流</p>\n<p>・网卡：10G/40G 网卡</p>\n<p>・磁盘：SAS (SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、</p>\n<p>MVMe SSD</p>\n<p>• SSD</p>\n<p>・多副本机制</p>\n<p>・系统盘 / 热点数据 / 数据库存储</p>\n<p>• HDD</p>\n<p>・冷数据存储</p>\n</blockquote>\n</blockquote>\n<p>横向扩展是通过添加机器来满足大型网站服务的处理能力。</p>\n<blockquote>\n<p>会话管理</p>\n<p>・Nginx 高级负载均衡</p>\n<p>• ip_hash</p>\n<p>・其他 Hash</p>\n<p>• hash $cookie_jsessionid;</p>\n<p>• hash $request_uri;</p>\n<p>・使用 lua 逻辑定向分发</p>\n<p>• Redis + SpringSession</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418100400412.png\" alt=\"image-20230418100400412\"></p>\n<p>应用集群：将同一应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理并返回响应的数据。</p>\n<p>负载均衡器：将用户访问的请求根据对应的负载均衡算法，分发到集群中的一台服务器进行处理。</p>\n<p>负载均衡作用：</p>\n<p>1、解决服务器的高并发压力，提高应用程序的处理性能。</p>\n<p>2、提供故障转移，实现高可用。</p>\n<p>3、通过添加或减少服务器数量，增强网站的可扩展性。</p>\n<p>4、在负载均衡器上进行过滤，可以提高系统的安全性。</p>\n<p>负载均衡常用方式：</p>\n<p><strong>用户手动选择</strong>，比如下载时选择电信、联通</p>\n<p>DNS 轮询 ：对同一个主机名添加多条 A 记录，这就是 DNS 轮询，DNS 服务器将解析请求按照 A 记录的顺序，随机分配到不同的 IP 上，这样就能完成简单的负载均衡。DNS 轮询的成本非常低，在一些不重要的服务器，被经常使用。</p>\n<p>1. 可靠性低</p>\n<p>假设一个域名 DNS 轮询多台服务器，如果其中的一台服务器发生故障，那么所有的访问该服务器的请求将不会有所回应，即使你将该服务器的 IP 从 DNS 中去掉，但是由于各大宽带接入商将众多的 DNS 存放在缓存中，以节省访问时间，导致 DNS 不会实时更新。所以 DNS 轮流上一定程度上解决了负载均衡问题，但是却存在可靠性不高的缺点。</p>\n<p>2. 负载均衡不均衡</p>\n<p>DNS 负载均衡采用的是简单的轮询负载算法，不能区分服务器的差异，不能反映服务器的当前运行状态，不能做到为性能好的服务器多分配请求，另外本地计算机也会缓存已经解析的域名到 IP 地址的映射，这也会导致使用该 DNS 服务器的用户在一定时间内访问的是同一台 Web 服务器，从而引发 Web 服务器减的负载不均衡。</p>\n<p>负载不均衡则会导致某几台服务器负荷很低，而另外几台服务器负荷确很高，处理请求的速度慢，配置高的服务器分配到的请求少，而配置低的服务器分配到的请求多。</p>\n<p><strong>四层 / 七层负载均衡</strong></p>\n<h3 id=\"四层负载均衡-七层负载均衡\"><a class=\"markdownIt-Anchor\" href=\"#四层负载均衡-七层负载均衡\">#</a> 四层负载均衡 / 七层负载均衡</h3>\n<p>所谓四层负载均衡指的是 OSI 七层模型中的传输层，主要是基于 IP+PORT 的负载均衡</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">实现四层负载均衡的方式：</span><br><span class=\"line\">硬件：F5 BIG-IP、Radware等</span><br><span class=\"line\">软件：LVS、Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>\n<p>所谓的七层负载均衡指的是在应用层，主要是基于虚拟的 URL 或主机 IP 的负载均衡</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">实现七层负载均衡的方式：</span><br><span class=\"line\">软件：Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>\n<p>四层和七层负载均衡的区别</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">四层负载均衡数据包是在底层就进行了分发，而七层负载均衡数据包则在最顶端进行分发，所以四层负载均衡的效率比七层负载均衡的要高。</span><br><span class=\"line\">四层负载均衡不识别域名，而七层负载均衡识别域名。</span><br></pre></td></tr></table></figure>\n<p>其实还有二层、三层负载均衡，二层是在数据链路层基于 mac 地址来实现负载均衡，三层是在网络层一般采用虚拟 IP 地址的方式实现负载均衡。</p>\n<p>实际会采用： 四层负载 (LVS)+ 七层负载 (Nginx)</p>\n<p><strong>七层负载均衡</strong></p>\n<p>Nginx 的负载均衡是在 Nginx 的反向代理基础上把用户的请求根据指定的算法分发到一组【upstream 虚拟服务池】。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> 该指令是用来定义一组服务器，它们可以是监听不同端口的服务器，并且也可以是同时监听TCP和Unix socket的服务器。服务器可以指定不同的权重，默认为<span class=\"number\">1</span>。</span><br><span class=\"line\">位置http</span><br><span class=\"line\"></span><br><span class=\"line\">server 该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者unix socket</span><br><span class=\"line\">位置<span class=\"section\">upstream</span></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418101020006.png\" alt=\"image-20230418101020006\"></p>\n<p>该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者 unix socket</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> backend&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9091</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9092</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9093</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">\t<span class=\"section\">location</span> /&#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>代理服务器在负责均衡调度中的状态有以下几个：</p>\n<table>\n<thead>\n<tr>\n<th>状态</th>\n<th>概述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>down</td>\n<td>当前的 server 暂时不参与负载均衡，该状态一般会对需要停机维护的服务器进行设置。</td>\n</tr>\n<tr>\n<td>backup</td>\n<td>预留的备份服务器，当主服务器不可用时，将用来传递请求。</td>\n</tr>\n<tr>\n<td>max_fails</td>\n<td>允许请求失败的次数，默认为 1</td>\n</tr>\n<tr>\n<td>fail_timeout</td>\n<td>经过 max_fails 失败后，服务暂停时间，默认是 10 秒</td>\n</tr>\n<tr>\n<td>max_conns</td>\n<td>限制最大的接收连接数，默认为 0，表示不限制，使用该配置可以根据后端服务器处理请求的并发量来进行设置，防止后端服务器被压垮。</td>\n</tr>\n</tbody>\n</table>\n<p>负载均衡策略</p>\n<p>Nginx 的 upstream 支持如下六种方式的分配算法，分别是:</p>\n<table>\n<thead>\n<tr>\n<th>算法名称</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>轮询</td>\n<td>默认方式</td>\n</tr>\n<tr>\n<td>weight</td>\n<td>权重方式，权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的，所有此策略比较适合服务器的硬件配置差别比较大的情况</td>\n</tr>\n<tr>\n<td>ip_hash</td>\n<td>先 hash，再和后端服务器的数量取余，得到的值就是需要转发到后端的服务器。不适用于局域网项目，即多用户共享 IP 的场景。容易造成流量倾斜。后端服务器宕机导致 session 丢失。适用于中小型项目，快速扩容。                                                                                                                 依据 ip 分配方式。能够将某个客户端 IP 的请求通过哈希算法定位到同一台后端服务器上。这样，当来自某一个 IP 的用户在后端 Web 服务器 A 上登录后，在访问该站点的其他 URL，能保证其访问的还是后端 web 服务器 A。ip_hash 指令无法保证后端服务器的负载均衡，可能导致有些后端服务器接收到的请求多，有些后端服务器接收的请求少，而且设置后端服务器权重等方法将不起作用。</td>\n</tr>\n<tr>\n<td>least_conn</td>\n<td>依据最少连接方式。有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn 这种方式就可以达到更好的负载均衡效果。</td>\n</tr>\n<tr>\n<td>url_hash</td>\n<td>依据 URL 分配方式。url_hash 按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，要配合缓存命中来使用。同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。而使用 url_hash，可以使得同一个 url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取。</td>\n</tr>\n<tr>\n<td>fair</td>\n<td>依据响应时间方式。可以根据页面大小、加载时间长短智能的进行负载均衡。</td>\n</tr>\n<tr>\n<td>$request_uri</td>\n<td>适用于不支持 cookie 的情况下。资源不平均分配：只需要算出 hash 将资源放到对应的服务器</td>\n</tr>\n<tr>\n<td>$cookie_jsessionid</td>\n<td>sessionid 只有 tomcat 才有，并且 hash 的是 value</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> backend&#123;</span><br><span class=\"line\">\tip_hash;</span><br><span class=\"line\">     <span class=\"comment\"># hash $request_uri;</span></span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9001</span> weight=<span class=\"number\">2</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9002</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9003</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span> <span class=\"number\">8083</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">\t<span class=\"section\">location</span> /&#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>fair</p>\n<p>fair 采用的不是内建负载均衡使用的轮换的均衡算法，而是可以根据页面大小、加载时间长短智能的进行负载均衡。那么如何使用第三方模块的 fair 负载均衡策略。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> backend &#123;</span><br><span class=\"line\">    fair;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">https://github.com/gnosek/nginx-<span class=\"section\">upstream</span>-fair</span><br><span class=\"line\">./configure --add-module=/root/fair</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在Nginx的源码中 src/http/ngx_http_upstream.h,找到ngx_http_upstream_srv_conf_s，在模块中添加添加default_port属性</span><br><span class=\"line\"></span><br><span class=\"line\">in_port_t\t   default_port</span><br><span class=\"line\"></span><br><span class=\"line\">make </span><br><span class=\"line\">make upgrade</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 实现带有URL重写的负载均衡</span></span><br><span class=\"line\"><span class=\"section\">upstream</span> backend&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9001</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9002</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:9003</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span>\t<span class=\"number\">80</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">\t<span class=\"section\">location</span> /file/ &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">rewrite</span><span class=\"regexp\"> ^(/file/.*)</span> /server/<span class=\"variable\">$1</span> <span class=\"literal\">last</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"stick-实现cookie-负载均衡\"><a class=\"markdownIt-Anchor\" href=\"#stick-实现cookie-负载均衡\">#</a> stick 实现 cookie 负载均衡</h3>\n<p>Sticky 是 nginx 的一个模块，它是基于 cookie 的一种 nginx 的负载均衡解决方案，通过分发和识别 cookie，来使同一个客户端的请求落在同一台服务器上，默认标识名为 route</p>\n<blockquote>\n<p>客户端首次发起访问请求，nginx 接收后，发现请求头没有 cookie，则以轮询方式将请求分发给后端服务器。</p>\n<p>后端服务器处理完请求，将响应数据返回给 nginx。</p>\n<p>此时 nginx 生成带 route 的 cookie，返回给客户端。route 的值与后端服务器对应，可能是明文，也可能是 md5、sha1 等 Hash 值</p>\n<p>客户端接收请求，并保存带 route 的 cookie。</p>\n<p>当客户端下一次发送请求时，会带上 route，nginx 根据接收到的 cookie 中的 route 值，转发给对应的后端服务器。</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iaXRidWNrZXQub3JnL25naW54LWdvb2RpZXMvbmdpbngtc3RpY2t5LW1vZHVsZS1uZy9zcmMvbWFzdGVyLw==\">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/</span></p>\n<p>依赖 <code>openssl-devel</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br></pre></td></tr></table></figure>\n<p>打开  <code>ngx_http_sticky_misc.c</code>  文件</p>\n<p>在 12 行添加</p>\n<figure class=\"highlight c\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;openssl/sha.h&gt;</span></span></span><br><span class=\"line\"><span class=\"meta\">#<span class=\"keyword\">include</span> <span class=\"string\">&lt;openssl/md5.h&gt;</span></span></span><br></pre></td></tr></table></figure>\n<p><strong>备份之前的程序</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br></pre></td></tr></table></figure>\n<p><strong>把编译好的 Nginx 程序替换到原来的目录里</strong></p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>\n<p><strong>升级检测</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">make upgrade</span><br></pre></td></tr></table></figure>\n<p>检查程序中是否包含新模块</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nginx -V</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> httpds &#123;</span><br><span class=\"line\">       <span class=\"attribute\">sticky</span> name=shabi expires=<span class=\"number\">6h</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.155:8080</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.166:8080</span>;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">       <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">       <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#charset koi8-r;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"comment\">#access_log  logs/host.access.log  main;</span></span><br><span class=\"line\"></span><br><span class=\"line\">       <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">               <span class=\"attribute\">proxy_pass</span> http://httpds;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">      <span class=\"section\">location</span> ~*/(js|img|css) &#123;</span><br><span class=\"line\">               <span class=\"attribute\">root</span>   /usr/local/nginx/html;</span><br><span class=\"line\">           &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>浏览器多标签会共享 cookie，且名字不好和 JESEEIONID 重复</p>\n<p>原理是在 cookie 中加入一个字段，从会话保持，也能维持静态会话</p>\n<h3 id=\"四层负载均衡\"><a class=\"markdownIt-Anchor\" href=\"#四层负载均衡\">#</a> 四层负载均衡</h3>\n<p>Nginx 在 1.9 之后，增加了一个 stream 模块，用来实现四层协议的转发、代理、负载均衡等。stream 模块的用法跟 http 的用法类似，允许我们配置一组 TCP 或者 UDP 等协议的监听，然后通过 proxy_pass 来转发我们的请求，通过 upstream 添加多个后端服务，实现负载均衡。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418102743685.png\" alt=\"image-20230418102743685\"></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--with-<span class=\"attribute\">stream</span></span><br><span class=\"line\"><span class=\"comment\"># stream指令 该指令提供在其中指定流服务器指令的配置文件上下文。和http指令同级。</span></span><br><span class=\"line\"><span class=\"comment\"># 位置main</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># upstream指令 该指令和http的upstream指令是类似的</span></span><br><span class=\"line\"></span><br><span class=\"line\">stream &#123;</span><br><span class=\"line\">    <span class=\"section\">upstream</span> backend &#123;</span><br><span class=\"line\">        <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.155:8888</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.155:8889</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">upstream</span> backendtomcat &#123;</span><br><span class=\"line\">        <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.155:8080</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">81</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> backend;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">82</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_pass</span> backendtomcat;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>四层和七层都有，四层优先</p>\n<h2 id=\"缓存\"><a class=\"markdownIt-Anchor\" href=\"#缓存\">#</a> 缓存</h2>\n<p>缓存就是数据交换的缓冲区 (称作：Cache), 当用户要获取数据的时候，会先从缓存中去查询获取数据，如果缓存中有就会直接返回给用户，如果缓存中没有，则会发请求从服务器重新查询数据，将数据返回给用户的同时将数据放入缓存，下次用户就会直接从缓存中获取数据。</p>\n<table>\n<thead>\n<tr>\n<th>场景</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>操作系统磁盘缓存</td>\n<td>减少磁盘机械操作</td>\n</tr>\n<tr>\n<td>数据库缓存</td>\n<td>减少文件系统的 IO 操作</td>\n</tr>\n<tr>\n<td>应用程序缓存</td>\n<td>减少对数据库的查询</td>\n</tr>\n<tr>\n<td>Web 服务器缓存</td>\n<td>减少对应用服务器请求次数</td>\n</tr>\n<tr>\n<td>浏览器缓存</td>\n<td>减少与后台的交互次数</td>\n</tr>\n</tbody>\n</table>\n<p>缓存的优点</p>\n<p>​\t1. 减少数据传输，节省网络流量，加快响应速度，提升用户体验；</p>\n<p>​\t2. 减轻服务器压力；</p>\n<p>​\t3. 提供服务端的高可用性；</p>\n<p>缓存的缺点</p>\n<p>​\t1. 数据的不一致</p>\n<p>​\t2. 增加成本</p>\n<h4 id=\"浏览器缓存\"><a class=\"markdownIt-Anchor\" href=\"#浏览器缓存\">#</a> 浏览器缓存</h4>\n<h5 id=\"什么时候可以用缓存\"><a class=\"markdownIt-Anchor\" href=\"#什么时候可以用缓存\">#</a> 什么时候可以用缓存？</h5>\n<ol>\n<li>不常改变的内容</li>\n<li>过期时间</li>\n<li>针对 post/get 请求都可以</li>\n<li>存储位置</li>\n<li>磁盘使用空间限制</li>\n</ol>\n<ul>\n<li>deskcache</li>\n</ul>\n<p>字面理解是从内存中，其实也是字面的含义，这个资源是直接从内存中拿到的，<strong>不会请求服务器</strong>一般已经加载过该资源且缓存在了内存当中，当关闭该页面时，此资源就被内存释放掉了，再次重新打开相同页面时不会出现 from memory cache 的情况</p>\n<ul>\n<li>memorycache</li>\n</ul>\n<p>是从磁盘当中取出的，也是在已经在之前的某个时间加载过该资源，<strong>不会请求服务器</strong>但是此资源不会随着该页面的关闭而释放掉，因为是存在硬盘当中的，下次打开仍会 from disk cache</p>\n<h5 id=\"age\"><a class=\"markdownIt-Anchor\" href=\"#age\">#</a> Age</h5>\n<p>是 CDN 添加的属性表示在 CDN 中缓存了多少秒</p>\n<h5 id=\"via\"><a class=\"markdownIt-Anchor\" href=\"#via\">#</a> <strong>via</strong></h5>\n<p>用来标识 CDN 缓存经历了哪些服务器，缓存是否命中，使用的协议</p>\n<h4 id=\"强制缓存与协商缓存\"><a class=\"markdownIt-Anchor\" href=\"#强制缓存与协商缓存\">#</a> 强制缓存与协商缓存</h4>\n<p>强制缓存：直接从本机读取，不请求服务器</p>\n<p>协商缓存：发送请求 header 中携带 Last-Modified，服务器可能会返回 304 Not Modified</p>\n<h4 id=\"浏览器强制缓存\"><a class=\"markdownIt-Anchor\" href=\"#浏览器强制缓存\">#</a> 浏览器强制缓存</h4>\n<h5 id=\"cache-control\"><a class=\"markdownIt-Anchor\" href=\"#cache-control\">#</a> <strong>cache-control</strong></h5>\n<p>http1.1 的规范，使用 max-age 表示文件可以在浏览器中缓存的时间以秒为单位</p>\n<table>\n<thead>\n<tr>\n<th>标记</th>\n<th>类型</th>\n<th>功能</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>public</td>\n<td>响应头</td>\n<td>响应的数据可以被缓存，客户端和代理层都可以缓存</td>\n</tr>\n<tr>\n<td>private</td>\n<td>响应头</td>\n<td>可私有缓存，客户端可以缓存，代理层不能缓存（CDN，proxy_pass）</td>\n</tr>\n<tr>\n<td>no-cache</td>\n<td>请求头</td>\n<td>可以使用本地缓存，但是必须发送请求到服务器回源验证</td>\n</tr>\n<tr>\n<td>no-store</td>\n<td>请求和响应</td>\n<td>应禁用缓存</td>\n</tr>\n<tr>\n<td>max-age</td>\n<td>请求和响应</td>\n<td>文件可以在浏览器中缓存的时间以秒为单位</td>\n</tr>\n<tr>\n<td>s-maxage</td>\n<td>请求和响应</td>\n<td>用户代理层缓存，CDN 下发，当客户端数据过期时会重新校验</td>\n</tr>\n<tr>\n<td>max-stale</td>\n<td>请求和响应</td>\n<td>缓存最大使用时间，如果缓存过期，但还在这个时间范围内则可以使用缓存数据</td>\n</tr>\n<tr>\n<td>min-fresh</td>\n<td>请求和响应</td>\n<td>缓存最小使用时间，</td>\n</tr>\n<tr>\n<td>must-revalidate</td>\n<td>请求和响应</td>\n<td>当缓存过期后，必须回源重新请求资源。比 no-cache 更严格。因为 HTTP 规范是允许客户端在某些特殊情况下直接使用过期缓存的，比如校验请求发送失败的时候。那么带有 must-revalidate 的缓存必须校验，其他条件全部失效。</td>\n</tr>\n<tr>\n<td>proxy-revalidate</td>\n<td>请求和响应</td>\n<td>和 must-revalidate 类似，只对 CDN 这种代理服务器有效，客户端遇到此头，需要回源验证</td>\n</tr>\n<tr>\n<td>stale-while-revalidate</td>\n<td>响应</td>\n<td>表示在指定时间内可以先使用本地缓存，后台进行异步校验</td>\n</tr>\n<tr>\n<td>stale-if-error</td>\n<td>响应</td>\n<td>在指定时间内，重新验证时返回状态码为 5XX 的时候，可以用本地缓存</td>\n</tr>\n<tr>\n<td>only-if-cached</td>\n<td>响应</td>\n<td>那么只使用缓存内容，如果没有缓存 则 504 getway timeout</td>\n</tr>\n</tbody>\n</table>\n<p>在浏览器和服务器端验证文件是否过期的时候，浏览器在二次请求的时候会携带 IF-Modified-Since 属性</p>\n<h5 id=\"expires\"><a class=\"markdownIt-Anchor\" href=\"#expires\">#</a> Expires</h5>\n<p>过期时间</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">expires 30s;   #缓存30秒</span><br><span class=\"line\">expires 30m;  #缓存30分钟   </span><br><span class=\"line\">expires 2h;     #缓存2小时</span><br><span class=\"line\">expires 30d;    #缓存30天</span><br></pre></td></tr></table></figure>\n<h4 id=\"协商缓存\"><a class=\"markdownIt-Anchor\" href=\"#协商缓存\">#</a> 协商缓存</h4>\n<h5 id=\"last-modified\"><a class=\"markdownIt-Anchor\" href=\"#last-modified\">#</a> <strong>last-modified</strong></h5>\n<h5 id=\"etag\"><a class=\"markdownIt-Anchor\" href=\"#etag\">#</a> <strong>etag</strong></h5>\n<p>http1.1 支持</p>\n<p>在 HTTP 协议中 If-Modified-Since 和 If-None-Match 分别对应 Last-Modified 和 ETag</p>\n<p>Entity Tag 的缩写，中文译过来就是实体标签的意思.</p>\n<p>HTTP 中并没有指定如何生成 ETag，哈希是比较理想的选择。</p>\n<p>在计算 Etag 的时候，会产生 CPU 的耗费，所以也可以用时间戳，但这样直接使用 Last-Modified 即可。</p>\n<p>ETag 用来校验用户请求的资源是否有变化，作用和 lastmodified 很像，区别是 lastmodified 精确到秒，ETag 可以用 hash 算法来生成更精确的比对内容。</p>\n<p>当用户首次请求资源的时候返回给用户数据和 200 状态码并生成 ETag，再次请求的时候服务器比对 ETag，没有发生变化的话返回 304</p>\n<p>Cache-Control 直接是通过不请求来实现，而 ETag 是会发请求的，只不过服务器根据请求的东西的内容有无变化来判断是否返回请求的资源</p>\n<h4 id=\"cache-control-expires-强制缓存\"><a class=\"markdownIt-Anchor\" href=\"#cache-control-expires-强制缓存\">#</a> cache-control expires 强制缓存</h4>\n<p>页面首次打开，直接读取缓存数据，刷新，会向服务器发起请求</p>\n<h4 id=\"etag-lastmodify-协商缓存\"><a class=\"markdownIt-Anchor\" href=\"#etag-lastmodify-协商缓存\">#</a> etag lastmodify  协商缓存</h4>\n<p>没发生变化 返回 304 不发送数据</p>\n<h4 id=\"浏览器缓存原则\"><a class=\"markdownIt-Anchor\" href=\"#浏览器缓存原则\">#</a> 浏览器缓存原则</h4>\n<ul>\n<li>\n<p>多级集群负载时 last-modified 必须保持一致</p>\n</li>\n<li>\n<p>还有一些场景下我们希望禁用浏览器缓存。比如轮训 api 上报数据数据</p>\n</li>\n<li>\n<p>浏览器缓存很难彻底禁用，大家的做法是加版本号，随机数等方法。</p>\n</li>\n<li>\n<p>只缓存 200 响应头的数据，像 3XX 这类跳转的页面不需要缓存。</p>\n</li>\n<li>\n<p>对于 js，css 这类可以缓存很久的数据，可以通过加版本号的方式更新内容</p>\n</li>\n<li>\n<p>不需要强一致性的数据，可以缓存几秒</p>\n</li>\n<li>\n<p>异步加载的接口数据，可以使用 ETag 来校验。</p>\n</li>\n<li>\n<p>在服务器添加 Server 头，有利于排查错误</p>\n</li>\n<li>\n<p>分为手机 APP 和 Client 以及是否遵循 http 协议</p>\n</li>\n<li>\n<p>在没有联网的状态下可以展示数据</p>\n</li>\n<li>\n<p>流量消耗过多</p>\n</li>\n<li>\n<p>提前下发  避免秒杀时同时下发数据造成流量短时间暴增</p>\n</li>\n<li>\n<p>兜底数据 在服务器崩溃和网络不可用的时候展示</p>\n</li>\n<li>\n<p>临时缓存  退出即清理</p>\n</li>\n<li>\n<p>固定缓存  展示框架这种，可能很长时间不会更新，可用随客户端下发</p>\n<ul>\n<li><strong>首页</strong>有的时候可以看做是框架 应该禁用缓存，以保证加载的资源都是最新的</li>\n</ul>\n</li>\n<li>\n<p>父子连接 页面跳转时有一部分内容不需要重新加载，可用从父菜单带过来</p>\n</li>\n<li>\n<p>预加载     某些逻辑可用判定用户接下来的操作，那么可用异步加载那些资源</p>\n</li>\n<li>\n<p>漂亮的加载过程 异步加载 先展示框架，然后异步加载内容，避免主线程阻塞</p>\n</li>\n</ul>\n<p>Nginx 是从 0.7.48 版开始提供缓存功能。Nginx 是基于 Proxy Store 来实现的，其原理是把 URL 及相关组合当做 Key, 在使用 MD5 算法对 Key 进行哈希，得到硬盘上对应的哈希目录路径，从而将缓存内容保存在该目录中。它可以支持任意 URL 连接，同时也支持 404/301/302 这样的非 200 状态码。Nginx 即可以支持对指定 URL 或者状态码设置过期时间，也可以使用 purge 命令来手动清除指定 URL 的缓存。</p>\n<p>Nginx 的 web 缓存服务主要是使用 <code>ngx_http_proxy_module</code>  模块相关指令集来完成</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># proxy_cache_path 该指定用于设置缓存文件的存放路径</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_cache_path</span> /usr/local/proxy_cache keys_zone=itcast:<span class=\"number\">200m</span>  levels=<span class=\"number\">1</span>:<span class=\"number\">2</span> inactive=<span class=\"number\">1d</span> max_size=<span class=\"number\">20g</span>;</span><br><span class=\"line\">再加两层目录，第一层一个字母，第二层两个字母</span><br><span class=\"line\">缓存名称，大小</span><br><span class=\"line\">缓存超时时间，未被访问就会删除</span><br><span class=\"line\">设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_cache 该指令用来开启或关闭代理缓存，如果是开启则自定使用哪个缓存区来进行缓存。</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http、server、location</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_cache</span> itcast</span><br><span class=\"line\"><span class=\"comment\"># 这个名字需要和上面定义的keys_zone的名字相同</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_cache_key 该指令用来设置web缓存的key值，Nginx会根据key值MD5哈希存缓存</span></span><br><span class=\"line\"><span class=\"comment\"># 默认值 proxy_cache_key \\$scheme\\$proxy_host$request_uri;</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http、server、location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_cache_vaild 该指令用来对不同返回状态码的URL设置不同的缓存时间</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http、server、location</span></span><br><span class=\"line\">proxy_cache_valid <span class=\"number\">200</span> <span class=\"number\">302</span> <span class=\"number\">10m</span>;</span><br><span class=\"line\"><span class=\"attribute\">proxy_cache_valid</span> <span class=\"number\">404</span> <span class=\"number\">1m</span>;</span><br><span class=\"line\"><span class=\"comment\"># 为200和302的响应URL设置10分钟缓存，为404的响应URL设置1分钟缓存</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_cache_valid</span> any <span class=\"number\">1m</span>;</span><br><span class=\"line\"><span class=\"comment\"># 对所有响应状态码的URL都设置1分钟缓存</span></span><br><span class=\"line\"><span class=\"comment\"># 最小匹配优先</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_cache_min_uses 该指令用来设置资源被访问多少次后被缓存</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http、server、location</span></span><br><span class=\"line\">默认值为1</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># proxy_cache_methdos 该指令用户设置缓存哪些HTTP方法</span></span><br><span class=\"line\"><span class=\"comment\"># 位置http、server、location</span></span><br><span class=\"line\">默认值为<span class=\"attribute\">GET</span> HEAD  ，支持get head post</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 断点续传缓存 range</span></span><br><span class=\"line\">当有完整的content-length之后即可断点续传</span><br><span class=\"line\">在反向代理服务器中需向后传递header</span><br><span class=\"line\"></span><br><span class=\"line\">proxy_set_header Range <span class=\"variable\">$http_range</span>;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418103348767.png\" alt=\"image-20230418103348767\"></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">proxy_cache_path</span> /usr/local/proxy_cache levels=<span class=\"number\">2</span>:<span class=\"number\">1</span> keys_zone=itcast:<span class=\"number\">200m</span> inactive=<span class=\"number\">1d</span> max_size=<span class=\"number\">20g</span>;</span><br><span class=\"line\">\t<span class=\"section\">upstream</span> backend&#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:8080</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"section\">server</span> &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">listen</span>       <span class=\"number\">8080</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">        <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        \t<span class=\"attribute\">proxy_cache</span> itcast;</span><br><span class=\"line\">            <span class=\"comment\"># 建议使用默认值$schema$proxy_host$request_uri; 相同的proxy_cache_key会出现问题，即该location下不同uri会返回相同的缓存</span></span><br><span class=\"line\">            <span class=\"attribute\">proxy_cache_key</span> it;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_cache_min_uses</span> <span class=\"number\">5</span>;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_cache_valid</span> <span class=\"number\">200</span> <span class=\"number\">5d</span>;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_cache_valid</span> <span class=\"number\">404</span> <span class=\"number\">30s</span>;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_cache_valid</span> any <span class=\"number\">1m</span>;</span><br><span class=\"line\">            <span class=\"attribute\">add_header</span> nginx-cache <span class=\"string\">&quot;<span class=\"variable\">$upstream_cache_status</span>&quot;</span>;</span><br><span class=\"line\">        \t<span class=\"attribute\">proxy_pass</span> http://backend/js/;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"删除缓存\"><a class=\"markdownIt-Anchor\" href=\"#删除缓存\">#</a> 删除缓存</h3>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.<span class=\"attribute\">rm</span> -rf /usr/local/proxy_cache/......</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">2</span>.使用ngx_cache_purge</span><br><span class=\"line\">ngx_cache_purge-<span class=\"number\">2</span>.<span class=\"number\">3</span>.tar.gz</span><br><span class=\"line\">./configure --add-module=/root/nginx/module/purge</span><br><span class=\"line\">server &#123;</span><br><span class=\"line\">    <span class=\"attribute\">listen</span>       <span class=\"number\">8080</span>;</span><br><span class=\"line\">    <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">    <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_cache</span> xixi;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_cache_key</span> haha;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">server&#123;    </span><br><span class=\"line\">    <span class=\"section\">location</span> ~/purge(/.*) &#123; </span><br><span class=\"line\">        <span class=\"comment\"># proxy_cache=name  peoxy_cache_key=key  上下两个key需要一样</span></span><br><span class=\"line\">        <span class=\"attribute\">proxy_cache_purge</span> xixi haha;    </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"设置资源不缓存\"><a class=\"markdownIt-Anchor\" href=\"#设置资源不缓存\">#</a> 设置资源不缓存</h3>\n<p>比如说对于一些经常发生变化的数据。如果进行缓存的话，就很容易出现用户访问到的数据不是服务器真实的数据。所以对于这些资源我们在缓存的过程中就需要进行过滤，不进行缓存。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 配置位置http,server,location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#proxy_no_cache</span></span><br><span class=\"line\"><span class=\"comment\">#该指令是用来定义不将数据进行缓存的条件。</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_no_cache</span> <span class=\"variable\">$cookie_nocache</span> <span class=\"variable\">$arg_nocache</span> <span class=\"variable\">$arg_comment</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#proxy_cache_bypass</span></span><br><span class=\"line\"><span class=\"comment\">#该指令是用来设置不从缓存中获取数据的条件。</span></span><br><span class=\"line\"><span class=\"attribute\">proxy_cache_bypass</span> <span class=\"variable\">$cookie_nocache</span> <span class=\"variable\">$arg_nocache</span> <span class=\"variable\">$arg_comment</span>;</span><br></pre></td></tr></table></figure>\n<p>上述两个指令都有一个指定的条件，这个条件可以是多个，并且多个条件中至少有一个不为空且不等于 &quot;0&quot;, 则条件满足成立。里面使用到了三个变量，分别是 $cookie_nocache、$arg_nocache、$arg_comment</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$<span class=\"attribute\">cookie_nocache</span></span><br><span class=\"line\">指的是当前请求的cookie中键的名称为nocache对应的值</span><br><span class=\"line\"><span class=\"variable\">$arg_nocache</span>和<span class=\"variable\">$arg_comment</span></span><br><span class=\"line\">指的是当前请求的参数中属性名为nocache和comment对应的属性值</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">server&#123;</span><br><span class=\"line\">\t<span class=\"attribute\">listen</span>\t<span class=\"number\">8080</span>;</span><br><span class=\"line\">\t<span class=\"attribute\">server_name</span> localhost;</span><br><span class=\"line\">\t<span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">\t\t<span class=\"attribute\">if</span> (<span class=\"variable\">$request_uri</span> <span class=\"regexp\">~ /.*\\.js$)</span>&#123;</span><br><span class=\"line\">           <span class=\"attribute\">set</span> <span class=\"variable\">$nocache</span> <span class=\"number\">1</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">\t   <span class=\"attribute\">proxy_no_cache</span> <span class=\"variable\">$nocache</span> <span class=\"variable\">$cookie_nocache</span> <span class=\"variable\">$arg_nocache</span> <span class=\"variable\">$arg_comment</span>;</span><br><span class=\"line\">        <span class=\"attribute\">proxy_cache_bypass</span> <span class=\"variable\">$nocache</span> <span class=\"variable\">$cookie_nocache</span> <span class=\"variable\">$arg_nocache</span> <span class=\"variable\">$arg_comment</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>或者通过 url 指定后面两个参数</p>\n<p>/jquery.js?nocache=1</p>\n<p>/jquery.js?comment=1</p>\n<p>都不会缓存或者使用 set cookie 中的 nocache</p>\n<p>上面三个变量只要不是 0 就行</p>\n<p>推荐两个都用 proxy_no_cache proxy_cache_bypass</p>\n<h2 id=\"动静分离\"><a class=\"markdownIt-Anchor\" href=\"#动静分离\">#</a> 动静分离</h2>\n<p>动：后台应用程序的业务处理</p>\n<p>静：网站的静态资源 (html,javaScript,css,images 等文件)</p>\n<p>分离：将两者进行分开部署访问，提供用户进行访问。举例说明就是以后所有和静态资源相关的内容都交给 Nginx 来部署访问，非静态内容则交个类似于 Tomcat 的服务器来部署访问。</p>\n<p>Nginx 在处理静态资源的时候，效率是非常高的，而且 Nginx 的并发访问量也是名列前茅，而 Tomcat 则相对比较弱一些，所以把静态资源交个 Nginx 后，可以减轻 Tomcat 服务器的访问压力并提高静态资源的访问速度。</p>\n<p>动静分离以后，降低了动态资源和静态资源的耦合度。如动态资源宕机了也不影响静态资源的展示。</p>\n<p>实现动静分离的方式很多，比如静态资源可以部署到 CDN、Nginx 等服务器上，动态资源可以部署到 Tomcat,weblogic 或者 websphere 上。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 将后端服务器上的静态资源删除</span></span><br><span class=\"line\"><span class=\"comment\"># 把后端服务器上的静态资源放到nginx上</span></span><br><span class=\"line\"><span class=\"section\">upstream</span> webservice&#123;</span><br><span class=\"line\">   <span class=\"attribute\">server</span> <span class=\"number\">192.168.200.146:8080</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">#动态资源</span></span><br><span class=\"line\">        <span class=\"section\">location</span> /demo &#123;</span><br><span class=\"line\">                <span class=\"attribute\">proxy_pass</span> http://webservice;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">#静态资源</span></span><br><span class=\"line\">        <span class=\"section\">location</span> ~/.*\\.(png|jpg|gif|js)&#123;</span><br><span class=\"line\">                <span class=\"attribute\">root</span> html/web;</span><br><span class=\"line\">                <span class=\"attribute\">gzip</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">            <span class=\"attribute\">root</span>   html/web;</span><br><span class=\"line\">            <span class=\"attribute\">index</span>  index.html index.htm;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"keepalived\"><a class=\"markdownIt-Anchor\" href=\"#keepalived\">#</a> keepalived</h2>\n<p>Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</p>\n<p>1. 选择协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VRRP可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由1和VRRP路由2之间会有竞争选择，通过选择会产生一个Master路由和一个Backup路由。</span><br></pre></td></tr></table></figure>\n<p>2. 路由容错协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Master路由和Backup路由之间会有一个心跳检测，Master会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代Master成为新的Master。Master路由有一个特权就是虚拟路由和后端服务器都是通过Master进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听Master的状态</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418104426216.png\" alt=\"image-20230418104426216\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">步骤1:从官方网站下载keepalived,官网地址https://keepalived.org/</span><br><span class=\"line\">步骤2:将下载的资源上传到服务器</span><br><span class=\"line\">\tkeepalived-2.0.20.tar.gz</span><br><span class=\"line\">步骤3:创建keepalived目录，方便管理资源</span><br><span class=\"line\">\tmkdir keepalived</span><br><span class=\"line\">步骤4:将压缩文件进行解压缩，解压缩到指定的目录</span><br><span class=\"line\">\ttar -zxf keepalived-2.0.20.tar.gz -C keepalived/</span><br><span class=\"line\">步骤5:对keepalived进行配置，编译和安装</span><br><span class=\"line\">\tcd keepalived/keepalived-2.0.20</span><br><span class=\"line\">\t./configure --sysconf=/etc --prefix=/usr/local</span><br><span class=\"line\">\tmake &amp;&amp; make install</span><br><span class=\"line\"></span><br><span class=\"line\">或者直接：</span><br><span class=\"line\">yum install keepalived</span><br></pre></td></tr></table></figure>\n<p>打开 keepalived.conf 配置文件</p>\n<p>这里面会分三部，第一部分是 global 全局配置、第二部分是 vrrp 相关配置、第三部分是 LVS 相关配置。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">global全局部分：</span><br><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   <span class=\"comment\">#通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址</span></span><br><span class=\"line\">   notification_email &#123;</span><br><span class=\"line\">     tom@itcast.cn</span><br><span class=\"line\">     jerry@itcast.cn</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   <span class=\"comment\">#设置发件人的邮箱信息</span></span><br><span class=\"line\">   notification_email_from zhaomin@itcast.cn</span><br><span class=\"line\">   <span class=\"comment\">#指定smpt服务地址</span></span><br><span class=\"line\">   smtp_server 192.168.200.1</span><br><span class=\"line\">   <span class=\"comment\">#指定smpt服务连接超时时间</span></span><br><span class=\"line\">   smtp_connect_timeout 30</span><br><span class=\"line\">   <span class=\"comment\">#运行keepalived服务器的一个标识，可以用作发送邮件的主题信息</span></span><br><span class=\"line\">   router_id LVS_DEVEL</span><br><span class=\"line\">   </span><br><span class=\"line\">   <span class=\"comment\">#默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)</span></span><br><span class=\"line\">   vrrp_skip_check_adv_addr</span><br><span class=\"line\">   <span class=\"comment\">#严格遵守VRRP协议。</span></span><br><span class=\"line\">   vrrp_strict</span><br><span class=\"line\">   <span class=\"comment\">#在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0</span></span><br><span class=\"line\">   vrrp_garp_interval 0</span><br><span class=\"line\">   <span class=\"comment\">#在一个网卡上每组na消息之间的延迟时间，默认为0</span></span><br><span class=\"line\">   vrrp_gna_interval 0</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">VRRP部分，该部分可以包含以下四个子模块</span><br><span class=\"line\">1. vrrp_script</span><br><span class=\"line\">2. vrrp_sync_group</span><br><span class=\"line\">3. garp_group</span><br><span class=\"line\">4. vrrp_instance</span><br><span class=\"line\">我们会用到第一个和第四个，</span><br><span class=\"line\">#设置keepalived实例的相关信息，VI_1为VRRP实例名称</span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER  \t\t#有两个值可选MASTER主 BACKUP备</span><br><span class=\"line\">    interface ens33\t\t#vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]</span><br><span class=\"line\">    virtual_router_id 51#指定VRRP实例ID，范围是0-255</span><br><span class=\"line\">    priority 100\t\t#指定优先级，优先级高的将成为MASTER</span><br><span class=\"line\">    advert_int 1\t\t#指定发送VRRP通告的间隔，单位是秒</span><br><span class=\"line\">    authentication &#123;\t#vrrp之间通信的认证信息</span><br><span class=\"line\">        auth_type PASS\t#指定认证方式。PASS简单密码认证(推荐)</span><br><span class=\"line\">        auth_pass 1111\t#指定认证使用的密码，最多8位</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123; #虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个</span><br><span class=\"line\">        192.168.200.222</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">global_defs &#123;</span><br><span class=\"line\">   notification_email &#123;</span><br><span class=\"line\">        tom@itcast.cn</span><br><span class=\"line\">        jerry@itcast.cn</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">   notification_email_from zhaomin@itcast.cn</span><br><span class=\"line\">   smtp_server 192.168.200.1</span><br><span class=\"line\">   smtp_connect_timeout 30</span><br><span class=\"line\">   router_id keepalived1</span><br><span class=\"line\">   vrrp_skip_check_adv_addr</span><br><span class=\"line\">   vrrp_strict</span><br><span class=\"line\">   vrrp_garp_interval 0</span><br><span class=\"line\">   vrrp_gna_interval 0</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">\t</span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    interface ens33</span><br><span class=\"line\">    virtual_router_id 51</span><br><span class=\"line\">    priority 100</span><br><span class=\"line\">    advert_int 1</span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass 1111</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        192.168.200.222</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务，比如Nginx,如果Nginx出现异常了，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418112232876.png\" alt=\"image-20230418112232876\"></p>\n<p>要想让 vip 进行切换，就必须要把服务器上的 keepalived 进行关闭，而什么时候关闭 keepalived 呢？应该是在 keepalived 所在服务器的 nginx 出现问题后，把 keepalived 关闭掉，就可以让 VIP 执行另外一台服务器，但是现在这所有的操作都是通过手动来完成的，我们如何能让系统自动判断当前服务器的 nginx 是否正确启动，如果没有，要能让 VIP 自动进行 &quot;漂移&quot;</p>\n<p>keepalived 只能做到对网络故障和 keepalived 本身的监控，即当出现网络故障或者 keepalived 本身出现问题时，进行切换。但是这些还不够，我们还需要监控 keepalived 所在服务器上的其他业务，比如 Nginx, 如果 Nginx 出现异常了，仅仅 keepalived 保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。</p>\n<p>实现步骤:</p>\n<ol>\n<li>在 keepalived 配置文件中添加对应的配置像</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vrrp_script 脚本名称</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    script &quot;脚本位置&quot;</span><br><span class=\"line\">    interval 3 #执行时间间隔</span><br><span class=\"line\">    weight -20 #动态调整vrrp_instance的优先级</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<ol start=\"2\">\n<li>编写脚本</li>\n</ol>\n<p>ck_nginx.sh</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#!/bin/bash</span><br><span class=\"line\">num=`ps -C nginx --no-header | wc -l`</span><br><span class=\"line\">if [ $num -eq 0 ];then</span><br><span class=\"line\"> /usr/local/nginx/sbin/nginx</span><br><span class=\"line\"> sleep 2</span><br><span class=\"line\"> if [ `ps -C nginx --no-header | wc -l` -eq 0 ]; then</span><br><span class=\"line\">  killall keepalived</span><br><span class=\"line\"> fi</span><br><span class=\"line\">fi</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 755 ck_nginx.sh</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vrrp_script ck_nginx &#123;</span><br><span class=\"line\">   script &quot;/etc/keepalived/ck_nginx.sh&quot; #执行脚本的位置</span><br><span class=\"line\">   interval 2\t\t#执行脚本的周期，秒为单位</span><br><span class=\"line\">   weight -20\t\t#权重的计算方式</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">vrrp_instance VI_1 &#123;</span><br><span class=\"line\">    state MASTER</span><br><span class=\"line\">    interface ens33</span><br><span class=\"line\">    virtual_router_id 10</span><br><span class=\"line\">    priority 100</span><br><span class=\"line\">    advert_int 1</span><br><span class=\"line\">    authentication &#123;</span><br><span class=\"line\">        auth_type PASS</span><br><span class=\"line\">        auth_pass 1111</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    virtual_ipaddress &#123;</span><br><span class=\"line\">        192.168.200.111</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    track_script &#123;</span><br><span class=\"line\">      ck_nginx</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>通常如果 master 服务死掉后 backup 会变成 master，但是当 master 服务又好了的时候 master 此时会抢占 VIP，这样就会发生两次切换对业务繁忙的网站来说是不好的。所以我们要在配置文件加入 nopreempt 非抢占，但是这个参数只能用于 state 为 backup，<strong>故我们在用 HA 的时候最好 master 和 backup 的 state 都设置成 backup 让其通过 priority 来竞争。</strong></p>\n<h2 id=\"制作下载站点\"><a class=\"markdownIt-Anchor\" href=\"#制作下载站点\">#</a> 制作下载站点</h2>\n<p>nginx 使用的是模块 ngx_http_autoindex_module 来实现的，该模块处理以斜杠 (&quot;/&quot;) 结尾的请求，并生成目录列表。</p>\n<p>nginx 编译的时候会自动加载该模块，但是该模块默认是关闭的，我们需要使用下来指令来完成对应的配置</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 以下都可以在http,server,location 配置</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># autoindex:启用或禁用目录列表输出</span></span><br><span class=\"line\"><span class=\"attribute\">autoindex</span> <span class=\"literal\">on</span>|<span class=\"literal\">off</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># autoindex_exact_size:对应HTLM格式，指定是否在目录列表展示文件的详细大小</span></span><br><span class=\"line\"><span class=\"attribute\">autoindex_exact_size</span>  <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># autoindex_format：设置目录列表的格式</span></span><br><span class=\"line\"><span class=\"attribute\">autoindex_format</span> html|xml|json|jsonp;</span><br><span class=\"line\"></span><br><span class=\"line\">autoindex_localtime: 对应HTML格式，是否在目录列表上显示时间。</span><br><span class=\"line\">默认为off，显示的文件时间为GMT时间。</span><br><span class=\"line\">改为on后，显示的文件时间为文件的服务器时间</span><br><span class=\"line\"><span class=\"attribute\">autoindex_localtime</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /download&#123;</span><br><span class=\"line\">    root /usr/local;</span><br><span class=\"line\">    autoindex on;</span><br><span class=\"line\">    autoindex_exact_size on;</span><br><span class=\"line\">    autoindex_format html;</span><br><span class=\"line\">    autoindex_localtime on;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"用户认证模块\"><a class=\"markdownIt-Anchor\" href=\"#用户认证模块\">#</a> 用户认证模块</h2>\n<p>对应系统资源的访问，我们往往需要限制谁能访问，谁不能访问。这块就是我们通常所说的认证部分，认证需要做的就是根据用户输入的用户名和密码来判定用户是否为合法用户，如果是则放行访问，如果不是则拒绝访问。</p>\n<p>Nginx 对应用户认证这块是通过 ngx_http_auth_basic_module 模块来实现的，它允许通过使用 &quot;HTTP 基本身份验证&quot; 协议验证用户名和密码来限制对资源的访问。默认情况下 nginx 是已经安装了该模块，如果不需要则使用–without-http_auth_basic_module。</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">（1）auth_basic:使用“ HTTP基本认证”协议启用用户名和密码的验证</span><br><span class=\"line\"></span><br><span class=\"line\">| 语法   | <span class=\"attribute\">auth_basic</span> string\\|<span class=\"literal\">off</span>;           |</span><br><span class=\"line\">| ------ | --------------------------------- |</span><br><span class=\"line\">| 默认值 | <span class=\"attribute\">auth_basic</span> <span class=\"literal\">off</span>;                   |</span><br><span class=\"line\">| 位置   | http,server,<span class=\"section\">location</span>,limit_except |</span><br><span class=\"line\"></span><br><span class=\"line\">开启后，服务端会返回<span class=\"number\">401</span>，指定的字符串会返回到客户端，给用户以提示信息，但是不同的浏览器对内容的展示不一致。</span><br><span class=\"line\"></span><br><span class=\"line\">（<span class=\"number\">2</span>）auth_basic_user_file:指定用户名和密码所在文件</span><br><span class=\"line\"></span><br><span class=\"line\">| 语法   | auth_basic_user_file file;        |</span><br><span class=\"line\">| ------ | --------------------------------- |</span><br><span class=\"line\">| 默认值 | —                                 |</span><br><span class=\"line\">| 位置   | http,server,<span class=\"section\">location</span>,limit_except |</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">location</span> /download&#123;</span><br><span class=\"line\">    <span class=\"attribute\">root</span> /usr/local;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex_exact_size</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex_format</span> html;</span><br><span class=\"line\">    <span class=\"attribute\">autoindex_localtime</span> <span class=\"literal\">on</span>;</span><br><span class=\"line\">    <span class=\"attribute\">auth_basic</span> <span class=\"string\">&#x27;please input your auth&#x27;</span>;</span><br><span class=\"line\">    <span class=\"attribute\">auth_basic_user_file</span> htpasswd;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>yum install -y httpd-tools</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">htpasswd -c /usr/local/nginx/conf/htpasswd username //创建一个新文件记录用户名和密码</span><br><span class=\"line\">htpasswd -b /usr/local/nginx/conf/htpasswd username password //在指定文件新增一个用户名和密码</span><br><span class=\"line\">htpasswd -D /usr/local/nginx/conf/htpasswd username //从指定文件删除一个用户信息</span><br><span class=\"line\">htpasswd -v /usr/local/nginx/conf/htpasswd username //验证用户名和密码是否正确</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW92NDExODdicS8/cD0xNDAmYW1wO3ZkX3NvdXJjZT1jMmU5MTdhNjcwMGNhZDM0OWJlOTE2MGU5NzNjMThhNg==\">13-Nginx 用户认证模块的使用_哔哩哔哩_bilibili</span></p>\n<h2 id=\"keepalive\"><a class=\"markdownIt-Anchor\" href=\"#keepalive\">#</a> keepalive</h2>\n<p>需要持续获取请求，通过 http 连接，则开启 keepalive</p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">keepalive_timeout</span>  <span class=\"number\">65</span>;</span><br><span class=\"line\">65指活跃时间，一旦活跃就会被重置</span><br><span class=\"line\"></span><br><span class=\"line\">请求很多但来自不同客户端，就没有必要开启keepalive，比如时间服务器</span><br><span class=\"line\"></span><br><span class=\"line\">=0 关闭keepalive，connection: <span class=\"attribute\">close</span> 服务器没有启动keepalive</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230326145512655.png\" alt=\"image-20230326145512655\"></p>\n<p>如果一个 connections 中有多个 transactions，那么说明这些 transactions 是复用了这个 connections</p>\n<p>对于 keepalive 链接，服务端通过 content-length 区分每一个请求</p>\n<blockquote>\n<h4 id=\"什么时候使用\"><a class=\"markdownIt-Anchor\" href=\"#什么时候使用\">#</a> 什么时候使用？</h4>\n<p>明显的预知用户会在当前连接上有下一步操作</p>\n<p>复用连接，有效减少握手次数，尤其是 https 建立一次连接开销会更大</p>\n<h4 id=\"什么时候不用\"><a class=\"markdownIt-Anchor\" href=\"#什么时候不用\">#</a> 什么时候不用？</h4>\n<p>访问内联资源一般用缓存，不需要 keepalive</p>\n<p>长时间的 tcp 连接容易导致系统资源无效占用</p>\n</blockquote>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># http块的keepalive</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">keepalive_disable</span>  禁用某些浏览器的keepalive</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">keepalive_requests  </span><br><span class=\"line\">设置一个keep-alive连接上可以服务的请求的最大数量，当最大请求数量达到时，连接被关闭。默认是<span class=\"number\">100</span></span><br><span class=\"line\">一个keep alive建立之后，nginx就会为这个连接设置一个计数器，记录这个keep alive的长连接上已经接收并处理的客户端请求的数量。如果达到这个参数设置的最大值时，则nginx会强行关闭这个长连接，逼迫客户端不得不重新建立新的长连接。</span><br><span class=\"line\">QPS太大时，会发现有大量的TIME_WAIT的socket连接</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">send_timeout  两次向客户端写操作的间隔，超过timeout强制断开连接.服务端向客户端传输数据的超时时间。</span><br><span class=\"line\">系统中 若有耗时操作，超过 send_timeout 强制断开连接。 注意：准备过程中，不是传输过程</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">keepalive_timeout timeout [header_timeout];</span><br><span class=\"line\">设置keep-alive客户端连接在服务器端保持开启的超时值（默认75s）；值为0会禁用keep-alive客户端连接；</span><br><span class=\"line\">可选、在响应的header域中设置一个值“Keep-Alive: timeout=time”；通常可以不用设置；</span><br><span class=\"line\">默认值为75<span class=\"attribute\">s</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">一般 keepalive_timeout &gt; send_timeout </span><br><span class=\"line\">keeplive_time  keepalive保持时间</span><br><span class=\"line\"></span><br><span class=\"line\">配置两个keepalive时会有两个keepalive</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># upstream 块的长连接</span></span><br><span class=\"line\"><span class=\"attribute\">keepalive</span>  <span class=\"number\">300</span>;</span><br><span class=\"line\">设置到<span class=\"section\">upstream</span>服务器的空闲keepalive连接的最大数量</span><br><span class=\"line\">当这个数量被突破时，最近使用最少的连接将被关闭</span><br><span class=\"line\">keepalive指令不会限制一个nginx worker进程到<span class=\"section\">upstream</span>服务器连接的总数量</span><br><span class=\"line\"></span><br><span class=\"line\">keepalive_timeout</span><br><span class=\"line\">连接保留时间</span><br><span class=\"line\">keepalive_requests</span><br><span class=\"line\">一个tcp复用中可以并发接收的请求个数</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">出现大量TIME_WAIT的情况</span><br><span class=\"line\">1）导致 nginx端出现大量TIME_WAIT的情况有两种：</span><br><span class=\"line\"></span><br><span class=\"line\">    keepalive_requests设置比较小，高并发下超过此值后nginx会强制关闭和客户端保持的keepalive长连接；（主动关闭连接后导致nginx出现TIME_WAIT）</span><br><span class=\"line\">    keepalive设置的比较小（空闲数太小），导致高并发下nginx会频繁出现连接数震荡（超过该值会关闭连接），不停的关闭、开启和后端server保持的keepalive长连接；</span><br><span class=\"line\">2）导致后端server端出现大量TIME_WAIT的情况：</span><br><span class=\"line\">nginx没有打开和后端的长连接，即：没有设置<span class=\"attribute\">proxy_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;和<span class=\"attribute\">proxy_set_header</span> Connection “”;从而导致后端server每次关闭连接，高并发下就会出现server端出现大量TIME_WAIT</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">http</span> &#123;</span><br><span class=\"line\">    <span class=\"section\">upstream</span>  BACKEND &#123;</span><br><span class=\"line\">        <span class=\"attribute\">server</span>   <span class=\"number\">192.168.0.1</span>：<span class=\"number\">8080</span>  weight=<span class=\"number\">1</span> max_fails=<span class=\"number\">2</span> fail_timeout=<span class=\"number\">30s</span>;</span><br><span class=\"line\">        <span class=\"attribute\">server</span>   <span class=\"number\">192.168.0.2</span>：<span class=\"number\">8080</span>  weight=<span class=\"number\">1</span> max_fails=<span class=\"number\">2</span> fail_timeout=<span class=\"number\">30s</span>;</span><br><span class=\"line\">        <span class=\"attribute\">keepalive</span> <span class=\"number\">300</span>;        </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"section\">server</span> &#123;</span><br><span class=\"line\">        <span class=\"attribute\">listen</span> <span class=\"number\">8080</span> default_server;</span><br><span class=\"line\">        <span class=\"attribute\">server_name</span> <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        <span class=\"section\">location</span> /  &#123;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_pass</span> http://BACKEND;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_set_header</span> Host  <span class=\"variable\">$Host</span>;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_set_header</span> x-forwarded-for <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_set_header</span> X-Real-IP <span class=\"variable\">$remote_addr</span>;</span><br><span class=\"line\">            <span class=\"attribute\">add_header</span> Cache-Control <span class=\"literal\">no</span>-store;</span><br><span class=\"line\">            <span class=\"attribute\">add_header</span> Pragma  <span class=\"literal\">no</span>-cache;</span><br><span class=\"line\">            <span class=\"attribute\">proxy_http_version</span> <span class=\"number\">1</span>.<span class=\"number\">1</span>;         // 这两个最好也设置</span><br><span class=\"line\">            <span class=\"attribute\">proxy_set_header</span> Connection <span class=\"string\">&quot;&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"对客户端限制\"><a class=\"markdownIt-Anchor\" href=\"#对客户端限制\">#</a> 对客户端限制</h3>\n<blockquote>\n<p><strong>client_body_buffer_size</strong></p>\n<p>对客户端请求中的 body 缓冲区大小</p>\n<p>默认 32 位 8k 64 位 16k</p>\n<p>如果请求体大于配置，则写入临时文件</p>\n<p><strong>client_header_buffer_size</strong></p>\n<p>设置读取客户端请求体的缓冲区大小。 如果请求体大于缓冲区，则将整个请求体或仅将其部分写入临时文件。 默认 32 位 8K。 64 位平台 16K。</p>\n<p><strong>client_max_body_size 1000M;</strong></p>\n<p>默认 1m，如果一个请求的大小超过配置的值，会返回 413 (request Entity Too Large) 错误给客户端</p>\n<p>将 size 设置为 0 将禁用对客户端请求正文大小的检查。</p>\n<p><strong>client_body_timeout</strong></p>\n<p>指定客户端与服务端建立连接后发送 request body 的超时时间。如果客户端在指定时间内没有发送任何内容，Nginx 返回 HTTP 408（Request Timed Out）</p>\n<p><strong>client_header_timeout</strong></p>\n<p>客户端向服务端发送一个完整的 request header 的超时时间。如果客户端在指定时间内没有发送一个完整的 request header，Nginx 返回 HTTP 408（Request Timed Out）。</p>\n<p><strong>client_body_temp_path</strong> <em>path</em> <code> [</code> <em>level1</em> <code> [</code> <em>level2</em> <code> [</code> <em>level3</em>`]]]</p>\n<p>在磁盘上客户端的 body 临时缓冲区位置</p>\n<p><strong>client_body_in_file_only on;</strong></p>\n<p>把 body 写入磁盘文件，请求结束也不会删除</p>\n<p><strong>client_body_in_single_buffer</strong></p>\n<p>尽量缓冲 body 的时候在内存中使用连续单一缓冲区，在二次开发时使用 <code>$request_body</code>  读取数据时性能会有所提高</p>\n<p><strong>client_header_buffer_size</strong></p>\n<p>设置读取客户端请求头的缓冲区大小</p>\n<p>如果一个请求行或者一个请求头字段不能放入这个缓冲区，那么就会使用 large_client_header_buffers</p>\n<p><strong>large_client_header_buffers</strong></p>\n<p>默认 8k</p>\n</blockquote>\n<h2 id=\"获取客户端ip\"><a class=\"markdownIt-Anchor\" href=\"#获取客户端ip\">#</a> 获取客户端 IP</h2>\n<p>X-Forwarded-for：将上一层的 remoteaddr 写入到 x-forwarded-for</p>\n<p>remote_addr 建立 tcp 连接的时候的 IP，反向代理时一定是 nginx 的 ip，无法伪造</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location / &#123;</span><br><span class=\"line\">        proxy_http_version 1.1;</span><br><span class=\"line\">        proxy_set_header Connection &quot;&quot;;</span><br><span class=\"line\">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class=\"line\">        proxy_pass http://httpds;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>如果存在多级代理，除了第一级代理以外直接转发即可，无需在设置 x-forwarded-for<br>\n 或者在加一个 ip X-Forwarded-For: ip1,ip2</p>\n<h2 id=\"concat-压缩请求个数\"><a class=\"markdownIt-Anchor\" href=\"#concat-压缩请求个数\">#</a> concat 压缩请求个数</h2>\n<p>concat 模块压缩请求数，减少并发请求个数</p>\n<p>淘宝网即，?? 代表这是一个合并请求</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230327181444179.png\" alt=\"image-20230327181444179\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubmdpbnguY29tL25naW54LXdpa2kvYnVpbGQvZGlyaHRtbC9tb2R1bGVzL2NvbmNhdC8=\">https://www.nginx.com/nginx-wiki/build/dirhtml/modules/concat/</span></p>\n<p><code>./configure --prefix=/usr/local/nginx --add-module=/root/Downloads/nginx-http-concat/</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location /static/css/ &#123;</span><br><span class=\"line\">    concat on;</span><br><span class=\"line\">    concat_max_files 20;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">location /static/js/ &#123;</span><br><span class=\"line\">    concat on;</span><br><span class=\"line\">    concat_max_files 30;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;link href=&quot;??font.css,bg.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>png 的可以一张图片包含多张图，在用切割展示不同的部分</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173546514.png\" alt=\"image-20230328173546514\"></p>\n<p>其实就是把 css 文件拼接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173731682.png\" alt=\"image-20230328173731682\"></p>\n<h2 id=\"根据ip判断用户位置\"><a class=\"markdownIt-Anchor\" href=\"#根据ip判断用户位置\">#</a> 根据 IP 判断用户位置</h2>\n<p>云厂商在 DNS 中有实现，也可以在 GEOIP 中自己实现</p>\n<p>GEOIP 判断 IP 所属区域，实现 IP 阻断或限制</p>\n<h4 id=\"1-下载数据库\"><a class=\"markdownIt-Anchor\" href=\"#1-下载数据库\">#</a> 1 下载数据库</h4>\n<p>官网需注册登录</p>\n<p>下载数据库</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL21heG1pbmQuY29t\">maxmind.com</span></p>\n<h4 id=\"2-安装依赖\"><a class=\"markdownIt-Anchor\" href=\"#2-安装依赖\">#</a> 2 安装依赖</h4>\n<h5 id=\"官方git\"><a class=\"markdownIt-Anchor\" href=\"#官方git\">#</a> 官方 git</h5>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL21heG1pbmQvbGlibWF4bWluZGRi\">https://github.com/maxmind/libmaxminddb</span></p>\n<p>下载后执行编译安装之后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf </span><br><span class=\"line\">$ ldconfig</span><br></pre></td></tr></table></figure>\n<h4 id=\"nginx模块\"><a class=\"markdownIt-Anchor\" href=\"#nginx模块\">#</a> Nginx 模块</h4>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2xlZXYvbmd4X2h0dHBfZ2VvaXAyX21vZHVsZQ==\">https://github.com/leev/ngx_http_geoip2_module</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">geoip2 /root/GeoLite2-ASN_20220524/GeoLite2-ASN.mmdb &#123;</span><br><span class=\"line\">\t$geoip2_country_code country iso_code;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">location&#123;</span><br><span class=\"line\">\tadd_header country $geoip2_country_code;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h2 id=\"健康检查\"><a class=\"markdownIt-Anchor\" href=\"#健康检查\">#</a> 健康检查</h2>\n<p>主动检查模式</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnL25naW54\">Nginx</span> 服务端会按照设定的间隔时间主动向后端的 upstream_server 发出检查请求来验证后端的各个 upstream_server 的状态。 如果得到某个<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==\">服务器</span>失败的返回超过一定次数，比如 3 次就会标记该<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==\">服务器</span>为异常，就不会将请求转发至该<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==\">服务器</span>。</p>\n<p>一般情况下后端<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==\">服务器</span>需要为这种健康检查专门提供一个低消耗的接口。</p>\n<p>被动检查模式</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnL25naW54\">Nginx</span> 在代理请求过程中会自动的监测每个后端<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==\">服务器</span>对请求的响应状态，如果某个后端<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2N2bT9mcm9tPTIwMDY1JmFtcDtmcm9tX2NvbHVtbj0yMDA2NQ==\">服务器</span>对请求的响应状态在短时间内累计一定失败次数时，Nginx 将会标记该服务器异常。就不会转发流量给该服务器。 不过每间隔一段时间 Nginx 还是会转发少量的一些请求给该后端服务器来探测它的返回状态。 以便识别该服务器是否恢复。</p>\n<p>后端服务器不需要专门提供健康检查接口，不过这种方式会造成一些用户请求的响应失败，因为 Nginx 需要用一些少量的请求去试探后端的服务是否恢复正常。</p>\n<p><strong>重试机制</strong></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"section\">upstream</span> &#123;</span><br><span class=\"line\">    <span class=\"attribute\">server</span> ... max_fails=<span class=\"number\">5</span> fail_timeout=<span class=\"number\">10s</span>; <span class=\"comment\"># 最大失败次数  </span></span><br><span class=\"line\">    <span class=\"comment\"># max_fails=5和fail_timeout=10s 表示在单位周期为10s钟内，中达到5次连接失败，那么接将把节点标记为不可用，并等待下一个周期（同样时常为fail_timeout）再一次去请求，判断是否连接是否成功。</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"section\">location</span> &#123;</span><br><span class=\"line\">    <span class=\"comment\"># Nginx 默认判断失败节点状态以connect refuse和time out状态为准，不以HTTP错误状态进行判断失败，因为HTTP只要能返回状态说明该节点还可以正常连接，所以nginx判断其还是存活状态；</span></span><br><span class=\"line\">    <span class=\"comment\"># 除非添加了proxy_next_upstream指令设置对404、502、503、504、500和time out等错误进行转到备机处理，</span></span><br><span class=\"line\">    <span class=\"attribute\">proxy_next_upstream</span> <span class=\"literal\">error</span> | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | <span class=\"literal\">off</span> ...;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"attribute\">proxy_next_upstream_timeout</span> time; <span class=\"comment\"># 失败重试总时间</span></span><br><span class=\"line\">    <span class=\"attribute\">proxy_next_upstream_tries</span> number; <span class=\"comment\"># 总时间内重试次数</span></span><br><span class=\"line\">    </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>主动状态检查</strong></p>\n<p>tengine 版</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3lhb3dlaWJpbi9uZ2lueF91cHN0cmVhbV9jaGVja19tb2R1bGU=\">https://github.com/yaoweibin/nginx_upstream_check_module</span></p>\n<p>nginx 商业版</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfdXBzdHJlYW1faGNfbW9kdWxlLmh0bWw=\">http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.下载安装nginx 1.20.2</span><br><span class=\"line\"></span><br><span class=\"line\">2.vi /root/path</span><br><span class=\"line\">内容为:https://github.com/yaoweibin/nginx_upstream_check_module/blob/master/check_1.20.1%2B.patch</span><br><span class=\"line\"></span><br><span class=\"line\">3.安装patch</span><br><span class=\"line\"></span><br><span class=\"line\">4.进入nginx文件夹</span><br><span class=\"line\">[root@mail nginx-1.20.2]# patch -p1 &lt; /root/path </span><br><span class=\"line\"></span><br><span class=\"line\">./configure --prefix=/usr/local/nginx20 --add-module=/root/Downloads/nginx_upstream_check_module-0.4.0</span><br><span class=\"line\">make </span><br><span class=\"line\">make install </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"section\">upstream</span> backend &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"attribute\">server</span> <span class=\"number\">192.168.44.102</span> weight=<span class=\"number\">8</span> down;</span><br><span class=\"line\">     <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.155:8080</span>;</span><br><span class=\"line\">     <span class=\"attribute\">server</span> <span class=\"number\">192.168.13.166:8080</span>;</span><br><span class=\"line\">     <span class=\"attribute\">check</span> interval=<span class=\"number\">3000</span> rise=<span class=\"number\">2</span> fall=<span class=\"number\">5</span> timeout=<span class=\"number\">1000</span> type=http; <span class=\"comment\">#每三秒检测一次，两次正常就up，五次失败就down，超时时间1000ms，使用http</span></span><br><span class=\"line\">     <span class=\"attribute\">check_http_send</span> <span class=\"string\">&quot;HEAD / HTTP/1.0\\r\\n\\r\\n&quot;</span>;</span><br><span class=\"line\">     <span class=\"attribute\">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"> <span class=\"section\">server</span> &#123;</span><br><span class=\"line\">     <span class=\"attribute\">listen</span>       <span class=\"number\">80</span>;</span><br><span class=\"line\">     <span class=\"attribute\">server_name</span>  localhost;</span><br><span class=\"line\">     </span><br><span class=\"line\">     <span class=\"comment\">#charset koi8-r;</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     <span class=\"comment\">#access_log  logs/host.access.log  main;</span></span><br><span class=\"line\">     </span><br><span class=\"line\">     <span class=\"section\">location</span> /status &#123;</span><br><span class=\"line\">             check_status;</span><br><span class=\"line\">             <span class=\"attribute\">access_log</span> <span class=\"literal\">off</span>;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">     <span class=\"section\">location</span> / &#123;</span><br><span class=\"line\">             <span class=\"attribute\">proxy_pass</span> http://backend;</span><br><span class=\"line\">             <span class=\"attribute\">root</span>   html;</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><code>./nginx -c /usr/local/nginx20/conf/nginx.conf</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230403163536618.png\" alt=\"image-20230403163536618\"></p>\n<h2 id=\"资源静态化\"><a class=\"markdownIt-Anchor\" href=\"#资源静态化\">#</a> 资源静态化</h2>\n<p>将原本需要计算的请求缓存成文件放在 nginx 里</p>\n<p>并发最高的：列表，详情页</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328175858869.png\" alt=\"image-20230328175858869\" style=\"zoom: 67%;\" /> \n<p>前端合并和后端合并</p>\n<p>前端合并：节约服务器资源，消耗请求数</p>\n<p>后端合并：ssi</p>\n<h3 id=\"ssi\"><a class=\"markdownIt-Anchor\" href=\"#ssi\">#</a> ssi</h3>\n<p>通常称为服务器端嵌入，是一种类似于 ASP 的基于服务器的网页制作技术。</p>\n<p>一个静态化的页面中，需要嵌入一小块实时变化的内容，。例如首页，大部分的页面内容需要缓存但是用户登录后的个人信息是动态信息，不能缓存。那么如何解决这个” 页面部分缓存” 问题，利用 SSI 就可以解决，在首页的静态页面中嵌入个人信息的动态页，由于是服务器端的嵌入，所以用户浏览的时候都是一个嵌入后的页面。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfc3NpX21vZHVsZS5odG1s\">http://nginx.org/en/docs/http/ngx_http_ssi_module.html</span></p>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># http， server， location</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"attribute\">ssi</span> <span class=\"literal\">on</span></span><br><span class=\"line\"></span><br><span class=\"line\">开启ssi支持，默认是<span class=\"literal\">off</span></span><br><span class=\"line\"></span><br><span class=\"line\">ssi_silent_errors <span class=\"literal\">on</span></span><br><span class=\"line\"></span><br><span class=\"line\">默认值是<span class=\"literal\">off</span>，开启后在处理SSI文件出错时不输出错误提示:”[an <span class=\"literal\">error</span> occurred while processing the directive] ”</span><br><span class=\"line\"></span><br><span class=\"line\">ssi_types</span><br><span class=\"line\"></span><br><span class=\"line\">默认是ssi_types text/html，所以如果需要htm和html支持，则不需要设置这句，如果需要shtml支持，则需要设置：ssi_types text/shtml</span><br><span class=\"line\"></span><br><span class=\"line\">ssi_value_length</span><br><span class=\"line\"></span><br><span class=\"line\">限制脚本参数最大长度</span><br><span class=\"line\"></span><br><span class=\"line\">ssi_last_modified</span><br><span class=\"line\"></span><br><span class=\"line\">是否保留lastmodified</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">server &#123;  </span><br><span class=\"line\">    <span class=\"attribute\">ssi</span> <span class=\"literal\">on</span>;  </span><br><span class=\"line\">    <span class=\"attribute\">ssi_silent_errors</span> <span class=\"literal\">on</span>;  </span><br><span class=\"line\">    <span class=\"attribute\">ssi_types</span> text/shtml;  </span><br><span class=\"line\">&#125;  </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!--#include file=&quot;header.html&quot;--&gt;</span><br><span class=\"line\">&lt;h1&gt;我是index&lt;/h1&gt;</span><br><span class=\"line\">&lt;!--#include virtual=&quot;footer.html&quot;--&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230419112317707.png\" alt=\"image-20230419112317707\"></p>\n<h3 id=\"rsync\"><a class=\"markdownIt-Anchor\" href=\"#rsync\">#</a> rsync</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2FtYmEub3JnL2Z0cC9yc3luYy9yc3luYy5odG1s\">https://www.samba.org/ftp/rsync/rsync.html</span></p>\n<p>remote synchronize 是一个远程数据同步工具，可通过 LAN/WAN 快速同步多台主机之间的文件。也可以使用 rsync 同步本地硬盘中的不同目录。<br>\nrsync 是用于替代 rcp 的一个工具，rsync 使用所谓的 rsync 算法 进行数据同步，这种算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。</p>\n<p>rsync 基于 inotify 开发</p>\n<p>Rsync 有三种模式：</p>\n<ul>\n<li>本地模式（类似于 cp 命令）</li>\n<li>远程模式（类似于 scp 命令）</li>\n<li>守护进程（socket 进程：是 rsync 的重要功能）</li>\n</ul>\n<h4 id=\"安装-2\"><a class=\"markdownIt-Anchor\" href=\"#安装-2\">#</a> 安装</h4>\n<p>两端安装</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y rsync</span><br></pre></td></tr></table></figure>\n<h3 id=\"\"><a class=\"markdownIt-Anchor\" href=\"#\">#</a> </h3>\n<h4 id=\"密码文件\"><a class=\"markdownIt-Anchor\" href=\"#密码文件\">#</a> 密码文件</h4>\n<p>创建文件 <code>/etc/rsync.password</code></p>\n<p>内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hello:123</span><br></pre></td></tr></table></figure>\n<p>修改权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">chmod 600 /etc/rsync.password</span><br></pre></td></tr></table></figure>\n<p>修改配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">auth users = sgg</span><br><span class=\"line\">secrets file = /etc/rsyncd.pwd</span><br></pre></td></tr></table></figure>\n<h4 id=\"开机启动\"><a class=\"markdownIt-Anchor\" href=\"#开机启动\">#</a> 开机启动</h4>\n<p>在 <code>/etc/rc.local</code>  文件中添加</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync --daemon</span><br></pre></td></tr></table></figure>\n<ul>\n<li>修改权限</li>\n</ul>\n<p>echo “sgg:111” &gt;&gt; /etc/rsyncd.passwd</p>\n<h4 id=\"查看远程目录\"><a class=\"markdownIt-Anchor\" href=\"#查看远程目录\">#</a> 查看远程目录</h4>\n<p>rsync --list-only 192.168.44.104::www/</p>\n<h4 id=\"拉取数据到指定目录\"><a class=\"markdownIt-Anchor\" href=\"#拉取数据到指定目录\">#</a> 拉取数据到指定目录</h4>\n<p>rsync -avz rsync://192.168.44.104:873/www</p>\n<p>rsync -avz 192.168.44.104::www/ /root/w</p>\n<h5 id=\"使用ssh方式\"><a class=\"markdownIt-Anchor\" href=\"#使用ssh方式\">#</a> 使用 SSH 方式</h5>\n<p>rsync -avzP /usr/local/nginx/html/ <span class=\"exturl\" data-url=\"bWFpbHRvOnJvb3RAMTkyLjE2OC40NC4xMDU=\">root@192.168.44.105</span>:/www/</p>\n<h4 id=\"推送\"><a class=\"markdownIt-Anchor\" href=\"#推送\">#</a> 推送</h4>\n<p>修改配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rsync -avz --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ rsync://sgg@192.168.44.105:/www</span><br></pre></td></tr></table></figure>\n<p><code>--delete 删除目标目录比源目录多余文件</code></p>\n<h4 id=\"实时推送\"><a class=\"markdownIt-Anchor\" href=\"#实时推送\">#</a> 实时推送</h4>\n<p>推送端安装 inotify</p>\n<p>依赖</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install -y automake</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class=\"line\">./configure --prefix=/usr/local/inotify</span><br><span class=\"line\">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>\n<p>监控目录</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"简单自动化脚本\"><a class=\"markdownIt-Anchor\" href=\"#简单自动化脚本\">#</a> 简单自动化脚本</h4>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta prompt_\">#</span><span class=\"language-bash\">!/bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file</span><br><span class=\"line\">do</span><br><span class=\"line\">       </span><br><span class=\"line\">        rsync -az --delete --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ sgg@192.168.44.102::ftp/</span><br><span class=\"line\">done</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"nginx-php\"><a class=\"markdownIt-Anchor\" href=\"#nginx-php\">#</a> nginx + php</h2>\n<figure class=\"highlight nginx\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">    <span class=\"comment\"># 这里新加的</span></span><br><span class=\"line\">    <span class=\"comment\"># PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI协议默认配置.</span></span><br><span class=\"line\">    <span class=\"comment\"># Fastcgi服务器和程序(PHP,Python)沟通的协议.</span></span><br><span class=\"line\">    <span class=\"section\">location</span> <span class=\"regexp\">~ \\.php$</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\"># 设置监听端口</span></span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_pass</span>   <span class=\"number\">127.0.0.1:9000</span>;</span><br><span class=\"line\">        <span class=\"comment\"># 设置nginx的默认首页文件(上面已经设置过了，可以删除)</span></span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_index</span>  index.php;</span><br><span class=\"line\">        <span class=\"comment\"># 设置脚本文件请求的路径</span></span><br><span class=\"line\">        <span class=\"attribute\">fastcgi_param</span>  SCRIPT_FILENAME  <span class=\"variable\">$document_root</span><span class=\"variable\">$fastcgi_script_name</span>;</span><br><span class=\"line\">        <span class=\"comment\"># 引入fastcgi的配置文件</span></span><br><span class=\"line\">        <span class=\"attribute\">include</span>        fastcgi_params;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1、nginx 的 <code>worker进程</code> 直接管理每一个请求到 nginx 的网络请求。</p>\n<p>2、php-fpm 程序也如同 nginx 一样，需要监听端口，并且有 master 和 worker 进程。worker 进程直接管理每一个 php 进程。</p>\n<p>3、关于 fastcgi：fastcgi 是一种进程管理器，管理 cgi 进程。市面上有多种实现了 fastcgi 功能的进程管理器，php-fpm 就是其中的一种。再提一点，php-fpm 作为一种 fast-cgi 进程管理服务，会监听端口， <code>一般默认监听9000端口，并且是监听本机</code> ，也就是只接收来自本机的端口请求，所以我们通常输入命令 netstat -nlpt|grep php-fpm 会得到：</p>\n<p>tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 1057/php-fpm<br>\n 这里的 127.0.0.1:9000 就是监听本机 9000 端口的意思。</p>\n<p>4、关于 fastcgi 的配置文件，目前 fastcgi 的配置文件一般放在 nginx.conf 同级目录下，配置文件形式，一般有两种：fastcgi.conf 和 fastcgi_params。不同的 nginx 版本会有不同的配置文件，这两个配置文件有一个非常重要的区别：fastcgi_parames 文件中缺少下列配置：<br>\nfastcgi_param SCRIPT_FILENAME fastcgi_script_name;<br>\n 我们可以打开 fastcgi_parames 文件加上上述行，也可以在要使用配置的地方动态添加。使得该配置生效。</p>\n<p>5、 <code>当需要处理php请求时，nginx的worker进程会将请求移交给php-fpm的worker进程进行处理，也就是最开头所说的nginx调用了php，其实严格得讲是nginx间接调用php</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NzIwODI1Mg==\">Nginx 和 PHP 的配置 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNDY1NjAwMDI=\">php 环境搭建（正确配置 nginx 和 php） - 知乎 (zhihu.com)</span></p>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/04/05/Docker/",
            "url": "http://example.com/2023/04/05/Docker/",
            "title": "docker",
            "date_published": "2023-04-05T05:38:45.000Z",
            "content_html": "<h1 id=\"docker\"><a class=\"markdownIt-Anchor\" href=\"#docker\">#</a> Docker</h1>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5kb2NrZXIuY29t\">www.docker.com</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2h1Yi5kb2NrZXIuY29t\">hub.docker.com</span></p>\n<p>虚拟机缺点：</p>\n<p>1. 资源占有多</p>\n<p>2. 冗余步骤多</p>\n<p>3. 启动慢</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328205458587.png\" alt=\"image-20230328205458587\"></p>\n<p>容器化技术：不是完整的操作系统，只保留了最核心的部分。直接运行在操作系统之上。容器之间相互隔离</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328203952292.png\" alt=\"image-20230328203952292\"></p>\n<p>传统虚拟机：虚拟出一套硬件，运行一套完整的操作系统，再运行软件</p>\n<p>容器内的应用直接运行在宿主机的内核，是没有自己内核的，也没有虚拟硬件，所以轻便。每个容器相互隔离，都有属于自己的文件系统</p>\n<p>更高效的资源应用</p>\n<p>更见的系统运维</p>\n<p>更便捷的升级和扩缩容</p>\n<p>应用更快速的交付和部署</p>\n<h2 id=\"docker安装\"><a class=\"markdownIt-Anchor\" href=\"#docker安装\">#</a> docker 安装</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328205612777.png\" alt=\"image-20230328205612777\"></p>\n<p><code>镜像</code> ：image 类似于模板，可以通过模板创建容器服务。镜像 run 之后就是一个容器，用于提供服务。通过这个镜像可以创建多个容器，项目运行就是在容器中</p>\n<p><code>容器</code> ：container docker 利用容器，独立运行一个或者一组应用，通过镜像来创建 ，可以启动，删除，停止等。可以把容器理解为一个简易的 linux 系统</p>\n<p><code>仓库</code> ：repository 存放镜像的地方。分为共有和私有仓库，比如 docker hub。国内需要配置镜像加速，利用阿里云容器服务器或者其他</p>\n<p>环境：centos7 + 华为云 + xshell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# uname -r</span><br><span class=\"line\">3.10.0-1160.53.1.el7.x86_64</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# cat /etc/os-release </span><br><span class=\"line\">NAME=&quot;CentOS Linux&quot;</span><br><span class=\"line\">VERSION=&quot;7 (Core)&quot;</span><br><span class=\"line\">ID=&quot;centos&quot;</span><br><span class=\"line\">ID_LIKE=&quot;rhel fedora&quot;</span><br><span class=\"line\">VERSION_ID=&quot;7&quot;</span><br><span class=\"line\">PRETTY_NAME=&quot;CentOS Linux 7 (Core)&quot;</span><br><span class=\"line\">ANSI_COLOR=&quot;0;31&quot;</span><br><span class=\"line\">CPE_NAME=&quot;cpe:/o:centos:centos:7&quot;</span><br><span class=\"line\">HOME_URL=&quot;https://www.centos.org/&quot;</span><br><span class=\"line\">BUG_REPORT_URL=&quot;https://bugs.centos.org/&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">CENTOS_MANTISBT_PROJECT=&quot;CentOS-7&quot;</span><br><span class=\"line\">CENTOS_MANTISBT_PROJECT_VERSION=&quot;7&quot;</span><br><span class=\"line\">REDHAT_SUPPORT_PRODUCT=&quot;centos&quot;</span><br><span class=\"line\">REDHAT_SUPPORT_PRODUCT_VERSION=&quot;7&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>1. 卸载旧版本</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum remove docker \\</span><br><span class=\"line\">                 docker-client \\</span><br><span class=\"line\">                 docker-client-latest \\</span><br><span class=\"line\">                 docker-common \\</span><br><span class=\"line\">                 docker-latest \\</span><br><span class=\"line\">                 docker-latest-logrotate \\</span><br><span class=\"line\">                 docker-logrotate \\</span><br><span class=\"line\">                 docker-engine</span><br></pre></td></tr></table></figure>\n<p><strong>2. 安装基本环境</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install -y yum-utils</span><br></pre></td></tr></table></figure>\n<p><strong>3. 设置镜像仓库</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum-config-manager \\</span><br><span class=\"line\">    --add-repo \\</span><br><span class=\"line\">http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">更新软件包索引</span><br><span class=\"line\">yum makecache fast</span><br></pre></td></tr></table></figure>\n<p><strong>4. 安装 docker 相关内容</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo yum install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin</span><br></pre></td></tr></table></figure>\n<p><strong>5. 启动 docker</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl start docker</span><br><span class=\"line\">docker version</span><br></pre></td></tr></table></figure>\n<p><strong>6. 测试 docker 安装是否成功</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run hello-world</span><br></pre></td></tr></table></figure>\n<p><strong>7. 查看 hello-world 镜像</strong></p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker images</span><br></pre></td></tr></table></figure>\n<p><strong>8. 卸载 docker</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">卸载依赖</span><br><span class=\"line\">sudo yum remove docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin docker-ce-rootless-extras</span><br><span class=\"line\">删除资源，也就是docker的默认工作路径</span><br><span class=\"line\">sudo rm -rf /var/lib/docker</span><br><span class=\"line\">sudo rm -rf /var/lib/containerd</span><br></pre></td></tr></table></figure>\n<h2 id=\"内核参数调优\"><a class=\"markdownIt-Anchor\" href=\"#内核参数调优\">#</a> 内核参数调优</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发。</span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># modprobe br_netfilter</span></span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># cat &gt; /etc/sysctl.d/docker.conf &lt;&lt;EOF</span></span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#使参数生效</span></span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># sysctl -p /etc/sysctl.d/docker.conf</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ngsql]<span class=\"comment\"># lsmod | grep br_</span></span><br><span class=\"line\">br_netfilter           22256  0 </span><br><span class=\"line\">bridge                151336  2 br_netfilter,ebtable_broute</span><br><span class=\"line\"></span><br><span class=\"line\">重启后模块失效，下面是开机自动加载模块的脚本</span><br><span class=\"line\">在/etc/新建rc.sysinit 文件</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/rc.sysinit</span><br><span class=\"line\"><span class=\"comment\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"keyword\">for</span> file <span class=\"keyword\">in</span> /etc/sysconfig/modules/*.modules ; <span class=\"keyword\">do</span></span><br><span class=\"line\">[ -x <span class=\"variable\">$file</span> ] &amp;&amp; <span class=\"variable\">$file</span></span><br><span class=\"line\"><span class=\"keyword\">done</span></span><br><span class=\"line\"></span><br><span class=\"line\">在/etc/sysconfig/modules/目录下新建文件如下</span><br><span class=\"line\"><span class=\"built_in\">cat</span> /etc/sysconfig/modules/br_netfilter.modules</span><br><span class=\"line\">modprobe br_netfilter</span><br><span class=\"line\"></span><br><span class=\"line\">增加权限</span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># chmod 755 /etc/sysconfig/modules/br_netfilter.modules</span></span><br><span class=\"line\"></span><br><span class=\"line\">重启机器模块也会自动加载</span><br><span class=\"line\">[root@localhost ~]<span class=\"comment\"># lsmod |grep br_netfilter</span></span><br><span class=\"line\">br_netfilter 22209 0</span><br><span class=\"line\">bridge 136173 1 br_netfilter</span><br><span class=\"line\"></span><br><span class=\"line\">注：</span><br><span class=\"line\">Docker 安装后出现：WARNING: bridge-nf-call-iptables is disabled 的解决办法：</span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\"></span><br><span class=\"line\">net.ipv4.ip_forward = 1：</span><br><span class=\"line\">将Linux系统作为路由或者VPN服务就必须要开启IP转发功能。当linux主机有多个网卡时一个网卡收到的信息是否能够传递给其他的网卡 ，如果设置成1 的话 可以进行数据包转发，可以实现VxLAN 等功能。不开启会导致docker部署应用无法访问。</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#重启docker</span></span><br><span class=\"line\">[root@xianchaomaster1 ~]<span class=\"comment\"># systemctl restart docker  </span></span><br></pre></td></tr></table></figure>\n<h2 id=\"镜像加速\"><a class=\"markdownIt-Anchor\" href=\"#镜像加速\">#</a> 镜像加速</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NyLmNvbnNvbGUuYWxpeXVuLmNvbQ==\">cr.console.aliyun.com</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">您可以通过修改daemon配置文件/etc/docker/daemon.json来使用加速器</span><br><span class=\"line\"></span><br><span class=\"line\">sudo mkdir -p /etc/docker</span><br><span class=\"line\">sudo tee /etc/docker/daemon.json &lt;&lt;-&#x27;EOF&#x27;</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  &quot;registry-mirrors&quot;: [&quot;https://fn5y0qpk.mirror.aliyuncs.com&quot;]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">EOF</span><br><span class=\"line\">sudo systemctl daemon-reload</span><br><span class=\"line\">sudo systemctl restart docker</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-run之后发生了什么\"><a class=\"markdownIt-Anchor\" href=\"#docker-run之后发生了什么\">#</a> docker run 之后发生了什么</h2>\n<p><strong>1. 本机寻找镜像</strong></p>\n<p><strong>2.1 本机有镜像，使用镜像运行</strong></p>\n<p><strong>2.2 去 dockerhub 上下载</strong></p>\n<p><strong>3.1 dockerhub 找不到镜像 - 返回错误</strong></p>\n<p><strong>3.2dockerhub 找到镜像，下载到本地</strong></p>\n<p><strong>4. 运行</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329195956959.png\" alt=\"image-20230329195956959\"></p>\n<p>docker 是一个 cs 结构的系统，docker 的守护进程运行在主机上。通过 socket 从客户端访问</p>\n<p>docker server 接收到 client 指定，就会执行这个命令</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329200521395.png\" alt=\"image-20230329200521395\"></p>\n<p>docker 有着比虚拟机更少的抽象层</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230329200736029.png\" alt=\"image-20230329200736029\"></p>\n<p>docker 用的是宿主机的内核，vm 需要 guest os</p>\n<p>docker 不需要重新加载操作系统内核，避免引导。</p>\n<h2 id=\"docker命令\"><a class=\"markdownIt-Anchor\" href=\"#docker命令\">#</a> docker 命令</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker version/info    # 版本信息，系统信息</span><br><span class=\"line\">docker --help          # 帮助命令</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"镜像命令\"><a class=\"markdownIt-Anchor\" href=\"#镜像命令\">#</a> 镜像命令</h3>\n<p><code>docker images   # 查看所有镜像</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker images </span><br><span class=\"line\">REPOSITORY                TAG       IMAGE ID       CREATED         SIZE</span><br><span class=\"line\">loadbalancejsp_lbsnode1   latest    8d19a7525948   3 months ago    240MB</span><br><span class=\"line\">loadbalancejsp_lbsnode2   latest    8d19a7525948   3 months ago    240MB</span><br><span class=\"line\">tomcat                    8-jre8    f0e282263192   3 months ago    240MB</span><br><span class=\"line\"></span><br><span class=\"line\">仓库源                     标签       镜像ID          创建时间         镜像大小</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-a 显示全部镜像</span><br><span class=\"line\"></span><br><span class=\"line\">-q 只显示镜像ID</span><br></pre></td></tr></table></figure>\n<p><code>docker search  # 搜索镜像</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker search mysql</span><br><span class=\"line\">NAME                            DESCRIPTION                                     STARS     OFFICIAL   AUTOMATED</span><br><span class=\"line\">mysql                           MySQL is a widely used, open-source relation…   13988     [OK]       </span><br><span class=\"line\">mariadb                         MariaDB Server is a high performing open sou…   5333      [OK]       </span><br><span class=\"line\">percona                         Percona Server is a fork of the MySQL relati…   602       [OK]       </span><br><span class=\"line\"></span><br><span class=\"line\">docker search mysql --filter=STARS=9000   STARS&gt;9000</span><br></pre></td></tr></table></figure>\n<p><code>docker pull   #下载镜像</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker pull mysql</span><br><span class=\"line\">Using default tag: latest</span><br><span class=\"line\">latest: Pulling from library/mysql</span><br><span class=\"line\">72a69066d2fe: Pull complete   # 分层下载</span><br><span class=\"line\">93619dbc5b36: Pull complete </span><br><span class=\"line\">99da31dd6142: Pull complete </span><br><span class=\"line\">626033c43d70: Pull complete </span><br><span class=\"line\">37d5d7efb64e: Pull complete </span><br><span class=\"line\">ac563158d721: Pull complete </span><br><span class=\"line\">d2ba16033dad: Pull complete </span><br><span class=\"line\">688ba7d5c01a: Pull complete </span><br><span class=\"line\">00e060b6d11d: Pull complete </span><br><span class=\"line\">1c04857f594f: Pull complete </span><br><span class=\"line\">4d7cfa90e6ea: Pull complete </span><br><span class=\"line\">e0431212d27d: Pull complete </span><br><span class=\"line\">Digest: sha256:e9027fe4d91c0153429607251656806cc784e914937271037f7738bd5b8e7709</span><br><span class=\"line\">Status: Downloaded newer image for mysql:latest</span><br><span class=\"line\">docker.io/library/mysql:latest  # 真实地址</span><br><span class=\"line\"></span><br><span class=\"line\">==</span><br><span class=\"line\">docker pull docker.io/library/mysql:latest</span><br><span class=\"line\"></span><br><span class=\"line\">分层可以实现层的共用</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker pull mysql:5.7</span><br><span class=\"line\">5.7: Pulling from library/mysql</span><br><span class=\"line\">72a69066d2fe: Already exists </span><br><span class=\"line\">93619dbc5b36: Already exists </span><br><span class=\"line\">99da31dd6142: Already exists </span><br><span class=\"line\">626033c43d70: Already exists </span><br><span class=\"line\">37d5d7efb64e: Already exists </span><br><span class=\"line\">ac563158d721: Already exists </span><br><span class=\"line\">d2ba16033dad: Already exists </span><br><span class=\"line\">0ceb82207cd7: Pull complete </span><br><span class=\"line\">37f2405cae96: Pull complete </span><br><span class=\"line\">e2482e017e53: Pull complete </span><br><span class=\"line\">70deed891d42: Pull complete </span><br><span class=\"line\">Digest: sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class=\"line\">Status: Downloaded newer image for mysql:5.7</span><br><span class=\"line\">docker.io/library/mysql:5.7</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><code>docker rmi    # 删除镜像</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker rmi c20</span><br><span class=\"line\">Untagged: mysql:5.7</span><br><span class=\"line\">Untagged: mysql@sha256:f2ad209efe9c67104167fc609cca6973c8422939491c9345270175a300419f94</span><br><span class=\"line\">Deleted: sha256:c20987f18b130f9d144c9828df630417e2a9523148930dc3963e9d0dab302a76</span><br><span class=\"line\">Deleted: sha256:6567396b065ee734fb2dbb80c8923324a778426dfd01969f091f1ab2d52c7989</span><br><span class=\"line\">Deleted: sha256:0910f12649d514b471f1583a16f672ab67e3d29d9833a15dc2df50dd5536e40f</span><br><span class=\"line\">Deleted: sha256:6682af2fb40555c448b84711c7302d0f86fc716bbe9c7dc7dbd739ef9d757150</span><br><span class=\"line\">Deleted: sha256:5c062c3ac20f576d24454e74781511a5f96739f289edaadf2de934d06e910b92</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker rmi c20 321  # 删除多个镜像</span><br><span class=\"line\"></span><br><span class=\"line\">#docker删除全部容器</span><br><span class=\"line\">[root@hecs-346515 ~]# docker rmi -f $(docker images -qa)</span><br></pre></td></tr></table></figure>\n<h3 id=\"容器命令\"><a class=\"markdownIt-Anchor\" href=\"#容器命令\">#</a> 容器命令</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker pull centos</span><br></pre></td></tr></table></figure>\n<p><strong>新建容器并启动</strong></p>\n<p><code>docker run</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"># 参数说明</span><br><span class=\"line\">--name=&quot;Name&quot;   容器名字，用于区分容器</span><br><span class=\"line\">-d   以后台运行</span><br><span class=\"line\">-it  使用交互方式运行，进入容器查看内容</span><br><span class=\"line\">-p   指定容器端口 -p 8080:8080</span><br><span class=\"line\">\t-p ip:主机端口:容器端口</span><br><span class=\"line\">\t-p 主机端口:容器端口</span><br><span class=\"line\">\t-p 容器端口</span><br><span class=\"line\">\t容器端口</span><br><span class=\"line\">-P   随机指定端口</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker run -it centos /bin/bash   # 启动并进入容器</span><br><span class=\"line\">[root@3505a169c989 /]# exit</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>列出所有运行的容器</strong></p>\n<p><code>docker ps -a</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker ps -a </span><br><span class=\"line\">CONTAINER ID   IMAGE                     COMMAND                  CREATED         STATUS                          PORTS     NAMES</span><br><span class=\"line\">3505a169c989   centos                    &quot;/bin/bash&quot;              2 minutes ago   Exited (0) About a minute ago             lucid_hypatia</span><br><span class=\"line\">efe24d96f682   hello-world               &quot;/hello&quot;                 23 hours ago    Exited (0) 23 hours ago                   goofy_lichterman</span><br><span class=\"line\">85c7b4c3d350   nginx:1.17                &quot;nginx -g &#x27;daemon of…&quot;   3 months ago    Exited (1) 3 months ago                   loadbalancejsp_nginx_1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">-a 列出历史容器和当前运行的容器</span><br><span class=\"line\">-n=?  显示最近创建的容器个数</span><br><span class=\"line\">-q  只显示容器编号</span><br><span class=\"line\"></span><br><span class=\"line\">docker ps -qa</span><br></pre></td></tr></table></figure>\n<p><strong>退出容器</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">exit  停止并退出</span><br><span class=\"line\">ctrl + q + p  容器不停止退出</span><br></pre></td></tr></table></figure>\n<p><strong>删除容器</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker rm id</span><br><span class=\"line\">docker rm -f $(docker ps -aq)   # 删除所有容器</span><br><span class=\"line\">docker ps -aq | xargs docker rm  # 删除所有容器</span><br></pre></td></tr></table></figure>\n<p><strong>启动和停止容器</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker start id</span><br><span class=\"line\">docker restart id</span><br><span class=\"line\">docker stop id</span><br><span class=\"line\">docker kill id</span><br></pre></td></tr></table></figure>\n<p><strong>后台启动容器</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d centos</span><br><span class=\"line\"></span><br><span class=\"line\">启动完之后因为没有前台进程，容器发现没有应用，自动停止</span><br></pre></td></tr></table></figure>\n<p><strong>查看日志</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker logs</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker logs -f -t 741  </span><br><span class=\"line\">[root@hecs-346515 ~]# docker logs -f -t --tail 10  741</span><br></pre></td></tr></table></figure>\n<p><strong>查看容器中的进程信息</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker top 741</span><br><span class=\"line\">UID                 PID                 PPID                C                   STIME               TTY                 TIME                CMD</span><br><span class=\"line\">root                8024                8006                0                   14:05               ?                   00:00:00            nginx: master process nginx -g daemon off;</span><br><span class=\"line\">101                 8075                8024                0                   14:05               ?                   00:00:00            nginx: worker process</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>查看镜像元数据</strong></p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># docker inspect 741</span></span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Id&quot;</span>: <span class=\"string\">&quot;741038301edd946e2f2e193803d8e29aa31897212a310730c85f8b8194dbf45f&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Created&quot;</span>: <span class=\"string\">&quot;2023-03-30T06:05:28.540089191Z&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Path&quot;</span>: <span class=\"string\">&quot;/docker-entrypoint.sh&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Args&quot;</span>: [</span><br><span class=\"line\">            <span class=\"string\">&quot;nginx&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;-g&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;daemon off;&quot;</span></span><br><span class=\"line\">        ],</span><br><span class=\"line\">        <span class=\"string\">&quot;State&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Status&quot;</span>: <span class=\"string\">&quot;running&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Running&quot;</span>: <span class=\"literal\">true</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Paused&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Restarting&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;OOMKilled&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Dead&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Pid&quot;</span>: 8024,</span><br><span class=\"line\">            <span class=\"string\">&quot;ExitCode&quot;</span>: 0,</span><br><span class=\"line\">            <span class=\"string\">&quot;Error&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;StartedAt&quot;</span>: <span class=\"string\">&quot;2023-03-30T06:05:28.79217804Z&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;FinishedAt&quot;</span>: <span class=\"string\">&quot;0001-01-01T00:00:00Z&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Image&quot;</span>: <span class=\"string\">&quot;sha256:605c77e624ddb75e6110f997c58876baa13f8754486b461117934b24a9dc3a85&quot;</span>,</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>进入当前运行容器</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker exec -it 741 /bin/bash</span><br><span class=\"line\">root@741038301edd:/# </span><br><span class=\"line\"># 进入容器后开启新终端</span><br><span class=\"line\">-i：以交互模式运行容器</span><br><span class=\"line\">-t：为容器重新分配一个伪输入终端</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker attach 8cf</span><br><span class=\"line\">[root@8cf0c194eae8 /]# </span><br><span class=\"line\"># 进入容器正在执行的终端，不会启动新的进程</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>容器内拷贝文件到主机上</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker cp id:/root/ /home</span><br><span class=\"line\">docker cp id:/容器目录  /本机目录</span><br><span class=\"line\">docker 容器内命令</span><br><span class=\"line\"></span><br><span class=\"line\">-v 卷可以实现自动同步</span><br></pre></td></tr></table></figure>\n<h2 id=\"使用docker\"><a class=\"markdownIt-Anchor\" href=\"#使用docker\">#</a> 使用 docker</h2>\n<h3 id=\"安装nginx\"><a class=\"markdownIt-Anchor\" href=\"#安装nginx\">#</a> 安装 nginx</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker search nginx</span><br><span class=\"line\">docker pull nginx </span><br><span class=\"line\">docker run -d --name=nginx01 -p 8991:80 nginx</span><br><span class=\"line\">curl 121.37.191.89:8991</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">whereis nginx 找到nginx</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装tomcat\"><a class=\"markdownIt-Anchor\" href=\"#安装tomcat\">#</a> 安装 tomcat</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --rm  tomcat /bin/bash   # rm用完就删，一般用于测试</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d -p 8877:8080 --name=tomcat01 tomcat</span><br><span class=\"line\">docker exec -it tomcat01 /bin/bash</span><br></pre></td></tr></table></figure>\n<h3 id=\"安装eskibana\"><a class=\"markdownIt-Anchor\" href=\"#安装eskibana\">#</a> 安装 es+kibana</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d --name es -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; elasticsearch</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">docker stats   # 查看cpu状态</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -d --name es2 -p 9200:9200 -p 9300:9300 -e &quot;discovery.type=single-node&quot; -e ES_JAVA_OPTS=&quot;-Xms64m -Xmx512m&quot; elasticsearch </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230330195235840.png\" alt=\"image-20230330195235840\"></p>\n<h2 id=\"可视化\"><a class=\"markdownIt-Anchor\" href=\"#可视化\">#</a> 可视化</h2>\n<p><strong>portainer</strong></p>\n<p><strong>Rancher</strong></p>\n<p>portainer docker 图形化界面管理工具</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -p 8088:9000 --restart=always -v /var/run/docker.sock:/var/run/docker.sock --privileged=true portainer/portainer</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331202120533.png\" alt=\"image-20230331202120533\"></p>\n<p>选择 local</p>\n<h2 id=\"联合文件系统\"><a class=\"markdownIt-Anchor\" href=\"#联合文件系统\">#</a> 联合文件系统</h2>\n<p>UnionFS</p>\n<p>UnionFS (联合文件系统）:Union 文件系统 (UnionFS) 是一种分层、轻量级并且高性能的文件系统，它支持对文件系统的修改作为一次提交来壬层层的叠加，同时可以将不同目录挂载到同一个虚拟文件系统下 (unite several directories into a single virtualfilesystem)。Union 文件系统是 Docker 镜像的基础。镜像可以通过分层来进行继承，基于基础镜像（没有父镜像），可以制作各种具体的应用镜像。</p>\n<p>特性∶一次同时加载多个文件系统，但从外面看起来，只能看到一个文件系统，联合加载会把各层文件系统叠加起来，这样最终的文件系统会包含所有底层的文件和目录</p>\n<p>bootfs (boot file system) 主要包含 bootloader 和 kernel, bootloader 主要是引导加载 kernel, Linux 刚启动时会加载 bootfs 文件系统，在 Docker 镜像的最底层 bootfs。这一层与我们典型的 LinuxlUnix 系统是一样的，包含 boot 加载器和内核。当 boot 加载完成之后整个内核就都在内存中了，此时内存的使用权已由 bootfs 转交给内核，此时系统也会卸载 bootfs。</p>\n<p>roots (root fle system)，在 boots 之上。包含的就是典型 Linux 系统中的 /dev, /proc, /bin, letc 等标准目录和文件。rootfs 就是各种不同的操作系统发行版，比如 Ubuntu，centos 等等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203141142.png\" alt=\"image-20230331203141142\"></p>\n<p>对于一个精简的 OS , rootfs 可以很小，只需要包含最基本的命令，工具和程序库就可以了，因为底层直接用 Host 的 kernel , 自己只需要提供 rootfs 就可以了。由此可见对于不同的 linux 发行版，bootfs 基本是一致的，rootfs 会有差别，因此不同的发行版可以公用<br>\n bootfs。</p>\n<h2 id=\"分层原理\"><a class=\"markdownIt-Anchor\" href=\"#分层原理\">#</a> 分层原理</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;RootFS&quot;: &#123;</span><br><span class=\"line\">            &quot;Type&quot;: &quot;layers&quot;,</span><br><span class=\"line\">            &quot;Layers&quot;: [</span><br><span class=\"line\">                &quot;sha256:6515074984c6f8bb1b8a9962c8fb5f310fc85e70b04c88442a3939c026dbfad3&quot;,</span><br><span class=\"line\">                &quot;sha256:4f169ae5a253d68d25f3f5fdd0deb31af20096bcffdec1fdda5cf8810d507d1f&quot;,</span><br><span class=\"line\">                &quot;sha256:edae32ac2ac2a7f24eebb4b62ad2fa0a9434f47f4b56a3739106e1da4cb1aa6a&quot;,</span><br><span class=\"line\">                &quot;sha256:f05805c5815d0394d09d3b64e3a58727f8d647f2c5a4d1fbb5e40ed5f8424e84&quot;,</span><br><span class=\"line\">                &quot;sha256:460c946f1b353b51ebb7548ea8f8127118d9bdc7be5f8f2c3c4e73fc9968d705&quot;,</span><br><span class=\"line\">                &quot;sha256:3241d073343d5c09cb9854032919de8fe88433c2867fac073a61ed5669e8cae8&quot;,</span><br><span class=\"line\">                &quot;sha256:f5c79923df4c5c22157139e199d0143e8af29ac0f11f73fd4a56759c1f080c05&quot;,</span><br><span class=\"line\">                &quot;sha256:a5d2135a0fbf3b167b687e40028e54e271588a2ece546bcdcf8da5751c4ba828&quot;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203518152.png\" alt=\"image-20230331203518152\"></p>\n<p>在添加额外的镜像层的同时，镜像始终保持是当前所有镜像的组合，理解这一点非常重要。下图中举了一个简单的例子，每个镜像层包含 3 个文件，而镜像包含了来自两个镜像层的 6 个文件。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203612551.png\" alt=\"image-20230331203612551\"></p>\n<p>下图中展示了一个稍微复杂的三层镜像，在外部看来整个镜像只有 6 个文件，这是因为最上层中的文件 7 是文件 5 的一个更新版本。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203723498.png\" alt=\"image-20230331203723498\"></p>\n<p>这种情况下，上层镜像层中的文件覆盖了底层镜像层中的文件。这样就使得文件的更新版本作为一个新镜像层添加到镜像当中。Docker 通过存储引擎 (新版本采用快照机制) 的方式来实现镜像层堆栈，并保证多镜像层对外展示为统一的文件系统。</p>\n<p>Linux 上可用的存储引擎有 AUFS、Overlay2、Device Mapper、Btrfs 以及 ZFS。顾名思义，每种存储引擎都基于 Linux 中对应的文件系统或者块设备技术，并且每种存储引擎都有其独有的性能特点。</p>\n<p>Docker 在 Windows 上仅支持 windowsfilter 一种存储引擎，该引擎基于 NTFS 文件系统之上实现了分层和 CoW [1]。下图展示了与系统显示相同的三层镜像。所有镜像层堆叠并合并，对外提供统一的视图。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331203816012.png\" alt=\"image-20230331203816012\"></p>\n<p>Docker 镜像都是只读的，当容器启动时，一个新的可写层被加载到镜像的顶部！</p>\n<p>这一层就是我们通常说的容器层，容器之下的都叫镜像层！</p>\n<h2 id=\"commit\"><a class=\"markdownIt-Anchor\" href=\"#commit\">#</a> commit</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker commit # 提交容器称为新的副本</span><br><span class=\"line\">docker commit -m=&quot;descriptor&quot; -a=&quot;author&quot; id  name:tag</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it -p 8898:8080 tomcat</span><br><span class=\"line\">docker exec -it ffcc /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">docker commit -a=&quot;shabi&quot; -m=&quot;webapp/&quot; ffccc tomcatshabi:1.22</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331205200662.png\" alt=\"image-20230331205200662\"></p>\n<p>通过 commit 提交后，在原始 tomcat 上面又增加了一层，所以文件会稍微变大一些</p>\n<h2 id=\"容器数据卷\"><a class=\"markdownIt-Anchor\" href=\"#容器数据卷\">#</a> 容器数据卷</h2>\n<p>如果数据都在容器中，容器删除数据就会丢失，不能持久化</p>\n<p>容器之间需要一个数据共享技术。docker 容器中产生的数据同步到本地，防止数据丢失</p>\n<p>其实就是目录挂载。将我们容器内的目录，挂载到虚拟机上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.数据卷在容器启动时初始化，如果容器使用的镜像在挂载点包含了数据，这些数据会被拷贝到新初始化的数据卷中</span><br><span class=\"line\">2.数据卷可以在容器之间共享和重用</span><br><span class=\"line\">3.可以对数据卷里的内容直接进行修改</span><br><span class=\"line\">4.数据卷的变化不会影像镜像的更新</span><br><span class=\"line\">5.卷会一直存在，即使挂载数据卷的容器已经被删除</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230331210323928.png\" alt=\"image-20230331210323928\"></p>\n<p>容器间数据也是可以共享的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v 主机目录:容器目录 -p 8767:8080</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it -v  /home/testing:/home -p 8767:8080 tomcat /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">&quot;Mounts&quot;: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                &quot;Type&quot;: &quot;bind&quot;,</span><br><span class=\"line\">                &quot;Source&quot;: &quot;/home/testing&quot;,    //主机地址</span><br><span class=\"line\">                &quot;Destination&quot;: &quot;/home&quot;,       //docker内地址</span><br><span class=\"line\">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class=\"line\">                &quot;RW&quot;: true,</span><br><span class=\"line\">                &quot;Propagation&quot;: &quot;rprivate&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ],</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>同步不受容器停止影响</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it -v  /usr/local/nginx/conf/nginx.conf:/usr/local/nginx/conf/nginx.conf -p 80:80 nginx /bin/bash</span><br></pre></td></tr></table></figure>\n<p>以后只需要本地修改即可，容器自动同步</p>\n<p>安装 mysql，并挂载数据卷</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -v /home/mysql_conf:/etc/mysql/conf.d/ -v /home/mysql_data:/var/lib/mysql  -p 3307:3306 -e MYSQL_ROOT_PASSWORD=123456 --name=mysql002  mysql</span><br><span class=\"line\"></span><br><span class=\"line\">mysql -uroot -p123456 -h121.37.191.89 -p3307</span><br></pre></td></tr></table></figure>\n<p>删除容器也不会丢失数据，但会占用两倍内存</p>\n<p>这就实现了容器持久化功能</p>\n<p><strong>具名挂载、匿名挂载</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-v 容器内路径 </span><br><span class=\"line\">docker run -d -P --name nginx01 -v /etc/nginx nginx</span><br><span class=\"line\"></span><br><span class=\"line\"># 查看卷的情况</span><br><span class=\"line\">[root@hecs-346515 ~]# docker volume ls</span><br><span class=\"line\">DRIVER    VOLUME NAME</span><br><span class=\"line\">local     879266c77b0964e9bca1b3a1f6cf4d6089eb18d9b9c9e549d0c41357f6dc5a35</span><br><span class=\"line\">local     dirtycow-vdso</span><br><span class=\"line\">local     ee9d314e1c5f3010b8d64108293246853c90d3d820c20332c338ed9bdd3f168b</span><br><span class=\"line\">local     f3924de885d11729faa0c5869488fd0aefca9e3f6bcaddc36c9ce95f4e891603</span><br><span class=\"line\">local     fd3d617a1c288349a4717e3a73e63dbbcf900c51f2d69fe30f9fa726ac82a08d</span><br><span class=\"line\">没有名称的就是匿名挂载</span><br><span class=\"line\"></span><br><span class=\"line\"># 具名挂载</span><br><span class=\"line\">docker run -d -P --name nginx01 -v juming_nginx:/etc/nginx nginx</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker volume inspect juming_nginx</span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;CreatedAt&quot;: &quot;2023-04-02T21:42:24+08:00&quot;,</span><br><span class=\"line\">        &quot;Driver&quot;: &quot;local&quot;,</span><br><span class=\"line\">        &quot;Labels&quot;: null,</span><br><span class=\"line\">        &quot;Mountpoint&quot;: &quot;/var/lib/docker/volumes/juming_nginx/_data&quot;,</span><br><span class=\"line\">        &quot;Name&quot;: &quot;juming_nginx&quot;,</span><br><span class=\"line\">        &quot;Options&quot;: null,</span><br><span class=\"line\">        &quot;Scope&quot;: &quot;local&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"># 所有docker内的卷，没有指定目录的情况下都在/var/lib/docker/volumes/</span><br><span class=\"line\"></span><br><span class=\"line\">我们通过具名挂载可以方便的找到一个卷</span><br></pre></td></tr></table></figure>\n<p>如何区分指定路径和匿名挂载</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-v 容器内路径   匿名</span><br><span class=\"line\">-v 卷名:容器内路径 具名</span><br><span class=\"line\">-v /usr/local:/etc/nginx/ 路径</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-v 容器内路径:rw/ro 改变读写权限</span><br><span class=\"line\">docker run -d -P --name nginx01 -v juming_nginx:/etc/nginx:ro nginx</span><br><span class=\"line\">readonly readwrite</span><br><span class=\"line\"></span><br><span class=\"line\">一旦设置了容器容器权限，对我们挂载出来的内容有限定</span><br><span class=\"line\">默认是rw，ro说明只能通过宿主机操作，容器内部无法操作</span><br></pre></td></tr></table></figure>\n<h2 id=\"dockerfile挂载\"><a class=\"markdownIt-Anchor\" href=\"#dockerfile挂载\">#</a> Dockerfile 挂载</h2>\n<p>dockerfile 就是用来构建 docker 镜像的文件</p>\n<p>镜像是一层层的，命令也是一层层的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos</span><br><span class=\"line\"></span><br><span class=\"line\">VOLUME [&quot;voume01&quot;,&quot;volume02&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">CMD echo &quot;---------------&quot;</span><br><span class=\"line\">CMD /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 docker-test]# docker build -f ./dockerfile1 -t hahaha .</span><br><span class=\"line\">[+] Building 0.1s (5/5) FINISHED                                                                 </span><br><span class=\"line\"> =&gt; [internal] load build definition from dockerfile1                                       0.1s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 123B                                                        0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                           0.1s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                             0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/centos:latest                            0.0s</span><br><span class=\"line\"> =&gt; [1/1] FROM docker.io/library/centos                                                     0.0s</span><br><span class=\"line\"> =&gt; exporting to image                                                                      0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                     0.0s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:29755edf1ce7d5c71c2c7cbbf8b0bd54f02ce72a4ebcaccdfd857aa0dcb99e  0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/hahaha                                                   0.0s</span><br><span class=\"line\"></span><br><span class=\"line\"># 这里的每个命令都是镜像的一层</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 docker-test]# docker run -it hahaha /bin/bash </span><br><span class=\"line\">[root@74ee4cc3e927 /]# ls </span><br><span class=\"line\">bin  etc   lib\t  lost+found  mnt  proc  run   srv  tmp  var\t   voume01</span><br><span class=\"line\">dev  home  lib64  media       opt  root  sbin  sys  usr  volume02</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"> &quot;Mounts&quot;: [</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class=\"line\">                &quot;Name&quot;: &quot;eb0e7a226b19aa2e8811eabaf339cf3cee05f3fec433af62212607e0010bda2e&quot;,</span><br><span class=\"line\">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/eb0e7a226b19aa2e8811eabaf339cf3cee05f3fec433af62212607e0010bda2e/_data&quot;,</span><br><span class=\"line\">                &quot;Destination&quot;: &quot;volume02&quot;,</span><br><span class=\"line\">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class=\"line\">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class=\"line\">                &quot;RW&quot;: true,</span><br><span class=\"line\">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &#123;</span><br><span class=\"line\">                &quot;Type&quot;: &quot;volume&quot;,</span><br><span class=\"line\">                &quot;Name&quot;: &quot;8b52d9050ada34758bacfe403a63a5b6a06e0c96cadb86830fa16aa9533a6fc8&quot;,</span><br><span class=\"line\">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/8b52d9050ada34758bacfe403a63a5b6a06e0c96cadb86830fa16aa9533a6fc8/_data&quot;,</span><br><span class=\"line\">                &quot;Destination&quot;: &quot;voume01&quot;,</span><br><span class=\"line\">                &quot;Driver&quot;: &quot;local&quot;,</span><br><span class=\"line\">                &quot;Mode&quot;: &quot;&quot;,</span><br><span class=\"line\">                &quot;RW&quot;: true,</span><br><span class=\"line\">                &quot;Propagation&quot;: &quot;&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        ],</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>构建镜像的时候没有挂载均，需要手动 - v 挂载</p>\n<h2 id=\"数据卷容器\"><a class=\"markdownIt-Anchor\" href=\"#数据卷容器\">#</a> 数据卷容器</h2>\n<p>实现容器之间同步数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230402220831342.png\" alt=\"image-20230402220831342\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --name docker01 hahaha </span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it --name docker02 --volumes-from docker01 hahaha</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>父容器删除，其他容器的文件依然在</p>\n<p>所有父容器和子容器都挂载在宿主机的文件中，如果宿主机挂载目录没了，三个容器都没了</p>\n<p>数据卷的声明周期一直到没有容器使用位置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rm -rf /etc/yum.repos.d/*</span><br><span class=\"line\">curl -o /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo</span><br><span class=\"line\">yum install wget -y</span><br><span class=\"line\">yum install nginx -y </span><br></pre></td></tr></table></figure>\n<h3 id=\"docker数据卷备份与还原\"><a class=\"markdownIt-Anchor\" href=\"#docker数据卷备份与还原\">#</a> docker 数据卷备份与还原</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run  --volumes-from [container name] -v $(pwd):/backup centos tar czvf /backup/backup.tar [container data volume]</span><br><span class=\"line\"></span><br><span class=\"line\">例子：备份datavolume6 到/backup </span><br><span class=\"line\">docker run --volumes-from data-volume2  -v  /root/backup:/backup --name datavolume-copy centos tar zcvf /backup/data-volume2.tar.gz /datavolume6</span><br><span class=\"line\"></span><br><span class=\"line\">还原备份</span><br><span class=\"line\">docker run --volumes-from [container name] -v $(pwd):/backup centos tar xzvf /backup/backup.tar.gz [container data volume]</span><br><span class=\"line\"></span><br><span class=\"line\">例：</span><br><span class=\"line\">docker run --volumes-from data-volume2 -v /root/backup/:/backup centos tar zxvf /backup/data-volume2.tar.gz -C /datavolume6</span><br></pre></td></tr></table></figure>\n<h2 id=\"dockerfile\"><a class=\"markdownIt-Anchor\" href=\"#dockerfile\">#</a> Dockerfile</h2>\n<p>dockerfile 是用来构建 dockerfile 的镜像文件，命令参数脚本</p>\n<p>一个基本 dockerfile</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos</span><br><span class=\"line\">MAINTAINER xianchao</span><br><span class=\"line\">RUN <span class=\"built_in\">rm</span> -rf /etc/yum.repos.d/*</span><br><span class=\"line\">COPY Centos-vault-8.5.2111.repo /etc/yum.repos.d/</span><br><span class=\"line\">RUN yum install wget -y</span><br><span class=\"line\">RUN yum install nginx -y</span><br><span class=\"line\">COPY index.html /usr/share/nginx/html/</span><br><span class=\"line\">EXPOSE 80</span><br><span class=\"line\">ENTRYPOINT [<span class=\"string\">&quot;/usr/sbin/nginx&quot;</span>,<span class=\"string\">&quot;-g&quot;</span>,<span class=\"string\">&quot;daemon off;&quot;</span>] </span><br><span class=\"line\"><span class=\"comment\"># nginx时钟前台运行，避免容器自动退出</span></span><br></pre></td></tr></table></figure>\n<p>1. 编写 dockerfile</p>\n<p>2.docker build 构建成为镜像</p>\n<p>3.docker run 运行镜像</p>\n<p>4.docker push 发布镜像</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230402224507380.png\" alt=\"image-20230402224507380\"></p>\n<p>每个关键字都是大写字母</p>\n<p>执行从上到下</p>\n<p>#表示注释</p>\n<p>每一个指令都会创建一个新的镜像层，并提交</p>\n<p>发布项目都要发布 dockerfile</p>\n<p>dockerfile 构建文件，定义了一切的步骤，源代码</p>\n<p>dockerimages 通过 dockerfile 生成的镜像，最终发布和运行的版本</p>\n<p>docker 容器：容器就是镜像运行起来提供服务</p>\n<h3 id=\"dockerfile指令\"><a class=\"markdownIt-Anchor\" href=\"#dockerfile指令\">#</a> dockerfile 指令</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM     \t# 基础镜像</span><br><span class=\"line\"></span><br><span class=\"line\">MAINTAINER \t# 维护者信息</span><br><span class=\"line\"></span><br><span class=\"line\">RUN \t\t# 镜像构建的时候需要运行的命令</span><br><span class=\"line\">包含两种模式</span><br><span class=\"line\">1、Shell</span><br><span class=\"line\">RUN &lt;command&gt; (shell模式，这个是最常用的，需要记住)</span><br><span class=\"line\">RUN echo hello</span><br><span class=\"line\">2、exec模式</span><br><span class=\"line\">RUN [“executable”，“param1”，“param2”](exec模式)</span><br><span class=\"line\">RUN [“/bin/bash”,”-c”,”echo hello”]</span><br><span class=\"line\">等价于/bin/bash -c echo hello</span><br><span class=\"line\">RUN yum install wget -y等价于</span><br><span class=\"line\">RUN [“/bin/bash”,”-c”,”yum install wget -y”]</span><br><span class=\"line\"></span><br><span class=\"line\">WORKDIR \t# 镜像工作目录</span><br><span class=\"line\">进容器之后的目录</span><br><span class=\"line\">docker build 构建镜像过程中的，每一个 RUN 命令都是新建的一层。只有通过 WORKDIR 创建的目录才会一直存在。</span><br><span class=\"line\"></span><br><span class=\"line\">volume\t\t# 设置容器卷，挂载到那个位置</span><br><span class=\"line\">1、避免重要的数据，因容器重启而丢失，这是非常致命的。</span><br><span class=\"line\">2、避免容器不断变大。</span><br><span class=\"line\">VOLUME [&quot;/data&quot;]</span><br><span class=\"line\">物理机随机生成一个目录映射到容器中/data</span><br><span class=\"line\">在启动容器 docker run 的时候，我们可以通过 -v 参数修改挂载点</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE\t\t# 指定暴露端口</span><br><span class=\"line\">1、帮助镜像使用者理解这个镜像服务的守护端口，以方便配置映射。</span><br><span class=\"line\">2、在运行时使用随机端口映射时，也就是 docker run -P 时，会自动随机映射 EXPOSE 的端口。</span><br><span class=\"line\">3、可以是一个或者多个端口，也可以指定多个EXPOSE</span><br><span class=\"line\"></span><br><span class=\"line\">CMD\t\t\t# 指定容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span><br><span class=\"line\">1、CMD 在docker run 时运行。</span><br><span class=\"line\">2、RUN 是在 docker build构建镜像时运行的</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT\t# 指定容器启动的时候要运行的命令，可以追加命令</span><br><span class=\"line\">类似于 CMD 指令，但其不会被 docker run 的命令行参数指定的指令所覆盖，而且这些命令行参数会被当作参数送给 ENTRYPOINT 指令指定的程序。</span><br><span class=\"line\">但是, 如果运行 docker run 时使用了 --entrypoint 选项，将覆盖 entrypoint指令指定的程序。</span><br><span class=\"line\">优点：在执行 docker run 的时候可以指定 ENTRYPOINT 运行所需的参数。</span><br><span class=\"line\">注意：如果 Dockerfile 中如果存在多个 ENTRYPOINT 指令，仅最后一个生效。</span><br><span class=\"line\">注意：如果 Dockerfile 中如果存在多个 CMD 指令，仅最后一个生效。</span><br><span class=\"line\">可以搭配 CMD 命令使用：一般是变参才会使用 CMD ，这里的 CMD 等于是在给 ENTRYPOINT 传参</span><br><span class=\"line\">ENTRYPOINT [&quot;nginx&quot;, &quot;-c&quot;] # 定参</span><br><span class=\"line\">CMD [&quot;/etc/nginx/nginx.conf&quot;] # 变参 </span><br><span class=\"line\">不传参运行会 运行nginx -c /etc/nginx/nginx.conf</span><br><span class=\"line\">参参运行 docker run --name nginx  nginx:test /etc/nginx/new.conf  会运行nginx -c /etc/nginx/new.conf</span><br><span class=\"line\"></span><br><span class=\"line\">ONBUILD\t\t# 当构建一个被继承Dockerfile，这个时候就会运行ONBUILD指令</span><br><span class=\"line\">用于延迟构建命令的执行。简单的说，就是 Dockerfile 里用 ONBUILD 指定的命令，在本次构建镜像的过程中不会执行（假设镜像为 test-build）。当有新的 Dockerfile 使用了之前构建的镜像 FROM test-build ，这时执行新镜像的 Dockerfile 构建时候，会执行 test-build 的 Dockerfile 里的 ONBUILD 指定的命令。</span><br><span class=\"line\">ONBUILD COPY index.html /usr/share/nginx/html/</span><br><span class=\"line\">docker build -t=&quot;onbuild-nginx:v1&quot; . --load</span><br><span class=\"line\">只有当某一个dockerfile把onbuild-nginx作为基础镜像时ONBUILD才会执行</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CPOY\t\t# 将文件拷贝到镜像中</span><br><span class=\"line\">COPY [--chown=&lt;user&gt;:&lt;group&gt;] &lt;源路径1&gt;...  &lt;目标路径&gt;</span><br><span class=\"line\">COPY [--chown=&lt;user&gt;:&lt;group&gt;] [&quot;&lt;源路径1&gt;&quot;,...  &quot;&lt;目标路径&gt;&quot;]</span><br><span class=\"line\">COPY hom* /mydir/</span><br><span class=\"line\">COPY hom?.txt /mydir/</span><br><span class=\"line\"></span><br><span class=\"line\">ADD \t\t# 步骤：如果搭建tomcat，压缩包就需要add</span><br><span class=\"line\">ADD 的优点：在执行 &lt;源文件&gt; 为 tar 压缩文件的话，压缩格式为 gzip, bzip2 以及 xz 的情况下，会自动复制并解压到 &lt;目标路径&gt;。</span><br><span class=\"line\">ADD 的缺点：在不解压的前提下，无法复制 tar 压缩文件。会令镜像构建缓存失效，从而可能会令镜像构建变得比较缓慢。具体是否使用，可以根据是否需要自动解压来决定。</span><br><span class=\"line\">ADD 指令和 COPY 的使用格式一致</span><br><span class=\"line\"></span><br><span class=\"line\">ENV\t\t\t# 构建的时候设置环境变量</span><br><span class=\"line\">ENV &lt;key&gt; &lt;value&gt;</span><br><span class=\"line\">ENV &lt;key&gt;=&lt;value&gt;...</span><br><span class=\"line\">ENV NODE_VERSION 6.6.6</span><br><span class=\"line\">RUN curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/node-v$NODE_VERSION-linux-x64.tar.xz&quot; \\</span><br><span class=\"line\">  &amp;&amp; curl -SLO &quot;https://nodejs.org/dist/v$NODE_VERSION/SHASUMS256.txt.asc&quot;</span><br><span class=\"line\"> </span><br><span class=\"line\">USER </span><br><span class=\"line\">用于指定执行后续命令的用户和用户组，这边只是切换后续命令执行的用户（用户和用户组必须提前已经存在）。</span><br><span class=\"line\">格式：</span><br><span class=\"line\">USER &lt;用户名&gt;[:&lt;用户组&gt;]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>dockerhub 中大部分镜像都是从 FROM scratch 来的，然后配置需要的软件和配置来进行构建</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建一个centos</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> centos:<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> shabi&lt;<span class=\"number\">21111</span>@qq.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> MYPATH /usr/local</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> <span class=\"variable\">$MYPATH</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install epel* -y</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install -y vim</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install -y net-tools</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">80</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> <span class=\"built_in\">echo</span> <span class=\"variable\">$MYPATH</span></span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> /bin/bash</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 构建镜像</span></span><br><span class=\"line\">docker build -f dockerfile -t centoshaha:<span class=\"number\">0.5</span> . </span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-<span class=\"number\">346515</span> dockerfile]<span class=\"comment\"># docker build -f dockerfile -t centoshaha:0.5 . </span></span><br><span class=\"line\">[+] Building <span class=\"number\">199.4</span>s (<span class=\"number\">5</span>/<span class=\"number\">7</span>)                                                                                             </span><br><span class=\"line\">[+] Building <span class=\"number\">200.1</span>s (<span class=\"number\">5</span>/<span class=\"number\">7</span>)                                                                                             </span><br><span class=\"line\">[+] Building <span class=\"number\">200.6</span>s (<span class=\"number\">5</span>/<span class=\"number\">7</span>)                                                                                             </span><br><span class=\"line\">[+] Building <span class=\"number\">200.9</span>s (<span class=\"number\">5</span>/<span class=\"number\">7</span>)                                                                                             </span><br><span class=\"line\">[+] Building <span class=\"number\">228.0</span>s (<span class=\"number\">8</span>/<span class=\"number\">8</span>) FINISHED                                                                                    </span><br><span class=\"line\"> =&gt; [internal] load build definition <span class=\"keyword\">from</span> dockerfile                                                             <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: <span class=\"number\">219</span>B                                                                             <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: <span class=\"number\">2</span>B                                                                                  <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/centos:<span class=\"number\">7</span>                                                     <span class=\"number\">16.0</span>s</span><br><span class=\"line\"> =&gt; [<span class=\"number\">1</span>/<span class=\"number\">4</span>] <span class=\"keyword\">FROM</span> docker.io/library/centos:<span class=\"number\">7</span>@sha256:<span class=\"number\">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e0  <span class=\"number\">50.2</span>s</span><br><span class=\"line\"> =&gt; =&gt; resolve docker.io/library/centos:<span class=\"number\">7</span>@sha256:<span class=\"number\">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e09  <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; sha256:<span class=\"number\">9</span>d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426a630e0987 <span class=\"number\">1.20</span>kB / <span class=\"number\">1.20</span>kB                   <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; sha256:dead07b4d8ed7e29e98de0f4504d87e8880d4347859d839686a31da35a3b532f <span class=\"number\">529</span>B / <span class=\"number\">529</span>B                       <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; sha256:eeb6ee3f44bd0b5103bb561b4c16bcb82328cfe5809ab675bb17ab3a16c517c9 <span class=\"number\">2.75</span>kB / <span class=\"number\">2.75</span>kB                   <span class=\"number\">0.0</span>s</span><br><span class=\"line\"> =&gt; =&gt; sha256:<span class=\"number\">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43f2553732b55df3bc <span class=\"number\">76.10</span>MB / <span class=\"number\">76.10</span>MB                <span class=\"number\">46.3</span>s</span><br><span class=\"line\"> =&gt; =&gt; extracting sha256:<span class=\"number\">2</span>d473b07cdd5f0912cd6f1a703352c82b512407db6b05b43f2553732b55df3bc                        <span class=\"number\">3.6</span>s</span><br><span class=\"line\"> =&gt; [<span class=\"number\">2</span>/<span class=\"number\">4</span>] <span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /usr/local                                                                                     0.0s</span></span><br><span class=\"line\"> =&gt; [<span class=\"number\">3</span>/<span class=\"number\">4</span>] <span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install -y vim                                                                               156.1s</span></span><br><span class=\"line\"> =&gt; [<span class=\"number\">4</span>/<span class=\"number\">4</span>] <span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install -y net-tools                                                                           2.9s</span></span><br><span class=\"line\"> =&gt; exporting to image                                                                                           <span class=\"number\">2.7</span>s </span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                          <span class=\"number\">2.7</span>s </span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:<span class=\"number\">1</span>c525b4438024495ebbbf1f19a3e3ea730826dfcab5cb8337ea0fa0a0de853ad                     <span class=\"number\">0.0</span>s </span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/centoshaha:<span class=\"number\">0.5</span>    </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404110343127.png\" alt=\"image-20230404110343127\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 dockerfile]# docker history 1c5</span><br><span class=\"line\">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class=\"line\">1c525b443802   4 minutes ago   CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;/bin/bash&quot;]                0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      4 minutes ago   CMD [&quot;/bin/sh&quot; &quot;-c&quot; &quot;echo $MYPATH&quot;]             0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      4 minutes ago   EXPOSE map[80/tcp:&#123;&#125;]                           0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c yum install -y net-tools # bu…   176MB     buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      4 minutes ago   RUN /bin/sh -c yum install -y vim # buildkit    259MB     buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      7 minutes ago   WORKDIR /usr/local                              0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      7 minutes ago   ENV MYPATH=/usr/local                           0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      7 minutes ago   MAINTAINER shabi&lt;21111@qq.com&gt;                  0B        buildkit.dockerfile.v0</span><br><span class=\"line\">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class=\"line\">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class=\"line\">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop) ADD file:b3ebbe8bd304723d4…   204MB     </span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker history 5d0</span><br><span class=\"line\">IMAGE          CREATED         CREATED BY                                      SIZE      COMMENT</span><br><span class=\"line\">5d0da3dc9764   18 months ago   /bin/sh -c #(nop)  CMD [&quot;/bin/bash&quot;]            0B        </span><br><span class=\"line\">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop)  LABEL org.label-schema.sc…   0B        </span><br><span class=\"line\">&lt;missing&gt;      18 months ago   /bin/sh -c #(nop) ADD file:805cb5e15fb6e0bb0…   231MB     </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM centos:7</span><br><span class=\"line\">CMD [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker build -f cmd  -t cmd:0.5 . </span><br><span class=\"line\">[+] Building 0.3s (5/5) FINISHED                                                                                      </span><br><span class=\"line\"> =&gt; [internal] load build definition from cmd                                                                    0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 60B                                                                              0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/centos:7                                                      0.2s</span><br><span class=\"line\"> =&gt; CACHED [1/1] FROM docker.io/library/centos:7@sha256:9d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426  0.0s</span><br><span class=\"line\"> =&gt; exporting to image                                                                                           0.0s</span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                          0.0s</span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:3ced42c5b7de1bbe7659ef7bd2349ebf83eb13eab6d1afe69f029ef65a88f9ab                     0.0s</span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/cmd:0.5                                                                       0.0s</span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker run -it cmd:0.5 </span><br><span class=\"line\">.   .dockerenv\t       bin  etc   lib\t media\topt   root  sbin  sys  usr</span><br><span class=\"line\">..  anaconda-post.log  dev  home  lib64  mnt\tproc  run   srv   tmp  var</span><br><span class=\"line\"></span><br><span class=\"line\">CMD\t\t\t# 指定容器启动的时候要运行的命令，只有最后一个会生效，可被替代</span><br><span class=\"line\"></span><br><span class=\"line\">docker run 3e -l    # -l不是命令所以报错</span><br><span class=\"line\"></span><br><span class=\"line\">docker run 3e ls -al  ls -al 替换了ls -a</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim entry</span><br><span class=\"line\">FROM centos:7</span><br><span class=\"line\">ENTRYPOINT [&quot;ls&quot;,&quot;-a&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker run entry:0.5</span><br><span class=\"line\">.</span><br><span class=\"line\">..</span><br><span class=\"line\">.dockerenv</span><br><span class=\"line\">anaconda-post.log</span><br><span class=\"line\">bin</span><br><span class=\"line\">dev</span><br><span class=\"line\">etc</span><br><span class=\"line\">home</span><br><span class=\"line\">lib</span><br><span class=\"line\">lib64</span><br><span class=\"line\">media</span><br><span class=\"line\">mnt</span><br><span class=\"line\">opt</span><br><span class=\"line\">proc</span><br><span class=\"line\">root</span><br><span class=\"line\">run</span><br><span class=\"line\">sbin</span><br><span class=\"line\">srv</span><br><span class=\"line\">sys</span><br><span class=\"line\">tmp</span><br><span class=\"line\">usr</span><br><span class=\"line\">var</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker run entry:0.5 -l</span><br><span class=\"line\">total 64</span><br><span class=\"line\">drwxr-xr-x   1 root root  4096 Apr  4 03:18 .</span><br><span class=\"line\">drwxr-xr-x   1 root root  4096 Apr  4 03:18 ..</span><br><span class=\"line\">-rwxr-xr-x   1 root root     0 Apr  4 03:18 .dockerenv</span><br><span class=\"line\">-rw-r--r--   1 root root 12114 Nov 13  2020 anaconda-post.log</span><br><span class=\"line\">lrwxrwxrwx   1 root root     7 Nov 13  2020 bin -&gt; usr/bin</span><br><span class=\"line\">drwxr-xr-x   5 root root   340 Apr  4 03:18 dev</span><br><span class=\"line\">drwxr-xr-x   1 root root  4096 Apr  4 03:18 etc</span><br><span class=\"line\">drwxr-xr-x   2 root root  4096 Apr 11  2018 home</span><br><span class=\"line\">lrwxrwxrwx   1 root root     7 Nov 13  2020 lib -&gt; usr/lib</span><br><span class=\"line\">lrwxrwxrwx   1 root root     9 Nov 13  2020 lib64 -&gt; usr/lib64</span><br><span class=\"line\">drwxr-xr-x   2 root root  4096 Apr 11  2018 media</span><br><span class=\"line\">drwxr-xr-x   2 root root  4096 Apr 11  2018 mnt</span><br><span class=\"line\">drwxr-xr-x   2 root root  4096 Apr 11  2018 opt</span><br><span class=\"line\">dr-xr-xr-x 134 root root     0 Apr  4 03:18 proc</span><br><span class=\"line\">dr-xr-x---   2 root root  4096 Nov 13  2020 root</span><br><span class=\"line\">drwxr-xr-x  11 root root  4096 Nov 13  2020 run</span><br><span class=\"line\">lrwxrwxrwx   1 root root     8 Nov 13  2020 sbin -&gt; usr/sbin</span><br><span class=\"line\">drwxr-xr-x   2 root root  4096 Apr 11  2018 srv</span><br><span class=\"line\">dr-xr-xr-x  13 root root     0 Apr  4 03:18 sys</span><br><span class=\"line\">drwxrwxrwt   7 root root  4096 Nov 13  2020 tmp</span><br><span class=\"line\">drwxr-xr-x  13 root root  4096 Nov 13  2020 usr</span><br><span class=\"line\">drwxr-xr-x  18 root root  4096 Nov 13  2020 var</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT\t# 指定容器启动的时候要运行的命令，可以追加命令</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>entrypoint 是追加，CMD 是覆盖</p>\n</blockquote>\n<h3 id=\"制作nginx镜像\"><a class=\"markdownIt-Anchor\" href=\"#制作nginx镜像\">#</a> 制作 nginx 镜像</h3>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> centos</span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> xianchao</span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">rm</span> -rf /etc/yum.repos.d/*</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> Centos-vault-8.5.2111.repo /etc/yum.repos.d/</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install wget -y</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install nginx -y</span></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> index.html /usr/share/nginx/html/</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">80</span></span><br><span class=\"line\"><span class=\"keyword\">ENTRYPOINT</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/usr/sbin/nginx&quot;</span>,<span class=\"string\">&quot;-g&quot;</span>,<span class=\"string\">&quot;daemon off;&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 构建</span></span><br><span class=\"line\">docker build -t=<span class=\"string\">&quot;shinya/shabi:v1&quot;</span> .</span><br><span class=\"line\"></span><br><span class=\"line\">docker <span class=\"keyword\">run</span><span class=\"language-bash\"> -d  -p 80 --name html2 shinya/shabi:v1</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"制作tomcat镜像\"><a class=\"markdownIt-Anchor\" href=\"#制作tomcat镜像\">#</a> 制作 tomcat 镜像</h3>\n<p>1、准备安装包</p>\n<p>2、Dockerfile 是官方命名，构建时会自动寻找，就不需要 - f 指定了</p>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">FROM</span> centos:<span class=\"number\">7</span></span><br><span class=\"line\"><span class=\"keyword\">MAINTAINER</span> shshshs&lt;<span class=\"number\">110</span>@<span class=\"number\">110</span>.com&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">COPY</span><span class=\"language-bash\"> readme.txt /usr/local/readme.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> apache-tomcat-10.1.7.tar.gz  /usr/local/</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> jdk-20_linux-x64_bin.tar.gz  /usr/local/</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> yum install -y vim</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> MYPATH /usr/local/</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> <span class=\"variable\">$MYPATH</span></span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> JAVA_HOME /usr/local/jdk-<span class=\"number\">20</span></span><br><span class=\"line\"><span class=\"keyword\">ENV</span> CLASS_PATH $JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> CATALINA_HOME /usr/local/apache-tomcat-<span class=\"number\">10.1</span>.<span class=\"number\">7</span>/</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> CATALINA_BASE /usr/local/apache-tomcat-<span class=\"number\">10.1</span>.<span class=\"number\">7</span>/</span><br><span class=\"line\"><span class=\"keyword\">ENV</span> PATH $PATH:$JAVA_HOME/bin:$CATALINA_HOME/lib:$CATALINA_HOME/bin</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">8080</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> /usr/local/apache-tomcat-10.1.7/bin/startup.sh &amp;&amp; <span class=\"built_in\">tail</span> -F /usr/local/apache-tomcat-10.1.7/logs/catalina.out</span></span><br></pre></td></tr></table></figure>\n<p>3. 构建镜像</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 dockerfile]# docker build -t ddcat:1.0 .</span><br><span class=\"line\">[+] Building 61.4s (11/11) FINISHED                                                                                   </span><br><span class=\"line\"> =&gt; [internal] load build definition from Dockerfile                                                             0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring dockerfile: 690B                                                                             0.0s</span><br><span class=\"line\"> =&gt; [internal] load .dockerignore                                                                                0.0s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 2B                                                                                  0.0s</span><br><span class=\"line\"> =&gt; [internal] load metadata for docker.io/library/centos:7                                                     15.3s</span><br><span class=\"line\"> =&gt; CACHED [1/6] FROM docker.io/library/centos:7@sha256:9d4bcbbb213dfd745b58be38b13b996ebb5ac315fe75711bd618426  0.0s</span><br><span class=\"line\"> =&gt; [internal] load build context                                                                                2.3s</span><br><span class=\"line\"> =&gt; =&gt; transferring context: 203.75MB                                                                            2.3s</span><br><span class=\"line\"> =&gt; [2/6] COPY readme.txt /usr/local/readme.txt                                                                  0.5s</span><br><span class=\"line\"> =&gt; [3/6] ADD apache-tomcat-10.1.7.tar.gz  /usr/local/                                                           0.4s</span><br><span class=\"line\"> =&gt; [4/6] ADD jdk-20_linux-x64_bin.tar.gz  /usr/local/                                                           4.6s</span><br><span class=\"line\"> =&gt; [5/6] RUN yum install -y vim                                                                                34.4s</span><br><span class=\"line\"> =&gt; [6/6] WORKDIR /usr/local/                                                                                    0.0s </span><br><span class=\"line\"> =&gt; exporting to image                                                                                           3.8s </span><br><span class=\"line\"> =&gt; =&gt; exporting layers                                                                                          3.8s </span><br><span class=\"line\"> =&gt; =&gt; writing image sha256:620e725ff485b1cae36720ea191ba0692cc5f2a857e516528e5b65653e752913                     0.0s </span><br><span class=\"line\"> =&gt; =&gt; naming to docker.io/library/ddcat:1.0                                                                     0.0s </span><br><span class=\"line\"> </span><br><span class=\"line\"></span><br><span class=\"line\">4.启动镜像</span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker run -d -p 8877:8080 --name=catcatcat -v /root/dockerfile/build/tomcat/test:/usr/local/apache-tomcat-10.1.7/webapps/test -v /root/dockerfile/build/tomcat/logs:/usr/local/apache-tomcat-10.1.7/logs ddcat:1.1</span><br><span class=\"line\">4357a9cda1d960125ac7d4ab052902ec04848c0dbbce3beb26bccf4eaff84fa4</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>5、访问测试</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404124622232.png\" alt=\"image-20230404124622232\"></p>\n<p>6. 发布项目</p>\n<figure class=\"highlight xml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?xml version=<span class=\"string\">&quot;1.0&quot;</span> encoding=<span class=\"string\">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">web-app</span> <span class=\"attr\">version</span>=<span class=\"string\">&quot;2.4&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xmlns</span>=<span class=\"string\">&quot;http://java.sun.com/xml/ns/j2ee&quot;</span> </span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xmlns:xsi</span>=<span class=\"string\">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class=\"line\"><span class=\"tag\">    <span class=\"attr\">xsi:schemaLocation</span>=<span class=\"string\">&quot;http://java.sun.com/xml/ns/j2ee </span></span></span><br><span class=\"line\"><span class=\"string\"><span class=\"tag\">        http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">web-app</span>&gt;</span>                                   </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight jsp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;%@ page contentType=<span class=\"string\">&quot;text/html;charset=UTF-8&quot;</span> language=<span class=\"string\">&quot;java&quot;</span> %&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;%--    &lt;meta charset=<span class=\"string\">&quot;UTF-8&quot;</span>&gt;--%&gt;</span><br><span class=\"line\">&lt;%--    &lt;meta http-equiv=<span class=\"string\">&quot;X-UA-Compatible&quot;</span> content=<span class=\"string\">&quot;IE=edge&quot;</span>&gt;--%&gt;</span><br><span class=\"line\">&lt;%--    &lt;meta name=<span class=\"string\">&quot;viewport&quot;</span> content=<span class=\"string\">&quot;width=device-width, initial-scale=1.0&quot;</span>&gt;--%&gt;</span><br><span class=\"line\">    &lt;title&gt;Title&lt;/title&gt;</span><br><span class=\"line\">    &lt;link rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;css/bootstrap.min.css&quot;</span>&gt;</span><br><span class=\"line\">    &lt;link rel=<span class=\"string\">&quot;stylesheet&quot;</span> href=<span class=\"string\">&quot;css/bootstrap.min.css.map&quot;</span>&gt;</span><br><span class=\"line\">    &lt;script type=<span class=\"string\">&quot;text/javascript&quot;</span> src=<span class=\"string\">&quot;js/jquery-3.5.1.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">    &lt;script type=<span class=\"string\">&quot;text/javascript&quot;</span> src=<span class=\"string\">&quot;js/bootstrap.min.js&quot;</span>&gt;&lt;/script&gt;</span><br><span class=\"line\">    &lt;script type=<span class=\"string\">&quot;text/javascript&quot;</span>&gt;</span><br><span class=\"line\">        $(function () &#123;</span><br><span class=\"line\">            $.ajax(&#123;</span><br><span class=\"line\">                url: <span class=\"string\">&quot;$&#123;pageContext.request.contextPath&#125;/type?method=findAllType&quot;</span>,</span><br><span class=\"line\">                type: <span class=\"string\">&quot;GET&quot;</span>,</span><br><span class=\"line\">                dataType: <span class=\"string\">&quot;json&quot;</span>,</span><br><span class=\"line\">                success: function (data) &#123;</span><br><span class=\"line\">                    <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> i in data) &#123;</span><br><span class=\"line\">                        <span class=\"type\">var</span> <span class=\"variable\">a</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;&lt;li&gt;&lt;a href=&#x27;$&#123;pageContext.request.contextPath&#125;/product?method=show&amp;tid=&quot;</span> + data[i].tid + <span class=\"string\">&quot;&#x27;&gt;&quot;</span> + data[i].tname + <span class=\"string\">&quot;&lt;/a&gt;&lt;/li&gt;&quot;</span>;</span><br><span class=\"line\">                        $(<span class=\"string\">&quot;#goodsType&quot;</span>).append(a);</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;,</span><br><span class=\"line\">                error: function () &#123;</span><br><span class=\"line\">                    alert(<span class=\"string\">&quot;失败&quot;</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;)</span><br><span class=\"line\">        &#125;)</span><br><span class=\"line\">    &lt;/script&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;div&gt;</span><br><span class=\"line\">    &lt;nav class=<span class=\"string\">&quot;navbar navbar-default&quot;</span>&gt;</span><br><span class=\"line\">        &lt;div class=<span class=\"string\">&quot;container-fluid&quot;</span>&gt;</span><br><span class=\"line\">            &lt;!-- Brand and toggle get grouped <span class=\"keyword\">for</span> better mobile display --&gt;</span><br><span class=\"line\">            &lt;div class=<span class=\"string\">&quot;navbar-header&quot;</span>&gt;</span><br><span class=\"line\">                &lt;button type=<span class=\"string\">&quot;button&quot;</span> class=<span class=\"string\">&quot;navbar-toggle collapsed&quot;</span> data-toggle=<span class=\"string\">&quot;collapse&quot;</span></span><br><span class=\"line\">                        data-target=<span class=\"string\">&quot;#bs-example-navbar-collapse-1&quot;</span> aria-expanded=<span class=\"string\">&quot;false&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;span class=<span class=\"string\">&quot;sr-only&quot;</span>&gt;Toggle navigation&lt;/span&gt;</span><br><span class=\"line\">                    &lt;span class=<span class=\"string\">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class=\"line\">                    &lt;span class=<span class=\"string\">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class=\"line\">                    &lt;span class=<span class=\"string\">&quot;icon-bar&quot;</span>&gt;&lt;/span&gt;</span><br><span class=\"line\">                &lt;/button&gt;</span><br><span class=\"line\">                &lt;a class=<span class=\"string\">&quot;navbar-brand&quot;</span> href=<span class=\"string\">&quot;#&quot;</span>&gt;myShop商城&lt;/a&gt;</span><br><span class=\"line\">            &lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">            &lt;!-- Collect the nav links, forms, and other content <span class=\"keyword\">for</span> toggling --&gt;</span><br><span class=\"line\">            &lt;div class=<span class=\"string\">&quot;collapse navbar-collapse&quot;</span> id=<span class=\"string\">&quot;bs-example-navbar-collapse-1&quot;</span>&gt;</span><br><span class=\"line\">                &lt;ul class=<span class=\"string\">&quot;nav navbar-nav&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;li class=<span class=\"string\">&quot;active&quot;</span>&gt;&lt;a href=<span class=\"string\">&quot;$&#123;pageContext.request.contextPath&#125;/Login.jsp&quot;</span>&gt;登录&lt;span class=<span class=\"string\">&quot;sr-only&quot;</span>&gt;(current)&lt;/span&gt;&lt;/a&gt;</span><br><span class=\"line\">                    &lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=<span class=\"string\">&quot;$&#123;pageContext.request.contextPath&#125;/Register.jsp&quot;</span>&gt;注册&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=<span class=\"string\">&quot;$&#123;pageContext.request.contextPath&#125;/user?method=loginOut&quot;</span>&gt;注销&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                &lt;/ul&gt;</span><br><span class=\"line\">                &lt;form class=<span class=\"string\">&quot;navbar-form navbar-left&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;div class=<span class=\"string\">&quot;form-group&quot;</span>&gt;</span><br><span class=\"line\">                        &lt;input type=<span class=\"string\">&quot;text&quot;</span> class=<span class=\"string\">&quot;form-control&quot;</span> placeholder=<span class=\"string\">&quot;搜索一下&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;/div&gt;</span><br><span class=\"line\">                    &lt;button type=<span class=\"string\">&quot;submit&quot;</span> class=<span class=\"string\">&quot;btn btn-default&quot;</span>&gt;搜索&lt;/button&gt;</span><br><span class=\"line\">                &lt;/form&gt;</span><br><span class=\"line\">                &lt;ul class=<span class=\"string\">&quot;nav navbar-nav navbar-right&quot;</span>&gt;</span><br><span class=\"line\">                    &lt;li&gt;&lt;a href=<span class=\"string\">&quot;#&quot;</span>&gt;购物车&lt;/a&gt;&lt;/li&gt;</span><br><span class=\"line\">                &lt;/ul&gt;</span><br><span class=\"line\">            &lt;/div&gt;&lt;!-- /.navbar-collapse --&gt;</span><br><span class=\"line\">        &lt;/div&gt;&lt;!-- /.container-fluid --&gt;</span><br><span class=\"line\">    &lt;/nav&gt;</span><br><span class=\"line\">    &lt;nav class=<span class=\"string\">&quot;navbar navbar-default&quot;</span>&gt;</span><br><span class=\"line\">        &lt;p&gt;</span><br><span class=\"line\">        &lt;ul id=<span class=\"string\">&quot;goodsType&quot;</span>&gt;</span><br><span class=\"line\">        &lt;/ul&gt;</span><br><span class=\"line\">        &lt;/p&gt;</span><br><span class=\"line\">    &lt;/nav&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">[root<span class=\"meta\">@hecs</span>-<span class=\"number\">346515</span> test]# pwd </span><br><span class=\"line\">/root/dockerfile/build/tomcat/test</span><br><span class=\"line\">[root<span class=\"meta\">@hecs</span>-<span class=\"number\">346515</span> test]# ls </span><br><span class=\"line\">index.jsp  WEB_INF</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"go代码dockerfile做成镜像\"><a class=\"markdownIt-Anchor\" href=\"#go代码dockerfile做成镜像\">#</a> go 代码 dockerfile 做成镜像</h3>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install go -y</span><br><span class=\"line\"></span><br><span class=\"line\">cat main.go</span><br><span class=\"line\">import (</span><br><span class=\"line\">\t<span class=\"string\">&quot;net/http&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"string\">&quot;github.com/gin-gonic/gin&quot;</span></span><br><span class=\"line\">)</span><br><span class=\"line\"></span><br><span class=\"line\">func statusOKHandler(c *gin.Context) &#123;</span><br><span class=\"line\">\tc.JSON(http.StatusOK, gin.H&#123;<span class=\"string\">&quot;status&quot;</span>: <span class=\"string\">&quot;success~welcome to study&quot;</span>&#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func versionHandler(c *gin.Context) &#123;</span><br><span class=\"line\">\tc.JSON(http.StatusOK, gin.H&#123;<span class=\"string\">&quot;version&quot;</span>: <span class=\"string\">&quot;v1.1版本&quot;</span>&#125;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">func main() &#123;</span><br><span class=\"line\">\trouter := gin.New()</span><br><span class=\"line\">\trouter.Use(gin.Recovery())</span><br><span class=\"line\">\trouter.GET(<span class=\"string\">&quot;/&quot;</span>, statusOKHandler)</span><br><span class=\"line\">\trouter.GET(<span class=\"string\">&quot;/version&quot;</span>, versionHandler)</span><br><span class=\"line\">\trouter.Run(<span class=\"string\">&quot;:8080&quot;</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">go mod init test  <span class=\"comment\"># test为当前目录</span></span><br><span class=\"line\"><span class=\"comment\">#设置代理</span></span><br><span class=\"line\">go <span class=\"keyword\">env</span> -w GOPROXY=https://goproxy.cn,direct</span><br><span class=\"line\">go mod tidy</span><br><span class=\"line\"><span class=\"comment\">#构建源码</span></span><br><span class=\"line\">CGO_ENABLED=<span class=\"number\">0</span> GOOS=linux GOARCH=amd64 go build -o k8s-demo main.go</span><br><span class=\"line\">./k8s-demo </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 编写dockerfile</span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> alpine</span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /data/app</span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> k8s-demo /data/app/</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;/bin/sh&quot;</span>,<span class=\"string\">&quot;-c&quot;</span>,<span class=\"string\">&quot;./k8s-demo&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker build -t dashabi:v1 .</span><br><span class=\"line\">docker <span class=\"keyword\">run</span><span class=\"language-bash\"> -d --name go2 -p 30188:8083 dashabi:v1</span></span><br><span class=\"line\">curl localhost:<span class=\"number\">30188</span>/version</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"python-dockerfile构建\"><a class=\"markdownIt-Anchor\" href=\"#python-dockerfile构建\">#</a> python dockerfile 构建</h3>\n<figure class=\"highlight dockerfile\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tar zxvf hello-python.tar.gz</span><br><span class=\"line\"><span class=\"comment\"># 得到main.py,requirements.txt</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># dockerfile </span></span><br><span class=\"line\"><span class=\"keyword\">FROM</span> python:<span class=\"number\">3.7</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> <span class=\"built_in\">mkdir</span> /app </span></span><br><span class=\"line\"><span class=\"keyword\">WORKDIR</span><span class=\"language-bash\"> /app </span></span><br><span class=\"line\"><span class=\"keyword\">ADD</span><span class=\"language-bash\"> . /app/ </span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> /usr/local/bin/python -m pip install --upgrade pip</span></span><br><span class=\"line\"><span class=\"keyword\">RUN</span><span class=\"language-bash\"> pip install -r requirements.txt</span></span><br><span class=\"line\"><span class=\"keyword\">EXPOSE</span> <span class=\"number\">5000</span></span><br><span class=\"line\"><span class=\"keyword\">CMD</span><span class=\"language-bash\"> [<span class=\"string\">&quot;python&quot;</span>,<span class=\"string\">&quot;/app/main.py&quot;</span>]</span></span><br><span class=\"line\"></span><br><span class=\"line\">docker build  -t hello-python:v1 . </span><br><span class=\"line\">docker <span class=\"keyword\">run</span><span class=\"language-bash\"> -d --name python -p 30050:5000  hello-python:v1</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"发布镜像\"><a class=\"markdownIt-Anchor\" href=\"#发布镜像\">#</a> 发布镜像</h2>\n<p><strong>dockerhub</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#登录dockerhub</span><br><span class=\"line\">[root@hecs-346515 test]# docker login -u kbshire -p </span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 test]# docker build -t kbshire/avcat:2.333 .</span><br><span class=\"line\">[root@hecs-346515 test]# docker push kbshire/avcat:2.333</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>阿里云</strong></p>\n<p>1. 创建命名空间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404132912975.png\" alt=\"image-20230404132912975\"></p>\n<p>2. 创建容器镜像</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404133112291.png\" alt=\"image-20230404133112291\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404134421264.png\" alt=\"image-20230404134421264\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404134504442.png\" alt=\"image-20230404134504442\"></p>\n<h2 id=\"docker-网络\"><a class=\"markdownIt-Anchor\" href=\"#docker-网络\">#</a> Docker 网络</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bridge模式：使--net =bridge指定，默认设置；</span><br><span class=\"line\">host模式：使--net =host指定；</span><br><span class=\"line\">none模式：使--net =none指定；</span><br><span class=\"line\">container模式：使用--net =container:NAME orID指定。</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 dockerfile]# ip a </span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 ::1/128 scope host </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">2: eth0: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class=\"line\">    link/ether fa:16:3e:8b:e2:28 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 192.168.0.69/24 brd 192.168.0.255 scope global noprefixroute dynamic eth0</span><br><span class=\"line\">       valid_lft 67882sec preferred_lft 67882sec</span><br><span class=\"line\">    inet6 fe80::f816:3eff:fe8b:e228/64 scope link </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class=\"line\">    link/ether 02:42:27:32:a6:49 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::42:27ff:fe32:a649/64 scope link </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -d -P --name tomcat01 tomcat </span><br><span class=\"line\"></span><br><span class=\"line\">docker exec -it tomcat01 ip addr </span><br><span class=\"line\"></span><br><span class=\"line\"># yum install iproute</span><br><span class=\"line\">[root@29ede5d03d63 local]# ip a </span><br><span class=\"line\">1: lo: &lt;LOOPBACK,UP,LOWER_UP&gt; mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000</span><br><span class=\"line\">    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00</span><br><span class=\"line\">    inet 127.0.0.1/8 scope host lo</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">161: eth0@if162: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue state UP group default </span><br><span class=\"line\">    link/ether 02:42:ac:11:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet 172.17.0.3/16 brd 172.17.255.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">linux是可以ping通容器内部的</span><br></pre></td></tr></table></figure>\n<p>每启动一个 docker 容器，docker 就会给 docker 容器分配一个 ip，我们只要安装了 docker 就会有一个网卡 docker0</p>\n<p>桥接模式，就是 evth-pair 技术</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">162: vetha5d997c@if161: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master docker0 state UP group default </span><br><span class=\"line\">    link/ether 82:60:95:bc:a3:22 brd ff:ff:ff:ff:ff:ff link-netnsid 1</span><br><span class=\"line\">    inet6 fe80::8060:95ff:febc:a322/64 scope link </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure>\n<p>容器带来的网卡都是一对一对的</p>\n<p>evth-pair 就是一队虚拟设备接口，他们是成对出现的，一端连着协议，一端彼此相连</p>\n<p>evth-pair 连接各种网络设备</p>\n<p>OpenStack，docker 容器之间，ovs 的连接都是使用 evth-pair</p>\n<p>容器和容器之间可以互相通信</p>\n<p>容器之间通信共用的 docker0，可以理解为一个路由器</p>\n<p>不指定容器网络的情况下，都是 docker0 路由的，docker 回给我们的容器分配一个默认 ip</p>\n<p>/16 的掩码最多可以有 65535 个地址</p>\n<p>docker 使用 linux 桥接，宿主机中是一个 docker 网络的网桥 docker0</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230404142456521.png\" alt=\"image-20230404142456521\"></p>\n<p>docker 中所有网络接口都是虚拟的，转发效率高</p>\n<p>容器删除，veth-pair 也就被删除了</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yum install bridge-utils</span><br><span class=\"line\">brctl show</span><br></pre></td></tr></table></figure>\n<h3 id=\"link\"><a class=\"markdownIt-Anchor\" href=\"#link\">#</a> –link</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 dockerfile]# docker run -it  -P --name centos05 --link gallant_poincare centoshaha:0.5</span><br><span class=\"line\">[root@hecs-346515 ~]# docker exec -it centos05 ping gallant_poincare</span><br><span class=\"line\">通过link实现可以通过服务名ping</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker exec -it gallant_poincare ping centos05</span><br><span class=\"line\">ping: centos05: Name or service not known</span><br><span class=\"line\"></span><br><span class=\"line\">docker network inspect id</span><br><span class=\"line\"></span><br><span class=\"line\">[root@5e0c29c45f15 local]# cat /etc/hosts</span><br><span class=\"line\">127.0.0.1\tlocalhost</span><br><span class=\"line\">::1\tlocalhost ip6-localhost ip6-loopback</span><br><span class=\"line\">fe00::0\tip6-localnet</span><br><span class=\"line\">ff00::0\tip6-mcastprefix</span><br><span class=\"line\">ff02::1\tip6-allnodes</span><br><span class=\"line\">ff02::2\tip6-allrouters</span><br><span class=\"line\">172.17.0.3\tgallant_poincare cef544877c1d</span><br><span class=\"line\">172.17.0.4\t5e0c29c45f15</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>–link 就是在 hosts 中增加了 gallant_poincare 的映射</strong></p>\n<p>不建议使用–link</p>\n<p>docker0 的问题，他不支持容器名进行连接访问</p>\n<h3 id=\"自定义网络\"><a class=\"markdownIt-Anchor\" href=\"#自定义网络\">#</a> 自定义网络</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 dockerfile]# docker network ls </span><br><span class=\"line\">NETWORK ID     NAME                     DRIVER    SCOPE</span><br><span class=\"line\">ef281869253b   bridge                   bridge    local</span><br><span class=\"line\">81efa88be64b   host                     host      local</span><br><span class=\"line\">57ffa6ffd57d   loadbalancejsp_default   bridge    local</span><br><span class=\"line\">55243546bae4   none                     null      local</span><br></pre></td></tr></table></figure>\n<p><strong>网络模式</strong></p>\n<p>bridge：docker 之间搭桥，自己创建也使用桥接</p>\n<p>none：不配置网络，一般不用</p>\n<p>​\tDocker 网络 none 模式是指创建的容器没有网络地址，只有 lo 网卡</p>\n<p>host：和宿主机共享网络</p>\n<p>container：容器内网络连通，局限很大</p>\n<p>​\t创建新容器的时候，通过–net container 参数，指定其和已经存在的某个容器共享一个 Network Namespace。两个容器的进程通过 lo 网卡设备通信。</p>\n<p>​\tdocker run --name container2 --net=container:none  -it --privileged=true centos</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --net=none --privileged=true centos </span><br><span class=\"line\">特权模式下才是真正的root 在容器内部</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">直接启动的命令默认--net bridge  这就是docker0</span><br><span class=\"line\">docker0是默认的，不能通过域名访问</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker network create --driver bridge --subnet 10.1.0.0/16 --gateway 10.1.0.1 sbnet </span><br><span class=\"line\">82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a</span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker network ls </span><br><span class=\"line\">NETWORK ID     NAME                     DRIVER    SCOPE</span><br><span class=\"line\">ef281869253b   bridge                   bridge    local</span><br><span class=\"line\">81efa88be64b   host                     host      local</span><br><span class=\"line\">57ffa6ffd57d   loadbalancejsp_default   bridge    local</span><br><span class=\"line\">55243546bae4   none                     null      local</span><br><span class=\"line\">82c4a8b68c66   sbnet                    bridge    local</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 dockerfile]# docker network inspect sbnet</span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;Name&quot;: &quot;sbnet&quot;,</span><br><span class=\"line\">        &quot;Id&quot;: &quot;82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a&quot;,</span><br><span class=\"line\">        &quot;Created&quot;: &quot;2023-04-04T18:25:48.537296679+08:00&quot;,</span><br><span class=\"line\">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class=\"line\">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class=\"line\">        &quot;EnableIPv6&quot;: false,</span><br><span class=\"line\">        &quot;IPAM&quot;: &#123;</span><br><span class=\"line\">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class=\"line\">            &quot;Options&quot;: &#123;&#125;,</span><br><span class=\"line\">            &quot;Config&quot;: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    &quot;Subnet&quot;: &quot;10.1.0.0/16&quot;,</span><br><span class=\"line\">                    &quot;Gateway&quot;: &quot;10.1.0.1&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Internal&quot;: false,</span><br><span class=\"line\">        &quot;Attachable&quot;: false,</span><br><span class=\"line\">        &quot;Ingress&quot;: false,</span><br><span class=\"line\">        &quot;ConfigFrom&quot;: &#123;</span><br><span class=\"line\">            &quot;Network&quot;: &quot;&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;ConfigOnly&quot;: false,</span><br><span class=\"line\">        &quot;Containers&quot;: &#123;&#125;,</span><br><span class=\"line\">        &quot;Options&quot;: &#123;&#125;,</span><br><span class=\"line\">        &quot;Labels&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it  -P --name=centos11 --net sbnet centos </span><br><span class=\"line\">docker run -it  -P --name=centos12 --net sbnet centos</span><br><span class=\"line\">docker exec -it centos11 ping centos12 </span><br><span class=\"line\">不使用--link也能ping通</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>我们自定义的网络 docker 已经帮我们维护好了关系</p>\n<p>可以使不同集群使用不同的网络，保证集群的安全和健康</p>\n<h3 id=\"网络连通\"><a class=\"markdownIt-Anchor\" href=\"#网络连通\">#</a> 网络连通</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker netowrk connect sbnet centos13</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker network connect sbnet centos13</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]# docker network inspect sbnet </span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        &quot;Name&quot;: &quot;sbnet&quot;,</span><br><span class=\"line\">        &quot;Id&quot;: &quot;82c4a8b68c66715f88003b8ba4ef65de670286de1c73abee49ab26f9fceb063a&quot;,</span><br><span class=\"line\">        &quot;Created&quot;: &quot;2023-04-04T18:25:48.537296679+08:00&quot;,</span><br><span class=\"line\">        &quot;Scope&quot;: &quot;local&quot;,</span><br><span class=\"line\">        &quot;Driver&quot;: &quot;bridge&quot;,</span><br><span class=\"line\">        &quot;EnableIPv6&quot;: false,</span><br><span class=\"line\">        &quot;IPAM&quot;: &#123;</span><br><span class=\"line\">            &quot;Driver&quot;: &quot;default&quot;,</span><br><span class=\"line\">            &quot;Options&quot;: &#123;&#125;,</span><br><span class=\"line\">            &quot;Config&quot;: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    &quot;Subnet&quot;: &quot;10.1.0.0/16&quot;,</span><br><span class=\"line\">                    &quot;Gateway&quot;: &quot;10.1.0.1&quot;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Internal&quot;: false,</span><br><span class=\"line\">        &quot;Attachable&quot;: false,</span><br><span class=\"line\">        &quot;Ingress&quot;: false,</span><br><span class=\"line\">        &quot;ConfigFrom&quot;: &#123;</span><br><span class=\"line\">            &quot;Network&quot;: &quot;&quot;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;ConfigOnly&quot;: false,</span><br><span class=\"line\">        &quot;Containers&quot;: &#123;</span><br><span class=\"line\">            &quot;872404abcfc68d09a65ec820c986aa2003737629a0bdf83406152793dc72f228&quot;: &#123;</span><br><span class=\"line\">                &quot;Name&quot;: &quot;centos12&quot;,</span><br><span class=\"line\">                &quot;EndpointID&quot;: &quot;e393d20c796d4c081b726787210dc5a05d645d33c1a75fd6da529ac11db6e0c1&quot;,</span><br><span class=\"line\">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:03&quot;,</span><br><span class=\"line\">                &quot;IPv4Address&quot;: &quot;10.1.0.3/16&quot;,</span><br><span class=\"line\">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;974c928cc0854549c5cf9b8e257adf025bf9e1499b1169b46bf56c1632565bbe&quot;: &#123;</span><br><span class=\"line\">                &quot;Name&quot;: &quot;centos13&quot;,</span><br><span class=\"line\">                &quot;EndpointID&quot;: &quot;a571e55079a80a2f36ff6e181194cadc1ec49b76bd51bb4485be030201a718c7&quot;,</span><br><span class=\"line\">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:04&quot;,</span><br><span class=\"line\">                &quot;IPv4Address&quot;: &quot;10.1.0.4/16&quot;,</span><br><span class=\"line\">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class=\"line\">            &#125;,</span><br><span class=\"line\">            &quot;ed93b6d1202d8953cd9ae12450e44538d1647620423a7cbf63d1bcd9f023e7a6&quot;: &#123;</span><br><span class=\"line\">                &quot;Name&quot;: &quot;centos11&quot;,</span><br><span class=\"line\">                &quot;EndpointID&quot;: &quot;820d037e8faaad9c8a19cd0a58629c1ec1881cc2b9e5e26a21420a1bb8724ccd&quot;,</span><br><span class=\"line\">                &quot;MacAddress&quot;: &quot;02:42:0a:01:00:02&quot;,</span><br><span class=\"line\">                &quot;IPv4Address&quot;: &quot;10.1.0.2/16&quot;,</span><br><span class=\"line\">                &quot;IPv6Address&quot;: &quot;&quot;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        &quot;Options&quot;: &#123;&#125;,</span><br><span class=\"line\">        &quot;Labels&quot;: &#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"></span><br><span class=\"line\">将centos13放到了bridge下，一个容器此时有两个地址</span><br></pre></td></tr></table></figure>\n<p>要跨网络操作容器，需要 docker connect 连通</p>\n<h3 id=\"redis集群\"><a class=\"markdownIt-Anchor\" href=\"#redis集群\">#</a> Redis 集群</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">for port in $(seq 1 6); \\</span><br><span class=\"line\">do \\</span><br><span class=\"line\">mkdir -p /mydata/redis/node-$&#123;port&#125;/conf</span><br><span class=\"line\">touch /mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class=\"line\">cat &lt;&lt; EOF &gt;/mydata/redis/node-$&#123;port&#125;/conf/redis.conf</span><br><span class=\"line\">port 6379 </span><br><span class=\"line\">bind 0.0.0.0</span><br><span class=\"line\">cluster-enabled yes </span><br><span class=\"line\">cluster-config-file nodes.conf</span><br><span class=\"line\">cluster-node-timeout 5000</span><br><span class=\"line\">cluster-announce-ip 172.38.0.1$&#123;port&#125;</span><br><span class=\"line\">cluster-announce-port 6379</span><br><span class=\"line\">cluster-announce-bus-port 16379</span><br><span class=\"line\">appendonly yes</span><br><span class=\"line\">EOF</span><br><span class=\"line\">done</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight docker\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker <span class=\"keyword\">run</span><span class=\"language-bash\"> -p 6376:6379 -p 16376:16379 --name redis-6 -v /mydata/redis/node-6/data:/data -v /mydata/redis/node-6/conf/redis.conf:/etc/redis/redis.conf -d --net redis --ip 172.38.0.16 redis:5.0.9-alpine3.11 redis-server /etc/redis/redis.conf </span></span><br><span class=\"line\"></span><br><span class=\"line\">redis-cli --cluster create <span class=\"number\">172.38</span>.<span class=\"number\">0.11</span>:<span class=\"number\">6379</span> <span class=\"number\">172.38</span>.<span class=\"number\">0.12</span>:<span class=\"number\">6379</span> <span class=\"number\">172.38</span>.<span class=\"number\">0.13</span>:<span class=\"number\">6379</span> <span class=\"number\">172.38</span>.<span class=\"number\">0.14</span>:<span class=\"number\">6379</span> <span class=\"number\">172.38</span>.<span class=\"number\">0.15</span>:<span class=\"number\">637</span></span><br><span class=\"line\"><span class=\"number\">9</span> <span class=\"number\">172.38</span>.<span class=\"number\">0.16</span>:<span class=\"number\">6379</span> --cluster-replicas <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">/data <span class=\"comment\"># redis-cli -c</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">6379</span>&gt; CLUSTER INFO</span><br><span class=\"line\">cluster_state:ok</span><br><span class=\"line\">cluster_slots_assigned:<span class=\"number\">16384</span></span><br><span class=\"line\">cluster_slots_ok:<span class=\"number\">16384</span></span><br><span class=\"line\">cluster_slots_pfail:<span class=\"number\">0</span></span><br><span class=\"line\">cluster_slots_fail:<span class=\"number\">0</span></span><br><span class=\"line\">cluster_known_nodes:<span class=\"number\">6</span></span><br><span class=\"line\">cluster_size:<span class=\"number\">3</span></span><br><span class=\"line\">cluster_current_epoch:<span class=\"number\">6</span></span><br><span class=\"line\">cluster_my_epoch:<span class=\"number\">1</span></span><br><span class=\"line\">cluster_stats_messages_ping_sent:<span class=\"number\">82</span></span><br><span class=\"line\">cluster_stats_messages_pong_sent:<span class=\"number\">82</span></span><br><span class=\"line\">cluster_stats_messages_sent:<span class=\"number\">164</span></span><br><span class=\"line\">cluster_stats_messages_ping_received:<span class=\"number\">77</span></span><br><span class=\"line\">cluster_stats_messages_pong_received:<span class=\"number\">82</span></span><br><span class=\"line\">cluster_stats_messages_meet_received:<span class=\"number\">5</span></span><br><span class=\"line\">cluster_stats_messages_received:<span class=\"number\">164</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">6379</span>&gt; CLUSTER NODES</span><br><span class=\"line\">b75997d0df1dafbbf8db3642f424eedc0cd9695f <span class=\"number\">172.38</span>.<span class=\"number\">0.15</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> slave <span class=\"number\">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class=\"number\">0</span> <span class=\"number\">1680661677823</span> <span class=\"number\">5</span> connected</span><br><span class=\"line\"><span class=\"number\">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class=\"number\">172.38</span>.<span class=\"number\">0.11</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> myself,master - <span class=\"number\">0</span> <span class=\"number\">1680661677000</span> <span class=\"number\">1</span> connected <span class=\"number\">0</span>-<span class=\"number\">5460</span></span><br><span class=\"line\"><span class=\"number\">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class=\"number\">172.38</span>.<span class=\"number\">0.12</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> master - <span class=\"number\">0</span> <span class=\"number\">1680661677522</span> <span class=\"number\">2</span> connected <span class=\"number\">5461</span>-<span class=\"number\">10922</span></span><br><span class=\"line\">ba2557b0959bed1cc5a446bcd0403721bcb8d002 <span class=\"number\">172.38</span>.<span class=\"number\">0.14</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> slave <span class=\"number\">3794</span>de303a95a3718988f3d313f332241b364d7c <span class=\"number\">0</span> <span class=\"number\">1680661677000</span> <span class=\"number\">4</span> connected</span><br><span class=\"line\"><span class=\"number\">3794</span>de303a95a3718988f3d313f332241b364d7c <span class=\"number\">172.38</span>.<span class=\"number\">0.13</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> master - <span class=\"number\">0</span> <span class=\"number\">1680661676822</span> <span class=\"number\">3</span> connected <span class=\"number\">10923</span>-<span class=\"number\">16383</span></span><br><span class=\"line\"><span class=\"number\">73007</span>d040ed6ca3c093fb5061a3358d1ae47a18a <span class=\"number\">172.38</span>.<span class=\"number\">0.16</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> slave <span class=\"number\">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class=\"number\">0</span> <span class=\"number\">1680661676000</span> <span class=\"number\">6</span> connected</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">6379</span>&gt; set a b </span><br><span class=\"line\">-&gt; Redirected to slot [<span class=\"number\">15495</span>] located at <span class=\"number\">172.38</span>.<span class=\"number\">0.13</span>:<span class=\"number\">6379</span></span><br><span class=\"line\">OK</span><br><span class=\"line\"><span class=\"number\">172.38</span>.<span class=\"number\">0.13</span>:<span class=\"number\">6379</span>&gt; get a </span><br><span class=\"line\">^C</span><br><span class=\"line\">/data <span class=\"comment\"># redis-cli -c</span></span><br><span class=\"line\"><span class=\"number\">127.0</span>.<span class=\"number\">0.1</span>:<span class=\"number\">6379</span>&gt; get a </span><br><span class=\"line\">-&gt; Redirected to slot [<span class=\"number\">15495</span>] located at <span class=\"number\">172.38</span>.<span class=\"number\">0.14</span>:<span class=\"number\">6379</span></span><br><span class=\"line\"><span class=\"string\">&quot;b&quot;</span></span><br><span class=\"line\"><span class=\"number\">172.38</span>.<span class=\"number\">0.14</span>:<span class=\"number\">6379</span>&gt; CLUSTER NODES</span><br><span class=\"line\">b75997d0df1dafbbf8db3642f424eedc0cd9695f <span class=\"number\">172.38</span>.<span class=\"number\">0.15</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> slave <span class=\"number\">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class=\"number\">0</span> <span class=\"number\">1680661856417</span> <span class=\"number\">5</span> connected</span><br><span class=\"line\"><span class=\"number\">73</span>a37cfa8c760c3069bd4fb69f9b2a411f556124 <span class=\"number\">172.38</span>.<span class=\"number\">0.11</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> master - <span class=\"number\">0</span> <span class=\"number\">1680661856517</span> <span class=\"number\">1</span> connected <span class=\"number\">0</span>-<span class=\"number\">5460</span></span><br><span class=\"line\">ba2557b0959bed1cc5a446bcd0403721bcb8d002 <span class=\"number\">172.38</span>.<span class=\"number\">0.14</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> myself,master - <span class=\"number\">0</span> <span class=\"number\">1680661855000</span> <span class=\"number\">7</span> connected <span class=\"number\">10923</span>-<span class=\"number\">16383</span></span><br><span class=\"line\"><span class=\"number\">73007</span>d040ed6ca3c093fb5061a3358d1ae47a18a <span class=\"number\">172.38</span>.<span class=\"number\">0.16</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> slave <span class=\"number\">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class=\"number\">0</span> <span class=\"number\">1680661856016</span> <span class=\"number\">6</span> connected</span><br><span class=\"line\"><span class=\"number\">51</span>c02482b19b9ab5dc20ff1852f375ada2f68986 <span class=\"number\">172.38</span>.<span class=\"number\">0.12</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> master - <span class=\"number\">0</span> <span class=\"number\">1680661855415</span> <span class=\"number\">2</span> connected <span class=\"number\">5461</span>-<span class=\"number\">10922</span></span><br><span class=\"line\"><span class=\"number\">3794</span>de303a95a3718988f3d313f332241b364d7c <span class=\"number\">172.38</span>.<span class=\"number\">0.13</span>:<span class=\"number\">6379</span>@<span class=\"number\">16379</span> master,fail - <span class=\"number\">1680661784244</span> <span class=\"number\">1680661782238</span> <span class=\"number\">3</span> connected</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h3 id=\"springboot-微服务打包docker镜像\"><a class=\"markdownIt-Anchor\" href=\"#springboot-微服务打包docker镜像\">#</a> springboot 微服务打包 docker 镜像</h3>\n<p>1. 构建 springboot 项目</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">创建package controller</span><br><span class=\"line\">创建class HelloControllerpackage com.example.demo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\">import org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\">@RestController</span><br><span class=\"line\">public class HelloController &#123;</span><br><span class=\"line\">    @RequestMapping(&quot;/hello&quot;)</span><br><span class=\"line\">    public String hello() &#123;</span><br><span class=\"line\">        return &quot;hello,shabi&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">package com.example.demo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\">import org.springframework.web.bind.annotation.RequestMapping;</span><br><span class=\"line\"></span><br><span class=\"line\">public class HelloController &#123;</span><br><span class=\"line\">    @RequestMapping(&quot;/hello&quot;)</span><br><span class=\"line\">    public String hello() &#123;</span><br><span class=\"line\">        return &quot;hello,shabi&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2. 打包应用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405110530946.png\" alt=\"image-20230405110530946\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405110610159.png\" alt=\"image-20230405110610159\"></p>\n<p>3. 编写 dockerfile</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM hzkjhub/java17:17.0.4</span><br><span class=\"line\"></span><br><span class=\"line\">COPY *.jar /app.jar</span><br><span class=\"line\"></span><br><span class=\"line\">CMD [&quot;--server.port=8080&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE 8080</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class=\"line\">~                                               </span><br></pre></td></tr></table></figure>\n<p>4. 构建镜像</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker build -t shabi .</span><br><span class=\"line\">docker run -P -it --name docker333  shabi</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">curl 127.0.0.1:32778/hello</span><br></pre></td></tr></table></figure>\n<p>5. 发布运行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW9nNHkxcTdNNA==\">https://www.bilibili.com/video/BV1og4y1q7M4</span></p>\n<h2 id=\"docker-资源配额\"><a class=\"markdownIt-Anchor\" href=\"#docker-资源配额\">#</a> docker 资源配额</h2>\n<p>Docker 通过 cgroup 来控制容器使用的资源限制，可以对 docker 限制的资源包括 CPU、内存、磁盘</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run --<span class=\"built_in\">help</span> | grep cpu-shares</span><br><span class=\"line\">  -c, --cpu-shares int                 CPU shares (relative weight)</span><br><span class=\"line\"></span><br><span class=\"line\">CPU shares (relative weight) 在创建容器时指定容器所使用的CPU份额值。cpu-shares的值不能保证可以获得1个vcpu或者多少GHz的CPU资源，仅仅只是一个弹性的加权值。</span><br><span class=\"line\">默认每个docker容器的cpu份额值都是1024。在同一个CPU核心上，同时运行多个容器时，容器的cpu加权的效果才能体现出来。</span><br><span class=\"line\">cgroups只在多个容器同时争抢同一个cpu资源时，cpu配额才会生效。因此，无法单纯根据某个容器的cpu份额来确定有多少cpu资源分配给它，资源分配结果取决于同时运行的其他容器的cpu分配和容器中进程运行情况。</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it --cpu-shares 512 centos  /bin/bash</span><br><span class=\"line\">[root@df176dd75bd4 /]<span class=\"comment\"># cat /sys/fs/cgroup/cpu/cpu.shares</span></span><br><span class=\"line\">512</span><br><span class=\"line\"></span><br><span class=\"line\">container_A 的 cpu share 1024，是 container_B 的两倍。当两个容器都需要 CPU 资源时，container_A 可以得到的 CPU 是 container_B 的两倍。</span><br><span class=\"line\"></span><br><span class=\"line\">需要注意的是，这种按权重分配 CPU只会发生在 CPU资源紧张的情况下。如果 container_A 处于空闲状态，为了充分利用 CPU资源，container_B 也可以分配到全部可用的 CPU。</span><br><span class=\"line\">docker run --name <span class=\"string\">&quot;container_B&quot;</span> -c 512 ubuntu</span><br></pre></td></tr></table></figure>\n<p>对多核 CPU 的服务器，docker 还可以控制容器运行限定使用哪些 cpu 内核和内存节点，即使用–cpuset-cpus 和–cpuset-mems 参数。对具有 NUMA 拓扑（具有多 CPU、多内存节点）的服务器尤其有用，可以对需要高性能计算的容器进行性能最优的配置。如果服务器只有一个内存节点，则–cpuset-mems 的配置基本上不会有明显效果。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -itd --name docker10 --cpuset-cpus 0,1 --cpu-shares 512 centos  /bin/bash </span><br><span class=\"line\">docker run -itd --name docker20 --cpuset-cpus 0,1 --cpu-shares 1024 centos  /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">指定docker20只能在cpu0和cpu1上运行，而且docker20的使用cpu的份额1024，比dcker10多一倍</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Docker提供参数-m, --memory=&quot;&quot;限制容器的内存使用量。</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it  -m 128m centos</span><br><span class=\"line\"></span><br><span class=\"line\">cat /sys/fs/cgroup/memory/memory.limit_in_bytes </span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it --cpuset-cpus 0,1 -m 128m centos </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--device-write-bps value      Limit write rate (bytes per second) to a device (default [])  </span><br><span class=\"line\"><span class=\"comment\">#限制此设备上的写速度（bytes per second），单位可以是kb、mb或者gb。</span></span><br><span class=\"line\">--device-read-bps value   </span><br><span class=\"line\"><span class=\"comment\">#限制此设备上的读速度（bytes per second），单位可以是kb、mb或者gb。</span></span><br><span class=\"line\"></span><br><span class=\"line\">情景：防止某个 Docker 容器吃光你的磁盘 I / O 资源</span><br><span class=\"line\"></span><br><span class=\"line\">docker run -it  -v /var/www/html/:/var/www/html --device /dev/sda:/dev/sda --device-write-bps /dev/sda:2mb centos  /bin/bash</span><br><span class=\"line\"></span><br><span class=\"line\">time <span class=\"built_in\">dd</span> <span class=\"keyword\">if</span>=/dev/sda of=/var/www/html/test.out bs=2M count=50 oflag=direct,nonblock</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run -it --<span class=\"built_in\">rm</span> --name xianchao centos  <span class=\"built_in\">sleep</span> 6</span><br><span class=\"line\">当容器命令运行结束后，自动删除容器，自动释放资源</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">总结：</span><br><span class=\"line\"><span class=\"comment\"># --cpu-shares 指定容器所使用的CPU份额值</span></span><br><span class=\"line\"><span class=\"comment\"># --cpuset-cpus 控制容器运行限定使用哪些cpu内核和内存节点</span></span><br><span class=\"line\"><span class=\"comment\"># --memory 限制容器的内存使用量</span></span><br><span class=\"line\"><span class=\"comment\"># --device-write-bps value 限制此设备上的写速度（bytes per second），单位可以是kb、mb或者gb</span></span><br><span class=\"line\"><span class=\"comment\"># --device-read-bps value #限制此设备上的读速度（bytes per second），单位可以是kb、mb或者gb</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"harbor\"><a class=\"markdownIt-Anchor\" href=\"#harbor\">#</a> Harbor</h2>\n<p>Harbor 是由 VMware 公司开源的企业级的 Docker Registry 管理项目，它包括权限管理 (RBAC)、LDAP、日志审核、管理界面、自我注册、镜像复制和中文支持等功能。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2dvaGFyYm9yL2hhcmJvcg==\">https://github.com/goharbor/harbor</span></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">openssl genrsa -out ca.key 3072</span><br><span class=\"line\"><span class=\"comment\">#生成一个3072位的key，也就是私钥</span></span><br><span class=\"line\">openssl req -new -x509 -days 3650 -key ca.key -out ca.pem</span><br><span class=\"line\"><span class=\"comment\">#生成一个数字证书ca.pem，3650表示证书的有效时间是3年</span></span><br><span class=\"line\"></span><br><span class=\"line\">生成域名的证书：</span><br><span class=\"line\">openssl genrsa -out harbor.key  3072</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">#生成一个3072位的key，也就是私钥</span></span><br><span class=\"line\">openssl req -new -key harbor.key -out harbor.csr</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 签发证书</span></span><br><span class=\"line\">openssl x509 -req -<span class=\"keyword\">in</span> harbor.csr -CA ca.pem -CAkey ca.key -CAcreateserial -out harbor.pem -days 3650</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y  wget net-tools nfs-utils lrzsz gcc gcc-c++ make cmake libxml2-devel openssl-devel curl curl-devel unzip sudo ntp libaio-devel wget vim ncurses-devel autoconf automake zlib-devel  python-devel epel-release openssh-server socat  ipvsadm conntrack </span><br><span class=\"line\"></span><br><span class=\"line\">yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span><br><span class=\"line\"></span><br><span class=\"line\">yum install -y yum-utils device-mapper-persistent-data lvm2</span><br><span class=\"line\"></span><br><span class=\"line\">yum install docker-ce -y</span><br><span class=\"line\"></span><br><span class=\"line\">内核参数修改：br_netfilter模块用于将桥接流量转发至iptables链，br_netfilter内核参数需要开启转发。</span><br><span class=\"line\">[root@ harbor~]<span class=\"comment\"># modprobe br_netfilter</span></span><br><span class=\"line\">[root@ harbor~]<span class=\"comment\"># cat &gt; /etc/sysctl.d/docker.conf &lt;&lt;EOF</span></span><br><span class=\"line\">net.bridge.bridge-nf-call-ip6tables = 1</span><br><span class=\"line\">net.bridge.bridge-nf-call-iptables = 1</span><br><span class=\"line\">net.ipv4.ip_forward = 1</span><br><span class=\"line\">EOF</span><br><span class=\"line\"></span><br><span class=\"line\">sysctl -p /etc/sysctl.d/docker.conf</span><br><span class=\"line\"></span><br><span class=\"line\">https://github.com/goharbor/harbor/releases/tag/v2.8.0</span><br><span class=\"line\"></span><br><span class=\"line\">tar xzvf harbor-offline-installer-v2.8.0.tgz </span><br><span class=\"line\"><span class=\"built_in\">cp</span> harbor.yml.tmpl harbor.yml</span><br><span class=\"line\"></span><br><span class=\"line\">vim harbor.yml</span><br><span class=\"line\">hostname: 192.168.13.155</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># http related config</span></span><br><span class=\"line\">http:</span><br><span class=\"line\">  <span class=\"comment\"># port for http, default is 80. If https enabled, this port will redirect to https port</span></span><br><span class=\"line\">  port: 80</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># https related config</span></span><br><span class=\"line\">https:</span><br><span class=\"line\">  <span class=\"comment\"># https port for harbor, default is 443</span></span><br><span class=\"line\">  port: 443</span><br><span class=\"line\">  <span class=\"comment\"># The path of cert and key files for nginx</span></span><br><span class=\"line\">  certificate: /data/ssl/harbor.pem</span><br><span class=\"line\">  private_key: /data/ssl/harbor.key</span><br><span class=\"line\"></span><br><span class=\"line\">admin/Harbor12345</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 安装docker-compose</span></span><br><span class=\"line\"></span><br><span class=\"line\">./prepare</span><br><span class=\"line\">./install.sh </span><br><span class=\"line\">[+] Running 10/10</span><br><span class=\"line\"> ✔ Network harbor_harbor        Created                                           0.2s </span><br><span class=\"line\"> ✔ Container harbor-log         Started                                           0.5s </span><br><span class=\"line\"> ✔ Container registryctl        Started                                           2.0s </span><br><span class=\"line\"> ✔ Container harbor-db          Started                                           2.0s </span><br><span class=\"line\"> ✔ Container harbor-portal      Started                                           1.3s </span><br><span class=\"line\"> ✔ Container registry           Started                                           1.9s </span><br><span class=\"line\"> ✔ Container redis              Started                                           1.9s </span><br><span class=\"line\"> ✔ Container harbor-core        Started                                           2.3s </span><br><span class=\"line\"> ✔ Container nginx              Started                                           3.3s </span><br><span class=\"line\"> ✔ Container harbor-jobservice  Started                                           3.0s </span><br><span class=\"line\">✔ ----Harbor has been installed and started successfully.----</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423153911479.png\" alt=\"image-20230423153911479\"></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 创建项目</span></span><br><span class=\"line\"></span><br><span class=\"line\">vim /etc/docker/daemon.json</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">  <span class=\"string\">&quot;registry-mirrors&quot;</span>: [<span class=\"string\">&quot;https://fn5y0qpk.mirror.aliyuncs.com&quot;</span>],</span><br><span class=\"line\">  <span class=\"string\">&quot;insecure-registries&quot;</span>: [<span class=\"string\">&quot;121.37.191.89&quot;</span>]</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># systemctl daemon-reload </span></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># systemctl restart docker</span></span><br><span class=\"line\"></span><br><span class=\"line\">[root@master ~]<span class=\"comment\"># docker login  121.37.191.89</span></span><br><span class=\"line\">Username: admin</span><br><span class=\"line\">Password: </span><br><span class=\"line\">WARNING! Your password will be stored unencrypted <span class=\"keyword\">in</span> /root/.docker/config.json.</span><br><span class=\"line\">Configure a credential helper to remove this warning. See</span><br><span class=\"line\">https://docs.docker.com/engine/reference/commandline/login/<span class=\"comment\">#credentials-store</span></span><br><span class=\"line\"></span><br><span class=\"line\">Login Succeeded</span><br><span class=\"line\"></span><br><span class=\"line\">docker tag hello-world:latest  121.37.191.89/test/hello-world:v1</span><br><span class=\"line\">docker push 121.37.191.89/test/hello-world:v1</span><br><span class=\"line\"></span><br><span class=\"line\">docker pull 121.37.191.89/test/hello-world:v1</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230423155448444.png\" alt=\"image-20230423155448444\"></p>\n<h2 id=\"docker-compose\"><a class=\"markdownIt-Anchor\" href=\"#docker-compose\">#</a> Docker Compose</h2>\n<p>高效的管理容器。定义运行多个容器。使用 yaml 配置</p>\n<blockquote>\n<p>编写 dockerfile 保证我们的项目在任何地方可以运行</p>\n<p>定义服务在 docker-compose.yml 中</p>\n<p>docker-compose up</p>\n</blockquote>\n<p>批量容器编排</p>\n<p>docker-compose 是 docker 的开源项目，需要安装</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&quot;3.9&quot;</span>  <span class=\"comment\"># optional since v1.27.0</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">web:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;8000:5000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">.:/code</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">logvolume01:/var/log</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\">  <span class=\"attr\">logvolume01:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>\n<p>service 容器，应用</p>\n<p>项目 project。一组关联的容器</p>\n<h3 id=\"安装docker-compose\"><a class=\"markdownIt-Anchor\" href=\"#安装docker-compose\">#</a> 安装 docker compose</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl -SL https://github.com/docker/compose/releases/download/v2.17.2/docker-compose-linux-x86_64 -o /usr/local/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\">sudo curl -L &quot;https://get.daocloud.io/docker/compose/releases/download/1.29.2/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">chmod +x /usr/local/bin/docker-compose</span><br><span class=\"line\"></span><br><span class=\"line\">docker-compose -version</span><br><span class=\"line\">docker-compose version 1.29.2, build 5becea4c</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEueG4tLWFwcC1xdzJmcTAxaC5weQ==\">1. 应用 app.py</span></p>\n<p>2.dockerfile 将应用打包为镜像</p>\n<p>3.docker-compose yaml 文件 定义整个服务，需要的环境</p>\n<p>4. 启动 compose</p>\n<p>流程</p>\n<p>1. 创建网络</p>\n<p>2. 执行 dockercompose.yaml</p>\n<p>3. 启动服务</p>\n<p>默认的服务名  <code>文件名_服务名_num</code></p>\n<p><code>_num</code>  代表副本数量</p>\n<p>docker-compose 自动维护一个网络，项目中的内容都在同个网络下，实现域名访问</p>\n<p>启动 <code>docker-compose up -d</code></p>\n<p>停止 <code>docker-compose down</code>   <code>ctrl+c</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405201151236.png\" alt=\"image-20230405201151236\"></p>\n<h3 id=\"yaml\"><a class=\"markdownIt-Anchor\" href=\"#yaml\">#</a> yaml</h3>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;&#x27;</span>   <span class=\"comment\"># 版本</span></span><br><span class=\"line\"><span class=\"attr\">services:</span>     <span class=\"comment\"># 服务</span></span><br><span class=\"line\">\t<span class=\"string\">服务1：web</span></span><br><span class=\"line\">\t\t<span class=\"comment\"># 服务配置</span></span><br><span class=\"line\">\t\t<span class=\"string\">images</span></span><br><span class=\"line\">\t\t<span class=\"string\">build</span></span><br><span class=\"line\">\t\t<span class=\"string\">network</span></span><br><span class=\"line\">\t<span class=\"string\">服务2：redis</span></span><br><span class=\"line\">\t\t<span class=\"string\">...</span>\t\t</span><br><span class=\"line\">\t\t</span><br><span class=\"line\"><span class=\"comment\"># 其他配置 网络，容器卷，全局规则</span></span><br><span class=\"line\"><span class=\"attr\">volumes:</span></span><br><span class=\"line\"><span class=\"attr\">networks:</span></span><br><span class=\"line\"><span class=\"attr\">configs:</span></span><br><span class=\"line\">\t</span><br><span class=\"line\"><span class=\"comment\"># 三层 - version - service - other</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vY29tcG9zZS9jb21wb3NlLWZpbGUvY29tcG9zZS1maWxlLXYzLyNidWlsZA==\">Compose file version 3 reference (docker.com)</span></p>\n<h3 id=\"docker-compose-搭建wordpress\"><a class=\"markdownIt-Anchor\" href=\"#docker-compose-搭建wordpress\">#</a> docker-compose 搭建 WordPress</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2RvY2tlci9hd2Vzb21lLWNvbXBvc2UvYmxvYi9tYXN0ZXIvd29yZHByZXNzLW15c3FsL2NvbXBvc2UueWFtbA==\">awesome-compose/compose.yaml at master · docker/awesome-compose (github.com)</span></p>\n<p>1. 下载项目 (docker-compose.yml)</p>\n<p>2. 如果需要 dockerfile</p>\n<p>3. 文件准备齐全，一键启动</p>\n<h3 id=\"实战\"><a class=\"markdownIt-Anchor\" href=\"#实战\">#</a> 实战</h3>\n<p>1. 编写微服务</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">package</span> com.example.demo.controller;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">import</span> jakarta.annotation.Resource;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.GetMapping;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.springframework.web.bind.annotation.RestController;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">@RestController</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">HelloController</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@Autowired</span></span><br><span class=\"line\">    StringRedisTemplate stringRedisTemplate;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"meta\">@GetMapping(&quot;/hello&quot;)</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> String <span class=\"title function_\">hello</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"type\">Long</span> <span class=\"variable\">views</span> <span class=\"operator\">=</span> stringRedisTemplate.opsForValue().increment(<span class=\"string\">&quot;views&quot;</span>);</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;hello&quot;</span> + views;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>2.dockerfile 构建镜像</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FROM hzkjhub/java17:17.0.4</span><br><span class=\"line\"></span><br><span class=\"line\">COPY *.jar /app.jar</span><br><span class=\"line\"></span><br><span class=\"line\">CMD [&quot;--server.port=8080&quot;]</span><br><span class=\"line\"></span><br><span class=\"line\">EXPOSE 8080</span><br><span class=\"line\"></span><br><span class=\"line\">ENTRYPOINT [&quot;java&quot;,&quot;-jar&quot;,&quot;/app.jar&quot;]</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3.docker-compose.yml 编排项目</p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&quot;3.9&quot;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\">  <span class=\"attr\">web:</span></span><br><span class=\"line\">    <span class=\"attr\">build:</span> <span class=\"string\">.</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">haha</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;8080:8080&quot;</span></span><br><span class=\"line\">  <span class=\"attr\">redis:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">&quot;redis:alpine3.8&quot;</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>4. 服务器 up 启动</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmNoZW5zbWFsbHgudG9wLzIwMjEvMDQvMDgvbmV4dGNsb3VkLW9uLWRvY2tlci8jZG9ja2VyLWNvbXBvc2UlRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=\">使用 docker-compose 搭建 nextcloud+Nginx+MySQL+Redis | Case of Xeon (chensmallx.top)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8yMTA0NTg0\">docker-compose 搭建 nginx+php+redis+mysql 环境 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80Nzk2MjMwOC9hcnRpY2xlL2RldGFpbHMvMTA5MTY2OTYz\">(66 条消息) Docker-compose 部署 nginx+mysql 模板_docker 部署 nginx mysql_仓鼠 小白的博客 - CSDN 博客</span></p>\n<h3 id=\"docker-compose-network\"><a class=\"markdownIt-Anchor\" href=\"#docker-compose-network\">#</a> docker-compose network</h3>\n<h4 id=\"类型\"><a class=\"markdownIt-Anchor\" href=\"#类型\">#</a> 类型</h4>\n<h5 id=\"default\"><a class=\"markdownIt-Anchor\" href=\"#default\">#</a> default</h5>\n<p>当我们运行 docker-compose up 时，将会执行以下几步：</p>\n<ul>\n<li>创建一个名为 myapp_default 的网络；</li>\n<li>使用 web 服务的配置创建容器，它以 “web” 这个名称加入网络 myapp_default；</li>\n<li>使用 db 服务的配置创建容器，它以 “db” 这个名称加入网络 myapp_default。</li>\n</ul>\n<p>默认情况下 docker-compose 会建立一个默认的网络，名称为 docker-compose.yml 所在目录名称小写形式加上 “_default”，我们的 TFLinux 环境就是 “tflinux_default”。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># cd ngsql/</span></span><br><span class=\"line\">[root@hecs-346515 ngsql]<span class=\"comment\"># ls </span></span><br><span class=\"line\">app  cache  db  docker-compose.yml  proxy</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># docker network ls </span></span><br><span class=\"line\">NETWORK ID     NAME                   DRIVER    SCOPE</span><br><span class=\"line\">5ed45bf78d6f   app_default            bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">2eea384bdd95   bridge                 bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">73c5128a4cfc   com-nginx_default      bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">362bcfa74398   composetest_default    bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">a919986fdc8c   host                   host      <span class=\"built_in\">local</span></span><br><span class=\"line\">a1c8315f1897   my_wordpress_default   bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">d1e6b687dcd0   ngsql_default          bridge    <span class=\"built_in\">local</span></span><br><span class=\"line\">a0d53da9cf10   none                   null      <span class=\"built_in\">local</span></span><br></pre></td></tr></table></figure>\n<p>这个默认网络会对所有 services 下面的服务生效，所以 services 下面的各个服务之间才能够通过 service 名称互相访问。</p>\n<p>如果要自定义默认网络可以针对 “default” 网络进行设置，这样就会影响导默认网络了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">networks:</span><br><span class=\"line\"></span><br><span class=\"line\">  default:</span><br><span class=\"line\">    driver: bridge</span><br></pre></td></tr></table></figure>\n<h5 id=\"自定义\"><a class=\"markdownIt-Anchor\" href=\"#自定义\">#</a> 自定义</h5>\n<p>除了默认网络之外，我们也可以建立自定义的网络，这个网络名称就比较随意了。</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">networks:</span><br><span class=\"line\"></span><br><span class=\"line\">  persist:</span><br><span class=\"line\">    driver: bridge</span><br></pre></td></tr></table></figure>\n<h3 id=\"已存在网络\"><a class=\"markdownIt-Anchor\" href=\"#已存在网络\">#</a> 已存在网络</h3>\n<p>通过 docker network create 创建好的网络，而不是让 docker-compose 创建一个新的，这个时候就需要用到 “external” 关键字了。</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">networks:</span><br><span class=\"line\"></span><br><span class=\"line\">  persist:</span><br><span class=\"line\">    external:</span><br><span class=\"line\">      name: bridge2</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82ODQ0OTAzOTc2NTM0NTQwMjk2\">Docker Compose 网络设置 - 掘金 (juejin.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zODI3NzkxNjA=\">docker-compose 的网络 networks 的使用技巧 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9oZXhvLmNoZW5zbWFsbHgudG9wLzIwMjEvMDQvMDgvbmV4dGNsb3VkLW9uLWRvY2tlci8jZG9ja2VyLWNvbXBvc2UlRTklODUlOEQlRTclQkQlQUUlRTYlOTYlODclRTQlQkIlQjY=\">使用 docker-compose 搭建 nextcloud+Nginx+MySQL+Redis | Case of Xeon (chensmallx.top)</span></p>\n<figure class=\"highlight yaml\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attr\">version:</span> <span class=\"string\">&#x27;3.4&#x27;</span></span><br><span class=\"line\"><span class=\"attr\">services:</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">db:</span> <span class=\"comment\"># 这里只是给每个容器单独配置一个名称</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">mariadb</span> <span class=\"comment\"># 具体的镜像名称，可以使用“:”指定镜像的版本</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span> <span class=\"comment\"># 重启的选项，分为no、on-failure、on-failure:x、always、unless-stopped，具体可以自行搜索查看区别</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span> </span><br><span class=\"line\">    <span class=\"comment\"># expose仅将指定的端口暴露给links的容器，而不对宿主机开放。</span></span><br><span class=\"line\">    <span class=\"comment\"># 和ports的区别在于，ports可以映射宿主机别的端口到容器中。</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">&quot;3306&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">    <span class=\"comment\"># volumes指的是将宿主机的路径映射到容器中的指定位置</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./db:/var/lib/mysql</span></span><br><span class=\"line\">    <span class=\"attr\">environment:</span></span><br><span class=\"line\">    <span class=\"comment\"># environment可以对容器创建指定多个环境变量</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_ROOT_PASSWORD=root_password</span> <span class=\"comment\"># 这里配置root密码</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_DATABASE=nextcloud</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_USER=user_name</span> <span class=\"comment\"># 这里配置一个非root账户给nextcloud使用</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">MYSQL_PASSWORD=user_password</span> <span class=\"comment\"># 这里配置上面那个账号的密码</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">cache:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">redis</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">&quot;6379&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./cache:/data</span></span><br><span class=\"line\">    <span class=\"attr\">command:</span> <span class=\"string\">redis-server</span> <span class=\"string\">--requirepass</span> <span class=\"string\">&#x27;redis_password&#x27;</span> <span class=\"comment\"># 这里的redis_password换成你要配置的redis密码</span></span><br><span class=\"line\">    <span class=\"comment\"># command指的是启动容器后代替默认启动指令来启动服务的指令</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">app:</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nextcloud:fpm</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">&quot;9000&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./app/html:/var/www/html</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./app/data:/var/www/html/data</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./app/config:/var/www/html/config</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./app/custom_apps:/var/www/html/custom_apps</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">    <span class=\"comment\"># links将容器与当前容器链接起来，以使得当前容器可以访问目标容器expose的端口</span></span><br><span class=\"line\">    <span class=\"comment\"># 格式为 容器的原名:映射到当前容器中的名称</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">db:db</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">cache:cache</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">    <span class=\"comment\"># 依赖的容器列表，只有这些容器都成功启动了，才会启动当前容器</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">db</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">cache</span></span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"attr\">proxy:</span> <span class=\"comment\"># 叫做proxy是因为是作为代理来提供服务</span></span><br><span class=\"line\">    <span class=\"attr\">image:</span> <span class=\"string\">nginx</span></span><br><span class=\"line\">    <span class=\"attr\">restart:</span> <span class=\"string\">unless-stopped</span></span><br><span class=\"line\">    <span class=\"attr\">expose:</span></span><br><span class=\"line\">      <span class=\"bullet\">-</span> <span class=\"string\">&quot;80&quot;</span></span><br><span class=\"line\">    <span class=\"attr\">ports:</span></span><br><span class=\"line\">    <span class=\"comment\"># ports可将容器内的端口映射到宿主机上</span></span><br><span class=\"line\">    <span class=\"comment\"># 这里是将容器的443端口映射到宿主机的7788端口</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"number\">7788</span><span class=\"string\">:443</span></span><br><span class=\"line\">    <span class=\"attr\">volumes:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./app/html:/var/www/html</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./proxy/conf.d:/etc/nginx/conf.d:ro</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">./proxy/ssl_certs:/etc/nginx/ssl_certs:ro</span></span><br><span class=\"line\">    <span class=\"attr\">links:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">app:app</span></span><br><span class=\"line\">    <span class=\"attr\">depends_on:</span></span><br><span class=\"line\">     <span class=\"bullet\">-</span> <span class=\"string\">app</span></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-swarm\"><a class=\"markdownIt-Anchor\" href=\"#docker-swarm\">#</a> docker swarm</h2>\n<p>集群的方式部署</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/swarm-diagram.png\" alt=\"Swarm mode cluster\"></p>\n<p>操作都在 manager</p>\n<h3 id=\"搭建集群\"><a class=\"markdownIt-Anchor\" href=\"#搭建集群\">#</a> 搭建集群</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">初始化管理节点</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker swarm init --advertise-addr 172.26.35.5</span><br><span class=\"line\">Swarm initialized: current node (amsigufjp7n6t878um697rtxx) is now a manager.</span><br><span class=\"line\"></span><br><span class=\"line\">To add a worker to this swarm, run the following command:</span><br><span class=\"line\"></span><br><span class=\"line\">    docker swarm join --token SWMTKN-1-378os4pztqynptic0b8kdsgysg21lq6x1u7ru4nxrv99ym9mgc-1hwbeetgvza2ympnj0s9kep3l 172.26.35.5:2377</span><br><span class=\"line\"></span><br><span class=\"line\">To add a manager to this swarm, run &#x27;docker swarm join-token manager&#x27; and follow the instructions.</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">加入节点</span><br><span class=\"line\">docker swarm join</span><br><span class=\"line\"></span><br><span class=\"line\">获取令牌</span><br><span class=\"line\">docker swarm join-token manager</span><br><span class=\"line\">docker swarm join-token worker</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker node ls </span><br><span class=\"line\">ID                            HOSTNAME                  STATUS    AVAILABILITY   MANAGER STATUS   ENGINE VERSION</span><br><span class=\"line\">amsigufjp7n6t878um697rtxx *   iZuf6dzrpxpwleuxiysmvrZ   Ready     Active         Leader           23.0.3</span><br><span class=\"line\">cg0dbg0k739u58yybwwlowr3z     iZuf6dzrpxpwleuxiysmvsZ   Ready     Active                          23.0.3</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">systemctl stop firewalld </span><br><span class=\"line\">systemctl disable firewalld </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>1. 生成主节点 inti</p>\n<p>2. 加入 (manager , worker)</p>\n<h3 id=\"raft\"><a class=\"markdownIt-Anchor\" href=\"#raft\">#</a> raft</h3>\n<p>保证大多数节点存活才可以用，集群至少 &gt; 3 台主节点，必须保证大多数节点存活才可以使用，&gt;1</p>\n<p>双主双从的情况下：</p>\n<p>manager 停止一个，另一个 manager 也不能用了</p>\n<p>其他 worker 随便离开</p>\n<p>work 只是工作，需要在管理节点操作</p>\n<p>三主一从</p>\n<p>至少有两个主存活集群还能使用</p>\n<h3 id=\"弹性创建服务\"><a class=\"markdownIt-Anchor\" href=\"#弹性创建服务\">#</a> 弹性创建服务</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker service --help </span><br><span class=\"line\"></span><br><span class=\"line\">Usage:  docker service COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">Manage Swarm services</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  create      Create a new service</span><br><span class=\"line\">  inspect     Display detailed information on one or more services</span><br><span class=\"line\">  logs        Fetch the logs of a service or task</span><br><span class=\"line\">  ls          List services</span><br><span class=\"line\">  ps          List the tasks of one or more services</span><br><span class=\"line\">  rm          Remove one or more services</span><br><span class=\"line\">  rollback    Revert changes to a service&#x27;s configuration</span><br><span class=\"line\">  scale       Scale one or multiple replicated services</span><br><span class=\"line\">  update      Update a service</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>灰度发布：金丝雀发布   升级不影响使用</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service create -p 8888:80 --name=nginx001  nginx </span></span><br><span class=\"line\">vrs4gx1m5dyydclezt4bbwnkj</span><br><span class=\"line\">overall progress: 1 out of 1 tasks </span><br><span class=\"line\">1/1: running   </span><br><span class=\"line\">verify: Service converged </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker run <span class=\"comment\">#容器启动，不具有扩缩容</span></span><br><span class=\"line\">docker service <span class=\"comment\">#具有扩缩容，滚动更新</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service ps nginx001 </span></span><br><span class=\"line\">ID             NAME         IMAGE          NODE                      DESIRED STATE   CURRENT STATE                ERROR     PORTS</span><br><span class=\"line\">2eewg8do04rd   nginx001.1   nginx:latest   iZuf6dzrpxpwleuxiysmvrZ   Running         Running about a minute ago             </span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service ls </span></span><br><span class=\"line\">ID             NAME       MODE         REPLICAS   IMAGE          PORTS</span><br><span class=\"line\">vrs4gx1m5dyy   nginx001   replicated   1/1        nginx:latest   *:8888-&gt;80/tcp</span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service create -p 8888:80 --name=nginx001  nginx </span></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service update --replicas 3 nginx001 </span></span><br><span class=\"line\"><span class=\"comment\"># 服务，集群中的任意节点都可以被访问，服务可以有多个副本动态扩缩容实现高可用</span></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service scale nginx001=5</span></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service rm nginx001 </span></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service ls</span></span><br></pre></td></tr></table></figure>\n<p><strong>swarm</strong></p>\n<p>集群的管理和编排，docker 可以初始化一个集群，其他节点可以加入</p>\n<p>加入时由 manager 和 worker 角色</p>\n<p><strong>node</strong></p>\n<p>就是一个 docker 节点，多个节点组成了网络集群</p>\n<p><strong>service</strong></p>\n<p>任务，可以在管理节点或工作节点运行。用户访问的就是他</p>\n<p><strong>task</strong></p>\n<p>容器内的命令</p>\n<p>命令 -&gt; 管理 -&gt;api -&gt; 调度 -&gt; 工作节点 (创建 task 容器维护)</p>\n<p>调整 service 以什么方式运行</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--mode string </span><br><span class=\"line\"></span><br><span class=\"line\">global server / replicated service </span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service create --mode global --name haha centos</span></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker service create --mode replicated --name haha centos</span></span><br></pre></td></tr></table></figure>\n<p>global 能在任何节点运行，replicated 只能在 worker 运行，默认 replicated</p>\n <img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407140542074.png\" alt=\"image-20230407140542074\" style=\"zoom:50%;\" />\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# yum install bridge-utils.x86_64 </span><br></pre></td></tr></table></figure>\n<p>swarm 中有三个网络，ingress，overlay，</p>\n<p>ingress：特殊的 overlay，具有负载均衡功能</p>\n<h2 id=\"docker-stack\"><a class=\"markdownIt-Anchor\" href=\"#docker-stack\">#</a> Docker Stack</h2>\n<p>集群部署项目，相当于集群版的 docker-compose</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker stack deploy 111.yml</span><br><span class=\"line\"></span><br><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]<span class=\"comment\"># docker stack --help</span></span><br><span class=\"line\"></span><br><span class=\"line\">Usage:  docker stack COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">Manage Swarm stacks</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  config      Outputs the final config file, after doing merges and interpolations</span><br><span class=\"line\">  deploy      Deploy a new stack or update an existing stack</span><br><span class=\"line\">  <span class=\"built_in\">ls</span>          List stacks</span><br><span class=\"line\">  ps          List the tasks <span class=\"keyword\">in</span> the stack</span><br><span class=\"line\">  <span class=\"built_in\">rm</span>          Remove one or more stacks</span><br><span class=\"line\">  services    List the services <span class=\"keyword\">in</span> the stack</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-secret\"><a class=\"markdownIt-Anchor\" href=\"#docker-secret\">#</a> docker  secret</h2>\n<p>安全，证书，配置密码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker secret --help </span><br><span class=\"line\"></span><br><span class=\"line\">Usage:  docker secret COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">Manage Swarm secrets</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  create      Create a secret from a file or STDIN as content</span><br><span class=\"line\">  inspect     Display detailed information on one or more secrets</span><br><span class=\"line\">  ls          List secrets</span><br><span class=\"line\">  rm          Remove one or more secrets</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-config\"><a class=\"markdownIt-Anchor\" href=\"#docker-config\">#</a> docker config</h2>\n<p>配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@iZuf6dzrpxpwleuxiysmvrZ ~]# docker config --help</span><br><span class=\"line\"></span><br><span class=\"line\">Usage:  docker config COMMAND</span><br><span class=\"line\"></span><br><span class=\"line\">Manage Swarm configs</span><br><span class=\"line\"></span><br><span class=\"line\">Commands:</span><br><span class=\"line\">  create      Create a config from a file or STDIN</span><br><span class=\"line\">  inspect     Display detailed information on one or more configs</span><br><span class=\"line\">  ls          List configs</span><br><span class=\"line\">  rm          Remove one or more configs</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ctr-crictl\"><a class=\"markdownIt-Anchor\" href=\"#ctr-crictl\">#</a> ctr &amp;&amp; crictl</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230626205442159.png\" alt=\"image-20230626205442159\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230626205458946.png\" alt=\"image-20230626205458946\"></p>\n<p>Containerd 也有 namespaces 的概念，对于上层编排系统的支持，主要区分了 3 个命名空间分别是 <code>k8s.io</code> 、 <code>moby</code>  和 <code>default</code> ，以上我们用 crictl 操作的均在 k8s.io 命名空间完成如查看镜像列表就需要加上 <code>-n</code>  参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ctr -n k8s.io images list</span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2023/04/03/iptables2/",
            "url": "http://example.com/2023/04/03/iptables2/",
            "title": "iptables",
            "date_published": "2023-04-03T05:38:45.000Z",
            "content_html": "<h1 id=\"iptables\"><a class=\"markdownIt-Anchor\" href=\"#iptables\">#</a> iptables</h1>\n<p>iptables 是 Linux 防火墙工作在用户空间的管理工具，是  <code>netfilter/iptables</code> IP 信息包过滤系统是一部分，用来设置、维护和检查 Linux 内核的 IP 数据包过滤规则。</p>\n<p>iptables 是集成在 Linux 内核中的<strong>包过滤防火墙</strong>系统。使用 iptables 可以添加、删除具体的过滤规则，iptables 默认维护着 4 个表和 5 个链，所有的防火墙策略规则都被分别写入这些表与链中。</p>\n<p>“四表” 是指 iptables 的功能，默认的 iptables 规则表有 <strong>filter 表（过滤规则表）、nat 表（地址转换规则表）、mangle（修改数据标记位规则表）、raw（跟踪数据表规则表）：</strong></p>\n<p>五链” 是指内核中控制网络的 NetFilter 定义的 5 个规则链。每个规则表中包含多个数据链：I<strong>NPUT（入站数据过滤）、OUTPUT（出站数据过滤）、FORWARD（转发数据过滤）、PREROUTING（路由前过滤）和 POSTROUTING（路由后过滤）</strong>，防火墙规则需要写入到这些具体的数据链中。</p>\n<p>iptables 的结构是由表（tables）组成，而 tables 是由链组成，链又是由具体的规则组成。因此我们在编写 iptables 规则时，要先指定表，再指定链。tables 的作用是区分不同功能的规则，并且存储这些规则。</p>\n<blockquote>\n<p>filter 表：控制数据包是否允许进出及转发，可以控制的链路有 INPUT、FORWARD 和 OUTPUT。</p>\n<p>nat 表：控制数据包中地址转换，可以控制的链路有 PREROUTING、INPUT、OUTPUT 和 POSTROUTING。</p>\n<p>mangle：修改数据包中的原数据。它能改变 TCP 头中的 QoS 位。可以控制的链路有 PREROUTING、INPUT、OUTPUT、FORWARD 和 POSTROUTING。</p>\n<p>raw：控制 nat 表中连接追踪机制的启用状况，可以控制的链路有 PREROUTING、OUTPUT。</p>\n<p>优先级：raw &gt; mangle &gt; nat &gt; filter</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/9ddgnzua1k.png\" alt=\"img\"></p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ce49aedfc45c82ef6a6f261c82af07a4.gif\" alt=\"Linux命令\"></p>\n<blockquote>\n<p>当一个数据包进入网卡时，它首先进入  <code>PREROUTING</code>  链，内核根据数据包目的 IP 判断是否需要转送出去。</p>\n<p>如果数据包就是进入本机的，它就会沿着图向下移动，到达  <code>INPUT</code>  链。数据包到了 INPUT 链后，任何进程都会收到它。</p>\n<p>本机上运行的程序可以发送数据包，这些数据包会经过  <code>OUTPUT</code>  链，然后到达 <code>POSTROUTING</code>  链输出。</p>\n<p>如果数据包是要转发出去的，且内核允许转发，数据包就会如图所示向右移动，经过  <code>FORWARD</code>  链，然后到达  <code>POSTROUTING</code>  链输出。</p>\n<p>如果是外部主机发送数据包给防火墙本机，数据将会经过 PREROUTING 链与 INPUT 链；</p>\n<p>如果是防火墙本机发送数据包到外部主机，数据将会经过 OUTPUT 链与 POSTROUTING 链；</p>\n<p>如果防火墙作为路由负责转发数据，则数据将经过 PREROUTING 链、FORWARD 链以及 POSTROUTING 链。</p>\n</blockquote>\n<h2 id=\"iptables-语法\"><a class=\"markdownIt-Anchor\" href=\"#iptables-语法\">#</a> iptables 语法</h2>\n<p><code>iptables [-t table] command [链名] [条件匹配] [-j 目标动作]</code></p>\n<p>如果满足条件，就执行目标 (target) 中的规则或者特定值。</p>\n<p>如果不满足条件，就判断下一条 Rules。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/jd6utdfije.png\" alt=\"img\"></p>\n<blockquote>\n<ul>\n<li>-t：指定需要维护的防火墙规则表 filter、nat、mangle 或 raw。在不使用 -t 时则默认使用 filter 表。</li>\n<li>COMMAND：子命令，定义对规则的管理。</li>\n<li>chain：指明链表。</li>\n<li>Parameter：匹配参数。</li>\n<li>target：触发动作。</li>\n</ul>\n</blockquote>\n<h3 id=\"command\"><a class=\"markdownIt-Anchor\" href=\"#command\">#</a> command</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">选 项</th>\n<th style=\"text-align:left\">功 能</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">-A</td>\n<td style=\"text-align:left\">添加防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-D</td>\n<td style=\"text-align:left\">删除防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-I</td>\n<td style=\"text-align:left\">插入防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-F</td>\n<td style=\"text-align:left\">清空防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-L</td>\n<td style=\"text-align:left\">列出添加防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-R</td>\n<td style=\"text-align:left\">替换防火墙规则</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-Z</td>\n<td style=\"text-align:left\">清空防火墙数据表统计信息</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-P</td>\n<td style=\"text-align:left\">设置链默认规则</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"parameter\"><a class=\"markdownIt-Anchor\" href=\"#parameter\">#</a> parameter</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">参 数</th>\n<th style=\"text-align:left\">功 能</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">-p</td>\n<td style=\"text-align:left\">匹配协议，! 表示取反</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-s</td>\n<td style=\"text-align:left\">匹配源地址</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-d</td>\n<td style=\"text-align:left\">匹配目标地址</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-i</td>\n<td style=\"text-align:left\">匹配入站网卡接口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-o</td>\n<td style=\"text-align:left\">匹配出站网卡接口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–sport</td>\n<td style=\"text-align:left\">匹配源端口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–dport</td>\n<td style=\"text-align:left\">匹配目标端口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–src-range</td>\n<td style=\"text-align:left\">匹配源地址范围</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–dst-range</td>\n<td style=\"text-align:left\">匹配目标地址范围</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-m limit --limit 匹配速率</td>\n<td style=\"text-align:left\">四配数据表速率</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-m mac --mac-source MAC</td>\n<td style=\"text-align:left\">匹配源 MAC 地址</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–sports</td>\n<td style=\"text-align:left\">匹配源端口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–dports</td>\n<td style=\"text-align:left\">匹配目标端口</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-m state --state 状态</td>\n<td style=\"text-align:left\">匹配状态（INVALID、ESTABLISHED、NEW、RELATED)</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">–string</td>\n<td style=\"text-align:left\">匹配应用层字串</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-–tcp-flags</td>\n<td style=\"text-align:left\">SYN, ACK, FIN, RST, URG, PSH</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">-–icmp-type</td>\n<td style=\"text-align:left\">0,8</td>\n</tr>\n</tbody>\n</table>\n<h3 id=\"action\"><a class=\"markdownIt-Anchor\" href=\"#action\">#</a> action</h3>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">触发动作</th>\n<th style=\"text-align:left\">功 能</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">ACCEPT</td>\n<td style=\"text-align:left\">允许数据包通过</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">DROP</td>\n<td style=\"text-align:left\">丢弃数据包</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">REJECT</td>\n<td style=\"text-align:left\">拒绝数据包通过</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">LOG</td>\n<td style=\"text-align:left\">将数据包信息记录 syslog 曰志</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">DNAT</td>\n<td style=\"text-align:left\">目标地址转换</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">SNAT</td>\n<td style=\"text-align:left\">源地址转换</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">MASQUERADE</td>\n<td style=\"text-align:left\">地址欺骗</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">REDIRECT</td>\n<td style=\"text-align:left\">重定向</td>\n</tr>\n</tbody>\n</table>\n<p><strong>内核会按照顺序依次检查 iptables 防火墙规则，如果发现有匹配的规则目录，则立刻执行相关动作，停止继续向下查找规则目录；如果所有的防火墙规则都未能匹配成功，则按照默认策略处理</strong></p>\n<p>如果没有 iptables，安装～</p>\n<h3 id=\"安装iptables\"><a class=\"markdownIt-Anchor\" href=\"#安装iptables\">#</a> 安装 iptables</h3>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">systemctl stop firewalld //关闭firewalld服务</span><br><span class=\"line\">yum -y install iptables-services</span><br><span class=\"line\">systemctl start iptables //启动iptables</span><br><span class=\"line\">vim /etc/sysconfig/iptables  //iptables 配置实例</span><br></pre></td></tr></table></figure>\n<h3 id=\"查看iptables\"><a class=\"markdownIt-Anchor\" href=\"#查看iptables\">#</a> 查看 iptables</h3>\n<ul>\n<li>-L 表示查看当前表的所有规则，默认查看的是 filter 表，如果要查看 nat 表，可以加上 -t nat 参数。</li>\n<li>-n 表示不对 IP 地址进行反查，加上这个参数显示速度将会加快。</li>\n<li>-v 表示输出详细信息，包含通过该规则的数据包数量、总字节数以及相应的网络接口。</li>\n</ul>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]# iptables -nvL --line-number</span><br><span class=\"line\">Chain INPUT (policy ACCEPT 3825K packets, 419M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 DOCKER-INGRESS  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3        0     0 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">4        0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">5        0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6        0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">7        0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">8        0     0 ACCEPT     all  --  *      docker_gwbridge  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">9        0     0 DOCKER     all  --  *      docker_gwbridge  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">10       0     0 ACCEPT     all  --  docker_gwbridge !docker_gwbridge  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">11       0     0 DROP       all  --  docker_gwbridge docker_gwbridge  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT 3586K packets, 397M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-INGRESS (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 DOCKER-ISOLATION-STAGE-2  all  --  docker_gwbridge !docker_gwbridge  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-2 (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 DROP       all  --  *      docker_gwbridge  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-USER (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"备份和还原\"><a class=\"markdownIt-Anchor\" href=\"#备份和还原\">#</a> 备份和还原</h2>\n<p>默认的 iptables 防火墙规则会立刻生效，但如果不保存，当计算机重启后所有的规则都会丢失</p>\n<p>iptables-save 和 iptables-restore，使用该工具可以实现防火墙规则的保存与还原。这两个工具的最大优势是处理庞大的规则集时速度非常快。</p>\n<h3 id=\"iptables-save\"><a class=\"markdownIt-Anchor\" href=\"#iptables-save\">#</a> iptables-save</h3>\n<p>iptables-save 命令用来批量导出 Linux 防火墙规则，语法介绍如下：</p>\n<p>保存在默认文件夹中（保存防火墙规则）： iptables-save &gt; /etc/sysconfig/iptables</p>\n<p>保存在其他位置（备份防火墙规则）： iptables-save &gt; 文件名称</p>\n<h3 id=\"iptables-restore\"><a class=\"markdownIt-Anchor\" href=\"#iptables-restore\">#</a> iptables-restore</h3>\n<p>iptables-restore 命令可以批量导入 Linux 防火墙规则，同时也需要结合重定向输入来指定备份文件的位置。命令如下：</p>\n<p>iptables-restore &lt; 文件名称</p>\n<h2 id=\"实例\"><a class=\"markdownIt-Anchor\" href=\"#实例\">#</a> 实例</h2>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -A INPUT -j ACCEPT <span class=\"comment\"># 允许所有访问本机的数据包通过</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -A FORWARD -s 10.10.10.10 -j DROP <span class=\"comment\"># 阻止来自10.10.10.10 的数据包通过本机</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to 18.18.18.18 <span class=\"comment\">#  将内网 192.168.1.0/24 转换为公网18.18.18.18地址</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -j SNAT --to 18.18.18.18-18.18.18.28</span><br><span class=\"line\"></span><br><span class=\"line\">iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.1.1 <span class=\"comment\"># 把从eth0口进来访问TCP/80端口的数据包目的地址改成192.168.1.1</span></span><br><span class=\"line\">iptables -t nat -A PREROUTING -i eth0 -p tcp --dport 80 -j DNAT --to 192.168.1.1-192.168.1.10</span><br><span class=\"line\"></span><br><span class=\"line\">iptables -t nat -A POSTROUTING -s 192.168.1.0/24 -o eth0 -j MASQUERADE <span class=\"comment\"># 将源地址是 192.168.1.0/24 的数据包进行地址伪装，转换成 eth0 上的 IP 地址</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.允许接收远程主机的SSH请求</span></span><br><span class=\"line\">iptables -A INPUT -i eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.允许发送本地主机的SSH响应</span></span><br><span class=\"line\">iptables -A OUTPUT -o eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 1.送出的数据包目的端口为22</span></span><br><span class=\"line\">iptables -A OUTPUT -o eth0 -p tcp --dport 22 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 2.接收的数据包源端口为22</span></span><br><span class=\"line\">iptables -A INPUT -i eth0 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 3.允许接收远程主机的HTTP请求</span></span><br><span class=\"line\">iptables -A INPUT -i eth0 -p tcp --dport 80 -m state --state NEW,ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 4.允许发送本地主机的HTTP响应</span></span><br><span class=\"line\">iptables -A OUTPUT -o eth0 -p tcp --sport 80 -m state --state ESTABLISHED -j ACCEPT</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 转发端口 DNAT</span></span><br><span class=\"line\">iptables -t nat -I PREROUTING -p tcp --dport 3389 -j DNAT --to x.x.x.x</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 转发端口 SNAT</span></span><br><span class=\"line\">iptables -t nat -I POSTROUTING -p tcp --dport 3389 -j MASQUERADE</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 把本地的mysql 3306端口映射出去变成63306</span></span><br><span class=\"line\">iptables -t nat -A PREROUTING -p tcp -m tcp --dport 63306 -j DNAT --to-destination 127.0.0.1:3306</span><br><span class=\"line\">iptables -t nat -A POSTROUTING -p tcp -m tcp --dport 63306 -j SNAT --to-source 127.0.0.1</span><br><span class=\"line\"><span class=\"comment\"># 限制单个来源IP</span></span><br><span class=\"line\">iptables -t nat -R PREROUTING 4 -s 192.168.40.154 -p tcp -m tcp --dport 63306 -j DNAT --to-destination 127.0.0.1:3306</span><br><span class=\"line\">iptables -t nat -R POSTROUTING 4 -s 192.168.40.154 -p tcp -m tcp --dport 63306 -j SNAT --to-source 127.0.0.1</span><br><span class=\"line\"></span><br><span class=\"line\">iptables -A INPUT -m state --state RELATED,ESTABLISHED -j ACCEPT <span class=\"comment\"># 将目前已运行的服务端口全部放行</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -A INPUT -m mac --mac-source xx:xx:xx:xx:xx:xx -j DROP <span class=\"comment\">#  拒绝来自某 MAC 地址的数据包进入本机</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -A FORWARD -d 192.168.1.1 -m <span class=\"built_in\">limit</span> --<span class=\"built_in\">limit</span> 50/s -j ACCEPT <span class=\"comment\"># 50/s 表示 1 秒中转发 50 个数据包,按一定速率去匹配</span></span><br><span class=\"line\"></span><br><span class=\"line\">iptables -A INPUT -p tcp -m multiport --dports 22,53,80,443 -j ACCEPT <span class=\"comment\"># 多端口匹配 </span></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker网络\"><a class=\"markdownIt-Anchor\" href=\"#docker网络\">#</a> docker 网络</h2>\n<p>Docker 原生网络是基于 Linux 的 网络命名空间（net namespace） 和 虚拟网络设备（veth pair）实现的。当 Docker 进程启动时，会在宿主机上创建一个名称为 docker0 的 虚拟网桥，在该宿主机上启动的 Docker 容器会连接到这个虚拟网桥上。</p>\n<p>虚拟网桥的工作方式和物理交换机类似，宿主机上所有的容器通过虚拟网桥连接在一个二层网络中。</p>\n<p>从 docker0 子网中分配一个 IP 给容器使用，并设置 docker0 的 IP 地址为容器的默认网关。在宿主机上创建一对虚拟网卡 veth pair 设备， Docker 将 veth pair 设备的一端放在新创建的容器中，并命名为 eth0（容器的网卡）， 另一端放在宿主机中，以 vethxxx 类似的名字命名， 并将这个网络设备连接到 docker0 网桥中。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># ip a</span></span><br><span class=\"line\">3: docker0: &lt;NO-CARRIER,BROADCAST,MULTICAST,UP&gt; mtu 1500 qdisc noqueue state DOWN group default </span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:27:32:a6:49 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.17.0.1/16 brd 172.17.255.255 scope global docker0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\">    inet6 fe80::42:27ff:fe32:a649/64 scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\">260: veth95b76a5@if259: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc noqueue master br-5ed45bf78d6f state UP group default </span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 72:7e:42:35:8b:de brd ff:ff:ff:ff:ff:ff link-netnsid 0</span><br><span class=\"line\">    inet6 fe80::707e:42ff:fe35:8bde/64 scope <span class=\"built_in\">link</span> </span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># docker exec -it 71 /bin/sh</span></span><br><span class=\"line\">259: eth0@if260: &lt;BROADCAST,MULTICAST,UP,LOWER_UP,M-DOWN&gt; mtu 1500 qdisc noqueue state UP </span><br><span class=\"line\">    <span class=\"built_in\">link</span>/ether 02:42:ac:15:00:02 brd ff:ff:ff:ff:ff:ff</span><br><span class=\"line\">    inet 172.21.0.2/16 brd 172.21.255.255 scope global eth0</span><br><span class=\"line\">       valid_lft forever preferred_lft forever</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>Docker 会自动配置 iptables 规则和配置 NAT，便于连通宿主机上的 docker0 网桥，完成这些操作之后，容器就可以使用它的 eth0 虚拟网卡，来连接其他容器和访问外部网络。</p>\n<p>Docker 中的网络接口默认都是虚拟的接口，Linux 在内核中通过 数据复制 实现接口之间的数据传输，可以充分发挥数据在不同 Docker 容器或容器与宿主机之间的转发效率， 发送接口发送缓存中的数据包，将直接复制到接收接口的缓存中，无需通过物理网络设备进行交换。</p>\n<p><img data-src=\"https://s4.51cto.com/oss/202304/06/09ce7c384ad5a5127bb645510a17bf81061db2.png\" alt=\"图片\"></p>\n<p>虚拟网桥 docker0 通过 iptables 配置与宿主机器上的网卡相连，符合条件的请求都会通过 iptables 转发到 docker0, 然后分发给对应的容器。</p>\n<h3 id=\"docker中网络模式\"><a class=\"markdownIt-Anchor\" href=\"#docker中网络模式\">#</a> docker 中网络模式</h3>\n<table>\n<thead>\n<tr>\n<th>名称</th>\n<th>描述</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>bridge</td>\n<td>默认的网络设备，当应用程序所在的容器需要通信时使用</td>\n</tr>\n<tr>\n<td>host</td>\n<td>移除容器与宿主机之间的网络隔离，直接使用宿主机的网络</td>\n</tr>\n<tr>\n<td>overlay</td>\n<td>将多个容器连接，并使集群服务能够相互通信</td>\n</tr>\n<tr>\n<td>ipvlan</td>\n<td>使用户可以完全控制 IPv4 和 IPv6 寻址</td>\n</tr>\n<tr>\n<td>macvlan</td>\n<td>可以为容器分配 MAC 地址</td>\n</tr>\n<tr>\n<td>none</td>\n<td>禁用所有网络</td>\n</tr>\n<tr>\n<td>Network plugins</td>\n<td>通过 Docker 安装和使用第三方网络插件</td>\n</tr>\n</tbody>\n</table>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/e6d4db721071b3311c3217c24cfa981353412b.png\" alt=\"图片\"></p>\n<blockquote>\n<p>Docker daemon 通过调用 libnetwork 提供的 API 完成网络的创建和管理等功能。libnetwork 中使用了 CNM 来完成网络功能， CNM 中主要有沙盒（sandbox）、端点（endpoint）和网络（network）3 种组件。</p>\n<p>・沙盒：一个沙盒包含了一个容器网络栈的信息。一个沙盒可以有多个端点和多个网络，沙盒可以对容器的接口、路由和 DNS 设置等进行管理，沙盒的实现可以是 Linux network namespace、FreeBSD Jail 或者类似的机制</p>\n<p>・端点：一个端点可以加入一个沙盒和一个网络。一个端点只属于一个网络和一个沙盒，端点的实现可以是 veth pair、Open vSwitch 内部端口或者相似的设备</p>\n<p>・网络：一个网络是一组可以直接互相联通的端点。一个网络可以包含多个端点，网络的实现可以是 Linux bridge、VLAN 等</p>\n</blockquote>\n<p><strong>bridge</strong></p>\n<p>bridge 是默认的网络模式，为容器创建独立的网络命名空间，容器具有独立的网卡等所有的网络栈。使用该模式的 ** 所有容器都是连接到 docker0 这个网桥， 作为 虚拟交换机使容器可以相互通信，** 但是由于宿主机的 IP 地址与容器 veth pair 的 IP 地址不在同一个网段，所以为了和宿主机以外的网络通信， Docker 采用了端口绑定的方式，也就是通过 iptables 的 NAT，将宿主机上的端口流量转发到容器。</p>\n<p>外界通信时使用 NAT，增加了通信的复杂性，在复杂场景下使用会有限制。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ docker network inspect bridge</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 输出如下 (节选部分信息)</span></span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;bridge&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Scope&quot;</span>: <span class=\"string\">&quot;local&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;bridge&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;EnableIPv6&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;IPAM&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;default&quot;</span>,</span><br><span class=\"line\">            <span class=\"string\">&quot;Options&quot;</span>: null,</span><br><span class=\"line\">            <span class=\"string\">&quot;Config&quot;</span>: [</span><br><span class=\"line\">                &#123;</span><br><span class=\"line\">                    <span class=\"string\">&quot;Subnet&quot;</span>: <span class=\"string\">&quot;172.17.0.0/16&quot;</span>,</span><br><span class=\"line\">                    <span class=\"string\">&quot;Gateway&quot;</span>: <span class=\"string\">&quot;172.17.0.1&quot;</span></span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            ]</span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Containers&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"comment\"># 使用 bridge 网络的容器列表</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p>虚拟网桥 的 IP 地址就是 bridge 网络类型的容器的网关地址。</p>\n<p>在 iptables 做了 DNAT 规则，实现端口转发功能:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -nvL --line-number -t nat</span></span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination </span><br><span class=\"line\">6      847 44652 DNAT       tcp  --  !br-5ed45bf78d6f *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.21.0.3:8080</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>当容器需要将端口映射到宿主机时，Docker 会自动为该容器分配一个 IP 地址，同时新增一个 iptables 规则。</p>\n<p>容器 iptables 详解会在后面详细说明，先记住有 docker 这么一条链即可</p>\n<p><strong>host</strong></p>\n<p>容器不会获得一个独立的网络命名空间，而是和宿主机共用一个。容器不会虚拟出自己的网卡，配置自己的 IP 等，而是直接使用宿宿主机的。但是容器的其他方面，如文件系统、进程列表等还是和宿宿主机隔离的，容器对外界是完全开放的，能够访问到宿主机，就能访问到容器。</p>\n<p>host 模式降低了容器与容器之间、容器与宿主机之间网络层面的隔离性，虽然有性能上的优势，但是引发了网络资源的竞争与冲突，因此适用于容器集群规模较小的场景。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\"># 通过--net 指定容器的网络类型</span></span><br><span class=\"line\">docker run -d --net host nginx</span><br><span class=\"line\"></span><br><span class=\"line\">docker network inspect host </span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;host&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Scope&quot;</span>: <span class=\"string\">&quot;local&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;host&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Internal&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Attachable&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Ingress&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Network&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Containers&quot;</span>: &#123;</span><br><span class=\"line\">           <span class=\"comment\"># 使用 host 网络的容器列表  </span></span><br><span class=\"line\">           <span class=\"string\">&quot;f202870092fc40bc08a607dddbb2770df9bb4534475b066f45ea35252d6e76e2&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;frosty_napier&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;7306a8e4103faf4edd081182f015fa9aa985baf3560f4a49b9045c00dc603190&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">            &#125;        </span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br><span class=\"line\"><span class=\"comment\"># Nginx 容器使用的网络类型是 host，没有独立的 IP</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># netstat -lntup | grep 80 </span></span><br><span class=\"line\">tcp        0      0 0.0.0.0:80              0.0.0.0:*               LISTEN      19407/nginx: master </span><br><span class=\"line\">tcp        0      0 0.0.0.0:8080            0.0.0.0:*               LISTEN      7873/docker-proxy   </span><br><span class=\"line\">tcp6       0      0 :::80                   :::*                    LISTEN      19407/nginx: master </span><br><span class=\"line\">tcp6       0      0 :::8080                 :::*                    LISTEN      7877/docker-proxy </span><br></pre></td></tr></table></figure>\n<p><strong>none</strong></p>\n<p>容器拥有自己的 Network Namespace，但是并不进行任何网络配置。也就意味着该容器没有网卡、IP、路由等信息，需要手动为容器添加网卡、配置 IP 等， none 模式下的容器会完全隔离，容器中只有 lo 这个 loopback（回环网络）网卡用于进程通信。</p>\n<p>none 模式为容器做了最少的网络设置，在没有网络配置的情况下，通过自定义配置容器的网络，提供了最高的灵活性。</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">docker network insepct none </span><br><span class=\"line\">[</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;none&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Scope&quot;</span>: <span class=\"string\">&quot;local&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Driver&quot;</span>: <span class=\"string\">&quot;null&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Internal&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Attachable&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;Ingress&quot;</span>: <span class=\"literal\">false</span>,</span><br><span class=\"line\">        <span class=\"string\">&quot;ConfigFrom&quot;</span>: &#123;</span><br><span class=\"line\">            <span class=\"string\">&quot;Network&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">        <span class=\"string\">&quot;Containers&quot;</span>: &#123;</span><br><span class=\"line\">           <span class=\"comment\"># 使用 none 网络的容器列表  </span></span><br><span class=\"line\">           <span class=\"string\">&quot;d2d0606b7d2429c224e61e06c348019b74cd47f0b8c85347a7cdb8f1e30dcf86&quot;</span>: &#123;</span><br><span class=\"line\">                <span class=\"string\">&quot;Name&quot;</span>: <span class=\"string\">&quot;hardcore_chebyshev&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;EndpointID&quot;</span>: <span class=\"string\">&quot;b8ff645671518e608f403818a31b1db34d7fce66af60373346ea3ab673a4c6b2&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;MacAddress&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv4Address&quot;</span>: <span class=\"string\">&quot;&quot;</span>,</span><br><span class=\"line\">                <span class=\"string\">&quot;IPv6Address&quot;</span>: <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">            &#125;        </span><br><span class=\"line\">        &#125;,</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">]</span><br></pre></td></tr></table></figure>\n<p><strong>container</strong></p>\n<p>与 host 模式类似，** 容器与指定的容器共享网络命名空间。这两个容器之间不存在网络隔离，但它们与宿主机以及其他的容器存在网络隔离。** 该模式下的容器可以通过 localhost 来访问同一网络命名空间下的其他容器，传输效率较高，且节约了一定的网络资源。在一些特殊的场景中非常有用，例如 k8s 的 Pod。</p>\n<blockquote>\n<ul>\n<li>当需要多个容器在同一台宿主机上进行通信时，使用 bridge</li>\n<li>当网络栈不应该与宿主机隔离，但是希望容器的其他方面被隔离时，使用 host</li>\n<li>当需要在不同宿主机上运行的容器进行通信时，使用 overlay</li>\n<li>当从虚拟机迁移或需要使容器看起来像物理宿主机时，使用 Macvlan, 每个容器都有一个唯一的 MAC 地址</li>\n<li>当需要将 Docker 与专门的网络栈集成，使用 Third-party</li>\n</ul>\n</blockquote>\n<h2 id=\"前置知识iptables自定义链\"><a class=\"markdownIt-Anchor\" href=\"#前置知识iptables自定义链\">#</a> 前置知识：iptables 自定义链</h2>\n<p>当默认链中的规则非常多时，不方便我们管理。</p>\n<p>想象一下，如果 INPUT 链中存放了 200 条规则，这 200 条规则有针对 httpd 服务的，有针对 sshd 服务的，有针对私网 IP 的，有针对公网 IP 的，假如，我们突然想要修改针对 httpd 服务的相关规则，难道我们还要从头看一遍这 200 条规则，找出哪些规则是针对 httpd 的吗？这显然不合理。</p>\n<p>iptables 中，可以自定义链，通过自定义链即可解决上述问题。</p>\n<p>假设，我们自定义一条链，链名叫 IN_WEB，我们可以将所有针对 80 端口的入站规则都写入到这条自定义链中，当以后想要修改针对 web 服务的入站规则时，就直接修改 IN_WEB 链中的规则就好了</p>\n<p><strong>自定义链并不能直接使用，而是需要被默认链引用才能够使用</strong></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -t filter -N IN_WEB</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -t filter -nvL --line-number </span></span><br><span class=\"line\">Chain IN_WEB (0 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination     </span><br><span class=\"line\"><span class=\"comment\"># 这条自定义链的引用计数为0 (0 references)，也就是说，这条自定义链还没有被任何默认链所引用，所以，即使IN_WEB中配置了规则，也不会生效</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 加一些规则 ~</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables  -t filter -I IN_WEB  -s 10.1.1.2 -j REJECT </span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -A IN_WEB -o eth0 -p tcp --dport 22 -m state --state ESTABLISH -j ACCEPT</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 在默认链引用自定义链</span></span><br><span class=\"line\"><span class=\"comment\"># 自定义链在哪里创建，应该被哪条默认链引用，取决于实际的工作场景，因为此处示例的规则是匹配入站报文，所以在INPUT链中引用自定义链。</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -I INPUT -p tcp --dport 80 -j IN_WEB </span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -t filter -nvL --line-number</span></span><br><span class=\"line\">Chain INPUT (policy ACCEPT 27 packets, 1664 bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 IN_WEB     tcp  --  *      *       0.0.0.0/0            0.0.0.0/0            tcp dpt:80</span><br><span class=\"line\"></span><br><span class=\"line\">Chain IN_WEB (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 REJECT     all  --  *      *       10.1.1.2             0.0.0.0/0            reject-with icmp-port-unreachable</span><br><span class=\"line\">2        0     0 ACCEPT     tcp  --  *      eth0    0.0.0.0/0            0.0.0.0/0            tcp dpt:22 state ESTABLISHED</span><br><span class=\"line\"><span class=\"comment\"># 在INPUT链中添加了一条规则，访问本机80端口的tcp报文将会被这条规则匹配到</span></span><br><span class=\"line\"><span class=\"comment\"># -j 不仅能指定动作，还能指定自定义链</span></span><br><span class=\"line\"><span class=\"comment\"># 当&quot;-j&quot;对应的值为一个自定义链时，就表示被当前规则匹配到的报文将交由对应的自定义链处理</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 重命名自定义链</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -E IN_WEB WEB </span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 使用&quot;-X&quot;选项可以删除自定义链，但是删除自定义链时，需要满足两个条件：</span></span><br><span class=\"line\"><span class=\"comment\"># 1、自定义链没有被任何默认链引用，即自定义链的引用计数为0。</span></span><br><span class=\"line\"><span class=\"comment\"># 2、自定义链中没有任何规则，即自定义链为空。</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -X WEB </span></span><br><span class=\"line\">iptables: Too many links.</span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -D INPUT 1 </span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -X WEB </span></span><br><span class=\"line\">iptables: Directory not empty.</span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -t filter -F WEB</span></span><br><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -X WEB </span></span><br></pre></td></tr></table></figure>\n<h2 id=\"docker-中-iptables\"><a class=\"markdownIt-Anchor\" href=\"#docker-中-iptables\">#</a> docker 中 iptables</h2>\n<p>虚拟网桥 docker0 通过 iptables 配置与宿主机器上的网卡相连，符合条件的请求都会通过 iptables 转发到 docker0, 然后分发给对应的容器。</p>\n<p>在 2015.12 之前，Docker 只额外提供了 DOCKER 链。</p>\n<p>在此之后，直到 Docker 17.06.0（2017.6）之前的版本中，Docker 提供了如下 2 个链:</p>\n<p>DOCKER<br>\nDOCKER-ISOLATION</p>\n<p>在 Docker 17.06.0（2017.6）及之后，Docker 18.03.1（2018.4）及之前的版本中，Docker 提供了如下 3 个链:</p>\n<p>DOCKER<br>\nDOCKER-ISOLATION<br>\nDOCKER-USER</p>\n<p>在 Docker 18.05.0（2018.5）及之后的版本中，提供如下 4 个 chain:</p>\n<ul>\n<li>DOCKER</li>\n<li><strong>DOCKER-ISOLATION-STAGE-1</strong></li>\n<li><strong>DOCKER-ISOLATION-STAGE-2</strong></li>\n<li>DOCKER-USER</li>\n</ul>\n<blockquote>\n<p><strong>Docker 的 DOCKER 链</strong></p>\n<p>仅处理从宿主机到 docker0 的 IP 数据包，即容器对外的规则</p>\n<p><strong>Docker 的 DOCKER-ISOLATION 链</strong></p>\n<p>为了隔离在不同的 bridge 网络之间的容器，Docker 提供了两个 DOCKER-ISOLATION 阶段实现。</p>\n<p>DOCKER-ISOLATION-STAGE-1 链<strong>过滤源地址是 bridge 网络（默认 docker0）的 IP 数据包，目的地不是 docker0</strong>，匹配的 IP 数据包再进入 DOCKER-ISOLATION-STAGE-2 链处理，不匹配就返回到父链 FORWARD。</p>\n<p>在 DOCKER-ISOLATION-STAGE-2 链中，进一步处理<strong>目的地址是 bridge 网络的 IP 数据包</strong>，匹配的 IP 数据包表示该 IP 数据包是从一个 bridge 网络的网桥发出，到另一个 bridge 网络的网桥，这样的 IP 数据包来自其他 bridge 网络，将被直接 DROP；不匹配的 IP 数据包就返回到父链 FORWARD 继续进行后续处理。</p>\n<p>即不允许不同的网卡互相访问，这对于 docker-compose 非常有用 <code>iptables -A DOCKER-ISOLATION-STAGE-2 -o br-afba712bfb32 -j DROP</code></p>\n<p><strong>Docker 的 DOCKER-USER 链</strong></p>\n<p>Docker 启动时，会加载 DOCKER 链和 DOCKER-ISOLATION（现在是 DOCKER-ISOLATION-STAGE-1）链中的过滤规则，并使之生效。绝对禁止修改这里的过滤规则。</p>\n<p>如果用户要补充 Docker 的过滤规则，强烈建议追加到 DOCKER-USER 链。<strong>DOCKER-USER 链中的过滤规则，将先于 Docker 默认创建的规则被加载，从而能够覆盖 Docker 在 DOCKER 链和 DOCKER-ISOLATION 链中的默认过滤规则。</strong></p>\n<p>例如，Docker 启动后，默认任何外部 source IP 都被允许转发，从而能够从该 source IP 连接到宿主机上的任何 Docker 容器实例。如果只允许一个指定的 IP 访问容器实例，可以插入路由规则到 DOCKER-USER 链中，从而能够在 DOCKER 链之前被加载。示例如下：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -A DOCKER-USER -i docker0 ! -s 192.168.1.1 -j DROP</span><br><span class=\"line\">iptables -A DOCKER-USER -i docker0 ! -s 192.168.1.0/24 -j DROP</span><br><span class=\"line\">iptables -A DOCKER-USER -m iprange -i docker0 ! --src-range 192.168.1.1-192.168.1.3 -j DROP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Docker 在 iptables 的 nat 表中的规则</strong></p>\n<p>为了能够从容器中访问其他 Docker 宿主机，Docker 需要在 iptables 的 nat 表中的<strong> POSTROUTING</strong> 链中插入转发规则。</p>\n<p>即 container 使用宿主机 docker0 的 IP 作为网关，便于接收外部返回的数据，示例如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iptables -t nat -A POSTROUTING -s 172.18.0.0/16 -j MASQUERADE</span><br></pre></td></tr></table></figure>\n<p>宿主机通过 nat 表的 OUTPUT 链是可以访问 container 的</p>\n<p>nat 表的 POSTROUTING 规则使得 container 可以访问外网</p>\n<p><strong>Docker 中禁止修改 iptables 过滤表</strong></p>\n<blockquote>\n<p>dockerd 启动时，参数–iptables 默认为 true，表示允许修改 iptables 过滤表。</p>\n<p>要禁用该功能，可以有两个选择：</p>\n<p>设置启动参数–iptables=false</p>\n<p>修改配置文件 /etc/docker/daemon.json，设置 &quot;iptables&quot;: “false”；然后执行 systemctl reload docker 重新加载</p>\n</blockquote>\n<blockquote>\n<p>docker 操作规则提供网络隔离，不应该修改 Docker 插入到策略中的规则。</p>\n<p>如果您正在一个暴露于 Internet 的主机上运行 Docker，那么您可能需要使用 iptables 策略来防止未经授权地访问在您的主机上运行的容器或其他服务。</p>\n<p>在 docker 的规则之后添加 iptables 规则：</p>\n<p>Docker 安装了两个名为 `DOCKER-USER``DOCKER 自定义 iptables 链，并确保传入的数据包总是首先由这两个链检查。</p>\n<p>Docker 的所有规则都添加到 DOCKER 链中。不要手动操作此链。如果需要添加在 Docker 规则之前加载的规则，请将它们添加到链中。在 Docker 自动创建任何规则之前应用这些规则。</p>\n<p><strong>为容器设置默认绑定地址</strong></p>\n<p>默认情况下，Docker 守护进程将公开 0.0.0.0 地址上的端口，即主机上的任何地址。如果希望将该行为更改为仅公开内部 IP 地址上的端口，则可以使用 --ip  选项指定不同的 IP 地址。</p>\n</blockquote>\n</blockquote>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -nvL --line-number -t filter</span></span><br><span class=\"line\">Chain INPUT (policy ACCEPT 325K packets, 57M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain FORWARD (policy ACCEPT 0 packets, 0 bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1    11650 1109K DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2    11650 1109K DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3     2853  225K ACCEPT     all  --  *      br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">4      613 35444 DOCKER     all  --  *      br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">5     2820  319K ACCEPT     all  --  br-73c5128a4cfc !br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6        0     0 ACCEPT     all  --  br-73c5128a4cfc br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">7     3075  327K ACCEPT     all  --  *      br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">8      767 41232 DOCKER     all  --  *      br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">9     3184  336K ACCEPT     all  --  br-5ed45bf78d6f !br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">10       0     0 ACCEPT     all  --  br-5ed45bf78d6f br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">11   12131   17M ACCEPT     all  --  *      br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">12     104  5928 DOCKER     all  --  *      br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">13    5982 1555K ACCEPT     all  --  br-a1c8315f1897 !br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">14      46  2760 ACCEPT     all  --  br-a1c8315f1897 br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">15       0     0 ACCEPT     all  --  *      br-362bcfa74398  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">16       0     0 DOCKER     all  --  *      br-362bcfa74398  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">17       0     0 ACCEPT     all  --  br-362bcfa74398 !br-362bcfa74398  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">18       0     0 ACCEPT     all  --  br-362bcfa74398 br-362bcfa74398  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">19   28865   53M ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">20       0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">21   27196 1524K ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">22       0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">23    101K  118M ACCEPT     all  --  *      br-7e6516f6eadc  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">24     583 35272 DOCKER     all  --  *      br-7e6516f6eadc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">25       1    44 ACCEPT     all  --  br-7e6516f6eadc !br-7e6516f6eadc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">26     582 35232 ACCEPT     all  --  br-7e6516f6eadc br-7e6516f6eadc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">27      54  4536 ACCEPT     all  --  *      br-82c4a8b68c66  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">28       2   168 DOCKER     all  --  *      br-82c4a8b68c66  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">29       0     0 ACCEPT     all  --  br-82c4a8b68c66 !br-82c4a8b68c66  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">30       2   168 ACCEPT     all  --  br-82c4a8b68c66 br-82c4a8b68c66  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">31       0     0 ACCEPT     all  --  *      br-57ffa6ffd57d  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">32       0     0 DOCKER     all  --  *      br-57ffa6ffd57d  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">33       0     0 ACCEPT     all  --  br-57ffa6ffd57d !br-57ffa6ffd57d  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">34       0     0 ACCEPT     all  --  br-57ffa6ffd57d br-57ffa6ffd57d  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT 223K packets, 22M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER (8 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1      767 41232 ACCEPT     tcp  --  !br-5ed45bf78d6f br-5ed45bf78d6f  0.0.0.0/0            172.21.0.3           tcp dpt:8080</span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1     2820  319K DOCKER-ISOLATION-STAGE-2  all  --  br-73c5128a4cfc !br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2     3184  336K DOCKER-ISOLATION-STAGE-2  all  --  br-5ed45bf78d6f !br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3     5982 1555K DOCKER-ISOLATION-STAGE-2  all  --  br-a1c8315f1897 !br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">4        0     0 DOCKER-ISOLATION-STAGE-2  all  --  br-362bcfa74398 !br-362bcfa74398  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">5    27196 1524K DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6    87590   74M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-2 (5 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 DROP       all  --  *      br-73c5128a4cfc  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 DROP       all  --  *      br-5ed45bf78d6f  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3        0     0 DROP       all  --  *      br-a1c8315f1897  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">4        0     0 DROP       all  --  *      br-362bcfa74398  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">5        0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6    39182 3735K RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-USER (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1     248K  299M RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]<span class=\"comment\"># iptables -nvL --line-number -t nat</span></span><br><span class=\"line\">Chain PREROUTING (policy ACCEPT 147K packets, 27M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1     311K   37M DOCKER     all  --  *      *       0.0.0.0/0            0.0.0.0/0            ADDRTYPE match dst-type LOCAL</span><br><span class=\"line\"></span><br><span class=\"line\">Chain INPUT (policy ACCEPT 147K packets, 27M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT 16537 packets, 1079K bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 DOCKER     all  --  *      *       0.0.0.0/0           !127.0.0.0/8          ADDRTYPE match dst-type LOCAL</span><br><span class=\"line\"></span><br><span class=\"line\">Chain POSTROUTING (policy ACCEPT 17105 packets, 1109K bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 MASQUERADE  all  --  *      !br-73c5128a4cfc  172.22.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">2        0     0 MASQUERADE  all  --  *      !br-5ed45bf78d6f  172.21.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">3       73  4572 MASQUERADE  all  --  *      !br-a1c8315f1897  172.20.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">4        0     0 MASQUERADE  all  --  *      !br-362bcfa74398  172.19.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">5       18  1120 MASQUERADE  all  --  *      !docker0  172.17.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">6        0     0 MASQUERADE  all  --  *      !br-7e6516f6eadc  172.38.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">7        0     0 MASQUERADE  all  --  *      !br-82c4a8b68c66  10.1.0.0/16          0.0.0.0/0           </span><br><span class=\"line\">8        0     0 MASQUERADE  all  --  *      !br-57ffa6ffd57d  172.18.0.0/16        0.0.0.0/0           </span><br><span class=\"line\">9        0     0 MASQUERADE  tcp  --  *      *       172.21.0.3           172.21.0.3           tcp dpt:8080</span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt <span class=\"keyword\">in</span>     out     <span class=\"built_in\">source</span>               destination         </span><br><span class=\"line\">1        0     0 RETURN     all  --  br-73c5128a4cfc *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 RETURN     all  --  br-5ed45bf78d6f *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">3        0     0 RETURN     all  --  br-a1c8315f1897 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">4        0     0 RETURN     all  --  br-362bcfa74398 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">5        0     0 RETURN     all  --  docker0 *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6      743 39312 DNAT       tcp  --  !br-5ed45bf78d6f *       0.0.0.0/0            0.0.0.0/0            tcp dpt:8080 to:172.21.0.3:8080</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@hecs-346515 ~]# docker network ls </span><br><span class=\"line\">NETWORK ID     NAME                   DRIVER    SCOPE</span><br><span class=\"line\">5ed45bf78d6f   app_default            bridge    local</span><br><span class=\"line\">20518cecd94f   bridge                 bridge    local</span><br><span class=\"line\">73c5128a4cfc   com-nginx_default      bridge    local</span><br><span class=\"line\">362bcfa74398   composetest_default    bridge    local</span><br><span class=\"line\">a919986fdc8c   host                   host      local</span><br><span class=\"line\">a1c8315f1897   my_wordpress_default   bridge    local</span><br><span class=\"line\">a0d53da9cf10   none                   null      local</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20201031165431445.png\" alt=\"在这里插入图片描述\"></p>\n<h2 id=\"kubernetes-下的-iptables\"><a class=\"markdownIt-Anchor\" href=\"#kubernetes-下的-iptables\">#</a> Kubernetes 下的 iptables</h2>\n<p>下面是一个 kubernetes 环境下的的 iptables</p>\n<figure class=\"highlight shell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@master ~]# iptables -nvL --line-number</span><br><span class=\"line\">Chain INPUT (policy ACCEPT 359K packets, 87M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1      51M   12G cali-INPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Cz_u1IQiXIMmKD4c */</span><br><span class=\"line\">2     560K   33M KUBE-EXTERNAL-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes externally-visible service portals */</span><br><span class=\"line\">3      51M   12G KUBE-FIREWALL  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain FORWARD (policy DROP 0 packets, 0 bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1      958  159K cali-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:wUHhoiAYhphO9Mso */</span><br><span class=\"line\">2      872  144K KUBE-FORWARD  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */</span><br><span class=\"line\">3       94  7636 KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */</span><br><span class=\"line\">4       94  7636 KUBE-EXTERNAL-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes externally-visible service portals */</span><br><span class=\"line\">5       94  7636 DOCKER-USER  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">6       94  7636 DOCKER-ISOLATION-STAGE-1  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">7        0     0 ACCEPT     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0            ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">8        0     0 DOCKER     all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">9        0     0 ACCEPT     all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">10       0     0 ACCEPT     all  --  docker0 docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">11      88  7259 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:S93hcgKJrXEqnTfs */ /* Policy explicitly accepted packet. */ mark match 0x10000/0x10000</span><br><span class=\"line\">12       4   208 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:mp77cMpurHhyjLrM */ MARK or 0x10000</span><br><span class=\"line\"></span><br><span class=\"line\">Chain OUTPUT (policy ACCEPT 366K packets, 94M bytes)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1      51M   12G cali-OUTPUT  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:tVnHkvAo15HuiPy0 */</span><br><span class=\"line\">2     757K   46M KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate NEW /* kubernetes service portals */</span><br><span class=\"line\">3      52M   13G KUBE-FIREWALL  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-1 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DOCKER-ISOLATION-STAGE-2  all  --  docker0 !docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2       94  7636 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-ISOLATION-STAGE-2 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DROP       all  --  *      docker0  0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\">2        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain DOCKER-USER (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1       94  7636 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0           </span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-EXTERNAL-SERVICES (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-FIREWALL (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes firewall for dropping marked packets */ mark match 0x8000/0x8000</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *      !127.0.0.0/8          127.0.0.0/8          /* block incoming localnet connections */ ! ctstate RELATED,ESTABLISHED,DNAT</span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-FORWARD (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            ctstate INVALID</span><br><span class=\"line\">2        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding rules */ mark match 0x4000/0x4000</span><br><span class=\"line\">3        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding conntrack pod source rule */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">4        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes forwarding conntrack pod destination rule */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-KUBELET-CANARY (0 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-PROXY-CANARY (0 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain KUBE-SERVICES (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 REJECT     tcp  --  *      *       0.0.0.0/0            10.96.222.97         /* calico-system/calico-typha:calico-typha has no endpoints */ tcp dpt:5473 reject-with icmp-port-unreachable</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-FORWARD (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1      958  159K MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:vjrMJCRpqwy5oRoX */ MARK and 0xfff1ffff</span><br><span class=\"line\">2      958  159K cali-from-hep-forward  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:A_sPAO0mcxbT9mOV */ mark match 0x0/0x10000</span><br><span class=\"line\">3       88 14441 cali-from-wl-dispatch  all  --  cali+  *       0.0.0.0/0            0.0.0.0/0            /* cali:8ZoYfO5HKXWbB3pk */</span><br><span class=\"line\">4       88  8399 cali-to-wl-dispatch  all  --  *      cali+   0.0.0.0/0            0.0.0.0/0            /* cali:jdEuaPBe14V2hutn */</span><br><span class=\"line\">5      870  144K cali-to-hep-forward  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:12bc6HljsMKsmfr- */</span><br><span class=\"line\">6      870  144K cali-cidr-block  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:NOSxoaGx8OIstr1z */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-INPUT (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1    12426 1790K ACCEPT     4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:PajejrV4aFdkZojI */ /* Allow IPIP packets from Calico hosts */ match-set cali40all-hosts-net src ADDRTYPE match dst-type LOCAL</span><br><span class=\"line\">2        0     0 DROP       4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:_wjq-Yrma8Ly1Svo */ /* Drop IPIP packets from non-Calico hosts */</span><br><span class=\"line\">3     849K   67M cali-wl-to-host  all  --  cali+  *       0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:8TZGxLWh_Eiz66wc */</span><br><span class=\"line\">4        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:6McIeIDvPdL6PE1T */ mark match 0x10000/0x10000</span><br><span class=\"line\">5      50M   11G MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:YGPbrUms7NId8xVa */ MARK and 0xfff0ffff</span><br><span class=\"line\">6      50M   11G cali-from-host-endpoint  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:2gmY7Bg2i0i84Wk_ */</span><br><span class=\"line\">7        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:q-Vz2ZT9iGE331LL */ /* Host endpoint policy accepted packet. */ mark match 0x10000/0x10000</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-OUTPUT (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Mq1_rAdXXH3YkrzW */ mark match 0x10000/0x10000</span><br><span class=\"line\">2     921K  240M RETURN     all  --  *      cali+   0.0.0.0/0            0.0.0.0/0            /* cali:69FkRTJDvD5Vu6Vl */</span><br><span class=\"line\">3    18389 3309K ACCEPT     4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AnEsmO6bDZbQntWW */ /* Allow IPIP packets to other Calico hosts */ match-set cali40all-hosts-net dst ADDRTYPE match src-type LOCAL</span><br><span class=\"line\">4      51M   12G MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:9e9Uf3GU5tX--Lxy */ MARK and 0xfff0ffff</span><br><span class=\"line\">5      47M 9955M cali-to-host-endpoint  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:0f3LDz_VKuHFaA2K */ ! ctstate DNAT</span><br><span class=\"line\">6        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:OgU2f8BVEAZ_fwkq */ /* Host endpoint policy accepted packet. */ mark match 0x10000/0x10000</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-cidr-block (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-from-hep-forward (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-from-host-endpoint (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-from-wl-dispatch (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1     321K   26M cali-fw-cali05bb5db3fa1  all  --  cali05bb5db3fa1 *       0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:drclJCIYHvwqq0Mm */</span><br><span class=\"line\">2     205K   15M cali-fw-cali208cae40f88  all  --  cali208cae40f88 *       0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:uukYuZsgOoCA5nGJ */</span><br><span class=\"line\">3     323K   26M cali-fw-cali7d622662493  all  --  cali7d622662493 *       0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:K5Mazerr4lRVD4rp */</span><br><span class=\"line\">4        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:iUPvKwE5IWuKpzAe */ /* Unknown interface */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-fw-cali05bb5db3fa1 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1     321K   26M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:E4mTrvGzdHfkb0gw */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:GvNaVMp0EOqXg4jE */ ctstate INVALID</span><br><span class=\"line\">3        2   130 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Zq-sKj9IRy4h8bZK */ MARK and 0xfffeffff</span><br><span class=\"line\">4        0     0 DROP       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:m22wu6b8QLcgIpE2 */ /* Drop VXLAN encapped packets originating in workloads */ multiport dports 4789</span><br><span class=\"line\">5        0     0 DROP       4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Fn9-T5rmzbblpHqk */ /* Drop IPinIP encapped packets originating in workloads */</span><br><span class=\"line\">6        2   130 cali-pro-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:l93qGyeNDdQl1ovZ */</span><br><span class=\"line\">7        2   130 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:-KzIO8-y_7ScQcqV */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 cali-pro-_u2Tn2rSoAPffvE7JO6  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:gjCVYZOwobWWrHJG */</span><br><span class=\"line\">9        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:mezFpLQtONhtQm3e */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">10       0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:rZ0tJ5sH1U2e4IZB */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-fw-cali208cae40f88 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1     205K   15M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:WqBOLrWawuZa0ygc */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AIUklCffi-Sif7fW */ ctstate INVALID</span><br><span class=\"line\">3        1    60 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:ZOPa3nn_tPtYNqZC */ MARK and 0xfffeffff</span><br><span class=\"line\">4        0     0 DROP       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:aGrGdu_8brjnTmRz */ /* Drop VXLAN encapped packets originating in workloads */ multiport dports 4789</span><br><span class=\"line\">5        0     0 DROP       4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:3TmhI0RrkxSSgmuV */ /* Drop IPinIP encapped packets originating in workloads */</span><br><span class=\"line\">6        1    60 cali-pro-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:lQflhvIvgTn9FAaI */</span><br><span class=\"line\">7        1    60 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:M5Vx8_abSocWEG1c */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 cali-pro-_PTRGc0U-L5Kz7V6ERW  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:tyI8xt3vGjcB3Kjs */</span><br><span class=\"line\">9        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Z44UO7vsJzVbUBgt */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">10       0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:TvjwAx7Sr3LHkcwA */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-fw-cali7d622662493 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1     323K   26M ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:us52QYtYtC7N1SMN */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:g9qDPkBjlFGzXBJP */ ctstate INVALID</span><br><span class=\"line\">3        2   129 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Q1KQ-NUBmwy-uult */ MARK and 0xfffeffff</span><br><span class=\"line\">4        0     0 DROP       udp  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AcStyauPzs11wg1K */ /* Drop VXLAN encapped packets originating in workloads */ multiport dports 4789</span><br><span class=\"line\">5        0     0 DROP       4    --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:jMHkEhR2halKFa0U */ /* Drop IPinIP encapped packets originating in workloads */</span><br><span class=\"line\">6        2   129 cali-pro-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:ln0oOSOnBZ8O0fmk */</span><br><span class=\"line\">7        2   129 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:1UKtb2XuD2JKMwDc */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 cali-pro-_u2Tn2rSoAPffvE7JO6  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:vP-U6Q5QbEW7NwFn */</span><br><span class=\"line\">9        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:cTSMCGZCszuaaJM6 */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">10       0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:gbPWoGXpey14BaFh */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pri-_PTRGc0U-L5Kz7V6ERW (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0            all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:g4z4yZxg6IEqYbOs */ /* Profile ksa.kube-system.calico-kube-controllers ingress */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pri-_u2Tn2rSoAPffvE7JO6 (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0            all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:WqgznqAQ-uYV0oBx */ /* Profile ksa.kube-system.coredns ingress */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pri-kns.kube-system (3 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1       84  7000 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:J1TyxtHWd0qaBGK- */ /* Profile kns.kube-system ingress */ MARK or 0x10000</span><br><span class=\"line\">2       84  7000 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:QIB6k7eEKdIg73Jp */ mark match 0x10000/0x10000</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pro-_PTRGc0U-L5Kz7V6ERW (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0            all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:DR9-t6YJRvFY-IdZ */ /* Profile ksa.kube-system.calico-kube-controllers egress */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pro-_u2Tn2rSoAPffvE7JO6 (2 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0            all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:0-_UPh39dt5XfhmJ */ /* Profile ksa.kube-system.coredns egress */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-pro-kns.kube-system (3 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        5   319 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:tgOR2S8DVHZW3F1M */ /* Profile kns.kube-system egress */ MARK or 0x10000</span><br><span class=\"line\">2        5   319 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:HVEEtYPJsiGRXCIt */ mark match 0x10000/0x10000</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-to-hep-forward (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-to-host-endpoint (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-to-wl-dispatch (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1       44  4176 cali-tw-cali05bb5db3fa1  all  --  *      cali05bb5db3fa1  0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:rVvWjln0-aNZqGu1 */</span><br><span class=\"line\">2        0     0 cali-tw-cali208cae40f88  all  --  *      cali208cae40f88  0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:p8fbXz8vMuxeVVTv */</span><br><span class=\"line\">3       44  4223 cali-tw-cali7d622662493  all  --  *      cali7d622662493  0.0.0.0/0            0.0.0.0/0           [goto]  /* cali:kGrRbUzhGNW6ln3t */</span><br><span class=\"line\">4        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AHbFMIPhEd7ZcZkX */ /* Unknown interface */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-tw-cali05bb5db3fa1 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        2   700 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Fj-eeXYVm_kIr8vU */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:d5SBG6rCITaOF4St */ ctstate INVALID</span><br><span class=\"line\">3       42  3476 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:RReaszN8AogolmpY */ MARK and 0xfffeffff</span><br><span class=\"line\">4       42  3476 cali-pri-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:pgSBVO45ShvkouPQ */</span><br><span class=\"line\">5       42  3476 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:NkoEve7iZeMjsHIy */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">6        0     0 cali-pri-_u2Tn2rSoAPffvE7JO6  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5dxw9MmbjYI5SyRn */</span><br><span class=\"line\">7        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:IRcVovIp8z3A96xi */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:p9m_VwxIvb-JstJn */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-tw-cali208cae40f88 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        0     0 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AdAnp29s6CQv5P_T */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:AwEonPAYrn5cBia9 */ ctstate INVALID</span><br><span class=\"line\">3        0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:kG17I4eM32XgKdfJ */ MARK and 0xfffeffff</span><br><span class=\"line\">4        0     0 cali-pri-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:q47knqHr9cXccotN */</span><br><span class=\"line\">5        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:cqmaerq28uKXR3gb */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">6        0     0 cali-pri-_PTRGc0U-L5Kz7V6ERW  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:yxkxnLNzJaqlF6iI */</span><br><span class=\"line\">7        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:tXwmznGE4A22gX86 */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:-YnOFudvLJQa-bvg */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-tw-cali7d622662493 (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1        2   699 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:5Rxcw-wNzA85Rhyi */ ctstate RELATED,ESTABLISHED</span><br><span class=\"line\">2        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:asunPDo0iNAgKSE1 */ ctstate INVALID</span><br><span class=\"line\">3       42  3524 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Pw9F6mU7G6ZWeNwP */ MARK and 0xfffeffff</span><br><span class=\"line\">4       42  3524 cali-pri-kns.kube-system  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:PpVJDNoONiGYUcRA */</span><br><span class=\"line\">5       42  3524 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:E5wJkjsA6VordSfX */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">6        0     0 cali-pri-_u2Tn2rSoAPffvE7JO6  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:QA2da1VY0eIFyRTB */</span><br><span class=\"line\">7        0     0 RETURN     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Pvklmif-0dfJa6Ew */ /* Return if profile accepted */ mark match 0x10000/0x10000</span><br><span class=\"line\">8        0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:fhsKGqOcZmhVBy6P */ /* Drop if no profiles matched */</span><br><span class=\"line\"></span><br><span class=\"line\">Chain cali-wl-to-host (1 references)</span><br><span class=\"line\">num   pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">1     849K   67M cali-from-wl-dispatch  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:Ee9Sbo10IpVujdIY */</span><br><span class=\"line\">2        1    60 ACCEPT     all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* cali:nSZbcOoG1xPONxb8 */ /* Configured DefaultEndpointToHostAction */</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">KUBE-EXTERNAL-SERVICES</span><br><span class=\"line\">KUBE-FIREWALL</span><br><span class=\"line\">KUBE-FORWARD</span><br><span class=\"line\">KUBE-KUBELET-CANARY</span><br><span class=\"line\">KUBE-PROXY-CANARY</span><br><span class=\"line\">KUBE-SERVICES</span><br><span class=\"line\"></span><br><span class=\"line\">KUBE-KUBELET-CANARY</span><br><span class=\"line\">KUBE-MARK-DROP</span><br><span class=\"line\">KUBE-MARK-MASQ</span><br><span class=\"line\">KUBE-NODEPORTS</span><br><span class=\"line\">KUBE-POSTROUTING</span><br><span class=\"line\">KUBE-PROXY-CANARY</span><br><span class=\"line\">KUBE-SERVICES</span><br></pre></td></tr></table></figure>\n<p>kube-proxy 只修改了 filter 和 nat 表，它对 iptables 的链进行了扩充，自定义了 KUBE-SERVICES，KUBE-NODEPORTS，KUBE-POSTROUTING，KUBE-MARK-MASQ 和 KUBE-MARK-DROP 五个链，并主要通过为 KUBE-SERVICES 链（附着在 PREROUTING 和 OUTPUT）增加 rule 来配制 traffic routing 规则，官方定义如下：</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">// the services chain</span><br><span class=\"line\">kubeServicesChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-SERVICES&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// the external services chain</span><br><span class=\"line\">kubeExternalServicesChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-EXTERNAL-SERVICES&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// the nodeports chain</span><br><span class=\"line\">kubeNodePortsChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-NODEPORTS&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// the kubernetes postrouting chain</span><br><span class=\"line\">kubePostroutingChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-POSTROUTING&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">// the mark-for-masquerade chain</span><br><span class=\"line\">KubeMarkMasqChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-MARK-MASQ&quot;</span>    /*对于未能匹配到跳转规则的traffic <span class=\"built_in\">set</span> mark 0x8000，有此标记的数据包会在filter表drop掉*/</span><br><span class=\"line\"></span><br><span class=\"line\">// the mark-for-drop chain</span><br><span class=\"line\">KubeMarkDropChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-MARK-DROP&quot;</span>    /*对于符合条件的包 <span class=\"built_in\">set</span> mark 0x4000, 有此标记的数据包会在KUBE-POSTROUTING chain中统一做MASQUERADE*/</span><br><span class=\"line\"></span><br><span class=\"line\">// the kubernetes forward chain</span><br><span class=\"line\">kubeForwardChain utiliptables.Chain = <span class=\"string\">&quot;KUBE-FORWARD&quot;</span></span><br></pre></td></tr></table></figure>\n<p>KUBE-MARK-MASQ 和 KUBE-MARK-DROP  这两个规则主要用来对经过的报文打标签，打上标签的报文可能会做相应处理</p>\n<blockquote>\n<p>-A KUBE-MARK-DROP -j MARK --set-xmark 0x8000/0x8000</p>\n<p>-A KUBE-MARK-MASQ -j MARK --set-xmark 0x4000/0x4000</p>\n</blockquote>\n<p>KUBE-MARK-DROP 和 KUBE-MARK-MASQ 本质上就是使用了 iptables 的 MARK 命令</p>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Chain KUBE-MARK-DROP (6 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">    0     0 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x8000</span><br><span class=\"line\">Chain KUBE-MARK-MASQ (89 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination</span><br><span class=\"line\">   88  5280 MARK       all  --  *      *       0.0.0.0/0            0.0.0.0/0            MARK or 0x4000</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p>对于 KUBE-MARK-MASQ 链中所有规则设置了 kubernetes 独有 MARK 标记，在 KUBE-POSTROUTING 链中对 NODE 节点上匹配 kubernetes 独有 MARK 标记的数据包，当报文离开 node 节点时进行 SNAT，MASQUERADE 源 IP</p>\n<blockquote>\n<p>-A KUBE-POSTROUTING -m comment --comment “kubernetes service traffic requiring SNAT” -m mark --mark 0x4000/0x4000 -j MASQUERADE</p>\n</blockquote>\n<p>而对于 KUBE-MARK-DROP 设置标记的报文则会在 KUBE_FIREWALL 中全部丢弃</p>\n<blockquote>\n<p>-A KUBE-FIREWALL -m comment --comment “kubernetes firewall for dropping marked packets” -m mark --mark 0x8000/0x8000 -j DROP</p>\n</blockquote>\n<p><strong>KUBE_SVC 和 KUBE-SEP</strong></p>\n<p>Kube-proxy 接着对每个服务创建 “KUBE-SVC-” 链，并在 nat 表中将 KUBE-SERVICES 链中每个目标地址是 service 的数据包导入这个 “KUBE-SVC-” 链，如果 endpoint 尚未创建，KUBE-SVC - 链中没有规则，任何 incomming packets 在规则匹配失败后会被 KUBE-MARK-DROP。在 iptables 的 filter 中有如下处理，如果 KUBE-SVC 处理失败会通过 KUBE_FIREWALL 丢弃</p>\n<blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Chain INPUT (policy ACCEPT 209 packets, 378K bytes)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\"> 540K 1370M KUBE-SERVICES  all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes service portals */</span><br><span class=\"line\"> 540K 1370M KUBE-FIREWALL  all  --  *      *       0.0.0.0/0            0.0.0.0/0  </span><br><span class=\"line\"> </span><br><span class=\"line\"> Chain KUBE-FIREWALL (2 references)</span><br><span class=\"line\"> pkts bytes target     prot opt in     out     source               destination         </span><br><span class=\"line\">    0     0 DROP       all  --  *      *       0.0.0.0/0            0.0.0.0/0            /* kubernetes firewall for dropping marked packets */ mark match 0x8000/0x8000</span><br></pre></td></tr></table></figure>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2Rhb2Nhb2thZmVpL2FydGljbGUvZGV0YWlscy8xMTUwOTEzMTM=\">Linux iptables 命令详解_一口 Linux 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjMyNzc2\">iptables 系列教程（一）| iptables 入门篇 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjMyNzc0P2Zyb209YXJ0aWNsZS5kZXRhaWwuMTYzMjc3NiZhbXA7YXJlYVNvdXJjZT0xMDYwMDAuMiZhbXA7dHJhY2VJZD0wNnFpVmUyeHNfRGdXQk5lWXNDX2U=\">iptables 系列教程（二）| iptables 语法规则 - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY2FuZ3FpbmdsYW5nL3AvMTU0Mzg0NjEuaHRtbA==\">Linux 下 iptables 超详细教程和使用示例 - 苍青浪 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW51eC5kaWUubmV0L21hbi84L2lwdGFibGVz\">iptables（8） - Linux 手册页 (die.net)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLmRvY2tlci5jb20vbmV0d29yay9pcHRhYmxlcy8=\">Docker and iptables</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5OTQ2OTE2L2FydGljbGUvZGV0YWlscy8xMDkyNzczMjU/c3BtPTEwMDEuMjEwMS4zMDAxLjY2NTAuMSZhbXA7dXRtX21lZGl1bT1kaXN0cmlidXRlLnBjX3JlbGV2YW50Lm5vbmUtdGFzay1ibG9nLTJ+ZGVmYXVsdH5DVFJMSVNUflJhdGUtMS0xMDkyNzczMjUtYmxvZy04ODg0NDU1OC4yMzUlNUV2MjglNUVwY19yZWxldmFudF9kZWZhdWx0JmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTA5Mjc3MzI1LWJsb2ctODg4NDQ1NTguMjM1JTVFdjI4JTVFcGNfcmVsZXZhbnRfZGVmYXVsdCZhbXA7dXRtX3JlbGV2YW50X2luZGV4PTI=\">(63 条消息) iptables 详解及 docker 的 iptables 规则_docker iptables 规则_摩洛哥 M 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3RhaXlhbmdkYW8vYXJ0aWNsZS9kZXRhaWxzLzg4ODQ0NTU4\">(63 条消息) 基于 iptables 的 Docker 网络隔离与通信详解_docker-user return_易生一世的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuNTFjdG8uY29tL2FydGljbGUvNzUxMjQ0Lmh0bWw=\">一篇文章讲明白 Docker 网络原理 - 51CTO.COM</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vd2Fuc3RhY2svcC84MzkzMjgyLmh0bWw=\">iptables 详解（10）：iptables 自定义链 - wanstack - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNjAzNTEx\">理解 kubernetes 环境的 iptables - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n",
            "tags": [
                "运维"
            ]
        },
        {
            "id": "http://example.com/2022/11/27/CDN/",
            "url": "http://example.com/2022/11/27/CDN/",
            "title": "CDN&DNS",
            "date_published": "2022-11-27T05:38:45.000Z",
            "content_html": "<h1 id=\"cdn\"><a class=\"markdownIt-Anchor\" href=\"#cdn\">#</a> CDN</h1>\n<h2 id=\"0x00-cdn概述\"><a class=\"markdownIt-Anchor\" href=\"#0x00-cdn概述\">#</a> 0x00 CDN 概述</h2>\n<p><strong>CDN</strong> 英文全称 <code>Content Delivery Network</code> ，中文翻译即为<strong>内容分发网络</strong>。它是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。</p>\n<p>CDN 这个技术其实说起来并不复杂，最初的核心理念，就是<strong>将内容缓存在终端用户附近</strong>。</p>\n<p>具体来说，CDN 就是采用更多的缓存服务器（CDN 边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。</p>\n<p>镜像服务器是源内容服务器的完整复制。而 CDN，是部分内容的缓存，智能程度更高。</p>\n<p><strong>CDN = 更智能的镜像 + 缓存 + 流量导流</strong>。</p>\n<h2 id=\"0x01-cdn应用场景\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn应用场景\">#</a> <strong>0x01 CDN 应用场景</strong></h2>\n<h6 id=\"1-网站站点应用加速\"><a class=\"markdownIt-Anchor\" href=\"#1-网站站点应用加速\">#</a> <strong>1、网站站点 / 应用加速</strong></h6>\n<p>站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器 ECS，静态资源如各类型图片、html、css、js 文件等，建议结合 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2Nvcz9mcm9tPTEwNjgw\">对象存储</span> OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发。</p>\n<h6 id=\"2-视音频点播大文件下载分发加速\"><a class=\"markdownIt-Anchor\" href=\"#2-视音频点播大文件下载分发加速\">#</a> <strong>2、视音频点播 / 大文件下载分发加速</strong></h6>\n<p>支持各类文件的下载、分发，支持在线点播加速业务，如 mp4、flv 视频文件或者平均单个文件大小在 20M 以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储 OSS 使用，可提升回源速度，节约近 2/3 回源带宽成本。</p>\n<h6 id=\"3-视频直播加速\"><a class=\"markdownIt-Anchor\" href=\"#3-视频直播加速\">#</a> <strong>3、视频直播加速</strong></h6>\n<p>视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。</p>\n<h6 id=\"4-移动应用加速\"><a class=\"markdownIt-Anchor\" href=\"#4-移动应用加速\">#</a> <strong>4、移动应用加速</strong></h6>\n<p>移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。提供 httpDNS 服务，避免 DNS 劫持并获得实时精确的 DNS 解析结果，有效缩短用户访问时间，提升用户体验。</p>\n<h2 id=\"0x01-cdn网络的组成\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn网络的组成\">#</a> 0x01 CDN 网络的组成</h2>\n<p>一个 CDN 网络主要由以下几部分组成：内容缓存设备、内容分发管理设备、本地负载均衡交换机、GSLB 设备和 CDN 管理系统，其网络结构如下图所示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20130609113946968\" alt=\"img\"></p>\n<p><strong>内容缓存设备 Cache</strong>：</p>\n<p>用于缓存内容实体和对缓存内容进行组织和管理。当有用户访问该客户内容时，直接由各缓存服务器响应用户的请求。</p>\n<p><strong>内容分发管理设备</strong>：</p>\n<p>主要负责核心 Web 服务器内容到 CDN 网络内缓存设备的内容推送、删除、校验以及内容的管理、同步。</p>\n<p><strong>GSLB 设备</strong>：</p>\n<p>则实现 CDN 全网各缓存节点之间的资源负载均衡，它与各节点的 SLB 设备保持通信，搜集各节点缓存设备的健康状态、性能、负载等，自动将用户指引到位于<strong>其地理区域中的最近服务器</strong>或者引导用户<strong>离开拥挤的网络和服务器</strong>。还可以通过使用多站点的内容和服务来提高容错性和可用性，防止因本地网或区域网络中断、断电或自然灾害而导致的故障。</p>\n<blockquote>\n<p>不用 CDN 技术时，使用 GSLB 设备可以为用户选择最合适的服务器，但受 Web 服务器的负荷和传输距离等因素的影响，响应速度依然经常不能满足用户的需求。这一问题的解决方案就是在传输网络上利用缓存技术使得 Web 服务数据流能够就近访问。内容分发网络（CDN）正是这种思想的一个实现，CDN 使用 GSLB 设备将用户引导到最合适的缓存节点（距离近，负载低），使得用户在访问静态内容时获得更好的体验。</p>\n</blockquote>\n<p><strong>CDN 管理系统</strong>：</p>\n<p>实现对全网设备的管理，对系统的配置。它不仅能对系统中的各个设备进行实时监控，对各种故障产生相应的告警，还能实时观测到系统中总的流量以及各节点的流量，并保存在系统的数据库中，作为统计分析的基础数据，并对日志文件进行管理、报告，作为计费的基础数据。</p>\n<h2 id=\"0x02-cdn-原理\"><a class=\"markdownIt-Anchor\" href=\"#0x02-cdn-原理\">#</a> 0x02 CDN 原理</h2>\n<h3 id=\"cdn-解析流程\"><a class=\"markdownIt-Anchor\" href=\"#cdn-解析流程\">#</a> CDN 解析流程</h3>\n<p>如果某个用户想要访问优酷的视频点播内容，那么：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204154043.png\" alt=\"image-20221125204154043\" style=\"zoom:67%;\" />\n<blockquote>\n<p>①、当用户点击 APP 上的内容，APP 会根据 URL 地址去<strong>本地 DNS</strong>（域名解析系统）寻求 IP 地址解析。</p>\n<p>②、当用户点击网站页面上的内容 URL，经过本地 DNS 系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。</p>\n<p>③、CDN 专用 DNS 服务器，将 CDN 的全局负载均衡设备 IP 地址返回用户。也就是上面所说的 GSLB 设备</p>\n<p>④、用户向<strong> CDN 的负载均衡设备</strong>发起内容 URL 访问请求。</p>\n<p>⑤、CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。</p>\n<p>⑥、负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。</p>\n<p>⑦、用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。</p>\n<p>⑧、如果这台缓存服务器上并没有用户想要的内容，那么这台缓存服务器就要网站的<strong>源服务器</strong>请求内容。</p>\n<p>⑨、源服务器返回内容给缓存服务器，缓存服务器发给用户，并根据用户自定义的缓存策略，判断要不要把内容缓存到缓存服务器上。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/u6pjybbkxn.png\" alt=\"img\"></p>\n<blockquote>\n<ol>\n<li>当终端用户（北京）向 <code>www.a.com</code>  下的指定资源发起请求时，首先向 LDNS（本地 DNS）发起域名解析请求。</li>\n<li>LDNS 检查缓存中是否有 <code>www.a.com</code>  的 IP 地址记录。如果有，则直接返回给终端用户；如果没有，则向授权 DNS 查询。</li>\n<li>当授权 DNS 解析 <code>www.a.com</code>  时，返回域名 CNAME www.a.tbcdn.com 对应 IP 地址。</li>\n<li>域名解析请求发送至阿里云 DNS 调度系统，并为请求分配最佳节点 IP 地址。</li>\n<li>LDNS 获取 DNS 返回的解析 IP 地址。</li>\n<li>用户获取解析 IP 地址。</li>\n<li>用户向获取的 IP 地址发起对该资源的访问请求。</li>\n</ol>\n<ul>\n<li>如果该 IP 地址对应的节点已缓存该资源，则会将数据直接返回给用户，例如，图中步骤 7 和 8，请求结束。</li>\n<li>如果该 IP 地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点，例如，图中的北京节点，并返回给用户，请求结束。</li>\n</ul>\n</blockquote>\n<blockquote>\n<ol>\n<li>CDN 的加速资源是跟域名绑定的。</li>\n<li>通过域名访问资源，首先是通过 DNS 分查找离用户最近的 CDN 节点（边缘服务器）的 IP</li>\n<li>通过 IP 访问实际资源时，如果 CDN 上并没有缓存资源，则会到源站请求资源，并缓存到 CDN 节点上，这样，用户下一次访问时，该 CDN 节点就会有对应资源的缓存了。</li>\n</ol>\n</blockquote>\n<p>应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键</p>\n<p>CDN 主要功能是在不同的地点缓存内容，通过负载均衡技术，将用户的请求定向到最合适的缓存服务器上去获取内容，比如说，是北京的用户，我们让他访问北京的节点，深圳的用户，我们让他访问深圳的节点。通过就近访问，加速用户对网站的访问。解决 Internet 网络拥堵状况，提高用户访问网络的响应速度。</p>\n<p>由于没有返回 IP 地址，于是本地 DNS 会向负载均衡系统再发送请求 ，则进入到 CDN 的全局负载均衡系统 GSLB 进行智能调度：</p>\n<ul>\n<li>看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点</li>\n<li>看用户所在的运营商网络，找相同网络的边缘节点</li>\n<li>检查边缘节点的负载情况，找负载较轻的节点</li>\n<li>其他，比如节点的 “健康状况”、服务能力、带宽、响应时间等</li>\n</ul>\n<p>结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问 CDN 的缓存代理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/fdde5787e61870ee5d997f1ca89d0870.png\" alt=\"img\"></p>\n<p>我们可以用 dig 查看 dns 解析结果</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# dig www.bilibili.com</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 &lt;&lt;&gt;&gt; www.bilibili.com</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60626</span><br><span class=\"line\">;; flags: qr rd ra; QUERY: 1, ANSWER: 22, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class=\"line\"></span><br><span class=\"line\">;; QUESTION SECTION:</span><br><span class=\"line\">;www.bilibili.com.\t\tIN\tA</span><br><span class=\"line\"></span><br><span class=\"line\">;; ANSWER SECTION:</span><br><span class=\"line\">www.bilibili.com.\t144\tIN\tCNAME\ta.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com.\t169\tIN\tCNAME\tct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.27</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.28</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.29</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.30</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.48</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.42</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.18</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.44</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.45</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.46</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.66</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.67</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.68</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.43</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.19</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.20</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.12</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.13</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.14</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.15</span><br><span class=\"line\"></span><br><span class=\"line\">;; Query time: 7 msec</span><br><span class=\"line\">;; SERVER: 183.60.83.19#53(183.60.83.19)</span><br><span class=\"line\">;; WHEN: Fri Nov 25 21:22:04 CST 2022</span><br><span class=\"line\">;; MSG SIZE  rcvd: 398</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在ANSWER SECTION列表可以看出</span><br><span class=\"line\"></span><br><span class=\"line\">www.bilibili.com为cname记录指向a.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com为cname记录指向ct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.返回了20条A记录，这20个ip 信息是</span><br><span class=\"line\">中国浙江金华 电信</span><br><span class=\"line\">中国江苏南通 电信</span><br><span class=\"line\">中国湖北宜昌 电信 </span><br><span class=\"line\">中国 陕西省 西安市 电信  -- 117.23.60.14</span><br><span class=\"line\">比如我在陕西省西安市鄠邑区，可以看出返回的都是就近节点。实际上CDN是有非常多的边缘节点。</span><br></pre></td></tr></table></figure>\n<p>用 tcpdump 来监控下 DNS 的 UDP 数据包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# tcpdump -n -s 1500 udp and port 53</span><br><span class=\"line\">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class=\"line\">listening on eth0, link-type EN10MB (Ethernet), capture size 1500 bytes</span><br><span class=\"line\">21:28:21.393765 IP 10.0.16.11.45832 &gt; 183.60.83.19.domain: 32323+ A? www.bilibili.com. (34)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.394724 IP 183.60.83.19.domain &gt; 10.0.16.11.45832: 32323 22/0/0 CNAME a.w.bilicdn1.com., CNAME ct.w.bilicdn1.com., A 61.147.236.42, A 61.147.236.43, A 61.147.236.44, A 61.147.236.45, A 61.147.236.46, A 116.207.137.66, A 116.207.137.67, A 116.207.137.68, A 117.21.179.18, A 117.21.179.19, A 117.21.179.20, A 117.23.60.12, A 171.214.10.140, A 171.214.10.141, A 171.214.10.142, A 183.131.147.27, A 183.131.147.28, A 183.131.147.29, A 183.131.147.30, A 183.131.147.48 (398)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.407290 IP 10.0.16.11.32999 &gt; 183.60.83.19.domain: 53397+ PTR? 42.236.147.61.in-addr.arpa. (44)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.431995 IP 183.60.83.19.domain &gt; 10.0.16.11.32999: 53397 NXDomain 0/1/0 (93)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中，10.0.16.11 为腾讯云服务器内网地址。也就是本机向路由器询问 DNS 解析，如果路由器已经缓存了，就会直接返回。</p>\n<h3 id=\"传统的网站访问与cdn访问\"><a class=\"markdownIt-Anchor\" href=\"#传统的网站访问与cdn访问\">#</a> 传统的网站访问与 CDN 访问</h3>\n<p><strong>传统访问访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/n630r4cz49.png\" alt=\"img\"></p>\n<p><strong>使用了 CDN 的网站访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7qb88zlcll.png\" alt=\"img\"></p>\n<p>在没有 CDN 的情况下，用户向浏览器输入 <code>www.web.com</code>  这个域名，客户端访问本地 DNS 服务器的时候，如果本地 DNS 服务器有缓存，则返回网站的地址；如果没有，递归查询到网站的权威 DNS 服务器，这个权威 DNS 服务器是负责 web.com 的，它会返回网站的 IP 地址。</p>\n<p>本地 DNS 服务器缓存下 IP 地址，将 IP 地址返回，然后客户端直接访问这个 IP 地址，就访问到了这个网站。</p>\n<p><strong>然而有了 CDN 之后，情况发生了变化</strong>。</p>\n<p>在 web.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 <code>www.web.cdn.com</code> ，返回给本地 DNS 服务器。</p>\n<p>当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，再访问的就不是 <span class=\"exturl\" data-url=\"aHR0cDovL3dlYi5jb20=\">web.com</span> 的权威 DNS 服务器了，而是 web.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</p>\n<p>接下来，<strong>本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名</strong>，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务</p>\n<p>基于以上这些条件，进行综合分析之后，全局负载均衡器会返回一台缓存服务器的 IP 地址。</p>\n<p>本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。 缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200418104105733.png\" alt=\"在这里插入图片描述\"></p>\n<p>与传统访问方式不同，<strong>CDN 网络则是在用户和服务器之间增加缓存层，将用户的访问请求引导到最优的缓存节点</strong>而不是服务器源站点，从而加速访问速度。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ciawk92i4h.png\" alt=\"img\"></p>\n<h3 id=\"缓存代理\"><a class=\"markdownIt-Anchor\" href=\"#缓存代理\">#</a> 缓存代理</h3>\n<p>缓存系统是 CDN 的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源</p>\n<p>其中有两个衡量 CDN 服务质量的指标：</p>\n<ul>\n<li>回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户<br>\n回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源</p>\n</blockquote>\n<ul>\n<li>命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>现在的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上</p>\n</blockquote>\n<h2 id=\"0x03-cdn好处\"><a class=\"markdownIt-Anchor\" href=\"#0x03-cdn好处\">#</a> 0x03 CDN 好处</h2>\n<blockquote>\n<h6 id=\"1-为了实现跨运营商-跨地域的全网覆盖\"><a class=\"markdownIt-Anchor\" href=\"#1-为了实现跨运营商-跨地域的全网覆盖\">#</a> <strong>1. 为了实现跨运营商、跨地域的全网覆盖</strong></h6>\n<p>互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN 加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署 CDN 边缘分发存储节点，充分利用带宽资源，平衡源站流量。</p>\n<p>例如中国移动手机用户访问中国电信网络的内容源，可以通过在中国移动假设 CDN 服务器，进行加速。效果是非常明显的。</p>\n<h6 id=\"2-为了保障你的网站安全\"><a class=\"markdownIt-Anchor\" href=\"#2-为了保障你的网站安全\">#</a> <strong>2. 为了保障你的网站安全</strong></h6>\n<p>CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。</p>\n<p>内容进行分发后，源服务器的 IP 被隐藏，受到攻击的概率会大幅下降。CDN 可以通过分流 ，洗掉来自 Ddos 大部分的攻击 。</p>\n<h6 id=\"3-为了异地备援\"><a class=\"markdownIt-Anchor\" href=\"#3-为了异地备援\">#</a> <strong>3. 为了异地备援</strong></h6>\n<p>当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近 100% 的可靠性，这就让你的网站可以做到永不宕机。</p>\n<h6 id=\"4-为了节约成本投入\"><a class=\"markdownIt-Anchor\" href=\"#4-为了节约成本投入\">#</a> <strong>4. 为了节约成本投入</strong></h6>\n<p>使用 CDN 加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9zb2x1dGlvbi9vcGVyYXRpb24/ZnJvbT0xMDY4MA==\">运维</span>，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，节省了人力、精力和财力。</p>\n<h6 id=\"5-为了让你更专注业务本身\"><a class=\"markdownIt-Anchor\" href=\"#5-为了让你更专注业务本身\">#</a> <strong>5. 为了让你更专注业务本身</strong></h6>\n<p>CDN 加速厂商一般都会提供一站式服务，业务不仅限于 CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供 7x24 运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。</p>\n<p>6. 互联网服务提供商采用 CDN，是<strong>以存储换时延</strong>。通信运营商也追捧 CDN，但它们的目的，是<strong>以存储换带宽</strong> —— 通过服务 “下沉”，减轻上层骨干网络的流量压力，避免硬件扩容，降低网络建设成本。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204403468.png\" alt=\"image-20221125204403468\"></p>\n<h2 id=\"0x04-常用的cdn缓存软件\"><a class=\"markdownIt-Anchor\" href=\"#0x04-常用的cdn缓存软件\">#</a> 0x04 常用的 CDN 缓存软件</h2>\n<blockquote>\n<ul>\n<li>Varnish ：可以认为是内存缓存，速度一流，但是内存缓存也限制了其容量，缓存页面和图片一般是挺好的；</li>\n<li>squid 是功能最全面的比较传统的 web cache server，有自己的存储引擎。，但是架构太老，性能不怎样。</li>\n<li>nginx 本来是反向代理 /web 服务器，用了插件可以做做这个副业，但是本身不支持的功能比较多</li>\n</ul>\n</blockquote>\n<h2 id=\"0x05-cdn相关术语\"><a class=\"markdownIt-Anchor\" href=\"#0x05-cdn相关术语\">#</a> 0x05 CDN 相关术语</h2>\n<p><strong>CDN 相关的术语解释</strong></p>\n<h6 id=\"1-origin-server源站\"><a class=\"markdownIt-Anchor\" href=\"#1-origin-server源站\">#</a> <strong>1、Origin Server 源站</strong></h6>\n<p>做 CDN 之前的客户真正的服务器。</p>\n<h6 id=\"2-user\"><a class=\"markdownIt-Anchor\" href=\"#2-user\">#</a> <strong>2、User</strong></h6>\n<p>访问者，也就是要访问网站的网民。</p>\n<h6 id=\"3-last-mile\"><a class=\"markdownIt-Anchor\" href=\"#3-last-mile\">#</a> <strong>3、Last Mile</strong></h6>\n<p>最后一公里，也就是网民到他所访问到的 CDN 服务器之间的路径。</p>\n<h6 id=\"4-域名\"><a class=\"markdownIt-Anchor\" href=\"#4-域名\">#</a> <strong>4、域名</strong></h6>\n<p>域名是 Internet 网络上的一个服务器或一个网络系统的名字，全世界，没有重复的域名。</p>\n<h6 id=\"5-cname记录\"><a class=\"markdownIt-Anchor\" href=\"#5-cname记录\">#</a> <strong>5、CNAME 记录</strong></h6>\n<p>它是一个别名记录 (Canonical Name)；当 DNS 系统在查询 CNAME 左面的名称的时候，都会转向 CNAME 右面的名称再进行查询，一直追踪到最后的 PTR 或 A 名称，成功查询后才会做出回应，否则失败。</p>\n<h6 id=\"6-cname域名\"><a class=\"markdownIt-Anchor\" href=\"#6-cname域名\">#</a> <strong>6、CNAME 域名</strong></h6>\n<p>CDN 的域名加速需要用到 CNAME 记录，在服务器控制台配置完成 CDN 加速后，您会得到一个加速后的域名，称之为 CNAME 域名（该域名一定是 <code>*.*http://wljslmz.com</code> ）， 用户需要将自己的域名作 CNAME 指向这个 <code>*.*http://wljslmz.com</code>  的域名后，域名解析的工作就正式转向云服务器，该域名所有的请求都将转向云 CDN 的节点。</p>\n<h6 id=\"7-dns\"><a class=\"markdownIt-Anchor\" href=\"#7-dns\">#</a> <strong>7、DNS</strong></h6>\n<p>DNS 即 Domain Name System，是域名解析服务的意思。它在互联网的作用是：把域名转换成为网络可以识别的 ip 地址。人们习惯记忆域名，但机器间互相只认 IP 地址，域名与 IP 地址之间是一一对应的，它们之间的转换工作称为域名解析，域名解析需要由专门的域名解析服务器来完成，整个过程是自动进行的。比如：上网时输入的百度一下，你就知道会自动转换成为 <code>220.181.112.143</code></p>\n<h6 id=\"8-边缘节点\"><a class=\"markdownIt-Anchor\" href=\"#8-边缘节点\">#</a> <strong>8、边缘节点</strong></h6>\n<p>也称 CDN 节点、Cache 节点等；是相对于网络的复杂结构而提出的一个概念，指距离最终用户接入具有较少的中间环节的网络节点，对最终接入用户有较好的响应能力和连接速度。其作用是将访问量较大的网页内容和对象保存在服务器前端的专用 cache 设备上，以此来提高网站访问的速度和质量。</p>\n<h6 id=\"9-cache\"><a class=\"markdownIt-Anchor\" href=\"#9-cache\">#</a> <strong>9、cache</strong></h6>\n<p>cache 高速缓冲存储器一种特殊的存储器子系统，其中复制了频繁使用的数据以利于快速访问。存储器的高速缓冲存储器存储了频繁访问的 RAM 位置的内容及这些数据项的存储地址。当处理器引用存储器中的某地址时，高速缓冲存储器便检查是否存有该地址。如果存有该地址，则将数据返回处理器；如果没有保存该地址，则进行常规的存储器访问。因为高速缓冲存储器总是比主 RAM 存储器速度快，所以当 RAM 的访问速度低于微处理器的速度时，常使用高速缓冲存储器。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzc5MzM1\">什么是 CDN？它解决了什么难题？5 分钟让你明明白白！ - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODk0MDQ1MQ==\">也许是史上最全的一次 CDN 详解 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MjM2Mjk1MA==\">到底什么是 CDN？ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTYyOTA0MjE2NTAzMzIwNTg5\">一图秒懂 CDN 原理 - 掘金 (juejin.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc4NTEzLmh0bWwjYXV0b2lkLWgyLTAtMC0w\">CDN 图解（秒懂 + 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n<p>来都来了，看个 DNS 再走吧～</p>\n<h1 id=\"dns\"><a class=\"markdownIt-Anchor\" href=\"#dns\">#</a> DNS</h1>\n<h2 id=\"dns概述\"><a class=\"markdownIt-Anchor\" href=\"#dns概述\">#</a> DNS 概述</h2>\n<p>DNS 是 Domain Name System 的缩写，也就是 域名解析系统，它的作用非常简单，就是根据域名查出对应的 IP 地址。</p>\n<p>你可以把它想象成一本巨大的电话本，比如当你要访问域名 <code>www.163.com</code> ，首先要通过 DNS 查出它的 IP 地址是 <code>112.48.162.8</code> 。</p>\n<p>为啥需要解析捏？ 因为域名是给人看的，你只能通过 IP 的方式访问资源，但是让你背 IP 你又不干，而且最坏的情况是他用了 CDN 或者负载均衡，导致他的 IP 更多了，你更不想背了，所以我们有了 DNS，将域名解析成 IP，我们只需要输入域名，域名通过 DNS 解析成 IP，最终访问到资源。</p>\n<p>注意：上面的 DNS 解析对于用户来说是透明的，你并不知道你输入 www.bilibili.com 后到底他给你解析了那个 IP。而如果你真想知道为啥会给你解析成某个 IP，要取决于对方有没有使用 CDN 和一些其他因素</p>\n<h2 id=\"dns资源记录\"><a class=\"markdownIt-Anchor\" href=\"#dns资源记录\">#</a> DNS 资源记录</h2>\n<p>在 DNS 服务器上，一个域名及其下级域名组成一个区域 （Zone）。一个 Zone 的 相关的 DNS 信息构成一个数据库文件。</p>\n<p>下面是一条 A 类型的资源记录（简称为 A 记录）：域名 <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy56ZG5zLmNu\">www.zdns.cn</span> 的数据为 202.173.11.10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210704153331929.png\" alt=\"在这里插入图片描述\"></p>\n<p>记录一条域名信息映射关系，称之为资源记录（RR）。当我们查询域名 www.zdns.cn 的时候，查询结果得到的资源记录结构体中有如下数据：</p>\n<ul>\n<li>TTL，就是生存周期，是递归服务器会在缓存中保存该资源记录的时长。</li>\n<li>网络 / 协议类型，它的代表的标识是 IN，IN 就是 internet，目前 DNS 系统主要支持的协议是 IN。</li>\n<li>type，就是资源记录类型，一般的网站都是都是 A 记录（IPv4 的主机地址）。</li>\n<li>rdata 是资源记录数据，就是域名关联的信息数据。</li>\n</ul>\n<p>常见的资源记录类型如表所示。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126101836133.png\" alt=\"image-20221126101836133\"></p>\n<p><strong>A 记录：又称 IP 指向</strong></p>\n<p>用户可以在此设置子域名并指向到自己的目标主机地址上，从而实现通过域名找到服务器。</p>\n<blockquote>\n<p>说明：指向的目标主机地址类型只能使用 IP 地址；<br>\n附加说明：</p>\n<ul>\n<li>\n<p>泛域名解析即将该域名所有未指定的子域名都指向一个空间。在 “主机名” 中填入 *，“类型” 为 A，“IP 地址 / 主机名” 中填入 web 服务器的 IP 地址，点击 “新增” 按钮即可。</p>\n</li>\n<li>\n<p>负载均衡的实现：负载均衡 (Server Load Balancing，SLB) 是指在一系列资源上面动态地分布网络负载。负载均衡可以减少网络拥塞，提高整体网络性能，提高自愈性， 并确保企业关键性应用的可用性。</p>\n<p>当相同子域名有多个目标地址时，表示轮循，可以达到负载均衡的目的，但需要虚拟主机服务商支持。</p>\n</li>\n</ul>\n</blockquote>\n<p><strong>CNAME : 通常称别名指向。</strong></p>\n<p>您可以为一个主机设置别名。<br>\n比如设置 <span class=\"exturl\" data-url=\"aHR0cDovL3Rlc3QubXlkb21haW4uY29t\">test.mydomain.com</span>，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS13d3ctcDE4ZG9odmRzMTFjbzgzYXQ1aGVtYXc1MGsucmRkbnMuY29t\">用来指向一个主机 www.rddns.com</span> , 那么以后就可以用 test.mydomain.com 来代替访问 www.rddns.com 了。</p>\n<p>说明：・</p>\n<ul>\n<li>CNAME 的目标主机地址只能使用主机名，不能使用 IP 地址；</li>\n<li>主机名前不能有任何其他前缀，如：<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1paHF4MWZoOHo1M29sdGZucHdpMmUv\">http:// 等是不被允许的</span>；</li>\n<li>A 记录优先于 CNAME 记录。即如果一个主机地址同时存在 A 记录和 CNAME 记录，则 CNAME 记录不生效。</li>\n</ul>\n<p><strong>NS 记录：指向 DNS 子域名</strong></p>\n<p>服务器解析记录，用来表明由哪台服务器对该域名进行解析。这里的 NS 记录只对子域名生效。</p>\n<p>例如用户希望由 12.34.56.78 这台服务器解析 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span>，则需要设置 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span> 的 NS 记录。</p>\n<p>说明：</p>\n<ul>\n<li>“优先级” 中的数字越小表示级别越高；</li>\n<li>“IP 地址 / 主机名” 中既可以填写 IP 地址，也可以填写像 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span> 这样的主机地址，但必须保证该主机地址有效。</li>\n</ul>\n<blockquote>\n<p>如，将 news.mydomain.com 的 NS 记录指向到 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span>，在设置 NS 记录的同时还需要设置 ns.mydomain.com 的指向，否则 NS 记录将无法正常解析；</p>\n</blockquote>\n<ul>\n<li>NS 记录优先于 A 记录。</li>\n</ul>\n<blockquote>\n<p>即，如果一个主机地址同时存在 NS 记录和 A 记录，则 A 记录不生效。这里的 NS 记录只对子域名生效。</p>\n</blockquote>\n<h2 id=\"解析过程\"><a class=\"markdownIt-Anchor\" href=\"#解析过程\">#</a> 解析过程</h2>\n<p>1、缓存查找 IP</p>\n<p>2、本机的 hosts 文件查找 IP</p>\n<p>3、DNS 服务器查找 IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210705144630547.png\" alt=\"在这里插入图片描述\"></p>\n<p><strong>从递归和迭代查询可以看出：</strong></p>\n<p>客户端 - 本地 dns 服务端：</p>\n<blockquote>\n<p>这部分属于递归查询。递归查询时，返回的结果只有两种：查询成功或查询失败.</p>\n</blockquote>\n<p>本地 dns 服务端 — 外网：</p>\n<blockquote>\n<p>这部分属于迭代查询。迭代查询，又称作重指引，返回的是最佳的查询点或者主机地址.</p>\n</blockquote>\n<blockquote>\n<ol>\n<li>浏览器先检查自身缓存中有没有被解析过的这个域名对应的 ip 地址，如果有，解析结束。同时域名被缓存的时间也可通过 TTL 属性来设置。</li>\n<li>如果浏览器缓存中没有（专业点叫还没命中），浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在 windows 中可通过 c 盘里一个叫 hosts 的文件来设置，如果你在这里指定了一个域名对应的 ip 地址，那浏览器会首先使用这个 ip 地址。</li>\n</ol>\n<blockquote>\n<p>但是这种操作系统级别的域名解析规程也被很多黑客利用，通过修改你的 hosts 文件里的内容把特定的域名解析到他指定的 ip 地址上，造成所谓的域名劫持。所以在 windows7 中将 hosts 文件设置成了 readonly，防止被恶意篡改。</p>\n</blockquote>\n<ol>\n<li>如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约 80% 的域名解析到这里就完成了。</li>\n<li>如果 LDNS 仍然没有命中，就直接跳到 Root Server 域名服务器请求解析</li>\n<li>根域名服务器返回给 LDNS 一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1idnMuY29t\">如.com</span> .cn .org 等）地址</li>\n<li>此时 LDNS 再发送请求给上一步返回的 gTLD</li>\n<li>接受请求的 gTLD 查找并返回这个域名对应的 Name Server 的地址，这个 Name Server 就是网站注册的域名服务器</li>\n<li>Name Server 根据映射关系表找到目标 ip，返回给 LDNS</li>\n<li>LDNS 缓存这个域名和对应的 ip</li>\n<li>LDNS 把解析的结果返回给用户，用户根据 TTL 值缓存到本地系统缓存中，域名解析过程至此结束</li>\n</ol>\n</blockquote>\n<p><strong>记住这个解析过程，后面要考</strong></p>\n<h1 id=\"举两个例子\"><a class=\"markdownIt-Anchor\" href=\"#举两个例子\">#</a> 举两个例子</h1>\n<p>腾讯连接了两家运营商电信和联通，电信访问内部服务的流量大，联通的少，怎么把电信流入的流量扔一些给联通</p>\n<blockquote>\n<p>这道题的侧重点在于控制用户侧和运营商侧，因为如果要控制腾讯侧，那么流量已经到了腾讯的防火墙上，不能实现流量控制。</p>\n<p>有两种可能的解法，dns 和 cdn，个人理解，cdn 其实是一种分布式 dns 的解法，两种解法的本质都是控制通过控制 dns 的解析来控制流量选路</p>\n<p>1.dns</p>\n<p>上面也提过 DNS 的解析过程了，那么我们需要控制的就是用户来解析域名时候返回的 IP。</p>\n<p>一般来说，联通用户解析出联通的 IP 访问速度肯定是最快的，但是当电信的访问拥塞时，我们可以给电信的用户在解析时返回联通的 IP，让电信用户通过联通访问，而众所周知，电信和联通可定是可以互通的，只不过是次优路径的问题，因此我们无需关注电信是怎么找到联通的。就像你以前在下游戏的时候，你也不会先看看自己是电信的 IP 还是联通的 IP 再下载，通常看心情随便一点，甚至还可以点到铁通去。</p>\n<p>那么还有个问题是运营商 / 腾讯怎么知道你的 IP 是电信还是联通的。其实每个 IP 都是可以查到归属的，我们只需要增加一个查表或者查缓存的过程罢了</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126105505371.png\" alt=\"image-20221126105505371\"></p>\n<p>2.cdn</p>\n<p>cdn 本质就是也是通过 dns 解析返回给你一个离你最近的一个边缘节点的 IP，只不过这个 IP 解析比较曲折，上面在将 cdn 的时候也讲过了，应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键。CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。并且 CDN 可以监控链路质量，实现动态切换和找到负载较轻的节点</p>\n<p>3. 负载均衡，nginx，redis (这个没啥用，但可以在这里写一笔)</p>\n<p>因为这明显是已经进入腾讯内部之后了，nginx 的负载均衡和 redis 的负载均衡在集群的场景下确实是有很大作用滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110209123.png\" alt=\"image-20221126110209123\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110225565.png\" alt=\"image-20221126110225565\" style=\"zoom:50%;\" />·</p>\n</blockquote>\n<p>或者你有两个出口电信和联通，怎么控制选路</p>\n<blockquote>\n<p>这道题侧重点在于流量出去，也是在本 AS 内控制选路</p>\n<p>1.PBR 策略路由</p>\n<p>略路由 PBR（Policy-Based Routing）是一种依据用户制定的策略进行路由选择的机制，分为本地策略路由、接口策略路由和智能策略路由 SPR</p>\n<p>路由策略（route-policy）与策略路由（policy based route）区别</p>\n<ul>\n<li>\n<p>策略路由的操作对象是数据包，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。</p>\n</li>\n<li>\n<p>路由策略的操作对象是路由信息。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。</p>\n</li>\n</ul>\n<p>传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。但是目前越来越多的用户希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。策略路由使网络管理者不仅能够根据报文的目的地址，而且能够根据报文的源地址、报文大小和链路质量等属性来制定策略路由，以改变数据包转发路径，满足用户需求。</p>\n<p>如果联通的流量很少，但电信流量很大，可以通过 PBR 强制改变路由选路实现流量迁移</p>\n<p>多说一句，其实我们的组网可以使用负载分担双联路方案</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126112007676.png\" alt=\"image-20221126112007676\" style=\"zoom:67%;\" />\n<p>\\1. 2 条链路能同时使用，一半 PC 优先选择电信，另外一半 PC 优先选择联通；</p>\n<p>\\2. 2 条链路为主备方式，电信线路为主，联通线路为备；</p>\n<p>\\3. 但可以实现电信线路断开，所有 PC 选择联通线路，联通线路故障，所有 PC 选择电信。</p>\n<p>其实基本原理还是策略路由，我们可以通过源 IP 奇偶性控制选路</p>\n<p>\\1. 由于策略路由只控制奇数 IP，所以偶数 IP 默认情况下就是优选电信线路，电信线路 Down 情况下选择联通线路，这和传统解决方案一致；</p>\n<p>\\2. 关键的是奇数 IP，奇数 IP 在策略路由的控制下，优选了联通线路，PBR 有一个特性，如果出接口联通线路 Down，则 PBR 失效，奇数 IP 恢复正常的路由转发，选择电信线路。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acl number 2000</span><br><span class=\"line\">rule permit source 0.0.0.1 255.255.255.254</span><br><span class=\"line\">#</span><br><span class=\"line\">policy-based-route mypbr permit node 5</span><br><span class=\"line\">if-match acl 2000</span><br><span class=\"line\">apply ip-address next-hop 联通网关</span><br><span class=\"line\">#</span><br><span class=\"line\">interface vlan-interface1</span><br><span class=\"line\">ip address 192.168.1.1 255.255.255.0</span><br><span class=\"line\">ip policy-based-route mypbr</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 电信网关</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 联通网关 preference 80</span><br></pre></td></tr></table></figure>\n<p>2.DNS 选路</p>\n<p>和上面的案例一样，只不过由于我们这次可以在内网控制，我们不一定要依赖运营商的 DNS 解析，比如学校里我们可以使用自己的 DNS 解析一部分地址，将其解析到空闲的链路上</p>\n<p>3. 控制 preference</p>\n<p>ip route-static 0.0.0.0 0 192.168.1.254 preference 10</p>\n<p>将希望优先选择的链路优先级改小，实现优先选路</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaDNjLmNvbS9jbi9kXzIwMTAxMC82OTc2NjRfOTc2NjVfMC5odG0=\">技术点详解 — 互联网双出口的选择 - IP 技术专栏 - 技术甜甜圈 - 新华三集团 - H3C</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc2NjEyLmh0bWwjYXV0b2lkLWgzLTExLTAtNg==\">DNS 图解（秒懂 - 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": [
                "运维"
            ]
        }
    ]
}