



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/2023/01/20/VXLAN/">



  <title>
VXLAN |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">VXLAN
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-01-20 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-01-20T13:38:45+08:00">2023-01-20</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giciundwu5j20zk0m8n9e.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicm0n457cj20zk0m8e81.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclhfehz7j20zk0m8u0x.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeyvx1d4j20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclg5ms2rj20zk0m8u0x.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeyhsblkj20zk0m81kx.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/01/20/VXLAN/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="vxlan"><a class="markdownIt-Anchor" href="#vxlan">#</a> VXLAN</h1>
<h2 id="enspvirtualbox设置"><a class="markdownIt-Anchor" href="#enspvirtualbox设置">#</a> ensp&amp;virtualbox 设置</h2>
<p>1. 导入 CE 镜像</p>
<p>拖一台 CE12800，启动设备，系统会让自动选择镜像，选择 CE 镜像，正确的镜像为 1.3G 的</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221931649.png" alt="image-20230101221931649"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222035060.png" alt="image-20230101222035060"></p>
<p>导入后 virtualbox 中会显示</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221847981.png" alt="image-20230101221847981"></p>
<p>更改 CE 设置，设置内存，每台 CE12800 大概需要 1G 内存</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222420086.png" alt="image-20230101222420086"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222459733.png" alt="image-20230101222459733"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222528294.png" alt="image-20230101222528294"></p>
<h2 id="vxlan-2"><a class="markdownIt-Anchor" href="#vxlan-2">#</a> VXLAN</h2>
<p>VXLAN 是由 IETF 定义的 NVO3 (Network Virtualization over Layer 3) 标准技术之一，采用 L2 over L4 ( MAC-in-UDP) 的报文封装模式，将二层报文用三层协议进行封装，可实现二层网络在三层范围内进行扩展，同时满足数据中心大二层虚拟迁移和多租户的需求。</p>
<p>Vxlan 是一种无控制平面，利用底层 IP 网络实现二层通信的隧道技术。</p>
<p>GRE 也是无控制平面，不需要使用协议维护隧道状态。比如 LDP 是 LSP 的控制平面。</p>
<p>底层的 IP 网络称为 Underlay 网络，Vxlan 则称为 Overlayer 网络。</p>
<h2 id="名词解释"><a class="markdownIt-Anchor" href="#名词解释">#</a> 名词解释</h2>
<h3 id="nvo3-nve"><a class="markdownIt-Anchor" href="#nvo3-nve">#</a> NVO3 &amp; NVE</h3>
<p>NVO3 (Network Virtualization Over Layer 3), 基于三层 IP overlay 网络构建虚拟网络技术统称为 NVO3。运行 NVO3 的设备叫做 NVE (NetworkVirtualization Edge) ，它位于 overlay 网络的边界，实现二、三层的虚拟化功能。<strong>NVE 是执行 VXLAN 封装和接封装的设备</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223857131.png" alt="image-20230101223857131"></p>
<h3 id="vtep"><a class="markdownIt-Anchor" href="#vtep">#</a> VTEP</h3>
<p><strong>VXLAN 网络中的 NVE 以 VTEP 进行标识</strong>，VTEP (VXLAN Tunnel Endpoint，VXLAN 隧道端点)<br>
 每一个 NVE 至少有一个 VTEP，VTEP 使用 NVE 的 IP 地址表示<br>
两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所公用</p>
<p>VTEP 即标识设备，也标识 VXLAN 隧道，两个 VTEP 地址之间唯一的确定一条 VXLAN 隧道。所以 VTEP 的地址要求全网可达</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223916250.png" alt="image-20230101223916250" style="zoom: 80%;" /> 
<h3 id="vni"><a class="markdownIt-Anchor" href="#vni">#</a> VNI</h3>
<p>VNI - VXLAN 网络标识符</p>
<p><strong>VNI 是一种类似于 VLANID 的用户标示，一个 VNl 代表了一个租户</strong>，属于不同 VNI 的虚拟机之间不能直接进行二层通信。VXLAN 报文封装时，给 VNI 分配了足够的空间使其可以支持海量租户的隔离。</p>
<p>应用场景</p>
<p>虚拟机在同一网段需要互访的情景，在没有 VXLAN 是，只能在同一个物理机上。使用 VXLAN，可以去除网络限制，使资源分配</p>
<p>2 层 VPN：封装的对象是帧，VXLAN，TRILL，L2TP，PPTP，VPLS</p>
<p>3 层 VPN：封装的对象是包，IPSEC，GRE，DSVPN，MPLS VPN</p>
<p>ipsec vpn 隧道模式，3 层 vpn</p>
<p>ipsec vpn 传输模式，只封装 IP 之上的内容</p>
<p>应用层 VPN：SSL VPN</p>
<p>MPLS VPN：三层</p>
<p>VPLS：二层</p>
<h2 id="实验1同子网互访"><a class="markdownIt-Anchor" href="#实验1同子网互访">#</a> 实验 1: 同子网互访</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">LSW1 &amp; LSW2</span><br><span class="line">trunk - access </span><br><span class="line"></span><br><span class="line">CE1 &amp; CE2 &amp; CE3</span><br><span class="line">1.underlay</span><br><span class="line">配置物理接口&amp;环回口地址</span><br><span class="line">配置路由协议</span><br><span class="line">2.VXLAN业务接入配置</span><br><span class="line">配置BD域:BD域用于在NVE上本地区分不同的大二层网络，本地有效,没有全局意义，每一个BD域只能关联一个vni，在一台NVE上不同BD域需要关联不同VNI</span><br><span class="line">bridge-domain 10 </span><br><span class="line">VXLAN vni 10</span><br><span class="line">将vlanid和BD域关联，BD域又和vni关联</span><br><span class="line">int g1/0/0.10 mode l2</span><br><span class="line">encapsulation dot1q vid 10</span><br><span class="line">bridge-domain 10</span><br><span class="line">创建VXLAN隧道</span><br><span class="line">int nve 1</span><br><span class="line">source 2.2.2.2</span><br><span class="line">vin 10 head-end peer-list 3.3.3.3</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110110558492.png" alt="image-20230110110558492"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line">LSW1</span><br><span class="line">vlan batch 10 20 30 40</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/1</span><br><span class="line"> port link-type access</span><br><span class="line"> port default vlan 10</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/2</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/3</span><br><span class="line"> port link-type access</span><br><span class="line"> port default vlan 30</span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 2.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0.30 mode l2</span><br><span class="line"> encapsulation dot1q vid 30</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line"> </span><br><span class="line">CE3</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 30</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 3.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.40 mode l2</span><br><span class="line"> encapsulation dot1q vid 40</span><br><span class="line"> bridge-domain 30</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 3.3.3.3</span><br><span class="line"> vni 10 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 20 head-end peer-list 2.2.2.2</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111117399.png" alt="image-20230110111117399"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111302369.png" alt="image-20230110111302369"></p>
<p>数据帧在 CE2 通过子接口，MAC，BD 上形成 MAC 地址表</p>
<p>MAC-IN-UDP  通过封装 UDP 实现按照流的负载分担，Dport 4789</p>
<p>在 VXLAN 中，不关心主机所在 VXLAN，只要在同一网段即可实现</p>
<p>既可以实现网络虚拟化，将网络虚拟为两个不同的虚拟网络，租户之间网络隔离</p>
<p>此时逻辑拓扑变为虚拟交换机连接同一租户的不同设备</p>
<p>在公有云场景，为了适应虚拟机迁移的场景，使用 SDN 动态下发配置</p>
<p>VXLAN 头端复制</p>
<p>将 VXLAN 报文复制多份发给每一个当前 vni 中的 peer list</p>
<p>vxlan 网络对 BUM 报文的转发行为默认是头端复制   broadcast-unknown-Multicast</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111205055822.png" alt="image-20230111205055822"></p>
<p>VXLAN I flag: 必须置为 1，标识 VNI 字段有效。</p>
<p>UDP Dest Port: VXLAN 保留 UDP 目的端口号，默认为 4789</p>
<p>UDP Source Port: 根据数据流 HASH 动态生成。</p>
<p>不同流封装类型的接口对报文的处理方式</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111211200322.png" alt="image-20230111211200322"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111213612876.png" alt="image-20230111213612876"></p>
<p>一个物理接口下如果存在 default 接口，那么不能存在其他类型的接口</p>
<h2 id="实验二跨子网互通集中式网关"><a class="markdownIt-Anchor" href="#实验二跨子网互通集中式网关">#</a> 实验二：跨子网互通（集中式网关）</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">CE1作为网关</span><br><span class="line">bridge-domain 10</span><br><span class="line"></span><br><span class="line">bridge-domain 20</span><br><span class="line"></span><br><span class="line">int vbdif 10</span><br><span class="line">ip add 192.168.1.254 24 </span><br><span class="line">int vbdif 20</span><br><span class="line">ip add 192.168.2.254 24 </span><br><span class="line"></span><br><span class="line">CE2 - CE1 建立VXLAN </span><br><span class="line">int nve 1</span><br><span class="line">vni 10 head peer 1.1.1.1</span><br><span class="line">vni 20 head peer 1.1.1.1 </span><br><span class="line">CE3 - CE1 建立VXLAN</span><br><span class="line">int nve 1</span><br><span class="line">vni 10 head peer 1.1.1.1</span><br><span class="line">vni 20 head peer 1.1.1.1 </span><br><span class="line"></span><br><span class="line">int nv1 </span><br><span class="line">vni 10 head peer 2.2.2.2 3.3.3.3</span><br><span class="line">vni 20 head peer 2.2.2.2 3.3.3.3</span><br><span class="line"></span><br><span class="line">主机网关设置vdbif接口地址</span><br><span class="line"></span><br><span class="line">对于多租户在网关上使用ip vpn-instance 实现</span><br><span class="line"></span><br><span class="line">ip vpn-instance A</span><br><span class="line">route-dist 1:1</span><br><span class="line"></span><br><span class="line">int vbdif 10 </span><br><span class="line">ip binding vpn-instance 10</span><br><span class="line">ip add </span><br><span class="line"></span><br><span class="line">int vbdif 20 </span><br><span class="line">ip binding vpn-instance 10</span><br><span class="line">ip add </span><br><span class="line"></span><br><span class="line">对于每一个租户分配一个VPN-instance </span><br><span class="line"></span><br><span class="line">对于普通的vlan网络，设置接口类型，vlanif接口，即可实现vlan与VXLAN互通</span><br><span class="line"></span><br><span class="line">对于需要访问外网的场景</span><br><span class="line">将VPN-instance中的路由泄露到public中，在VPN-instance中添加了一条静态路由</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0 10.1.11.10 public</span><br><span class="line"></span><br><span class="line">注意回包路由</span><br><span class="line">1.将租户路由引回私网中</span><br><span class="line">ip route-static 192.168.1.1 24 10.1.11.1</span><br><span class="line">2.将public泄露到vpn中,public中会有一下一跳为VPN-instance的路由，迭代到出接口vbdif </span><br><span class="line">ip route-static 192.168.1.0 24 vpn-instance A 192.168.1.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">要求</span><br><span class="line">1.对于同一租户，同子网和跨子网互通</span><br><span class="line">2.vlan和VXLAN互通</span><br><span class="line">3.VXLAN中租户和公网互通</span><br><span class="line">4.CE1旁挂防火墙，实现路由隔离，nat在fw上，租户互通通过fw</span><br></pre></td></tr></table></figure>
<p>网络虚拟化，对于租户来说，只消耗 vni 和直连路由</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112221742698.png" alt="image-20230112221742698"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112224309888.png" alt="image-20230112224309888"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line">CE1</span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 1:1</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vbdif20</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.2.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vlanif30</span><br><span class="line"> ip address 192.168.3.254 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.11.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/3</span><br><span class="line"> undo shutdown</span><br><span class="line"> port default vlan 30</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 2.2.2.2</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 vpn-instance A 192.168.1.1</span><br><span class="line">ip route-static 192.168.2.0 255.255.255.0 vpn-instance A 192.168.2.1</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 10.1.11.2 public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">vlan batch 10 20</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">bridge-domain 20</span><br><span class="line"> vxlan vni 20</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 2.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.12.2 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.10 mode l2</span><br><span class="line"> encapsulation dot1q vid 10</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1.20 mode l2</span><br><span class="line"> encapsulation dot1q vid 20</span><br><span class="line"> bridge-domain 20</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 2.2.2.2</span><br><span class="line"> vni 10 head-end peer-list 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line"> vni 20 head-end peer-list 1.1.1.1</span><br><span class="line"> vni 20 head-end peer-list 3.3.3.3</span><br><span class="line"> </span><br><span class="line">AR1</span><br><span class="line">acl number 2000  </span><br><span class="line"> rule 5 permit source 192.168.1.0 0.0.0.255 </span><br><span class="line"> rule 10 permit source 192.168.2.0 0.0.0.255 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 10.1.11.2 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet0/0/1</span><br><span class="line"> ip address 10.1.21.1 255.255.255.0 </span><br><span class="line"> nat outbound 2000</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 10.1.21.2</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 10.1.11.1</span><br><span class="line">ip route-static 192.168.2.0 255.255.255.0 10.1.11.1</span><br></pre></td></tr></table></figure>
<p>两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所共用。</p>
<p>VXLAN 二层网关：允许租户接入 VxLAN 网络，实现相同 VxLAN 内部流量互访。</p>
<p>VxLAN L3 Gateway: 实现不同 VxLAN 直接互访，或者 VxLAN 与非 VxLAN 网络互访。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114212602424.png" alt="image-20230114212602424"></p>
<p>L2-Subif: 用于用户接入，子接口上可以配置一层 tag 接入或者不配置 tag 接入；</p>
<p>BD (Bridge-Domain): 标识一个二层广播域，BD 和 VNI 1:1 映射。所有广播域功能基于 BD 支持，如 MAC 学习、二层查表、广播复制等；</p>
<p>NVE (Network Virtualization Edge): 主要用于本地 VTEP 地址管理，VXLAN 隧道管理，头端复制列表管理；</p>
<p>VXLAN 隧道: VXLAN 隧道用于 VXLAN 报文的转发，用本地 VTEP 地址 + 远端 VTEP 地址标识﹔</p>
<p>BDIF:BD 域的三层路由接口，用于二层流量进入三层进行路由转发；</p>
<p>bridge-domain 20</p>
<p>L2 binding vlan 10  // 全局关联 vlan 端口到 BD 域中</p>
<p>VLAN 绑定 BD 后，该 BD 不支持创建对应的 VBDIF 接口。同时不支持创建该 VLAN 对应的 VLANIF 接口。</p>
<p>VLAN 绑定 BD 功能和 ARP 广播报文抑制功能互斥，配置 VLAN 为 VXLAN 业务接入点后，不建议再使能 ARP 广播报文抑制功能</p>
<p>ARP 广播抑制：抑制后续的 ARP 广播报文，由于首包之后 CE 上已经有了 arp 请求的主机的位置，只需要单播请求即可。arp 广播请求变 arp 单播请求</p>
<p>第一次虚拟化：利用隧道技术将边缘设备互连透传二层报文；整网抽象理解成一台端口数目扩展的超大 LAN switch。</p>
<p>第二次虚拟化利用 VNI 将这台超大的交换机虚拟出多个二层的广播域，和 VLAN 本质是一样的，VNI 类比 VLANID. 并通过定义 VXLAN header 中的 VNI 字段，将子网范围由 4K 扩展至 16M。</p>
<p>vxlan 主要优点</p>
<p>基于 IP 的 overlay, 仅需要边界设备间 IP 可达。</p>
<p>隧道间水平分割、IP overlay TTL 避免环路。 网络层收到的 VXLAN 报文只能发给用户侧</p>
<p>数据流量基于 IP 路由 SPF 及 ECMP 快速转发。</p>
<p>网络变化实时侦听全网拓扑毫秒收敛</p>
<p>Overlay+VNI 构建虚拟网络，支持多达 16M 的虚拟网络。</p>
<p>物理设备、vSwitch 均能够部署。CE1800V 软件交换机也能做 VXLAN</p>
<p>VXLAN 同子网互访模型</p>
<p>1. 同一 OVS 之间</p>
<p>2. 不同 OVS 之间</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191207957.png" alt="image-20230122191207957"></p>
<p>3. 不同 tor 之间</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191226332.png" alt="image-20230122191226332"></p>
<p>VXLAN 不同子网护网</p>
<p>集中式网关</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191735252.png" alt="image-20230122191735252"></p>
<p>1. 流量迂回</p>
<p>2. 网关 arp 表项过多可能成为网络瓶颈</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192007255.png" alt="image-20230122192007255"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192117780.png" alt="image-20230122192117780"></p>
<p>VXLAN 基于 spine-leaf 组网架构</p>
<p>胖树</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192248454.png" alt="image-20230122192248454"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122193919103.png" alt="image-20230122193919103"></p>
<p>spine 和网关分离部署，解决集中式网关容量问题</p>
<p>spine 和网关融合部署</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122194413496.png" alt="image-20230122194413496"></p>
<p>集中式网关场景下网关双活</p>
<p>华为最多支持四台做多活，但只提高转发效率，不提高表项</p>
<p>表项通过 DFS 同步</p>
<p>需要通过双活组做网关扩容</p>
<p>多活网关需要 VTEP 一样</p>
<p>CE 模拟器基于包做负载分担</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195628679.png" alt="image-20230122195628679"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195938635.png" alt="image-20230122195938635"></p>
<p>集中式网关特点</p>
<p>1. 流量存在迂回现象</p>
<p>2. 网关需要维护主机的 mac 地址信息和 arp 信息，对设备表项容量要求高，容易遇到瓶颈</p>
<p>3. 网关容易存在单点故障</p>
<p>4. 跨子网的流量都由网关来完成，流量有明显控制点，网关维护用户路由信息，MAC 地址，ARP 表项，VXLAN 隧道路由</p>
<p>leaf 只需要维护 MAC 地址信息和 VXLAN 隧道的路由信息，无需维护用户的路由信息</p>
<p>第一个和第二三个问题可以采用分布式网关解决</p>
<p>第三个问题可以使用双活网关解决</p>
<p>如果非要用集中式网关</p>
<p>1. 第一个问题无法解决</p>
<p>2. 第二个问题采用多组网关解决容量问题</p>
<p>3. 第三个问题采用多活网关</p>
<p>集中式网关有网关和 spine 融合组网  适用业务稳定，规模稳定的私有云</p>
<p>网关和 spine 分离组网    适用于业务变更频繁业务规模可以弹性伸缩的时候，中大型公有云和私有云</p>
<h2 id="集中式双活网关过墙"><a class="markdownIt-Anchor" href="#集中式双活网关过墙">#</a> 集中式双活网关过墙</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123214500930.png" alt="image-20230123214500930"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">网关上创建互联vlan</span><br><span class="line">一个vlan绑定到用户的VPN-instance中，用于和用户的vfw实现三层互连</span><br><span class="line">一个vlan绑定到public中，和root防火墙实现三层互联，此链路所有租户共享</span><br><span class="line"></span><br><span class="line">fw上创建互联vlan</span><br><span class="line">一个vlan关联到租户的虚墙，实现和租户在gw上的VPN-instance对接</span><br><span class="line">一个vlan关联root防火墙和gw的public对接</span><br><span class="line"></span><br><span class="line">gw</span><br><span class="line">vlan 10</span><br><span class="line">des vpn A</span><br><span class="line"></span><br><span class="line">vlan 20</span><br><span class="line">des public </span><br><span class="line"></span><br><span class="line">int g1/0/1</span><br><span class="line">p l t </span><br><span class="line">p t a v a </span><br><span class="line"></span><br><span class="line">int vlanif 10</span><br><span class="line">ip add 192.168.10.1 24 </span><br><span class="line">ip bing vpn A</span><br><span class="line"></span><br><span class="line">int vlan 20 </span><br><span class="line">ip add 192.168.20.1 24 </span><br><span class="line"></span><br><span class="line">ip route vpn A 0.0.0.0 0 192.168.10.10</span><br><span class="line"></span><br><span class="line">ip rou 0.0.0.0 0 192.168.30.1</span><br><span class="line"></span><br><span class="line">ip rou 202.1.1.0 24 192.168.20.20</span><br><span class="line"></span><br><span class="line">fw</span><br><span class="line">vlan 10 20</span><br><span class="line">int g1/0/0</span><br><span class="line">portswitch</span><br><span class="line">p l t</span><br><span class="line">p t a v a </span><br><span class="line"></span><br><span class="line">vsys enable</span><br><span class="line">vsys name A</span><br><span class="line">assign vlan 10</span><br><span class="line">int vlanif 10 </span><br><span class="line">ip add 192.168.10.10 24 </span><br><span class="line">service pin p</span><br><span class="line">switch vsys A</span><br><span class="line">firewall zone trust</span><br><span class="line">add interface vlanif 10</span><br><span class="line">//华为NGFW默认出厂存在一个virtual-if0，它属于root的一个逻辑接口，用于和虚拟fw的virtual-if接口实现通信</span><br><span class="line">在创建vfw时，也会为vfw自动创建一个virtual-if接口，接口号设备自行分配</span><br><span class="line">Firewall zone untrust </span><br><span class="line">add inter vitural-if 1</span><br><span class="line"></span><br><span class="line">firewall zone trust  </span><br><span class="line">add inter vit 0</span><br><span class="line"></span><br><span class="line">int vlan 20</span><br><span class="line">ip add 192.168.20.20  24 </span><br><span class="line">service pin p</span><br><span class="line">firewall zon un </span><br><span class="line">add int vlan 20</span><br><span class="line"></span><br><span class="line">switch vsys A </span><br><span class="line">ip route-static 192.168.1.0 24 192.168.10.1</span><br><span class="line">security-po </span><br><span class="line">ru name test </span><br><span class="line">trust-&gt;untrust</span><br><span class="line">sourece 192.168.1.0 </span><br><span class="line">ac pe</span><br><span class="line">ip route 0.0.0.0 0 public</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">security-policy </span><br><span class="line">def ac per</span><br><span class="line">ip route 0.0.0.0 0 192.168.20.1</span><br><span class="line"></span><br><span class="line">nat add A</span><br><span class="line">section 202.1.1.1 202.1.1.10</span><br><span class="line"></span><br><span class="line">vsys name A</span><br><span class="line">assign global 202.1.1.1 202.1.1.10 free</span><br><span class="line"></span><br><span class="line">switch vsys A </span><br><span class="line">nat add A</span><br><span class="line">sec 202.1.1.1 202.1.1.3</span><br><span class="line">nat-policy </span><br><span class="line">ru name A</span><br><span class="line">source-zon  t</span><br><span class="line">de un</span><br><span class="line">source 192.168.1.0 24 </span><br><span class="line">ac so add A </span><br><span class="line"></span><br><span class="line">ip rou 202.1.1.0 28 vpn A</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R1</span><br><span class="line">ip rou 202.1.1.0 24 192.168.30.1</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123211745121.png" alt="image-20230123211745121"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">//1.网关双活</span><br><span class="line">[CE1]dis cu </span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> mac-address 5489-9825-6da0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[CE3]dis cu </span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 1</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.23.3 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo shutdown</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2.10 mode l2</span><br><span class="line"> encapsulation untag</span><br><span class="line"> bridge-domain 10</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 3.3.3.3</span><br><span class="line"> vni 10 head-end peer-list 1.1.1.1</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 3.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">//网关双活过墙</span><br><span class="line">[CE1]di cu </span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">ip vpn-instance A</span><br><span class="line"> ipv4-family</span><br><span class="line">  route-distinguisher 100:1</span><br><span class="line">#</span><br><span class="line">vlan 10</span><br><span class="line"> description VPN-instance  A</span><br><span class="line">#</span><br><span class="line">bridge-domain 10</span><br><span class="line"> vxlan vni 10</span><br><span class="line">#</span><br><span class="line">interface Vbdif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.1.254 255.255.255.0</span><br><span class="line"> mac-address 5489-9825-6da0</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface Vlanif20</span><br><span class="line"> description public</span><br><span class="line"> ip address 192.168.20.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/0</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 10.1.13.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface GE1/0/1</span><br><span class="line"> undo shutdown</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">interface GE1/0/2</span><br><span class="line"> undo portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> ip address 192.168.30.1 255.255.255.0</span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.255</span><br><span class="line">#</span><br><span class="line">interface Nve1</span><br><span class="line"> source 1.1.1.1</span><br><span class="line"> vni 10 head-end peer-list 3.3.3.3</span><br><span class="line">#</span><br><span class="line">rip 1</span><br><span class="line"> version 2</span><br><span class="line"> network 1.0.0.0</span><br><span class="line"> network 10.0.0.0</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 192.168.30.30</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.0 192.168.20.20</span><br><span class="line">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 192.168.10.10</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[USG6000V1]dis cu </span><br><span class="line">vlan batch 10 20 30</span><br><span class="line">#</span><br><span class="line">vsys enable</span><br><span class="line">#</span><br><span class="line">vsys name A 1</span><br><span class="line"> assign vlan 10</span><br><span class="line"> assign global-ip 201.1.1.1 202.1.1.10 free</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.10 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface Vlanif20</span><br><span class="line"> ip address 192.168.20.20 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">interface GigabitEthernet1/0/0</span><br><span class="line"> portswitch</span><br><span class="line"> undo shutdown</span><br><span class="line"> port link-type trunk</span><br><span class="line"> port trunk allow-pass vlan 2 to 4094</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface GigabitEthernet0/0/0</span><br><span class="line"> add interface Virtual-if0</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Vlanif20</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 192.168.20.1</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.240 vpn-instance A</span><br><span class="line">#</span><br><span class="line">security-policy</span><br><span class="line"> default action permit</span><br><span class="line"> rule name test</span><br><span class="line">#</span><br><span class="line">switch vsys A</span><br><span class="line">#</span><br><span class="line">interface Vlanif10</span><br><span class="line"> ip binding vpn-instance A</span><br><span class="line"> ip address 192.168.10.10 255.255.255.0</span><br><span class="line"> service-manage ping permit</span><br><span class="line">#</span><br><span class="line">firewall zone trust</span><br><span class="line"> set priority 85</span><br><span class="line"> add interface Vlanif10</span><br><span class="line">#</span><br><span class="line">firewall zone untrust</span><br><span class="line"> set priority 5</span><br><span class="line"> add interface Virtual-if1</span><br><span class="line">#</span><br><span class="line">nat address-group A 0</span><br><span class="line"> mode pat</span><br><span class="line"> section 0 202.1.1.1 202.1.1.3</span><br><span class="line">#</span><br><span class="line">security-policy</span><br><span class="line"> rule name test</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  action permit</span><br><span class="line">#</span><br><span class="line">nat-policy</span><br><span class="line"> rule name A</span><br><span class="line">  source-zone trust</span><br><span class="line">  destination-zone untrust</span><br><span class="line">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class="line">  action source-nat address-group A</span><br><span class="line">#</span><br><span class="line">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class="line">ip route-static 192.168.1.0 255.255.255.0 192.168.10.1</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[R1]dis cu</span><br><span class="line">[V200R003C00]</span><br><span class="line">interface GigabitEthernet0/0/0</span><br><span class="line"> ip address 192.168.30.30 255.255.255.0 </span><br><span class="line">#</span><br><span class="line">interface LoopBack0</span><br><span class="line"> ip address 8.8.8.8 255.255.255.255 </span><br><span class="line">#</span><br><span class="line">ip route-static 202.1.1.0 255.255.255.0 192.168.30.1</span><br></pre></td></tr></table></figure>
<h2 id="evpn"><a class="markdownIt-Anchor" href="#evpn">#</a> EVPN</h2>
<p>EVPN 作为数据中心 VXLAN 技术的控制平面，转发平面还是采用 VXLAN 对数据进行封装</p>
<p>EVPN 支持集中式网关组网，也支持分布式网关组网</p>
<p>EVPN 在数据中心实现同子网互访和跨子网互访</p>
<p>为了在数据中心支持 VXLAN。EVPN 在 BGP 协议的基础上新增了一种 NLRI，称为 EVPN NLRI</p>
<p>EVPN NLRI 定义了三种路由信息</p>
<p>1.type 2 路由称为 MAC/IP 路由，根据不同的作用，也称为 ARP 路由 / IRB 路由（IRB  集成的路由与桥接），用于</p>
<p>@数据中心支持 ARP 广播抑制</p>
<p>@动态虚拟机迁移</p>
<p>@虚拟机主机路由的发布，实现跨子网互访</p>
<p>2.type 3 路由，称为集成组播路由，用于在 VTEP 之间动态建立 VXLAN 隧道，并动态实现头端复制列表的生成，用于支持 BUM 报文的转发</p>
<p>3.type 5 路由，称为前缀路由，常用于将数据中心外部路由引入到各租户的 VPN-instance 中，实现数据中心内部访问外部</p>
<p>另外标准的 EVPN 协议还定义了 type 1 的路由</p>
<p>type 1 路由 Ethernet AD Route    (auto discovery)</p>
<p>双归场景下用于防环快速收敛，别名</p>
<p>type 4 路由，Ethernet Segment Route</p>
<p>双归场景下用于实现 DF 的选举和执行负载分担的维护</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">//CE1-CE4之间建立EVPN邻居</span><br><span class="line">CE1</span><br><span class="line">evpn-overlay enable </span><br><span class="line">bgp 100</span><br><span class="line">peer 2.2.2.2 as 100</span><br><span class="line">peer 2.2.2.2 con l 0 </span><br><span class="line">peer 3.3.3.3</span><br><span class="line">peer 4.4.4.4</span><br><span class="line">l2vpn-fa evpn </span><br><span class="line">peer 2.2.2.2 enable</span><br><span class="line">peer 2.2.2.2 re</span><br><span class="line">peer 3.3.3.3 </span><br><span class="line">peer 4.4.4.4</span><br><span class="line">peer 2.2.2.2 ad arp</span><br><span class="line">peer 3.3.3.3 ad arp</span><br><span class="line">peer 4.4.4.4 ad arp</span><br><span class="line">undo p v</span><br><span class="line"></span><br><span class="line">CE2</span><br><span class="line">evpn-overlay enable </span><br><span class="line">bgp 100</span><br><span class="line">peer 1.1.1.1 as 100</span><br><span class="line">peer 1.1.1.1 con l 0 </span><br><span class="line">l2vpn-fa evpn </span><br><span class="line">peer 1.1.1.1 en</span><br><span class="line">peer 1.1.1.1 ad arp</span><br><span class="line"></span><br><span class="line">dis bgp evpn peer </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CE2-CE3-CE4</span><br><span class="line">BD 10</span><br><span class="line">vx  10</span><br><span class="line">evpn</span><br><span class="line">router- 100:1</span><br><span class="line">vpn-t 100:1 b</span><br><span class="line"></span><br><span class="line">int g1/0/1.10 </span><br><span class="line">bd 10</span><br><span class="line">enca 10</span><br><span class="line">//EVPN实例中本地的每个BD域都可以看成是一个独立的EVPN实例，一个二层的广播域</span><br><span class="line"></span><br><span class="line">int Nve1</span><br><span class="line">source 2.2.2.2</span><br><span class="line">vni 10 head peer pro bgp    //type3</span><br><span class="line">dis bgp evpn rout in 0:32:2.2.2.2</span><br><span class="line"></span><br><span class="line">CE4</span><br><span class="line">int vbdif 10</span><br><span class="line">ip add 192.168.1.254 24 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">没有反射器的场景需要在所有节点建立全互联EVPN</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>Type3 路由 ——Inclusive Multicast 路由</strong><br>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212349933.png" alt="image-20230125212349933"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212635735.png" alt="image-20230125212635735"></p>
<p>还会携带 ERT，不在 EVPN 中，在 BGP 中，用于设置感兴趣路由</p>
<p>1. 对方收到 type3 路由后，比较 RT 是否匹配，如果匹配则接收该 type3 的路由</p>
<p>2. 提取 type3 中 org router ip (VTEP 地址) ，如果该地址路由可达，则创建 VXLAN 隧道</p>
<p>3. 提取 PMSI 属性中二层 VNI 值，看是否和本端 EVPN 实例中的相同，如果相同则将 PSMI 中携带的 VTEP 地址添加到 VXLAN 隧道的头端复制列表中</p>
<p>如果希望在 EVPN 邻居之间传递 type2 的路由，需要 peer 1.1.1.1 ad arp</p>
<p>mac route 实现 vm 之间二层互访，需再 EVPN 邻居之间传递 Mac route</p>
<p>mac route 特征，携带 RD+MAC + 二层 VNI</p>
<p>为了支持 ARP 广播抑制和虚拟机热迁移，需要在 EVPN 邻居之间传递 ARP 路由的路由</p>
<p>传递 IRB peer 1.1.1.1 ad irb</p>
<p><strong>Type2 路由 ——MAC/IP 路由</strong></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212428010.png" alt="image-20230126212428010"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212535678.png" alt="image-20230126212535678"></p>
<p>arp 路由的特征：携带 RD+MAC+IP + 二层 VNI</p>
<p>irb 类型的特征：携带 RD+MAC+IP + 二层 VNI + 三层 VNI，irb 类型的路由也具备 arp 类型路由的功能</p>
<p>什么时候发送 ARP 类型的路由，集中式网关部署时发送 ARP 类型的路由即可</p>
<p>什么时候发送 IRB 类型的路由，分布式网关一定要发送 IRB 类型的路由</p>
<p>当邻居之间发布 arp 路由命令后，设备会将用户侧学到主机的 IP+MAC 信息通过 arp 类型的路由发送给 evpn 邻居</p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-01-27 12:07:41" itemprop="dateModified" datetime="2023-01-27T12:07:41+08:00">2023-01-27</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/01/20/VXLAN/" title="VXLAN">http://example.com/2023/01/20/VXLAN/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;mw690&#x2F;6833939bly1gicliierfjj20zk0m8npd.jpg" title="水滴rev">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 逆向</span>
  <h3>水滴rev</h3>
  </a>

    </div>
    <div class="item right">
    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#vxlan"><span class="toc-number">1.</span> <span class="toc-text"> VXLAN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#enspvirtualbox%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> ensp&amp;virtualbox 设置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vxlan-2"><span class="toc-number">1.2.</span> <span class="toc-text"> VXLAN</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8D%E8%AF%8D%E8%A7%A3%E9%87%8A"><span class="toc-number">1.3.</span> <span class="toc-text"> 名词解释</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#nvo3-nve"><span class="toc-number">1.3.1.</span> <span class="toc-text"> NVO3 &amp; NVE</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vtep"><span class="toc-number">1.3.2.</span> <span class="toc-text"> VTEP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#vni"><span class="toc-number">1.3.3.</span> <span class="toc-text"> VNI</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C1%E5%90%8C%E5%AD%90%E7%BD%91%E4%BA%92%E8%AE%BF"><span class="toc-number">1.4.</span> <span class="toc-text"> 实验 1: 同子网互访</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C%E4%BA%8C%E8%B7%A8%E5%AD%90%E7%BD%91%E4%BA%92%E9%80%9A%E9%9B%86%E4%B8%AD%E5%BC%8F%E7%BD%91%E5%85%B3"><span class="toc-number">1.5.</span> <span class="toc-text"> 实验二：跨子网互通（集中式网关）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9B%86%E4%B8%AD%E5%BC%8F%E5%8F%8C%E6%B4%BB%E7%BD%91%E5%85%B3%E8%BF%87%E5%A2%99"><span class="toc-number">1.6.</span> <span class="toc-text"> 集中式双活网关过墙</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#evpn"><span class="toc-number">1.7.</span> <span class="toc-text"> EVPN</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">22</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">5</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/01/03/%E6%BB%B4%E6%B0%B4reverse/" title="水滴rev">水滴rev</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/12/25/%E5%86%85%E7%BD%91/" title="内网渗透">内网渗透</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/31/webshell/" title="webshell">webshell</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%A7%8B%E6%8B%9B/" title="In 秋招">秋招</a>
</div>

    <span><a href="/2022/10/28/%E7%A7%8B%E6%8B%9B%E9%9D%A2%E8%AF%95%E9%A2%98/" title="秋招面试题">秋招面试题</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/01/%E6%B1%87%E7%BC%96/" title="汇编">汇编</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/17/JWT%20%E5%9F%BA%E7%A1%80/" title="JWT">JWT</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/01/20/VXLAN/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
