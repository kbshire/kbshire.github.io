{
    "version": "https://jsonfeed.org/version/1",
    "title": "Hexo • All posts by \"网络\" category",
    "description": "",
    "home_page_url": "http://example.com",
    "items": [
        {
            "id": "http://example.com/2023/09/01/border%20leaf/",
            "url": "http://example.com/2023/09/01/border%20leaf/",
            "title": "从三层架构到spine leaf",
            "date_published": "2023-09-01T05:38:45.000Z",
            "content_html": "<h1 id=\"从三层架构到spine-leaf\"><a class=\"markdownIt-Anchor\" href=\"#从三层架构到spine-leaf\">#</a> 从三层架构到 spine leaf</h1>\n<p>为了应付一些数据中心客户购买 waf 的需求，因此在这里记录一下一种数据中心组网。</p>\n<p>客户采用的组网图如下：两台 waf 是准备放在 fw 所在的 service leaf 中，但是存在问题，后续会更新组网图</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230905221001563.png\" alt=\"image-20230905221001563\"></p>\n<h2 id=\"传统三层架构\"><a class=\"markdownIt-Anchor\" href=\"#传统三层架构\">#</a> 传统三层架构</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230905221134755.png\" alt=\"image-20230905221134755\"></p>\n<p>这种架构由核心路由器、聚合路由器（有时叫分发路由器，distribution routers  ）和接入交换机组成。在接入交换机和聚合路由器之间运行生成树协议（Spanning Tree  Protocol，STP），以保证网络的二层部分（L2）没有环路。STP 有许多好处：简单，  即插即用（plug-and-play），只需很少配置。每个 pod 内的机器都属于同一个 VLAN， 因此服务器无需修改 IP  地址和网关就可以在 pod 内部任意迁移位置。但是，STP 无法 使用并行转发路径（parallel forwarding  path），它永远会禁用 VLAN 内的冗余路径。</p>\n<p>核心层：核心层是网络的高速交换主干，对整个网络的连通起到至关重要的作用。核心层应该具有如下几个特性：可靠性、高效性、冗余性、容错性、可管理性、适应性、低延时性等。在核心层中，应该采用高带宽的千兆以上交换机。因为核心层是网络的枢纽中心，重要性突出。核心层设备采用双机冗余热备份是非常必要的，也可以使用负载均衡功能，来改善网络性能。</p>\n<p>汇聚层：汇聚层是网络接入层和核心层的 “中介”，就是在工作站接入核心层前先做汇聚，以减轻核心层设备的负荷。汇聚层具有实施策略、安全、工作组接入、虚拟局域网（VLAN）之间的路由、源地址或目的地址过滤等多种功能。在汇聚层中，应该选用支持三层交换技术和 VLAN 的交换机，以达到网络隔离和分段的目的。</p>\n<p>接入层：接入层向本地网段提供工作站接入。在接入层中，减少同一网段的工作站数量，能够向工作组提供高速带宽。接入层可以选择不支持 VLAN 和三层交换技术的普通交换机。</p>\n<p>并且在这种组网中如果预算有限可以使用二层交换机作为接入层交换机减少预算，在关键的核心选择性能较高的设备加速转发。现网中大量运用三层交换机，三层交换机也可以作为出口设备，代替了很多路由器的功能。但是要注意：路由器的交换机是有本质区别的！</p>\n<p>在不同 vlan 互访的时候涉及到网关的规划。网关可以选择放在核心，汇聚，甚至接入都可以。网关放在不同的地方有不同的好处，比如放在汇聚或接入可以减少流量迂回。放在 core 上会产生大量的 arp 表项导致网络瓶颈等。</p>\n<p>三层架构优点：采用三层架构，可以在不同层做不同的规划，比如汇聚层做安全策略等，并且可以实现各层的冗余，使网络的安全性和可靠性大幅增加。stp 可以防止广播风暴，可以节约一定的成本，具有一定的扩展性。比如最开始说到的 waf 的案例，我们就可以选择在核心或者汇聚旁挂，做反向代理访问后端 web server。</p>\n<p>缺点：stp 永远会阻塞一条冗余链路，这在数据中心中 10G 甚至更高的带宽的场景下这种阻塞对链路带宽浪费是巨大的。对于东西向流量 (稍后会在 spine-leaf 中提及) 会产生传输瓶颈，因为经过了大量的多余节点，会产生非常明显的性能衰减。</p>\n<p>使用场景：校园网，比如掀石油大学采用的就是三层架构。将接入直接连接同学的电脑，汇聚和接入放在每幢楼的机房，在学校 xx 位置有一个核心机房放置核心层交换机。企业网，便于管理</p>\n<p>一些提供冗余的技术：VRRP (HSRP) Etrunk 链路捆绑 堆叠  双电源</p>\n<h2 id=\"spine-leaf\"><a class=\"markdownIt-Anchor\" href=\"#spine-leaf\">#</a> spine-leaf</h2>\n<p>早期数据中心的流量有 80% 为横向（east-west，南北）流量，随着云计算、分布式架构的发展，现在已经转变为 70%  为纵向（north-south，东西）流量</p>\n<p>随着云计算的到来，越来越丰富的业务对数据中心的流量模型产生了巨大的冲击，如搜索、并行计算等业务，需要大量的服务器组成集群系统，协同完成工作，这导致服务器之间的流量变得非常大。比如搜索，用户只是发出一个搜索指令，服务器集群就在海量数据面前进行搜索与计算，这个过程是非常复杂的，而只是将结果传递给用户。早期数据中心主要满足外部对数据中心的访问，所以流量就以 “南北” 为主。这种流量模型受到了出口带宽的限制，一般的数据中心访问都会存在收敛比，即网络接入带宽比较大，而出口带宽比较小，访问的速度无法提升，在业务高峰期时，用户访问数据中心的体验感下降，这种网络模型已经不适应现今数据中心的发展需要。三层架构的另一个问题是服务器到服务器延迟（server-to-server latency）随着流量路 径的不同而不同。</p>\n<p>针对以上问题，提出了一种新的数据中心设计，称作基于 Clos 网络的 Spine-and-Leaf 架 构（Clos network-based Spine-and-Leaf architecture）。事实已经证明，这种架构可 以提供高带宽、低延迟、非阻塞的服务器到服务器连接。</p>\n<h3 id=\"一些概念\"><a class=\"markdownIt-Anchor\" href=\"#一些概念\">#</a> 一些概念</h3>\n<p><strong>流量方向</strong></p>\n<p>东西流量指的就是横向流量 ------- 例如：服务器与服务器之间交换流量</p>\n<p>南北流量指的就是纵向流量 ------- 例如：客户端和服务器之间的流量</p>\n<p>跨数据中心流量：不同数据中心的流量，例如数据中心之间的灾备，私有云和公有云之间的通讯。</p>\n<p><strong>leaf 种类</strong></p>\n<p>Leaf 分为三类：在设计的时候就要区分</p>\n<p>server leaf     应用       （连接服务器这些）</p>\n<p>service leaf   增值服务（连接防火墙这些）</p>\n<p>border leaf    边界       （连接路由器这些）— 可以去外网，也可以去另一个内网（另一个数据中心）</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/3b7f1262fd704fc4966335f3a3e9b495.png\" alt=\"img\"></p>\n<p><strong>Fabric</strong>：物理设备组成的网络，一般就指一个数据中心网络</p>\n<p>​       Fabric 扩展（多个 Fabric 通过核心交换机连接在一起）</p>\n<p>​       多个小的数据中心，通过一个逻辑的大二层组成一个数据中心</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/aa3132a9835340f181316de7449cd9af.png\" alt=\"img\"></p>\n<p><strong>收敛比</strong></p>\n<p>通常的，使用一个网络架构中的所有南向 (下行）接口的总带宽比上所有北向 (上行) 接口的总带宽来表示。</p>\n<p><strong>vpc</strong></p>\n<p>VPC（Virtual Port Channel）是思科网络设备中的一项技术，它允许两台交换机（通常是核心交换机）之间形成一个逻辑的端口通道，并将它们看作是一台逻辑交换机，再连接到其他设备。其他设备包括：Nexus 2000 系列的 Fabric  Extender（后文暂且翻译为结构扩展器），交换机，服务器等其他任何的网络设备。vPC 技术可以提供二层的多路径选择，让用户可以在有多条可选路径的情况下增加网络冗余度，同时实现提升带宽、在多个节点之间启用多条并行路径和对流量进行负载均衡。VPC 技术能够提高网络可靠性和可用性，同时还可以提供更好的性能和灵活性。</p>\n<p>使用 VPC 技术时，两台交换机之间需要配置一个双向的 peer-link 通道，peer-link 通道可以使用多个物理接口进行绑定。vPC 域内包含 vPC 端设备，vPC 对端 keepalive 链路，vPC 对端互联链路，以及所有在 vPC 域下的 PortChannel。每个 VPC 域内，可以将多个物理接口绑定成一个逻辑的 VPC 端口通道，以提供更高的带宽和可靠性。VPC 端口通道会同时连接到两台交换机上，但只会使用其中一台交换机进行数据传输，这样可以避免网络中出现环路。</p>\n<p>在 VPC 技术中，交换机之间会同步 MAC 地址、VLAN 信息等状态信息，以保证网络的一致性和可用性。此外，VPC 技术还提供了一些高可用性的功能，例如 peer-gateway 和 peer-switch 等，以保证在交换机发生故障时可以快速地切换到备用交换机上，保证网络的可靠性和连通性。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230905224024717.png\" alt=\"image-20230905224024717\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/v2-05fe95c7e89f30361e8fe63abc8d825b_720w.webp\" alt=\"img\"></p>\n<h3 id=\"spine-leaf架构\"><a class=\"markdownIt-Anchor\" href=\"#spine-leaf架构\">#</a> spine-leaf 架构</h3>\n<p>在以上两级 Clos 架构中，每个低层级的交换机（leaf）都会连接到每个高层级的交换机 （spine），形成一个 full-mesh  拓扑。leaf 层由接入交换机组成，用于连接服务器等 设备。spine 层是网络的骨干（backbone），负责将所有的 leaf 连接起来。  fabric 中的每个 leaf 都会连接到每个 spine，如果一个 spine 挂了，数据中心的吞吐性 能只会有轻微的下降（slightly degrade）。</p>\n<p>如果某个链路被打满了，扩容过程也很直接：添加一个 spine 交换机就可以扩展每个 leaf 的上行链路，增大了 leaf 和 spine 之间的带宽，缓解了链路被打爆的问题。如果接入层 的端口数量成为了瓶颈，那就直接添加一个新的 leaf，然后将其连接到每个 spine 并做相  应的配置即可。这种易于扩展（ease of expansion）的特性优化了 IT 部门扩展网络的过 程。leaf  层的接入端口和上行链路都没有瓶颈时，这个架构就实现了无阻塞（nonblocking）。</p>\n<p>在 Spine-and-Leaf 架构中，任意一个服务器到另一个服务器的连接，都会经过相同数量 的设备（除非这两个服务器在同一 leaf 下面），这保证了延迟是可预测的，因为一个包 只需要经过一个 spine 和另一个 leaf 就可以到达目的端。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/4-spine-leaf.PNG\" alt=\"img\"></p>\n<h3 id=\"spine-leaf优势\"><a class=\"markdownIt-Anchor\" href=\"#spine-leaf优势\">#</a> spine leaf 优势</h3>\n<p><strong>扁平化</strong>：扁平化设计缩短服务器之间的通信路径，从而降低延迟，可以显著提高应用程序和服务性能。</p>\n<p><strong>易扩展</strong>：如果 Spine 交换机的带宽不足，我们只需要增加 Spine 节点数，也可以提供路径上的负载均衡；如果接入连接不足，则只需增加 Leaf 节点数。<br>\n低收敛比：容易实现 1:X 甚至是无阻塞的 1:1 的收敛比，而且通过增加 Spine 和 Leaf 设备间的链路带宽也可以降低链路收敛比。</p>\n<p><strong>简化管理</strong>：叶脊结构可以在无环路环境中使用全网格中的每个链路并进行负载平衡，这种等价多路径设计，在使用 SDN 等集中式网络管理平台时处于最佳状态。SDN  允许在发生堵塞或链路故障时简化流量的配置，管理和重新分配路由，使得智能负载均衡的全网状拓扑成为一个相对简单的配置和管理方式。</p>\n<p><strong>边缘流量处理</strong>：随着物联网（IoT）等业务的兴起，接入层压力剧增，可能有数千个传感器和设备在网络边缘连接并产生大量流量。Leaf 可以在接入层处理连接，Spine 保证节点内的任意两个端口之间提供延迟非常低的无阻塞性能，从而实现从接入到云平台的敏捷服务。</p>\n<p><strong>多云管理</strong>：数据中心或云之间通过 Leaf Spine 架构仍可以实现高性能、高容错等优势，而多云管理策略也逐渐成为企业的必选项。</p>\n<h2 id=\"overlay\"><a class=\"markdownIt-Anchor\" href=\"#overlay\">#</a> overlay</h2>\n<p>现代虚拟化数据中心的网络要加速应用部署和支持 DevOps，必须满足特定的前提 条件。例如，需要支持扩展转发表、扩展网段、L2 segment  extension、虚拟设备漂移（mobility）、转发路径优化、共享物理基础设施上的网络虚拟 化和多租户等等。</p>\n<ul>\n<li>VXLAN：Virtual Extensible LAN</li>\n<li>NVGRE: Network Virtualization Using Generic Routing Encapsulation</li>\n<li>TRILL: Transparent Interconnection of Lots of Links</li>\n<li>LISP: Location/Identifier Separation Protocol</li>\n</ul>\n<p>overlay 网络是共享底层网络（underlay network）的节点之间互连形成的虚拟网络，这使 得在不修改底层（underlay）网络的情况下，可以部署对网络拓扑有特定要求的应用</p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlqaWFoYW8uYmFpZHUuY29tL3M/aWQ9MTc1MTA2NTE0Nzg0MDgzNTU0NSZhbXA7d2ZyPXNwaWRlciZhbXA7Zm9yPXBj\">https://baijiahao.baidu.com/s?id=1751065147840835545&amp;wfr=spider&amp;for=pc</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZHJlYW0zOTcvcC8xMjg2OTU0Ny5odG1s\">https://www.cnblogs.com/dream397/p/12869547.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L20wXzQ5ODY0MTEwL2FydGljbGUvZGV0YWlscy8xMjM3NjU5MDg=\">https://blog.csdn.net/m0_49864110/article/details/123765908</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L0ptaWxrL2FydGljbGUvZGV0YWlscy8xMjE3NDE2MDA=\">https://blog.csdn.net/Jmilk/article/details/121741600</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9zdXBwb3J0Lmh1YXdlaS5jb20vZW50ZXJwcmlzZS96aC9kb2MvRURPQzExMDAwMjM1NDM/c2VjdGlvbj1qMDBx\">https://support.huawei.com/enterprise/zh/doc/EDOC1100023543?section=j00q</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vZHJlYW0zOTcvcC8xMjg2OTU0Ny5odG1s\">https://www.cnblogs.com/dream397/p/12869547.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9iYWlqaWFoYW8uYmFpZHUuY29tL3M/aWQ9MTc2MjY4MzgyMjQ2NTg2MTQ4MyZhbXA7d2ZyPXNwaWRlciZhbXA7Zm9yPXBj\">https://baijiahao.baidu.com/s?id=1762683822465861483&amp;wfr=spider&amp;for=pc</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cDovL3d3dy50YW9kdWR1LmNjL25ld3Mvc2hvdy00NDQxNDI5Lmh0bWw/YWN0aW9uPW9uQ2xpY2s=\">http://www.taodudu.cc/news/show-4441429.html?action=onClick</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC84MjAzNzM5NA==\">https://zhuanlan.zhihu.com/p/82037394</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20veWlwaWFuY2h1eXVuL3AvMTM4NDIyOTcuaHRtbA==\">https://www.cnblogs.com/yipianchuyun/p/13842297.html</span></p>\n<p><span class=\"exturl\" data-url=\"aHR0cHM6Ly9hcmNoaXRlY3QucHViL2Jvb2svZXhwb3J0L2h0bWwvODM2\">https://architect.pub/book/export/html/836</span></p>\n",
            "tags": [
                "网络"
            ]
        },
        {
            "id": "http://example.com/2023/01/20/VXLAN/",
            "url": "http://example.com/2023/01/20/VXLAN/",
            "title": "VXLAN",
            "date_published": "2023-01-20T05:38:45.000Z",
            "content_html": "<h1 id=\"vxlan\"><a class=\"markdownIt-Anchor\" href=\"#vxlan\">#</a> VXLAN</h1>\n<h2 id=\"enspvirtualbox设置\"><a class=\"markdownIt-Anchor\" href=\"#enspvirtualbox设置\">#</a> ensp&amp;virtualbox 设置</h2>\n<p>1. 导入 CE 镜像</p>\n<p>拖一台 CE12800，启动设备，系统会让自动选择镜像，选择 CE 镜像，正确的镜像为 1.3G 的</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221931649.png\" alt=\"image-20230101221931649\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222035060.png\" alt=\"image-20230101222035060\"></p>\n<p>导入后 virtualbox 中会显示</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101221847981.png\" alt=\"image-20230101221847981\"></p>\n<p>更改 CE 设置，设置内存，每台 CE12800 大概需要 1G 内存</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222420086.png\" alt=\"image-20230101222420086\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222459733.png\" alt=\"image-20230101222459733\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101222528294.png\" alt=\"image-20230101222528294\"></p>\n<h2 id=\"vxlan-2\"><a class=\"markdownIt-Anchor\" href=\"#vxlan-2\">#</a> VXLAN</h2>\n<p>VXLAN 是由 IETF 定义的 NVO3 (Network Virtualization over Layer 3) 标准技术之一，采用 L2 over L4 ( MAC-in-UDP) 的报文封装模式，将二层报文用三层协议进行封装，可实现二层网络在三层范围内进行扩展，同时满足数据中心大二层虚拟迁移和多租户的需求。</p>\n<p>Vxlan 是一种无控制平面，利用底层 IP 网络实现二层通信的隧道技术。</p>\n<p>GRE 也是无控制平面，不需要使用协议维护隧道状态。比如 LDP 是 LSP 的控制平面。</p>\n<p>底层的 IP 网络称为 Underlay 网络，Vxlan 则称为 Overlayer 网络。</p>\n<h2 id=\"名词解释\"><a class=\"markdownIt-Anchor\" href=\"#名词解释\">#</a> 名词解释</h2>\n<h3 id=\"nvo3-nve\"><a class=\"markdownIt-Anchor\" href=\"#nvo3-nve\">#</a> NVO3 &amp; NVE</h3>\n<p>NVO3 (Network Virtualization Over Layer 3), 基于三层 IP overlay 网络构建虚拟网络技术统称为 NVO3。运行 NVO3 的设备叫做 NVE (NetworkVirtualization Edge) ，它位于 overlay 网络的边界，实现二、三层的虚拟化功能。<strong>NVE 是执行 VXLAN 封装和接封装的设备</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223857131.png\" alt=\"image-20230101223857131\"></p>\n<h3 id=\"vtep\"><a class=\"markdownIt-Anchor\" href=\"#vtep\">#</a> VTEP</h3>\n<p><strong>VXLAN 网络中的 NVE 以 VTEP 进行标识</strong>，VTEP (VXLAN Tunnel Endpoint，VXLAN 隧道端点)<br>\n 每一个 NVE 至少有一个 VTEP，VTEP 使用 NVE 的 IP 地址表示<br>\n两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所公用</p>\n<p>VTEP 即标识设备，也标识 VXLAN 隧道，两个 VTEP 地址之间唯一的确定一条 VXLAN 隧道。所以 VTEP 的地址要求全网可达</p>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230101223916250.png\" alt=\"image-20230101223916250\" style=\"zoom: 80%;\" /> \n<h3 id=\"vni\"><a class=\"markdownIt-Anchor\" href=\"#vni\">#</a> VNI</h3>\n<p>VNI - VXLAN 网络标识符</p>\n<p><strong>VNI 是一种类似于 VLANID 的用户标示，一个 VNl 代表了一个租户</strong>，属于不同 VNI 的虚拟机之间不能直接进行二层通信。VXLAN 报文封装时，给 VNI 分配了足够的空间使其可以支持海量租户的隔离。</p>\n<p>应用场景</p>\n<p>虚拟机在同一网段需要互访的情景，在没有 VXLAN 是，只能在同一个物理机上。使用 VXLAN，可以去除网络限制，使资源分配</p>\n<p>2 层 VPN：封装的对象是帧，VXLAN，TRILL，L2TP，PPTP，VPLS</p>\n<p>3 层 VPN：封装的对象是包，IPSEC，GRE，DSVPN，MPLS VPN</p>\n<p>ipsec vpn 隧道模式，3 层 vpn</p>\n<p>ipsec vpn 传输模式，只封装 IP 之上的内容</p>\n<p>应用层 VPN：SSL VPN</p>\n<p>MPLS VPN：三层</p>\n<p>VPLS：二层</p>\n<h2 id=\"实验1同子网互访\"><a class=\"markdownIt-Anchor\" href=\"#实验1同子网互访\">#</a> 实验 1: 同子网互访</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LSW1 &amp; LSW2</span><br><span class=\"line\">trunk - access </span><br><span class=\"line\"></span><br><span class=\"line\">CE1 &amp; CE2 &amp; CE3</span><br><span class=\"line\">1.underlay</span><br><span class=\"line\">配置物理接口&amp;环回口地址</span><br><span class=\"line\">配置路由协议</span><br><span class=\"line\">2.VXLAN业务接入配置</span><br><span class=\"line\">配置BD域:BD域用于在NVE上本地区分不同的大二层网络，本地有效,没有全局意义，每一个BD域只能关联一个vni，在一台NVE上不同BD域需要关联不同VNI</span><br><span class=\"line\">bridge-domain 10 </span><br><span class=\"line\">VXLAN vni 10</span><br><span class=\"line\">将vlanid和BD域关联，BD域又和vni关联</span><br><span class=\"line\">int g1/0/0.10 mode l2</span><br><span class=\"line\">encapsulation dot1q vid 10</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\">创建VXLAN隧道</span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vin 10 head-end peer-list 3.3.3.3</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110110558492.png\" alt=\"image-20230110110558492\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">LSW1</span><br><span class=\"line\">vlan batch 10 20 30 40</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/1</span><br><span class=\"line\"> port link-type access</span><br><span class=\"line\"> port default vlan 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/2</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/3</span><br><span class=\"line\"> port link-type access</span><br><span class=\"line\"> port default vlan 30</span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.30 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 30</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> </span><br><span class=\"line\">CE3</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 30</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.40 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 40</span><br><span class=\"line\"> bridge-domain 30</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 20 head-end peer-list 2.2.2.2</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111117399.png\" alt=\"image-20230110111117399\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230110111302369.png\" alt=\"image-20230110111302369\"></p>\n<p>数据帧在 CE2 通过子接口，MAC，BD 上形成 MAC 地址表</p>\n<p>MAC-IN-UDP  通过封装 UDP 实现按照流的负载分担，Dport 4789</p>\n<p>在 VXLAN 中，不关心主机所在 VXLAN，只要在同一网段即可实现</p>\n<p>既可以实现网络虚拟化，将网络虚拟为两个不同的虚拟网络，租户之间网络隔离</p>\n<p>此时逻辑拓扑变为虚拟交换机连接同一租户的不同设备</p>\n<p>在公有云场景，为了适应虚拟机迁移的场景，使用 SDN 动态下发配置</p>\n<p>VXLAN 头端复制</p>\n<p>将 VXLAN 报文复制多份发给每一个当前 vni 中的 peer list</p>\n<p>vxlan 网络对 BUM 报文的转发行为默认是头端复制   broadcast-unknown-Multicast</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111205055822.png\" alt=\"image-20230111205055822\"></p>\n<p>VXLAN I flag: 必须置为 1，标识 VNI 字段有效。</p>\n<p>UDP Dest Port: VXLAN 保留 UDP 目的端口号，默认为 4789</p>\n<p>UDP Source Port: 根据数据流 HASH 动态生成。</p>\n<p>不同流封装类型的接口对报文的处理方式</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111211200322.png\" alt=\"image-20230111211200322\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230111213612876.png\" alt=\"image-20230111213612876\"></p>\n<p>一个物理接口下如果存在 default 接口，那么不能存在其他类型的接口</p>\n<h2 id=\"实验二跨子网互通集中式网关\"><a class=\"markdownIt-Anchor\" href=\"#实验二跨子网互通集中式网关\">#</a> 实验二：跨子网互通（集中式网关）</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE1作为网关</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"></span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip add 192.168.1.254 24 </span><br><span class=\"line\">int vbdif 20</span><br><span class=\"line\">ip add 192.168.2.254 24 </span><br><span class=\"line\"></span><br><span class=\"line\">CE2 - CE1 建立VXLAN </span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">vni 10 head peer 1.1.1.1</span><br><span class=\"line\">vni 20 head peer 1.1.1.1 </span><br><span class=\"line\">CE3 - CE1 建立VXLAN</span><br><span class=\"line\">int nve 1</span><br><span class=\"line\">vni 10 head peer 1.1.1.1</span><br><span class=\"line\">vni 20 head peer 1.1.1.1 </span><br><span class=\"line\"></span><br><span class=\"line\">int nv1 </span><br><span class=\"line\">vni 10 head peer 2.2.2.2 3.3.3.3</span><br><span class=\"line\">vni 20 head peer 2.2.2.2 3.3.3.3</span><br><span class=\"line\"></span><br><span class=\"line\">主机网关设置vdbif接口地址</span><br><span class=\"line\"></span><br><span class=\"line\">对于多租户在网关上使用ip vpn-instance 实现</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\">route-dist 1:1</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10 </span><br><span class=\"line\">ip binding vpn-instance 10</span><br><span class=\"line\">ip add </span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 20 </span><br><span class=\"line\">ip binding vpn-instance 10</span><br><span class=\"line\">ip add </span><br><span class=\"line\"></span><br><span class=\"line\">对于每一个租户分配一个VPN-instance </span><br><span class=\"line\"></span><br><span class=\"line\">对于普通的vlan网络，设置接口类型，vlanif接口，即可实现vlan与VXLAN互通</span><br><span class=\"line\"></span><br><span class=\"line\">对于需要访问外网的场景</span><br><span class=\"line\">将VPN-instance中的路由泄露到public中，在VPN-instance中添加了一条静态路由</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0 10.1.11.10 public</span><br><span class=\"line\"></span><br><span class=\"line\">注意回包路由</span><br><span class=\"line\">1.将租户路由引回私网中</span><br><span class=\"line\">ip route-static 192.168.1.1 24 10.1.11.1</span><br><span class=\"line\">2.将public泄露到vpn中,public中会有一下一跳为VPN-instance的路由，迭代到出接口vbdif </span><br><span class=\"line\">ip route-static 192.168.1.0 24 vpn-instance A 192.168.1.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">要求</span><br><span class=\"line\">1.对于同一租户，同子网和跨子网互通</span><br><span class=\"line\">2.vlan和VXLAN互通</span><br><span class=\"line\">3.VXLAN中租户和公网互通</span><br><span class=\"line\">4.CE1旁挂防火墙，实现路由隔离，nat在fw上，租户互通通过fw</span><br></pre></td></tr></table></figure>\n<p>网络虚拟化，对于租户来说，只消耗 vni 和直连路由</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112221742698.png\" alt=\"image-20230112221742698\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230112224309888.png\" alt=\"image-20230112224309888\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE1</span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 1:1</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif30</span><br><span class=\"line\"> ip address 192.168.3.254 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.11.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port default vlan 30</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 2.2.2.2</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 vpn-instance A 192.168.1.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 vpn-instance A 192.168.2.1</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 10.1.11.2 public</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> vni 20 head-end peer-list 1.1.1.1</span><br><span class=\"line\"> vni 20 head-end peer-list 3.3.3.3</span><br><span class=\"line\"> </span><br><span class=\"line\">AR1</span><br><span class=\"line\">acl number 2000  </span><br><span class=\"line\"> rule 5 permit source 192.168.1.0 0.0.0.255 </span><br><span class=\"line\"> rule 10 permit source 192.168.2.0 0.0.0.255 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> ip address 10.1.11.2 255.255.255.0 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/1</span><br><span class=\"line\"> ip address 10.1.21.1 255.255.255.0 </span><br><span class=\"line\"> nat outbound 2000</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 10.1.21.2</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 10.1.11.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 10.1.11.1</span><br></pre></td></tr></table></figure>\n<p>两个 VTEP 可以确定一条 VXLAN 隧道，VTEP 间的这条 VXLAN 隧道将被两个 NVE 间的所有 VNI 所共用。</p>\n<p>VXLAN 二层网关：允许租户接入 VxLAN 网络，实现相同 VxLAN 内部流量互访。</p>\n<p>VxLAN L3 Gateway: 实现不同 VxLAN 直接互访，或者 VxLAN 与非 VxLAN 网络互访。</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230114212602424.png\" alt=\"image-20230114212602424\"></p>\n<p>L2-Subif: 用于用户接入，子接口上可以配置一层 tag 接入或者不配置 tag 接入；</p>\n<p>BD (Bridge-Domain): 标识一个二层广播域，BD 和 VNI 1:1 映射。所有广播域功能基于 BD 支持，如 MAC 学习、二层查表、广播复制等；</p>\n<p>NVE (Network Virtualization Edge): 主要用于本地 VTEP 地址管理，VXLAN 隧道管理，头端复制列表管理；</p>\n<p>VXLAN 隧道: VXLAN 隧道用于 VXLAN 报文的转发，用本地 VTEP 地址 + 远端 VTEP 地址标识﹔</p>\n<p>BDIF:BD 域的三层路由接口，用于二层流量进入三层进行路由转发；</p>\n<p>bridge-domain 20</p>\n<p>L2 binding vlan 10  // 全局关联 vlan 端口到 BD 域中</p>\n<p>VLAN 绑定 BD 后，该 BD 不支持创建对应的 VBDIF 接口。同时不支持创建该 VLAN 对应的 VLANIF 接口。</p>\n<p>VLAN 绑定 BD 功能和 ARP 广播报文抑制功能互斥，配置 VLAN 为 VXLAN 业务接入点后，不建议再使能 ARP 广播报文抑制功能</p>\n<p>ARP 广播抑制：抑制后续的 ARP 广播报文，由于首包之后 CE 上已经有了 arp 请求的主机的位置，只需要单播请求即可。arp 广播请求变 arp 单播请求</p>\n<p>第一次虚拟化：利用隧道技术将边缘设备互连透传二层报文；整网抽象理解成一台端口数目扩展的超大 LAN switch。</p>\n<p>第二次虚拟化利用 VNI 将这台超大的交换机虚拟出多个二层的广播域，和 VLAN 本质是一样的，VNI 类比 VLANID. 并通过定义 VXLAN header 中的 VNI 字段，将子网范围由 4K 扩展至 16M。</p>\n<p>vxlan 主要优点</p>\n<p>基于 IP 的 overlay, 仅需要边界设备间 IP 可达。</p>\n<p>隧道间水平分割、IP overlay TTL 避免环路。 网络层收到的 VXLAN 报文只能发给用户侧</p>\n<p>数据流量基于 IP 路由 SPF 及 ECMP 快速转发。</p>\n<p>网络变化实时侦听全网拓扑毫秒收敛</p>\n<p>Overlay+VNI 构建虚拟网络，支持多达 16M 的虚拟网络。</p>\n<p>物理设备、vSwitch 均能够部署。CE1800V 软件交换机也能做 VXLAN</p>\n<p>VXLAN 同子网互访模型</p>\n<p>1. 同一 OVS 之间</p>\n<p>2. 不同 OVS 之间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191207957.png\" alt=\"image-20230122191207957\"></p>\n<p>3. 不同 tor 之间</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191226332.png\" alt=\"image-20230122191226332\"></p>\n<p>VXLAN 不同子网护网</p>\n<p>集中式网关</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122191735252.png\" alt=\"image-20230122191735252\"></p>\n<p>1. 流量迂回</p>\n<p>2. 网关 arp 表项过多可能成为网络瓶颈</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192007255.png\" alt=\"image-20230122192007255\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192117780.png\" alt=\"image-20230122192117780\"></p>\n<p>VXLAN 基于 spine-leaf 组网架构</p>\n<p>胖树</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122192248454.png\" alt=\"image-20230122192248454\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122193919103.png\" alt=\"image-20230122193919103\"></p>\n<p>spine 和网关分离部署，解决集中式网关容量问题</p>\n<p>spine 和网关融合部署</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122194413496.png\" alt=\"image-20230122194413496\"></p>\n<p>集中式网关场景下网关双活</p>\n<p>华为最多支持四台做多活，但只提高转发效率，不提高表项</p>\n<p>表项通过 DFS 同步</p>\n<p>需要通过双活组做网关扩容</p>\n<p>多活网关需要 VTEP 一样</p>\n<p>CE 模拟器基于包做负载分担</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195628679.png\" alt=\"image-20230122195628679\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230122195938635.png\" alt=\"image-20230122195938635\"></p>\n<p>集中式网关特点</p>\n<p>1. 流量存在迂回现象</p>\n<p>2. 网关需要维护主机的 mac 地址信息和 arp 信息，对设备表项容量要求高，容易遇到瓶颈</p>\n<p>3. 网关容易存在单点故障</p>\n<p>4. 跨子网的流量都由网关来完成，流量有明显控制点，网关维护用户路由信息，MAC 地址，ARP 表项，VXLAN 隧道路由</p>\n<p>leaf 只需要维护 MAC 地址信息和 VXLAN 隧道的路由信息，无需维护用户的路由信息</p>\n<p>第一个和第二三个问题可以采用分布式网关解决</p>\n<p>第三个问题可以使用双活网关解决</p>\n<p>如果非要用集中式网关</p>\n<p>1. 第一个问题无法解决</p>\n<p>2. 第二个问题采用多组网关解决容量问题</p>\n<p>3. 第三个问题采用多活网关</p>\n<p>集中式网关有网关和 spine 融合组网  适用业务稳定，规模稳定的私有云</p>\n<p>网关和 spine 分离组网    适用于业务变更频繁业务规模可以弹性伸缩的时候，中大型公有云和私有云</p>\n<h2 id=\"集中式双活网关过墙\"><a class=\"markdownIt-Anchor\" href=\"#集中式双活网关过墙\">#</a> 集中式双活网关过墙</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123214500930.png\" alt=\"image-20230123214500930\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">网关上创建互联vlan</span><br><span class=\"line\">一个vlan绑定到用户的VPN-instance中，用于和用户的vfw实现三层互连</span><br><span class=\"line\">一个vlan绑定到public中，和root防火墙实现三层互联，此链路所有租户共享</span><br><span class=\"line\"></span><br><span class=\"line\">fw上创建互联vlan</span><br><span class=\"line\">一个vlan关联到租户的虚墙，实现和租户在gw上的VPN-instance对接</span><br><span class=\"line\">一个vlan关联root防火墙和gw的public对接</span><br><span class=\"line\"></span><br><span class=\"line\">gw</span><br><span class=\"line\">vlan 10</span><br><span class=\"line\">des vpn A</span><br><span class=\"line\"></span><br><span class=\"line\">vlan 20</span><br><span class=\"line\">des public </span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/1</span><br><span class=\"line\">p l t </span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">int vlanif 10</span><br><span class=\"line\">ip add 192.168.10.1 24 </span><br><span class=\"line\">ip bing vpn A</span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 20 </span><br><span class=\"line\">ip add 192.168.20.1 24 </span><br><span class=\"line\"></span><br><span class=\"line\">ip route vpn A 0.0.0.0 0 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 0.0.0.0 0 192.168.30.1</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 202.1.1.0 24 192.168.20.20</span><br><span class=\"line\"></span><br><span class=\"line\">fw</span><br><span class=\"line\">vlan 10 20</span><br><span class=\"line\">int g1/0/0</span><br><span class=\"line\">portswitch</span><br><span class=\"line\">p l t</span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">vsys name A</span><br><span class=\"line\">assign vlan 10</span><br><span class=\"line\">int vlanif 10 </span><br><span class=\"line\">ip add 192.168.10.10 24 </span><br><span class=\"line\">service pin p</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\">add interface vlanif 10</span><br><span class=\"line\">//华为NGFW默认出厂存在一个virtual-if0，它属于root的一个逻辑接口，用于和虚拟fw的virtual-if接口实现通信</span><br><span class=\"line\">在创建vfw时，也会为vfw自动创建一个virtual-if接口，接口号设备自行分配</span><br><span class=\"line\">Firewall zone untrust </span><br><span class=\"line\">add inter vitural-if 1</span><br><span class=\"line\"></span><br><span class=\"line\">firewall zone trust  </span><br><span class=\"line\">add inter vit 0</span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 20</span><br><span class=\"line\">ip add 192.168.20.20  24 </span><br><span class=\"line\">service pin p</span><br><span class=\"line\">firewall zon un </span><br><span class=\"line\">add int vlan 20</span><br><span class=\"line\"></span><br><span class=\"line\">switch vsys A </span><br><span class=\"line\">ip route-static 192.168.1.0 24 192.168.10.1</span><br><span class=\"line\">security-po </span><br><span class=\"line\">ru name test </span><br><span class=\"line\">trust-&gt;untrust</span><br><span class=\"line\">sourece 192.168.1.0 </span><br><span class=\"line\">ac pe</span><br><span class=\"line\">ip route 0.0.0.0 0 public</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">security-policy </span><br><span class=\"line\">def ac per</span><br><span class=\"line\">ip route 0.0.0.0 0 192.168.20.1</span><br><span class=\"line\"></span><br><span class=\"line\">nat add A</span><br><span class=\"line\">section 202.1.1.1 202.1.1.10</span><br><span class=\"line\"></span><br><span class=\"line\">vsys name A</span><br><span class=\"line\">assign global 202.1.1.1 202.1.1.10 free</span><br><span class=\"line\"></span><br><span class=\"line\">switch vsys A </span><br><span class=\"line\">nat add A</span><br><span class=\"line\">sec 202.1.1.1 202.1.1.3</span><br><span class=\"line\">nat-policy </span><br><span class=\"line\">ru name A</span><br><span class=\"line\">source-zon  t</span><br><span class=\"line\">de un</span><br><span class=\"line\">source 192.168.1.0 24 </span><br><span class=\"line\">ac so add A </span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 202.1.1.0 28 vpn A</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">R1</span><br><span class=\"line\">ip rou 202.1.1.0 24 192.168.30.1</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230123211745121.png\" alt=\"image-20230123211745121\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//1.网关双活</span><br><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> mac-address 5489-9825-6da0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">[CE3]dis cu </span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 1</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.23.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2.10 mode l2</span><br><span class=\"line\"> encapsulation untag</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list 1.1.1.1</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//网关双活过墙</span><br><span class=\"line\">[CE1]di cu </span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">#</span><br><span class=\"line\">vlan 10</span><br><span class=\"line\"> description VPN-instance  A</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> mac-address 5489-9825-6da0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif20</span><br><span class=\"line\"> description public</span><br><span class=\"line\"> ip address 192.168.20.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 192.168.30.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 1.1.1.1</span><br><span class=\"line\"> vni 10 head-end peer-list 3.3.3.3</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.30.30</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.0 192.168.20.20</span><br><span class=\"line\">ip route-static vpn-instance A 0.0.0.0 0.0.0.0 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[USG6000V1]dis cu </span><br><span class=\"line\">vlan batch 10 20 30</span><br><span class=\"line\">#</span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">#</span><br><span class=\"line\">vsys name A 1</span><br><span class=\"line\"> assign vlan 10</span><br><span class=\"line\"> assign global-ip 201.1.1.1 202.1.1.10 free</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.10 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif20</span><br><span class=\"line\"> ip address 192.168.20.20 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/0</span><br><span class=\"line\"> portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface GigabitEthernet0/0/0</span><br><span class=\"line\"> add interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Vlanif20</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.20.1</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.240 vpn-instance A</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> default action permit</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">#</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.10.10 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface Vlanif10</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">nat address-group A 0</span><br><span class=\"line\"> mode pat</span><br><span class=\"line\"> section 0 202.1.1.1 202.1.1.3</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  action permit</span><br><span class=\"line\">#</span><br><span class=\"line\">nat-policy</span><br><span class=\"line\"> rule name A</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  action source-nat address-group A</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 192.168.10.1</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">[R1]dis cu</span><br><span class=\"line\">[V200R003C00]</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> ip address 192.168.30.30 255.255.255.0 </span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 8.8.8.8 255.255.255.255 </span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 202.1.1.0 255.255.255.0 192.168.30.1</span><br></pre></td></tr></table></figure>\n<h2 id=\"evpn\"><a class=\"markdownIt-Anchor\" href=\"#evpn\">#</a> EVPN</h2>\n<p>EVPN 作为数据中心 VXLAN 技术的控制平面，转发平面还是采用 VXLAN 对数据进行封装</p>\n<p>EVPN 支持集中式网关组网，也支持分布式网关组网</p>\n<p>EVPN 在数据中心实现同子网互访和跨子网互访</p>\n<p>为了在数据中心支持 VXLAN。EVPN 在 BGP 协议的基础上新增了一种 NLRI，称为 EVPN NLRI</p>\n<p>EVPN NLRI 定义了三种路由信息</p>\n<p>1.type 2 路由称为 MAC/IP 路由，根据不同的作用，也称为 ARP 路由 / IRB 路由（IRB  集成的路由与桥接），用于</p>\n<p>@数据中心支持 ARP 广播抑制</p>\n<p>@动态虚拟机迁移</p>\n<p>@虚拟机主机路由的发布，实现跨子网互访</p>\n<p>2.type 3 路由，称为集成组播路由，用于在 VTEP 之间动态建立 VXLAN 隧道，并动态实现头端复制列表的生成，用于支持 BUM 报文的转发</p>\n<p>3.type 5 路由，称为前缀路由，常用于将数据中心外部路由引入到各租户的 VPN-instance 中，实现数据中心内部访问外部</p>\n<p>另外标准的 EVPN 协议还定义了 type 1 的路由</p>\n<p>type 1 路由 Ethernet AD Route    (auto discovery)</p>\n<p>双归场景下用于防环快速收敛，别名</p>\n<p>type 4 路由，Ethernet Segment Route</p>\n<p>双归场景下用于实现 DF 的选举和执行负载分担的维护</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">//CE1-CE4之间建立EVPN邻居</span><br><span class=\"line\">CE1</span><br><span class=\"line\">evpn-overlay enable </span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 2.2.2.2 as 100</span><br><span class=\"line\">peer 2.2.2.2 con l 0 </span><br><span class=\"line\">peer 3.3.3.3</span><br><span class=\"line\">peer 4.4.4.4</span><br><span class=\"line\">l2vpn-fa evpn </span><br><span class=\"line\">peer 2.2.2.2 enable</span><br><span class=\"line\">peer 2.2.2.2 re</span><br><span class=\"line\">peer 3.3.3.3 </span><br><span class=\"line\">peer 4.4.4.4</span><br><span class=\"line\">//peer 2.2.2.2 ad arp</span><br><span class=\"line\">//peer 3.3.3.3 ad arp</span><br><span class=\"line\">//peer 4.4.4.4 ad arp</span><br><span class=\"line\">undo p v</span><br><span class=\"line\"></span><br><span class=\"line\">CE2</span><br><span class=\"line\">evpn-overlay enable </span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 1.1.1.1 as 100</span><br><span class=\"line\">peer 1.1.1.1 con l 0 </span><br><span class=\"line\">l2vpn-fa evpn </span><br><span class=\"line\">peer 1.1.1.1 en</span><br><span class=\"line\">//peer 1.1.1.1 ad arp</span><br><span class=\"line\"></span><br><span class=\"line\">dis bgp evpn peer </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2-CE3-CE4</span><br><span class=\"line\">BD 10</span><br><span class=\"line\">vx  10</span><br><span class=\"line\">evpn</span><br><span class=\"line\">router- 100:1</span><br><span class=\"line\">vpn-t 100:1 b</span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/1.10 </span><br><span class=\"line\">bd 10</span><br><span class=\"line\">enca 10</span><br><span class=\"line\">//EVPN实例中本地的每个BD域都可以看成是一个独立的EVPN实例，一个二层的广播域</span><br><span class=\"line\"></span><br><span class=\"line\">int Nve1</span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vni 10 head peer pro bgp    //type3</span><br><span class=\"line\">dis bgp evpn rout in 0:32:2.2.2.2</span><br><span class=\"line\"></span><br><span class=\"line\">CE4</span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip add 192.168.1.254 24 </span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">没有反射器的场景需要在所有节点建立全互联EVPN</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE2-CE3</span><br><span class=\"line\">ip vpn- A</span><br><span class=\"line\">router 100:1</span><br><span class=\"line\">vpn 100:1 both evpn</span><br><span class=\"line\">vxlan vni 100   //三层VNI</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10</span><br><span class=\"line\">ip bin vpn A</span><br><span class=\"line\">arp dist enable</span><br><span class=\"line\">arp collect host enable</span><br><span class=\"line\">ip addr</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Type3 路由 ——Inclusive Multicast 路由</strong><br>\n<img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212349933.png\" alt=\"image-20230125212349933\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230125212635735.png\" alt=\"image-20230125212635735\"></p>\n<p>还会携带 ERT，不在 EVPN 中，在 BGP 中，用于设置感兴趣路由</p>\n<p>1. 对方收到 type3 路由后，比较 RT 是否匹配，如果匹配则接收该 type3 的路由</p>\n<p>2. 提取 type3 中 org router ip (VTEP 地址) ，如果该地址路由可达，则创建 VXLAN 隧道</p>\n<p>3. 提取 PMSI 属性中二层 VNI 值，看是否和本端 EVPN 实例中的相同，如果相同则将 PSMI 中携带的 VTEP 地址添加到 VXLAN 隧道的头端复制列表中</p>\n<p>如果希望在 EVPN 邻居之间传递 type2 的路由 (ARP 路由 / IRB 路由)</p>\n<p>peer 1.1.1.1 advertise arp   传递 ARP 路由 / MAC 路由</p>\n<p>peer 1.1.1.1 advertise irb    传递 IRB 类型的路由</p>\n<p>默认只传 type3</p>\n<p>MAC route 实现 VM 之间二层互访，需要在 EVPN 邻居之间传递 MAC  route</p>\n<p>MAC route 特征</p>\n<p>携带 RD+MAC + 二层 VNI</p>\n<p>为了支持 ARP 广播抑制和虚拟机热迁移，需要在 EVPN 邻居之间传递 ARP 类型的路由</p>\n<p>传递 IRB peer 1.1.1.1 ad irb</p>\n<p><strong>Type2 路由 ——MAC/IP 路由</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212428010.png\" alt=\"image-20230126212428010\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230126212535678.png\" alt=\"image-20230126212535678\"></p>\n<p>arp 路由的特征：携带 RD+MAC+IP + 二层 VNI</p>\n<p>irb 类型的特征：携带 RD+MAC+IP + 二层 VNI + 三层 VNI，irb 类型的路由也具备 arp 类型路由的功能</p>\n<p>什么时候发送 ARP 类型的路由，集中式网关部署时发送 ARP 类型的路由即可</p>\n<p>什么时候发送 IRB 类型的路由，分布式网关一定要发送 IRB 类型的路由</p>\n<p>当邻居之间发布 arp 路由命令后，设备会将用户侧学到主机的 IP+MAC 信息通过 arp 类型的路由发送给 evpn 邻居</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type 2路由在VXLAN控制平面中的作用包括：</span><br><span class=\"line\"></span><br><span class=\"line\">主机MAC地址通告</span><br><span class=\"line\"></span><br><span class=\"line\">要实现同子网主机的二层互访，两端VTEP需要相互学习主机MAC。作为BGP EVPN对等体的VTEP之间通过交换MAC/IP路由，可以相互通告已经获取到的主机MAC。其中，MAC Address Length和MAC Address字段为主机MAC地址。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">主机ARP通告</span><br><span class=\"line\"></span><br><span class=\"line\">MAC/IP路由可以同时携带主机MAC地址+主机IP地址，因此该路由可以用来在VTEP之间传递主机ARP表项，实现主机ARP通告。其中，MAC Address和MAC Address Length字段为主机MAC地址，IP Address和IP Address Length字段为主机IP地址。此时的MAC/IP路由也称为ARP类型路由。主机ARP通告主要用于以下两种场景：</span><br><span class=\"line\"></span><br><span class=\"line\">1.ARP广播抑制。当三层网关学习到其子网下的主机ARP时，生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息同步到二层网关上。这样当二层网关再收到ARP请求时，先查找是否存在目的IP地址对应的主机信息，如果存在，则直接将ARP请求报文中的广播MAC地址替换为目的单播MAC地址，实现广播变单播，达到ARP广播抑制的目的。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">2.分布式网关场景下的虚拟机迁移。当一台虚拟机从当前网关迁移到另一个网关下之后，新网关学习到该虚拟机的ARP（一般通过虚拟机发送免费ARP实现），并生成主机信息（包含主机IP地址、主机MAC地址、二层VNI、网关VTEP IP地址），然后通过传递ARP类型路由将主机信息发送给虚拟机的原网关。原网关收到后，感知到虚拟机的位置发生变化，触发ARP探测，当探测不到原位置的虚拟机时，撤销原位置虚拟机的ARP和主机路由。</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128140404626.png\" alt=\"image-20230128140404626\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/2</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.14.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 2.2.2.2 as-number 100</span><br><span class=\"line\"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class=\"line\"> peer 3.3.3.3 as-number 100</span><br><span class=\"line\"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class=\"line\"> peer 4.4.4.4 as-number 100</span><br><span class=\"line\"> peer 4.4.4.4 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 4.4.4.4 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  undo policy vpn-target</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 2.2.2.2 advertise irb</span><br><span class=\"line\">  peer 2.2.2.2 reflect-client</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 3.3.3.3 advertise irb</span><br><span class=\"line\">  peer 3.3.3.3 reflect-client</span><br><span class=\"line\">  peer 4.4.4.4 enable</span><br><span class=\"line\">  peer 4.4.4.4 advertise irb</span><br><span class=\"line\">  peer 4.4.4.4 reflect-client</span><br><span class=\"line\">  </span><br><span class=\"line\">  </span><br><span class=\"line\">[CE2]dis  cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:1 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:1 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/0.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 1.1.1.1 as-number 100</span><br><span class=\"line\"> peer 1.1.1.1 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 1.1.1.1 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 1.1.1.1 enable</span><br><span class=\"line\">  peer 1.1.1.1 advertise irb</span><br></pre></td></tr></table></figure>\n<p>配置分布式网关并且通告 irb 类型路由后‘</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230128150821743.png\" alt=\"image-20230128150821743\"></p>\n<h2 id=\"分布式网关\"><a class=\"markdownIt-Anchor\" href=\"#分布式网关\">#</a> 分布式网关</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE2-CE3</span><br><span class=\"line\">evpn en\t</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 3.3.3.3 as 100</span><br><span class=\"line\">peer 3.3.3.3 con l 0</span><br><span class=\"line\">l2vpn evpn</span><br><span class=\"line\">peer 3.3.3.3 enable</span><br><span class=\"line\">peer 3.3.3.3 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\">bd 10</span><br><span class=\"line\">vxxlan 10</span><br><span class=\"line\">evpn </span><br><span class=\"line\">route</span><br><span class=\"line\">vpn-target 100:1</span><br><span class=\"line\"></span><br><span class=\"line\">bbd 20</span><br><span class=\"line\">vpn 100:2</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\">route 100:1</span><br><span class=\"line\">vpn- 100:1 both </span><br><span class=\"line\">vpn- 100:1 evpn</span><br><span class=\"line\">vpn 100:2 evpn imp</span><br><span class=\"line\">vxlan vni 99</span><br><span class=\"line\"></span><br><span class=\"line\">int vbdif 10 </span><br><span class=\"line\">ip bind vpn A</span><br><span class=\"line\">ip add </span><br><span class=\"line\">arp dis en</span><br><span class=\"line\">arp coll host en</span><br><span class=\"line\"></span><br><span class=\"line\">int nv 1 </span><br><span class=\"line\">source 2.2.2.2</span><br><span class=\"line\">vni 10 h p p bgp</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>二层 VNI 用于同子网互访</p>\n<p>三层 VNI 用于实现跨子网互访</p>\n<ul>\n<li>\n<p>ARP 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI；IRB 类型路由携带的有效信息有：主机 MAC 地址 + 主机 IP 地址 + 二层 VNI + 三层 VNI。因此，IRB 类型路由包含着 ARP 类型路由，不仅可以用于主机 IP 路由通告，也能用于主机 ARP 通告。</p>\n</li>\n<li>\n<p>主机 IP 路由通告</p>\n<p>在分布式网关场景中，要实现跨子网主机的三层互访，两端 VTEP（作为三层网关）需要互相学习主机 IP 路由。作为 BGP EVPN 对等体的 VTEP 之间通过交换 MAC/IP 路由，可以相互通告已经获取到的主机 IP 路由。其中，IP Address Length 和 IP Address 字段为主机 IP 路由的目的地址，同时 MPLS Label2 字段必须携带三层 VNI。此时的 MAC/IP 路由也称为 IRB（Integrated Routing and Bridge）类型路由。</p>\n</li>\n</ul>\n<p><span class=\"exturl\" data-url=\"aHR0cDovLzEuQkQ=\">1.BD</span> rt 匹配，如果匹配实现广播抑制虚拟机热迁移</p>\n<p>2. 当 Eert 和本端 VPN-instance 中 Eirt 匹配时，会将其中携带的 IP 地址加入到 VPN-instance 路由表中，生成一条主机路由</p>\n<p>export-rt evpn Eert</p>\n<p>import-rt evpn Eirt</p>\n<p>Leaf2 收到 Leaf1 发来的 BGP EVPN 路由后，同时进行如下处理：</p>\n<ul>\n<li>检查该路由携带的 ERT，如果与本端 EVPN 实例的 IRT 相同，则接收该路由。EVPN 实例获取到 IRB 类型路由后，还能提取到其中包含的 ARP 类型路由，用于主机 ARP 通告。</li>\n<li>检查该路由携带的 ERT，如果与本端 L3VPN 实例的 eIRT 相同，则接收该路由。然后，L3VPN 实例获取到该路由携带的 IRB 类型路由，从中提取 Host1 的主机 IP 地址、三层 VNI，在其路由表中保存 Host1 的主机 IP 路由，并根据路由的下一跳迭代出接口，最终迭代结果是指向 Leaf1 的 VXLAN 隧道，如<span class=\"exturl\" data-url=\"bWs6TVNJVFN0b3JlOkQ6JTVDQV8lRTUlQUQlQTYlRTQlQjklQTAlNUMlRTQlQkElQTclRTUlOTMlODElRTYlOTYlODclRTYlQTElQTMlNUNDRTEyODAwLmNobTo6L2RjL2RjX3ZycF9mZWF0dXJlX3Z4bGFuXzEwMzkuaHRtbCNaSC1DTl9DT05DRVBUXzAxNDExMTg4NTBfX2ZpZ19kY192cnBfZmVhdHVyZV92eGxhbl8xMDM5MDc=\">图 6</span> 所示。</li>\n</ul>\n<p>分布式网关只需要维护 rt 匹配的路由</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230130224834603.png\" alt=\"image-20230130224834603\"></p>\n<p>dis ip rou vpn A</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144845172.png\" alt=\"image-20230131144845172\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br><span class=\"line\">139</span><br><span class=\"line\">140</span><br><span class=\"line\">141</span><br><span class=\"line\">142</span><br><span class=\"line\">143</span><br><span class=\"line\">144</span><br><span class=\"line\">145</span><br><span class=\"line\">146</span><br><span class=\"line\">147</span><br><span class=\"line\">148</span><br><span class=\"line\">149</span><br><span class=\"line\">150</span><br><span class=\"line\">151</span><br><span class=\"line\">152</span><br><span class=\"line\">153</span><br><span class=\"line\">154</span><br><span class=\"line\">155</span><br><span class=\"line\">156</span><br><span class=\"line\">157</span><br><span class=\"line\">158</span><br><span class=\"line\">159</span><br><span class=\"line\">160</span><br><span class=\"line\">161</span><br><span class=\"line\">162</span><br><span class=\"line\">163</span><br><span class=\"line\">164</span><br><span class=\"line\">165</span><br><span class=\"line\">166</span><br><span class=\"line\">167</span><br><span class=\"line\">168</span><br><span class=\"line\">169</span><br><span class=\"line\">170</span><br><span class=\"line\">171</span><br><span class=\"line\">172</span><br><span class=\"line\">173</span><br><span class=\"line\">174</span><br><span class=\"line\">175</span><br><span class=\"line\">176</span><br><span class=\"line\">177</span><br><span class=\"line\">178</span><br><span class=\"line\">179</span><br><span class=\"line\">180</span><br><span class=\"line\">181</span><br><span class=\"line\">182</span><br><span class=\"line\">183</span><br><span class=\"line\">184</span><br><span class=\"line\">185</span><br><span class=\"line\">186</span><br><span class=\"line\">187</span><br><span class=\"line\">188</span><br><span class=\"line\">189</span><br><span class=\"line\">190</span><br><span class=\"line\">191</span><br><span class=\"line\">192</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[CE3]di cu </span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:4</span><br><span class=\"line\">  vpn-target 100:5 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity evpn</span><br><span class=\"line\">  vpn-target 100:5 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity evpn</span><br><span class=\"line\"> vxlan vni 99</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:11 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:11 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:2</span><br><span class=\"line\">  vpn-target 100:3 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:3 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 3.0.0.0</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/6</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.3 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 3.3.3.3 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 3.3.3.3</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\"> vni 20 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 2.2.2.2 as-number 100</span><br><span class=\"line\"> peer 2.2.2.2 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 2.2.2.2 enable</span><br><span class=\"line\">  peer 2.2.2.2 advertise irb</span><br><span class=\"line\">  </span><br><span class=\"line\">[CE1]dis cu </span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 1.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/3</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.13.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/4</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.1 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 1.1.1.1 255.255.255.255</span><br><span class=\"line\"> </span><br><span class=\"line\"> </span><br><span class=\"line\">[CE2]dis cu </span><br><span class=\"line\">vlan batch 10 20</span><br><span class=\"line\">#</span><br><span class=\"line\">evpn-overlay enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ip vpn-instance A</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:3 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity evpn</span><br><span class=\"line\">  vpn-target 100:3 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity evpn</span><br><span class=\"line\"> vxlan vni 99</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 10</span><br><span class=\"line\"> vxlan vni 10</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:1</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">bridge-domain 20</span><br><span class=\"line\"> vxlan vni 20</span><br><span class=\"line\"> evpn</span><br><span class=\"line\">  route-distinguisher 100:2</span><br><span class=\"line\">  vpn-target 100:100 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 export-extcommunity</span><br><span class=\"line\">  vpn-target 100:100 import-extcommunity</span><br><span class=\"line\">  vpn-target 100:22 import-extcommunity</span><br><span class=\"line\">#</span><br><span class=\"line\">rip 1</span><br><span class=\"line\"> version 2</span><br><span class=\"line\"> network 10.0.0.0</span><br><span class=\"line\"> network 2.0.0.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif10</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.1.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vbdif20</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.2.254 255.255.255.0</span><br><span class=\"line\"> arp distribute-gateway enable</span><br><span class=\"line\"> arp collect host enable</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.10 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 10</span><br><span class=\"line\"> bridge-domain 10</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/1.20 mode l2</span><br><span class=\"line\"> encapsulation dot1q vid 20</span><br><span class=\"line\"> bridge-domain 20</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GE1/0/5</span><br><span class=\"line\"> undo portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.12.2 255.255.255.0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 2.2.2.2 255.255.255.255</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Nve1</span><br><span class=\"line\"> source 2.2.2.2</span><br><span class=\"line\"> vni 10 head-end peer-list protocol bgp</span><br><span class=\"line\"> vni 20 head-end peer-list protocol bgp</span><br><span class=\"line\">#</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\"> peer 3.3.3.3 as-number 100</span><br><span class=\"line\"> peer 3.3.3.3 connect-interface LoopBack0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family unicast</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\"> #</span><br><span class=\"line\"> l2vpn-family evpn</span><br><span class=\"line\">  policy vpn-target</span><br><span class=\"line\">  peer 3.3.3.3 enable</span><br><span class=\"line\">  peer 3.3.3.3 advertise irb</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131144906251.png\" alt=\"image-20230131144906251\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131145050065.png\" alt=\"image-20230131145050065\"></p>\n<h2 id=\"分布式网关访问外网\"><a class=\"markdownIt-Anchor\" href=\"#分布式网关访问外网\">#</a> 分布式网关访问外网</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">CE2-CE3</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 1.1.1.1 as 100</span><br><span class=\"line\">peer 1.1.1.1 con l 0</span><br><span class=\"line\">l2vpn</span><br><span class=\"line\">peer 1.1.1.1 en</span><br><span class=\"line\">peer 1.1.1.1 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">CE1</span><br><span class=\"line\">peer 2.2.2.2 as 100</span><br><span class=\"line\">peer 2.2.2.2 con l 0 </span><br><span class=\"line\">l2vpn </span><br><span class=\"line\">peer 2.2.2.2 en</span><br><span class=\"line\">peer 2.2.2.2 ad irb</span><br><span class=\"line\"></span><br><span class=\"line\">//1.建立EVPN邻居</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn A </span><br><span class=\"line\">route 100:1</span><br><span class=\"line\">vxlan vni 99</span><br><span class=\"line\">vpn- 100:100 b evpn </span><br><span class=\"line\">vpn 100:100 e e</span><br><span class=\"line\"></span><br><span class=\"line\">int g1/0/3 </span><br><span class=\"line\">p l t </span><br><span class=\"line\">p t a v a </span><br><span class=\"line\"></span><br><span class=\"line\">int vlan 10</span><br><span class=\"line\">ip bin vpn A</span><br><span class=\"line\">ip add 192.168.10.1 24 </span><br><span class=\"line\"></span><br><span class=\"line\">ip rou vpn A  0.0.0.0 0 192.168.10.10 </span><br><span class=\"line\">ip rou vpn A  8.8.8.0 24 192.168.10.10</span><br><span class=\"line\"></span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">ipv4 vpn A</span><br><span class=\"line\">import  static</span><br><span class=\"line\">ad l2vpn evpn   //vpnv4转换为EVPN type 5路由</span><br><span class=\"line\"></span><br><span class=\"line\">b 10</span><br><span class=\"line\">vxlan vni 10</span><br><span class=\"line\">evpn</span><br><span class=\"line\">rd 100:1</span><br><span class=\"line\">rt 100:1 b</span><br><span class=\"line\">b20</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\">int nv 1</span><br><span class=\"line\">...</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">FW </span><br><span class=\"line\">int g1/0/0.1</span><br><span class=\"line\">vlan-type dot 10</span><br><span class=\"line\">ip add 192.168.10.10 24 </span><br><span class=\"line\"></span><br><span class=\"line\">fir zon trust</span><br><span class=\"line\">add g1/0/0.1</span><br><span class=\"line\">ser p p</span><br><span class=\"line\"></span><br><span class=\"line\">ip rou 0.0.0.0 0 192.168.10.1 </span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p><strong>Type5 路由 ——IP 前缀路由</strong></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220410404.png\" alt=\"image-20230131220410404\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230131220430645.png\" alt=\"image-20230131220430645\"></p>\n<p>发送时</p>\n<p>tpye 2，3 路由携带 evpn 实例下自身的 ERT</p>\n<p>type 5 路由携带 vpn 实例下 eert</p>\n<p>接收时</p>\n<p>匹配 vpn 实例下 eirt</p>\n<p>1.14</p>\n<p>EVN</p>\n<p>用于 vlan 的场景下实现跨数据中心互访，完成不同数据中心相同 vlan 互访，只用于二层互访</p>\n<p>@集成多播路由 (Inclusive Multicast Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递集成多播路由。用于生成 BUM 转发表，同时自动建立传送数<br>\n据报文的 VXLAN 隧道。</p>\n<p>MAC 地址通告路由 (MAC Advertisement Route) : BGP 邻居关系建立后，当 PE 上的 MAC 表信息发生变化时，PE 即向对等体 PE 发送 MAC 地址通告路由，用于更新对端 PE 上的 MAC 表，指导单播报文的转发。</p>\n<p>@以太自动发现路由（Ethernet Auto-Discovery Routa) : PE 之间的 BGP 邻居关系建立成功后，.PE 之间会传递以太自动发现路由。以太目动发现路由可以向其他 PE 通告本端 PE 对接入站点的 MAC 地址的可达性，主要用于 CE 多归属的场景中的水平分割和快速收敛。</p>\n<p>以太网段路由 (Ethernet Segment Route) : 当 PE 之间的 BGP 邻居关系建立成功后，PE 之间会传递以太网段路由，用来实现连接到相同 CE 的 PE 设备之间互相自动发现。以太网段路由主要用于 CE 多归属场景中的 DF 的选举。在单归属场景中，主要涉及前两种路由的交互。接下来我们就看一下，这两种路由信息是如何促成控制面表项和隧道生成的。</p>\n<p>type 1</p>\n<p>双规场景下实现别名，快速收敛，水平分割</p>\n<p>esi 用于实现 PE 是否连在一台 CE 上，本端 PE 知道，对端 PE 也知道</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201215825630.png\" alt=\"image-20230201215825630\"></p>\n<p>通过阻塞链路或者负载分担防环</p>\n<p>阻塞链路：single active</p>\n<p>负载分担：all- active</p>\n<p>多活时与 CE 相连的 PE 必须都是多活</p>\n<p>有一个单活就必须使用第一种</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201220430613.png\" alt=\"image-20230201220430613\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201221300402.png\" alt=\"image-20230201221300402\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230201222213560.png\" alt=\"image-20230201222213560\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203212914411.png\" alt=\"image-20230203212914411\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203213933709.png\" alt=\"image-20230203213933709\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214050214.png\" alt=\"image-20230203214050214\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214445292.png\" alt=\"image-20230203214445292\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203214823555.png\" alt=\"image-20230203214823555\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215114418.png\" alt=\"image-20230203215114418\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203215133032.png\" alt=\"image-20230203215133032\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230203220526567.png\" alt=\"image-20230203220526567\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">vlan batch 30 100 200</span><br><span class=\"line\">vsys enable</span><br><span class=\"line\">vsys name A 1</span><br><span class=\"line\"> assign vlan 100</span><br><span class=\"line\"> assign global-ip 203.1.1.1 203.1.1.10 free</span><br><span class=\"line\">interface Vlanif100</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.100.100 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Vlanif200</span><br><span class=\"line\"> ip address 192.168.200.200 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip binding vpn-instance default</span><br><span class=\"line\"> ip address 192.168.0.1 255.255.255.0</span><br><span class=\"line\"> alias GE0/METH</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/1</span><br><span class=\"line\"> portswitch</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> port link-type trunk</span><br><span class=\"line\"> port trunk allow-pass vlan 2 to 4094</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/4</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/5</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet1/0/6</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">interface NULL0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone local</span><br><span class=\"line\"> set priority 100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface GigabitEthernet0/0/0</span><br><span class=\"line\"> add interface Virtual-if0</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Vlanif200</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone dmz</span><br><span class=\"line\"> set priority 50</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 192.168.200.1</span><br><span class=\"line\">ip route-static 203.1.1.0 255.255.255.240 vpn-instance A</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface con 0</span><br><span class=\"line\"> authentication-mode aaa</span><br><span class=\"line\"> idle-timeout 0 0</span><br><span class=\"line\">user-interface vty 0 4</span><br><span class=\"line\"> authentication-mode aaa</span><br><span class=\"line\"> protocol inbound ssh</span><br><span class=\"line\">user-interface vty 16 20</span><br><span class=\"line\">#</span><br><span class=\"line\">switch vsys A</span><br><span class=\"line\">sys </span><br><span class=\"line\">interface Vlanif100</span><br><span class=\"line\"> ip binding vpn-instance A</span><br><span class=\"line\"> ip address 192.168.100.100 255.255.255.0</span><br><span class=\"line\"> service-manage ping permit</span><br><span class=\"line\"></span><br><span class=\"line\">firewall zone local</span><br><span class=\"line\"> set priority 100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone trust</span><br><span class=\"line\"> set priority 85</span><br><span class=\"line\"> add interface Vlanif100</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone untrust</span><br><span class=\"line\"> set priority 5</span><br><span class=\"line\"> add interface Virtual-if1</span><br><span class=\"line\">#</span><br><span class=\"line\">firewall zone dmz</span><br><span class=\"line\"> set priority 50</span><br><span class=\"line\">#</span><br><span class=\"line\">location</span><br><span class=\"line\">#</span><br><span class=\"line\">nat address-group A 0</span><br><span class=\"line\"> mode pat</span><br><span class=\"line\"> section 0 203.1.1.1 203.1.1.3</span><br><span class=\"line\">#</span><br><span class=\"line\">multi-linkif</span><br><span class=\"line\"> mode proportion-of-weight</span><br><span class=\"line\">#</span><br><span class=\"line\">security-policy</span><br><span class=\"line\"> rule name test</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class=\"line\">  action permit</span><br><span class=\"line\">#</span><br><span class=\"line\">auth-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">traffic-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">policy-based-route</span><br><span class=\"line\">#</span><br><span class=\"line\">nat-policy</span><br><span class=\"line\"> rule name A</span><br><span class=\"line\">  source-zone trust</span><br><span class=\"line\">  destination-zone untrust</span><br><span class=\"line\">  source-address 192.168.1.0 mask 255.255.255.0</span><br><span class=\"line\">  source-address 192.168.2.0 mask 255.255.255.0</span><br><span class=\"line\">  action source-nat address-group A</span><br><span class=\"line\">#</span><br><span class=\"line\">quota-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">pcp-policy</span><br><span class=\"line\">#</span><br><span class=\"line\">ip route-static 0.0.0.0 0.0.0.0 public</span><br><span class=\"line\">ip route-static 192.168.1.0 255.255.255.0 192.168.100.1</span><br><span class=\"line\">ip route-static 192.168.2.0 255.255.255.0 192.168.100.1</span><br><span class=\"line\">#</span><br><span class=\"line\">return</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n",
            "tags": [
                "网络"
            ]
        },
        {
            "id": "http://example.com/2023/01/17/Segment%20Routing/",
            "url": "http://example.com/2023/01/17/Segment%20Routing/",
            "title": "Segment Routing",
            "date_published": "2023-01-17T05:38:45.000Z",
            "content_html": "<h2 id=\"0为什么需要sr\"><a class=\"markdownIt-Anchor\" href=\"#0为什么需要sr\">#</a> 0. 为什么需要 SR</h2>\n<p>1、简化底层控制平面，以 MPLS VPN 举例，需要部署 IGP、BGP、MPLS LDP 协议</p>\n<p>2、网络发展诉求，SDN 化</p>\n<p>1、简化控制平面，不存在 LDP 与 IGP 同步问题</p>\n<p>2、IP 骨干网可能有流量工程需求，需要部署 MPLS-TE，通过 RSVP 在端到端设备之间维护大量状态信息</p>\n<h2 id=\"1igp与ldp同步\"><a class=\"markdownIt-Anchor\" href=\"#1igp与ldp同步\">#</a> 1.IGP 与 LDP 同步</h2>\n<p>正常情况通过主 LSP 转发，如果主链路故障通过备 LSP 转发</p>\n<p><code>ospf  timer  lsp-sync  hold-max-cost ldp</code>  不同步时发布最大开销的 LSA</p>\n<p>SR 将 OSPF，ISIS，BGP 与标签结合，不存在同步问题，路由计算和标签分发都通过 IGP 或 BGP 实现，也称为 SR-MPLS BE（best effort），在控制平面移除了 LDP</p>\n<p>SR-MPLS TE（流量工程）对标 MPLS TE，控制平面移除了 RSVP 协议</p>\n<h2 id=\"2sr-分段路由-基本概念\"><a class=\"markdownIt-Anchor\" href=\"#2sr-分段路由-基本概念\">#</a> 2.SR - 分段路由 - 基本概念</h2>\n<p>SR 域（Segment Routing Domain）：SR 节点的集合。</p>\n<p>SID：即 Segment ID，用来标识唯一的段。在转发层面，可以映射为 MPLS 标签。</p>\n<p>SRGB（Segment Routing Global Block）：用户指定的为 Segment Routing MPLS 预留的全局标签集合。</p>\n<p>SRLB（Segment Routing Local Block）：用户指定的为 Segment Routing MPLS 预留的本地标签集合。这些标签在本地配置，仅在本地有效，但是会通过 IGP 对外发布，所以是全局可见。SRLB 当前主要用于配置 Binding SID。</p>\n<p><code>segement</code> : 节点对数据包要执行的指令</p>\n<p><code>Segment ID</code> ：IPV4 中为标签，IPV6 中为 ipv6 地址。用于标识 Segment。网络中的每个节点，链路都可以称为 Segment id</p>\n<p><code>源路由</code> ：源节点选择一条路径并压入有序的 Segment List，其他节点按照 segmeng list 转发</p>\n<p>通过对 IGP，BGP 扩展之后，可以实现源路由转发</p>\n<p><code>prefix segment</code> : 用于标识网络中的某个目的地址前缀，全局有效</p>\n<p><code>SRGB</code> ：用户指定的为 Segment Routing MPLS 预留的全局标签集合</p>\n<p><code>Adjacency Segment</code> : 用于标识网络中的某个邻接，本地有效</p>\n<h2 id=\"3segment分类\"><a class=\"markdownIt-Anchor\" href=\"#3segment分类\">#</a> 3.segment 分类</h2>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206211033379.png\" alt=\"image-20230206211033379\"></p>\n<p>Node SID + adjacent SID</p>\n<h2 id=\"4ospf-for-sr-mpls\"><a class=\"markdownIt-Anchor\" href=\"#4ospf-for-sr-mpls\">#</a> 4.ospf for SR-MPLS</h2>\n<p>配置：</p>\n<p>1. 配置接口地址</p>\n<p>2. 使能 MPLS</p>\n<p>3. 全局使能 segment-routing</p>\n<p>4. 配置 IGP/BGP 路由协议</p>\n<p>5. 配置 IGP/BGP 对 SR 支持</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">undo DCN  //使用DCN功能实现网管通过网关网元对网元的远程管理</span><br><span class=\"line\">segment-routing</span><br><span class=\"line\"></span><br><span class=\"line\">ospf 1 router 1.1.1.1</span><br><span class=\"line\">network</span><br><span class=\"line\">opaque enable //OSPF引入type 10 opeart LSA支持SR</span><br><span class=\"line\">segment  mpls </span><br><span class=\"line\">segment global-block 16000 23999(SRGB)</span><br><span class=\"line\"></span><br><span class=\"line\">int l 0</span><br><span class=\"line\">ospf prefix-sid index 10 (node sid)</span><br><span class=\"line\"></span><br><span class=\"line\">display tunel all</span><br></pre></td></tr></table></figure>\n<p>扩展：通过 type 10 LSA</p>\n<p>type 10 LSA 使用 TLV 架构，携带三种 segment ID</p>\n<p>其中 type 10 中又包含了 type-4,7,8 满足对于 SR 相关信息的携带</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206220417399.png\" alt=\"image-20230206220417399\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:4.0.0.0  //opaque类型,本地SRGB范围</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:4</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">Router-Information LSA TLV information:</span><br><span class=\"line\">  SR-Algorithm TLV    //tlv-type8</span><br><span class=\"line\">    Algorithm:spf  //对外通告自己使用算法</span><br><span class=\"line\">\tSID/Label Range TLV: //SID或MPLS标签范围,type 9 tlv</span><br><span class=\"line\">\t\tRange Size: 8000  //范围内LSA数量</span><br><span class=\"line\">\t\tSID/Label sub-tlv:  //tlv type 1</span><br><span class=\"line\">\t\t\tLabel:16000 //起始范围</span><br><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:7.0.0.0  //opaque类型</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:7</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">OSPFv2 Extended Prefix opaque LSA TLV information: //携带自身环回前缀信息，以及index值，即前缀SID(节点SID)</span><br><span class=\"line\">  OSPFV2 Extended Prefix TLV:  //tlv type1</span><br><span class=\"line\">\t\tRoute Type: Intra-Area </span><br><span class=\"line\">\t\tAF: IPV4-unicast</span><br><span class=\"line\">    flags:0x40</span><br><span class=\"line\">    prefix:1.1.1.1/32</span><br><span class=\"line\">    prefix SID sub-tlv:  //tlv type2</span><br><span class=\"line\">    \tflags: 0x00</span><br><span class=\"line\">      MT ID :0</span><br><span class=\"line\">\t\t\tAlgorithm: SPF</span><br><span class=\"line\">      index:10 //接口配置的偏移值或绝对值</span><br><span class=\"line\">type:opq-Area</span><br><span class=\"line\">LS-id:8.0.0.0  //opaque类型</span><br><span class=\"line\">Adv rtr: 1.1.1.1 //产生者router-id</span><br><span class=\"line\">opaque type:8</span><br><span class=\"line\">opaque id:0</span><br><span class=\"line\">OSPFV2 Extended Link opaque LSA TLV information: //携带邻接信息包括本地接口地址，链路类型，以及邻接SID标识这个邻居</span><br><span class=\"line\">\tOSPFV2 Extended Link TLV:  //tlv type 1</span><br><span class=\"line\">\t\tLink Type: TransNet</span><br><span class=\"line\">    link ID:10.1.12.1  //DR</span><br><span class=\"line\">    link data: 10.1.12.1</span><br><span class=\"line\">    LAN adj-sid sub-tlv:  //tlv type 2</span><br><span class=\"line\">    \tflags:0x60</span><br><span class=\"line\">      MT ID:0</span><br><span class=\"line\">      Weight:0</span><br><span class=\"line\">      Neighor ID:2.2.2.2</span><br><span class=\"line\">      Label:48020</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230206222830799.png\" alt=\"image-20230206222830799\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230209160852576.png\" alt=\"image-20230209160852576\"></p>\n<h2 id=\"5mpls-be隧道建立\"><a class=\"markdownIt-Anchor\" href=\"#5mpls-be隧道建立\">#</a> 5.MPLS BE 隧道建立</h2>\n<p>SR 转发模型，类似 MPLS 环境，一条 SR MPLS BE 隧道包含入节点、交换节点、出节点、也具备倒数第二跳弹出</p>\n<p>节点不会再通告，基于去往目的前缀的下一跳 SRGB 初始值 + 该前缀的 prfix id index 值得到 out Lable</p>\n<p>存在倒数第二跳弹出，实际 19040 会变为 3</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374024961-016f137e-1813-497a-941a-5f940ffe0190.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tracert lsp segment ip 4.4.4.4 32 ver d</span><br><span class=\"line\">//看Segment Routing的标签转发表信息</span><br><span class=\"line\">display segment-routing prefix mpls forwarding</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374210842-a5d77af0-bd44-4659-8bc4-29d0d5a541de.png\" alt=\"img\"></p>\n<p>每台设备通过扩展的路由协议通告自己的 SRGB。</p>\n<p>节点通过扩展的路由协议通告前缀 SID 索引 (Index) 后，各台设备分别根据 SRGB 计算入站及出站 SID。</p>\n<p>1、建议每台设备配置一样的 SRGB</p>\n<p>2、基于全局的 prefix SID 统一标签值，方便管理一些。此时每台设备 index 需要唯一</p>\n<p>MPLS-BE 场景</p>\n<p>1. 基于 prefix-segment</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374929567-d3e112af-1144-4823-b44f-503e393cad0d.png\" alt=\"img\"></p>\n<p>2. 基于 adjacency segment</p>\n<p>segment-routing auto-adj-sid disable 命令关闭动态邻接标签</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374954780-23325eae-ad31-4c4b-b044-4876095d1c98.png\" alt=\"img\"></p>\n<p>3. 基于 adjacency segment+prefix-segment</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645374976244-cae7b3c0-6b36-4713-becd-d6b477998564.png\" alt=\"img\"></p>\n<p>使用承载业务</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645377347132-0fa0a128-f5d2-4a00-b649-4b483465be71.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tunnel policy to_pe4</span><br><span class=\"line\">tunnel select-seq se-lsp load 8</span><br><span class=\"line\"></span><br><span class=\"line\">ip vpn site_a</span><br><span class=\"line\">ipv4</span><br><span class=\"line\">tnl-policy to_pe4</span><br></pre></td></tr></table></figure>\n<h2 id=\"6prefix-sid-sub-tlv-flag\"><a class=\"markdownIt-Anchor\" href=\"#6prefix-sid-sub-tlv-flag\">#</a> 6.prefix SID sub tlv flag</h2>\n<p>特殊标签同样适用于 SR 场景</p>\n<p>NP：No-PHP（Penultimate Hop Popping，倒数第二跳弹出）标志。如果置位，不启用倒数第二跳弹出特性，倒数第二跳在转发报文给 Egress 节点时，不能弹出 Egress 节点标签。</p>\n<p>M：Mapping Server 标记。如果置位，表示 SID 是由一个 Mapping Server 发布。</p>\n<p>E：显式空标签（Explicit-Null）标志。如果置位，则启用显式空标签特性，上游邻居在转发报文时，必须把标签替换为显式空标签。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">mpls                         //egress </span><br><span class=\"line\">label advertise explict-     //通告显示空标签</span><br></pre></td></tr></table></figure>\n<p>V：Value 标志。如果置位，则 Prefix-SID 携带 Value，代替索引（Index）。缺省未置位。</p>\n<p>L：Local 标志。如果置位，表示 Prefix-SID 携带的 Value/Index 具有本地意义。缺省未置位。</p>\n<p>如果 NP 标志置位，然后：E 标志未置位，则任何 Prefix-SID 生成者的上游邻居必须保留对应的 Prefix-SID 标签在标签栈顶。这种方式可能用于路径粘连，比如 Prefix-SID 生成者可能使用该标签将报文转到其他的 MPLS LSP 中。E 标志置位，则任何 Prefix-SID 生成者的上游邻居必须将对应的 Prefix-SID 标签替换为显式空标签。此种方式下可以保留 MPLS EXP 标志位，如果 Prefix-SID 生成者就是报文的目的地址，则可以接收到原始 MPLS EXP。MPLS EXP 标志可以用于 QoS 服务。</p>\n<h2 id=\"sr-mpls-be-解决bgp路由黑洞问题\"><a class=\"markdownIt-Anchor\" href=\"#sr-mpls-be-解决bgp路由黑洞问题\">#</a> SR-MPLS BE 解决 BGP 路由黑洞问题</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">route recursive tunnel</span><br></pre></td></tr></table></figure>\n<p>其他参考 MPLS-LDP 场景</p>\n<h2 id=\"7isis对于实现sr-mpls支持\"><a class=\"markdownIt-Anchor\" href=\"#7isis对于实现sr-mpls支持\">#</a> 7.ISIS 对于实现 SR-MPLS 支持</h2>\n<p>配置</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[ISIS]</span><br><span class=\"line\">  network-entity </span><br><span class=\"line\">  is-level</span><br><span class=\"line\">  cost-style wide</span><br><span class=\"line\">  segment-routing mpls</span><br><span class=\"line\">  segment-routing global-block 16000 23999</span><br><span class=\"line\">[interface Loopback]</span><br><span class=\"line\">\tisis enable</span><br><span class=\"line\">  isis prefix-sid index 10</span><br><span class=\"line\">[interface Ethe1/0/0]</span><br><span class=\"line\">\tisis enable </span><br></pre></td></tr></table></figure>\n<p>1、ospf 大部分 LSA 报文结构设计相对固定，无法扩展，引入其它 tlv 能力的 LSA 实现扩充</p>\n<p>2、IS-Is 所有报文包括 LSP 天然支持扩充能力，有大量灵活的 tlv，有扩展需求，挂载 tlv 即可</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645428709138-e3c81cf0-a983-4884-b0da-3404ea43f54c.png\" alt=\"img\"></p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230209210945528.png\" alt=\"image-20230209210945528\"></p>\n<h2 id=\"8sr-be与ldp互通\"><a class=\"markdownIt-Anchor\" href=\"#8sr-be与ldp互通\">#</a> 8.SR-BE 与 LDP 互通</h2>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">segment-routing</span><br><span class=\"line\">mapping-server prefix-sid 20.1.1.1 32 999</span><br><span class=\"line\"></span><br><span class=\"line\">ospf</span><br><span class=\"line\">segment mapping-server send</span><br><span class=\"line\"></span><br><span class=\"line\">mpls </span><br><span class=\"line\">lsp-trigger segment-routing-interworking best-effort host</span><br></pre></td></tr></table></figure>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230210145555435.png\" alt=\"image-20230210145555435\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br><span class=\"line\">119</span><br><span class=\"line\">120</span><br><span class=\"line\">121</span><br><span class=\"line\">122</span><br><span class=\"line\">123</span><br><span class=\"line\">124</span><br><span class=\"line\">125</span><br><span class=\"line\">126</span><br><span class=\"line\">127</span><br><span class=\"line\">128</span><br><span class=\"line\">129</span><br><span class=\"line\">130</span><br><span class=\"line\">131</span><br><span class=\"line\">132</span><br><span class=\"line\">133</span><br><span class=\"line\">134</span><br><span class=\"line\">135</span><br><span class=\"line\">136</span><br><span class=\"line\">137</span><br><span class=\"line\">138</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[HUAWEI-mpls]dis cu </span><br><span class=\"line\">!Software Version V800R011C00SPC607B607</span><br><span class=\"line\">!Last configuration was updated at 2023-02-10 14:50:51+00:00</span><br><span class=\"line\">#</span><br><span class=\"line\">sysname HUAWEI</span><br><span class=\"line\">#</span><br><span class=\"line\">set neid 18a90</span><br><span class=\"line\">#</span><br><span class=\"line\">vsm on-board-mode enable</span><br><span class=\"line\">#</span><br><span class=\"line\">snmp-agent trap type base-trap</span><br><span class=\"line\">#</span><br><span class=\"line\">icmp rate-limit disable</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls lsr-id 8.8.8.8</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls</span><br><span class=\"line\"> lsp-trigger segment-routing-interworking best-effort host</span><br><span class=\"line\">#</span><br><span class=\"line\">mpls ldp</span><br><span class=\"line\"> #</span><br><span class=\"line\"> ipv4-family</span><br><span class=\"line\">#</span><br><span class=\"line\">aaa</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authentication-scheme default</span><br><span class=\"line\">  authentication-mode local radius</span><br><span class=\"line\"> #</span><br><span class=\"line\"> authorization-scheme default</span><br><span class=\"line\"> #</span><br><span class=\"line\"> accounting-scheme default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> accounting-scheme default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default0</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default1</span><br><span class=\"line\"> #</span><br><span class=\"line\"> domain default_admin</span><br><span class=\"line\">#</span><br><span class=\"line\">license</span><br><span class=\"line\">#</span><br><span class=\"line\">segment-routing</span><br><span class=\"line\"> mapping-server prefix-sid-mapping 4.4.4.4 32 99 </span><br><span class=\"line\">#</span><br><span class=\"line\">isis 1</span><br><span class=\"line\"> is-level level-2</span><br><span class=\"line\"> cost-style wide</span><br><span class=\"line\"> network-entity 49.0001.0000.0000.0004.00</span><br><span class=\"line\"> segment-routing mpls</span><br><span class=\"line\"> segment-routing global-block 16000 23999</span><br><span class=\"line\"> segment-routing mapping-server send </span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.78.8 255.255.255.0</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> undo dcn</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/1</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> ip address 10.1.38.8 255.255.255.0</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> mpls</span><br><span class=\"line\"> mpls ldp</span><br><span class=\"line\"> undo dcn</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/2</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/3</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/4</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/5</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/6</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/7</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/8</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface Ethernet1/0/9</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\"> undo dcn mode vlan</span><br><span class=\"line\">#</span><br><span class=\"line\">interface GigabitEthernet0/0/0</span><br><span class=\"line\"> undo shutdown</span><br><span class=\"line\">#</span><br><span class=\"line\">interface LoopBack0</span><br><span class=\"line\"> ip address 8.8.8.8 255.255.255.255</span><br><span class=\"line\"> isis enable 1</span><br><span class=\"line\"> isis prefix-sid index 40</span><br><span class=\"line\">#</span><br><span class=\"line\">interface NULL0</span><br><span class=\"line\">#</span><br><span class=\"line\">undo dcn</span><br><span class=\"line\">#</span><br><span class=\"line\">lldp enable</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh authorization-type default aaa</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh server cipher aes256_gcm aes128_gcm aes256_ctr aes192_ctr aes128_ctr aes256_</span><br><span class=\"line\">cbc aes128_cbc 3des_cbc</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh server dh-exchange min-len 1024</span><br><span class=\"line\">#</span><br><span class=\"line\">ssh client cipher aes256_gcm aes128_gcm aes256_ctr aes192_ctr aes128_ctr aes256_</span><br><span class=\"line\">cbc aes128_cbc 3des_cbc</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface con 0</span><br><span class=\"line\">#</span><br><span class=\"line\">user-interface aux 0</span><br><span class=\"line\">#</span><br><span class=\"line\">local-aaa-server</span><br><span class=\"line\">#</span><br><span class=\"line\">vm-manager</span><br><span class=\"line\">#</span><br><span class=\"line\">return</span><br></pre></td></tr></table></figure>\n<h2 id=\"9粘连标签与标签栈\"><a class=\"markdownIt-Anchor\" href=\"#9粘连标签与标签栈\">#</a> 9. 粘连标签与标签栈</h2>\n<p>当标签栈深度超过转发器所支持的标签栈深度时，控制器需要为转发器分配多个标签栈，在合适的节点下发标签栈的同时分配一种特殊的标签，然后将这些标签栈关联起来，实现逐段转发。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1645544995222-bac36ee4-f184-4267-a87d-75b91dcde1d8.png\" alt=\"img\"></p>\n<h2 id=\"10mpls-te\"><a class=\"markdownIt-Anchor\" href=\"#10mpls-te\">#</a> 10.MPLS-TE</h2>\n<p>MPLS TE 隧道所使用的 LSP 称为基于一定约束条件建立的 LSP (Constraint-based Routed Label Switched Path) ，简称为 CR-LSP。</p>\n<p>约束条件主要包括带宽约束和路径约束两个方面，只有隧道所经过的链路满足约束条件才能成功地建立 CR-LSP，凭借约束条件可以更好地根据现有网络的情况规划业务。</p>\n<p>CR_LSP 单向，一般是在头结点部署</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">isis</span><br><span class=\"line\">is-level level-2</span><br><span class=\"line\">cost wide </span><br><span class=\"line\">network-entity</span><br><span class=\"line\">traffic level-2</span><br><span class=\"line\"></span><br><span class=\"line\">mpls lsr-id</span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls  te</span><br><span class=\"line\">mpls revp-te</span><br><span class=\"line\"></span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls </span><br><span class=\"line\">mpls te</span><br><span class=\"line\">mpls rsvp-te</span><br><span class=\"line\"></span><br><span class=\"line\">头结点 &amp; 伪节点</span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls te cspf</span><br><span class=\"line\"></span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls te bandwidth max 100000</span><br><span class=\"line\">mpls te bandwidth bc0 100000</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/1</span><br><span class=\"line\">ip add unnumbered int l 0 </span><br><span class=\"line\">tunnel mpls te</span><br><span class=\"line\">dest 4.4.4.4</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te banswidthct0 60000</span><br></pre></td></tr></table></figure>\n<h3 id=\"101cspf算法\"><a class=\"markdownIt-Anchor\" href=\"#101cspf算法\">#</a> 10.1CSPF 算法</h3>\n<p>根据以下信息来进行 CSPF 算法：</p>\n<p>1. 带宽（链路的最大可预留带宽，BC 带宽，CT 带宽）不满足带宽需求的节点不会出现在最短路径中</p>\n<p>2. 链路属性，可选（链路颜色，隧道颜色） 需要手工配置，用于选路。通过配置隧道颜色来约束选路。隧道接口、设备之间互联链路都需要配置隧道颜色，即亲和属性</p>\n<p>3. 根据 1,2 步骤计算最短路径拓扑之后，出现了两条路径。比较 TE-cost 执行选路。</p>\n<p>通过 CSPF 算法计算后，一旦出现等价路径，采用 CSPF 最高仲裁选择 — 条到尾节点路径</p>\n<h3 id=\"102-路径选择-松散严格显式路径\"><a class=\"markdownIt-Anchor\" href=\"#102-路径选择-松散严格显式路径\">#</a> 10.2 路径选择 - 松散 / 严格显式路径</h3>\n<p>松散显示路径：</p>\n<p>松散方式可以指定路径上必须经过哪些节点，但是该节点和前一跳之间可以存在其他路由器。</p>\n<p>严格显示路径：</p>\n<p>所谓的严格显式路径，就是下一跳与前一跳直接相连。通过严格显式路径，可以最精确地控制 LSP 所经过的路径。</p>\n<p>混合显示路径：</p>\n<p>严格与松散结合</p>\n<h3 id=\"103管理组-亲和属性\"><a class=\"markdownIt-Anchor\" href=\"#103管理组-亲和属性\">#</a> 10.3 管理组、亲和属性</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">管理组（Administration Group）</span><br></pre></td></tr></table></figure>\n<p>也称链路颜色，用来描述链路的属性。由 32 个 Bit 组成，每一位都可以单独表示链路的一个属性，用于管理拥有这些特征的链路，在物理接口下配置。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">亲和属性（Affinity Attributes）</span><br></pre></td></tr></table></figure>\n<p>是用来描述 TE 隧道所需链路的 32 位向量值，与管理组属性类似，在这里可以理解为隧道颜色，在隧道的首节点配置实施（隧道信息，不通过 IGP 发布）。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">掩码（Mask）</span><br></pre></td></tr></table></figure>\n<p>由 32 个 Bit 组成，决定了设备需要检查的链路属性，只有隧道颜色和链路颜色匹配才能进行正常的数据转发。实际应用中，就是通过修改掩码来选择链路。</p>\n<p><strong>掩码为 0 的位，不限制链路管理组属性。</strong></p>\n<p><strong>掩码为 1 的位，如果亲和属性为 0，链路管理组属性也必须为 0；如果亲和属性为 1，链路管理组属性至少 1 位是 1 即可。</strong></p>\n<p>在 Tunnel 进行路径选择时，首先需要满足带宽需求，再根据接口（链路）的管理组属性需匹配其亲和属性才有资格被选择。只有带宽匹配不能进行选择</p>\n<p>亲合属性 10101 掩码 11011 管理组属性可能的值为   10001 10000 00001 10101 10100 00101</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">[R1-GigabitEthernet1/0/0]mpls te link administrative group 10001  //配置管理组</span><br><span class=\"line\">[R1-Tunnel1]mpls te affinity property 10101 mask 11011</span><br></pre></td></tr></table></figure>\n<p>由于 LSP 中携带亲和属性，因此亲和属性和管理组的匹配都在头结点进行</p>\n<p>有多条隧道时，可以通过隧道优先级来设置优先选择隧道 <code>mpls te priority </code> ，在头结点隧道接口配置</p>\n<p>验证： tracert lsp te tunnel 0/0/1</p>\n<h2 id=\"10sr-mpls-te\"><a class=\"markdownIt-Anchor\" href=\"#10sr-mpls-te\">#</a> 10.SR-MPLS-TE</h2>\n<p>SR-MPLS TE（Segment Routing-MPLS Traffic Engineering）是使用 SR 作为控制协议的一种新型的 TE 隧道技术。SR-MPLS TE 支持采用集中式架构，控制器收集全局网络拓扑信息和 TE 信息，集中算路，然后把算路结果下发给网络设备。</p>\n<p>集中式 SR-MPLS TE：</p>\n<p>1. 扩展 IS-IS/OSPF 携带 TE 信息，在域内泛洪 IGP 和 TE 信息，生成 TEDB。</p>\n<p>2. 通过 BGP-LS 收集网络信息，建立全局 TE 数据库。</p>\n<p>3. 控制器基于约束全局算路。</p>\n<p>4. 使用 PCEP 或 BGP SR Policy 将算路结果下发设备。</p>\n<p>网络拓扑收集</p>\n<p>1.IGP 协议收集网络拓扑信息</p>\n<p>转发器的 IGP 协议收集网络拓扑信息，收集 SR 的邻接标签和节点标签。</p>\n<p>2.BGP-LS 上报网络拓扑信息</p>\n<p>BGP-LS 将带有 SR 标签信息的网络拓扑和 TE 信息上报给控制器。</p>\n<p>使用多个 SID 进行组合来指导数据转发，这种工作机制可以对数据的转发路径进行一定约束，从而满足流量工程的需求，因此被称为 SR-MPLS TE</p>\n<p>SR TE SID 的组合形式：</p>\n<p>使用多个 Adjacency SID。</p>\n<p>使用 Node SID 与 Adjacency SID 组合</p>\n<p><img data-src=\"https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230214221712920.png\" alt=\"image-20230214221712920\"></p>\n<h3 id=\"sp-mpls-te单域\"><a class=\"markdownIt-Anchor\" href=\"#sp-mpls-te单域\">#</a> SP-MPLS TE 单域</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1、SR、Is-is规划</span><br><span class=\"line\">2、配置TE相关信息，接口带宽信息</span><br><span class=\"line\">3、SR-MPLS TE头节点tunne1接口</span><br><span class=\"line\"></span><br><span class=\"line\">mpls</span><br><span class=\"line\">mpls te </span><br><span class=\"line\">int ethe 1/0/0</span><br><span class=\"line\">mpls </span><br><span class=\"line\">mpls te </span><br><span class=\"line\"></span><br><span class=\"line\">isis</span><br><span class=\"line\">level 2</span><br><span class=\"line\">wide </span><br><span class=\"line\">netentity</span><br><span class=\"line\">traffic-eng</span><br><span class=\"line\">segment mpls</span><br><span class=\"line\">segment global 16000 23999</span><br><span class=\"line\"></span><br><span class=\"line\">int l 0 </span><br><span class=\"line\">isis pre in 10</span><br><span class=\"line\"></span><br><span class=\"line\">头结点</span><br><span class=\"line\">int t0/0/1 </span><br><span class=\"line\">ip add un in l 0 </span><br><span class=\"line\">tunnel-protocol mpls te</span><br><span class=\"line\">des 4.4.4.4</span><br><span class=\"line\">mpls te singal-protocol segment-routing</span><br><span class=\"line\">mpls te tunnel-di 1 </span><br><span class=\"line\"></span><br><span class=\"line\">头结点</span><br><span class=\"line\">explicit-path  to4pe</span><br><span class=\"line\">next sid label 48140 adja</span><br><span class=\"line\">next sid label 48141 adja</span><br><span class=\"line\">next sid label 48142 adja</span><br><span class=\"line\">int t0/0/1</span><br><span class=\"line\">mplt te ex to4pe</span><br><span class=\"line\"></span><br><span class=\"line\">尾节点</span><br><span class=\"line\"></span><br><span class=\"line\">tunnel-policy pe4</span><br><span class=\"line\">tunnel select sr-te  load 1</span><br><span class=\"line\">ip vpn a</span><br><span class=\"line\">tnl pe4</span><br></pre></td></tr></table></figure>\n<h3 id=\"sp-mpls-te-跨域e2e跨域\"><a class=\"markdownIt-Anchor\" href=\"#sp-mpls-te-跨域e2e跨域\">#</a> SP-MPLS TE 跨域 (E2E 跨域)</h3>\n<p>1. 配置思路</p>\n<p>1、AS10、20 内部规划 IGP IS-IS，并配置 SR-MPLS</p>\n<p>2、端到端配置 MPLS，MPLS TE，每个 AS 内配置 SR-MPLS TE 隧道；PE 之间建立跨域 E2E SR-MPLS TE 隧道</p>\n<p>3、ASBR 之间配置 EBGP 邻居，要求 BGP 可以分配 sID</p>\n<p>4、PE 之间建立 SR-MPLS TE E2E 跨域隧道，使用 tunnel3</p>\n<p>不直接在 PE 之间建立隧道，在 AS 内部 PE 和 ASBR 之间建立隧道，减少标签栈深度</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">IP MPLS IGP TE</span><br><span class=\"line\"></span><br><span class=\"line\">PE</span><br><span class=\"line\">explicit-path to_asbr</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\">next sid label 48141 type adja</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/01</span><br><span class=\"line\">ip add unnum int l 0 </span><br><span class=\"line\">tunnel-pro mpls te</span><br><span class=\"line\">dest 3.3.3.3</span><br><span class=\"line\">mpls te signal-protoc segment</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te path explicit to_asbr</span><br><span class=\"line\"></span><br><span class=\"line\">ASBR</span><br><span class=\"line\">explict to_pe</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\">next sid label 48140 type adja</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/01</span><br><span class=\"line\">ip add unnum int l 0 </span><br><span class=\"line\">tunnel-pro mpls te</span><br><span class=\"line\">dest 1.1.1.1</span><br><span class=\"line\">mpls te signal-protoc segment</span><br><span class=\"line\">mpls te tunnel-id 1</span><br><span class=\"line\">mpls te path explicit to_asbr</span><br><span class=\"line\"></span><br><span class=\"line\">ASBR-ASBR</span><br><span class=\"line\">ip rou 4.4.4.4 32 10.1.34.4</span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 4.4.4.4 as 200</span><br><span class=\"line\">peer 4.4.4.4 con l 0 </span><br><span class=\"line\">peer 4.4.4.4 ebgp</span><br><span class=\"line\">peer 4.4.4.4 egress-eng</span><br><span class=\"line\">net 6.6.6.6</span><br><span class=\"line\">link-state unicast</span><br><span class=\"line\"></span><br><span class=\"line\">isis </span><br><span class=\"line\">import bgp</span><br><span class=\"line\"></span><br><span class=\"line\">PE</span><br><span class=\"line\">int  t0/0/1</span><br><span class=\"line\">mpls te binding label 1000</span><br><span class=\"line\"></span><br><span class=\"line\">explicit to_pe6</span><br><span class=\"line\">next sid label 1000</span><br><span class=\"line\">next sid label 48182</span><br><span class=\"line\">next label 2000</span><br><span class=\"line\"></span><br><span class=\"line\">int t0/0/3</span><br><span class=\"line\">ip add</span><br><span class=\"line\">tunnel mpls te </span><br><span class=\"line\">mpls te signal segment</span><br><span class=\"line\">des 6.6.6.6</span><br><span class=\"line\">mpls te tu 2</span><br><span class=\"line\">mpls te ex to_pe6</span><br><span class=\"line\"></span><br><span class=\"line\">bgp 100</span><br><span class=\"line\">peer 6.6.6.6 as 200</span><br><span class=\"line\">peer 6.6.6.6 con l 0 </span><br><span class=\"line\">peer 6.6.6.6 ebgp</span><br><span class=\"line\">ipv4 vpnv4</span><br><span class=\"line\">prrt 6.6.6.6 en</span><br><span class=\"line\">ipv4 vpn-instance </span><br><span class=\"line\"></span><br><span class=\"line\">tunnel-policy to_pe6</span><br><span class=\"line\">tunnel ses sr-te lo 1</span><br><span class=\"line\">ip vpn </span><br><span class=\"line\">tnl </span><br></pre></td></tr></table></figure>\n<p>Binding SID</p>\n<p>SR-MPLS TE 隧道可以做为一种转发邻接。如果将 SR-MPLS TE 隧道做为转发邻接分配一个邻接 SID（Adjacency SID），则该 SID 可以标识 SR-MPLS TE 隧道，利用这个 SID 就可以将数据流量导入 SR-MPLS TE 隧道，实施 TE 策略</p>\n<p>Binding SID 意味着将使用该 SID 的流量与一个 SR-MPLS TE 隧道或者一个 TE 策略绑定。Binding SID 在 AS 域内的转发器上配置，一个 Binding SID 代表一条域内 SR-MPLS TE 隧道</p>\n<h2 id=\"srv6\"><a class=\"markdownIt-Anchor\" href=\"#srv6\">#</a> SRv6</h2>\n<p>使用 IPv6 数据平面，基于 IPv6 路由扩展头进行扩展</p>\n<p>通过在 IPV6 报头中增加 SRH 扩展头实现 SRv6</p>\n<p>该扩展头指定一个 IPv6 的显式路径，存储的是 IPv6 的 Segment List 信息，其作用与 SR MPLS 里的 Segment List 一样。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646962227447-7498c5a3-ab67-417c-a6bb-6cf6e7e4486c.png\" alt=\"img\"></p>\n<p><code>Segment List</code> : 有序的 SRv6 SID 列表</p>\n<p><code>Segments Left(SL)</code> : SRv6 激活的 SID 为 Slist [SL]。转发过程中通过修改 SL，同时更换 DIP 为活跃的 SID 来分段完成转发。</p>\n<p><code>Tag</code> : 用于对数据包分组，可以实现基于组的策略。</p>\n<p><code>SRH TLVs </code> (NSH metadata，HMAC TLV,Padding TLv 等)︰可以作为 Segment List 的 sID 共同使用的全局参数。</p>\n<p>通过扩展头 SRH 中内容确定 IPV6destination address。</p>\n<p>在 SRv6 中，IPv6 DA 仅标识当前报文的下一个节点，是不断变换的。</p>\n<p>&lt;Segment List [0], Segment List [1], …, Segment List [n-1], Segment List [n]&gt;：SRv6 报文的段列表，类似于 SR-MPLS 中的 MPLS 标签栈信息，在入节点生成。Segment List [n] 是 SRv6 路径上第一个需要被处理的 Segment List；Segment List [n-1] 是第二个；Segment List [1] 是倒数第二个；Segment List [0] 是倒数第一个。</p>\n<p>SRv6 按照从栈底从栈顶处理 segment list，和 SR 相反</p>\n<p>在 SRv6 中，每经过一个 SRv6 节点，Segments Left（SL）字段减 1，IPv6 DA 信息变换一次。Segments Left 和 Segment List 字段共同决定 IPv6 DA 信息。</p>\n<p>segment 在处理后也不弹出</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646962793965-aa63ed56-8ce8-43eb-ae40-8abb17323199.png\" alt=\"img\"></p>\n<h3 id=\"srv6三层可编程能力\"><a class=\"markdownIt-Anchor\" href=\"#srv6三层可编程能力\">#</a> SRv6 三层可编程能力</h3>\n<p>第一层是 segment List。它可以将多个 Segment 组合，形成 SRv6 路径。这一点和 MPLs 标签栈类似。</p>\n<p>第二层是对 SRv6 SID 128 bit 地址的运用。MPLs 标签中四个段是定长的 (20 bit 标签、8 bit TTL、3 bit Tc 和 1 bit 栈底标识)。而 SRv6 SID 的 128 bit 可以灵活分段，并且每个段的长度也可以变化。由此 SRv6 具备更灵活的可编程能力。</p>\n<p>第三层是紧接在 Segment Llist 后的可选 TLV。报文在网络中传送时，如果需要在转发平面封装一些非规则类的信息，可以通过在 SRH 中 TLv 的灵活组合来完成。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646963384530-ea5d3c4c-91ef-4864-9b1a-8ae86d240080.png\" alt=\"img\"></p>\n<p>节点配置 Locator 之后，系统会生成一条 Locator 网段路由，<strong>并且通过 IGP 在 SR 域内扩散。网络里其他节点通过 Locator 网段路由就可以定位到本节点</strong>，同时本节点发布的所有 SRv6 SID 也都可以通过该条 Locator 网段路由到达。</p>\n<p>Function 代表设备的指令（Instruction），这些指令都由设备预先设定，Function 部分<strong>用于指示 SRv6 SID 的生成节点进行相应的功能操作。</strong></p>\n<p>指令就是转发信息，他与 SRv6 SID 相关，每一个 SID 代表隐含的转发指令，生成 SRv6 SID 的设备会生成 SID 表，存储了与本 SRv6 SID 相关指令</p>\n<p>Function 部分还可以分出一个可选的参数段（Arguments），此时 SRv6 SID 的格式变为 Locator:Function:Arguments，Arguments 占据 IPv6 地址的低比特位，通过 Arguments 字段可以定义一些报文的流和服务等信息。</p>\n<p>end,end.x Locator 需要手动配置，.DT4 或.DT6 Locator 可以手动配置或 BGP 自动生成</p>\n<p>3. <code>第三层是紧接在SegmentList后的可选TLV</code></p>\n<h3 id=\"srv6-sid\"><a class=\"markdownIt-Anchor\" href=\"#srv6-sid\">#</a> SRv6 SID</h3>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End SID</span><br></pre></td></tr></table></figure>\n<p>标识某个节点，类似于 node SID，通过 IGP 扩散</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646964052858-59b3bfb7-e664-4dfc-b93d-9c1056f07991.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.x SID</span><br></pre></td></tr></table></figure>\n<p>End.X SID 表示三层交叉连接的 Endpoint SID，用于标识网络中的某条链路。类似 SR-MPLS 中的 Adjacency SID。</p>\n<p><img data-src=\"https://cdn.nlark.com/yuque/0/2022/png/2759285/1646964288229-6874d999-51cf-4513-b2d2-b7dae3ec90a9.png\" alt=\"img\"></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.DT4 SID</span><br></pre></td></tr></table></figure>\n<p>End.DT4 SID 表示 PE 类型的 Endpoint SID，<strong>用于标识网络中的某个 IPv4 VPN 实例</strong>。End.DT4 SID 对应的转发动作是解封装报文，并且查找 IPv4 VPN 实例路由表转发。End.DT4 SID 在 L3VPNv4 场景使用，<strong>等价于 IPv4 VPN 的标签</strong>。End.DT4 SID 也可以用于标识公网实例。</p>\n<p>End.DT4 SID 可以通过静态配置生成，也可以通过<strong> BGP 在 Locator 的动态 SID 范围内自动分配</strong>。</p>\n<p><strong>只需要在 PE 节点生成环回路由和 locator 路由，中间节点不需要</strong></p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">End.DT6 SID</span><br></pre></td></tr></table></figure>\n<p>End.DT6 SID 表示 PE 类型的 Endpoint SID，<strong>用于标识网络中的某个 IPv6 VPN 实例</strong>。End.DT6 SID 对应的转发动作是解封装报文，并且查找 IPv6 VPN 实例路由表转发。End.DT6 SID 在 L3VPNv6 场景使用，<strong>等价于 IPv6 VPN 的标签</strong>。End.DT6 SID 也可以用于标识公网实例。</p>\n<p>End.DT6 SID 可以通过静态配置生成，也可以通过 BGP 在 Locator 的动态 SID 范围内自动分配。</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置end.dt4</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n<p>配置：</p>\n<figure class=\"highlight plaintext\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">配置接口地址</span><br><span class=\"line\"></span><br><span class=\"line\">PE：</span><br><span class=\"line\">全局使能</span><br><span class=\"line\">segment routing</span><br><span class=\"line\"></span><br><span class=\"line\">PE上配置环回，用于后续建立VPN邻居</span><br><span class=\"line\">ipv6 address </span><br><span class=\"line\"></span><br><span class=\"line\">segment-routing ipv6</span><br><span class=\"line\">  encapu source-address //指定隧道源,即PE上的Loopback</span><br><span class=\"line\">  locator aa ipv6-ptefix 2001:: 64 static 32  //配置locator路由,32是可自定义空间</span><br><span class=\"line\"></span><br><span class=\"line\"></span><br><span class=\"line\">运行IGP协议,中间节点不需要起segment-routing ipv6 locator aa</span><br><span class=\"line\">isis</span><br><span class=\"line\">  is-level</span><br><span class=\"line\">  cost-style</span><br><span class=\"line\">  network-entity</span><br><span class=\"line\">  ipv6 enable t ipv6</span><br><span class=\"line\">  segemnt-routing ipv6 locator aa a</span><br><span class=\"line\">  </span><br><span class=\"line\">//display Segment ipv6 local-sid </span><br><span class=\"line\">//display isis route </span><br><span class=\"line\"></span><br><span class=\"line\">配置VPN实例</span><br><span class=\"line\">  ip vpn-instance</span><br><span class=\"line\">  \troute</span><br><span class=\"line\">  \tvpn-target</span><br><span class=\"line\">  </span><br><span class=\"line\">配置function,argu</span><br><span class=\"line\">  segment-routing ipv6</span><br><span class=\"line\">    locator aa</span><br><span class=\"line\">      opcode ::100 end-dt4 vpn-instance site_a  //通过查询VPN-instance做路由转发</span><br><span class=\"line\"></span><br><span class=\"line\">//PE之间运行BGP</span><br><span class=\"line\">  BGP 100</span><br><span class=\"line\">    router-id</span><br><span class=\"line\">    peer 2001::1 as 100</span><br><span class=\"line\">    peer 2001:1 con l   0</span><br><span class=\"line\">    ipv4-family vpnv4</span><br><span class=\"line\">      peer 2001:: enable</span><br><span class=\"line\">      peer 2001:: prefix-sid</span><br><span class=\"line\">    ipv4 vpn-instance</span><br><span class=\"line\">      segment ipv6 locator auto-sid-disable</span><br><span class=\"line\">      segment ipv6 best-effort</span><br><span class=\"line\">      </span><br></pre></td></tr></table></figure>\n<p>对于不支持 SRv6 的设备可以通过 Multi topology reachable ipv6 prefixes 计算 locator 路由（TLV 237）</p>\n<p>对于支持的设备通过 locator 携带，TLV 27</p>\n<p>SID 谁生成谁传播，DT4 SID 只能由 BGP 传播</p>\n",
            "tags": [
                "网络"
            ]
        }
    ]
}