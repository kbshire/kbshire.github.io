



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://example.com/k8s%E9%AB%98%E7%BA%A7">



  <title>k8s高级 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">k8s高级
  </h1>

          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1giclx29mstj20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeu1usa7j20zk0m8b29.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipewkhf1zj20zk0m81kx.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipey84bjtj20zk0m8hdt.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gicli9lfebj20zk0m84qp.jpg"></li>
          <li class="item" data-background-image="https://tva3.sinaimg.cn/large/6833939bly1gipeudstjqj20zk0m8k3r.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="page wrap">
    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/k8s%E9%AB%98%E7%BA%A7.html">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="k8s高级"><a class="markdownIt-Anchor" href="#k8s高级">#</a> k8s 高级</h1>
<h2 id="环境配置"><a class="markdownIt-Anchor" href="#环境配置">#</a> 环境配置</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">docker load -i  .tar.gz</span><br><span class="line">ctr -n=k8s.io images import .tar.gz</span><br><span class="line">ctr -n=k8s.io images pull docker.io/library/centos:latest</span><br><span class="line">docker save -o .tar.gz</span><br><span class="line">ctr -n=k8s.io import .tar.gz</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">修改ip</span><br><span class="line">配置主机名</span><br><span class="line">配置hosts文件</span><br><span class="line">配置免密登录</span><br><span class="line">关闭交换分区</span><br><span class="line">修改内核参数</span><br><span class="line">关闭firewalld防火墙</span><br><span class="line">关闭selinux</span><br><span class="line">配置阿里云的安装docker的repo源</span><br><span class="line">配置阿里云安装k8s的repo源</span><br><span class="line">配置时间同步</span><br><span class="line">开启ipvs</span><br><span class="line">安装基础软件包</span><br><span class="line">安装iptablese</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kubeadm join 192.168.13.180:6443 --token or2v2h.3vffzj49xx3yuvr6 \</span><br><span class="line">	--discovery-token-ca-cert-hash sha256:09c9428481b6f33c04537f0753472f38c16637b351123a1416e7771366ca837a</span><br><span class="line"></span><br><span class="line">1.安装bash-completion工具</span><br><span class="line">yum install bash-completion -y</span><br><span class="line"> 否则报错：</span><br><span class="line">-bash: _get_comp_words_by_ref: command not found</span><br><span class="line">2.执行bash_completion</span><br><span class="line">source /usr/share/bash-completion/bash_completion</span><br><span class="line">3.加载kubectl completion</span><br><span class="line">source &lt;(kubectl completion bash) # 在 bash 中设置当前 shell 的自动补全，要先安装 bash-completion 包。</span><br><span class="line">echo &quot;source &lt;(kubectl completion bash)&quot; &gt;&gt; ~/.bashrc # 在您的 bash shell 中永久的添加自动补全</span><br><span class="line">您还可以为 kubectl 使用一个速记别名，该别名也可以与 completion 一起使用：</span><br><span class="line">cat &gt;&gt;/root/.bashrc&lt;&lt;EOF</span><br><span class="line">alias k=kubectl</span><br><span class="line">complete -F __start_kubectl k</span><br><span class="line">EOF</span><br><span class="line">source /root/.bashrc</span><br></pre></td></tr></table></figure>
<h2 id="prometheus"><a class="markdownIt-Anchor" href="#prometheus">#</a> Prometheus</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Prometheus是一个开源的系统监控和报警系统，现在已经加入到CNCF基金会，成为继k8s之后第二个在CNCF托管的项目，在kubernetes容器管理系统中，通常会搭配prometheus进行监控，同时也支持多种exporter采集数据，还支持pushgateway进行数据上报，Prometheus性能足够支撑上万台规模的集群。</span><br><span class="line"></span><br><span class="line">zabbix,nagios,cattio</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">1.多维度数据模型</span><br><span class="line">每一个时间序列数据都由metric度量指标名称和它的标签labels键值对集合唯一确定：</span><br><span class="line">这个metric度量指标名称指定监控目标系统的测量特征（如：http_requests_total- 接收http请求的总计数）。labels开启了Prometheus的多维数据模型：对于相同的度量名称，通过不同标签列表的结合, 会形成特定的度量维度实例。(例如：所有包含度量名称为/api/tracks的http请求，打上method=POST的标签，则形成了具体的http请求)。这个查询语言在这些度量和标签列表的基础上进行过滤和聚合。改变任何度量上的任何标签值，则会形成新的时间序列图。</span><br><span class="line">2.灵活的查询语言（PromQL）</span><br><span class="line">可以对采集的metrics指标进行加法，乘法，连接等操作；</span><br><span class="line">3.可以直接在本地部署，不依赖其他分布式存储；</span><br><span class="line">4.通过基于HTTP的pull方式采集时序数据；</span><br><span class="line">5.可以通过中间网关pushgateway的方式把时间序列数据推送到prometheus server端；</span><br><span class="line">6.可通过服务发现或者静态配置来发现目标服务对象（targets）。</span><br><span class="line">7.有多种可视化图像界面，如Grafana等。</span><br><span class="line">8.高效的存储，每个采样数据占3.5 bytes左右，300万的时间序列，30s间隔，保留60天，消耗磁盘大概200G。</span><br><span class="line">9.做高可用，可以对数据做异地备份，联邦集群，部署多套prometheus，pushgateway上报数据</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">样本</span><br><span class="line">在时间序列中的每一个点称为一个样本（sample），样本由以下三部分组成：</span><br><span class="line">1、指标（metric）：指标名称和描述当前样本特征的 labelsets；</span><br><span class="line">2、时间戳（timestamp）：一个精确到毫秒的时间戳；</span><br><span class="line">3、样本值（value）： 一个 folat64 的浮点型数据表示当前样本的值。</span><br><span class="line"></span><br><span class="line">表示方式：</span><br><span class="line">通过如下表达方式表示指定指标名称和指定标签集合的时间序列：</span><br><span class="line">&lt;metric name&gt;&#123;&lt;label name&gt;=&lt;label value&gt;, ...&#125;</span><br><span class="line">例如，指标名称为 api_http_requests_total，标签为 method=&quot;POST&quot; 和 handler=&quot;/messages&quot; 的时间序列可以表示为：</span><br><span class="line">api_http_requests_total&#123;method=&quot;POST&quot;, handler=&quot;/messages&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="组件介绍"><a class="markdownIt-Anchor" href="#组件介绍">#</a> 组件介绍</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1.Prometheus Server: 用于收集和存储时间序列数据。</span><br><span class="line">2.Client Library: 客户端库，检测应用程序代码，当Prometheus抓取实例的HTTP端点时，客户端库会将所有跟踪的metrics指标的当前状态发送到prometheus server端。</span><br><span class="line">3.Exporters: prometheus支持多种exporter，通过exporter可以采集metrics数据，然后发送到prometheus server端，所有向promtheus server提供监控数据的程序都可以被称为exporter</span><br><span class="line">4.Alertmanager: 从 Prometheus server 端接收到 alerts 后，会进行去重，分组，并路由到相应的接收方，发出报警，常见的接收方式有：电子邮件，微信，钉钉, slack等。</span><br><span class="line">5.Grafana：监控仪表盘，可视化监控数据</span><br><span class="line">6.pushgateway: 各个目标主机可上报数据到pushgateway，然后prometheus server统一从pushgateway拉取数据。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143122137.png" alt="image-20230526143122137"></p>
<h3 id="工作流程"><a class="markdownIt-Anchor" href="#工作流程">#</a> 工作流程</h3>
<p>1.Prometheus server 可定期从活跃的（up）目标主机上（target）拉取监控指标数据，目标主机的监控数据可通过配置静态 job 或者服务发现的方式被 prometheus server 采集到，这种方式默认的 pull 方式拉取指标；也可通过 pushgateway 把采集的数据上报到 prometheus server 中；还可通过一些组件自带的 exporter 采集相应组件的数据；</p>
<p>2.Prometheus server 把采集到的监控指标数据保存到本地磁盘或者数据库；</p>
<p>3.Prometheus 采集的监控指标数据按时间序列存储，通过配置报警规则，把触发的报警发送到 alertmanager</p>
<p>4.Alertmanager 通过配置报警接收方，发送报警到邮件，微信或者钉钉等</p>
<p>5.Prometheus 自带的 web ui 界面提供 PromQL 查询语言，可查询监控数据</p>
<p>6.Grafana 可接入 prometheus 数据源，把监控数据以图形化形式展示出</p>
<h3 id="prometheus和zabbix对比"><a class="markdownIt-Anchor" href="#prometheus和zabbix对比">#</a> Prometheus 和 Zabbix 对比</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143352088.png" alt="image-20230526143352088"></p>
<h3 id="部署模式"><a class="markdownIt-Anchor" href="#部署模式">#</a> 部署模式</h3>
<p>基本 HA</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143444630.png" alt="image-20230526143444630"></p>
<p><strong>基本的 HA 模式只能确保 Promthues 服务的可用性问题，但是不解决 Prometheus Server 之间的数据一致性问题以及持久化问题 (数据丢失后无法恢复)，也无法进行动态的扩展。因此这种部署方式适合监控规模不大，Promthues Server 也不会频繁发生迁移的情况，并且只需要保存短周期监控数据的场景。</strong></p>
<p>基本 HA + 远程存储</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143538150.png" alt="image-20230526143538150"></p>
<p><strong>在解决了 Promthues 服务可用性的基础上，同时确保了数据的持久化，当 Promthues Server 发生宕机或者数据丢失的情况下，可以快速的恢复。 同时 Promthues Server 可能很好的进行迁移。因此，该方案适用于用户监控规模不大，但是希望能够将监控数据持久化，同时能够确保 Promthues Server 的可迁移性的场景。</strong></p>
<p>基本 HA + 远程存储 + 联邦集群</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230526143645241.png" alt="image-20230526143645241"></p>
<p><strong>Promthues 的性能瓶颈主要在于大量的采集任务，因此用户需要利用 Prometheus 联邦集群的特性，将不同类型的采集任务划分到不同的 Promthues 子服务中，从而实现功能分区。例如一个 Promthues Server 负责采集基础设施相关的监控指标，另外一个 Prometheus Server 负责采集应用监控指标。再有上层 Prometheus Server 实现对数据的汇聚。</strong></p>
<h3 id="数据类型"><a class="markdownIt-Anchor" href="#数据类型">#</a> 数据类型</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">Counter是计数器类型：</span><br><span class="line">1、Counter 用于累计值，例如记录请求次数、任务完成数、错误发生次数。</span><br><span class="line">2、一直增加，不会减少。</span><br><span class="line">3、重启进程后，会被重置。</span><br><span class="line">例如：http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  100</span><br><span class="line">      http_response_total&#123;method=&quot;GET&quot;,endpoint=&quot;/api/tracks&quot;&#125;  160</span><br><span class="line">      </span><br><span class="line">Counter 类型数据可以让用户方便的了解事件产生的速率的变化，在PromQL内置的相关操作函数可以提供相应的分析，比如以HTTP应用请求量来进行说明：</span><br><span class="line">1、通过rate()函数获取HTTP请求量的增长率</span><br><span class="line">rate(http_requests_total[5m])</span><br><span class="line">2、查询当前系统中，访问量前10的HTTP地址</span><br><span class="line">topk(10, http_requests_total)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">Gauge是测量器类型：</span><br><span class="line">1、Gauge是常规数值，例如温度变化、内存使用变化。</span><br><span class="line">2、可变大，可变小。</span><br><span class="line">3、重启进程后，会被重置</span><br><span class="line"></span><br><span class="line">例如：</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   100</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   30</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   50</span><br><span class="line">memory_usage_bytes&#123;host=&quot;master-01&quot;&#125;   80 </span><br><span class="line"></span><br><span class="line">对于 Gauge 类型的监控指标，通过 PromQL 内置函数 delta() 可以获取样本在一段时间内的变化情况，例如，计算 CPU 温度在两小时内的差异：</span><br><span class="line">dalta(cpu_temp_celsius&#123;host=&quot;zeus&quot;&#125;[2h])</span><br><span class="line"></span><br><span class="line">你还可以通过PromQL 内置函数 predict_linear() 基于简单线性回归的方式，对样本数据的变化趋势做出预测。例如，基于 2 小时的样本数据，来预测主机可用磁盘空间在 4 个小时之后的剩余情况：</span><br><span class="line">predict_linear(node_filesystem_free&#123;job=&quot;node&quot;&#125;[2h], 4 * 3600) &lt; 0</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">histogram是柱状图，在Prometheus系统的查询语言中，有三种作用：</span><br><span class="line">1、在一段时间范围内对数据进行采样（通常是请求持续时间或响应大小等），并将其计入可配置的存储桶（bucket）中. 后续可通过指定区间筛选样本，也可以统计样本总数，最后一般将数据展示为直方图。</span><br><span class="line">2、对每个采样点值累计和(sum)</span><br><span class="line">3、对采样点的次数累计和(count)</span><br><span class="line"></span><br><span class="line">度量指标名称: [basename]_上面三类的作用度量指标名称</span><br><span class="line">1、[basename]_bucket&#123;le=&quot;上边界&quot;&#125;, 这个值为小于等于上边界的所有采样点数量</span><br><span class="line">2、[basename]_sum</span><br><span class="line">3、[basename]_count</span><br><span class="line"></span><br><span class="line">在大多数情况下人们都倾向于使用某些量化指标的平均值，例如 CPU 的平均使用率、页面的平均响应时间。这种方式的问题很明显，以系统 API 调用的平均响应时间为例：如果大多数 API 请求都维持在 100ms 的响应时间范围内，而个别请求的响应时间需要 5s，那么就会导致某些 WEB 页面的响应时间落到中位数的情况，而这种现象被称为长尾问题。</span><br><span class="line">为了区分是平均的慢还是长尾的慢，最简单的方式就是按照请求延迟的范围进行分组。例如，统计延迟在 0~10ms 之间的请求数有多少，而 10~20ms 之间的请求数又有多少。通过这种方式可以快速分析系统慢的原因。Histogram 和 Summary 都是为了能够解决这样问题的存在，通过 Histogram 和 Summary 类型的监控指标，我们可以快速了解监控样本的分布情况。</span><br><span class="line"></span><br><span class="line">Histogram 类型的样本会提供三种指标（假设指标名称为 &lt;basename&gt;）：</span><br><span class="line">样本的值分布在 bucket 中的数量，命名为 &lt;basename&gt;_bucket&#123;le=&quot;&lt;上边界&gt;&quot;&#125;。解释的更通俗易懂一点，这个值表示指标值小于等于上边界的所有样本数量。</span><br><span class="line"></span><br><span class="line">1、http 请求响应时间 &lt;=0.005 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.005&quot;,&#125; 0.0</span><br><span class="line">2、http 请求响应时间 &lt;=0.01 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.01&quot;,&#125; 0.0</span><br><span class="line"> 3、http 请求响应时间 &lt;=0.025 秒 的请求次数为0</span><br><span class="line">io_namespace_http_requests_latency_seconds_histogram_bucket&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,le=&quot;0.025&quot;,&#125; 0.0</span><br><span class="line"></span><br><span class="line">所有样本值的大小总和，命名为 &lt;basename&gt;_sum。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">summary</span><br><span class="line">与 Histogram 类型类似，用于表示一段时间内的数据采样结果（通常是请求持续时间或响应大小等），但它直接存储了分位数（通过客户端计算，然后展示出来），而不是通过区间来计算。它也有三种作用：</span><br><span class="line">1、对于每个采样点进行统计，并形成分位图。（如：正态分布一样，统计低于60分不及格的同学比例，统计低于80分的同学比例，统计低于95分的同学比例）</span><br><span class="line">2、统计班上所有同学的总成绩(sum)</span><br><span class="line">3、统计班上同学的考试总人数(count)</span><br><span class="line"></span><br><span class="line">样本值的分位数分布情况，命名为 &lt;basename&gt;&#123;quantile=&quot;&lt;φ&gt;&quot;&#125;。</span><br><span class="line">1、含义：http 请求中有 50% 的请求响应时间是 3.052404983s</span><br><span class="line">  io_namespace_http_requests_latency_seconds_summary&#123;path=&quot;/&quot;,method=&quot;GET&quot;,code=&quot;200&quot;,quantile=&quot;0.5&quot;,&#125; 3.052404983</span><br><span class="line">  </span><br><span class="line">  Histogram 需要通过 &lt;basename&gt;_bucket 来计算分位数，而 Summary 则直接存储了分位数的值。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Prometheus对kubernetes的监控</span><br><span class="line">对于Kubernetes而言，我们可以把当中所有的资源分为几类：</span><br><span class="line">•基础设施层（Node）：集群节点，为整个集群和应用提供运行时资源</span><br><span class="line">•容器基础设施（Container）：为应用提供运行时环境</span><br><span class="line">•用户应用（Pod）：Pod中会包含一组容器，它们一起工作，并且对外提供一个（或者一组）功能</span><br><span class="line">•内部服务负载均衡（Service）：在集群内，通过Service在集群暴露应用功能，集群内应用和应用之间访问时提供内部的负载均衡</span><br><span class="line">•外部访问入口（Ingress）：通过Ingress提供集群外的访问入口，从而可以使外部客户端能够访问到部署在Kubernetes集群内的服务</span><br></pre></td></tr></table></figure>
<h3 id="node-exporter"><a class="markdownIt-Anchor" href="#node-exporter">#</a> node-exporter</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">node-exporter可以采集机器（物理机、虚拟机、云主机等）的监控指标数据，能够采集到的指标包括CPU, 内存，磁盘，网络，文件数等信息。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>  <span class="comment">#可以保证k8s集群的每个节点都运行完全一样的pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">hostPID:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostIPC:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">hostNetwork:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/node-exporter:latest</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9100</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="number">0.15</span>  <span class="comment">#这个容器运行至少需要0.15核cpu</span></span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span>  <span class="comment">#开启特权模式</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.procfs</span>  <span class="comment">#配置挂载宿主机（node节点）的路径</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/host/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--path.sysfs</span>  <span class="comment">#配置挂载宿主机（node节点）的路径</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">/host/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">--collector.filesystem.ignored-mount-points</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;&quot;^/(sys|proc|dev|host|etc)($|/)&quot;&#x27;</span></span><br><span class="line"><span class="comment">#通过正则表达式忽略某些文件系统挂载点的信息收集</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/host/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/rootfs</span></span><br><span class="line"><span class="comment">#将主机/dev、/proc、/sys这些目录挂在到容器中，这是因为我们采集的很多节点数据都是通过这些文件来获取系统信息的。</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">&quot;node-role.kubernetes.io/master&quot;</span></span><br><span class="line">        <span class="attr">operator:</span> <span class="string">&quot;Exists&quot;</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">&quot;NoSchedule&quot;</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">proc</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/proc</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dev</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/dev</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">sys</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/sys</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rootfs</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/1</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span><span class="string">:9100/metrics</span></span><br><span class="line"></span><br><span class="line"><span class="string">curl</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span><span class="string">:9100/metrics</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">node_cpu_seconds</span></span><br><span class="line">  <span class="string">%</span> <span class="string">Total</span>    <span class="string">%</span> <span class="string">Received</span> <span class="string">%</span> <span class="string">Xferd</span>  <span class="string">Average</span> <span class="string">Speed</span>   <span class="string">Time</span>    <span class="string">Time</span>     <span class="string">Time</span>  <span class="string">Current</span></span><br><span class="line">                                 <span class="string">Dload</span>  <span class="string">Upload</span>   <span class="string">Total</span>   <span class="string">Spent</span>    <span class="string">Left</span>  <span class="string">Speed</span></span><br><span class="line">  <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>    <span class="number">0</span>     <span class="number">0</span>      <span class="number">0</span>      <span class="number">0</span> <span class="string">--:--:--</span> <span class="string">--:--:--</span> <span class="string">--:--:--</span>     <span class="number">0</span></span><br><span class="line"><span class="comment"># HELP node_cpu_seconds_total Seconds the CPUs spent in each mode.</span></span><br><span class="line"><span class="comment"># TYPE node_cpu_seconds_total counter</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;idle&quot;&#125;</span> <span class="number">14492.66</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;iowait&quot;&#125;</span> <span class="number">19.3</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;irq&quot;&#125;</span> <span class="number">0</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;nice&quot;&#125;</span> <span class="number">0.48</span></span><br><span class="line"><span class="string">node_cpu_seconds_total&#123;cpu=&quot;0&quot;,mode=&quot;softirq&quot;&#125;</span> <span class="number">28.25</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建sa账号，对sa做rbac授权</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">serviceaccount</span> <span class="string">monitor</span> <span class="string">-n</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">monitor-clusterrolebinding</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">--clusterrole=cluster-admin</span>  <span class="string">--serviceaccount=monitor-sa:monitor</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">monitor-clusterrolebinding-1</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">--clusterrole=cluster-admin</span> <span class="string">--user=system:serviceaccount:monitor:monitor-sa</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建prometheus数据存储目录</span></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">~</span>]<span class="comment"># mkdir /data </span></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">~</span>]<span class="comment"># chmod 777 -R /data/</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建configmap</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      evaluation_interval: 1m</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role:  node</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __scheme__</span></span><br><span class="line"><span class="string">        regex: (https?)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_name </span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<h3 id="部署prothemeus"><a class="markdownIt-Anchor" href="#部署prothemeus">#</a> 部署 Prothemeus</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 通过deployment部署Prothemeus</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">    <span class="comment">#matchExpressions:</span></span><br><span class="line">    <span class="comment">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class="line">    <span class="comment">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">monitor</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">prometheus</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--config.file=/etc/prometheus/prometheus.yml</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--storage.tsdb.path=/prometheus</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--storage.tsdb.retention=720h</span></span><br><span class="line">          <span class="bullet">-</span> <span class="string">--web.enable-lifecycle</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@prometheus-master</span> <span class="string">prome</span>]<span class="comment"># kubectl exec -it -n monitor-sa prometheus-server-674dff4c46-l67r6 -- /bin/sh</span></span><br><span class="line"><span class="string">/prometheus</span> <span class="string">$</span> <span class="string">cd</span> <span class="string">/etc/prometheus/</span></span><br><span class="line"><span class="string">/etc/prometheus</span> <span class="string">$</span> <span class="string">ls</span></span><br><span class="line"><span class="string">prometheus.yml</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9090</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 监控promethus-service</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br></pre></td></tr></table></figure>
<h3 id="prothemeus热加载"><a class="markdownIt-Anchor" href="#prothemeus热加载">#</a> Prothemeus 热加载</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">curl</span> <span class="string">-X</span> <span class="string">POST</span> <span class="string">http://pod-ip:9090/-/reload</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#热加载速度比较慢，可以暴力重启prometheus，如修改上面的prometheus-cfg.yaml文件之后，可执行如下强制删除：</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">然后再通过apply更新：</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">注意：</span></span><br><span class="line"><span class="string">线上最好热加载，暴力删除可能造成监控数据的丢失</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527153500817.png" alt="image-20230527153500817"></p>
<h3 id="grafana"><a class="markdownIt-Anchor" href="#grafana">#</a> Grafana</h3>
<p><strong>Grafana 是一个跨平台的开源的度量分析和可视化工具，可以将采集的数据可视化的展示，并及时通知给告警接收方。它主要有以下六大特点：</strong></p>
<p><strong>1、展示方式：快速灵活的客户端图表，面板插件有许多不同方式的可视化指标和日志，官方库中具有丰富的仪表盘插件，比如热图、折线图、图表等多种展示方式；</strong></p>
<p><strong>2、数据源：Graphite，InfluxDB，OpenTSDB，Prometheus，Elasticsearch，CloudWatch 和 KairosDB 等；</strong></p>
<p><strong>3、通知提醒：以可视方式定义最重要指标的警报规则，Grafana 将不断计算并发送通知，在数据达到阈值时通过 Slack、PagerDuty 等获得通知；</strong></p>
<p><strong>4、混合展示：在同一图表中混合使用不同的数据源，可以基于每个查询指定数据源，甚至自定义数据源；</strong></p>
<p><strong>5、注释：使用来自不同数据源的丰富事件注释图表，将鼠标悬停在事件上会显示完整的事件元数据和标记</strong></p>
<h3 id="安装grafana"><a class="markdownIt-Anchor" href="#安装grafana">#</a> 安装 Grafana</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      task: monitoring</span><br><span class="line">      k8s-app: grafana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        task: monitoring</span><br><span class="line">        k8s-app: grafana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: grafana</span><br><span class="line">        image: k8s.gcr.io/heapster-grafana-amd64:v5.0.4</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 3000</span><br><span class="line">          protocol: TCP</span><br><span class="line">        volumeMounts:</span><br><span class="line">        - mountPath: /etc/ssl/certs</span><br><span class="line">          name: ca-certificates</span><br><span class="line">          readOnly: true</span><br><span class="line">        - mountPath: /var</span><br><span class="line">          name: grafana-storage</span><br><span class="line">        env:</span><br><span class="line">        - name: INFLUXDB_HOST</span><br><span class="line">          value: monitoring-influxdb</span><br><span class="line">        - name: GF_SERVER_HTTP_PORT</span><br><span class="line">          value: &quot;3000&quot;</span><br><span class="line">          # The following env variables are required to make Grafana accessible via</span><br><span class="line">          # the kubernetes api-server proxy. On production clusters, we recommend</span><br><span class="line">          # removing these env variables, setup auth for grafana, and expose the grafana</span><br><span class="line">          # service using a LoadBalancer or a public IP.</span><br><span class="line">        - name: GF_AUTH_BASIC_ENABLED</span><br><span class="line">          value: &quot;false&quot;</span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ENABLED</span><br><span class="line">          value: &quot;true&quot;</span><br><span class="line">        - name: GF_AUTH_ANONYMOUS_ORG_ROLE</span><br><span class="line">          value: Admin</span><br><span class="line">        - name: GF_SERVER_ROOT_URL</span><br><span class="line">          # If you&#x27;re only using the API Server proxy, set this value instead:</span><br><span class="line">          # value: /api/v1/namespaces/kube-system/services/monitoring-grafana/proxy</span><br><span class="line">          value: /</span><br><span class="line">      volumes:</span><br><span class="line">      - name: ca-certificates</span><br><span class="line">        hostPath:</span><br><span class="line">          path: /etc/ssl/certs</span><br><span class="line">      - name: grafana-storage</span><br><span class="line">        emptyDir: &#123;&#125;</span><br><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  labels:</span><br><span class="line">    # For use as a Cluster add-on (https://github.com/kubernetes/kubernetes/tree/master/cluster/addons)</span><br><span class="line">    # If you are NOT using this as an addon, you should comment out this line.</span><br><span class="line">    kubernetes.io/cluster-service: &#x27;true&#x27;</span><br><span class="line">    kubernetes.io/name: monitoring-grafana</span><br><span class="line">  name: monitoring-grafana</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  # In a production setup, we recommend accessing Grafana through an external Loadbalancer</span><br><span class="line">  # or through a public IP.</span><br><span class="line">  # type: LoadBalancer</span><br><span class="line">  # You could also use NodePort to expose the service at a randomly-generated port</span><br><span class="line">  # type: NodePort</span><br><span class="line">  ports:</span><br><span class="line">  - port: 80</span><br><span class="line">    targetPort: 3000</span><br><span class="line">  selector:</span><br><span class="line">    k8s-app: grafana</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160404888.png" alt="image-20230527160404888"></p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230527160957066.png" alt="image-20230527160957066"></p>
<p>将其中的 container_last_seen 放到 Prometheus 中 query，如果显示 nodata 说明没有这项监控</p>
<h3 id="kube-metric"><a class="markdownIt-Anchor" href="#kube-metric">#</a> kube-metric</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: ServiceAccount</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRole</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">rules:</span><br><span class="line">- apiGroups: [&quot;&quot;]</span><br><span class="line">  resources: [&quot;nodes&quot;, &quot;pods&quot;, &quot;services&quot;, &quot;resourcequotas&quot;, &quot;replicationcontrollers&quot;, &quot;limitranges&quot;, &quot;persistentvolumeclaims&quot;, &quot;persistentvolumes&quot;, &quot;namespaces&quot;, &quot;endpoints&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;extensions&quot;]</span><br><span class="line">  resources: [&quot;daemonsets&quot;, &quot;deployments&quot;, &quot;replicasets&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;apps&quot;]</span><br><span class="line">  resources: [&quot;statefulsets&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;batch&quot;]</span><br><span class="line">  resources: [&quot;cronjobs&quot;, &quot;jobs&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">- apiGroups: [&quot;autoscaling&quot;]</span><br><span class="line">  resources: [&quot;horizontalpodautoscalers&quot;]</span><br><span class="line">  verbs: [&quot;list&quot;, &quot;watch&quot;]</span><br><span class="line">---</span><br><span class="line">apiVersion: rbac.authorization.k8s.io/v1</span><br><span class="line">kind: ClusterRoleBinding</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">roleRef:</span><br><span class="line">  apiGroup: rbac.authorization.k8s.io</span><br><span class="line">  kind: ClusterRole</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">subjects:</span><br><span class="line">- kind: ServiceAccount</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  </span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kube-state-metrics</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kube-state-metrics</span><br><span class="line">    spec:</span><br><span class="line">      serviceAccountName: kube-state-metrics</span><br><span class="line">      containers:</span><br><span class="line">      - name: kube-state-metrics</span><br><span class="line">        image: quay.io/coreos/kube-state-metrics:v1.9.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  annotations:</span><br><span class="line">    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">  name: kube-state-metrics</span><br><span class="line">  namespace: kube-system</span><br><span class="line">  labels:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - name: kube-state-metrics</span><br><span class="line">    port: 8080</span><br><span class="line">    protocol: TCP</span><br><span class="line">  selector:</span><br><span class="line">    app: kube-state-metrics</span><br><span class="line">    </span><br><span class="line">导入json</span><br><span class="line">https://grafana.com/grafana/dashboards/?search=kubernetes</span><br></pre></td></tr></table></figure>
<h2 id="alert-manager"><a class="markdownIt-Anchor" href="#alert-manager">#</a> alert manager</h2>
<h3 id="报警到qq邮箱"><a class="markdownIt-Anchor" href="#报警到qq邮箱">#</a> 报警到 qq 邮箱</h3>
<p>WYCMUCTTXLOBSVYS</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">alertmanager.yml:</span> <span class="string">|-</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      resolve_timeout: 1m</span></span><br><span class="line"><span class="string">      smtp_smarthost: &#x27;smtp.163.com:25&#x27;</span></span><br><span class="line"><span class="string">      smtp_from: &#x27;kbshire@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_username: &#x27;kbshire@163.com&#x27;</span></span><br><span class="line"><span class="string">      smtp_auth_password: &#x27;WYCMUCTTXLOBSVYS&#x27;</span></span><br><span class="line"><span class="string">      smtp_require_tls: false</span></span><br><span class="line"><span class="string">    route:  #用于配置告警分发策略</span></span><br><span class="line"><span class="string">      group_by: [alertname] # 采用哪个标签来作为分组依据</span></span><br><span class="line"><span class="string">      group_wait: 10s       # 组告警等待时间。也就是告警产生后等待10s，如果有同组告警一起发出</span></span><br><span class="line"><span class="string">      group_interval: 10s    # 上下两组发送告警的间隔时间</span></span><br><span class="line"><span class="string">      repeat_interval: 10m    # 重复发送告警的时间，减少相同邮件的发送频率，默认是1h</span></span><br><span class="line"><span class="string">      receiver: default-receiver  #定义谁来收告警</span></span><br><span class="line"><span class="string">    receivers:</span></span><br><span class="line"><span class="string">    - name: &#x27;default-receiver&#x27;</span></span><br><span class="line"><span class="string">      email_configs:</span></span><br><span class="line"><span class="string">      - to: &#x27;183108913@qq.com&#x27;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">报警处理流程如下：</span><br><span class="line">1. Prometheus Server监控目标主机上暴露的http接口（这里假设接口A），通过Promethes配置的&#x27;scrape_interval&#x27;定义的时间间隔，定期采集目标主机上监控数据。</span><br><span class="line">2. 当接口A不可用的时候，Server端会持续的尝试从接口中取数据，直到&quot;scrape_timeout&quot;时间后停止尝试。这时候把接口的状态变为“DOWN”。</span><br><span class="line">3. Prometheus同时根据配置的&quot;evaluation_interval&quot;的时间间隔，定期（默认1min）的对Alert Rule进行评估；当到达评估周期的时候，发现接口A为DOWN，即UP=0为真，激活Alert，进入“PENDING”状态，并记录当前active的时间；</span><br><span class="line">4. 当下一个alert rule的评估周期到来的时候，发现UP=0继续为真，然后判断警报Active的时间是否已经超出rule里的‘for’ 持续时间，如果未超出，则进入下一个评估周期；如果时间超出，则alert的状态变为“FIRING”；同时调用Alertmanager接口，发送相关报警数据。</span><br><span class="line">5. AlertManager收到报警数据后，会将警报信息进行分组，然后根据alertmanager配置的“group_wait”时间先进行等待。等wait时间过后再发送报警信息。</span><br><span class="line">6. 属于同一个Alert Group的警报，在等待的过程中可能进入新的alert，如果之前的报警已经成功发出，那么间隔“group_interval”的时间间隔后再重新发送报警信息。比如配置的是邮件报警，那么同属一个group的报警信息会汇总在一个邮件里进行发送。</span><br><span class="line">7. 如果Alert Group里的警报一直没发生变化并且已经成功发送，等待‘repeat_interval’时间间隔之后再重复发送相同的报警邮件；如果之前的警报没有成功发送，则相当于触发第6条条件，则需要等待group_interval时间间隔后重复发送。</span><br><span class="line"></span><br><span class="line">同时最后至于警报信息具体发给谁，满足什么样的条件下指定警报接收人，设置不同报警发送频率，这里有alertmanager的route路由规则进行配置。</span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">prometheus.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    rule_files:</span></span><br><span class="line"><span class="string">    - /etc/prometheus/rules.yml</span></span><br><span class="line"><span class="string">    alerting:</span></span><br><span class="line"><span class="string">      alertmanagers:</span></span><br><span class="line"><span class="string">      - static_configs:</span></span><br><span class="line"><span class="string">        - targets: [&quot;localhost:9093&quot;]</span></span><br><span class="line"><span class="string">    global:</span></span><br><span class="line"><span class="string">      scrape_interval: 15s</span></span><br><span class="line"><span class="string">      scrape_timeout: 10s</span></span><br><span class="line"><span class="string">      evaluation_interval: 1m</span></span><br><span class="line"><span class="string">    scrape_configs:</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: node</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__address__]</span></span><br><span class="line"><span class="string">        regex: &#x27;(.*):10250&#x27;</span></span><br><span class="line"><span class="string">        replacement: &#x27;$&#123;1&#125;:9100&#x27;</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-node-cadvisor&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role:  node</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_node_label_(.+)</span></span><br><span class="line"><span class="string">      - target_label: __address__</span></span><br><span class="line"><span class="string">        replacement: kubernetes.default.svc:443</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_node_name]</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        replacement: /api/v1/nodes/$&#123;1&#125;/proxy/metrics/cadvisor</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-apiserver&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt</span></span><br><span class="line"><span class="string">      bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: default;kubernetes;https</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-service-endpoints&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: endpoints</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]</span></span><br><span class="line"><span class="string">        action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __scheme__</span></span><br><span class="line"><span class="string">        regex: (https?)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_annotation_prometheus_io_path]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__address__, __meta_kubernetes_service_annotation_prometheus_io_port]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_service_label_(.+)</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_namespace]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - source_labels: [__meta_kubernetes_service_name]</span></span><br><span class="line"><span class="string">        action: replace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_name </span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-pods&#x27;</span></span><br><span class="line"><span class="string">      kubernetes_sd_configs:</span></span><br><span class="line"><span class="string">      - role: pod</span></span><br><span class="line"><span class="string">      relabel_configs:</span></span><br><span class="line"><span class="string">      - action: keep</span></span><br><span class="line"><span class="string">        regex: true</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_scrape</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        regex: (.+)</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_path</span></span><br><span class="line"><span class="string">        target_label: __metrics_path__</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        regex: ([^:]+)(?::\d+)?;(\d+)</span></span><br><span class="line"><span class="string">        replacement: $1:$2</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __address__</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_annotation_prometheus_io_port</span></span><br><span class="line"><span class="string">        target_label: __address__</span></span><br><span class="line"><span class="string">      - action: labelmap</span></span><br><span class="line"><span class="string">        regex: __meta_kubernetes_pod_label_(.+)</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_namespace</span></span><br><span class="line"><span class="string">        target_label: kubernetes_namespace</span></span><br><span class="line"><span class="string">      - action: replace</span></span><br><span class="line"><span class="string">        source_labels:</span></span><br><span class="line"><span class="string">        - __meta_kubernetes_pod_name</span></span><br><span class="line"><span class="string">        target_label: kubernetes_pod_name</span></span><br><span class="line"><span class="string">    - job_name: &#x27;kubernetes-etcd&#x27;</span></span><br><span class="line"><span class="string">      scheme: https</span></span><br><span class="line"><span class="string">      tls_config:</span></span><br><span class="line"><span class="string">        ca_file: /etc/kubernetes/pki/etcd/ca.crt</span></span><br><span class="line"><span class="string">        cert_file: /etc/kubernetes/pki/etcd/server.crt</span></span><br><span class="line"><span class="string">        key_file: /etc/kubernetes/pki/etcd/server.key</span></span><br><span class="line"><span class="string">      scrape_interval: 5s</span></span><br><span class="line"><span class="string">      static_configs:</span></span><br><span class="line"><span class="string">      - targets: [&#x27;192.168.13.180:2379&#x27;]</span></span><br><span class="line"><span class="string"></span>  <span class="attr">rules.yml:</span> <span class="string">|</span></span><br><span class="line"><span class="string">    groups:</span></span><br><span class="line"><span class="string">    - name: example</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: apiserver的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">      - alert:  apiserver的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-apiserver&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">      - alert: etcd的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">      - alert:  etcd的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;job=~&quot;kubernetes-etcd&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-state-metrics的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;80%&quot;      </span></span><br><span class="line"><span class="string">      - alert: kube-state-metrics的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-state-metrics&quot;&#125;[1m]) * 100 &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;90%&quot;      </span></span><br><span class="line"><span class="string">      - alert: coredns的cpu使用率大于80%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过80%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;80%&quot;      </span></span><br><span class="line"><span class="string">      - alert: coredns的cpu使用率大于90%</span></span><br><span class="line"><span class="string">        expr: rate(process_cpu_seconds_total&#123;k8s_app=~&quot;kube-dns&quot;&#125;[1m]) * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.k8s_app&#125;&#125;组件的cpu使用率超过90%&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;%&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;90%&quot;      </span></span><br><span class="line"><span class="string">      - alert: kube-proxy打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-proxy打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-schedule打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-schedule打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd打开句柄数&gt;600</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd打开句柄数&gt;1000</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.instance&#125;&#125;的&#123;&#123;$labels.job&#125;&#125;打开句柄数&gt;1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: coredns</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 600</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning </span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过600&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: coredns</span></span><br><span class="line"><span class="string">        expr: process_open_fds&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 打开句柄数超过1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-proxy</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-kube-proxy&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: scheduler</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-schedule&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-controller-manager</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-controller-manager&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-apiserver</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-apiserver&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kubernetes-etcd</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;job=~&quot;kubernetes-etcd&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: kube-dns</span></span><br><span class="line"><span class="string">        expr: process_virtual_memory_bytes&#123;k8s_app=~&quot;kube-dns&quot;&#125;  &gt; 2000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;插件&#123;&#123;$labels.k8s_app&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 使用虚拟内存超过2G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: HttpRequestsAvg</span></span><br><span class="line"><span class="string">        expr: sum(rate(rest_client_requests_total&#123;job=~&quot;kubernetes-kube-proxy|kubernetes-kubelet|kubernetes-schedule|kubernetes-control-manager|kubernetes-apiservers&quot;&#125;[1m]))  &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): TPS超过1000&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1000&quot;   </span></span><br><span class="line"><span class="string">      - alert: Pod_restarts</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_restarts_total&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: warnning</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;在&#123;&#123;$labels.namespace&#125;&#125;名称空间下发现&#123;&#123;$labels.pod&#125;&#125;这个pod下的容器&#123;&#123;$labels.container&#125;&#125;被重启,这个监控指标是由&#123;&#123;$labels.instance&#125;&#125;采集的&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Pod_waiting</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_waiting_reason&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;启动异常等待中&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;   </span></span><br><span class="line"><span class="string">      - alert: Pod_terminated</span></span><br><span class="line"><span class="string">        expr: kube_pod_container_status_terminated_reason&#123;namespace=~&quot;kube-system|default|monitor-sa&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.pod&#125;&#125;下的&#123;&#123;$labels.container&#125;&#125;被删除&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_leader</span></span><br><span class="line"><span class="string">        expr: etcd_server_has_leader&#123;job=&quot;kubernetes-etcd&quot;&#125; == 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前没有leader&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_leader_changes</span></span><br><span class="line"><span class="string">        expr: rate(etcd_server_leader_changes_seen_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 当前leader已发生改变&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_failed</span></span><br><span class="line"><span class="string">        expr: rate(etcd_server_proposals_failed_total&#123;job=&quot;kubernetes-etcd&quot;&#125;[1m]) &gt; 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 服务失败&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;0&quot;</span></span><br><span class="line"><span class="string">      - alert: Etcd_db_total_size</span></span><br><span class="line"><span class="string">        expr: etcd_debugging_mvcc_db_total_size_in_bytes&#123;job=&quot;kubernetes-etcd&quot;&#125; &gt; 10000000000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;组件&#123;&#123;$labels.job&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;)：db空间超过10G&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;10G&quot;</span></span><br><span class="line"><span class="string">      - alert: Endpoint_ready</span></span><br><span class="line"><span class="string">        expr: kube_endpoint_address_not_ready&#123;namespace=~&quot;kube-system|default&quot;&#125; == 1</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          team: admin</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          description: &quot;空间&#123;&#123;$labels.namespace&#125;&#125;(&#123;&#123;$labels.instance&#125;&#125;): 发现&#123;&#123;$labels.endpoint&#125;&#125;不可用&quot;</span></span><br><span class="line"><span class="string">          value: &quot;&#123;&#123; $value &#125;&#125;&quot;</span></span><br><span class="line"><span class="string">          threshold: &quot;1&quot;</span></span><br><span class="line"><span class="string">    - name: 物理节点状态-监控告警</span></span><br><span class="line"><span class="string">      rules:</span></span><br><span class="line"><span class="string">      - alert: 物理节点cpu使用率</span></span><br><span class="line"><span class="string">        expr: 100-avg(irate(node_cpu_seconds_total&#123;mode=&quot;idle&quot;&#125;[5m])) by(instance)*100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: ccritical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;cpu使用率过高&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的cpu使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot; </span></span><br><span class="line"><span class="string">      - alert: 物理节点内存使用率</span></span><br><span class="line"><span class="string">        expr: (node_memory_MemTotal_bytes - (node_memory_MemFree_bytes + node_memory_Buffers_bytes + node_memory_Cached_bytes)) / node_memory_MemTotal_bytes * 100 &gt; 90</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;内存使用率过高&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;的内存使用率超过90%,当前使用率[&#123;&#123; $value &#125;&#125;],需要排查处理&quot;</span></span><br><span class="line"><span class="string">      - alert: InstanceDown</span></span><br><span class="line"><span class="string">        expr: up == 0</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:   </span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器宕机&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123; $labels.instance &#125;&#125;: 服务器延时超过2分钟&quot;</span></span><br><span class="line"><span class="string">      - alert: 物理节点磁盘的IO性能</span></span><br><span class="line"><span class="string">        expr: 100-(avg(irate(node_disk_io_time_seconds_total[1m])) by(instance)* 100) &lt; 60</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入磁盘IO使用率过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 流入磁盘IO大于60%(目前使用:&#123;&#123;$value&#125;&#125;)&quot;</span></span><br><span class="line"><span class="string">      - alert: 入网流量带宽</span></span><br><span class="line"><span class="string">        expr: ((sum(rate (node_network_receive_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流入网络带宽过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流入网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: 出网流量带宽</span></span><br><span class="line"><span class="string">        expr: ((sum(rate (node_network_transmit_bytes_total&#123;device!~&#x27;tap.*|veth.*|br.*|docker.*|virbr*|lo*&#x27;&#125;[5m])) by (instance)) / 100) &gt; 102400</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 流出网络带宽过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125;流出网络带宽持续5分钟高于100M. RX带宽使用率&#123;&#123;$value&#125;&#125;&quot;</span></span><br><span class="line"><span class="string">      - alert: TCP会话</span></span><br><span class="line"><span class="string">        expr: node_netstat_Tcp_CurrEstab &gt; 1000</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; TCP_ESTABLISHED过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; TCP_ESTABLISHED大于1000%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string">      - alert: 磁盘容量</span></span><br><span class="line"><span class="string">        expr: 100-(node_filesystem_free_bytes&#123;fstype=~&quot;ext4|xfs&quot;&#125;/node_filesystem_size_bytes &#123;fstype=~&quot;ext4|xfs&quot;&#125;*100) &gt; 80</span></span><br><span class="line"><span class="string">        for: 2s</span></span><br><span class="line"><span class="string">        labels:</span></span><br><span class="line"><span class="string">          severity: critical</span></span><br><span class="line"><span class="string">        annotations:</span></span><br><span class="line"><span class="string">          summary: &quot;&#123;&#123;$labels.mountpoint&#125;&#125; 磁盘分区使用率过高！&quot;</span></span><br><span class="line"><span class="string">          description: &quot;&#123;&#123;$labels.mountpoint &#125;&#125; 磁盘分区使用大于80%(目前使用:&#123;&#123;$value&#125;&#125;%)&quot;</span></span><br><span class="line"><span class="string"></span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">kubectl</span> <span class="string">-n</span> <span class="string">monitor-sa</span> <span class="string">create</span> <span class="string">secret</span> <span class="string">generic</span> <span class="string">etcd-certs</span> <span class="string">--from-file=/etc/kubernetes/pki/etcd/server.key</span>  <span class="string">--from-file=/etc/kubernetes/pki/etcd/server.crt</span> <span class="string">--from-file=/etc/kubernetes/pki/etcd/ca.crt</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">prometheus-server</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">      <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">    <span class="comment">#matchExpressions:</span></span><br><span class="line">    <span class="comment">#- &#123;key: app, operator: In, values: [prometheus]&#125;</span></span><br><span class="line">    <span class="comment">#- &#123;key: component, operator: In, values: [server]&#125;</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">component:</span> <span class="string">server</span></span><br><span class="line">      <span class="attr">annotations:</span></span><br><span class="line">        <span class="attr">prometheus.io/scrape:</span> <span class="string">&#x27;false&#x27;</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="comment">#nodeName: xianchaonode1</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">monitor</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/prometheus</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;/bin/prometheus&quot;</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/prometheus/prometheus.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.path=/prometheus&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--storage.tsdb.retention=24h&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--web.enable-lifecycle&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9090</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/etc/prometheus</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">/prometheus/</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/run/secrets/kubernetes.io/k8s-certs/etcd/</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">prom/alertmanager</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">args:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--config.file=/etc/alertmanager/alertmanager.yml&quot;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&quot;--log.level=debug&quot;</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9093</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-storage</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/etc/localtime</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">prometheus-config</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prometheus-storage-volume</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">Directory</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">k8s-certs</span></span><br><span class="line">          <span class="attr">secret:</span></span><br><span class="line">           <span class="attr">secretName:</span> <span class="string">etcd-certs</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-config</span></span><br><span class="line">          <span class="attr">configMap:</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager-storage</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/data/alertmanager</span></span><br><span class="line">           <span class="attr">type:</span> <span class="string">DirectoryOrCreate</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">localtime</span></span><br><span class="line">          <span class="attr">hostPath:</span></span><br><span class="line">           <span class="attr">path:</span> <span class="string">/usr/share/zoneinfo/Asia/Shanghai</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">prometheus</span></span><br><span class="line">    <span class="attr">kubernetes.io/cluster-service:</span> <span class="string">&#x27;true&#x27;</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">monitor-sa</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">alertmanager</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30066</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9093</span></span><br><span class="line">    <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9093</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">prometheus</span></span><br><span class="line">  <span class="attr">sessionAffinity:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 微信</span></span><br><span class="line"><span class="attr">receivers:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">&#x27;prometheus&#x27;</span></span><br><span class="line">  <span class="attr">wechat_configs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">corp_id:</span> <span class="string">wwa82df90a693abb15</span></span><br><span class="line">    <span class="attr">to_user:</span> <span class="string">&#x27;@all&#x27;</span></span><br><span class="line">    <span class="attr">agent_id:</span> <span class="number">1000003</span></span><br><span class="line">    <span class="attr">api_secret:</span> <span class="string">Ov5SWq_JqrolsOj6dD4Jg9qaMu1TTaDzVTCrXHcjlFs</span></span><br><span class="line">    </span><br><span class="line"><span class="comment"># 钉钉</span></span><br><span class="line">  <span class="attr">receivers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster1</span></span><br><span class="line">      <span class="attr">webhook_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">url:</span> <span class="string">&#x27;http://192.168.40.180:8060/dingtalk/cluster1/send&#x27;</span></span><br><span class="line">        <span class="attr">send_resolved:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>
<h3 id="promql"><a class="markdownIt-Anchor" href="#promql">#</a> <strong>PromQL</strong></h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">PromQL（Prometheus</span> <span class="string">Query</span> <span class="string">Language）是</span> <span class="string">Prometheus</span> <span class="string">自己开发的表达式语言，语言表现力很丰富，内置函数也很多。使用它可以对时序数据进行筛选和聚合。</span></span><br><span class="line"></span><br><span class="line"><span class="string">PromQL</span> <span class="string">表达式计算出来的值有以下几种类型：</span></span><br><span class="line"><span class="string">瞬时向量</span> <span class="string">(Instant</span> <span class="string">vector):</span> <span class="string">一组时序，每个时序只有一个采样值</span></span><br><span class="line"><span class="string">区间向量</span> <span class="string">(Range</span> <span class="string">vector):</span> <span class="string">一组时序，每个时序包含一段时间内的多个采样值</span></span><br><span class="line"><span class="string">标量数据</span> <span class="string">(Scalar):</span> <span class="string">一个浮点数</span></span><br><span class="line"><span class="string">字符串</span> <span class="string">(String):</span> <span class="string">一个字符串，暂时未用</span></span><br><span class="line"></span><br><span class="line"><span class="string">瞬时向量选择器用来选择一组时序在某个采样点的采样值。</span></span><br><span class="line"><span class="string">最简单的情况就是指定一个度量指标，选择出所有属于该度量指标的时序的当前采样值。</span></span><br><span class="line"><span class="string">可以通过在后面添加用大括号包围起来的一组标签键值对来对时序进行过滤。比如下面的表达式筛选出了</span> <span class="string">job</span> <span class="string">为</span> <span class="string">kubernetes-apiservers，并且</span> <span class="string">resource为</span> <span class="string">pod的时序：apiserver_request_total</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span></span><br><span class="line"><span class="string">匹配标签值时可以是等于，也可以使用正则表达式。总共有下面几种匹配操作符：</span></span><br><span class="line"><span class="string">=：完全相等</span></span><br><span class="line"><span class="type">!=</span><span class="string">：</span> <span class="string">不相等</span></span><br><span class="line"><span class="string">=~：</span> <span class="string">正则表达式匹配</span></span><br><span class="line"><span class="type">!~</span><span class="string">：</span> <span class="string">正则表达式不匹配</span></span><br><span class="line"><span class="string">下面的表达式筛选出了container是kube-scheduler或kube-proxy或kube-apiserver的时序数据</span></span><br><span class="line"><span class="string">container_processes&#123;container=~&quot;kube-scheduler|kube-proxy|kube-apiserver&quot;&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">区间向量选择器类似于瞬时向量选择器，不同的是它选择的是过去一段时间的采样值。可以通过在瞬时向量选择器后面添加包含在</span> [] <span class="string">里的时长来得到区间向量选择器。比如下面的表达式选出了所有度量指标为apiserver_request_total且resource是pod的时序在过去1</span> <span class="string">分钟的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;[1m]</span></span><br><span class="line"><span class="string">这个不支持Graph，需要选择Console，才会看到采集的数据</span></span><br><span class="line"><span class="string">说明：时长的单位可以是下面几种之一：</span></span><br><span class="line"><span class="string">s：seconds</span></span><br><span class="line"><span class="string">m：minutes</span></span><br><span class="line"><span class="string">h：hours</span></span><br><span class="line"><span class="string">d：days</span></span><br><span class="line"><span class="string">w：weeks</span></span><br><span class="line"><span class="string">y：years</span></span><br><span class="line"></span><br><span class="line"><span class="string">偏移向量选择器</span></span><br><span class="line"><span class="string">前面介绍的选择器默认都是以当前时间为基准时间，偏移修饰器用来调整基准时间，使其往前偏移一段时间。偏移修饰器紧跟在选择器后面，使用</span> <span class="string">offset</span> <span class="string">来指定要偏移的量。比如下面的表达式选择度量名称为apiserver_request_total的所有时序在</span> <span class="number">5</span> <span class="string">分钟前的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> <span class="string">offset</span> <span class="string">5m</span></span><br><span class="line"><span class="string">下面的表达式选择apiserver_request_total</span> <span class="string">度量指标在</span> <span class="number">1</span> <span class="string">周前的这个时间点过去</span> <span class="number">5</span> <span class="string">分钟的采样值。</span></span><br><span class="line"><span class="string">apiserver_request_total&#123;job=&quot;kubernetes-apiserver&quot;,resource=&quot;pods&quot;&#125;</span> [<span class="string">5m</span>] <span class="string">offset</span> <span class="string">1w</span></span><br><span class="line"></span><br><span class="line"><span class="string">聚合操作符</span></span><br><span class="line"><span class="string">PromQL</span> <span class="string">的聚合操作符用来将向量里的元素聚合得更少。总共有下面这些聚合操作符：</span></span><br><span class="line"><span class="string">sum：求和</span></span><br><span class="line"><span class="string">min：最小值</span></span><br><span class="line"><span class="string">max：最大值</span></span><br><span class="line"><span class="string">avg：平均值</span></span><br><span class="line"><span class="string">stddev：标准差</span></span><br><span class="line"><span class="string">stdvar：方差</span></span><br><span class="line"><span class="string">count：元素个数</span></span><br><span class="line"><span class="string">count_values：等于某值的元素个数</span></span><br><span class="line"><span class="string">bottomk：最小的</span> <span class="string">k</span> <span class="string">个元素</span></span><br><span class="line"><span class="string">topk：最大的</span> <span class="string">k</span> <span class="string">个元素</span></span><br><span class="line"><span class="string">quantile：分位数</span></span><br><span class="line"><span class="string">计算haha节点所有容器总计内存</span></span><br><span class="line"><span class="string">sum(container_memory_usage_bytes&#123;instance=~&quot;haha&quot;&#125;)/1024/1024/1024</span></span><br><span class="line"><span class="string">计算haha节点最近1m所有容器cpu使用率</span></span><br><span class="line"><span class="string">sum</span> <span class="string">(rate</span> <span class="string">(container_cpu_usage_seconds_total&#123;instance=~&quot;haha&quot;&#125;[1m]))</span> <span class="string">/</span> <span class="string">sum</span> <span class="string">(machine_cpu_cores&#123;</span> <span class="string">instance</span> <span class="string">=~&quot;haha&quot;&#125;)</span> <span class="string">*</span> <span class="number">100</span></span><br><span class="line"><span class="string">计算最近1m所有容器cpu使用率</span></span><br><span class="line"><span class="string">sum</span> <span class="string">(rate</span> <span class="string">(container_cpu_usage_seconds_total&#123;id!=&quot;/&quot;&#125;[1m]))</span> <span class="string">by</span> <span class="string">(id)</span></span><br><span class="line"></span><br><span class="line"><span class="string">函数</span></span><br><span class="line"><span class="string">Prometheus</span> <span class="string">内置了一些函数来辅助计算，下面介绍一些典型的。</span></span><br><span class="line"><span class="string">abs()：绝对值</span></span><br><span class="line"><span class="string">sqrt()：平方根</span></span><br><span class="line"><span class="string">exp()：指数计算</span></span><br><span class="line"><span class="string">ln()：自然对数</span></span><br><span class="line"><span class="string">ceil()：向上取整</span></span><br><span class="line"><span class="string">floor()：向下取整</span></span><br><span class="line"><span class="string">round()：四舍五入取整</span></span><br><span class="line"><span class="string">delta()：计算区间向量里每一个时序第一个和最后一个的差值</span></span><br><span class="line"><span class="string">sort()：排序</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控tomcat"><a class="markdownIt-Anchor" href="#prometheus-监控tomcat">#</a> prometheus 监控 tomcat</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL25saWdodGVuL3RvbWNhdF9leHBvcnRlcg==">nlighten/tomcat_exporter: A Prometheus exporter for Apache Tomcat (github.com)</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">下面在k8s-master节点操作</span><br><span class="line">（1）制作tomcat镜像，按如下步骤</span><br><span class="line">mkdir /root/tomcat_image</span><br><span class="line">把上面的war包和jar包传到这个目录下</span><br><span class="line">cat Dockerfile</span><br><span class="line">FROM tomcat:8.5-jdk8-corretto</span><br><span class="line">ADD metrics.war /usr/local/tomcat/webapps/</span><br><span class="line">ADD simpleclient-0.8.0.jar  /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_common-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_hotspot-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD simpleclient_servlet-0.8.0.jar /usr/local/tomcat/lib/</span><br><span class="line">ADD tomcat_exporter_client-0.0.12.jar /usr/local/tomcat/lib/</span><br><span class="line"></span><br><span class="line">docker build -t=&#x27;/tomcat_prometheus:v1&#x27; .</span><br><span class="line">docker login</span><br><span class="line">  username：xianchao</span><br><span class="line">  password：1989317**</span><br><span class="line">docker push xianchao/tomcat_prometheus:v1 #上传镜像到hub仓库</span><br><span class="line">docker pull xianchao/tomcat_prometheus:v1  #在k8s的node节点拉取镜像拉取镜像</span><br><span class="line"></span><br><span class="line">（2）基于上面的镜像创建一个tomcat实例</span><br><span class="line">cat deploy.yaml</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: tomcat-deployment</span><br><span class="line">  namespace: default</span><br><span class="line">spec:</span><br><span class="line">  selector: </span><br><span class="line">    matchLabels: </span><br><span class="line">     app: tomcat</span><br><span class="line">  replicas: 2 # tells deployment to run 2 pods matching the template</span><br><span class="line">  template: # create pods using pod definition in this template</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: tomcat</span><br><span class="line">      annotations:</span><br><span class="line">        prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: tomcat</span><br><span class="line">        image: xianchao/tomcat_prometheus:v1</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 8080</span><br><span class="line">        securityContext: </span><br><span class="line">          privileged: true</span><br><span class="line"></span><br><span class="line">kubectl apply -f deploy.yaml</span><br><span class="line"></span><br><span class="line">创建一个service，可操作也可不操作</span><br><span class="line"> cat tomcat-service.yaml</span><br><span class="line">kind: Service  #service 类型</span><br><span class="line">apiVersion: v1</span><br><span class="line">metadata:</span><br><span class="line">#  annotations:</span><br><span class="line">#    prometheus.io/scrape: &#x27;true&#x27;</span><br><span class="line">  name: tomcat-service</span><br><span class="line">spec:</span><br><span class="line">  selector:</span><br><span class="line">    app: tomcat</span><br><span class="line">  ports:</span><br><span class="line">  - nodePort: 31360</span><br><span class="line">    port: 80</span><br><span class="line">    protocol: TCP</span><br><span class="line">    targetPort: 8080</span><br><span class="line">  type: NodePort</span><br><span class="line"></span><br><span class="line">kubectl apply -f tomcat-service.yaml </span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控-redis"><a class="markdownIt-Anchor" href="#prometheus-监控-redis">#</a> prometheus 监控 redis</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">cat</span> <span class="string">redis.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">redis:4</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis-exporter</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">oliver006/redis_exporter:latest</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">100Mi</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9121</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-system</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">prometheus.io/scrape:</span> <span class="string">&quot;true&quot;</span></span><br><span class="line">    <span class="attr">prometheus.io/port:</span> <span class="string">&quot;9121&quot;</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">redis</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">6379</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">6379</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">prom</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">9121</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="number">9121</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span>  <span class="string">apply</span> <span class="string">-f</span> <span class="string">redis.yaml</span></span><br><span class="line"><span class="string">redis</span> <span class="string">这个</span> <span class="string">Pod</span> <span class="string">中包含了两个容器，一个就是</span> <span class="string">redis</span> <span class="string">本身的主应用，另外一个容器就是</span> <span class="string">redis_exporter</span></span><br><span class="line"></span><br><span class="line"><span class="string">由于Redis服务的metrics接口在redis-exporter</span> <span class="number">9121</span><span class="string">上，所以我们添加了prometheus.io/port=9121这样的annotation,在prometheus就会自动发现redis了</span></span><br><span class="line"></span><br><span class="line"><span class="string">接下来我们刷新一下Redis的Service配置</span></span><br><span class="line">[<span class="string">root@abcdocker</span> <span class="string">prometheus</span>]<span class="comment"># kubectl apply -f  redis.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控mysql"><a class="markdownIt-Anchor" href="#prometheus-监控mysql">#</a> prometheus 监控 mysql</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">mysql</span> <span class="string">-y</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">mariadb</span>  <span class="string">-y</span></span><br><span class="line"></span><br><span class="line"><span class="string">tar</span> <span class="string">-xvf</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class="line"><span class="string">cp</span> <span class="string">-ar</span> <span class="string">mysqld_exporter</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/bin/mysqld_exporter</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.登陆mysql为mysql_exporter创建账号并授权</span></span><br><span class="line"><span class="comment"># 创建数据库用户。</span></span><br><span class="line"><span class="string">mysql&gt;</span> <span class="string">CREATE</span> <span class="string">USER</span> <span class="string">&#x27;mysql_exporter&#x27;</span><span class="string">@&#x27;localhost&#x27;</span> <span class="string">IDENTIFIED</span> <span class="string">BY</span> <span class="string">&#x27;Abcdef123!.&#x27;</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 对mysql_exporter用户授权</span></span><br><span class="line"><span class="string">mysql&gt;</span> <span class="string">GRANT</span> <span class="string">PROCESS,</span> <span class="string">REPLICATION</span> <span class="string">CLIENT,</span> <span class="string">SELECT</span> <span class="string">ON</span> <span class="string">*.*</span> <span class="string">TO</span> <span class="string">&#x27;mysql_exporter&#x27;</span><span class="string">@&#x27;localhost&#x27;;</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.创建mysql配置文件、运行时可免密码连接数据库：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">mysqld_exporter-0.10.0.linux-amd64</span></span><br><span class="line"><span class="string">cat</span> <span class="string">my.cnf</span></span><br><span class="line">[<span class="string">client</span>]</span><br><span class="line"><span class="string">user=mysql_exporter</span></span><br><span class="line"><span class="string">password=Abcdef123!.</span></span><br><span class="line"></span><br><span class="line"><span class="string">nohup</span> <span class="string">./mysqld_exporter</span> <span class="string">--config.my-cnf=./my.cnf</span> <span class="string">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="number">5</span><span class="string">.修改prometheus-alertmanager-cfg.yaml文件，添加如下</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;mysql&#x27;</span></span><br><span class="line">    <span class="attr">static_configs:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.40.180:9104&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-deploy.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-alertmanager-deploy.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prothemeus监控nginx"><a class="markdownIt-Anchor" href="#prothemeus监控nginx">#</a> Prothemeus 监控 nginx</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">unzip</span> <span class="string">nginx-module-vts-master.zip</span></span><br><span class="line"><span class="string">mv</span> <span class="string">nginx-module-vts-master</span> <span class="string">/usr/local/</span></span><br><span class="line"></span><br><span class="line"><span class="string">tar</span> <span class="string">zxvf</span> <span class="string">nginx-1.15.7.tar.gz</span></span><br><span class="line"><span class="string">cd</span> <span class="string">nginx-1.15.7</span></span><br><span class="line"><span class="string">./configure</span>  <span class="string">--prefix=/usr/local/nginx</span> <span class="string">--with-http_gzip_static_module</span> <span class="string">--with-http_stub_status_module</span> <span class="string">--with-http_ssl_module</span> <span class="string">--with-pcre</span> <span class="string">--with-file-aio</span> <span class="string">--with-http_realip_module</span> <span class="string">--add-module=/usr/local/nginx-module-vts-master</span></span><br><span class="line"></span><br><span class="line"><span class="string">make</span> <span class="string">&amp;&amp;</span> <span class="string">make</span> <span class="string">install</span></span><br><span class="line"></span><br><span class="line"><span class="string">修改nginx配置文件：</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="string">server下添加如下：</span></span><br><span class="line"><span class="string">location</span> <span class="string">/status</span> &#123;</span><br><span class="line">        <span class="string">vhost_traffic_status_display;</span></span><br><span class="line">        <span class="string">vhost_traffic_status_display_format</span> <span class="string">html;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="string">http中添加如下：</span></span><br><span class="line"><span class="string">vhost_traffic_status_zone;</span></span><br><span class="line"><span class="string">nginx</span> <span class="string">-s</span> <span class="string">reload</span></span><br><span class="line"><span class="string">访问192.168.124.16/status可以看到nginx监控数据</span></span><br><span class="line"></span><br><span class="line"><span class="number">3</span><span class="string">.安装nginx-vts-exporter</span></span><br><span class="line"><span class="string">unzip</span>  <span class="string">nginx-vts-exporter-0.5.zip</span></span><br><span class="line"><span class="string">mv</span> <span class="string">nginx-vts-exporter-0.5</span>  <span class="string">/usr/local/</span></span><br><span class="line"><span class="string">chmod</span> <span class="string">+x</span> <span class="string">/usr/local/nginx-vts-exporter-0.5/bin/nginx-vts-exporter</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/usr/local/nginx-vts-exporter-0.5/bin</span></span><br><span class="line"><span class="string">nohup</span> <span class="string">./nginx-vts-exporter</span>  <span class="string">-nginx.scrape_uri</span> <span class="string">http://192.168.124.16/status/format/json</span> <span class="string">&amp;</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.修改prometheus-cfg.yaml文件</span></span><br><span class="line"><span class="string">添加如下job：</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">&#x27;nginx&#x27;</span></span><br><span class="line">      <span class="attr">scrape_interval:</span> <span class="string">5s</span></span><br><span class="line">      <span class="attr">static_configs:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">targets:</span> [<span class="string">&#x27;192.168.124.16:9913&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-cfg.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">prometheus-deploy.yaml</span></span><br></pre></td></tr></table></figure>
<h3 id="prometheus-监控-mongodb"><a class="markdownIt-Anchor" href="#prometheus-监控-mongodb">#</a> prometheus 监控 mongodb</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">1.下载mongodb和mongodb_exporter镜像</span><br><span class="line">docker pull mongo</span><br><span class="line">docker pull eses/mongodb_exporter</span><br><span class="line"></span><br><span class="line">2.启动mongodb</span><br><span class="line"><span class="built_in">mkdir</span> -p /data/db</span><br><span class="line">docker run -d --name mongodb -p 27017:27017 -v /data/db:/data/db mongo</span><br><span class="line"><span class="comment">#创建mongo账号密码，给mongodb_exporter连接mongo用</span></span><br><span class="line">（1）登录到容器</span><br><span class="line">docker <span class="built_in">exec</span> -it 24f910190790ade396844cef61cc66412b7af2108494742922c6157c5b236aac mongo admin</span><br><span class="line">（2）设置密码</span><br><span class="line">use admin</span><br><span class="line">db.createUser(&#123; user: <span class="string">&#x27;admin&#x27;</span>, <span class="built_in">pwd</span>: <span class="string">&#x27;admin111111&#x27;</span>, roles: [ &#123; role: <span class="string">&quot;userAdminAnyDatabase&quot;</span>, db: <span class="string">&quot;admin&quot;</span> &#125; ] &#125;)</span><br><span class="line"></span><br><span class="line">docker run -d --name mongodb_exporter -p 30056:9104  percona/mongodb_exporter:0.34.0   --mongodb.uri mongodb://admin:admin111111@192.168.124.16:27017</span><br><span class="line"></span><br><span class="line">注：admin:admin111111这个就是上面启动mongodb后设置的密码，@后面接mongodb的ip和端口</span><br><span class="line"></span><br><span class="line">4.修改prometheus-cfg.yaml文件</span><br><span class="line">添加一个job_name</span><br><span class="line">- job_name: <span class="string">&#x27;mongodb&#x27;</span></span><br><span class="line">  scrape_interval: 5s</span><br><span class="line">  static_configs:</span><br><span class="line">  - targets: [<span class="string">&#x27;192.168.124.16:30056&#x27;</span>]</span><br><span class="line"></span><br><span class="line">kubectl apply -f prometheus-cfg.yaml</span><br><span class="line">kubectl delete -f prometheus-deploy.yaml</span><br><span class="line">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>
<h3 id="pushgateway"><a class="markdownIt-Anchor" href="#pushgateway">#</a> pushgateway</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Pushgateway是prometheus的一个组件，prometheus server默认是通过exporter主动获取数据（默认采取pull拉取数据），pushgateway则是通过被动方式推送数据到prometheus server，用户可以写一些自定义的监控脚本把需要监控的数据发送给pushgateway， 然后pushgateway再把数据发送给Prometheus server</span><br><span class="line"></span><br><span class="line">Pushgateway优点：</span><br><span class="line">Prometheus 默认采用定时pull 模式拉取targets数据，但是如果不在一个子网或者防火墙，prometheus就拉取不到targets数据，所以可以采用各个target往pushgateway上push数据，然后prometheus去pushgateway上定时pull数据</span><br><span class="line">在监控业务数据的时候，需要将不同数据汇总, 汇总之后的数据可以由pushgateway统一收集，然后由 Prometheus 统一拉取。</span><br><span class="line"></span><br><span class="line">pushgateway缺点：</span><br><span class="line">Prometheus拉取状态只针对 pushgateway, 不能对每个节点都有效；</span><br><span class="line">Pushgateway出现问题，整个采集到的数据都会出现问题</span><br><span class="line">监控下线，prometheus还会拉取到旧的监控数据，需要手动清理 pushgateway不要的数据。</span><br><span class="line"></span><br><span class="line">docker push prom/pushgateway</span><br><span class="line">docker run -d --name pushgateway -p 9091:9091 prom/pushgateway</span><br><span class="line"></span><br><span class="line">    - job_name: <span class="string">&#x27;pushgateway&#x27;</span></span><br><span class="line">      scrape_interval: 5s</span><br><span class="line">      static_configs:</span><br><span class="line">      - targets: [<span class="string">&#x27;192.168.13.181:9091&#x27;</span>]</span><br><span class="line">      honor_labels: <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">kubectl apply -f prometheus-cfg.yaml</span><br><span class="line">kubectl delete -f prometheus-deploy.yaml</span><br><span class="line">kubectl apply -f prometheus-deploy.yaml</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230529153332021.png" alt="image-20230529153332021"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">推送指定的数据格式到pushgateway</span><br><span class="line"></span><br><span class="line">向 &#123;job=<span class="string">&quot;test_job&quot;</span>&#125; 添加单条数据：</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot; metric 3.6&quot;</span> | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job</span><br><span class="line"></span><br><span class="line">添加复杂数据</span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span></span><br><span class="line"><span class="string">node_memory_usage 36</span></span><br><span class="line"><span class="string">node_memory_total 36000</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line">删除某个组下某个实例的所有数据</span><br><span class="line">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job/instance/test_instance</span><br><span class="line"></span><br><span class="line">删除某个组下的所有数据：</span><br><span class="line">curl -X DELETE http://192.168.13.181:9091/metrics/job/test_job</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">把数据上报到pushgateway</span><br><span class="line">在被监控服务所在的机器配置数据上报,想要把192.168.13.181这个机器的内存数据上报到pushgateway，下面步骤需要在192.168.40.181操作</span><br><span class="line"></span><br><span class="line"><span class="built_in">cat</span> push.sh</span><br><span class="line"></span><br><span class="line">node_memory_usages=$(free -m | grep Mem | awk <span class="string">&#x27;&#123;print $3/$2*100&#125;&#x27;</span>)</span><br><span class="line">job_name=<span class="string">&quot;memory&quot;</span></span><br><span class="line">instance_name=<span class="string">&quot;192.168.13.181&quot;</span></span><br><span class="line"><span class="built_in">cat</span> &lt;&lt;<span class="string">EOF | curl --data-binary @- http://192.168.13.181:9091/metrics/job/$job_name/instance/$instance_name</span></span><br><span class="line"><span class="string">node_memory_usages $node_memory_usages</span></span><br><span class="line"><span class="string">EOF</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">sh push.sh</span><br><span class="line"></span><br><span class="line">crontab -u root -e</span><br><span class="line">*/1 * * * * /root/push.sh</span><br><span class="line"></span><br><span class="line">注意：从上面配置可以看到，我们上传到pushgateway中的数据有job也有instance，而prometheus配置pushgateway这个job_name中也有job和instance，这个job和instance是指pushgateway实例本身，添加 honor_labels: <span class="literal">true</span> 参数， 可以避免promethues的targets列表中的job_name是pushgateway的 job 、instance 和上报到pushgateway数据的job和instance冲突。</span><br></pre></td></tr></table></figure>
<h2 id="elk"><a class="markdownIt-Anchor" href="#elk">#</a> ELK</h2>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">日志打印的常见级别：</span><br><span class="line">日志打印通常有四种级别，从高到底分别是：ERROR、WARN、INFO、DEBUG。</span><br><span class="line"></span><br><span class="line">在你的系统中如果开启了某一级别的日志后，就不会打印比它级别低的日志。例如，程序如果开启了INFO级别日志，DEBUG日志就不会打印，通常在生产环境中开启INFO日志。</span><br><span class="line"></span><br><span class="line">1、DEBUG：</span><br><span class="line">DEBU可以打印出最详细的日志信息，主要用于开发过程中打印一些运行信息。</span><br><span class="line">2、INFO：</span><br><span class="line">INFO可以打印一些你感兴趣的或者重要的信息，这个可以用于生产环境中输出程序运行的一些重要信息，但是不能滥用，避免打印过多的日志。</span><br><span class="line">3、WARNING： </span><br><span class="line">WARNING 表明发生了一些暂时不影响运行的错误，会出现潜在错误的情形，有些信息不是错误信息，但是也要给程序员的一些提示 </span><br><span class="line">4、ERROR：</span><br><span class="line">ERROR 可以打印错误和异常信息，如果不想输出太多的日志，可以使用这个级别，这一级就是比较重要的错误了，软件的某些功能已经不能继续执行了。</span><br><span class="line"></span><br><span class="line">通过查看INFO日志发现是由于自己操作失误，造成了程序结果和预期不符合，这种情况不是程序出错，所以并不是bug，不需要开发人员到场。</span><br><span class="line">通过查看INFO日志发现自己的操作正确，根据INFO日志查看并不是操作失误造成，这个时候就需要开发人员到场确认。</span><br><span class="line"></span><br><span class="line">ERROR和WARN的级别都比INFO要高，所以在设定日志级别在INFO时，这两者的日志也会被打印。根据上面INFO和DEBUG级别的区别以及适用人员可以知道，ERROR和WARN是同时给测试和开发、运维观察的。WARN级别称之为“警告”，这个“警告”实际上就有点含糊了，它不算错，你可以选择忽视它，但也可以选择重视它。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">常见的日志收集方案</span><br><span class="line">EFK</span><br><span class="line">在Kubernetes集群上运行多个服务和应用程序时，日志收集系统可以帮助你快速分类和分析由Pod生成的大量日志数据。Kubernetes中比较流行的日志收集解决方案是Elasticsearch、Fluentd和Kibana（EFK）技术栈，也是官方推荐的一种方案。</span><br><span class="line"></span><br><span class="line">Elasticsearch是一个实时的，分布式的，可扩展的搜索引擎，它允许进行全文本和结构化搜索以及对日志进行分析。它通常用于索引和搜索大量日志数据，也可以用于搜索许多不同种类的文档。</span><br><span class="line"></span><br><span class="line">Elasticsearch通常与Kibana一起部署，kibana可以把Elasticsearch采集到的数据通过dashboard（仪表板）可视化展示出来。Kibana允许你通过Web界面浏览Elasticsearch日志数据，也可自定义查询条件快速检索出elasticccsearch中的日志数据。</span><br><span class="line"></span><br><span class="line">Fluentd是一个流行的开源数据收集器，我们在 Kubernetes 集群节点上安装 Fluentd，通过获取容器日志文件、过滤和转换日志数据，然后将数据传递到 Elasticsearch 集群，在该集群中对其进行索引和存储。</span><br><span class="line"></span><br><span class="line">ELK</span><br><span class="line">E - Elasticsearch（简称：ES）</span><br><span class="line">L - Logstash</span><br><span class="line">K - Kibana</span><br><span class="line">Elasticsearch：日志存储和搜索引擎，它的特点有：分布式，零配置，自动发现，索引自动分片，索引副本机制，restful风格接口，多数据源，自动搜索负载等。</span><br><span class="line"></span><br><span class="line">Logstash：是一个完全开源的工具，他可以对你的日志进行收集、过滤，并将其存储供以后使用（支持动态的从各种数据源搜集数据，并对数据进行过滤、分析、丰富、统一格式等操作。）。</span><br><span class="line"></span><br><span class="line">Kibana 也是一个开源和免费的工具，Kibana可以为 Logstash 和 ElasticSearch 提供的日志分析友好的 Web 界面，可以帮助您汇总、分析和搜索重要数据日志。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ELK+filebeat</span><br><span class="line">Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line"></span><br><span class="line">2.4 其他方案</span><br><span class="line">ELK日志流程可以有多种方案（不同组件可自由组合，根据自身业务配置），常见有以下：</span><br><span class="line"></span><br><span class="line">    Logstash（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Logstash（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Filebeat（采集、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">    Filebeat（采集）—&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br><span class="line">Filebeat（采集）—&gt; Kafka/Redis(消峰) —&gt; Logstash（聚合、处理）—&gt; ElasticSearch （存储）—&gt;Kibana （展示）</span><br></pre></td></tr></table></figure>
<h3 id="efk组件"><a class="markdownIt-Anchor" href="#efk组件">#</a> efk 组件</h3>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Elasticsearch 是一个分布式的免费开源搜索和分析引擎，适用于包括文本、数字、地理空间、结构化和非结构化数据等在内的所有类型的数据。Elasticsearch 在 Apache Lucene 的基础上开发而成，由 Elasticsearch N.V.（即现在的 Elastic）于 2010 年首次发布。</span><br><span class="line">Elasticsearch 以其简单的 REST 风格 API、分布式特性、速度和可扩展性而闻名，是 Elastic Stack 的核心组件；Elastic Stack 是一套适用于数据采集、扩充、存储、分析和可视化的免费开源工具。</span><br><span class="line">人们通常将 Elastic Stack 称为 ELK Stack（代指 Elasticsearch、Logstash 和 Kibana），目前 Elastic Stack 包括一系列丰富的轻量型数据采集代理，这些代理统称为 Beats，可用来向 Elasticsearch 发送数据。</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">filebeat是Beats中的一员。</span><br><span class="line">　　Beats是一个轻量级日志采集器，Beats家族有6个成员，早期的ELK架构中使用Logstash收集、解析日志，但是Logstash对内存、cpu、io等资源消耗比较高。相比Logstash，Beats所占系统的CPU和内存几乎可以忽略不计。</span><br><span class="line"></span><br><span class="line">目前Beats包含六种工具：</span><br><span class="line">1、Packetbeat：网络数据（收集网络流量数据）</span><br><span class="line">2、Metricbeat：指标（收集系统、进程和文件系统级别的CPU和内存使用情况等数据）</span><br><span class="line">3、Filebeat：日志文件（收集文件数据）</span><br><span class="line">4、Winlogbeat：windows事件日志（收集Windows事件日志数据）</span><br><span class="line">5、Auditbeat：审计数据（收集审计日志）</span><br><span class="line">6、Heartbeat：运行时间监控（收集系统运行时的数据）</span><br><span class="line"></span><br><span class="line">Filebeat是用于转发和收集日志数据的轻量级传送工具。Filebeat监视你指定的日志文件或位置，收集日志事件，并将它们转发到Elasticsearch或 Logstash中。</span><br><span class="line">Filebeat的工作方式如下：启动Filebeat时，它将启动一个或多个输入，这些输入将在为日志数据指定的位置中查找。对于Filebeat所找到的每个日志，Filebeat都会启动收集器。每个收集器都读取单个日志以获取新内容，并将新日志数据发送到libbeat，libbeat将聚集事件，并将聚集的数据发送到为Filebeat配置的输出。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530142835668.png" alt="image-20230530142835668"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Filebeat 有两个主要组件：</span><br><span class="line">    harvester：一个harvester负责读取一个单个文件的内容。harvester逐行读取每个文件，并把这些内容发送到输出。每个文件启动一个harvester。</span><br><span class="line">    Input：一个input负责管理harvesters，并找到所有要读取的源。如果input类型是log，则input查找驱动器上与已定义的log日志路径匹配的所有文件，并为每个文件启动一个harvester。</span><br><span class="line">    </span><br><span class="line">Filebeat工作原理</span><br><span class="line">在任何环境下，应用程序都有停机的可能性。 Filebeat 读取并转发日志行，如果中断，则会记住所有事件恢复联机状态时所在位置。</span><br><span class="line">Filebeat带有内部模块（auditd，Apache，Nginx，System和MySQL），可通过一个指定命令来简化通用日志格式的收集，解析和可视化。</span><br><span class="line">FileBeat 不会让你的管道超负荷。FileBeat 如果是向 Logstash 传输数据，当 Logstash 忙于处理数据，会通知 FileBeat 放慢读取速度。一旦拥塞得到解决，FileBeat将恢复到原来的速度并继续传播。</span><br><span class="line">Filebeat保持每个文件的状态，并经常刷新注册表文件中的磁盘状态。状态用于记住harvester正在读取的最后偏移量，并确保发送所有日志行。Filebeat将每个事件的传递状态存储在注册表文件中。所以它能保证事件至少传递一次到配置的输出，没有数据丢失。</span><br><span class="line"></span><br><span class="line">传输方案</span><br><span class="line">1、output.elasticsearch</span><br><span class="line">如果你希望使用 filebeat 直接向 elasticsearch 输出数据，需要配置 output.elasticsearch</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;192.168.40.180:9200&quot;]</span><br><span class="line">2、output.logstash</span><br><span class="line">如果使用filebeat向 logstash输出数据，然后由 logstash 再向elasticsearch 输出数据，需要配置 output.logstash。 logstash 和 filebeat 一起工作时，如果 logstash 忙于处理数据，会通知FileBeat放慢读取速度。一旦拥塞得到解决，FileBeat 将恢复到原来的速度并继续传播。这样，可以减少管道超负荷的情况。</span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.40.180:5044&quot;]  </span><br><span class="line">  </span><br><span class="line">3、output.kafka</span><br><span class="line">如果使用filebeat向kafka输出数据，然后由 logstash 作为消费者拉取kafka中的日志，并再向elasticsearch 输出数据，需要配置 output.logstash</span><br><span class="line">output.kafka:</span><br><span class="line">  enabled: true</span><br><span class="line">  hosts: [&quot;192.168.40.180:9092&quot;]</span><br><span class="line">  topic: elfk8stest</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">logstash组件介绍</span><br><span class="line">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。Logstash 是一个应用程序日志、事件的传输、处理、管理和搜索的平台。你可以用它来统一对应用程序日志进行收集管理，提供 Web 接口用于查询和统计。</span><br><span class="line">输入：采集各种样式、大小和来源的数据</span><br><span class="line">数据往往以各种各样的形式，或分散或集中地存在于很多系统中。Logstash 支持各种输入选择 ，可以在同一时间从众多常用来源捕捉事件。能够以连续的流式传输方式，轻松地从你的日志、指标、Web 应用、数据存储以及各种 AWS 服务采集数据。</span><br><span class="line"></span><br><span class="line">过滤器：实时解析和转换数据</span><br><span class="line">数据从源传输到存储库的过程中，Logstash 过滤器能够解析各个事件，识别已命名的字段以构建结构，并将它们转换成通用格式，以便更轻松、更快速地分析和实现商业价值。</span><br><span class="line">Logstash 能够动态地转换和解析数据，不受格式或复杂度的影响：</span><br><span class="line">1、利用 Grok 从非结构化数据中派生出结构</span><br><span class="line">2、从 IP 地址破译出地理坐标</span><br><span class="line">3、将 PII 数据匿名化，完全排除敏感字段</span><br><span class="line">4、整体处理不受数据源、格式或架构的影响</span><br><span class="line"></span><br><span class="line">输出：选择你的存储，导出你的数据</span><br><span class="line">尽管 Elasticsearch 是我们的首选输出方向，能够为我们的搜索和分析带来无限可能，但它并非唯一选择。Logstash 提供众多输出选择，你可以将数据发送到你要指定的地方。 </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230530143914957.png" alt="image-20230530143914957"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">Logstash 有两个必要元素：input 和 output ，一个可选元素：filter。 这三个元素，分别代表 Logstash 事件处理的三个阶段：输入 &gt; 过滤器 &gt; 输出</span><br><span class="line"></span><br><span class="line">Input负责从数据源采集数据。</span><br><span class="line">filter 将数据修改为你指定的格式或内容。</span><br><span class="line">output 将数据传输到目的地。</span><br><span class="line"></span><br><span class="line">在实际应用场景中，通常输入、输出、过滤器不止一个。Logstash 的这三个元素都使用插件式管理方式，可以根据应用需要，灵活的选用各阶段需要的插件，并组合使用。</span><br><span class="line"></span><br><span class="line">常用input模块</span><br><span class="line">    file：从文件系统上的文件读取</span><br><span class="line">    syslog：在众所周知的端口514上侦听系统日志消息，并根据RFC3164格式进行解析</span><br><span class="line">    redis：从redis服务器读取，使用redis通道和redis列表。 Redis经常用作集中式Logstash安装中的“代理”，它将接收来自远程Logstash“托运人”的Logstash事件排队。</span><br><span class="line">    beats：处理由Filebeat发送的事件。</span><br><span class="line"></span><br><span class="line">常用的filter模块</span><br><span class="line">    过滤器是Logstash管道中的中间处理设备。可以将条件过滤器组合在一起，对事件执行操作。</span><br><span class="line">    grok：解析和结构任意文本。 Grok目前是Logstash中将非结构化日志数据解析为结构化和可查询的最佳方法。</span><br><span class="line">    mutate：对事件字段执行一般转换。可以重命名，删除，替换和修改事件中的字段。</span><br><span class="line">    drop：完全放弃一个事件，例如调试事件。</span><br><span class="line">    clone：制作一个事件的副本，可能会添加或删除字段。</span><br><span class="line">    geoip：添加有关IP地址的地理位置的信息</span><br><span class="line"></span><br><span class="line">常用output</span><br><span class="line">    elasticsearch：将事件数据发送给 Elasticsearch（推荐模式）。</span><br><span class="line">    file：将事件数据写入文件或磁盘。</span><br><span class="line">    graphite：将事件数据发送给 graphite（一个流行的开源工具，存储和绘制指标， http://graphite.readthedocs.io/en/latest/）。</span><br><span class="line">    statsd：将事件数据发送到 statsd （这是一种侦听统计数据的服务，如计数器和定时器，通过UDP发送并将聚合发送到一个或多个可插入的后端服务）。</span><br><span class="line">    </span><br><span class="line">input &#123;</span><br><span class="line">      kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; &quot;192.168.40.180:9092&quot;</span><br><span class="line">        auto_offset_reset =&gt; &quot;latest&quot;</span><br><span class="line">        consumer_threads =&gt; 5</span><br><span class="line">        decorate_events =&gt; true</span><br><span class="line">        topics =&gt; [&quot;elktest&quot;]</span><br><span class="line">      &#125;</span><br><span class="line">&#125;</span><br><span class="line">          </span><br><span class="line">output &#123; </span><br><span class="line">    elasticsearch &#123; </span><br><span class="line">        hosts =&gt; [&quot;192.168.40.180:9200&quot;]</span><br><span class="line">        index =&gt; &quot;elkk8stest-%&#123;+YYYY.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">fluentd是一个针对日志的收集、处理、转发系统。通过丰富的插件系统，可以收集来自于各种系统或应用的日志，转化为用户指定的格式后，转发到用户所指定的日志存储系统之中。</span><br><span class="line">fluentd 常常被拿来和Logstash比较，我们常说ELK，L就是这个agent。fluentd 是随着Docker和es一起流行起来的agent。</span><br><span class="line">fluentd 比 logstash 更省资源；</span><br><span class="line">更轻量级的 fluent-bid 对应 filebeat，作为部署在结点上的日志收集器；</span><br><span class="line">fluentd 有更多强大、开放的插件数量和社区。插件多，也非常灵活，规则也不复杂。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">fluentd、filebeat、logstash对比分析</span><br><span class="line"></span><br><span class="line">Logstash</span><br><span class="line">Logstash是一个开源数据收集引擎，具有实时管道功能。Logstash可以动态地将来自不同数据源的数据统一起来，并将数据标准化到你所选择的目的地。</span><br><span class="line">优势</span><br><span class="line">Logstash 主要的优点就是它的灵活性，主要因为它有很多插件，详细的文档以及直白的配置格式让它可以在多种场景下应用。我们基本上可以在网上找到很多资源，几乎可以处理任何问题。</span><br><span class="line">劣势</span><br><span class="line">Logstash 致命的问题是它的性能以及资源消耗(默认的堆大小是 1GB)。尽管它的性能在近几年已经有很大提升，与它的替代者们相比还是要慢很多的。这里有 Logstash 与 rsyslog 性能对比以及Logstash 与 filebeat 的性能对比。它在大数据量的情况下会是个问题。</span><br><span class="line">另一个问题是它目前不支持缓存，目前的典型替代方案是将 Redis 或 Kafka 作为中心缓冲池：</span><br><span class="line">因为 Logstash 自身的灵活性以及网络上丰富的资料，Logstash 适用于原型验证阶段使用，或者解析非常的复杂的时候。在不考虑服务器资源的情况下，如果服务器的性能足够好，我们也可以为每台服务器安装 Logstash 。我们也不需要使用缓冲，因为文件自身就有缓冲的行为，而 Logstash 也会记住上次处理的位置。</span><br><span class="line">如果服务器性能较差，并不推荐为每个服务器安装 Logstash ，这样就需要一个轻量的日志传输工具，将数据从服务器端经由一个或多个 Logstash 中心服务器传输到 Elasticsearch：</span><br><span class="line"></span><br><span class="line">Filebeat</span><br><span class="line">作为 Beats 家族的一员，Filebeat 是一个轻量级的日志传输工具，它的存在正弥补了 Logstash 的缺点：Filebeat 作为一个轻量级的日志传输工具可以将日志推送到中心 Logstash。</span><br><span class="line">在版本 5.x 中，Elasticsearch 具有解析的能力(像 Logstash 过滤器)— Ingest。这也就意味着可以将数据直接用 Filebeat 推送到 Elasticsearch，并让 Elasticsearch 既做解析的事情，又做存储的事情。也不需要使用缓冲，因为 Filebeat 也会和 Logstash 一样记住上次读取的偏移，如果需要缓冲(例如，不希望将日志服务器的文件系统填满)，可以使用 Redis/Kafka，因为 Filebeat 可以与它们进行通信。</span><br><span class="line">优势</span><br><span class="line">Filebeat 只是一个二进制文件没有任何依赖。它占用资源极少，尽管它还十分年轻，正式因为它简单，所以几乎没有什么可以出错的地方，所以它的可靠性还是很高的。它也为我们提供了很多可以调节的点，例如：它以何种方式搜索新的文件，以及当文件有一段时间没有发生变化时，何时选择关闭文件句柄。</span><br><span class="line">劣势</span><br><span class="line">Filebeat 的应用范围十分有限，所以在某些场景下我们会碰到问题。例如，如果使用 Logstash 作为下游管道，我们同样会遇到性能问题。正因为如此，Filebeat 的范围在扩大。开始时，它只能将日志发送到 Logstash 和 Elasticsearch，而现在它可以将日志发送给 Kafka 和 Redis，在 5.x 版本中，它还具备过滤的能力。</span><br><span class="line"></span><br><span class="line">Fluentd</span><br><span class="line">Fluentd 创建的初衷主要是尽可能的使用 JSON 作为日志输出，所以传输工具及其下游的传输线不需要猜测子字符串里面各个字段的类型。这样，它为几乎所有的语言都提供库，这也意味着，我们可以将它插入到我们自定义的程序中。</span><br><span class="line">优势</span><br><span class="line">和多数 Logstash 插件一样，Fluentd 插件是用 Ruby 语言开发的非常易于编写维护。所以它数量很多，几乎所有的源和目标存储都有插件(各个插件的成熟度也不太一样)。这也意味这我们可以用 Fluentd 来串联所有的东西。</span><br><span class="line">劣势</span><br><span class="line">因为在多数应用场景下，我们会通过 Fluentd 得到结构化的数据，它的灵活性并不好。但是我们仍然可以通过正则表达式，来解析非结构化的数据。尽管，性能在大多数场景下都很好，但它并不是最好的，和 syslog-ng 一样，它的缓冲只存在与输出端，单线程核心以及 Ruby GIL 实现的插件意味着它大的节点下性能是受限的，不过，它的资源消耗在大多数场景下是可以接受的。对于小的或者嵌入式的设备，可能需要看看 Fluent Bit，它和 Fluentd 的关系与 Filebeat 和 Logstash 之间的关系类似。</span><br><span class="line"></span><br><span class="line">Logagent</span><br><span class="line">Logagent 是 Sematext 提供的传输工具，它用来将日志传输到 Logsene(一个基于 SaaS 平台的 Elasticsearch API)，因为 Logsene 会暴露 Elasticsearch API，所以 Logagent 可以很容易将数据推送到 Elasticsearch 。</span><br><span class="line">优势</span><br><span class="line">可以获取 /var/log 下的所有信息，解析各种格式(Elasticsearch，Solr，MongoDB，Apache HTTPD等等)，它可以掩盖敏感的数据信息，例如，个人验证信息(PII)，出生年月日，信用卡号码，等等。它还可以基于 IP 做 GeoIP 丰富地理位置信息(例如，access logs)。同样，它轻量又快速，可以将其置入任何日志块中。在新的 2.0 版本中，它以第三方 node.js 模块化方式增加了支持对输入输出的处理插件。重要的是 Logagent 有本地缓冲，所以不像 Logstash ，在数据传输目的地不可用时会丢失日志。</span><br><span class="line">劣势</span><br><span class="line">尽管 Logagent 有些比较有意思的功能(例如，接收 Heroku 或 CloudFoundry 日志)，但是它并没有 Logstash 灵活。</span><br><span class="line"></span><br><span class="line">logtail</span><br><span class="line">阿里云日志服务的生产者，目前在阿里集团内部机器上运行，经过3年多时间的考验，目前为阿里公有云用户提供日志收集服务。</span><br><span class="line">采用C++语言实现，对稳定性、资源控制、管理等下过很大的功夫，性能良好。相比于logstash、fluentd的社区支持，logtail功能较为单一，专注日志收集功能。</span><br><span class="line">优势</span><br><span class="line">logtail占用机器cpu、内存资源最少，结合阿里云日志服务的E2E体验良好。</span><br><span class="line">劣势</span><br><span class="line">logtail目前对特定日志类型解析的支持较弱，后续需要把这一块补起来。</span><br><span class="line"></span><br><span class="line">rsyslog</span><br><span class="line">绝大多数 Linux 发布版本默认的 syslog 守护进程，rsyslog 可以做的不仅仅是将日志从 syslog socket 读取并写入 /var/log/messages 。它可以提取文件、解析、缓冲(磁盘和内存)以及将它们传输到多个目的地，包括 Elasticsearch 。可以从此处找到如何处理 Apache 以及系统日志。</span><br><span class="line">优势</span><br><span class="line">rsyslog 是经测试过的最快的传输工具。如果只是将它作为一个简单的 router/shipper 使用，几乎所有的机器都会受带宽的限制，但是它非常擅长处理解析多个规则。它基于语法的模块(mmnormalize)无论规则数目如何增加，它的处理速度始终是线性增长的。这也就意味着，如果当规则在 20-30 条时，如解析 Cisco 日志时，它的性能可以大大超过基于正则式解析的 grok ，达到 100 倍(当然，这也取决于 grok 的实现以及 liblognorm 的版本)。</span><br><span class="line">它同时也是我们能找到的最轻的解析器，当然这也取决于我们配置的缓冲。</span><br><span class="line">劣势</span><br><span class="line">rsyslog 的配置工作需要更大的代价(这里有一些例子)，这让两件事情非常困难：</span><br><span class="line">文档难以搜索和阅读，特别是那些对术语比较陌生的开发者。</span><br><span class="line">5.x 以上的版本格式不太一样(它扩展了 syslogd 的配置格式，同时也仍然支持旧的格式)，尽管新的格式可以兼容旧格式，但是新的特性(例如，Elasticsearch 的输出)只在新的配置下才有效，然后旧的插件(例如，Postgres 输出)只在旧格式下支持。</span><br></pre></td></tr></table></figure>
<h3 id="安装elasticsearch"><a class="markdownIt-Anchor" href="#安装elasticsearch">#</a> 安装 elasticsearch</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">.创建一个kube-logging名称空间，将EFK组件安装到该名称空间中。</span></span><br><span class="line"></span><br><span class="line"><span class="string">在这个名称空间下去安装日志收集组件efk，首先，我们需要部署一个有3个节点的Elasticsearch集群。我们使用3个Elasticsearch</span> <span class="string">Pods可以避免高可用中的多节点群集中发生的“裂脑”的问题。</span> <span class="string">Elasticsearch脑裂可参考如下：https://www.elastic.co/guide/en/elasticsearch/reference/current/modules-node.html#split-brain</span></span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">.创建一个headless</span> <span class="string">service的Kubernetes服务，服务名称是elasticsearch，这个服务将为3个Pod定义一个DNS域。headless</span> <span class="string">service不具备负载均衡也没有IP。</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">clusterIP:</span> <span class="string">None</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9200</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">port:</span> <span class="number">9300</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">inter-node</span></span><br><span class="line"></span><br><span class="line"> </span><br><span class="line"><span class="number">3</span><span class="string">.</span> <span class="string">创建Storageclass，实现存储类动态供给</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nfs</span> <span class="string">--now</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/data/v1</span> <span class="string">-p</span></span><br><span class="line"><span class="string">/data/v1</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">restart</span> <span class="string">nfs</span></span><br><span class="line"></span><br><span class="line"><span class="number">4</span><span class="string">.创建nfs作为存储的供应商</span></span><br><span class="line"><span class="number">1</span><span class="string">、创建sa</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="number">2</span><span class="string">、对sa做rbac授权</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>, <span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;extensions&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;podsecuritypolicies&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;nfs-provisioner&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;use&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">run-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner-runner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leader-locking-nfs-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"></span><br><span class="line"><span class="string">vim</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">--feature-gates=RemoveSelfLink=false</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">apply</span> <span class="string">-f</span> <span class="string">/etc/kubernetes/manifests/kube-apiserver.yaml</span> <span class="comment"># 可能导致6443暂时无法访问</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">delete</span> <span class="string">pod</span> <span class="string">-n</span> <span class="string">kube-system</span> <span class="string">kube-apiserver</span> <span class="comment"># 高可用时需要改一个文件删一个api-server</span></span><br><span class="line"></span><br><span class="line"><span class="string">工作节点：</span></span><br><span class="line"> <span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span> <span class="string">nfs-client-provisioner.tar.gz</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#通过deployment创建pod用来运行nfs-provisioner</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-provisioner</span></span><br><span class="line">          <span class="attr">image:</span> <span class="string">registry.cn-hangzhou.aliyuncs.com/open-ali/xianchao/nfs-client-provisioner:v1</span></span><br><span class="line">          <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">          <span class="attr">volumeMounts:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">              <span class="attr">mountPath:</span> <span class="string">/persistentvolumes</span></span><br><span class="line">          <span class="attr">env:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">example.com/nfs</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_SERVER</span></span><br><span class="line">              <span class="attr">value:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">            <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">NFS_PATH</span></span><br><span class="line">              <span class="attr">value:</span> <span class="string">/data/v1</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nfs-client-root</span></span><br><span class="line">          <span class="attr">nfs:</span></span><br><span class="line">            <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/data/v1</span></span><br><span class="line"><span class="comment">#创建stoorageclass</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">do-block-storage</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">example.com/nfs</span></span><br><span class="line">      </span><br><span class="line"><span class="comment"># 安装elasticsearch集群</span></span><br><span class="line"><span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span> <span class="string">elasticsearch_7_2_0.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StatefulSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">es-cluster</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">serviceName:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">elasticsearch</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">docker.elastic.co/elasticsearch/elasticsearch:7.2.0</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">            <span class="attr">limits:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">requests:</span></span><br><span class="line">              <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9200</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">rest</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">9300</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">inter-node</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster.name</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">k8s-logs</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">node.name</span></span><br><span class="line">            <span class="attr">valueFrom:</span></span><br><span class="line">              <span class="attr">fieldRef:</span></span><br><span class="line">                <span class="attr">fieldPath:</span> <span class="string">metadata.name</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">discovery.seed_hosts</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;es-cluster-0.elasticsearch.kube-logging.svc.cluster.local,es-cluster-1.elasticsearch.kube-logging.svc.cluster.local,es-cluster-2.elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cluster.initial_master_nodes</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;es-cluster-0,es-cluster-1,es-cluster-2&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ES_JAVA_OPTS</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;-Xms512m -Xmx512m&quot;</span></span><br><span class="line">      <span class="attr">initContainers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fix-permissions</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;chown -R 1000:1000 /usr/share/elasticsearch/data&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/usr/share/elasticsearch/data</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-vm-max-map</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sysctl&quot;</span>, <span class="string">&quot;-w&quot;</span>, <span class="string">&quot;vm.max_map_count=262144&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">increase-fd-ulimit</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;ulimit -n 65536&quot;</span>]</span><br><span class="line">        <span class="attr">securityContext:</span></span><br><span class="line">          <span class="attr">privileged:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">volumeClaimTemplates:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">data</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">elasticsearch</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">accessModes:</span> [ <span class="string">&quot;ReadWriteOnce&quot;</span> ]</span><br><span class="line">      <span class="attr">storageClassName:</span> <span class="string">do-block-storage</span></span><br><span class="line">      <span class="attr">resources:</span></span><br><span class="line">        <span class="attr">requests:</span></span><br><span class="line">          <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line"></span><br><span class="line"><span class="string">pod部署完成之后，可以通过REST</span> <span class="string">API检查elasticsearch集群是否部署成功，使用下面的命令将本地端口9200转发到</span> <span class="string">Elasticsearch</span> <span class="string">节点（如es-cluster-0）对应的端口：</span></span><br><span class="line"></span><br><span class="line"><span class="string">kubectl</span> <span class="string">port-forward</span> <span class="string">es-cluster-0</span> <span class="number">9200</span><span class="string">:9200</span> <span class="string">--namespace=kube-logging</span></span><br><span class="line"><span class="string">curl</span> <span class="string">http://localhost:9200/_cat/</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建kibaba</span></span><br><span class="line">apiVersion: v1</span><br><span class="line">kind: Service</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: kube-logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  ports:</span><br><span class="line">  - port: 5601</span><br><span class="line">  selector:</span><br><span class="line">    app: kibana</span><br><span class="line">---</span><br><span class="line">apiVersion: apps/v1</span><br><span class="line">kind: Deployment</span><br><span class="line">metadata:</span><br><span class="line">  name: kibana</span><br><span class="line">  namespace: kube-logging</span><br><span class="line">  labels:</span><br><span class="line">    app: kibana</span><br><span class="line">spec:</span><br><span class="line">  replicas: 1</span><br><span class="line">  selector:</span><br><span class="line">    matchLabels:</span><br><span class="line">      app: kibana</span><br><span class="line">  template:</span><br><span class="line">    metadata:</span><br><span class="line">      labels:</span><br><span class="line">        app: kibana</span><br><span class="line">    spec:</span><br><span class="line">      containers:</span><br><span class="line">      - name: kibana</span><br><span class="line">        image: docker.elastic.co/kibana/kibana:7.2.0</span><br><span class="line">        imagePullPolicy: IfNotPresent</span><br><span class="line">        resources:</span><br><span class="line">          limits:</span><br><span class="line">            cpu: 1000m</span><br><span class="line">          requests:</span><br><span class="line">            cpu: 100m</span><br><span class="line">        <span class="built_in">env</span>:</span><br><span class="line">          - name: ELASTICSEARCH_URL</span><br><span class="line">            value: http://elasticsearch.kube-logging.svc.cluster.local:9200</span><br><span class="line">        ports:</span><br><span class="line">        - containerPort: 5601</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装fluentd组件</span></span><br><span class="line"><span class="string">我们使用daemonset控制器部署fluentd组件，这样可以保证集群中的每个节点都可以运行同样fluentd的pod副本，这样就可以收集k8s集群中每个节点的日志，在k8s集群中，容器应用程序的输入输出日志会重定向到node节点里的json文件中，fluentd可以tail和过滤以及把日志转换成指定的格式发送到elasticsearch集群中。除了容器日志，fluentd也可以采集kubelet、kube-proxy、docker的日志。</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">&quot;&quot;</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pods</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">namespaces</span></span><br><span class="line">  <span class="attr">verbs:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">get</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">list</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">watch</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">kube-logging</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">fluentd</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">fluentd</span></span><br><span class="line">      <span class="attr">serviceAccountName:</span> <span class="string">fluentd</span></span><br><span class="line">      <span class="attr">tolerations:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">node-role.kubernetes.io/master</span></span><br><span class="line">        <span class="attr">effect:</span> <span class="string">NoSchedule</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">fluent/fluentd-kubernetes-daemonset:v1.4.2-debian-elasticsearch-1.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">FLUENT_ELASTICSEARCH_HOST</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;elasticsearch.kube-logging.svc.cluster.local&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span>  <span class="string">FLUENT_ELASTICSEARCH_PORT</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;9200&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENT_ELASTICSEARCH_SCHEME</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">&quot;http&quot;</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENTD_SYSTEMD_CONF</span></span><br><span class="line">            <span class="attr">value:</span> <span class="string">disable</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">terminationGracePeriodSeconds:</span> <span class="number">30</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/log</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlibdockercontainers</span></span><br><span class="line">        <span class="attr">hostPath:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/var/lib/docker/containers</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="测试pod"><a class="markdownIt-Anchor" href="#测试pod">#</a> 测试 pod</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">counter</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">count</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">args:</span> [<span class="string">/bin/sh</span>, <span class="string">-c</span>,<span class="string">&#x27;i=0; while true; do echo &quot;$i: $(date)&quot;; i=$((i+1)); sleep 1; done&#x27;</span>]</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143741555.png" alt="image-20230531143741555"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230531143701392.png" alt="image-20230531143701392"></p>
<p>[Kibana Query Language | Kibana Guide <span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9ndWlkZS9lbi9raWJhbmEvNy4yL2t1ZXJ5LXF1ZXJ5Lmh0bWw=">7.2] | Elastic</span></p>
<h2 id="ceph"><a class="markdownIt-Anchor" href="#ceph">#</a> ceph</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">ceph是一种开源的分布式的存储系统</span><br><span class="line">包含以下几种存储类型：</span><br><span class="line">块存储（rbd），对象存储(RADOS Fateway)，文件系统（cephfs）</span><br><span class="line"></span><br><span class="line">1.块存储（rbd）：</span><br><span class="line">块是一个字节序列（例如，512字节的数据块）。 基于块的存储接口是使用旋转介质（如硬盘，CD，软盘甚至传统的9轨磁带）存储数据的最常用方法;Ceph块设备是精简配置，可调整大小并存储在Ceph集群中多个OSD条带化的数据。 Ceph块设备利用RADOS功能，如快照，复制和一致性。 Ceph的RADOS块设备（RBD）使用内核模块或librbd库与OSD进行交互;Ceph的块设备为内核模块或QVM等KVM以及依赖libvirt和QEMU与Ceph块设备集成的OpenStack和CloudStack等基于云的计算系统提供高性能和无限可扩展性。 可以使用同一个集群同时运行Ceph RADOS Gateway，CephFS文件系统和Ceph块设备。</span><br><span class="line">linux系统中，ls /dev/下有很多块设备文件，这些文件就是我们添加硬盘时识别出来的；</span><br><span class="line">rbd就是由Ceph集群提供出来的块设备。可以这样理解，sda是通过数据线连接到了真实的硬盘，而rbd是通过网络连接到了Ceph集群中的一块存储区域，往rbd设备文件写入数据，最终会被存储到Ceph集群的这块区域中；</span><br><span class="line">总结：块设备可理解成一块硬盘，用户可以直接使用不含文件系统的块设备，也可以将其格式化成特定的文件系统，由文件系统来组织管理存储空间，从而为用户提供丰富而友好的数据操作支持。</span><br><span class="line"></span><br><span class="line">2.文件系统cephfs</span><br><span class="line">Ceph文件系统（CephFS）是一个符合POSIX标准的文件系统，它使用Ceph存储集群来存储其数据。 Ceph文件系统使用与Ceph块设备相同的Ceph存储集群系统。</span><br><span class="line">用户可以在块设备上创建xfs文件系统，也可以创建ext4等其他文件系统，Ceph集群实现了自己的文件系统来组织管理集群的存储空间，用户可以直接将Ceph集群的文件系统挂载到用户机上使用，Ceph有了块设备接口，在块设备上完全可以构建一个文件系统，那么Ceph为什么还需要文件系统接口呢？</span><br><span class="line">主要是因为应用场景的不同，Ceph的块设备具有优异的读写性能，但不能多处挂载同时读写，目前主要用在OpenStack上作为虚拟磁盘，而Ceph的文件系统接口读写性能较块设备接口差，但具有优异的共享性。</span><br><span class="line"></span><br><span class="line">3.对象存储</span><br><span class="line">Ceph对象存储使用Ceph对象网关守护进程（radosgw），它是一个用于与Ceph存储集群交互的HTTP服务器。由于它提供与OpenStack Swift和Amazon S3兼容的接口，因此Ceph对象网关具有自己的用户管理。 Ceph对象网关可以将数据存储在用于存储来自Ceph文件系统客户端或Ceph块设备客户端的数据的相同Ceph存储集群中</span><br><span class="line">使用方式就是通过http协议上传下载删除对象（文件即对象）。</span><br><span class="line">老问题来了，有了块设备接口存储和文件系统接口存储，为什么还整个对象存储呢?</span><br><span class="line">Ceph的块设备存储具有优异的存储性能但不具有共享性，而Ceph的文件系统具有共享性然而性能较块设备存储差，为什么不权衡一下存储性能和共享性，整个具有共享性而存储性能好于文件系统存储的存储呢，对象存储就这样出现了。</span><br><span class="line"></span><br><span class="line">分布式存储的优点：</span><br><span class="line">高可靠：既满足存储读取不丢失，还要保证数据长期存储。 在保证部分硬件损坏后依然可以保证数据安全</span><br><span class="line">高性能：读写速度快</span><br><span class="line">可扩展：分布式存储的优势就是“分布式”，所谓的“分布式”就是能够将多个物理节点整合在一起形成共享的存储池，节点可以线性扩充，这样可以源源不断的通过扩充节点提升性能和扩大容量，这是传统存储阵列无法做到的</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Ceph核心组件介绍</span><br><span class="line">在ceph集群中，不管你是想要提供对象存储，块设备存储，还是文件系统存储，所有Ceph存储集群部署都是从设置每个Ceph节点，网络和Ceph存储开始 的。 Ceph存储集群至少需要一个Ceph Monitor，Ceph Manager和Ceph OSD（对象存储守护进程）。 运行Ceph Filesystem客户端时也需要Ceph元数据服务器。</span><br><span class="line"></span><br><span class="line">Monitors：Ceph监视器（ceph-mon）维护集群状态的映射，包括监视器映射，管理器映射，OSD映射和CRUSH映射。这些映射是Ceph守护进程相互协调所需的关键集群状态。监视器还负责管理守护进程和客户端之间的身份验证。冗余和高可用性通常至少需要三个监视器。</span><br><span class="line"></span><br><span class="line">Managers：Ceph Manager守护程序（ceph-mgr）负责跟踪运行时指标和Ceph集群的当前状态，包括存储利用率，当前性能指标和系统负载。 Ceph Manager守护进程还托管基于python的模块来管理和公开Ceph集群信息，包括基于Web的Ceph Dashboard和REST API。高可用性通常至少需要两名Managers。</span><br><span class="line"></span><br><span class="line">Ceph OSD：Ceph OSD（对象存储守护进程，ceph-osd）存储数据，处理数据复制，恢复，重新平衡，并通过检查其他Ceph OSD守护进程来获取心跳，为Ceph监视器和管理器提供一些监视信息。冗余和高可用性通常至少需要3个Ceph OSD。</span><br><span class="line"></span><br><span class="line">MDS：Ceph元数据服务器（MDS，ceph-mds）代表Ceph文件系统存储元数据（即，Ceph块设备和Ceph对象存储不使用MDS）。 Ceph元数据服务器允许POSIX文件系统用户执行基本命令（如ls，find等），而不会给Ceph存储集群带来巨大负担。</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ceph集群</span></span><br><span class="line"><span class="comment">#在master1-admin节点安装ceph-deploy</span></span><br><span class="line"> yum install python-setuptools  ceph-deploy -y</span><br><span class="line"><span class="comment">#在master1-admin、node1-monitor和node2-osd节点安装ceph</span></span><br><span class="line">yum install ceph ceph-radosgw  -y</span><br><span class="line"></span><br><span class="line">[root@master1-admin ~]<span class="comment"># ceph --version</span></span><br><span class="line">ceph version 10.2.11 (e4b061b47f07f583c92a050d9e84b1813a35671e)</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建一个目录，用于保存 ceph-deploy 生成的配置文件信息的</span></span><br><span class="line">[root@master1-admin ceph ~]<span class="comment"># cd /etc/ceph</span></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ceph-deploy new master1-admin node1-monitor node2-osd</span></span><br><span class="line"><span class="comment"># 执行会生成如下文件</span></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ls </span></span><br><span class="line">ceph.conf  ceph-deploy-ceph.log  ceph.mon.keyring  rbdmap</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.<span class="comment"># 追加如下参数</span></span><br><span class="line">osd_pool_default_size = 2</span><br><span class="line">mon clock drift allowed = 0.500</span><br><span class="line">mon clock drift warn backoff = 10</span><br><span class="line"></span><br><span class="line">mon clock drift allowed <span class="comment">#监视器间允许的时钟漂移量默认值0.05</span></span><br><span class="line">mon clock drift warn backoff <span class="comment">#时钟偏移警告的退避指数。默认值5</span></span><br><span class="line">ceph对每个mon之间的时间同步延时默认要求在0.05s之间，这个时间有的时候太短了。所以如果ceph集群如果出现clock问题就检查ntp时间同步或者适当放宽这个误差时间。</span><br><span class="line">cephx是认证机制是整个 Ceph 系统的用户名/密码</span><br><span class="line"></span><br><span class="line">2、配置初始monitor、收集所有的密钥</span><br><span class="line">[root@master1-admin]<span class="comment"># cd /etc/ceph</span></span><br><span class="line">[root@master1-admin]<span class="comment"># ceph-deploy mon create-initial</span></span><br><span class="line">[root@master1-admin]<span class="comment"># ls *.keyring</span></span><br><span class="line">ceph.bootstrap-mds.keyring  ceph.bootstrap-mgr.keyring  ceph.bootstrap-osd.keyring  ceph.bootstrap-rgw.keyring  ceph.client.admin.keyring  ceph.mon.keyring</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 准备osd</span></span><br><span class="line"><span class="built_in">cd</span> /etc/ceph/</span><br><span class="line">ceph-deploy osd prepare master1-admin:/dev/sdb </span><br><span class="line">ceph-deploy osd prepare node1-monitor:/dev/sdb </span><br><span class="line">ceph-deploy osd prepare node2-osd:/dev/sdb</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#激活osd</span></span><br><span class="line">ceph-deploy osd activate master1-admin:/dev/sdb1</span><br><span class="line">ceph-deploy osd activate node1-monitor:/dev/sdb1</span><br><span class="line">ceph-deploy osd activate node2-osd:/dev/sdb1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看状态</span></span><br><span class="line">ceph-deploy osd list master1-admin node1-monitor node2-osd</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建ceph文件系统</span></span><br><span class="line">创建mds</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph-deploy mds create master1-admin node1-monitor node2-osd</span></span><br><span class="line"></span><br><span class="line">查看ceph当前文件系统</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs ls   	</span></span><br><span class="line"></span><br><span class="line">No filesystems enabled</span><br><span class="line"></span><br><span class="line">一个cephfs至少要求两个librados存储池，一个为data，一个为metadata。当配置这两个存储池时，注意：</span><br><span class="line">1. 为metadata pool设置较高级别的副本级别，因为metadata的损坏可能导致整个文件系统不用</span><br><span class="line">2. 建议，metadata pool使用低延时存储，比如SSD，因为metadata会直接影响客户端的响应速度。</span><br><span class="line"></span><br><span class="line">创建存储池</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph osd pool create cephfs_data 128</span></span><br><span class="line">pool <span class="string">&#x27;cephfs_data&#x27;</span> created</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph osd pool create cephfs_metadata 128</span></span><br><span class="line">pool <span class="string">&#x27;cephfs_metadata&#x27;</span> created</span><br><span class="line"></span><br><span class="line">关于创建存储池</span><br><span class="line">确定 pg_num 取值是强制性的，因为不能自动计算。下面是几个常用的值：</span><br><span class="line">*少于 5 个 OSD 时可把 pg_num 设置为 128</span><br><span class="line">*OSD 数量在 5 到 10 个时，可把 pg_num 设置为 512</span><br><span class="line">*OSD 数量在 10 到 50 个时，可把 pg_num 设置为 4096</span><br><span class="line">*OSD 数量大于 50 时，你得理解权衡方法、以及如何自己计算 pg_num 取值</span><br><span class="line">*自己计算 pg_num 取值时可借助 pgcalc 工具</span><br><span class="line">随着 OSD 数量的增加，正确的 pg_num 取值变得更加重要，因为它显著地影响着集群的行为、以及出错时的数据持久性（即灾难性事件导致数据丢失的概率）。</span><br><span class="line"></span><br><span class="line">创建文件系统</span><br><span class="line">创建好存储池后，你就可以用 fs new 命令创建文件系统了</span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs new xianchao cephfs_metadata cephfs_data</span></span><br><span class="line">new fs with metadata pool 2 and data pool 1</span><br><span class="line">其中：new后的fsname  可自定义</span><br><span class="line"></span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph fs ls              #查看创建后的cephfs</span></span><br><span class="line">[root@ master1-admin ceph]<span class="comment"># ceph mds stat          #查看mds节点状态</span></span><br><span class="line"></span><br><span class="line">[root@master1-admin ceph]<span class="comment"># ceph -s </span></span><br><span class="line">    cluster 66e0ffc8-fb71-40ee-bcc0-a6e87713ddac</span><br><span class="line">     health HEALTH_WARN</span><br><span class="line">            clock skew detected on mon.node2-osd</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="k8s挂载ceph-rbd"><a class="markdownIt-Anchor" href="#k8s挂载ceph-rbd">#</a> k8s 挂载 ceph rbd</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># kubernetes要想使用ceph，需要在k8s的每个node节点安装ceph-common，把ceph节点上的ceph.repo文件拷贝到k8s各个节点/etc/yum.repos.d/目录下，然后在k8s的各个节点yum install ceph-common -y</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># scp /etc/yum.repos.d/ceph.repo 192.168.40.180:/etc/yum.repos.d/</span></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># scp /etc/yum.repos.d/ceph.repo 192.168.40.181:/etc/yum.repos.d/</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@masterk8s</span> <span class="string">~</span>]<span class="comment"># yum install ceph-common -y</span></span><br><span class="line">[<span class="string">root@nodek8s</span> <span class="string">~</span>]<span class="comment"># yum install ceph-common -y</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># scp /etc/ceph/* 192.168.40.180:/etc/ceph/</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># scp /etc/ceph/* 192.168.40.181:/etc/ceph/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#创建ceph rbd</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8srbd1 6</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd create rbda -s 1024 -p k8srbd1</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd feature disable  k8srbd1/rbda object-map fast-diff deep-flatten</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testrbd</span></span><br><span class="line">      <span class="attr">rbd:</span></span><br><span class="line">        <span class="attr">monitors:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#x27;192.168.13.202:6789&#x27;</span></span><br><span class="line">        <span class="attr">pool:</span> <span class="string">k8srbd1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">rbda</span></span><br><span class="line">        <span class="attr">fsType:</span> <span class="string">xfs</span></span><br><span class="line">        <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">        <span class="attr">keyring:</span> <span class="string">/etc/ceph/ceph.client.admin.keyring</span></span><br><span class="line"></span><br><span class="line"><span class="string">k8srbd1下的rbda被pod挂载了，那其他pod就不能占用这个k8srbd1下的rbda了</span></span><br><span class="line"></span><br><span class="line"><span class="string">创建deployment的时候也只有一个能running，因为只有一个pod能用这个块设备</span></span><br></pre></td></tr></table></figure>
<h3 id="ceph-rbd生成pv"><a class="markdownIt-Anchor" href="#ceph-rbd生成pv">#</a> ceph rbd 生成 pv</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、创建ceph-secret这个k8s</span> <span class="string">secret对象，这个secret对象用于k8s</span> <span class="string">volume插件访问ceph集群，获取client.admin的keyring值，并用base64编码，在master1-admin（ceph管理节点）操作</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph auth get-key client.admin | base64</span></span><br><span class="line"></span><br><span class="line"><span class="string">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFBWk0zeGdZdDlhQXhBQVZsS0poYzlQUlBianBGSWJVbDNBenc9PQ==</span></span><br><span class="line">  </span><br><span class="line"><span class="number">3</span><span class="string">.回到ceph</span> <span class="string">管理节点创建pool池</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8stest 6</span></span><br><span class="line"><span class="string">pool</span> <span class="string">&#x27;k8stest&#x27;</span> <span class="string">created</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd create rbda -s 1024 -p k8stest</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># rbd feature disable  k8stest/rbda object-map fast-diff deep-flatten</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-pv</span> </span><br><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">   <span class="attr">capacity:</span>     </span><br><span class="line">     <span class="attr">storage:</span> <span class="string">1Gi</span>   </span><br><span class="line">   <span class="attr">accessModes:</span>     </span><br><span class="line">   <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>   </span><br><span class="line">   <span class="attr">rbd:</span>     </span><br><span class="line">         <span class="attr">monitors:</span>       </span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.201:6789&#x27;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.200:6789&#x27;</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">&#x27;192.168.13.202:6789&#x27;</span>    </span><br><span class="line">         <span class="attr">pool:</span> <span class="string">k8stest</span>     </span><br><span class="line">         <span class="attr">image:</span> <span class="string">rbda</span>     </span><br><span class="line">         <span class="attr">user:</span> <span class="string">admin</span>     </span><br><span class="line">         <span class="attr">secretRef:</span>       </span><br><span class="line">             <span class="attr">name:</span> <span class="string">ceph-secret</span>     </span><br><span class="line">         <span class="attr">fsType:</span> <span class="string">xfs</span>     </span><br><span class="line">         <span class="attr">readOnly:</span> <span class="literal">false</span>   </span><br><span class="line">   <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span> </span><br><span class="line"><span class="attr">metadata:</span>   </span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-pvc</span> </span><br><span class="line"><span class="attr">spec:</span>   </span><br><span class="line">  <span class="attr">accessModes:</span>     </span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteOnce</span>   </span><br><span class="line">  <span class="attr">resources:</span>     </span><br><span class="line">   <span class="attr">requests:</span>       </span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">     <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span> <span class="comment"># tells deployment to run 2 pods matching the template</span></span><br><span class="line">  <span class="attr">template:</span> <span class="comment"># create pods using pod definition in this template</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">          <span class="bullet">-</span> <span class="attr">mountPath:</span> <span class="string">&quot;/ceph-data&quot;</span></span><br><span class="line">            <span class="attr">name:</span> <span class="string">ceph-data</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-data</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">            <span class="attr">claimName:</span> <span class="string">ceph-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="string">通过上面实验可以发现pod是可以以ReadWriteOnce共享挂载相同的pvc的</span></span><br><span class="line"></span><br><span class="line"><span class="string">注意：ceph</span> <span class="string">rbd块存储的特点</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储能在同一个node上跨pod以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储能在同一个node上同一个pod多个容器中以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">ceph</span> <span class="string">rbd块存储不能跨node以ReadWriteOnce共享挂载</span></span><br><span class="line"><span class="string">如果一个使用ceph</span> <span class="string">rdb的pod所在的node挂掉，这个pod虽然会被调度到其它node，但是由于rbd不能跨node多次挂载和挂掉的pod不能自动解绑pv的问题，这个新pod不会正常运行</span></span><br><span class="line"></span><br><span class="line"><span class="string">Deployment更新特性：</span></span><br><span class="line"><span class="string">deployment触发更新的时候，它确保至少所需</span> <span class="string">Pods</span> <span class="number">75</span><span class="string">%</span> <span class="string">处于运行状态（最大不可用比例为</span> <span class="number">25</span><span class="string">%）。故像一个pod的情况，肯定是新创建一个新的pod，新pod运行正常之后，再关闭老的pod。</span></span><br><span class="line"><span class="string">默认情况下，它可确保启动的</span> <span class="string">Pod</span> <span class="string">个数比期望个数最多多出</span> <span class="number">25</span><span class="string">%</span></span><br><span class="line"></span><br><span class="line"><span class="string">问题：</span></span><br><span class="line"><span class="string">结合ceph</span> <span class="string">rbd共享挂载的特性和deployment更新的特性，我们发现原因如下：</span></span><br><span class="line"><span class="string">由于deployment触发更新，为了保证服务的可用性，deployment要先创建一个pod并运行正常之后，再去删除老pod。而如果新创建的pod和老pod不在一个node，就会导致此故障。</span></span><br><span class="line"></span><br><span class="line"><span class="string">解决办法：</span></span><br><span class="line"><span class="number">1</span><span class="string">，使用能支持跨node和pod之间挂载的共享存储，例如cephfs，GlusterFS等</span></span><br><span class="line"><span class="number">2</span><span class="string">，给node添加label，只允许deployment所管理的pod调度到一个固定的node上。（不建议，这个node挂掉的话，服务就故障了）</span></span><br></pre></td></tr></table></figure>
<h3 id="基于storage动态生成pv"><a class="markdownIt-Anchor" href="#基于storage动态生成pv">#</a> 基于 storage 动态生成 pv</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@\master~</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line">[<span class="string">root@node</span>]<span class="comment"># chmod 777  -R  /etc/ceph/*</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master1-admin</span>]<span class="comment"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment">#mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1-monitor</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node2-osd</span>]<span class="comment"># cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master~</span>]<span class="comment">#mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@master</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1</span>]<span class="comment"># mkdir /root/.ceph/</span></span><br><span class="line">[<span class="string">root@node1</span> <span class="string">~</span>]<span class="comment">#cp -ar /etc/ceph/ /root/.ceph/</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">、创建rbd的供应商provisioner</span></span><br><span class="line"><span class="comment">#把rbd-provisioner.tar.gz上传到xianchaonode1上，手动解压</span></span><br><span class="line">[<span class="string">root@xianchaonode1</span> <span class="string">~</span>]<span class="comment"># docker load -i rbd-provisioner.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumes&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;delete&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;persistentvolumeclaims&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;update&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;storage.k8s.io&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;storageclasses&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;events&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line">  <span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">    <span class="attr">resources:</span> [<span class="string">&quot;services&quot;</span>]</span><br><span class="line">    <span class="attr">resourceNames:</span> [<span class="string">&quot;kube-dns&quot;</span>,<span class="string">&quot;coredns&quot;</span>]</span><br><span class="line">    <span class="attr">verbs:</span> [<span class="string">&quot;list&quot;</span>, <span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ClusterRoleBinding</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">    <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">ClusterRole</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">rules:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;secrets&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>]</span><br><span class="line"><span class="bullet">-</span> <span class="attr">apiGroups:</span> [<span class="string">&quot;&quot;</span>]</span><br><span class="line">  <span class="attr">resources:</span> [<span class="string">&quot;endpoints&quot;</span>]</span><br><span class="line">  <span class="attr">verbs:</span> [<span class="string">&quot;get&quot;</span>, <span class="string">&quot;list&quot;</span>, <span class="string">&quot;watch&quot;</span>, <span class="string">&quot;create&quot;</span>, <span class="string">&quot;update&quot;</span>, <span class="string">&quot;patch&quot;</span>]</span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">rbac.authorization.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">RoleBinding</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">roleRef:</span></span><br><span class="line">  <span class="attr">apiGroup:</span> <span class="string">rbac.authorization.k8s.io</span></span><br><span class="line">  <span class="attr">kind:</span> <span class="string">Role</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">subjects:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">default</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span></span><br><span class="line">  <span class="attr">strategy:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">Recreate</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">quay.io/xianchao/external_storage/rbd-provisioner:v1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">env:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">PROVISIONER_NAME</span></span><br><span class="line">          <span class="attr">value:</span> <span class="string">ceph.com/rbd</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">rbd-provisioner</span></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ServiceAccount</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-provisioner</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"><span class="number">2</span><span class="string">、创建ceph-secret</span></span><br><span class="line"><span class="comment">#创建pool池</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># ceph osd pool create k8stest1 6</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-secret-1</span></span><br><span class="line"><span class="attr">type:</span> <span class="string">&quot;ceph.com/rbd&quot;</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFEN0VIZGswYmZ1Q0JBQXhRK1hGUFV0d1BraTlCNjBSbndiYmc9PQ==</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">storage.k8s.io/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">StorageClass</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">k8s-rbd</span></span><br><span class="line"><span class="attr">provisioner:</span> <span class="string">ceph.com/rbd</span></span><br><span class="line"><span class="attr">parameters:</span></span><br><span class="line">  <span class="attr">monitors:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.201</span><span class="string">:6789,192.168.13.202:6789,192.168.13.200:6789</span></span><br><span class="line">  <span class="attr">adminId:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">adminSecretName:</span> <span class="string">ceph-secret-1</span></span><br><span class="line">  <span class="attr">pool:</span> <span class="string">k8stest1</span></span><br><span class="line">  <span class="attr">userId:</span> <span class="string">admin</span></span><br><span class="line">  <span class="attr">userSecretName:</span> <span class="string">ceph-secret-1</span></span><br><span class="line">  <span class="attr">fsType:</span> <span class="string">xfs</span></span><br><span class="line">  <span class="attr">imageFormat:</span> <span class="string">&quot;2&quot;</span></span><br><span class="line">  <span class="attr">imageFeatures:</span> <span class="string">&quot;layering&quot;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">rbd-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteOnce</span></span><br><span class="line">  <span class="attr">volumeMode:</span> <span class="string">Filesystem</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">storageClassName:</span> <span class="string">k8s-rbd</span></span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">test:</span> <span class="string">rbd-pod</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">ceph-rbd-pod</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd-nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd</span></span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">      <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">ceph-rbd</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">rbd-pvc</span></span><br><span class="line">      </span><br></pre></td></tr></table></figure>
<h3 id="k8s对接cephfs"><a class="markdownIt-Anchor" href="#k8s对接cephfs">#</a> k8s 对接 cephfs</h3>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">、创建ceph子目录</span></span><br><span class="line"></span><br><span class="line"><span class="string">为了别的地方能挂载cephfs，先创建一个secretfile</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># cat /etc/ceph/ceph.client.admin.keyring |grep key|awk -F&quot; &quot; &#x27;&#123;print $3&#125;&#x27; &gt; /etc/ceph/admin.secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">挂载cephfs的根目录到集群的mon节点下的一个目录，比如xianchao_data，因为挂载后，我们就可以直接在xianchao_data下面用Linux命令创建子目录了。</span></span><br><span class="line"></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># mkdir xianchao_data</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># mount -t ceph 192.168.40.201:6789:/ /root/xianchao_data -o name=admin,secretfile=/etc/ceph/admin.secret</span></span><br><span class="line"></span><br><span class="line"><span class="string">在cephfs的根目录里面创建了一个子目录lucky，k8s以后就可以挂载这个目录</span> </span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">~</span>]<span class="comment"># cd /root/xianchao_data/</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># mkdir lucky</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># chmod 0777 lucky/</span></span><br><span class="line"></span><br><span class="line"><span class="string">创建k8s连接ceph使用的secret</span></span><br><span class="line">   <span class="string">将/etc/ceph/ceph.client.admin.keyring里面的key的值转换为base64，否则会有问题</span></span><br><span class="line">[<span class="string">root@master1-admin</span> <span class="string">xianchao_data</span>]<span class="comment"># echo &quot;AQBvBdZgsDSZKxAAan+5rnsjr2ziA/atqFnQOA==&quot; | base64</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Secret</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-secret</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key:</span> <span class="string">QVFCdkJkWmdzRFNaS3hBQWFuKzVybnNqcjJ6aUEvYXRxRm5RT0E9PQo=</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">cephfs:</span></span><br><span class="line">    <span class="attr">monitors:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="number">192.168</span><span class="number">.40</span><span class="number">.201</span><span class="string">:6789</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/lucky</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">secretRef:</span></span><br><span class="line">        <span class="attr">name:</span> <span class="string">cephfs-secret</span></span><br><span class="line">  <span class="attr">persistentVolumeReclaimPolicy:</span> <span class="string">Recycle</span>  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pvc</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">volumeName:</span> <span class="string">cephfs-pv</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">1Gi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cephfs-pod-1</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">image:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">      <span class="attr">volumeMounts:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-v1</span></span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">/mnt</span></span><br><span class="line">  <span class="attr">volumes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-v1</span></span><br><span class="line">    <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">      <span class="attr">claimName:</span> <span class="string">cephfs-pvc</span></span><br></pre></td></tr></table></figure>
<h2 id="devops"><a class="markdownIt-Anchor" href="#devops">#</a> devops</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">敏捷开发</span><br><span class="line">提高开发效率，及时跟进用户需求，缩短开发周期。</span><br><span class="line"></span><br><span class="line">敏捷开发包括编写代码和构建代码两个阶段，可以使用git或者svn来管理代码，用maven对代码进行构建 </span><br><span class="line"></span><br><span class="line">1.5.2 持续集成（CI）</span><br><span class="line">持续集成强调开发人员提交了新代码之后，立刻自动的进行构建、（单元）测试。根据测试结果，我们可以确定新代码和原有代码能否正确地集成在一起。持续集成过程中很重视自动化测试验证结果，对可能出现的一些问题进行预警，以保障最终合并的代码没有问题。</span><br><span class="line">常见的持续集成工具：</span><br><span class="line">1. Jenkins</span><br><span class="line">Jenkins是用Java语言编写的，是目前使用最多和最受欢迎的持续集成工具，使用Jenkins，可以自动监测到git或者svn存储库代码的更新，基于最新的代码进行构建，把构建好的源码或者镜像发布到生产环境。Jenkins还有个非常好的功能：它可以在多台机器上进行分布式地构建和负载测试</span><br><span class="line">2. TeamCity</span><br><span class="line">3.  Travis CI</span><br><span class="line">4.   Go CD </span><br><span class="line">5.  Bamboo</span><br><span class="line">6.   GitLab CI</span><br><span class="line">7.  Codeship</span><br><span class="line"></span><br><span class="line">它的好处主要有以下几点：</span><br><span class="line">1）较早的发现错误：每次集成都通过自动化的构建（包括编译，发布，自动化测试）来验证，哪个环节出现问题都可以较早的发现</span><br><span class="line">2）快速的发现错误：每完成一部分代码的更新，就会把代码集成到主干中，这样就可以快速的发现错误，比较容易的定位错误</span><br><span class="line">3）提升团队绩效：持续集成中代码更新速度快，能及时发现小问题并进行修改，使团队能创造出更好的产品</span><br><span class="line">4）防止分支过多的偏离主干：经常持续集成，会使分支代码经常向主干更新，当单元测试失败或者出现bug，如果开发者需要在没有调试的情况下恢复仓库的代码到没有bug的状态，只有很小部分的代码会丢失 </span><br><span class="line">持续集成的目的是提高代码质量，让产品快速的更新迭代。它的核心措施是，代码集成到主干之前，必须通过自动化测试。只要有一个测试用例失败，就不能集成。</span><br><span class="line">Martin Fowler说过，&quot;持续集成并不能消除Bug，而是让它们非常容易发现和改正。&quot;</span><br><span class="line"></span><br><span class="line">1.5.3 持续交付</span><br><span class="line">持续交付在持续集成的基础上，将集成后的代码部署到更贴近真实运行环境的「类生产环境」（production-like environments）中。交付给质量团队或者用户，以供评审。如果评审通过，代码就进入生产阶段。</span><br><span class="line">如果所有的代码完成之后一起交付，会导致很多问题爆发出来，解决起来很麻烦，所以持续集成，也就是没更新一次代码，都向下交付一次，这样可以及时发现问题，及时解决，防止问题大量堆积。</span><br><span class="line">1.5.4 持续部署</span><br><span class="line">持续部署是指当交付的代码通过评审之后，自动部署到生产环境中。持续部署是持续交付的最高阶段。</span><br><span class="line">Puppet，SaltStack和Ansible是这个阶段使用的流行工具。容器化工具在部署阶段也发挥着重要作用。 Docker和k8s是流行的工具，有助于在开发，测试和生产环境中实现一致性。 除此之外，k8s还可以实现自动扩容缩容等功能。 </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602135250221.png" alt="image-20230602135250221"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">K8S在DevOps中的核心作用</span><br><span class="line">Docker和K8S的出现使DevOps变得更加普及，更加容易实现。在传统运维中我们服务时需要针对不同的环境去安装不同的版本，部署方式也杂、多。那么有了docker之后，一次构建、到处运行，我们只需要要构建一次镜像，那么只要有docker的主机，就可以基于镜像把应用跑起来。</span><br><span class="line"></span><br><span class="line">在众多微服务中，我们每天可能需要去处理各种服务的崩溃，而服务间的依赖调用关系也及其复杂，这对我们解决问题带来了很大的复杂度。要很好的解决这个问题。我们就需要用到容器编排工具。</span><br><span class="line"></span><br><span class="line">Kubernetes 的出现主宰了容器编排的市场，也进化了过去的运维方式，将开发与运维联系的更加紧密。而且让 DevOps 这一角色变得更加清晰，它是目前可用的很流行的容器解决方案之一。</span><br><span class="line">3.1 自动化</span><br><span class="line">敏捷开发-&gt;持续集成-&gt;持续交付-&gt;持续部署</span><br><span class="line">3.2 多集群管理</span><br><span class="line">可以根据客户需求对开发，测试，生产环境部署多套kubernetes集群，每个环境使用独立的物理资源，相互之间避免影响</span><br><span class="line">3.3 多环境一致性</span><br><span class="line">Kubernetes是基于docker的容器编排工具，因为容器的镜像是不可变的，所以镜像把 OS、业务代码、运行环境、程序库、目录结构都包含在内，镜像保存在我们的私有仓库，只要用户从我们提供的私有仓库拉取镜像，就能保证环境的一致性。</span><br><span class="line">3.4 实时反馈和智能化报表</span><br><span class="line">每次集成或交付，都会第一时间将结果通过多途径的方式反馈给你，也可以定制适合企业专用的报表平台。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230602143206987.png" alt="image-20230602143206987"></p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span><span class="string">.安装nfs</span></span><br><span class="line"><span class="string">yum</span> <span class="string">install</span> <span class="string">nfs-utils</span> <span class="string">-y</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">start</span> <span class="string">nfs</span></span><br><span class="line"><span class="string">systemctl</span> <span class="string">enable</span> <span class="string">nfs</span></span><br><span class="line"><span class="string">（2）在master1上创建一个nfs共享目录</span></span><br><span class="line"><span class="string">mkdir</span> <span class="string">/data/v2</span>  <span class="string">-p</span></span><br><span class="line"><span class="string">vim</span> <span class="string">/etc/exports</span></span><br><span class="line"><span class="string">/data/v1</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">/data/v2</span> <span class="string">*(rw,no_root_squash)</span></span><br><span class="line"><span class="string">exportfs</span> <span class="string">-arv</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span><span class="string">.安装Jenkins</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">namespace</span> <span class="string">jenkins-k8s</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolume</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-k8s-pv</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">capacity:</span></span><br><span class="line">    <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  <span class="attr">nfs:</span></span><br><span class="line">    <span class="attr">server:</span> <span class="number">192.168</span><span class="number">.13</span><span class="number">.180</span></span><br><span class="line">    <span class="attr">path:</span> <span class="string">/data/v2</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">kind:</span> <span class="string">PersistentVolumeClaim</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-k8s-pvc</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">resources:</span></span><br><span class="line">    <span class="attr">requests:</span></span><br><span class="line">      <span class="attr">storage:</span> <span class="string">10Gi</span></span><br><span class="line">  <span class="attr">accessModes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">ReadWriteMany</span></span><br><span class="line">  </span><br><span class="line"><span class="string">（4）创建一个sa账号</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">sa</span> <span class="string">jenkins-k8s-sa</span> <span class="string">-n</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="string">（5）把上面的sa账号做rbac授权</span></span><br><span class="line"><span class="string">kubectl</span> <span class="string">create</span> <span class="string">clusterrolebinding</span> <span class="string">jenkins-k8s-sa-cluster</span> <span class="string">-n</span> <span class="string">jenkins-k8s</span>  <span class="string">--clusterrole=cluster-admin</span> <span class="string">--serviceaccount=jenkins-k8s:jenkins-k8s-sa</span></span><br><span class="line"></span><br><span class="line"><span class="string">docker</span> <span class="string">pull</span> <span class="string">jenkins/jenkins</span></span><br><span class="line"><span class="string">docker</span> <span class="string">load</span> <span class="string">-i</span>  <span class="string">jenkins-slave-latest.tar.gz</span></span><br><span class="line"></span><br><span class="line"><span class="string">jenkins-slave-latest.tar.gz这个里面封装的镜像是jenkins-slave-latest:v1，这个jenkins-slave-latest:v1镜像制作方法如下：</span></span><br><span class="line"><span class="string">cd</span> <span class="string">/root/slave</span></span><br><span class="line"><span class="string">cat</span> <span class="string">dockerfile</span></span><br><span class="line"><span class="string">FROM</span> <span class="string">jenkins/jnlp-slave:4.13.3-1-jdk11</span></span><br><span class="line"><span class="string">USER</span> <span class="string">root</span></span><br><span class="line"><span class="comment"># 安装Docker</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">apt-get</span> <span class="string">update</span> <span class="string">&amp;&amp;</span> <span class="string">apt-get</span> <span class="string">install</span> <span class="string">-y</span> <span class="string">\</span></span><br><span class="line">    <span class="string">docker.io</span></span><br><span class="line"><span class="comment"># 将当前用户加入docker用户组</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">usermod</span> <span class="string">-aG</span> <span class="string">docker</span> <span class="string">jenkins</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">curl</span> <span class="string">-LO</span> <span class="string">https://dl.k8s.io/release/stable.txt</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">curl</span> <span class="string">-LO</span> <span class="string">https://dl.k8s.io/release/$(cat</span> <span class="string">stable.txt)/bin/linux/amd64/kubectl</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">chmod</span> <span class="string">+x</span> <span class="string">kubectl</span></span><br><span class="line"><span class="string">RUN</span> <span class="string">mv</span> <span class="string">kubectl</span> <span class="string">/usr/local/bin/</span></span><br><span class="line"><span class="string">ENV</span> <span class="string">DOCKER_HOST</span> <span class="string">unix:///var/run/docker.sock</span></span><br><span class="line"></span><br><span class="line"><span class="string">docker</span> <span class="string">build</span> <span class="string">-t=jenkins-slave-latest:v1</span> <span class="string">.</span></span><br><span class="line"><span class="string">docker</span> <span class="string">save</span> <span class="string">-o</span> <span class="string">jenkins-slave-latest.tar.gz</span>  <span class="string">jenkins-slave-latest:v1</span></span><br><span class="line"></span><br><span class="line"><span class="string">chown</span> <span class="string">-R</span> <span class="number">1000.1000</span> <span class="string">/data/v2/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">2</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">template:</span></span><br><span class="line">    <span class="attr">metadata:</span></span><br><span class="line">      <span class="attr">labels:</span></span><br><span class="line">        <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">    <span class="attr">spec:</span></span><br><span class="line">      <span class="attr">serviceAccount:</span> <span class="string">jenkins-k8s-sa</span></span><br><span class="line">      <span class="attr">containers:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins</span></span><br><span class="line">        <span class="attr">image:</span>  <span class="string">jenkins/jenkins:2.401.1</span></span><br><span class="line">        <span class="attr">imagePullPolicy:</span> <span class="string">IfNotPresent</span></span><br><span class="line">        <span class="attr">ports:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">50000</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">          <span class="attr">protocol:</span> <span class="string">TCP</span></span><br><span class="line">        <span class="attr">resources:</span></span><br><span class="line">          <span class="attr">limits:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">1000m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">1Gi</span></span><br><span class="line">          <span class="attr">requests:</span></span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">500m</span></span><br><span class="line">            <span class="attr">memory:</span> <span class="string">512Mi</span></span><br><span class="line">        <span class="attr">livenessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">readinessProbe:</span></span><br><span class="line">          <span class="attr">httpGet:</span></span><br><span class="line">            <span class="attr">path:</span> <span class="string">/login</span></span><br><span class="line">            <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">          <span class="attr">initialDelaySeconds:</span> <span class="number">60</span></span><br><span class="line">          <span class="attr">timeoutSeconds:</span> <span class="number">5</span></span><br><span class="line">          <span class="attr">failureThreshold:</span> <span class="number">12</span></span><br><span class="line">        <span class="attr">volumeMounts:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-volume</span></span><br><span class="line">          <span class="attr">subPath:</span> <span class="string">jenkins-home</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/jenkins_home</span></span><br><span class="line">      <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jenkins-volume</span></span><br><span class="line">        <span class="attr">persistentVolumeClaim:</span></span><br><span class="line">          <span class="attr">claimName:</span> <span class="string">jenkins-k8s-pvc</span></span><br><span class="line"></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Service</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">jenkins-service</span></span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">jenkins-k8s</span></span><br><span class="line">  <span class="attr">labels:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">app:</span> <span class="string">jenkins</span></span><br><span class="line">  <span class="attr">type:</span> <span class="string">NodePort</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">8080</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">web</span></span><br><span class="line">    <span class="attr">nodePort:</span> <span class="number">30002</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">agent</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">50000</span></span><br><span class="line">    <span class="attr">targetPort:</span> <span class="string">agent</span></span><br><span class="line">    </span><br><span class="line"><span class="string">http://192.168.13.180:30002</span></span><br><span class="line"></span><br><span class="line"><span class="string">查看初始密码</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> 测试通过Jenkins部署应用发布到k8s开发环境、测试环境、生产环境</span><br><span class="line"></span><br><span class="line">开发提交代码到代码仓库gitlab-jenkins检测到代码更新-调用k8s api在k8s中创建jenkins slave pod：</span><br><span class="line">Jenkins slave pod拉取代码---通过maven把拉取的代码进行构建成war包或者jar包---&gt;上传代码到Sonarqube，进行静态代码扫描- --&gt;基于war包构建docker image--&gt;把镜像上传到harbor镜像仓库--&gt;基于镜像部署应用到开发环境--&gt;部署应用到测试环境---&gt;部署应用到生产环境。</span><br><span class="line"></span><br><span class="line">kubectl create ns devlopment</span><br><span class="line">kubectl create ns production</span><br><span class="line">kubectl create ns qatest</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">api_token</span><br><span class="line"> 11e9faa9696f6e6b8ced2d7bcf7172a1a4</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">    stage(<span class="string">&#x27;Clone&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;1.Clone Stage&quot;</span></span><br><span class="line">        git url: <span class="string">&quot;https://github.com/luckylucky421/jenkins-sample.git&quot;</span></span><br><span class="line">        script &#123;</span><br><span class="line">            build_tag = sh(returnStdout: <span class="literal">true</span>, script: <span class="string">&#x27;git rev-parse --short HEAD&#x27;</span>).trim()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Test&#x27;</span>) &#123;</span><br><span class="line">      <span class="built_in">echo</span> <span class="string">&quot;2.Test Stage&quot;</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Build&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;3.Build Docker Image Stage&quot;</span></span><br><span class="line">        sh <span class="string">&quot;docker build -t kbshire/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span> .&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Push&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;4.Push Docker Image Stage&quot;</span></span><br><span class="line">        withCredentials([usernamePassword(credentialsId: <span class="string">&#x27;3774bc6b-f509-4c57-b913-c82d4f20aeb5&#x27;</span>, passwordVariable: <span class="string">&#x27;dockerHubPassword&#x27;</span>, usernameVariable: <span class="string">&#x27;dockerHubUser&#x27;</span>)]) &#123;</span><br><span class="line">            sh <span class="string">&quot;docker login -u <span class="variable">$&#123;dockerHubUser&#125;</span> -p <span class="variable">$&#123;dockerHubPassword&#125;</span>&quot;</span></span><br><span class="line">            sh <span class="string">&quot;docker push kbshire/jenkins-demo:<span class="variable">$&#123;build_tag&#125;</span>&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    stage(<span class="string">&#x27;Deploy to dev&#x27;</span>) &#123;</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;5. Deploy DEV&quot;</span></span><br><span class="line">		sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class="line">        sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-dev.yaml&quot;</span></span><br><span class="line">//        sh <span class="string">&quot;bash running-devlopment.sh&quot;</span></span><br><span class="line">        sh <span class="string">&quot;kubectl apply -f k8s-dev.yaml  --validate=false&quot;</span></span><br><span class="line">	&#125;	</span><br><span class="line">	stage(<span class="string">&#x27;Promote to qa&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line"></span><br><span class="line">            message: <span class="string">&#x27;Promote to qa?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-qa.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-qa.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-qa.yaml --validate=false&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sleep 6&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl get pods -n qatest&quot;</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            //exit</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">	stage(<span class="string">&#x27;Promote to pro&#x27;</span>) &#123;	</span><br><span class="line">		def userInput = input(</span><br><span class="line"></span><br><span class="line">            <span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line">            message: <span class="string">&#x27;Promote to pro?&#x27;</span>,</span><br><span class="line">            parameters: [</span><br><span class="line">                [</span><br><span class="line">                    <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                    choices: <span class="string">&quot;YES\nNO&quot;</span>,</span><br><span class="line">                    name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">                ]</span><br><span class="line">            ]</span><br><span class="line">        )</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;userInput&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> (userInput == <span class="string">&quot;YES&quot;</span>) &#123;</span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BUILD_TAG&gt;/<span class="variable">$&#123;build_tag&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;sed -i &#x27;s/&lt;BRANCH_NAME&gt;/<span class="variable">$&#123;env.BRANCH_NAME&#125;</span>/&#x27; k8s-prod.yaml&quot;</span></span><br><span class="line">//            sh <span class="string">&quot;bash running-production.sh&quot;</span></span><br><span class="line">            sh <span class="string">&quot;cat k8s-prod.yaml&quot;</span></span><br><span class="line">            sh <span class="string">&quot;kubectl apply -f k8s-prod.yaml --record --validate=false&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果有403错误，修改/usr/local/bin/jenkins.sh ,主要修改地方在exec java这行，修改完之后重启docker 容器，docker restart docker_id </span></span><br><span class="line"><span class="comment">#! /bin/bash -e</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;JENKINS_WAR:=&quot;/usr/share/jenkins/jenkins.war&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;JENKINS_HOME:=&quot;/var/jenkins_home&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG:=&quot;<span class="variable">$&#123;JENKINS_HOME&#125;</span>/copy_reference_file.log&quot;&#125;</span>&quot;</span></span><br><span class="line">: <span class="string">&quot;<span class="variable">$&#123;REF:=&quot;/usr/share/jenkins/ref&quot;&#125;</span>&quot;</span></span><br><span class="line"><span class="built_in">touch</span> <span class="string">&quot;<span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>&quot;</span> || &#123; <span class="built_in">echo</span> <span class="string">&quot;Can not write to <span class="variable">$&#123;COPY_REFERENCE_FILE_LOG&#125;</span>. Wrong volume permissions?&quot;</span>; <span class="built_in">exit</span> 1; &#125;</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;--- Copying files at <span class="subst">$(date)</span>&quot;</span> &gt;&gt; <span class="string">&quot;<span class="variable">$COPY_REFERENCE_FILE_LOG</span>&quot;</span></span><br><span class="line">find <span class="string">&quot;<span class="variable">$&#123;REF&#125;</span>&quot;</span> \( -<span class="built_in">type</span> f -o -<span class="built_in">type</span> l \) -<span class="built_in">exec</span> bash -c <span class="string">&#x27;. /usr/local/bin/jenkins-support; for arg; do copy_reference_file &quot;$arg&quot;; done&#x27;</span> _ &#123;&#125; +</span><br><span class="line"><span class="comment"># if `docker run` first argument start with `--` the user is passing jenkins launcher arguments</span></span><br><span class="line"><span class="keyword">if</span> [[ <span class="variable">$#</span> -lt 1 ]] || [[ <span class="string">&quot;<span class="variable">$1</span>&quot;</span> == <span class="string">&quot;--&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">  <span class="comment"># shellcheck disable=SC2001</span></span><br><span class="line">  effective_java_opts=$(sed -e <span class="string">&#x27;s/^ $//&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$JAVA_OPTS</span> <span class="variable">$JENKINS_JAVA_OPTS</span>&quot;</span>)</span><br><span class="line">  <span class="comment"># read JAVA_OPTS and JENKINS_OPTS into arrays to avoid need for eval (and associated vulnerabilities)</span></span><br><span class="line">  java_opts_array=()</span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r -d <span class="string">&#x27;&#x27;</span> item; <span class="keyword">do</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;<span class="variable">$item</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">done</span> &lt; &lt;([[ <span class="variable">$effective_java_opts</span> ]] &amp;&amp; xargs <span class="built_in">printf</span> <span class="string">&#x27;%s\0&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$effective_java_opts</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">readonly</span> agent_port_property=<span class="string">&#x27;jenkins.model.Jenkins.slaveAgentPort&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> [ -n <span class="string">&quot;<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT:-&#125;</span>&quot;</span> ] &amp;&amp; [[ <span class="string">&quot;<span class="variable">$&#123;effective_java_opts:-&#125;</span>&quot;</span> != *<span class="string">&quot;<span class="variable">$&#123;agent_port_property&#125;</span>&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;-D<span class="variable">$&#123;agent_port_property&#125;</span>=<span class="variable">$&#123;JENKINS_SLAVE_AGENT_PORT&#125;</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="built_in">readonly</span> lifecycle_property=<span class="string">&#x27;hudson.lifecycle&#x27;</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$&#123;JAVA_OPTS:-&#125;</span>&quot;</span> != *<span class="string">&quot;<span class="variable">$&#123;lifecycle_property&#125;</span>&quot;</span>* ]]; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( <span class="string">&quot;-D<span class="variable">$&#123;lifecycle_property&#125;</span>=hudson.lifecycle.ExitLifecycle&quot;</span> )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  <span class="keyword">if</span> [[ <span class="string">&quot;<span class="variable">$DEBUG</span>&quot;</span> ]] ; <span class="keyword">then</span></span><br><span class="line">    java_opts_array+=( \</span><br><span class="line">      <span class="string">&#x27;-Xdebug&#x27;</span> \</span><br><span class="line">      <span class="string">&#x27;-Xrunjdwp:server=y,transport=dt_socket,address=*:5005,suspend=y&#x27;</span> \</span><br><span class="line">    )</span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line">  jenkins_opts_array=( )</span><br><span class="line">  <span class="keyword">while</span> IFS= <span class="built_in">read</span> -r -d <span class="string">&#x27;&#x27;</span> item; <span class="keyword">do</span></span><br><span class="line">    jenkins_opts_array+=( <span class="string">&quot;<span class="variable">$item</span>&quot;</span> )</span><br><span class="line">  <span class="keyword">done</span> &lt; &lt;([[ <span class="variable">$JENKINS_OPTS</span> ]] &amp;&amp; xargs <span class="built_in">printf</span> <span class="string">&#x27;%s\0&#x27;</span> &lt;&lt;&lt;<span class="string">&quot;<span class="variable">$JENKINS_OPTS</span>&quot;</span>)</span><br><span class="line">  <span class="built_in">exec</span> java -Duser.home=<span class="string">&quot;<span class="variable">$JENKINS_HOME</span>&quot;</span> -Dhudson.security.csrf.GlobalCrumbIssuerConfiguration.DISABLE_CSRF_PROTECTION=<span class="literal">true</span> <span class="string">&quot;<span class="variable">$&#123;java_opts_array[@]&#125;</span>&quot;</span> -jar <span class="string">&quot;<span class="variable">$&#123;JENKINS_WAR&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$&#123;jenkins_opts_array[@]&#125;</span>&quot;</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="comment"># As argument is not jenkins, assume user wants to run a different process, for example a `bash` shell to explore this image</span></span><br><span class="line"><span class="built_in">exec</span> <span class="string">&quot;<span class="variable">$@</span>&quot;</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230603155028149.png" alt="image-20230603155028149"></p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 回滚脚本</span></span><br><span class="line">node(<span class="string">&#x27;testing&#x27;</span>) &#123;</span><br><span class="line">  stage(<span class="string">&#x27;git clone&#x27;</span>) &#123;</span><br><span class="line">    git url: <span class="string">&quot;https://github.com/kbshire/jenkins-rollout.git&quot;</span></span><br><span class="line">    sh <span class="string">&quot;ls -al&quot;</span></span><br><span class="line">    sh <span class="string">&quot;pwd&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;select env&#x27;</span>) &#123;</span><br><span class="line">    def envInput = input(</span><br><span class="line">      <span class="built_in">id</span>: <span class="string">&#x27;envInput&#x27;</span>,</span><br><span class="line">      message: <span class="string">&#x27;Choose a deploy environment&#x27;</span>,</span><br><span class="line">      parameters: [</span><br><span class="line">         [</span><br><span class="line">             <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">             choices: <span class="string">&quot;devlopment\nqatest\nproduction&quot;</span>,</span><br><span class="line">             name: <span class="string">&#x27;Env&#x27;</span></span><br><span class="line">         ]</span><br><span class="line">     ]</span><br><span class="line">)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;This is a deploy step to <span class="variable">$&#123;envInput&#125;</span>&quot;</span></span><br><span class="line">sh <span class="string">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class="variable">$&#123;envInput&#125;</span>/&#x27; getVersion.sh&quot;</span></span><br><span class="line">sh <span class="string">&quot;sed -i &#x27;s/&lt;namespace&gt;/<span class="variable">$&#123;envInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class="line">sh <span class="string">&quot;bash getVersion.sh&quot;</span></span><br><span class="line">// env.WORKSPACE = <span class="built_in">pwd</span>()</span><br><span class="line">// def version = readFile <span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class="line">// println version</span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;select version&#x27;</span>) &#123;</span><br><span class="line">     env.WORKSPACE = <span class="built_in">pwd</span>()</span><br><span class="line">  def version = readFile <span class="string">&quot;<span class="variable">$&#123;env.WORKSPACE&#125;</span>/version.csv&quot;</span></span><br><span class="line">  println version</span><br><span class="line">      def userInput = input(<span class="built_in">id</span>: <span class="string">&#x27;userInput&#x27;</span>,</span><br><span class="line">                                        message: <span class="string">&#x27;选择回滚版本&#x27;</span>,</span><br><span class="line">                                        parameters: [</span><br><span class="line">            [</span><br><span class="line">                 <span class="variable">$class</span>: <span class="string">&#x27;ChoiceParameterDefinition&#x27;</span>,</span><br><span class="line">                 choices: <span class="string">&quot;<span class="variable">$version</span>\n&quot;</span>,</span><br><span class="line">                 name: <span class="string">&#x27;Version&#x27;</span></span><br><span class="line">       ]</span><br><span class="line">      ]</span><br><span class="line">)</span><br><span class="line">       sh <span class="string">&quot;sed -i &#x27;s/&lt;version&gt;/<span class="variable">$&#123;userInput&#125;</span>/&#x27; rollout.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">  stage(<span class="string">&#x27;rollout deploy&#x27;</span>) &#123;</span><br><span class="line">      sh <span class="string">&quot;bash rollout.sh&quot;</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">Jenkins Pipeline介绍</span><br><span class="line">Jenkins pipeline （流水线）是一套运行于jenkins上的工作流框架，将原本独立运行于单个或者多个节点的任务连接起来，实现单个任务难以完成的复杂流程编排与可视化。它把持续提交流水线（Continuous Delivery Pipeline）的任务集成到Jenkins中。</span><br><span class="line">pipeline 是jenkins2.X 最核心的特性， 帮助jenkins 实现从CI到CD与DevOps的转变。</span><br><span class="line"></span><br><span class="line">持续提交流水线（Continuous Delivery Pipeline）会经历一个复杂的过程： 从版本控制、向用户和客户提交软件，软件的每次变更（提交代码到仓库）到软件发布（Release）。这个过程包括以一种可靠并可重复的方式构建软件，以及通过多个测试和部署阶段来开发构建好的软件（称为Build）。</span><br><span class="line"></span><br><span class="line">总结：</span><br><span class="line">1.Jenkins Pipeline是一组插件，让Jenkins可以实现持续交付管道的落地和实施。</span><br><span class="line">2.持续交付管道(CD Pipeline)是将软件从版本控制阶段到交付给用户或客户的完</span><br><span class="line">整过程的自动化表现。</span><br><span class="line">3.软件的每一次更改（提交到源代码管理系统）都要经过一个复杂的过程才能被发布。</span><br><span class="line"></span><br><span class="line">本质上，Jenkins 是一个自动化引擎，它支持许多自动模式。 Pipeline向Jenkins中添加了一组强大的工具, 支持简单的CI到全面的CD pipeline。通过对一系列的相关任务进行建模, 用户可以利用pipeline的很多特性:</span><br><span class="line">1、代码：Pipeline以代码的形式实现，使团队能够编辑，审查和迭代其CD流程。</span><br><span class="line">    2、可持续性：Jenkins重启或者中断后都不会影响Pipeline Job。</span><br><span class="line">    3、停顿：Pipeline可以选择停止并等待人工输入或批准，然后再继续Pipeline运行。</span><br><span class="line">    4、多功能：Pipeline支持现实复杂的CD要求，包括循环和并行执行工作的能力。</span><br><span class="line">    5、可扩展：Pipeline插件支持其DSL的自定义扩展以及与其他插件集成的多个选项。</span><br><span class="line"></span><br><span class="line">DSL 是什么？</span><br><span class="line">DSL 其实是 Domain Specific Language 的缩写，中文翻译为领域特定语言（下简称 DSL）；而与 DSL相对的就是GPL，这里的GPL并不是我们知道的开源许可证，而是 General Purpose Language的简称，即通用编程语言，也就是我们非常熟悉的 Objective-C、Java、Python 以及 C 语言等等。</span><br><span class="line"></span><br><span class="line">pipeline脚本是由groovy 语言实现的</span><br><span class="line">但无需专门学习 groovy</span><br><span class="line"></span><br><span class="line">pipeline支持两种语法：</span><br><span class="line">　-Declarative：声明式</span><br><span class="line">　-Scripted pipeline ：脚本式</span><br><span class="line"></span><br><span class="line">声明式pipeline语法：</span><br><span class="line">官网：</span><br><span class="line">https://www.jenkins.io/doc/book/pipeline/syntax/</span><br><span class="line"></span><br><span class="line">声明式语法包括以下核心流程：</span><br><span class="line">1.pipeline : 声明其内容为一个声明式的pipeline脚本</span><br><span class="line">2.agent:  执行节点（job运行的slave或者master节点）</span><br><span class="line">3.stages: 阶段集合，包裹所有的阶段（例如：打包，部署等各个阶段）</span><br><span class="line">4.stage:  阶段，被stages包裹，一个stages可以有多个stage</span><br><span class="line">5.steps:  步骤,为每个阶段的最小执行单元,被stage包裹</span><br><span class="line">6.post:   执行构建后的操作，根据构建结果来执行对应的操作</span><br><span class="line"></span><br><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&quot;This is first stage&quot;</span>)&#123;</span><br><span class="line">            steps(<span class="string">&quot;This is first step&quot;</span>)&#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;1&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    post&#123;</span><br><span class="line">        always&#123;</span><br><span class="line">            <span class="built_in">echo</span> <span class="string">&quot;The process is ending&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line">environment</span><br><span class="line">environment指令指定一系列键值对，这些键值对将被定义为所有step或stage-specific step的环境变量，具体取决于environment指令在Pipeline中的位置。该指令支持一种特殊的方法credentials()，可以通过其在Jenkins环境中的标识符来访问预定义的凭据。对于类型为“Secret Text”的凭据，该 credentials()方法将确保指定的环境变量包含Secret Text内容；对于“标准用户名和密码”类型的凭证，指定的环境变量将被设置为username:password并且将自动定义两个附加的环境变量：MYVARNAME_USR和MYVARNAME_PSW。</span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    environment &#123;  </span><br><span class="line">        CC = <span class="string">&#x27;clang&#x27;</span> </span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;printenv&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">options</span><br><span class="line">options指令允许在Pipeline本身内配置Pipeline专用选项。Pipeline本身提供了许多选项，例如buildDiscarder，但它们也可能由插件提供，例如 timestamps。</span><br><span class="line"></span><br><span class="line">可用选项</span><br><span class="line">buildDiscarder：  pipeline保持构建的最大个数。用于保存Pipeline最近几次运行的数据，例如：options &#123; buildDiscarder(logRotator(numToKeepStr: <span class="string">&#x27;1&#x27;</span>)) &#125;</span><br><span class="line">　　disableConcurrentBuilds： 不允许并行执行Pipeline,可用于防止同时访问共享资源等。例如：options &#123; disableConcurrentBuilds() &#125;</span><br><span class="line">　　skipDefaultCheckout：跳过默认设置的代码check out。例如：options &#123; skipDefaultCheckout() &#125;</span><br><span class="line">　　skipStagesAfterUnstable： 一旦构建状态进入了“Unstable”状态，就跳过此stage。例如：options &#123; skipStagesAfterUnstable() &#125;</span><br><span class="line">　　<span class="built_in">timeout</span>： 设置Pipeline运行的超时时间，超过超时时间，job会自动被终止，例如：options &#123; <span class="built_in">timeout</span>(time: 1, unit: <span class="string">&#x27;HOURS&#x27;</span>) &#125;</span><br><span class="line">　　retry：  失败后，重试整个Pipeline的次数。例如：options &#123; retry(3) &#125;</span><br><span class="line">　　timestamps： 预定义由Pipeline生成的所有控制台输出时间。例如：options &#123; timestamps() &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    options &#123;</span><br><span class="line">        <span class="built_in">timeout</span>(time: 1, unit: <span class="string">&#x27;HOURS&#x27;</span>) </span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;　</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">parameters</span><br><span class="line">parameters指令提供用户在触发Pipeline时的参数列表。这些参数值通过该params对象可用于Pipeline stage中，具体用法如下：</span><br><span class="line">作用域：被最外层pipeline所包裹，并且只能出现一次，参数可被全局使用 </span><br><span class="line">好处：使用parameters好处是能够使参数也变成code,达到pipeline as code，pipeline中设置的参数会自动在job构建的时候生成，形成参数化构建</span><br><span class="line"></span><br><span class="line">可用参数</span><br><span class="line">　　string</span><br><span class="line">　　　　A parameter of a string <span class="built_in">type</span>, <span class="keyword">for</span> example: parameters &#123; string(name: <span class="string">&#x27;DEPLOY_ENV&#x27;</span>, defaultValue: <span class="string">&#x27;staging&#x27;</span>, description: <span class="string">&#x27;&#x27;</span>) &#125;</span><br><span class="line">　　booleanParam</span><br><span class="line">　　　　A boolean parameter, <span class="keyword">for</span> example: parameters &#123; booleanParam(name: <span class="string">&#x27;DEBUG_BUILD&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;&#x27;</span>) &#125;</span><br><span class="line">　　目前只支持[booleanParam, choice, credentials, file, text, password, run, string]这几种参数类型，其他高级参数化类型还需等待社区支持。</span><br><span class="line"></span><br><span class="line">pipeline&#123;</span><br><span class="line">    agent any</span><br><span class="line">    parameters &#123;</span><br><span class="line">        string(name: <span class="string">&#x27;haha&#x27;</span>, defaultValue: <span class="string">&#x27;sb&#x27;</span>, description: <span class="string">&#x27;haha&#x27;</span>)</span><br><span class="line">        booleanParam(name: <span class="string">&#x27;xixi&#x27;</span>, defaultValue: <span class="literal">true</span>, description: <span class="string">&#x27;xixi&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    stages&#123;</span><br><span class="line">        stage(<span class="string">&quot;stage1&quot;</span>)&#123;</span><br><span class="line">            steps&#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$haha</span>&quot;</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;<span class="variable">$xixi</span>&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">triggers</span><br><span class="line">triggers指令定义了Pipeline自动化触发的方式。目前有三个可用的触发器：cron和pollSCM和upstream。</span><br><span class="line">用域：被pipeline包裹，在符合条件下自动触发pipeline</span><br><span class="line"></span><br><span class="line">cron</span><br><span class="line">　　接受一个cron风格的字符串来定义Pipeline触发的时间间隔，例如： </span><br><span class="line">triggers &#123; cron(<span class="string">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class="line">pollSCM</span><br><span class="line">　　接受一个cron风格的字符串来定义Jenkins检查SCM源更改的常规间隔。如果存在新的更改，则Pipeline将被重新触发。例如：triggers &#123; pollSCM(<span class="string">&#x27;H 4/* 0 0 1-5&#x27;</span>) &#125;</span><br><span class="line">　　</span><br><span class="line">　　</span><br><span class="line">tools</span><br><span class="line"> 通过tools可自动安装工具，并放置环境变量到PATH。如果agent none，这将被忽略。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    tools &#123;</span><br><span class="line">       <span class="comment">#工具名称必须在Jenkins 管理Jenkins → 全局工具配置中预配置。</span></span><br><span class="line">        maven <span class="string">&#x27;apache-maven-3.0.1&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                sh <span class="string">&#x27;mvn --version&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">stage 的 input 指令允许你使用 input step提示输入。 在应用了 options 后，进入 stage 的 agent 或评估 when 条件前，stage 将暂停。 如果 input 被批准, stage 将会继续。 作为 input 提交的一部分的任何参数都将在环境中用于其他 stage</span><br><span class="line">配置项</span><br><span class="line">message</span><br><span class="line">必需的。 这将在用户提交 input 时呈现给用户。</span><br><span class="line"><span class="built_in">id</span></span><br><span class="line">input 的可选标识符， 默认为 stage 名称。</span><br><span class="line">ok</span><br><span class="line">`input`表单上的<span class="string">&quot;ok&quot;</span> 按钮的可选文本。</span><br><span class="line">submitter</span><br><span class="line">可选的以逗号分隔的用户列表或允许提交 input 的外部组名。默认允许任何用户。</span><br><span class="line">submitterParameter</span><br><span class="line">环境变量的可选名称。如果存在，用 submitter 名称设置。</span><br><span class="line">parameters</span><br><span class="line">提示提交者提供的一个可选的参数列表。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example&#x27;</span>) &#123;</span><br><span class="line">            input &#123;</span><br><span class="line">                message <span class="string">&quot;Should we continue?&quot;</span></span><br><span class="line">                ok <span class="string">&quot;Yes, we should.&quot;</span></span><br><span class="line">                submitter <span class="string">&quot;222&quot;</span></span><br><span class="line">                parameters &#123;</span><br><span class="line">                    string(name: <span class="string">&#x27;PERSON&#x27;</span>, defaultValue: <span class="string">&#x27;111&#x27;</span>, description: <span class="string">&#x27;Who should I say hello to?&#x27;</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;Hello, <span class="variable">$&#123;PERSON&#125;</span>, nice to meet you.&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">when</span><br><span class="line">　when指令允许Pipeline根据给定的条件确定是否执行该阶段。该when指令必须至少包含一个条件。如果when指令包含多个条件，则所有子条件必须为stage执行返回<span class="literal">true</span>。这与子条件嵌套在一个allOf条件中相同（见下面的例子）。</span><br><span class="line">更复杂的条件结构可使用嵌套条件建：not，allOf或anyOf。嵌套条件可以嵌套到任意深度。</span><br><span class="line">内置条件</span><br><span class="line">branch</span><br><span class="line">　　　　当正在构建的分支与给出的分支模式匹配时执行，例如：when &#123; branch <span class="string">&#x27;master&#x27;</span> &#125;。请注意，这仅适用于多分支Pipeline。</span><br><span class="line">　　environment</span><br><span class="line">　　　　当指定的环境变量设置为给定值时执行，例如： when &#123; environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span> &#125;</span><br><span class="line">　　expression</span><br><span class="line">　　　　当指定的Groovy表达式求值为<span class="literal">true</span>时执行，例如： when &#123; expression &#123; <span class="built_in">return</span> params.DEBUG_BUILD &#125; &#125;</span><br><span class="line">　　not</span><br><span class="line">　　　　当嵌套条件为<span class="literal">false</span>时执行。必须包含一个条件。例如：when &#123; not &#123; branch <span class="string">&#x27;master&#x27;</span> &#125; &#125;</span><br><span class="line">　　allOf</span><br><span class="line">　　　　当所有嵌套条件都为真时执行。必须至少包含一个条件。例如：when &#123; allOf &#123; branch <span class="string">&#x27;master&#x27;</span>; environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span> &#125; &#125;</span><br><span class="line">　　anyOf</span><br><span class="line">　　　　当至少一个嵌套条件为真时执行。必须至少包含一个条件。例如：when &#123; anyOf &#123; branch <span class="string">&#x27;master&#x27;</span>; branch <span class="string">&#x27;staging&#x27;</span> &#125; &#125;</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Example Build&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Hello World&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Example Deploy&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                allOf &#123;</span><br><span class="line">                    branch <span class="string">&#x27;production&#x27;</span></span><br><span class="line">                    environment name: <span class="string">&#x27;DEPLOY_TO&#x27;</span>, value: <span class="string">&#x27;production&#x27;</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;Deploying&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Parallel</span><br><span class="line">Declarative Pipeline近期新增了对并行嵌套stage的支持，对耗时长，相互不存在依赖的stage可以使用此方式提升运行效率。除了parallel stage，单个parallel里的多个step也可以使用并行的方式运行。</span><br><span class="line">pipeline &#123;</span><br><span class="line">    agent any</span><br><span class="line">    stages &#123;</span><br><span class="line">        stage(<span class="string">&#x27;Non-Parallel Stage&#x27;</span>) &#123;</span><br><span class="line">            steps &#123;</span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&#x27;This stage will be executed first.&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        stage(<span class="string">&#x27;Parallel Stage&#x27;</span>) &#123;</span><br><span class="line">            when &#123;</span><br><span class="line">                branch <span class="string">&#x27;master&#x27;</span></span><br><span class="line">            &#125;</span><br><span class="line">            parallel &#123;</span><br><span class="line">                stage(<span class="string">&#x27;Branch A&#x27;</span>) &#123;</span><br><span class="line">                    agent &#123;</span><br><span class="line">                        label <span class="string">&quot;for-branch-a&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;On Branch A&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                stage(<span class="string">&#x27;Branch B&#x27;</span>) &#123;</span><br><span class="line">                    agent &#123;</span><br><span class="line">                        label <span class="string">&quot;for-branch-b&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    steps &#123;</span><br><span class="line">                        <span class="built_in">echo</span> <span class="string">&quot;On Branch B&quot;</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2023-06-03 17:20:17" itemprop="dateModified" datetime="2023-06-03T17:20:17+08:00">2023-06-03</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/k8s%E9%AB%98%E7%BA%A7.html" title="k8s高级">http://example.com/k8s高级.html</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#k8s%E9%AB%98%E7%BA%A7"><span class="toc-number">1.</span> <span class="toc-text"> k8s 高级</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> 环境配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#prometheus"><span class="toc-number">1.2.</span> <span class="toc-text"> Prometheus</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E4%BB%B6%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 组件介绍</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A8%8B"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 工作流程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus%E5%92%8Czabbix%E5%AF%B9%E6%AF%94"><span class="toc-number">1.2.3.</span> <span class="toc-text"> Prometheus 和 Zabbix 对比</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 部署模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 数据类型</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#node-exporter"><span class="toc-number">1.2.6.</span> <span class="toc-text"> node-exporter</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2prothemeus"><span class="toc-number">1.2.7.</span> <span class="toc-text"> 部署 Prothemeus</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prothemeus%E7%83%AD%E5%8A%A0%E8%BD%BD"><span class="toc-number">1.2.8.</span> <span class="toc-text"> Prothemeus 热加载</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#grafana"><span class="toc-number">1.2.9.</span> <span class="toc-text"> Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85grafana"><span class="toc-number">1.2.10.</span> <span class="toc-text"> 安装 Grafana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kube-metric"><span class="toc-number">1.2.11.</span> <span class="toc-text"> kube-metric</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#alert-manager"><span class="toc-number">1.3.</span> <span class="toc-text"> alert manager</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%A5%E8%AD%A6%E5%88%B0qq%E9%82%AE%E7%AE%B1"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 报警到 qq 邮箱</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#promql"><span class="toc-number">1.3.2.</span> <span class="toc-text"> PromQL</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7tomcat"><span class="toc-number">1.3.3.</span> <span class="toc-text"> prometheus 监控 tomcat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7-redis"><span class="toc-number">1.3.4.</span> <span class="toc-text"> prometheus 监控 redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7mysql"><span class="toc-number">1.3.5.</span> <span class="toc-text"> prometheus 监控 mysql</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prothemeus%E7%9B%91%E6%8E%A7nginx"><span class="toc-number">1.3.6.</span> <span class="toc-text"> Prothemeus 监控 nginx</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#prometheus-%E7%9B%91%E6%8E%A7-mongodb"><span class="toc-number">1.3.7.</span> <span class="toc-text"> prometheus 监控 mongodb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#pushgateway"><span class="toc-number">1.3.8.</span> <span class="toc-text"> pushgateway</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#elk"><span class="toc-number">1.4.</span> <span class="toc-text"> ELK</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#efk%E7%BB%84%E4%BB%B6"><span class="toc-number">1.4.1.</span> <span class="toc-text"> efk 组件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85elasticsearch"><span class="toc-number">1.4.2.</span> <span class="toc-text"> 安装 elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%8B%E8%AF%95pod"><span class="toc-number">1.4.3.</span> <span class="toc-text"> 测试 pod</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#ceph"><span class="toc-number">1.5.</span> <span class="toc-text"> ceph</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E6%8C%82%E8%BD%BDceph-rbd"><span class="toc-number">1.5.1.</span> <span class="toc-text"> k8s 挂载 ceph rbd</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ceph-rbd%E7%94%9F%E6%88%90pv"><span class="toc-number">1.5.2.</span> <span class="toc-text"> ceph rbd 生成 pv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8Estorage%E5%8A%A8%E6%80%81%E7%94%9F%E6%88%90pv"><span class="toc-number">1.5.3.</span> <span class="toc-text"> 基于 storage 动态生成 pv</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#k8s%E5%AF%B9%E6%8E%A5cephfs"><span class="toc-number">1.5.4.</span> <span class="toc-text"> k8s 对接 cephfs</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#devops"><span class="toc-number">1.6.</span> <span class="toc-text"> devops</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">68</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">4</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">4</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/12/27/SSTI/" title="SSTI">SSTI</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/03/yuque/iptables2/" title="iptables">iptables</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/08/16/yuque/%E5%8F%91%E7%8E%B0%E5%B0%8F%E5%8F%AF%E7%88%B1%EF%BC%81/" title="about me">about me</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/05/yuque/Docker/" title="docker">docker</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2022/12/28/mysql/" title="Mysql">Mysql</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/11/reverse/" title="逆向">逆向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/07/TCPIP_new/" title="TCP&#x2F;IP">TCP/IP</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/03/27/yuque/http/" title="http">http</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/05/27/yuque/emergency%20response/" title="应急响应">应急响应</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/15/yuque/Nginx/" title="Nginx">Nginx</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: 'k8s高级',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
