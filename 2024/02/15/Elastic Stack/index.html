



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="运维" />


<link rel="canonical" href="http://example.com/2024/02/15/Elastic%20Stack/">



  <title>
Elastic stack - 运维 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Elastic stack
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-02-15 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-02-15T13:38:45+08:00">2024-02-15</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/0e7c33417077333d006139c148caf559.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/6a834199cae04e75c335d444704c2060.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/2a42af8906eaa0a898ee31569cbd2661.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/f93f124fd90670f86b81841581c3698c.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/9d41e0144387641f894a827002ea5c33.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/5ec5e6a577b47f3d9b70654073f8b881.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="In 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2024/02/15/Elastic%20Stack/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="elastic-stack"><a class="markdownIt-Anchor" href="#elastic-stack">#</a> Elastic Stack</h1>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207173153219.png" alt="image-20240207173153219" style="zoom:50%;" /> 
<p>The Elastic stack, 包括 Elasticsearch、Kibana、Beats 和 Logstash (也称为 ELK Stack)。<br>
Elaticsearch:<br>
 简称为 ES， ES 是一个开源的高扩展的分布式全文搜索引擎，是整个 E1astic stack 技术栈的核心。它可以近乎实时的存储、检索数据；本身扩展性很好，可以扩展到上百台服务器，处理 PB 级别的数据<br>
 Kibana:<br>
 是一个免费且开放的用户界面，能够让您对 Elasticsearch 数据进行可视化，并让您在 elastic stack 中进行导航。<br>
您可以进行各种操作，从跟踪查询负载，到理解请求如何流经您的整个应用，都能轻松完成。<br>
Beats:<br>
 是一个免费且开放的平台，集合了多种单一用途数据采集器。它们从成百上千或成千上万台机器和系统向 Logstash 或 Elasticsearch 发送数据<br>
 Logstash:<br>
 是免费且开放的服务器端数据处理管道，能够从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的 “存储库 &quot; 中。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207173840701.png" alt="image-20240207173840701"></p>
<p>数据流走向：源数据层 (nginx，tomcat)—&gt; 数据采集层 (filebeat)—&gt; 数据存储层 (Elasticsearch)</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207174025791.png" alt="image-20240207174025791"></p>
<p>数据流走向：源数据层 (nginx，tomcat)—&gt; 数据采集 / 转换层 (Logstash)—&gt; 数据存储层 (Elasticsearch)。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207174116591.png" alt="image-20240207174116591"></p>
<p>数据流走向：源数据层 (nginx,tomcat)—&gt; 数据采集 (filebeat)–&gt; 转换层 (Logstash)—&gt; 数据存储层 (ElasticSearch)。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207174356843.png" alt="image-20240207174356843"></p>
<p>数据流走向：源数据层 (nginx，tomcat)—&gt; 数据采集 (filebeat)—&gt; 数据缓存层 (kafka)—&gt; 转换层 (Logstash)—&gt; 数 据存储层 (ElasticSearch)。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207174651850.png" alt="image-20240207174651850"></p>
<h2 id="elasticsearch-和-solr的选择"><a class="markdownIt-Anchor" href="#elasticsearch-和-solr的选择">#</a> ElasticSearch 和 solr 的选择</h2>
<p>Lucene 的优缺点:</p>
<p>优点:</p>
<p>可以被认为是迄今为止最先进，性能最好的，功能最全的搜索引整库 (框架)。</p>
<p>缺点:</p>
<p>(1) 只能在 Java 项目中使用，并且要以 jar 包的方式直接集成在项目中；<br>
(2) 使用很复杂，你需要深入了解检索的相关知识来创建索引和搜索索引代码；<br>
(3) 不支持集群环境，索引数据不同步 (不支持大型项目);<br>
(4) 扩展性差，索引库和应用所在同一个服务器，当索引数据过大时，效率逐渐降低；<br>
 值得注意的是，上述的 Lucene 框架中的缺点，Elasticsearch 全部都能解决。</p>
<p>Elasticsearch 是一个实时的分布式搜索和分析引擎。它可以帮助你用前所未有的速度去处理大规模数据<br>
 ES 可以用于全文搜索，结构化搜索以及分析，当然你也可以将这三者进行组合，</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuZWxhc3RpYy5jby9jbi9jdXN0b21lcnMvc3VjY2Vzcy1zdG9yaWVz">https://www.elastic.co/cn/customers/success-stories</span></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240207195559794.png" alt="image-20240207195559794"></p>
<p>Solr 是 Apache ucene 项目的开源企业搜索平台。其主要功能包括全文检索、命中标示、分面搜索、动态聚类、数据库集成，以及富文本 (如 Word、PDF) 的处理。<br>
So1r 是高度可扩展的，并提供了分布式搜索和索引复制。So1r 是最流行的企业级搜索引擎，Solr4 还增加了 NoSQL 支持。<br>
Elasticsearch (下面简称 &quot;ES&quot;) 与 Solr 的比较:<br>
(1) So1r 利用 2ookeeper 进行分布式管理，而 ES 自身带有分布式协调管理功能；(2) Solr 支持更多格式 (JSON、XML、CSV) 的数据，而 ES 仅支持 JSON 文件格式；(3) Solr 官方提供的功能更多，而 ES 本身更注重于核心功能，高级功能多有第三方插件提供；(4) So1r 在 &quot; 传统搜索”(已有数据) 中表现好于 ES，但在处理 “实时搜索”(实时建立索引) 应用时效率明显低于 ES (5) Solr 是传统搜索应用的有力解决方案，但 Elasticsearch 更适用于新兴的实时搜索应用。</p>
<h2 id="部署"><a class="markdownIt-Anchor" href="#部署">#</a> 部署</h2>
<h3 id="单点部署es"><a class="markdownIt-Anchor" href="#单点部署es">#</a> 单点部署 es</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line">hostnamectl set-hostname elk101</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/hosts &lt;&lt; &quot;EOF&quot;</span><br><span class="line">&gt; 192.168.13.101 elk101</span><br><span class="line">&gt; 192.168.13.102 elk102</span><br><span class="line">&gt; 192.168.13.103 elk103</span><br><span class="line">&gt; EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;&gt; ~/.bashrc </span><br><span class="line">PS1=&quot;\[\e[37;40m\][\[\e[32;40m\]\u\[\e[37;40m\]@\h \[\e[36;40m\]\w\[\e[0m\]]\\$ &quot;</span><br><span class="line">EOF</span><br><span class="line">source ~/.bashrc </span><br><span class="line"></span><br><span class="line">vim /etc/ssh/sshd_config </span><br><span class="line">GSSAPIAuthentication no</span><br><span class="line">UseDNS no</span><br><span class="line"></span><br><span class="line">sed -ri &#x27;s#^GSSAPIAuthentication yes#GSSAPIAuthentication no#g&#x27; /etc/ssh/sshd_config</span><br><span class="line">sed -ri &#x27;s@^#UseDNS yes@UseDNS no@g&#x27; /etc/ssh/sshd_config</span><br><span class="line">grep ^UseDNS /etc/ssh/sshd_config</span><br><span class="line">grep ^GSSAPIAuthentication /etc/ssh/sshd_config</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl disable firewalld --now </span><br><span class="line">systemctl is-enabled firewalld </span><br><span class="line"></span><br><span class="line">getenforce </span><br><span class="line">setenforce 0 </span><br><span class="line">sed -ri &#x27;s#(SELINUX=)enforcing#1disabled#&#x27; /etc/selinux/config </span><br><span class="line"></span><br><span class="line">ssh-keygen -t rsa -P &#x27;&#x27; -f ~/.ssh/id_rsa -q</span><br><span class="line">ssh-copy-id 192.168.13.102</span><br><span class="line">ssh-copy-id 192.168.13.103</span><br><span class="line">ssh-copy-id 192.168.13.101</span><br><span class="line"></span><br><span class="line">yum install rsync -y </span><br><span class="line"></span><br><span class="line">// 仅在101上</span><br><span class="line">vim /usr/local/sbin/data_rsync.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">if [ $# -ne 1 ];then</span><br><span class="line">    echo &quot;Usage: $0 /path/to/file&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">if [ ! -e $1 ];then</span><br><span class="line">    echo &quot;[ $1 ] dir or file not find&quot;</span><br><span class="line">    exit</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line">fullpath=`dirname $1`</span><br><span class="line"></span><br><span class="line">basename=`basename $1`</span><br><span class="line"></span><br><span class="line">cd $fullpath</span><br><span class="line"></span><br><span class="line">for ((host_id=102;host_id&lt;=103;host_id++))</span><br><span class="line">    do</span><br><span class="line">        tput setaf 2</span><br><span class="line">        echo ===== rsyncing elk$&#123;host_id&#125;: $basename =====</span><br><span class="line">        tput setaf 7</span><br><span class="line">        rsync -az $basename `whoami`@elk$&#123;host_id&#125;:$fullpath</span><br><span class="line">        if [ $? -eq 0 ];then</span><br><span class="line">            echo &quot;命令执行成功&quot;</span><br><span class="line">        fi</span><br><span class="line"> done</span><br><span class="line"> chmod +x /usr/local/sbin/data_rsync.sh</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">[root@elk101 /tmp]$ data_rsync.sh /tmp/</span><br><span class="line">===== rsyncing elk102: tmp =====</span><br><span class="line">The authenticity of host &#x27;elk102 (192.168.13.102)&#x27; can&#x27;t be established.</span><br><span class="line">ECDSA key fingerprint is SHA256:Amhw1/IzdvDQ+eSUVh6rwPbGbuOoSsni4RkaYT5RYNA.</span><br><span class="line">ECDSA key fingerprint is MD5:00:b8:a1:41:cd:66:89:02:11:af:c7:64:fe:5d:25:b2.</span><br><span class="line">Are you sure you want to continue connecting (yes/no)? yes</span><br><span class="line">Warning: Permanently added &#x27;elk102&#x27; (ECDSA) to the list of known hosts.</span><br><span class="line">命令执行成功</span><br><span class="line">===== rsyncing elk103: tmp =====</span><br><span class="line">命令执行成功</span><br><span class="line"></span><br><span class="line">yum install vim net-tools.x86_64 ntpdate chrony.x86_64 -y</span><br><span class="line"></span><br><span class="line">vim /etc/chrony.conf </span><br><span class="line">server ntp.aliyun.com iburst</span><br><span class="line">server ntp1.aliyun.com iburst</span><br><span class="line"></span><br><span class="line">systemctl restart chronyd.service </span><br><span class="line"></span><br><span class="line">systemctl enable chronyd --now </span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------</span><br><span class="line">// 开始安装es</span><br><span class="line"></span><br><span class="line">yum install wget -y</span><br><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-linux-x86_64.tar.gz</span><br><span class="line">wget &quot;https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-x86_64.rpm&quot;</span><br><span class="line">yum install -y elasticsearch-7.17.3-x86_64.rpm</span><br><span class="line">systemctl start elasticsearch.service</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 /usr/share/elasticsearch/jdk/bin]$ netstat -lntup </span><br><span class="line">Active Internet connections (only servers)</span><br><span class="line">Proto Recv-Q Send-Q Local Address           Foreign Address         State       PID/Program name          </span><br><span class="line">tcp6       0      0 127.0.0.1:9200          :::*                    LISTEN      11745/java          </span><br><span class="line">tcp6       0      0 ::1:9200                :::*                    LISTEN      11745/java          </span><br><span class="line">tcp6       0      0 127.0.0.1:9300          :::*                    LISTEN      11745/java          </span><br><span class="line">tcp6       0      0 ::1:9300                :::*                    LISTEN      11745/java          </span><br><span class="line"></span><br><span class="line">9200 对集群外部提供服务，使用http协议</span><br><span class="line">9300 集群内通信，使用tcp协议</span><br><span class="line"></span><br><span class="line">[root@elk101 ~]$ curl http://127.0.0.1:9200</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;elk101&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elasticsearch&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;qW8JEryoSeqktwv8L4VOGA&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.17.3&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;rpm&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;5ad023604c8d7416c9eb6c0eadb62b14e766caff&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2022-04-19T08:11:19.070913226Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.11.1&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">cluster.name: elk</span><br><span class="line">node.name: elk101</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;elk101&quot;]</span><br><span class="line"></span><br><span class="line">ll /var/log/elasticsearch</span><br><span class="line">-rw-r--r-- 1 elasticsearch elasticsearch     0 Feb  8 01:32 elk_index_indexing_slowlog.json</span><br><span class="line">-rw-r--r-- 1 elasticsearch elasticsearch     0 Feb  8 01:32 elk_index_indexing_slowlog.log</span><br><span class="line">-rw-r--r-- 1 elasticsearch elasticsearch     0 Feb  8 01:32 elk_index_search_slowlog.json</span><br><span class="line">-rw-r--r-- 1 elasticsearch elasticsearch     0 Feb  8 01:32 elk_index_search_slowlog.log</span><br><span class="line">-rw-r--r-- 1 elasticsearch elasticsearch 23194 Feb  8 01:32 elk.log</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 /var/log/elasticsearch]$ curl http://elk101:9200 </span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot; : &quot;elk101&quot;,</span><br><span class="line">  &quot;cluster_name&quot; : &quot;elk&quot;,</span><br><span class="line">  &quot;cluster_uuid&quot; : &quot;qW8JEryoSeqktwv8L4VOGA&quot;,</span><br><span class="line">  &quot;version&quot; : &#123;</span><br><span class="line">    &quot;number&quot; : &quot;7.17.3&quot;,</span><br><span class="line">    &quot;build_flavor&quot; : &quot;default&quot;,</span><br><span class="line">    &quot;build_type&quot; : &quot;rpm&quot;,</span><br><span class="line">    &quot;build_hash&quot; : &quot;5ad023604c8d7416c9eb6c0eadb62b14e766caff&quot;,</span><br><span class="line">    &quot;build_date&quot; : &quot;2022-04-19T08:11:19.070913226Z&quot;,</span><br><span class="line">    &quot;build_snapshot&quot; : false,</span><br><span class="line">    &quot;lucene_version&quot; : &quot;8.11.1&quot;,</span><br><span class="line">    &quot;minimum_wire_compatibility_version&quot; : &quot;6.8.0&quot;,</span><br><span class="line">    &quot;minimum_index_compatibility_version&quot; : &quot;6.0.0-beta1&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;tagline&quot; : &quot;You Know, for Search&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="集群部署es"><a class="markdownIt-Anchor" href="#集群部署es">#</a> 集群部署 es</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum install elasticsearch-7.17.3-x86_64.rpm -y</span><br><span class="line">vim /etc/elasticsearch/elasticsearch.yml</span><br><span class="line">discovery.seed_hosts: [&quot;elk101&quot;,&quot;elk102&quot;,&quot;elk103&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;elk101&quot;,&quot;elk102&quot;,&quot;elk103&quot;]</span><br><span class="line"></span><br><span class="line">// 删除临时数据</span><br><span class="line">rm -rf /var/&#123;lib,log&#125;/elasticsearch/*</span><br><span class="line"></span><br><span class="line">data_rsync.sh /etc/elasticsearch/elasticsearch.yml</span><br><span class="line"></span><br><span class="line">systemctl restart elasticsearch </span><br><span class="line"></span><br><span class="line">[root@elk102 ~]# curl http://192.168.13.103:9200/_cat/nodes</span><br><span class="line">192.168.13.102 7 97 1 0.01 0.04 0.05 cdfhilmrstw - elk102</span><br><span class="line">192.168.13.103 6 97 2 0.02 0.08 0.07 cdfhilmrstw - elk103</span><br><span class="line">192.168.13.101 9 96 3 0.20 0.18 0.09 cdfhilmrstw * elk101</span><br></pre></td></tr></table></figure>
<h3 id="安装kibana"><a class="markdownIt-Anchor" href="#安装kibana">#</a> 安装 kibana</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-x86_64.rpm&quot;</span><br><span class="line">wget https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-linux-x86_64.tar.gz</span><br><span class="line">yum install kibana-7.17.3-x86_64.rpm -y</span><br><span class="line"></span><br><span class="line">vim /etc/kibana/kibana.yml </span><br><span class="line">server.host: &quot;elk101&quot;</span><br><span class="line">server.name: &quot;elk&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240210151604168.png" alt="image-20240210151604168"></p>
<h3 id="安装filebeat"><a class="markdownIt-Anchor" href="#安装filebeat">#</a> 安装 filebeat</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-x86_64.rpm&quot;</span><br><span class="line">wget &quot;https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-linux-x86_64.tar.gz&quot;</span><br><span class="line">yum install filebeat-7.17.3-x86_64.rpm -y</span><br><span class="line"></span><br><span class="line">vim  /etc/filebeat/filebeat.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: stdin</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">  </span><br><span class="line">filebeat -e -c /etc/filebeat/filebeat.yml</span><br><span class="line">9999999999999999999999999999</span><br><span class="line">&#123;</span><br><span class="line">  &quot;@timestamp&quot;: &quot;2024-02-10T10:01:37.689Z&quot;,</span><br><span class="line">  &quot;@metadata&quot;: &#123;</span><br><span class="line">    &quot;beat&quot;: &quot;filebeat&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;_doc&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;7.17.3&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;host&quot;: &#123;</span><br><span class="line">    &quot;name&quot;: &quot;elk101&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;agent&quot;: &#123;</span><br><span class="line">    &quot;ephemeral_id&quot;: &quot;b92fbd99-5787-454b-a33b-8b3dc5a1bd88&quot;,</span><br><span class="line">    &quot;id&quot;: &quot;370ef800-c964-4c80-bef5-5f4b5756bdb2&quot;,</span><br><span class="line">    &quot;name&quot;: &quot;elk101&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;filebeat&quot;,</span><br><span class="line">    &quot;version&quot;: &quot;7.17.3&quot;,</span><br><span class="line">    &quot;hostname&quot;: &quot;elk101&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;log&quot;: &#123;</span><br><span class="line">    &quot;offset&quot;: 0,</span><br><span class="line">    &quot;file&quot;: &#123;</span><br><span class="line">      &quot;path&quot;: &quot;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;message&quot;: &quot;9999999999999999999999999999&quot;,</span><br><span class="line">  &quot;input&quot;: &#123;</span><br><span class="line">    &quot;type&quot;: &quot;stdin&quot;</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;ecs&quot;: &#123;</span><br><span class="line">    &quot;version&quot;: &quot;1.12.0&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240210175557765.png" alt="image-20240210175557765"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~]$ ll /var/lib/filebeat/registry/filebeat/</span><br><span class="line">total 8</span><br><span class="line">-rw------- 1 root root 902 Feb 10 20:20 log.json 					记录了读取的时间戳与读取位置偏移，修改offset实现自定义读取位置</span><br><span class="line">-rw------- 1 root root  15 Feb 10 17:33 meta.json</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 通过日志文件读取input数据</span><br><span class="line">vim  /etc/filebeat/filebeat-log.yml</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">  </span><br><span class="line">删除了/var/lib/filebeat/*后，offset丢失，重新从文件开始读取</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;shabi&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*</span><br><span class="line">    - /tmp/1.json</span><br><span class="line">  fields:							// 输出的字段增加fields字段，fields中是kv形式</span><br><span class="line">    haha: &quot;xixixi&quot;</span><br><span class="line"></span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;haha&quot;]					// 在输出的字段中增加tag字段</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /data/safeline/*</span><br><span class="line">  fields_under_root: true								// 不在被fields字段包裹，直接自己变成一个kv</span><br><span class="line">output.elasticsearch:</span><br><span class="line">  host: [&quot;http://elk101:9200&quot;]</span><br></pre></td></tr></table></figure>
<p>filebeat 对接 es</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;shabi&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*</span><br><span class="line">    - /tmp/1.json</span><br><span class="line">  fields:                                                       </span><br><span class="line">    haha: &quot;xixixi&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  #index: &quot;%&#123;[fields.log_type]&#125;-%&#123;[agent.version]&#125;-%&#123;+yyy.MM.dd&#125;&quot;   // 默认索引名称filebeat-7.17.3-2024-02-12。不配置索引生命周期的时候才会生效</span><br><span class="line">  index: &quot;hahaha-xixi-%&#123;+yyy.MM.dd&#125;&quot;</span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi&quot;</span><br><span class="line">setup.ilm.enabled: false				// 禁用索引生命周期管理</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211205042678.png" alt="image-20240211205042678"></p>
<p>创建索引</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211205405692.png" alt="image-20240211205405692"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211205523452.png" alt="image-20240211205523452"></p>
<p>筛选字段</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211205716000.png" alt="image-20240211205716000"></p>
<p>新建索引模板</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211213108434.png" alt="image-20240211213108434"></p>
<p>filebeat-indices</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;shabi&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/*</span><br><span class="line">  fields:                                                       </span><br><span class="line">    haha: &quot;xixixi&quot;</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;zhizhang&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /tmp/*</span><br><span class="line">  fields:                                                       </span><br><span class="line">    haha: &quot;lululu&quot;</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">  - index: &quot;hahaha-xixi-uuu-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    when.contains:</span><br><span class="line">      tags: &quot;shabi&quot;</span><br><span class="line">  - index: &quot;hahaha-xixi-ppp-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    when.contains:</span><br><span class="line">      tags: &quot;zhizhang&quot;</span><br><span class="line">      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false		</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240211214505454.png" alt="image-20240211214505454"></p>
<p>egrep -v “<sup>#|</sup>$” /etc/kibana/kibana.yml</p>
<p>分片：一个分片只能在一个节点。分片里面存放的是文档。多分片适用于集群情况</p>
<p>每个文档通过 id 标识</p>
<p>路由计算：hash (文档 id) % 主分片数 = 分片编号</p>
<p>分片数量设置后不可以修改。副本数量可以修改</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240212192642807.png" alt="image-20240212192642807"></p>
<p>机架感知：防止一个机柜故障导致副本无法访问</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240212193118761.png" alt="image-20240212193118761" style="zoom:50%;" /> 
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">filebeat.inputs:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;shabi&quot;</span>]</span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/var/log/*</span></span><br><span class="line">  <span class="attr">fields:</span>                                                       </span><br><span class="line">    <span class="attr">haha:</span> <span class="string">&quot;xixixi&quot;</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">type:</span> <span class="string">log</span></span><br><span class="line">  <span class="attr">tags:</span> [<span class="string">&quot;zhizhang&quot;</span>]</span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">paths:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">/tmp/*</span></span><br><span class="line">  <span class="attr">fields:</span>                                                       </span><br><span class="line">    <span class="attr">haha:</span> <span class="string">&quot;lululu&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="attr">output.elasticsearch:</span></span><br><span class="line">  <span class="attr">hosts:</span> [<span class="string">&quot;http://elk101:9200&quot;</span>, <span class="string">&quot;http://elk102:9200&quot;</span>, <span class="string">&quot;http://elk103:9200&quot;</span>]</span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">indices:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;hahaha-xixi-uuu-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when.contains:</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">&quot;shabi&quot;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">index:</span> <span class="string">&quot;hahaha-xixi-ppp-<span class="template-variable">%&#123;+yyyy.MM.dd&#125;</span>&quot;</span></span><br><span class="line">    <span class="attr">when.contains:</span></span><br><span class="line">      <span class="attr">tags:</span> <span class="string">&quot;zhizhang&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置索引模板的名称      </span></span><br><span class="line"><span class="attr">setup.template.name:</span> <span class="string">&quot;hahaha&quot;</span></span><br><span class="line"><span class="comment"># 设置索引模板的匹配模式</span></span><br><span class="line"><span class="attr">setup.template.pattern:</span> <span class="string">&quot;hahaha-xixi*&quot;</span></span><br><span class="line"><span class="comment"># 禁用索引生命周期管理</span></span><br><span class="line"><span class="attr">setup.ilm.enabled:</span> <span class="literal">false</span>        </span><br><span class="line"><span class="comment"># 覆盖已有的索引模板</span></span><br><span class="line"><span class="attr">setup.template.overwrite:</span> <span class="literal">false</span></span><br><span class="line"><span class="attr">setup.template.settings:</span></span><br><span class="line">  <span class="attr">index.number_of_shards:</span> <span class="number">3</span>				<span class="comment"># 分片</span></span><br><span class="line">  <span class="attr">index.number_of_replicas:</span> <span class="number">0</span>			<span class="comment"># 副本，副本数量一定要小于集群中主机数量</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240212194140225.png" alt="image-20240212194140225"></p>
<p>集群有红黄绿三种颜色</p>
<p>红色：集群的主分片未正常工作</p>
<p>黄色：集群的部分副本分片未正常使用</p>
<p>绿色：集群的主分片和副本分片可以访问</p>
<p>主分片和副本分片的区别</p>
<p>主分片可以读写</p>
<p>副本分片只读</p>
<p>推荐 10 分片 2 副本</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240212201413703.png" alt="image-20240212201413703"></p>
<p>索引模式用于在 kibana.discover 中展示数据</p>
<p>索引模板：用于按照模板创建一系列索引。删除索引模板不会删除索引</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240212204717096.png" alt="image-20240212204717096"></p>
<p>filebeat 收集 nginx 日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">yum install nginx -y </span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-nginx-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br></pre></td></tr></table></figure>
<h3 id="通过日志筛选某个字段"><a class="markdownIt-Anchor" href="#通过日志筛选某个字段">#</a> 通过日志筛选某个字段</h3>
<p>1.accesslog 直接变为 json 格式</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">    log_format log_json &#x27;&#123; &quot;@timestamp&quot;: &quot;$time_local&quot;, &#x27;</span><br><span class="line">                        &#x27;&quot;remote_addr&quot;: &quot;$remote_addr&quot;, &#x27;</span><br><span class="line">                        &#x27;&quot;referer&quot;: &quot;$http_referer&quot;, &#x27;</span><br><span class="line">                        &#x27;&quot;request&quot;: &quot;$request&quot;, &#x27;</span><br><span class="line">                        &#x27;&quot;status&quot;: $status, &#x27;</span><br><span class="line">                        &#x27;&quot;bytes&quot;: $body_bytes_sent, &#x27;</span><br><span class="line">                        &#x27;&quot;agent&quot;: &quot;$http_user_agent&quot;, &#x27;</span><br><span class="line">                        &#x27;&quot;x_forwarded&quot;: &quot;$http_x_forwarded_for&quot;, &#x27;</span><br><span class="line">                       # &#x27;&quot;up_addr&quot;: &quot;$upstream_addr&quot;,&#x27;</span><br><span class="line">                       # &#x27;&quot;up_host&quot;: &quot;$upstream_http_host&quot;,&#x27;</span><br><span class="line">                       # &#x27;&quot;up_resp_time&quot;: &quot;$upstream_response_time&quot;,&#x27;</span><br><span class="line">                        &#x27;&quot;request_time&quot;: &quot;$request_time&quot;&#x27;</span><br><span class="line">                        &#x27; &#125;&#x27;;</span><br><span class="line">    access_log  /var/log/nginx/access.log  log_json;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">&#123; &quot;@timestamp&quot;: &quot;13/Feb/2024:15:23:23 +0800&quot;, &quot;remote_addr&quot;: &quot;192.168.13.1&quot;, &quot;referer&quot;: &quot;-&quot;, &quot;request&quot;: &quot;GET / HTTP/1.1&quot;, &quot;status&quot;: 304, &quot;bytes&quot;: 0, &quot;agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0&quot;, &quot;x_forwarded&quot;: &quot;-&quot;, &quot;request_time&quot;: &quot;0.000&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240213153307334.png" alt="image-20240213153307334"></p>
<p>2. 借助 module 处理 (filebeat)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line">[root@elk101 ~/es-filebeat]$ filebeat -e -c /root/es-filebeat/nginx-module.yaml modules list </span><br><span class="line">2024-02-13T15:58:56.904+0800    INFO    instance/beat.go:685    Home path: [/usr/share/filebeat] Config path: [/etc/filebeat] Data path: [/var/lib/filebeat] Logs path: [/var/log/filebeat] Hostfs Path: [/]</span><br><span class="line">2024-02-13T15:58:56.904+0800    INFO    instance/beat.go:693    Beat ID: 86cb8587-cdc1-47a0-8ed8-82b95547ea30</span><br><span class="line">Enabled:</span><br><span class="line"></span><br><span class="line">Disabled:</span><br><span class="line">activemq</span><br><span class="line">apache</span><br><span class="line">auditd</span><br><span class="line">aws</span><br><span class="line">awsfargate</span><br><span class="line">azure</span><br><span class="line">barracuda</span><br><span class="line">bluecoat</span><br><span class="line">cef</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 ~/es-filebeat]$ filebeat -e -c /root/es-filebeat/nginx-module.yaml modules enable nginx tomcat </span><br><span class="line">2024-02-13T16:04:33.044+0800    INFO    instance/beat.go:685    Home path: [/usr/share/filebeat] Config path: [/etc/filebeat] Data path: [/var/lib/filebeat] Logs path: [/var/log/filebeat] Hostfs Path: [/]</span><br><span class="line">2024-02-13T16:04:33.044+0800    INFO    instance/beat.go:693    Beat ID: 86cb8587-cdc1-47a0-8ed8-82b95547ea30</span><br><span class="line">Enabled nginx</span><br><span class="line">Enabled tomcat</span><br><span class="line"></span><br><span class="line">启用和禁用只取决于后缀是否是.yml 或者后面是disable</span><br><span class="line"></span><br><span class="line">[root@elk101 ~/es-filebeat]$ cat /etc/filebeat/modules.d/nginx.yml </span><br><span class="line"># Module: nginx</span><br><span class="line"># Docs: https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-module-nginx.html</span><br><span class="line"></span><br><span class="line">- module: nginx</span><br><span class="line">  # Access logs</span><br><span class="line">  access:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br><span class="line">    # Set custom paths for the log files. If left empty,</span><br><span class="line">    # Filebeat will choose the paths depending on your OS.</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/access.log*&quot;]</span><br><span class="line"></span><br><span class="line">  # Error logs</span><br><span class="line">  error:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br><span class="line">    # Set custom paths for the log files. If left empty,</span><br><span class="line">    # Filebeat will choose the paths depending on your OS.</span><br><span class="line">    var.paths: [&quot;/var/log/nginx/error.log*&quot;]</span><br><span class="line"></span><br><span class="line">  # Ingress-nginx controller logs. This is disabled by default. It could be used in Kubernetes environments to parse ingress-nginx logs</span><br><span class="line">  ingress_controller:</span><br><span class="line">    enabled: false</span><br><span class="line"></span><br><span class="line">    # Set custom paths for the log files. If left empty,</span><br><span class="line">    # Filebeat will choose the paths depending on your OS.</span><br><span class="line">    #var.paths:</span><br><span class="line">    </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240213162820195.png" alt="image-20240213162820195"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240213164251436.png" alt="image-20240213164251436"></p>
<p>3. 引入 logstash</p>
<h3 id="收集tomcat日志"><a class="markdownIt-Anchor" href="#收集tomcat日志">#</a> 收集 tomcat 日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"> filebeat -e -c /root/es-filebeat/nginx-module.yaml modules enable tomcat </span><br><span class="line"> </span><br><span class="line"> vim tomcat-module.yaml</span><br><span class="line"> filebeat.config.modules:</span><br><span class="line">  path: $&#123;path.config&#125;/modules.d/*.yml</span><br><span class="line">  reload.enabled: false</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-tomcat-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  vim /etc/filebeat/modules.d/tomcat.yml</span><br><span class="line"># Module: tomcat</span><br><span class="line"># Docs: https://www.elastic.co/guide/en/beats/filebeat/7.17/filebeat-module-tomcat.html</span><br><span class="line"></span><br><span class="line">- module: tomcat</span><br><span class="line">  log:</span><br><span class="line">    enabled: true</span><br><span class="line"></span><br><span class="line">    # Set which input to use between udp (default), tcp or file.</span><br><span class="line">    var.input: file</span><br><span class="line">    # var.syslog_host: localhost</span><br><span class="line">    # var.syslog_port: 9501</span><br><span class="line"></span><br><span class="line">    # Set paths for the log files when file input is used.</span><br><span class="line">    var.paths:</span><br><span class="line">      - /usr/local/tomcat/logs/*.txt</span><br><span class="line"></span><br><span class="line">    # Toggle output of non-ECS fields (default true).</span><br><span class="line">    # var.rsa_fields: true</span><br><span class="line"></span><br><span class="line">    # Set custom timezone offset.</span><br><span class="line">    # &quot;local&quot; (default) for system timezone.</span><br><span class="line">    # &quot;+02:00&quot; for GMT+02:00</span><br><span class="line">    # var.tz_offset: local</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">var.input 有tcp udp file 三种形式</span><br><span class="line">前两种对接syslog</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
 <img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240214150406383.png" alt="image-20240214150406383" style="zoom:50%;" />
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/tomcat/logs/tomcat.haha.com_access_log.2024-02-14.txt</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-tomcat-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">vim /usr/local/tomcat/conf/server.xml</span><br><span class="line">161       &lt;Host name=&quot;tomcat.haha.com&quot;  appBase=&quot;webapps&quot;</span><br><span class="line">162             unpackWARs=&quot;true&quot; autoDeploy=&quot;true&quot;&gt;</span><br><span class="line">163 </span><br><span class="line">164         &lt;!-- SingleSignOn valve, share authentication between web applications</span><br><span class="line">165              Documentation at: /docs/config/valve.html --&gt;</span><br><span class="line">166         &lt;!--</span><br><span class="line">167         &lt;Valve className=&quot;org.apache.catalina.authenticator.SingleSignOn&quot; /&gt;</span><br><span class="line">168         --&gt;</span><br><span class="line">169 </span><br><span class="line">170         &lt;!-- Access log processes all example.</span><br><span class="line">171              Documentation at: /docs/config/valve.html</span><br><span class="line">172              Note: The pattern used is equivalent to using pattern=&quot;common&quot; --&gt;</span><br><span class="line">173         &lt;Valve className=&quot;org.apache.catalina.valves.AccessLogValve&quot; directory=&quot;logs&quot;</span><br><span class="line">174                prefix=&quot;tomcat.haha.com_access_log&quot; suffix=&quot;.txt&quot;</span><br><span class="line">175                pattern=&quot;&#123;&amp;quot;client&amp;quot;:&amp;quot;%h&amp;quot;,  &amp;quot;client user&amp;quot;:&amp;quot;%l&amp;quot;,   &amp;quot;authenticated&amp;quot;:&amp;quo    t;%u&amp;quot;,   &amp;quot;access time&amp;quot;:&amp;quot;%t&amp;quot;,     &amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,   &amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,  &amp;q    uot;send bytes&amp;quot;:&amp;quot;%b&amp;quot;,  &amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,  &amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,  &amp;quot;A    gent version&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;&quot;/&gt;</span><br><span class="line">176 </span><br><span class="line">177       &lt;/Host&gt;</span><br><span class="line">178     &lt;/Engine&gt;</span><br><span class="line">179   &lt;/Service&gt;</span><br><span class="line">180 &lt;/Server&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 /usr/local/tomcat/logs]$ cat tomcat.haha.com_access_log.2024-02-14.txt </span><br><span class="line">&#123;&quot;client&quot;:&quot;192.168.13.101&quot;,  &quot;client user&quot;:&quot;-&quot;,   &quot;authenticated&quot;:&quot;-&quot;,   &quot;access time&quot;:&quot;[14/Feb/2024:15:55:51 +0800]&quot;,     &quot;method&quot;:&quot;GET / HTTP/1.1&quot;,   &quot;status&quot;:&quot;200&quot;,  &quot;send bytes&quot;:&quot;11230&quot;,  &quot;Query?string&quot;:&quot;&quot;,  &quot;partner&quot;:&quot;-&quot;,  &quot;Agent version&quot;:&quot;curl/7.29.0&quot;&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240214161223343.png" alt="image-20240214161223343"></p>
<p>kql - kibana query language</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240214161753177.png" alt="image-20240214161753177"></p>
<h3 id="收集tomcat错误日志"><a class="markdownIt-Anchor" href="#收集tomcat错误日志">#</a> 收集 tomcat 错误日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;error&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/tomcat/logs/catalina.out</span><br><span class="line">  # json.key_under_root: true</span><br><span class="line">  multiline.type: pattern</span><br><span class="line">  multiline.pattern: &#x27;^\d&#123;2&#125;&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-tomcat-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240215140411494.png" alt="image-20240215140411494"></p>
<h3 id="收集es错误日志"><a class="markdownIt-Anchor" href="#收集es错误日志">#</a> 收集 es 错误日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;error&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/elasticsearch/elk-100.log</span><br><span class="line">  # json.key_under_root: true</span><br><span class="line">  multiline.type: pattern</span><br><span class="line">  multiline.pattern: &#x27;^\[&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-tomcat-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240215141620731.png" alt="image-20240215141620731"></p>
<h3 id="日志过滤"><a class="markdownIt-Anchor" href="#日志过滤">#</a> 日志过滤</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;error&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/elasticsearch/elk-100.log</span><br><span class="line">  # json.key_under_root: true</span><br><span class="line">  multiline.type: pattern</span><br><span class="line">  multiline.pattern: &#x27;^\[&#x27;</span><br><span class="line">  multiline.negate: true</span><br><span class="line">  multiline.match: after</span><br><span class="line">  // 包含指定的内容才会采集</span><br><span class="line">  include_lines: [&quot;^ERR&quot;, &quot;^WARN&quot;]</span><br><span class="line">  exclude_lines: [&quot;^ERR&quot;, &quot;^WARN&quot;]</span><br></pre></td></tr></table></figure>
<p>不包含的结果是 offset 已经过了这行，但是 output 没有这行</p>
<p>黑名单优先级更高</p>
<h3 id="收集nginx所有日志"><a class="markdownIt-Anchor" href="#收集nginx所有日志">#</a> 收集 nginx 所有日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;error&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/error.log*</span><br><span class="line">  include_lines: [&#x27;\[error\]&#x27;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;error&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false				// 禁用索引生命周期管理</span><br></pre></td></tr></table></figure>
<h3 id="filestream-收集日志"><a class="markdownIt-Anchor" href="#filestream-收集日志">#</a> filestream 收集日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~/es-filebeat]$ cat /var/log/nginx/access.log</span><br><span class="line">&#123; &quot;@timestamp&quot;: &quot;15/Feb/2024:16:28:00 +0800&quot;, &quot;remote_addr&quot;: &quot;127.0.0.1&quot;, &quot;referer&quot;: &quot;-&quot;, &quot;request&quot;: &quot;GET / HTTP/1.1&quot;, &quot;status&quot;: 200, &quot;bytes&quot;: 615, &quot;agent&quot;: &quot;curl/7.29.0&quot;, &quot;x_forwarded&quot;: &quot;-&quot;, &quot;request_time&quot;: &quot;0.000&quot; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line">  id: haxi</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line">  parsers:</span><br><span class="line">    - ndjson:</span><br><span class="line">        keys_under_root: true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;error&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: filestream</span><br><span class="line">  id: haxi</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/tomcat/logs/tomcat.haha.com_access_log.*.txt</span><br><span class="line">  parsers:</span><br><span class="line">    - ndjson:</span><br><span class="line">        keys_under_root: true</span><br><span class="line"></span><br><span class="line">- type: filestream</span><br><span class="line">  id: haxixi</span><br><span class="line">  tags: [&quot;error&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /usr/local/tomcat/logs/*.out</span><br><span class="line">  parsers:</span><br><span class="line">    - multiline:</span><br><span class="line">        type: pattern</span><br><span class="line">        pattern: &#x27;^\d&#123;2&#125;&#x27;</span><br><span class="line">        negate: true</span><br><span class="line">        match: after</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;error&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240216143534847.png" alt="image-20240216143534847"></p>
<p>input 源最好 少于 4 个</p>
<p>实例太多可以采用：拆分实例 / 日志聚合</p>
<p>运行多个实例的 filebeat 需要手工指定数据路径 --path.data=/tmp/filebeat 。运行实例后，会在文件夹生成一个 lock 文件，阻止其他 fileabeat 实例使用</p>
<h3 id="日志聚合"><a class="markdownIt-Anchor" href="#日志聚合">#</a> 日志聚合</h3>
<p>rsyslog 收集系统日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">yum install rsyslog -y</span><br><span class="line"></span><br><span class="line">vim /etc/rsyslog.conf</span><br><span class="line">$ModLoad imtcp</span><br><span class="line">$InputTCPServerRun 514</span><br><span class="line">*.*                                                     /var/log/kkkkk.log		# @10.0.0.1:514</span><br><span class="line"></span><br><span class="line">systemctl restart rsyslog.service</span><br><span class="line"></span><br><span class="line">logger &quot;xixix&quot;										# logger命令测试日志文件</span><br><span class="line"></span><br><span class="line">Feb 16 15:21:46 elk101 root: xixix</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">// 之后filesream中只需要收集kkkkk.log即可</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="inputtcp"><a class="markdownIt-Anchor" href="#inputtcp">#</a> input.tcp</h3>
<p>用于路由器 / 交换机等无法安装 linux 程序场景</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;0.0.0.0:8888&quot;</span><br><span class="line">  tags: &quot;access&quot; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false</span><br></pre></td></tr></table></figure>
<p>telnet 1.1.1.1 8888</p>
<p>nc 1.1.1.1 8888</p>
<h3 id="outputfile"><a class="markdownIt-Anchor" href="#outputfile">#</a> output.file</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">output.file:</span><br><span class="line">  path: &quot;/tmp/haha&quot;</span><br><span class="line">  filename: sss.txt</span><br></pre></td></tr></table></figure>
<h3 id="outputredis"><a class="markdownIt-Anchor" href="#outputredis">#</a> output.redis</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">yum install epel* -y </span><br><span class="line">yum install redis -y </span><br><span class="line"></span><br><span class="line">vim /etc/redis.conf </span><br><span class="line">bind 0.0.0.0</span><br><span class="line">requirepass hahahaha</span><br><span class="line"></span><br><span class="line">systemctl enable redis --now </span><br><span class="line"></span><br><span class="line">redis-cli -a hahahaha -h 192.168.13.101 -p 6379 --raw -n 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;192.168.13.101:9000&quot;</span><br><span class="line">  tags: &quot;access&quot; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.redis:</span><br><span class="line">  hosts: [&quot;192.168.13.101:6379&quot;]</span><br><span class="line">  password: &quot;hahahaha&quot;</span><br><span class="line">  key: &quot;xixixixi&quot;</span><br><span class="line">  db: 5</span><br><span class="line">  timeout: 3</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 ~]$ telnet 192.168.13.101 9000</span><br><span class="line">Trying 192.168.13.101...</span><br><span class="line">Connected to 192.168.13.101.</span><br><span class="line">Escape character is &#x27;^]&#x27;.</span><br><span class="line">aaaa</span><br><span class="line">dddd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk102 ~]# redis-cli -a hahahaha -h 192.168.13.101 -p 6379 --raw -n 5</span><br><span class="line">192.168.13.101:6379[5]&gt; KEYS *</span><br><span class="line">xixixixi</span><br><span class="line">192.168.13.101:6379[5]&gt; LRANGE xixixixi 0 -1</span><br><span class="line">&#123;&quot;@timestamp&quot;:&quot;2024-02-16T08:34:52.573Z&quot;,&quot;@metadata&quot;:&#123;&quot;beat&quot;:&quot;filebeat&quot;,&quot;type&quot;:&quot;_doc&quot;,&quot;version&quot;:&quot;7.17.3&quot;&#125;,&quot;log&quot;:&#123;&quot;source&quot;:&#123;&quot;address&quot;:&quot;192.168.13.101:58184&quot;&#125;&#125;,&quot;tags&quot;:[&quot;access&quot;],&quot;input&quot;:&#123;&quot;type&quot;:&quot;tcp&quot;&#125;,&quot;ecs&quot;:&#123;&quot;version&quot;:&quot;1.12.0&quot;&#125;,&quot;host&quot;:&#123;&quot;name&quot;:&quot;elk101&quot;&#125;,&quot;agent&quot;:&#123;&quot;version&quot;:&quot;7.17.3&quot;,&quot;hostname&quot;:&quot;elk101&quot;,&quot;ephemeral_id&quot;:&quot;0ff0daea-3a89-47bb-84c2-e76108f22046&quot;,&quot;id&quot;:&quot;6531f582-c541-42cb-97f2-6a8ff960316b&quot;,&quot;name&quot;:&quot;elk101&quot;,&quot;type&quot;:&quot;filebeat&quot;&#125;,&quot;message&quot;:&quot;aaaa&quot;&#125;</span><br><span class="line">&#123;&quot;@timestamp&quot;:&quot;2024-02-16T08:34:53.371Z&quot;,&quot;@metadata&quot;:&#123;&quot;beat&quot;:&quot;filebeat&quot;,&quot;type&quot;:&quot;_doc&quot;,&quot;version&quot;:&quot;7.17.3&quot;&#125;,&quot;log&quot;:&#123;&quot;source&quot;:&#123;&quot;address&quot;:&quot;192.168.13.101:58184&quot;&#125;&#125;,&quot;tags&quot;:[&quot;access&quot;],&quot;input&quot;:&#123;&quot;type&quot;:&quot;tcp&quot;&#125;,&quot;ecs&quot;:&#123;&quot;version&quot;:&quot;1.12.0&quot;&#125;,&quot;host&quot;:&#123;&quot;name&quot;:&quot;elk101&quot;&#125;,&quot;agent&quot;:&#123;&quot;id&quot;:&quot;6531f582-c541-42cb-97f2-6a8ff960316b&quot;,&quot;name&quot;:&quot;elk101&quot;,&quot;type&quot;:&quot;filebeat&quot;,&quot;version&quot;:&quot;7.17.3&quot;,&quot;hostname&quot;:&quot;elk101&quot;,&quot;ephemeral_id&quot;:&quot;0ff0daea-3a89-47bb-84c2-e76108f22046&quot;&#125;,&quot;message&quot;:&quot;dddd&quot;&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">echo 11111 | nc 192.168.13.101 9000</span><br></pre></td></tr></table></figure>
<h2 id="logstash"><a class="markdownIt-Anchor" href="#logstash">#</a> Logstash</h2>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240217192958149.png" alt="image-20240217192958149"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://artifacts.elastic.co/downloads/logstash/logstash-7.17.3-x86_64.rpm&quot;</span><br><span class="line">yum install logstash-7.17.3-x86_64.rpm -y </span><br><span class="line"></span><br><span class="line">ln -sv /usr/share/logstash/bin/logstash /usr/local/bin/</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240217193501783.png" alt="image-20240217193501783"></p>
<h3 id="stdin-stdout"><a class="markdownIt-Anchor" href="#stdin-stdout">#</a> stdin &amp;&amp; stdout</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logstash -tf 111.conf</span><br><span class="line">logstash -f 111.conf</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">111111</span><br><span class="line">&#123;</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;elk102&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;111111&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-17T11:36:14.136Z</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="input-file"><a class="markdownIt-Anchor" href="#input-file">#</a> input - file</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; [&quot;/tmp/*.txt&quot;]</span><br><span class="line">        # logstash 默认从文件尾部读取。指定文件读取位置，只有sincedb种没有记录时生效。默认是end</span><br><span class="line">        start_position =&gt; &quot;beginning&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cat /usr/share/logstash/data/plugins/inputs/file/.sincedb_820ddbbd098cfece4b56f4fcbf67a9bb</span><br><span class="line">2363504 0 2050 12 1708170120.662962 /tmp/xxxx.txt</span><br><span class="line"></span><br><span class="line">ll -i /tmp/xxxx.txt </span><br><span class="line">2363504 -rw-r--r-- 1 root root 12 Feb 17 13:57 /tmp/xxxx.txt</span><br><span class="line"></span><br><span class="line">所有file都从头开始读取，删除db，设置beginning</span><br><span class="line"></span><br><span class="line">选择 Logstash 开始读取文件的初始位置:开始或结束。默认行为将文件视为实时流，因此从最后开始。如果您有要导入的旧数据，请将其设置为begin。</span><br><span class="line">此选项仅修改文件是新文件且以前未见过的“第一次接触”情况，即没有记录在 Logstash 读取的sincedb 文件中的当前位置的文件。如果文件之前已经看过，则此选项无效，将使用 sincedb 文件中记录的位置。</span><br></pre></td></tr></table></figure>
<h3 id="input-tcp"><a class="markdownIt-Anchor" href="#input-tcp">#</a> input - tcp</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 8888</span><br><span class="line">    &#125;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 9999</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@elk101 ~]$ telnet 192.168.13.102 8888</span><br><span class="line">eeeeee</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">          &quot;host&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-17T11:58:05.831Z,</span><br><span class="line">          &quot;port&quot; =&gt; 60912,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;eeeeee\r&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240217200036913.png" alt="image-20240217200036913"></p>
<h3 id="input-http"><a class="markdownIt-Anchor" href="#input-http">#</a> input - http</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    http &#123;</span><br><span class="line">        port =&gt; 8888</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-17T12:15:58.521Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">       &quot;headers&quot; =&gt; &#123;</span><br><span class="line">        &quot;upgrade_insecure_requests&quot; =&gt; &quot;1&quot;,</span><br><span class="line">                      &quot;http_accept&quot; =&gt; &quot;text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.7&quot;,</span><br><span class="line">                        &quot;http_host&quot; =&gt; &quot;192.168.13.102:8888&quot;,</span><br><span class="line">                       &quot;connection&quot; =&gt; &quot;close&quot;,</span><br><span class="line">                  &quot;accept_language&quot; =&gt; &quot;zh-CN,zh;q=0.9&quot;,</span><br><span class="line">                   &quot;request_method&quot; =&gt; &quot;POST&quot;,</span><br><span class="line">                  &quot;accept_encoding&quot; =&gt; &quot;gzip, deflate, br&quot;,</span><br><span class="line">                  &quot;http_user_agent&quot; =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.6099.71 Safari/537.36&quot;,</span><br><span class="line">                     &quot;request_path&quot; =&gt; &quot;/&quot;,</span><br><span class="line">                     &quot;http_version&quot; =&gt; &quot;HTTP/1.1&quot;,</span><br><span class="line">                    &quot;cache_control&quot; =&gt; &quot;max-age=0&quot;,</span><br><span class="line">                   &quot;content_length&quot; =&gt; &quot;6&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;111111&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;192.168.13.1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">使用postman，burp发送数据，logstash读取body数据</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240217200636381.png" alt="image-20240217200636381"></p>
<h3 id="input-redis"><a class="markdownIt-Anchor" href="#input-redis">#</a> input - redis</h3>
<p>filebeat 配合 logstash 使用</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240217203344911.png" alt="image-20240217203344911"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;192.168.13.101:9000&quot;</span><br><span class="line">  tags: &quot;access&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.redis:</span><br><span class="line">  hosts: [&quot;192.168.13.101:6379&quot;]</span><br><span class="line">  password: &quot;hahahaha&quot;</span><br><span class="line">  key: &quot;xixixixi&quot;</span><br><span class="line">  db: 5</span><br><span class="line">  timeout: 3</span><br><span class="line">  enabled: true</span><br><span class="line">  indices:</span><br><span class="line">    - index: &quot;hahaha-xixi-nginx-access-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">      when.contains:</span><br><span class="line">        tags: &quot;access&quot;</span><br><span class="line"></span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------------------------------------</span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">        data_type =&gt; &quot;list&quot;</span><br><span class="line">        db =&gt; 5</span><br><span class="line">        host =&gt; &quot;192.168.13.101&quot;</span><br><span class="line">        port =&gt; 6379</span><br><span class="line">        password =&gt; &quot;hahahaha&quot;</span><br><span class="line">        key =&gt; &quot;xixixixi&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">          &quot;tags&quot; =&gt; [</span><br><span class="line">        [0] &quot;access&quot;</span><br><span class="line">    ],</span><br><span class="line">         &quot;input&quot; =&gt; &#123;</span><br><span class="line">        &quot;type&quot; =&gt; &quot;tcp&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-16T08:34:52.573Z,</span><br><span class="line">           &quot;log&quot; =&gt; &#123;</span><br><span class="line">        &quot;source&quot; =&gt; &#123;</span><br><span class="line">            &quot;address&quot; =&gt; &quot;192.168.13.101:58184&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;aaaa&quot;,</span><br><span class="line">           &quot;ecs&quot; =&gt; &#123;</span><br><span class="line">        &quot;version&quot; =&gt; &quot;1.12.0&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">         &quot;agent&quot; =&gt; &#123;</span><br><span class="line">             &quot;version&quot; =&gt; &quot;7.17.3&quot;,</span><br><span class="line">            &quot;hostname&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">                  &quot;id&quot; =&gt; &quot;6531f582-c541-42cb-97f2-6a8ff960316b&quot;,</span><br><span class="line">        &quot;ephemeral_id&quot; =&gt; &quot;0ff0daea-3a89-47bb-84c2-e76108f22046&quot;,</span><br><span class="line">                &quot;name&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">                &quot;type&quot; =&gt; &quot;filebeat&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &#123;</span><br><span class="line">        &quot;name&quot; =&gt; &quot;elk101&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>logstash 从 redis 取数据的时候是使用的 pop 方式，读完就删</p>
<h3 id="filebeat-logstash"><a class="markdownIt-Anchor" href="#filebeat-logstash">#</a> filebeat — logstash</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">logstash:</span><br><span class="line">input &#123;</span><br><span class="line">    beats &#123;</span><br><span class="line">        port =&gt; 8809</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filebeat:</span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: tcp</span><br><span class="line">  host: &quot;192.168.13.101:9000&quot;</span><br><span class="line">  tags: &quot;access&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.13.102:8809&quot;]</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">&#123;</span><br><span class="line">         &quot;agent&quot; =&gt; &#123;</span><br><span class="line">                &quot;name&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">             &quot;version&quot; =&gt; &quot;7.17.3&quot;,</span><br><span class="line">        &quot;ephemeral_id&quot; =&gt; &quot;76001a08-5496-418b-8f67-cc021e950a5d&quot;,</span><br><span class="line">                  &quot;id&quot; =&gt; &quot;3c315a09-5270-4638-997e-829692eb5eb9&quot;,</span><br><span class="line">            &quot;hostname&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">                &quot;type&quot; =&gt; &quot;filebeat&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-17T12:42:08.409Z,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">           &quot;log&quot; =&gt; &#123;</span><br><span class="line">        &quot;source&quot; =&gt; &#123;</span><br><span class="line">            &quot;address&quot; =&gt; &quot;192.168.13.103:58750&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">          &quot;tags&quot; =&gt; [</span><br><span class="line">        [0] &quot;access&quot;,</span><br><span class="line">        [1] &quot;beats_input_codec_plain_applied&quot;</span><br><span class="line">    ],</span><br><span class="line">         &quot;input&quot; =&gt; &#123;</span><br><span class="line">        &quot;type&quot; =&gt; &quot;tcp&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">           &quot;ecs&quot; =&gt; &#123;</span><br><span class="line">        &quot;version&quot; =&gt; &quot;1.12.0&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;1111111111111&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &#123;</span><br><span class="line">        &quot;name&quot; =&gt; &quot;elk101&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="output-redis"><a class="markdownIt-Anchor" href="#output-redis">#</a> output - redis</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 9999</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    redis &#123;</span><br><span class="line">        host =&gt; &quot;192.168.13.101&quot;     </span><br><span class="line">        port =&gt; 6379</span><br><span class="line">        db =&gt; 10</span><br><span class="line">        password =&gt; &quot;hahahaha&quot;</span><br><span class="line">        data_type =&gt; &quot;list&quot;</span><br><span class="line">        key =&gt; &quot;aaaaa&quot;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">          &quot;host&quot; =&gt; &quot;elk103&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-17T12:51:25.744Z,</span><br><span class="line">       &quot;message&quot; =&gt; &quot;eeeeeeee\r&quot;,</span><br><span class="line">          &quot;port&quot; =&gt; 56288</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@elk102 ~/logst-config]# redis-cli -h 192.168.13.101 -a hahahaha -n 10 --raw</span><br><span class="line">192.168.13.101:6379[10]&gt; LRANGE aaaaa 0 -1</span><br><span class="line">1) &quot;&#123;\&quot;host\&quot;:\&quot;elk103\&quot;,\&quot;@version\&quot;:\&quot;1\&quot;,\&quot;@timestamp\&quot;:\&quot;2024-02-17T12:51:25.744Z\&quot;,\&quot;message\&quot;:\&quot;eeeeeeee\\r\&quot;,\&quot;port\&quot;:56288&#125;&quot;</span><br></pre></td></tr></table></figure>
<h3 id="output-file"><a class="markdownIt-Anchor" href="#output-file">#</a> output - file</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 9999</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    file &#123;</span><br><span class="line">        path =&gt; &quot;/tmp/kkkkk.txt&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cat /tmp/kkkkk.txt </span><br><span class="line">&#123;&quot;port&quot;:56292,&quot;@timestamp&quot;:&quot;2024-02-17T12:56:36.976Z&quot;,&quot;host&quot;:&quot;elk103&quot;,&quot;message&quot;:&quot;ttttttt\r&quot;,&quot;@version&quot;:&quot;1&quot;&#125;</span><br></pre></td></tr></table></figure>
<h3 id="output-es"><a class="markdownIt-Anchor" href="#output-es">#</a> output - es</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 9999</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;   </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 9999</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240218204850593.png" alt="image-20240218204850593"></p>
<p>索引模板可以自定义</p>
<h3 id="if"><a class="markdownIt-Anchor" href="#if">#</a> if</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">    tcp &#123;</span><br><span class="line">        port =&gt; 8888</span><br><span class="line">        type =&gt; &quot;shabi&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    if [tpye] == &quot;haha&quot; &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">        	hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        	index =&gt; &quot;uuu-logstash--haha-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else if [type] == &quot;shabi&quot; &#123;</span><br><span class="line">    	elasticsearch &#123;</span><br><span class="line">        	hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        	index =&gt; &quot;uuu-logstash--shabi-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">    	elasticsearch &#123;</span><br><span class="line">        	hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        	index =&gt; &quot;uuu-logstash--ppp-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240218211300883.png" alt="image-20240218211300883"></p>
<h3 id="多实例logstash"><a class="markdownIt-Anchor" href="#多实例logstash">#</a> 多实例 logstash</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">logstash -f xxx.conf --path.data /tmp/haha</span><br></pre></td></tr></table></figure>
<h3 id="filter"><a class="markdownIt-Anchor" href="#filter">#</a> filter</h3>
<h4 id="gork"><a class="markdownIt-Anchor" href="#gork">#</a> gork</h4>
<p>Grok 是将非结构化日志数据解析为结构化和可查询的好方法<br>
基于正则匹配任意文本格式，尤其是解析任意文本并对其进行结构化。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	beats &#123;</span><br><span class="line">		port =&gt; 8888</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			# &quot;message&quot; =&gt; &quot;%&#123;HTTPD_COMMONLOG&#125;&quot;</span><br><span class="line">			&quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			# patterns_dir =&gt; [&quot;./patterns&quot;]  # patterns 目录下面有个任意文件定义了变量，如果使用非官方定义的变量 </span><br><span class="line">			&quot;message&quot; =&gt; &quot;%&#123;IP:client&#125; %&#123;WORD:method&#125; %&#123;URIPATHPARAM:request&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:duration&#125;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">55.3.244.1 GET /index.html 15824 0.043</span><br><span class="line">&#123;</span><br><span class="line">         &quot;bytes&quot; =&gt; &quot;15824&quot;,</span><br><span class="line">      &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">          &quot;host&quot; =&gt; &quot;elk102&quot;,</span><br><span class="line">        &quot;method&quot; =&gt; &quot;GET&quot;,</span><br><span class="line">      &quot;duration&quot; =&gt; &quot;0.043&quot;,</span><br><span class="line">    &quot;@timestamp&quot; =&gt; 2024-02-19T12:56:29.945Z,</span><br><span class="line">        &quot;client&quot; =&gt; &quot;55.3.244.1&quot;,</span><br><span class="line">       &quot;message&quot; =&gt; &quot; 55.3.244.1 GET /index.html 15824 0.043&quot;,</span><br><span class="line">       &quot;request&quot; =&gt; &quot;/index.html&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>remove_field 移除一些字段</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			# patterns_dir =&gt; [&quot;./patterns&quot;]  # patterns 目录下面有个任意文件定义了变量，如果使用非官方定义的变量 </span><br><span class="line">			&quot;message&quot; =&gt; &quot;%&#123;IP:client&#125; %&#123;WORD:method&#125; %&#123;URIPATHPARAM:request&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:duration&#125;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">		remove_field =&gt; [&quot;@version&quot;,&quot;tags&quot;]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>add_field</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">	grok &#123;</span><br><span class="line">		match =&gt; &#123;</span><br><span class="line">			# patterns_dir =&gt; [&quot;./patterns&quot;]  # patterns 目录下面有个任意文件定义了变量，如果使用非官方定义的变量 </span><br><span class="line">			&quot;message&quot; =&gt; &quot;%&#123;IP:client&#125; %&#123;WORD:method&#125; %&#123;URIPATHPARAM:request&#125; %&#123;NUMBER:bytes&#125; %&#123;NUMBER:duration&#125;&quot;</span><br><span class="line">		&#125;</span><br><span class="line">		remove_field =&gt; [&quot;@version&quot;,&quot;tags&quot;]</span><br><span class="line">		add_field =&gt; &#123;</span><br><span class="line">			&quot;xixi&quot; =&gt; &quot;xixixi&quot;</span><br><span class="line">			&quot;haha-ip&quot; =&gt; %&#123;clientip&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		add_tag =&gt; [&quot;ssss&quot;]</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240220131110249.png" alt="image-20240220131110249"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240220132930278.png" alt="image-20240220132930278"></p>
<h4 id="date"><a class="markdownIt-Anchor" href="#date">#</a> date</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.13.102:8888&quot;]</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">            port =&gt; 8888</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">                match =&gt; &#123;</span><br><span class="line">                        &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        date &#123;</span><br><span class="line">                match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">                timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">                # 将匹配到的时间字段解析后存储到目标字段，默认为@timestamp</span><br><span class="line">                target =&gt; &quot;ooooo&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">           &quot;host&quot; =&gt; &#123;</span><br><span class="line">        &quot;name&quot; =&gt; &quot;elk101&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">           &quot;auth&quot; =&gt; &quot;-&quot;,</span><br><span class="line">            &quot;log&quot; =&gt; &#123;</span><br><span class="line">        &quot;offset&quot; =&gt; 87,</span><br><span class="line">          &quot;file&quot; =&gt; &#123;</span><br><span class="line">            &quot;path&quot; =&gt; &quot;/var/log/nginx/access.log&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">           &quot;verb&quot; =&gt; &quot;GET&quot;,</span><br><span class="line">    &quot;httpversion&quot; =&gt; &quot;1.1&quot;,</span><br><span class="line">       &quot;response&quot; =&gt; &quot;200&quot;,</span><br><span class="line">       &quot;referrer&quot; =&gt; &quot;\&quot;-\&quot;&quot;,</span><br><span class="line">          &quot;ooooo&quot; =&gt; 2024-02-20T05:55:12.000Z,</span><br><span class="line">     &quot;@timestamp&quot; =&gt; 2024-02-20T07:29:00.018Z,</span><br><span class="line">      &quot;timestamp&quot; =&gt; &quot;20/Feb/2024:13:55:12 +0800&quot;,</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240220153211206.png" alt="image-20240220153211206"></p>
<h4 id="geoip"><a class="markdownIt-Anchor" href="#geoip">#</a> geoip</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">            port =&gt; 8888</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">        grok &#123;</span><br><span class="line">                match =&gt; &#123;</span><br><span class="line">                        &quot;message&quot; =&gt; &quot;%&#123;COMBINEDAPACHELOG&#125;&quot;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        date &#123;</span><br><span class="line">                match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">                timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">                # 将匹配到的时间字段解析后存储到目标字段，默认为@timestamp</span><br><span class="line">                target =&gt; &quot;ooooo&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        geoip &#123;</span><br><span class="line">        	source =&gt; &quot;clientip&quot;</span><br><span class="line">        	fields =&gt; [&quot;city_name&quot;, &quot;country_name&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">          &quot;geoip&quot; =&gt; &#123;</span><br><span class="line">              &quot;timezone&quot; =&gt; &quot;Asia/Shanghai&quot;,</span><br><span class="line">         &quot;country_code3&quot; =&gt; &quot;CN&quot;,</span><br><span class="line">                    &quot;ip&quot; =&gt; &quot;223.5.5.5&quot;,</span><br><span class="line">             &quot;city_name&quot; =&gt; &quot;Hangzhou&quot;,</span><br><span class="line">              &quot;latitude&quot; =&gt; 30.294,</span><br><span class="line">             &quot;longitude&quot; =&gt; 120.1619,</span><br><span class="line">           &quot;region_code&quot; =&gt; &quot;ZJ&quot;,</span><br><span class="line">         &quot;country_code2&quot; =&gt; &quot;CN&quot;,</span><br><span class="line">          &quot;country_name&quot; =&gt; &quot;China&quot;,</span><br><span class="line">        &quot;continent_code&quot; =&gt; &quot;AS&quot;,</span><br><span class="line">              &quot;location&quot; =&gt; &#123;</span><br><span class="line">            &quot;lat&quot; =&gt; 30.294,</span><br><span class="line">            &quot;lon&quot; =&gt; 120.1619</span><br><span class="line">        &#125;,</span><br></pre></td></tr></table></figure>
<h4 id="useragent"><a class="markdownIt-Anchor" href="#useragent">#</a> useragent</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line">&#123; &quot;@timestamp&quot;: &quot;20/Feb/2024:17:01:44 +0800&quot;, &quot;remote_addr&quot;: &quot;192.168.13.1&quot;, &quot;referer&quot;: &quot;-&quot;, &quot;request&quot;: &quot;GET /jajaj HTTP/1.1&quot;, &quot;status&quot;: 404, &quot;bytes&quot;: 153, &quot;http_user_agent&quot;: &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0&quot;, &quot;x_forwarded&quot;: &quot;-&quot;, &quot;request_time&quot;: &quot;0.000&quot; &#125;</span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: log</span><br><span class="line">  tags: [&quot;access&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  paths:</span><br><span class="line">    - /var/log/nginx/access.log*</span><br><span class="line">  json.keys_under_root: true</span><br><span class="line"></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [&quot;192.168.13.102:8888&quot;]</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">                         </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">            port =&gt; 8888</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">        date &#123;</span><br><span class="line">                match =&gt; [&quot;timestamp&quot;,&quot;dd/MMM/yyyy:HH:mm:ss Z&quot;]</span><br><span class="line">                timezone =&gt; &quot;Asia/Shanghai&quot;</span><br><span class="line">                # 将匹配到的时间字段解析后存储到目标字段，默认为@timestamp</span><br><span class="line">                target =&gt; &quot;ooooo&quot;</span><br><span class="line">        &#125;</span><br><span class="line">        geoip &#123;</span><br><span class="line">        	source =&gt; &quot;clientip&quot;</span><br><span class="line">        	fields =&gt; [&quot;city_name&quot;, &quot;country_name&quot;]</span><br><span class="line">        &#125;</span><br><span class="line">        useragent &#123;</span><br><span class="line">        	source =&gt; &quot;http_user_agent&quot;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">       &quot;request_time&quot; =&gt; &quot;0.000&quot;,</span><br><span class="line">             &quot;status&quot; =&gt; 404,</span><br><span class="line">         &quot;@timestamp&quot; =&gt; 2024-02-20T09:08:53.104Z,</span><br><span class="line">              &quot;input&quot; =&gt; &#123;</span><br><span class="line">        &quot;type&quot; =&gt; &quot;log&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">            &quot;referer&quot; =&gt; &quot;-&quot;,</span><br><span class="line">        &quot;x_forwarded&quot; =&gt; &quot;-&quot;,</span><br><span class="line">                &quot;ecs&quot; =&gt; &#123;</span><br><span class="line">        &quot;version&quot; =&gt; &quot;1.12.0&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">            &quot;request&quot; =&gt; &quot;GET /jajaj HTTP/1.1&quot;,</span><br><span class="line">                &quot;log&quot; =&gt; &#123;</span><br><span class="line">          &quot;file&quot; =&gt; &#123;</span><br><span class="line">            &quot;path&quot; =&gt; &quot;/var/log/nginx/access.log&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;offset&quot; =&gt; 306</span><br><span class="line">    &#125;,</span><br><span class="line">               &quot;host&quot; =&gt; &#123;</span><br><span class="line">        &quot;name&quot; =&gt; &quot;elk101&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">         &quot;agentttttt&quot; =&gt; &#123;</span><br><span class="line">          &quot;os_major&quot; =&gt; &quot;10&quot;,</span><br><span class="line">           &quot;version&quot; =&gt; &quot;122.0&quot;,</span><br><span class="line">              &quot;name&quot; =&gt; &quot;Firefox&quot;,</span><br><span class="line">           &quot;os_full&quot; =&gt; &quot;Windows 10&quot;,</span><br><span class="line">           &quot;os_name&quot; =&gt; &quot;Windows&quot;,</span><br><span class="line">        &quot;os_version&quot; =&gt; &quot;10&quot;,</span><br><span class="line">             &quot;major&quot; =&gt; &quot;122&quot;,</span><br><span class="line">             &quot;minor&quot; =&gt; &quot;0&quot;,</span><br><span class="line">            &quot;device&quot; =&gt; &quot;Other&quot;,</span><br><span class="line">                &quot;os&quot; =&gt; &quot;Windows&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">               &quot;tags&quot; =&gt; [</span><br><span class="line">        [0] &quot;access&quot;,</span><br><span class="line">        [1] &quot;beats_input_raw_event&quot;,</span><br><span class="line">        [2] &quot;_geoip_lookup_failure&quot;</span><br><span class="line">    ],</span><br><span class="line">              &quot;bytes&quot; =&gt; 153,</span><br><span class="line">           &quot;@version&quot; =&gt; &quot;1&quot;,</span><br><span class="line">              &quot;agent&quot; =&gt; &#123;</span><br><span class="line">        &quot;ephemeral_id&quot; =&gt; &quot;cb7c47b6-8857-42bb-a298-5e2c43a57980&quot;,</span><br><span class="line">             &quot;version&quot; =&gt; &quot;7.17.3&quot;,</span><br><span class="line">                &quot;name&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">                &quot;type&quot; =&gt; &quot;filebeat&quot;,</span><br><span class="line">            &quot;hostname&quot; =&gt; &quot;elk101&quot;,</span><br><span class="line">                  &quot;id&quot; =&gt; &quot;27c000fd-4c27-4a68-bd48-fc24ea1959aa&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;http_user_agent&quot; =&gt; &quot;Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:122.0) Gecko/20100101 Firefox/122.0&quot;,</span><br><span class="line">        &quot;remote_addr&quot; =&gt; &quot;192.168.13.1&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="mutate"><a class="markdownIt-Anchor" href="#mutate">#</a> mutate</h4>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">            port =&gt; 8888</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            split &#123;</span><br><span class="line">                &quot;message&quot; =&gt; &quot;|&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            add_field =&gt; &#123;</span><br><span class="line">                &quot;user_id&quot; =&gt; &quot;%&#123;[message][0]&#125;&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            convert =&gt; &#123;</span><br><span class="line">                &quot;filenum&quot; =&gt; &quot;integer&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mutate &#123;</span><br><span class="line">            strip =&gt; &#123;</span><br><span class="line">                &quot;filenum&quot; =&gt; [&quot;integer&quot;]</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">    stdout &#123;&#125;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">        hosts =&gt;  [&quot;elk101:9200&quot;, &quot;elk102:9200&quot;, &quot;elk103:9200&quot;]</span><br><span class="line">        index =&gt; &quot;uuu-logstash-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line"> beats &#123;</span><br><span class="line"> type =&gt; &quot;oldboyedu-beats&quot;</span><br><span class="line"> port =&gt; 8888</span><br><span class="line"> &#125; </span><br><span class="line"> tcp &#123;</span><br><span class="line"> type =&gt; &quot;oldboyedu-tcp&quot;</span><br><span class="line"> port =&gt; 9999</span><br><span class="line"> &#125;</span><br><span class="line"> tcp &#123;</span><br><span class="line"> type =&gt; &quot;oldboyedu-tcp-new&quot;</span><br><span class="line"> port =&gt; 7777</span><br><span class="line"> &#125;</span><br><span class="line"> http &#123;</span><br><span class="line"> type =&gt; &quot;oldboyedu-http&quot;</span><br><span class="line"> port =&gt; 6666</span><br><span class="line"> &#125;</span><br><span class="line"> file &#123;</span><br><span class="line"> type =&gt; &quot;oldboyedu-file&quot;</span><br><span class="line"> path =&gt; &quot;/tmp/apps.log&quot;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> add_field =&gt; &#123; </span><br><span class="line"> &quot;school&quot; =&gt; &quot;北京市昌平区沙河镇⽼男孩IT教育&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> if [type] == [&quot;oldboyedu-beats&quot;,&quot;oldboyedu-tcp-new&quot;,&quot;oldboyedu-http&quot;] </span><br><span class="line">&#123;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> remove_field =&gt; [ &quot;agent&quot;, &quot;host&quot;, &quot;@version&quot;, &quot;ecs&quot;, </span><br><span class="line">&quot;tags&quot;,&quot;input&quot;, &quot;log&quot; ]</span><br><span class="line"> &#125;</span><br><span class="line"> geoip &#123;</span><br><span class="line"> source =&gt; &quot;clientip&quot;</span><br><span class="line"> target =&gt; &quot;oldboyedu-linux80-geoip&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> useragent &#123;</span><br><span class="line"> source =&gt; &quot;http_user_agent&quot;</span><br><span class="line"> target =&gt; &quot;oldboyedu-linux80-useragent&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125; else if [type] == &quot;oldboyedu-file&quot; &#123;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> add_field =&gt; &#123;</span><br><span class="line"> &quot;class&quot; =&gt; &quot;oldboyedu-linux80&quot;</span><br><span class="line"> &quot;address&quot; =&gt; &quot;北京昌平区沙河镇⽼男孩IT教育&quot;</span><br><span class="line"> &quot;hobby&quot; =&gt; [&quot;LOL&quot;,&quot;王者荣耀&quot;]</span><br><span class="line"> &#125;</span><br><span class="line"> remove_field =&gt; [&quot;host&quot;,&quot;@version&quot;,&quot;school&quot;]</span><br><span class="line"> &#125;</span><br><span class="line"> &#125; else &#123;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> remove_field =&gt; [&quot;port&quot;,&quot;@version&quot;,&quot;host&quot;]</span><br><span class="line"> &#125;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> split =&gt; &#123;</span><br><span class="line"> &quot;message&quot; =&gt; &quot;|&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> add_field =&gt; &#123;</span><br><span class="line"> &quot;user_id&quot; =&gt; &quot;%&#123;[message][1]&#125;&quot;</span><br><span class="line"> &quot;action&quot; =&gt; &quot;%&#123;[message][2]&#125;&quot;</span><br><span class="line"> &quot;svip&quot; =&gt; &quot;%&#123;[message][3]&#125;&quot;</span><br><span class="line"> &quot;price&quot; =&gt; &quot;%&#123;[message][4]&#125;&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> # 利⽤完message字段后，在删除是可以等!注意代码等执⾏顺序!</span><br><span class="line"> remove_field =&gt; [&quot;message&quot;]</span><br><span class="line"> strip =&gt; [&quot;svip&quot;]</span><br><span class="line"> &#125;</span><br><span class="line"> mutate &#123;</span><br><span class="line"> convert =&gt; &#123;</span><br><span class="line"> &quot;user_id&quot; =&gt; &quot;integer&quot;</span><br><span class="line"> &quot;svip&quot; =&gt; &quot;boolean&quot;</span><br><span class="line"> &quot;price&quot; =&gt; &quot;float&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line"> stdout &#123;&#125;</span><br><span class="line"> if [type] == &quot;oldboyedu-beats&quot; &#123;</span><br><span class="line"> elasticsearch &#123;</span><br><span class="line"> hosts =&gt; </span><br><span class="line">[&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line"> index =&gt; &quot;oldboyedu-linux80-logstash-beats&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125; else &#123;</span><br><span class="line"> elasticsearch &#123;</span><br><span class="line"> hosts =&gt; </span><br><span class="line">[&quot;10.0.0.101:9200&quot;,&quot;10.0.0.102:9200&quot;,&quot;10.0.0.103:9200&quot;]</span><br><span class="line"> index =&gt; &quot;oldboyedu-linux80-logstash-tcp&quot;</span><br><span class="line"> &#125;</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240221154547427.png" alt="image-20240221154547427"></p>
<h2 id="kibana"><a class="markdownIt-Anchor" href="#kibana">#</a> kibana</h2>
<p>试用 kibana 样例</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240221155924632.png" alt="image-20240221155924632"></p>
<h3 id="dashborad"><a class="markdownIt-Anchor" href="#dashborad">#</a> dashborad</h3>
<h4 id="pv"><a class="markdownIt-Anchor" href="#pv">#</a> pv</h4>
<p>page view 页面访问量，在一定的统计周期内，用户每次刷新网页就会被计算</p>
<p>1. 创建 Visualize 库</p>
<p>创建基于聚合 -&gt; 新建指标  -&gt; 选择索引</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224212012635.png" alt="image-20240224212012635"></p>
<h4 id="ip"><a class="markdownIt-Anchor" href="#ip">#</a> IP</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224214353415.png" alt="image-20240224214353415"></p>
<h4 id="带宽"><a class="markdownIt-Anchor" href="#带宽">#</a> 带宽</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224214831117.png" alt="image-20240224214831117"></p>
<h4 id="统计访问页面"><a class="markdownIt-Anchor" href="#统计访问页面">#</a> 统计访问页面</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224215436733.png" alt="image-20240224215436733"></p>
<h4 id="dashboard"><a class="markdownIt-Anchor" href="#dashboard">#</a> dashboard</h4>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224220417920.png" alt="image-20240224220417920"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224220707733.png" alt="image-20240224220707733"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224221343389.png" alt="image-20240224221343389"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240224221458172.png" alt="image-20240224221458172"></p>
<h2 id="二进制部署"><a class="markdownIt-Anchor" href="#二进制部署">#</a> 二进制部署</h2>
<h3 id="单节点elasticsearch"><a class="markdownIt-Anchor" href="#单节点elasticsearch">#</a> 单节点 elasticsearch</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">yum install java-1.8.0-openjdk  java-1.8.0-openjdk-devel.x86_64 -y</span><br><span class="line">java -version </span><br><span class="line">openjdk version &quot;1.8.0_402&quot;</span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_402-b06)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.402-b06, mixed mode)</span><br><span class="line"></span><br><span class="line">echo &quot;export JAVA_HOME=/usr/lib/jvm/java-1.8.0-openjdk-1.8.0.402.b06-1.el7_9.x86_64&quot; &gt;&gt; /etc/profile</span><br><span class="line">echo &quot;export PATH=$JAVA_HOME/bin:$PATH &quot; &gt;&gt; /etc/profile</span><br><span class="line">echo &quot;export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar&quot; &gt;&gt; /etc/profile</span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">yum install wget vim lrzsz systemd unzip -y</span><br><span class="line">wget &quot;https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-7.17.3-linux-x86_64.tar.gz&quot;</span><br><span class="line">tar xzvf elasticsearch-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">echo &quot;# elasticsearch&quot; &gt;&gt; /etc/profile</span><br><span class="line">echo &quot;export ES_HOME=/root/elasticsearch-7.17.3&quot; &gt;&gt; /etc/profile</span><br><span class="line">echo &quot;export PATH=$PATH:$ES_HOME/bin&quot; &gt;&gt; /etc/profile</span><br><span class="line">source	/etc/profile</span><br><span class="line"></span><br><span class="line">useradd elasticsearch</span><br><span class="line">chown elasticsearch:elasticsearch -R elasticsearch-7.17.3</span><br><span class="line"></span><br><span class="line">egrep -v &quot;^#|^$&quot; /root/elasticsearch-7.17.3/config/elasticsearch.yml </span><br><span class="line">cluster.name: elk</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;192.168.13.101&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;192.168.13.101&quot;]</span><br><span class="line"></span><br><span class="line">ulimit -a </span><br><span class="line">core file size          (blocks, -c) 0</span><br><span class="line">data seg size           (kbytes, -d) unlimited</span><br><span class="line">scheduling priority             (-e) 0</span><br><span class="line">file size               (blocks, -f) unlimited</span><br><span class="line">pending signals                 (-i) 15001</span><br><span class="line">max locked memory       (kbytes, -l) 64</span><br><span class="line">max memory size         (kbytes, -m) unlimited</span><br><span class="line">open files                      (-n) 1024</span><br><span class="line">pipe size            (512 bytes, -p) 8</span><br><span class="line">POSIX message queues     (bytes, -q) 819200</span><br><span class="line">real-time priority              (-r) 0</span><br><span class="line">stack size              (kbytes, -s) 8192</span><br><span class="line">cpu time               (seconds, -t) unlimited</span><br><span class="line">max user processes              (-u) 15001</span><br><span class="line">virtual memory          (kbytes, -v) unlimited</span><br><span class="line">file locks                      (-x) unlimited</span><br><span class="line"></span><br><span class="line">vim /etc/security/limits.conf </span><br><span class="line">* soft nofile 65535</span><br><span class="line">* hard nofile 100000</span><br><span class="line"></span><br><span class="line">logout</span><br><span class="line"></span><br><span class="line">ulimit  -Sn</span><br><span class="line">65535</span><br><span class="line">ulimit  -Hn</span><br><span class="line">100000</span><br><span class="line"></span><br><span class="line">vim /etc/sysctl.conf </span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line"></span><br><span class="line">sysctl -p</span><br><span class="line"></span><br><span class="line">sysctl  -q vm.max_map_count</span><br><span class="line">vm.max_map_count = 262144</span><br><span class="line"></span><br><span class="line">usermod -g root elasticsearch</span><br><span class="line">su -c &quot;elasticsearch&quot; elasticsearch				# -d后台启动，或者切到用户在启动</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">curl 192.168.13.101:9200/_cat/nodes</span><br><span class="line">192.168.13.101 17 97 8 0.22 0.12 0.08 cdfhilmrstw * elk101</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">jps # 查看java相关进程信息</span><br><span class="line">31139 Jps</span><br><span class="line">30872 Elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">jmap -heap 30872 		# 查看java堆栈信息</span><br><span class="line">Attaching to process ID 30872, please wait...</span><br><span class="line">Debugger attached successfully.</span><br><span class="line">Server compiler detected.</span><br><span class="line">JVM version is 25.402-b06</span><br><span class="line"></span><br><span class="line">using parallel threads in the new generation.</span><br><span class="line">using thread-local object allocation.</span><br><span class="line">Concurrent Mark-Sweep GC</span><br><span class="line"></span><br><span class="line">Heap Configuration:</span><br><span class="line">   MinHeapFreeRatio         = 40</span><br><span class="line">   MaxHeapFreeRatio         = 70</span><br><span class="line">   MaxHeapSize              = 1073741824 (1024.0MB)</span><br><span class="line">   NewSize                  = 174456832 (166.375MB)</span><br><span class="line">   MaxNewSize               = 174456832 (166.375MB)</span><br><span class="line">   OldSize                  = 899284992 (857.625MB)</span><br><span class="line">   NewRatio                 = 2</span><br><span class="line">   SurvivorRatio            = 8</span><br><span class="line">   MetaspaceSize            = 21807104 (20.796875MB)</span><br><span class="line">   CompressedClassSpaceSize = 1073741824 (1024.0MB)</span><br><span class="line">   MaxMetaspaceSize         = 17592186044415 MB</span><br><span class="line">   G1HeapRegionSize         = 0 (0.0MB)</span><br><span class="line"></span><br><span class="line">Heap Usage:</span><br><span class="line">New Generation (Eden + 1 Survivor Space):</span><br><span class="line">   capacity = 157024256 (149.75MB)</span><br><span class="line">   used     = 119552712 (114.01435089111328MB)</span><br><span class="line">   free     = 37471544 (35.73564910888672MB)</span><br><span class="line">   76.13646136301388% used</span><br><span class="line">Eden Space:</span><br><span class="line">   capacity = 139591680 (133.125MB)</span><br><span class="line">   used     = 113230224 (107.98475646972656MB)</span><br><span class="line">   free     = 26361456 (25.140243530273438MB)</span><br><span class="line">   81.11531002420774% used</span><br><span class="line">From Space:</span><br><span class="line">   capacity = 17432576 (16.625MB)</span><br><span class="line">   used     = 6322488 (6.029594421386719MB)</span><br><span class="line">   free     = 11110088 (10.595405578613281MB)</span><br><span class="line">   36.26823712112312% used</span><br><span class="line">To Space:</span><br><span class="line">   capacity = 17432576 (16.625MB)</span><br><span class="line">   used     = 0 (0.0MB)</span><br><span class="line">   free     = 17432576 (16.625MB)</span><br><span class="line">   0.0% used</span><br><span class="line">concurrent mark-sweep generation:</span><br><span class="line">   capacity = 899284992 (857.625MB)</span><br><span class="line">   used     = 73758768 (70.34184265136719MB)</span><br><span class="line">   free     = 825526224 (787.2831573486328MB)</span><br><span class="line">   8.201934721045584% used</span><br><span class="line"></span><br><span class="line">40897 interned Strings occupying 4927424 bytes.</span><br><span class="line"></span><br><span class="line">vim /root/elasticsearch-7.17.3/config/jvm.options</span><br><span class="line">-Xms512m</span><br><span class="line">-Xmx512m</span><br><span class="line"></span><br><span class="line">当内存&gt;64G 的时候，最高设置为32G。否则设置为 1/2</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line"></span><br><span class="line">如果es文件在root下，那么此时一定要给对应的文件夹普通用户的权限，或者chown这个文件夹</span><br><span class="line">同事也需要将这个普通用户所属组改成root   usermod -g root elasticsearch</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=Elasticsearch #描述</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=elasticsearch</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">WorkingDirectory=/root/elasticsearch-7.17.3/</span><br><span class="line">ExecStart=/root/elasticsearch-7.17.3/bin/elasticsearch</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload </span><br></pre></td></tr></table></figure>
<h3 id="集群es"><a class="markdownIt-Anchor" href="#集群es">#</a> 集群 es</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /root/elasticsearch-7.17.3/config/elasticsearch.yml </span><br><span class="line">cluster.name: elk</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">discovery.seed_hosts: [&quot;elk101&quot;, &quot;elk102&quot;, &quot;elk103&quot;]</span><br><span class="line">cluster.initial_master_nodes: [&quot;elk101&quot;, &quot;elk102&quot;, &quot;elk103&quot;]</span><br></pre></td></tr></table></figure>
<h3 id="kibana-2"><a class="markdownIt-Anchor" href="#kibana-2">#</a> kibana</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://artifacts.elastic.co/downloads/kibana/kibana-7.17.3-linux-x86_64.tar.gz&quot;</span><br><span class="line">tar xzvf kibana-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">vim /etc/profile</span><br><span class="line"># kibana</span><br><span class="line">export KIBANA_HONE=/root/kibana-7.17.3-linux-x86_64/</span><br><span class="line">export PATH=$PATH:$KIBANA_HONE/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br><span class="line"></span><br><span class="line">chown elasticsearch:elasticsearch /root/kibana-7.17.3-linux-x86_64 -R</span><br><span class="line"></span><br><span class="line">vim /root/kibana-7.17.3-linux-x86_64/config/kibana.yml </span><br><span class="line">server.host: &quot;0.0.0.0&quot;</span><br><span class="line">elasticsearch.hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">server.name: &quot;kibana-server&quot;</span><br><span class="line">i18n.locale: &quot;zh-CN&quot;</span><br><span class="line"></span><br><span class="line">su -c &quot;kibana&quot; elasticsearch</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">cat /root/kibana-7.17.3-linux-x86_64/bin/kibana.sh </span><br><span class="line">Kibana=/root/kibana-7.17.3-linux-x86_64</span><br><span class="line">PID=&quot;&quot;</span><br><span class="line"> </span><br><span class="line">if [ &quot;$1&quot; = &quot;&quot; ];</span><br><span class="line">then</span><br><span class="line">    echo -e &quot;\033[0;31m 未输入操作名 \033[0m  \033[0;34m &#123;start|stop|restart|status&#125; \033[0m&quot;</span><br><span class="line">    exit 1</span><br><span class="line">fi</span><br><span class="line"> </span><br><span class="line">function query()</span><br><span class="line">&#123;</span><br><span class="line">    PID=`ps aux |grep elk|grep kibana|grep -v $0 | grep -v grep | awk &#x27;&#123;print $2&#125;&#x27;`</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function start()</span><br><span class="line">&#123;</span><br><span class="line">    query</span><br><span class="line">    </span><br><span class="line">    if [ x&quot;$PID&quot; != x&quot;&quot; ]; then</span><br><span class="line">        echo &quot;kibana is running...&quot;</span><br><span class="line">    else</span><br><span class="line">        #su elk&lt;&lt;!</span><br><span class="line">        nohup su -c $Kibana/bin/kibana &quot;elasticsearch&quot; &gt;/root/kibana-7.17.3-linux-x86_64/logs/start.log 2&gt;&amp;1&amp;</span><br><span class="line">#!</span><br><span class="line">        echo &quot;Start kibana success...&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function stop()</span><br><span class="line">&#123;</span><br><span class="line">    echo &quot;Stop kibana&quot;</span><br><span class="line">    query</span><br><span class="line">    echo &quot;WO $PID&quot;</span><br><span class="line">    if [ x&quot;$PID&quot; != x&quot;&quot; ]; then</span><br><span class="line">        kill -TERM $PID</span><br><span class="line">        echo &quot;kibana (pid:$PID) exiting...&quot;</span><br><span class="line">        while [ x&quot;$PID&quot; != x&quot;&quot; ]</span><br><span class="line">        do</span><br><span class="line">            sleep 1</span><br><span class="line">            query</span><br><span class="line">        done</span><br><span class="line">        echo &quot;kibana exited.&quot;</span><br><span class="line">    else</span><br><span class="line">        echo &quot;kibana already stopped.&quot;</span><br><span class="line">    fi</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">function restart()</span><br><span class="line">&#123;</span><br><span class="line">    stop</span><br><span class="line">       sleep 2</span><br><span class="line">       start</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line">case $1 in</span><br><span class="line">start)</span><br><span class="line">        start;;</span><br><span class="line">stop)</span><br><span class="line">        stop;;</span><br><span class="line">restart)</span><br><span class="line">        restart;;</span><br><span class="line">*)</span><br><span class="line"> </span><br><span class="line">esac</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">mkdir /root/kibana-7.17.3-linux-x86_64/logs</span><br><span class="line">chown elasticsearch:elasticsearch -R logs/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=kibana.service</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">User=elasticsearch</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">LimitNOFILE=65536</span><br><span class="line">LimitNPROC=65536</span><br><span class="line">ExecStart=/root/kibana-7.17.3-linux-x86_64/bin/kibana.sh start</span><br><span class="line">ExecReload=/root/kibana-7.17.3-linux-x86_64/bin/kibana.sh restart</span><br><span class="line">ExecStop=/root/kibana-7.17.3-linux-x86_64/bin/kibana.sh stop</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=always</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=kibana</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=elasticsearch</span><br><span class="line">ExecStart=/root/kibana-7.17.3-linux-x86_64/bin/kibana</span><br><span class="line">PrivateTmp=true</span><br><span class="line">User=elasticsearch</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure>
<h3 id="logstash-2"><a class="markdownIt-Anchor" href="#logstash-2">#</a> logstash</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/logstash/logstash-7.17.3-linux-x86_64.tar.gz</span><br><span class="line">tar xvzf logstash-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line">vim /etc/profile</span><br><span class="line">export LOGSTASH_HOME=/root/logstash-7.17.3</span><br><span class="line">export PATH=$PATH:$LOGSTASH_HOME/bin</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">        stdin&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">        stdout&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logstash -rf 1.conf</span><br></pre></td></tr></table></figure>
<h3 id="filebeat"><a class="markdownIt-Anchor" href="#filebeat">#</a> filebeat</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-7.17.3-linux-x86_64.tar.gz</span><br><span class="line">tar xzvf filebeat-7.17.3-linux-x86_64.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">filebeat.inputs:</span><br><span class="line">- type: stdin</span><br><span class="line">  enabled: true</span><br><span class="line"></span><br><span class="line">output.console:</span><br><span class="line">  pretty: true</span><br><span class="line">  </span><br><span class="line">/root/filebeat-7.17.3-linux-x86_64/filebeat -e -c /root/filebeat_config/1.yaml </span><br></pre></td></tr></table></figure>
<h3 id="es-head"><a class="markdownIt-Anchor" href="#es-head">#</a> es-head</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">wget https://github.com/mobz/elasticsearch-head/archive/refs/tags/v5.0.0.tar.gz</span><br><span class="line">tar xzvf v5.0.0.tar.gz</span><br></pre></td></tr></table></figure>
<h2 id="es-rest风格api"><a class="markdownIt-Anchor" href="#es-rest风格api">#</a> ES rest 风格 api</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">json 语法</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">基础数据类型</span><br><span class="line">	字符串</span><br><span class="line">	数字</span><br><span class="line">	布尔值</span><br><span class="line">	空值 null</span><br><span class="line">	</span><br><span class="line">高级数据类型</span><br><span class="line">	数组 []</span><br><span class="line">	对象 &#123;&quot;1&quot;:&quot;12&quot;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">es</span><br><span class="line">	document: 文档，用户存储在es中的数据，最小的存储单元。文档采用json对象数据类型存储</span><br><span class="line">	field： 相当于数据库表的字段，对文档数据根据不同属性进行分类标识</span><br><span class="line">	index：索引，一个索引就是一个拥有相似特征的文档集合</span><br><span class="line">	shard：分片，一个索引有一个或多个分片。是真正存储数据的地方，对应的是一个lucene库</span><br><span class="line">	replica： 副本，一个分片可以有0个或多个副本。副本数量不等于0的时候，就会有主分片primary shard和副本分片replica shard</span><br><span class="line">		主分片：可以实现数据的读写操作</span><br><span class="line">		副本分片：可以实现数据读写操作，需要去主分片同步数据，当主分片挂掉，副本分片会变成主分片</span><br><span class="line">	Alloction：将分片分配给某个节点的过程，包含主分片和副本分片。如果是副本分片，还包含从主分片复制数据的过程，这个分配过程由master节点调度完成</span><br><span class="line">	Type： 在5.x和以前一个索引中我们可以定义一种或多种数据类型。在es7中仅支持_doc类型</span><br></pre></td></tr></table></figure>
<h3 id="索引"><a class="markdownIt-Anchor" href="#索引">#</a> 索引</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240302134655477.png" alt="image-20240302134655477"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240302134913428.png" alt="image-20240302134913428"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240302135039214.png" alt="image-20240302135039214"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240302135140817.png" alt="image-20240302135140817"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"># 查询索引</span><br><span class="line">GET http://192.168.13.101:9200/_cat/indices</span><br><span class="line">GET http://192.168.13.101:9200/_cat/indices?v</span><br><span class="line">GET http://192.168.13.101:9200/_cat/indices/.geoip_databases?v</span><br><span class="line">GET http://192.168.13.101:9200/.kibana_7.17.3_001</span><br><span class="line"></span><br><span class="line"># 创建索引</span><br><span class="line">PUT http://192.168.13.101:9200/hahaha-new			#　创建索引</span><br><span class="line">PUT http://192.168.13.101:9200/hahaha-old </span><br><span class="line">&#123;</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &#123;</span><br><span class="line">            &quot;number_of_shards&quot;: &quot;3&quot;,</span><br><span class="line">            &quot;number_of_replicas&quot;: &quot;3&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 修改索引,只能修改副本数量，不能修改分片数量</span><br><span class="line">PUT http://192.168.13.101:9200/hahaha-old/_settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;number_of_replicas&quot;: &quot;2&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 删除索引</span><br><span class="line">DELETE http://192.168.13.101:9200/hahaha-old</span><br><span class="line"></span><br><span class="line"># 索引别名</span><br><span class="line">POST http://192.168.13.101:9200/_aliases			# 创建</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;hahaha-new&quot;,</span><br><span class="line">                &quot;alias&quot;: &quot;ahahahah&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;hahaha-new&quot;,</span><br><span class="line">                &quot;alias&quot;: &quot;pppp&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">GET http://192.168.13.101:9200/_aliases		# 查看所有索引别名</span><br><span class="line">POST http://192.168.13.101:9200/_aliases		# 删除索引别名</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;remove&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;hahaha-new&quot;,</span><br><span class="line">                &quot;alias&quot;: &quot;ahahahah&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">POST http://192.168.13.101:9200/_aliases			# 修改</span><br><span class="line">&#123;</span><br><span class="line">    &quot;actions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;remove&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;hahaha-new&quot;,</span><br><span class="line">                &quot;alias&quot;: &quot;ahahahah&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;add&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;hahaha-new&quot;,</span><br><span class="line">                &quot;alias&quot;: &quot;segemnt&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 关闭索引,数据在，不会被真实删除，但是不能进行读写，支持通配符</span><br><span class="line">POST http://192.168.13.101:9200/hahaha-new/_close</span><br><span class="line">POST http://192.168.13.101:9200/hahaha-new/_open 	</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 文档创建,es7中只有_doc这种类型。可以创建不同的类型的文档,文档中类型必须一致。</span><br><span class="line">POST http://192.168.13.101:9200/teacher/_doc			# 创建文档，会自动创建索引</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;shabi&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;123&quot;</span><br><span class="line">&#125;</span><br><span class="line">POST http://192.168.13.101:9200/teacher/_doc/10010			# 10010 为文档ID</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;shabi&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;123&quot;</span><br><span class="line">&#125;</span><br><span class="line">POST http://192.168.13.101:9200/teacher/linux</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;shabi&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;123&quot;</span><br><span class="line">&#125;</span><br><span class="line">POST http://192.168.13.101:9200/teacher/_doc</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;shabi&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;123&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查看文档</span><br><span class="line">GET http://192.168.13.101:9200/teacher/_search</span><br><span class="line">源数据：用户写入数据</span><br><span class="line">元数据：描述用户写入数据，由es维护</span><br><span class="line">GET http://192.168.13.101:9200/teacher/_doc/10010			# 查看id=10010的文档</span><br><span class="line">HEAD http://192.168.13.101:9200/teacher/_doc/10010			# 文档是否存在</span><br><span class="line"></span><br><span class="line"># 修改文档</span><br><span class="line">POST http://192.168.13.101:9200/teacher/_doc/10010		# 全量更新</span><br><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;:&quot;hahahahah&quot;,</span><br><span class="line">    &quot;age&quot;:&quot;123&quot;</span><br><span class="line">&#125;</span><br><span class="line">POST http://192.168.13.101:9200/teacher/_doc/10010/_update		# 局部更新，只更新某个字段</span><br><span class="line">&#123;</span><br><span class="line">    &quot;doc&quot;: &#123;</span><br><span class="line">        &quot;name&quot;: &quot;hahahahahxixix&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 删除文档</span><br><span class="line">DELETE http://192.168.13.101:9200/teacher/_doc/_psT_o0BSW4RfxxQMeLl		# 删除文档</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">bulk对JSON串的有着严格的要求。每个JSON串不能换行，只能放在同一行，同时，相邻的JSON串之间必须要有换行（Linux下是\n；Window下是\r\n）。bulk的每个操作必须要一对JSON串（delete语法除外）。</span><br><span class="line"># 批量创建文档</span><br><span class="line">POST http://192.168.13.101:9200/_bulk</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;hahaha&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;xixi&quot;,&quot;hobby&quot;:&quot;luguan&quot;&#125;</span><br><span class="line">&#123;&quot;create&quot;:&#123;&quot;_index&quot;:&quot;hahaha&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;name&quot;:&quot;haha&quot;,&quot;hobby&quot;:&quot;111&quot;&#125;</span><br><span class="line">\n				# 替换成一个换行</span><br><span class="line"></span><br><span class="line"># 批量删除</span><br><span class="line">POST http://192.168.13.101:9200/_bulk</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;hahaha&quot;,&quot;_id&quot;: &quot;AZscBI4BSW4RfxxQpuOP&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;delete&quot;:&#123;&quot;_index&quot;:&quot;hahaha&quot;,&quot;_id&quot;: &quot;AZscBI4BSW4RfxxQpuOP&quot;&#125;&#125;</span><br><span class="line">\n&#123;</span><br><span class="line">    &quot;docs&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">        &quot;_index&quot;:&quot;hahaha&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;ApsiBI4BSW4RfxxQnuNB&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 批量修改</span><br><span class="line">POST http://192.168.13.101:9200/_bulk</span><br><span class="line">&#123;&quot;update&quot;:&#123;&quot;_index&quot;:&quot;hahaha&quot;,&quot;_id&quot;: &quot;ApsiBI4BSW4RfxxQnuNB&quot;&#125;&#125;</span><br><span class="line">&#123;&quot;doc&quot;:&#123;&quot;name&quot;:&quot;xixi&quot;,&quot;hobby&quot;:&quot;dapao&quot;&#125;&#125;</span><br><span class="line">\n</span><br><span class="line"></span><br><span class="line"># 批量查看</span><br><span class="line">POST http://192.168.13.101:9200/_mget</span><br><span class="line">&#123;</span><br><span class="line">    &quot;docs&quot;:[</span><br><span class="line">        &#123;</span><br><span class="line">        &quot;_index&quot;:&quot;hahaha&quot;,</span><br><span class="line">        &quot;_id&quot;: &quot;ApsiBI4BSW4RfxxQnuNB&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"># 创建mapping，将字段指定为自定义类型</span><br><span class="line">PUT http://192.168.13.101:9200/teacher222/</span><br><span class="line">&#123;</span><br><span class="line">    &quot;mappings&quot; :&#123;</span><br><span class="line">        &quot;properties&quot;:&#123;</span><br><span class="line">            &quot;ip_addr&quot;:&#123;</span><br><span class="line">                &quot;type&quot;:&quot;ip&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># 查看映射关系</span><br><span class="line">GET http://192.168.13.101:9200/teacher222/</span><br><span class="line"></span><br><span class="line"># 修改字段映射类型</span><br><span class="line">PUT http://192.168.13.101:9200/teacher222/_mapping</span><br><span class="line">&#123;</span><br><span class="line">        &quot;properties&quot;:&#123;</span><br><span class="line">            &quot;name&quot;:&#123;</span><br><span class="line">                &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">                &quot;index&quot;:&quot;true&quot;</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;gender&quot;:&#123;</span><br><span class="line">                &quot;type&quot;:&quot;text&quot;,</span><br><span class="line">                &quot;index&quot;:&quot;true&quot;  </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">keyword在搜索时必须完全匹配</span><br><span class="line">text可以模糊匹配</span><br><span class="line">如果不想基于字段搜索，设置index:false</span><br></pre></td></tr></table></figure>
<h3 id="分词器"><a class="markdownIt-Anchor" href="#分词器">#</a> 分词器</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.13.101:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;standard&quot;,</span><br><span class="line">    &quot;text&quot;: &quot;my name is sb&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#123;</span><br><span class="line">    &quot;tokens&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;my&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 0,</span><br><span class="line">            &quot;end_offset&quot;: 2,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 0</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;name&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 3,</span><br><span class="line">            &quot;end_offset&quot;: 7,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;is&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 8,</span><br><span class="line">            &quot;end_offset&quot;: 10,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 2</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;token&quot;: &quot;sb&quot;,</span><br><span class="line">            &quot;start_offset&quot;: 11,</span><br><span class="line">            &quot;end_offset&quot;: 13,</span><br><span class="line">            &quot;type&quot;: &quot;&lt;ALPHANUM&gt;&quot;,</span><br><span class="line">            &quot;position&quot;: 3</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">标准分词器默认使用空格和符号进行切割分词</span><br><span class="line">标准分词器默认使用单个汉字进行分割</span><br><span class="line"></span><br><span class="line">wget https://github.com/infinilabs/analysis-ik/releases/download/v7.17.3/elasticsearch-analysis-ik-7.17.3.zip</span><br><span class="line">unzip elasticsearch-analysis-ik-7.17.3.zip</span><br><span class="line">chown -R elasticsearch:elasticsearch /root/elasticsearch-7.17.3/plugins/ik/</span><br><span class="line">systemctl restart elasticsearch.service</span><br><span class="line"></span><br><span class="line">GET http://192.168.13.101:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;ik_max_word&quot;,				# 细粒度分词</span><br><span class="line">    &quot;text&quot;: &quot;我是警察&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GET http://192.168.13.101:9200/_analyze</span><br><span class="line">&#123;</span><br><span class="line">    &quot;analyzer&quot;: &quot;ik_smart&quot;,					# 粗粒度分词</span><br><span class="line">    &quot;text&quot;: &quot;我是警察&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 自定义字典</span><br><span class="line">在confi下创建一个dic文件，里面定义自己的词汇</span><br><span class="line"></span><br><span class="line">加载字典</span><br><span class="line">vim IKAnalyzer.cfg.xml </span><br><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE properties SYSTEM &quot;http://java.sun.com/dtd/properties.dtd&quot;&gt;</span><br><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;comment&gt;IK Analyzer 扩展配置&lt;/comment&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置自己的扩展字典 --&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_dict&quot;&gt;hahaha.dic&lt;/entry&gt;</span><br><span class="line">         &lt;!--用户可以在这里配置自己的扩展停止词字典--&gt;</span><br><span class="line">        &lt;entry key=&quot;ext_stopwords&quot;&gt;&lt;/entry&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展字典 --&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=&quot;remote_ext_dict&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">        &lt;!--用户可以在这里配置远程扩展停止词字典--&gt;</span><br><span class="line">        &lt;!-- &lt;entry key=&quot;remote_ext_stopwords&quot;&gt;words_location&lt;/entry&gt; --&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"></span><br><span class="line">重启es</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 自定义分词器</span><br><span class="line">PUT http://192.168.13.101:9200/hahaha</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">GET http://192.168.13.101:9200/_analyze</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240305121419839.png" alt="image-20240305121419839"></p>
<p>集群的每个节点都需要安装分词器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;戴尔（DELL）31.5英⼨ 4K 曲⾯ 内置⾳箱 低蓝光 影院级⾊彩 FreeSync技术 可壁挂 1800R 电脑显示器 S3221QS&quot;,</span><br><span class="line">    &quot;price&quot;: 3399.00,</span><br><span class="line">    &quot;brand&quot;: &quot;Dell&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;15.25kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100014940686.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;三星（SAMSUNG）28英⼨ 4K IPS 10.7亿⾊ 90%DCI-P3 Eyecomfort2.0认证 专业设计制图显示器（U28R550UQC）&quot;,</span><br><span class="line">    &quot;price&quot;: 2099.00,</span><br><span class="line">    &quot;brand&quot;: &quot;SAMSUNG&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;7.55kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100009558656.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;ALIENWARE外星⼈新品外设⾼端键⿏套装AW510K机械键盘cherry轴RGB/AW610M 610M ⽆线⿏标+510K机械键盘+510H⽿机&quot;,</span><br><span class="line">    &quot;price&quot;: 6000.00,</span><br><span class="line">    &quot;brand&quot;: &quot;ALIENWARE外星⼈&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10030370257612.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;:&quot;樱桃CHERRY MX8.0彩光87键游戏机械键盘合⾦⼥⽣樱粉⾊版 彩光-粉⾊红轴粉⾊箱 官⽅标配&quot;,</span><br><span class="line">    &quot;price&quot;: 4066.00,</span><br><span class="line">    &quot;brand&quot;: &quot;樱桃CHERRY&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10024385308012.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;罗技（G）G610机械键盘 有线机械键盘 游戏机械键盘 全尺⼨背光机械键盘 吃鸡键盘 Cherry红轴&quot;,</span><br><span class="line">    &quot;price&quot;: 429.00,</span><br><span class="line">    &quot;brand&quot;: &quot;罗技&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.627kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/3378484.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;美商海盗船（USCORSAIR）K68机械键盘⿊⾊ 防⽔防尘樱桃轴体 炫彩背光游戏有线 红光红轴&quot;,</span><br><span class="line">    &quot;price&quot;: 499.00,</span><br><span class="line">    &quot;brand&quot;: &quot;美商海盗船&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.41kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/43580479783.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;雷蛇(Razer) 蝰蛇标准版 ⿏标 有线⿏标 游戏⿏标 ⼈体⼯程学 电竞 ⿊⾊6400DPI lol吃鸡神器cf&quot;,</span><br><span class="line">    &quot;price&quot;: 109.00,</span><br><span class="line">    &quot;brand&quot;: &quot;雷蛇&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;185.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/8141909.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;罗技（G）G502 HERO主宰者有线⿏标 游戏⿏标 HERO引擎 RGB⿏标 电竞⿏标 25600DPI&quot;,</span><br><span class="line">    &quot;price&quot;: 299.00,</span><br><span class="line">    &quot;brand&quot;: &quot;罗技&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;250.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100001691967.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;武极 i5 10400F/GTX1050Ti/256G游戏台式办公电脑主机DIY组装机&quot;,</span><br><span class="line">    &quot;price&quot;: 4099.00,</span><br><span class="line">    &quot;brand&quot;: &quot;武极&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;5.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/1239166056.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;变异者 组装电脑主机DIY台式游戏 i5 9400F/16G/GTX1050Ti 战胜G1&quot;,</span><br><span class="line">    &quot;price&quot;: 4299.00,</span><br><span class="line">    &quot;brand&quot;: &quot;变异者&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;9.61kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/41842373306.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;宏碁(Acer) 暗影骑⼠·威N50-N92 英特尔酷睿i5游戏台机 吃鸡电脑主机(⼗⼀代i5-11400F 16G 256G+1T GTX1650)&quot;,</span><br><span class="line">    &quot;price&quot;: 5299.00,</span><br><span class="line">    &quot;brand&quot;: &quot;宏碁&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;7.25kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100020726324.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;京天 酷睿i7 10700F/RTX2060/16G内存 吃鸡游戏台式电脑主机DIY组装机&quot;,</span><br><span class="line">    &quot;price&quot;: 7999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;京天&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;10.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/40808512828.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;戴尔（DELL）OptiPlex 3070MFF/3080MFF微型台式机电脑迷你⼩主机客厅HTPC 标配 i5-10500T/8G/1T+256G 内置WiFi+蓝⽛ 全国联保 三年上⻔&quot;,</span><br><span class="line">    &quot;price&quot;: 3999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;DELL&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;2.85kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10025304273651.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;伊萌纯种英短蓝⽩猫活体猫咪幼猫活体英国短⽑猫矮脚猫英短蓝猫幼体银渐层蓝⽩活体宠物蓝猫幼崽猫咪宠物猫短 双⾎统A级 ⺟&quot;,</span><br><span class="line">    &quot;price&quot;: 4000.00,</span><br><span class="line">    &quot;brand&quot;: &quot;英短&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10027188382742.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;柴墨 ⾦渐层幼猫英短猫宠物猫英短⾦渐层猫咪活体猫活体纯种⼩猫银渐层 双⾎统&quot;,</span><br><span class="line">    &quot;price&quot;: 12000.00,</span><br><span class="line">    &quot;brand&quot;: &quot;英短&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;3.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10029312412476.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Redmi Note10 Pro 游戏智能5G⼿机 ⼩⽶ 红⽶&quot;,</span><br><span class="line">    &quot;price&quot;: 9999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;⼩⽶&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;10.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100021970002.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;【⼆⼿99新】⼩⽶Max3⼿机⼆⼿⼿机 ⼤屏安卓 曜⽯⿊ 6G+128G 全⽹通&quot;,</span><br><span class="line">    &quot;price&quot;: 1046.00,</span><br><span class="line">    &quot;brand&quot;: &quot;⼩⽶&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;0.75kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/35569092038.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;现货速发（10天价保）⼩⽶11 5G⼿机 骁⻰888 游戏智能⼿机 PRO店内可选⿊⾊ 套装版 12GB+256GB&quot;,</span><br><span class="line">    &quot;price&quot;: 4699.00,</span><br><span class="line">    &quot;brand&quot;: &quot;⼩⽶&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;0.7kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10025836790851.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;⼩⽶⼿环6 NFC版 全⾯彩屏 30种运动模式 24h⼼率检测 50⽶防⽔ 智能⼿环&quot;,</span><br><span class="line">    &quot;price&quot;: 279.00,</span><br><span class="line">    &quot;brand&quot;: &quot;⼩⽶&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;65.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100019867468.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;HUAWEI MateView⽆线原⾊显示器⽆线版 28.2英⼨ 4K+ IPS 98% DCI-P3 10.7亿⾊ HDR400 TypeC 双扬声器 双MIC&quot;,</span><br><span class="line">    &quot;price&quot;: 4699.00,</span><br><span class="line">    &quot;brand&quot;: &quot;华为&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;9.8kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100021420806.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;华为nova7se/nova7 se 5G⼿机（ 12期免息可选 ）下单享好礼 绮境森林乐活版 8G+128G（1年碎屏险）&quot;,</span><br><span class="line">    &quot;price&quot;: 2999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;华为&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;500.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10029312412476.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;华为HUAWEI FreeBuds 4i主动降噪 ⼊⽿式真⽆线蓝⽛⽿机/通话降噪/⻓续航/⼩巧舒适 Android&amp;ios通⽤ 陶瓷⽩&quot;,</span><br><span class="line">    &quot;price&quot;: 479.00,</span><br><span class="line">    &quot;brand&quot;: &quot;华为&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;137.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100018510746.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;HUAWEI WATCH GT2 华为⼿表 运动智能⼿表 两周⻓续航/蓝⽛通话/⾎氧检测/麒麟芯⽚ 华为gt2 46mm 曜⽯⿊&quot;,</span><br><span class="line">    &quot;price&quot;: 1488.00,</span><br><span class="line">    &quot;brand&quot;: &quot;华为&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;335.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100008492922.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Apple苹果12 mini iPhone 12 mini 5G ⼿机（现货速发 12期免息可选）蓝⾊ 5G版 64G&quot;,</span><br><span class="line">    &quot;price&quot;: 4699.00,</span><br><span class="line">    &quot;brand&quot;: &quot;苹果&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;280.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10026100075337.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;Apple iPhone 12 (A2404) 128GB 紫⾊ ⽀持移动联通电信5G 双卡双待⼿机&quot;,</span><br><span class="line">    &quot;price&quot;: 6799.00,</span><br><span class="line">    &quot;brand&quot;: &quot;苹果&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;330.00g&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100011203359.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;华硕ROG冰刃双屏 ⼗代英特尔酷睿 15.6英⼨液⾦导热300Hz电竞游戏笔记本电脑 i9-10980H 32G 2T RTX2080S&quot;,</span><br><span class="line">    &quot;price&quot;: 48999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;华硕&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;2.5kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10021558215658.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;联想⼩新Air15 2021超轻薄笔记本电脑 ⾼⾊域学⽣办公设计师游戏本 ⼋核锐⻰R7-5700U 16G内存 512G固态 升级15.6英⼨IPS全⾯屏【DC调光护眼⽆闪烁&quot;,</span><br><span class="line">    &quot;price&quot;: 5499.00,</span><br><span class="line">    &quot;brand&quot;: &quot;苹果&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;10.0kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/33950552707.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;苹果（Apple）MacBook Air 13.3英⼨ 笔记本电脑 【2020款商务灰】⼗代i7 16G 512G 官⽅标配 19点前付款当天发货&quot;,</span><br><span class="line">    &quot;price&quot;: 10498.00,</span><br><span class="line">    &quot;brand&quot;: &quot;苹果&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.29kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/10021130510120.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;科⼤讯⻜机器⼈ 阿尔法蛋A10智能机器⼈ 专业教育⼈⼯智能编程机器⼈学习机智能可编程 ⽩⾊&quot;,</span><br><span class="line">    &quot;price&quot;: 1099.00,</span><br><span class="line">    &quot;brand&quot;: &quot;科⼤讯⻜&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;1.7kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100005324258.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;robosen乐森机器⼈六⼀⼉童节礼物⾃营孩⼦玩具星际特⼯智能编程机器⼈⼉童语⾳控制陪伴益智变形机器⼈&quot;,</span><br><span class="line">    &quot;price&quot;: 2499.00,</span><br><span class="line">    &quot;brand&quot;: &quot;senpowerT9-X&quot;,</span><br><span class="line">    &quot;weight&quot;: &quot;3.01kg&quot;,</span><br><span class="line">    &quot;item&quot;: &quot;https://item.jd.com/100006740372.html&quot;</span><br><span class="line">&#125;,</span><br><span class="line">&#123;</span><br><span class="line">    &quot;title&quot;: &quot;优必选（UBTECH）悟空智能语⾳监控对话⼈形机器⼈⼉童教育陪伴早教学习机玩具&quot;,</span><br><span class="line">    &quot;price&quot;: 4999.00,</span><br><span class="line">    &quot;brand&quot;: &quot;优必选悟空&quot;,</span><br><span class="line">    &quot;weigth&quot;: &quot;1.21kg&quot;,</span><br><span class="line"> &quot;item&quot;: &quot;https://item.jd.com/100000722348.html&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"># 查看索引模板</span><br><span class="line">GET　http://192.168.13.101:9200/_template</span><br><span class="line"></span><br><span class="line"># 查看单个索引模板</span><br><span class="line">GET http://192.168.13.101:9200/_template/.monitoring-es</span><br><span class="line"></span><br><span class="line"># 创建/修改索引模板</span><br><span class="line">POST http://192.168.13.101:9200/_template/uuuuuu</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index_patterns&quot;:[</span><br><span class="line">        &quot;hahaha*&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;settings&quot;: &#123;</span><br><span class="line">        &quot;index&quot;: &#123;</span><br><span class="line">            &quot;number_of_shards&quot;: &quot;3&quot;,</span><br><span class="line">            &quot;number_of_replicas&quot;: &quot;1&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;mappings&quot;:&#123;</span><br><span class="line">        &quot;properties&quot; :&#123;</span><br><span class="line">            &quot;ip_addr&quot;:&#123;</span><br><span class="line">                &quot;type&quot;:&quot;ip&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line">索引模板只对新创建的索引生效</span><br><span class="line"></span><br><span class="line"># 删除索引模板</span><br><span class="line">DELETE http://192.168.13.101:9200/_template/uuuuuu</span><br></pre></td></tr></table></figure>
<h2 id="dsl"><a class="markdownIt-Anchor" href="#dsl">#</a> DSL</h2>
<p>Elasticsearch 提供了基于 JSON 的完整 Query DSL (Domain Specific Language) 来定义查询。</p>
<h3 id="全文类型检索"><a class="markdownIt-Anchor" href="#全文类型检索">#</a> 全文类型检索</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># match查询</span><br><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;brand&quot;:&quot;优必选悟空&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">逻辑是对中文进行分词</span><br></pre></td></tr></table></figure>
<h3 id="完全匹配"><a class="markdownIt-Anchor" href="#完全匹配">#</a> 完全匹配</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match_phrase&quot;:&#123;</span><br><span class="line">            &quot;brand&quot;:&quot;优必选悟空&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="全量查询"><a class="markdownIt-Anchor" href="#全量查询">#</a> 全量查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">POST http://10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">     &quot;query&quot;: &#123;</span><br><span class="line">     &quot;match_all&quot; : &#123;&#125;</span><br><span class="line">     &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="分页查询"><a class="markdownIt-Anchor" href="#分页查询">#</a> 分页查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;size:7,</span><br><span class="line">    &quot;from&quot;:28</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">size:</span><br><span class="line">指定每页显示多少条数据，默认值为10.</span><br><span class="line">from:</span><br><span class="line">指定跳过数据偏移量的大小，默认值为0，即默认看第一页。查询指定页码的from值=&quot;(页码-1)*每页数据大小(size)</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match_all&quot;:&#123;&#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;size:7,</span><br><span class="line">    &quot;from&quot;:28,</span><br><span class="line">    &quot;_source&quot;:[&quot;brand&quot;,&quot;price&quot;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">_source:指定只查看哪些字段</span><br></pre></td></tr></table></figure>
<h3 id="查询包含指定字段文档"><a class="markdownIt-Anchor" href="#查询包含指定字段文档">#</a> 查询包含指定字段文档</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;exists&quot;:&#123;</span><br><span class="line">        	&quot;field&quot;:&quot;hobby&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">返回包含指定字段的文档</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="语法高亮"><a class="markdownIt-Anchor" href="#语法高亮">#</a> 语法高亮</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;brand&quot;:&quot;优必选悟空&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;:&#123;</span><br><span class="line">    	&quot;pre_tags&quot;:[&quot;&lt;h1&gt;&quot;],</span><br><span class="line">    	&quot;post_tags&quot;:[&quot;&lt;/h1&gt;&quot;]</span><br><span class="line">    	&quot;fields&quot;:&#123;</span><br><span class="line">    		&quot;brand&quot;:&#123;&#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字段排序"><a class="markdownIt-Anchor" href="#字段排序">#</a> 字段排序</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">POST http://192.168.13.101:9200/shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;:&#123;</span><br><span class="line">        &quot;match&quot;:&#123;</span><br><span class="line">            &quot;brand&quot;:&quot;优必选悟空&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;sort&quot;:&#123;</span><br><span class="line">    	&quot;price&quot;:&#123;</span><br><span class="line">    		&quot;order&quot;:asc&quot;&quot;</span><br><span class="line">    	&#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">asc</span><br><span class="line">desc</span><br></pre></td></tr></table></figure>
<h3 id="多条件查询"><a class="markdownIt-Anchor" href="#多条件查询">#</a> 多条件查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">POST http://10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_phrase&quot;: &#123;</span><br><span class="line">                        &quot;brand&quot;: &quot; 苹果&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match&quot;: &#123;</span><br><span class="line">                        &quot;price&quot;: 5499</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">must,must_not,should</span><br><span class="line">最少匹配条件&quot;minimum_should_match&quot;: 2</span><br><span class="line"></span><br><span class="line">POST http://10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_phrase&quot;: &#123;</span><br><span class="line">                        &quot;brand&quot;: &quot; 苹果&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match&quot;: &#123;</span><br><span class="line">                        &quot;price&quot;: 5499</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;minimum_should_match&quot;: 2</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> bool:</span><br><span class="line"> 可以匹配多个条件查询。其中有&quot;must&quot;，&quot;must_not&quot;,&quot;should&quot;。</span><br><span class="line"> &quot;must&quot;</span><br><span class="line"> 必须匹配的条件。</span><br><span class="line"> &quot;must_not&quot;</span><br><span class="line"> 必须不匹配的条件，即和must相反。</span><br><span class="line"> &quot;should&quot;</span><br><span class="line"> 不是必要条件，满⾜其中之⼀即可，可以使⽤&quot;minimum_should_match&quot;来限制满⾜</span><br><span class="line">要求的条件数量。</span><br></pre></td></tr></table></figure>
<h3 id="范围查询"><a class="markdownIt-Anchor" href="#范围查询">#</a> 范围查询</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">POST http: //10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_phrase&quot;: &#123;</span><br><span class="line">                        &quot;brand&quot;: &quot; 苹果&quot;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;filter&quot;: &#123;</span><br><span class="line">                &quot;range&quot;: &#123;</span><br><span class="line">                    &quot;price&quot;: &#123;</span><br><span class="line">                        &quot;gt&quot;: 5000,</span><br><span class="line">                        &quot;lt&quot;: 8000</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="精确匹配"><a class="markdownIt-Anchor" href="#精确匹配">#</a> 精确匹配</h3>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">POST http<span class="punctuation">:</span><span class="comment">//10.0.0.103:9200/oldboyedu-shopping/_search</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;query&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        <span class="attr">&quot;terms&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;price&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">                <span class="number">4699</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">299</span><span class="punctuation">,</span></span><br><span class="line">                <span class="number">4066</span></span><br><span class="line">            <span class="punctuation">]</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">term匹配一个</span><br><span class="line">terms匹配多个</span><br></pre></td></tr></table></figure>
<h3 id="多词搜索"><a class="markdownIt-Anchor" href="#多词搜索">#</a> 多词搜索</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">POST http: //10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match&quot;: &#123;</span><br><span class="line">                        &quot;title&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &quot;显示器曲⾯&quot;,</span><br><span class="line">                            &quot;operator&quot;: &quot;and&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;: &#123;</span><br><span class="line">        &quot;pre_tags&quot;: [</span><br><span class="line">            &quot;&lt;h1&gt;&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;post_tags&quot;: [</span><br><span class="line">            &quot;&lt;/h1&gt;&quot;</span><br><span class="line">        ],</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&quot;operator&quot;设置为&quot;and&quot;则⽂档必须包含&quot;query&quot;中的所有词汇，&quot;operator&quot;的默认值为&quot;or&quot;。</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="权重"><a class="markdownIt-Anchor" href="#权重">#</a> 权重</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">POST http: //10.0.0.103:9200/oldboyedu-shopping/_search</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;bool&quot;: &#123;</span><br><span class="line">            &quot;must&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match&quot;: &#123;</span><br><span class="line">                        &quot;brand&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &quot;⼩苹华&quot;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ],</span><br><span class="line">            &quot;should&quot;: [</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_phrase&quot;: &#123;</span><br><span class="line">                        &quot;title&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &quot;防⽔&quot;,</span><br><span class="line">                            &quot;boost&quot;: 2</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                &#123;</span><br><span class="line">                    &quot;match_phrase&quot;: &#123;</span><br><span class="line">                        &quot;title&quot;: &#123;</span><br><span class="line">                            &quot;query&quot;: &quot;⿊⾊&quot;,</span><br><span class="line">                            &quot;boost&quot;: 10</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;highlight&quot;: &#123;</span><br><span class="line">        &quot;fields&quot;: &#123;</span><br><span class="line">            &quot;title&quot;: &#123;&#125;,</span><br><span class="line">            &quot;brand&quot;: &#123;&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;_source&quot;: &quot;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="聚合"><a class="markdownIt-Anchor" href="#聚合">#</a> 聚合</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">POST http: //10.0.0.103:9200/oldboyedu-shopping/_search # 统计每个品牌的数量。</span><br><span class="line">&#123;</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;oldboyedu_brand_group&quot;: &#123;</span><br><span class="line">            &quot;terms&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;brand.keyword&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;size&quot;: 0</span><br><span class="line">&#125;</span><br><span class="line">POST http: //10.0.0.103:9200/oldboyedu-shopping/_search # 统计苹果商品中最贵的。</span><br><span class="line">&#123;</span><br><span class="line">    &quot;query&quot;: &#123;</span><br><span class="line">        &quot;match_phrase&quot;: &#123;</span><br><span class="line">            &quot;brand&quot;: &quot;苹果&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;aggs&quot;: &#123;</span><br><span class="line">        &quot;oldboyedu_max_shopping&quot;: &#123;</span><br><span class="line">            &quot;max&quot;: &#123;</span><br><span class="line">                &quot;field&quot;: &quot;price&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;size&quot;: 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="es集群迁移"><a class="markdownIt-Anchor" href="#es集群迁移">#</a> es 集群迁移</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">wget https://artifacts.elastic.co/downloads/elasticsearch/elasticsearch-6.8.23.tar.gz</span><br><span class="line">tar xzvf elasticsearch-6.8.23.tar.gz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cluster.name: es-6</span><br><span class="line">node.name: elk-101</span><br><span class="line">path.data: /data/data</span><br><span class="line">path.logs: /data/logs</span><br><span class="line">network.host: 0.0.0.0</span><br><span class="line">http.port: 19200</span><br><span class="line">transport.tcp.port: 19300</span><br><span class="line">discovery.zen.ping.unicast.hosts: [&quot;elk101&quot;, &quot;elk102&quot;, &quot;elk103&quot;]</span><br><span class="line">discovery.zen.minimum_master_nodes: 2</span><br><span class="line"></span><br><span class="line">chown -R elasticsearch:elasticsearch /data/</span><br><span class="line">chown elasticsearch:elasticsearch /root/elasticsearch-6.8.23 -R</span><br><span class="line"></span><br><span class="line"># 同步目录到其他节点</span><br><span class="line">data_rsync.sh /root/elasticsearch-6.8.23</span><br><span class="line"></span><br><span class="line">cp /etc/systemd/system/elasticsearch.service /etc/systemd/system/elasticsearch7.service</span><br><span class="line">cp /etc/systemd/system/elasticsearch7.service /etc/systemd/system/elasticsearch6.service</span><br><span class="line"></span><br><span class="line">[Unit]</span><br><span class="line">Description=Elasticsearch</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">User=elasticsearch</span><br><span class="line">LimitMEMLOCK=infinity</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">WorkingDirectory=/root/elasticsearch-6.8.23</span><br><span class="line">ExecStart=/root/elasticsearch-6.8.23/bin/elasticsearch</span><br><span class="line">Restart=on-failure</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl daemon-reload</span><br><span class="line">systemctl restart elasticsearch6.service</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"># 同集群迁移</span><br><span class="line">POST http://192.168.13.101:9200/_reindex</span><br><span class="line">&#123;</span><br><span class="line">    &quot;source&quot;:&#123;</span><br><span class="line">        &quot;index&quot;:&quot;shopping&quot;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dest&quot;:&#123;</span><br><span class="line">        &quot;index&quot;:&quot;shopping-new&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 跨集群迁移</span><br><span class="line">编辑原集群配置文件</span><br><span class="line">echo reindex.remote.whitelist: \&quot;*:*\&quot; &gt;&gt; elasticsearch.yml</span><br><span class="line">systemctl restart elasticsearch6</span><br><span class="line">POST http://192.168.13.101:9200/_reindex</span><br><span class="line">&#123;</span><br><span class="line">    &quot;source&quot;:&#123;</span><br><span class="line">        &quot;index&quot;:&quot;shopping&quot;,</span><br><span class="line">        &quot;remote&quot;:&#123;</span><br><span class="line">            &quot;host&quot;:&quot;http://192.168.13.101:19200&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;query&quot;:&#123;</span><br><span class="line">        	&quot;match&quot;:&#123;</span><br><span class="line">        		&quot;brand&quot;:&quot;haha&quot;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;dest&quot;:&#123;</span><br><span class="line">        &quot;index&quot;:&quot;shopping-new&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">把19200的数据迁移到9200，注意修改19200的配置文件，加上reindex</span><br><span class="line"></span><br><span class="line">可以在迁移的时候使用query，决定迁移哪些数据</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="logstash实现集群迁移"><a class="markdownIt-Anchor" href="#logstash实现集群迁移">#</a> logstash 实现集群迁移</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	index =&gt; &quot;shopping&quot;</span><br><span class="line">	hosts =&gt; &quot;192.168.13.101:19200&quot;</span><br><span class="line">	query =&gt; &#x27;&#123;&quot;query&quot;: &#123;&quot;match_phrase&quot;:&#123;&quot;brand&quot;:&quot;dell&quot;&#125;&#125;,&quot;sort&quot;:[&quot;_doc&quot;]&#125;&#x27;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		index =&gt; &quot;ooo&quot;</span><br><span class="line">		hosts =&gt; &quot;192.168.13.101:9200&quot;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="es-健康api"><a class="markdownIt-Anchor" href="#es-健康api">#</a> es 健康 api</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"># 集群状态</span><br><span class="line">http://192.168.13.101:9200/_cluster/health </span><br><span class="line">&#123;</span><br><span class="line">    &quot;cluster_name&quot;: &quot;elk&quot;,</span><br><span class="line">    &quot;status&quot;: &quot;green&quot;,</span><br><span class="line">    &quot;timed_out&quot;: false,</span><br><span class="line">    &quot;number_of_nodes&quot;: 3,</span><br><span class="line">    &quot;number_of_data_nodes&quot;: 3,</span><br><span class="line">    &quot;active_primary_shards&quot;: 16,</span><br><span class="line">    &quot;active_shards&quot;: 32,</span><br><span class="line">    &quot;relocating_shards&quot;: 0,</span><br><span class="line">    &quot;initializing_shards&quot;: 0,</span><br><span class="line">    &quot;unassigned_shards&quot;: 0,</span><br><span class="line">    &quot;delayed_unassigned_shards&quot;: 0,</span><br><span class="line">    &quot;number_of_pending_tasks&quot;: 0,</span><br><span class="line">    &quot;number_of_in_flight_fetch&quot;: 0,</span><br><span class="line">    &quot;task_max_waiting_in_queue_millis&quot;: 0,</span><br><span class="line">    &quot;active_shards_percent_as_number&quot;: 100.0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Green</span><br><span class="line">所有分片都已分配。</span><br><span class="line">yellow</span><br><span class="line">所有主分片都已分配，但一个或多个副本分片未分配。如果集群中的某个节点发生故障，则在修复该节点之前，某些数据可能不可用。</span><br><span class="line">red</span><br><span class="line">一个或多个主分片未分配，因此某些数据不可用。这可能会在集群启动期间短暂发生，因为分配了主分片。</span><br><span class="line"></span><br><span class="line">查看详细分片状态</span><br><span class="line">curl http://192.168.13.101:9200/_cluster/health?level=shards | jq </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 集群详细信息</span><br><span class="line">http://192.168.13.101:9200/_cluster/settings?include_defaults</span><br><span class="line">http://192.168.13.101:9200/_cluster/settings?include_defaults=true&amp;flat_settings=true</span><br></pre></td></tr></table></figure>
<h3 id="集群更新设置"><a class="markdownIt-Anchor" href="#集群更新设置">#</a> 集群更新设置</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">如果您使用多种方法配置相同的设置，Elasticsearch会按以下优先顺序应用这些设置</span><br><span class="line">Transient setting</span><br><span class="line">Persistent setting</span><br><span class="line">elasticsearch.yml setting</span><br><span class="line">Default setting value</span><br><span class="line"></span><br><span class="line">PUT http://192.168.13.101:9200/_cluster/settings</span><br><span class="line">&#123;</span><br><span class="line">    &quot;persistent&quot;:&#123;</span><br><span class="line">        &quot;indices.recovery.max_bytes_per_sec&quot;:&quot;50mb&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#x27;cluster.routing.allocation.enable&quot; :</span><br><span class="line">&quot;all&quot;:</span><br><span class="line">允许所有分片类型进行分配。</span><br><span class="line">&quot;primaries&quot;</span><br><span class="line">仅允许分配主分片。</span><br><span class="line">&quot;new&quot;</span><br><span class="line">仅允许新索引分配主分片</span><br><span class="line">&quot;none&quot;</span><br><span class="line">不允许分配任何类型的分片</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="集群state"><a class="markdownIt-Anchor" href="#集群state">#</a> 集群 state</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.13.101:9200/_cluster/state</span><br><span class="line">GET http://192.168.13.101:9200/_cluster/state/nodes		# 返回node内容</span><br><span class="line">GET http://192.168.13.101:9200/_cluster/state/nodes,version/shopping* 	# 查看索引shopping* 的nodes和version信息		</span><br></pre></td></tr></table></figure>
<h3 id="集群stats统计信息"><a class="markdownIt-Anchor" href="#集群stats统计信息">#</a> 集群 stats 统计信息</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GET http://192.168.13.101:9200/_cluster/stats</span><br><span class="line">GET http://192.168.13.101:9200/_cluster/stats/nodes/elk101</span><br></pre></td></tr></table></figure>
<h3 id="集群分片分配情况"><a class="markdownIt-Anchor" href="#集群分片分配情况">#</a> 集群分片分配情况</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">集群分配解释API的目的是为集群中的分片分配提供解释。</span><br><span class="line">对于未分配的分片，解释 API 提供了有关未分配分片的原因的解释。</span><br><span class="line">对于分配的分片，解释 API解释了为什么分片保留在其当前节点上并且没有移动或重新平衡到另一个节点。</span><br><span class="line"></span><br><span class="line">GET   http://192.168.13.101:9200/_cluster/allocation/explain</span><br><span class="line">&#123;</span><br><span class="line">    &quot;index&quot;:&quot;hahaha-new&quot;,</span><br><span class="line">    &quot;shard&quot;:0,</span><br><span class="line">    &quot;primary&quot;:&quot;true&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="reroute-api"><a class="markdownIt-Anchor" href="#reroute-api">#</a> reroute api</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">reroute 命令允许手动更改集群中各个分片的分配。例如，可以将分片从一个节点显式移动到另一个节点，可以取消分配，并且可以将未分</span><br><span class="line">配的分片显式分配给特定节点。</span><br><span class="line"></span><br><span class="line">POST http://192.168.13.101:9200/_cluster/reroute</span><br><span class="line">&#123;</span><br><span class="line">    &quot;commands&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;move&quot;: &#123;</span><br><span class="line">                &quot;index&quot;: &quot;teacher&quot;,</span><br><span class="line">                &quot;shard&quot;: 0,</span><br><span class="line">                &quot;from_node&quot;: &quot;elk102&quot;,</span><br><span class="line">                &quot;to_node&quot;: &quot;elk101&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="集群角色"><a class="markdownIt-Anchor" href="#集群角色">#</a> 集群角色</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">node.role  </span><br><span class="line">cdfhilmrstw </span><br><span class="line"></span><br><span class="line">⻆⾊说明:</span><br><span class="line"> c :</span><br><span class="line"> Cold data </span><br><span class="line"> d :</span><br><span class="line"> data node</span><br><span class="line"> f : </span><br><span class="line"> frozen node</span><br><span class="line"> h :</span><br><span class="line"> hot node</span><br><span class="line"> i : </span><br><span class="line"> ingest node</span><br><span class="line"> l : </span><br><span class="line"> machine learning node</span><br><span class="line"> m :</span><br><span class="line"> master eligible node</span><br><span class="line"> r :</span><br><span class="line"> remote cluster client node</span><br><span class="line"> s :</span><br><span class="line"> content node</span><br><span class="line"> t :</span><br><span class="line"> transform node</span><br><span class="line"> v :</span><br><span class="line"> voting-only node</span><br><span class="line"> w :</span><br><span class="line"> warm node</span><br><span class="line"> - : </span><br><span class="line"> coordinating node only</span><br><span class="line">常⽤的⻆⾊说明:</span><br><span class="line"> data node:</span><br><span class="line"> 指的是存储数据的节点。</span><br><span class="line"> node.data: true</span><br><span class="line"> master node:</span><br><span class="line"> 控制ES集群，并维护集群的状态(cluster state，包括节点信息，索引信息等，ES</span><br><span class="line">集群每个节点都有⼀份)。</span><br><span class="line"> node.master: true</span><br><span class="line"> coordinating:</span><br><span class="line"> 协调节点可以处理请求的节点，ES集群所有的节点均为协调节点，该⻆⾊⽆法取消。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240310164635140.png" alt="image-20240310164635140"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240310165658810.png" alt="image-20240310165658810"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240310174634804.png" alt="image-20240310174634804"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240312223812350.png" alt="image-20240312223812350"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240312224711763.png" alt="image-20240312224711763"></p>
<h3 id="乐观锁"><a class="markdownIt-Anchor" href="#乐观锁">#</a> 乐观锁</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">POST http://1.1.1.1:9200/index_exp/_doc/10001/?version=3&amp;versin_type=external</span><br><span class="line"></span><br><span class="line">POST http://1.1.1.1:9200/index_exp/_doc/10001/_update?if_seq_no=0&amp;if_primary_term=1</span><br></pre></td></tr></table></figure>
<h3 id="tls"><a class="markdownIt-Anchor" href="#tls">#</a> tls</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">bin/elasticsearch-certutil ca</span><br><span class="line">#一直enter</span><br><span class="line">bin/elasticsearch-certutil cert --ca elastic-stack-ca.p12</span><br><span class="line"> #一直enter</span><br><span class="line"></span><br><span class="line">chown elasticsearch:elasticsearch elastic.p12</span><br><span class="line"></span><br><span class="line">vim elasticsearch.yml</span><br><span class="line">xpack.security.enabled: true</span><br><span class="line">xpack.security.transport.ssl.enabled: true</span><br><span class="line">xpack.security.transport.ssl.verification_mode: certificate</span><br><span class="line">xpack.security.transport.ssl.keystore.path: /root/elasticsearch-7.17.3/config/elastic-certificates.p12</span><br><span class="line">xpack.security.transport.ssl.truststore.path: /root/elasticsearch-7.17.3/config/elastic-certificates.p12</span><br><span class="line"></span><br><span class="line">Changed password for user apm_system</span><br><span class="line">PASSWORD apm_system = 9sWQlhJehyYKrueHVD6h</span><br><span class="line"></span><br><span class="line">Changed password for user kibana_system</span><br><span class="line">PASSWORD kibana_system = E6evsbrrupM1ub90Uq58</span><br><span class="line"></span><br><span class="line">Changed password for user kibana</span><br><span class="line">PASSWORD kibana = E6evsbrrupM1ub90Uq58</span><br><span class="line"></span><br><span class="line">Changed password for user logstash_system</span><br><span class="line">PASSWORD logstash_system = aZlM0Wx3EgdD7Cn0oIyQ</span><br><span class="line"></span><br><span class="line">Changed password for user beats_system</span><br><span class="line">PASSWORD beats_system = sPUcXLl62KpC9apCDnLO</span><br><span class="line"></span><br><span class="line">Changed password for user remote_monitoring_user</span><br><span class="line">PASSWORD remote_monitoring_user = 82axLeZr4vvSMFhfZAqh</span><br><span class="line"></span><br><span class="line">Changed password for user elastic</span><br><span class="line">PASSWORD elastic = lPXaVbZBHvVdUcpI1bCQ</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC9kMTNiNjA3NGI1NDU=">https://www.jianshu.com/p/d13b6074b545</span></p>
<p>注意文件所属着和所属组，证书一定要在 config 下面</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240313223859472.png" alt="image-20240313223859472"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 ~/elasticsearch-7.17.3]$ vim /root/kibana-7.17.3-linux-x86_64/config/kibana.yml </span><br><span class="line"></span><br><span class="line">elasticsearch.username: &quot;kibana_system&quot;</span><br><span class="line">elasticsearch.password: &quot;E6evsbrrupM1ub90Uq58&quot;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240313224316040.png" alt="image-20240313224316040"></p>
<h3 id="rbac"><a class="markdownIt-Anchor" href="#rbac">#</a> RBAC</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240316134801880.png" alt="image-20240316134801880"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240316135708419.png" alt="image-20240316135708419"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">input &#123;</span><br><span class="line">	stdin&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">	elasticsearch &#123;</span><br><span class="line">		index =&gt; &quot;1111&quot;</span><br><span class="line">		hosts =&gt; &quot;10.0.0.101:9200&quot;</span><br><span class="line">		user =&gt; &quot;elastic&quot;</span><br><span class="line">		password =&gt; &quot;xxxx&quot;</span><br><span class="line">	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">创建一个低权限用户来管理</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">filebeat.inputs:</span><br><span class="line">- type: stdin</span><br><span class="line">  tags: [&quot;stdin&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output.elasticsearch:</span><br><span class="line">  hosts: [&quot;http://elk101:9200&quot;, &quot;http://elk102:9200&quot;, &quot;http://elk103:9200&quot;]</span><br><span class="line">  enabled: true</span><br><span class="line">  index: &quot;hahaha-xixi-tomcat-error-%&#123;+yyyy.MM.dd&#125;&quot;</span><br><span class="line">  username: &quot;elastic&quot;</span><br><span class="line">  password: &quot;zzz&quot;</span><br><span class="line"></span><br><span class="line"># 设置索引模板的名称      </span><br><span class="line">setup.template.name: &quot;hahaha&quot;</span><br><span class="line"># 设置索引模板的匹配模式</span><br><span class="line">setup.template.pattern: &quot;hahaha-xixi*&quot;</span><br><span class="line"># 禁用索引生命周期管理</span><br><span class="line">setup.ilm.enabled: false</span><br><span class="line"># 覆盖已有的索引模板</span><br><span class="line">setup.template.overwrite: true</span><br><span class="line">setup.template.settings:</span><br><span class="line">  index.number_of_shards: 3</span><br><span class="line">  index.number_of_replicas: 0</span><br><span class="line">  </span><br><span class="line">不建议使用elastic管理员用户</span><br></pre></td></tr></table></figure>
<h2 id="kafka"><a class="markdownIt-Anchor" href="#kafka">#</a> kafka</h2>
<p>filebeat 一般在靠近数据源测，易扩展</p>
<p>为了解决 logstash 的性能瓶颈，有三种解决方案</p>
<p>垂直扩容 - 升级单节点硬件设备 价钱昂贵，可能存在单点故障，容易达到硬件上限</p>
<p>水平扩容 - 加机器  - 缺点：高峰时期服务器利用率低</p>
<p>增加 MQ</p>
<p>消息队列:<br>
 使用消息队列解耦，缓冲数据，数据削峰</p>
<p>消息队列是在消息传输过程中保存消息的容器，多用于分布式系统之间进行通信。</p>
<p>劣势：</p>
<p>可靠性降低</p>
<p>系统复杂度提高</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317175359357.png" alt="image-20240317175359357"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317175522234.png" alt="image-20240317175522234"></p>
<h3 id="工作模式"><a class="markdownIt-Anchor" href="#工作模式">#</a> 工作模式</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">点对点模式:</span><br><span class="line"> ⼀对⼀，消费者主动拉取数据，消息接受后消息会被删除</span><br><span class="line"> </span><br><span class="line">发布/订阅模式:</span><br><span class="line"> ⼀对多，消费者消费数据后不会清除消息。</span><br><span class="line"> 消费者可以主动去Broker服务器去拉取数据，当然，也可以是Broker主动推送数据。</span><br><span class="line"> </span><br><span class="line"> 拉取:</span><br><span class="line">  优点:</span><br><span class="line">  消费者程序可以根据自身的硬件配置去broker消费)</span><br><span class="line">  缺点:</span><br><span class="line">  消费者需要长期执行一个进程来询问broker是否有数据</span><br><span class="line">  </span><br><span class="line"> 推(push):</span><br><span class="line"> 优点:</span><br><span class="line"> 无需客户端主动拉去数据，而是由服务端主动发送数据</span><br><span class="line"> 缺点:</span><br><span class="line">(1)broker推送数据给消费者是，可能因为消费者消费能力不足，直接导致客户端程序崩溃掉</span><br><span class="line">(2)broker内部需要维护一个订阅者列表，当订阅者较多时，可能会很占用内存</span><br><span class="line"></span><br><span class="line">kafka broker仅支持拉取工作方式。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317180554895.png" alt="image-20240317180554895"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317181336827.png" alt="image-20240317181336827"></p>
<h3 id="部署kafka"><a class="markdownIt-Anchor" href="#部署kafka">#</a> 部署 kafka</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"># 部署zookeerper集群</span><br><span class="line">wget &quot;https://dlcdn.apache.org/zookeeper/zookeeper-3.9.2/apache-zookeeper-3.9.2-bin.tar.gz&quot; --no-check-certificate</span><br><span class="line">tar zvxf apache-zookeeper-3.9.2-bin.tar.gz</span><br><span class="line">cd apache-zookeeper-3.9.2-bin/</span><br><span class="line"></span><br><span class="line">vim /etc/profile.d/kafka.sh</span><br><span class="line">#! /bin/bash</span><br><span class="line">export ZK_HOME=/root/apache-zookeeper-3.9.2-bin</span><br><span class="line">export PATH=$PATH:$ZK_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile.d/kafka.sh</span><br><span class="line">cp zoo_sample.cfg  zoo.cfg</span><br><span class="line"></span><br><span class="line">zkServer.sh start </span><br><span class="line">ZooKeeper JMX enabled by default</span><br><span class="line">Using config: /root/apache-zookeeper-3.9.2-bin/bin/../conf/zoo.cfg</span><br><span class="line">Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line">zkServer.sh status</span><br><span class="line"></span><br><span class="line">zkCli.sh </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 部署kafka</span><br><span class="line">wget https://downloads.apache.org/kafka/3.7.0/kafka_2.13-3.7.0.tgz --no-check-certificate</span><br><span class="line">tar xzvf kafka_2.13-3.7.0.tgz</span><br><span class="line">cd kafka_2.13-3.7.0/</span><br><span class="line"></span><br><span class="line">vim /etc/profile.d/kafka.sh</span><br><span class="line">export KAFKA_HOME=/root/kafka_2.13-3.7.0</span><br><span class="line">export PATH=$PATH:$KAFKA_HOME/bin</span><br><span class="line">source /etc/profile.d/kafka.sh</span><br><span class="line"></span><br><span class="line">vim server.properties </span><br><span class="line">broker.id=99</span><br><span class="line">zookeeper.connect=192.168.13.101:2181/kafka_3.7</span><br><span class="line"></span><br><span class="line">kafka-server-start.sh -daemon /root/kafka_2.13-3.7.0/config/server.properties </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">tcp6       0      0 :::9092                 :::*                    LISTEN      40507/java      </span><br><span class="line">tcp6       0      0 :::2181                 :::*                    LISTEN      36697/java     </span><br><span class="line"></span><br><span class="line">jps </span><br><span class="line">40803 Jps</span><br><span class="line">40739 ZooKeeperMain</span><br><span class="line">36697 QuorumPeerMain</span><br><span class="line">48059 Elasticsearch</span><br><span class="line">40507 Kafka</span><br><span class="line">127132 Elasticsearch</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证</span><br><span class="line">kafka-console-producer.sh --topic nginx --bootstrap-server 192.168.13.101:9092				# 不存在topic自动创建</span><br><span class="line"></span><br><span class="line">kafka-console-producer.sh --topic nginx --bootstrap-server 192.168.13.101:9092</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">取数据默认从最新的取，加上--from-beginning 从头开始取数据</span><br></pre></td></tr></table></figure>
<h3 id="基本概念"><a class="markdownIt-Anchor" href="#基本概念">#</a> 基本概念</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">broker server:</span><br><span class="line"> ⼀台kafka服务器就是⼀个broker。通常情况下，&quot;broker list&quot;就是kafka </span><br><span class="line">集群(cluster)。</span><br><span class="line"> topic:</span><br><span class="line"> 对外提供的逻辑存储单位。和ES中的index有点类似。</span><br><span class="line"> parition:</span><br><span class="line"> 实际存储数据的单元，⼀个topic最少对应⼀个或多个parition。和ES中的shard分⽚有点类似。</span><br><span class="line"> replica:</span><br><span class="line"> 每个partition最少有⼀个或多个副本，如果有2个或以上副本，则副本分为leader和follower。</span><br><span class="line"> leader:</span><br><span class="line"> leader parition负责对kafka集群对读写(rw)操作，可以和客户端进⾏交互。</span><br><span class="line"> follower:</span><br><span class="line"> follower parition负责去leader parition同步数据，不可以和客户端进⾏交互。</span><br><span class="line"> </span><br><span class="line">client:</span><br><span class="line"> consumer API:</span><br><span class="line"> 即消费者，指的是从boker拉取数据的⻆⾊。</span><br><span class="line"> 每个消费者均⾪属于⼀个消费者组(consumer Group)，⼀个消费者组内可以有多个消费者。</span><br><span class="line"> </span><br><span class="line"> producer API:</span><br><span class="line"> 即⽣产者，指的是往broker写⼊数据的⻆⾊。</span><br><span class="line"> </span><br><span class="line"> admin API:</span><br><span class="line"> 集群管理的相关API，包括topic，parititon，replica等管理。</span><br><span class="line"> </span><br><span class="line"> stream API:</span><br><span class="line"> 数据流处理等API，提供给Spark，Flink，Storm分布式计算框架提供数据流管道。</span><br><span class="line"> </span><br><span class="line"> connect API:</span><br><span class="line"> 连接数据库相关的API，例如将MySQL导⼊到kafka。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240317195348018.png" alt="image-20240317195348018"></p>
<h3 id="集群"><a class="markdownIt-Anchor" href="#集群">#</a> 集群</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">mkdir /data/kakfa</span><br><span class="line">chown -R elasticsearch:elasticsearch  /data/</span><br><span class="line"></span><br><span class="line">vim server.properties </span><br><span class="line">log.dirs=/data/kafka</span><br><span class="line">broker.id=99</span><br><span class="line">zookeeper.connect=192.168.13.101:2181/kafka_3.7</span><br><span class="line"></span><br><span class="line">kafka-server-start.sh -daemon /root/kafka_2.13-3.7.0/config/server.properties </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 7] ls /kafka_3.7/brokers/ids</span><br><span class="line">[102, 103, 99] </span><br></pre></td></tr></table></figure>
<h3 id="kafka-topic"><a class="markdownIt-Anchor" href="#kafka-topic">#</a> kafka topic</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --list </span><br><span class="line">__consumer_offsets</span><br><span class="line">nginx</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --describe </span><br><span class="line">Topic: nginx    TopicId: THT6uHQmS3S8NzU12s5uIQ PartitionCount: 1       ReplicationFactor: 1    Configs: </span><br><span class="line">        Topic: nginx    Partition: 0    Leader: 99      Replicas: 99    Isr: 99</span><br><span class="line">Topic: __consumer_offsets       TopicId: LYq2xfA9ShKZy0fgPLd7zg PartitionCount: 50      ReplicationFactor: 1    Configs: compression.type=producer,cleanup.policy=compact,segment.bytes=104857600</span><br><span class="line">        Topic: __consumer_offsets       Partition: 0    Leader: 99      Replicas: 99    Isr: 99</span><br><span class="line">        Topic: __consumer_offsets       Partition: 1    Leader: 99      Replicas: 99    Isr: 99</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --describe --topic nginx</span><br><span class="line">Topic: nginx    TopicId: THT6uHQmS3S8NzU12s5uIQ PartitionCount: 1       ReplicationFactor: 1    Configs: </span><br><span class="line">        Topic: nginx    Partition: 0    Leader: 99      Replicas: 99    Isr: 99</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --create --topic hahaha --partitions 10 --replication-factor 1</span><br><span class="line">Created topic hahaha.</span><br><span class="line"></span><br><span class="line">topic 不能存在相同的名字</span><br><span class="line">副本数量不能大于 brokers 的数量，范围1-32767</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改分区数量，只能调大不能调小</span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092  --topic hahaha  --alter --partitions 13</span><br><span class="line">--alter不能修改副本选项</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --delete --topic nginx</span><br><span class="line">删除多个时使用,分割</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br></pre></td><td class="code"><pre><span class="line"># 修改副本数量</span><br><span class="line">vim resign.json</span><br><span class="line">&#123;</span><br><span class="line">	&quot;topics&quot;: [&#123;&quot;topic&quot;: &quot;hahaha&quot;&#125;],</span><br><span class="line">	&quot;version&quot;: 1</span><br><span class="line">&#125;</span><br><span class="line">kafka-reassign-partitions.sh --bootstrap-server 192.168.13.101:9092 --broker-list 99,102,103  --topics-to-move-json-file resign.json  --generate</span><br><span class="line">Current partition replica assignment</span><br><span class="line">&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;]&#125;</span><br><span class="line"></span><br><span class="line">Proposed partition reassignment configuration			# 重新分配分区计划，还未执行</span><br><span class="line">&#123;&quot;version&quot;:1,&quot;partitions&quot;:[&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:0,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:1,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:2,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:3,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:4,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:5,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:6,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:7,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:8,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:9,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:10,&quot;replicas&quot;:[102],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:11,&quot;replicas&quot;:[103],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;,&#123;&quot;topic&quot;:&quot;hahaha&quot;,&quot;partition&quot;:12,&quot;replicas&quot;:[99],&quot;log_dirs&quot;:[&quot;any&quot;]&#125;]&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim rebalance.json</span><br><span class="line">&#123;</span><br><span class="line">    &quot;version&quot;: 1,</span><br><span class="line">    &quot;partitions&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 0,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                99,</span><br><span class="line">                102</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;,</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 1,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                102</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 2,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                103</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 3,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                99</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 4,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                102</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 5,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                103</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 6,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                99</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 7,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                102</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 8,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                103</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 9,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                99</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 10,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                102</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 11,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                103</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;topic&quot;: &quot;hahaha&quot;,</span><br><span class="line">            &quot;partition&quot;: 12,</span><br><span class="line">            &quot;replicas&quot;: [</span><br><span class="line">                99</span><br><span class="line">            ],</span><br><span class="line">            &quot;log_dirs&quot;: [</span><br><span class="line">                &quot;any&quot;</span><br><span class="line">            ]</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 验证分配计划</span><br><span class="line">kafka-reassign-partitions.sh --bootstrap-server 192.168.13.101:9092 --reassignment-json-file rebalance.json --verify</span><br><span class="line">Status of partition reassignment:</span><br><span class="line">There is no active reassignment of partition hahaha-0, but replica set is 99 rather than 99,102.</span><br><span class="line">There is no active reassignment of partition hahaha-1, but replica set is 103 rather than 102.</span><br><span class="line">There is no active reassignment of partition hahaha-2, but replica set is 102 rather than 103.</span><br><span class="line">Reassignment of partition hahaha-3 is completed.</span><br><span class="line">There is no active reassignment of partition hahaha-4, but replica set is 103 rather than 102.</span><br><span class="line">There is no active reassignment of partition hahaha-5, but replica set is 102 rather than 103.</span><br><span class="line">Reassignment of partition hahaha-6 is completed.</span><br><span class="line">There is no active reassignment of partition hahaha-7, but replica set is 103 rather than 102.</span><br><span class="line">There is no active reassignment of partition hahaha-8, but replica set is 102 rather than 103.</span><br><span class="line">Reassignment of partition hahaha-9 is completed.</span><br><span class="line">Reassignment of partition hahaha-10 is completed.</span><br><span class="line">Reassignment of partition hahaha-11 is completed.</span><br><span class="line">Reassignment of partition hahaha-12 is completed.</span><br><span class="line"></span><br><span class="line">Clearing broker-level throttles on brokers 99,102,103</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 执行分配计划</span><br><span class="line">kafka-reassign-partitions.sh --bootstrap-server 192.168.13.101:9092 --reassignment-json-file rebalance.json --execute</span><br><span class="line"></span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092 --describe --topic hahaha</span><br><span class="line">Topic: hahaha   TopicId: 0TDZliscTFaZDRM9QL_mtA PartitionCount: 13      ReplicationFactor: 2    Configs: </span><br><span class="line">        Topic: hahaha   Partition: 0    Leader: 99      Replicas: 99,102        Isr: 99,102</span><br></pre></td></tr></table></figure>
<h3 id="消费者组"><a class="markdownIt-Anchor" href="#消费者组">#</a> 消费者组</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.13.101:9092 --list </span><br><span class="line">console-consumer-59612</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.13.101:9092 --describe --group console-consumer-59612</span><br><span class="line"></span><br><span class="line">GROUP                  TOPIC           PARTITION  CURRENT-OFFSET  LOG-END-OFFSET  LAG             CONSUMER-ID                                           HOST            CLIENT-ID</span><br><span class="line">console-consumer-59612 nginx           0          -               0               -               console-consumer-71084746-0f0c-4438-873c-d30fb954f83e /192.168.13.102 console-consumer</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 192.168.13.101:9092 --describe --all-groups</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">kafka-consumer.sh --bootstrap-server 192.168.13.101:9092 --topic hahaha --from-beginning --consumer-property group.id=&quot;111&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">同一个消费者组(consumer group)的消费者(consumer)不能同时去同一个分区(parititon)读取数据，避免数据重复消费;</span><br><span class="line">当一个topic的分区数量增大时，消费者组的各个消费者将重新分配，即重新分配待消费分区的所属权;</span><br><span class="line">当同一个消费者组的消费者数量发生变化时，也会触发rebalance，即重新分配待消费分区的所属权;</span><br></pre></td></tr></table></figure>
<h3 id="同一个集群部署不同版本kafka"><a class="markdownIt-Anchor" href="#同一个集群部署不同版本kafka">#</a> 同一个集群部署不同版本 kafka</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">wget &quot;https://archive.apache.org/dist/kafka/0.8.0/kafka_2.8.0-0.8.0.tar.gz&quot; --no-check-certificate</span><br><span class="line">tar xzvf kafka_2.8.0-0.8.0.tar.gz</span><br><span class="line"></span><br><span class="line">vim server.properties </span><br><span class="line">broker.id=99</span><br><span class="line">zookeeper.connect=192.168.13.101:2181/kafka_3.7</span><br><span class="line">port=19092</span><br><span class="line"></span><br><span class="line">nohup ./kafka-server-start.sh /root/kafka_2.8.0-0.8.0/config/server.properties  &amp;</span><br></pre></td></tr></table></figure>
<h3 id="znode基础操作"><a class="markdownIt-Anchor" href="#znode基础操作">#</a> znode 基础操作</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"># 查看 / 下所有子znode列表</span><br><span class="line">ls /</span><br><span class="line">[kafka_0.8, kafka_3.7, zookeeper]</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 3] stat /</span><br><span class="line">cZxid = 0x0</span><br><span class="line">ctime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">mZxid = 0x0</span><br><span class="line">mtime = Thu Jan 01 08:00:00 CST 1970</span><br><span class="line">pZxid = 0x136</span><br><span class="line">cversion = 1</span><br><span class="line">dataVersion = 0</span><br><span class="line">aclVersion = 0</span><br><span class="line">ephemeralOwner = 0x0</span><br><span class="line">dataLength = 0</span><br><span class="line">numChildren = 3</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 4] ls -R /</span><br><span class="line">/</span><br><span class="line">/kafka_0.8</span><br><span class="line">/kafka_3.7</span><br><span class="line">/zookeeper</span><br><span class="line">/kafka_0.8/admin</span><br><span class="line">/kafka_0.8/brokers</span><br><span class="line">/kafka_0.8/cluster</span><br><span class="line">/kafka_0.8/config</span><br><span class="line"></span><br><span class="line"># 查看信息</span><br><span class="line">[zk: localhost:2181(CONNECTED) 5] get /zookeeper/config</span><br><span class="line"></span><br><span class="line"># 创建znode，创建多级znode时，其父znode必须存在</span><br><span class="line">[zk: localhost:2181(CONNECTED) 6] create /hahaha</span><br><span class="line">Created /hahaha</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 8] create /hahaha/haha 444</span><br><span class="line">Created /hahaha/haha</span><br><span class="line">[zk: localhost:2181(CONNECTED) 9] get /hahaha/haha </span><br><span class="line">444</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 10] set /hahaha/haha 888</span><br><span class="line">[zk: localhost:2181(CONNECTED) 11] get /hahaha/haha </span><br><span class="line">888</span><br><span class="line"></span><br><span class="line">[zk: localhost:2181(CONNECTED) 12] delete /hahaha/haha  </span><br><span class="line">[zk: localhost:2181(CONNECTED) 13] deleteall /hahaha 	# 递归删除</span><br></pre></td></tr></table></figure>
<h3 id="offset"><a class="markdownIt-Anchor" href="#offset">#</a> offset</h3>
<p>kafka 最早 offset 放在 zk 上，后来放在了 broker 上，一个叫做_consumer_Offset 的 topic 中</p>
<p>早器 &lt;0.9  后期&gt; 0.9</p>
<p>当消费者组数量增多时，对 zk 写入有较大压力</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt; 0.9</span><br><span class="line">get /oldboyedu-linux80-kafka-0_8_0/consumers/oldboyedu/offsets/oldboyedu-linux80/0</span><br><span class="line"></span><br><span class="line">&gt;0.9</span><br><span class="line">kafka-consumer-groups.sh --bootstrap-server 10.0.0.101:9092 --describe --group oldboyedu-linux</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查看内置的__consumer_offsets数据</span><br><span class="line">kafka-console-consumer.sh --bootstrap-server 10.0.0.101:9092 --topic __consumer_offsets --formatter &quot;kafka.coordinator.group.GroupMetadataManager\$OffsetsMessageFormatter&quot; --from-beginning | grep oldboyedu-linux</span><br></pre></td></tr></table></figure>
<h3 id="kafka-监控组件eagle"><a class="markdownIt-Anchor" href="#kafka-监控组件eagle">#</a> kafka 监控组件 eagle</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">kafka-server-stop.sh</span><br><span class="line"></span><br><span class="line">vim kafka-server-start.sh </span><br><span class="line">if [ &quot;x$KAFKA_HEAP_OPTS&quot; = &quot;x&quot; ]; then</span><br><span class="line">    #export KAFKA_HEAP_OPTS=&quot;-Xmx1G -Xms1G&quot;</span><br><span class="line">    export KAFKA_HEAP_OPTS=&quot;-server -Xmx256M -Xms256M  -Xms256M -XX:PermSize=128m -XX:+UseG1GC -XX:MaxGCPauseMillis=200 -XX:ParallelGCThreads=8 -XX:ConcGCThreads=5 -XX:InitiatingHeapOccupancyPercent=70&quot;</span><br><span class="line">    export JMX_PORT=&quot;8888&quot;</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># 其余节点同步配置文件，启动kafka</span><br><span class="line"></span><br><span class="line">yum install mariadb-server -y </span><br><span class="line">systemctl enable mariadb.service --now </span><br><span class="line"></span><br><span class="line">mysql</span><br><span class="line">CREATE DATABASE kafka DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci</span><br><span class="line">CREATE USER admin IDENTIFIED BY &#x27;kafka&#x27;;</span><br><span class="line"></span><br><span class="line">GRANT ALL ON kafka.* TO admin;</span><br><span class="line"></span><br><span class="line">show GRANTS FOR  admin;</span><br><span class="line">+------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Grants for admin@%                                                                                   |</span><br><span class="line">+------------------------------------------------------------------------------------------------------+</span><br><span class="line">| GRANT USAGE ON *.* TO &#x27;admin&#x27;@&#x27;%&#x27; IDENTIFIED BY PASSWORD &#x27;*DCB9E0CF558C6CC2E574E66EF0C9CA18276BDDB1&#x27; |</span><br><span class="line">| GRANT ALL PRIVILEGES ON `kafka`.* TO &#x27;admin&#x27;@&#x27;%&#x27;                                                     |</span><br><span class="line">+------------------------------------------------------------------------------------------------------+</span><br><span class="line">2 rows in set </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">wget &quot;https://github.com/smartloli/kafka-eagle-bin/archive/v3.0.1.tar.gz&quot;</span><br><span class="line">tar xzvf v3.0.1.tar.gz</span><br><span class="line">cd kafka-eagle-bin-3.0.1/</span><br><span class="line">tar xzvf efak-web-3.0.1-bin.tar.gz</span><br><span class="line"></span><br><span class="line">vim ke.sh</span><br><span class="line">export KE_JAVA_OPTS=&quot;-server -Xmx512M -Xms512M -XX:MaxGCPauseMillis=20 -XX:+UseG1GC -XX:MetaspaceSize=128m -XX:InitiatingHeapOccupancyPercent=35 -XX:G1HeapRegionSize=16M -XX:MinMetaspaceFreeRatio=50 -XX:MaxMetaspaceFreeRatio=80&quot;</span><br><span class="line"></span><br><span class="line">vim system-config.properties </span><br><span class="line">efak.zk.cluster.alias=cluster1,cluster2</span><br><span class="line">cluster1.zk.list=192.168.13.101:2181/kafka_0.8</span><br><span class="line">cluster2.zk.list=192.168.13.101:2181/kafka_3.7</span><br><span class="line">cluster1.efak.offset.storage=zk</span><br><span class="line">cluster2.efak.offset.storage=kafka</span><br><span class="line">efak.topic.token=keadmin</span><br><span class="line">efak.driver=com.mysql.cj.jdbc.Driver</span><br><span class="line">efak.url=jdbc:mysql://127.0.0.1:3306/kafka?useUnicode=true&amp;characterEncoding=UTF-8&amp;zeroDateTimeBehavior=convertToNull</span><br><span class="line">efak.username=admin</span><br><span class="line">efak.password=kafka</span><br><span class="line"></span><br><span class="line">vim /etc/profile.d/kafka.sh</span><br><span class="line">export KE_HOME=/root/kafka-eagle-bin-3.0.1/efak-web-3.0.1/</span><br><span class="line">export PATH=$PATH:$KE_HOME/bin</span><br><span class="line"></span><br><span class="line">source /etc/profile.d/kafka.sh</span><br><span class="line"></span><br><span class="line">ke.sh start </span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="kafka压测"><a class="markdownIt-Anchor" href="#kafka压测">#</a> kafka 压测</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@elk101 /tmp/kafka-logs]$ mkdir /tmp/kafka-test </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt; oldboyedu-kafka-test.sh &lt;&lt;&#x27;EOF&#x27;</span><br><span class="line"># 创建topic</span><br><span class="line">kafka-topics.sh --bootstrap-server 192.168.13.101:9092,192.168.13.102:9092,192.168.13.103:9092 --topic oldboyedu-kafka --replication-factor 1 --partitions 10 --create</span><br><span class="line"># 启动消费者消费数据</span><br><span class="line">nohup kafka-consumer-perf-test.sh --broker-list 192.168.13.101:9092,192.168.13.102:9092,192.168.13.103:9092 --topic oldboyedu-kafka --messages 100000000 &amp;&gt;/tmp/kafka-test/oldboyedu-kafka-consumer.log &amp;</span><br><span class="line"># 启动⽣产者写⼊数据</span><br><span class="line">nohup kafka-producer-perf-test.sh --num-records 100000000 --record-size 1000 --topic oldboyedu-kafka --throughput 1000000 --producer-props bootstrap.servers=192.168.13.101:9092,192.168.13.102:9092,192.168.13.103:9092 &amp;&gt; /tmp/kafka-test/oldboyedu-kafka-producer.log &amp;</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

      <div class="tags">
          <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"><i class="ic i-tag"></i> 运维</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-03-26 00:34:18" itemprop="dateModified" datetime="2024-03-26T00:34:18+08:00">2024-03-26</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2024/02/15/Elastic%20Stack/" title="Elastic stack">http://example.com/2024/02/15/Elastic Stack/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/02/01/%E7%9B%91%E6%8E%A7/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;e10fa1dac1ea1b1bf06ccdd62eb0f9f0.jpg" title="监控">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>监控</h3>
  </a>

    </div>
    <div class="item right">
    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#elastic-stack"><span class="toc-number">1.</span> <span class="toc-text"> Elastic Stack</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#elasticsearch-%E5%92%8C-solr%E7%9A%84%E9%80%89%E6%8B%A9"><span class="toc-number">1.1.</span> <span class="toc-text"> ElasticSearch 和 solr 的选择</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">1.2.</span> <span class="toc-text"> 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E7%82%B9%E9%83%A8%E7%BD%B2es"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 单点部署 es</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2es"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 集群部署 es</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85kibana"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 安装 kibana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%89%E8%A3%85filebeat"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 安装 filebeat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E6%97%A5%E5%BF%97%E7%AD%9B%E9%80%89%E6%9F%90%E4%B8%AA%E5%AD%97%E6%AE%B5"><span class="toc-number">1.2.5.</span> <span class="toc-text"> 通过日志筛选某个字段</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86tomcat%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.6.</span> <span class="toc-text"> 收集 tomcat 日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86tomcat%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.7.</span> <span class="toc-text"> 收集 tomcat 错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86es%E9%94%99%E8%AF%AF%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.8.</span> <span class="toc-text"> 收集 es 错误日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%BF%87%E6%BB%A4"><span class="toc-number">1.2.9.</span> <span class="toc-text"> 日志过滤</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%94%B6%E9%9B%86nginx%E6%89%80%E6%9C%89%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.10.</span> <span class="toc-text"> 收集 nginx 所有日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filestream-%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97"><span class="toc-number">1.2.11.</span> <span class="toc-text"> filestream 收集日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E8%81%9A%E5%90%88"><span class="toc-number">1.2.12.</span> <span class="toc-text"> 日志聚合</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#inputtcp"><span class="toc-number">1.2.13.</span> <span class="toc-text"> input.tcp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#outputfile"><span class="toc-number">1.2.14.</span> <span class="toc-text"> output.file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#outputredis"><span class="toc-number">1.2.15.</span> <span class="toc-text"> output.redis</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#logstash"><span class="toc-number">1.3.</span> <span class="toc-text"> Logstash</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#stdin-stdout"><span class="toc-number">1.3.1.</span> <span class="toc-text"> stdin &amp;&amp; stdout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input-file"><span class="toc-number">1.3.2.</span> <span class="toc-text"> input - file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input-tcp"><span class="toc-number">1.3.3.</span> <span class="toc-text"> input - tcp</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input-http"><span class="toc-number">1.3.4.</span> <span class="toc-text"> input - http</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#input-redis"><span class="toc-number">1.3.5.</span> <span class="toc-text"> input - redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filebeat-logstash"><span class="toc-number">1.3.6.</span> <span class="toc-text"> filebeat — logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#output-redis"><span class="toc-number">1.3.7.</span> <span class="toc-text"> output - redis</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#output-file"><span class="toc-number">1.3.8.</span> <span class="toc-text"> output - file</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#output-es"><span class="toc-number">1.3.9.</span> <span class="toc-text"> output - es</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#if"><span class="toc-number">1.3.10.</span> <span class="toc-text"> if</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E5%AE%9E%E4%BE%8Blogstash"><span class="toc-number">1.3.11.</span> <span class="toc-text"> 多实例 logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filter"><span class="toc-number">1.3.12.</span> <span class="toc-text"> filter</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#gork"><span class="toc-number">1.3.12.1.</span> <span class="toc-text"> gork</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#date"><span class="toc-number">1.3.12.2.</span> <span class="toc-text"> date</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#geoip"><span class="toc-number">1.3.12.3.</span> <span class="toc-text"> geoip</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#useragent"><span class="toc-number">1.3.12.4.</span> <span class="toc-text"> useragent</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#mutate"><span class="toc-number">1.3.12.5.</span> <span class="toc-text"> mutate</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kibana"><span class="toc-number">1.4.</span> <span class="toc-text"> kibana</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#dashborad"><span class="toc-number">1.4.1.</span> <span class="toc-text"> dashborad</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#pv"><span class="toc-number">1.4.1.1.</span> <span class="toc-text"> pv</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ip"><span class="toc-number">1.4.1.2.</span> <span class="toc-text"> IP</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B8%A6%E5%AE%BD"><span class="toc-number">1.4.1.3.</span> <span class="toc-text"> 带宽</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%BB%9F%E8%AE%A1%E8%AE%BF%E9%97%AE%E9%A1%B5%E9%9D%A2"><span class="toc-number">1.4.1.4.</span> <span class="toc-text"> 统计访问页面</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#dashboard"><span class="toc-number">1.4.1.5.</span> <span class="toc-text"> dashboard</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2"><span class="toc-number">1.5.</span> <span class="toc-text"> 二进制部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%8A%82%E7%82%B9elasticsearch"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 单节点 elasticsearch</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4es"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 集群 es</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kibana-2"><span class="toc-number">1.5.3.</span> <span class="toc-text"> kibana</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#logstash-2"><span class="toc-number">1.5.4.</span> <span class="toc-text"> logstash</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#filebeat"><span class="toc-number">1.5.5.</span> <span class="toc-text"> filebeat</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#es-head"><span class="toc-number">1.5.6.</span> <span class="toc-text"> es-head</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es-rest%E9%A3%8E%E6%A0%BCapi"><span class="toc-number">1.6.</span> <span class="toc-text"> ES rest 风格 api</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B4%A2%E5%BC%95"><span class="toc-number">1.6.1.</span> <span class="toc-text"> 索引</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E8%AF%8D%E5%99%A8"><span class="toc-number">1.6.2.</span> <span class="toc-text"> 分词器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#dsl"><span class="toc-number">1.7.</span> <span class="toc-text"> DSL</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E6%96%87%E7%B1%BB%E5%9E%8B%E6%A3%80%E7%B4%A2"><span class="toc-number">1.7.1.</span> <span class="toc-text"> 全文类型检索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%8C%E5%85%A8%E5%8C%B9%E9%85%8D"><span class="toc-number">1.7.2.</span> <span class="toc-text"> 完全匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E9%87%8F%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.3.</span> <span class="toc-text"> 全量查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%86%E9%A1%B5%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.4.</span> <span class="toc-text"> 分页查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9F%A5%E8%AF%A2%E5%8C%85%E5%90%AB%E6%8C%87%E5%AE%9A%E5%AD%97%E6%AE%B5%E6%96%87%E6%A1%A3"><span class="toc-number">1.7.5.</span> <span class="toc-text"> 查询包含指定字段文档</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AF%AD%E6%B3%95%E9%AB%98%E4%BA%AE"><span class="toc-number">1.7.6.</span> <span class="toc-text"> 语法高亮</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%97%E6%AE%B5%E6%8E%92%E5%BA%8F"><span class="toc-number">1.7.7.</span> <span class="toc-text"> 字段排序</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E6%9D%A1%E4%BB%B6%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.8.</span> <span class="toc-text"> 多条件查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%8C%83%E5%9B%B4%E6%9F%A5%E8%AF%A2"><span class="toc-number">1.7.9.</span> <span class="toc-text"> 范围查询</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B2%BE%E7%A1%AE%E5%8C%B9%E9%85%8D"><span class="toc-number">1.7.10.</span> <span class="toc-text"> 精确匹配</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A4%9A%E8%AF%8D%E6%90%9C%E7%B4%A2"><span class="toc-number">1.7.11.</span> <span class="toc-text"> 多词搜索</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9D%83%E9%87%8D"><span class="toc-number">1.7.12.</span> <span class="toc-text"> 权重</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%81%9A%E5%90%88"><span class="toc-number">1.7.13.</span> <span class="toc-text"> 聚合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es%E9%9B%86%E7%BE%A4%E8%BF%81%E7%A7%BB"><span class="toc-number">1.8.</span> <span class="toc-text"> es 集群迁移</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#logstash%E5%AE%9E%E7%8E%B0%E9%9B%86%E7%BE%A4%E8%BF%81%E7%A7%BB"><span class="toc-number">1.8.1.</span> <span class="toc-text"> logstash 实现集群迁移</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#es-%E5%81%A5%E5%BA%B7api"><span class="toc-number">1.9.</span> <span class="toc-text"> es 健康 api</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E6%9B%B4%E6%96%B0%E8%AE%BE%E7%BD%AE"><span class="toc-number">1.9.1.</span> <span class="toc-text"> 集群更新设置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4state"><span class="toc-number">1.9.2.</span> <span class="toc-text"> 集群 state</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4stats%E7%BB%9F%E8%AE%A1%E4%BF%A1%E6%81%AF"><span class="toc-number">1.9.3.</span> <span class="toc-text"> 集群 stats 统计信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E5%88%86%E7%89%87%E5%88%86%E9%85%8D%E6%83%85%E5%86%B5"><span class="toc-number">1.9.4.</span> <span class="toc-text"> 集群分片分配情况</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#reroute-api"><span class="toc-number">1.9.5.</span> <span class="toc-text"> reroute api</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4%E8%A7%92%E8%89%B2"><span class="toc-number">1.9.6.</span> <span class="toc-text"> 集群角色</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B9%90%E8%A7%82%E9%94%81"><span class="toc-number">1.9.7.</span> <span class="toc-text"> 乐观锁</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#tls"><span class="toc-number">1.9.8.</span> <span class="toc-text"> tls</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rbac"><span class="toc-number">1.9.9.</span> <span class="toc-text"> RBAC</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#kafka"><span class="toc-number">1.10.</span> <span class="toc-text"> kafka</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F"><span class="toc-number">1.10.1.</span> <span class="toc-text"> 工作模式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2kafka"><span class="toc-number">1.10.2.</span> <span class="toc-text"> 部署 kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5"><span class="toc-number">1.10.3.</span> <span class="toc-text"> 基本概念</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9B%86%E7%BE%A4"><span class="toc-number">1.10.4.</span> <span class="toc-text"> 集群</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka-topic"><span class="toc-number">1.10.5.</span> <span class="toc-text"> kafka topic</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B6%88%E8%B4%B9%E8%80%85%E7%BB%84"><span class="toc-number">1.10.6.</span> <span class="toc-text"> 消费者组</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%8C%E4%B8%80%E4%B8%AA%E9%9B%86%E7%BE%A4%E9%83%A8%E7%BD%B2%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%ACkafka"><span class="toc-number">1.10.7.</span> <span class="toc-text"> 同一个集群部署不同版本 kafka</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#znode%E5%9F%BA%E7%A1%80%E6%93%8D%E4%BD%9C"><span class="toc-number">1.10.8.</span> <span class="toc-text"> znode 基础操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#offset"><span class="toc-number">1.10.9.</span> <span class="toc-text"> offset</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka-%E7%9B%91%E6%8E%A7%E7%BB%84%E4%BB%B6eagle"><span class="toc-number">1.10.10.</span> <span class="toc-text"> kafka 监控组件 eagle</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#kafka%E5%8E%8B%E6%B5%8B"><span class="toc-number">1.10.11.</span> <span class="toc-text"> kafka 压测</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2023/04/03/iptables2/" rel="bookmark" title="iptables">iptables</a></li><li><a href="/2023/04/05/Docker/" rel="bookmark" title="docker">docker</a></li><li><a href="/2023/04/15/Nginx_new/" rel="bookmark" title="Nginx">Nginx</a></li><li><a href="/2023/05/20/Kubernetes/" rel="bookmark" title="Kubernetes">Kubernetes</a></li><li><a href="/2023/05/30/jenkins/" rel="bookmark" title="Jenkins">Jenkins</a></li><li><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" rel="bookmark" title="k8s高级">k8s高级</a></li><li><a href="/2024/01/01/istio/" rel="bookmark" title="istio">istio</a></li><li><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="bookmark" title="集群与存储">集群与存储</a></li><li><a href="/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" rel="bookmark" title="虚拟化">虚拟化</a></li><li><a href="/2024/02/01/%E7%9B%91%E6%8E%A7/" rel="bookmark" title="监控">监控</a></li><li class="active"><a href="/2024/02/15/Elastic%20Stack/" rel="bookmark" title="Elastic stack">Elastic stack</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">46</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2022/11/11/reverse/" title="逆向">逆向</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/05/27/CSRF/" title="CSRF">CSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/05/30/jenkins/" title="Jenkins">Jenkins</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/09/01/border%20leaf/" title="从三层架构到spine leaf">从三层架构到spine leaf</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" title="集群与存储">集群与存储</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" title="k8s高级">k8s高级</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/11/27/Docker%E9%80%83%E9%80%B8/" title="docker逃逸&amp;capabilities">docker逃逸&capabilities</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/08/16/Unserialize/" title="unserialize">unserialize</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/02/15/Elastic Stack/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
