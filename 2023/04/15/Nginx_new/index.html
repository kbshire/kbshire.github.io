



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="运维" />


<link rel="canonical" href="http://example.com/2023/04/15/Nginx_new/">



  <title>
Nginx - 运维 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">Nginx
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2023-04-15 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2023-04-15T13:38:45+08:00">2023-04-15</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/38f4d53604cb5ca98a47fea8d62cde72.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/52607e127cb45c155489002e506f7b5d.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/df90fbe0bf0d8c96355b06f9318f97e6.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/f584675dfc4ef47fcf19442f0e2ea18b.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/7a9a95e33c226d979abfd43d471f610d.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/18a32c514eae0d32a8b4b2a75853a08b.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="item" rel="index" title="In 运维"><span itemprop="name">运维</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2023/04/15/Nginx_new/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="nginx"><a class="markdownIt-Anchor" href="#nginx">#</a> Nginx</h1>
<p><span class="exturl" data-url="aHR0cHM6Ly9wYW4uYmFpZHUuY29tL3MvMWJaV1dvSm90cDFfZ2gzNkZtSjhINkE/X2F0Xz0xNjgxMzg1MTc2MTU1I2xpc3QvcGF0aD0lMkYmYW1wO3BhcmVudFBhdGg9JTJG">Java-nginx 分布式框架_免费高速下载 | 百度网盘 - 分享无限制 (baidu.com)</span></p>
<h2 id="nginx目录结构"><a class="markdownIt-Anchor" href="#nginx目录结构">#</a> nginx 目录结构</h2>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/nginx/</span><br><span class="line">├── <span class="attribute">client_body_temp</span></span><br><span class="line">├── conf 					<span class="comment"># 配置文件目录</span></span><br><span class="line">│   ├── fastcgi.conf		<span class="comment"># fastcgi 配置文件</span></span><br><span class="line">│   ├── fastcgi.conf.default</span><br><span class="line">│   ├── fastcgi_params</span><br><span class="line">│   ├── fastcgi_params.default</span><br><span class="line">│   ├── koi-utf</span><br><span class="line">│   ├── koi-win</span><br><span class="line">│   ├── mime.types</span><br><span class="line">│   ├── mime.types.default</span><br><span class="line">│   ├── nginx.conf</span><br><span class="line">│   ├── nginx.conf.default</span><br><span class="line">│   ├── scgi_params</span><br><span class="line">│   ├── scgi_params.default</span><br><span class="line">│   ├── uwsgi_params</span><br><span class="line">│   ├── uwsgi_params.default</span><br><span class="line">│   └── win-utf</span><br><span class="line">├── fastcgi_temp</span><br><span class="line">├── html</span><br><span class="line">│   ├── 50x.html</span><br><span class="line">│   └── index.html</span><br><span class="line">├── logs</span><br><span class="line">│   ├── access.log</span><br><span class="line">│   ├── <span class="literal">error</span>.log</span><br><span class="line">│   └── nginx.pid	<span class="comment"># nginx的process id</span></span><br><span class="line">├── proxy_temp</span><br><span class="line">│   ├── <span class="number">1</span></span><br><span class="line">│   │   └── <span class="number">00</span></span><br><span class="line">│   ├── <span class="number">2</span></span><br><span class="line">│   │   └── <span class="number">00</span></span><br><span class="line">│   ├── <span class="number">3</span></span><br><span class="line">│   │   └── <span class="number">00</span></span><br><span class="line">│   ├── <span class="number">4</span></span><br><span class="line">│   │   └── <span class="number">00</span></span><br><span class="line">│   ├── <span class="number">5</span></span><br><span class="line">│   │   └── <span class="number">00</span></span><br><span class="line">│   └── <span class="number">6</span></span><br><span class="line">│       └── <span class="number">00</span></span><br><span class="line">├── sbin</span><br><span class="line">│   └── nginx</span><br><span class="line">├── scgi_temp</span><br><span class="line">├── ssl</span><br><span class="line">│   ├── 9584217_www.radsm.co.key</span><br><span class="line">│   ├── 9584217_www.radsm.co_nginx.zip</span><br><span class="line">│   ├── 9584217_www.radsm.co.pem</span><br><span class="line">│   ├── nginx.crt</span><br><span class="line">│   └── nginx.key</span><br><span class="line">└── uwsgi_temp</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>CGl (Common Gateway Interface) 通用网关【接口】，主要解决的问题是从客户端发送一个请求和数据，服务端获取到请求和数据后可以调用调用 CGI【程序】处理及相应结果给客户端的一种标准规范。</p>
<p>fastcgi，scgi，uwsgi 是 cgi 的升级版</p>
<p>koi-utf、koi-win、win-utf 这三个文件都是与编码转换映射相关的配置文件，用来将一种编码转换成另一种编码</p>
<p><strong>mime.types: 记录的是 HTTP 协议中的 Content-Type 的值和文件后缀名的对应关系</strong></p>
<p>mime.types.default:mime.types 的备份文件</p>
<p><strong>nginx.conf: 这个是 Nginx 的核心配置文件，这个文件非常重要，也是我们即将要学习的重点</strong></p>
<p>nginx.conf.default:nginx.conf 的备份文件</p>
<p><strong>logs: 记录入门的文件，当 nginx 服务器启动后，这里面会有 access.log error.log 和 nginx.pid 三个文件出现。</strong></p>
<p><strong>sbin: 是存放执行程序文件 nginx</strong></p>
<p><strong>nginx 是用来控制 Nginx 的启动和停止等相关的命令。</strong></p>
</blockquote>
<h2 id="nginx启停"><a class="markdownIt-Anchor" href="#nginx启停">#</a> nginx 启停</h2>
<p><code>ps -ef | grep nginx</code>  查看 nginx 的 master 和 work process】</p>
<p>Nginx 后台进程中包含一个 master 进程和多个 worker 进程，master 进程主要用来管理 worker 进程，包含接收外界的信息，并将接收到的信号发送给各个 worker 进程，监控 worker 进程的状态，当 worker 进程出现异常退出后，会自动重新启动新的 worker 进程。而 worker 进程则是专门用来处理用户请求的，各个 worker 进程之间是平等的并且相互独立，处理请求的机会也是一样的。nginx 的进程模型，我们可以通过下图来说明下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 ~]<span class="comment"># ps -ef | grep nginx </span></span><br><span class="line">root     19255 19235  0 10:01 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">root     32091     1  0 Apr14 ?        00:00:00 nginx: master process /usr/local/nginx/sbin/nginx -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">nobody   32092 32091  0 Apr14 ?        00:00:00 nginx: worker process</span><br><span class="line"></span><br><span class="line">[root@hecs-346515 ~]<span class="comment"># cat /usr/local/nginx/logs/nginx.pid </span></span><br><span class="line">32091</span><br></pre></td></tr></table></figure>
<p>nginx 是多进程工作模式</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230405205817349.png" alt="image-20230405205817349"></p>
<table>
<thead>
<tr>
<th>信号</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>TERM/INT</td>
<td>立即关闭整个服务</td>
</tr>
<tr>
<td>QUIT</td>
<td>&quot;优雅&quot; 地关闭整个服务</td>
</tr>
<tr>
<td>HUP</td>
<td>重读配置文件并使用服务对新配置项生效</td>
</tr>
<tr>
<td>USR1</td>
<td>重新打开日志文件，可以用来进行日志切割</td>
</tr>
<tr>
<td>USR2</td>
<td>平滑升级到最新版的 nginx 会使用</td>
</tr>
<tr>
<td>WINCH</td>
<td>所有子进程不在接收处理新连接，相当于给 work 进程发送 QUIT 指令</td>
</tr>
</tbody>
</table>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">kill</span> -TERM PID</span><br><span class="line"><span class="built_in">kill</span> -QUIT PID</span><br><span class="line"><span class="built_in">kill</span> -HUP PID    <span class="comment"># master pid不会变，会重启worker，pid也会改变</span></span><br><span class="line"><span class="built_in">kill</span> -WINCH PID  <span class="comment"># 会关闭worker，不关闭master</span></span><br><span class="line"><span class="built_in">kill</span> -USR1 PID   <span class="comment"># 重新生成并打开日志</span></span><br><span class="line"><span class="built_in">kill</span> -USR2 PID   <span class="comment"># 生成新的master和worker，原来的pid文件变为nginx.pid.oldbin ，在QUIT关闭旧PID</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">[root@hecs-346515 sbin]# ./nginx -?</span><br><span class="line">nginx version: nginx/1.23.4</span><br><span class="line">Usage: nginx [-?hvVtTq] [-s signal] [-p prefix]</span><br><span class="line">             [-e filename] [-c filename] [-g directives]</span><br><span class="line"></span><br><span class="line">Options:</span><br><span class="line">  -?,-h         : this help</span><br><span class="line">  -v            : show version and exit</span><br><span class="line">  -V            : show version and configure options then exit</span><br><span class="line">  -t            : test configuration and exit</span><br><span class="line">  -T            : test configuration, dump it and exit,会输出nginxconf, mime 等其他信息</span><br><span class="line">  -q            : suppress non-error messages during configuration testing    -tq只输出错误信息</span><br><span class="line">  -s signal     : send signal to a master process: stop, quit, reopen, reload</span><br><span class="line">  -p prefix     : set prefix path (default: /usr/local/nginx/)</span><br><span class="line">  -e filename   : set error log file (default: logs/error.log)</span><br><span class="line">  -c filename   : set configuration file (default: conf/nginx.conf)</span><br><span class="line">  -g directives : set global directives out of configuration file</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">-s singal </span><br><span class="line">stop[快速关闭，类似于TERM/INT信号的作用]</span><br><span class="line">quit[优雅的关闭，类似于QUIT信号的作用] </span><br><span class="line">reopen[重新打开日志文件类似于USR1信号的作用] </span><br><span class="line">reload[类似于HUP信号的作用]</span><br><span class="line"></span><br><span class="line">./nginx -g &quot;pid logs/abc.pid&quot;  # 指定启动时的全局变量</span><br></pre></td></tr></table></figure>
<h2 id="nginx平滑升级"><a class="markdownIt-Anchor" href="#nginx平滑升级">#</a> nginx 平滑升级</h2>
<p>升级 1：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装新版本</span></span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line">make</span><br><span class="line"></span><br><span class="line"><span class="comment"># 备份旧的nginx</span></span><br><span class="line"><span class="built_in">cp</span> /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class="line"><span class="comment"># 复制新的nginx</span></span><br><span class="line"><span class="built_in">cp</span> objs/nginx /usr/local/nginx/sbin/</span><br><span class="line"></span><br><span class="line"><span class="comment"># 发送信号</span></span><br><span class="line"><span class="built_in">kill</span> -USR2 `<span class="built_in">cat</span> /usr/local/nginx/logs/nginx.pid`</span><br><span class="line"></span><br><span class="line"><span class="comment"># 关闭旧的进程</span></span><br><span class="line"><span class="built_in">kill</span> -QUIT `<span class="built_in">cat</span> /usr/local/nginx/logs/nginx.pid.oldbin`</span><br></pre></td></tr></table></figure>
<p>升级 2：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 备份旧的nginx</span></span><br><span class="line"><span class="built_in">cp</span> /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装新版本</span></span><br><span class="line">./configure --prefix=/usr/local/nginx</span><br><span class="line"><span class="built_in">cp</span> objs/nginx /usr/local/nginx/sbin/</span><br><span class="line">make upgrade</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">加减模块可升级基本一样，只是不发送最后的信号</span><br></pre></td></tr></table></figure>
<h2 id="nginxconf"><a class="markdownIt-Anchor" href="#nginxconf">#</a> nginx.conf</h2>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># vim /usr/local/nginx/conf/nginx.conf</span></span><br><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局块</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="comment"># events块 配置网络连接相关内容</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局块</span></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="comment"># http块</span></span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line"></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="comment"># server块，配置虚拟主机等功能，一个http可以由多个server块</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="comment"># location块，匹配到路径，取出资源，展示给用户</span></span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>nginx.conf 配置文件中默认有三大块：全局块、events 块、http 块</p>
<p>http 块中可以配置多个 server 块，每个 server 块又可以配置多个 location 块。</p>
<h3 id="全局块"><a class="markdownIt-Anchor" href="#全局块">#</a> 全局块</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">| 语法   | <span class="attribute">user</span> user [group] |</span><br><span class="line">| ------ | ----------------- |</span><br><span class="line">| 默认值 | nobody            |</span><br><span class="line">| 位置   | 全局块            |</span><br><span class="line"></span><br><span class="line">user www;</span><br><span class="line"><span class="comment"># 默认为nobody</span></span><br><span class="line"><span class="comment"># 如果user 的值是普通用户，那么root /root/html 会产生403的错误</span></span><br></pre></td></tr></table></figure>
<p>综上所述，使用 user 指令可以指定启动运行工作进程的用户及用户组，这样对于系统的权限访问控制的更加精细，也更加安全。</p>
<p>master_process: 用来指定是否开启工作进程。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>master_process on|off;</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认值</td>
<td>master_process on;</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody>
</table>
<p>用于配置 Nginx 生成工作进程的数量，这个是 Nginx 服务器实现并发处理服务的关键所在。理论上来说 workder process 的值越大，可以支持的并发处理量也越多，但事实上这个值的设定是需要受到来自服务器自身的限制，建议将该值和服务器 CPU 的内核数保存一致。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th style="text-align:left">worker_processes     num/auto;</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认值</td>
<td style="text-align:left">1</td>
</tr>
<tr>
<td>位置</td>
<td style="text-align:left">全局块</td>
</tr>
</tbody>
</table>
<p>设定 Nginx 是否以守护进程的方式启动。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>daemon on|off;</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认值</td>
<td>daemon on;</td>
</tr>
<tr>
<td>位置</td>
<td>全局块</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">master_process</span> <span class="literal">on</span>|<span class="literal">off</span>; <span class="comment"># 是否开启工作进程，default on</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_process</span> num|auto; <span class="comment"># 建议设置的和服务器cpu内核个数保持一致，生成工作进程的数量</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">on</span>|<span class="literal">off</span>  <span class="comment"># 是否以守护进程启动，default on</span></span><br><span class="line"></span><br><span class="line">pid /usr/local/nginx/logs <span class="comment"># nginx.pid位置</span></span><br><span class="line"></span><br><span class="line">error_log /usr/local/nginx/logs/ <span class="literal">error</span> <span class="comment"># error_logs  可以配置在全局，http，server，location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 其中日志级别的值有：debug|info|notice|warn|error|crit|alert|emerg，这块建议大家设置的时候不要设置成info以下的等级，因为会带来大量的磁盘I/O消耗，影响Nginx的性能。</span></span><br><span class="line"></span><br><span class="line">include /usr/local/nginx/conf/aaa.conf  <span class="comment"># 引入其他配置，可以在任何位置配置</span></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="events块"><a class="markdownIt-Anchor" href="#events块">#</a> events 块</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">默认值<span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">accept_mutex</span> <span class="literal">on</span>;   <span class="comment"># 解决惊群，用来设置nginx网络链接序列化，一个个唤醒worker  将会对多个Nginx进程接收连接进行序列号，一个个来唤醒接收，就防止了多个进程对连接的争抢。</span></span><br><span class="line"></span><br><span class="line">默认值<span class="attribute">multi_accept</span> <span class="literal">off</span>;</span><br><span class="line"><span class="attribute">multi_accept</span> <span class="literal">on</span>;  <span class="comment"># 是否允许同时接受多个网络链接</span></span><br><span class="line">如果multi_accept被禁止了，nginx一个工作进程只能同时接受一个新的连接。否则，一个工作进程可以同时接受所有的新连接</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attribute">worker_connections</span> <span class="number">512</span>;  <span class="comment"># 单个worker进程最大连接数，number值不能大于操作系统支持打开的最大文件句柄数量。</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">use</span> <span class="literal">epoll</span>|<span class="literal">select</span>|<span class="literal">poll</span>|<span class="literal">kqueue</span>; 		<span class="comment"># 来设置Nginx服务器选择哪种事件驱动来处理网络消息。建议epoll</span></span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="http-块"><a class="markdownIt-Anchor" href="#http-块">#</a> http 块</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mime-type Nginx作为web服务器，也需要能够识别前端请求的资源类型。</span></span><br><span class="line">Nginx的配置文件中，默认有两行配置</span><br><span class="line"><span class="attribute">include</span> mime.types;</span><br><span class="line"><span class="attribute">default_type</span> application/octet-stream;   <span class="comment"># http,server,location 可以配置，默认二进制流，浏览器会下载文件</span></span><br><span class="line"></span><br><span class="line">| 语法   | <span class="attribute">default_type</span> mime-type;   |</span><br><span class="line">| ------ | ------------------------- |</span><br><span class="line">| 默认值 | <span class="attribute">default_type</span> text/plain； |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">location /get_text &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/html;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&quot;&lt;h1&gt;shabi&lt;/h1&gt;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">sendfile</span> <span class="literal">on</span>;  <span class="comment"># 配置位置 http,server,location</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">keepalive_timeout</span>  <span class="number">75</span>  <span class="comment"># 长连接超时协议</span></span><br><span class="line"></span><br><span class="line">keepalive_requests <span class="number">100</span> <span class="comment"># 长连接处理请求个数</span></span><br></pre></td></tr></table></figure>
<h3 id="定义日志"><a class="markdownIt-Anchor" href="#定义日志">#</a> 定义日志</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nginx中日志的类型分access.log、error.log</span><br><span class="line"></span><br><span class="line">access.log:用来记录用户所有的访问请求。</span><br><span class="line"></span><br><span class="line">error.log:记录nginx本身运行时的错误信息，不会记录用户的访问请求。</span><br><span class="line"></span><br><span class="line">Nginx服务器支持对服务日志的格式、大小、输出等进行设置，需要使用到两个指令，分别是access_log和log_format指令。</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>语法</th>
<th>access_log path[format[buffer=size]]</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认值</td>
<td>access_log logs/access.log combined;</td>
</tr>
<tr>
<td>位置</td>
<td><code>http</code> ,  <code>server</code> ,  <code>location</code></td>
</tr>
</tbody>
<tbody>
<tr>
<td>语法</td>
<td>log_format name [escape=default|json|none] string…;</td>
</tr>
<tr>
<td>------</td>
<td>--------------------------------------------------------</td>
</tr>
<tr>
<td>默认值</td>
<td>log_format combined “…”;</td>
</tr>
<tr>
<td>位置</td>
<td>http</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">access_log</span> /usr/local/nginx/logs hahaha;   <span class="comment"># http，server，location块配置</span></span><br><span class="line"><span class="attribute">log_format</span> hahaha <span class="string">&#x27;fomat: <span class="variable">$http_user_agent</span>&#x27;</span>;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">sendfile:用来设置Nginx服务器是否使用sendfile()传输文件，该属性可以大大提高Nginx处理静态资源的性能</span><br><span class="line">默认值<span class="attribute">sendfile</span> <span class="literal">off</span>;</span><br><span class="line">位置http、server、<span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用keepalive模式，可以告诉服务器端在处理完一个请求后保持这个TCP连接的打开状态，若接收到来自这个客户端的其他请求，服务端就会利用这个未被关闭的连接，而不需要重新创建一个新连接，提升效率，但是这个连接也不能一直保持，这样的话，连接如果过多，也会是服务端的性能下降，这个时候就需要我们进行设置其的超时时间。</span></span><br><span class="line">keepalive_timeout:用来设置长连接的超时时间。</span><br><span class="line">默认值keepalive_timeout <span class="number">75s</span>;</span><br><span class="line">位置http、server、<span class="section">location</span></span><br><span class="line"></span><br><span class="line">keepalive_requests:用来设置一个keep-alive连接使用的次数。</span><br><span class="line">默认值keepalive_requests <span class="number">100</span>;</span><br><span class="line">位置http、server、<span class="section">location</span></span><br></pre></td></tr></table></figure>
<h3 id="server-location"><a class="markdownIt-Anchor" href="#server-location">#</a> server、location</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;</span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">      </span><br><span class="line">       <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span>  /50x.html;</span><br><span class="line">       <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>http.server,location 中都有的，location 优先生效</p>
<h3 id="exercise"><a class="markdownIt-Anchor" href="#exercise">#</a> exercise</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">（1）有如下访问：</span><br><span class="line">	http://192.168.200.133:8081/server1/location1</span><br><span class="line">		访问的是：index_sr1_location1.html</span><br><span class="line">	http://192.168.200.133:8081/server1/location2</span><br><span class="line">		访问的是：index_sr1_location2.html</span><br><span class="line">	http://192.168.200.133:8082/server2/location1</span><br><span class="line">		访问的是：index_sr2_location1.html</span><br><span class="line">	http://192.168.200.133:8082/server2/location2</span><br><span class="line">		访问的是：index_sr2_location2.html</span><br><span class="line">（2）如果访问的资源不存在，</span><br><span class="line">	返回自定义的404页面</span><br><span class="line">（3）将/server1和/server2的配置使用不同的配置文件分割</span><br><span class="line">	将文件放到/home/www/conf.d目录下，然后使用include进行合并</span><br><span class="line">（4）为/server1和/server2各自创建一个访问日志文件</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># /home/www/conf.d/haha1.conf</span></span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8081</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">	    <span class="attribute">access_log</span> /usr/local/nginx/logs main1;</span><br><span class="line">        <span class="section">location</span> server1/location1 &#123;</span><br><span class="line">            <span class="attribute">root</span>   /home/www/myweb;</span><br><span class="line">            <span class="attribute">index</span>  index_sr1_location1.html index_sr1_location1.htm;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="section">location</span> server1/location2 &#123;</span><br><span class="line">            <span class="attribute">root</span>   /home/www/myweb;</span><br><span class="line">            <span class="attribute">index</span>  index_sr1_location2.html index_sr1_location2.htm;</span><br><span class="line">        &#125;</span><br><span class="line">       </span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   /home/www/myweb;</span><br><span class="line">        	<span class="attribute">index</span> <span class="number">404</span>.html;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># /home/www/conf.d/haha2.conf    </span></span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">8082</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="attribute">access_log</span> /usr/local/nginx/logs main2;</span><br><span class="line">        <span class="section">location</span> server2/location2 &#123;</span><br><span class="line">            <span class="attribute">root</span>   html;</span><br><span class="line">            <span class="attribute">index</span>  index_sr2_location2.html index_sr2_location2.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span> <span class="number">404</span>  /50x.html;</span><br><span class="line">        <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">            <span class="attribute">root</span>   /home/www/myweb;</span><br><span class="line">        	<span class="attribute">index</span> <span class="number">404</span>.html;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>;</span><br><span class="line"><span class="attribute">user</span> www;</span><br><span class="line"><span class="attribute">error_log</span> logs/<span class="literal">error</span>.log;</span><br><span class="line"><span class="attribute">pid</span> logs/nginx.pid;</span><br><span class="line"><span class="attribute">daemon</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="section">events</span> &#123;</span><br><span class="line">    <span class="attribute">accept_mutex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">multi_accept</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">use</span> <span class="literal">epoll</span>;</span><br><span class="line">    <span class="attribute">worker_connections</span> <span class="number">1024</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="attribute">include</span>       mime.types;</span><br><span class="line">    <span class="attribute">default_type</span>  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">sendfile</span>        <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">    <span class="attribute">keepalive_requests</span> <span class="number">100</span>;</span><br><span class="line">    </span><br><span class="line">	<span class="attribute">log_format</span>  main1  	<span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                       	<span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                       	<span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="attribute">log_format</span>  main2  	<span class="string">&#x27;<span class="variable">$remote_addr</span> - <span class="variable">$remote_user</span> [<span class="variable">$time_local</span>] &quot;<span class="variable">$request</span>&quot; &#x27;</span></span><br><span class="line">                   		<span class="string">&#x27;<span class="variable">$status</span> <span class="variable">$body_bytes_sent</span> &quot;<span class="variable">$http_referer</span>&quot; &#x27;</span></span><br><span class="line">                   		<span class="string">&#x27;&quot;<span class="variable">$http_user_agent</span>&quot; &quot;<span class="variable">$http_x_forwarded_for</span>&quot;&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;</span><br><span class="line"></span><br><span class="line">	<span class="attribute">include</span> /home/www/conf.d/<span class="regexp">*.conf</span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="配置nginx为系统服务"><a class="markdownIt-Anchor" href="#配置nginx为系统服务">#</a> 配置 nginx 为系统服务</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vim /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[Unit]</span><br><span class="line">Description=nginx web service</span><br><span class="line">Documentation=http://nginx.org/en/docs/</span><br><span class="line">After=network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=forking</span><br><span class="line">PIDFile=/usr/local/nginx/logs/nginx.pid</span><br><span class="line">ExecStartPre=/usr/local/nginx/sbin/nginx -t -c /usr/local/nginx/conf/nginx.conf</span><br><span class="line">ExecStart=/usr/local/nginx/sbin/nginx</span><br><span class="line">ExecReload=/usr/local/nginx/sbin/nginx -s reload</span><br><span class="line">ExecStop=/usr/local/nginx/sbin/nginx -s stop</span><br><span class="line">PrivateTmp=true</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=default.target</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 /usr/lib/systemd/system/nginx.service</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">启动: systemctl start nginx</span><br><span class="line">停止: systemctl stop nginx</span><br><span class="line">重启: systemctl restart nginx</span><br><span class="line">重新加载配置文件: systemctl reload nginx   # 不改变master pid，重启worker</span><br><span class="line">查看nginx状态: systemctl status nginx</span><br><span class="line">开机启动: systemctl enable nginx</span><br></pre></td></tr></table></figure>
<h2 id="nginx配置环境变量"><a class="markdownIt-Anchor" href="#nginx配置环境变量">#</a> nginx 配置环境变量</h2>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line">在最后一行添加</span><br><span class="line">export PATH=$PATH:/usr/local/nginx/sbin</span><br><span class="line"></span><br><span class="line">source /etc/profile</span><br></pre></td></tr></table></figure>
<h2 id="nginx虚拟主机"><a class="markdownIt-Anchor" href="#nginx虚拟主机">#</a> nginx 虚拟主机</h2>
<ul>
<li>虚拟 Web 主机指的是在同一台物理服务器中发布多个 Web 站点或应用</li>
<li>独立的网站，独立的项目甚至独立的功能模块都可以使用虚拟主机进行发布</li>
<li>Nginx 可以基于不同的 IP、不同的端口以及不同的域名实现不同的虚拟主机</li>
<li>虚拟主机内的资源收到虚拟主机配置文件内容约束，与其他虚拟主机相对独立</li>
</ul>
<p>配置虚拟主机可以基于端口号也可以基于子域名</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;  <span class="comment"># 域名或主机名</span></span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">       <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">       <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">88</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  a.com;  <span class="comment"># 域名或主机名</span></span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   /www/wwwroot;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">       <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">       <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<h2 id="nginx-静态资源部署"><a class="markdownIt-Anchor" href="#nginx-静态资源部署">#</a> nginx 静态资源部署</h2>
<p>我们所请 求的内容就分为两种类型，一类是静态资源、一类是动态资源。</p>
<p>静态资源即指在服务器端真实存在并且能直接拿来展示的一些文件，比如常见的 html 页面、css 文件、js 文件、图 片、视频等资源；</p>
<p>动态资源即指在服务器端真实存在但是要想获取需要经过一定的业务逻辑处理，根据不同的条件展示在页面不同这 一部分内容，比如说报表数据展示、根据当前登录用户展示相关具体数据等资源；</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">（1）静态资源的配置指令</span><br><span class="line">（2）静态资源的配置优化</span><br><span class="line">（3）静态资源的压缩配置指令</span><br><span class="line">（4）静态资源的缓存处理</span><br><span class="line">（5）静态资源的访问控制，包括跨域问题和防盗链问题</span><br></pre></td></tr></table></figure>
<h3 id="1静态资源的配置指令"><a class="markdownIt-Anchor" href="#1静态资源的配置指令">#</a> （1）静态资源的配置指令</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">默认值<span class="attribute">listen</span> *:<span class="number">80</span> | *:<span class="number">8000</span></span><br><span class="line">位置server</span><br><span class="line">listen *:<span class="number">80</span>;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">8080</span>;    <span class="comment"># server 下配置  监听指定端口上的连接</span></span><br><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1:8000</span>;</span><br><span class="line"><span class="attribute">listen</span> <span class="number">127.0.0.1</span>; <span class="comment"># 监听指定IP的所有端口</span></span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="comment"># default_server属性是标识符，用来将此虚拟主机设置成默认主机。所谓的默认主机指的是如果没有匹配到对应的address:port，则会默认执行的。如果不指定默认使用的是第一个server。</span></span><br><span class="line">如果没有匹配成功，使用第一个server响应请求</span><br><span class="line">比如<span class="attribute">server_name</span> 写的<span class="number">127.0.0.1</span>，但是访问<span class="number">192.168.1.12</span>，会匹配第一个server</span><br><span class="line"></span><br><span class="line">如果配置了default_server ,会使用default_server 所在的server响应</span><br><span class="line">listen <span class="number">8080</span> default_server;</span><br><span class="line"></span><br><span class="line">-------------------------------------------------</span><br><span class="line"></span><br><span class="line"><span class="attribute">server_name</span> </span><br><span class="line">默认值server_name  <span class="string">&quot;&quot;</span>;</span><br><span class="line">位置<span class="attribute">server</span></span><br><span class="line"></span><br><span class="line">配置方式<span class="number">1</span>:精确配置</span><br><span class="line">server_name www.baidu.com baidu.com;</span><br><span class="line">如果你没有域名，你就要改hosts啦</span><br><span class="line">匹配方式2:通配符匹配</span><br><span class="line"><span class="attribute">server_name</span> <span class="regexp">*.baidu.com</span>;</span><br><span class="line">*不能放在域名中间 ，比如 <span class="attribute">server_name</span> <span class="regexp">www.*</span>.com;</span><br><span class="line">*不能在最后，比如 www.baidu.c*</span><br><span class="line">匹配方式三：正则匹配</span><br><span class="line"><span class="attribute">server_name</span> ~^www\.(\w+)\.com$;</span><br><span class="line"><span class="section">location</span> / &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;====<span class="variable">$1</span>&#x27;</span>;</span><br><span class="line">    <span class="comment"># ~后不能有空格</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 三种匹配方式都存在，且都能匹配，那么精确匹配 &gt; 前置通配符 &gt; 后置通配符 &gt; 正则匹配 &gt; default_server </span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># location 用来设置请求的URI</span></span><br><span class="line">位置server,<span class="section">location</span></span><br><span class="line"><span class="number">1</span>.不带任何符号</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="section">location</span> /abc &#123;</span><br><span class="line">        <span class="comment"># /abc /abcdef /abc/ /abc?tom=1  都可以被匹配到</span></span><br><span class="line">        <span class="attribute">default_type</span> text/plain;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;success&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> = /abc &#123;</span><br><span class="line">        <span class="comment"># 精确匹配 /abc /abc?tom=1 </span></span><br><span class="line">        <span class="comment"># 不能匹配 /abc/ /abcde</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> ~^/abc\w$ &#123;</span><br><span class="line">        <span class="comment"># abc_ 区分大小写</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># ~ ： 用于表示当前uri中包含了正则表达式，并且区分大小写</span></span><br><span class="line">	<span class="comment"># ~*:  用于表示当前uri中包含了正则表达式，并且不区分大小写</span></span><br><span class="line">    </span><br><span class="line">    <span class="section">location</span> ~*^/abc\w$ &#123;</span><br><span class="line">        <span class="comment"># abc_ 不区分大小写 </span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># ^~: 用于不包含正则表达式的uri前，功能和不加符号的一致，唯一不同的是，如果模式匹配，那么就停止搜索其他模式了。</span></span><br><span class="line">    <span class="section">location</span><span class="regexp"> ^~/abcd</span> &#123;</span><br><span class="line">        <span class="comment"># 非贪婪</span></span><br><span class="line">        <span class="comment"># 不加^ 贪婪匹配</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># root  path为Nginx服务器接收到请求以后查找资源的根目录路径。</span></span><br><span class="line">默认值<span class="attribute">root</span> html;</span><br><span class="line">位置http、server、<span class="section">location</span></span><br><span class="line"><span class="comment"># alias：用来更改location的URI</span></span><br><span class="line">位置<span class="section">location</span></span><br><span class="line"></span><br><span class="line">/usr/local/nginx/html/images/<span class="number">1</span>.jpg</span><br><span class="line"><span class="section">location</span> /images &#123;</span><br><span class="line">    <span class="attribute">root</span> html; <span class="comment"># root处理结果 root路径+location</span></span><br><span class="line">    <span class="attribute">alias</span> html/images; <span class="comment">#alias处理结果 直接使用Alisa路径替换location路径，如果location以/结尾,那么alias也要以/结尾</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在`/usr/local/nginx/html`目录下创建一个 images目录,并在目录下放入一张图片mv.png图片</span></span><br><span class="line"><span class="section">location</span> /images &#123;</span><br><span class="line">	<span class="attribute">root</span> /usr/local/nginx/html;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /images &#123;</span><br><span class="line">	<span class="attribute">alias</span> /usr/local/nginx/html/images/;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 访问 http://192.168.200.133/images/mv.png 时，上述效果相同</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># index</span></span><br><span class="line">网站的默认页</span><br><span class="line">默认值<span class="attribute">index</span> index.html;位置http、server、<span class="section">location</span></span><br><span class="line">index index.html index.htm;  从左往右匹配，一经匹配，立即执行</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># error_page error_page:设置网站的错误页面</span></span><br><span class="line"><span class="comment"># 1.</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">error_page</span> <span class="number">404</span> www.baidu.com;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">500</span> <span class="number">404</span> /50x.html;</span><br><span class="line"><span class="section">location</span> /50x.html &#123;</span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3.不能直接访问的location</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> <span class="variable">@hahaha</span>;</span><br><span class="line"><span class="section">location</span> <span class="variable">@hahaha</span> &#123;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">456</span> <span class="string">&#x27;shabi&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4.将相应代码更改为另外一个</span></span><br><span class="line"><span class="attribute">error_page</span> <span class="number">404</span> =<span class="number">200</span> /50x.html;</span><br><span class="line"><span class="section">location</span> /50x.html &#123;</span><br><span class="line">	<span class="attribute">root</span> html;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="静态资源优化"><a class="markdownIt-Anchor" href="#静态资源优化">#</a> 静态资源优化</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">sendfile</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">tcp_nopush</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">tcp_nodelay</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="attribute">sendfile</span> 高效的文件传输，http，server，location</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407163654759.png" alt="image-20230407163654759"  />
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407163846712.png" alt="image-20230407163846712"  />
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">tcp_nopush</span>   <span class="comment"># sendfile 打开才生效 位置http,server,location  提升传输效率，即存满缓冲区再发，不要立即push</span></span><br><span class="line">tcp_nodelay  <span class="comment"># keep-alive连接开启才生效 提高网络包传输实时性，即有数据不等缓冲区满立即发 不要延迟</span></span><br></pre></td></tr></table></figure>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230407164306027.png" alt="image-20230407164306027" style="zoom:67%;" /> 
<p>在 linux2.5.9 以后的版本中两者是可以兼容的，三个指令都开启的好处是，sendfile 可以开启高效的文件传输模式，tcp_nopush 开启可以确保在发送到客户端之前数据包已经充分 “填满”， 这大大减少了网络开销，并加快了文件发送的速度。 然后，当它到达最后一个可能因为没有 “填满” 而暂停的数据包时，Nginx 会忽略 tcp_nopush 参数， 然后，tcp_nodelay 强制套接字发送数据。由此可知，TCP_NOPUSH 可以与 TCP_NODELAY 一起设置，它比单独配置 TCP_NODELAY 具有更强的性能。所以我们可以使用如下配置来优化 Nginx 静态资源的处理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sendfile on;</span><br><span class="line">tcp_nopush on;</span><br><span class="line">tcp_nodelay on;</span><br></pre></td></tr></table></figure>
<h2 id="nginx静态资源压缩"><a class="markdownIt-Anchor" href="#nginx静态资源压缩">#</a> nginx 静态资源压缩</h2>
<p>在 Nginx 的配置文件中可以通过配置 gzip 来对静态资源进行压缩，相关的指令可以配置在 http 块、server 块和 location 块中，Nginx 可以通过</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ngx_http_gzip_module模块</span><br><span class="line">ngx_http_gzip_static_module模块</span><br><span class="line">ngx_http_gunzip_module模块</span><br></pre></td></tr></table></figure>
<p>对这些指令进行解析和处理</p>
<p>以下指令都可以在 http，server，location 中配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>   <span class="comment"># 用于开启或者关闭gzip功能 http,server,location</span></span><br><span class="line">gzip_types mine-type  <span class="comment"># 默认text/html,对mime类型的资源做压缩，多个值空格分隔，使用*压缩所有，http，server，location.不建议压缩图片视频等资源</span></span><br><span class="line">gzip_comp_level <span class="number">1</span>    <span class="comment"># 默认1，取值1-9，值越大，压缩等级最高。设置越高，浪费cpu资源越大。建议6</span></span><br><span class="line">gzip_vary <span class="literal">off</span>  <span class="comment"># 默认off，是否携带“Vary:Accept-Encoding”头域的响应头部。主要是告诉接收方，所发送的数据经过了Gzip压缩处理</span></span><br><span class="line">gzip_buffers <span class="number">32</span> <span class="number">4k</span>    <span class="comment"># 主要实现的是申请number个每个大小为size的缓冲区空间。</span></span><br><span class="line">gzip_disable <span class="string">&quot;MSIE [1-6]\.&quot;</span>;   <span class="comment"># 针对不同客户端选择是否启用压缩</span></span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>    <span class="comment"># 该指令是指定使用Gzip的HTTP最低版本，该指令一般采用默认值即可。</span></span><br><span class="line">gzip_min_length <span class="number">20</span>  <span class="comment"># 小于20字节不在压缩，可以加单位。但是使用了Chunk编码动态压缩，该指令将被忽略。建议设置为1K或以上</span></span><br><span class="line">gzip_proxied <span class="literal">off</span>;  <span class="comment"># 该指令设置是否对服务端返回的结果进行Gzip压缩。</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_proxied</span> 取值</span><br><span class="line"><span class="literal">off</span> - 关闭Nginx服务器对后台服务器返回结果的Gzip压缩</span><br><span class="line">expired - 启用压缩，如果header头中包含 <span class="string">&quot;Expires&quot;</span> 头信息</span><br><span class="line"><span class="literal">no</span>-cache - 启用压缩，如果header头中包含 <span class="string">&quot;Cache-Control:no-cache&quot;</span> 头信息</span><br><span class="line"><span class="literal">no</span>-store - 启用压缩，如果header头中包含 <span class="string">&quot;Cache-Control:no-store&quot;</span> 头信息</span><br><span class="line">private - 启用压缩，如果header头中包含 <span class="string">&quot;Cache-Control:private&quot;</span> 头信息</span><br><span class="line">no_last_modified - 启用压缩,如果header头中不包含 <span class="string">&quot;Last-Modified&quot;</span> 头信息</span><br><span class="line">no_etag - 启用压缩 ,如果header头中不包含 <span class="string">&quot;ETag&quot;</span> 头信息</span><br><span class="line">auth - 启用压缩 , 如果header头中包含 <span class="string">&quot;Authorization&quot;</span> 头信息</span><br><span class="line">any - 无条件启用压缩</span><br></pre></td></tr></table></figure>
<p>新建 nginx_gzip.conf</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_types</span> *;</span><br><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">6</span>;</span><br><span class="line"><span class="attribute">gzip_min_length</span> <span class="number">1024</span>;</span><br><span class="line"><span class="attribute">gzip_buffers</span> <span class="number">4</span> <span class="number">16K</span>;</span><br><span class="line"><span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line"><span class="attribute">gzip_vary</span>  <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">gzip_disable</span> <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line"><span class="attribute">gzip_proxied</span>  <span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在nginx.<span class="attribute">conf</span> </span><br><span class="line">include nginx_gzip.conf</span><br></pre></td></tr></table></figure>
<p>gzip 和 sendfile 冲突</p>
<p>gzip 压缩是在用户态完成的，使用 sendfile 之后就不在从内核态到用户态，因此无法同时使用</p>
<p>可以在存储压缩过的文件，直接发送压缩过的文件，客户端解压</p>
<p><strong>可以使用 ngx_http_gzip_static_module 模块的 gzip_static 指令来解决。</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_static</span> <span class="literal">off</span>;  <span class="comment"># 检查与访问资源同名的.gz文件时，response中以gzip相关的header返回.gz文件的内容。</span></span><br><span class="line">取值 <span class="attribute">on</span> <span class="literal">off</span> always</span><br><span class="line">always 浏览器不支持压缩都会发送，<span class="literal">on</span>会先判断</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">nginx</span> 编译时默认没有该模块</span><br><span class="line">./confighure --with-http_gzip_static_module </span><br></pre></td></tr></table></figure>
<p>使用该模块后会在 header 中加入 <code>content-Encoding: gzip</code>   <code>Vary: Accept-Encoding</code></p>
<h3 id="brotil"><a class="markdownIt-Anchor" href="#brotil">#</a> brotil</h3>
<p>需要 https 支持</p>
<p>br 和 gzip 可以共存，br 优先级更高</p>
<h4 id="安装"><a class="markdownIt-Anchor" href="#安装">#</a> 安装</h4>
<ul>
<li>官网
<ul>
<li><code>https://github.com/google/ngx_brotli</code></li>
<li><code>https://codeload.github.com/google/brotli/tar.gz/refs/tags/v1.0.9</code></li>
</ul>
</li>
<li>下载 两个项目</li>
<li>解压缩</li>
</ul>
<p>把 brotli-1.0.9 下所有文件移走</p>
<p><code>mv ./* ../ngx_brotli-1.0.0rc/deps/brotli/</code></p>
<p>编译</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --with-compat --add-dynamic-module=/root/ngx_brotli-1.0.0rc --prefix=/usr/local/nginx/</span><br></pre></td></tr></table></figure>
<ul>
<li>make</li>
<li>将 <code>ngx_http_brotli_filter_module.so</code>   <code>ngx_http_brotli_static_module.so</code>  拷贝到 <code>/usr/local/nginx/modules/</code></li>
<li>复制 nginx 主程序</li>
<li>配置文件中添加</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_filter_module.so&quot;;</span><br><span class="line">load_module &quot;/usr/local/nginx/modules/ngx_http_brotli_static_module.so&quot;;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">brotli on;</span><br><span class="line">    brotli_static on;</span><br><span class="line">	brotli_comp_level 6;</span><br><span class="line">	brotli_buffers 16 8k;</span><br><span class="line">	brotli_min_length 20;</span><br><span class="line">	brotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">            #gunzip on;</span><br><span class="line">            #gzip_static always;</span><br><span class="line">            gzip on;  #默认关闭</span><br><span class="line">            gzip_buffers 16 8k; #内存缓冲16个8k的块缓冲  32 4k 32位  16 8k 64位</span><br><span class="line">            gzip_comp_level 6; #压缩等级</span><br><span class="line">            gzip_http_version 1.1;  #http版本号</span><br><span class="line">            gzip_min_length 256; #最小返回数据文件，&gt;这个值才压缩</span><br><span class="line">            gzip_proxied any; #只针对反向代理生效，针对上游服务器返回header做条件压缩</span><br><span class="line">            gzip_vary on;</span><br><span class="line">            gzip_types text/xml text/css text/javascript;   #针对那些mine文件压缩</span><br><span class="line">            gzip_disable MSIE6   # 针对那些浏览器关闭压缩，最好别搞正则， 对性能消耗太大</span><br><span class="line">            proxy_http_version 1.1;</span><br><span class="line">            proxy_set_header Connection &quot;&quot;;</span><br><span class="line">            proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">            proxy_pass http://httpds;</span><br><span class="line">            brotli on;</span><br><span class="line">            brotli_static on;</span><br><span class="line">            brotli_comp_level 6;</span><br><span class="line">            brotli_buffers 16 8k;</span><br><span class="line">            brotli_min_length 20;</span><br><span class="line">            brotli_types text/plain text/css text/javascript application/javascript text/xml application/xml application/xml+rss application/json image/jpeg image/gif image/png;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">#测试：</span><br><span class="line">curl -H &#x27;accept-encoding:br&#x27; -I http://192.168.13.132</span><br></pre></td></tr></table></figure>
<h2 id="静态资源缓存处理"><a class="markdownIt-Anchor" href="#静态资源缓存处理">#</a> 静态资源缓存处理</h2>
<p>缓存种类</p>
<blockquote>
<p>客户端缓存</p>
<p>​	浏览器缓存</p>
<p>服务端缓存</p>
<p>​	Nginx / Redis / Memcached 等</p>
</blockquote>
<p>浏览器缓存</p>
<p>是为了节约网络的资源加速浏览，浏览器在用户磁盘上对最近请求过的文档进行存储，当访问者再次请求这个页面时，浏览器就可以从本地磁盘显示文档，这样就可以加速页面的阅览.</p>
<blockquote>
<p>成本最低的一种缓存实现</p>
<p>减少网络带宽消耗</p>
<p>降低服务器压力</p>
<p>减少网络延迟，加快页面打开速度</p>
</blockquote>
<p>header 和缓存相关字段</p>
<table>
<thead>
<tr>
<th>header</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>Expires</td>
<td>缓存过期的日期和时间</td>
</tr>
<tr>
<td>Cache-Control</td>
<td>设置和缓存相关的配置信息</td>
</tr>
<tr>
<td>Last-Modified</td>
<td>请求资源最后修改时间</td>
</tr>
<tr>
<td>ETag</td>
<td>请求变量的实体标签的当前值，比如文件的 MD5 值</td>
</tr>
</tbody>
</table>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417111638213.png" alt="image-20230417111638213"></p>
<blockquote>
<p>（1）用户首次通过浏览器发送请求到服务端获取数据，客户端是没有对应的缓存，所以需要发送 request 请求来获取数据；</p>
<p>（2）服务端接收到请求后，获取服务端的数据及服务端缓存的允许后，返回 200 的成功状态码并且在响应头上附上对应资源以及缓存信息；</p>
<p>（3）当用户再次访问相同资源的时候，客户端会在浏览器的缓存目录中查找是否存在响应的缓存文件</p>
<p>（4）如果没有找到对应的缓存文件，则走 (2) 步</p>
<p>（5）如果有缓存文件，接下来对缓存文件是否过期进行判断，过期的判断标准是 (Expires),</p>
<p>（6）如果没有过期，则直接从本地缓存中返回数据进行展示</p>
<p>（7）如果 Expires 过期，接下来需要判断缓存文件是否发生过变化</p>
<p>（8）判断的标准有两个，一个是 ETag (Entity Tag), 一个是 Last-Modified</p>
<p>（9）判断结果是未发生变化，则服务端返回 304，直接从缓存文件中获取数据</p>
<p>（10）如果判断是发生了变化，重新从服务端获取数据，并根据缓存协商 (服务端所设置的是否需要进行缓存数据的设置) 来进行数据缓存。</p>
</blockquote>
<p>强缓存和弱缓存的区别在于是否还要向服务端请求</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">expires</span> <span class="literal">off</span>;  <span class="comment"># expires:该指令用来控制页面缓存的作用。可以通过该指令控制HTTP应答中的“Expires&quot;和”Cache-Control&quot;</span></span><br><span class="line"><span class="attribute">expires</span>   [modified] time</span><br><span class="line">expires epoch|max|<span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line">time:可以整数也可以是负数，指定过期时间，如果是负数，Cache-Control则为no-cache,如果为整数或0，则Cache-Control的值为max-age=time;</span><br><span class="line">epoch: 指定Expires的值为&#x27;1 January,1970,00:00:01 GMT&#x27;(1970-01-01 00:00:00)，Cache-Control的值no-<span class="attribute">cache</span></span><br><span class="line">max:指定Expires的值为<span class="string">&#x27;31 December2037 23:59:59GMT&#x27;</span> (<span class="number">2037</span>-<span class="number">12</span>-<span class="number">31</span> <span class="number">23</span>:<span class="number">59</span>:<span class="number">59</span>) ，Cache-Control的值为<span class="number">10</span>年</span><br><span class="line"><span class="literal">off</span>:默认不缓存。</span><br><span class="line"></span><br><span class="line">location <span class="regexp">~ .*\.(html|js|css|png)$</span> &#123;</span><br><span class="line">    <span class="attribute">expires</span> <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">off</span>												整数											负数</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230410170254546.png" alt="image-20230410170254546"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># add_header指令是用来添加指定的响应头和响应值。</span></span><br><span class="line"><span class="attribute">add_header</span> Cache-control <span class="literal">no</span>-store</span><br><span class="line"><span class="comment"># 也能实现不缓存</span></span><br></pre></td></tr></table></figure>
<p>缓存响应指令：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Cache-control: must-revalidate</span><br><span class="line">Cache-control: no-cache</span><br><span class="line">Cache-control: no-store</span><br><span class="line">Cache-control: no-transform</span><br><span class="line">Cache-control: public</span><br><span class="line">Cache-control: private</span><br><span class="line">Cache-control: proxy-revalidate</span><br><span class="line">Cache-Control: max-age=&lt;seconds&gt;</span><br><span class="line">Cache-control: s-maxage=&lt;seconds&gt;</span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th>指令</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>must-revalidate</td>
<td>可缓存但必须再向源服务器进行确认</td>
</tr>
<tr>
<td>no-cache</td>
<td>缓存前必须确认其有效性</td>
</tr>
<tr>
<td>no-store</td>
<td>不缓存请求或响应的任何内容</td>
</tr>
<tr>
<td>no-transform</td>
<td>代理不可更改媒体类型</td>
</tr>
<tr>
<td>public</td>
<td>可向任意方提供响应的缓存</td>
</tr>
<tr>
<td>private</td>
<td>仅向特定用户返回响应</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>要求中间缓存服务器对缓存的响应有效性再进行确认</td>
</tr>
<tr>
<td>max-age=&lt;秒&gt;</td>
<td>响应最大 Age 值</td>
</tr>
<tr>
<td>s-maxage=&lt;秒&gt;</td>
<td>公共缓存服务器响应的最大 Age 值</td>
</tr>
</tbody>
</table>
<p>max-age=[秒]：</p>
<h2 id="nginx解决跨域问题"><a class="markdownIt-Anchor" href="#nginx解决跨域问题">#</a> nginx 解决跨域问题</h2>
<p>同源：协议、域名 (IP)、端口相同即为同源</p>
<p>有两台服务器分别为 A,B, 如果从服务器 A 的页面发送异步请求到服务器 B 获取数据，如果服务器 A 和服务器 B 不满足同源策略，则就会出现跨域问题。</p>
<p>Access-Control-Allow-Origin: 直译过来是允许跨域访问的源地址信息，可以配置多个 (多个用逗号分隔)，也可以使用 <code>*</code>  代表所有源</p>
<p>Access-Control-Allow-Methods: 直译过来是允许跨域访问的请求方式，值可以为 GET POST PUT DELETE…, 可以全部设置，也可以根据需要设置，多个用逗号分隔</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解决跨域问题</span></span><br><span class="line"><span class="section">location</span> &#123;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin http://192.168.13.132:80;   <span class="comment"># * 匹配所有</span></span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">location</span> /getUser&#123;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Origin *;</span><br><span class="line">    <span class="attribute">add_header</span> Access-Control-Allow-Methods GET,POST,PUT,DELETE;</span><br><span class="line">    <span class="attribute">default_type</span> application/json;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&#123;&quot;id&quot;:1,&quot;name&quot;:&quot;TOM&quot;,&quot;age&quot;:18&#125;&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="防盗链"><a class="markdownIt-Anchor" href="#防盗链">#</a> 防盗链</h2>
<p>资源盗链指的是此内容不在自己服务器上，而是通过技术手段，绕过别人的限制将别人的内容放到自己页面上最终展示给用户。以此来盗取大网站的空间和流量。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417112346770.png" alt="image-20230417112346770"></p>
<p>Referer, 当浏览器向 web 服务器发送请求的时候，一般都会带上 Referer, 来告诉浏览器该网页是从哪个页面链接过来的。</p>
<p>在二次请求时会在请求头中加入 referer，第一次访问时是没有的</p>
<p>后台服务器可以根据获取到的这个 Referer 信息来判断是否为自己信任的网站地址，如果是则放行继续访问，如果不是则可以返回 403 (服务端拒绝访问) 的状态信息。</p>
<p>valid_referers:nginx 会通就过查看 referer 自动和 valid_referers 后面的内容进行匹配，如果匹配到了就将 $invalid_referer 变量置 0，如果没有匹配到，则将 $invalid_referer 变量置为 1，匹配的过程中不区分大小写。</p>
<table>
<thead>
<tr>
<th>语法</th>
<th>valid_referers none|blocked|server_names|string…</th>
</tr>
</thead>
<tbody>
<tr>
<td>默认值</td>
<td>—</td>
</tr>
<tr>
<td>位置</td>
<td>server、location</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 防盗链测试</span></span><br><span class="line"><span class="attribute">curl</span> 测试防盗链</span><br><span class="line">curl -I 只返回响应头信息</span><br><span class="line">curl -e <span class="string">&quot;referer&quot;</span> -I <span class="string">&quot;URL&quot;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">none: 如果Header中的Referer为空，允许访问</span><br><span class="line">blocked:在Header中的Referer不为空，但是该值被防火墙或代理进行伪装过，如不带&quot;http://&quot; 、&quot;https://&quot;等协议头的资源允许访问。就是允许“http://”或&quot;https//&quot;以外的请求。</span><br><span class="line">server_names:指定具体的域名或者<span class="attribute">IP</span></span><br><span class="line">string: 可以支持正则表达式和*的字符串。如果是正则表达式，需要以`~`开头表示，例如</span><br><span class="line"></span><br><span class="line">location <span class="regexp">~ .*\.(png|jpg|gif)$</span> &#123;</span><br><span class="line">    <span class="attribute">vaild_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.g.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="attribute">root</span> html/images;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 针对目录进行防盗链</span></span><br><span class="line"><span class="section">location</span> /static &#123;</span><br><span class="line">    <span class="attribute">root</span> html;</span><br><span class="line">    <span class="attribute">vaild_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.g.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测到盗链时返回403错误码</span></span><br><span class="line"><span class="section">location</span> ~*/(js|img|css) &#123;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="number">192.168.13.132</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    <span class="attribute">index</span>  index.html index.htm; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测到盗链时返回指定页面</span></span><br><span class="line"><span class="section">location</span> ~*/(js|img|css) &#123;</span><br><span class="line">    <span class="attribute">valid_referers</span> <span class="literal">none</span> <span class="number">192.168.13.132</span>;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">401</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">root</span>   html;</span><br><span class="line">    <span class="attribute">index</span>  index.html index.htm; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="attribute">error_page</span>  <span class="number">401</span>  /<span class="number">401</span>.html;</span><br><span class="line">    <span class="section">location</span> = /<span class="number">401</span>.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   html;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment"># 注意，只有打开图片链接才能看到指定页面</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测到盗链时返回指定图片</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ .*\.(png|jpg|gif)$</span> &#123;</span><br><span class="line">    <span class="attribute">vaild_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.g.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">		<span class="comment"># return 403;</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/</span> /imgaes/a.png <span class="literal">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="attribute">root</span> html/images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Referer 的限制比较粗，比如随意加一个 Referer，上面的方式是无法进行限制的</p>
<p>此处我们需要用到 Nginx 的第三方模块 <code>ngx_http_accesskey_module</code> ，第三方模块如何实现盗链</p>
<h2 id="rewrite"><a class="markdownIt-Anchor" href="#rewrite">#</a> rewrite</h2>
<p>主要的作用是用来实现 URL 的重写。</p>
<p>Nginx 服务器的 Rewrite 功能的实现依赖于 PCRE 的支持，因此在编译安装 Nginx 服务器之前，需要安装 PCRE 库。Nginx 使用的是 ngx_http_rewrite_module 模块来解析和处理 Rewrite 功能的相关配置。</p>
<p>重写和转发的区别:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">地址重写浏览器地址会发生变化而地址转发则不变</span><br><span class="line">一次地址重写会产生两次请求而一次地址转发只会产生一次请求</span><br><span class="line">地址重写到的页面必须是一个完整的路径而地址转发则不需要</span><br><span class="line">地址重写因为是两次请求所以request范围内属性不能传递给新页面而地址转发因为是一次请求所以可以传递值</span><br><span class="line">地址转发速度快于地址重写</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly9uZ2lueC5vcmcvZW4vZG9jcy9odHRwL25neF9odHRwX3Jld3JpdGVfbW9kdWxlLmh0bWw=">Module ngx_http_rewrite_module (nginx.org)</span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># set  该指令用来设置一个新的变量。</span></span><br><span class="line"><span class="comment"># server、location、if</span></span><br><span class="line"><span class="attribute">set</span> <span class="variable">$variable</span> value;</span><br><span class="line">variable:变量的名称，该变量名称要用&quot;$&quot;作为变量的第一个字符，且不能与Nginx服务器预设的全局变量同名。</span><br><span class="line">value:变量的值，可以是字符串、其他变量或者变量的组合等。</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8890</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> /server &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$name</span> shabi;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$age</span> <span class="number">18</span>;</span><br><span class="line">        <span class="attribute">default_type</span> text/plain;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="variable">$name</span>=<span class="variable">$age</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>rewrite 常用全局变量</p>
<table>
<thead>
<tr>
<th>变量</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>$args</td>
<td>变量中存放了请求 URL 中的请求指令。比如 http://192.168.200.133:8080?arg1=value1&amp;args2=value2 中的 &quot;arg1=value1&amp;arg2=value2&quot;，功能和 $query_string 一样</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>变量存储的是用户访问服务的代理信息 (如果通过浏览器访问，记录的是浏览器的相关版本信息)</td>
</tr>
<tr>
<td>$host</td>
<td>变量存储的是访问服务器的 server_name 值</td>
</tr>
<tr>
<td>$document_uri</td>
<td>变量存储的是当前访问地址的 URI。比如 http://192.168.200.133/server?id=10&amp;name=zhangsan 中的 &quot;/server&quot;，功能和 $uri 一样</td>
</tr>
<tr>
<td>$document_root</td>
<td>变量存储的是当前请求对应 location 的 root 值，如果未设置，默认指向 Nginx 自带 html 目录所在位置</td>
</tr>
<tr>
<td>$content_length</td>
<td>变量存储的是请求头中的 Content-Length 的值</td>
</tr>
<tr>
<td>$content_type</td>
<td>变量存储的是请求头中的 Content-Type 的值</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>变量存储的是客户端的 cookie 信息，可以通过 add_header Set-Cookie 'cookieName=cookieValue’来添加 cookie 数据</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>变量中存储的是 Nginx 服务器对网络连接速率的限制，也就是 Nginx 配置中对 limit_rate 指令设置的值，默认是 0，不限制。</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>变量中存储的是客户端的 IP 地址</td>
</tr>
<tr>
<td>$remote_port</td>
<td>变量中存储了客户端与服务端建立连接的端口号</td>
</tr>
<tr>
<td>$remote_user</td>
<td>变量中存储了客户端的用户名，需要有认证模块才能获取</td>
</tr>
<tr>
<td>$scheme</td>
<td>变量中存储了访问协议</td>
</tr>
<tr>
<td>$server_addr</td>
<td>变量中存储了服务端的地址</td>
</tr>
<tr>
<td>$server_name</td>
<td>变量中存储了客户端请求到达的服务器的名称</td>
</tr>
<tr>
<td>$server_port</td>
<td>变量中存储了客户端请求到达服务器的端口号</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>变量中存储了客户端请求协议的版本，比如 &quot;HTTP/1.1&quot;</td>
</tr>
<tr>
<td>$request_body_file</td>
<td>变量中存储了发给后端服务器的本地文件资源的名称</td>
</tr>
<tr>
<td>$request_method</td>
<td>变量中存储了客户端的请求方式，比如 &quot;GET&quot;,&quot;POST&quot; 等</td>
</tr>
<tr>
<td>$request_filename</td>
<td>变量中存储了当前请求的资源文件的路径名</td>
</tr>
<tr>
<td>$request_uri</td>
<td>变量中存储了当前请求的 URI，并且携带请求参数，比如 http://192.168.200.133/server?id=10&amp;name=zhangsan 中的 &quot;/server?id=10&amp;name=zhangsan&quot;</td>
</tr>
</tbody>
</table>
<h3 id="if"><a class="markdownIt-Anchor" href="#if">#</a> if</h3>
<p>使用正则表达式对变量进行匹配，匹配成功返回 true，否则返回 false。变量与正则表达式之间使用 &quot;<sub>&quot;,&quot;</sub>*&quot;,&quot;!<sub>&quot;,&quot;!</sub>*&quot; 来连接。</p>
<p>&quot;~&quot; 代表匹配正则表达式过程中区分大小写，</p>
<p>&quot;~*&quot; 代表匹配正则表达式过程中不区分大小写</p>
<p>&quot;!<sub>“和”!</sub>*&quot; 刚好和上面取相反值，如果匹配上返回 false, 匹配不上返回 true</p>
<p>判断请求的文件是否存在使用 &quot;-f&quot; 和 &quot;!-f&quot;,</p>
<p>当使用 &quot;-f&quot; 时，如果请求的文件存在返回 true，不存在返回 false。</p>
<p>当使用 &quot;!f&quot; 时，如果请求文件不存在，但该文件所在目录存在返回 true, 文件和目录都不存在返回 false, 如果文件存在返回 false</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># if  (condition)&#123;...&#125;</span></span><br><span class="line"><span class="comment"># server、location</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /if &#123;</span><br><span class="line">    <span class="attribute">set</span> <span class="variable">$param</span> <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$param</span>) &#123;</span><br><span class="line">		<span class="attribute">return</span> <span class="number">200</span> <span class="variable">$param</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$request_method</span> = POST) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">405</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$http_user_agent</span> <span class="regexp">~ Safari)</span> &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">if</span> (!-f <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="variable">$request_filename</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;empty&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol start="5">
<li>
<p>判断请求的目录是否存在使用 &quot;-d&quot; 和 &quot;!-d&quot;,</p>
<p>当使用 &quot;-d&quot; 时，如果请求的目录存在，if 返回 true，如果目录不存在则返回 false</p>
<p>当使用 &quot;!-d&quot; 时，如果请求的目录不存在但该目录的上级目录存在则返回 true，该目录和它上级目录都不存在则返回 false, 如果请求目录存在也返回 false.</p>
</li>
<li>
<p>判断请求的目录或者文件是否存在使用 &quot;-e&quot; 和 &quot;!-e&quot;</p>
<p>当使用 &quot;-e&quot;, 如果请求的目录或者文件存在时，if 返回 true, 否则返回 false.</p>
<p>当使用 &quot;!-e&quot;, 如果请求的文件和文件所在路径上的目录都不存在返回 true, 否则返回 false</p>
</li>
<li>
<p>判断请求的文件是否可执行使用 &quot;-x&quot; 和 &quot;!-x&quot;</p>
<p>当使用 &quot;-x&quot;, 如果请求的文件可执行，if 返回 true, 否则返回 false</p>
<p>当使用 &quot;!-x&quot;, 如果请求文件不可执行，返回 true, 否则返回 false</p>
</li>
</ol>
<h3 id="break"><a class="markdownIt-Anchor" href="#break">#</a> break</h3>
<p>该指令用于中断当前相同作用域中的其他 Nginx 配置。与该指令处于同一作用域的 Nginx 配置中，位于它前面的指令配置生效，位于后面的指令配置无效。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /testbreak &#123;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$args</span>) &#123;</span><br><span class="line">        <span class="attribute">set</span> <span class="variable">$username</span> haha;</span><br><span class="line">        break;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="attribute">add_header</span> <span class="variable">$username</span> <span class="number">222</span>;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="return"><a class="markdownIt-Anchor" href="#return">#</a> return</h3>
<p>该指令用于完成对请求的处理，直接向客户端返回响应状态代码。在 return 后的所有 Nginx 配置都是无效的。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">return</span> code [text];</span><br><span class="line"><span class="attribute">return</span> code URL;</span><br><span class="line"><span class="attribute">return</span> URL;</span><br></pre></td></tr></table></figure>
<p>code: 为返回给客户端的 HTTP 状态代理。可以返回的状态代码为 0~999 的任意 HTTP 状态代理</p>
<p>text: 为返回给客户端的响应体内容，支持变量的使用</p>
<p>URL: 为返回给客户端的 URL 地址</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">server</span> /ret &#123;</span><br><span class="line">    <span class="attribute">default_type</span> application/json;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">200</span> success;</span><br><span class="line">    <span class="comment"># return 302 http://www.baidu.com;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rewrite-2"><a class="markdownIt-Anchor" href="#rewrite-2">#</a> rewrite</h3>
<p>该指令通过正则表达式的使用来改变 URI。可以同时存在一个或者多个指令，按照顺序依次对 URL 进行匹配和处理。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># rewrite regex replacement [flag];</span></span><br><span class="line"><span class="comment"># server、location、if</span></span><br><span class="line"></span><br><span class="line"><span class="section">location</span> /rewrite &#123;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/rewrite/url\w*$</span> https://www.baidu.com;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/rewrite/(test)\w*$</span>; /$1;</span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/rewrite/(demo)\w*$</span>  /<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>regex: 用来匹配 URI 的正则表达式</p>
<p>replacement: 匹配成功后，用于替换 URI 中被截取内容的字符串。如果该字符串是以 &quot;http://&quot; 或者 &quot;https://&quot; 开头的，则不会继续向下对 URI 进行其他处理，而是直接返回重写后的 URI 给客户端。</p>
<p>flag: 用来设置 rewrite 对 URI 的处理行为，可选值有如下：</p>
<p>​	last: 终止继续在本 location 块中处理接收到的 URI，并将此处重写的 URI 作为一个新的 URI，使用各 location 块进行处理。该标志将重写后的 URI 重写在 server 块中执行，为重写后的 URI 提供了转入到其他 location 块的机会。即本条规则匹配完成后，继续向下匹配新的 1ocation URI 规则</p>
<p>​	break: 将此处重写的 URI 作为一个新的 URI, 在本块中继续进行处理。该标志将重写后的地址在当前的 location 块中执行，不会将新的 URI 转向其他的 location 块。</p>
<p>​	redirect: 将重写后的 URl 返回给客户端，状态码为 302，指明是临时重定向 URl, 主要用在 replacement 变量不是以 &quot;http:/“或者&quot;https:/”&quot; 开头的情况。浏览器地址会显示跳转后的 URL 地址</p>
<p>​	permanent: 将重写后的 URI 返回给客户端，状态码为 301，指明是重定向 URl, 主要用在 replacement 变量不是以 &quot;http://“或者&quot;https://”&quot; 开头的情况。浏览器地址栏会显示跳转后的 URL 地址</p>
<h3 id="rewrite_log"><a class="markdownIt-Anchor" href="#rewrite_log">#</a> rewrite_log</h3>
<p>该指令配置是否开启 URL 重写日志的输出功能。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">rewrite_log off;</span><br><span class="line">开启后，URL重写的相关日志将以notice级别输出到error_log指令配置的日志文件汇总。</span><br><span class="line">error_log notice;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="rewrite实现伪静态"><a class="markdownIt-Anchor" href="#rewrite实现伪静态">#</a> rewrite 实现伪静态</h3>
<figure class="highlight jsp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 假设pageNum为前端接收数据，后端根据对应的pageNum展示对应的页面</span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">String</span> <span class="variable">pageNum</span> <span class="operator">=</span> request.getParameter(<span class="string">&quot;pageNum&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;this is&quot;</span> + pageNum);</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;  <span class="comment"># 域名或主机名</span></span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">       	<span class="attribute">rewrite</span><span class="regexp"> ^/([0-9]+).html$</span> /index.jsp?pageNum=<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://192.168.13.155:8080;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">       <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">       <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以实现访问 http://www.a.com/haha?pageNum=13 时客户端显示 <span class="exturl" data-url="aHR0cDovL3d3dy5hLmNvbS8xMy5odG1s">http://www.a.com/13.html</span></p>
<h3 id="域名跳转"><a class="markdownIt-Anchor" href="#域名跳转">#</a> 域名跳转</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1.修改hosts</span></span><br><span class="line">127.0.0.1       www.shinya.<span class="attribute">com</span></span><br><span class="line"><span class="number">127.0.0.1</span>       www.kbshire.com</span><br><span class="line"><span class="number">127.0.0.1</span>       www.shabi.com</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2.修改conf</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.shinya.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;&lt;h1&gt;shinya&lt;/h1&gt;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.kbshire.com www.shinya.com;</span><br><span class="line">    <span class="comment"># rewrite ^/ http://www.shinya.com/;</span></span><br><span class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> http://www.shinya.com<span class="variable">$1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="域名镜像"><a class="markdownIt-Anchor" href="#域名镜像">#</a> 域名镜像</h3>
<p>镜像网站指定是将一个完全相同的网站分别放置到几台服务器上，并分别使用独立的 URL 进行访问。其中一台服务器上的网站叫主站，其他的为镜像网站。镜像网站和主站没有太大的区别，可以把镜像网站理解为主站的一个备份节点。</p>
<p>然如果我们不想把整个网站做镜像，只想为其中某一个子目录下的资源做镜像，我们可以在 location 块中配置 rewrite 功能，比如:</p>
<p>提高可用性</p>
<p>加快响应速度</p>
<p>流量负载</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 只对user子目录做镜像</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www.shinya.com www.kbshire.com;</span><br><span class="line">    <span class="section">location</span> /user &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/user(.*)$</span> http://www.shabi.com<span class="variable">$1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /emp &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="独立域名"><a class="markdownIt-Anchor" href="#独立域名">#</a> 独立域名</h3>
<p>为每个模块设置独立域名</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://search.hm.<span class="attribute">com</span>  访问商品搜索模块</span><br><span class="line">http://item.hm.com	  访问商品详情模块</span><br><span class="line">http://cart.hm.com	  访问商品购物车模块</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> search.hm.com;</span><br><span class="line">	<span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> http://www.hm.com/bbs<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">81</span>;</span><br><span class="line">	<span class="attribute">server_name</span> item.hm.com;</span><br><span class="line">	<span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> http://www.hm.com/item<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">82</span>;</span><br><span class="line">	<span class="attribute">server_name</span> cart.hm.com;</span><br><span class="line">	<span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> http://www.hm.com/cart<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="自动加"><a class="markdownIt-Anchor" href="#自动加">#</a> 自动加 /</h3>
<p>重定向的地址会有一个指令叫 server_name_in_redirect on|off; 来决定重定向的地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">如果该指令为on</span><br><span class="line">	重定向的地址为:  http://server_name/目录名/;</span><br><span class="line">如果该指令为off</span><br><span class="line">	重定向的地址为:  http://原URL中的域名/目录名/;</span><br></pre></td></tr></table></figure>
<p>server_name_in_redirect on 时，如果访问 192.168.13.155/shabi 会跳转到 localhost/shabi/ 导致无法访问</p>
<p>自动加 / 可以避免自动跳转</p>
<p>注意 server_name_in_redirect 指令在 Nginx 的 0.8.48 版本之前默认都是 on，之后改成了 off, 所以现在我们这个版本不需要考虑这个问题</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="attribute">server_name_in_redirect</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="section">location</span> /shabi &#123;</span><br><span class="line">        <span class="attribute">root</span> html;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="attribute">if</span> (-d <span class="variable">$request_filename</span>) &#123;</span><br><span class="line">            <span class="attribute">rewrite</span><span class="regexp"> ^(.*)([^/])$</span> http://<span class="variable">$host</span>:<span class="variable">$server_port</span><span class="variable">$1</span><span class="variable">$2</span>/ <span class="literal">permanent</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>127.0.0.1/shbi 与 127.0.0.1/shabi/ 的区别</p>
<p>127.0.0.1/shabi    不加 / 会 301 重定向到 /shabi/</p>
<p>127.0.0.1/shabi/   不做重定向</p>
<h3 id="目录合并"><a class="markdownIt-Anchor" href="#目录合并">#</a> 目录合并</h3>
<p>URL 的目录层级一般不要超过三层，否则的话不利于搜索引擎的搜索也给客户端的输入带来了负担，但是将所有的文件放在一个目录下又会导致文件资源管理混乱并且访问文件的速度也会随着文件增多而慢下来</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> /server &#123;</span><br><span class="line">        <span class="attribute">root</span> html;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/server-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)-([0-9]+)\.html$</span> /server/<span class="variable">$1</span>/<span class="variable">$2</span>/<span class="variable">$3</span>/<span class="variable">$4</span>/<span class="variable">$5</span>.html <span class="literal">last</span>;</span><br><span class="line">        <span class="comment"># /server/11/22/33/44/20.html</span></span><br><span class="line">        <span class="comment"># /server/11-22-33-44-20.html</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="防盗链-2"><a class="markdownIt-Anchor" href="#防盗链-2">#</a> 防盗链</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 检测到盗链时返回指定图片</span></span><br><span class="line"><span class="section">location</span> <span class="regexp">~ .*\.(png|jpg|gif)$</span> &#123;</span><br><span class="line">    <span class="attribute">vaild_referers</span> <span class="literal">none</span> <span class="literal">blocked</span> www.g.com;</span><br><span class="line">    <span class="attribute">if</span> (<span class="variable">$invalid_referer</span>) &#123;</span><br><span class="line">		<span class="comment"># return 403;</span></span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^/</span> /imgaes/a.png <span class="literal">break</span>;</span><br><span class="line">	&#125;</span><br><span class="line">    <span class="attribute">root</span> html/images;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="nginx代理"><a class="markdownIt-Anchor" href="#nginx代理">#</a> Nginx 代理</h2>
<p>正向代理</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230417115758644.png" alt="image-20230417115758644"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 访问192.168.13.155 82 代理到服务器，服务器认为是155访问的</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">82</span>;</span><br><span class="line">    <span class="attribute">resolver</span> <span class="number">8.8.8.8</span>;   <span class="comment"># 设置DNSIP，用来继续proxy_pass中域名</span></span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://<span class="variable">$host</span><span class="variable">$request_uri</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>修稿客户端的代理</p>
<h3 id="反向代理"><a class="markdownIt-Anchor" href="#反向代理">#</a> 反向代理</h3>
<p>Nginx 反向代理模块的指令是由 <code>ngx_http_proxy_module</code>  模块进行解析，该模块在安装 Nginx 的时候已经自己加装到 Nginx 中了</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_pass</span> <span class="comment"># 设置被代理服务器的地址</span></span><br><span class="line">位置location</span><br><span class="line"></span><br><span class="line">server  &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /server &#123;</span><br><span class="line">        <span class="comment"># 此时访问的是/server/index.html</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /server &#123;</span><br><span class="line">        <span class="comment"># 此时访问的是/index.html</span></span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155/;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment"># 注意location /  proxy_pass 后面会帮你加上 / </span></span><br><span class="line">    <span class="comment"># loction /xxx  后面不加 / 会出现上面的问题</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_set_header</span> </span><br><span class="line"><span class="comment"># 该指令可以更改Nginx服务器接收到的客户端请求的请求头信息，然后将新的请求头发送给代理的服务器</span></span><br><span class="line">proxy_set_header Host <span class="variable">$proxy_host</span>;</span><br><span class="line"><span class="attribute">proxy_set_header</span> Connection close;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 被带服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">default_type</span> text/html;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="variable">$http_username</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器</span></span><br><span class="line"><span class="section">server</span>  &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155:8080;</span><br><span class="line">        <span class="attribute">proxy_set_header</span> username HAHA;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 实现功能 访问代理服务器的:8080/server 添加username header，在被代服务器回显给客户端</span></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># proxy_redirect</span></span><br><span class="line">该指令是用来重置头信息中的&quot;Location&quot;和&quot;Refresh&quot;的值。</span><br><span class="line"><span class="attribute">proxy_redirect</span> <span class="literal">redirect</span> replacement;</span><br><span class="line"><span class="attribute">proxy_redirect</span> default;</span><br><span class="line"><span class="attribute">proxy_redirect</span> <span class="literal">off</span>;</span><br><span class="line">位置http、server、<span class="section">location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 服务端</span></span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">root</span> html;</span><br><span class="line">        <span class="attribute">index</span> index.html;</span><br><span class="line">        <span class="comment"># 这样会暴露服务端真实ip</span></span><br><span class="line">        <span class="comment">#if (!-f $request_filename) &#123;</span></span><br><span class="line">        <span class="comment">#    return 302 http://192.168.13.155/;</span></span><br><span class="line">        <span class="comment">#&#125;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8082</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155:8082;</span><br><span class="line">        <span class="attribute">proxy_redirect</span> http://192.168.13.155 http://192.168.13.132;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_redirect redirect replacement;</span></span><br><span class="line">redirect:目标,Location的值</span><br><span class="line">replacement:要替换的值</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_redirect default;</span></span><br><span class="line">将<span class="section">location</span>块的uri变量作为replacement,</span><br><span class="line">将proxy_pass变量作为redirect进行替换</span><br></pre></td></tr></table></figure>
<p>当后端三台服务器上内容不一样时的案例：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 如果后端服务器每台上内容不一样</span></span><br><span class="line"><span class="comment"># 服务器1</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.13.155</span>;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;155&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 服务器2</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">server_name</span> <span class="number">192.168.13.166</span>;</span><br><span class="line">    <span class="attribute">default_type</span> text/plain;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">return</span> <span class="number">200</span> <span class="string">&#x27;166&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155:8083/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8084</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.166:8083/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 代理服务器 - 或者</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">    <span class="attribute">server_name</span> localhost;</span><br><span class="line">    <span class="section">location</span> /server1 &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.155:8083/;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">location</span> /server2 &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span> http://192.168.13.166:8083/;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nginx安全控制"><a class="markdownIt-Anchor" href="#nginx安全控制">#</a> nginx 安全控制</h3>
<p>http 请求转变成 https 请求</p>
<p>nginx 添加 ssl 支持</p>
<p>–with-http_ssl_module</p>
<p>ssl 模块下所有的配置都可以在 http，server 块中配置，下面就省略配置位置了</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">ssl</span> <span class="literal">on</span>;   <span class="comment"># 开启ssl支持</span></span><br><span class="line">位置http、<span class="attribute">server</span></span><br><span class="line">或者</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">443</span> ssl;</span><br><span class="line">&#125;</span><br><span class="line">效果一样~</span><br><span class="line"></span><br><span class="line"><span class="attribute">ssl_certificate</span> ;   <span class="comment"># 指定pem证书</span></span><br><span class="line"><span class="attribute">ssl_certificate_key</span> <span class="comment"># 指定pem secret 文件</span></span><br><span class="line">ssl_session_cache <span class="literal">off</span>;  <span class="comment"># 设置ssl会话缓存</span></span><br><span class="line"></span><br><span class="line">/*</span><br><span class="line"><span class="attribute">ssl_session_cache</span> 可选项如下</span><br><span class="line"><span class="literal">off</span>:禁用会话缓存，客户端不得重复使用会话</span><br><span class="line"><span class="literal">none</span>:禁止使用会话缓存，客户端可以重复使用，但是并没有在缓存中存储会话参数</span><br><span class="line">builtin:内置OpenSSL缓存，仅在一个工作进程中使用。</span><br><span class="line">shared:所有工作进程之间共享缓存，缓存的相关信息用name和size来指定</span><br><span class="line">*/</span><br><span class="line"></span><br><span class="line">ssl_session_timeout <span class="comment"># 设置客户端能够反复使用储存在缓存中的会话参数时间</span></span><br><span class="line">ssl_ciphers <span class="comment"># 允许的密码，必须为openssl支持的格式，可以使用`openssl ciphers`查看openssl支持的格式。</span></span><br><span class="line">ssl_prefer_server_ciphers <span class="literal">on</span>;  <span class="comment">#该指令指定是否服务器密码优先客户端密码</span></span><br></pre></td></tr></table></figure>
<p>生成证书</p>
<blockquote>
<p>阿里云生成</p>
<p>openssl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">mkdir</span> /root/cert</span><br><span class="line"><span class="built_in">cd</span> /root/cert</span><br><span class="line">openssl genrsa -des3 -out server.key 2048</span><br><span class="line">openssl req -new -key server.key -out server.csr</span><br><span class="line"><span class="built_in">cp</span> server.key server.key.org</span><br><span class="line">openssl rsa -<span class="keyword">in</span> server.key.org -out server.key</span><br><span class="line">openssl x509 -req -days 365 -<span class="keyword">in</span> server.csr -signkey server.key -out server.crt</span><br><span class="line"></span><br><span class="line">[root@localhost cert]<span class="comment"># ls -al </span></span><br><span class="line">total 20</span><br><span class="line">drwxr-xr-x   2 root root   82 Apr 12 19:48 .</span><br><span class="line">dr-xr-x---. 20 root root 4096 Apr 12 19:42 ..</span><br><span class="line">-rw-r--r--   1 root root  867 Apr 12 19:48 server.crt</span><br><span class="line">-rw-r--r--   1 root root  708 Apr 12 19:46 server.csr</span><br><span class="line">-rw-------   1 root root  916 Apr 12 19:47 server.key</span><br><span class="line">-rw-------   1 root root 1062 Apr 12 19:47 server.key.org</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">443</span> ssl;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">       <span class="attribute">ssl_certificate</span>      /root/cert/server.crt;</span><br><span class="line">       <span class="attribute">ssl_certificate_key</span>  /root/cert/server.key</span><br><span class="line"></span><br><span class="line">       ssl_session_cache    shared:SSL:<span class="number">1m</span>;   <span class="comment"># 工作进程共享缓存   名称   大小</span></span><br><span class="line">       <span class="attribute">ssl_session_timeout</span>  <span class="number">5m</span>;              <span class="comment"># 超时时间</span></span><br><span class="line"></span><br><span class="line">       <span class="attribute">ssl_ciphers</span>  HIGH:!aNULL:!MD5;        <span class="comment"># 密码格式</span></span><br><span class="line">       <span class="attribute">ssl_prefer_server_ciphers</span>  <span class="literal">on</span>;        <span class="comment"># 是否服务端密码优先于客户端密码</span></span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">           <span class="attribute">root</span>   html;</span><br><span class="line">           <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">       &#125;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># httprewrite到https，因为浏览器www.baidu.com 默认是http</span></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span> <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span> www,baidu.com;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">rewrite</span><span class="regexp"> ^(.*)</span> https://baidu.com<span class="variable">$1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</blockquote>
<h3 id="反向代理系统优化"><a class="markdownIt-Anchor" href="#反向代理系统优化">#</a> 反向代理系统优化</h3>
<p>Buffer 和 cache</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">相同点:</span><br><span class="line">两种方式都是用来提供IO吞吐效率，都是用来提升Nginx代理的性能。</span><br><span class="line">不同点:</span><br><span class="line">缓冲主要用来解决不同设备之间数据传递速度不一致导致的性能低的问题，缓冲中的数据一旦此次操作完成后，就可以删除。</span><br><span class="line">缓存主要是备份，将被代理服务器的数据缓存一份到代理服务器，这样的话，客户端再次获取相同数据的时候，就只需要从代理服务器上获取，效率较高，缓存中的数据可以重复使用，只有满足特定条件才会删除.</span><br></pre></td></tr></table></figure>
<p>下面所有的参数都可以在 http，server，location 中配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">on</span>  :该指令用来开启或者关闭代理服务器的缓冲区；</span><br><span class="line">proxy_buffers <span class="number">8</span> <span class="number">4k</span>   :该指令用来指定单个连接从代理服务器读取响应的缓存区的个数和大小。</span><br><span class="line">proxy_buffer_size <span class="number">4k</span> :该指令用来设置从被代理服务器获取的第一部分响应数据的大小。保持与proxy_buffers中的size一致即可，当然也可以更小。</span><br><span class="line">proxy_busy_buffers_size <span class="number">8k</span>  ：该指令用来限制同时处于BUSY状态的缓冲总大小</span><br><span class="line">proxy_temp_path path  :当缓冲区存满后，仍未被Nginx服务器完全接受，响应数据就会被临时存放在磁盘文件上，该指令设置文件路径,最多只能三层目录</span><br><span class="line">proxy_temp_file_write_size <span class="number">8k</span> ：该指令用来设置磁盘上缓冲文件的大小。</span><br></pre></td></tr></table></figure>
<p>通用配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">proxy_buffering</span> <span class="literal">on</span>;</span><br><span class="line"><span class="attribute">proxy_buffer_size</span> <span class="number">4</span> <span class="number">32k</span>;</span><br><span class="line"><span class="attribute">proxy_busy_buffers_size</span> <span class="number">64k</span>;</span><br><span class="line"><span class="attribute">proxy_temp_file_write_size</span> <span class="number">64k</span>;</span><br></pre></td></tr></table></figure>
<h4 id="代理https请求"><a class="markdownIt-Anchor" href="#代理https请求">#</a> 代理 https 请求</h4>
<p>需要第三方模块</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2Nob2JpdHMvbmd4X2h0dHBfcHJveHlfY29ubmVjdF9tb2R1bGU=">https://github.com/chobits/ngx_http_proxy_connect_module</span></p>
<p>配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">server &#123;</span><br><span class="line">    listen                         3128;</span><br><span class="line"></span><br><span class="line">    # dns resolver used by forward proxying</span><br><span class="line">    resolver                       8.8.8.8;</span><br><span class="line"></span><br><span class="line">    # forward proxy for CONNECT request</span><br><span class="line">    proxy_connect;</span><br><span class="line">    proxy_connect_allow            443 563;</span><br><span class="line">    proxy_connect_connect_timeout  10s;</span><br><span class="line">    proxy_connect_read_timeout     10s;</span><br><span class="line">    proxy_connect_send_timeout     10s;</span><br><span class="line"></span><br><span class="line">    # forward proxy for non-CONNECT request</span><br><span class="line">    location / &#123;</span><br><span class="line">        proxy_pass http://$host;</span><br><span class="line">        proxy_set_header Host $host;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="负载均衡"><a class="markdownIt-Anchor" href="#负载均衡">#</a> 负载均衡</h2>
<p>系统的扩展分为纵向扩展和横向扩展</p>
<p>纵向扩展是从单机的角度出发，通过增加系统的硬件处理能力来提升服务器的处理能力</p>
<blockquote>
<blockquote>
<p>云服务资源增加</p>
<p>・整机：IBM、浪潮、DELL、HP 等</p>
<p>・CPU / 主板：更新到主流</p>
<p>・网卡：10G/40G 网卡</p>
<p>・磁盘：SAS (SCSI) HDD（机械）、HHD（混合）、SATA SSD、PCI-e SSD、</p>
<p>MVMe SSD</p>
<p>• SSD</p>
<p>・多副本机制</p>
<p>・系统盘 / 热点数据 / 数据库存储</p>
<p>• HDD</p>
<p>・冷数据存储</p>
</blockquote>
</blockquote>
<p>横向扩展是通过添加机器来满足大型网站服务的处理能力。</p>
<blockquote>
<p>会话管理</p>
<p>・Nginx 高级负载均衡</p>
<p>• ip_hash</p>
<p>・其他 Hash</p>
<p>• hash $cookie_jsessionid;</p>
<p>• hash $request_uri;</p>
<p>・使用 lua 逻辑定向分发</p>
<p>• Redis + SpringSession</p>
</blockquote>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418100400412.png" alt="image-20230418100400412"></p>
<p>应用集群：将同一应用部署到多台机器上，组成处理集群，接收负载均衡设备分发的请求，进行处理并返回响应的数据。</p>
<p>负载均衡器：将用户访问的请求根据对应的负载均衡算法，分发到集群中的一台服务器进行处理。</p>
<p>负载均衡作用：</p>
<p>1、解决服务器的高并发压力，提高应用程序的处理性能。</p>
<p>2、提供故障转移，实现高可用。</p>
<p>3、通过添加或减少服务器数量，增强网站的可扩展性。</p>
<p>4、在负载均衡器上进行过滤，可以提高系统的安全性。</p>
<p>负载均衡常用方式：</p>
<p><strong>用户手动选择</strong>，比如下载时选择电信、联通</p>
<p>DNS 轮询 ：对同一个主机名添加多条 A 记录，这就是 DNS 轮询，DNS 服务器将解析请求按照 A 记录的顺序，随机分配到不同的 IP 上，这样就能完成简单的负载均衡。DNS 轮询的成本非常低，在一些不重要的服务器，被经常使用。</p>
<p>1. 可靠性低</p>
<p>假设一个域名 DNS 轮询多台服务器，如果其中的一台服务器发生故障，那么所有的访问该服务器的请求将不会有所回应，即使你将该服务器的 IP 从 DNS 中去掉，但是由于各大宽带接入商将众多的 DNS 存放在缓存中，以节省访问时间，导致 DNS 不会实时更新。所以 DNS 轮流上一定程度上解决了负载均衡问题，但是却存在可靠性不高的缺点。</p>
<p>2. 负载均衡不均衡</p>
<p>DNS 负载均衡采用的是简单的轮询负载算法，不能区分服务器的差异，不能反映服务器的当前运行状态，不能做到为性能好的服务器多分配请求，另外本地计算机也会缓存已经解析的域名到 IP 地址的映射，这也会导致使用该 DNS 服务器的用户在一定时间内访问的是同一台 Web 服务器，从而引发 Web 服务器减的负载不均衡。</p>
<p>负载不均衡则会导致某几台服务器负荷很低，而另外几台服务器负荷确很高，处理请求的速度慢，配置高的服务器分配到的请求少，而配置低的服务器分配到的请求多。</p>
<p><strong>四层 / 七层负载均衡</strong></p>
<h3 id="四层负载均衡-七层负载均衡"><a class="markdownIt-Anchor" href="#四层负载均衡-七层负载均衡">#</a> 四层负载均衡 / 七层负载均衡</h3>
<p>所谓四层负载均衡指的是 OSI 七层模型中的传输层，主要是基于 IP+PORT 的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">实现四层负载均衡的方式：</span><br><span class="line">硬件：F5 BIG-IP、Radware等</span><br><span class="line">软件：LVS、Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>
<p>所谓的七层负载均衡指的是在应用层，主要是基于虚拟的 URL 或主机 IP 的负载均衡</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">实现七层负载均衡的方式：</span><br><span class="line">软件：Nginx、Hayproxy等</span><br></pre></td></tr></table></figure>
<p>四层和七层负载均衡的区别</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">四层负载均衡数据包是在底层就进行了分发，而七层负载均衡数据包则在最顶端进行分发，所以四层负载均衡的效率比七层负载均衡的要高。</span><br><span class="line">四层负载均衡不识别域名，而七层负载均衡识别域名。</span><br></pre></td></tr></table></figure>
<p>其实还有二层、三层负载均衡，二层是在数据链路层基于 mac 地址来实现负载均衡，三层是在网络层一般采用虚拟 IP 地址的方式实现负载均衡。</p>
<p>实际会采用： 四层负载 (LVS)+ 七层负载 (Nginx)</p>
<p><strong>七层负载均衡</strong></p>
<p>Nginx 的负载均衡是在 Nginx 的反向代理基础上把用户的请求根据指定的算法分发到一组【upstream 虚拟服务池】。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> 该指令是用来定义一组服务器，它们可以是监听不同端口的服务器，并且也可以是同时监听TCP和Unix socket的服务器。服务器可以指定不同的权重，默认为<span class="number">1</span>。</span><br><span class="line">位置http</span><br><span class="line"></span><br><span class="line">server 该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者unix socket</span><br><span class="line">位置<span class="section">upstream</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418101020006.png" alt="image-20230418101020006"></p>
<p>该指令用来指定后端服务器的名称和一些参数，可以使用域名、IP、端口或者 unix socket</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend&#123;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9091</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9092</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9093</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line">	<span class="section">location</span> /&#123;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>代理服务器在负责均衡调度中的状态有以下几个：</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>概述</th>
</tr>
</thead>
<tbody>
<tr>
<td>down</td>
<td>当前的 server 暂时不参与负载均衡，该状态一般会对需要停机维护的服务器进行设置。</td>
</tr>
<tr>
<td>backup</td>
<td>预留的备份服务器，当主服务器不可用时，将用来传递请求。</td>
</tr>
<tr>
<td>max_fails</td>
<td>允许请求失败的次数，默认为 1</td>
</tr>
<tr>
<td>fail_timeout</td>
<td>经过 max_fails 失败后，服务暂停时间，默认是 10 秒</td>
</tr>
<tr>
<td>max_conns</td>
<td>限制最大的接收连接数，默认为 0，表示不限制，使用该配置可以根据后端服务器处理请求的并发量来进行设置，防止后端服务器被压垮。</td>
</tr>
</tbody>
</table>
<p>负载均衡策略</p>
<p>Nginx 的 upstream 支持如下六种方式的分配算法，分别是:</p>
<table>
<thead>
<tr>
<th>算法名称</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>轮询</td>
<td>默认方式</td>
</tr>
<tr>
<td>weight</td>
<td>权重方式，权重数据越大，被分配到请求的几率越大；该权重值，主要是针对实际工作环境中不同的后端服务器硬件配置进行调整的，所有此策略比较适合服务器的硬件配置差别比较大的情况</td>
</tr>
<tr>
<td>ip_hash</td>
<td>先 hash，再和后端服务器的数量取余，得到的值就是需要转发到后端的服务器。不适用于局域网项目，即多用户共享 IP 的场景。容易造成流量倾斜。后端服务器宕机导致 session 丢失。适用于中小型项目，快速扩容。                                                                                                                 依据 ip 分配方式。能够将某个客户端 IP 的请求通过哈希算法定位到同一台后端服务器上。这样，当来自某一个 IP 的用户在后端 Web 服务器 A 上登录后，在访问该站点的其他 URL，能保证其访问的还是后端 web 服务器 A。ip_hash 指令无法保证后端服务器的负载均衡，可能导致有些后端服务器接收到的请求多，有些后端服务器接收的请求少，而且设置后端服务器权重等方法将不起作用。</td>
</tr>
<tr>
<td>least_conn</td>
<td>依据最少连接方式。有些请求占用的时间很长，会导致其所在的后端负载较高。这种情况下，least_conn 这种方式就可以达到更好的负载均衡效果。</td>
</tr>
<tr>
<td>url_hash</td>
<td>依据 URL 分配方式。url_hash 按访问 url 的 hash 结果来分配请求，使每个 url 定向到同一个后端服务器，要配合缓存命中来使用。同一个资源多次请求，可能会到达不同的服务器上，导致不必要的多次下载，缓存命中率不高，以及一些资源时间的浪费。而使用 url_hash，可以使得同一个 url（也就是同一个资源请求）会到达同一台服务器，一旦缓存住了资源，再此收到请求，就可以从缓存中读取。</td>
</tr>
<tr>
<td>fair</td>
<td>依据响应时间方式。可以根据页面大小、加载时间长短智能的进行负载均衡。</td>
</tr>
<tr>
<td>$request_uri</td>
<td>适用于不支持 cookie 的情况下。资源不平均分配：只需要算出 hash 将资源放到对应的服务器</td>
</tr>
<tr>
<td>$cookie_jsessionid</td>
<td>sessionid 只有 tomcat 才有，并且 hash 的是 value</td>
</tr>
</tbody>
</table>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend&#123;</span><br><span class="line">	ip_hash;</span><br><span class="line">     <span class="comment"># hash $request_uri;</span></span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9001</span> weight=<span class="number">2</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9002</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9003</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span> <span class="number">8083</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line">	<span class="section">location</span> /&#123;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>fair</p>
<p>fair 采用的不是内建负载均衡使用的轮换的均衡算法，而是可以根据页面大小、加载时间长短智能的进行负载均衡。那么如何使用第三方模块的 fair 负载均衡策略。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> backend &#123;</span><br><span class="line">    fair;</span><br><span class="line">&#125;</span><br><span class="line">https://github.com/gnosek/nginx-<span class="section">upstream</span>-fair</span><br><span class="line">./configure --add-module=/root/fair</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">在Nginx的源码中 src/http/ngx_http_upstream.h,找到ngx_http_upstream_srv_conf_s，在模块中添加添加default_port属性</span><br><span class="line"></span><br><span class="line">in_port_t	   default_port</span><br><span class="line"></span><br><span class="line">make </span><br><span class="line">make upgrade</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实现带有URL重写的负载均衡</span></span><br><span class="line"><span class="section">upstream</span> backend&#123;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9001</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9002</span>;</span><br><span class="line">	<span class="attribute">server</span> <span class="number">192.168.200.146:9003</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">	<span class="attribute">listen</span>	<span class="number">80</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line">	<span class="section">location</span> /file/ &#123;</span><br><span class="line">		<span class="attribute">rewrite</span><span class="regexp"> ^(/file/.*)</span> /server/<span class="variable">$1</span> <span class="literal">last</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="stick-实现cookie-负载均衡"><a class="markdownIt-Anchor" href="#stick-实现cookie-负载均衡">#</a> stick 实现 cookie 负载均衡</h3>
<p>Sticky 是 nginx 的一个模块，它是基于 cookie 的一种 nginx 的负载均衡解决方案，通过分发和识别 cookie，来使同一个客户端的请求落在同一台服务器上，默认标识名为 route</p>
<blockquote>
<p>客户端首次发起访问请求，nginx 接收后，发现请求头没有 cookie，则以轮询方式将请求分发给后端服务器。</p>
<p>后端服务器处理完请求，将响应数据返回给 nginx。</p>
<p>此时 nginx 生成带 route 的 cookie，返回给客户端。route 的值与后端服务器对应，可能是明文，也可能是 md5、sha1 等 Hash 值</p>
<p>客户端接收请求，并保存带 route 的 cookie。</p>
<p>当客户端下一次发送请求时，会带上 route，nginx 根据接收到的 cookie 中的 route 值，转发给对应的后端服务器。</p>
</blockquote>
<p><span class="exturl" data-url="aHR0cHM6Ly9iaXRidWNrZXQub3JnL25naW54LWdvb2RpZXMvbmdpbngtc3RpY2t5LW1vZHVsZS1uZy9zcmMvbWFzdGVyLw==">https://bitbucket.org/nginx-goodies/nginx-sticky-module-ng/src/master/</span></p>
<p>依赖 <code>openssl-devel</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./configure --prefix=/usr/local/nginx --add-module=/root/nginx-goodies-nginx-sticky-module-ng-c78b7dd79d0d</span><br></pre></td></tr></table></figure>
<p>打开  <code>ngx_http_sticky_misc.c</code>  文件</p>
<p>在 12 行添加</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/sha.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;openssl/md5.h&gt;</span></span></span><br></pre></td></tr></table></figure>
<p><strong>备份之前的程序</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /usr/local/nginx/sbin/nginx /usr/local/nginx/sbin/nginx.old</span><br></pre></td></tr></table></figure>
<p><strong>把编译好的 Nginx 程序替换到原来的目录里</strong></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cp objs/nginx /usr/local/nginx/sbin/</span><br></pre></td></tr></table></figure>
<p><strong>升级检测</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make upgrade</span><br></pre></td></tr></table></figure>
<p>检查程序中是否包含新模块</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nginx -V</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> httpds &#123;</span><br><span class="line">       <span class="attribute">sticky</span> name=shabi expires=<span class="number">6h</span>;</span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.13.155:8080</span>;</span><br><span class="line">       <span class="attribute">server</span> <span class="number">192.168.13.166:8080</span>;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="section">server</span> &#123;</span><br><span class="line">       <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">       <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">       <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">       <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">       <span class="section">location</span> / &#123;</span><br><span class="line">               <span class="attribute">proxy_pass</span> http://httpds;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">      <span class="section">location</span> ~*/(js|img|css) &#123;</span><br><span class="line">               <span class="attribute">root</span>   /usr/local/nginx/html;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>浏览器多标签会共享 cookie，且名字不好和 JESEEIONID 重复</p>
<p>原理是在 cookie 中加入一个字段，从会话保持，也能维持静态会话</p>
<h3 id="四层负载均衡"><a class="markdownIt-Anchor" href="#四层负载均衡">#</a> 四层负载均衡</h3>
<p>Nginx 在 1.9 之后，增加了一个 stream 模块，用来实现四层协议的转发、代理、负载均衡等。stream 模块的用法跟 http 的用法类似，允许我们配置一组 TCP 或者 UDP 等协议的监听，然后通过 proxy_pass 来转发我们的请求，通过 upstream 添加多个后端服务，实现负载均衡。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418102743685.png" alt="image-20230418102743685"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">--with-<span class="attribute">stream</span></span><br><span class="line"><span class="comment"># stream指令 该指令提供在其中指定流服务器指令的配置文件上下文。和http指令同级。</span></span><br><span class="line"><span class="comment"># 位置main</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># upstream指令 该指令和http的upstream指令是类似的</span></span><br><span class="line"></span><br><span class="line">stream &#123;</span><br><span class="line">    <span class="section">upstream</span> backend &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.13.155:8888</span>;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.13.155:8889</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">upstream</span> backendtomcat &#123;</span><br><span class="line">        <span class="attribute">server</span> <span class="number">192.168.13.155:8080</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">81</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> backend;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">82</span>;</span><br><span class="line">        <span class="attribute">proxy_pass</span> backendtomcat;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>四层和七层都有，四层优先</p>
<h2 id="缓存"><a class="markdownIt-Anchor" href="#缓存">#</a> 缓存</h2>
<p>缓存就是数据交换的缓冲区 (称作：Cache), 当用户要获取数据的时候，会先从缓存中去查询获取数据，如果缓存中有就会直接返回给用户，如果缓存中没有，则会发请求从服务器重新查询数据，将数据返回给用户的同时将数据放入缓存，下次用户就会直接从缓存中获取数据。</p>
<table>
<thead>
<tr>
<th>场景</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>操作系统磁盘缓存</td>
<td>减少磁盘机械操作</td>
</tr>
<tr>
<td>数据库缓存</td>
<td>减少文件系统的 IO 操作</td>
</tr>
<tr>
<td>应用程序缓存</td>
<td>减少对数据库的查询</td>
</tr>
<tr>
<td>Web 服务器缓存</td>
<td>减少对应用服务器请求次数</td>
</tr>
<tr>
<td>浏览器缓存</td>
<td>减少与后台的交互次数</td>
</tr>
</tbody>
</table>
<p>缓存的优点</p>
<p>​	1. 减少数据传输，节省网络流量，加快响应速度，提升用户体验；</p>
<p>​	2. 减轻服务器压力；</p>
<p>​	3. 提供服务端的高可用性；</p>
<p>缓存的缺点</p>
<p>​	1. 数据的不一致</p>
<p>​	2. 增加成本</p>
<h4 id="浏览器缓存"><a class="markdownIt-Anchor" href="#浏览器缓存">#</a> 浏览器缓存</h4>
<h5 id="什么时候可以用缓存"><a class="markdownIt-Anchor" href="#什么时候可以用缓存">#</a> 什么时候可以用缓存？</h5>
<ol>
<li>不常改变的内容</li>
<li>过期时间</li>
<li>针对 post/get 请求都可以</li>
<li>存储位置</li>
<li>磁盘使用空间限制</li>
</ol>
<ul>
<li>deskcache</li>
</ul>
<p>字面理解是从内存中，其实也是字面的含义，这个资源是直接从内存中拿到的，<strong>不会请求服务器</strong>一般已经加载过该资源且缓存在了内存当中，当关闭该页面时，此资源就被内存释放掉了，再次重新打开相同页面时不会出现 from memory cache 的情况</p>
<ul>
<li>memorycache</li>
</ul>
<p>是从磁盘当中取出的，也是在已经在之前的某个时间加载过该资源，<strong>不会请求服务器</strong>但是此资源不会随着该页面的关闭而释放掉，因为是存在硬盘当中的，下次打开仍会 from disk cache</p>
<h5 id="age"><a class="markdownIt-Anchor" href="#age">#</a> Age</h5>
<p>是 CDN 添加的属性表示在 CDN 中缓存了多少秒</p>
<h5 id="via"><a class="markdownIt-Anchor" href="#via">#</a> <strong>via</strong></h5>
<p>用来标识 CDN 缓存经历了哪些服务器，缓存是否命中，使用的协议</p>
<h4 id="强制缓存与协商缓存"><a class="markdownIt-Anchor" href="#强制缓存与协商缓存">#</a> 强制缓存与协商缓存</h4>
<p>强制缓存：直接从本机读取，不请求服务器</p>
<p>协商缓存：发送请求 header 中携带 Last-Modified，服务器可能会返回 304 Not Modified</p>
<h4 id="浏览器强制缓存"><a class="markdownIt-Anchor" href="#浏览器强制缓存">#</a> 浏览器强制缓存</h4>
<h5 id="cache-control"><a class="markdownIt-Anchor" href="#cache-control">#</a> <strong>cache-control</strong></h5>
<p>http1.1 的规范，使用 max-age 表示文件可以在浏览器中缓存的时间以秒为单位</p>
<table>
<thead>
<tr>
<th>标记</th>
<th>类型</th>
<th>功能</th>
</tr>
</thead>
<tbody>
<tr>
<td>public</td>
<td>响应头</td>
<td>响应的数据可以被缓存，客户端和代理层都可以缓存</td>
</tr>
<tr>
<td>private</td>
<td>响应头</td>
<td>可私有缓存，客户端可以缓存，代理层不能缓存（CDN，proxy_pass）</td>
</tr>
<tr>
<td>no-cache</td>
<td>请求头</td>
<td>可以使用本地缓存，但是必须发送请求到服务器回源验证</td>
</tr>
<tr>
<td>no-store</td>
<td>请求和响应</td>
<td>应禁用缓存</td>
</tr>
<tr>
<td>max-age</td>
<td>请求和响应</td>
<td>文件可以在浏览器中缓存的时间以秒为单位</td>
</tr>
<tr>
<td>s-maxage</td>
<td>请求和响应</td>
<td>用户代理层缓存，CDN 下发，当客户端数据过期时会重新校验</td>
</tr>
<tr>
<td>max-stale</td>
<td>请求和响应</td>
<td>缓存最大使用时间，如果缓存过期，但还在这个时间范围内则可以使用缓存数据</td>
</tr>
<tr>
<td>min-fresh</td>
<td>请求和响应</td>
<td>缓存最小使用时间，</td>
</tr>
<tr>
<td>must-revalidate</td>
<td>请求和响应</td>
<td>当缓存过期后，必须回源重新请求资源。比 no-cache 更严格。因为 HTTP 规范是允许客户端在某些特殊情况下直接使用过期缓存的，比如校验请求发送失败的时候。那么带有 must-revalidate 的缓存必须校验，其他条件全部失效。</td>
</tr>
<tr>
<td>proxy-revalidate</td>
<td>请求和响应</td>
<td>和 must-revalidate 类似，只对 CDN 这种代理服务器有效，客户端遇到此头，需要回源验证</td>
</tr>
<tr>
<td>stale-while-revalidate</td>
<td>响应</td>
<td>表示在指定时间内可以先使用本地缓存，后台进行异步校验</td>
</tr>
<tr>
<td>stale-if-error</td>
<td>响应</td>
<td>在指定时间内，重新验证时返回状态码为 5XX 的时候，可以用本地缓存</td>
</tr>
<tr>
<td>only-if-cached</td>
<td>响应</td>
<td>那么只使用缓存内容，如果没有缓存 则 504 getway timeout</td>
</tr>
</tbody>
</table>
<p>在浏览器和服务器端验证文件是否过期的时候，浏览器在二次请求的时候会携带 IF-Modified-Since 属性</p>
<h5 id="expires"><a class="markdownIt-Anchor" href="#expires">#</a> Expires</h5>
<p>过期时间</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">expires 30s;   #缓存30秒</span><br><span class="line">expires 30m;  #缓存30分钟   </span><br><span class="line">expires 2h;     #缓存2小时</span><br><span class="line">expires 30d;    #缓存30天</span><br></pre></td></tr></table></figure>
<h4 id="协商缓存"><a class="markdownIt-Anchor" href="#协商缓存">#</a> 协商缓存</h4>
<h5 id="last-modified"><a class="markdownIt-Anchor" href="#last-modified">#</a> <strong>last-modified</strong></h5>
<h5 id="etag"><a class="markdownIt-Anchor" href="#etag">#</a> <strong>etag</strong></h5>
<p>http1.1 支持</p>
<p>在 HTTP 协议中 If-Modified-Since 和 If-None-Match 分别对应 Last-Modified 和 ETag</p>
<p>Entity Tag 的缩写，中文译过来就是实体标签的意思.</p>
<p>HTTP 中并没有指定如何生成 ETag，哈希是比较理想的选择。</p>
<p>在计算 Etag 的时候，会产生 CPU 的耗费，所以也可以用时间戳，但这样直接使用 Last-Modified 即可。</p>
<p>ETag 用来校验用户请求的资源是否有变化，作用和 lastmodified 很像，区别是 lastmodified 精确到秒，ETag 可以用 hash 算法来生成更精确的比对内容。</p>
<p>当用户首次请求资源的时候返回给用户数据和 200 状态码并生成 ETag，再次请求的时候服务器比对 ETag，没有发生变化的话返回 304</p>
<p>Cache-Control 直接是通过不请求来实现，而 ETag 是会发请求的，只不过服务器根据请求的东西的内容有无变化来判断是否返回请求的资源</p>
<h4 id="cache-control-expires-强制缓存"><a class="markdownIt-Anchor" href="#cache-control-expires-强制缓存">#</a> cache-control expires 强制缓存</h4>
<p>页面首次打开，直接读取缓存数据，刷新，会向服务器发起请求</p>
<h4 id="etag-lastmodify-协商缓存"><a class="markdownIt-Anchor" href="#etag-lastmodify-协商缓存">#</a> etag lastmodify  协商缓存</h4>
<p>没发生变化 返回 304 不发送数据</p>
<h4 id="浏览器缓存原则"><a class="markdownIt-Anchor" href="#浏览器缓存原则">#</a> 浏览器缓存原则</h4>
<ul>
<li>
<p>多级集群负载时 last-modified 必须保持一致</p>
</li>
<li>
<p>还有一些场景下我们希望禁用浏览器缓存。比如轮训 api 上报数据数据</p>
</li>
<li>
<p>浏览器缓存很难彻底禁用，大家的做法是加版本号，随机数等方法。</p>
</li>
<li>
<p>只缓存 200 响应头的数据，像 3XX 这类跳转的页面不需要缓存。</p>
</li>
<li>
<p>对于 js，css 这类可以缓存很久的数据，可以通过加版本号的方式更新内容</p>
</li>
<li>
<p>不需要强一致性的数据，可以缓存几秒</p>
</li>
<li>
<p>异步加载的接口数据，可以使用 ETag 来校验。</p>
</li>
<li>
<p>在服务器添加 Server 头，有利于排查错误</p>
</li>
<li>
<p>分为手机 APP 和 Client 以及是否遵循 http 协议</p>
</li>
<li>
<p>在没有联网的状态下可以展示数据</p>
</li>
<li>
<p>流量消耗过多</p>
</li>
<li>
<p>提前下发  避免秒杀时同时下发数据造成流量短时间暴增</p>
</li>
<li>
<p>兜底数据 在服务器崩溃和网络不可用的时候展示</p>
</li>
<li>
<p>临时缓存  退出即清理</p>
</li>
<li>
<p>固定缓存  展示框架这种，可能很长时间不会更新，可用随客户端下发</p>
<ul>
<li><strong>首页</strong>有的时候可以看做是框架 应该禁用缓存，以保证加载的资源都是最新的</li>
</ul>
</li>
<li>
<p>父子连接 页面跳转时有一部分内容不需要重新加载，可用从父菜单带过来</p>
</li>
<li>
<p>预加载     某些逻辑可用判定用户接下来的操作，那么可用异步加载那些资源</p>
</li>
<li>
<p>漂亮的加载过程 异步加载 先展示框架，然后异步加载内容，避免主线程阻塞</p>
</li>
</ul>
<p>Nginx 是从 0.7.48 版开始提供缓存功能。Nginx 是基于 Proxy Store 来实现的，其原理是把 URL 及相关组合当做 Key, 在使用 MD5 算法对 Key 进行哈希，得到硬盘上对应的哈希目录路径，从而将缓存内容保存在该目录中。它可以支持任意 URL 连接，同时也支持 404/301/302 这样的非 200 状态码。Nginx 即可以支持对指定 URL 或者状态码设置过期时间，也可以使用 purge 命令来手动清除指定 URL 的缓存。</p>
<p>Nginx 的 web 缓存服务主要是使用 <code>ngx_http_proxy_module</code>  模块相关指令集来完成</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># proxy_cache_path 该指定用于设置缓存文件的存放路径</span></span><br><span class="line"><span class="comment"># 位置http</span></span><br><span class="line"><span class="attribute">proxy_cache_path</span> /usr/local/proxy_cache keys_zone=itcast:<span class="number">200m</span>  levels=<span class="number">1</span>:<span class="number">2</span> inactive=<span class="number">1d</span> max_size=<span class="number">20g</span>;</span><br><span class="line">再加两层目录，第一层一个字母，第二层两个字母</span><br><span class="line">缓存名称，大小</span><br><span class="line">缓存超时时间，未被访问就会删除</span><br><span class="line">设置最大缓存空间，如果缓存空间存满，默认会覆盖缓存时间最长的资源</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_cache 该指令用来开启或关闭代理缓存，如果是开启则自定使用哪个缓存区来进行缓存。</span></span><br><span class="line"><span class="comment"># 位置http、server、location</span></span><br><span class="line"><span class="attribute">proxy_cache</span> itcast</span><br><span class="line"><span class="comment"># 这个名字需要和上面定义的keys_zone的名字相同</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_cache_key 该指令用来设置web缓存的key值，Nginx会根据key值MD5哈希存缓存</span></span><br><span class="line"><span class="comment"># 默认值 proxy_cache_key \$scheme\$proxy_host$request_uri;</span></span><br><span class="line"><span class="comment"># 位置http、server、location</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_cache_vaild 该指令用来对不同返回状态码的URL设置不同的缓存时间</span></span><br><span class="line"><span class="comment"># 位置http、server、location</span></span><br><span class="line">proxy_cache_valid <span class="number">200</span> <span class="number">302</span> <span class="number">10m</span>;</span><br><span class="line"><span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">1m</span>;</span><br><span class="line"><span class="comment"># 为200和302的响应URL设置10分钟缓存，为404的响应URL设置1分钟缓存</span></span><br><span class="line"><span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line"><span class="comment"># 对所有响应状态码的URL都设置1分钟缓存</span></span><br><span class="line"><span class="comment"># 最小匹配优先</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_cache_min_uses 该指令用来设置资源被访问多少次后被缓存</span></span><br><span class="line"><span class="comment"># 位置http、server、location</span></span><br><span class="line">默认值为1</span><br><span class="line"></span><br><span class="line"><span class="comment"># proxy_cache_methdos 该指令用户设置缓存哪些HTTP方法</span></span><br><span class="line"><span class="comment"># 位置http、server、location</span></span><br><span class="line">默认值为<span class="attribute">GET</span> HEAD  ，支持get head post</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 断点续传缓存 range</span></span><br><span class="line">当有完整的content-length之后即可断点续传</span><br><span class="line">在反向代理服务器中需向后传递header</span><br><span class="line"></span><br><span class="line">proxy_set_header Range <span class="variable">$http_range</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418103348767.png" alt="image-20230418103348767"></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">http&#123;</span><br><span class="line">	<span class="attribute">proxy_cache_path</span> /usr/local/proxy_cache levels=<span class="number">2</span>:<span class="number">1</span> keys_zone=itcast:<span class="number">200m</span> inactive=<span class="number">1d</span> max_size=<span class="number">20g</span>;</span><br><span class="line">	<span class="section">upstream</span> backend&#123;</span><br><span class="line">		<span class="attribute">server</span> <span class="number">192.168.200.146:8080</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="section">server</span> &#123;</span><br><span class="line">		<span class="attribute">listen</span>       <span class="number">8080</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">        	<span class="attribute">proxy_cache</span> itcast;</span><br><span class="line">            <span class="comment"># 建议使用默认值$schema$proxy_host$request_uri; 相同的proxy_cache_key会出现问题，即该location下不同uri会返回相同的缓存</span></span><br><span class="line">            <span class="attribute">proxy_cache_key</span> it;</span><br><span class="line">            <span class="attribute">proxy_cache_min_uses</span> <span class="number">5</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">200</span> <span class="number">5d</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> <span class="number">404</span> <span class="number">30s</span>;</span><br><span class="line">            <span class="attribute">proxy_cache_valid</span> any <span class="number">1m</span>;</span><br><span class="line">            <span class="attribute">add_header</span> nginx-cache <span class="string">&quot;<span class="variable">$upstream_cache_status</span>&quot;</span>;</span><br><span class="line">        	<span class="attribute">proxy_pass</span> http://backend/js/;</span><br><span class="line">        &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="删除缓存"><a class="markdownIt-Anchor" href="#删除缓存">#</a> 删除缓存</h3>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1.<span class="attribute">rm</span> -rf /usr/local/proxy_cache/......</span><br><span class="line"></span><br><span class="line"><span class="number">2</span>.使用ngx_cache_purge</span><br><span class="line">ngx_cache_purge-<span class="number">2</span>.<span class="number">3</span>.tar.gz</span><br><span class="line">./configure --add-module=/root/nginx/module/purge</span><br><span class="line">server &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">8080</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line">    <span class="section">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_cache</span> xixi;</span><br><span class="line">        <span class="attribute">proxy_cache_key</span> haha;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">server&#123;    </span><br><span class="line">    <span class="section">location</span> ~/purge(/.*) &#123; </span><br><span class="line">        <span class="comment"># proxy_cache=name  peoxy_cache_key=key  上下两个key需要一样</span></span><br><span class="line">        <span class="attribute">proxy_cache_purge</span> xixi haha;    </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="设置资源不缓存"><a class="markdownIt-Anchor" href="#设置资源不缓存">#</a> 设置资源不缓存</h3>
<p>比如说对于一些经常发生变化的数据。如果进行缓存的话，就很容易出现用户访问到的数据不是服务器真实的数据。所以对于这些资源我们在缓存的过程中就需要进行过滤，不进行缓存。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置位置http,server,location</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#proxy_no_cache</span></span><br><span class="line"><span class="comment">#该指令是用来定义不将数据进行缓存的条件。</span></span><br><span class="line"><span class="attribute">proxy_no_cache</span> <span class="variable">$cookie_nocache</span> <span class="variable">$arg_nocache</span> <span class="variable">$arg_comment</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#proxy_cache_bypass</span></span><br><span class="line"><span class="comment">#该指令是用来设置不从缓存中获取数据的条件。</span></span><br><span class="line"><span class="attribute">proxy_cache_bypass</span> <span class="variable">$cookie_nocache</span> <span class="variable">$arg_nocache</span> <span class="variable">$arg_comment</span>;</span><br></pre></td></tr></table></figure>
<p>上述两个指令都有一个指定的条件，这个条件可以是多个，并且多个条件中至少有一个不为空且不等于 &quot;0&quot;, 则条件满足成立。里面使用到了三个变量，分别是 $cookie_nocache、$arg_nocache、$arg_comment</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$<span class="attribute">cookie_nocache</span></span><br><span class="line">指的是当前请求的cookie中键的名称为nocache对应的值</span><br><span class="line"><span class="variable">$arg_nocache</span>和<span class="variable">$arg_comment</span></span><br><span class="line">指的是当前请求的参数中属性名为nocache和comment对应的属性值</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	<span class="attribute">listen</span>	<span class="number">8080</span>;</span><br><span class="line">	<span class="attribute">server_name</span> localhost;</span><br><span class="line">	<span class="section">location</span> / &#123;</span><br><span class="line">		<span class="attribute">if</span> (<span class="variable">$request_uri</span> <span class="regexp">~ /.*\.js$)</span>&#123;</span><br><span class="line">           <span class="attribute">set</span> <span class="variable">$nocache</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">	   <span class="attribute">proxy_no_cache</span> <span class="variable">$nocache</span> <span class="variable">$cookie_nocache</span> <span class="variable">$arg_nocache</span> <span class="variable">$arg_comment</span>;</span><br><span class="line">        <span class="attribute">proxy_cache_bypass</span> <span class="variable">$nocache</span> <span class="variable">$cookie_nocache</span> <span class="variable">$arg_nocache</span> <span class="variable">$arg_comment</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>或者通过 url 指定后面两个参数</p>
<p>/jquery.js?nocache=1</p>
<p>/jquery.js?comment=1</p>
<p>都不会缓存或者使用 set cookie 中的 nocache</p>
<p>上面三个变量只要不是 0 就行</p>
<p>推荐两个都用 proxy_no_cache proxy_cache_bypass</p>
<h2 id="动静分离"><a class="markdownIt-Anchor" href="#动静分离">#</a> 动静分离</h2>
<p>动：后台应用程序的业务处理</p>
<p>静：网站的静态资源 (html,javaScript,css,images 等文件)</p>
<p>分离：将两者进行分开部署访问，提供用户进行访问。举例说明就是以后所有和静态资源相关的内容都交给 Nginx 来部署访问，非静态内容则交个类似于 Tomcat 的服务器来部署访问。</p>
<p>Nginx 在处理静态资源的时候，效率是非常高的，而且 Nginx 的并发访问量也是名列前茅，而 Tomcat 则相对比较弱一些，所以把静态资源交个 Nginx 后，可以减轻 Tomcat 服务器的访问压力并提高静态资源的访问速度。</p>
<p>动静分离以后，降低了动态资源和静态资源的耦合度。如动态资源宕机了也不影响静态资源的展示。</p>
<p>实现动静分离的方式很多，比如静态资源可以部署到 CDN、Nginx 等服务器上，动态资源可以部署到 Tomcat,weblogic 或者 websphere 上。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 将后端服务器上的静态资源删除</span></span><br><span class="line"><span class="comment"># 把后端服务器上的静态资源放到nginx上</span></span><br><span class="line"><span class="section">upstream</span> webservice&#123;</span><br><span class="line">   <span class="attribute">server</span> <span class="number">192.168.200.146:8080</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">        <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#动态资源</span></span><br><span class="line">        <span class="section">location</span> /demo &#123;</span><br><span class="line">                <span class="attribute">proxy_pass</span> http://webservice;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">#静态资源</span></span><br><span class="line">        <span class="section">location</span> ~/.*\.(png|jpg|gif|js)&#123;</span><br><span class="line">                <span class="attribute">root</span> html/web;</span><br><span class="line">                <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="section">location</span> / &#123;</span><br><span class="line">            <span class="attribute">root</span>   html/web;</span><br><span class="line">            <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="keepalived"><a class="markdownIt-Anchor" href="#keepalived">#</a> keepalived</h2>
<p>Keepalived 软件由 C 编写的，最初是专为 LVS 负载均衡软件设计的，Keepalived 软件主要是通过 VRRP 协议实现高可用功能。</p>
<p>1. 选择协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">VRRP可以把一个虚拟路由器的责任动态分配到局域网上的 VRRP 路由器中的一台。其中的虚拟路由即Virtual路由是由VRRP路由群组创建的一个不真实存在的路由，这个虚拟路由也是有对应的IP地址。而且VRRP路由1和VRRP路由2之间会有竞争选择，通过选择会产生一个Master路由和一个Backup路由。</span><br></pre></td></tr></table></figure>
<p>2. 路由容错协议</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Master路由和Backup路由之间会有一个心跳检测，Master会定时告知Backup自己的状态，如果在指定的时间内，Backup没有接收到这个通知内容，Backup就会替代Master成为新的Master。Master路由有一个特权就是虚拟路由和后端服务器都是通过Master进行数据传递交互的，而备份节点则会直接丢弃这些请求和数据，不做处理，只是去监听Master的状态</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418104426216.png" alt="image-20230418104426216"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">步骤1:从官方网站下载keepalived,官网地址https://keepalived.org/</span><br><span class="line">步骤2:将下载的资源上传到服务器</span><br><span class="line">	keepalived-2.0.20.tar.gz</span><br><span class="line">步骤3:创建keepalived目录，方便管理资源</span><br><span class="line">	mkdir keepalived</span><br><span class="line">步骤4:将压缩文件进行解压缩，解压缩到指定的目录</span><br><span class="line">	tar -zxf keepalived-2.0.20.tar.gz -C keepalived/</span><br><span class="line">步骤5:对keepalived进行配置，编译和安装</span><br><span class="line">	cd keepalived/keepalived-2.0.20</span><br><span class="line">	./configure --sysconf=/etc --prefix=/usr/local</span><br><span class="line">	make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line">或者直接：</span><br><span class="line">yum install keepalived</span><br></pre></td></tr></table></figure>
<p>打开 keepalived.conf 配置文件</p>
<p>这里面会分三部，第一部分是 global 全局配置、第二部分是 vrrp 相关配置、第三部分是 LVS 相关配置。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">global全局部分：</span><br><span class="line">global_defs &#123;</span><br><span class="line">   <span class="comment">#通知邮件，当keepalived发送切换时需要发email给具体的邮箱地址</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     tom@itcast.cn</span><br><span class="line">     jerry@itcast.cn</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">#设置发件人的邮箱信息</span></span><br><span class="line">   notification_email_from zhaomin@itcast.cn</span><br><span class="line">   <span class="comment">#指定smpt服务地址</span></span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   <span class="comment">#指定smpt服务连接超时时间</span></span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   <span class="comment">#运行keepalived服务器的一个标识，可以用作发送邮件的主题信息</span></span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">   </span><br><span class="line">   <span class="comment">#默认是不跳过检查。检查收到的VRRP通告中的所有地址可能会比较耗时，设置此命令的意思是，如果通告与接收的上一个通告来自相同的master路由器，则不执行检查(跳过检查)</span></span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   <span class="comment">#严格遵守VRRP协议。</span></span><br><span class="line">   vrrp_strict</span><br><span class="line">   <span class="comment">#在一个接口发送的两个免费ARP之间的延迟。可以精确到毫秒级。默认是0</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   <span class="comment">#在一个网卡上每组na消息之间的延迟时间，默认为0</span></span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">VRRP部分，该部分可以包含以下四个子模块</span><br><span class="line">1. vrrp_script</span><br><span class="line">2. vrrp_sync_group</span><br><span class="line">3. garp_group</span><br><span class="line">4. vrrp_instance</span><br><span class="line">我们会用到第一个和第四个，</span><br><span class="line">#设置keepalived实例的相关信息，VI_1为VRRP实例名称</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER  		#有两个值可选MASTER主 BACKUP备</span><br><span class="line">    interface ens33		#vrrp实例绑定的接口，用于发送VRRP包[当前服务器使用的网卡名称]</span><br><span class="line">    virtual_router_id 51#指定VRRP实例ID，范围是0-255</span><br><span class="line">    priority 100		#指定优先级，优先级高的将成为MASTER</span><br><span class="line">    advert_int 1		#指定发送VRRP通告的间隔，单位是秒</span><br><span class="line">    authentication &#123;	#vrrp之间通信的认证信息</span><br><span class="line">        auth_type PASS	#指定认证方式。PASS简单密码认证(推荐)</span><br><span class="line">        auth_pass 1111	#指定认证使用的密码，最多8位</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123; #虚拟IP地址设置虚拟IP地址，供用户访问使用，可设置多个，一行一个</span><br><span class="line">        192.168.200.222</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">        tom@itcast.cn</span><br><span class="line">        jerry@itcast.cn</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from zhaomin@itcast.cn</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id keepalived1</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">	</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.222</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keepalived只能做到对网络故障和keepalived本身的监控，即当出现网络故障或者keepalived本身出现问题时，进行切换。但是这些还不够，我们还需要监控keepalived所在服务器上的其他业务，比如Nginx,如果Nginx出现异常了，仅仅keepalived保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230418112232876.png" alt="image-20230418112232876"></p>
<p>要想让 vip 进行切换，就必须要把服务器上的 keepalived 进行关闭，而什么时候关闭 keepalived 呢？应该是在 keepalived 所在服务器的 nginx 出现问题后，把 keepalived 关闭掉，就可以让 VIP 执行另外一台服务器，但是现在这所有的操作都是通过手动来完成的，我们如何能让系统自动判断当前服务器的 nginx 是否正确启动，如果没有，要能让 VIP 自动进行 &quot;漂移&quot;</p>
<p>keepalived 只能做到对网络故障和 keepalived 本身的监控，即当出现网络故障或者 keepalived 本身出现问题时，进行切换。但是这些还不够，我们还需要监控 keepalived 所在服务器上的其他业务，比如 Nginx, 如果 Nginx 出现异常了，仅仅 keepalived 保持正常，是无法完成系统的正常工作的，因此需要根据业务进程的运行状态决定是否需要进行主备切换，这个时候，我们可以通过编写脚本对业务进程进行检测监控。</p>
<p>实现步骤:</p>
<ol>
<li>在 keepalived 配置文件中添加对应的配置像</li>
</ol>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script 脚本名称</span><br><span class="line">&#123;</span><br><span class="line">    script &quot;脚本位置&quot;</span><br><span class="line">    interval 3 #执行时间间隔</span><br><span class="line">    weight -20 #动态调整vrrp_instance的优先级</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>编写脚本</li>
</ol>
<p>ck_nginx.sh</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">#!/bin/bash</span><br><span class="line">num=`ps -C nginx --no-header | wc -l`</span><br><span class="line">if [ $num -eq 0 ];then</span><br><span class="line"> /usr/local/nginx/sbin/nginx</span><br><span class="line"> sleep 2</span><br><span class="line"> if [ `ps -C nginx --no-header | wc -l` -eq 0 ]; then</span><br><span class="line">  killall keepalived</span><br><span class="line"> fi</span><br><span class="line">fi</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 755 ck_nginx.sh</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">vrrp_script ck_nginx &#123;</span><br><span class="line">   script &quot;/etc/keepalived/ck_nginx.sh&quot; #执行脚本的位置</span><br><span class="line">   interval 2		#执行脚本的周期，秒为单位</span><br><span class="line">   weight -20		#权重的计算方式</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens33</span><br><span class="line">    virtual_router_id 10</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.200.111</span><br><span class="line">    &#125;</span><br><span class="line">    track_script &#123;</span><br><span class="line">      ck_nginx</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通常如果 master 服务死掉后 backup 会变成 master，但是当 master 服务又好了的时候 master 此时会抢占 VIP，这样就会发生两次切换对业务繁忙的网站来说是不好的。所以我们要在配置文件加入 nopreempt 非抢占，但是这个参数只能用于 state 为 backup，<strong>故我们在用 HA 的时候最好 master 和 backup 的 state 都设置成 backup 让其通过 priority 来竞争。</strong></p>
<h2 id="制作下载站点"><a class="markdownIt-Anchor" href="#制作下载站点">#</a> 制作下载站点</h2>
<p>nginx 使用的是模块 ngx_http_autoindex_module 来实现的，该模块处理以斜杠 (&quot;/&quot;) 结尾的请求，并生成目录列表。</p>
<p>nginx 编译的时候会自动加载该模块，但是该模块默认是关闭的，我们需要使用下来指令来完成对应的配置</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 以下都可以在http,server,location 配置</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># autoindex:启用或禁用目录列表输出</span></span><br><span class="line"><span class="attribute">autoindex</span> <span class="literal">on</span>|<span class="literal">off</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># autoindex_exact_size:对应HTLM格式，指定是否在目录列表展示文件的详细大小</span></span><br><span class="line"><span class="attribute">autoindex_exact_size</span>  <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># autoindex_format：设置目录列表的格式</span></span><br><span class="line"><span class="attribute">autoindex_format</span> html|xml|json|jsonp;</span><br><span class="line"></span><br><span class="line">autoindex_localtime: 对应HTML格式，是否在目录列表上显示时间。</span><br><span class="line">默认为off，显示的文件时间为GMT时间。</span><br><span class="line">改为on后，显示的文件时间为文件的服务器时间</span><br><span class="line"><span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">location /download&#123;</span><br><span class="line">    root /usr/local;</span><br><span class="line">    autoindex on;</span><br><span class="line">    autoindex_exact_size on;</span><br><span class="line">    autoindex_format html;</span><br><span class="line">    autoindex_localtime on;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="用户认证模块"><a class="markdownIt-Anchor" href="#用户认证模块">#</a> 用户认证模块</h2>
<p>对应系统资源的访问，我们往往需要限制谁能访问，谁不能访问。这块就是我们通常所说的认证部分，认证需要做的就是根据用户输入的用户名和密码来判定用户是否为合法用户，如果是则放行访问，如果不是则拒绝访问。</p>
<p>Nginx 对应用户认证这块是通过 ngx_http_auth_basic_module 模块来实现的，它允许通过使用 &quot;HTTP 基本身份验证&quot; 协议验证用户名和密码来限制对资源的访问。默认情况下 nginx 是已经安装了该模块，如果不需要则使用–without-http_auth_basic_module。</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">（1）auth_basic:使用“ HTTP基本认证”协议启用用户名和密码的验证</span><br><span class="line"></span><br><span class="line">| 语法   | <span class="attribute">auth_basic</span> string\|<span class="literal">off</span>;           |</span><br><span class="line">| ------ | --------------------------------- |</span><br><span class="line">| 默认值 | <span class="attribute">auth_basic</span> <span class="literal">off</span>;                   |</span><br><span class="line">| 位置   | http,server,<span class="section">location</span>,limit_except |</span><br><span class="line"></span><br><span class="line">开启后，服务端会返回<span class="number">401</span>，指定的字符串会返回到客户端，给用户以提示信息，但是不同的浏览器对内容的展示不一致。</span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）auth_basic_user_file:指定用户名和密码所在文件</span><br><span class="line"></span><br><span class="line">| 语法   | auth_basic_user_file file;        |</span><br><span class="line">| ------ | --------------------------------- |</span><br><span class="line">| 默认值 | —                                 |</span><br><span class="line">| 位置   | http,server,<span class="section">location</span>,limit_except |</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">location</span> /download&#123;</span><br><span class="line">    <span class="attribute">root</span> /usr/local;</span><br><span class="line">    <span class="attribute">autoindex</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_exact_size</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">autoindex_format</span> html;</span><br><span class="line">    <span class="attribute">autoindex_localtime</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">auth_basic</span> <span class="string">&#x27;please input your auth&#x27;</span>;</span><br><span class="line">    <span class="attribute">auth_basic_user_file</span> htpasswd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>yum install -y httpd-tools</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">htpasswd -c /usr/local/nginx/conf/htpasswd username //创建一个新文件记录用户名和密码</span><br><span class="line">htpasswd -b /usr/local/nginx/conf/htpasswd username password //在指定文件新增一个用户名和密码</span><br><span class="line">htpasswd -D /usr/local/nginx/conf/htpasswd username //从指定文件删除一个用户信息</span><br><span class="line">htpasswd -v /usr/local/nginx/conf/htpasswd username //验证用户名和密码是否正确</span><br></pre></td></tr></table></figure>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuYmlsaWJpbGkuY29tL3ZpZGVvL0JWMW92NDExODdicS8/cD0xNDAmYW1wO3ZkX3NvdXJjZT1jMmU5MTdhNjcwMGNhZDM0OWJlOTE2MGU5NzNjMThhNg==">13-Nginx 用户认证模块的使用_哔哩哔哩_bilibili</span></p>
<h2 id="keepalive"><a class="markdownIt-Anchor" href="#keepalive">#</a> keepalive</h2>
<p>需要持续获取请求，通过 http 连接，则开启 keepalive</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">keepalive_timeout</span>  <span class="number">65</span>;</span><br><span class="line">65指活跃时间，一旦活跃就会被重置</span><br><span class="line"></span><br><span class="line">请求很多但来自不同客户端，就没有必要开启keepalive，比如时间服务器</span><br><span class="line"></span><br><span class="line">=0 关闭keepalive，connection: <span class="attribute">close</span> 服务器没有启动keepalive</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230326145512655.png" alt="image-20230326145512655"></p>
<p>如果一个 connections 中有多个 transactions，那么说明这些 transactions 是复用了这个 connections</p>
<p>对于 keepalive 链接，服务端通过 content-length 区分每一个请求</p>
<blockquote>
<h4 id="什么时候使用"><a class="markdownIt-Anchor" href="#什么时候使用">#</a> 什么时候使用？</h4>
<p>明显的预知用户会在当前连接上有下一步操作</p>
<p>复用连接，有效减少握手次数，尤其是 https 建立一次连接开销会更大</p>
<h4 id="什么时候不用"><a class="markdownIt-Anchor" href="#什么时候不用">#</a> 什么时候不用？</h4>
<p>访问内联资源一般用缓存，不需要 keepalive</p>
<p>长时间的 tcp 连接容易导致系统资源无效占用</p>
</blockquote>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http块的keepalive</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">keepalive_disable</span>  禁用某些浏览器的keepalive</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">keepalive_requests  </span><br><span class="line">设置一个keep-alive连接上可以服务的请求的最大数量，当最大请求数量达到时，连接被关闭。默认是<span class="number">100</span></span><br><span class="line">一个keep alive建立之后，nginx就会为这个连接设置一个计数器，记录这个keep alive的长连接上已经接收并处理的客户端请求的数量。如果达到这个参数设置的最大值时，则nginx会强行关闭这个长连接，逼迫客户端不得不重新建立新的长连接。</span><br><span class="line">QPS太大时，会发现有大量的TIME_WAIT的socket连接</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">send_timeout  两次向客户端写操作的间隔，超过timeout强制断开连接.服务端向客户端传输数据的超时时间。</span><br><span class="line">系统中 若有耗时操作，超过 send_timeout 强制断开连接。 注意：准备过程中，不是传输过程</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">keepalive_timeout timeout [header_timeout];</span><br><span class="line">设置keep-alive客户端连接在服务器端保持开启的超时值（默认75s）；值为0会禁用keep-alive客户端连接；</span><br><span class="line">可选、在响应的header域中设置一个值“Keep-Alive: timeout=time”；通常可以不用设置；</span><br><span class="line">默认值为75<span class="attribute">s</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一般 keepalive_timeout &gt; send_timeout </span><br><span class="line">keeplive_time  keepalive保持时间</span><br><span class="line"></span><br><span class="line">配置两个keepalive时会有两个keepalive</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># upstream 块的长连接</span></span><br><span class="line"><span class="attribute">keepalive</span>  <span class="number">300</span>;</span><br><span class="line">设置到<span class="section">upstream</span>服务器的空闲keepalive连接的最大数量</span><br><span class="line">当这个数量被突破时，最近使用最少的连接将被关闭</span><br><span class="line">keepalive指令不会限制一个nginx worker进程到<span class="section">upstream</span>服务器连接的总数量</span><br><span class="line"></span><br><span class="line">keepalive_timeout</span><br><span class="line">连接保留时间</span><br><span class="line">keepalive_requests</span><br><span class="line">一个tcp复用中可以并发接收的请求个数</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">出现大量TIME_WAIT的情况</span><br><span class="line">1）导致 nginx端出现大量TIME_WAIT的情况有两种：</span><br><span class="line"></span><br><span class="line">    keepalive_requests设置比较小，高并发下超过此值后nginx会强制关闭和客户端保持的keepalive长连接；（主动关闭连接后导致nginx出现TIME_WAIT）</span><br><span class="line">    keepalive设置的比较小（空闲数太小），导致高并发下nginx会频繁出现连接数震荡（超过该值会关闭连接），不停的关闭、开启和后端server保持的keepalive长连接；</span><br><span class="line">2）导致后端server端出现大量TIME_WAIT的情况：</span><br><span class="line">nginx没有打开和后端的长连接，即：没有设置<span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;和<span class="attribute">proxy_set_header</span> Connection “”;从而导致后端server每次关闭连接，高并发下就会出现server端出现大量TIME_WAIT</span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">http</span> &#123;</span><br><span class="line">    <span class="section">upstream</span>  BACKEND &#123;</span><br><span class="line">        <span class="attribute">server</span>   <span class="number">192.168.0.1</span>：<span class="number">8080</span>  weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="attribute">server</span>   <span class="number">192.168.0.2</span>：<span class="number">8080</span>  weight=<span class="number">1</span> max_fails=<span class="number">2</span> fail_timeout=<span class="number">30s</span>;</span><br><span class="line">        <span class="attribute">keepalive</span> <span class="number">300</span>;        </span><br><span class="line">    &#125;</span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">        <span class="attribute">listen</span> <span class="number">8080</span> default_server;</span><br><span class="line">        <span class="attribute">server_name</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="section">location</span> /  &#123;</span><br><span class="line">            <span class="attribute">proxy_pass</span> http://BACKEND;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Host  <span class="variable">$Host</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> x-forwarded-for <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">proxy_set_header</span> X-Real-IP <span class="variable">$remote_addr</span>;</span><br><span class="line">            <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-store;</span><br><span class="line">            <span class="attribute">add_header</span> Pragma  <span class="literal">no</span>-cache;</span><br><span class="line">            <span class="attribute">proxy_http_version</span> <span class="number">1</span>.<span class="number">1</span>;         // 这两个最好也设置</span><br><span class="line">            <span class="attribute">proxy_set_header</span> Connection <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="对客户端限制"><a class="markdownIt-Anchor" href="#对客户端限制">#</a> 对客户端限制</h3>
<blockquote>
<p><strong>client_body_buffer_size</strong></p>
<p>对客户端请求中的 body 缓冲区大小</p>
<p>默认 32 位 8k 64 位 16k</p>
<p>如果请求体大于配置，则写入临时文件</p>
<p><strong>client_header_buffer_size</strong></p>
<p>设置读取客户端请求体的缓冲区大小。 如果请求体大于缓冲区，则将整个请求体或仅将其部分写入临时文件。 默认 32 位 8K。 64 位平台 16K。</p>
<p><strong>client_max_body_size 1000M;</strong></p>
<p>默认 1m，如果一个请求的大小超过配置的值，会返回 413 (request Entity Too Large) 错误给客户端</p>
<p>将 size 设置为 0 将禁用对客户端请求正文大小的检查。</p>
<p><strong>client_body_timeout</strong></p>
<p>指定客户端与服务端建立连接后发送 request body 的超时时间。如果客户端在指定时间内没有发送任何内容，Nginx 返回 HTTP 408（Request Timed Out）</p>
<p><strong>client_header_timeout</strong></p>
<p>客户端向服务端发送一个完整的 request header 的超时时间。如果客户端在指定时间内没有发送一个完整的 request header，Nginx 返回 HTTP 408（Request Timed Out）。</p>
<p><strong>client_body_temp_path</strong> <em>path</em> <code> [</code> <em>level1</em> <code> [</code> <em>level2</em> <code> [</code> <em>level3</em>`]]]</p>
<p>在磁盘上客户端的 body 临时缓冲区位置</p>
<p><strong>client_body_in_file_only on;</strong></p>
<p>把 body 写入磁盘文件，请求结束也不会删除</p>
<p><strong>client_body_in_single_buffer</strong></p>
<p>尽量缓冲 body 的时候在内存中使用连续单一缓冲区，在二次开发时使用 <code>$request_body</code>  读取数据时性能会有所提高</p>
<p><strong>client_header_buffer_size</strong></p>
<p>设置读取客户端请求头的缓冲区大小</p>
<p>如果一个请求行或者一个请求头字段不能放入这个缓冲区，那么就会使用 large_client_header_buffers</p>
<p><strong>large_client_header_buffers</strong></p>
<p>默认 8k</p>
</blockquote>
<h2 id="获取客户端ip"><a class="markdownIt-Anchor" href="#获取客户端ip">#</a> 获取客户端 IP</h2>
<p>X-Forwarded-for：将上一层的 remoteaddr 写入到 x-forwarded-for</p>
<p>remote_addr 建立 tcp 连接的时候的 IP，反向代理时一定是 nginx 的 ip，无法伪造</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">        proxy_http_version 1.1;</span><br><span class="line">        proxy_set_header Connection &quot;&quot;;</span><br><span class="line">        proxy_set_header X-Forwarded-For $remote_addr;</span><br><span class="line">        proxy_pass http://httpds;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>如果存在多级代理，除了第一级代理以外直接转发即可，无需在设置 x-forwarded-for<br>
 或者在加一个 ip X-Forwarded-For: ip1,ip2</p>
<h2 id="concat-压缩请求个数"><a class="markdownIt-Anchor" href="#concat-压缩请求个数">#</a> concat 压缩请求个数</h2>
<p>concat 模块压缩请求数，减少并发请求个数</p>
<p>淘宝网即，?? 代表这是一个合并请求</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230327181444179.png" alt="image-20230327181444179"></p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cubmdpbnguY29tL25naW54LXdpa2kvYnVpbGQvZGlyaHRtbC9tb2R1bGVzL2NvbmNhdC8=">https://www.nginx.com/nginx-wiki/build/dirhtml/modules/concat/</span></p>
<p><code>./configure --prefix=/usr/local/nginx --add-module=/root/Downloads/nginx-http-concat/</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">location /static/css/ &#123;</span><br><span class="line">    concat on;</span><br><span class="line">    concat_max_files 20;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line">location /static/js/ &#123;</span><br><span class="line">    concat on;</span><br><span class="line">    concat_max_files 30;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;link href=&quot;??font.css,bg.css&quot; rel=&quot;stylesheet&quot;&gt;</span><br></pre></td></tr></table></figure>
<p>png 的可以一张图片包含多张图，在用切割展示不同的部分</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173546514.png" alt="image-20230328173546514"></p>
<p>其实就是把 css 文件拼接</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328173731682.png" alt="image-20230328173731682"></p>
<h2 id="根据ip判断用户位置"><a class="markdownIt-Anchor" href="#根据ip判断用户位置">#</a> 根据 IP 判断用户位置</h2>
<p>云厂商在 DNS 中有实现，也可以在 GEOIP 中自己实现</p>
<p>GEOIP 判断 IP 所属区域，实现 IP 阻断或限制</p>
<h4 id="1-下载数据库"><a class="markdownIt-Anchor" href="#1-下载数据库">#</a> 1 下载数据库</h4>
<p>官网需注册登录</p>
<p>下载数据库</p>
<p><span class="exturl" data-url="aHR0cDovL21heG1pbmQuY29t">maxmind.com</span></p>
<h4 id="2-安装依赖"><a class="markdownIt-Anchor" href="#2-安装依赖">#</a> 2 安装依赖</h4>
<h5 id="官方git"><a class="markdownIt-Anchor" href="#官方git">#</a> 官方 git</h5>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL21heG1pbmQvbGlibWF4bWluZGRi">https://github.com/maxmind/libmaxminddb</span></p>
<p>下载后执行编译安装之后</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ echo /usr/local/lib  &gt;&gt; /etc/ld.so.conf.d/local.conf </span><br><span class="line">$ ldconfig</span><br></pre></td></tr></table></figure>
<h4 id="nginx模块"><a class="markdownIt-Anchor" href="#nginx模块">#</a> Nginx 模块</h4>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2xlZXYvbmd4X2h0dHBfZ2VvaXAyX21vZHVsZQ==">https://github.com/leev/ngx_http_geoip2_module</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">geoip2 /root/GeoLite2-ASN_20220524/GeoLite2-ASN.mmdb &#123;</span><br><span class="line">	$geoip2_country_code country iso_code;</span><br><span class="line">&#125;</span><br><span class="line">location&#123;</span><br><span class="line">	add_header country $geoip2_country_code;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="健康检查"><a class="markdownIt-Anchor" href="#健康检查">#</a> 健康检查</h2>
<p>主动检查模式</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnL25naW54">Nginx</span> 服务端会按照设定的间隔时间主动向后端的 upstream_server 发出检查请求来验证后端的各个 upstream_server 的状态。 如果得到某个<span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==">服务器</span>失败的返回超过一定次数，比如 3 次就会标记该<span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==">服务器</span>为异常，就不会将请求转发至该<span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==">服务器</span>。</p>
<p>一般情况下后端<span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==">服务器</span>需要为这种健康检查专门提供一个低消耗的接口。</p>
<p>被动检查模式</p>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnL25naW54">Nginx</span> 在代理请求过程中会自动的监测每个后端<span class="exturl" data-url="aHR0cHM6Ly93d3cueGdzcy5uZXQvdGFnLyVFNiU5QyU4RCVFNSU4QSVBMSVFNSU5OSVBOA==">服务器</span>对请求的响应状态，如果某个后端<span class="exturl" data-url="aHR0cHM6Ly9jbG91ZC50ZW5jZW50LmNvbS9wcm9kdWN0L2N2bT9mcm9tPTIwMDY1JmFtcDtmcm9tX2NvbHVtbj0yMDA2NQ==">服务器</span>对请求的响应状态在短时间内累计一定失败次数时，Nginx 将会标记该服务器异常。就不会转发流量给该服务器。 不过每间隔一段时间 Nginx 还是会转发少量的一些请求给该后端服务器来探测它的返回状态。 以便识别该服务器是否恢复。</p>
<p>后端服务器不需要专门提供健康检查接口，不过这种方式会造成一些用户请求的响应失败，因为 Nginx 需要用一些少量的请求去试探后端的服务是否恢复正常。</p>
<p><strong>重试机制</strong></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">upstream</span> &#123;</span><br><span class="line">    <span class="attribute">server</span> ... max_fails=<span class="number">5</span> fail_timeout=<span class="number">10s</span>; <span class="comment"># 最大失败次数  </span></span><br><span class="line">    <span class="comment"># max_fails=5和fail_timeout=10s 表示在单位周期为10s钟内，中达到5次连接失败，那么接将把节点标记为不可用，并等待下一个周期（同样时常为fail_timeout）再一次去请求，判断是否连接是否成功。</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">location</span> &#123;</span><br><span class="line">    <span class="comment"># Nginx 默认判断失败节点状态以connect refuse和time out状态为准，不以HTTP错误状态进行判断失败，因为HTTP只要能返回状态说明该节点还可以正常连接，所以nginx判断其还是存活状态；</span></span><br><span class="line">    <span class="comment"># 除非添加了proxy_next_upstream指令设置对404、502、503、504、500和time out等错误进行转到备机处理，</span></span><br><span class="line">    <span class="attribute">proxy_next_upstream</span> <span class="literal">error</span> | timeout | invalid_header | http_500 | http_502 | http_503 | http_504 | http_403 | http_404 | http_429 | non_idempotent | <span class="literal">off</span> ...;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">proxy_next_upstream_timeout</span> time; <span class="comment"># 失败重试总时间</span></span><br><span class="line">    <span class="attribute">proxy_next_upstream_tries</span> number; <span class="comment"># 总时间内重试次数</span></span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>主动状态检查</strong></p>
<p>tengine 版</p>
<p><span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3lhb3dlaWJpbi9uZ2lueF91cHN0cmVhbV9jaGVja19tb2R1bGU=">https://github.com/yaoweibin/nginx_upstream_check_module</span></p>
<p>nginx 商业版</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfdXBzdHJlYW1faGNfbW9kdWxlLmh0bWw=">http://nginx.org/en/docs/http/ngx_http_upstream_hc_module.html</span></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">1.下载安装nginx 1.20.2</span><br><span class="line"></span><br><span class="line">2.vi /root/path</span><br><span class="line">内容为:https://github.com/yaoweibin/nginx_upstream_check_module/blob/master/check_1.20.1%2B.patch</span><br><span class="line"></span><br><span class="line">3.安装patch</span><br><span class="line"></span><br><span class="line">4.进入nginx文件夹</span><br><span class="line">[root@mail nginx-1.20.2]# patch -p1 &lt; /root/path </span><br><span class="line"></span><br><span class="line">./configure --prefix=/usr/local/nginx20 --add-module=/root/Downloads/nginx_upstream_check_module-0.4.0</span><br><span class="line">make </span><br><span class="line">make install </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"> <span class="section">upstream</span> backend &#123;</span><br><span class="line"></span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.44.102</span> weight=<span class="number">8</span> down;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.13.155:8080</span>;</span><br><span class="line">     <span class="attribute">server</span> <span class="number">192.168.13.166:8080</span>;</span><br><span class="line">     <span class="attribute">check</span> interval=<span class="number">3000</span> rise=<span class="number">2</span> fall=<span class="number">5</span> timeout=<span class="number">1000</span> type=http; <span class="comment">#每三秒检测一次，两次正常就up，五次失败就down，超时时间1000ms，使用http</span></span><br><span class="line">     <span class="attribute">check_http_send</span> <span class="string">&quot;HEAD / HTTP/1.0\r\n\r\n&quot;</span>;</span><br><span class="line">     <span class="attribute">check_http_expect_alive</span> http_2xx http_3xx;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="section">server</span> &#123;</span><br><span class="line">     <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">     <span class="attribute">server_name</span>  localhost;</span><br><span class="line">     </span><br><span class="line">     <span class="comment">#charset koi8-r;</span></span><br><span class="line">     </span><br><span class="line">     <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line">     </span><br><span class="line">     <span class="section">location</span> /status &#123;</span><br><span class="line">             check_status;</span><br><span class="line">             <span class="attribute">access_log</span> <span class="literal">off</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">     <span class="section">location</span> / &#123;</span><br><span class="line">             <span class="attribute">proxy_pass</span> http://backend;</span><br><span class="line">             <span class="attribute">root</span>   html;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><code>./nginx -c /usr/local/nginx20/conf/nginx.conf</code></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230403163536618.png" alt="image-20230403163536618"></p>
<h2 id="资源静态化"><a class="markdownIt-Anchor" href="#资源静态化">#</a> 资源静态化</h2>
<p>将原本需要计算的请求缓存成文件放在 nginx 里</p>
<p>并发最高的：列表，详情页</p>
<img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230328175858869.png" alt="image-20230328175858869" style="zoom: 67%;" /> 
<p>前端合并和后端合并</p>
<p>前端合并：节约服务器资源，消耗请求数</p>
<p>后端合并：ssi</p>
<h3 id="ssi"><a class="markdownIt-Anchor" href="#ssi">#</a> ssi</h3>
<p>通常称为服务器端嵌入，是一种类似于 ASP 的基于服务器的网页制作技术。</p>
<p>一个静态化的页面中，需要嵌入一小块实时变化的内容，。例如首页，大部分的页面内容需要缓存但是用户登录后的个人信息是动态信息，不能缓存。那么如何解决这个” 页面部分缓存” 问题，利用 SSI 就可以解决，在首页的静态页面中嵌入个人信息的动态页，由于是服务器端的嵌入，所以用户浏览的时候都是一个嵌入后的页面。</p>
<p><span class="exturl" data-url="aHR0cDovL25naW54Lm9yZy9lbi9kb2NzL2h0dHAvbmd4X2h0dHBfc3NpX21vZHVsZS5odG1s">http://nginx.org/en/docs/http/ngx_http_ssi_module.html</span></p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># http， server， location</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">ssi</span> <span class="literal">on</span></span><br><span class="line"></span><br><span class="line">开启ssi支持，默认是<span class="literal">off</span></span><br><span class="line"></span><br><span class="line">ssi_silent_errors <span class="literal">on</span></span><br><span class="line"></span><br><span class="line">默认值是<span class="literal">off</span>，开启后在处理SSI文件出错时不输出错误提示:”[an <span class="literal">error</span> occurred while processing the directive] ”</span><br><span class="line"></span><br><span class="line">ssi_types</span><br><span class="line"></span><br><span class="line">默认是ssi_types text/html，所以如果需要htm和html支持，则不需要设置这句，如果需要shtml支持，则需要设置：ssi_types text/shtml</span><br><span class="line"></span><br><span class="line">ssi_value_length</span><br><span class="line"></span><br><span class="line">限制脚本参数最大长度</span><br><span class="line"></span><br><span class="line">ssi_last_modified</span><br><span class="line"></span><br><span class="line">是否保留lastmodified</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">server &#123;  </span><br><span class="line">    <span class="attribute">ssi</span> <span class="literal">on</span>;  </span><br><span class="line">    <span class="attribute">ssi_silent_errors</span> <span class="literal">on</span>;  </span><br><span class="line">    <span class="attribute">ssi_types</span> text/shtml;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--#include file=&quot;header.html&quot;--&gt;</span><br><span class="line">&lt;h1&gt;我是index&lt;/h1&gt;</span><br><span class="line">&lt;!--#include virtual=&quot;footer.html&quot;--&gt;</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20230419112317707.png" alt="image-20230419112317707"></p>
<h3 id="rsync"><a class="markdownIt-Anchor" href="#rsync">#</a> rsync</h3>
<p><span class="exturl" data-url="aHR0cHM6Ly93d3cuc2FtYmEub3JnL2Z0cC9yc3luYy9yc3luYy5odG1s">https://www.samba.org/ftp/rsync/rsync.html</span></p>
<p>remote synchronize 是一个远程数据同步工具，可通过 LAN/WAN 快速同步多台主机之间的文件。也可以使用 rsync 同步本地硬盘中的不同目录。<br>
rsync 是用于替代 rcp 的一个工具，rsync 使用所谓的 rsync 算法 进行数据同步，这种算法只传送两个文件的不同部分，而不是每次都整份传送，因此速度相当快。</p>
<p>rsync 基于 inotify 开发</p>
<p>Rsync 有三种模式：</p>
<ul>
<li>本地模式（类似于 cp 命令）</li>
<li>远程模式（类似于 scp 命令）</li>
<li>守护进程（socket 进程：是 rsync 的重要功能）</li>
</ul>
<h4 id="安装-2"><a class="markdownIt-Anchor" href="#安装-2">#</a> 安装</h4>
<p>两端安装</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rsync</span><br></pre></td></tr></table></figure>
<h3 id=""><a class="markdownIt-Anchor" href="#">#</a> </h3>
<h4 id="密码文件"><a class="markdownIt-Anchor" href="#密码文件">#</a> 密码文件</h4>
<p>创建文件 <code>/etc/rsync.password</code></p>
<p>内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hello:123</span><br></pre></td></tr></table></figure>
<p>修改权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod 600 /etc/rsync.password</span><br></pre></td></tr></table></figure>
<p>修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">auth users = sgg</span><br><span class="line">secrets file = /etc/rsyncd.pwd</span><br></pre></td></tr></table></figure>
<h4 id="开机启动"><a class="markdownIt-Anchor" href="#开机启动">#</a> 开机启动</h4>
<p>在 <code>/etc/rc.local</code>  文件中添加</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync --daemon</span><br></pre></td></tr></table></figure>
<ul>
<li>修改权限</li>
</ul>
<p>echo “sgg:111” &gt;&gt; /etc/rsyncd.passwd</p>
<h4 id="查看远程目录"><a class="markdownIt-Anchor" href="#查看远程目录">#</a> 查看远程目录</h4>
<p>rsync --list-only 192.168.44.104::www/</p>
<h4 id="拉取数据到指定目录"><a class="markdownIt-Anchor" href="#拉取数据到指定目录">#</a> 拉取数据到指定目录</h4>
<p>rsync -avz rsync://192.168.44.104:873/www</p>
<p>rsync -avz 192.168.44.104::www/ /root/w</p>
<h5 id="使用ssh方式"><a class="markdownIt-Anchor" href="#使用ssh方式">#</a> 使用 SSH 方式</h5>
<p>rsync -avzP /usr/local/nginx/html/ <span class="exturl" data-url="bWFpbHRvOnJvb3RAMTkyLjE2OC40NC4xMDU=">root@192.168.44.105</span>:/www/</p>
<h4 id="推送"><a class="markdownIt-Anchor" href="#推送">#</a> 推送</h4>
<p>修改配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rsync -avz --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ rsync://sgg@192.168.44.105:/www</span><br></pre></td></tr></table></figure>
<p><code>--delete 删除目标目录比源目录多余文件</code></p>
<h4 id="实时推送"><a class="markdownIt-Anchor" href="#实时推送">#</a> 实时推送</h4>
<p>推送端安装 inotify</p>
<p>依赖</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y automake</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz</span><br><span class="line">./configure --prefix=/usr/local/inotify</span><br><span class="line">make &amp;&amp; make install</span><br></pre></td></tr></table></figure>
<p>监控目录</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%Y-%m-%d %H:%M:%S&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="简单自动化脚本"><a class="markdownIt-Anchor" href="#简单自动化脚本">#</a> 简单自动化脚本</h4>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">#</span><span class="language-bash">!/bin/bash</span></span><br><span class="line"></span><br><span class="line">/usr/local/inotify/bin/inotifywait -mrq --timefmt &#x27;%d/%m/%y %H:%M&#x27; --format &#x27;%T %w%f %e&#x27; -e close_write,modify,delete,create,attrib,move //usr/local/nginx/html/ | while read file</span><br><span class="line">do</span><br><span class="line">       </span><br><span class="line">        rsync -az --delete --password-file=/etc/rsyncd.passwd.client /usr/local/nginx/html/ sgg@192.168.44.102::ftp/</span><br><span class="line">done</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="nginx-php"><a class="markdownIt-Anchor" href="#nginx-php">#</a> nginx + php</h2>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment"># 这里新加的</span></span><br><span class="line">    <span class="comment"># PHP 脚本请求全部转发到 FastCGI处理. 使用FastCGI协议默认配置.</span></span><br><span class="line">    <span class="comment"># Fastcgi服务器和程序(PHP,Python)沟通的协议.</span></span><br><span class="line">    <span class="section">location</span> <span class="regexp">~ \.php$</span> &#123;</span><br><span class="line">        <span class="comment"># 设置监听端口</span></span><br><span class="line">        <span class="attribute">fastcgi_pass</span>   <span class="number">127.0.0.1:9000</span>;</span><br><span class="line">        <span class="comment"># 设置nginx的默认首页文件(上面已经设置过了，可以删除)</span></span><br><span class="line">        <span class="attribute">fastcgi_index</span>  index.php;</span><br><span class="line">        <span class="comment"># 设置脚本文件请求的路径</span></span><br><span class="line">        <span class="attribute">fastcgi_param</span>  SCRIPT_FILENAME  <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        <span class="comment"># 引入fastcgi的配置文件</span></span><br><span class="line">        <span class="attribute">include</span>        fastcgi_params;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>1、nginx 的 <code>worker进程</code> 直接管理每一个请求到 nginx 的网络请求。</p>
<p>2、php-fpm 程序也如同 nginx 一样，需要监听端口，并且有 master 和 worker 进程。worker 进程直接管理每一个 php 进程。</p>
<p>3、关于 fastcgi：fastcgi 是一种进程管理器，管理 cgi 进程。市面上有多种实现了 fastcgi 功能的进程管理器，php-fpm 就是其中的一种。再提一点，php-fpm 作为一种 fast-cgi 进程管理服务，会监听端口， <code>一般默认监听9000端口，并且是监听本机</code> ，也就是只接收来自本机的端口请求，所以我们通常输入命令 netstat -nlpt|grep php-fpm 会得到：</p>
<p>tcp 0 0 127.0.0.1:9000 0.0.0.0:* LISTEN 1057/php-fpm<br>
 这里的 127.0.0.1:9000 就是监听本机 9000 端口的意思。</p>
<p>4、关于 fastcgi 的配置文件，目前 fastcgi 的配置文件一般放在 nginx.conf 同级目录下，配置文件形式，一般有两种：fastcgi.conf 和 fastcgi_params。不同的 nginx 版本会有不同的配置文件，这两个配置文件有一个非常重要的区别：fastcgi_parames 文件中缺少下列配置：<br>
fastcgi_param SCRIPT_FILENAME fastcgi_script_name;<br>
 我们可以打开 fastcgi_parames 文件加上上述行，也可以在要使用配置的地方动态添加。使得该配置生效。</p>
<p>5、 <code>当需要处理php请求时，nginx的worker进程会将请求移交给php-fpm的worker进程进行处理，也就是最开头所说的nginx调用了php，其实严格得讲是nginx间接调用php</code></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC85NzIwODI1Mg==">Nginx 和 PHP 的配置 - 知乎 (zhihu.com)</span></p>
<p><span class="exturl" data-url="aHR0cHM6Ly96aHVhbmxhbi56aGlodS5jb20vcC8zNDY1NjAwMDI=">php 环境搭建（正确配置 nginx 和 php） - 知乎 (zhihu.com)</span></p>

      <div class="tags">
          <a href="/tags/%E8%BF%90%E7%BB%B4/" rel="tag"><i class="ic i-tag"></i> 运维</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-01-02 22:55:02" itemprop="dateModified" datetime="2024-01-02T22:55:02+08:00">2024-01-02</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2023/04/15/Nginx_new/" title="Nginx">http://example.com/2023/04/15/Nginx_new/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/04/07/TCPIP_new/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;84792bda8699365f11e183429da41a63.jpg" title="TCP&#x2F;IP">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>TCP/IP</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/05/20/Kubernetes/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;62d006663966c7ffbe93715d7d26acae.jpg" title="Kubernetes">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>Kubernetes</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#nginx"><span class="toc-number">1.</span> <span class="toc-text"> Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">1.1.</span> <span class="toc-text"> nginx 目录结构</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%90%AF%E5%81%9C"><span class="toc-number">1.2.</span> <span class="toc-text"> nginx 启停</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E5%B9%B3%E6%BB%91%E5%8D%87%E7%BA%A7"><span class="toc-number">1.3.</span> <span class="toc-text"> nginx 平滑升级</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginxconf"><span class="toc-number">1.4.</span> <span class="toc-text"> nginx.conf</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%A8%E5%B1%80%E5%9D%97"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 全局块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#events%E5%9D%97"><span class="toc-number">1.4.2.</span> <span class="toc-text"> events 块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#http-%E5%9D%97"><span class="toc-number">1.4.3.</span> <span class="toc-text"> http 块</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9A%E4%B9%89%E6%97%A5%E5%BF%97"><span class="toc-number">1.4.4.</span> <span class="toc-text"> 定义日志</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#server-location"><span class="toc-number">1.4.5.</span> <span class="toc-text"> server、location</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#exercise"><span class="toc-number">1.4.6.</span> <span class="toc-text"> exercise</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%85%8D%E7%BD%AEnginx%E4%B8%BA%E7%B3%BB%E7%BB%9F%E6%9C%8D%E5%8A%A1"><span class="toc-number">1.5.</span> <span class="toc-text"> 配置 nginx 为系统服务</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E9%85%8D%E7%BD%AE%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">1.6.</span> <span class="toc-text"> nginx 配置环境变量</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E8%99%9A%E6%8B%9F%E4%B8%BB%E6%9C%BA"><span class="toc-number">1.7.</span> <span class="toc-text"> nginx 虚拟主机</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E9%83%A8%E7%BD%B2"><span class="toc-number">1.8.</span> <span class="toc-text"> nginx 静态资源部署</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%9A%84%E9%85%8D%E7%BD%AE%E6%8C%87%E4%BB%A4"><span class="toc-number">1.8.1.</span> <span class="toc-text"> （1）静态资源的配置指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E4%BC%98%E5%8C%96"><span class="toc-number">1.8.2.</span> <span class="toc-text"> 静态资源优化</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E5%8E%8B%E7%BC%A9"><span class="toc-number">1.9.</span> <span class="toc-text"> nginx 静态资源压缩</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#brotil"><span class="toc-number">1.9.1.</span> <span class="toc-text"> brotil</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85"><span class="toc-number">1.9.1.1.</span> <span class="toc-text"> 安装</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9D%99%E6%80%81%E8%B5%84%E6%BA%90%E7%BC%93%E5%AD%98%E5%A4%84%E7%90%86"><span class="toc-number">1.10.</span> <span class="toc-text"> 静态资源缓存处理</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E8%A7%A3%E5%86%B3%E8%B7%A8%E5%9F%9F%E9%97%AE%E9%A2%98"><span class="toc-number">1.11.</span> <span class="toc-text"> nginx 解决跨域问题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE"><span class="toc-number">1.12.</span> <span class="toc-text"> 防盗链</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#rewrite"><span class="toc-number">1.13.</span> <span class="toc-text"> rewrite</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#if"><span class="toc-number">1.13.1.</span> <span class="toc-text"> if</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#break"><span class="toc-number">1.13.2.</span> <span class="toc-text"> break</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#return"><span class="toc-number">1.13.3.</span> <span class="toc-text"> return</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite-2"><span class="toc-number">1.13.4.</span> <span class="toc-text"> rewrite</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite_log"><span class="toc-number">1.13.5.</span> <span class="toc-text"> rewrite_log</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rewrite%E5%AE%9E%E7%8E%B0%E4%BC%AA%E9%9D%99%E6%80%81"><span class="toc-number">1.13.6.</span> <span class="toc-text"> rewrite 实现伪静态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E8%B7%B3%E8%BD%AC"><span class="toc-number">1.13.7.</span> <span class="toc-text"> 域名跳转</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%9F%E5%90%8D%E9%95%9C%E5%83%8F"><span class="toc-number">1.13.8.</span> <span class="toc-text"> 域名镜像</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E5%9F%9F%E5%90%8D"><span class="toc-number">1.13.9.</span> <span class="toc-text"> 独立域名</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%87%AA%E5%8A%A8%E5%8A%A0"><span class="toc-number">1.13.10.</span> <span class="toc-text"> 自动加 &#x2F;</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E5%BD%95%E5%90%88%E5%B9%B6"><span class="toc-number">1.13.11.</span> <span class="toc-text"> 目录合并</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%98%B2%E7%9B%97%E9%93%BE-2"><span class="toc-number">1.13.12.</span> <span class="toc-text"> 防盗链</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx%E4%BB%A3%E7%90%86"><span class="toc-number">1.14.</span> <span class="toc-text"> Nginx 代理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86"><span class="toc-number">1.14.1.</span> <span class="toc-text"> 反向代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#nginx%E5%AE%89%E5%85%A8%E6%8E%A7%E5%88%B6"><span class="toc-number">1.14.2.</span> <span class="toc-text"> nginx 安全控制</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8F%8D%E5%90%91%E4%BB%A3%E7%90%86%E7%B3%BB%E7%BB%9F%E4%BC%98%E5%8C%96"><span class="toc-number">1.14.3.</span> <span class="toc-text"> 反向代理系统优化</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%90%86https%E8%AF%B7%E6%B1%82"><span class="toc-number">1.14.3.1.</span> <span class="toc-text"> 代理 https 请求</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.15.</span> <span class="toc-text"> 负载均衡</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1-%E4%B8%83%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.15.1.</span> <span class="toc-text"> 四层负载均衡 &#x2F; 七层负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#stick-%E5%AE%9E%E7%8E%B0cookie-%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.15.2.</span> <span class="toc-text"> stick 实现 cookie 负载均衡</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E5%B1%82%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="toc-number">1.15.3.</span> <span class="toc-text"> 四层负载均衡</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.</span> <span class="toc-text"> 缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.1.</span> <span class="toc-text"> 浏览器缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E5%8F%AF%E4%BB%A5%E7%94%A8%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.1.1.</span> <span class="toc-text"> 什么时候可以用缓存？</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#age"><span class="toc-number">1.16.0.1.2.</span> <span class="toc-text"> Age</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#via"><span class="toc-number">1.16.0.1.3.</span> <span class="toc-text"> via</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98%E4%B8%8E%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.2.</span> <span class="toc-text"> 强制缓存与协商缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.3.</span> <span class="toc-text"> 浏览器强制缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#cache-control"><span class="toc-number">1.16.0.3.1.</span> <span class="toc-text"> cache-control</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#expires"><span class="toc-number">1.16.0.3.2.</span> <span class="toc-text"> Expires</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.4.</span> <span class="toc-text"> 协商缓存</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#last-modified"><span class="toc-number">1.16.0.4.1.</span> <span class="toc-text"> last-modified</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#etag"><span class="toc-number">1.16.0.4.2.</span> <span class="toc-text"> etag</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cache-control-expires-%E5%BC%BA%E5%88%B6%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.5.</span> <span class="toc-text"> cache-control expires 强制缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#etag-lastmodify-%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.0.6.</span> <span class="toc-text"> etag lastmodify  协商缓存</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%8F%E8%A7%88%E5%99%A8%E7%BC%93%E5%AD%98%E5%8E%9F%E5%88%99"><span class="toc-number">1.16.0.7.</span> <span class="toc-text"> 浏览器缓存原则</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%88%A0%E9%99%A4%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.1.</span> <span class="toc-text"> 删除缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%BE%E7%BD%AE%E8%B5%84%E6%BA%90%E4%B8%8D%E7%BC%93%E5%AD%98"><span class="toc-number">1.16.2.</span> <span class="toc-text"> 设置资源不缓存</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8A%A8%E9%9D%99%E5%88%86%E7%A6%BB"><span class="toc-number">1.17.</span> <span class="toc-text"> 动静分离</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalived"><span class="toc-number">1.18.</span> <span class="toc-text"> keepalived</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%88%B6%E4%BD%9C%E4%B8%8B%E8%BD%BD%E7%AB%99%E7%82%B9"><span class="toc-number">1.19.</span> <span class="toc-text"> 制作下载站点</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E8%AE%A4%E8%AF%81%E6%A8%A1%E5%9D%97"><span class="toc-number">1.20.</span> <span class="toc-text"> 用户认证模块</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#keepalive"><span class="toc-number">1.21.</span> <span class="toc-text"> keepalive</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%BD%BF%E7%94%A8"><span class="toc-number">1.21.0.1.</span> <span class="toc-text"> 什么时候使用？</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%80%E4%B9%88%E6%97%B6%E5%80%99%E4%B8%8D%E7%94%A8"><span class="toc-number">1.21.0.2.</span> <span class="toc-text"> 什么时候不用？</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%B9%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%99%90%E5%88%B6"><span class="toc-number">1.21.1.</span> <span class="toc-text"> 对客户端限制</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%8E%B7%E5%8F%96%E5%AE%A2%E6%88%B7%E7%AB%AFip"><span class="toc-number">1.22.</span> <span class="toc-text"> 获取客户端 IP</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#concat-%E5%8E%8B%E7%BC%A9%E8%AF%B7%E6%B1%82%E4%B8%AA%E6%95%B0"><span class="toc-number">1.23.</span> <span class="toc-text"> concat 压缩请求个数</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%B9%E6%8D%AEip%E5%88%A4%E6%96%AD%E7%94%A8%E6%88%B7%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.24.</span> <span class="toc-text"> 根据 IP 判断用户位置</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E6%95%B0%E6%8D%AE%E5%BA%93"><span class="toc-number">1.24.0.1.</span> <span class="toc-text"> 1 下载数据库</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%AE%89%E8%A3%85%E4%BE%9D%E8%B5%96"><span class="toc-number">1.24.0.2.</span> <span class="toc-text"> 2 安装依赖</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%AE%98%E6%96%B9git"><span class="toc-number">1.24.0.2.1.</span> <span class="toc-text"> 官方 git</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#nginx%E6%A8%A1%E5%9D%97"><span class="toc-number">1.24.0.3.</span> <span class="toc-text"> Nginx 模块</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">1.25.</span> <span class="toc-text"> 健康检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B5%84%E6%BA%90%E9%9D%99%E6%80%81%E5%8C%96"><span class="toc-number">1.26.</span> <span class="toc-text"> 资源静态化</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#ssi"><span class="toc-number">1.26.1.</span> <span class="toc-text"> ssi</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#rsync"><span class="toc-number">1.26.2.</span> <span class="toc-text"> rsync</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-2"><span class="toc-number">1.26.2.1.</span> <span class="toc-text"> 安装</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link"><span class="toc-number">1.26.3.</span> <span class="toc-text"> </span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AF%86%E7%A0%81%E6%96%87%E4%BB%B6"><span class="toc-number">1.26.3.1.</span> <span class="toc-text"> 密码文件</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BC%80%E6%9C%BA%E5%90%AF%E5%8A%A8"><span class="toc-number">1.26.3.2.</span> <span class="toc-text"> 开机启动</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9F%A5%E7%9C%8B%E8%BF%9C%E7%A8%8B%E7%9B%AE%E5%BD%95"><span class="toc-number">1.26.3.3.</span> <span class="toc-text"> 查看远程目录</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8B%89%E5%8F%96%E6%95%B0%E6%8D%AE%E5%88%B0%E6%8C%87%E5%AE%9A%E7%9B%AE%E5%BD%95"><span class="toc-number">1.26.3.4.</span> <span class="toc-text"> 拉取数据到指定目录</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8ssh%E6%96%B9%E5%BC%8F"><span class="toc-number">1.26.3.4.1.</span> <span class="toc-text"> 使用 SSH 方式</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%8E%A8%E9%80%81"><span class="toc-number">1.26.3.5.</span> <span class="toc-text"> 推送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%9E%E6%97%B6%E6%8E%A8%E9%80%81"><span class="toc-number">1.26.3.6.</span> <span class="toc-text"> 实时推送</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%87%AA%E5%8A%A8%E5%8C%96%E8%84%9A%E6%9C%AC"><span class="toc-number">1.26.3.7.</span> <span class="toc-text"> 简单自动化脚本</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#nginx-php"><span class="toc-number">1.27.</span> <span class="toc-text"> nginx + php</span></a></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2022/11/27/CDN/" rel="bookmark" title="CDN&DNS">CDN&DNS</a></li><li><a href="/2023/04/03/iptables2/" rel="bookmark" title="iptables">iptables</a></li><li><a href="/2023/04/05/Docker/" rel="bookmark" title="docker">docker</a></li><li class="active"><a href="/2023/04/15/Nginx_new/" rel="bookmark" title="Nginx">Nginx</a></li><li><a href="/2023/05/20/Kubernetes/" rel="bookmark" title="Kubernetes">Kubernetes</a></li><li><a href="/2023/05/30/jenkins/" rel="bookmark" title="Jenkins">Jenkins</a></li><li><a href="/2023/06/02/k8s%E9%AB%98%E7%BA%A7/" rel="bookmark" title="k8s高级">k8s高级</a></li><li><a href="/2024/01/01/istio/" rel="bookmark" title="istio">istio</a></li><li><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" rel="bookmark" title="集群与存储">集群与存储</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">42</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">6</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">6</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/04/07/TCPIP_new/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/05/20/Kubernetes/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/03/27/http/" title="http">http</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/03/16/SQL%E6%B3%A8%E5%85%A5/" title="SQL injection">SQL injection</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/09/15/%E7%BC%93%E5%AD%98%E6%B1%A1%E6%9F%93/" title="缓存污染&#x2F;请求走私">缓存污染/请求走私</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/02/21/https%E5%8E%9F%E7%90%86/" title="https+TLS">https+TLS</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/10/%E9%9B%86%E7%BE%A4%E4%B8%8E%E5%AD%98%E5%82%A8/" title="集群与存储">集群与存储</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%86%85%E7%BD%91/" title="In 内网">内网</a>
</div>

    <span><a href="/2022/12/25/%E5%86%85%E7%BD%91/" title="内网渗透">内网渗透</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/04/07/TCPIP_new/" title="TCP&#x2F;IP">TCP/IP</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/05/30/jenkins/" title="Jenkins">Jenkins</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/05/Docker/" title="docker">docker</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2024</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/04/15/Nginx_new/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
