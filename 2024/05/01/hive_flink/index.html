



<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="Hexo" href="http://example.com/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="Hexo" href="http://example.com/atom.xml" />
<link rel="alternate" type="application/json" title="Hexo" href="http://example.com/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  
  <meta name="keywords" content="大数据" />


<link rel="canonical" href="http://example.com/2024/05/01/hive_flink/">



  <title>
hive_flink - 大数据 |
Yume Shoka = Hexo</title>
<meta name="generator" content="Hexo 5.4.2"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">hive_flink
  </h1>
  
<div class="meta">
  <span class="item" title="Created: 2024-05-01 13:38:45">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">Posted on</span>
    <time itemprop="dateCreated datePublished" datetime="2024-05-01T13:38:45+08:00">2024-05-01</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="Toggle navigation bar">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">Yume Shoka</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
        <ul>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/ab0127aa2427fa655db33a097d7e215e.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/67487d98c148b67bef002f2fa291f18a.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/c97ba7c95fea6f32b4bfb028c8898607.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/3f20154a69ec2ac89963a3c94445fdd7.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/38f4d53604cb5ca98a47fea8d62cde72.jpg"></li>
          <li class="item" data-background-image="https://img.timelessq.com/images/2022/07/26/2a42af8906eaa0a898ee31569cbd2661.jpg"></li>
        </ul>
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">Home</a></span><i class="ic i-angle-right"></i>
<span  class="current" itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem"><a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" itemprop="item" rel="index" title="In 大数据"><span itemprop="name">大数据</span></a>
<meta itemprop="position" content="1" /></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="en">
  <link itemprop="mainEntityOfPage" href="http://example.com/2024/05/01/hive_flink/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="John Doe">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Hexo">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h2 id="hive"><a class="markdownIt-Anchor" href="#hive">#</a> hive</h2>
<p>Hive 是由 Facebook 开源，基于 Hadoop 的一个数据仓库工具，可以将结构化的数据文件映射为一张表，并提供类 SQL 查询功能。</p>
<p>Hive 是一个 Hadoop 客户端，用于将 HQL (HiveSQL) 转化成 MapfReduce 程序。</p>
<p>(1) Hive 中每张表的数据存储在 HDFS</p>
<p>(2) Hive 分析数据底层的实现是 MapReduce (也可配置为 Sparl 或者 Tez)</p>
<p>(3) 执行程序运行在 Yarn 上</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224128675.png" alt="image-20240804224128675"></p>
<h3 id="最小化安装"><a class="markdownIt-Anchor" href="#最小化安装">#</a> 最小化安装</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">wget http:<span class="comment">//apache.mirror.iweb.ca/hive/hive-3.1.3/apache-hive-3.1.3-bin.tar.gz</span></span><br><span class="line">tar xzvf apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin.tar.gz</span><br><span class="line">cd apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin/</span><br><span class="line"></span><br><span class="line">#!/bin/bash</span><br><span class="line">export HIVE_HOME=/root/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin</span><br><span class="line">export PATH=$PATH:$HIVE_HOME/bin</span><br><span class="line"></span><br><span class="line">./schematool -dbType derby -initSchema</span><br><span class="line"></span><br><span class="line">hive </span><br><span class="line">&gt; show databases;</span><br></pre></td></tr></table></figure>
<p>路径同一时刻，只能允许一个 derby 客户端使用</p>
<p><span class="exturl" data-url="aHR0cDovL2FwYWNoZS5taXJyb3IuaXdlYi5jYS9oaXZlL2hpdmUtMy4xLjMv">http://apache.mirror.iweb.ca/hive/hive-3.1.3/</span></p>
<h3 id="mysql-hive"><a class="markdownIt-Anchor" href="#mysql-hive">#</a> mysql-hive</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br></pre></td><td class="code"><pre><span class="line"># 卸载mariadb</span><br><span class="line"></span><br><span class="line"># 安装mysql</span><br><span class="line">apt install mysql-server</span><br><span class="line">systemctl enable mysql --now</span><br><span class="line">sudo mysql_secure_installation</span><br><span class="line">ALTER USER <span class="string">&#x27;root&#x27;</span>@<span class="string">&#x27;localhost&#x27;</span> IDENTIFIED BY <span class="string">&#x27;123456&#x27;</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># hive存储元数据到mysql</span><br><span class="line">create database metastore;</span><br><span class="line"></span><br><span class="line"># 修改配置文件 hive-site.xml</span><br><span class="line"> &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionURL&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;jdbc:mysql:<span class="comment">//hadoop100:3306/metastore?useSSL=false&lt;/value&gt;</span></span><br><span class="line">    &lt;description&gt;</span><br><span class="line">      JDBC connect string <span class="keyword">for</span> a JDBC metastore.</span><br><span class="line">      To use SSL to encrypt/authenticate the connection, provide database-specific SSL flag in the connection URL.</span><br><span class="line">      For example, jdbc:postgresql:<span class="comment">//myhost/db?ssl=true for postgres database.</span></span><br><span class="line">    &lt;/description&gt;</span><br><span class="line">  &lt;/property&gt; </span><br><span class="line">  </span><br><span class="line">    &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionUserName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;root&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;Username to use against metastore database&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">  </span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionPassword&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="number">123456</span>&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;password to use against metastore database&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">    &lt;name&gt;javax.jdo.option.ConnectionDriverName&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;com.mysql.jdbc.Driver&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;Driver <span class="keyword">class</span> <span class="title class_">name</span> <span class="keyword">for</span> a JDBC metastore&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">    &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.metastore.warehouse.dir&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;/user/hive/warehouse&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;location of <span class="keyword">default</span> database <span class="keyword">for</span> the warehouse&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding in [jar:file:/root/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin/lib/log4j-slf4j-impl-<span class="number">2.17</span><span class="number">.1</span>.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding in [jar:file:/root/hadoop-<span class="number">3.3</span><span class="number">.6</span>/share/hadoop/common/lib/slf4j-reload4j-<span class="number">1.7</span><span class="number">.36</span>.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#multiple_bindings for an explanation.</span></span><br><span class="line">SLF4J: Actual binding is of type [org.apache.logging.slf4j.Log4jLoggerFactory]</span><br><span class="line">Metastore connection URL:        jdbc:mysql:<span class="comment">//hadoop100:3306/metastore?useSSL=false</span></span><br><span class="line">Metastore Connection Driver :    com.mysql.cj.jdbc.Driver</span><br><span class="line">Metastore connection User:       root</span><br><span class="line">org.apache.hadoop.hive.metastore.HiveMetaException: Failed to get schema version.</span><br><span class="line">Underlying cause: com.mysql.cj.jdbc.exceptions.CommunicationsException : Communications link failure</span><br><span class="line"></span><br><span class="line">The last packet sent successfully to the server was <span class="number">0</span> milliseconds ago. The driver has not received any packets from the server.</span><br><span class="line">SQL Error code: <span class="number">0</span></span><br><span class="line">org.apache.hadoop.hive.metastore.HiveMetaException: Failed to get schema version.</span><br><span class="line">        at org.apache.hadoop.hive.metastore.tools.HiveSchemaHelper.getConnectionToMetastore(HiveSchemaHelper.java:<span class="number">94</span>)</span><br><span class="line">        at org.apache.hive.beeline.HiveSchemaTool.getConnectionToMetastore(HiveSchemaTool.java:<span class="number">169</span>)</span><br><span class="line">        at org.apache.hive.beeline.HiveSchemaTool.testConnectionToMetastore(HiveSchemaTool.java:<span class="number">475</span>)</span><br><span class="line">        at org.apache.hive.beeline.HiveSchemaTool.doInit(HiveSchemaTool.java:<span class="number">581</span>)</span><br><span class="line">        at org.apache.hive.beeline.HiveSchemaTool.doInit(HiveSchemaTool.java:<span class="number">567</span>)</span><br><span class="line">        at org.apache.hive.beeline.HiveSchemaTool.main(HiveSchemaTool.java:<span class="number">1517</span>)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">        at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">        at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">        at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">        at org.apache.hadoop.util.RunJar.run(RunJar.java:<span class="number">328</span>)</span><br><span class="line">        at org.apache.hadoop.util.RunJar.main(RunJar.java:<span class="number">241</span>)</span><br><span class="line">Caused by: com.mysql.cj.jdbc.exceptions.CommunicationsException: Communications link failure</span><br><span class="line"></span><br><span class="line">The last packet sent successfully to the server was <span class="number">0</span> milliseconds ago. The driver has not received any packets from the server.</span><br><span class="line">        at com.mysql.cj.jdbc.exceptions.SQLError.createCommunicationsException(SQLError.java:<span class="number">175</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.exceptions.SQLExceptionsMapping.translateException(SQLExceptionsMapping.java:<span class="number">64</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:<span class="number">825</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:<span class="number">446</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:<span class="number">239</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:<span class="number">188</span>)</span><br><span class="line">        at java.sql.DriverManager.getConnection(DriverManager.java:<span class="number">664</span>)</span><br><span class="line">        at java.sql.DriverManager.getConnection(DriverManager.java:<span class="number">247</span>)</span><br><span class="line">        at org.apache.hadoop.hive.metastore.tools.HiveSchemaHelper.getConnectionToMetastore(HiveSchemaHelper.java:<span class="number">88</span>)</span><br><span class="line">        ... <span class="number">11</span> more</span><br><span class="line">Caused by: com.mysql.cj.exceptions.CJCommunicationsException: Communications link failure</span><br><span class="line"></span><br><span class="line">The last packet sent successfully to the server was <span class="number">0</span> milliseconds ago. The driver has not received any packets from the server.</span><br><span class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance0(Native Method)</span><br><span class="line">        at sun.reflect.NativeConstructorAccessorImpl.newInstance(NativeConstructorAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">        at sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:<span class="number">45</span>)</span><br><span class="line">        at java.lang.reflect.Constructor.newInstance(Constructor.java:<span class="number">423</span>)</span><br><span class="line">        at com.mysql.cj.exceptions.ExceptionFactory.createException(ExceptionFactory.java:<span class="number">62</span>)</span><br><span class="line">        at com.mysql.cj.exceptions.ExceptionFactory.createException(ExceptionFactory.java:<span class="number">105</span>)</span><br><span class="line">        at com.mysql.cj.exceptions.ExceptionFactory.createException(ExceptionFactory.java:<span class="number">150</span>)</span><br><span class="line">        at com.mysql.cj.exceptions.ExceptionFactory.createCommunicationsException(ExceptionFactory.java:<span class="number">166</span>)</span><br><span class="line">        at com.mysql.cj.protocol.a.NativeSocketConnection.connect(NativeSocketConnection.java:<span class="number">89</span>)</span><br><span class="line">        at com.mysql.cj.NativeSession.connect(NativeSession.java:<span class="number">121</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:<span class="number">945</span>)</span><br><span class="line">        at com.mysql.cj.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:<span class="number">815</span>)</span><br><span class="line">        ... <span class="number">17</span> more</span><br><span class="line">Caused by: java.net.ConnectException: Connection <span class="title function_">refused</span> <span class="params">(Connection refused)</span></span><br><span class="line">        at java.net.PlainSocketImpl.socketConnect(Native Method)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:<span class="number">350</span>)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:<span class="number">206</span>)</span><br><span class="line">        at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:<span class="number">188</span>)</span><br><span class="line">        at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:<span class="number">392</span>)</span><br><span class="line">        at java.net.Socket.connect(Socket.java:<span class="number">607</span>)</span><br><span class="line">        at com.mysql.cj.protocol.StandardSocketFactory.connect(StandardSocketFactory.java:<span class="number">153</span>)</span><br><span class="line">        at com.mysql.cj.protocol.a.NativeSocketConnection.connect(NativeSocketConnection.java:<span class="number">63</span>)</span><br><span class="line">        ... <span class="number">20</span> more</span><br><span class="line">*** schemaTool failed ***</span><br><span class="line">如果报错，注意，当前用户不是localhost</span><br><span class="line">mysql&gt; use mysql;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off <span class="built_in">this</span> feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">mysql&gt; select host,user from user where user=<span class="string">&#x27;root&#x27;</span>;</span><br><span class="line">+-----------+------+</span><br><span class="line">| host      | user |</span><br><span class="line">+-----------+------+</span><br><span class="line">| localhost | root |</span><br><span class="line">+-----------+------+</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置文件中不是<span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span></span><br><span class="line">通常情况下，这个配置文件位于/etc/mysql/mysql.conf.d/mysqld.cnf，找到bind-address这一项并将其更改为<span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span>。然后重启mysql服务：sudo systemctl restart mysql。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置文件中账号密码正确</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">已经下载mysql连接java驱动，并且复制到hive/lib下面</span><br><span class="line">https:<span class="comment">//downloads.mysql.com/archives/c-j/</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Relative path in absolute URI: $&#123;system:java.io.tmpdir%<span class="number">7D</span>/$%7Bsystem:user.name%<span class="number">7D</span></span><br><span class="line">https:<span class="comment">//www.cnblogs.com/qxyy/articles/5247933.html</span></span><br><span class="line">把上面文章中所有 $HIVE_HOME/iotmp 改为绝对路径，比如 /root/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin/iotmp</span><br><span class="line">验证：</span><br><span class="line">hive</span><br><span class="line">show databases；</span><br></pre></td></tr></table></figure>
<h3 id="hiveserver2"><a class="markdownIt-Anchor" href="#hiveserver2">#</a> hiveserver2</h3>
<p>Hive 的 hiveserver2 服务的作用是提供 jdbc/odbc 接口，为用户提供远程访问 Hive 数据的功能，例如用户期望在个人电脑中访问远程服务中的 Hive 数据，就需要用到 Hiveserver2</p>
<h4 id="用户模拟功能"><a class="markdownIt-Anchor" href="#用户模拟功能">#</a> 用户模拟功能</h4>
<p>在远程访问 Hive 数据时，客户端并未直接访问 Hadoop 集群，而是由 Hivesever2 代理访问。由于 Hadoop 集群中的数据具备访问权限控制，所以此时需考虑一个问题：那就是访问 Hadoop 集群的用户身份是谁？是 Hiveserver2 的启动用户？还是客户端的登录用户？</p>
<p>答案是都有可能，具体是谁，由 Hiveserver2 的 hive.server2.enable.doAs 参数决定，该参数的含义是是否启用 Hiveserver2 用户模拟的功能。若启用，则 Hiveserver2 会模拟成客户端的登录用户去访问 Hadoop 集群的数据，不启用，则 Hivesever2 会直接使用启动用户访问 Hadoop 集群数据。模拟用户的功能，默认是开启的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">vim core-site.yaml</span><br><span class="line">&lt;!--配置所有节点的atguigu用户都可作为代理用户--&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.proxyuser.root.hosts&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--配置atguigu用户能够代理的用户组为任意组--&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.proxyuser.root.groups&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">&lt;!--配置atguigu用户能够代理的用户为任意用户--&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;hadoop.proxyuser.root.users&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;*&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">scp core-site.xml root@<span class="number">192.168</span><span class="number">.13</span><span class="number">.191</span>:/root/hadoop-<span class="number">3.3</span><span class="number">.6</span>/etc/hadoop</span><br><span class="line">scp core-site.xml root@<span class="number">192.168</span><span class="number">.13</span><span class="number">.192</span>:/root/hadoop-<span class="number">3.3</span><span class="number">.6</span>/etc/hadoop</span><br><span class="line">hadoop-start.sh</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim hive-site.yaml</span><br><span class="line"> </span><br><span class="line">&lt;!-- 指定hiveserver2连接的host --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">   &lt;name&gt;hive.server2.thrift.bind.host&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;hadoop100&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"> </span><br><span class="line">&lt;!-- 指定hiveserver2连接的端口号 --&gt;</span><br><span class="line">&lt;property&gt;</span><br><span class="line">   &lt;name&gt;hive.server2.thrift.port&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;<span class="number">10000</span>&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br><span class="line"></span><br><span class="line">bin/hiveserver2</span><br><span class="line">root<span class="meta">@hadoop100</span>:~/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin# nohup hiveserver2 &gt;/dev/<span class="literal">null</span> <span class="number">2</span>&gt;&amp;<span class="number">1</span>  &amp; </span><br><span class="line">[<span class="number">1</span>] <span class="number">124804</span></span><br><span class="line"></span><br><span class="line">root<span class="meta">@hadoop100</span>:~/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin# jps</span><br><span class="line"><span class="number">123633</span> NameNode</span><br><span class="line"><span class="number">124131</span> NodeManager</span><br><span class="line"><span class="number">124804</span> RunJar</span><br></pre></td></tr></table></figure>
<p>测试</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root<span class="meta">@hadoop100</span>:~/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin# beeline </span><br><span class="line">SLF4J: Class path contains multiple SLF4J bindings.</span><br><span class="line">SLF4J: Found binding in [jar:file:/root/apache-hive-<span class="number">3.1</span><span class="number">.3</span>-bin/lib/log4j-slf4j-impl-<span class="number">2.17</span><span class="number">.1</span>.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: Found binding in [jar:file:/root/hadoop-<span class="number">3.3</span><span class="number">.6</span>/share/hadoop/common/lib/slf4j-reload4j-<span class="number">1.7</span><span class="number">.36</span>.jar!/org/slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line">SLF4J: See http:<span class="comment">//www.slf4j.org/codes.html#multiple_bindings for an explanation.</span></span><br><span class="line">SLF4J: Actual binding is of type [org.apache.logging.slf4j.Log4jLoggerFactory]</span><br><span class="line">Beeline version <span class="number">3.1</span><span class="number">.3</span> by Apache Hive</span><br><span class="line">beeline&gt; !connect jdbc:hive2:<span class="comment">//hadoop100:10000</span></span><br><span class="line">Connecting to jdbc:hive2:<span class="comment">//hadoop100:10000</span></span><br><span class="line">Enter username <span class="keyword">for</span> jdbc:hive2:<span class="comment">//hadoop100:10000: root</span></span><br><span class="line">Enter password <span class="keyword">for</span> jdbc:hive2:<span class="comment">//hadoop100:10000: </span></span><br><span class="line">Connected to: Apache <span class="title function_">Hive</span> <span class="params">(version <span class="number">3.1</span><span class="number">.3</span>)</span></span><br><span class="line">Driver: Hive <span class="title function_">JDBC</span> <span class="params">(version <span class="number">3.1</span><span class="number">.3</span>)</span></span><br><span class="line">Transaction isolation: TRANSACTION_REPEATABLE_READ</span><br><span class="line"><span class="number">0</span>: jdbc:hive2:<span class="comment">//hadoop100:10000&gt; </span></span><br></pre></td></tr></table></figure>
<p>使用 datagrip 连接</p>
<h3 id="metastore"><a class="markdownIt-Anchor" href="#metastore">#</a> metastore</h3>
<p>Hive 的 metastore 服务的作用是为 Hive CLI 或者 Hiveserver2 提供元数据访问接口。</p>
<p><strong>metastore 运行模式</strong></p>
<p>metastore 有两种运行模式，分别为嵌入式模式和独立服务模式。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224157870.png" alt="image-20240804224157870"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224212449.png" alt="image-20240804224212449"></p>
<p>生产环境中，不推荐使用嵌入式模式。因为其存在以下两个问题：</p>
<p>（1）嵌入式模式下，每个 Hive CLI 都需要直接连接元数据库，当 Hive CLI 较多时，数据库压力会比较大。</p>
<p>（2）每个客户端都需要用户元数据库的读写权限，元数据库的安全得不到很好的保证。</p>
<h4 id="独立模式部署"><a class="markdownIt-Anchor" href="#独立模式部署">#</a> 独立模式部署</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">Hadoop100</span><br><span class="line">nohup hive --service metastore &amp;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hadoop101</span><br><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.metastore.uris&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;thrift:<span class="comment">//hadoop100:9083 &lt;/value&gt;</span></span><br><span class="line">    &lt;description/&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line"></span><br><span class="line">需要删除jdbc相关参数</span><br><span class="line">hive -e <span class="string">&quot;insert into stu values(2,&#x27;aaa&#x27;)&quot;</span></span><br><span class="line"></span><br><span class="line">hive -f stu.sql</span><br><span class="line"></span><br><span class="line">hive -hiveconf mapreduce.job.x=<span class="number">10</span>;</span><br><span class="line"></span><br><span class="line">hive&gt; set mapreduce.x.x=<span class="number">10</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">hive&gt; set mapreduce.x.x </span><br></pre></td></tr></table></figure>
<p>配置文件 &lt; 命令行参数 &lt; 参数声明。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">  &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.cli.print.header&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;Whether to print the names of the columns in query output.&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  </span><br><span class="line">    &lt;property&gt;</span><br><span class="line">    &lt;name&gt;hive.cli.print.current.db&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="literal">true</span>&lt;/value&gt;</span><br><span class="line">    &lt;description&gt;Whether to include the current database in the Hive prompt.&lt;/description&gt;</span><br><span class="line">  &lt;/property&gt;</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">修改日志路径</span><br><span class="line"></span><br><span class="line">vim hive-log4j2.properties</span><br><span class="line"># list of properties</span><br><span class="line">property.hive.log.level = INFO</span><br><span class="line">property.hive.root.logger = DRFA</span><br><span class="line">property.hive.log.dir = $&#123;sys:java.io.tmpdir&#125;/$&#123;sys:user.name&#125;</span><br><span class="line">property.hive.log.file = hive.log</span><br><span class="line">property.hive.perflogger.log.level = INFO</span><br><span class="line"># 调整堆内存</span><br><span class="line"></span><br><span class="line">vim hive-env.sh</span><br><span class="line">export HADOOP_HEAPSIZE=<span class="number">2048</span></span><br><span class="line">在yarn-site.xml中关闭虚拟内存检查(虚拟内存校验</span><br><span class="line"></span><br><span class="line">yarn-nodemanager.vmem-check-enabled </span><br><span class="line"><span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h3 id="ddl"><a class="markdownIt-Anchor" href="#ddl">#</a> DDL</h3>
<h4 id="库操作"><a class="markdownIt-Anchor" href="#库操作">#</a> 库操作</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">### databases</span><br><span class="line">（<span class="number">1</span>）创建一个数据库，不指定路径</span><br><span class="line">hive (<span class="keyword">default</span>)&gt; create database db_hive1;</span><br><span class="line">注：若不指定路径，其默认路径为$&#123;hive.metastore.warehouse.dir&#125;/database_name.db</span><br><span class="line">（<span class="number">2</span>）创建一个数据库，指定路径</span><br><span class="line">hive (<span class="keyword">default</span>)&gt; create database db_hive2 location <span class="string">&#x27;/db_hive2&#x27;</span>;</span><br><span class="line">（<span class="number">2</span>）创建一个数据库，带有dbproperties</span><br><span class="line"><span class="title function_">hive</span> <span class="params">(<span class="keyword">default</span>)</span>&gt; create database db_hive3 with <span class="title function_">dbproperties</span><span class="params">(<span class="string">&#x27;create_date&#x27;</span>=<span class="string">&#x27;2022-11-18&#x27;</span>)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show databases like <span class="string">&#x27;db_hive*&#x27;</span>;</span><br><span class="line"></span><br><span class="line">desc database db_hive3;</span><br><span class="line">desc database extended db_hive3;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改数据库location，不会改变当前已有表的路径信息，而只是改变后续创建的新表的默认的父目录。</span><br><span class="line">ALTER DATABASE db_hive3 SET <span class="title function_">DBPROPERTIES</span> <span class="params">(<span class="string">&#x27;create_date&#x27;</span>=<span class="string">&#x27;2022-11-20&#x27;</span>)</span>;</span><br><span class="line"></span><br><span class="line">DROP DATABASE [IF EXISTS] database_name [RESTRICT|CASCADE];</span><br><span class="line">注：RESTRICT：严格模式，若数据库不为空，则会删除失败，默认为该模式。</span><br><span class="line">    CASCADE：级联模式，若数据库不为空，则会将库中的表一并删除。</span><br><span class="line">    </span><br><span class="line">use db1;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### tables</span><br></pre></td></tr></table></figure>
<h4 id="建表"><a class="markdownIt-Anchor" href="#建表">#</a> 建表</h4>
<p><strong>1TEMPORARY</strong></p>
<p>临时表，该表只在当前会话可见，会话结束，表会被删除。</p>
<p><strong>2EXTERNAL（重点）</strong></p>
<p>外部表，与之相对应的是内部表（管理表）。管理表意味着 Hive 会完全接管该表，包括元数据和 HDFS 中的数据。而外部表则意味着 Hive 只接管元数据，而不完全接管 HDFS 中的数据。</p>
<p><strong>3data_type（重点）</strong></p>
<p>Hive 中的字段类型可分为基本数据类型和复杂数据类型。</p>
<p>基本数据类型如下：</p>
<table>
<thead>
<tr>
<th>Hive</th>
<th>说明</th>
<th>定义</th>
</tr>
</thead>
<tbody>
<tr>
<td>tinyint</td>
<td>1byte 有符号整数</td>
<td></td>
</tr>
<tr>
<td>smallint</td>
<td>2byte 有符号整数</td>
<td></td>
</tr>
<tr>
<td>int</td>
<td>4byte 有符号整数</td>
<td></td>
</tr>
<tr>
<td>bigint</td>
<td>8byte 有符号整数</td>
<td></td>
</tr>
<tr>
<td>boolean</td>
<td>布尔类型，true 或者 false</td>
<td></td>
</tr>
<tr>
<td>float</td>
<td>单精度浮点数</td>
<td></td>
</tr>
<tr>
<td>double</td>
<td>双精度浮点数</td>
<td></td>
</tr>
<tr>
<td>decimal</td>
<td>十进制精准数字类型</td>
<td>decimal(16,2)</td>
</tr>
<tr>
<td>varchar</td>
<td>字符序列，需指定最大长度，最大长度的范围是 [1,65535]</td>
<td>varchar(32)</td>
</tr>
<tr>
<td>string</td>
<td>字符串，无需指定最大长度</td>
<td></td>
</tr>
<tr>
<td>timestamp</td>
<td>时间类型</td>
<td></td>
</tr>
<tr>
<td>binary</td>
<td>二进制数据</td>
<td></td>
</tr>
</tbody>
</table>
<p><strong>方式一：隐式转换</strong></p>
<p>具体规则如下：</p>
<p>a. 任何整数类型都可以隐式地转换为一个范围更广的类型，如 tinyint 可以转换成 int，int 可以转换成 bigint。</p>
<p>b. 所有整数类型、float 和 string 类型都可以隐式地转换成 double。</p>
<p>c. tinyint、smallint、int 都可以转换为 float。</p>
<p>d. boolean 类型不可以转换为任何其它的类型。</p>
<p><strong>方式二：显示转换</strong></p>
<p>可以借助 cast 函数完成显示的类型转换</p>
<p>a. 语法</p>
<p>cast(expr as <type>)</p>
<p>b. 案例</p>
<p>hive (default)&gt; select ‘1’ + 2, cast(‘1’ as int) + 2;</p>
<p>数据仓库 (英语：Data Warehouse, 简称数仓、DW), 是一个月用于存储、分析、报告的数据系统。</p>
<p>数据仓库的目的是构建面向分析的集成化数据环境，分析结果为企业提供决策支持 (Decision Support)。</p>
<p>关系型数据库 (RDBMS) 是 OLTP 典型应用，比如：Oracle、MySQL、SQL Server 等。</p>
<p>面向分析、支持分析的系统称之为 OLAP (联机分析处理) 系统。数据仓库是 OLAP 一种。</p>
<p>联机事务处理 OLTP (On-Line Transaction Processing)。</p>
<p>传统 RDBMS，mysql，oracle，sqlserver</p>
<p>联机分析处理 OLAP (On-LineAnalytical Processing)。</p>
<p>数据仓库，主要用于开展数据分析</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224237355.png" alt="image-20240804224237355"></p>
<p>数据库与数据仓库的区别实际讲的是 OLTP 与 OLAP 的区别。</p>
<p>OLTP 系统的典型应用就是 RDBMS, 也就是我们俗称的数据库，当然这里要特别强调此数据库表示的是关系型数据库，</p>
<p>Nosql 数据库并不在讨论范围内。</p>
<p>OLAP 系统的典型应用就是 DW, 也就是我们俗称的数据仓库。</p>
<p>数据仓库，数据集市</p>
<p>数据仓库 (Data Warehouse) 是面向整个集团组织的数据，数据集市 (Data Mart) 是面向单个部门使用的。</p>
<p>可以认为数据集市是数据仓库的子集，也有人把数据集市叫做小型数据仓库。数据集市通常只涉及一个主题领域，例如市场营销或销售。因为它们较小且更具体，所以它们通常更易于管理和维护，并具有更灵活的结构。</p>
<p>下图中，各种操作型系统数据和包括文件在内的等其他数据作为数据源，经过 ETL (抽取转换加载) 填充到数据仓库中；数据仓库中有不同主题数据，数据集市则根据部门特点面向指定主题，比如 Purchasing (采购)、Sales 售)、Inventory (库存);</p>
<p>用户可以基于主题数据开展各种应用：数据分析、数据报表、数据挖掘。</p>
<p>数据仓库分层思想</p>
<p>ETL ELT</p>
<h2 id="flink"><a class="markdownIt-Anchor" href="#flink">#</a> flink</h2>
<p>Apache Flink 是一个框架和分布式处理引擎，用于对无异和有界数据流进行有状态计算。</p>
<p>1) 无界数据流:</p>
<p>有定义流的开始，但没有定义流的结束；</p>
<p>它们会无休止的产生数据；</p>
<p>无界流的数据必须持续处理，即数据被摄取后需要立刻处上理。</p>
<p>我们不能等到所有数据都到达再处理，因为输入是无限的。</p>
<p>2) 有界数据流:</p>
<p>有定义流的开始，也有定义流的结束；</p>
<p>有界流可以在摄取所有数据后再进行计算；</p>
<p>有界流所有数据可以被排序，所以并不需要有序摄取；</p>
<p>有界流处理通常被称为批处理。</p>
<p>把流处理需要的额外数据保存成一个 &quot;状态&quot;, 然户后针对这条数据进行处理，并且更新状态。这就是所谓的 &quot;有状态的流处理&quot;。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224253261.png" alt="image-20240804224253261"></p>
<h3 id="wordcount"><a class="markdownIt-Anchor" href="#wordcount">#</a> wordcount</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">        &lt;flink.version&gt;<span class="number">1.17</span><span class="number">.0</span>&lt;/flink.version&gt;</span><br><span class="line">&lt;/properties&gt;</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">    &lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-streaming-java&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"> </span><br><span class="line">     &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-clients&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;$&#123;flink.version&#125;&lt;/version&gt;</span><br><span class="line">     &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br><span class="line"><span class="comment">// 批处理</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.ExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.operators.AggregateOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.operators.DataSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.operators.FlatMapOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.operators.UnsortedGrouping;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">count</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">ExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> ExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        DataSource&lt;String&gt; stringDataSource = env.readTextFile(<span class="string">&quot;data/input&quot;</span>);</span><br><span class="line"></span><br><span class="line">        FlatMapOperator&lt;String, Tuple2&lt;String, Integer&gt;&gt; stringTuple2FlatMapOperator = stringDataSource.flatMap(<span class="keyword">new</span> <span class="title class_">FlatMapFunction</span>&lt;String, Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(String s, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                String[] s1 = s.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String ss : s1) &#123;</span><br><span class="line">                    Tuple2&lt;String, Integer&gt; stringIntegerTuple2 = Tuple2.of(ss, <span class="number">1</span>);</span><br><span class="line">                    collector.collect(stringIntegerTuple2);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        UnsortedGrouping&lt;Tuple2&lt;String, Integer&gt;&gt; tuple2UnsortedGrouping = stringTuple2FlatMapOperator.groupBy(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">        AggregateOperator&lt;Tuple2&lt;String, Integer&gt;&gt; sum = tuple2UnsortedGrouping.sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        sum.print();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 流处理</span></span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.functions.FlatMapFunction;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.functions.KeySelector;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.KeyedStream;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">count2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">executionEnvironment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;String&gt; stringDataStreamSource = executionEnvironment.readTextFile(<span class="string">&quot;data/input&quot;</span>);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; tuple2SingleOutputStreamOperator = stringDataStreamSource.flatMap(<span class="keyword">new</span> <span class="title class_">FlatMapFunction</span>&lt;String, Tuple2&lt;String, Integer&gt;&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(String s, Collector&lt;Tuple2&lt;String, Integer&gt;&gt; collector)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                String[] s1 = s.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">                <span class="keyword">for</span> (String string : s1) &#123;</span><br><span class="line">                    Tuple2&lt;String, Integer&gt; stringIntegerTuple2 = Tuple2.of(string, <span class="number">1</span>);</span><br><span class="line">                    collector.collect(stringIntegerTuple2);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;Tuple2&lt;String, Integer&gt;, String&gt; tuple2StringKeyedStream = tuple2SingleOutputStreamOperator.keyBy(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;Tuple2&lt;String, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(Tuple2&lt;String, Integer&gt; stringIntegerTuple2)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> stringIntegerTuple2.f0;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; sum = tuple2StringKeyedStream.sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        sum.print();</span><br><span class="line">        </span><br><span class="line">        executionEnvironment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// socket</span></span><br></pre></td></tr></table></figure>
<h3 id="flink-部署"><a class="markdownIt-Anchor" href="#flink-部署">#</a> flink 部署</h3>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">客户端(Client):代码由客户端获取并做转换,之后提交给JolManger</span><br><span class="line">JobManager就是Flink集群里的<span class="string">&quot;管事人&quot;</span>,对作业进行中央调度管理;而它获取到要执行的作业后,会进一步处理转换,然后分发任务给众多的TaskManager。</span><br><span class="line">TaskManager,就是真正<span class="string">&quot;干活的人&quot;</span>,数据的处理操作都是它它们来做的。</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224309842.png" alt="image-20240804224309842"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">wget <span class="string">&quot;https://dlcdn.apache.org/flink/flink-1.17.2/flink-1.17.2-bin-scala_2.12.tgz&quot;</span></span><br><span class="line">tar xzvf flink-<span class="number">1.17</span><span class="number">.2</span>-bin-scala_2<span class="number">.12</span>.tgz</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim flink-conf.yaml</span><br><span class="line">jobmanager.rpc.address: hadoop100</span><br><span class="line">jobmanager.rpc.port: <span class="number">6123</span></span><br><span class="line">jobmanager.bind-host: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">rest.address: hadoop100</span><br><span class="line">rest.bind-address: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line"></span><br><span class="line">taskmanager.bind-host: <span class="number">0.0</span><span class="number">.0</span><span class="number">.0</span></span><br><span class="line">taskmanager.host: hadoop100</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">vim worker</span><br><span class="line">hadoop100</span><br><span class="line">hadoop101</span><br><span class="line">hadoop102</span><br><span class="line"></span><br><span class="line">vim master</span><br><span class="line">hadoop100:<span class="number">8081</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">分发到其他节点，修改flink-conf</span><br><span class="line"></span><br><span class="line">taskmanager.host: hadoop10x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 启动</span><br><span class="line"> start-cluster.sh </span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">root<span class="meta">@hadoop100</span>:~# jps </span><br><span class="line"><span class="number">140450</span> StandaloneSessionClusterEntrypoint</span><br><span class="line"><span class="number">140861</span> TaskManagerRunner</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http:<span class="comment">//hadoop100:8081/#/overview</span></span><br></pre></td></tr></table></figure>
<h4 id="web提交任务"><a class="markdownIt-Anchor" href="#web提交任务">#</a> web 提交任务</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.flink.api.common.typeinfo.Types;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.api.java.tuple.Tuple2;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.DataStreamSource;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.datastream.SingleOutputStreamOperator;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.streaming.api.environment.StreamExecutionEnvironment;</span><br><span class="line"><span class="keyword">import</span> org.apache.flink.util.Collector;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketStreamWordCount</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建流式执行环境</span></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 2. 读取文本流：hadoop102表示发送端主机名、7777表示端口号</span></span><br><span class="line">        DataStreamSource&lt;String&gt; lineStream = env.socketTextStream(<span class="string">&quot;hadoop100&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换、分组、求和，得到统计结果</span></span><br><span class="line">        SingleOutputStreamOperator&lt;Tuple2&lt;String, Long&gt;&gt; sum = lineStream.flatMap((String line, Collector&lt;Tuple2&lt;String, Long&gt;&gt; out) -&gt; &#123;</span><br><span class="line">                    String[] words = line.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">                        out.collect(Tuple2.of(word, <span class="number">1L</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).returns(Types.TUPLE(Types.STRING, Types.LONG))</span><br><span class="line">                .keyBy(data -&gt; data.f0)</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 打印</span></span><br><span class="line">        sum.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"># 增加依赖</span><br><span class="line"> &lt;build&gt;</span><br><span class="line">        &lt;plugins&gt;</span><br><span class="line">            &lt;plugin&gt;</span><br><span class="line">                &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;</span><br><span class="line">                &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;</span><br><span class="line">                &lt;version&gt;<span class="number">3.2</span><span class="number">.4</span>&lt;/version&gt;</span><br><span class="line">                &lt;executions&gt;</span><br><span class="line">                    &lt;execution&gt;</span><br><span class="line">                        &lt;phase&gt;<span class="keyword">package</span>&lt;/phase&gt;</span><br><span class="line">                        &lt;goals&gt;</span><br><span class="line">                            &lt;goal&gt;shade&lt;/goal&gt;</span><br><span class="line">                        &lt;/goals&gt;</span><br><span class="line">                        &lt;configuration&gt;</span><br><span class="line">                            &lt;artifactSet&gt;</span><br><span class="line">                                &lt;excludes&gt;</span><br><span class="line">                                    &lt;exclude&gt;com.google.code.findbugs:jsr305&lt;/exclude&gt;</span><br><span class="line">                                    &lt;exclude&gt;org.slf4j:*&lt;/exclude&gt;</span><br><span class="line">                                    &lt;exclude&gt;log4j:*&lt;/exclude&gt;</span><br><span class="line">                                &lt;/excludes&gt;</span><br><span class="line">                            &lt;/artifactSet&gt;</span><br><span class="line">                            &lt;filters&gt;</span><br><span class="line">                                &lt;filter&gt;</span><br><span class="line">                                    &lt;!-- Do not copy the signatures in the META-INF folder.</span><br><span class="line">                                    Otherwise, <span class="built_in">this</span> might cause SecurityExceptions when using the JAR. --&gt;</span><br><span class="line">                                    &lt;artifact&gt;*:*&lt;/artifact&gt;</span><br><span class="line">                                    &lt;excludes&gt;</span><br><span class="line">                                        &lt;exclude&gt;META-INF<span class="comment">/*.SF&lt;/exclude&gt;</span></span><br><span class="line"><span class="comment">                                        &lt;exclude&gt;META-INF/*.DSA&lt;/exclude&gt;</span></span><br><span class="line"><span class="comment">                                        &lt;exclude&gt;META-INF/*.RSA&lt;/exclude&gt;</span></span><br><span class="line"><span class="comment">                                    &lt;/excludes&gt;</span></span><br><span class="line"><span class="comment">                                &lt;/filter&gt;</span></span><br><span class="line"><span class="comment">                            &lt;/filters&gt;</span></span><br><span class="line"><span class="comment">                            &lt;transformers combine.children=&quot;append&quot;&gt;</span></span><br><span class="line"><span class="comment">                                &lt;transformer</span></span><br><span class="line"><span class="comment">                                        implementation=&quot;org.apache.maven.plugins.shade.resource.ServicesResourceTransformer&quot;&gt;</span></span><br><span class="line"><span class="comment">                                &lt;/transformer&gt;</span></span><br><span class="line"><span class="comment">                            &lt;/transformers&gt;</span></span><br><span class="line"><span class="comment">                        &lt;/configuration&gt;</span></span><br><span class="line"><span class="comment">                    &lt;/execution&gt;</span></span><br><span class="line"><span class="comment">                &lt;/executions&gt;</span></span><br><span class="line"><span class="comment">            &lt;/plugin&gt;</span></span><br><span class="line"><span class="comment">        &lt;/plugins&gt;</span></span><br><span class="line"><span class="comment">    &lt;/build&gt;</span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">    </span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  </span><br><span class="line">  可以在前面的依赖中添加</span><br><span class="line">  &lt;scope&gt;provided&lt;/scope&gt;</span><br><span class="line">  来不打包依赖</span><br><span class="line">  </span><br><span class="line">  添加后需要在edit configuration中include provided，否则idea中无法编译</span><br><span class="line">  </span><br><span class="line">  </span><br><span class="line">  </span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224322601.png" alt="image-20240804224322601"></p>
<p>创建任务，submit</p>
<p>nc -lvvp 7777 发送数据查看效果</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224334662.png" alt="image-20240804224334662"></p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224343308.png" alt="image-20240804224343308"></p>
<p>命令行提交作业</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">flink run -m hadoop100:<span class="number">8081</span> -c wordcount.SocketStreamWordCount ./xxx.jar</span><br></pre></td></tr></table></figure>
<h3 id="部署模式"><a class="markdownIt-Anchor" href="#部署模式">#</a> 部署模式</h3>
<p>Flink 为各种场景提供了不同的部署模式，主要有以下三种：会话模式（Session Mode）、单作业模式（Per-Job Mode）、应用模式（Application Mode）。</p>
<p>它们的区别主要在于：集群的生命周期以及资源的分配方式；以及应用的 main 方法到底在哪里执行 —— 客户端（Client）还是 JobManager。</p>
<h4 id="会话模式"><a class="markdownIt-Anchor" href="#会话模式">#</a> 会话模式</h4>
<p>会话模式其实最符合常规思维。我们需要先启动一个集群，保持一个会话，在这个会话中通过客户端提交作业。集群启动时所有资源就都已经确定，所以所有提交的作业会竞争集群中的资源。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224355062.png" alt="image-20240804224355062"></p>
<h4 id="单作业模式"><a class="markdownIt-Anchor" href="#单作业模式">#</a> 单作业模式</h4>
<p>会话模式因为资源共享会导致很多问题，所以为了更好地隔离资源，我们可以考虑为每个提交的作业启动一个集群，这就是所谓的单作业 (Per-Job) 模式。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224407159.png" alt="image-20240804224407159"></p>
<p>需要注意的是，Flink 本身无法直接这样运行，所以单作业模式一般需要借助一些资源管理框架来启动集群，比如 YARN、Kubernetes (K8S)。</p>
<h4 id="应用模式"><a class="markdownIt-Anchor" href="#应用模式">#</a> 应用模式</h4>
<p>直接把应用提交到 JobManger 上运行。而这也就代表着，我们需要为每一个提交的应用单独启动一个 JobManager, 也就是创建一个集群。这个 JobManager 只为执行这一个应用而存在，执行结束之后 JobManager 也就关闭了，这就是所谓的应用模式。</p>
<p>应用模式与单作业模式，都是提交作业之后才创建集群；单单作业模式是通过客户端来提交的，客户端解析出的每一个作业对应一个集群；而应用模式下，是直接由 JobManager 执行应用程序的。</p>
<h4 id="standlone-模式"><a class="markdownIt-Anchor" href="#standlone-模式">#</a> standlone 模式</h4>
<p>独立模式是独立运行的，不依赖任何外部的资源管理平台；当然独立也是有代价的：如果资源不足，或者出现故障，没有自动扩展或重分配资源的保证，必须手动处理。所以独立模式一般只用在开发测试或作业非常少的场景下。</p>
<p>会话模式部署</p>
<p>提前启动集群，并通过 Web 页面客户端提交任务（可以多个任务，但是集群资源固定）。</p>
<p>standlone 不支持单作业部署</p>
<p>应用模式部署</p>
<p>启动 jobmanager</p>
<p>bin/standalone-job.sh start --job-classname com.atguigu.wc.SocketStreamWordCount</p>
<p>启动 TaskManager, 需要在每个 taskmanager 上启动</p>
<p><span class="exturl" data-url="aHR0cDovL3Rhc2ttYW5hZ2VyLnNo">taskmanager.sh</span> start</p>
<p>停止</p>
<p><span class="exturl" data-url="aHR0cDovL3Rhc2ttYW5hZ2VyLnNo">taskmanager.sh</span> stop</p>
<p><span class="exturl" data-url="aHR0cDovL3N0YW5kYWxvbmUtam9iLnNo">standalone-job.sh</span> stop</p>
<h4 id="yarn模式"><a class="markdownIt-Anchor" href="#yarn模式">#</a> yarn 模式</h4>
<p>客户端把 Flink 应用提交给 Yarn 的 ResourceManager，Yarn 的 ResourceManager 会向 Yarn 的 NodeManager 申请容器。在这些容器上，Flink 会部署 JobManager 和 TaskManager 的实例，从而启动集群。Flink 会根据运行在 JobManger 上的作业所需要的 Slot 数量动态分配 TaskManager 资源。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/profile</span><br><span class="line"># hadoop</span><br><span class="line">export HADOOP_HOME=/root/hadoop-<span class="number">3.3</span><span class="number">.6</span></span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/bin</span><br><span class="line">export PATH=$PATH:$HADOOP_HOME/sbin</span><br><span class="line">export HADOOP_CONF_DIR=$&#123;HADOOP_HOME&#125;/etc/hadoop</span><br><span class="line">export HADOOP_CLASSPATH=`hadoop classpath`</span><br></pre></td></tr></table></figure>
<h5 id="yarn-会话模式"><a class="markdownIt-Anchor" href="#yarn-会话模式">#</a> yarn - 会话模式</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yarn-session.sh -d -nm name111</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 提交任务</span><br><span class="line">flink run -c com.wordcount lib/<span class="number">1.</span>jar </span><br></pre></td></tr></table></figure>
<h5 id="yarn-单作业模式"><a class="markdownIt-Anchor" href="#yarn-单作业模式">#</a> yarn - 单作业模式</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">flink run -d -t yarn-per-job -c com.wordcount lib/<span class="number">1.</span>jar</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/// 停止</span></span><br><span class="line">bin/flink list -t yarn-per-job -Dyarn.application.id=application_XXXX_YY</span><br><span class="line"> </span><br><span class="line">bin/flink cancel -t yarn-per-job -Dyarn.application.id=application_XXXX_YY &lt;jobId&gt;</span><br><span class="line">消除classloader告警</span><br><span class="line">vim flink-conf.yaml</span><br><span class="line"> </span><br><span class="line">classloader.check-leaked-classloader: <span class="literal">false</span></span><br></pre></td></tr></table></figure>
<h5 id="yarn-应用模式部署"><a class="markdownIt-Anchor" href="#yarn-应用模式部署">#</a> yarn - 应用模式部署</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">flink run-application -t yarn-application -c com.atguigu.wc.SocketStreamWordCount FlinkTutorial-<span class="number">1.0</span>-SNAPSHOT.jar </span><br><span class="line">上传HDFS提交</span><br><span class="line">可以通过yarn.provided.lib.dirs配置选项指定位置，将flink的依赖上传到远程。</span><br><span class="line">（<span class="number">1</span>）上传flink的lib和plugins到HDFS上</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ hadoop fs -mkdir /flink-dist</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ hadoop fs -put lib/ /flink-dist</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ hadoop fs -put plugins/ /flink-dist</span><br><span class="line">（<span class="number">2</span>）上传自己的jar包到HDFS</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ hadoop fs -mkdir /flink-jars</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ hadoop fs -put FlinkTutorial-<span class="number">1.0</span>-SNAPSHOT.jar /flink-jars</span><br><span class="line">（<span class="number">3</span>）提交作业</span><br><span class="line">[atguigu<span class="meta">@hadoop102</span> flink-<span class="number">1.17</span><span class="number">.0</span>]$ bin/flink run-application -t yarn-application        -Dyarn.provided.lib.dirs=<span class="string">&quot;hdfs://hadoop102:8020/flink-dist&quot;</span>        -c com.atguigu.wc.SocketStreamWordCount  hdfs:<span class="comment">//hadoop102:8020/flink-jars/FlinkTutorial-1.0-SNAPSHOT.jar</span></span><br></pre></td></tr></table></figure>
<p>配置历史服务器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">jobmanager.archive.fs.dir: hdfs:<span class="comment">//hadoop100:8020/logs</span></span><br><span class="line"></span><br><span class="line"># The address under which the web-based HistoryServer listens.</span><br><span class="line">historyserver.web.address: hadoop100</span><br><span class="line"></span><br><span class="line"># The port under which the web-based HistoryServer listens.</span><br><span class="line">historyserver.web.port: <span class="number">8082</span></span><br><span class="line"></span><br><span class="line"># Comma separated list of directories to monitor <span class="keyword">for</span> completed jobs.</span><br><span class="line">historyserver.archive.fs.dir: hdfs:<span class="comment">//hadoop100:8020/logs</span></span><br><span class="line"></span><br><span class="line"># Interval in milliseconds <span class="keyword">for</span> refreshing the monitored directories.</span><br><span class="line">historyserver.archive.fs.refresh-interval: <span class="number">10000</span></span><br><span class="line"></span><br><span class="line">historyserver.sh start </span><br></pre></td></tr></table></figure>
<h3 id="系统架构"><a class="markdownIt-Anchor" href="#系统架构">#</a> 系统架构</h3>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224432790.png" alt="image-20240804224432790"></p>
<h4 id="并行度"><a class="markdownIt-Anchor" href="#并行度">#</a> 并行度</h4>
<p>一个特定算子的子任务（subtask）的个数被称之为其并行度（parallelism）。这样，包含并行子任务的数据流，就是并行数据流，它需要多个分区（stream partition）来分配并行任务。一般情况下，一个流程序的并行度，可以认为就是其所有算子中最大的并行度。一个程序中，不同的算子可能具有不同的并行度。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224445616.png" alt="image-20240804224445616"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;flink-runtime-web&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;<span class="number">1.17</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SocketStreamWordCount</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 1. 创建流式执行环境</span></span><br><span class="line">        <span class="comment">//StreamExecutionEnvironment env = StreamExecutionEnvironment.getExecutionEnvironment();</span></span><br><span class="line"></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.createLocalEnvironmentWithWebUI(<span class="keyword">new</span> <span class="title class_">Configuration</span>());</span><br><span class="line">        <span class="comment">// 2. 读取文本流：hadoop102表示发送端主机名、7777表示端口号</span></span><br><span class="line">        DataStreamSource&lt;String&gt; lineStream = env.socketTextStream(<span class="string">&quot;hadoop100&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 3. 转换、分组、求和，得到统计结果</span></span><br><span class="line">        elineStream.flatMap((String line, Collector&lt;Tuple2&lt;String, Long&gt;&gt; out) -&gt; &#123;</span><br><span class="line">                    String[] words = line.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">                        out.collect(Tuple2.of(word, <span class="number">1L</span>));</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;).setParallelism(<span class="number">2</span>)</span><br><span class="line">                .returns(Types.TUPLE(Types.STRING, Types.LONG))</span><br><span class="line">                .keyBy(data -&gt; data.f0)</span><br><span class="line">                .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 4. 打印</span></span><br><span class="line">        sum.print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 5. 执行</span></span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// idea中，不指定并行度，默认就是电脑的线程数</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 全局设置并行度</span></span><br><span class="line">        env.setParallelism(<span class="number">3</span>);</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">算子优先级更高 &gt;  env   &gt;  -p  &gt; flink-conf</span><br><span class="line"></span><br><span class="line">提交作业时指定 命令行启动 参数 -p <span class="number">2</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置文件</span><br><span class="line">flink-conf.yaml</span><br><span class="line">parallelism.<span class="keyword">default</span>: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<h4 id="算子链"><a class="markdownIt-Anchor" href="#算子链">#</a> 算子链</h4>
<p><strong>（1）一对一（One-to-one，forwarding）</strong></p>
<p>这种模式下，数据流维护着分区以及元素的顺序。比如图中的 source 和 map 算子，source 算子读取数据之后，可以直接发送给 map 算子做处理，它们之间不需要重新分区，也不需要调整数据的顺序。这就意味着 map 算子的子任务，看到的元素个数和顺序跟 source 算子的子任务产生的完全一样，保证着 “一对一” 的关系。map、filter、flatMap 等算子都是这种 one-to-one 的对应关系。这种关系类似于 Spark 中的窄依赖。</p>
<p><strong>（2）重分区（Redistributing）</strong></p>
<p>在这种模式下，数据流的分区会发生改变。比如图中的 map 和后面的 keyBy/window 算子之间，以及 keyBy/window 算子和 Sink 算子之间，都是这样的关系。</p>
<p>每一个算子的子任务，会根据数据传输的策略，把数据发送到不同的下游目标任务。这些传输方式都会引起重分区的过程，这一过程类似于 Spark 中的 shuffle。</p>
<p>在 Flink 中，并行度相同的一对一（one to one）算子操作，可以直接链接在一起形成一个 “大” 的任务（task）</p>
<p>将算子链接成 task 是非常有效的优化：可以减少线程之间的切换和基于缓存区的数据交换，在减少时延的同时提升吞吐量。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 全局禁用算子链</span><br><span class="line">env.disableOperatorChaining();</span><br><span class="line"></span><br><span class="line"># 对某个算子禁用算子链</span><br><span class="line">.sum(<span class="number">1</span>).disableChaining();</span><br><span class="line"></span><br><span class="line">禁用算子链之后，只有这个算子相邻算子不能和自己链</span><br><span class="line"></span><br><span class="line"># 从某个算子开启新链条</span><br><span class="line">.sum(<span class="number">1</span>).startNewChain();</span><br><span class="line">算子不与前面链，从当前开始正常链</span><br></pre></td></tr></table></figure>
<h4 id="任务槽"><a class="markdownIt-Anchor" href="#任务槽">#</a> 任务槽</h4>
<p>每个任务槽（task slot）其实表示了 TaskManager 拥有计算资源的一个固定大小的子集。这些资源就是用来独立执行一个子任务的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 每个tm slot数，默认是<span class="number">1</span></span><br><span class="line">taskmanager.numberOfTaskSlots: <span class="number">1</span></span><br></pre></td></tr></table></figure>
<p>slot 目前仅仅用来隔离内存，不会涉及 CPU 的隔离。在具体应用时，可以将 slot 数量配置为机器的 CPU 核心数，尽量避免不同任务之间对 CPU 的竞争。这也是开发环境默认并行度设为机器 CPU 数量的原因。</p>
<p>同一个 job 中，不同算子的子任务，才可以共享一个 slot，slot 内是同时在运行的</p>
<p>属于同一个 slot 共享组，默认是 default</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224459615.png" alt="image-20240804224459615"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.sum(<span class="number">1</span>).slotSharingGroup(<span class="string">&quot;aaa&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>slot 数量 与 并行度 的关系</p>
<p>1) slot 是一种静态的概念，表示最大的并发上限</p>
<p>并行度是一种动态的概念，表示实际运行 占用了几个</p>
<p>2) 要求:slot 数量 &gt;=job 并行度 (算子最大并行度),job 才能运行</p>
<p>yarn 模式是动态申请</p>
<p>申请的 TM 数量 = job 并行度 / 每个 TM 的 slot 数，向上取整</p>
<h4 id="作业提交流程"><a class="markdownIt-Anchor" href="#作业提交流程">#</a> 作业提交流程</h4>
<h5 id="standalone"><a class="markdownIt-Anchor" href="#standalone">#</a> standalone</h5>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224512232.png" alt="image-20240804224512232"></p>
<p>逻辑流图（StreamGraph）→ 作业图（JobGraph）→ 执行图（ExecutionGraph）→ 物理图（Physical Graph）</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224530055.png" alt="image-20240804224530055"></p>
<p><img data-src="https://bytedance.larkoffice.com/space/api/box/stream/download/asynccode/?code=ODUxMzFkZWQ3OWQyMTFjMjhlZWY1NWM3MWQzNzk0YWZfVXM3M2gxRkdSeEFvMWQ4ZWJ6N1pscHplUFZFOTVJVWhfVG9rZW46VWR4WmJTUUJzb0c0MFp4eTdxeWNzVGhrbllnXzE3MjI3ODE5MDk6MTcyMjc4NTUwOV9WNA" alt="img"></p>
<h5 id="yarn"><a class="markdownIt-Anchor" href="#yarn">#</a> yarn</h5>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224551577.png" alt="image-20240804224551577"></p>
<h4 id="datastream-api"><a class="markdownIt-Anchor" href="#datastream-api">#</a> datastream api</h4>
<h5 id="执行环境"><a class="markdownIt-Anchor" href="#执行环境">#</a> 执行环境</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    configuration.set(RestOptions.BIND_PORT, <span class="string">&quot;8082&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动识别环境是远程还是本地</span></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment(configuration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 流批一体，同一套API，默认STREAMING</span></span><br><span class="line">    <span class="comment">// 一般不在代码写死，再命令行参数指定 -Dexecution.runtime-mode=BATCH</span></span><br><span class="line">    environment.setRuntimeMode(RuntimeExecutionMode.STREAMING);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;Tuple2&lt;String, Long&gt;&gt; sum = environment.socketTextStream(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">7777</span>).flatMap((String line, Collector&lt;Tuple2&lt;String, Long&gt;&gt; out) -&gt; &#123;</span><br><span class="line">                String[] words = line.split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">for</span> (String word : words) &#123;</span><br><span class="line">                    out.collect(Tuple2.of(word, <span class="number">1L</span>));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;)</span><br><span class="line">            .returns(Types.TUPLE(Types.STRING, Types.LONG))</span><br><span class="line">            .keyBy(data -&gt; data.f0)</span><br><span class="line">            .sum(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    sum.print();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 触发执行 flink job</span></span><br><span class="line">    <span class="comment">// Flink是由事件驱动的,只有等等到数据到来,才会触发真正的计算,这也被称为&quot;延迟执行&quot;或&quot;懒执行&quot;。</span></span><br><span class="line">    <span class="comment">// 一个main调用多个exec，会在第一个阻塞住</span></span><br><span class="line">    environment.execute();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 异步执行，不会阻塞，execsync个数 = 生成flink job数</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// yarn-application集群,提交一次,集群里会有几个flink job?</span></span><br><span class="line">    <span class="comment">//取决于调用了n个executeAsync()</span></span><br><span class="line">    <span class="comment">//对应application集群里,会有n个job</span></span><br><span class="line">    <span class="comment">//对应Jobmanager当中,会有 n个JobMaster</span></span><br><span class="line">    environment.executeAsync();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="读取数据"><a class="markdownIt-Anchor" href="#读取数据">#</a> 读取数据</h5>
<h6 id="从集合读取数据"><a class="markdownIt-Anchor" href="#从集合读取数据">#</a> 从集合读取数据</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">Configuration</span> <span class="variable">configuration</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Configuration</span>();</span><br><span class="line">    configuration.set(RestOptions.BIND_PORT, <span class="string">&quot;8082&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 自动识别环境是远程还是本地</span></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment(configuration);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromCollection(Arrays.asList(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>));</span><br><span class="line">    DataStreamSource&lt;Integer&gt; dataStreamSource = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">    integerDataStreamSource.print();</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="文件"><a class="markdownIt-Anchor" href="#文件">#</a> 文件</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;flink-connector-files&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.17</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">FileSource&lt;String&gt; build = FileSource.forRecordStreamFormat(<span class="keyword">new</span> <span class="title class_">TextLineInputFormat</span>(), <span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;input/1.txt&quot;</span>)).build();</span><br><span class="line"></span><br><span class="line">DataStreamSink&lt;String&gt; aaaa = environment.fromSource(build, WatermarkStrategy.noWatermarks(), <span class="string">&quot;aaaa&quot;</span>).print();</span><br></pre></td></tr></table></figure>
<h6 id="kafka"><a class="markdownIt-Anchor" href="#kafka">#</a> kafka</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;flink-connector-kafka&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">1.17</span><span class="number">.0</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KafkaSource&lt;String&gt; build = KafkaSource.&lt;String&gt;builder().setBootstrapServers(<span class="string">&quot;hadoop100:9092&quot;</span>).setGroupId(<span class="string">&quot;aaa&quot;</span>).setTopics(<span class="string">&quot;topic_haha&quot;</span>).setValueOnlyDeserializer(<span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>()).setStartingOffsets(OffsetsInitializer.latest()).build();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">environment.fromSource(build, WatermarkStrategy.noWatermarks(),<span class="string">&quot;kafka&quot;</span>);</span><br></pre></td></tr></table></figure>
<h6 id="数据生成器读取"><a class="markdownIt-Anchor" href="#数据生成器读取">#</a> 数据生成器读取</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment(configuration);</span><br><span class="line">environment.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// GeneratorFunction接口重新long方法</span></span><br><span class="line"><span class="comment">// Long 类型 自动生成数字序列的最大值</span></span><br><span class="line"><span class="comment">// 限速策略</span></span><br><span class="line"><span class="comment">// 返回类型</span></span><br><span class="line">DataGeneratorSource&lt;String&gt; stringDataGeneratorSource = <span class="keyword">new</span> <span class="title class_">DataGeneratorSource</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">GeneratorFunction</span>&lt;Long, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">map</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + aLong;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;, Long.MAX_VALUE, RateLimiterStrategy.perSecond(<span class="number">1</span>), Types.STRING);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 如果有n个并行度,最大值设为a</span></span><br><span class="line"><span class="comment">//将数值均分成n份,</span></span><br><span class="line"><span class="comment">//其中一个是0-49</span></span><br><span class="line"><span class="comment">//a/n,比如,最大100,并行度2,每个并行度生成50个</span></span><br><span class="line">environment.fromSource(stringDataGeneratorSource, WatermarkStrategy.noWatermarks(),<span class="string">&quot;datagen&quot;</span>).print();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">environment.execute();</span><br></pre></td></tr></table></figure>
<h5 id="flink-数据类型"><a class="markdownIt-Anchor" href="#flink-数据类型">#</a> flink 数据类型</h5>
<p>Flink 使用 “类型信息”（TypeInformation）来统一表示数据类型。TypeInformation 类是 Flink 中所有类型描述符的基类。它涵盖了类型的一些基本属性，并为每个数据类型生成特定的序列化器、反序列化器和比较器。</p>
<blockquote>
<p>泛型类型（GENERIC）</p>
<p>Flink 支持所有的 Java 类和 Scala 类。不过如果没有按照上面 POJO 类型的要求来定义，就会被 Flink 当作泛型类来处理。Flink 会把泛型类型当作黑盒，无法获取它们内部的属性；它们也不是由 Flink 本身序列化的，而是由 Kryo 序列化的。</p>
<p>在这些类型中，元组类型和 POJO 类型最为灵活，因为它们支持创建复杂类型。而相比之下，POJO 还支持在键（key）的定义中直接使用字段名，这会让我们的代码可读性大大增加。所以，在项目实践中，往往会将流处理程序中的元素类型定为 Flink 的 POJO 类型。</p>
<p>Flink 对 POJO 类型的要求如下：</p>
<ul>
<li>类是公有（public）的</li>
<li>有一个无参的构造方法</li>
<li>所有属性都是公有（public）的</li>
<li>所有属性的类型都是可以序列化的</li>
</ul>
</blockquote>
<blockquote>
<p><strong>类型提示（Type Hints）</strong></p>
<p>Flink 还具有一个类型提取系统，可以分析函数的输入和返回类型，自动获取类型信息，从而获得对应的序列化器和反序列化器。但是，由于 Java 中泛型擦除的存在，在某些特殊情况下（比如 Lambda 表达式中），自动提取的信息是不够精细的 —— 只告诉 Flink 当前的元素由 “船头、船身、船尾” 构成，根本无法重建出 “大船” 的模样；这时就需要显式地提供类型信息，才能使应用程序正常工作或提高其性能。</p>
<p>为了解决这类问题，Java API 提供了专门的 “类型提示”（type hints）。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.returns(<span class="keyword">new</span> <span class="title class_">TypeHint</span>&lt;Tuple2&lt;Integer, SomeType&gt;&gt;()&#123;&#125;)</span><br><span class="line"></span><br><span class="line">.returns(Types.TUPLE(Types.STRING, Types.LONG));</span><br></pre></td></tr></table></figure>
</blockquote>
<h4 id="转换算子"><a class="markdownIt-Anchor" href="#转换算子">#</a> 转换算子</h4>
<h5 id="map"><a class="markdownIt-Anchor" href="#map">#</a> map</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment(configuration);</span><br><span class="line">environment.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Object&gt; map = integerDataStreamSource.map(<span class="keyword">new</span> <span class="title class_">MapFunction</span>&lt;Integer, Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">map</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> integer;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">map.print();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Integer&gt; map1 = integerDataStreamSource.map(num -&gt; num * <span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<h5 id="fliter-flatmap"><a class="markdownIt-Anchor" href="#fliter-flatmap">#</a> fliter \ flatmap</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Integer&gt; filter = integerDataStreamSource.filter(<span class="keyword">new</span> <span class="title class_">FilterFunction</span>&lt;Integer&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// flatmap 可以一进一出，一进多出，一进0出</span></span><br><span class="line">SingleOutputStreamOperator&lt;Object&gt; objectSingleOutputStreamOperator = integerDataStreamSource.flatMap(<span class="keyword">new</span> <span class="title class_">FlatMapFunction</span>&lt;Integer, Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">flatMap</span><span class="params">(Integer integer, Collector&lt;Object&gt; collector)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        collector.collect(integer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">objectSingleOutputStreamOperator.print();</span><br></pre></td></tr></table></figure>
<script>alert(1)</script>
<h5 id="keyby"><a class="markdownIt-Anchor" href="#keyby">#</a> keyby</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// keyby 按照id分组，，返回键控流，不是转换算子，只是对数据重分区，不能设置并行度</span></span><br><span class="line"><span class="comment">// 3、keyby分组与分组 与 分区 的关系:</span></span><br><span class="line"><span class="comment">//1) keyby是对数据分组,保证 相同key的数据在同一个分区</span></span><br><span class="line"><span class="comment">//2)分区:一个子任务可以理解为一个分区,一个分区(子任务)中可以存在多个分组(key)</span></span><br><span class="line">KeyedStream&lt;Integer, Tuple&gt; integerObjectKeyedStream = integerDataStreamSource.keyBy(String.valueOf(<span class="keyword">new</span> <span class="title class_">KeySelector</span>&lt;Integer, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getKey</span><span class="params">(Integer integer)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;));</span><br></pre></td></tr></table></figure>
<h5 id="简单聚合算子"><a class="markdownIt-Anchor" href="#简单聚合算子">#</a> 简单聚合算子</h5>
<p>keyby 之后才能调用</p>
<p>做分组内聚合，对同一个 key 数据聚合</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sum(<span class="string">&quot;title&quot;</span>);  </span><br><span class="line"><span class="comment">// 传位置索引适用于tuple类型</span></span><br><span class="line">min(<span class="string">&quot;vc&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// max 只回取比较字段最大值，非比较字段取第一次的值</span></span><br><span class="line"><span class="comment">// maxby只回取比较字段最大值，非比较字段取当前字段的值</span></span><br><span class="line">max()</span><br><span class="line">maxby()</span><br></pre></td></tr></table></figure>
<h5 id="reduce"><a class="markdownIt-Anchor" href="#reduce">#</a> reduce</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">、keyby之后调用</span><br><span class="line">、输入类型=输出类型,类型不能变</span><br><span class="line">、每个key的第一条数据来的时候,不会执行reduce方法,在起来,直接输出</span><br><span class="line">reduce 方法中的参数，value1之前计算结果  value2 现在来的数据</span><br></pre></td></tr></table></figure>
<h5 id="udf"><a class="markdownIt-Anchor" href="#udf">#</a> UDF</h5>
<p>Flink 暴露了所有 UDF 函数的接口，具体实现方式为接口或者抽象类，例如 MapFunction、FilterFunction、ReduceFunction 等。所以用户可以自定义一个函数类，实现对应的接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">  DataStream&lt;String&gt; filter = stream.filter(<span class="keyword">new</span> <span class="title class_">UserFilter</span>());</span><br><span class="line">      </span><br><span class="line">        filter.print();</span><br><span class="line">        env.execute();</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">UserFilter</span> <span class="keyword">implements</span> <span class="title class_">FilterFunction</span>&lt;WaterSensor&gt; &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">filter</span><span class="params">(WaterSensor e)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> e.id.equals(<span class="string">&quot;sensor_1&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="richxxxfunction"><a class="markdownIt-Anchor" href="#richxxxfunction">#</a> RichXXXFunction</h5>
<p>多了生命周期管理方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">............多亏你申请</span><br><span class="line">open():每个子任务,在启动时,调用一次</span><br><span class="line">close():每个子任务,在结束时,调用一次</span><br></pre></td></tr></table></figure>
<p>多了运行时上下文，可以获取运行时环境信息，比如子任务编号，名称</p>
<p>无界流，如果 flink 程序异常终止，不会调用 close</p>
<p>正常调用 web ui cancel，会调用 close</p>
<h5 id="分区算子"><a class="markdownIt-Anchor" href="#分区算子">#</a> 分区算子</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//        Configuration configuration = new Configuration();</span></span><br><span class="line"><span class="comment">//        configuration.set(RestOptions.BIND_PORT, &quot;8082&quot;);</span></span><br><span class="line"></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        environment.setParallelism(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;String&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 随机分区</span></span><br><span class="line">        <span class="comment">// localhost.shuffle().print();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// rebalanced 轮询</span></span><br><span class="line">        <span class="comment">// 数据源倾斜场景，source读进来后，调用rebalance可以解决</span></span><br><span class="line">        <span class="comment">//localhost.rebalance().print();</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// rescale 缩放</span></span><br><span class="line">        <span class="comment">// 局部组队，比rebalance更高效</span></span><br><span class="line">        localhost.rescale().print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        localhost.broadcast().print();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 将所有数据发到一个子任务</span></span><br><span class="line">        localhost.global().print();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">// keyby:按指定key去发送,相同key发往同一个子任务</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h5 id="自定义分区器"><a class="markdownIt-Anchor" href="#自定义分区器">#</a> 自定义分区器</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPart</span> <span class="keyword">implements</span> <span class="title class_">Partitioner</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">partition</span><span class="params">(String s, <span class="type">int</span> i)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(s) % i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">custompartption</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        environment.setParallelism(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;String&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>);</span><br><span class="line"></span><br><span class="line">        localhost.partitionCustom(<span class="keyword">new</span> <span class="title class_">MyPart</span>(),num -&gt; num).print();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="分流"><a class="markdownIt-Anchor" href="#分流">#</a> 分流</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1.</span>使用process算子</span><br><span class="line"><span class="number">2.</span>定义outputtag对象</span><br><span class="line"><span class="number">3.</span>调用ctx.output</span><br><span class="line"><span class="number">4.</span>通过主流获取测流</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SplitStreamByOutputTag</span> &#123;    </span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">env</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"> </span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; ds = env.socketTextStream(<span class="string">&quot;hadoop102&quot;</span>, <span class="number">7777</span>)</span><br><span class="line">              .map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">        OutputTag&lt;WaterSensor&gt; s1 = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;s1&quot;</span>, Types.POJO(WaterSensor.class))&#123;&#125;;</span><br><span class="line">        OutputTag&lt;WaterSensor&gt; s2 = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;s2&quot;</span>, Types.POJO(WaterSensor.class))&#123;&#125;;</span><br><span class="line">       <span class="comment">//返回的都是主流</span></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; ds1 = ds.process(<span class="keyword">new</span> <span class="title class_">ProcessFunction</span>&lt;WaterSensor, WaterSensor&gt;()</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(WaterSensor value, Context ctx, Collector&lt;WaterSensor&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"> </span><br><span class="line">                <span class="keyword">if</span> (<span class="string">&quot;s1&quot;</span>.equals(value.getId())) &#123;</span><br><span class="line">                    ctx.output(s1, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;s2&quot;</span>.equals(value.getId())) &#123;</span><br><span class="line">                    ctx.output(s2, value);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">//主流</span></span><br><span class="line">                    out.collect(value);</span><br><span class="line">                &#125;</span><br><span class="line"> </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"> </span><br><span class="line">        ds1.print(<span class="string">&quot;主流，非s1,s2的传感器&quot;</span>);</span><br><span class="line">        SideOutputDataStream&lt;WaterSensor&gt; s1DS = ds1.getSideOutput(s1);</span><br><span class="line">        SideOutputDataStream&lt;WaterSensor&gt; s2DS = ds1.getSideOutput(s2);</span><br><span class="line"> </span><br><span class="line">        s1DS.printToErr(<span class="string">&quot;s1&quot;</span>);</span><br><span class="line">        s2DS.printToErr(<span class="string">&quot;s2&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        env.execute();</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="合流"><a class="markdownIt-Anchor" href="#合流">#</a> 合流</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"># union合流的数据类型必须相同</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">unionn</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">        environment.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        DataStreamSource&lt;Integer&gt; integerDataStreamSource1 = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">        DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromElements(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        DataStream&lt;Integer&gt; union = integerDataStreamSource.union(integerDataStreamSource1);</span><br><span class="line"></span><br><span class="line">        union.print();</span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">多条流可以用 , 分割</span><br><span class="line">source.union(source1,source2);</span><br><span class="line"></span><br><span class="line">也可以用.union </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 一次可以合并多条流</span><br><span class="line"># connect合流数据类型可以不一样</span><br><span class="line">DataStreamSource&lt;Integer&gt; integerDataStreamSource1 = environment.fromElements(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>);</span><br><span class="line">DataStreamSource&lt;Integer&gt; integerDataStreamSource = environment.fromElements(<span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>);</span><br><span class="line">DataStreamSource&lt;String&gt; stringDataStreamSource = environment.fromElements(<span class="string">&quot;111&quot;</span>, <span class="string">&quot;222&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ConnectedStreams&lt;Integer, String&gt; connect = integerDataStreamSource.connect(stringDataStreamSource);</span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; map = connect.map(<span class="keyword">new</span> <span class="title class_">CoMapFunction</span>&lt;Integer, String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">map1</span><span class="params">(Integer value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> value.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">map2</span><span class="params">(String value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">map.print();</span><br><span class="line"></span><br><span class="line">connect 一次只能连接两条流</span><br><span class="line">连接后可以调用map等处理，但是各处理各的</span><br></pre></td></tr></table></figure>
<h5 id="sink"><a class="markdownIt-Anchor" href="#sink">#</a> sink</h5>
<h6 id="输出到外部系统"><a class="markdownIt-Anchor" href="#输出到外部系统">#</a> 输出到外部系统</h6>
<p>Flink 作为数据处理框架，最终还是要把计算处理的结果写，入外部存储为外部应用提供支持。</p>
<p>Sink 多数情况下同样并不需要我们自己实现。之前我们一直在使用的 print 方法其实就是一种 Sink, 它表示将数据流写入标准控制台打印输出。Flink 官方为我们提供了一部分</p>
<h6 id="输出到文件"><a class="markdownIt-Anchor" href="#输出到文件">#</a> 输出到文件</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">    <span class="comment">// 同时写入的文件数由并行度决定</span></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    DataGeneratorSource&lt;String&gt; stringDataGeneratorSource = <span class="keyword">new</span> <span class="title class_">DataGeneratorSource</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">GeneratorFunction</span>&lt;Long, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">map</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + aLong;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Long.MAX_VALUE, RateLimiterStrategy.perSecond(<span class="number">1</span>), Types.STRING);</span><br><span class="line"></span><br><span class="line">    DataStreamSource&lt;String&gt; stringDataStreamSource = environment.fromSource(stringDataGeneratorSource, WatermarkStrategy.noWatermarks(), <span class="string">&quot;datagen&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FileSink&lt;String&gt; build = FileSink.forRowFormat(<span class="keyword">new</span> <span class="title class_">Path</span>(<span class="string">&quot;/Users/bytedance/Desktop&quot;</span>), <span class="keyword">new</span> <span class="title class_">SimpleStringEncoder</span>&lt;String&gt;(<span class="string">&quot;UTF-8&quot;</span>)).</span><br><span class="line">            withOutputFileConfig(OutputFileConfig.builder().withPartPrefix(<span class="string">&quot;==&quot;</span>).withPartSuffix(<span class="string">&quot;++&quot;</span>).build()).</span><br><span class="line">            withBucketAssigner(<span class="keyword">new</span> <span class="title class_">DateTimeBucketAssigner</span>&lt;&gt;(<span class="string">&quot;yyyy-MM-dd HH&quot;</span>, ZoneId.systemDefault())).</span><br><span class="line">            withRollingPolicy(DefaultRollingPolicy.builder().withRolloverInterval(Duration.ofSeconds(<span class="number">10</span>)).withMaxPartSize(<span class="keyword">new</span> <span class="title class_">MemorySize</span>(<span class="number">1024</span> * <span class="number">1024</span>)).build()).build();</span><br><span class="line"></span><br><span class="line">    stringDataStreamSource.sinkTo(build);</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="输出到kafka"><a class="markdownIt-Anchor" href="#输出到kafka">#</a> 输出到 kafka</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">    <span class="comment">// 同时写入的文件数由并行度决定</span></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    DataGeneratorSource&lt;String&gt; stringDataGeneratorSource = <span class="keyword">new</span> <span class="title class_">DataGeneratorSource</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">GeneratorFunction</span>&lt;Long, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">map</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + aLong;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Long.MAX_VALUE, RateLimiterStrategy.perSecond(<span class="number">1</span>), Types.STRING);</span><br><span class="line"></span><br><span class="line">    DataStreamSource&lt;String&gt; stringDataStreamSource = environment.fromSource(stringDataGeneratorSource, WatermarkStrategy.noWatermarks(), <span class="string">&quot;datagen&quot;</span>);</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// TODO注意:如果要使用精准一次 写入Kafka,需要满足以下条件,缺一不可</span></span><br><span class="line">    <span class="comment">//1、开启checkpoint(后续介绍)</span></span><br><span class="line">    <span class="comment">//2、设置事务前缀</span></span><br><span class="line">    <span class="comment">//3、设置事务超时时间:</span></span><br><span class="line">    <span class="comment">//checkpoint间隔&lt;</span></span><br><span class="line">    <span class="comment">//事务超时时间&lt;max的15分钟</span></span><br><span class="line">    KafkaSink&lt;String&gt; build = KafkaSink.&lt;String&gt;builder()</span><br><span class="line">            .setBootstrapServers(<span class="string">&quot;hadoop100:9092,hadoop101:9092,hadoop102:9092&quot;</span>)</span><br><span class="line">            .setRecordSerializer(</span><br><span class="line">                    KafkaRecordSerializationSchema.&lt;String&gt;builder()</span><br><span class="line">                            .setTopic(<span class="string">&quot;aaaaa&quot;</span>)</span><br><span class="line">                            .setValueSerializationSchema(<span class="keyword">new</span> <span class="title class_">SimpleStringSchema</span>())</span><br><span class="line">                            .build()</span><br><span class="line"></span><br><span class="line">            )</span><br><span class="line">            .setDeliveryGuarantee(DeliveryGuarantee.EXACTLY_ONCE)</span><br><span class="line">            .setTransactionalIdPrefix(<span class="string">&quot;xxxxxx&quot;</span>)</span><br><span class="line">            .setProperty(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG,<span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span> + <span class="string">&quot;&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line">    <span class="comment">// //写到kafka的一致性级别:精准一次、至少一次</span></span><br><span class="line">    <span class="comment">//.setDeliveryGuarantee (DeliveryGuarantee.EXAC)TLY_ONCE</span></span><br><span class="line">    <span class="comment">////如果是精准一次,必须设置事务的前缀</span></span><br><span class="line">    <span class="comment">//.setTransactionalIdPrefix(&quot;-&quot;)</span></span><br><span class="line">    <span class="comment">//如果是精准一次,必须设置事务超时时间:大于checkpoint间隔,小于max15分钟</span></span><br><span class="line"></span><br><span class="line">    stringDataStreamSource.sinkTo(build);</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line">    <span class="comment">// 同时写入的文件数由并行度决定</span></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    DataGeneratorSource&lt;String&gt; stringDataGeneratorSource = <span class="keyword">new</span> <span class="title class_">DataGeneratorSource</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">GeneratorFunction</span>&lt;Long, String&gt;() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">map</span><span class="params">(Long aLong)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span> + aLong;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, Long.MAX_VALUE, RateLimiterStrategy.perSecond(<span class="number">1</span>), Types.STRING);</span><br><span class="line"></span><br><span class="line">    DataStreamSource&lt;String&gt; stringDataStreamSource = environment.fromSource(stringDataGeneratorSource, WatermarkStrategy.noWatermarks(), <span class="string">&quot;datagen&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果要指定写入kafka的key</span></span><br><span class="line">    <span class="comment">//可以自定义反序列器:</span></span><br><span class="line">    <span class="comment">//1、实现一个接口,重写序列化方法</span></span><br><span class="line">    <span class="comment">//2、指定key,转成字节数组</span></span><br><span class="line">    <span class="comment">//3、指定value,转成 字节数组</span></span><br><span class="line">    <span class="comment">//4、返回一个ProducerRecord对象,把key、value放进去</span></span><br><span class="line"></span><br><span class="line">    KafkaSink&lt;String&gt; build = KafkaSink.&lt;String&gt;builder()</span><br><span class="line">            .setBootstrapServers(<span class="string">&quot;hadoop100:9092,hadoop101:9092,hadoop102:9092&quot;</span>)</span><br><span class="line">            .setRecordSerializer(</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">KafkaRecordSerializationSchema</span>&lt;String&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Nullable</span></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="keyword">public</span> ProducerRecord&lt;<span class="type">byte</span>[], <span class="type">byte</span>[]&gt; serialize(String s, KafkaSinkContext kafkaSinkContext, Long aLong) &#123;</span><br><span class="line">                            String[] datas = s.split(<span class="string">&quot;,&quot;</span>);</span><br><span class="line">                            <span class="type">byte</span>[] key = datas[<span class="number">0</span>].getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                            <span class="type">byte</span>[] value = s.getBytes(StandardCharsets.UTF_8);</span><br><span class="line">                            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ProducerRecord</span>&lt;&gt;(<span class="string">&quot;aaa&quot;</span>, key, value);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">            )</span><br><span class="line">            .setDeliveryGuarantee(DeliveryGuarantee.EXACTLY_ONCE)</span><br><span class="line">            .setTransactionalIdPrefix(<span class="string">&quot;xxxxxx&quot;</span>)</span><br><span class="line">            .setProperty(ProducerConfig.TRANSACTION_TIMEOUT_CONFIG, <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span> + <span class="string">&quot;&quot;</span>)</span><br><span class="line">            .build();</span><br><span class="line"></span><br><span class="line">    stringDataStreamSource.sinkTo(build);</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出到 mysql</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;<span class="number">8.0</span><span class="number">.30</span>&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.apache.flink&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;flink-connector-jdbc&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;<span class="number">1.17</span>-SNAPSHOT&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">&lt;repositories&gt;</span><br><span class="line">    &lt;repository&gt;</span><br><span class="line">        &lt;id&gt;apache-snapshots&lt;/id&gt;</span><br><span class="line">        &lt;name&gt;apache snapshots&lt;/name&gt;</span><br><span class="line">        &lt;url&gt;https:<span class="comment">//repository.apache.org/content/repositories/snapshots/&lt;/url&gt;</span></span><br><span class="line">    &lt;/repository&gt;</span><br><span class="line">&lt;/repositories&gt;</span><br><span class="line">SinkFunction&lt;WaterSensor&gt; jdbcSink = JdbcSink.sink(</span><br><span class="line">                <span class="string">&quot;insert into ws values(?,?,?)&quot;</span>,</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">JdbcStatementBuilder</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">accept</span><span class="params">(PreparedStatement preparedStatement, WaterSensor waterSensor)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">                        <span class="comment">//每收到一条WaterSensor，如何去填充占位符</span></span><br><span class="line">                        preparedStatement.setString(<span class="number">1</span>, waterSensor.getId());</span><br><span class="line">                        preparedStatement.setLong(<span class="number">2</span>, waterSensor.getTs());</span><br><span class="line">                        preparedStatement.setInt(<span class="number">3</span>, waterSensor.getVc());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;,</span><br><span class="line">                JdbcExecutionOptions.builder()</span><br><span class="line">                        .withMaxRetries(<span class="number">3</span>) <span class="comment">// 重试次数</span></span><br><span class="line">                        .withBatchSize(<span class="number">100</span>) <span class="comment">// 批次的大小：条数</span></span><br><span class="line">                        .withBatchIntervalMs(<span class="number">3000</span>) <span class="comment">// 批次的时间</span></span><br><span class="line">                        .build(),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">JdbcConnectionOptions</span>.JdbcConnectionOptionsBuilder()</span><br><span class="line">                        .withUrl(<span class="string">&quot;jdbc:mysql://hadoop102:3306/test?serverTimezone=Asia/Shanghai&amp;useUnicode=true&amp;characterEncoding=UTF-8&quot;</span>)</span><br><span class="line">                        .withUsername(<span class="string">&quot;root&quot;</span>)</span><br><span class="line">                        .withPassword(<span class="string">&quot;000000&quot;</span>)</span><br><span class="line">                        .withConnectionCheckTimeoutSeconds(<span class="number">60</span>) <span class="comment">// 重试的超时时间</span></span><br><span class="line">                        .build()</span><br><span class="line">        );</span><br><span class="line"> </span><br><span class="line"> <span class="comment">//          * TODO 写入mysql</span></span><br><span class="line"><span class="comment">//         * 1、只能用老的sink写法： addsink</span></span><br><span class="line"><span class="comment">//         * 2、JDBCSink的4个参数:</span></span><br><span class="line"><span class="comment">//         *    第一个参数： 执行的sql，一般就是 insert into</span></span><br><span class="line"><span class="comment">//         *    第二个参数： 预编译sql， 对占位符填充值</span></span><br><span class="line"><span class="comment">//         *    第三个参数： 执行选项 ---》 攒批、重试</span></span><br><span class="line"><span class="comment">//         *    第四个参数： 连接选项 ---》 url、用户名、密码</span></span><br><span class="line">        sensorDS.addSink(jdbcSink);</span><br></pre></td></tr></table></figure>
<h6 id="自定义sink"><a class="markdownIt-Anchor" href="#自定义sink">#</a> 自定义 sink</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Mysink</span> <span class="keyword">extends</span> <span class="title class_">RichSinkFunction</span>&lt;String&gt; &#123;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">(Configuration parameters)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.open(parameters);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">invoke</span><span class="params">(String value, Context context)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.invoke(value, context);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="时间和窗口"><a class="markdownIt-Anchor" href="#时间和窗口">#</a> 时间和窗口</h4>
<p>Flink 是一种流式计算引擎，主要是来处理无界数据流的，数据源源不断、无穷无尽。想要更加方便高效地处理无界流，一种方式就是将无限数据切割成有限的 &quot;数据块&quot; 进行处理，这就是所谓的 &quot;窗口&quot;(Window)。</p>
<p>在 Flink 中，窗口其实并不是一个 &quot;框&quot;, 应该把窗口理解成一个 &quot;桶&quot;。在 Flink 中，窗口可以把流切割成有限大小的多个 &quot;存储桶&quot;。每个数据都会分发到对应的桶中，当到达窗口结束时间时，就对每个桶中收集的数据进行计算处理。</p>
<p>Flink 中窗口并不是静态准备好的，而是动态创建 —— 当有落在这个窗口区间范围的数据达到时，才创建对应的窗口。</p>
<h5 id="窗口分类"><a class="markdownIt-Anchor" href="#窗口分类">#</a> 窗口分类</h5>
<p>窗口本身是截取有界数据的一种方式，所以窗口一个非常重要的信意其实就是 &quot;怎样截取数据&quot;。换句话说，就是以什么标准来开始和结束数据的截取，我们把它叫作窗口的 &quot;驱动类型&quot;。</p>
<h6 id="1按照驱动类型分"><a class="markdownIt-Anchor" href="#1按照驱动类型分">#</a> 1. 按照驱动类型分</h6>
<p>(1) 时间窗口 (TimeWindow)</p>
<p>时间窗口以时间点来定义窗口的开始 (start) 和结束 (end), 所以截取出的就是某一时间段的数据。到达结束时间时，窗口不再收集数据，触发计算输出结果，并将窗口关闭销毁。所以可以说基本思路就是 &quot;定点发车&quot;。</p>
<p>(2) 计数窗口 (CountWindow)</p>
<p>计数窗口基于元素的个数来截取数据，到达固定的个数时就触发计算并关闭窗口。每个窗口截取数据的个数，就是窗口的大小。基本思路是 &quot;人齐发车&quot;。</p>
<h6 id="2按照窗口分配数据的规则分类"><a class="markdownIt-Anchor" href="#2按照窗口分配数据的规则分类">#</a> 2. 按照窗口分配数据的规则分类</h6>
<p>（1）滚动窗口</p>
<p>滚动窗口有固定的大小，是一种对数据进行 &quot;均匀切片&quot; 的划分方式。窗口之间没有重叠，也不会有间隔，是 &quot;首尾相接&quot; 的状态。这是最简单的窗口形式，每个数据都都会被分配到一个窗口，而且只会属于一个窗口。</p>
<p>（2）滑动窗口</p>
<p>滑动窗口的大小也是固定的。但是窗口之间并不是首尾相接的，而是可以 &quot;错开&quot; 一定的位置。定义滑动窗口的参数有两个：除去窗口大小 (windowsize) 之之外，还有一个 &quot;滑动步长&quot;(windowslide), 它其实就代表了窗口计算的频率。窗口在结束时间触发计算输出结果，那么滑动步长就代表了计算频率。</p>
<p>（3）会话窗口</p>
<p>会话窗口，是基于 &quot;会话&quot;(session) 来来对数据进行分分组的。会话窗口只能基于时间来定义。</p>
<p>会话窗口中，最重要的参数就是会话的超时时间，也就是两个会话窗口之间的最小距离。如果相邻两个数据到来的时间间隔 (Gap) 小于指定的大小 (size), 那说明还在保保持会话，它们就属于同一个窗口；如果 gap 大于 size, 那么新来的数据就应该属于新的会话窗口，而前一个窗口就应该关闭了。</p>
<p>（4）全局窗口</p>
<p>“全局窗口”, 这种窗口全局有效，会把相同 key 的所有数据都分配到同一个窗口中，这种窗口没有结束的时候，默认是不会做触发计算的。如果希望它能对数据进行计算处理，还需要自定义 &quot;触发器&quot;(Trigger)。</p>
<h5 id="窗口api"><a class="markdownIt-Anchor" href="#窗口api">#</a> 窗口 API</h5>
<h6 id="带keyby和不带keyby"><a class="markdownIt-Anchor" href="#带keyby和不带keyby">#</a> 带 keyby 和不带 keyby</h6>
<p>1.1 没有 keyby 的窗口：窗口内的所有数据进入同一个子任务，并行度只能为 1     //sensorDS.windowAll ()</p>
<p>1.2 有 keyby 的窗口：每个 key 上都定义了一组窗口，各自独立地进行统计计算   //sensorDS.window ()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//1.1没有keyby的窗口:窗口内的所有数据进入同一个子任务,并行度只能为1</span></span><br><span class="line">sensorDS.windowAll()</span><br><span class="line"><span class="comment">//1.2有keyby的窗口:每个key上都定义了一组窗口,各自独立地进行统计计算</span></span><br><span class="line">基于时间的</span><br><span class="line">sensorKS.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)))<span class="comment">////滚动窗口长度10s</span></span><br><span class="line">sensorKS.window(SlidingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>),Time.seconds(<span class="number">2</span>)))<span class="comment">// 滑动窗口,窗口长度10s,滑动步长2s</span></span><br><span class="line">sensorKS.window(ProcessingTimeSessionWindows.wiithGap(Time.seconds(<span class="number">5</span>)))<span class="comment">// 会话窗口,超时间隔5s</span></span><br><span class="line"><span class="comment">//基于计数的</span></span><br><span class="line">sensorKS.countWindow(<span class="number">5</span>) <span class="comment">// 滚动窗口,窗口长度=5个元素</span></span><br><span class="line">sensorKS.countWindow(<span class="number">5</span>,<span class="number">2</span>)<span class="comment">//滑动窗口长度=5个元素,滑动步长=2个元素</span></span><br><span class="line">sensorKS.window(Globalwindows.create()),_<span class="comment">//全局窗口,计数窗口的底层就是用的这个,需要自定义触发器</span></span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224618279.png" alt="image-20240804224618279"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO 1.指定窗口分配器，用哪一种窗口</span></span><br><span class="line"><span class="comment">// 没有keyby的窗口</span></span><br><span class="line"><span class="comment">// 窗口内的所有数据进入同一个子任务,并行度只能为1</span></span><br><span class="line"><span class="comment">//waterSensorStringKeyedStream.windowAll()</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 有keyby 窗口</span></span><br><span class="line"><span class="comment">// 每个key上都定义了一组窗口,各自独立地进行统计计算</span></span><br><span class="line"><span class="comment">//waterSensorStringKeyedStream.window()</span></span><br><span class="line"><span class="comment">// 基于时间</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)));       <span class="comment">// 滚动</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window1 = waterSensorStringKeyedStream.window(SlidingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>), Time.seconds(<span class="number">2</span>)));      <span class="comment">// 滑动</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window2 = waterSensorStringKeyedStream.window(ProcessingTimeSessionWindows.withGap(Time.seconds(<span class="number">5</span>)));       <span class="comment">// 会话</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 基于计数的</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, GlobalWindow&gt; waterSensorStringGlobalWindowWindowedStream = waterSensorStringKeyedStream.countWindow(<span class="number">5</span>);   <span class="comment">// 滚动，窗口长度为5</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, GlobalWindow&gt; waterSensorStringGlobalWindowWindowedStream1 = waterSensorStringKeyedStream.countWindow(<span class="number">5</span>, <span class="number">2</span>);   <span class="comment">// 滑动，长度5 步长 2</span></span><br><span class="line">WindowedStream&lt;WaterSensor, String, GlobalWindow&gt; window3 = waterSensorStringKeyedStream.window(GlobalWindows.create());     <span class="comment">// 全局窗口，计数窗口底层，需要自定义触发器</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// TODO 2.指定窗口函数,计算逻辑</span></span><br><span class="line"><span class="comment">// 增量聚合函数：来一条算一条.窗口触发的时候输出计算结果</span></span><br><span class="line">window.reduce();</span><br><span class="line">window.aggregate();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 全窗口函数，数据来了不计算。窗口触发的时候，计算并输出</span></span><br><span class="line">window.process();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">environment.execute();</span><br></pre></td></tr></table></figure>
<h5 id="窗口函数"><a class="markdownIt-Anchor" href="#窗口函数">#</a> 窗口函数</h5>
<h6 id="增量聚合reduce"><a class="markdownIt-Anchor" href="#增量聚合reduce">#</a> 增量聚合 reduce</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 窗口的reduce</span></span><br><span class="line"><span class="comment">// 1.相同的key来的第一条数据不会调用reduce</span></span><br><span class="line"><span class="comment">// 2.增量聚合：来一条数据计算一次，不会输出</span></span><br><span class="line"><span class="comment">// 3.窗口触发的时候，才会输出窗口的最终计算结果</span></span><br><span class="line">SingleOutputStreamOperator&lt;WaterSensor&gt; reduce = window.reduce(<span class="keyword">new</span> <span class="title class_">ReduceFunction</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> WaterSensor <span class="title function_">reduce</span><span class="params">(WaterSensor waterSensor, WaterSensor t1)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用reduce，&quot;</span> + waterSensor + <span class="string">&quot;======&quot;</span> + t1);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">WaterSensor</span>(waterSensor.getId(), t1.getTs(), waterSensor.getVc() + t1.getVc());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">reduce.print();</span><br><span class="line"></span><br><span class="line">environment.execute();</span><br></pre></td></tr></table></figure>
<h6 id="聚合函数aggregate"><a class="markdownIt-Anchor" href="#聚合函数aggregate">#</a> 聚合函数 aggregate</h6>
<p>ReduceFunction 可以解决大多数归约聚合的问题，但是这个接口有一个限制，就是聚合状态的类型、输出结果的类型都必须和输入数据类型一样。</p>
<p>Flink WindowAPI 中的 aggregate 就突破了这个限制，可以定义务更加灵活的窗口聚合操作。</p>
<p>这个方法需要传入一个 AggregateFunction 的实现类作为参数。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 第一条数据来，创建窗口，创建累加器</span></span><br><span class="line">    SingleOutputStreamOperator&lt;String&gt; aggregate = window.aggregate(<span class="keyword">new</span> <span class="title class_">AggregateFunction</span>&lt;WaterSensor, Integer, String&gt;() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 输入类型</span></span><br><span class="line"><span class="comment">         * 累加器类型（存储中间结果类型）</span></span><br><span class="line"><span class="comment">         * 输出类型</span></span><br><span class="line"><span class="comment">         * pod</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">createAccumulator</span><span class="params">()</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建累加器&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">(WaterSensor waterSensor, Integer integer)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;调用add&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> integer + waterSensor.getVc();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> String <span class="title function_">getResult</span><span class="params">(Integer integer)</span> &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> integer.toString();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> Integer <span class="title function_">merge</span><span class="params">(Integer integer, Integer acc1)</span> &#123;</span><br><span class="line">            <span class="comment">// 会话窗口会用到</span></span><br><span class="line">            System.out.println(<span class="string">&quot;merge&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    aggregate.print();</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="全窗口函数"><a class="markdownIt-Anchor" href="#全窗口函数">#</a> 全窗口函数</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;String&gt; apply = window.apply(<span class="keyword">new</span> <span class="title class_">WindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> s The key for which this window is evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> window The window that is being evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> input The elements in the window being evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> out A collector for emitting elements.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">apply</span><span class="params">(String s, TimeWindow window, Iterable&lt;WaterSensor&gt; input, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;String&gt; process = window.process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> s The key for which this window is evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> context The context in which the window is being evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> elements The elements in the window being evaluated.</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> out A collector for emitting elements.</span></span><br><span class="line"><span class="comment">         * 全窗口函数计算逻辑，窗口触发是才会调用一次，统一计算</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">            <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">            <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">            DateFormatUtils.format(start,<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">            DateFormatUtils.format(end,<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line">            out.collect(elements.toString()+l);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    process.print();</span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="结合使用"><a class="markdownIt-Anchor" href="#结合使用">#</a> 结合使用</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(TumblingProcessingTimeWindows.of(Time.seconds(<span class="number">10</span>)));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 增量聚合Aggregate+全窗口process</span></span><br><span class="line"><span class="comment">     * 1、增量聚合函数处理数据:来一条计算一条</span></span><br><span class="line"><span class="comment">     * 2、窗口触发时,增量聚合的结果(只有一条)</span></span><br><span class="line"><span class="comment">     * 3、经过全窗口函数的处理包装后,输出</span></span><br><span class="line"><span class="comment">     * 传递给全窗口函数</span></span><br><span class="line"><span class="comment">     * 结合两者的优点:</span></span><br><span class="line"><span class="comment">     * 1、增量聚合:来一条计算一条,存储中间的计算结果,占用的空间少</span></span><br><span class="line"><span class="comment">     * 2、全窗口函数:可以通过上下文实现灵活的功能</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SingleOutputStreamOperator&lt;String&gt; aggregate1 = window.aggregate(<span class="keyword">new</span> <span class="title class_">MyAgg</span>(), <span class="keyword">new</span> <span class="title class_">MyProcWin</span>());</span><br><span class="line">    aggregate1.print();</span><br><span class="line"></span><br><span class="line">    environment.execute();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyAgg</span> <span class="keyword">implements</span> <span class="title class_">AggregateFunction</span>&lt;WaterSensor, Integer, String&gt; &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">createAccumulator</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;创建累加器&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">add</span><span class="params">(WaterSensor waterSensor, Integer integer)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;调用add&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> integer + waterSensor.getVc();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getResult</span><span class="params">(Integer integer)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;result&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> integer.toString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">merge</span><span class="params">(Integer integer, Integer acc1)</span> &#123;</span><br><span class="line">        <span class="comment">// 会话窗口会用到</span></span><br><span class="line">        System.out.println(<span class="string">&quot;merge&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">MyProcWin</span> <span class="keyword">extends</span> <span class="title class_">ProcessWindowFunction</span>&lt;String,String,String,TimeWindow&gt;&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;String, String, String, TimeWindow&gt;.Context context, Iterable&lt;String&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">        DateFormatUtils.format(start,<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">        DateFormatUtils.format(end,<span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line">        out.collect(elements.toString()+l);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="动态会话窗口"><a class="markdownIt-Anchor" href="#动态会话窗口">#</a> 动态会话窗口</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">    environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">    environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">    SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    WindowedStream&lt;WaterSensor, String, TimeWindow&gt; window = waterSensorStringKeyedStream.window(ProcessingTimeSessionWindows.withDynamicGap(</span><br><span class="line">            <span class="keyword">new</span> <span class="title class_">SessionWindowTimeGapExtractor</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extract</span><span class="params">(WaterSensor element)</span> &#123;</span><br><span class="line">                    <span class="comment">// 根据ts的值动态变化会话窗口</span></span><br><span class="line">                    <span class="keyword">return</span> element.getTs() * <span class="number">1000L</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="计数窗口"><a class="markdownIt-Anchor" href="#计数窗口">#</a> 计数窗口</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">        environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = localhost.keyBy(WaterSensor::getId);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 窗口分配器</span></span><br><span class="line">        <span class="comment">// 滚动，窗口长度5条数据</span></span><br><span class="line"><span class="comment">//        WindowedStream&lt;WaterSensor, String, GlobalWindow&gt; waterSensorStringGlobalWindowWindowedStream = waterSensorStringKeyedStream.countWindow(5);</span></span><br><span class="line"></span><br><span class="line">        WindowedStream&lt;WaterSensor, String, GlobalWindow&gt; waterSensorStringGlobalWindowWindowedStream = waterSensorStringKeyedStream.countWindow(<span class="number">5</span>, <span class="number">2</span>);</span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; process = waterSensorStringGlobalWindowWindowedStream.process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, GlobalWindow&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, GlobalWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">l</span> <span class="operator">=</span> context.window().maxTimestamp();</span><br><span class="line">                <span class="type">long</span> <span class="variable">l1</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line">                out.collect(l + <span class="string">&quot;===&quot;</span> + l1);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        process.print();</span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<h6 id="触发器-移除器"><a class="markdownIt-Anchor" href="#触发器-移除器">#</a> 触发器 移除器</h6>
<p>触发器：触发计算和输出</p>
<p>窗口触发：</p>
<p>时间进展 &gt;= 窗口的最大时间戳 (end-1ms)</p>
<p>移除器：</p>
<p>定义移除数据的逻辑</p>
<p>触发器和移除器都有默认实现，一般不需要自定义</p>
<blockquote>
<p>以时间类型的滚动窗口为例，分析原理:</p>
<p>TODO1、窗口什么时候触发输出？</p>
<p>时间进展 &gt;= 窗口的最大时间戳 (end-1ms)</p>
<p>TODO2、窗口是怎么划分的？</p>
<p>start = 向下取整，取窗口长度的整数倍</p>
<p>end=start + 窗口长度</p>
<p>窗口左闭右开 ==》</p>
<p>属于本窗口的最大时间戳 = end-1ms</p>
<p>TODO 3、窗口的生命周期？</p>
<p>创建：属于本窗口的第一条数据来的时候，现 new 的，放入一一个 singleton 单例的集合中</p>
<p>销毁 (关窗): 时间进展 &gt;= 窗口的最大时间戳 (end-1ms)+ 允许迟到的时间 (默认 0)</p>
</blockquote>
<h5 id="时间"><a class="markdownIt-Anchor" href="#时间">#</a> 时间</h5>
<p>事件时间：数据产生的时间</p>
<p>处理时间：数据被处理的时间</p>
<h5 id="水位线"><a class="markdownIt-Anchor" href="#水位线">#</a> 水位线</h5>
<p>具体实现上，水位线可以看作一条特殊的数据记录，它是插入到数据流中的一个标记点，主要内容就是一个时间戳！用来指示当前的事件时间。</p>
<p>2) 乱序流中的水位线</p>
<p>在分布式系统中，数据在节点间传输，会因为网络传输延迟的不确定性，导致顺序发生改变，这就是所谓的 &quot;乱序数据&quot;</p>
<p>乱序 + 数据量小：我们还是靠数据来驱动，每来一个数据就提取它的时间戳、插入一个水位线。不过现在的情况是数据乱序，所以插入新的水位线时，要先判断一了下时间戳是否比之前的大，否则就不再生成新的水位线。也就是说，只有数据的时间戳比当前时钟大，才能推动动时钟前进，这时才插入水位线。</p>
<p>乱序 + 数据量大：如果考虑到大量数据同时到来的处理效率，我们同样可以周期性地生成水位线。这时只需要保存一下之前所有数据中的最大时间戳，需要插入水位线时，就直接以它作为时间戳生成新的水位线。</p>
<p>乱序 + 迟到数据：我们无法正确处理 &quot;迟到&quot; 的数据。为了让窗口能够正确收集到迟到的数据，我们也可以等上一段时间，比如 2 秒；也就是用当前已有数据的最大大时间戳减去 2 秒，就是要插入的水位线的时间戳。这样的话，9 秒的数据到来之后，事件时钟不会直接推进到 9 秒，而是进展到了 7 秒；必须等到 11 秒的数据到来之后，事件时钟才会进展到 9 秒，这时迟到数据也都已收集齐，0~9 秒的窗口就可以正确计算结果了。</p>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224636418.png" alt="image-20240804224636418"></p>
<p>3) 水位线特性</p>
<p>水位线是插入到数据流中的一个标记，可以认为是一个特殊的数据</p>
<p>水位线主要的内容是一个时间戳，用来表示当前事件时间的进展</p>
<p>水位线是基于数据的时间戳生成的</p>
<p>水位线的时间戳必须单调递增，以确保任务的事件时间时钟一直向前推进</p>
<p>水位线可以通过设置延迟，来保证正确处理乱序数据</p>
<p>一个水位线 Watermark (t), 表示在当前流中事件时间已经达到了时间戳 t, 这代表 t 之前的所有数据都到齐了，之后流中不会出现时间戳 t’&lt;t 的数据</p>
<p>水位线是 Flink 流处理中保证结果正确性的核心机制，它往往会跟窗口一起配合，完成对乱序数据的正确处理。</p>
<p>正确理解：在 Flink 中，窗口其实并不是一个 &quot;框&quot;, 应该把窗口理解成一个 &quot;桶&quot;。在 Flink 中，窗口可以把流切割成有限大小的多个 &quot;存储桶&quot;(bucket); 每个数据都会分发到对应的桶中，当到达窗口结束时间时，就对每个桶中收集的数据进行计算处理。</p>
<h6 id="生成水位线"><a class="markdownIt-Anchor" href="#生成水位线">#</a> 生成水位线</h6>
<p>一个水位线一旦出现，就表示这个时间之前的数据已经全部到齐、之后再也不会出现了。不过如果要保证绝对正确，就必须等足够长的时间，这会带来更高的延迟。</p>
<p>内置水位线，有序流水位线</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">watermarkdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">        environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line">        WatermarkStrategy&lt;WaterSensor&gt; waterSensorWatermarkStrategy = WatermarkStrategy</span><br><span class="line">                <span class="comment">// 升序的watermark，没有等待时间</span></span><br><span class="line">                .&lt;WaterSensor&gt;forMonotonousTimestamps()</span><br><span class="line">                <span class="comment">// 指定时间传分配器</span></span><br><span class="line">                .withTimestampAssigner(<span class="keyword">new</span> <span class="title class_">SerializableTimestampAssigner</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractTimestamp</span><span class="params">(WaterSensor waterSensor, <span class="type">long</span> l)</span> &#123;</span><br><span class="line">                System.out.println(waterSensor + <span class="string">&quot;=======&quot;</span> + l);</span><br><span class="line">                <span class="keyword">return</span> waterSensor.getTs() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; waterSensorSingleOutputStreamOperator = localhost.assignTimestampsAndWatermarks(waterSensorWatermarkStrategy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">                <span class="comment">// 事件语义窗口</span></span><br><span class="line">                .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">                .process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">startTs</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">endTs</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowStart</span> <span class="operator">=</span> DateFormatUtils.format(startTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowEnd</span> <span class="operator">=</span> DateFormatUtils.format(endTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line"></span><br><span class="line">                        out.collect(windowStart + windowEnd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>内置 watermark 都是周期性生成的  environment.getConfig ().setAutoWatermarkInterval ();  默认 200 毫秒</p>
<p>有序流 watermark = 当前最大的事件时间 - 1ms</p>
<p>乱序流 watermark = 当前最大的事件时间 - 延迟时间 -1ms</p>
<p>升序 watermark 就是等待时间为 0 的乱序 watermark</p>
<p>乱序流设置水位线</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.time.Duration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">watermarkOOOdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">        environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line">        WatermarkStrategy&lt;WaterSensor&gt; waterSensorWatermarkStrategy = WatermarkStrategy</span><br><span class="line">                <span class="comment">// 乱序的watermark，等三秒</span></span><br><span class="line">                .&lt;WaterSensor&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">                <span class="comment">// 指定时间传分配器</span></span><br><span class="line">                .withTimestampAssigner(<span class="keyword">new</span> <span class="title class_">SerializableTimestampAssigner</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractTimestamp</span><span class="params">(WaterSensor waterSensor, <span class="type">long</span> l)</span> &#123;</span><br><span class="line">                System.out.println(waterSensor + <span class="string">&quot;=======&quot;</span> + l);</span><br><span class="line">                <span class="keyword">return</span> waterSensor.getTs() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; waterSensorSingleOutputStreamOperator = localhost.assignTimestampsAndWatermarks(waterSensorWatermarkStrategy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">                <span class="comment">// 事件语义窗口</span></span><br><span class="line">                .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">                .process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">startTs</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">endTs</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowStart</span> <span class="operator">=</span> DateFormatUtils.format(startTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowEnd</span> <span class="operator">=</span> DateFormatUtils.format(endTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line"></span><br><span class="line">                        out.collect(windowStart + windowEnd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>水位线生成器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPeriodWaterMark</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">WatermarkGenerator</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">long</span> maxTs;</span><br><span class="line">    <span class="comment">// 保存当前为止最大时间</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">long</span> delayTs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPeriodWaterMark</span><span class="params">(<span class="type">long</span> delayTs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delayTs = delayTs;</span><br><span class="line">        <span class="built_in">this</span>.maxTs = Long.MIN_VALUE + <span class="built_in">this</span>.delayTs + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(T t, <span class="type">long</span> l, WatermarkOutput watermarkOutput)</span> &#123;</span><br><span class="line">        maxTs = Math.max(maxTs, l);</span><br><span class="line">        System.out.println(<span class="string">&quot;最大时间穿&quot;</span> + maxTs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPeriodicEmit</span><span class="params">(WatermarkOutput watermarkOutput)</span> &#123;</span><br><span class="line">        watermarkOutput.emitWatermark(<span class="keyword">new</span> <span class="title class_">Watermark</span>(maxTs-delayTs -<span class="number">1</span>));</span><br><span class="line">        System.out.println(maxTs-delayTs -<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">watermarkCuustomdemo</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">StreamExecutionEnvironment</span> <span class="variable">environment</span> <span class="operator">=</span> StreamExecutionEnvironment.getExecutionEnvironment();</span><br><span class="line"></span><br><span class="line">        environment.setParallelism(<span class="number">1</span>);</span><br><span class="line">        environment.enableCheckpointing(<span class="number">2000</span>, CheckpointingMode.EXACTLY_ONCE);</span><br><span class="line"></span><br><span class="line">        environment.getConfig().setAutoWatermarkInterval(<span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>());</span><br><span class="line"></span><br><span class="line">        WatermarkStrategy&lt;WaterSensor&gt; waterSensorWatermarkStrategy = WatermarkStrategy</span><br><span class="line">                <span class="comment">// 指定自定义生成器</span></span><br><span class="line">                .&lt;WaterSensor&gt;forGenerator(<span class="keyword">new</span> <span class="title class_">WatermarkGeneratorSupplier</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> WatermarkGenerator&lt;WaterSensor&gt; <span class="title function_">createWatermarkGenerator</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MyPeriodWaterMark</span>&lt;&gt;(<span class="number">3000L</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="comment">// 指定时间传分配器</span></span><br><span class="line">                .withTimestampAssigner(<span class="keyword">new</span> <span class="title class_">SerializableTimestampAssigner</span>&lt;WaterSensor&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="type">long</span> <span class="title function_">extractTimestamp</span><span class="params">(WaterSensor waterSensor, <span class="type">long</span> l)</span> &#123;</span><br><span class="line">                System.out.println(waterSensor + <span class="string">&quot;=======&quot;</span> + l);</span><br><span class="line">                <span class="keyword">return</span> waterSensor.getTs() * <span class="number">1000L</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;WaterSensor&gt; waterSensorSingleOutputStreamOperator = localhost.assignTimestampsAndWatermarks(waterSensorWatermarkStrategy);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        SingleOutputStreamOperator&lt;String&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">                <span class="comment">// 事件语义窗口</span></span><br><span class="line">                .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">                .process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                        <span class="type">long</span> <span class="variable">startTs</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">                        <span class="type">long</span> <span class="variable">endTs</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowStart</span> <span class="operator">=</span> DateFormatUtils.format(startTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                        <span class="type">String</span> <span class="variable">windowEnd</span> <span class="operator">=</span> DateFormatUtils.format(endTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line"></span><br><span class="line">                        out.collect(windowStart + windowEnd);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        environment.execute();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h6 id="断点式水位线生成器"><a class="markdownIt-Anchor" href="#断点式水位线生成器">#</a> 断点式水位线生成器</h6>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MyPuntuatedPeriodWaterMark</span>&lt;T&gt; <span class="keyword">implements</span> <span class="title class_">WatermarkGenerator</span>&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">long</span> maxTs;</span><br><span class="line">    <span class="comment">// 保存当前为止最大时间</span></span><br><span class="line">    <span class="keyword">private</span>  <span class="type">long</span> delayTs;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MyPuntuatedPeriodWaterMark</span><span class="params">(<span class="type">long</span> delayTs)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.delayTs = delayTs;</span><br><span class="line">        <span class="built_in">this</span>.maxTs = Long.MIN_VALUE + <span class="built_in">this</span>.delayTs + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onEvent</span><span class="params">(T t, <span class="type">long</span> l, WatermarkOutput watermarkOutput)</span> &#123;</span><br><span class="line">        maxTs = Math.max(maxTs, l);</span><br><span class="line">        watermarkOutput.emitWatermark(<span class="keyword">new</span> <span class="title class_">Watermark</span>(maxTs - delayTs - <span class="number">1</span>));</span><br><span class="line">        System.out.println( maxTs);</span><br><span class="line">        System.out.println( maxTs - delayTs - <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onPeriodicEmit</span><span class="params">(WatermarkOutput watermarkOutput)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">WatermarkStrategy&lt;WaterSensor&gt; waterSensorWatermarkStrategy = WatermarkStrategy</span><br><span class="line">        <span class="comment">// 指定自定义生成器</span></span><br><span class="line">        .&lt;WaterSensor&gt;forGenerator(ctx -&gt; <span class="keyword">new</span> <span class="title class_">MyPuntuatedPeriodWaterMark</span>&lt;&gt;(<span class="number">3000L</span>))</span><br></pre></td></tr></table></figure>
<h6 id="水位线传递"><a class="markdownIt-Anchor" href="#水位线传递">#</a> 水位线传递</h6>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224656483.png" alt="image-20240804224656483"></p>
<p>收到上游多个，取最小</p>
<p>往下游多个发送，广播</p>
<p>空闲等待：超过时间上有还没水位过来，后续不使用</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;Integer&gt; localhost = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>)</span><br><span class="line">        .partitionCustom(<span class="keyword">new</span> <span class="title class_">MyPart</span>(), r -&gt; r)</span><br><span class="line">        .map(Integer::parseInt)</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy</span><br><span class="line">                .&lt;Integer&gt;forMonotonousTimestamps()</span><br><span class="line">                .withTimestampAssigner((r, ts) -&gt; r * <span class="number">1000L</span>)</span><br><span class="line">                <span class="comment">// 空闲等待五秒</span></span><br><span class="line">                .withIdleness(Duration.ofSeconds(<span class="number">5</span>)));</span><br></pre></td></tr></table></figure>
<p>允许迟到</p>
<p>推迟关窗时间，在关窗之前，会计算迟到数据，来一条计算一次。</p>
<p>关窗口迟到数据不会被计算</p>
<p>乱序：数据顺序乱了，出现时间小的比时间大的后来</p>
<p>迟到：当前数据的时间戳 &lt; 当前的 watermark</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;String&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">        <span class="comment">// 事件语义窗口</span></span><br><span class="line">        .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">        .allowedLateness(Time.seconds(<span class="number">2</span>))   <span class="comment">// 允许推迟两秒关窗</span></span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">startTs</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">                <span class="type">long</span> <span class="variable">endTs</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">                <span class="type">String</span> <span class="variable">windowStart</span> <span class="operator">=</span> DateFormatUtils.format(startTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">windowEnd</span> <span class="operator">=</span> DateFormatUtils.format(endTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line"></span><br><span class="line">                out.collect(windowStart + windowEnd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
<p>侧输出流</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">OutputTag&lt;WaterSensor&gt; latedata = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;latedata&quot;</span>, Types.POJO(WaterSensor.class));</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">        <span class="comment">// 事件语义窗口</span></span><br><span class="line">        .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">10</span>)))</span><br><span class="line">        .allowedLateness(Time.seconds(<span class="number">2</span>))   <span class="comment">// 允许推迟两秒关窗</span></span><br><span class="line">        <span class="comment">// 关窗后迟到数据放入侧输出流</span></span><br><span class="line">        .sideOutputLateData(latedata)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">ProcessWindowFunction</span>&lt;WaterSensor, String, String, TimeWindow&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">process</span><span class="params">(String s, ProcessWindowFunction&lt;WaterSensor, String, String, TimeWindow&gt;.Context context, Iterable&lt;WaterSensor&gt; elements, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="type">long</span> <span class="variable">startTs</span> <span class="operator">=</span> context.window().getStart();</span><br><span class="line">                <span class="type">long</span> <span class="variable">endTs</span> <span class="operator">=</span> context.window().getEnd();</span><br><span class="line">                <span class="type">String</span> <span class="variable">windowStart</span> <span class="operator">=</span> DateFormatUtils.format(startTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line">                <span class="type">String</span> <span class="variable">windowEnd</span> <span class="operator">=</span> DateFormatUtils.format(endTs, <span class="string">&quot;yyyy-MM-dd HH:mm:ss.SSS&quot;</span>);</span><br><span class="line"></span><br><span class="line">                <span class="type">long</span> <span class="variable">count</span> <span class="operator">=</span> elements.spliterator().estimateSize();</span><br><span class="line"></span><br><span class="line">                out.collect(windowStart + windowEnd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// 从主流获取侧输出流打印</span></span><br><span class="line">        process.getSideOutput(latedata).printToErr();</span><br><span class="line">        process.print();</span><br></pre></td></tr></table></figure>
<p><img data-src="https://kbshire-1308981697.cos.ap-shanghai.myqcloud.com/img/image-20240804224716145.png" alt="image-20240804224716145"></p>
<h5 id="合流-2"><a class="markdownIt-Anchor" href="#合流-2">#</a> 合流</h5>
<h6 id="基于时间的合流-双流联结"><a class="markdownIt-Anchor" href="#基于时间的合流-双流联结">#</a> 基于时间的合流 - 双流联结</h6>
<p>窗口联结</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; operator1 = environment.fromElements(Tuple2.of(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>),Tuple2.of(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>),Tuple2.of(<span class="string">&quot;c&quot;</span>, <span class="number">1</span>))</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy</span><br><span class="line">                .&lt;Tuple2&lt;String, Integer&gt;&gt;forMonotonousTimestamps()</span><br><span class="line">                .withTimestampAssigner((value, ts) -&gt; value.f1 * <span class="number">1000L</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Tuple3&lt;String, Integer, Integer&gt;&gt; operator2 = environment.fromElements(Tuple3.of(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">11</span>), Tuple3.of(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">22</span>), Tuple3.of(<span class="string">&quot;c&quot;</span>, <span class="number">1</span>, <span class="number">33</span>))</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy</span><br><span class="line">                .&lt;Tuple3&lt;String, Integer, Integer&gt;&gt;forMonotonousTimestamps()</span><br><span class="line">                .withTimestampAssigner((value, ts) -&gt; value.f1 * <span class="number">1000L</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 落在同一个时间范围内才能匹配</span></span><br><span class="line"><span class="comment">// 根据keyby的key，来进行关联</span></span><br><span class="line"><span class="comment">// 只能拿到匹配上的数据，类似inner join</span></span><br><span class="line">DataStream&lt;String&gt; apply = operator1.join(operator2)</span><br><span class="line">        .where(r1 -&gt; r1.f0)</span><br><span class="line">        .equalTo(r2 -&gt; r2.f0)</span><br><span class="line">        .window(TumblingEventTimeWindows.of(Time.seconds(<span class="number">5</span>)))</span><br><span class="line">        .apply(<span class="keyword">new</span> <span class="title class_">JoinFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Tuple3&lt;String, Integer, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 关联上的数据，调用join</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> stringIntegerTuple2</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> stringIntegerIntegerTuple3</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> String <span class="title function_">join</span><span class="params">(Tuple2&lt;String, Integer&gt; stringIntegerTuple2, Tuple3&lt;String, Integer, Integer&gt; stringIntegerIntegerTuple3)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="keyword">return</span> stringIntegerTuple2 + <span class="string">&quot;&quot;</span> + stringIntegerIntegerTuple3;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">apply.print();</span><br></pre></td></tr></table></figure>
<p>间隔联结</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;Tuple2&lt;String, Integer&gt;&gt; operator1 = environment.fromElements(Tuple2.of(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>),Tuple2.of(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>),Tuple2.of(<span class="string">&quot;c&quot;</span>, <span class="number">1</span>))</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy</span><br><span class="line">                .&lt;Tuple2&lt;String, Integer&gt;&gt;forMonotonousTimestamps()</span><br><span class="line">                .withTimestampAssigner((value, ts) -&gt; value.f1 * <span class="number">1000L</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;Tuple3&lt;String, Integer, Integer&gt;&gt; operator2 = environment.fromElements(Tuple3.of(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">11</span>), Tuple3.of(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">22</span>), Tuple3.of(<span class="string">&quot;c&quot;</span>, <span class="number">1</span>, <span class="number">33</span>))</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy</span><br><span class="line">                .&lt;Tuple3&lt;String, Integer, Integer&gt;&gt;forMonotonousTimestamps()</span><br><span class="line">                .withTimestampAssigner((value, ts) -&gt; value.f1 * <span class="number">1000L</span>));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">KeyedStream&lt;Tuple2&lt;String, Integer&gt;, String&gt; tuple2StringKeyedStream = operator1.keyBy(r2 -&gt; r2.f0);</span><br><span class="line">KeyedStream&lt;Tuple3&lt;String, Integer, Integer&gt;, String&gt; tuple3StringKeyedStream = operator2.keyBy(r2 -&gt; r2.f0);</span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; process = tuple2StringKeyedStream.intervalJoin(tuple3StringKeyedStream)</span><br><span class="line">        .between(Time.seconds(-<span class="number">2</span>), Time.seconds(<span class="number">2</span>))</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">ProcessJoinFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Tuple3&lt;String, Integer, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 两条流数据匹配，调用方法</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> left The left element of the joined pair.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> right The right element of the joined pair.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> ctx A context that allows querying the timestamps of the left, right and joined pair.</span></span><br><span class="line"><span class="comment">             *     In addition, this context allows to emit elements on a side output.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> out The collector to emit resulting elements to.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(Tuple2&lt;String, Integer&gt; left, Tuple3&lt;String, Integer, Integer&gt; right, ProcessJoinFunction&lt;Tuple2&lt;String, Integer&gt;, Tuple3&lt;String, Integer, Integer&gt;, String&gt;.Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                out.collect(left + <span class="string">&quot;=====&quot;</span> + right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">process.print();</span><br></pre></td></tr></table></figure>
<p>处理迟到数据</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">KeyedStream&lt;Tuple2&lt;String, Integer&gt;, String&gt; tuple2StringKeyedStream = operator1.keyBy(r2 -&gt; r2.f0);</span><br><span class="line">KeyedStream&lt;Tuple3&lt;String, Integer, Integer&gt;, String&gt; tuple3StringKeyedStream = operator2.keyBy(r2 -&gt; r2.f0);</span><br><span class="line"></span><br><span class="line">OutputTag&lt;Tuple2&lt;String, Integer&gt;&gt; tupleOutputTag = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;ks1-late&quot;</span>, Types.TUPLE(Types.STRING, Types.INT));</span><br><span class="line">OutputTag&lt;Tuple3&lt;String, Integer, Integer&gt;&gt; tupleOutputTag2 = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;ks2-late&quot;</span>, Types.TUPLE(Types.STRING, Types.INT, Types.INT));</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; process = tuple2StringKeyedStream.intervalJoin(tuple3StringKeyedStream)</span><br><span class="line">        .between(Time.seconds(-<span class="number">2</span>), Time.seconds(<span class="number">2</span>))</span><br><span class="line">        .sideOutputLeftLateData(tupleOutputTag)</span><br><span class="line">        .sideOutputRightLateData(tupleOutputTag2)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">ProcessJoinFunction</span>&lt;Tuple2&lt;String, Integer&gt;, Tuple3&lt;String, Integer, Integer&gt;, String&gt;() &#123;</span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 两条流数据匹配，调用方法</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> left The left element of the joined pair.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> right The right element of the joined pair.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> ctx A context that allows querying the timestamps of the left, right and joined pair.</span></span><br><span class="line"><span class="comment">             *     In addition, this context allows to emit elements on a side output.</span></span><br><span class="line"><span class="comment">             * <span class="doctag">@param</span> out The collector to emit resulting elements to.</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(Tuple2&lt;String, Integer&gt; left, Tuple3&lt;String, Integer, Integer&gt; right, ProcessJoinFunction&lt;Tuple2&lt;String, Integer&gt;, Tuple3&lt;String, Integer, Integer&gt;, String&gt;.Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                out.collect(left + <span class="string">&quot;=====&quot;</span> + right);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">process.getSideOutput(tupleOutputTag).printToErr();</span><br><span class="line">process.getSideOutput(tupleOutputTag2).printToErr();</span><br><span class="line">process.print();</span><br></pre></td></tr></table></figure>
<h4 id="处理函数"><a class="markdownIt-Anchor" href="#处理函数">#</a> 处理函数</h4>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">KeyedStream&lt;WaterSensor, String&gt; waterSensorStringKeyedStream = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId);</span><br><span class="line">SingleOutputStreamOperator&lt;String&gt; process = waterSensorStringKeyedStream.process(<span class="keyword">new</span> <span class="title class_">KeyedProcessFunction</span>&lt;String, WaterSensor, String&gt;() &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> value The input value.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx A &#123;<span class="doctag">@link</span> Context&#125; that allows querying the timestamp of the element and getting a</span></span><br><span class="line"><span class="comment">     *     &#123;<span class="doctag">@link</span> TimerService&#125; for registering timers and querying the time. The context is only</span></span><br><span class="line"><span class="comment">     *     valid during the invocation of this method, do not store it.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(WaterSensor value, KeyedProcessFunction&lt;String, WaterSensor, String&gt;.Context ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">// 提取事件事件</span></span><br><span class="line">        <span class="type">Long</span> <span class="variable">timestamp</span> <span class="operator">=</span> ctx.timestamp();</span><br><span class="line">        <span class="comment">// 定时器</span></span><br><span class="line">        <span class="type">TimerService</span> <span class="variable">timerService</span> <span class="operator">=</span> ctx.timerService();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 注册定时器</span></span><br><span class="line">        timerService.registerEventTimeTimer(<span class="number">5000L</span>);</span><br><span class="line">        System.out.println(timestamp + <span class="string">&quot;===&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> timestamp The timestamp of the firing timer.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> ctx An &#123;<span class="doctag">@link</span> OnTimerContext&#125; that allows querying the timestamp, the &#123;<span class="doctag">@link</span></span></span><br><span class="line"><span class="comment">     *     TimeDomain&#125;, and the key of the firing timer and getting a &#123;<span class="doctag">@link</span> TimerService&#125; for</span></span><br><span class="line"><span class="comment">     *     registering timers and querying the time. The context is only valid during the invocation</span></span><br><span class="line"><span class="comment">     *     of this method, do not store it.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> out The collector for returning result values.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onTimer</span><span class="params">(<span class="type">long</span> timestamp, KeyedProcessFunction&lt;String, WaterSensor, String&gt;.OnTimerContext ctx, Collector&lt;String&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="built_in">super</span>.onTimer(timestamp, ctx, out);</span><br><span class="line">        System.out.println(timestamp + <span class="string">&quot;=======---&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>定时器：</p>
<p>keyed 才有</p>
<p>事件时间定时器，通过 watermark 触发</p>
<p>watermark &gt;=  注册时间</p>
<p>watermark = 当前最大时间 - 等待时间 - 1</p>
<p>在 process 中获取 watermark，显示的上一次的 watermaark，因为 process 还没收到这条新数据的 watermark</p>
<h5 id="侧输出流"><a class="markdownIt-Anchor" href="#侧输出流">#</a> 侧输出流</h5>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">SingleOutputStreamOperator&lt;WaterSensor&gt; waterSensorSingleOutputStreamOperator = environment.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">7777</span>).map(<span class="keyword">new</span> <span class="title class_">WaterSensorMapFunction</span>())</span><br><span class="line">        .assignTimestampsAndWatermarks(WatermarkStrategy.&lt;WaterSensor&gt;forBoundedOutOfOrderness(Duration.ofSeconds(<span class="number">3</span>))</span><br><span class="line">                .withTimestampAssigner((ele, ts) -&gt; ele.getTs() * <span class="number">1000L</span>));</span><br><span class="line"></span><br><span class="line">OutputTag&lt;String&gt; warn11 = <span class="keyword">new</span> <span class="title class_">OutputTag</span>&lt;&gt;(<span class="string">&quot;warn&quot;</span>, Types.STRING);</span><br><span class="line"></span><br><span class="line">SingleOutputStreamOperator&lt;WaterSensor&gt; process = waterSensorSingleOutputStreamOperator.keyBy(WaterSensor::getId)</span><br><span class="line">        .process(<span class="keyword">new</span> <span class="title class_">KeyedProcessFunction</span>&lt;String, WaterSensor, WaterSensor&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processElement</span><span class="params">(WaterSensor value, KeyedProcessFunction&lt;String, WaterSensor, WaterSensor&gt;.Context ctx, Collector&lt;WaterSensor&gt; out)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                <span class="comment">// 侧输出流</span></span><br><span class="line">                <span class="keyword">if</span> (value.getVc() &gt; <span class="number">10</span>) &#123;</span><br><span class="line">                    ctx.output(warn11, <span class="string">&quot;sss&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// 主流</span></span><br><span class="line">                out.collect(value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">process.getSideOutput(warn11).printToErr();</span><br><span class="line">process.print();</span><br></pre></td></tr></table></figure>
<h4 id="状态管理"><a class="markdownIt-Anchor" href="#状态管理">#</a> 状态管理</h4>
<p>在 Flink 中，算子任务可以分为无状态和有状态两种情况。</p>
<p>无状态的算子任务只需要观察每个独立事件，根据当前输入的数故据直接转换输出结果。我们之前讲到的基本转换算子，如 map、filter、flatMap, 计算时不依赖其他数据，就都属于无状态的算子。</p>
<p>而有状态的算子任务，则除当前数据之外，还需要一些其他也数据来得到计算结果。这里的 &quot;其他数据&quot;, 就是所谓的状态 (state)。我们之前讲到的算子中，聚合算子、窗口算子都属于有状态的算子。</p>
<p><strong>托管状态（Managed State）和原始状态（Raw State）</strong></p>
<p>Flink 的状态有两种：托管状态（Managed State）和原始状态（Raw State）。托管状态就是由 Flink 统一管理的，状态的存储访问、故障恢复和重组等一系列问题都由 Flink 实现，我们只要调接口就可以；而原始状态则是自定义的，相当于就是开辟了一块内存，需要我们自己管理，实现状态的序列化和故障恢复。</p>
<p>通常我们采用 Flink 托管状态来实现需求。</p>
<p>托管状态分为算子状态和按键分区状态</p>
<p>keyby 后的是按键分区状态，其他称为算子状态</p>
<p><strong>算子状态（Operator State）和按键分区状态（Keyed State）</strong></p>
<p>接下来我们的重点就是托管状态（Managed State）。</p>
<p>我们知道在 Flink 中，一个算子任务会按照并行度分为多个并行子任务执行，而不同的子任务会占据不同的任务槽（task slot）。由于不同的 slot 在计算资源上是物理隔离的，所以 Flink 能管理的状态在并行任务间是无法共享的，每个状态只能针对当前子任务的实例有效。</p>
<p>而很多有状态的操作（比如聚合、窗口）都是要先做 keyBy 进行按键分区的。按键分区之后，任务所进行的所有计算都应该只针对当前 key 有效，所以状态也应该按照 key 彼此隔离。在这种情况下，状态的访问方式又会有所不同。</p>
<p>基于这样的想法，我们又可以将托管状态分为两类：算子状态和按键分区状态。</p>
<p>算子状态可以用在所有算子上，使用的时候其实就跟一个本地变量没什么区别–因为本地变量的作用域也是当前任务实例。在使用时，我们还需进一步实现 ChneckpointedFunction 接口。</p>
<h4 id="容错机制"><a class="markdownIt-Anchor" href="#容错机制">#</a> 容错机制</h4>
<p>在流处理中，我们可以用存档读档的思路，就是将之前某个日时间点所有的状态保存下来，这份 &quot;存档&quot; 就是所谓的 &quot;检查点&quot;(checkpoint)。</p>
<p><strong>1）周期性的触发保存</strong></p>
<p>“随时存档” 确实恢复起来方便，可是需要我们不停地做存档操作。如果每处理一条数据就进行检查点的保存，当大量数据同时到来时，就会耗费很多资源来频繁做检查点，数据处理的速度就会受到影响。所以在 Flink 中，检查点的保存是周期性触发的，间隔时间可以进行设置。</p>
<p><strong>2）保存的时间点</strong></p>
<p>我们应该在所有任务（算子）都恰好处理完一个相同的输入数据的时候，将它们的状态保存下来。</p>
<p>这样做可以实现一个数据被所有任务（算子）完整地处理完，状态得到了保存。</p>
<p>如果出现故障，我们恢复到之前保存的状态，故障时正在处理的所有数据都需要重新处理；我们只需要让源（source）任务向数据源重新提交偏移量、请求重放数据就可以了。当然这需要源任务可以把偏移量作为算子状态保存下来，而且外部数据源能够重置偏移量</p>
<p>当发生故障时，就需要找到最近一次成功保存的检查点来恢复状态。</p>
<p>(1) 重启应用</p>
<p>遇到故障之后，第一步当然就是重启。我们将应用重新启动动后，所有任务的状态会清空。</p>
<p>(2) 读取检查点，重置状态</p>
<p>找到最近一次保存的检查点，从中读出每个算子任务状态的快照，分别填充到对应的状态中。这样，Flink 内部所有任务的状态，就恢复到了保存检查点的那一时刻，也就是刚好处理完第三个数据的时候。</p>
<p>(3) 重置偏移量</p>
<p>从检查点恢复状态后还有一个问题：如果直接继续处理数据，那么保存检查点之后、到发生故障这段时间内的数据，也就是第 4、5 个数据就相当于丢掉了；这会造成计算结果的错误。</p>
<p>为了不丢数据，我们应该从保存检查点后开始重新读取数据，这可以通过 Source 任务向外部数据源重新提交偏移量 (offset) 来实现。</p>
<p>(4) 继续处理数据</p>
<p>接下来，我们就可以正常处理数据了。首先是重放第 4、5 个一数据，然后继续读取后面的数据。</p>
<h4 id="flink-sql"><a class="markdownIt-Anchor" href="#flink-sql">#</a> Flink SQL</h4>

      <div class="tags">
          <a href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/" rel="tag"><i class="ic i-tag"></i> 大数据</a>
      </div>
  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">Edited on</span>
    <time title="Modified: 2024-08-04 23:29:24" itemprop="dateModified" datetime="2024-08-04T23:29:24+08:00">2024-08-04</time>
  </span>
</div>

      
<div class="reward">
  <button><i class="ic i-heartbeat"></i> Donate</button>
  <p>Give me a cup of [coffee]~(￣▽￣)~*</p>
  <div id="qr">
      
      <div>
        <img data-src="/images/wechatpay.png" alt="John Doe WeChat Pay">
        <p>WeChat Pay</p>
      </div>
      
      <div>
        <img data-src="/images/alipay.png" alt="John Doe Alipay">
        <p>Alipay</p>
      </div>
      
      <div>
        <img data-src="/images/paypal.png" alt="John Doe PayPal">
        <p>PayPal</p>
      </div>
  </div>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>Post author:  </strong>John Doe <i class="ic i-at"><em>@</em></i>Hexo
  </li>
  <li class="link">
    <strong>Post link: </strong>
    <a href="http://example.com/2024/05/01/hive_flink/" title="hive_flink">http://example.com/2024/05/01/hive_flink/</a>
  </li>
  <li class="license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2024/04/01/spark/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;74f81cade89fd386a6972382481bd355.jpg" title="spark">
  <span class="type">Previous Post</span>
  <span class="category"><i class="ic i-flag"></i> 大数据</span>
  <h3>spark</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2024/06/01/openstack/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;img.timelessq.com&#x2F;images&#x2F;2022&#x2F;07&#x2F;26&#x2F;a8d0ac76b87f7593653e29559d61b32d.jpg" title="OpenStack+openvswitch">
  <span class="type">Next Post</span>
  <span class="category"><i class="ic i-flag"></i> 运维</span>
  <h3>OpenStack+openvswitch</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="Contents">
          <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#hive"><span class="toc-number">1.</span> <span class="toc-text"> hive</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E5%8C%96%E5%AE%89%E8%A3%85"><span class="toc-number">1.1.</span> <span class="toc-text"> 最小化安装</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#mysql-hive"><span class="toc-number">1.2.</span> <span class="toc-text"> mysql-hive</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hiveserver2"><span class="toc-number">1.3.</span> <span class="toc-text"> hiveserver2</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E6%A8%A1%E6%8B%9F%E5%8A%9F%E8%83%BD"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 用户模拟功能</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#metastore"><span class="toc-number">1.4.</span> <span class="toc-text"> metastore</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8B%AC%E7%AB%8B%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="toc-number">1.4.1.</span> <span class="toc-text"> 独立模式部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ddl"><span class="toc-number">1.5.</span> <span class="toc-text"> DDL</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%93%E6%93%8D%E4%BD%9C"><span class="toc-number">1.5.1.</span> <span class="toc-text"> 库操作</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BB%BA%E8%A1%A8"><span class="toc-number">1.5.2.</span> <span class="toc-text"> 建表</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#flink"><span class="toc-number">2.</span> <span class="toc-text"> flink</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#wordcount"><span class="toc-number">2.1.</span> <span class="toc-text"> wordcount</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#flink-%E9%83%A8%E7%BD%B2"><span class="toc-number">2.2.</span> <span class="toc-text"> flink 部署</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#web%E6%8F%90%E4%BA%A4%E4%BB%BB%E5%8A%A1"><span class="toc-number">2.2.1.</span> <span class="toc-text"> web 提交任务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.</span> <span class="toc-text"> 部署模式</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.1.</span> <span class="toc-text"> 会话模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E4%BD%9C%E4%B8%9A%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.2.</span> <span class="toc-text"> 单作业模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.3.</span> <span class="toc-text"> 应用模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#standlone-%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.4.</span> <span class="toc-text"> standlone 模式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#yarn%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.5.</span> <span class="toc-text"> yarn 模式</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#yarn-%E4%BC%9A%E8%AF%9D%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.5.1.</span> <span class="toc-text"> yarn - 会话模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yarn-%E5%8D%95%E4%BD%9C%E4%B8%9A%E6%A8%A1%E5%BC%8F"><span class="toc-number">2.3.5.2.</span> <span class="toc-text"> yarn - 单作业模式</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yarn-%E5%BA%94%E7%94%A8%E6%A8%A1%E5%BC%8F%E9%83%A8%E7%BD%B2"><span class="toc-number">2.3.5.3.</span> <span class="toc-text"> yarn - 应用模式部署</span></a></li></ol></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84"><span class="toc-number">2.4.</span> <span class="toc-text"> 系统架构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B6%E8%A1%8C%E5%BA%A6"><span class="toc-number">2.4.1.</span> <span class="toc-text"> 并行度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%AE%97%E5%AD%90%E9%93%BE"><span class="toc-number">2.4.2.</span> <span class="toc-text"> 算子链</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%BB%E5%8A%A1%E6%A7%BD"><span class="toc-number">2.4.3.</span> <span class="toc-text"> 任务槽</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BD%9C%E4%B8%9A%E6%8F%90%E4%BA%A4%E6%B5%81%E7%A8%8B"><span class="toc-number">2.4.4.</span> <span class="toc-text"> 作业提交流程</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#standalone"><span class="toc-number">2.4.4.1.</span> <span class="toc-text"> standalone</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#yarn"><span class="toc-number">2.4.4.2.</span> <span class="toc-text"> yarn</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#datastream-api"><span class="toc-number">2.4.5.</span> <span class="toc-text"> datastream api</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%89%A7%E8%A1%8C%E7%8E%AF%E5%A2%83"><span class="toc-number">2.4.5.1.</span> <span class="toc-text"> 执行环境</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">2.4.5.2.</span> <span class="toc-text"> 读取数据</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E4%BB%8E%E9%9B%86%E5%90%88%E8%AF%BB%E5%8F%96%E6%95%B0%E6%8D%AE"><span class="toc-number">2.4.5.2.1.</span> <span class="toc-text"> 从集合读取数据</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.5.2.2.</span> <span class="toc-text"> 文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#kafka"><span class="toc-number">2.4.5.2.3.</span> <span class="toc-text"> kafka</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E7%94%9F%E6%88%90%E5%99%A8%E8%AF%BB%E5%8F%96"><span class="toc-number">2.4.5.2.4.</span> <span class="toc-text"> 数据生成器读取</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#flink-%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="toc-number">2.4.5.3.</span> <span class="toc-text"> flink 数据类型</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BD%AC%E6%8D%A2%E7%AE%97%E5%AD%90"><span class="toc-number">2.4.6.</span> <span class="toc-text"> 转换算子</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#map"><span class="toc-number">2.4.6.1.</span> <span class="toc-text"> map</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#fliter-flatmap"><span class="toc-number">2.4.6.2.</span> <span class="toc-text"> fliter \ flatmap</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#keyby"><span class="toc-number">2.4.6.3.</span> <span class="toc-text"> keyby</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AE%80%E5%8D%95%E8%81%9A%E5%90%88%E7%AE%97%E5%AD%90"><span class="toc-number">2.4.6.4.</span> <span class="toc-text"> 简单聚合算子</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#reduce"><span class="toc-number">2.4.6.5.</span> <span class="toc-text"> reduce</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#udf"><span class="toc-number">2.4.6.6.</span> <span class="toc-text"> UDF</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#richxxxfunction"><span class="toc-number">2.4.6.7.</span> <span class="toc-text"> RichXXXFunction</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E5%8C%BA%E7%AE%97%E5%AD%90"><span class="toc-number">2.4.6.8.</span> <span class="toc-text"> 分区算子</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89%E5%88%86%E5%8C%BA%E5%99%A8"><span class="toc-number">2.4.6.9.</span> <span class="toc-text"> 自定义分区器</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%88%86%E6%B5%81"><span class="toc-number">2.4.6.10.</span> <span class="toc-text"> 分流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E6%B5%81"><span class="toc-number">2.4.6.11.</span> <span class="toc-text"> 合流</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#sink"><span class="toc-number">2.4.6.12.</span> <span class="toc-text"> sink</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0%E5%A4%96%E9%83%A8%E7%B3%BB%E7%BB%9F"><span class="toc-number">2.4.6.12.1.</span> <span class="toc-text"> 输出到外部系统</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0%E6%96%87%E4%BB%B6"><span class="toc-number">2.4.6.12.2.</span> <span class="toc-text"> 输出到文件</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%BE%93%E5%87%BA%E5%88%B0kafka"><span class="toc-number">2.4.6.12.3.</span> <span class="toc-text"> 输出到 kafka</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%87%AA%E5%AE%9A%E4%B9%89sink"><span class="toc-number">2.4.6.12.4.</span> <span class="toc-text"> 自定义 sink</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%B6%E9%97%B4%E5%92%8C%E7%AA%97%E5%8F%A3"><span class="toc-number">2.4.7.</span> <span class="toc-text"> 时间和窗口</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%88%86%E7%B1%BB"><span class="toc-number">2.4.7.1.</span> <span class="toc-text"> 窗口分类</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#1%E6%8C%89%E7%85%A7%E9%A9%B1%E5%8A%A8%E7%B1%BB%E5%9E%8B%E5%88%86"><span class="toc-number">2.4.7.1.1.</span> <span class="toc-text"> 1. 按照驱动类型分</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#2%E6%8C%89%E7%85%A7%E7%AA%97%E5%8F%A3%E5%88%86%E9%85%8D%E6%95%B0%E6%8D%AE%E7%9A%84%E8%A7%84%E5%88%99%E5%88%86%E7%B1%BB"><span class="toc-number">2.4.7.1.2.</span> <span class="toc-text"> 2. 按照窗口分配数据的规则分类</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3api"><span class="toc-number">2.4.7.2.</span> <span class="toc-text"> 窗口 API</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%B8%A6keyby%E5%92%8C%E4%B8%8D%E5%B8%A6keyby"><span class="toc-number">2.4.7.2.1.</span> <span class="toc-text"> 带 keyby 和不带 keyby</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.7.3.</span> <span class="toc-text"> 窗口函数</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%A2%9E%E9%87%8F%E8%81%9A%E5%90%88reduce"><span class="toc-number">2.4.7.3.1.</span> <span class="toc-text"> 增量聚合 reduce</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%81%9A%E5%90%88%E5%87%BD%E6%95%B0aggregate"><span class="toc-number">2.4.7.3.2.</span> <span class="toc-text"> 聚合函数 aggregate</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%85%A8%E7%AA%97%E5%8F%A3%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.7.3.3.</span> <span class="toc-text"> 全窗口函数</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%BB%93%E5%90%88%E4%BD%BF%E7%94%A8"><span class="toc-number">2.4.7.3.4.</span> <span class="toc-text"> 结合使用</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E4%BC%9A%E8%AF%9D%E7%AA%97%E5%8F%A3"><span class="toc-number">2.4.7.3.5.</span> <span class="toc-text"> 动态会话窗口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%AE%A1%E6%95%B0%E7%AA%97%E5%8F%A3"><span class="toc-number">2.4.7.3.6.</span> <span class="toc-text"> 计数窗口</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E8%A7%A6%E5%8F%91%E5%99%A8-%E7%A7%BB%E9%99%A4%E5%99%A8"><span class="toc-number">2.4.7.3.7.</span> <span class="toc-text"> 触发器 移除器</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%97%B6%E9%97%B4"><span class="toc-number">2.4.7.4.</span> <span class="toc-text"> 时间</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF"><span class="toc-number">2.4.7.5.</span> <span class="toc-text"> 水位线</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E7%94%9F%E6%88%90%E6%B0%B4%E4%BD%8D%E7%BA%BF"><span class="toc-number">2.4.7.5.1.</span> <span class="toc-text"> 生成水位线</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%96%AD%E7%82%B9%E5%BC%8F%E6%B0%B4%E4%BD%8D%E7%BA%BF%E7%94%9F%E6%88%90%E5%99%A8"><span class="toc-number">2.4.7.5.2.</span> <span class="toc-text"> 断点式水位线生成器</span></a></li><li class="toc-item toc-level-6"><a class="toc-link" href="#%E6%B0%B4%E4%BD%8D%E7%BA%BF%E4%BC%A0%E9%80%92"><span class="toc-number">2.4.7.5.3.</span> <span class="toc-text"> 水位线传递</span></a></li></ol></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%90%88%E6%B5%81-2"><span class="toc-number">2.4.7.6.</span> <span class="toc-text"> 合流</span></a><ol class="toc-child"><li class="toc-item toc-level-6"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E6%97%B6%E9%97%B4%E7%9A%84%E5%90%88%E6%B5%81-%E5%8F%8C%E6%B5%81%E8%81%94%E7%BB%93"><span class="toc-number">2.4.7.6.1.</span> <span class="toc-text"> 基于时间的合流 - 双流联结</span></a></li></ol></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%87%BD%E6%95%B0"><span class="toc-number">2.4.8.</span> <span class="toc-text"> 处理函数</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%BE%A7%E8%BE%93%E5%87%BA%E6%B5%81"><span class="toc-number">2.4.8.1.</span> <span class="toc-text"> 侧输出流</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86"><span class="toc-number">2.4.9.</span> <span class="toc-text"> 状态管理</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6"><span class="toc-number">2.4.10.</span> <span class="toc-text"> 容错机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flink-sql"><span class="toc-number">2.4.11.</span> <span class="toc-text"> Flink SQL</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="Related">
        <ul>
          <li><a href="/2024/03/01/hadoop_new/" rel="bookmark" title="Hadoop">Hadoop</a></li><li><a href="/2024/04/01/spark/" rel="bookmark" title="spark">spark</a></li><li class="active"><a href="/2024/05/01/hive_flink/" rel="bookmark" title="hive_flink">hive_flink</a></li><li><a href="/2024/10/01/clickhouse/" rel="bookmark" title="Clickhouse">Clickhouse</a></li><li><a href="/2024/11/01/%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%94%9F%E6%80%81%E6%A6%82%E8%AE%BA/" rel="bookmark" title="大数据生态概论">大数据生态概论</a></li>
        </ul>
      </div>
      <div class="overview panel" data-title="Overview">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="John Doe"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">John Doe</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">54</span>
        <span class="name">posts</span>
      </a>
    </div>
    <div class="item categories">
      <a href="/categories/">
        <span class="count">7</span>
        <span class="name">categories</span>
      </a>
    </div>
    <div class="item tags">
      <a href="/tags/">
        <span class="count">7</span>
        <span class="name">tags</span>
      </a>
    </div>
</nav>

<div class="social">
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>Home</a>
  </li>


</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2024/04/01/spark/" rel="prev" title="Previous Post"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2024/06/01/openstack/" rel="next" title="Next Post"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          
<div class="rpost pjax">
  <h2>Random Posts</h2>
  <ul>
      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/05/Docker/" title="docker">docker</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
</div>

    <span><a href="/2023/07/15/%E4%B8%AD%E9%97%B4%E4%BB%B6%E6%BC%8F%E6%B4%9E/" title="中间件漏洞">中间件漏洞</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E7%BD%91%E7%BB%9C/" title="In 网络">网络</a>
</div>

    <span><a href="/2023/09/01/border%20leaf/" title="从三层架构到spine leaf">从三层架构到spine leaf</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/06/27/SSRF/" title="SSRF">SSRF</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2023/04/03/iptables2/" title="iptables">iptables</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E5%A4%A7%E6%95%B0%E6%8D%AE/" title="In 大数据">大数据</a>
</div>

    <span><a href="/2024/10/01/clickhouse/" title="Clickhouse">Clickhouse</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/web%E5%AE%89%E5%85%A8/" title="In web安全">web安全</a>
</div>

    <span><a href="/2022/04/16/Upload/" title="File upload">File upload</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/01/25/%E8%99%9A%E6%8B%9F%E5%8C%96/" title="虚拟化">虚拟化</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E8%BF%90%E7%BB%B4/" title="In 运维">运维</a>
</div>

    <span><a href="/2024/02/01/%E7%9B%91%E6%8E%A7/" title="监控">监控</a></span>
  </li>

      
  <li class="item">
    
<div class="breadcrumb">
<a href="/categories/%E9%80%86%E5%90%91/" title="In 逆向">逆向</a>
</div>

    <span><a href="/2023/10/01/1234567/" title="windows逆向进阶">windows逆向进阶</a></span>
  </li>

  </ul>
</div>
<div>
  <h2>Recent Comments</h2>
  <ul class="leancloud-recent-comment"></ul>
</div>

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2010 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">John Doe @ Yume Shoka</span>
  </div>
  <div class="powered-by">
    Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2024/05/01/hive_flink/',
    favicon: {
      show: "（●´3｀●）Goooood",
      hide: "(´Д｀)Booooom"
    },
    search : {
      placeholder: "Search for Posts",
      empty: "We didn't find any results for the search: ${query}",
      stats: "${hits} results found in ${time} ms"
    },
    valine: true,fancybox: true,
    copyright: 'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
